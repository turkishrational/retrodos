     1                                  ; ****************************************************************************
     2                                  ; RDHDIMG.ASM (RDHDIMG.COM) - Retro DOS	v2 Hard Disk Image Formatting Utility
     3                                  ; 					 	          (for MSDOS/WINDOWS)
     4                                  ; ****************************************************************************
     5                                  ; Last Update: 20/05/2018
     6                                  ; ----------------------------------------------------------------------------
     7                                  ; Beginning: 07/05/2018
     8                                  ; ----------------------------------------------------------------------------
     9                                  ; Assembler: NASM version 2.11
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Derived from 'hdimage.s'(HDIMAGE.COM) source code by Erdogan Tan
    12                                  ; (03/02/2018) - TRDOS 386 hard disk image formatting utility -
    13                                  ; ****************************************************************************
    14                                  ; nasm rdhdimg.s -l rdhdimg.lst -o RDHDIMG.COM
    15                                  
    16                                  bsOemName	equ RETRODOS_FAT12_hd_bs + 3
    17                                  bsBytesPerSec	equ RETRODOS_FAT12_hd_bs + 11
    18                                  bsSecPerClust	equ RETRODOS_FAT12_hd_bs + 13
    19                                  bsResSectors	equ RETRODOS_FAT12_hd_bs + 14
    20                                  bsFATs		equ RETRODOS_FAT12_hd_bs + 16	
    21                                  bsRootDirEnts	equ RETRODOS_FAT12_hd_bs + 17
    22                                  bsSectors	equ RETRODOS_FAT12_hd_bs + 19
    23                                  bsMedia		equ RETRODOS_FAT12_hd_bs + 21
    24                                  bsFATsecs	equ RETRODOS_FAT12_hd_bs + 22
    25                                  bsSecPerTrk	equ RETRODOS_FAT12_hd_bs + 24
    26                                  bsHeads		equ RETRODOS_FAT12_hd_bs + 26
    27                                  bsHidden1	equ RETRODOS_FAT12_hd_bs + 28
    28                                  bsHidden2	equ RETRODOS_FAT12_hd_bs + 30	
    29                                  bsHugeSectors	equ RETRODOS_FAT12_hd_bs + 32
    30                                  bsDriveNumber   equ RETRODOS_FAT12_hd_bs + 36
    31                                  bsReserved1	equ RETRODOS_FAT12_hd_bs + 37
    32                                  bsBpbSignature	equ RETRODOS_FAT12_hd_bs + 38
    33                                  bsVolumeID      equ RETRODOS_FAT12_hd_bs + 39
    34                                  bsVolumeLabel   equ RETRODOS_FAT12_hd_bs + 43
    35                                  bsFileSysType	equ RETRODOS_FAT12_hd_bs + 54
    36                                  bsReserved2	equ RETRODOS_FAT12_hd_bs + 62
    37                                  bsDataStart	equ RETRODOS_FAT12_hd_bs + 64	
    38                                  bsRootDirStart	equ RETRODOS_FAT12_hd_bs + 66
    39                                  bsRootDirSects	equ RETRODOS_FAT12_hd_bs + 68
    40                                  
    41                                  ; DTA (PSP+80h= Offset 128)
    42                                  DTA_Attrib equ 149 ; PDP+21
    43                                  DTA_Time equ 150 ; PSP+22
    44                                  DTA_Date equ 152 ; PSP 24
    45                                  DTA_FileSize equ 154 ; PSP + 26
    46                                  DTA_FileName equ 158 ; PSP + 30
    47                                  
    48                                  ; Masterboot / Partition Table at Beginning+1BEh
    49                                  ptBootable      equ 0
    50                                  ptBeginHead     equ 1
    51                                  ptBeginSector   equ 2
    52                                  ptBeginCylinder equ 3
    53                                  ptFileSystemID	equ 4
    54                                  ptEndHead       equ 5
    55                                  ptEndSector     equ 6
    56                                  ptEndCylinder   equ 7
    57                                  ptStartSector   equ 8
    58                                  ptSectors       equ 12
    59                                  
    60                                  pt_cylinders	equ RETRODOS_MASTERBOOT_SECTOR + 1B8h	
    61                                  pt_heads	equ RETRODOS_MASTERBOOT_SECTOR + 1BAh	
    62                                  pt_sectors	equ RETRODOS_MASTERBOOT_SECTOR + 1BCh
    63                                  partition_table equ RETRODOS_MASTERBOOT_SECTOR + 1BEh
    64                                  
    65                                  ; BIOS Disk Parameters
    66                                  DPDiskNumber  equ 0h
    67                                  DPDType       equ 1h
    68                                  DPReturn      equ 2h
    69                                  DPHeads       equ 3h
    70                                  DPCylinders   equ 4h
    71                                  DPSecPerTrack equ 6h
    72                                  DPDisks       equ 7h
    73                                  DPTableOff    equ 8h
    74                                  DPTableSeg    equ 0Ah
    75                                  DPNumOfSecs   equ 0Ch
    76                                  
    77                                  ; BIOS INT 13h Extensions (LBA extensions)
    78                                  ; Just After DP Data (DPDiskNumber+)
    79                                  DAP_PacketSize equ 10h  ; If extensions present, this byte will be >=10h
    80                                  DAP_Reserved1 equ 11h   ; Reserved Byte 
    81                                  DAP_NumOfBlocks equ 12h ; Value of this byte must be 0 to 127
    82                                  DAP_Reserved2 equ 13h   ; Reserved Byte
    83                                  DAP_Destination equ 14h ; Address of Transfer Buffer as SEGMENT:OFFSET
    84                                  DAP_LBA_Address equ 18h ; LBA=(C1*H0+H1)*S0+S1-1
    85                                                          ; C1= Selected Cylinder Number
    86                                                          ; H0= Number Of Heads (Maximum Head Number + 1)
    87                                                          ; H1= Selected Head Number
    88                                                          ; S0= Maximum Sector Number
    89                                                          ; S1= Selected Sector Number
    90                                                          ; QUAD WORD
    91                                  ; DAP_Flat_Destination equ 20h ; 64 bit address, if value in 4h is FFFF:FFFFh
    92                                                               ; QUAD WORD (Also, value in 0h must be 18h) 
    93                                                               ; TR-DOS will not use 64 bit Flat Address
    94                                  
    95                                  ; INT 13h Function 48h "Get Enhanced Disk Drive Parameters"
    96                                  ; Just After DP Data (DPDiskNumber+)
    97                                  GetDParams_48h equ 20h ; Word. Data Lenght, must be 26 (1Ah) for short data.
    98                                  GDP_48h_InfoFlag equ 22h ; Word
    99                                  ; Bit 1 = 1 -> The geometry returned in bytes 4-15 is valid.
   100                                  GDP_48h_NumOfPCyls equ 24h ; Double Word. Number physical cylinders.
   101                                  GDP_48h_NumOfPHeads equ 28h ; Double Word. Number of physical heads.
   102                                  GDP_48h_NumOfPSpT equ 2Ch ; Double word. Num of physical sectors per track.
   103                                  GDP_48h_LBA_Sectors equ 30h ; 8 bytes. Number of physical/LBA sectors.
   104                                  GDP_48h_BytesPerSec equ 38h ; Word. Number of bytes in a sector.
   105                                  
   106                                  ; Cursor Location
   107                                  CCCpointer equ  0450h   ; BIOS data, current cursor column
   108                                  
   109                                  ; MINIMUM & MAXIMUM SECTORS (partition and disk size limits in sectors)
   110                                  MINPARTSIZE equ 4096 ; 2GB
   111                                  MAXPARTSIZE equ 4128768 - 1 ; 2GB - masterboot sector	
   112                                  MINDISKSIZE equ 16384 ; 8MB
   113                                  MAXDISKSIZE equ 4128768 ; 2GB
   114                                  
   115                                  pTableOffset equ 1BEh ; 446		
   116                                  
   117                                  [BITS 16]
   118                                  [ORG 100h]
   119                                  
   120                                  	;cli
   121                                  	;cld
   122                                  	;push	cs
   123                                  	;pop	ss
   124                                  	;mov	sp, 0FFFEh
   125                                  	;sti
   126                                  	
   127 00000000 BB[DC18]                	mov	bx, SizeOfFile+100
   128 00000003 83C30F                          add	bx, 15
   129 00000006 D1EB                            shr	bx, 1
   130 00000008 D1EB                            shr	bx, 1
   131 0000000A D1EB                    	shr	bx, 1
   132 0000000C D1EB                    	shr	bx, 1
   133 0000000E B44A                            mov	ah, 4Ah ; modify memory allocation
   134                                          ;push	cs
   135                                          ;pop	es
   136 00000010 CD21                            int	21h 
   137                                  
   138                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   139                                  ; get fd image file name
   140                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   141                                  
   142 00000012 BE8000                  	mov	si, 80h			; PSP command tail
   143 00000015 AC                       	lodsb
   144 00000016 08C0                    	or	al, al 			; command tail length                            
   145 00000018 0F840801                	jz	R_15			; jump if zero
   146                                  R_01:
   147 0000001C AC                      	lodsb
   148 0000001D 3C20                    	cmp	al, ' '			; is it SPACE ?
   149 0000001F 74FB                    	je	short R_01 		
   150 00000021 0F82FF00                	jb	R_15
   151                                  	
   152                                  	; check hd image file name
   153                                  R_02:
   154 00000025 BF[B916]                       	mov	di, img_file_name
   155 00000028 AA                      	stosb
   156                                  R_03:
   157 00000029 AC                      	lodsb
   158                                  	;cmp	al, 0Dh ; ENTER (CR) key
   159 0000002A 3C20                    	cmp	al, 20h ; ' '
   160 0000002C 760C                    	jna	short R_04
   161 0000002E AA                      	stosb
   162 0000002F 81FF[C516]              	cmp	di, img_file_name + 12
   163 00000033 72F4                    	jb	short R_03
   164 00000035 803C20                  	cmp	byte [si], 20h 
   165 00000038 7748                    	ja	short R_11
   166                                  R_04:
   167                                  	;sub	al, al
   168                                  	;stosb
   169                                  
   170                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   171                                  ; File name capitalization
   172                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   173                                  
   174 0000003A BE[B916]                	mov	si, img_file_name
   175 0000003D 89F7                    	mov	di, si
   176 0000003F 89F3                    	mov	bx, si
   177                                  R_05:
   178 00000041 AC                      	lodsb
   179 00000042 3C61                    	cmp	al, 'a'
   180 00000044 730D                    	jnb	short R_07
   181 00000046 20C0                    	and	al, al
   182 00000048 7412                    	jz	short R_08
   183 0000004A 3C2E                    	cmp	al, '.'
   184 0000004C 7502                    	jne	short R_06
   185 0000004E 89FB                    	mov	bx, di ; dot position	
   186                                  R_06:
   187 00000050 AA                      	stosb
   188 00000051 EBEE                    	jmp	short R_05 		
   189                                  R_07:
   190 00000053 3C7A                    	cmp	al, 'z'
   191 00000055 77F9                    	ja	short R_06
   192 00000057 24DF                    	and	al, 0DFh ; NOT 32
   193 00000059 AA                      	stosb
   194 0000005A EBE5                    	jmp	short R_05	
   195                                  R_08:
   196 0000005C 8805                    	mov	[di], al
   197 0000005E 4F                      	dec	di
   198 0000005F 39FB                    	cmp	bx, di
   199 00000061 7316                    	jnb	short R_10
   200 00000063 29DF                    	sub	di, bx
   201 00000065 81EB[B916]              	sub	bx, img_file_name
   202 00000069 83FF03                  	cmp	di, 3
   203 0000006C 7606                    	jna	short R_09
   204 0000006E 21DB                    	and	bx, bx
   205 00000070 7507                    	jnz	short R_10
   206 00000072 EB0E                    	jmp	short R_11		
   207                                  R_09:
   208 00000074 83FB08                  	cmp	bx, 8
   209 00000077 7609                    	jna	short R_11
   210                                  R_10:
   211 00000079 BE[7E11]                	mov	si, msg_inv_file_name
   212 0000007C E88304                  	call	print_msg
   213 0000007F E99700                  	jmp	R_14
   214                                  
   215                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   216                                  ; Find image file
   217                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   218                                  	
   219                                  R_11:
   220 00000082 BA[B916]                	mov	dx, img_file_name
   221 00000085 B93F00                  	mov	cx, 3Fh ; File Attributes
   222 00000088 B44E                    	mov	ah, 4Eh ; MS-DOS Function = Find First File
   223 0000008A CD21                    	int	21h
   224 0000008C 0F82B900                	jc	R_19
   225                                  
   226                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   227                                  ; Check image file features
   228                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   229                                  
   230 00000090 BE9500                  	mov	si, DTA_Attrib
   231 00000093 8A04                    	mov	al, [si]
   232 00000095 241F                    	and	al, 1Fh ; directory, volume label, system, hidden, read only
   233 00000097 0F859900                	jnz	R_17     
   234 0000009B BE9A00                  	mov	si, DTA_FileSize
   235 0000009E AD                      	lodsw
   236 0000009F 8B14                    	mov	dx, [si]
   237 000000A1 81FAF801                	cmp	dx, 1F8h
   238 000000A5 0F878B00                	ja	R_17
   239 000000A9 A9FF01                  	test	ax, 511
   240 000000AC 0F858400                	jnz	R_17
   241 000000B0 C1E809                  	shr	ax, 9
   242 000000B3 C1E207                  	shl	dx, 7
   243 000000B6 01D0                    	add	ax, dx
   244                                  
   245                                  	; max. size of Retro DOS v2 hard disk image < 32MB
   246 000000B8 3D00FC                  	cmp	ax, 64512 ; 64*16*63 sectors
   247 000000BB 7777                    	ja	short R_17
   248 000000BD 7426                    	je	short R_12
   249 000000BF 3DC04E                  	cmp	ax, 20160 ; 20*16*63 sectors
   250 000000C2 7421                    	je	short R_12
   251 000000C4 726E                    	jb	short R_17
   252 000000C6 3D4851                  	cmp	ax, 20808 ; 306*4*17 sectors
   253 000000C9 7269                    	jb	short R_17
   254 000000CB 7418                    	je	short R_12
   255 000000CD 3D90A2                  	cmp	ax, 41616 ; 306*8*17 sectors
   256 000000D0 7413                    	je	short R_12
   257 000000D2 3D70F5                  	cmp	ax, 62832 ; 462*8*17 sectors
   258 000000D5 740E                    	je	short R_12
   259 000000D7 775B                    	ja	short R_17
   260 000000D9 3D007E                  	cmp	ax, 32256 ; 32*16*63 sectors
   261 000000DC 7407                    	je	short R_12
   262 000000DE 7254                    	jb	short R_17
   263 000000E0 3D809D                  	cmp	ax, 40320 ; 40*16*63 sectors
   264 000000E3 754F                    	jne	short R_17		
   265                                  R_12:
   266                                  
   267                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   268                                  ; Overwrite question
   269                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   270                                  
   271 000000E5 BE[EC14]                	mov	si, msg_overwrite_question1
   272 000000E8 E81704                  	call	print_msg
   273 000000EB BE9E00                  	mov	si, DTA_FileName
   274 000000EE E81104                  	call	print_msg
   275 000000F1 BE[0915]                	mov	si, msg_overwrite_question2
   276 000000F4 E80B04                  	call	print_msg
   277 000000F7 BE[1115]                	mov	si, msg_yes_no
   278 000000FA E80504                  	call	print_msg
   279                                  
   280                                  	; get answer
   281                                  R_13:
   282 000000FD 31C0                    	xor	ax, ax
   283 000000FF CD16                    	int	16h			; wait for keyboard command
   284 00000101 3C03                    	cmp	al, 'C'-40h
   285 00000103 7414                    	je	short R_14 ; Exit                   
   286 00000105 3C1B                    	cmp	al, 27
   287 00000107 7410                    	je	short R_14 ; Exit
   288 00000109 24DF                    	and	al, 0DFh
   289 0000010B 3C59                    	cmp	al, 'Y'			; Yes?
   290 0000010D 741D                    	je	short R_16		; write
   291 0000010F 3C4E                    	cmp	al, 'N'			; No?
   292 00000111 75EA                    	jne	short R_13      
   293                                  					; no write (exit)  
   294 00000113 BE[EC15]                	mov	si, Msg_NO
   295 00000116 E8E903                  	call	print_msg 
   296                                  
   297                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   298                                  ; Nextline & Exit
   299                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   300                                  
   301                                  R_14:
   302 00000119 BE[E415]                	mov	si, CRLF
   303 0000011C E8E303                  	call	print_msg
   304 0000011F B8004C                  	mov	ax, 4C00h		; terminate
   305 00000122 CD21                    	int	21h
   306                                  
   307                                  R_15:
   308 00000124 BE[0511]                	mov	si, RetroDOS_Welcome
   309 00000127 E8D803                  	call	print_msg
   310 0000012A EBED                    	jmp	short R_14 ; Exit
   311                                  
   312                                  R_16:
   313 0000012C BE[E715]                	mov	si, Msg_YES
   314 0000012F E8D003                  	call	print_msg
   315 00000132 EB08                    	jmp	short R_18
   316                                  
   317                                  R_17:
   318 00000134 BE[C011]                	mov	si, msg_inv_image_file
   319 00000137 E8C803                  	call	print_msg
   320 0000013A EBDD                    	jmp	short R_14
   321                                  
   322                                  R_18:
   323                                  	; Delete existing image file
   324 0000013C B441                    	mov	ah, 41h ; Delete file
   325 0000013E BA[B916]                	mov	dx, img_file_name
   326 00000141 CD21                    	int	21h
   327 00000143 7304                    	jnc	short R_19
   328 00000145 3C02                    	cmp	al, 2 ; file not found
   329 00000147 75EB                    	jne	short R_17 ; invalid image file
   330                                  
   331                                  R_19:
   332 00000149 E86D04                  	call	write_chs_table
   333                                  R_20:
   334 0000014C 30E4                    	xor	ah, ah
   335 0000014E CD16                    	int	16h
   336                                  
   337 00000150 3C31                    	cmp	al, '1'
   338 00000152 720B                    	jb	short R_21
   339 00000154 3C37                    	cmp	al, '7'
   340 00000156 77F4                    	ja	short R_20
   341 00000158 88C4                    	mov	ah, al
   342 0000015A 80EC30                  	sub	ah, '0'
   343 0000015D EB09                    	jmp	short R_22
   344                                  R_21:
   345 0000015F 3C1B                    	cmp	al, 27 ;  ESCape key
   346 00000161 75E9                    	jne	short R_20
   347                                  
   348                                  	; Exit
   349 00000163 B8004C                  	mov	ax, 4C00h
   350 00000166 CD21                    	int	21h
   351                                  
   352                                  R_22:
   353 00000168 8826[B816]              	mov	[DiskType], ah
   354                                  
   355                                  	; clear screen
   356 0000016C B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
   357 0000016F CD10                    	int	10h
   358                                  
   359 00000171 8A1E[B816]              	mov	bl, [DiskType]	; 1 to 7
   360 00000175 FECB                    	dec	bl 		; 0 to 6
   361                                  	;xor	bh, bh
   362 00000177 89DE                    	mov	si, bx
   363 00000179 D0E3                    	shl	bl, 1
   364 0000017B 81C3[9E16]              	add	bx, DskTypeNumStr
   365 0000017F 8B07                    	mov	ax, [bx]
   366 00000181 A3[8416]                	mov	[msg_disk_size], ax
   367 00000184 C1E603                  	shl	si, 3 ; * 8
   368 00000187 81C6[C505]              	add	si, DskTypeParms
   369 0000018B AD                      	lodsw
   370 0000018C A3[B808]                	mov	[pt_cylinders], ax
   371 0000018F AD                      	lodsw
   372 00000190 A3[BA08]                	mov	[pt_heads], ax
   373 00000193 AD                      	lodsw
   374 00000194 A3[BC08]                	mov	[pt_sectors], ax
   375 00000197 AD                      	lodsw	
   376 00000198 A3[B616]                	mov	[diskimage_size], ax
   377                                  	
   378 0000019B BE[7916]                	mov	si, msg_creating
   379 0000019E E86103                  	call	print_msg
   380                                  
   381                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   382                                  ; Create a new hard disk image file
   383                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   384                                  		
   385 000001A1 BA[B916]                	mov	dx, img_file_name
   386 000001A4 B90000                  	mov	cx, 0 ; File Attributes
   387 000001A7 B43C                    	mov	ah, 3Ch ; MS-DOS Function = Create File
   388 000001A9 CD21                    	int	21h
   389 000001AB 7208                    	jc	short R_23
   390                                  
   391                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   392                                  ; Open image file for writing
   393                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   394                                  
   395 000001AD B002                    	mov	al, 2 ; open for reading and writing
   396                                  	;mov	dx, img_file_name
   397 000001AF B43D                    	mov	ah, 3Dh ; open file
   398 000001B1 CD21                    	int	21h
   399 000001B3 7314                    	jnc	short R_24
   400                                  
   401                                  R_23:
   402                                  	; AL = error code
   403 000001B5 E85903                  	call	bin_to_hex
   404 000001B8 A3[FB15]                	mov 	[error_code], ax
   405                                  
   406 000001BB BE[E415]                	mov	si, CRLF
   407 000001BE E84103                  	call	print_msg
   408                                  
   409 000001C1 BE[F015]                	mov	si, Msg_Error
   410 000001C4 E83B03                  	call	print_msg
   411                                  
   412 000001C7 CD20                    	int	20h	; Exit
   413                                  
   414                                  R_24:
   415 000001C9 A3[120B]                	mov	[img_file_handle], ax
   416 000001CC BA[C616]                	mov	dx, HDFORMAT_SECBUFFER  ; 0F6h buffer
   417                                  R_25:
   418 000001CF B90002                  	mov	cx, 512
   419 000001D2 8B1E[120B]              	mov	bx, [img_file_handle]
   420 000001D6 B440                    	mov	ah, 40h ; write to file	
   421 000001D8 CD21                    	int	21h
   422 000001DA 7226                    	jc	short R_26
   423                                  
   424 000001DC FF06[B416]              	inc	word [CWSector]
   425 000001E0 A1[B616]                	mov	ax, [diskimage_size]
   426                                  
   427 000001E3 B90100                  	mov	cx, 1
   428                                  
   429 000001E6 3B06[B416]              	cmp	ax, [CWSector]
   430 000001EA 761E                    	jna	short R_27
   431                                  	
   432 000001EC A1[B416]                	mov	ax, [CWSector]
   433 000001EF 83E003                  	and	ax, 3
   434 000001F2 BB[AE16]                	mov	bx, RSymbols
   435 000001F5 01C3                    	add	bx, ax
   436 000001F7 8A07                    	mov	al, [bx]
   437 000001F9 BB0700                  	mov	bx, 7
   438                                  	;mov	cx, 1
   439 000001FC B40A                    	mov	ah, 0Ah ; write character (on previous cpos)
   440 000001FE CD10                    	int	10h
   441                                  
   442 00000200 EBCD                    	jmp	short R_25
   443                                  
   444                                  R_26:
   445                                  	; Error.. close file..
   446 00000202 50                      	push	ax
   447 00000203 B43E                    	mov	ah, 3Eh ; close file
   448                                  	;mov	bx, [img_file_handle]
   449 00000205 CD21                    	int	21h
   450 00000207 58                      	pop	ax
   451 00000208 EBAB                    	jmp	short R_23
   452                                  
   453                                  R_27:
   454 0000020A B020                    	mov	al, 20h ; space
   455 0000020C BB0700                  	mov	bx, 7
   456 0000020F B40A                    	mov	ah, 0Ah ; write character (on previous cpos)
   457                                  	;mov	cx, 1
   458 00000211 CD10                    	int	10h
   459                                  	
   460 00000213 BE[E015]                	mov	si, msg_OK
   461 00000216 E8E902                  	call	print_msg
   462                                  
   463                                  	; Wait about 1 second (~16/18.2)
   464                                  	; "before press any key to continue message"
   465 00000219 30E4                    	xor	ah, ah ; 0
   466 0000021B CD1A                    	int	1Ah
   467                                  	; CX:DX = tick count (18.2 ticks per second)
   468 0000021D 83E20F                  	and	dx, 0Fh
   469 00000220 89D6                    	mov	si, dx
   470 00000222 31DB                    	xor	bx, bx
   471                                  R_28:
   472 00000224 B80000                  	mov	ax,0
   473 00000227 CD1A                    	int	1Ah	
   474 00000229 43                      	inc	bx
   475 0000022A 7407                    	jz	short R_29 
   476 0000022C 83E20F                  	and	dx, 0Fh
   477 0000022F 39F2                    	cmp	dx, si
   478 00000231 75F1                    	jne	short R_28
   479                                  R_29:
   480 00000233 BE[5A16]                	mov	si, msg_press_any_key
   481 00000236 E8C902                  	call	print_msg
   482                                  
   483 00000239 30E4                    	xor	ah, ah
   484 0000023B CD16                    	int	16h
   485                                  
   486                                  R_30:
   487                                  	; clear screen
   488 0000023D B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
   489 00000240 CD10                    	int	10h
   490                                  	
   491 00000242 BE[A212]                	mov	si, msg_create_dos_partition_h ; header
   492 00000245 E8BA02                  	call	print_msg
   493 00000248 BE[9713]                	mov	si, msg_create_dos_partition_m ; menu
   494 0000024B E8B402                  	call	print_msg
   495                                  R_31:
   496 0000024E 30E4                    	xor	ah, ah
   497 00000250 CD16                    	int	16h
   498 00000252 3C1B                    	cmp	al, 27 ; ESC key	
   499 00000254 743B                    	je	short R_32
   500 00000256 3C30                    	cmp	al, '0'
   501 00000258 7437                    	je	short R_32
   502 0000025A 72F2                    	jb	short R_31
   503 0000025C 3C36                    	cmp	al, '6'
   504 0000025E 77EE                    	ja	short R_31
   505                                  
   506 00000260 30ED                    	xor	ch, ch
   507 00000262 2C30                    	sub	al, '0'
   508 00000264 88C1                    	mov	cl, al
   509 00000266 FEC9                    	dec	cl  ; 0 to 5
   510 00000268 8A1E[B816]              	mov	bl, [DiskType]
   511 0000026C FECB                    	dec	bl  ; 0 to 6
   512 0000026E B006                    	mov	al, 6
   513 00000270 F6E3                    	mul	bl	
   514 00000272 BB[D506]                	mov	bx, OptionValidatingTable
   515 00000275 01C8                    	add	ax, cx
   516 00000277 01C3                    	add	bx, ax
   517 00000279 8A07                    	mov	al, [bx]
   518 0000027B 20C0                    	and	al, al
   519 0000027D 7520                    	jnz	short R_34
   520                                  
   521 0000027F BE[0512]                	mov	si, msg_option_not_proper
   522 00000282 E87D02                  	call	print_msg
   523 00000285 BE[5A16]                	mov	si, msg_press_any_key
   524 00000288 E87702                  	call	print_msg
   525 0000028B 30E4                    	xor	ah, ah
   526 0000028D CD16                    	int	16h
   527 0000028F EBAC                    	jmp	short R_30
   528                                  
   529                                  R_32:	
   530 00000291 BE[E415]                	mov	si, CRLF
   531 00000294 E86B02                  	call	print_msg
   532                                  
   533 00000297 30C0                    	xor	al, al	; return code = 0
   534 00000299 B44C                    	mov	ah, 4Ch ; EXIT - terminate with return code
   535 0000029B CD21                    	int	21h
   536                                  
   537                                  R_33:
   538 0000029D EBFE                    	jmp	short R_33
   539                                  
   540                                  R_34:
   541 0000029F FEC8                    	dec	al ; zero based type of partition selection
   542 000002A1 B412                    	mov	ah, 18
   543 000002A3 F6E4                    	mul	ah
   544 000002A5 BE[FD05]                	mov	si, partition_parms
   545 000002A8 01C6                    	add	si, ax
   546 000002AA BB[BE08]                	mov	bx, partition_table
   547 000002AD AD                      	lodsw
   548 000002AE A2[0D09]                	mov	[bsSecPerClust], al  ; sectors per cluster
   549 000002B1 AD                      	lodsw
   550                                  	;mov	cx, ax  	     ; number of clusters
   551 000002B2 AD                      	lodsw
   552 000002B3 A3[1109]                	mov	[bsRootDirEnts], ax  ; root directory entries
   553 000002B6 83C00F                  	add	ax,15
   554 000002B9 C1E804                  	shr	ax, 4
   555 000002BC A3[4409]                	mov	[bsRootDirSects], ax ; root directory sectors	
   556 000002BF AD                      	lodsw
   557 000002C0 A3[1C09]                	mov	[bsHidden1], ax	     ; hidden sectors
   558 000002C3 894708                  	mov	[bx+ptStartSector], ax ; start sector
   559                                  	;mov	word [bx+ptStartSector+2], 0
   560                                  
   561                                  	;mov	word [bsHidden2], 0
   562 000002C6 AD                      	lodsw
   563                                  	;mov	[bsResSectors], ax   ; reserved sectors = 1
   564 000002C7 AD                      	lodsw
   565 000002C8 A3[1609]                	mov	[bsFATsecs], ax      ; fat sectors
   566 000002CB AD                      	lodsw
   567 000002CC A3[4209]                	mov	[bsRootDirStart], ax ; root directory address
   568 000002CF AD                      	lodsw
   569 000002D0 A3[4009]                	mov	[bsDataStart], ax    ; first data sector address
   570 000002D3 AD                      	lodsw
   571 000002D4 A3[1309]                	mov	[bsSectors], ax      ; partition/volume size in sectors
   572 000002D7 A3[2009]                	mov	[bsHugeSectors], ax 
   573                                  	;mov	word [bsHugeSectors+2], 0
   574 000002DA 89470C                  	mov	[bx+ptSectors], ax
   575                                  	;mov	word [bx+ptSectors+2], 0
   576                                  
   577 000002DD 89C1                    	mov	cx, ax 		     ; volume/partition size in sectors
   578                                  
   579 000002DF C60780                  	mov	byte [bx], 80h       ; Active/Bootable partition
   580 000002E2 B001                    	mov	al, 1
   581 000002E4 884704                  	mov	[bx+ptFileSystemID], al ; 1
   582 000002E7 884701                  	mov	[bx+ptBeginHead], al ; beginning head = 1
   583 000002EA 884702                  	mov	[bx+ptBeginSector], al ; beginning sector = 1
   584 000002ED 30E4                    	xor	ah, ah	
   585                                  	;mov	[bx+ptBeginCylinder], ah ; beginning cylinder = 0
   586                                  		
   587 000002EF A0[BC08]                	mov	al, [pt_sectors]
   588 000002F2 A2[1809]                	mov	[bsSecPerTrk], al
   589                                  	;mov	byte [bsSecPerTrk+1], 0
   590 000002F5 884706                  	mov	[bx+ptEndSector], al	
   591 000002F8 01C1                    	add	cx, ax		     ; + sectors per track      		           
   592                                  
   593 000002FA 8A26[BA08]              	mov	ah, [pt_heads]
   594 000002FE 8826[1A09]              	mov	[bsHeads], ah
   595                                  	;mov	byte [bsHeads+1], 0
   596 00000302 FECC                    	dec	ah
   597 00000304 886705                  	mov	[bx+ptEndHead], ah
   598 00000307 FEC4                    	inc	ah
   599 00000309 F6E4                    	mul	ah
   600 0000030B 91                      	xchg	cx, ax
   601 0000030C 31D2                    	xor	dx, dx
   602 0000030E F7F1                    	div	cx
   603 00000310 48                      	dec	ax  ; the last cylinder of the partition (< 120) 
   604 00000311 884707                  	mov	[bx+ptEndCylinder], al
   605                                  
   606                                  	; clear screen
   607 00000314 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
   608 00000317 CD10                    	int	10h	
   609                                  
   610 00000319 BE[1C15]                	mov	si, msg_writing_mbr
   611 0000031C E8E301                  	call	print_msg
   612                                  
   613                                  	; Move file pointer to start of the file
   614                                  	;xor	al, al
   615 0000031F 8B1E[120B]              	mov	bx, [img_file_handle]
   616 00000323 29C9                    	sub	cx, cx
   617                                  	;sub	dx, dx
   618 00000325 B442                    	mov	ah, 42h ; seek (move file pointer)
   619 00000327 CD21                    	int	21h
   620                                  
   621                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   622                                  ; writing masterboot sector
   623                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   624                                  
   625                                  	;mov	bx, [img_file_handle]
   626 00000329 BA[0007]                	mov	dx, RETRODOS_MASTERBOOT_SECTOR ; Singlix FS1 MBR
   627 0000032C B90002                  	mov	cx, 512
   628 0000032F B440                    	mov	ah, 40h ; write to file	
   629 00000331 CD21                    	int	21h
   630 00000333 0F82CBFE                	jc	R_26 ; write error message then exit
   631                                  
   632 00000337 BE[E015]                	mov	si, msg_OK
   633 0000033A E8C501                  	call	print_msg
   634                                  
   635 0000033D BF[2B09]                	mov	di, bsVolumeLabel
   636 00000340 E8E600                  	call	write_volume_name
   637 00000343 BE[2709]                	mov	si, bsVolumeID
   638 00000346 E83201                  	call	write_volume_serial
   639                                  
   640 00000349 BE[4F15]                	mov	si, msg_writing_boot_sector
   641 0000034C E8B301                  	call	print_msg
   642                                  
   643                                  	; Move file pointer to start of the dos partition
   644 0000034F 8B16[C608]              	mov	dx, [partition_table+ptStartSector]
   645                                  	
   646 00000353 B80002                  	mov	ax, 512
   647 00000356 F7E2                    	mul	dx
   648 00000358 89D1                    	mov	cx, dx
   649 0000035A 89C2                    	mov	dx, ax
   650                                  
   651 0000035C 28C0                    	sub	al, al
   652 0000035E 8B1E[120B]              	mov	bx, [img_file_handle]
   653 00000362 B442                    	mov	ah, 42h ; seek (move file pointer)
   654 00000364 CD21                    	int	21h
   655                                  	;jc	R_26
   656                                  
   657                                  	;mov	bx, [img_file_handle]
   658 00000366 BA[0009]                	mov	dx, RETRODOS_FAT12_hd_bs
   659 00000369 B90002                  	mov	cx, 512
   660 0000036C B440                    	mov	ah, 40h ; write to file	
   661 0000036E CD21                    	int	21h
   662 00000370 0F828EFE                	jc	R_26 ; write error message then exit
   663                                  
   664 00000374 BE[E015]                	mov	si, msg_OK
   665 00000377 E88801                  	call	print_msg
   666                                  
   667                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   668                                  ; writing FAT sectors
   669                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   670                                  
   671                                  	;mov	si, CRLF
   672                                  	;call	print_msg
   673                                  
   674                                  	; Clear sector buffer (clear 0F6h bytes)
   675 0000037A BF[C616]                	mov	di, HDFORMAT_FATBUFFER
   676 0000037D 31C0                    	xor	ax, ax
   677 0000037F B90001                  	mov	cx, 256
   678 00000382 F3AB                    	rep	stosw 
   679                                  
   680 00000384 BE[6D15]                	mov	si, msg_writing_FAT_sectors
   681 00000387 E87801                  	call	print_msg
   682                                  
   683 0000038A 8B2E[1609]              	mov	bp, [bsFATsecs]
   684 0000038E 4D                      	dec	bp
   685 0000038F 89EF                    	mov	di, bp
   686                                  
   687 00000391 B8F8FF                  	mov	ax, 0FFF8h
   688 00000394 BE[C616]                	mov	si, HDFORMAT_FATBUFFER
   689 00000397 8904                    	mov	[SI], ax
   690 00000399 886402                  	mov	[SI+2], ah
   691                                  	
   692 0000039C 28C0                    	sub	al, al
   693 0000039E 8B1E[120B]              	mov	bx, [img_file_handle]
   694 000003A2 89F2                    	mov	dx, si ; [HDFORMAT_FATBUFFER]
   695 000003A4 B90002                  	mov	cx, 512
   696 000003A7 B440                    	mov	ah, 40h ; write to file	
   697 000003A9 CD21                    	int	21h
   698 000003AB 0F8253FE                	jc	R_26 ; write error message then exit
   699                                  	;mov	bx, [img_file_handle]
   700 000003AF BA[C616]                	mov	dx, HDFORMAT_ZERO_BUFF
   701                                  	;mov	cx, 512
   702 000003B2 31C0                    	xor	ax, ax
   703 000003B4 8904                    	mov	[SI], ax
   704 000003B6 886402                  	mov	[SI+2], ah
   705                                  R_35:
   706 000003B9 28C0                    	sub	al, al
   707                                  	;mov	dx, HDFORMAT_ZERO_BUFF
   708                                  	;mov	cx, 512
   709 000003BB B440                    	mov	ah, 40h ; write to file	
   710 000003BD CD21                    	int	21h
   711 000003BF 0F823FFE                	jc	R_26 ; write error message then exit
   712                                  
   713 000003C3 4D                      	dec	bp
   714 000003C4 75F3                    	jnz	short R_35
   715                                  
   716 000003C6 B8F8FF                  	mov	ax, 0FFF8h
   717                                  	;mov	si, HDFORMAT_FATBUFFER
   718 000003C9 8904                    	mov	[SI], ax
   719 000003CB 886402                  	mov	[SI+2], ah
   720                                  
   721 000003CE 28C0                    	sub	al, al
   722                                  	;mov	bx, [img_file_handle]
   723 000003D0 89F2                    	mov	dx, si; [HDFORMAT_FATBUFFER]
   724                                  	;mov	cx, 512
   725 000003D2 B440                    	mov	ah, 40h ; write to file	
   726 000003D4 CD21                    	int	21h
   727 000003D6 0F8228FE                	jc	R_26 ; write error message then exit
   728                                  	;mov	bx, [img_file_handle]
   729 000003DA BA[C616]                	mov	dx, HDFORMAT_ZERO_BUFF
   730                                  	;mov	cx, 512
   731 000003DD 29C0                    	sub	ax, ax
   732 000003DF 8904                    	mov	[SI], ax
   733 000003E1 886402                  	mov	[SI+2], ah
   734                                  R_36:
   735 000003E4 28C0                    	sub	al, al
   736                                  	;mov	dx, HDFORMAT_ZERO_BUFF
   737                                  	;mov	cx, 512
   738 000003E6 B440                    	mov	ah, 40h ; write to file	
   739 000003E8 CD21                    	int	21h
   740 000003EA 0F8214FE                	jc	R_26 ; write error message then exit
   741                                  	
   742 000003EE 4F                      	dec	di
   743 000003EF 75F3                    	jnz	short R_36
   744                                  
   745 000003F1 BE[E015]                	mov	si, msg_OK
   746 000003F4 E80B01                  	call	print_msg
   747                                  
   748                                  	;mov	si, CRLF
   749                                  	;call	print_msg
   750                                  
   751 000003F7 BE[8415]                	mov	si, msg_writing_root_dir
   752 000003FA E80501                  	call	print_msg
   753                                  
   754 000003FD 8B3E[1109]              	mov	di, [bsRootDirEnts]
   755 00000401 C1EF04                  	shr	di, 4 ; 240/16 = 15, 512/16 =  32 sectors
   756 00000404 8B1E[120B]              	mov	bx, [img_file_handle]
   757 00000408 BA[C616]                	mov	dx, HDFORMAT_ZERO_BUFF
   758                                  	;mov	cx, 512
   759                                  R_37:
   760 0000040B 28C0                    	sub	al, al
   761                                  	;mov	bx, [img_file_handle]
   762                                  	;mov	dx, HDFORMAT_ZERO_BUFF
   763                                  	;mov	cx, 512
   764 0000040D B440                    	mov	ah, 40h ; write to file	
   765 0000040F CD21                    	int	21h
   766 00000411 0F82EDFD                	jc	R_26 ; write error message then exit
   767                                  	
   768 00000415 4F                      	dec	di
   769 00000416 75F3                    	jnz	short R_37
   770                                  
   771 00000418 BE[E015]                	mov	si, msg_OK
   772 0000041B E8E400                  	call	print_msg
   773                                  
   774 0000041E B43E                    	mov	ah, 3Eh ; close file
   775 00000420 8B1E[120B]              	mov	bx, [img_file_handle]
   776 00000424 CD21                    	int	21h
   777                                  
   778 00000426 E968FE                  	jmp	R_32
   779                                  
   780                                  
   781                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   782                                  ; set & write volume name
   783                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   784                                  
   785                                  write_volume_name:
   786                                  	;mov	byte [vname_length], 11
   787                                  svn_fs:
   788                                  	; DI = (BS) Volume Label address
   789 00000429 BE[B215]                	mov	si, Msg_Volume_Name
   790 0000042C E8D300                  	call	print_msg
   791                                  
   792                                  	; get cursor position
   793                                  	; bh = 0  ; video page
   794 0000042F B403                    	mov     ah, 3 ; get cursor pos
   795 00000431 CD10                    	int     10h
   796 00000433 8916[B216]              	mov	[Cursor_Pos], dx
   797                                  
   798 00000437 E8EE00                  	call	rw_char
   799                                  	;jc	short svn_1
   800 0000043A 7216                    	jc	short svn_5
   801                                  svn_0:
   802 0000043C AC                      	lodsb
   803 0000043D 3C20                    	cmp	al, 20h
   804 0000043F 74FB                    	je	short svn_0 
   805                                  	;mov	di, [bp+47h) ; [BS_VolLab] ; FAT32
   806                                  	;mov	di, [bp+2Bh) ; [BS_VolLab] ; FAT16 (&FAT12)
   807 00000441 89FB                    	mov	bx, di ; *	
   808                                  	;ja	short svn_2
   809 00000443 720D                    	jb	short svn_5
   810                                  ;svn_1:
   811                                  ;	mov	si, no_name
   812                                  ;	lodsb
   813                                  svn_2:
   814 00000445 B90B00                  	mov	cx, 11; [vname_length]
   815 00000448 EB05                    	jmp	short svn_4
   816                                  svn_3:
   817 0000044A AC                      	lodsb
   818 0000044B 3C20                    	cmp	al, 20h
   819 0000044D 7225                    	jb	short svn_6
   820                                  svn_4:
   821 0000044F AA                      	stosb
   822 00000450 E2F8                    	loop	svn_3
   823                                  svn_5:
   824 00000452 B90B00                  	mov	cx, 11 ; [vname_length]
   825 00000455 89DE                    	mov	si, bx ; *
   826 00000457 BF[A615]                	mov	di, StrVolumeName
   827 0000045A F3A4                    	rep	movsb
   828                                  	;mov	byte [di], 0
   829                                  
   830 0000045C 8B16[B216]              	mov	dx, [Cursor_Pos]
   831 00000460 BB0700                  	mov	bx, 7
   832 00000463 B402                    	mov	ah, 2
   833 00000465 CD10                    	int	10h  ; Set Cursor Position
   834                                  
   835 00000467 BE[A615]                	mov	si, StrVolumeName
   836 0000046A E89500                  	call	print_msg
   837 0000046D BE[E415]                	mov	si, CRLF
   838 00000470 E88F00                  	call	print_msg
   839 00000473 C3                      	retn
   840                                  svn_6:
   841 00000474 B020                    	mov	al, 20h
   842                                  svn_7:
   843 00000476 AA                      	stosb
   844 00000477 E2FD                    	loop	svn_7
   845 00000479 EBD7                    	jmp	short svn_5
   846                                  
   847                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   848                                  ; set & write volume serial number (volume ID)
   849                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   850                                  
   851                                  write_volume_serial:
   852                                  	; SI = (BS) Volume Serial Number (binary) address
   853                                  
   854                                  	;xor	ax, ax
   855                                  	;int	1Ah			; get time of day
   856                                  
   857                                  	;mov	[si], dx
   858                                  	;mov	[si+2], cx		; set unique volume ID
   859                                  
   860                                  	;mov	ah, 02h			; Return Current Time
   861                                  	;int	1Ah
   862                                  	;xchg	ch, cl
   863                                  	;xchg	dh, dl
   864                                  
   865                                  	;add	cx, dx  
   866                                  	;add	[si+2], cx
   867                                                 
   868                                  	;mov	ah, 04h			; Return Current Date
   869                                  	;int	1Ah
   870                                  
   871                                  	;xchg	ch,cl
   872                                  	;xchg	dh,dl
   873                                  
   874                                  	;add	cx, dx  
   875                                  	;add	[si+2], cx
   876                                  
   877                                  	; According to Microsoft DOS 6.0 serial number
   878                                  	; production method...
   879                                  	; < Create unique 32 bit serial number >
   880                                  
   881                                  	; Create_Serial_ID (MSDOS 6.0 Source code, MSFOR.ASM)
   882                                  	; (20/04/1987)
   883                                  	;
   884                                  	;  Get date (INT 21h, AH=2Bh)
   885                                  	;  Get time (INT 21h, AH=2Ch)
   886                                  	;  Serial_ID+0 = DX reg date + DX reg time
   887                                  	;  Serial_ID+2 = CX reg date + CX reg time
   888                                  	;  Serial_Num_Low = Serial_ID+2
   889                                  	;  Serial_Num_High = Serial_ID+0
   890                                  
   891 0000047B B404                    	mov	ah, 04h		; Return Current Date
   892 0000047D CD1A                    	int	1Ah
   893                                  
   894                                  	; DL = Day (BCD)	(20h) 	
   895                                  	; DH = Month (BCD)	(12h)
   896                                  	; CH = Century (BCD)	(20h)
   897                                  	; CL = Year (BCD) 	(17h)
   898                                  
   899 0000047F 88D0                    	mov	al, dl
   900 00000481 E87100                  	call	bcd_to_bin
   901 00000484 88C2                    	mov	dl, al 
   902 00000486 88F0                    	mov	al, dh
   903 00000488 E86A00                  	call	bcd_to_bin
   904 0000048B 88C6                    	mov	dh, al 
   905 0000048D 88C8                    	mov	al, cl
   906 0000048F E86300                  	call	bcd_to_bin
   907 00000492 88C1                    	mov	cl, al 
   908 00000494 88E8                    	mov	al, ch
   909 00000496 E85C00                  	call	bcd_to_bin
   910 00000499 88C5                    	mov	ch, al
   911                                  
   912                                  	; DH = Month (1-10)
   913                                  	; DL = Day (1-31)
   914                                  	; CX = Year (1900-2099)
   915                                  
   916 0000049B 52                      	push	dx 
   917 0000049C 51                      	push	cx
   918                                  
   919 0000049D B402                    	mov	ah, 02h		; Return Current Time
   920 0000049F CD1A                    	int	1Ah
   921                                  	
   922                                  	; DH = Seconds (BCD)	(59h) 	
   923                                  	; CL = Minutes (BCD)	(59h)
   924                                  	; CH = Hours (BCD)	(23h)
   925                                  	; DL = Daylight savings time option (1=yes)
   926                                  
   927 000004A1 88F0                    	mov	al, dh
   928 000004A3 E84F00                  	call	bcd_to_bin
   929 000004A6 88C6                    	mov	dh, al 
   930 000004A8 88C8                    	mov	al, cl
   931 000004AA E84800                  	call	bcd_to_bin
   932 000004AD 88C1                    	mov	cl, al 
   933 000004AF 88E8                    	mov	al, ch
   934 000004B1 E84100                  	call	bcd_to_bin
   935 000004B4 88C5                    	mov	ch, al 
   936                                  
   937                                  	; CH = Hour (0-23)
   938                                  	; CL = Minutes (0-59)
   939                                  	; DH = Seconds (0-59)
   940                                  	; ((DL = Hundredths (0-99) - MSDOS!))
   941                                  	; DL = 0 or 1 (here!)
   942                                  
   943 000004B6 89C8                    	mov	ax, cx
   944 000004B8 59                      	pop	cx
   945 000004B9 01C8                    	add	ax, cx
   946                                  
   947 000004BB 894402                  	mov	[si+2], ax
   948                                  
   949 000004BE 89D0                    	mov	ax, dx
   950 000004C0 5A                      	pop	dx
   951 000004C1 01D0                    	add	ax, dx
   952                                  
   953 000004C3 8904                    	mov	[si], ax
   954                                  
   955 000004C5 30E4                    	xor	ah, ah		; Read time counter
   956 000004C7 CD1A                    	int	1Ah
   957                                  
   958                                  	; CX = High word of clock count
   959                                  	; DX = Low word of clock count
   960                                  	; AL = 0 if 24 hours has not passed, else 1
   961                                  
   962                                  	; NOTES: 
   963                                  	; (Ref: vitaly_filatov.tripod.com/ng/asm/asm_029.1.html)
   964                                  	;
   965                                     	; Following formulas convert the clock count to
   966                                          ; the time of day:
   967                                   	;	Hour      = Clock / 65543 (1007h)
   968                                  	;	Remainder = Clock MOD 65543
   969                                   	;
   970                                  	;	Minutes   = Remainder / 1092 (444h)
   971                                  	;	Remainder = Remainder MOD 1092
   972                                  	;
   973                                  	;	Second    = Remainder / 18.21
   974                                  	;	Remainder = Remainder MOD 18.21
   975                                  	;
   976                                  	;	Hundredths = CINT(Remainder * 100)
   977                                  
   978 000004C9 0014                    	add	[si], dl
   979                                  
   980                                  	; SI = Volume serial number address (4 bytes) 
   981 000004CB 8A04                    	mov	al, [si]
   982 000004CD E84100                  	call	bin_to_hex
   983 000004D0 A3[DB15]                	mov	[Vol_Serial2+2], ax	
   984 000004D3 8A4401                  	mov	al, [si+1]
   985 000004D6 E83800                  	call	bin_to_hex
   986 000004D9 A3[D915]                	mov	[Vol_Serial2], ax
   987 000004DC 8A4402                  	mov	al, [si+2]
   988 000004DF E82F00                  	call	bin_to_hex
   989 000004E2 A3[D615]                	mov	[Vol_Serial1+2], ax	
   990 000004E5 8A4403                  	mov	al, [si+3]
   991 000004E8 E82600                  	call	bin_to_hex
   992 000004EB A3[D415]                	mov	[Vol_Serial1], ax
   993                                  
   994 000004EE BE[C215]                	mov	si, Msg_Volume_Serial
   995 000004F1 E80E00                  	call	print_msg
   996                                  
   997 000004F4 C3                      	retn
   998                                  
   999                                  bcd_to_bin:
  1000 000004F5 53                      	push	bx
  1001 000004F6 D410                    	db	0D4h,10h  ; Undocumented inst. AAM
  1002                                  			  ; AH = AL / 10h
  1003                                  			  ; AL = AL MOD 10h
  1004 000004F8 88C3                    	mov	bl, al
  1005 000004FA B00A                    	mov	al, 10
  1006 000004FC F6E4                    	mul	ah
  1007 000004FE 00D8                    	add	al, bl
  1008 00000500 5B                      	pop	bx
  1009 00000501 C3                      	retn
  1010                                  
  1011                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1012                                  ; Print messages
  1013                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1014                                  
  1015                                  print_msg:
  1016                                  
  1017                                  print_msg_LOOP:
  1018 00000502 AC                      	lodsb                           ; Load byte at DS:SI to AL
  1019 00000503 20C0                    	and     al, al            
  1020 00000505 7409                    	jz      short print_msg_OK       
  1021 00000507 B40E                    	mov	ah, 0Eh			
  1022 00000509 BB0700                  	mov     bx, 07h             
  1023 0000050C CD10                    	int	10h			; BIOS Service func ( ah ) = 0Eh
  1024                                  					; Write char as TTY
  1025                                  					; AL-char BH-page BL-color
  1026 0000050E EBF2                    	jmp     short print_msg_LOOP           
  1027                                  
  1028                                  print_msg_OK:
  1029 00000510 C3                      	retn
  1030                                  
  1031                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1032                                  ; Convert byte to hexadecimal number
  1033                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1034                                  
  1035                                  bin_to_hex:
  1036                                  	; INPUT ->
  1037                                  	; 	AL = byte (binary number)
  1038                                  	; OUTPUT ->
  1039                                  	;	AX = hexadecimal string
  1040                                  	;
  1041 00000511 53                      	push	bx
  1042 00000512 31DB                    	xor	bx, bx
  1043 00000514 88C3                    	mov	bl, al
  1044 00000516 C0EB04                  	shr	bl, 4
  1045 00000519 8A9F[010B]              	mov	bl, [bx+hexchrs] 	 	
  1046 0000051D 86D8                    	xchg	bl, al
  1047 0000051F 80E30F                  	and	bl, 0Fh
  1048 00000522 8AA7[010B]              	mov	ah, [bx+hexchrs] 
  1049 00000526 5B                      	pop	bx	
  1050 00000527 C3                      	retn
  1051                                  
  1052                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1053                                  ; Read & Write characters
  1054                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1055                                  
  1056                                  rw_char:
  1057                                  	; OUTPUT -> DS:SI = Entered String (ASCIIZ)
  1058 00000528 BE[A615]                	mov     si, StrVolumeName
  1059 0000052B BB0700                  	mov     bx, 7
  1060 0000052E B403                    	mov     ah, 3
  1061 00000530 CD10                    	int     10h
  1062 00000532 8916[B216]              	mov     [Cursor_Pos], dx
  1063                                  read_next_char:
  1064 00000536 30E4                    	xor     ah, ah
  1065 00000538 CD16                    	int     16h
  1066 0000053A 20C0                    	and     al, al
  1067 0000053C 7439                    	jz      short loc_arrow    
  1068 0000053E 3CE0                    	cmp     al, 0E0h          
  1069 00000540 7435                    	je      short loc_arrow
  1070 00000542 3C08                    	cmp     al, 8
  1071 00000544 753D                    	jne     short char_return
  1072                                  loc_back:
  1073 00000546 B403                    	mov     ah, 3
  1074 00000548 CD10                    	int     10h
  1075 0000054A 3A16[B216]              	cmp     dl, byte [Cursor_Pos]
  1076 0000054E 761F                    	jna     short loc_beep
  1077                                  prev_column:
  1078 00000550 FECA                    	dec     dl
  1079                                  set_cursor_pos:
  1080 00000552 B402                    	mov     ah, 2
  1081 00000554 CD10                    	int     10h
  1082 00000556 88D3                    	mov     bl, dl
  1083 00000558 2A1E[B216]              	sub     bl, byte [Cursor_Pos] 
  1084 0000055C B90100                  	mov     cx, 1
  1085 0000055F B409                    	mov     ah, 9
  1086 00000561 B020                    	mov     al, 20h
  1087 00000563 8800                    	mov     [si+bx], al
  1088                                  loc_write_it:
  1089 00000565 B307                    	mov     bl, 7
  1090 00000567 CD10                    	int     10h
  1091 00000569 8B16[B216]              	mov     dx, [Cursor_Pos]
  1092 0000056D EBC7                    	jmp     short read_next_char
  1093                                  loc_beep:
  1094 0000056F B40E                    	mov     ah, 0Eh
  1095 00000571 B007                    	mov     al, 7
  1096 00000573 CD10                    	int     10h
  1097 00000575 EBBF                    	jmp     short read_next_char
  1098                                  loc_arrow:    
  1099 00000577 80FC4B                  	cmp     ah, 4Bh
  1100 0000057A 74CA                    	je      short loc_back
  1101 0000057C 80FC53                  	cmp     ah, 53h
  1102 0000057F 74C5                    	je      short loc_back
  1103 00000581 EBB3                    	jmp     short read_next_char
  1104                                  char_return:
  1105 00000583 B403                    	mov     ah, 3
  1106 00000585 CD10                    	int     10h
  1107                                  check_char_type:
  1108 00000587 3C20                    	cmp     al, 20h
  1109 00000589 7228                    	jb      short loc_escape
  1110 0000058B 88D4                    	mov     ah, dl
  1111 0000058D 2A26[B216]              	sub     ah, byte [Cursor_Pos]
  1112                                  	;cmp	ah, 10 
  1113                                  	;ja	short loc_beep
  1114 00000591 80FC0B                  	cmp     ah, 11 ; [vname_length]
  1115 00000594 73D9                    	jnb	short loc_beep
  1116 00000596 3C7A                    	cmp     al, 'z'
  1117 00000598 779C                    	ja      short read_next_char
  1118 0000059A 3C61                    	cmp     al, 'a'
  1119 0000059C 7202                    	jb      short pass_capitalize
  1120 0000059E 24DF                    	and     al, 0DFh
  1121                                  pass_capitalize:
  1122 000005A0 88E3                    	mov     bl, ah 
  1123 000005A2 30E4                    	xor     ah, ah
  1124 000005A4 8900                    	mov     [si+bx], ax
  1125 000005A6 B307                    	mov     bl, 7
  1126 000005A8 B40E                    	mov     ah, 0Eh
  1127 000005AA CD10                    	int     10h
  1128 000005AC EB88                    	jmp     short read_next_char
  1129                                  pass_escape:
  1130 000005AE 3C0D                    	cmp     al, 0Dh	; 13 ; ENTER
  1131 000005B0 7584                    	jne     short read_next_char
  1132                                  	;mov	ah, 0Eh
  1133                                  	;int	10h
  1134                                  	;mov	al, 0Ah
  1135                                  	;int	10h
  1136 000005B2 C3                      	retn
  1137                                  loc_escape:
  1138 000005B3 3C1B                    	cmp     al, 1Bh	; 27 ; ESC
  1139 000005B5 75F7                    	jne     short pass_escape
  1140 000005B7 F9                      	stc
  1141 000005B8 C3                      	retn
  1142                                  
  1143                                  write_chs_table:
  1144                                  	; clear screen
  1145 000005B9 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  1146 000005BC CD10                    	int	10h
  1147                                  
  1148 000005BE BE[140B]                	mov	si, Dsk_Type_Select_msg
  1149 000005C1 E83EFF                  	call	print_msg
  1150                                  
  1151 000005C4 C3                      	retn
  1152                                  
  1153                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1154                                  ;  Data
  1155                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1156                                  
  1157                                  DskTypeParms:
  1158                                  DskType1Parms:
  1159 000005C5 3201                    cyl1:	dw 306
  1160 000005C7 0400                    hed1:	dw 4
  1161 000005C9 1100                    spt1:	dw 17
  1162 000005CB 4851                    cap1:	dw 306*4*17
  1163                                  DskType2Parms:
  1164 000005CD 3201                    cyl2:	dw 306
  1165 000005CF 0800                    hed2:	dw 8
  1166 000005D1 1100                    spt2:	dw 17
  1167 000005D3 90A2                    cap2:	dw 306*8*17
  1168                                  DskType3Parms:
  1169 000005D5 CE01                    cyl3:	dw 462
  1170 000005D7 0800                    hed3:	dw 8
  1171 000005D9 1100                    spt3:	dw 17
  1172 000005DB 70F5                    cap3:	dw 462*8*17
  1173                                  DskType4Parms:
  1174 000005DD 1400                    cyl4:	dw 20
  1175 000005DF 1000                    hed4:	dw 16
  1176 000005E1 3F00                    spt4:	dw 63
  1177 000005E3 C04E                    cap4:	dw 20*16*63
  1178                                  DskType5Parms:
  1179 000005E5 2000                    cyl5:	dw 32
  1180 000005E7 1000                    hed5:	dw 16
  1181 000005E9 3F00                    spt5:	dw 63
  1182 000005EB 007E                    cap5:	dw 32*16*63
  1183                                  DskType6Parms:
  1184 000005ED 2800                    cyl6:	dw 40
  1185 000005EF 1000                    hed6:	dw 16
  1186 000005F1 3F00                    spt6:	dw 63
  1187 000005F3 809D                    cap6:	dw 40*16*63
  1188                                  DskType7Parms:
  1189 000005F5 4000                    cyl7:	dw 64
  1190 000005F7 1000                    hed7:	dw 16
  1191 000005F9 3F00                    spt7:	dw 63
  1192 000005FB 00FC                    cap7:	dw 64*16*63
  1193                                  
  1194                                  partition_parms:
  1195                                  
  1196                                  Partition_4MB_17: ; 1
  1197 000005FD 0400                    secpc0a: dw 4
  1198 000005FF EC07                    clsts0a: dw 2028
  1199 00000601 0001                    roote0a: dw 256
  1200 00000603 1100                    hidds0a: dw 17
  1201 00000605 0100                    ressc0a: dw 1
  1202 00000607 0600                    fatsc0a: dw 6
  1203 00000609 0D00                    rootd0a: dw 13
  1204 0000060B 1D00                    fdats0a: dw 29
  1205 0000060D CF1F                    parts0a: dw (60*8*17)-17 ; 8143 (2 sectors free)
  1206                                  
  1207                                  Partition_4MB_63: ; 2
  1208 0000060F 0400                    secpc0b: dw 4
  1209 00000611 C907                    clsts0b: dw 1993
  1210 00000613 0001                    roote0b: dw 256
  1211 00000615 3F00                    hidds0b: dw 63
  1212 00000617 0100                    ressc0b: dw 1
  1213 00000619 0600                    fatsc0b: dw 6
  1214 0000061B 0D00                    rootd0b: dw 13
  1215 0000061D 1D00                    fdats0b: dw 29
  1216 0000061F 411F                    parts0b: dw (8*16*63)-63 ; 8001 (0 sector free)
  1217                                  
  1218                                  Partition_8MB_17: ; 3
  1219 00000621 0800                    secpc1a: dw 8
  1220 00000623 F007                    clsts1a: dw 2032
  1221 00000625 0002                    roote1a: dw 512
  1222 00000627 1100                    hidds1a: dw 17
  1223 00000629 0100                    ressc1a: dw 1
  1224 0000062B 0600                    fatsc1a: dw 6
  1225 0000062D 0D00                    rootd1a: dw 13
  1226 0000062F 2D00                    fdats1a: dw 45
  1227 00000631 AF3F                    parts1a: dw (120*8*17)-17 ; 16303 (2 sectors free)
  1228                                  
  1229                                  Partition_8MB_63: ; 4
  1230 00000633 0800                    secpc1b: dw 8
  1231 00000635 D207                    clsts1b: dw 2002
  1232 00000637 0002                    roote1b: dw 512
  1233 00000639 3F00                    hidds1b: dw 63
  1234 0000063B 0100                    ressc1b: dw 1
  1235 0000063D 0600                    fatsc1b: dw 6
  1236 0000063F 0D00                    rootd1b: dw 13
  1237 00000641 2D00                    fdats1b: dw 45
  1238 00000643 C13E                    parts1b: dw (16*16*63)-63 ; 16065 (4 sectors free)
  1239                                  
  1240                                  Partition_10MB_17: ; 5
  1241 00000645 0800                    secpc2a: dw 8
  1242 00000647 200A                    clsts2a: dw 2592
  1243 00000649 0002                    roote2a: dw 512
  1244 0000064B 1100                    hidds2a: dw 17
  1245 0000064D 0100                    ressc2a: dw 1
  1246 0000064F 0800                    fatsc2a: dw 8
  1247 00000651 1100                    rootd2a: dw 17
  1248 00000653 3100                    fdats2a: dw 49
  1249 00000655 3751                    parts2a: dw (306*4*17)-17 ; 20791 (6 sectors free)
  1250                                  
  1251                                  Partition_10MB_63: ; 6
  1252 00000657 0800                    secpc2b: dw 8
  1253 00000659 CA09                    clsts2b: dw 2506
  1254 0000065B 0002                    roote2b: dw 512
  1255 0000065D 3F00                    hidds2b: dw 63
  1256 0000065F 0100                    ressc2b: dw 1
  1257 00000661 0800                    fatsc2b: dw 8
  1258 00000663 1100                    rootd2b: dw 17
  1259 00000665 3100                    fdats2b: dw 49
  1260 00000667 814E                    parts2b: dw (20*16*63)-63 ; 20097 (0 sector free)
  1261                                  
  1262                                  Partition_16MB_17: ; 7
  1263 00000669 0800                    secpc3a: dw 8
  1264 0000066B E60F                    clsts3a: dw 4070
  1265 0000066D 0002                    roote3a: dw 512
  1266 0000066F 1100                    hidds3a: dw 17
  1267 00000671 0100                    ressc3a: dw 1
  1268 00000673 0C00                    fatsc3a: dw 12
  1269 00000675 1900                    rootd3a: dw 25
  1270 00000677 3900                    fdats3a: dw 57
  1271 00000679 6F7F                    parts3a: dw (240*8*17)-17 ; 32623 (6 sectors free)
  1272                                  
  1273                                  Partition_16MB_63: ; 8
  1274 0000067B 0800                    secpc3b: dw 8
  1275 0000067D B10F                    clsts3b: dw 4017
  1276 0000067F 0002                    roote3b: dw 512
  1277 00000681 3F00                    hidds3b: dw 63
  1278 00000683 0100                    ressc3b: dw 1
  1279 00000685 0C00                    fatsc3b: dw 12
  1280 00000687 1900                    rootd3b: dw 25
  1281 00000689 3900                    fdats3b: dw 57
  1282 0000068B C17D                    parts3b: dw (32*16*63)-63 ; 32193 (0 sector free)					
  1283                                  
  1284                                  Partition_20MB_17: ; 9
  1285 0000068D 1000                    secpc4a: dw 16
  1286 0000068F 220A                    clsts4a: dw 2594
  1287 00000691 0004                    roote4a: dw 1024
  1288 00000693 1100                    hidds4a: dw 17
  1289 00000695 0100                    ressc4a: dw 1
  1290 00000697 0800                    fatsc4a: dw 8
  1291 00000699 1100                    rootd4a: dw 17
  1292 0000069B 5100                    fdats4a: dw 81
  1293 0000069D 7FA2                    parts4a: dw (306*8*17)-17 ; 41599 (14 sectors free)
  1294                                  
  1295                                  Partition_20MB_63: ; 10	
  1296 0000069F 1000                    secpc4b: dw 16
  1297 000006A1 CF09                    clsts4b: dw 2511
  1298 000006A3 0004                    roote4b: dw 1024
  1299 000006A5 3F00                    hidds4b: dw 63
  1300 000006A7 0100                    ressc4b: dw 1
  1301 000006A9 0800                    fatsc4b: dw 8
  1302 000006AB 1100                    rootd4b: dw 17
  1303 000006AD 5100                    fdats4b: dw 81
  1304 000006AF 419D                    parts4b: dw (40*16*63)-63 ; 40257 (0 sector free)
  1305                                  
  1306                                  Partition_31MB:    ; 11
  1307 000006B1 1000                    secpc5a: dw 16
  1308 000006B3 500F                    clsts5a: dw 3920
  1309 000006B5 0004                    roote5a: dw 1024
  1310 000006B7 1100                    hidds5a: dw 17
  1311 000006B9 0100                    ressc5a: dw 1
  1312 000006BB 0C00                    fatsc5a: dw 12
  1313 000006BD 1900                    rootd5a: dw 25
  1314 000006BF 5900                    fdats5a: dw 89
  1315 000006C1 5FF5                    parts5a: dw (462*8*17)-17 ; 62815 (6 sectors free)
  1316                                  
  1317                                  Partition_32MB:	  ;  12
  1318 000006C3 1000                    secpc5b: dw 16
  1319 000006C5 B60F                    clsts5b: dw 4022
  1320 000006C7 0004                    roote5b: dw 1024
  1321 000006C9 3F00                    hidds5b: dw 63
  1322 000006CB 0100                    ressc5b: dw 1
  1323 000006CD 0C00                    fatsc5b: dw 12
  1324 000006CF 1900                    rootd5b: dw 25
  1325 000006D1 5900                    fdats5b: dw 89
  1326 000006D3 C1FB                    parts5b: dw (64*16*63)-63 ; 64449 (8 sectors free)
  1327                                  
  1328                                  
  1329                                  OptionValidatingTable:
  1330                                  ; 	Option  4MB,8MB,10M,16M,20M,WHOLE DISK	
  1331 000006D5 010005000005            	db	 1,  0,  5,  0,  0,  5   ; 10MB, 17SPT	 	
  1332 000006DB 010305000909            	db	 1,  3,  5,  0,  9,  9	 ; 20MB, 17SPT
  1333 000006E1 01030507000B            	db	 1,  3,  5,  7,  0, 11   ; 31MB, 17SPT	 	
  1334 000006E7 020006000006            	db	 2,  0,  6,  0,  0,  6   ; 10MB, 63SPT	 	
  1335 000006ED 020400080008            	db	 2,  4,  0,  8,  0,  8	 ; 16MB, 63SPT
  1336 000006F3 020406000A0A            	db	 2,  4,  6,  0, 10, 10	 ; 20MB, 63SPT
  1337 000006F9 02040608000C            	db	 2,  4,  6,  8,  0, 12   ; 32MB, 63SPT
  1338                                  
  1339 000006FF 00                      	db	0
  1340                                  
  1341                                  RETRODOS_MASTERBOOT_SECTOR:
  1342 00000700 <incbin>                	incbin	'FS1_MBR.BIN' ; Singlix FS1 MBR	
  1343                                  
  1344                                  RETRODOS_FAT12_hd_bs: 
  1345 00000900 <incbin>                	incbin	'RD2HDBS.BIN'
  1346                                  
  1347 00000B00 00                      	db	0
  1348                                  
  1349                                  hexchrs:
  1350 00000B01 303132333435363738-     	db	'0123456789ABCDEF'
  1351 00000B0A 39414243444546     
  1352                                  
  1353 00000B11 90                      align 2
  1354                                  
  1355                                  img_file_handle:
  1356 00000B12 0000                    	dw	0
  1357                                  
  1358                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1359                                  ;  Messages
  1360                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1361                                  
  1362                                  Dsk_Type_Select_msg:
  1363 00000B14 524554524F20444F53-     db  "RETRO DOS v2.0 Hard Disk Image Utility by Erdogan Tan (2018)                    "
  1364 00000B1D 2076322E3020486172-
  1365 00000B26 64204469736B20496D-
  1366 00000B2F 616765205574696C69-
  1367 00000B38 747920627920457264-
  1368 00000B41 6F67616E2054616E20-
  1369 00000B4A 283230313829202020-
  1370 00000B53 202020202020202020-
  1371 00000B5C 2020202020202020   
  1372 00000B64 202020202020202020-     db  "                                                                                "
  1373 00000B6D 202020202020202020-
  1374 00000B76 202020202020202020-
  1375 00000B7F 202020202020202020-
  1376 00000B88 202020202020202020-
  1377 00000B91 202020202020202020-
  1378 00000B9A 202020202020202020-
  1379 00000BA3 202020202020202020-
  1380 00000BAC 2020202020202020   
  1381 00000BB4 202020202020202020-     db  "                                                                                "
  1382 00000BBD 202020202020202020-
  1383 00000BC6 202020202020202020-
  1384 00000BCF 202020202020202020-
  1385 00000BD8 202020202020202020-
  1386 00000BE1 202020202020202020-
  1387 00000BEA 202020202020202020-
  1388 00000BF3 202020202020202020-
  1389 00000BFC 2020202020202020   
  1390 00000C04 4469736B2054797065-     db  "Disk Type     Cylinders     Heads     Sectors       Capacity                    "
  1391 00000C0D 202020202043796C69-
  1392 00000C16 6E6465727320202020-
  1393 00000C1F 204865616473202020-
  1394 00000C28 2020536563746F7273-
  1395 00000C31 202020202020204361-
  1396 00000C3A 706163697479202020-
  1397 00000C43 202020202020202020-
  1398 00000C4C 2020202020202020   
  1399 00000C54 2D2D2D2D2D2D2D2D2D-     db  "---------     ---------     -----     -------       --------                    "
  1400 00000C5D 20202020202D2D2D2D-
  1401 00000C66 2D2D2D2D2D20202020-
  1402 00000C6F 202D2D2D2D2D202020-
  1403 00000C78 20202D2D2D2D2D2D2D-
  1404 00000C81 202020202020202D2D-
  1405 00000C8A 2D2D2D2D2D2D202020-
  1406 00000C93 202020202020202020-
  1407 00000C9C 2020202020202020   
  1408 00000CA4 202020202031202020-     db  "     1           306          4         17            10 MB                     "
  1409 00000CAD 202020202020202033-
  1410 00000CB6 303620202020202020-
  1411 00000CBF 202020342020202020-
  1412 00000CC8 202020203137202020-
  1413 00000CD1 202020202020202020-
  1414 00000CDA 3130204D4220202020-
  1415 00000CE3 202020202020202020-
  1416 00000CEC 2020202020202020   
  1417 00000CF4 202020202032202020-     db  "     2           306          8         17            20 MB                     "
  1418 00000CFD 202020202020202033-
  1419 00000D06 303620202020202020-
  1420 00000D0F 202020382020202020-
  1421 00000D18 202020203137202020-
  1422 00000D21 202020202020202020-
  1423 00000D2A 3230204D4220202020-
  1424 00000D33 202020202020202020-
  1425 00000D3C 2020202020202020   
  1426 00000D44 202020202033202020-     db  "     3           462          8         17            31 MB                     " 	      	     	
  1427 00000D4D 202020202020202034-
  1428 00000D56 363220202020202020-
  1429 00000D5F 202020382020202020-
  1430 00000D68 202020203137202020-
  1431 00000D71 202020202020202020-
  1432 00000D7A 3331204D4220202020-
  1433 00000D83 202020202020202020-
  1434 00000D8C 2020202020202020   
  1435 00000D94 202020202020202020-     db  "                                                                                "
  1436 00000D9D 202020202020202020-
  1437 00000DA6 202020202020202020-
  1438 00000DAF 202020202020202020-
  1439 00000DB8 202020202020202020-
  1440 00000DC1 202020202020202020-
  1441 00000DCA 202020202020202020-
  1442 00000DD3 202020202020202020-
  1443 00000DDC 2020202020202020   
  1444 00000DE4 202020202034202020-     db  "     4            20         16         63            10 MB                     "
  1445 00000DED 202020202020202020-
  1446 00000DF6 323020202020202020-
  1447 00000DFF 202031362020202020-
  1448 00000E08 202020203633202020-
  1449 00000E11 202020202020202020-
  1450 00000E1A 3130204D4220202020-
  1451 00000E23 202020202020202020-
  1452 00000E2C 2020202020202020   
  1453 00000E34 202020202035202020-     db  "     5            32         16         63            16 MB                     "   	
  1454 00000E3D 202020202020202020-
  1455 00000E46 333220202020202020-
  1456 00000E4F 202031362020202020-
  1457 00000E58 202020203633202020-
  1458 00000E61 202020202020202020-
  1459 00000E6A 3136204D4220202020-
  1460 00000E73 202020202020202020-
  1461 00000E7C 2020202020202020   
  1462 00000E84 202020202036202020-     db  "     6            40         16         63            20 MB                     "
  1463 00000E8D 202020202020202020-
  1464 00000E96 343020202020202020-
  1465 00000E9F 202031362020202020-
  1466 00000EA8 202020203633202020-
  1467 00000EB1 202020202020202020-
  1468 00000EBA 3230204D4220202020-
  1469 00000EC3 202020202020202020-
  1470 00000ECC 2020202020202020   
  1471 00000ED4 202020202037202020-     db  "     7            64         16         63            32 MB                     " 	 
  1472 00000EDD 202020202020202020-
  1473 00000EE6 363420202020202020-
  1474 00000EEF 202031362020202020-
  1475 00000EF8 202020203633202020-
  1476 00000F01 202020202020202020-
  1477 00000F0A 3332204D4220202020-
  1478 00000F13 202020202020202020-
  1479 00000F1C 2020202020202020   
  1480 00000F24 202020202020202020-     db  "                                                                                "
  1481 00000F2D 202020202020202020-
  1482 00000F36 202020202020202020-
  1483 00000F3F 202020202020202020-
  1484 00000F48 202020202020202020-
  1485 00000F51 202020202020202020-
  1486 00000F5A 202020202020202020-
  1487 00000F63 202020202020202020-
  1488 00000F6C 2020202020202020   
  1489 00000F74 202020202020202020-     db  "                                                                                "
  1490 00000F7D 202020202020202020-
  1491 00000F86 202020202020202020-
  1492 00000F8F 202020202020202020-
  1493 00000F98 202020202020202020-
  1494 00000FA1 202020202020202020-
  1495 00000FAA 202020202020202020-
  1496 00000FB3 202020202020202020-
  1497 00000FBC 2020202020202020   
  1498 00000FC4 507265737320646973-     db  "Press disk number (1 to 6) to SELECT or                                         "
  1499 00000FCD 6B206E756D62657220-
  1500 00000FD6 283120746F20362920-
  1501 00000FDF 746F2053454C454354-
  1502 00000FE8 206F72202020202020-
  1503 00000FF1 202020202020202020-
  1504 00000FFA 202020202020202020-
  1505 00001003 202020202020202020-
  1506 0000100C 2020202020202020   
  1507 00001014 202020202020202020-     db  "                                                                                " 
  1508 0000101D 202020202020202020-
  1509 00001026 202020202020202020-
  1510 0000102F 202020202020202020-
  1511 00001038 202020202020202020-
  1512 00001041 202020202020202020-
  1513 0000104A 202020202020202020-
  1514 00001053 202020202020202020-
  1515 0000105C 2020202020202020   
  1516 00001064 507265737320455343-     db  "Press ESC to cancel.                                                            "
  1517 0000106D 20746F2063616E6365-
  1518 00001076 6C2E20202020202020-
  1519 0000107F 202020202020202020-
  1520 00001088 202020202020202020-
  1521 00001091 202020202020202020-
  1522 0000109A 202020202020202020-
  1523 000010A3 202020202020202020-
  1524 000010AC 2020202020202020   
  1525 000010B4 202020202020202020-     db  "                                                                                " 
  1526 000010BD 202020202020202020-
  1527 000010C6 202020202020202020-
  1528 000010CF 202020202020202020-
  1529 000010D8 202020202020202020-
  1530 000010E1 202020202020202020-
  1531 000010EA 202020202020202020-
  1532 000010F3 202020202020202020-
  1533 000010FC 2020202020202020   
  1534 00001104 00                      db  0
  1535                                  
  1536                                  RetroDOS_Welcome:
  1537 00001105 0D0A                    	db	0Dh, 0Ah
  1538 00001107 526574726F20444F53-     	db	'Retro DOS v2.0 Fixed Disk Image Format Utility'
  1539 00001110 2076322E3020466978-
  1540 00001119 6564204469736B2049-
  1541 00001122 6D61676520466F726D-
  1542 0000112B 6174205574696C6974-
  1543 00001134 79                 
  1544 00001135 0D0A                    	db	0Dh, 0Ah
  1545 00001137 76312E302E32303035-     	db	"v1.0.200518  (c) Erdogan TAN 2018"
  1546 00001140 313820202863292045-
  1547 00001149 72646F67616E205441-
  1548 00001152 4E2032303138       
  1549 00001158 0D0A                    	db	0Dh,0Ah
  1550 0000115A 0D0A                    	db	0Dh,0Ah
  1551 0000115C 55736167653A207264-     	db	'Usage: rdhdimg <image file name> '
  1552 00001165 6864696D67203C696D-
  1553 0000116E 6167652066696C6520-
  1554 00001177 6E616D653E20       
  1555 0000117D 00                      	db	0
  1556                                  
  1557                                  msg_inv_file_name: 
  1558 0000117E 0D0A                    	db	0Dh, 0Ah
  1559 00001180 496E76616C69642066-     	db	"Invalid file name !", 0Dh, 0Ah
  1560 00001189 696C65206E616D6520-
  1561 00001192 210D0A             
  1562 00001195 2846696C65206E616D-     	db	"(File name must fit to 8.3 DOS format) !"
  1563 0000119E 65206D757374206669-
  1564 000011A7 7420746F20382E3320-
  1565 000011B0 444F5320666F726D61-
  1566 000011B9 74292021           
  1567 000011BD 0D0A00                  	db	0Dh, 0Ah, 0
  1568                                  
  1569                                  msg_inv_image_file:
  1570 000011C0 0D0A                    	db	0Dh, 0Ah
  1571 000011C2 496E76616C69642066-     	db	"Invalid fixed disk image file !", 0Dh, 0Ah
  1572 000011CB 69786564206469736B-
  1573 000011D4 20696D616765206669-
  1574 000011DD 6C6520210D0A       
  1575 000011E3 2846696C652073697A-     	db	"(File size is not compatible) !"
  1576 000011EC 65206973206E6F7420-
  1577 000011F5 636F6D70617469626C-
  1578 000011FE 65292021           
  1579 00001202 0D0A00                  	db	0Dh, 0Ah, 0 
  1580                                  
  1581                                  msg_option_not_proper:
  1582 00001205 53656C656374656420-     	db	"Selected partion size is not proper for selected disk size !"
  1583 0000120E 70617274696F6E2073-
  1584 00001217 697A65206973206E6F-
  1585 00001220 742070726F70657220-
  1586 00001229 666F722073656C6563-
  1587 00001232 746564206469736B20-
  1588 0000123B 73697A652021       
  1589 00001241 0D0A                    	db	0Dh, 0Ah
  1590 00001243 28596F75206E656564-     	db	"(You need to select another option.)"
  1591 0000124C 20746F2073656C6563-
  1592 00001255 7420616E6F74686572-
  1593 0000125E 206F7074696F6E2E29 
  1594 00001267 0D0D00                  	db	0Dh, 0Dh, 0 
  1595                                  
  1596                                  msg_any_key_esc_exit:
  1597 0000126A 0D0A                    	db	0Dh, 0Ah
  1598 0000126C 507265737320455343-     	db	"Press ESC to exit or press another key to continue..."
  1599 00001275 20746F206578697420-
  1600 0000127E 6F7220707265737320-
  1601 00001287 616E6F74686572206B-
  1602 00001290 657920746F20636F6E-
  1603 00001299 74696E75652E2E2E   
  1604 000012A1 00                      	db	0
  1605                                  
  1606                                  msg_create_dos_partition_h:
  1607 000012A2 0D0A                    	db	0Dh, 0Ah
  1608 000012A4 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  1609 000012AD 2D2D2D2D2D2D2D2D2D-
  1610 000012B6 2D2D2D2D2D2D2D2D2D-
  1611 000012BF 2D2D2D2D2D2D2D2D2D-
  1612 000012C8 2D2D2D2D2D2D2D2D2D-
  1613 000012D1 2D2D2D2D2D2D2D2D2D-
  1614 000012DA 2D2D2D2D2D2D2D2D2D-
  1615 000012E3 2D2D2D2D2D2D2D2D2D-
  1616 000012EC 2D2D2D2D2D2D2D2D   
  1617 000012F4 202020202020202020-     	db	"                        Create Primary DOS Partition                            "
  1618 000012FD 202020202020202020-
  1619 00001306 202020202020437265-
  1620 0000130F 617465205072696D61-
  1621 00001318 727920444F53205061-
  1622 00001321 72746974696F6E2020-
  1623 0000132A 202020202020202020-
  1624 00001333 202020202020202020-
  1625 0000133C 2020202020202020   
  1626 00001344 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"	
  1627 0000134D 2D2D2D2D2D2D2D2D2D-
  1628 00001356 2D2D2D2D2D2D2D2D2D-
  1629 0000135F 2D2D2D2D2D2D2D2D2D-
  1630 00001368 2D2D2D2D2D2D2D2D2D-
  1631 00001371 2D2D2D2D2D2D2D2D2D-
  1632 0000137A 2D2D2D2D2D2D2D2D2D-
  1633 00001383 2D2D2D2D2D2D2D2D2D-
  1634 0000138C 2D2D2D2D2D2D2D2D   
  1635 00001394 0D0A00                  	db	0Dh, 0Ah, 0	
  1636                                  msg_create_dos_partition_m:
  1637 00001397 53656C65637420616E-     	db	"Select an option: "
  1638 000013A0 206F7074696F6E3A20 
  1639 000013A9 0D0A                    	db	0Dh, 0Ah
  1640 000013AB 0D0A                    	db	0Dh, 0Ah
  1641 000013AD 202031292055736520-     	db	"  1) Use  4 MB disk space for FAT12 partition ", 0Dh, 0Ah
  1642 000013B6 2034204D4220646973-
  1643 000013BF 6B2073706163652066-
  1644 000013C8 6F7220464154313220-
  1645 000013D1 706172746974696F6E-
  1646 000013DA 200D0A             
  1647 000013DD 202032292055736520-     	db	"  2) Use  8 MB disk space for FAT12 partition ", 0Dh, 0Ah
  1648 000013E6 2038204D4220646973-
  1649 000013EF 6B2073706163652066-
  1650 000013F8 6F7220464154313220-
  1651 00001401 706172746974696F6E-
  1652 0000140A 200D0A             
  1653 0000140D 202033292055736520-     	db	"  3) Use 10 MB disk space for FAT12 partition ", 0Dh, 0Ah
  1654 00001416 3130204D4220646973-
  1655 0000141F 6B2073706163652066-
  1656 00001428 6F7220464154313220-
  1657 00001431 706172746974696F6E-
  1658 0000143A 200D0A             
  1659 0000143D 202034292055736520-     	db	"  4) Use 16 MB disk space for FAT12 partition ", 0Dh, 0Ah
  1660 00001446 3136204D4220646973-
  1661 0000144F 6B2073706163652066-
  1662 00001458 6F7220464154313220-
  1663 00001461 706172746974696F6E-
  1664 0000146A 200D0A             
  1665 0000146D 202035292055736520-     	db	"  5) Use 20 MB disk space for FAT12 partition ", 0Dh, 0Ah
  1666 00001476 3230204D4220646973-
  1667 0000147F 6B2073706163652066-
  1668 00001488 6F7220464154313220-
  1669 00001491 706172746974696F6E-
  1670 0000149A 200D0A             
  1671 0000149D 202036292055736520-     	db	"  6) Use whole disk space for FAT12 partition ", 0Dh, 0Ah
  1672 000014A6 77686F6C6520646973-
  1673 000014AF 6B2073706163652066-
  1674 000014B8 6F7220464154313220-
  1675 000014C1 706172746974696F6E-
  1676 000014CA 200D0A             
  1677 000014CD 0D0A                    	db	0Dh, 0Ah	
  1678 000014CF 507265737320455343-     	db	"Press ESC or 0 to exit .. "
  1679 000014D8 206F72203020746F20-
  1680 000014E1 65786974202E2E20   
  1681 000014E9 0D0A00                   	db 	0Dh, 0Ah, 0
  1682                                  
  1683                                  msg_overwrite_question1:
  1684 000014EC 0D0A                    	db	0Dh, 0Ah
  1685 000014EE 446F20796F75207761-     	db	'Do you want to overwrite '
  1686 000014F7 6E7420746F206F7665-
  1687 00001500 72777269746520     
  1688 00001507 27                      	db	27h
  1689 00001508 00                      	db	0
  1690                                  
  1691                                  msg_overwrite_question2: 
  1692 00001509 27                      	db	27h
  1693 0000150A 2066696C6520            	db	' file '
  1694 00001510 00                      	db	0
  1695                                  
  1696                                  msg_yes_no:
  1697 00001511 285965732F4E6F293F-     	db	'(Yes/No)? ', 0	
  1698 0000151A 2000               
  1699                                  
  1700                                  msg_writing_mbr:
  1701 0000151C 57726974696E67206D-     	db	"Writing masterboot sector...", 0
  1702 00001525 6173746572626F6F74-
  1703 0000152E 20736563746F722E2E-
  1704 00001537 2E00               
  1705                                  
  1706                                  msg_writing_disk_sectors:
  1707 00001539 57726974696E672064-     	db	"Writing disk sector: ", 0
  1708 00001542 69736B20736563746F-
  1709 0000154B 723A2000           
  1710                                  
  1711                                  msg_writing_boot_sector:
  1712 0000154F 57726974696E672076-     	db	"Writing volume boot sector...", 0
  1713 00001558 6F6C756D6520626F6F-
  1714 00001561 7420736563746F722E-
  1715 0000156A 2E2E00             
  1716                                  
  1717                                  msg_writing_FAT_sectors:
  1718 0000156D 57726974696E672046-     	db	"Writing FAT sectors...", 0
  1719 00001576 415420736563746F72-
  1720 0000157F 732E2E2E00         
  1721                                  
  1722                                  msg_writing_root_dir:
  1723 00001584 57726974696E672072-     	db	"Writing root directory sectors...", 0
  1724 0000158D 6F6F74206469726563-
  1725 00001596 746F72792073656374-
  1726 0000159F 6F72732E2E2E00     
  1727                                  
  1728                                  StrVolumeName:
  1729 000015A6 00<rept>                	times 	12 db  0
  1730                                  
  1731                                  Msg_Volume_Name:
  1732 000015B2 0D0A                    	db	0Dh, 0Ah
  1733 000015B4 566F6C756D65204E61-     	db	"Volume Name: ", 0
  1734 000015BD 6D653A2000         
  1735                                  
  1736                                  Msg_Volume_Serial:
  1737 000015C2 566F6C756D65205365-     	db	"Volume Serial No: "
  1738 000015CB 7269616C204E6F3A20 
  1739                                  Vol_Serial1:
  1740 000015D4 30303030                	db	"0000"
  1741 000015D8 2D                      	db	"-"
  1742                                  Vol_Serial2:
  1743 000015D9 30303030                	db	"0000"
  1744 000015DD 0D0A00                  	db	0Dh, 0Ah, 0
  1745                                  
  1746                                  msg_OK:
  1747 000015E0 204F4B2E                	db	' OK.'
  1748                                  CRLF:
  1749 000015E4 0D0A00                  	db	0Dh, 0Ah, 0
  1750                                  Msg_YES:
  1751 000015E7 20                      	db	 20h
  1752                                  msg_yes_:
  1753 000015E8 59455300                	db	'YES', 0
  1754                                  Msg_NO:
  1755 000015EC 20                      	db	20h
  1756                                  msg_no_:
  1757 000015ED 4E4F00                  	db	'NO', 0
  1758                                  
  1759                                  Msg_Error:
  1760 000015F0 0D0A                    	db	0Dh, 0Ah
  1761 000015F2 4572726F72202120        	db	'Error ! '
  1762 000015FA 28                      	db	'('
  1763                                  error_code:
  1764 000015FB 3030                    	dw	3030h
  1765 000015FD 68                      	db	'h'
  1766 000015FE 2920                    	db	') '
  1767 00001600 0D0A                    	db	0Dh, 0Ah
  1768 00001602 00                      	db	0
  1769                                  
  1770                                  msg_disk_type_selected:
  1771 00001603 4469736B2054797065-     	db	"Disk Type "
  1772 0000160C 20                 
  1773                                  delected_disk_num:
  1774 0000160D 202068617320626565-     	db	"  has been selected."
  1775 00001616 6E2073656C65637465-
  1776 0000161F 642E               
  1777 00001621 0D0A00                  	db 0Dh, 0Ah, 0
  1778                                  msg_enter_cancel:
  1779 00001624 0D0A                    	db	0Dh, 0Ah
  1780 00001626 507265737320454E54-     	db	"Press ENTER to write file or press ESC to cancel." 
  1781 0000162F 455220746F20777269-
  1782 00001638 74652066696C65206F-
  1783 00001641 722070726573732045-
  1784 0000164A 534320746F2063616E-
  1785 00001653 63656C2E           
  1786 00001657 0D0A00                  	db	0Dh, 0Ah, 0
  1787                                  
  1788                                  msg_press_any_key:
  1789 0000165A 0D0A                    	db	0Dh, 0Ah
  1790 0000165C 50726573732061206B-     	db	"Press a key to continue..." 
  1791 00001665 657920746F20636F6E-
  1792 0000166E 74696E75652E2E2E   
  1793 00001676 0D0A00                  	db	0Dh, 0Ah, 0
  1794                                  
  1795                                  msg_creating:
  1796 00001679 0D0A                    	db	0Dh, 0Ah
  1797 0000167B 4372656174696E6720      	db	"Creating "
  1798                                  msg_disk_size:
  1799 00001684 31304D422068617264-     	db	"10MB hard disk image... ",
  1800 0000168D 206469736B20696D61-
  1801 00001696 67652E2E2E20       
  1802 0000169C 20                      	db	" "
  1803 0000169D 00                      	db	0
  1804                                  
  1805                                  DskTypeNumStr:	
  1806 0000169E 313032303331313031-     	db	"10203110162032"
  1807 000016A7 3632303332         
  1808 000016AC 0000                    	dw	0
  1809                                  
  1810                                  RSymbols:
  1811 000016AE 2D5C7C2F                	db	"-\|/"
  1812                                  
  1813                                  align 2
  1814                                  
  1815                                  Cursor_Pos:
  1816 000016B2 0000                    	dw	0
  1817                                  
  1818                                  CWSector:
  1819 000016B4 0000                    	dw	0
  1820                                  
  1821                                  diskimage_size:
  1822 000016B6 0000                    	dw	0
  1823                                  
  1824                                  DiskType:
  1825 000016B8 00                      	db	0
  1826                                  
  1827                                  img_file_name:  
  1828 000016B9 00<rept>                	times	13 db 0
  1829                                  
  1830                                  ;no_name:
  1831                                  ;	db 	'NO NAME    ', 0
  1832                                  
  1833                                  align 2
  1834                                  
  1835                                  HDFORMAT_SECBUFFER:
  1836                                  HDFORMAT_FATBUFFER:
  1837                                  HDFORMAT_ZERO_BUFF:
  1838 000016C6 F6<rept>                	times	512 db 0F6h
  1839                                  
  1840 000018C6 00                      	db	0
  1841 000018C7 286329204572646F67-     	db	'(c) Erdogan TAN 2018'
  1842 000018D0 616E2054414E203230-
  1843 000018D9 3138               
  1844 000018DB 00                      	db	0
  1845                                  
  1846                                  SizeOfFile equ $-100
