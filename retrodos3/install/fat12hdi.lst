     1                                  ; ****************************************************************************
     2                                  ; 'fat12hdi.s' - Retro DOS v2/v3 Hard Disk Image (FAT12 FS) Formatting Utility
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; 'rdhdimg.s' (RDHDIMG.COM) - Retro DOS	v2 Hard Disk Image Formatting Utility
     5                                  ; 					 	          (for MSDOS/WINDOWS)
     6                                  ; ****************************************************************************
     7                                  ; Last Update: 28/10/2023 (Previous: 19/10/2018)
     8                                  ; ----------------------------------------------------------------------------
     9                                  ; Beginning: 07/05/2018
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Assembler: NASM version 2.11
    12                                  ; ----------------------------------------------------------------------------
    13                                  ; Derived from 'hdimage.s'(HDIMAGE.COM) source code by Erdogan Tan
    14                                  ; (03/02/2018) - TRDOS 386 hard disk image formatting utility -
    15                                  ; ****************************************************************************
    16                                  ; nasm fat12hdi.s -l fat12hdi.lst -o FAT12HDI.COM
    17                                  
    18                                  bsOemName	equ RETRODOS_FAT12_hd_bs + 3
    19                                  bsBytesPerSec	equ RETRODOS_FAT12_hd_bs + 11
    20                                  bsSecPerClust	equ RETRODOS_FAT12_hd_bs + 13
    21                                  bsResSectors	equ RETRODOS_FAT12_hd_bs + 14
    22                                  bsFATs		equ RETRODOS_FAT12_hd_bs + 16	
    23                                  bsRootDirEnts	equ RETRODOS_FAT12_hd_bs + 17
    24                                  bsSectors	equ RETRODOS_FAT12_hd_bs + 19
    25                                  bsMedia		equ RETRODOS_FAT12_hd_bs + 21
    26                                  bsFATsecs	equ RETRODOS_FAT12_hd_bs + 22
    27                                  bsSecPerTrk	equ RETRODOS_FAT12_hd_bs + 24
    28                                  bsHeads		equ RETRODOS_FAT12_hd_bs + 26
    29                                  bsHidden1	equ RETRODOS_FAT12_hd_bs + 28
    30                                  bsHidden2	equ RETRODOS_FAT12_hd_bs + 30	
    31                                  bsHugeSectors	equ RETRODOS_FAT12_hd_bs + 32
    32                                  bsDriveNumber   equ RETRODOS_FAT12_hd_bs + 36
    33                                  bsReserved1	equ RETRODOS_FAT12_hd_bs + 37
    34                                  bsBpbSignature	equ RETRODOS_FAT12_hd_bs + 38
    35                                  bsVolumeID      equ RETRODOS_FAT12_hd_bs + 39
    36                                  bsVolumeLabel   equ RETRODOS_FAT12_hd_bs + 43
    37                                  bsFileSysType	equ RETRODOS_FAT12_hd_bs + 54
    38                                  bsReserved2	equ RETRODOS_FAT12_hd_bs + 62
    39                                  bsDataStart	equ RETRODOS_FAT12_hd_bs + 64	
    40                                  bsRootDirStart	equ RETRODOS_FAT12_hd_bs + 66
    41                                  bsRootDirSects	equ RETRODOS_FAT12_hd_bs + 68
    42                                  
    43                                  ; DTA (PSP+80h= Offset 128)
    44                                  DTA_Attrib equ 149 ; PDP+21
    45                                  DTA_Time equ 150 ; PSP+22
    46                                  DTA_Date equ 152 ; PSP 24
    47                                  DTA_FileSize equ 154 ; PSP + 26
    48                                  DTA_FileName equ 158 ; PSP + 30
    49                                  
    50                                  ; Masterboot / Partition Table at Beginning+1BEh
    51                                  ptBootable      equ 0
    52                                  ptBeginHead     equ 1
    53                                  ptBeginSector   equ 2
    54                                  ptBeginCylinder equ 3
    55                                  ptFileSystemID	equ 4
    56                                  ptEndHead       equ 5
    57                                  ptEndSector     equ 6
    58                                  ptEndCylinder   equ 7
    59                                  ptStartSector   equ 8
    60                                  ptSectors       equ 12
    61                                  
    62                                  pt_cylinders	equ RETRODOS_MASTERBOOT_SECTOR + 1B8h	
    63                                  pt_heads	equ RETRODOS_MASTERBOOT_SECTOR + 1BAh	
    64                                  pt_sectors	equ RETRODOS_MASTERBOOT_SECTOR + 1BCh
    65                                  partition_table equ RETRODOS_MASTERBOOT_SECTOR + 1BEh
    66                                  
    67                                  ; BIOS Disk Parameters
    68                                  DPDiskNumber  equ 0h
    69                                  DPDType       equ 1h
    70                                  DPReturn      equ 2h
    71                                  DPHeads       equ 3h
    72                                  DPCylinders   equ 4h
    73                                  DPSecPerTrack equ 6h
    74                                  DPDisks       equ 7h
    75                                  DPTableOff    equ 8h
    76                                  DPTableSeg    equ 0Ah
    77                                  DPNumOfSecs   equ 0Ch
    78                                  
    79                                  ; BIOS INT 13h Extensions (LBA extensions)
    80                                  ; Just After DP Data (DPDiskNumber+)
    81                                  DAP_PacketSize equ 10h  ; If extensions present, this byte will be >=10h
    82                                  DAP_Reserved1 equ 11h   ; Reserved Byte 
    83                                  DAP_NumOfBlocks equ 12h ; Value of this byte must be 0 to 127
    84                                  DAP_Reserved2 equ 13h   ; Reserved Byte
    85                                  DAP_Destination equ 14h ; Address of Transfer Buffer as SEGMENT:OFFSET
    86                                  DAP_LBA_Address equ 18h ; LBA=(C1*H0+H1)*S0+S1-1
    87                                                          ; C1= Selected Cylinder Number
    88                                                          ; H0= Number Of Heads (Maximum Head Number + 1)
    89                                                          ; H1= Selected Head Number
    90                                                          ; S0= Maximum Sector Number
    91                                                          ; S1= Selected Sector Number
    92                                                          ; QUAD WORD
    93                                  ; DAP_Flat_Destination equ 20h ; 64 bit address, if value in 4h is FFFF:FFFFh
    94                                                               ; QUAD WORD (Also, value in 0h must be 18h) 
    95                                                               ; TR-DOS will not use 64 bit Flat Address
    96                                  
    97                                  ; INT 13h Function 48h "Get Enhanced Disk Drive Parameters"
    98                                  ; Just After DP Data (DPDiskNumber+)
    99                                  GetDParams_48h equ 20h ; Word. Data Lenght, must be 26 (1Ah) for short data.
   100                                  GDP_48h_InfoFlag equ 22h ; Word
   101                                  ; Bit 1 = 1 -> The geometry returned in bytes 4-15 is valid.
   102                                  GDP_48h_NumOfPCyls equ 24h ; Double Word. Number physical cylinders.
   103                                  GDP_48h_NumOfPHeads equ 28h ; Double Word. Number of physical heads.
   104                                  GDP_48h_NumOfPSpT equ 2Ch ; Double word. Num of physical sectors per track.
   105                                  GDP_48h_LBA_Sectors equ 30h ; 8 bytes. Number of physical/LBA sectors.
   106                                  GDP_48h_BytesPerSec equ 38h ; Word. Number of bytes in a sector.
   107                                  
   108                                  ; Cursor Location
   109                                  CCCpointer equ  0450h   ; BIOS data, current cursor column
   110                                  
   111                                  ; MINIMUM & MAXIMUM SECTORS (partition and disk size limits in sectors)
   112                                  MINPARTSIZE equ 4096 ; 2GB
   113                                  MAXPARTSIZE equ 4128768 - 1 ; 2GB - masterboot sector	
   114                                  MINDISKSIZE equ 16384 ; 8MB
   115                                  MAXDISKSIZE equ 4128768 ; 2GB
   116                                  
   117                                  pTableOffset equ 1BEh ; 446		
   118                                  
   119                                  [BITS 16]
   120                                  [ORG 100h]
   121                                  
   122                                  	;cli
   123                                  	;cld
   124                                  	;push	cs
   125                                  	;pop	ss
   126                                  	;mov	sp, 0FFFEh
   127                                  	;sti
   128                                  	
   129 00000000 BB[F718]                	mov	bx, SizeOfFile+100
   130 00000003 83C30F                          add	bx, 15
   131 00000006 D1EB                            shr	bx, 1
   132 00000008 D1EB                            shr	bx, 1
   133 0000000A D1EB                    	shr	bx, 1
   134 0000000C D1EB                    	shr	bx, 1
   135 0000000E B44A                            mov	ah, 4Ah ; modify memory allocation
   136                                          ;push	cs
   137                                          ;pop	es
   138 00000010 CD21                            int	21h 
   139                                  
   140                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   141                                  ; get fd image file name
   142                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   143                                  
   144 00000012 BE8000                  	mov	si, 80h			; PSP command tail
   145 00000015 AC                       	lodsb
   146 00000016 08C0                    	or	al, al 			; command tail length                            
   147 00000018 0F840801                	jz	R_15			; jump if zero
   148                                  R_01:
   149 0000001C AC                      	lodsb
   150 0000001D 3C20                    	cmp	al, ' '			; is it SPACE ?
   151 0000001F 74FB                    	je	short R_01 		
   152 00000021 0F82FF00                	jb	R_15
   153                                  	
   154                                  	; check hd image file name
   155                                  R_02:
   156 00000025 BF[CF16]                       	mov	di, img_file_name
   157 00000028 AA                      	stosb
   158                                  R_03:
   159 00000029 AC                      	lodsb
   160                                  	;cmp	al, 0Dh ; ENTER (CR) key
   161 0000002A 3C20                    	cmp	al, 20h ; ' '
   162 0000002C 760C                    	jna	short R_04
   163 0000002E AA                      	stosb
   164 0000002F 81FF[DB16]              	cmp	di, img_file_name + 12
   165 00000033 72F4                    	jb	short R_03
   166 00000035 803C20                  	cmp	byte [si], 20h 
   167 00000038 7748                    	ja	short R_11
   168                                  R_04:
   169                                  	;sub	al, al
   170                                  	;stosb
   171                                  
   172                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   173                                  ; File name capitalization
   174                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   175                                  
   176 0000003A BE[CF16]                	mov	si, img_file_name
   177 0000003D 89F7                    	mov	di, si
   178 0000003F 89F3                    	mov	bx, si
   179                                  R_05:
   180 00000041 AC                      	lodsb
   181 00000042 3C61                    	cmp	al, 'a'
   182 00000044 730D                    	jnb	short R_07
   183 00000046 20C0                    	and	al, al
   184 00000048 7412                    	jz	short R_08
   185 0000004A 3C2E                    	cmp	al, '.'
   186 0000004C 7502                    	jne	short R_06
   187 0000004E 89FB                    	mov	bx, di ; dot position	
   188                                  R_06:
   189 00000050 AA                      	stosb
   190 00000051 EBEE                    	jmp	short R_05 		
   191                                  R_07:
   192 00000053 3C7A                    	cmp	al, 'z'
   193 00000055 77F9                    	ja	short R_06
   194 00000057 24DF                    	and	al, 0DFh ; NOT 32
   195 00000059 AA                      	stosb
   196 0000005A EBE5                    	jmp	short R_05	
   197                                  R_08:
   198 0000005C 8805                    	mov	[di], al
   199 0000005E 4F                      	dec	di
   200 0000005F 39FB                    	cmp	bx, di
   201 00000061 7316                    	jnb	short R_10
   202 00000063 29DF                    	sub	di, bx
   203 00000065 81EB[CF16]              	sub	bx, img_file_name
   204 00000069 83FF03                  	cmp	di, 3
   205 0000006C 7606                    	jna	short R_09
   206 0000006E 21DB                    	and	bx, bx
   207 00000070 7507                    	jnz	short R_10
   208 00000072 EB0E                    	jmp	short R_11		
   209                                  R_09:
   210 00000074 83FB08                  	cmp	bx, 8
   211 00000077 7609                    	jna	short R_11
   212                                  R_10:
   213 00000079 BE[9311]                	mov	si, msg_inv_file_name
   214 0000007C E88904                  	call	print_msg
   215 0000007F E99700                  	jmp	R_14
   216                                  
   217                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   218                                  ; Find image file
   219                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   220                                  	
   221                                  R_11:
   222 00000082 BA[CF16]                	mov	dx, img_file_name
   223 00000085 B93F00                  	mov	cx, 3Fh ; File Attributes
   224 00000088 B44E                    	mov	ah, 4Eh ; MS-DOS Function = Find First File
   225 0000008A CD21                    	int	21h
   226 0000008C 0F82B900                	jc	R_19
   227                                  
   228                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   229                                  ; Check image file features
   230                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   231                                  
   232 00000090 BE9500                  	mov	si, DTA_Attrib
   233 00000093 8A04                    	mov	al, [si]
   234 00000095 241F                    	and	al, 1Fh ; directory, volume label, system, hidden, read only
   235 00000097 0F859900                	jnz	R_17     
   236 0000009B BE9A00                  	mov	si, DTA_FileSize
   237 0000009E AD                      	lodsw
   238 0000009F 8B14                    	mov	dx, [si]
   239 000000A1 81FAF801                	cmp	dx, 1F8h
   240 000000A5 0F878B00                	ja	R_17
   241 000000A9 A9FF01                  	test	ax, 511
   242 000000AC 0F858400                	jnz	R_17
   243 000000B0 C1E809                  	shr	ax, 9
   244 000000B3 C1E207                  	shl	dx, 7
   245 000000B6 01D0                    	add	ax, dx
   246                                  
   247                                  	; max. size of Retro DOS v2 hard disk image < 32MB
   248 000000B8 3D00FC                  	cmp	ax, 64512 ; 64*16*63 sectors
   249 000000BB 7777                    	ja	short R_17
   250 000000BD 7426                    	je	short R_12
   251 000000BF 3DC04E                  	cmp	ax, 20160 ; 20*16*63 sectors
   252 000000C2 7421                    	je	short R_12
   253 000000C4 726E                    	jb	short R_17
   254 000000C6 3D4851                  	cmp	ax, 20808 ; 306*4*17 sectors
   255 000000C9 7269                    	jb	short R_17
   256 000000CB 7418                    	je	short R_12
   257 000000CD 3D90A2                  	cmp	ax, 41616 ; 306*8*17 sectors
   258 000000D0 7413                    	je	short R_12
   259 000000D2 3D70F5                  	cmp	ax, 62832 ; 462*8*17 sectors
   260 000000D5 740E                    	je	short R_12
   261 000000D7 775B                    	ja	short R_17
   262 000000D9 3D007E                  	cmp	ax, 32256 ; 32*16*63 sectors
   263 000000DC 7407                    	je	short R_12
   264 000000DE 7254                    	jb	short R_17
   265 000000E0 3D809D                  	cmp	ax, 40320 ; 40*16*63 sectors
   266 000000E3 754F                    	jne	short R_17		
   267                                  R_12:
   268                                  
   269                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   270                                  ; Overwrite question
   271                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   272                                  
   273 000000E5 BE[0115]                	mov	si, msg_overwrite_question1
   274 000000E8 E81D04                  	call	print_msg
   275 000000EB BE9E00                  	mov	si, DTA_FileName
   276 000000EE E81704                  	call	print_msg
   277 000000F1 BE[1E15]                	mov	si, msg_overwrite_question2
   278 000000F4 E81104                  	call	print_msg
   279 000000F7 BE[2615]                	mov	si, msg_yes_no
   280 000000FA E80B04                  	call	print_msg
   281                                  
   282                                  	; get answer
   283                                  R_13:
   284 000000FD 31C0                    	xor	ax, ax
   285 000000FF CD16                    	int	16h			; wait for keyboard command
   286 00000101 3C03                    	cmp	al, 'C'-40h
   287 00000103 7414                    	je	short R_14 ; Exit                   
   288 00000105 3C1B                    	cmp	al, 27
   289 00000107 7410                    	je	short R_14 ; Exit
   290 00000109 24DF                    	and	al, 0DFh
   291 0000010B 3C59                    	cmp	al, 'Y'			; Yes?
   292 0000010D 741D                    	je	short R_16		; write
   293 0000010F 3C4E                    	cmp	al, 'N'			; No?
   294 00000111 75EA                    	jne	short R_13      
   295                                  					; no write (exit)  
   296 00000113 BE[0116]                	mov	si, Msg_NO
   297 00000116 E8EF03                  	call	print_msg 
   298                                  
   299                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   300                                  ; Nextline & Exit
   301                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   302                                  
   303                                  R_14:
   304 00000119 BE[F915]                	mov	si, CRLF
   305 0000011C E8E903                  	call	print_msg
   306 0000011F B8004C                  	mov	ax, 4C00h		; terminate
   307 00000122 CD21                    	int	21h
   308                                  
   309                                  R_15:
   310 00000124 BE[0B11]                	mov	si, RetroDOS_Welcome
   311 00000127 E8DE03                  	call	print_msg
   312 0000012A EBED                    	jmp	short R_14 ; Exit
   313                                  
   314                                  R_16:
   315 0000012C BE[FC15]                	mov	si, Msg_YES
   316 0000012F E8D603                  	call	print_msg
   317 00000132 EB08                    	jmp	short R_18
   318                                  
   319                                  R_17:
   320 00000134 BE[D511]                	mov	si, msg_inv_image_file
   321 00000137 E8CE03                  	call	print_msg
   322 0000013A EBDD                    	jmp	short R_14
   323                                  
   324                                  R_18:
   325                                  	; Delete existing image file
   326 0000013C B441                    	mov	ah, 41h ; Delete file
   327 0000013E BA[CF16]                	mov	dx, img_file_name
   328 00000141 CD21                    	int	21h
   329 00000143 7304                    	jnc	short R_19
   330 00000145 3C02                    	cmp	al, 2 ; file not found
   331 00000147 75EB                    	jne	short R_17 ; invalid image file
   332                                  
   333                                  R_19:
   334 00000149 E87304                  	call	write_chs_table
   335                                  R_20:
   336 0000014C 30E4                    	xor	ah, ah
   337 0000014E CD16                    	int	16h
   338                                  
   339 00000150 3C31                    	cmp	al, '1'
   340 00000152 7208                    	jb	short R_21
   341 00000154 3C37                    	cmp	al, '7'
   342 00000156 77F4                    	ja	short R_20
   343                                  	; 19/10/2018
   344 00000158 2C30                    	sub	al, '0'
   345 0000015A EB09                    	jmp	short R_22
   346                                  R_21:
   347 0000015C 3C1B                    	cmp	al, 27 ;  ESCape key
   348 0000015E 75EC                    	jne	short R_20
   349                                  
   350                                  	; Exit
   351 00000160 B8004C                  	mov	ax, 4C00h
   352 00000163 CD21                    	int	21h
   353                                  
   354                                  R_22:
   355 00000165 A2[CE16]                	mov	[DiskType], al ; 19/10/2018
   356                                  
   357                                  	; clear screen
   358 00000168 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
   359 0000016B CD10                    	int	10h
   360                                  
   361 0000016D 8A1E[CE16]              	mov	bl, [DiskType]	; 1 to 7
   362 00000171 FECB                    	dec	bl 		; 0 to 6
   363                                  	;xor	bh, bh
   364 00000173 89DE                    	mov	si, bx
   365 00000175 D0E3                    	shl	bl, 1
   366 00000177 81C3[B316]              	add	bx, DskTypeNumStr
   367 0000017B 8B07                    	mov	ax, [bx]
   368 0000017D A3[9916]                	mov	[msg_disk_size], ax
   369 00000180 C1E603                  	shl	si, 3 ; * 8
   370 00000183 81C6[CB05]              	add	si, DskTypeParms
   371 00000187 AD                      	lodsw
   372 00000188 A3[BE08]                	mov	[pt_cylinders], ax
   373 0000018B AD                      	lodsw
   374 0000018C A3[C008]                	mov	[pt_heads], ax
   375 0000018F AD                      	lodsw
   376 00000190 A3[C208]                	mov	[pt_sectors], ax
   377 00000193 AD                      	lodsw	
   378 00000194 A3[CC16]                	mov	[diskimage_size], ax
   379                                  	
   380 00000197 BE[8E16]                	mov	si, msg_creating
   381 0000019A E86B03                  	call	print_msg
   382                                  
   383                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   384                                  ; Create a new hard disk image file
   385                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   386                                  		
   387 0000019D BA[CF16]                	mov	dx, img_file_name
   388 000001A0 B90000                  	mov	cx, 0 ; File Attributes
   389 000001A3 B43C                    	mov	ah, 3Ch ; MS-DOS Function = Create File
   390 000001A5 CD21                    	int	21h
   391 000001A7 7208                    	jc	short R_23
   392                                  
   393                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   394                                  ; Open image file for writing
   395                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   396                                  
   397 000001A9 B002                    	mov	al, 2 ; open for reading and writing
   398                                  	;mov	dx, img_file_name
   399 000001AB B43D                    	mov	ah, 3Dh ; open file
   400 000001AD CD21                    	int	21h
   401 000001AF 7314                    	jnc	short R_24
   402                                  
   403                                  R_23:
   404                                  	; AL = error code
   405 000001B1 E86303                  	call	bin_to_hex
   406 000001B4 A3[1016]                	mov 	[error_code], ax
   407                                  
   408 000001B7 BE[F915]                	mov	si, CRLF
   409 000001BA E84B03                  	call	print_msg
   410                                  
   411 000001BD BE[0516]                	mov	si, Msg_Error
   412 000001C0 E84503                  	call	print_msg
   413                                  
   414 000001C3 CD20                    	int	20h	; Exit
   415                                  
   416                                  R_24:
   417 000001C5 A3[180B]                	mov	[img_file_handle], ax
   418 000001C8 BA[DC16]                	mov	dx, HDFORMAT_SECBUFFER  ; 0F6h buffer
   419                                  R_25:
   420 000001CB B90002                  	mov	cx, 512
   421 000001CE 8B1E[180B]              	mov	bx, [img_file_handle]
   422 000001D2 B440                    	mov	ah, 40h ; write to file	
   423 000001D4 CD21                    	int	21h
   424 000001D6 7226                    	jc	short R_26
   425                                  
   426 000001D8 FF06[CA16]              	inc	word [CWSector]
   427 000001DC A1[CC16]                	mov	ax, [diskimage_size]
   428                                  
   429 000001DF B90100                  	mov	cx, 1
   430                                  
   431 000001E2 3B06[CA16]              	cmp	ax, [CWSector]
   432 000001E6 761E                    	jna	short R_27
   433                                  	
   434 000001E8 A1[CA16]                	mov	ax, [CWSector]
   435 000001EB 83E003                  	and	ax, 3
   436 000001EE BB[C316]                	mov	bx, RSymbols
   437 000001F1 01C3                    	add	bx, ax
   438 000001F3 8A07                    	mov	al, [bx]
   439 000001F5 BB0700                  	mov	bx, 7
   440                                  	;mov	cx, 1
   441 000001F8 B40A                    	mov	ah, 0Ah ; write character (on previous cpos)
   442 000001FA CD10                    	int	10h
   443                                  
   444 000001FC EBCD                    	jmp	short R_25
   445                                  
   446                                  R_26:
   447                                  	; Error.. close file..
   448 000001FE 50                      	push	ax
   449 000001FF B43E                    	mov	ah, 3Eh ; close file
   450                                  	;mov	bx, [img_file_handle]
   451 00000201 CD21                    	int	21h
   452 00000203 58                      	pop	ax
   453 00000204 EBAB                    	jmp	short R_23
   454                                  
   455                                  R_27:
   456 00000206 B020                    	mov	al, 20h ; space
   457 00000208 BB0700                  	mov	bx, 7
   458 0000020B B40A                    	mov	ah, 0Ah ; write character (on previous cpos)
   459                                  	;mov	cx, 1
   460 0000020D CD10                    	int	10h
   461                                  	
   462 0000020F BE[F515]                	mov	si, msg_OK
   463 00000212 E8F302                  	call	print_msg
   464                                  
   465                                  	; Wait about 1 second (~16/18.2)
   466                                  	; "before press any key to continue message"
   467 00000215 30E4                    	xor	ah, ah ; 0
   468 00000217 CD1A                    	int	1Ah
   469                                  	; CX:DX = tick count (18.2 ticks per second)
   470 00000219 83E20F                  	and	dx, 0Fh
   471 0000021C 89D6                    	mov	si, dx
   472 0000021E 31DB                    	xor	bx, bx
   473                                  R_28:
   474 00000220 B80000                  	mov	ax,0
   475 00000223 CD1A                    	int	1Ah	
   476 00000225 43                      	inc	bx
   477 00000226 7407                    	jz	short R_29 
   478 00000228 83E20F                  	and	dx, 0Fh
   479 0000022B 39F2                    	cmp	dx, si
   480 0000022D 75F1                    	jne	short R_28
   481                                  R_29:
   482 0000022F BE[6F16]                	mov	si, msg_press_any_key
   483 00000232 E8D302                  	call	print_msg
   484                                  
   485 00000235 30E4                    	xor	ah, ah
   486 00000237 CD16                    	int	16h
   487                                  
   488                                  R_30:
   489                                  	; clear screen
   490 00000239 B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
   491 0000023C CD10                    	int	10h
   492                                  	
   493 0000023E BE[B712]                	mov	si, msg_create_dos_partition_h ; header
   494 00000241 E8C402                  	call	print_msg
   495 00000244 BE[AC13]                	mov	si, msg_create_dos_partition_m ; menu
   496 00000247 E8BE02                  	call	print_msg
   497                                  R_31:
   498 0000024A 30E4                    	xor	ah, ah
   499 0000024C CD16                    	int	16h
   500 0000024E 3C1B                    	cmp	al, 27 ; ESC key	
   501 00000250 743B                    	je	short R_32
   502 00000252 3C30                    	cmp	al, '0'
   503 00000254 7437                    	je	short R_32
   504 00000256 72F2                    	jb	short R_31
   505 00000258 3C36                    	cmp	al, '6'
   506 0000025A 77EE                    	ja	short R_31
   507                                  
   508 0000025C 30ED                    	xor	ch, ch
   509 0000025E 2C30                    	sub	al, '0'
   510 00000260 88C1                    	mov	cl, al
   511 00000262 FEC9                    	dec	cl  ; 0 to 5
   512 00000264 8A1E[CE16]              	mov	bl, [DiskType]
   513 00000268 FECB                    	dec	bl  ; 0 to 6
   514 0000026A B006                    	mov	al, 6
   515 0000026C F6E3                    	mul	bl	
   516 0000026E BB[DB06]                	mov	bx, OptionValidatingTable
   517 00000271 01C8                    	add	ax, cx
   518 00000273 01C3                    	add	bx, ax
   519 00000275 8A07                    	mov	al, [bx]
   520 00000277 20C0                    	and	al, al
   521 00000279 7520                    	jnz	short R_34
   522                                  
   523 0000027B BE[1A12]                	mov	si, msg_option_not_proper
   524 0000027E E88702                  	call	print_msg
   525 00000281 BE[6F16]                	mov	si, msg_press_any_key
   526 00000284 E88102                  	call	print_msg
   527 00000287 30E4                    	xor	ah, ah
   528 00000289 CD16                    	int	16h
   529 0000028B EBAC                    	jmp	short R_30
   530                                  
   531                                  R_32:	
   532 0000028D BE[F915]                	mov	si, CRLF
   533 00000290 E87502                  	call	print_msg
   534                                  
   535 00000293 30C0                    	xor	al, al	; return code = 0
   536 00000295 B44C                    	mov	ah, 4Ch ; EXIT - terminate with return code
   537 00000297 CD21                    	int	21h
   538                                  
   539                                  R_33:
   540 00000299 EBFE                    	jmp	short R_33
   541                                  
   542                                  R_34:
   543 0000029B FEC8                    	dec	al ; zero based type of partition selection
   544 0000029D B412                    	mov	ah, 18
   545 0000029F F6E4                    	mul	ah
   546 000002A1 BE[0306]                	mov	si, partition_parms
   547 000002A4 01C6                    	add	si, ax
   548 000002A6 BB[C408]                	mov	bx, partition_table
   549 000002A9 AD                      	lodsw
   550 000002AA A2[1309]                	mov	[bsSecPerClust], al  ; sectors per cluster
   551 000002AD AD                      	lodsw
   552                                  	;mov	cx, ax  	     ; number of clusters
   553 000002AE AD                      	lodsw
   554 000002AF A3[1709]                	mov	[bsRootDirEnts], ax  ; root directory entries
   555 000002B2 83C00F                  	add	ax,15
   556 000002B5 C1E804                  	shr	ax, 4
   557 000002B8 A3[4A09]                	mov	[bsRootDirSects], ax ; root directory sectors	
   558 000002BB AD                      	lodsw
   559 000002BC A3[2209]                	mov	[bsHidden1], ax	     ; hidden sectors
   560 000002BF 894708                  	mov	[bx+ptStartSector], ax ; start sector
   561                                  	;mov	word [bx+ptStartSector+2], 0
   562                                  
   563                                  	;mov	word [bsHidden2], 0
   564 000002C2 AD                      	lodsw
   565                                  	;mov	[bsResSectors], ax   ; reserved sectors = 1
   566 000002C3 AD                      	lodsw
   567 000002C4 A3[1C09]                	mov	[bsFATsecs], ax      ; fat sectors
   568 000002C7 AD                      	lodsw
   569 000002C8 A3[4809]                	mov	[bsRootDirStart], ax ; root directory address
   570 000002CB AD                      	lodsw
   571 000002CC A3[4609]                	mov	[bsDataStart], ax    ; first data sector address
   572 000002CF AD                      	lodsw
   573 000002D0 A3[1909]                	mov	[bsSectors], ax      ; partition/volume size in sectors
   574 000002D3 A3[2609]                	mov	[bsHugeSectors], ax 
   575                                  	;mov	word [bsHugeSectors+2], 0
   576 000002D6 89470C                  	mov	[bx+ptSectors], ax
   577                                  	;mov	word [bx+ptSectors+2], 0
   578                                  
   579 000002D9 89C1                    	mov	cx, ax 		     ; volume/partition size in sectors
   580                                  
   581 000002DB C60780                  	mov	byte [bx], 80h       ; Active/Bootable partition
   582 000002DE B001                    	mov	al, 1
   583 000002E0 884704                  	mov	[bx+ptFileSystemID], al ; 1
   584 000002E3 884701                  	mov	[bx+ptBeginHead], al ; beginning head = 1
   585 000002E6 884702                  	mov	[bx+ptBeginSector], al ; beginning sector = 1
   586 000002E9 30E4                    	xor	ah, ah	
   587                                  	;mov	[bx+ptBeginCylinder], ah ; beginning cylinder = 0
   588                                  		
   589 000002EB A0[C208]                	mov	al, [pt_sectors]
   590 000002EE A2[1E09]                	mov	[bsSecPerTrk], al
   591                                  	;mov	byte [bsSecPerTrk+1], 0
   592 000002F1 884706                  	mov	[bx+ptEndSector], al	
   593 000002F4 01C1                    	add	cx, ax		     ; + sectors per track      		           
   594                                  
   595 000002F6 8A26[C008]              	mov	ah, [pt_heads]
   596 000002FA 8826[2009]              	mov	[bsHeads], ah
   597                                  	;mov	byte [bsHeads+1], 0
   598 000002FE FECC                    	dec	ah
   599 00000300 886705                  	mov	[bx+ptEndHead], ah
   600 00000303 FEC4                    	inc	ah
   601 00000305 F6E4                    	mul	ah
   602 00000307 91                      	xchg	cx, ax
   603 00000308 31D2                    	xor	dx, dx
   604 0000030A F7F1                    	div	cx
   605 0000030C 48                      	dec	ax  ; the last cylinder of the partition (< 1024) 
   606 0000030D 884707                  	mov	[bx+ptEndCylinder], al
   607                                  
   608                                  	; 19/10/2018
   609 00000310 20E4                    	and	ah, ah
   610 00000312 7406                    	jz	short R_35  ; last cylinder number is less than 256
   611                                  
   612 00000314 C0E406                  	shl	ah, 6 ; shift cylinder (AX) bits 8 & 9 to AH bits 6 & 7
   613 00000317 086706                  	or	byte [bx+ptEndSector],ah ; .. and put it in EndSector bits 6 & 7
   614                                  
   615                                  R_35:
   616                                  	; clear screen
   617 0000031A B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
   618 0000031D CD10                    	int	10h	
   619                                  
   620 0000031F BE[3115]                	mov	si, msg_writing_mbr
   621 00000322 E8E301                  	call	print_msg
   622                                  
   623                                  	; Move file pointer to start of the file
   624                                  	;xor	al, al
   625 00000325 8B1E[180B]              	mov	bx, [img_file_handle]
   626 00000329 29C9                    	sub	cx, cx
   627                                  	;sub	dx, dx
   628 0000032B B442                    	mov	ah, 42h ; seek (move file pointer)
   629 0000032D CD21                    	int	21h
   630                                  
   631                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   632                                  ; writing masterboot sector
   633                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   634                                  
   635                                  	;mov	bx, [img_file_handle]
   636 0000032F BA[0607]                	mov	dx, RETRODOS_MASTERBOOT_SECTOR ; Singlix FS1 MBR
   637 00000332 B90002                  	mov	cx, 512
   638 00000335 B440                    	mov	ah, 40h ; write to file	
   639 00000337 CD21                    	int	21h
   640 00000339 0F82C1FE                	jc	R_26 ; write error message then exit
   641                                  
   642 0000033D BE[F515]                	mov	si, msg_OK
   643 00000340 E8C501                  	call	print_msg
   644                                  
   645 00000343 BF[3109]                	mov	di, bsVolumeLabel
   646 00000346 E8E600                  	call	write_volume_name
   647 00000349 BE[2D09]                	mov	si, bsVolumeID
   648 0000034C E83201                  	call	write_volume_serial
   649                                  
   650 0000034F BE[6415]                	mov	si, msg_writing_boot_sector
   651 00000352 E8B301                  	call	print_msg
   652                                  
   653                                  	; Move file pointer to start of the dos partition
   654 00000355 8B16[CC08]              	mov	dx, [partition_table+ptStartSector]
   655                                  	
   656 00000359 B80002                  	mov	ax, 512
   657 0000035C F7E2                    	mul	dx
   658 0000035E 89D1                    	mov	cx, dx
   659 00000360 89C2                    	mov	dx, ax
   660                                  
   661 00000362 28C0                    	sub	al, al
   662 00000364 8B1E[180B]              	mov	bx, [img_file_handle]
   663 00000368 B442                    	mov	ah, 42h ; seek (move file pointer)
   664 0000036A CD21                    	int	21h
   665                                  	;jc	R_26
   666                                  
   667                                  	;mov	bx, [img_file_handle]
   668 0000036C BA[0609]                	mov	dx, RETRODOS_FAT12_hd_bs
   669 0000036F B90002                  	mov	cx, 512
   670 00000372 B440                    	mov	ah, 40h ; write to file	
   671 00000374 CD21                    	int	21h
   672 00000376 0F8284FE                	jc	R_26 ; write error message then exit
   673                                  
   674 0000037A BE[F515]                	mov	si, msg_OK
   675 0000037D E88801                  	call	print_msg
   676                                  
   677                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   678                                  ; writing FAT sectors
   679                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   680                                  
   681                                  	;mov	si, CRLF
   682                                  	;call	print_msg
   683                                  
   684                                  	; Clear sector buffer (clear 0F6h bytes)
   685 00000380 BF[DC16]                	mov	di, HDFORMAT_FATBUFFER
   686 00000383 31C0                    	xor	ax, ax
   687 00000385 B90001                  	mov	cx, 256
   688 00000388 F3AB                    	rep	stosw 
   689                                  
   690 0000038A BE[8215]                	mov	si, msg_writing_FAT_sectors
   691 0000038D E87801                  	call	print_msg
   692                                  
   693 00000390 8B2E[1C09]              	mov	bp, [bsFATsecs]
   694 00000394 4D                      	dec	bp
   695 00000395 89EF                    	mov	di, bp
   696                                  
   697 00000397 B8F8FF                  	mov	ax, 0FFF8h
   698 0000039A BE[DC16]                	mov	si, HDFORMAT_FATBUFFER
   699 0000039D 8904                    	mov	[SI], ax
   700 0000039F 886402                  	mov	[SI+2], ah
   701                                  	
   702 000003A2 28C0                    	sub	al, al
   703 000003A4 8B1E[180B]              	mov	bx, [img_file_handle]
   704 000003A8 89F2                    	mov	dx, si ; [HDFORMAT_FATBUFFER]
   705 000003AA B90002                  	mov	cx, 512
   706 000003AD B440                    	mov	ah, 40h ; write to file	
   707 000003AF CD21                    	int	21h
   708 000003B1 0F8249FE                	jc	R_26 ; write error message then exit
   709                                  	;mov	bx, [img_file_handle]
   710 000003B5 BA[DC16]                	mov	dx, HDFORMAT_ZERO_BUFF
   711                                  	;mov	cx, 512
   712 000003B8 31C0                    	xor	ax, ax
   713 000003BA 8904                    	mov	[SI], ax
   714 000003BC 886402                  	mov	[SI+2], ah
   715                                  R_36:
   716 000003BF 28C0                    	sub	al, al
   717                                  	;mov	dx, HDFORMAT_ZERO_BUFF
   718                                  	;mov	cx, 512
   719 000003C1 B440                    	mov	ah, 40h ; write to file	
   720 000003C3 CD21                    	int	21h
   721 000003C5 0F8235FE                	jc	R_26 ; write error message then exit
   722                                  
   723 000003C9 4D                      	dec	bp
   724 000003CA 75F3                    	jnz	short R_36
   725                                  
   726 000003CC B8F8FF                  	mov	ax, 0FFF8h
   727                                  	;mov	si, HDFORMAT_FATBUFFER
   728 000003CF 8904                    	mov	[SI], ax
   729 000003D1 886402                  	mov	[SI+2], ah
   730                                  
   731 000003D4 28C0                    	sub	al, al
   732                                  	;mov	bx, [img_file_handle]
   733 000003D6 89F2                    	mov	dx, si; [HDFORMAT_FATBUFFER]
   734                                  	;mov	cx, 512
   735 000003D8 B440                    	mov	ah, 40h ; write to file	
   736 000003DA CD21                    	int	21h
   737 000003DC 0F821EFE                	jc	R_26 ; write error message then exit
   738                                  	;mov	bx, [img_file_handle]
   739 000003E0 BA[DC16]                	mov	dx, HDFORMAT_ZERO_BUFF
   740                                  	;mov	cx, 512
   741 000003E3 29C0                    	sub	ax, ax
   742 000003E5 8904                    	mov	[SI], ax
   743 000003E7 886402                  	mov	[SI+2], ah
   744                                  R_37:
   745 000003EA 28C0                    	sub	al, al
   746                                  	;mov	dx, HDFORMAT_ZERO_BUFF
   747                                  	;mov	cx, 512
   748 000003EC B440                    	mov	ah, 40h ; write to file	
   749 000003EE CD21                    	int	21h
   750 000003F0 0F820AFE                	jc	R_26 ; write error message then exit
   751                                  	
   752 000003F4 4F                      	dec	di
   753 000003F5 75F3                    	jnz	short R_37
   754                                  
   755 000003F7 BE[F515]                	mov	si, msg_OK
   756 000003FA E80B01                  	call	print_msg
   757                                  
   758                                  	;mov	si, CRLF
   759                                  	;call	print_msg
   760                                  
   761 000003FD BE[9915]                	mov	si, msg_writing_root_dir
   762 00000400 E80501                  	call	print_msg
   763                                  
   764 00000403 8B3E[1709]              	mov	di, [bsRootDirEnts]
   765 00000407 C1EF04                  	shr	di, 4 ; 240/16 = 15, 512/16 =  32 sectors
   766 0000040A 8B1E[180B]              	mov	bx, [img_file_handle]
   767 0000040E BA[DC16]                	mov	dx, HDFORMAT_ZERO_BUFF
   768                                  	;mov	cx, 512
   769                                  R_38:
   770 00000411 28C0                    	sub	al, al
   771                                  	;mov	bx, [img_file_handle]
   772                                  	;mov	dx, HDFORMAT_ZERO_BUFF
   773                                  	;mov	cx, 512
   774 00000413 B440                    	mov	ah, 40h ; write to file	
   775 00000415 CD21                    	int	21h
   776 00000417 0F82E3FD                	jc	R_26 ; write error message then exit
   777                                  	
   778 0000041B 4F                      	dec	di
   779 0000041C 75F3                    	jnz	short R_38
   780                                  
   781 0000041E BE[F515]                	mov	si, msg_OK
   782 00000421 E8E400                  	call	print_msg
   783                                  
   784 00000424 B43E                    	mov	ah, 3Eh ; close file
   785 00000426 8B1E[180B]              	mov	bx, [img_file_handle]
   786 0000042A CD21                    	int	21h
   787                                  
   788 0000042C E95EFE                  	jmp	R_32
   789                                  
   790                                  
   791                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   792                                  ; set & write volume name
   793                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   794                                  
   795                                  write_volume_name:
   796                                  	;mov	byte [vname_length], 11
   797                                  svn_fs:
   798                                  	; DI = (BS) Volume Label address
   799 0000042F BE[C715]                	mov	si, Msg_Volume_Name
   800 00000432 E8D300                  	call	print_msg
   801                                  
   802                                  	; get cursor position
   803                                  	; bh = 0  ; video page
   804 00000435 B403                    	mov     ah, 3 ; get cursor pos
   805 00000437 CD10                    	int     10h
   806 00000439 8916[C816]              	mov	[Cursor_Pos], dx
   807                                  
   808 0000043D E8EE00                  	call	rw_char
   809                                  	;jc	short svn_1
   810 00000440 7216                    	jc	short svn_5
   811                                  svn_0:
   812 00000442 AC                      	lodsb
   813 00000443 3C20                    	cmp	al, 20h
   814 00000445 74FB                    	je	short svn_0 
   815                                  	;mov	di, [bp+47h) ; [BS_VolLab] ; FAT32
   816                                  	;mov	di, [bp+2Bh) ; [BS_VolLab] ; FAT16 (&FAT12)
   817 00000447 89FB                    	mov	bx, di ; *	
   818                                  	;ja	short svn_2
   819 00000449 720D                    	jb	short svn_5
   820                                  ;svn_1:
   821                                  ;	mov	si, no_name
   822                                  ;	lodsb
   823                                  svn_2:
   824 0000044B B90B00                  	mov	cx, 11; [vname_length]
   825 0000044E EB05                    	jmp	short svn_4
   826                                  svn_3:
   827 00000450 AC                      	lodsb
   828 00000451 3C20                    	cmp	al, 20h
   829 00000453 7225                    	jb	short svn_6
   830                                  svn_4:
   831 00000455 AA                      	stosb
   832 00000456 E2F8                    	loop	svn_3
   833                                  svn_5:
   834 00000458 B90B00                  	mov	cx, 11 ; [vname_length]
   835 0000045B 89DE                    	mov	si, bx ; *
   836 0000045D BF[BB15]                	mov	di, StrVolumeName
   837 00000460 F3A4                    	rep	movsb
   838                                  	;mov	byte [di], 0
   839                                  
   840 00000462 8B16[C816]              	mov	dx, [Cursor_Pos]
   841 00000466 BB0700                  	mov	bx, 7
   842 00000469 B402                    	mov	ah, 2
   843 0000046B CD10                    	int	10h  ; Set Cursor Position
   844                                  
   845 0000046D BE[BB15]                	mov	si, StrVolumeName
   846 00000470 E89500                  	call	print_msg
   847 00000473 BE[F915]                	mov	si, CRLF
   848 00000476 E88F00                  	call	print_msg
   849 00000479 C3                      	retn
   850                                  svn_6:
   851 0000047A B020                    	mov	al, 20h
   852                                  svn_7:
   853 0000047C AA                      	stosb
   854 0000047D E2FD                    	loop	svn_7
   855 0000047F EBD7                    	jmp	short svn_5
   856                                  
   857                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   858                                  ; set & write volume serial number (volume ID)
   859                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   860                                  
   861                                  write_volume_serial:
   862                                  	; SI = (BS) Volume Serial Number (binary) address
   863                                  
   864                                  	;xor	ax, ax
   865                                  	;int	1Ah			; get time of day
   866                                  
   867                                  	;mov	[si], dx
   868                                  	;mov	[si+2], cx		; set unique volume ID
   869                                  
   870                                  	;mov	ah, 02h			; Return Current Time
   871                                  	;int	1Ah
   872                                  	;xchg	ch, cl
   873                                  	;xchg	dh, dl
   874                                  
   875                                  	;add	cx, dx  
   876                                  	;add	[si+2], cx
   877                                                 
   878                                  	;mov	ah, 04h			; Return Current Date
   879                                  	;int	1Ah
   880                                  
   881                                  	;xchg	ch,cl
   882                                  	;xchg	dh,dl
   883                                  
   884                                  	;add	cx, dx  
   885                                  	;add	[si+2], cx
   886                                  
   887                                  	; According to Microsoft DOS 6.0 serial number
   888                                  	; production method...
   889                                  	; < Create unique 32 bit serial number >
   890                                  
   891                                  	; Create_Serial_ID (MSDOS 6.0 Source code, MSFOR.ASM)
   892                                  	; (20/04/1987)
   893                                  	;
   894                                  	;  Get date (INT 21h, AH=2Bh)
   895                                  	;  Get time (INT 21h, AH=2Ch)
   896                                  	;  Serial_ID+0 = DX reg date + DX reg time
   897                                  	;  Serial_ID+2 = CX reg date + CX reg time
   898                                  	;  Serial_Num_Low = Serial_ID+2
   899                                  	;  Serial_Num_High = Serial_ID+0
   900                                  
   901 00000481 B404                    	mov	ah, 04h		; Return Current Date
   902 00000483 CD1A                    	int	1Ah
   903                                  
   904                                  	; DL = Day (BCD)	(20h) 	
   905                                  	; DH = Month (BCD)	(12h)
   906                                  	; CH = Century (BCD)	(20h)
   907                                  	; CL = Year (BCD) 	(17h)
   908                                  
   909 00000485 88D0                    	mov	al, dl
   910 00000487 E87100                  	call	bcd_to_bin
   911 0000048A 88C2                    	mov	dl, al 
   912 0000048C 88F0                    	mov	al, dh
   913 0000048E E86A00                  	call	bcd_to_bin
   914 00000491 88C6                    	mov	dh, al 
   915 00000493 88C8                    	mov	al, cl
   916 00000495 E86300                  	call	bcd_to_bin
   917 00000498 88C1                    	mov	cl, al 
   918 0000049A 88E8                    	mov	al, ch
   919 0000049C E85C00                  	call	bcd_to_bin
   920 0000049F 88C5                    	mov	ch, al
   921                                  
   922                                  	; DH = Month (1-10)
   923                                  	; DL = Day (1-31)
   924                                  	; CX = Year (1900-2099)
   925                                  
   926 000004A1 52                      	push	dx 
   927 000004A2 51                      	push	cx
   928                                  
   929 000004A3 B402                    	mov	ah, 02h		; Return Current Time
   930 000004A5 CD1A                    	int	1Ah
   931                                  	
   932                                  	; DH = Seconds (BCD)	(59h) 	
   933                                  	; CL = Minutes (BCD)	(59h)
   934                                  	; CH = Hours (BCD)	(23h)
   935                                  	; DL = Daylight savings time option (1=yes)
   936                                  
   937 000004A7 88F0                    	mov	al, dh
   938 000004A9 E84F00                  	call	bcd_to_bin
   939 000004AC 88C6                    	mov	dh, al 
   940 000004AE 88C8                    	mov	al, cl
   941 000004B0 E84800                  	call	bcd_to_bin
   942 000004B3 88C1                    	mov	cl, al 
   943 000004B5 88E8                    	mov	al, ch
   944 000004B7 E84100                  	call	bcd_to_bin
   945 000004BA 88C5                    	mov	ch, al 
   946                                  
   947                                  	; CH = Hour (0-23)
   948                                  	; CL = Minutes (0-59)
   949                                  	; DH = Seconds (0-59)
   950                                  	; ((DL = Hundredths (0-99) - MSDOS!))
   951                                  	; DL = 0 or 1 (here!)
   952                                  
   953 000004BC 89C8                    	mov	ax, cx
   954 000004BE 59                      	pop	cx
   955 000004BF 01C8                    	add	ax, cx
   956                                  
   957 000004C1 894402                  	mov	[si+2], ax
   958                                  
   959 000004C4 89D0                    	mov	ax, dx
   960 000004C6 5A                      	pop	dx
   961 000004C7 01D0                    	add	ax, dx
   962                                  
   963 000004C9 8904                    	mov	[si], ax
   964                                  
   965 000004CB 30E4                    	xor	ah, ah		; Read time counter
   966 000004CD CD1A                    	int	1Ah
   967                                  
   968                                  	; CX = High word of clock count
   969                                  	; DX = Low word of clock count
   970                                  	; AL = 0 if 24 hours has not passed, else 1
   971                                  
   972                                  	; NOTES: 
   973                                  	; (Ref: vitaly_filatov.tripod.com/ng/asm/asm_029.1.html)
   974                                  	;
   975                                     	; Following formulas convert the clock count to
   976                                          ; the time of day:
   977                                   	;	Hour      = Clock / 65543 (1007h)
   978                                  	;	Remainder = Clock MOD 65543
   979                                   	;
   980                                  	;	Minutes   = Remainder / 1092 (444h)
   981                                  	;	Remainder = Remainder MOD 1092
   982                                  	;
   983                                  	;	Second    = Remainder / 18.21
   984                                  	;	Remainder = Remainder MOD 18.21
   985                                  	;
   986                                  	;	Hundredths = CINT(Remainder * 100)
   987                                  
   988 000004CF 0014                    	add	[si], dl
   989                                  
   990                                  	; SI = Volume serial number address (4 bytes) 
   991 000004D1 8A04                    	mov	al, [si]
   992 000004D3 E84100                  	call	bin_to_hex
   993 000004D6 A3[F015]                	mov	[Vol_Serial2+2], ax	
   994 000004D9 8A4401                  	mov	al, [si+1]
   995 000004DC E83800                  	call	bin_to_hex
   996 000004DF A3[EE15]                	mov	[Vol_Serial2], ax
   997 000004E2 8A4402                  	mov	al, [si+2]
   998 000004E5 E82F00                  	call	bin_to_hex
   999 000004E8 A3[EB15]                	mov	[Vol_Serial1+2], ax	
  1000 000004EB 8A4403                  	mov	al, [si+3]
  1001 000004EE E82600                  	call	bin_to_hex
  1002 000004F1 A3[E915]                	mov	[Vol_Serial1], ax
  1003                                  
  1004 000004F4 BE[D715]                	mov	si, Msg_Volume_Serial
  1005 000004F7 E80E00                  	call	print_msg
  1006                                  
  1007 000004FA C3                      	retn
  1008                                  
  1009                                  bcd_to_bin:
  1010 000004FB 53                      	push	bx
  1011 000004FC D410                    	db	0D4h,10h  ; Undocumented inst. AAM
  1012                                  			  ; AH = AL / 10h
  1013                                  			  ; AL = AL MOD 10h
  1014 000004FE 88C3                    	mov	bl, al
  1015 00000500 B00A                    	mov	al, 10
  1016 00000502 F6E4                    	mul	ah
  1017 00000504 00D8                    	add	al, bl
  1018 00000506 5B                      	pop	bx
  1019 00000507 C3                      	retn
  1020                                  
  1021                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1022                                  ; Print messages
  1023                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1024                                  
  1025                                  print_msg:
  1026                                  
  1027                                  print_msg_LOOP:
  1028 00000508 AC                      	lodsb                           ; Load byte at DS:SI to AL
  1029 00000509 20C0                    	and     al, al            
  1030 0000050B 7409                    	jz      short print_msg_OK       
  1031 0000050D B40E                    	mov	ah, 0Eh			
  1032 0000050F BB0700                  	mov     bx, 07h             
  1033 00000512 CD10                    	int	10h			; BIOS Service func ( ah ) = 0Eh
  1034                                  					; Write char as TTY
  1035                                  					; AL-char BH-page BL-color
  1036 00000514 EBF2                    	jmp     short print_msg_LOOP           
  1037                                  
  1038                                  print_msg_OK:
  1039 00000516 C3                      	retn
  1040                                  
  1041                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1042                                  ; Convert byte to hexadecimal number
  1043                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1044                                  
  1045                                  bin_to_hex:
  1046                                  	; INPUT ->
  1047                                  	; 	AL = byte (binary number)
  1048                                  	; OUTPUT ->
  1049                                  	;	AX = hexadecimal string
  1050                                  	;
  1051 00000517 53                      	push	bx
  1052 00000518 31DB                    	xor	bx, bx
  1053 0000051A 88C3                    	mov	bl, al
  1054 0000051C C0EB04                  	shr	bl, 4
  1055 0000051F 8A9F[070B]              	mov	bl, [bx+hexchrs] 	 	
  1056 00000523 86D8                    	xchg	bl, al
  1057 00000525 80E30F                  	and	bl, 0Fh
  1058 00000528 8AA7[070B]              	mov	ah, [bx+hexchrs] 
  1059 0000052C 5B                      	pop	bx	
  1060 0000052D C3                      	retn
  1061                                  
  1062                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1063                                  ; Read & Write characters
  1064                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1065                                  
  1066                                  rw_char:
  1067                                  	; OUTPUT -> DS:SI = Entered String (ASCIIZ)
  1068 0000052E BE[BB15]                	mov     si, StrVolumeName
  1069 00000531 BB0700                  	mov     bx, 7
  1070 00000534 B403                    	mov     ah, 3
  1071 00000536 CD10                    	int     10h
  1072 00000538 8916[C816]              	mov     [Cursor_Pos], dx
  1073                                  read_next_char:
  1074 0000053C 30E4                    	xor     ah, ah
  1075 0000053E CD16                    	int     16h
  1076 00000540 20C0                    	and     al, al
  1077 00000542 7439                    	jz      short loc_arrow    
  1078 00000544 3CE0                    	cmp     al, 0E0h          
  1079 00000546 7435                    	je      short loc_arrow
  1080 00000548 3C08                    	cmp     al, 8
  1081 0000054A 753D                    	jne     short char_return
  1082                                  loc_back:
  1083 0000054C B403                    	mov     ah, 3
  1084 0000054E CD10                    	int     10h
  1085 00000550 3A16[C816]              	cmp     dl, byte [Cursor_Pos]
  1086 00000554 761F                    	jna     short loc_beep
  1087                                  prev_column:
  1088 00000556 FECA                    	dec     dl
  1089                                  set_cursor_pos:
  1090 00000558 B402                    	mov     ah, 2
  1091 0000055A CD10                    	int     10h
  1092 0000055C 88D3                    	mov     bl, dl
  1093 0000055E 2A1E[C816]              	sub     bl, byte [Cursor_Pos] 
  1094 00000562 B90100                  	mov     cx, 1
  1095 00000565 B409                    	mov     ah, 9
  1096 00000567 B020                    	mov     al, 20h
  1097 00000569 8800                    	mov     [si+bx], al
  1098                                  loc_write_it:
  1099 0000056B B307                    	mov     bl, 7
  1100 0000056D CD10                    	int     10h
  1101 0000056F 8B16[C816]              	mov     dx, [Cursor_Pos]
  1102 00000573 EBC7                    	jmp     short read_next_char
  1103                                  loc_beep:
  1104 00000575 B40E                    	mov     ah, 0Eh
  1105 00000577 B007                    	mov     al, 7
  1106 00000579 CD10                    	int     10h
  1107 0000057B EBBF                    	jmp     short read_next_char
  1108                                  loc_arrow:    
  1109 0000057D 80FC4B                  	cmp     ah, 4Bh
  1110 00000580 74CA                    	je      short loc_back
  1111 00000582 80FC53                  	cmp     ah, 53h
  1112 00000585 74C5                    	je      short loc_back
  1113 00000587 EBB3                    	jmp     short read_next_char
  1114                                  char_return:
  1115 00000589 B403                    	mov     ah, 3
  1116 0000058B CD10                    	int     10h
  1117                                  check_char_type:
  1118 0000058D 3C20                    	cmp     al, 20h
  1119 0000058F 7228                    	jb      short loc_escape
  1120 00000591 88D4                    	mov     ah, dl
  1121 00000593 2A26[C816]              	sub     ah, byte [Cursor_Pos]
  1122                                  	;cmp	ah, 10 
  1123                                  	;ja	short loc_beep
  1124 00000597 80FC0B                  	cmp     ah, 11 ; [vname_length]
  1125 0000059A 73D9                    	jnb	short loc_beep
  1126 0000059C 3C7A                    	cmp     al, 'z'
  1127 0000059E 779C                    	ja      short read_next_char
  1128 000005A0 3C61                    	cmp     al, 'a'
  1129 000005A2 7202                    	jb      short pass_capitalize
  1130 000005A4 24DF                    	and     al, 0DFh
  1131                                  pass_capitalize:
  1132 000005A6 88E3                    	mov     bl, ah 
  1133 000005A8 30E4                    	xor     ah, ah
  1134 000005AA 8900                    	mov     [si+bx], ax
  1135 000005AC B307                    	mov     bl, 7
  1136 000005AE B40E                    	mov     ah, 0Eh
  1137 000005B0 CD10                    	int     10h
  1138 000005B2 EB88                    	jmp     short read_next_char
  1139                                  pass_escape:
  1140 000005B4 3C0D                    	cmp     al, 0Dh	; 13 ; ENTER
  1141 000005B6 7584                    	jne     short read_next_char
  1142                                  	;mov	ah, 0Eh
  1143                                  	;int	10h
  1144                                  	;mov	al, 0Ah
  1145                                  	;int	10h
  1146 000005B8 C3                      	retn
  1147                                  loc_escape:
  1148 000005B9 3C1B                    	cmp     al, 1Bh	; 27 ; ESC
  1149 000005BB 75F7                    	jne     short pass_escape
  1150 000005BD F9                      	stc
  1151 000005BE C3                      	retn
  1152                                  
  1153                                  write_chs_table:
  1154                                  	; clear screen
  1155 000005BF B80300                  	mov	ax, 3 ; set video mode to 03h (80x25 text)
  1156 000005C2 CD10                    	int	10h
  1157                                  
  1158 000005C4 BE[1A0B]                	mov	si, Dsk_Type_Select_msg
  1159 000005C7 E83EFF                  	call	print_msg
  1160                                  
  1161 000005CA C3                      	retn
  1162                                  
  1163                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1164                                  ;  Data
  1165                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1166                                  
  1167                                  DskTypeParms:
  1168                                  DskType1Parms:
  1169 000005CB 3201                    cyl1:	dw 306
  1170 000005CD 0400                    hed1:	dw 4
  1171 000005CF 1100                    spt1:	dw 17
  1172 000005D1 4851                    cap1:	dw 306*4*17
  1173                                  DskType2Parms:
  1174 000005D3 3201                    cyl2:	dw 306
  1175 000005D5 0800                    hed2:	dw 8
  1176 000005D7 1100                    spt2:	dw 17
  1177 000005D9 90A2                    cap2:	dw 306*8*17
  1178                                  DskType3Parms:
  1179 000005DB CE01                    cyl3:	dw 462
  1180 000005DD 0800                    hed3:	dw 8
  1181 000005DF 1100                    spt3:	dw 17
  1182 000005E1 70F5                    cap3:	dw 462*8*17
  1183                                  DskType4Parms:
  1184 000005E3 1400                    cyl4:	dw 20
  1185 000005E5 1000                    hed4:	dw 16
  1186 000005E7 3F00                    spt4:	dw 63
  1187 000005E9 C04E                    cap4:	dw 20*16*63
  1188                                  DskType5Parms:
  1189 000005EB 2000                    cyl5:	dw 32
  1190 000005ED 1000                    hed5:	dw 16
  1191 000005EF 3F00                    spt5:	dw 63
  1192 000005F1 007E                    cap5:	dw 32*16*63
  1193                                  DskType6Parms:
  1194 000005F3 2800                    cyl6:	dw 40
  1195 000005F5 1000                    hed6:	dw 16
  1196 000005F7 3F00                    spt6:	dw 63
  1197 000005F9 809D                    cap6:	dw 40*16*63
  1198                                  DskType7Parms:
  1199 000005FB 4000                    cyl7:	dw 64
  1200 000005FD 1000                    hed7:	dw 16
  1201 000005FF 3F00                    spt7:	dw 63
  1202 00000601 00FC                    cap7:	dw 64*16*63
  1203                                  
  1204                                  partition_parms:
  1205                                  
  1206                                  Partition_4MB_17: ; 1
  1207 00000603 0400                    secpc0a: dw 4
  1208 00000605 EC07                    clsts0a: dw 2028
  1209 00000607 0001                    roote0a: dw 256
  1210 00000609 1100                    hidds0a: dw 17
  1211 0000060B 0100                    ressc0a: dw 1
  1212 0000060D 0600                    fatsc0a: dw 6
  1213 0000060F 0D00                    rootd0a: dw 13
  1214 00000611 1D00                    fdats0a: dw 29
  1215 00000613 CF1F                    parts0a: dw (60*8*17)-17 ; 8143 (2 sectors free)
  1216                                  
  1217                                  Partition_4MB_63: ; 2
  1218 00000615 0400                    secpc0b: dw 4
  1219 00000617 C907                    clsts0b: dw 1993
  1220 00000619 0001                    roote0b: dw 256
  1221 0000061B 3F00                    hidds0b: dw 63
  1222 0000061D 0100                    ressc0b: dw 1
  1223 0000061F 0600                    fatsc0b: dw 6
  1224 00000621 0D00                    rootd0b: dw 13
  1225 00000623 1D00                    fdats0b: dw 29
  1226 00000625 411F                    parts0b: dw (8*16*63)-63 ; 8001 (0 sector free)
  1227                                  
  1228                                  Partition_8MB_17: ; 3
  1229 00000627 0800                    secpc1a: dw 8
  1230 00000629 F007                    clsts1a: dw 2032
  1231 0000062B 0002                    roote1a: dw 512
  1232 0000062D 1100                    hidds1a: dw 17
  1233 0000062F 0100                    ressc1a: dw 1
  1234 00000631 0600                    fatsc1a: dw 6
  1235 00000633 0D00                    rootd1a: dw 13
  1236 00000635 2D00                    fdats1a: dw 45
  1237 00000637 AF3F                    parts1a: dw (120*8*17)-17 ; 16303 (2 sectors free)
  1238                                  
  1239                                  Partition_8MB_63: ; 4
  1240 00000639 0800                    secpc1b: dw 8
  1241 0000063B D207                    clsts1b: dw 2002
  1242 0000063D 0002                    roote1b: dw 512
  1243 0000063F 3F00                    hidds1b: dw 63
  1244 00000641 0100                    ressc1b: dw 1
  1245 00000643 0600                    fatsc1b: dw 6
  1246 00000645 0D00                    rootd1b: dw 13
  1247 00000647 2D00                    fdats1b: dw 45
  1248 00000649 C13E                    parts1b: dw (16*16*63)-63 ; 16065 (4 sectors free)
  1249                                  
  1250                                  Partition_10MB_17: ; 5
  1251 0000064B 0800                    secpc2a: dw 8
  1252 0000064D 200A                    clsts2a: dw 2592
  1253 0000064F 0002                    roote2a: dw 512
  1254 00000651 1100                    hidds2a: dw 17
  1255 00000653 0100                    ressc2a: dw 1
  1256 00000655 0800                    fatsc2a: dw 8
  1257 00000657 1100                    rootd2a: dw 17
  1258 00000659 3100                    fdats2a: dw 49
  1259 0000065B 3751                    parts2a: dw (306*4*17)-17 ; 20791 (6 sectors free)
  1260                                  
  1261                                  Partition_10MB_63: ; 6
  1262 0000065D 0800                    secpc2b: dw 8
  1263 0000065F CA09                    clsts2b: dw 2506
  1264 00000661 0002                    roote2b: dw 512
  1265 00000663 3F00                    hidds2b: dw 63
  1266 00000665 0100                    ressc2b: dw 1
  1267 00000667 0800                    fatsc2b: dw 8
  1268 00000669 1100                    rootd2b: dw 17
  1269 0000066B 3100                    fdats2b: dw 49
  1270 0000066D 814E                    parts2b: dw (20*16*63)-63 ; 20097 (0 sector free)
  1271                                  
  1272                                  Partition_16MB_17: ; 7
  1273 0000066F 0800                    secpc3a: dw 8
  1274 00000671 E60F                    clsts3a: dw 4070
  1275 00000673 0002                    roote3a: dw 512
  1276 00000675 1100                    hidds3a: dw 17
  1277 00000677 0100                    ressc3a: dw 1
  1278 00000679 0C00                    fatsc3a: dw 12
  1279 0000067B 1900                    rootd3a: dw 25
  1280 0000067D 3900                    fdats3a: dw 57
  1281 0000067F 6F7F                    parts3a: dw (240*8*17)-17 ; 32623 (6 sectors free)
  1282                                  
  1283                                  Partition_16MB_63: ; 8
  1284 00000681 0800                    secpc3b: dw 8
  1285 00000683 B10F                    clsts3b: dw 4017
  1286 00000685 0002                    roote3b: dw 512
  1287 00000687 3F00                    hidds3b: dw 63
  1288 00000689 0100                    ressc3b: dw 1
  1289 0000068B 0C00                    fatsc3b: dw 12
  1290 0000068D 1900                    rootd3b: dw 25
  1291 0000068F 3900                    fdats3b: dw 57
  1292 00000691 C17D                    parts3b: dw (32*16*63)-63 ; 32193 (0 sector free)					
  1293                                  
  1294                                  Partition_20MB_17: ; 9
  1295 00000693 1000                    secpc4a: dw 16
  1296 00000695 220A                    clsts4a: dw 2594
  1297 00000697 0004                    roote4a: dw 1024
  1298 00000699 1100                    hidds4a: dw 17
  1299 0000069B 0100                    ressc4a: dw 1
  1300 0000069D 0800                    fatsc4a: dw 8
  1301 0000069F 1100                    rootd4a: dw 17
  1302 000006A1 5100                    fdats4a: dw 81
  1303 000006A3 7FA2                    parts4a: dw (306*8*17)-17 ; 41599 (14 sectors free)
  1304                                  
  1305                                  Partition_20MB_63: ; 10	
  1306 000006A5 1000                    secpc4b: dw 16
  1307 000006A7 CF09                    clsts4b: dw 2511
  1308 000006A9 0004                    roote4b: dw 1024
  1309 000006AB 3F00                    hidds4b: dw 63
  1310 000006AD 0100                    ressc4b: dw 1
  1311 000006AF 0800                    fatsc4b: dw 8
  1312 000006B1 1100                    rootd4b: dw 17
  1313 000006B3 5100                    fdats4b: dw 81
  1314 000006B5 419D                    parts4b: dw (40*16*63)-63 ; 40257 (0 sector free)
  1315                                  
  1316                                  Partition_31MB:    ; 11
  1317 000006B7 1000                    secpc5a: dw 16
  1318 000006B9 500F                    clsts5a: dw 3920
  1319 000006BB 0004                    roote5a: dw 1024
  1320 000006BD 1100                    hidds5a: dw 17
  1321 000006BF 0100                    ressc5a: dw 1
  1322 000006C1 0C00                    fatsc5a: dw 12
  1323 000006C3 1900                    rootd5a: dw 25
  1324 000006C5 5900                    fdats5a: dw 89
  1325 000006C7 5FF5                    parts5a: dw (462*8*17)-17 ; 62815 (6 sectors free)
  1326                                  
  1327                                  Partition_32MB:	  ;  12
  1328 000006C9 1000                    secpc5b: dw 16
  1329 000006CB B60F                    clsts5b: dw 4022
  1330 000006CD 0004                    roote5b: dw 1024
  1331 000006CF 3F00                    hidds5b: dw 63
  1332 000006D1 0100                    ressc5b: dw 1
  1333 000006D3 0C00                    fatsc5b: dw 12
  1334 000006D5 1900                    rootd5b: dw 25
  1335 000006D7 5900                    fdats5b: dw 89
  1336 000006D9 C1FB                    parts5b: dw (64*16*63)-63 ; 64449 (8 sectors free)
  1337                                  
  1338                                  
  1339                                  OptionValidatingTable:
  1340                                  ; 	Option  4MB,8MB,10M,16M,20M,WHOLE DISK	
  1341 000006DB 010005000005            	db	 1,  0,  5,  0,  0,  5   ; 10MB, 17SPT	 	
  1342 000006E1 010305000909            	db	 1,  3,  5,  0,  9,  9	 ; 20MB, 17SPT
  1343 000006E7 01030507000B            	db	 1,  3,  5,  7,  0, 11   ; 31MB, 17SPT	 	
  1344 000006ED 020006000006            	db	 2,  0,  6,  0,  0,  6   ; 10MB, 63SPT	 	
  1345 000006F3 020400080008            	db	 2,  4,  0,  8,  0,  8	 ; 16MB, 63SPT
  1346 000006F9 020406000A0A            	db	 2,  4,  6,  0, 10, 10	 ; 20MB, 63SPT
  1347 000006FF 02040608000C            	db	 2,  4,  6,  8,  0, 12   ; 32MB, 63SPT
  1348                                  
  1349 00000705 00                      	db	0
  1350                                  
  1351                                  RETRODOS_MASTERBOOT_SECTOR:
  1352 00000706 <bin 200h>              	incbin	'FS1_MBR.BIN' ; Singlix FS1 MBR	
  1353                                  
  1354                                  RETRODOS_FAT12_hd_bs: 
  1355 00000906 <bin 200h>              	incbin	'RD2HDBS.BIN' ; BS Last Update: 25/10/2023
  1356                                  
  1357 00000B06 00                      	db	0
  1358                                  
  1359                                  hexchrs:
  1360 00000B07 303132333435363738-     	db	'0123456789ABCDEF'
  1360 00000B10 39414243444546     
  1361                                  
  1362 00000B17 90                      align 2
  1363                                  
  1364                                  img_file_handle:
  1365 00000B18 0000                    	dw	0
  1366                                  
  1367                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1368                                  ;  Messages
  1369                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1370                                  
  1371                                  Dsk_Type_Select_msg:
  1372 00000B1A 524554524F20444F53-     db  "RETRO DOS v2.0 Hard Disk Image Utility by Erdogan Tan (2018)                    "
  1372 00000B23 2076322E3020486172-
  1372 00000B2C 64204469736B20496D-
  1372 00000B35 616765205574696C69-
  1372 00000B3E 747920627920457264-
  1372 00000B47 6F67616E2054616E20-
  1372 00000B50 283230313829202020-
  1372 00000B59 202020202020202020-
  1372 00000B62 2020202020202020   
  1373 00000B6A 202020202020202020-     db  "                                                                                "
  1373 00000B73 202020202020202020-
  1373 00000B7C 202020202020202020-
  1373 00000B85 202020202020202020-
  1373 00000B8E 202020202020202020-
  1373 00000B97 202020202020202020-
  1373 00000BA0 202020202020202020-
  1373 00000BA9 202020202020202020-
  1373 00000BB2 2020202020202020   
  1374 00000BBA 202020202020202020-     db  "                                                                                "
  1374 00000BC3 202020202020202020-
  1374 00000BCC 202020202020202020-
  1374 00000BD5 202020202020202020-
  1374 00000BDE 202020202020202020-
  1374 00000BE7 202020202020202020-
  1374 00000BF0 202020202020202020-
  1374 00000BF9 202020202020202020-
  1374 00000C02 2020202020202020   
  1375 00000C0A 4469736B2054797065-     db  "Disk Type     Cylinders     Heads     Sectors       Capacity                    "
  1375 00000C13 202020202043796C69-
  1375 00000C1C 6E6465727320202020-
  1375 00000C25 204865616473202020-
  1375 00000C2E 2020536563746F7273-
  1375 00000C37 202020202020204361-
  1375 00000C40 706163697479202020-
  1375 00000C49 202020202020202020-
  1375 00000C52 2020202020202020   
  1376 00000C5A 2D2D2D2D2D2D2D2D2D-     db  "---------     ---------     -----     -------       --------                    "
  1376 00000C63 20202020202D2D2D2D-
  1376 00000C6C 2D2D2D2D2D20202020-
  1376 00000C75 202D2D2D2D2D202020-
  1376 00000C7E 20202D2D2D2D2D2D2D-
  1376 00000C87 202020202020202D2D-
  1376 00000C90 2D2D2D2D2D2D202020-
  1376 00000C99 202020202020202020-
  1376 00000CA2 2020202020202020   
  1377 00000CAA 202020202031202020-     db  "     1           306          4         17            10 MB                     "
  1377 00000CB3 202020202020202033-
  1377 00000CBC 303620202020202020-
  1377 00000CC5 202020342020202020-
  1377 00000CCE 202020203137202020-
  1377 00000CD7 202020202020202020-
  1377 00000CE0 3130204D4220202020-
  1377 00000CE9 202020202020202020-
  1377 00000CF2 2020202020202020   
  1378 00000CFA 202020202032202020-     db  "     2           306          8         17            20 MB                     "
  1378 00000D03 202020202020202033-
  1378 00000D0C 303620202020202020-
  1378 00000D15 202020382020202020-
  1378 00000D1E 202020203137202020-
  1378 00000D27 202020202020202020-
  1378 00000D30 3230204D4220202020-
  1378 00000D39 202020202020202020-
  1378 00000D42 2020202020202020   
  1379 00000D4A 202020202033202020-     db  "     3           462          8         17            31 MB                     " 	      	     	
  1379 00000D53 202020202020202034-
  1379 00000D5C 363220202020202020-
  1379 00000D65 202020382020202020-
  1379 00000D6E 202020203137202020-
  1379 00000D77 202020202020202020-
  1379 00000D80 3331204D4220202020-
  1379 00000D89 202020202020202020-
  1379 00000D92 2020202020202020   
  1380 00000D9A 202020202020202020-     db  "                                                                                "
  1380 00000DA3 202020202020202020-
  1380 00000DAC 202020202020202020-
  1380 00000DB5 202020202020202020-
  1380 00000DBE 202020202020202020-
  1380 00000DC7 202020202020202020-
  1380 00000DD0 202020202020202020-
  1380 00000DD9 202020202020202020-
  1380 00000DE2 2020202020202020   
  1381 00000DEA 202020202034202020-     db  "     4            20         16         63            10 MB                     "
  1381 00000DF3 202020202020202020-
  1381 00000DFC 323020202020202020-
  1381 00000E05 202031362020202020-
  1381 00000E0E 202020203633202020-
  1381 00000E17 202020202020202020-
  1381 00000E20 3130204D4220202020-
  1381 00000E29 202020202020202020-
  1381 00000E32 2020202020202020   
  1382 00000E3A 202020202035202020-     db  "     5            32         16         63            16 MB                     "   	
  1382 00000E43 202020202020202020-
  1382 00000E4C 333220202020202020-
  1382 00000E55 202031362020202020-
  1382 00000E5E 202020203633202020-
  1382 00000E67 202020202020202020-
  1382 00000E70 3136204D4220202020-
  1382 00000E79 202020202020202020-
  1382 00000E82 2020202020202020   
  1383 00000E8A 202020202036202020-     db  "     6            40         16         63            20 MB                     "
  1383 00000E93 202020202020202020-
  1383 00000E9C 343020202020202020-
  1383 00000EA5 202031362020202020-
  1383 00000EAE 202020203633202020-
  1383 00000EB7 202020202020202020-
  1383 00000EC0 3230204D4220202020-
  1383 00000EC9 202020202020202020-
  1383 00000ED2 2020202020202020   
  1384 00000EDA 202020202037202020-     db  "     7            64         16         63            32 MB                     " 	 
  1384 00000EE3 202020202020202020-
  1384 00000EEC 363420202020202020-
  1384 00000EF5 202031362020202020-
  1384 00000EFE 202020203633202020-
  1384 00000F07 202020202020202020-
  1384 00000F10 3332204D4220202020-
  1384 00000F19 202020202020202020-
  1384 00000F22 2020202020202020   
  1385 00000F2A 202020202020202020-     db  "                                                                                "
  1385 00000F33 202020202020202020-
  1385 00000F3C 202020202020202020-
  1385 00000F45 202020202020202020-
  1385 00000F4E 202020202020202020-
  1385 00000F57 202020202020202020-
  1385 00000F60 202020202020202020-
  1385 00000F69 202020202020202020-
  1385 00000F72 2020202020202020   
  1386 00000F7A 202020202020202020-     db  "                                                                                "
  1386 00000F83 202020202020202020-
  1386 00000F8C 202020202020202020-
  1386 00000F95 202020202020202020-
  1386 00000F9E 202020202020202020-
  1386 00000FA7 202020202020202020-
  1386 00000FB0 202020202020202020-
  1386 00000FB9 202020202020202020-
  1386 00000FC2 2020202020202020   
  1387 00000FCA 507265737320646973-     db  "Press disk number (1 to 7) to SELECT or                                         "
  1387 00000FD3 6B206E756D62657220-
  1387 00000FDC 283120746F20372920-
  1387 00000FE5 746F2053454C454354-
  1387 00000FEE 206F72202020202020-
  1387 00000FF7 202020202020202020-
  1387 00001000 202020202020202020-
  1387 00001009 202020202020202020-
  1387 00001012 2020202020202020   
  1388 0000101A 202020202020202020-     db  "                                                                                " 
  1388 00001023 202020202020202020-
  1388 0000102C 202020202020202020-
  1388 00001035 202020202020202020-
  1388 0000103E 202020202020202020-
  1388 00001047 202020202020202020-
  1388 00001050 202020202020202020-
  1388 00001059 202020202020202020-
  1388 00001062 2020202020202020   
  1389 0000106A 507265737320455343-     db  "Press ESC to cancel.                                                            "
  1389 00001073 20746F2063616E6365-
  1389 0000107C 6C2E20202020202020-
  1389 00001085 202020202020202020-
  1389 0000108E 202020202020202020-
  1389 00001097 202020202020202020-
  1389 000010A0 202020202020202020-
  1389 000010A9 202020202020202020-
  1389 000010B2 2020202020202020   
  1390 000010BA 202020202020202020-     db  "                                                                                " 
  1390 000010C3 202020202020202020-
  1390 000010CC 202020202020202020-
  1390 000010D5 202020202020202020-
  1390 000010DE 202020202020202020-
  1390 000010E7 202020202020202020-
  1390 000010F0 202020202020202020-
  1390 000010F9 202020202020202020-
  1390 00001102 2020202020202020   
  1391 0000110A 00                      db  0
  1392                                  
  1393                                  RetroDOS_Welcome:
  1394 0000110B 0D0A                    	db	0Dh, 0Ah
  1395 0000110D 526574726F20444F53-     	db	'Retro DOS v4 Fixed Disk Image (FAT12 FS) Format Utility'
  1395 00001116 207634204669786564-
  1395 0000111F 204469736B20496D61-
  1395 00001128 676520284641543132-
  1395 00001131 2046532920466F726D-
  1395 0000113A 6174205574696C6974-
  1395 00001143 79                 
  1396 00001144 0D0A                    	db	0Dh, 0Ah
  1397 00001146 76342E302E32333130-     	db	"v4.0.231028  (c) Erdogan TAN 2018-2023"
  1397 0000114F 323820202863292045-
  1397 00001158 72646F67616E205441-
  1397 00001161 4E20323031382D3230-
  1397 0000116A 3233               
  1398 0000116C 0D0A                    	db	0Dh,0Ah
  1399 0000116E 0D0A                    	db	0Dh,0Ah
  1400 00001170 55736167653A206661-     	db	'Usage: fat12hdi <image file name> '
  1400 00001179 743132686469203C69-
  1400 00001182 6D6167652066696C65-
  1400 0000118B 206E616D653E20     
  1401 00001192 00                      	db	0
  1402                                  
  1403                                  msg_inv_file_name: 
  1404 00001193 0D0A                    	db	0Dh, 0Ah
  1405 00001195 496E76616C69642066-     	db	"Invalid file name !", 0Dh, 0Ah
  1405 0000119E 696C65206E616D6520-
  1405 000011A7 210D0A             
  1406 000011AA 2846696C65206E616D-     	db	"(File name must fit to 8.3 DOS format) !"
  1406 000011B3 65206D757374206669-
  1406 000011BC 7420746F20382E3320-
  1406 000011C5 444F5320666F726D61-
  1406 000011CE 74292021           
  1407 000011D2 0D0A00                  	db	0Dh, 0Ah, 0
  1408                                  
  1409                                  msg_inv_image_file:
  1410 000011D5 0D0A                    	db	0Dh, 0Ah
  1411 000011D7 496E76616C69642066-     	db	"Invalid fixed disk image file !", 0Dh, 0Ah
  1411 000011E0 69786564206469736B-
  1411 000011E9 20696D616765206669-
  1411 000011F2 6C6520210D0A       
  1412 000011F8 2846696C652073697A-     	db	"(File size is not compatible) !"
  1412 00001201 65206973206E6F7420-
  1412 0000120A 636F6D70617469626C-
  1412 00001213 65292021           
  1413 00001217 0D0A00                  	db	0Dh, 0Ah, 0 
  1414                                  
  1415                                  msg_option_not_proper:
  1416 0000121A 53656C656374656420-     	db	"Selected partion size is not proper for selected disk size !"
  1416 00001223 70617274696F6E2073-
  1416 0000122C 697A65206973206E6F-
  1416 00001235 742070726F70657220-
  1416 0000123E 666F722073656C6563-
  1416 00001247 746564206469736B20-
  1416 00001250 73697A652021       
  1417 00001256 0D0A                    	db	0Dh, 0Ah
  1418 00001258 28596F75206E656564-     	db	"(You need to select another option.)"
  1418 00001261 20746F2073656C6563-
  1418 0000126A 7420616E6F74686572-
  1418 00001273 206F7074696F6E2E29 
  1419 0000127C 0D0D00                  	db	0Dh, 0Dh, 0 
  1420                                  
  1421                                  msg_any_key_esc_exit:
  1422 0000127F 0D0A                    	db	0Dh, 0Ah
  1423 00001281 507265737320455343-     	db	"Press ESC to exit or press another key to continue..."
  1423 0000128A 20746F206578697420-
  1423 00001293 6F7220707265737320-
  1423 0000129C 616E6F74686572206B-
  1423 000012A5 657920746F20636F6E-
  1423 000012AE 74696E75652E2E2E   
  1424 000012B6 00                      	db	0
  1425                                  
  1426                                  msg_create_dos_partition_h:
  1427 000012B7 0D0A                    	db	0Dh, 0Ah
  1428 000012B9 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"
  1428 000012C2 2D2D2D2D2D2D2D2D2D-
  1428 000012CB 2D2D2D2D2D2D2D2D2D-
  1428 000012D4 2D2D2D2D2D2D2D2D2D-
  1428 000012DD 2D2D2D2D2D2D2D2D2D-
  1428 000012E6 2D2D2D2D2D2D2D2D2D-
  1428 000012EF 2D2D2D2D2D2D2D2D2D-
  1428 000012F8 2D2D2D2D2D2D2D2D2D-
  1428 00001301 2D2D2D2D2D2D2D2D   
  1429 00001309 202020202020202020-     	db	"                        Create Primary DOS Partition                            "
  1429 00001312 202020202020202020-
  1429 0000131B 202020202020437265-
  1429 00001324 617465205072696D61-
  1429 0000132D 727920444F53205061-
  1429 00001336 72746974696F6E2020-
  1429 0000133F 202020202020202020-
  1429 00001348 202020202020202020-
  1429 00001351 2020202020202020   
  1430 00001359 2D2D2D2D2D2D2D2D2D-     	db	"--------------------------------------------------------------------------------"	
  1430 00001362 2D2D2D2D2D2D2D2D2D-
  1430 0000136B 2D2D2D2D2D2D2D2D2D-
  1430 00001374 2D2D2D2D2D2D2D2D2D-
  1430 0000137D 2D2D2D2D2D2D2D2D2D-
  1430 00001386 2D2D2D2D2D2D2D2D2D-
  1430 0000138F 2D2D2D2D2D2D2D2D2D-
  1430 00001398 2D2D2D2D2D2D2D2D2D-
  1430 000013A1 2D2D2D2D2D2D2D2D   
  1431 000013A9 0D0A00                  	db	0Dh, 0Ah, 0	
  1432                                  msg_create_dos_partition_m:
  1433 000013AC 53656C65637420616E-     	db	"Select an option: "
  1433 000013B5 206F7074696F6E3A20 
  1434 000013BE 0D0A                    	db	0Dh, 0Ah
  1435 000013C0 0D0A                    	db	0Dh, 0Ah
  1436 000013C2 202031292055736520-     	db	"  1) Use  4 MB disk space for FAT12 partition ", 0Dh, 0Ah
  1436 000013CB 2034204D4220646973-
  1436 000013D4 6B2073706163652066-
  1436 000013DD 6F7220464154313220-
  1436 000013E6 706172746974696F6E-
  1436 000013EF 200D0A             
  1437 000013F2 202032292055736520-     	db	"  2) Use  8 MB disk space for FAT12 partition ", 0Dh, 0Ah
  1437 000013FB 2038204D4220646973-
  1437 00001404 6B2073706163652066-
  1437 0000140D 6F7220464154313220-
  1437 00001416 706172746974696F6E-
  1437 0000141F 200D0A             
  1438 00001422 202033292055736520-     	db	"  3) Use 10 MB disk space for FAT12 partition ", 0Dh, 0Ah
  1438 0000142B 3130204D4220646973-
  1438 00001434 6B2073706163652066-
  1438 0000143D 6F7220464154313220-
  1438 00001446 706172746974696F6E-
  1438 0000144F 200D0A             
  1439 00001452 202034292055736520-     	db	"  4) Use 16 MB disk space for FAT12 partition ", 0Dh, 0Ah
  1439 0000145B 3136204D4220646973-
  1439 00001464 6B2073706163652066-
  1439 0000146D 6F7220464154313220-
  1439 00001476 706172746974696F6E-
  1439 0000147F 200D0A             
  1440 00001482 202035292055736520-     	db	"  5) Use 20 MB disk space for FAT12 partition ", 0Dh, 0Ah
  1440 0000148B 3230204D4220646973-
  1440 00001494 6B2073706163652066-
  1440 0000149D 6F7220464154313220-
  1440 000014A6 706172746974696F6E-
  1440 000014AF 200D0A             
  1441 000014B2 202036292055736520-     	db	"  6) Use whole disk space for FAT12 partition ", 0Dh, 0Ah
  1441 000014BB 77686F6C6520646973-
  1441 000014C4 6B2073706163652066-
  1441 000014CD 6F7220464154313220-
  1441 000014D6 706172746974696F6E-
  1441 000014DF 200D0A             
  1442 000014E2 0D0A                    	db	0Dh, 0Ah	
  1443 000014E4 507265737320455343-     	db	"Press ESC or 0 to exit .. "
  1443 000014ED 206F72203020746F20-
  1443 000014F6 65786974202E2E20   
  1444 000014FE 0D0A00                   	db 	0Dh, 0Ah, 0
  1445                                  
  1446                                  msg_overwrite_question1:
  1447 00001501 0D0A                    	db	0Dh, 0Ah
  1448 00001503 446F20796F75207761-     	db	'Do you want to overwrite '
  1448 0000150C 6E7420746F206F7665-
  1448 00001515 72777269746520     
  1449 0000151C 27                      	db	27h
  1450 0000151D 00                      	db	0
  1451                                  
  1452                                  msg_overwrite_question2: 
  1453 0000151E 27                      	db	27h
  1454 0000151F 2066696C6520            	db	' file '
  1455 00001525 00                      	db	0
  1456                                  
  1457                                  msg_yes_no:
  1458 00001526 285965732F4E6F293F-     	db	'(Yes/No)? ', 0	
  1458 0000152F 2000               
  1459                                  
  1460                                  msg_writing_mbr:
  1461 00001531 57726974696E67206D-     	db	"Writing masterboot sector...", 0
  1461 0000153A 6173746572626F6F74-
  1461 00001543 20736563746F722E2E-
  1461 0000154C 2E00               
  1462                                  
  1463                                  msg_writing_disk_sectors:
  1464 0000154E 57726974696E672064-     	db	"Writing disk sector: ", 0
  1464 00001557 69736B20736563746F-
  1464 00001560 723A2000           
  1465                                  
  1466                                  msg_writing_boot_sector:
  1467 00001564 57726974696E672076-     	db	"Writing volume boot sector...", 0
  1467 0000156D 6F6C756D6520626F6F-
  1467 00001576 7420736563746F722E-
  1467 0000157F 2E2E00             
  1468                                  
  1469                                  msg_writing_FAT_sectors:
  1470 00001582 57726974696E672046-     	db	"Writing FAT sectors...", 0
  1470 0000158B 415420736563746F72-
  1470 00001594 732E2E2E00         
  1471                                  
  1472                                  msg_writing_root_dir:
  1473 00001599 57726974696E672072-     	db	"Writing root directory sectors...", 0
  1473 000015A2 6F6F74206469726563-
  1473 000015AB 746F72792073656374-
  1473 000015B4 6F72732E2E2E00     
  1474                                  
  1475                                  StrVolumeName:
  1476 000015BB 00<rep Ch>              	times 	12 db  0
  1477                                  
  1478                                  Msg_Volume_Name:
  1479 000015C7 0D0A                    	db	0Dh, 0Ah
  1480 000015C9 566F6C756D65204E61-     	db	"Volume Name: ", 0
  1480 000015D2 6D653A2000         
  1481                                  
  1482                                  Msg_Volume_Serial:
  1483 000015D7 566F6C756D65205365-     	db	"Volume Serial No: "
  1483 000015E0 7269616C204E6F3A20 
  1484                                  Vol_Serial1:
  1485 000015E9 30303030                	db	"0000"
  1486 000015ED 2D                      	db	"-"
  1487                                  Vol_Serial2:
  1488 000015EE 30303030                	db	"0000"
  1489 000015F2 0D0A00                  	db	0Dh, 0Ah, 0
  1490                                  
  1491                                  msg_OK:
  1492 000015F5 204F4B2E                	db	' OK.'
  1493                                  CRLF:
  1494 000015F9 0D0A00                  	db	0Dh, 0Ah, 0
  1495                                  Msg_YES:
  1496 000015FC 20                      	db	 20h
  1497                                  msg_yes_:
  1498 000015FD 59455300                	db	'YES', 0
  1499                                  Msg_NO:
  1500 00001601 20                      	db	20h
  1501                                  msg_no_:
  1502 00001602 4E4F00                  	db	'NO', 0
  1503                                  
  1504                                  Msg_Error:
  1505 00001605 0D0A                    	db	0Dh, 0Ah
  1506 00001607 4572726F72202120        	db	'Error ! '
  1507 0000160F 28                      	db	'('
  1508                                  error_code:
  1509 00001610 3030                    	dw	3030h
  1510 00001612 68                      	db	'h'
  1511 00001613 2920                    	db	') '
  1512 00001615 0D0A                    	db	0Dh, 0Ah
  1513 00001617 00                      	db	0
  1514                                  
  1515                                  msg_disk_type_selected:
  1516 00001618 4469736B2054797065-     	db	"Disk Type "
  1516 00001621 20                 
  1517                                  delected_disk_num:
  1518 00001622 202068617320626565-     	db	"  has been selected."
  1518 0000162B 6E2073656C65637465-
  1518 00001634 642E               
  1519 00001636 0D0A00                  	db 0Dh, 0Ah, 0
  1520                                  msg_enter_cancel:
  1521 00001639 0D0A                    	db	0Dh, 0Ah
  1522 0000163B 507265737320454E54-     	db	"Press ENTER to write file or press ESC to cancel." 
  1522 00001644 455220746F20777269-
  1522 0000164D 74652066696C65206F-
  1522 00001656 722070726573732045-
  1522 0000165F 534320746F2063616E-
  1522 00001668 63656C2E           
  1523 0000166C 0D0A00                  	db	0Dh, 0Ah, 0
  1524                                  
  1525                                  msg_press_any_key:
  1526 0000166F 0D0A                    	db	0Dh, 0Ah
  1527 00001671 50726573732061206B-     	db	"Press a key to continue..." 
  1527 0000167A 657920746F20636F6E-
  1527 00001683 74696E75652E2E2E   
  1528 0000168B 0D0A00                  	db	0Dh, 0Ah, 0
  1529                                  
  1530                                  msg_creating:
  1531 0000168E 0D0A                    	db	0Dh, 0Ah
  1532 00001690 4372656174696E6720      	db	"Creating "
  1533                                  msg_disk_size:
  1534 00001699 31304D422068617264-     	db	"10MB hard disk image... ",
  1534 000016A2 206469736B20696D61-
  1534 000016AB 67652E2E2E20       
  1535 000016B1 20                      	db	" "
  1536 000016B2 00                      	db	0
  1537                                  
  1538                                  DskTypeNumStr:	
  1539 000016B3 313032303331313031-     	db	"10203110162032"
  1539 000016BC 3632303332         
  1540 000016C1 0000                    	dw	0
  1541                                  
  1542                                  RSymbols:
  1543 000016C3 2D5C7C2F                	db	"-\|/"
  1544                                  
  1545 000016C7 90                      align 2
  1546                                  
  1547                                  Cursor_Pos:
  1548 000016C8 0000                    	dw	0
  1549                                  
  1550                                  CWSector:
  1551 000016CA 0000                    	dw	0
  1552                                  
  1553                                  diskimage_size:
  1554 000016CC 0000                    	dw	0
  1555                                  
  1556                                  DiskType:
  1557 000016CE 00                      	db	0
  1558                                  
  1559                                  img_file_name:  
  1560 000016CF 00<rep Dh>              	times	13 db 0
  1561                                  
  1562                                  ;no_name:
  1563                                  ;	db 	'NO NAME    ', 0
  1564                                  
  1565                                  align 2
  1566                                  
  1567                                  HDFORMAT_SECBUFFER:
  1568                                  HDFORMAT_FATBUFFER:
  1569                                  HDFORMAT_ZERO_BUFF:
  1570 000016DC F6<rep 200h>            	times	512 db 0F6h
  1571                                  
  1572 000018DC 00                      	db	0
  1573 000018DD 286329204572646F67-     	db	'(c) Erdogan TAN 2018-2023'
  1573 000018E6 616E2054414E203230-
  1573 000018EF 31382D32303233     
  1574 000018F6 00                      	db	0
  1575                                  
  1576                                  SizeOfFile equ $-100
