     1                                  ; ****************************************************************************
     2                                  ; FD2IMG.ASM (RD2IMG.COM) - Retro DOS v4 Floppy Disk Image Utility
     3                                  ;         (Reads floppy disk -all- sectors and writes to raw disk image file.)
     4                                  ; ****************************************************************************
     5                                  ; Last Update: 31/10/2023
     6                                  ; ----------------------------------------------------------------------------
     7                                  ; Beginning: 29/10/2023
     8                                  ; ----------------------------------------------------------------------------
     9                                  ; Assembler: NASM version 2.15
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Retro DOS Operating System Project by ERDOGAN TAN (Beginning: 04/02/2018)
    12                                  ; ----------------------------------------------------------------------------
    13                                  ; Derived from 'rfdimage.s'(RFDIMAGE.COM) source code by Erdogan Tan
    14                                  ; (25/10/2023)
    15                                  ; ****************************************************************************
    16                                  ; nasm fd2img.s -l fd2img.lst -o FD2IMG.COM
    17                                  
    18                                  ; DTA (PSP+80h= Offset 128)
    19                                  DTA_Attrib equ 149 ; PDP+21
    20                                  DTA_Time equ 150 ; PSP+22
    21                                  DTA_Date equ 152 ; PSP 24
    22                                  DTA_FileSize equ 154 ; PSP + 26
    23                                  DTA_FileName equ 158 ; PSP + 30
    24                                  
    25                                  [BITS 16]
    26                                  [ORG 100h]
    27                                  
    28 00000000 FA                      	cli
    29 00000001 FC                      	cld
    30 00000002 0E                      	push	cs
    31 00000003 17                      	pop	ss
    32 00000004 BCFEFF                  	mov	sp, 0FFFEh
    33 00000007 FB                      	sti
    34                                  
    35                                  ;-----------------------------------------------------------------
    36                                  ; get fd image file name
    37                                  ;-----------------------------------------------------------------
    38                                  
    39 00000008 BE8000                  	mov	si, 80h			; PSP command tail
    40 0000000B AC                       	lodsb
    41 0000000C 08C0                    	or	al, al 			; command tail length                            
    42 0000000E 7436                    	jz	short R_17		; jump if zero
    43 00000010 89C1                    	mov 	cx, ax
    44                                  R_01:
    45 00000012 49                      	dec	cx
    46 00000013 7431                    	jz	short R_17
    47                                  
    48 00000015 AC                      	lodsb
    49                                  
    50 00000016 3C20                    	cmp	al, ' '			; is it SPACE ?
    51 00000018 722C                    	jb	short R_17
    52 0000001A 74F6                    	je	short R_01
    53                                  
    54                                  	; check floppy disk name
    55                                  T_01:
    56 0000001C 3C41                    	cmp	al, 'A'
    57 0000001E 7226                    	jb	short R_17
    58 00000020 7414                    	je	short T_03
    59 00000022 3C42                    	cmp	al, 'B'
    60 00000024 7610                    	jna	short T_03
    61 00000026 3C5A                    	cmp	al, 'Z'
    62 00000028 761C                    	jna	short R_17
    63                                  	
    64 0000002A 3C61                    	cmp	al, 'a'			; a - z 
    65 0000002C 7218                    	jb	short R_17                  
    66 0000002E 7404                    	je	short T_02
    67 00000030 3C62                    	cmp	al, 'b'
    68 00000032 7718                    	ja	short T_05
    69                                  T_02:
    70 00000034 24DF                    	and	al, 0DFh		; to upper case
    71                                  T_03:
    72 00000036 2C41                    	sub	al, 'A'
    73 00000038 803C3A                  	cmp	byte [si], ':'
    74 0000003B 7504                    	jne	short T_04
    75                                  
    76 0000003D 49                      	dec	cx
    77 0000003E 7406                    	jz	short R_17
    78 00000040 46                      	inc	si
    79                                  T_04:
    80 00000041 803C20                  	cmp	byte [si], 20h
    81 00000044 7423                    	je	short T_06	
    82                                  	;jmp	short R_17 
    83                                  
    84                                  R_17:
    85 00000046 BE[CF02]                	mov	si, RetroDOS_Welcome
    86                                  	;call	print_msg
    87 00000049 E94F01                  	jmp	R_16 ; Exit
    88                                  
    89                                  T_05:
    90 0000004C 3C66                    	cmp	al, 'f'
    91 0000004E 75F6                    	jne	short R_17
    92 00000050 49                      	dec	cx
    93 00000051 49                      	dec	cx
    94 00000052 7EF2                    	jng	short R_17
    95 00000054 AC                      	lodsb
    96 00000055 3C64                    	cmp	al, 'd'
    97 00000057 75ED                    	jne	short R_17
    98 00000059 AC                      	lodsb
    99                                  
   100                                  	; 30/10/2023
   101 0000005A 803C20                  	cmp	byte [si], 20h
   102 0000005D 75E7                    	jne	short R_17
   103 0000005F 46                      	inc	si
   104 00000060 49                      	dec	cx
   105                                  		
   106 00000061 2C30                    	sub	al, '0'
   107 00000063 7407                    	jz	short T_19
   108                                  
   109 00000065 3C01                    	cmp	al, 1
   110 00000067 75DD                    	jne	short R_17
   111                                  T_06:	
   112 00000069 A2[AC02]                	mov	[drivenumber], al
   113                                  
   114                                  T_19:
   115                                  	; 30/10/2023
   116 0000006C AC                      	lodsb
   117 0000006D 3C20                    	cmp	al, 20h
   118 0000006F 7707                    	ja	short R_02
   119 00000071 72D3                    	jb	short R_17
   120                                  
   121 00000073 49                      	dec	cx
   122 00000074 75F6                    	jnz	short T_19
   123 00000076 EBCE                    	jmp	short R_17
   124                                  
   125                                  	; check fd image file name
   126                                  R_02:
   127 00000078 BF[8E05]                       	mov	di, img_file_name
   128 0000007B AA                      	stosb
   129                                  R_03:
   130 0000007C 49                      	dec	cx
   131 0000007D 740C                    	jz	short R_27
   132                                  
   133 0000007F AC                      	lodsb
   134                                  	;cmp	al, 0Dh ; ENTER (CR) key
   135 00000080 3C20                    	cmp	al, 20h ; ' '
   136 00000082 760C                    	jna	short R_04
   137 00000084 AA                      	stosb
   138 00000085 81FF[CE05]              	cmp	di, img_file_name + 64
   139 00000089 72F1                    	jb	short R_03
   140                                  R_27:
   141 0000008B 803C20                  	cmp	byte [si], 20h 
   142 0000008E 77B6                    	ja	short R_17 ; 31/10/2023
   143                                  R_04:
   144 00000090 28C0                    	sub	al, al
   145 00000092 AA                      	stosb
   146                                  
   147                                  ;-----------------------------------------------------------------
   148                                  ; get drive parameters
   149                                  ;-----------------------------------------------------------------
   150                                  
   151                                  T_07:
   152 00000093 B408                    	mov	ah, 08h
   153 00000095 8A16[AC02]              	mov	dl, [drivenumber]	; (0 or 1)
   154 00000099 CD13                    	int	13h			; return disk parameters
   155 0000009B 7306                    	jnc	short T_09
   156                                  T_08:
   157                                  	; Drive not ready error
   158 0000009D BE[9C04]                	mov	si, msg_drv_not_ready_err
   159                                  	;call	print_msg
   160 000000A0 E9F800                  	jmp	R_16 
   161                                  T_09:
   162 000000A3 881E[AD02]              	mov	[disktype], bl
   163                                  	
   164 000000A7 0E                      	push	cs
   165 000000A8 07                      	pop	es
   166                                  
   167                                  	; (this extra check may not be necessary)
   168 000000A9 20DB                    	and	bl, bl
   169 000000AB 74F0                    	jz	short T_08
   170 000000AD 80FB05                  	cmp	bl, 5
   171 000000B0 77EB                    	ja	short T_08
   172                                  
   173                                  	;---------------------------------------------------------
   174                                  
   175                                  	; read boot sector to test (disk is ready in drive)
   176 000000B2 B80102                  	mov	ax, 0201h		; read disk
   177 000000B5 BB[D605]                	mov	bx, trackbuffer		; buffer
   178 000000B8 8A16[AC02]              	mov	dl, [drivenumber]
   179 000000BC 30F6                    	xor	dh, dh			; head 0
   180 000000BE B90100                  	mov	cx, 1			; cylinder 0, sector 1 
   181 000000C1 CD13                    	int	13h
   182 000000C3 72D8                    	jc	short T_08
   183                                  
   184                                  T_10:
   185 000000C5 8B1E[AD02]              	mov	bx, [disktype]	 ; bh = 0
   186 000000C9 81C3[AF02]              	add	bx, SPT_table-1
   187 000000CD 8A07                    	mov	al, [bx]
   188 000000CF BB[D605]                	mov	bx, trackbuffer
   189                                  T_11:
   190 000000D2 A2[AF02]                	mov	[SPT], al
   191                                  	
   192                                  	; read track 0 (will return with error is SPT is wrong)	
   193 000000D5 B402                    	mov	ah, 02h
   194                                  	;mov	al, [SPT]
   195                                  	;mov	dl, [drivenumber]
   196                                  	;xor	dh, dh			; head 0
   197                                  	;mov	cx, 1			; cylinder 0, sector 1 
   198 000000D7 CD13                    	int	13h
   199 000000D9 731A                    	jnc	short R_10
   200                                  
   201                                  	; chance SPT and try again
   202 000000DB 8A26[AD02]              	mov	ah, [disktype]
   203 000000DF FE0E[AD02]              	dec	byte [disktype]
   204 000000E3 B012                    	mov	al, 18
   205 000000E5 80FC04                  	cmp	ah, 4
   206 000000E8 7407                    	je	short T_12  ; 18 -> 9 sectors per track
   207 000000EA 77E6                    	ja	short T_11  ; 36 -> 18 sectors per track
   208 000000EC 80FC02                  	cmp	ah, 2
   209 000000EF 75AC                    	jne	short T_08  
   210                                  	; 15 -> 9 sectors per track	
   211                                  T_12:
   212 000000F1 D1E8                    	shr	ax, 1 ; al = 9
   213 000000F3 EBDD                    	jmp	short T_11
   214                                  
   215                                  ;-----------------------------------------------------------------
   216                                  ; Find image file
   217                                  ;-----------------------------------------------------------------
   218                                  	
   219                                  R_10:
   220 000000F5 BA[8E05]                	mov	dx, img_file_name
   221 000000F8 B93F00                  	mov	cx, 3Fh ; File Attributes
   222 000000FB B44E                    	mov	ah, 4Eh ; MS-DOS Function = Find First File
   223 000000FD CD21                    	int	21h
   224 000000FF 7261                    	jc	short R_05
   225                                  
   226                                  ;-----------------------------------------------------------------
   227                                  ; Check image file features
   228                                  ;-----------------------------------------------------------------
   229                                  
   230 00000101 BE9500                  	mov	si, DTA_Attrib
   231 00000104 8A04                    	mov	al, [si]
   232 00000106 241F                    	and	al, 1Fh ; directory, volume label, system, hidden, read only
   233 00000108 7558                    	jnz	short R_05
   234                                  
   235                                  	; disk sizes: (in bytes)
   236                                  	; 2.88 MB = 2D0000h
   237                                  	; 1.44 MB = 168000h
   238                                  	;  720 KB = 0B4000h
   239                                  	; 1200 KB = 12C000h
   240                                  	;  360 KB = 05A000h
   241                                  
   242 0000010A 8B36[AD02]              	mov	si, [disktype]
   243 0000010E 89F7                    	mov	di, si
   244 00000110 D1E6                    	shl	si, 1
   245 00000112 D1E6                    	shl	si, 1
   246 00000114 81C6[B702]              	add	si, imagesizetbl-4
   247 00000118 AD                      	lodsw
   248 00000119 89C1                    	mov	cx, ax
   249 0000011B 8B1C                    	mov	bx, [si]	
   250                                  
   251 0000011D BE9A00                  	mov	si, DTA_FileSize
   252 00000120 AD                      	lodsw
   253 00000121 8B14                    	mov	dx, [si]
   254                                  
   255 00000123 A9FF0F                  	test	ax, 4095 ; 0FFFh
   256 00000126 7535                    	jnz	short R_06
   257                                  
   258 00000128 39DA                    	cmp	dx, bx
   259 0000012A 7522                    	jne	short R_07
   260 0000012C 39C8                    	cmp	ax, cx
   261 0000012E 751E                    	jne	short R_07
   262                                  		
   263                                  	; same image/disk size
   264                                  	;---------------------------------------------------------
   265                                  	
   266                                  	; read track (will return with error if the inserted disk
   267                                  	;	      is not same with the disk image)
   268                                  
   269 00000130 81C7[AF02]              	add	di, SPT_table-1
   270 00000134 8A05                    	mov	al, [di]
   271 00000136 A2[AF02]                	mov	[SPT], al
   272                                  	
   273                                  	; read track 1 to test (disk is ready in drive)
   274                                  	; al = SPT
   275 00000139 B402                    	mov	ah, 02h			; read disk
   276 0000013B BB[D605]                	mov	bx, trackbuffer		; buffer
   277 0000013E 8A16[AC02]              	mov	dl, [drivenumber]
   278 00000142 30F6                    	xor	dh, dh			; head 0
   279 00000144 B90101                  	mov	cx, 101h		; track 1, sector 1 
   280 00000147 CD13                    	int	13h
   281 00000149 731C                    	jnc	short T_13
   282                                  
   283 0000014B E94FFF                  	jmp	T_08	; drive not ready error
   284                                  
   285                                  R_07:
   286 0000014E B90A00                  	mov	cx, 10
   287 00000151 BF[BB02]                	mov	di, imagesizetbl
   288 00000154 F2AF                    	repne	scasw
   289 00000156 E305                    	jcxz	R_06	
   290                                  
   291 00000158 BE[0404]                	mov	si, msg_improper_size
   292 0000015B EB3E                    	jmp	short R_16
   293                                  
   294                                  R_06:
   295 0000015D BE[9F03]                	mov	si, msg_inv_image_file
   296 00000160 EB39                    	jmp	short R_16
   297                                  
   298                                  R_05:
   299 00000162 BE[ED03]                	mov	si, msg_file_notfound
   300 00000165 EB34                    	jmp	short R_16
   301                                  
   302                                  ;-----------------------------------------------------------------
   303                                  ; Check current drive
   304                                  ;-----------------------------------------------------------------
   305                                  
   306                                  T_13:
   307 00000167 B419                    	mov	ah, 19h	; get current/default drive
   308 00000169 CD21                    	int	21h	
   309                                  
   310 0000016B 38D0                    	cmp	al, dl	; cmp al, [drivenumber]
   311 0000016D 7505                    	jne	short R_11
   312                                  
   313 0000016F BE[3804]                	mov	si, msg_permission_denied
   314 00000172 EB27                    	jmp	short R_16
   315                                  
   316                                  ;-----------------------------------------------------------------
   317                                  ; Overwrite question
   318                                  ;-----------------------------------------------------------------
   319                                  
   320                                  R_11:
   321 00000174 A0[AC02]                	mov	al, [drivenumber]
   322 00000177 0441                    	add	al, 'A'
   323 00000179 A2[8E04]                	mov	[drv_chr], al
   324                                  
   325 0000017C BE[6D04]                	mov	si, msg_overwrite_question
   326 0000017F E8D500                  	call	print_msg
   327                                  	
   328                                  	; get answer
   329                                  R_15:
   330 00000182 31C0                    	xor	ax, ax
   331 00000184 CD16                    	int	16h			; wait for keyboard command
   332 00000186 3C03                    	cmp	al, 'C'-40h
   333 00000188 7414                    	je	short R_12 ; Exit                   
   334 0000018A 3C1B                    	cmp	al, 27
   335 0000018C 7410                    	je	short R_12 ; Exit
   336 0000018E 24DF                    	and	al, 0DFh
   337 00000190 3C59                    	cmp	al, 'Y'			; Yes?
   338 00000192 741A                    	je	short R_18		; write
   339 00000194 3C4E                    	cmp	al, 'N'			; No?
   340 00000196 75EA                    	jne	short R_15      
   341                                  					; no write (exit)  
   342 00000198 BE[6D05]                	mov	si, Msg_NO
   343                                  
   344                                  ;-----------------------------------------------------------------
   345                                  ; Nextline & Exit
   346                                  ;-----------------------------------------------------------------
   347                                  
   348                                  R_16:
   349 0000019B E8B900                  	call	print_msg
   350                                  R_12:
   351 0000019E BE[7505]                	mov	si, CRLF
   352 000001A1 E8B300                  	call	print_msg
   353 000001A4 B8004C                  	mov	ax, 4C00h		; terminate
   354 000001A7 CD21                    	int	21h
   355                                  
   356                                  R_19:
   357 000001A9 BE[3804]                	mov	si, msg_permission_denied
   358                                  	;call	print_msg
   359 000001AC EBED                    	jmp	short R_16
   360                                  
   361                                  R_18:
   362 000001AE BE[6805]                	mov	si, Msg_YES
   363 000001B1 E8A300                  	call	print_msg
   364                                  	;jmp	short R_20
   365                                  
   366                                  ;-----------------------------------------------------------------
   367                                  ; Read image file ands write onto disk
   368                                  ;-----------------------------------------------------------------
   369                                  
   370                                  R_20:
   371 000001B4 BE[7505]                	mov	si, CRLF
   372 000001B7 E89D00                  	call	print_msg
   373                                  
   374                                  ;-----------------------------------------------------------------
   375                                  ; Open image file for reading
   376                                  ;-----------------------------------------------------------------
   377                                  
   378                                  	; 31/10/2023
   379                                  
   380                                  	;mov	al, 0 ; open for reading
   381 000001BA BA[8E05]                	mov	dx, img_file_name
   382 000001BD B43D                    	mov	ah, 3Dh ; open file
   383 000001BF CD21                    	int	21h
   384 000001C1 7305                    	jnc	short R_21
   385                                  T_18:
   386 000001C3 BE[B204]                	mov	si, msg_reading_err
   387 000001C6 EBD3                    	jmp	R_16
   388                                  R_21:
   389 000001C8 A3[8C05]                	mov	[img_file_handle], ax
   390                                  
   391 000001CB BE[FB04]                	mov	si, msg_disk_type
   392 000001CE E88600                  	call	print_msg
   393                                  
   394 000001D1 B013                    	mov	al, disktypestrsize
   395 000001D3 F626[AD02]              	mul	byte [disktype]
   396 000001D7 BE[F604]                	mov	si, disktypestr-disktypestrsize
   397 000001DA 01C6                    	add	si, ax
   398 000001DC E87800                  	call	print_msg
   399 000001DF BE[7505]                	mov	si, CRLF
   400 000001E2 E87200                  	call	print_msg
   401                                  	
   402                                  	; al = 0
   403 000001E5 8A26[AF02]              	mov	ah, [SPT]
   404 000001E9 D0E4                    	shl	ah, 1 ; ax = [SPT] * 512
   405 000001EB A3[D405]                	mov	[tracksize], ax
   406 000001EE B85000                  	mov	ax, 80
   407 000001F1 803E[AD02]01            	cmp	byte [disktype], 1
   408 000001F6 7702                    	ja	short T_14
   409 000001F8 D1E8                    	shr	ax, 1 ; mov al, 40
   410                                  T_14:
   411 000001FA A3[D205]                	mov	[numtracks], ax
   412                                  
   413                                  ;-----------------------------------------------------------------
   414                                  ; writing sectors
   415                                  ;-----------------------------------------------------------------
   416                                  
   417 000001FD BE[EA04]                	mov	si, msg_writing
   418 00000200 E85400                  	call	print_msg
   419                                  
   420 00000203 B403                    	mov	ah, 3
   421                                  	;mov	bx, 7
   422 00000205 CD10                    	int	10h ; Return Cursor Position
   423                                  	; DL = Column, DH = Line
   424 00000207 8916[D005]              	mov	[cursorpos], dx
   425                                  T_15:	
   426 0000020B E87200                  	call	calculate_percentage
   427                                  
   428 0000020E BE[B702]                	mov	si, percent_str
   429 00000211 E84300                  	call	print_msg
   430                                  R_22:
   431                                  	;sub	al, al
   432 00000214 8B1E[8C05]              	mov	bx, [img_file_handle]
   433 00000218 8B0E[D405]              	mov	cx, [tracksize] ; SPT*512
   434 0000021C BA[D605]                	mov	dx, trackbuffer ; buffer
   435 0000021F B43F                    	mov	ah, 3Fh ; read file	
   436 00000221 CD21                    	int	21h
   437 00000223 729E                    	jc	short T_18
   438                                  
   439 00000225 E83E00                  	call	write_track
   440 00000228 7221                    	jc	short R_24
   441                                  
   442 0000022A 8036[B602]01            	xor	byte [head], 1
   443 0000022F 75E3                    	jnz	short R_22
   444                                  R_23:
   445 00000231 FE06[B502]              	inc	byte [track]
   446 00000235 A0[D205]                	mov	al, [numtracks]
   447 00000238 3A06[B502]              	cmp	al, [track]
   448 0000023C 7613                    	jna	short R_25
   449                                  	
   450 0000023E 8B16[D005]              	mov	dx, [cursorpos]
   451 00000242 B402                    	mov	ah, 2
   452 00000244 BB0700                  	mov	bx, 7
   453 00000247 CD10                    	int	10h  ; Set Cursor Position
   454 00000249 EBC0                    	jmp	short T_15
   455                                  
   456                                  R_24:
   457 0000024B BE[C804]                	mov	si, msg_writing_err
   458                                  	;call	print_msg
   459 0000024E E94AFF                  	jmp	R_16
   460                                  
   461                                  R_25:
   462 00000251 BE[7105]                	mov	si, Msg_OK
   463 00000254 E944FF                  	jmp	R_16
   464                                  
   465                                  ;-----------------------------------------------------------------
   466                                  ; Print messages
   467                                  ;-----------------------------------------------------------------
   468                                  
   469                                  print_msg:
   470                                  
   471                                  print_msg_LOOP:
   472 00000257 AC                      	lodsb                           ; Load byte at DS:SI to AL
   473 00000258 20C0                    	and     al, al            
   474 0000025A 7409                    	jz      short print_msg_OK       
   475 0000025C B40E                    	mov	ah, 0Eh			
   476 0000025E BB0700                  	mov     bx, 07h             
   477 00000261 CD10                    	int	10h			; BIOS Service func ( ah ) = 0Eh
   478                                  					; Write char as TTY
   479                                  					; AL-char BH-page BL-color
   480 00000263 EBF2                    	jmp     short print_msg_LOOP           
   481                                  
   482                                  print_msg_OK:
   483 00000265 C3                      	retn
   484                                  
   485                                  ;-----------------------------------------------------------------
   486                                  ; write disk track
   487                                  ;-----------------------------------------------------------------
   488                                  
   489                                  write_track:
   490 00000266 89D3                    	mov	bx, dx	; trackbuffer
   491 00000268 B403                    	mov	ah, 03h
   492 0000026A A0[AF02]                	mov	al, [SPT]
   493 0000026D 8A16[AC02]              	mov	dl, [drivenumber]
   494 00000271 8A36[B602]              	mov	dh, [head]		; head 0 or 1
   495 00000275 8A2E[B502]              	mov	ch, [track]
   496 00000279 B101                    	mov	cl, 1			; sector 1
   497 0000027B CD13                    	int	13h
   498 0000027D B000                    	mov	al, 0
   499 0000027F C3                      	retn
   500                                  
   501                                  ;-----------------------------------------------------------------
   502                                  ; calculate and set writing percentage
   503                                  ;-----------------------------------------------------------------
   504                                  
   505                                  calculate_percentage:
   506 00000280 BF[B702]                	mov	di, percent_str
   507 00000283 A0[B502]                	mov	al, [track]
   508 00000286 FEC0                    	inc	al
   509 00000288 8A0E[D205]              	mov	cl, [numtracks] ; 80 or 40
   510 0000028C 38C8                    	cmp	al, cl
   511 0000028E 7207                    	jb	short cperc_1
   512 00000290 B031                    	mov	al, '1'
   513 00000292 AA                      	stosb
   514 00000293 31C0                    	xor	ax, ax
   515 00000295 EB0C                    	jmp	short cperc_2
   516                                  cperc_1:
   517 00000297 B464                    	mov	ah, 100
   518 00000299 F6E4                    	mul	ah
   519 0000029B F6F1                    	div	cl
   520                                  	; al = %
   521 0000029D 30E4                    	xor	ah, ah
   522 0000029F B10A                    	mov	cl, 10
   523 000002A1 F6F1                    	div	cl
   524                                  cperc_2:
   525 000002A3 053030                  	add	ax, '00' ; 3030h
   526 000002A6 AB                      	stosw
   527 000002A7 B82500                  	mov	ax, '%'
   528 000002AA AB                      	stosw
   529 000002AB C3                      	retn
   530                                  
   531                                  ;-----------------------------------------------------------------
   532                                  ;  Data
   533                                  ;-----------------------------------------------------------------
   534                                  
   535                                  	; 30/10/2023
   536                                  
   537                                  drivenumber:
   538 000002AC 00                      	db	0
   539                                  disktype:
   540 000002AD 0000                    	dw	0
   541                                  
   542 000002AF 00                      SPT:	db	0
   543                                  SPT_table:
   544 000002B0 090F091224              	db	9, 15, 9, 18, 36
   545                                  
   546 000002B5 00                      track:	db	0
   547 000002B6 00                      head:	db	0
   548                                  
   549                                  percent_str:
   550 000002B7 30302500                	db	'00%', 0
   551                                  
   552                                  	; disk sizes: (in bytes)
   553                                  	; 2.88 MB = 2D0000h
   554                                  	; 1.44 MB = 168000h
   555                                  	;  720 KB = 0B4000h
   556                                  	; 1200 KB = 12C000h
   557                                  	;  360 KB = 05A000h
   558                                  
   559                                  	; 31/10/2023
   560                                  imagesizetbl:
   561 000002BB 00A00500                	dd	05A000h
   562 000002BF 00001200                	dd	120000h
   563 000002C3 00400B00                	dd	0B4000h
   564 000002C7 00801600                	dd	168000h
   565 000002CB 00002D00                	dd	2D0000h
   566                                  
   567                                  ;-----------------------------------------------------------------
   568                                  ;  Messages
   569                                  ;-----------------------------------------------------------------
   570                                  
   571                                  RetroDOS_Welcome:
   572 000002CF 0D0A                    	db	0Dh, 0Ah
   573 000002D1 466C6F707079204469-     	db	'Floppy Disk Image Utility (image copy to disk)'
   573 000002DA 736B20496D61676520-
   573 000002E3 5574696C6974792028-
   573 000002EC 696D61676520636F70-
   573 000002F5 7920746F206469736B-
   573 000002FE 29                 
   574 000002FF 0D0A                    	db	0Dh, 0Ah
   575 00000301 76312E302E32333130-     	db	"v1.0.231031  (c) Erdogan TAN 2023"
   575 0000030A 333120202863292045-
   575 00000313 72646F67616E205441-
   575 0000031C 4E2032303233       
   576 00000322 0D0A                    	db	0Dh,0Ah
   577 00000324 0D0A                    	db	0Dh,0Ah
   578 00000326 55736167653A20696D-     	db	'Usage: img2fd <fd name> <image file name> '
   578 0000032F 67326664203C666420-
   578 00000338 6E616D653E203C696D-
   578 00000341 6167652066696C6520-
   578 0000034A 6E616D653E20       
   579 00000350 0D0A                    	db	0Dh, 0Ah
   580 00000352 0D0A                    	db	0Dh, 0Ah
   581 00000354 20204578616D706C65-     	db	'  Example: img2fd a: a.img '
   581 0000035D 3A20696D6732666420-
   581 00000366 613A20612E696D6720 
   582 0000036F 0D0A                    	db	0Dh, 0Ah
   583 00000371 0D0A                    	db	0Dh, 0Ah
   584 00000373 4469736B206E616D65-     	db	'Disk names: A:, B: or fd0 (A:), fd1 (B:) ' 
   584 0000037C 733A20413A2C20423A-
   584 00000385 206F72206664302028-
   584 0000038E 413A292C2066643120-
   584 00000397 28423A2920         
   585 0000039C 0D0A                    	db	0Dh, 0Ah
   586 0000039E 00                      	db	0
   587                                  
   588                                  msg_inv_image_file:
   589 0000039F 0D0A                    	db	0Dh, 0Ah
   590 000003A1 496E76616C69642066-     	db	"Invalid floppy disk image file !", 0Dh, 0Ah
   590 000003AA 6C6F70707920646973-
   590 000003B3 6B20696D6167652066-
   590 000003BC 696C6520210D0A     
   591 000003C3 28646F6573206E6F74-     	db	"(does not correspond to any fd image) !"
   591 000003CC 20636F72726573706F-
   591 000003D5 6E6420746F20616E79-
   591 000003DE 20666420696D616765-
   591 000003E7 292021             
   592 000003EA 0D0A00                  	db	0Dh, 0Ah, 0
   593                                  
   594                                  msg_file_notfound:
   595 000003ED 0D0A                    	db	0Dh, 0Ah
   596 000003EF 46696C65206E6F7420-     	db	"File not found !", 0Dh, 0Ah
   596 000003F8 666F756E6420210D0A 
   597 00000401 0D0A00                  	db	0Dh, 0Ah, 0
   598                                  
   599                                  msg_improper_size:
   600 00000404 0D0A                    	db	0Dh, 0Ah
   601 00000406 54686520666420696D-     	db	"The fd image and the floppy disk does not fit !"
   601 0000040F 61676520616E642074-
   601 00000418 686520666C6F707079-
   601 00000421 206469736B20646F65-
   601 0000042A 73206E6F7420666974-
   601 00000433 2021               
   602 00000435 0D0A00                  	db	0Dh, 0Ah, 0
   603                                  
   604                                  msg_permission_denied: 
   605 00000438 0D0A                    	db	0Dh, 0Ah
   606 0000043A 5065726D697373696F-     	db	"Permission denied ! ", 0Dh, 0Ah
   606 00000443 6E2064656E69656420-
   606 0000044C 21200D0A           
   607 00000450 2843757272656E7420-     	db	"(Current drive selected) !"
   607 00000459 64726976652073656C-
   607 00000462 6563746564292021   
   608 0000046A 0D0A00                  	db	0Dh, 0Ah, 0
   609                                  
   610                                  msg_overwrite_question:
   611 0000046D 0D0A                    	db	0Dh, 0Ah
   612 0000046F 446F20796F75207761-     	db	"Do you want to overwrite drive "
   612 00000478 6E7420746F206F7665-
   612 00000481 727772697465206472-
   612 0000048A 69766520           
   613                                  drv_chr:
   614 0000048E 403A20285965732F4E-     	db	"@: (Yes/No)? ", 0
   614 00000497 6F293F2000         
   615                                  
   616                                  msg_drv_not_ready_err: 
   617 0000049C 0D0A                    	db	0Dh, 0Ah
   618 0000049E 4472697665206E6F74-     	db	"Drive not ready !"
   618 000004A7 2072656164792021   
   619 000004AF 0D0A00                  	db	0Dh, 0Ah, 0
   620                                  
   621                                  msg_reading_err: 
   622 000004B2 0D0A                    	db	0Dh, 0Ah
   623 000004B4 46696C652072656164-     	db	"File read error !"
   623 000004BD 206572726F722021   
   624 000004C5 0D0A00                  	db	0Dh, 0Ah, 0
   625                                  
   626                                  msg_writing_err:
   627 000004C8 0D0A                    	db	0Dh, 0Ah
   628 000004CA 4469736B2077726974-     	db	"Disk write error !"
   628 000004D3 65206572726F722021 
   629 000004DC 0D0A00                  	db	0Dh, 0Ah, 0	
   630                                  
   631                                  msg_yes_no:
   632 000004DF 285965732F4E6F293F-     	db	'(Yes/No)? ', 0		
   632 000004E8 2000               
   633                                  
   634                                  msg_writing:
   635 000004EA 57726974696E672074-     	db	"Writing tracks: ", 0
   635 000004F3 7261636B733A2000   
   636                                  
   637                                  msg_disk_type:
   638 000004FB 0D0A                    	db	0Dh, 0Ah
   639 000004FD 4469736B2054797065-     	db	'Disk Type: '
   639 00000506 3A20               
   640 00000508 00                      	db	0
   641                                  
   642                                  disktypestr:
   643 00000509 31202D20352E323522-     	db	'1 - 5.25",  360 KB',0
   643 00000512 2C2020333630204B42-
   643 0000051B 00                 
   644                                  disktypestrsize equ $ - disktypestr
   645 0000051C 32202D20352E323522-     	db	'2 - 5.25", 1200 KB',0
   645 00000525 2C2031323030204B42-
   645 0000052E 00                 
   646 0000052F 33202D20352E323522-      	db	'3 - 5.25",  720 KB',0
   646 00000538 2C2020373230204B42-
   646 00000541 00                 
   647 00000542 34202D20332E35222C-     	db	'4 - 3.5",  1440 KB',0
   647 0000054B 202031343430204B42-
   647 00000554 00                 
   648 00000555 35202D20332E35222C-      	db	'5 - 3.5",  2880 KB',0	
   648 0000055E 202032383830204B42-
   648 00000567 00                 
   649                                  
   650                                  Msg_YES:
   651 00000568 2059455300              	db	' YES', 0
   652                                  Msg_NO:
   653 0000056D 204E4F00                	db	' NO', 0
   654                                  
   655                                  Msg_OK:
   656 00000571 204F4B2E                	db	' OK.'
   657                                  CRLF:
   658 00000575 0D0A00                  	db	0Dh, 0Ah, 0
   659                                  
   660 00000578 286329204572646F67-     	db	'(c) Erdogan TAN 2023'
   660 00000581 616E2054414E203230-
   660 0000058A 3233               
   661                                  
   662                                  ;SizeOfFile equ $-100
   663                                  
   664                                  ;-----------------------------------------------------------------
   665                                  ; uninitialized data
   666                                  ;-----------------------------------------------------------------
   667                                  
   668                                  bss_start:
   669                                  
   670                                  ABSOLUTE bss_start
   671                                  
   672                                  alignb 2
   673                                  
   674                                  img_file_handle:
   675 0000058C ????                    	resw	1
   676                                  img_file_name:  
   677 0000058E <res 42h>               	resb	66
   678                                  cursorpos:
   679 000005D0 ????                    	resw	1
   680                                  numtracks:
   681 000005D2 ????                    	resw	1
   682                                  tracksize:
   683 000005D4 ????                    	resw	1
   684                                  trackbuffer:
   685 000005D6 <res 4800h>             	resb	36*512
   686                                  
   687                                  end_bss:		
   688                                    
