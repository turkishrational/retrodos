     1                                  ; ****************************************************************************
     2                                  ; FDISK.ASM (FDISK.COM) - MSDOS 3.3 Hard Disk Partitioning Utility
     3                                  ; 	    by Erdogan Tan				  (for MSDOS/WINDOWS)
     4                                  ; ****************************************************************************
     5                                  ; Last Update: 22/10/2018
     6                                  ; ----------------------------------------------------------------------------
     7                                  ; Beginning: 21/10/2018
     8                                  ; ----------------------------------------------------------------------------
     9                                  ; Assembler: NASM version 2.11
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Modified from disassembled source code of FDISK.COM by Alan Jay Weiner, 1983
    12                                  ; ****************************************************************************
    13                                  ; nasm fdisk.s -l fdisk.txt -o FDISK.COM
    14                                  ; ============================================================================
    15                                  ;
    16                                  ; ---------------------------------------------------------------------------
    17                                  ; -	This file is generated by The Interactive Disassembler (IDA)	    -
    18                                  ; -	Copyright (c) 2010 by Hex-Rays SA, <support@hex-rays.com>	    -
    19                                  ; -			 Licensed to: Freeware version			    -
    20                                  ; ---------------------------------------------------------------------------
    21                                  ;
    22                                  ; Input	MD5   :	B4080FCD526BEB3060C00FCC3FF4E9CC
    23                                  
    24                                  ; File Name   :	D:\Documents and Settings\Erdoðan Tan\Desktop\FDISK.COM
    25                                  ; Format      :	MS-DOS COM-file
    26                                  ; Base Address:	0h Range: 100h-1702h Loaded length: 1602h
    27                                  
    28                                  ; ============================================================================
    29                                  
    30                                  	[BITS 16]
    31                                  	[ORG 100h]
    32                                  
    33                                  start:
    34 00000000 E98700                  	jmp	code_start
    35                                  
    36 00000003 E207                    	dw	2018
    37 00000005 A101                    	dw	01A1h
    38                                  
    39 00000007 00                      	db	0
    40                                  ; ----------------------------------------------------------------------------
    41                                  
    42 00000008 464449534B20757469-     	db 'FDISK utility Copyright 1983 Phoenix Software Associates, Ltd'
    43 00000011 6C69747920436F7079-
    44 0000001A 726967687420313938-
    45 00000023 332050686F656E6978-
    46 0000002C 20536F667477617265-
    47 00000035 204173736F63696174-
    48 0000003E 65732C204C7464     
    49 00000045 0D0A                    	db 0Dh,0Ah
    50 00000047 7772697474656E2062-     	db 'written by Alan Jay Weiner'
    51 00000050 7920416C616E204A61-
    52 00000059 79205765696E6572   
    53 00000061 1A                      	db 1Ah
    54                                  
    55                                  	; FDISK.COM file - 05/06/1985 
    56                                  	; (It is seen as, there is a modification on 1983 code for FAT16 FS)
    57                                  	; (Also this modification may be reason of unused code in FDISK.COM.) 
    58                                  
    59                                  ;MBR_ADDR:	dw	MBR
    60 00000062 [2214]                  buffer:		dw	end_of_file+2
    61                                  
    62                                  current_partition:
    63 00000064 00                      p_status:	db	0
    64 00000065 00                      start_head:	db	0
    65 00000066 0000                    start_cyl_sec:	dw	0
    66 00000068 00                      partition_type:	db	0
    67 00000069 00                      end_head:	db	0
    68 0000006A 0000                    end_cyl_sec:	dw	0
    69 0000006C 0000                    start_lba_lw:	dw	0
    70 0000006E 0000                    start_lba_hw:	dw	0
    71 00000070 0000                    sectors_lba_lw:	dw	0
    72 00000072 0000                    sectors_lba_hw:	dw	0
    73                                  
    74 00000074 0000                    pt_start_cyl:	dw	0
    75 00000076 0000                    pt_end_cyl:	dw	0
    76 00000078 0000                    pt_cylinders:	dw	0
    77 0000007A 01                      file_system:	db	1
    78                                  cpartition_number:
    79 0000007B 00                      		db	0
    80 0000007C 00                      partition:	db	0
    81 0000007D 80                      drive:		db	80h ; 0
    82 0000007E 31                      disk_number:	db	'1' ; 0
    83 0000007F 00                      wait_for_input:	db	0
    84                                  max_avl_cylinders: 
    85 00000080 0000                    		dw	0
    86                                  next_start_cylinder: 
    87 00000082 0000                    		dw	0
    88 00000084 0000                    cylinders:	dw	0
    89 00000086 0000                    start_cyl:	dw	0
    90                                  active_part_input:
    91 00000088 00                      		db	0
    92                                  active_partition:
    93 00000089 00                      		db	0
    94                                  
    95                                  ; ----------------------------------------------------------------------------
    96                                  
    97                                  code_start:
    98 0000008A 0E                      		push	cs
    99 0000008B 07                      		pop	es
   100 0000008C BA[3E07]                		mov	dx,CLSSET
   101 0000008F E8830E                  		call	write_on_screen
   102                                  		;mov	byte [drive],80h
   103                                  		;mov	byte [disk_number],'1'
   104                                  		;mov	byte [wait_for_input],0
   105 00000092 E80704                  		call	get_harddisk_parameters
   106 00000095 7308                    		jnc	short read_mb_sector
   107 00000097 BA[4207]                		mov	dx,NOFDISKPMSG ; "\r\n\nNo fixed disks present.\r\n\n"
   108 0000009A E8780E                  		call	write_on_screen
   109 0000009D EB31                    		jmp	short terminate
   110                                  
   111                                  read_mb_sector:
   112 0000009F E82A04                  		call	read_mbr
   113                                  
   114                                  start_screen:
   115                                  
   116                                  ;       |0000000000111111111122222222223333333333|  MAIN MENU   ;
   117                                  ;       |0123456789012345678901234567890123456789|              ;
   118                                  ;     --------------------------------------------              ;
   119                                  ;     00|                                        | FDISKOPMPAGE ;
   120                                  ;     01|                                        |              ;
   121                                  ;     02|                                        |              ;
   122                                  ;     03|                                        |              ;
   123                                  ;     04|FDISK Options                           |              ;
   124                                  ;     05|                                        |              ;
   125                                  ;     06|Current Fixed Disk Drive: 1             |              ;
   126                                  ;     07|                                        |              ;
   127                                  ;     08|                                        |              ;
   128                                  ;     09|Choose one of the following:            |              ;
   129                                  ;     10|                                        |              ;
   130                                  ;     11|    1.  Create DOS Partition            |              ;
   131                                  ;     12|    2.  Change Active Partition         |              ;
   132                                  ;     13|    3.  Delete DOS Partition            |              ;
   133                                  ;     14|    4.  Display Partition Data          |              ;
   134                                  ;     15|    5.  Select Next Fixed Disk Drive    |              ;
   135                                  ;     16|                                        |              ;
   136                                  ;     17|Enter choice: [1]                       |              ;
   137                                  ;     18|                                        |              ;
   138                                  ;     19|                                        |              ;
   139                                  ;     20|                                        |              ;
   140                                  ;     21|                                        |              ;
   141                                  ;     22|                                        |              ;
   142                                  ;     23|# is not a choice.  Enter a choice.     | WRONGSELECT  ;
   143                                  ;     24|Press ESC to return to DOS.             |              ;
   144                                  ;     --------------------------------------------              ;
   145                                  
   146 000000A2 BA[6007]                		mov	dx,FDISKOPMPAGE
   147 000000A5 E86D0E                  		call	write_on_screen
   148                                  so1:
   149 000000A8 8B16[CF08]              		mov	dx,[opnum_cpos]
   150 000000AC E86811                  		call	set_cursor_position
   151 000000AF A0[CE08]                		mov	al,[def_opnum]
   152 000000B2 E8410F                  		call	select_option_number
   153 000000B5 BB[E800]                		mov	bx,input_num_ftbl
   154 000000B8 E8B010                  		call	input_type_function
   155                                  so2:
   156 000000BB BA[A308]                		mov	dx,WRONGSELECT
   157 000000BE E8540E                  		call	write_on_screen
   158 000000C1 EBE5                    		jmp	short so1
   159                                  
   160                                  op_cancel_exit:
   161 000000C3 803E[7F00]00            		cmp	byte [wait_for_input],0
   162 000000C8 750A                    		jne	short getch_reboot
   163 000000CA BA[AE0E]                		mov	dx,cls1
   164 000000CD E8450E                  		call	write_on_screen
   165                                  terminate:
   166 000000D0 B400                    		mov	ah,0
   167 000000D2 CD21                    		int	21h		; DOS -	PROGRAM	TERMINATION
   168                                  
   169                                  getch_reboot:
   170 000000D4 BA[B00E]                		mov	dx,cls_reboot_msg
   171 000000D7 E83B0E                  		call	write_on_screen
   172 000000DA E88910                  		call	getchar
   173 000000DD BA[0D0F]                		mov	dx,cls2
   174 000000E0 E8320E                  		call	write_on_screen
   175 000000E3 EA0000FFFF              		jmp	0FFFFh:0
   176                                  
   177                                  ; ----------------------------------------------------------------------------
   178                                  
   179 000000E8 31                      input_num_ftbl:	db	'1'
   180 000000E9 [FB00]                  		dw	op_create_dosp  ; Create DOS Partition
   181 000000EB 32                      		db	'2'
   182 000000EC [2402]                  		dw	op_chg_activep	; Change Active Partition
   183 000000EE 33                      		db	'3'
   184 000000EF [CD02]                  		dw	op_delete_dosp	; Delete DOS Partition
   185 000000F1 34                      		db	'4'
   186 000000F2 [4503]                  		dw	op_display_pt	; Display Partition Data
   187 000000F4 35                      		db	'5'
   188 000000F5 [5103]                  		dw	op_sel_nxt_disk	; Select Next Fixed Disk Drive
   189                                  
   190 000000F7 1B                      		db	27  ; 1Bh (ESCape) ; Cancel, Return to DOS 
   191 000000F8 [C300]                  		dw	op_cancel_exit
   192 000000FA 00                      		db	0
   193                                  
   194                                  ; ----------------------------------------------------------------------------
   195                                  
   196                                  op_create_dosp:		; Create DOS Partition	
   197 000000FB BA[6B0A]                		mov	dx,createdosp_msg
   198 000000FE E8140E                  		call	write_on_screen
   199 00000101 E8F602                  		call	dos_partitions
   200 00000104 750C                    		jnz	short create_dosp
   201 00000106 E87502                  		call	display_partition_table
   202 00000109 BA[8B0A]                		mov	dx,alreadydosp_msg
   203 0000010C E8060E                  		call	write_on_screen
   204 0000010F E9A300                  		jmp	cdosp5
   205                                  
   206                                  ; ----------------------------------------------------------------------------
   207                                  
   208                                  create_dosp: ; The disk hasn't got a DOS partition, let's create DOS partition
   209                                  
   210                                  ;       |00000000001111111111222222222233333333334444444444| CREATE MENU     ;
   211                                  ;       |01234567890123456789012345678901234567890123456789|                 ;
   212                                  ;     ------------------------------------------------------                 ;
   213                                  ;     00|                                                  | PTABLEHEADER    ;
   214                                  ;     01|                                                  |                 ;
   215                                  ;     02|                                                  |                 ;
   216                                  ;     03|                                                  |                 ;
   217                                  ;     04|Create DOS partition                              | createdosp_msg  ;
   218                                  ;     05|                                                  |                 ;
   219                                  ;     06|Current Fixed Disk Drive: 1                       |                 ;
   220                                  ;     07|                                                  |                 ;
   221                                  ;     08|                                                  |                 ;
   222                                  ;     09|Partition   Status   Type   Start   End   Size    |                 ;
   223                                  ;     10|    1          A     DOS        0    63     64    | DOSPTABLEROW    ;
   224                                  ;     11|                                                  |                 ;
   225                                  ;     12|                                                  |                 ;
   226                                  ;     13|                                                  |                 ;
   227                                  ;     14|Total disk space is    64 cylinders               | TOTALDISKSIZE   ;
   228                                  ;     15|The current active partition is 1                 | CURACTIVEPART   ;
   229                                  ;     16|                                                  |                 ;
   230                                  ;     17|                                                  |                 ;
   231                                  ;     18|                                                  |                 ;
   232                                  ;     19|Fixed disk already has a DOS partition.           | alreadydosp_msg ;
   233                                  ;     20|                                                  |                 ;
   234                                  ;     21|                                                  |                 ;
   235                                  ;     22|                                                  |                 ;
   236                                  ;     23|                                                  |                 ;
   237                                  ;     24|Press Esc to return to FDISK Options _            |                 ;
   238                                  ;     ------------------------------------------------------                 ;
   239                                  
   240 00000112 B101                    		mov	cl,1
   241 00000114 E81803                  		call	find_first_partition
   242 00000117 732D                    		jnc	short cdosp2
   243 00000119 BA[B80A]                		mov	dx,empty_pt
   244 0000011C E8F60D                  		call	write_on_screen
   245 0000011F A0[8B0C]                		mov	al,[_yes_]
   246 00000122 E8D10E                  		call	select_option_number
   247 00000125 BB[1402]                		mov	bx,input_yn_ftbl
   248 00000128 E84010                  		call	input_type_function
   249 0000012B BA[8C0C]                		mov	dx,beep1
   250 0000012E E8E40D                  		call	write_on_screen
   251 00000131 EBDF                    		jmp	short create_dosp
   252                                  cdosp1:
   253 00000133 C706[8600]0000          		mov	word [start_cyl],0
   254 00000139 A1[9704]                		mov	ax,[totalcylinders]
   255 0000013C A3[8400]                		mov	[cylinders],ax
   256 0000013F C606[6400]80            		mov	byte [p_status],80h
   257 00000144 EB59                    		jmp	short cdosp4
   258                                  cdosp2:
   259 00000146 E83502                  		call	display_partition_table
   260 00000149 B104                    		mov	cl,4
   261 0000014B E8E102                  		call	find_first_partition
   262 0000014E 736B                    		jnc	short cdosp7
   263 00000150 C606[6400]00            		mov	byte [p_status],0
   264 00000155 E82805                  		call	get_max_available_space
   265 00000158 833E[8000]00            		cmp	word [max_avl_cylinders],0
   266 0000015D 745C                    		je	short cdosp7
   267 0000015F BA[3C0B]                		mov	dx,maxavlspace_msg
   268 00000162 E8B00D                  		call	write_on_screen
   269                                  
   270                                  ;       |00000000001111111111222222222233333333334444444444| CREATE MENU     ;
   271                                  ;       |01234567890123456789012345678901234567890123456789|                 ;
   272                                  ;     ------------------------------------------------------                 ;
   273                                  ;     00|                                                  |                 ;
   274                                  ;     01|                                                  |                 ;
   275                                  ;     02|                                                  |                 ;
   276                                  ;     03|                                                  |                 ;
   277                                  ;     04|Create DOS partition                              |                 ;
   278                                  ;     05|                                                  |                 ;
   279                                  ;     06|Current Fixed Disk Drive: 1                       |                 ;
   280                                  ;     07|                                                  |                 ;
   281                                  ;     08|                                                  |                 ;
   282                                  ;     09|No partitions defined.				   |                 ;
   283                                  ;     10|                                                  |                 ;
   284                                  ;     11|                                                  |                 ;
   285                                  ;     12|                                                  |                 ;
   286                                  ;     13|                                                  |                 ;
   287                                  ;     14|Total disk space is    64 cylinders               |                 ;
   288                                  ;     15|Maximum available space is    64                  | maxavlspace_msg ;
   289                                  ;     16|cylinders at cylinder     0                       |                 ;
   290                                  ;     17|                                                  |                 ;
   291                                  ;     18|Enter partition size............: [  64]          | enterpsize_msg  ;
   292                                  ;     19|                                                  |                 ;
   293                                  ;     20|                                                  |                 ;
   294                                  ;     21|                                                  |                 ;
   295                                  ;     22|                                                  |                 ;
   296                                  ;     23|                                                  |                 ;
   297                                  ;     24|Press Esc to return to FDISK Options              |                 ;
   298                                  ;     ------------------------------------------------------                 ;
   299                                  
   300                                  cdosp3:
   301 00000165 BA[790B]                		mov	dx,enterpsize_msg
   302 00000168 E8AA0D                  		call	write_on_screen
   303 0000016B A1[8000]                		mov	ax,[max_avl_cylinders]
   304 0000016E B104                    		mov	cl,4
   305 00000170 E8BF0E                  		call	get_and_write_number
   306 00000173 7243                    		jc	short cdosp6
   307 00000175 09C0                    		or	ax,ax
   308 00000177 744B                    		jz	short cdosp8
   309 00000179 A3[8400]                		mov	[cylinders],ax
   310 0000017C 3DFF03                  		cmp	ax,1023
   311 0000017F 7743                    		ja	short cdosp8
   312 00000181 BA[A70B]                		mov	dx,entstartcyl_msg
   313 00000184 E88E0D                  		call	write_on_screen
   314 00000187 A1[8200]                		mov	ax,[next_start_cylinder]
   315 0000018A B104                    		mov	cl,4
   316 0000018C E8A30E                  		call	get_and_write_number
   317 0000018F 7227                    		jc	short cdosp6
   318 00000191 A3[8600]                		mov	[start_cyl],ax
   319 00000194 3DFF03                  		cmp	ax,1023
   320 00000197 7733                    		ja	short cdosp9
   321 00000199 BA[820C]                		mov	dx,blank34193919
   322 0000019C E8760D                  		call	write_on_screen
   323                                  cdosp4:
   324 0000019F E83200                  		call	set_primary_dos_partion
   325 000001A2 E81F05                  		call	prepare_pt_entry
   326 000001A5 7225                    		jc	short cdosp9
   327 000001A7 E8A803                  		call	create_primary_dos_partition
   328 000001AA E84A03                  		call	write_mbr
   329 000001AD C606[7F00]01            		mov	byte [wait_for_input],1
   330 000001B2 E8C901                  		call	display_partition_table
   331                                  cdosp5:
   332 000001B5 E99102                  		jmp	redo1
   333                                  cdosp6:
   334 000001B8 E9E7FE                  		jmp	start_screen
   335                                  cdosp7:
   336 000001BB BA[0F0C]                		mov	dx,noptspace_msg
   337 000001BE E8540D                  		call	write_on_screen
   338 000001C1 E98502                  		jmp	redo1
   339                                  cdosp8:
   340 000001C4 BA[E30B]                		mov	dx,zerocyl_msg
   341 000001C7 E84B0D                  		call	write_on_screen
   342 000001CA EB99                    		jmp	short cdosp3
   343                                  cdosp9:
   344 000001CC BA[2F0C]                		mov	dx,nocylspace_msg
   345 000001CF E8430D                  		call	write_on_screen
   346 000001D2 EB91                    		jmp	short cdosp3
   347                                  
   348                                  ; ----------------------------------------------------------------------------
   349                                  
   350                                  set_primary_dos_partion: ; Set partition tbl parameters for new DOS partition
   351 000001D4 C606[6500]00            		mov	byte [start_head],0
   352 000001D9 A1[8600]                		mov	ax,[start_cyl]
   353 000001DC D0CC                    		ror	ah,1
   354 000001DE D0CC                    		ror	ah,1
   355 000001E0 80E4C0                  		and	ah,0C0h
   356 000001E3 80CC01                  		or	ah,1
   357 000001E6 8826[6600]              		mov	byte [start_cyl_sec],ah
   358 000001EA A2[6700]                		mov	byte [start_cyl_sec+1],al
   359 000001ED A0[7A00]                		mov	al,[file_system]
   360 000001F0 A2[6800]                		mov	[partition_type],al
   361 000001F3 A0[9604]                		mov	al,[heads]
   362 000001F6 A2[6900]                		mov	[end_head],al
   363 000001F9 A1[8600]                		mov	ax,[start_cyl]
   364 000001FC 0306[8400]              		add	ax,[cylinders]
   365 00000200 48                      		dec	ax
   366 00000201 D0CC                    		ror	ah,1
   367 00000203 D0CC                    		ror	ah,1
   368 00000205 80E4C0                  		and	ah,0C0h
   369 00000208 0A26[9904]              		or	ah,[sectors]
   370 0000020C 8826[6A00]              		mov	byte [end_cyl_sec], ah
   371 00000210 A2[6B00]                		mov	byte [end_cyl_sec+1],al
   372 00000213 C3                      		retn
   373                                  
   374                                  ; ----------------------------------------------------------------------------
   375                                  
   376 00000214 59                      input_yn_ftbl:	db	'Y'  ; Yes/No answer to the question for create menu
   377 00000215 [3301]                  		dw	cdosp1
   378 00000217 79                      		db	'y'
   379 00000218 [3301]                  		dw	cdosp1
   380 0000021A 4E                      		db	'N'
   381 0000021B [4601]                  		dw	cdosp2
   382 0000021D 6E                      		db	'n'
   383 0000021E [4601]                  		dw	cdosp2
   384 00000220 1B                      		db	1Bh ; ESCape (27)  ; Cancel, Return to main menu
   385 00000221 [A200]                  		dw	start_screen
   386 00000223 00                      		db	0
   387                                  
   388                                  ; ----------------------------------------------------------------------------
   389                                  
   390                                  op_chg_activep:		; Change Active Partition
   391                                  
   392                                  ;       |00000000001111111111222222222233333333334444444444| CHG ACTIVE PART ;
   393                                  ;       |01234567890123456789012345678901234567890123456789|                 ;
   394                                  ;     ------------------------------------------------------                 ;
   395                                  ;     00|                                                  | chgactpart_msg  ;
   396                                  ;     01|                                                  |                 ;
   397                                  ;     02|                                                  |                 ;
   398                                  ;     03|                                                  |                 ;
   399                                  ;     04|Change Active Partition                           |  		     ;
   400                                  ;     05|                                                  |                 ;
   401                                  ;     06|Current Fixed Disk Drive: 1                       |                 ;
   402                                  ;     07|                                                  |                 ;
   403                                  ;     08|                                                  |                 ;
   404                                  ;     09|Partition   Status   Type   Start   End   Size    | PTABLEHEADER    ;
   405                                  ;     10|    1          A     DOS        0    63     64    | DOSPTABLEROW    ;
   406                                  ;     11|                                                  |                 ;
   407                                  ;     12|                                                  |                 ;
   408                                  ;     13|                                                  |                 ;
   409                                  ;     14|Total disk space is    64 cylinders               |                 ;
   410                                  ;     15|                                                  |                 ;
   411                                  ;     16|                                                  |                 ;
   412                                  ;     17|                                                  |                 ;
   413                                  ;     18|Enter the number of the partition you want        | entptomkact_msg ;
   414                                  ;     19|to make active..................: [_]             |                 ;
   415                                  ;     20|                                                  |                 ;
   416                                  ;     21|                                                  |                 ;
   417                                  ;     22|                                                  |                 ;
   418                                  ;     23|                                                  |                 ;
   419                                  ;     24|                                                  |                 ;
   420                                  ;     ------------------------------------------------------                 ;
   421                                  
   422 00000224 BA[8E0C]                		mov	dx,chgactpart_msg
   423 00000227 E8EB0C                  		call	write_on_screen
   424 0000022A E85101                  		call	display_partition_table
   425 0000022D B102                    		mov	cl,2
   426 0000022F E8FD01                  		call	find_first_partition
   427 00000232 7312                    		jnc	short chg_ap2
   428 00000234 B101                    		mov	cl,1
   429 00000236 E8F601                  		call	find_first_partition
   430 00000239 7209                    		jc	short chg_ap1
   431 0000023B 803E[6400]80            		cmp	byte [p_status],80h
   432 00000240 7504                    		jne	short chg_ap2
   433 00000242 EB7D                    		jmp	short chg_ap8
   434                                  chg_ap1:
   435 00000244 EB72                    		jmp	short chg_ap7
   436                                  chg_ap2:
   437 00000246 E8B101                  		call	dos_partitions
   438 00000249 7405                    		jz	short chg_ap3
   439 0000024B C606[7B00]01            		mov	byte [cpartition_number],1
   440                                  chg_ap3:
   441 00000250 BA[B00C]                		mov	dx,entptomkact_msg
   442 00000253 E8BF0C                  		call	write_on_screen
   443 00000256 A0[7B00]                		mov	al,[cpartition_number]
   444 00000259 30E4                    		xor	ah,ah
   445 0000025B B101                    		mov	cl,1
   446 0000025D E8D20D                  		call	get_and_write_number
   447 00000260 7268                    		jc	short chg_ap9
   448 00000262 A2[8800]                		mov	[active_part_input],al
   449 00000265 08C0                    		or	al,al
   450 00000267 7442                    		jz	short chg_ap6
   451 00000269 88C1                    		mov	cl,al
   452 0000026B E8C101                  		call	find_first_partition
   453 0000026E 723B                    		jc	short chg_ap6
   454 00000270 C606[7C00]00            		mov	byte [partition],0
   455                                  chg_ap4:
   456 00000275 FE06[7C00]              		inc	byte [partition]
   457 00000279 E8A302                  		call	get_partition_params
   458 0000027C 720A                    		jc	short chg_ap5
   459 0000027E C606[6400]00            		mov	byte [p_status],0
   460 00000283 E8FC02                  		call	move_partition_params
   461 00000286 E2ED                    		loop	chg_ap4
   462                                  chg_ap5:
   463 00000288 8A0E[8800]              		mov	cl,[active_part_input]
   464 0000028C E8A001                  		call	find_first_partition
   465 0000028F C606[6400]80            		mov	byte [p_status],80h
   466 00000294 E8EB02                  		call	move_partition_params
   467 00000297 E85D02                  		call	write_mbr
   468 0000029A 8006[8800]30            		add	byte [active_part_input],'0'
   469 0000029F BA[310D]                		mov	dx,madeactive_msg
   470 000002A2 E8700C                  		call	write_on_screen
   471 000002A5 E8D600                  		call	display_partition_table
   472 000002A8 E99E01                  		jmp	redo1
   473                                  chg_ap6:
   474 000002AB 8006[8800]30            		add	byte [active_part_input],'0'
   475 000002B0 BA[070D]                		mov	dx,isnotchoice_msg
   476 000002B3 E85F0C                  		call	write_on_screen
   477 000002B6 EB8E                    		jmp	short chg_ap2
   478                                  chg_ap7:
   479 000002B8 BA[A20D]                		mov	dx,noptoactive_msg
   480 000002BB E8570C                  		call	write_on_screen
   481 000002BE E98801                  		jmp	redo1
   482                                  chg_ap8:			; "Partition # is already active."
   483 000002C1 BA[570D]                		mov	dx,alrdyactive_msg
   484 000002C4 E84E0C                  		call	write_on_screen
   485 000002C7 E97F01                  		jmp	redo1
   486                                  chg_ap9:
   487 000002CA E9D5FD                  		jmp	start_screen
   488                                  
   489                                  ; ----------------------------------------------------------------------------
   490                                  
   491                                  op_delete_dosp:		; Delete DOS Partition
   492                                  
   493                                  ;       |00000000001111111111222222222233333333334444444444| DELETE MENU     ;
   494                                  ;       |01234567890123456789012345678901234567890123456789|                 ;
   495                                  ;     ------------------------------------------------------                 ;
   496                                  ;     00|                                                  | deldp_msg       ;
   497                                  ;     01|                                                  |                 ;
   498                                  ;     02|                                                  |                 ;
   499                                  ;     03|                                                  |                 ;
   500                                  ;     04|Delete DOS partition                              |  		     ;
   501                                  ;     05|                                                  |                 ;
   502                                  ;     06|Current Fixed Disk Drive: 1                       |                 ;
   503                                  ;     07|                                                  |                 ;
   504                                  ;     08|                                                  |                 ;
   505                                  ;     09|Partition   Status   Type   Start   End   Size    | PTABLEHEADER    ;
   506                                  ;     10|    1          A     DOS        0    63     64    | DOSPTABLEROW    ;
   507                                  ;     11|                                                  |                 ;
   508                                  ;     12|                                                  |                 ;
   509                                  ;     13|                                                  |                 ;
   510                                  ;     14|Total disk space is    64 cylinders               |                 ;
   511                                  ;     15|The current active partition is 1                 |                 ;
   512                                  ;     16|                                                  |                 ;
   513                                  ;     17|                                                  |                 ;
   514                                  ;     18|Warning!  Data in the DOS partition               | deldp_warn_msg  ;
   515                                  ;     19|could be lost.  Do you wish to                    |                 ;
   516                                  ;     20|continue...................................? [N]  |                 ;
   517                                  ;     21|                                                  |                 ;
   518                                  ;     22|                                                  |                 ;
   519                                  ;     23|                                                  |                 ;
   520                                  ;     24|Press Esc to return to FDISK Options              |                 ;
   521                                  ;     ------------------------------------------------------                 ;
   522                                  
   523 000002CD BA[C30D]                		mov	dx,deldp_msg
   524 000002D0 E8420C                  		call	write_on_screen
   525 000002D3 E8A800                  		call	display_partition_table
   526 000002D6 E82101                  		call	dos_partitions
   527 000002D9 7408                    		jz	short deldosp1
   528 000002DB BA[8C0E]                		mov	dx,no_dosp_del_msg
   529 000002DE E8340C                  		call	write_on_screen
   530 000002E1 EB5F                    		jmp	short deldosp8
   531                                  deldosp1:
   532 000002E3 BA[0B0E]                		mov	dx,deldp_warn_msg
   533 000002E6 E82C0C                  		call	write_on_screen
   534                                  deldosp2:
   535 000002E9 8B16[870E]              		mov	dx,[delanswer_cpos]
   536                                  deldosp3:
   537 000002ED E8270F                  		call	set_cursor_position
   538 000002F0 A0[890E]                		mov	al,[_no_]
   539 000002F3 E8000D                  		call	select_option_number
   540 000002F6 BB[0403]                		mov	bx,deldosp_yn_tbl
   541 000002F9 E86F0E                  		call	input_type_function
   542 000002FC BA[8A0E]                		mov	dx,beep2
   543 000002FF E8130C                  		call	write_on_screen
   544 00000302 EBE5                    		jmp	short deldosp2
   545                                  
   546                                  ; ----------------------------------------------------------------------------
   547                                  
   548 00000304 59                      deldosp_yn_tbl:	db	'Y' ; Yes/No answer to the question for delete menu	
   549 00000305 [1403]                  		dw	deldosp_yes
   550 00000307 79                      		db	'y'
   551 00000308 [1403]                  		dw	deldosp_yes
   552 0000030A 4E                      		db	'N'
   553 0000030B [A200]                  		dw	start_screen
   554 0000030D 6E                      		db	'n'
   555 0000030E [A200]                  		dw	start_screen
   556 00000310 1B                      		db	1Bh ; ESCape	; Cancel, Return to main menu
   557 00000311 [A200]                  		dw	start_screen
   558 00000313 00                      		db	0
   559                                  
   560                                  deldosp_yes:
   561 00000314 C606[7C00]01            		mov	byte [partition],1
   562                                  deldosp4:
   563 00000319 E80302                  		call	get_partition_params
   564 0000031C 7219                    		jc	short deldosp7
   565 0000031E A0[7A00]                		mov	al,[file_system]
   566 00000321 3A06[6800]              		cmp	al,[partition_type]
   567 00000325 7407                    		je	short deldosp5
   568 00000327 803E[6800]04            		cmp	byte [partition_type],4
   569 0000032C 7503                    		jne	short deldosp6
   570                                  deldosp5:
   571 0000032E E85F02                  		call	delete_pte
   572                                  deldosp6:
   573 00000331 FE06[7C00]              		inc	byte [partition]
   574 00000335 EBE2                    		jmp	short deldosp4
   575                                  deldosp7:
   576 00000337 C606[7F00]01            		mov	byte [wait_for_input],1
   577 0000033C E8B801                  		call	write_mbr
   578 0000033F E83C00                  		call	display_partition_table
   579                                  deldosp8:
   580 00000342 E90401                  		jmp	redo1
   581                                  
   582                                  ; ----------------------------------------------------------------------------
   583                                  
   584                                  op_display_pt:		; Display Partition Table/Data
   585 00000345 BA[D108]                		mov	dx,DISPLAYPTPAGE
   586 00000348 E8CA0B                  		call	write_on_screen
   587 0000034B E83000                  		call	display_partition_table
   588 0000034E E9F800                  		jmp	redo1
   589                                  
   590                                  ; ----------------------------------------------------------------------------
   591                                  
   592                                  op_sel_nxt_disk:
   593 00000351 803E[9504]01            		cmp	byte [harddisks],1
   594 00000356 7503                    		jne	short snxt1
   595 00000358 E960FD                  		jmp	so2
   596                                  snxt1:
   597 0000035B FE06[7D00]              		inc	byte [drive]
   598 0000035F FE06[7E00]              		inc	byte [disk_number]
   599 00000363 A0[7D00]                		mov	al,[drive]
   600 00000366 247F                    		and	al,7Fh
   601 00000368 3A06[9504]              		cmp	al,[harddisks]
   602 0000036C 720A                    		jb	short snxt2
   603 0000036E C606[7D00]80            		mov	byte [drive],80h
   604 00000373 C606[7E00]31            		mov	byte [disk_number],'1'
   605                                  snxt2:
   606 00000378 E85101                  		call	read_mbr
   607 0000037B E924FD                  		jmp	start_screen
   608                                  
   609                                  ; ----------------------------------------------------------------------------
   610                                  
   611                                  display_partition_table: 	; Display Partition Data
   612 0000037E E81F02                  		call	check_set_pt_order
   613 00000381 E8DD00                  		call	get_active_partition
   614 00000384 8B1E[6200]              		mov	bx,[buffer]
   615 00000388 81C3CA01                		add	bx,1CAh ; 1BEh + 12
   616 0000038C B90400                  		mov	cx,4
   617 0000038F 31C0                    		xor	ax,ax
   618                                  dpt1:
   619 00000391 0B07                    		or	ax,[bx]
   620 00000393 0B4702                  		or	ax,[bx+2]
   621 00000396 83C310                  		add	bx,16
   622 00000399 E2F6                    		loop	dpt1
   623 0000039B 09C0                    		or	ax,ax
   624 0000039D 7508                    		jnz	short dpt2
   625 0000039F BA[460A]                		mov	dx,nopartdef_msg
   626 000003A2 E8700B                  		call	write_on_screen
   627 000003A5 EB3F                    		jmp	short dpt6
   628                                  dpt2:
   629 000003A7 BA[9709]                		mov	dx,PTABLEHEADER
   630 000003AA E8680B                  		call	write_on_screen
   631 000003AD C606[7B00]31            		mov	byte [cpartition_number],'1'
   632 000003B2 C606[7C00]01            		mov	byte [partition], 1
   633                                  dpt3:
   634 000003B7 E86501                  		call	get_partition_params
   635 000003BA 722A                    		jc	short dpt6
   636 000003BC A1[7000]                		mov	ax,[sectors_lba_lw]
   637 000003BF 0B06[7200]              		or	ax,[sectors_lba_hw]
   638 000003C3 741B                    		jz	short dpt5
   639 000003C5 BA[D609]                		mov	dx,DOSPTABLEROW
   640 000003C8 803E[6800]01            		cmp	byte [partition_type],1
   641 000003CD 740A                    		je	short dpt4
   642 000003CF 803E[6800]04            		cmp	byte [partition_type],4
   643 000003D4 7403                    		je	short dpt4
   644 000003D6 BA[0E0A]                		mov	dx,NONDOSPTABLEROW
   645                                  dpt4:
   646 000003D9 E8390B                  		call	write_on_screen
   647 000003DC FE06[7B00]              		inc	byte [cpartition_number]
   648                                  dpt5:
   649 000003E0 FE06[7C00]              		inc	byte [partition]
   650 000003E4 EBD1                    		jmp	short dpt3
   651                                  dpt6:
   652 000003E6 BA[2209]                		mov	dx,TOTALDISKSIZE
   653 000003E9 E8290B                  		call	write_on_screen
   654 000003EC 803E[8900]FF            		cmp	byte [active_partition],0FFh  ; -1
   655 000003F1 7406                    		je	short dpt7
   656 000003F3 BA[4709]                		mov	dx,CURACTIVEPART
   657 000003F6 E81C0B                  		call	write_on_screen
   658                                  dpt7:
   659 000003F9 C3                      		retn
   660                                  
   661                                  ; ----------------------------------------------------------------------------
   662                                  
   663                                  dos_partitions:  ; Check for a DOS partition is present or not
   664 000003FA C606[7B00]01            		mov	byte [cpartition_number],1
   665 000003FF C606[7C00]01            		mov	byte [partition],1
   666                                  dp1:
   667 00000404 E81801                  		call	get_partition_params
   668 00000407 7221                    		jc	short dp3
   669 00000409 833E[7000]00            		cmp	word [sectors_lba_lw],0
   670 0000040E 7414                    		je	short dp2
   671 00000410 A0[7A00]                		mov	al,[file_system]
   672 00000413 3A06[6800]              		cmp	al,[partition_type]
   673 00000417 7415                    		je	short dp4
   674 00000419 803E[6800]04            		cmp	byte [partition_type],4
   675 0000041E 740E                    		je	short dp4
   676 00000420 FE06[7B00]              		inc	byte [cpartition_number]
   677                                  dp2:
   678 00000424 FE06[7C00]              		inc	byte [partition]
   679 00000428 EBDA                    		jmp	short dp1
   680                                  dp3:
   681 0000042A 30C0                    		xor	al, al
   682 0000042C FEC0                    		inc	al
   683                                  dp4:
   684 0000042E C3                      		retn
   685                                  
   686                                  ; ----------------------------------------------------------------------------
   687                                  
   688                                  find_first_partition:	; Find first valid/existing partition 
   689                                  			; (CL = start partition number/index in PT for search)
   690 0000042F 30ED                    		xor	ch,ch
   691 00000431 C606[7C00]00            		mov	byte [partition],0
   692                                  ffp1:
   693 00000436 FE06[7C00]              		inc	byte [partition]
   694 0000043A E8E200                  		call	get_partition_params
   695 0000043D 7209                    		jc	short ffp2
   696 0000043F 833E[7000]00            		cmp	word [sectors_lba_lw],0
   697 00000444 74F0                    		je	short ffp1
   698 00000446 E2EE                    		loop	ffp1
   699                                  		;clc		 ; cf = 0 -> partition index in [partition] 
   700                                  ffp2:				 ; cf = 1 -> there is not a valid partition!
   701 00000448 C3                      		retn
   702                                  
   703                                  ; ----------------------------------------------------------------------------
   704                                  
   705                                  redo1:		; Return to main menu
   706 00000449 BA[0F0F]                		mov	dx,finalcpos	; Final cursor position for getchar
   707 0000044C E8C60A                  		call	write_on_screen
   708                                  redo2:
   709 0000044F E8140D                  		call	getchar		; Get a character from keyboard input
   710 00000452 3C1B                    		cmp	al,1Bh ; ESC	; Cancel/ESCape key
   711 00000454 7503                    		jne	short redo3
   712 00000456 E949FC                  		jmp	start_screen
   713                                  redo3:
   714 00000459 BA[130F]                		mov	dx,beep4	; beep sound (wtty with al=07h)
   715 0000045C E8B60A                  		call	write_on_screen
   716 0000045F EBEE                    		jmp	short redo2
   717                                  
   718                                  ; ----------------------------------------------------------------------------
   719                                  
   720                                  get_active_partition:	; Get (present) active partititon number (as '1'..'4')
   721 00000461 C606[7C00]00            		mov	byte [partition],0
   722 00000466 C606[7B00]31            		mov	byte [cpartition_number],'1'
   723                                  gapart1:
   724 0000046B FE06[7C00]              		inc	byte [partition]
   725 0000046F E8AD00                  		call	get_partition_params
   726 00000472 721B                    		jc	short gapart3
   727 00000474 833E[7000]00            		cmp	word [sectors_lba_lw],0
   728 00000479 74F0                    		je	short gapart1
   729 0000047B 803E[6400]80            		cmp	byte [p_status],80h
   730 00000480 7406                    		je	short gapart2
   731 00000482 FE06[7B00]              		inc	byte [cpartition_number]
   732 00000486 EBE3                    		jmp	short gapart1
   733                                  gapart2:
   734 00000488 A0[7B00]                		mov	al,[cpartition_number]
   735 0000048B A2[8900]                		mov	[active_partition],al
   736                                  		;clc
   737 0000048E C3                      		retn
   738                                  gapart3:
   739 0000048F C606[8900]FF            		mov	byte [active_partition],0FFh ; -1 ; not found !
   740                                  		;stc
   741 00000494 C3                      		retn
   742                                  
   743                                  ; ----------------------------------------------------------------------------
   744                                  
   745 00000495 00                      harddisks:	db	0
   746 00000496 00                      heads:		db	0
   747 00000497 0000                    totalcylinders:	dw	0
   748 00000499 00                      sectors:	db	0
   749 0000049A 0000                    cyl_sectors:	dw	0
   750                                  
   751                                  ; ----------------------------------------------------------------------------
   752                                  
   753                                  get_harddisk_parameters: ; Get disk/CHS parameters as base of FDISK functions
   754 0000049C B280                    		mov	dl,80h
   755 0000049E B408                    		mov	ah,8
   756 000004A0 CD13                    		int	13h	; DISK - DISK -	GET CURRENT DRIVE PARAMETERS
   757                                  				;		(XT,AT,XT286,CONV,PS)
   758                                  				; DL = drive number
   759                                  				; Return:
   760                                  				;    	CF set on error,
   761                                  				;	AH = status code
   762                                  				;	BL = drive type
   763                                  				;	CX = maximum value for cylinder&sector 
   764                                  				; 	DL = number of consecutive drives
   765                                  				; 	DH = maximum value for head number
   766                                  				;	ES:DI -> drive parameter
   767 000004A2 7227                    		jc	short ghdp_retn
   768 000004A4 8816[9504]              		mov	[harddisks],dl
   769 000004A8 8836[9604]              		mov	[heads],dh
   770 000004AC 890E[9A04]              		mov	[cyl_sectors],cx
   771 000004B0 51                      		push	cx
   772 000004B1 80E13F                  		and	cl,3Fh
   773 000004B4 880E[9904]              		mov	[sectors],cl
   774 000004B8 59                      		pop	cx
   775 000004B9 86E9                    		xchg	ch,cl
   776 000004BB D0C5                    		rol	ch,1
   777 000004BD D0C5                    		rol	ch,1
   778 000004BF 81E1FF03                		and	cx,3FFh
   779 000004C3 41                      		inc	cx
   780 000004C4 890E[9704]              		mov	[totalcylinders],cx
   781                                  		;mov	al,[harddisks]
   782                                  		;cmp	al,1
   783 000004C8 80FA01                  		cmp	dl,1
   784                                  ghdp_retn:
   785 000004CB C3                      		retn
   786                                  
   787                                  ; ----------------------------------------------------------------------------
   788                                  
   789                                  read_mbr:	; Read Master Boot Record/Sector (C=0,H=1,S=1)
   790 000004CC B402                    		mov	ah,2
   791 000004CE B001                    		mov	al,1
   792 000004D0 B90100                  		mov	cx,1
   793 000004D3 B600                    		mov	dh,0
   794 000004D5 8A16[7D00]              		mov	dl,[drive]
   795 000004D9 0E                      		push	cs
   796 000004DA 07                      		pop	es
   797 000004DB 8B1E[6200]              		mov	bx,[buffer]  ; Master Boot sector buffer address
   798 000004DF CD13                    		int	13h	; DISK - READ SECTORS INTO MEMORY
   799                                  				;    AL = number of sectors to read, 
   800                                  				;    CH = track, CL = sector
   801                                  				;    DH = head, DL = drive,
   802                                  				;    ES:BX -> buffer to fill
   803                                  				; Return: 
   804                                  				;    CF set on error,
   805                                  				;    AH = status,
   806                                  				;    AL = number of sectors read
   807 000004E1 8B1E[6200]              		mov	bx,[buffer]
   808 000004E5 81BFFE0155AA            		cmp	word [bx+510],0AA55h
   809 000004EB 7409                    		je	short read_mbr_retn
   810 000004ED 89DF                    		mov	di,bx
   811 000004EF B90002                  		mov	cx,512
   812 000004F2 30C0                    		xor	al,al
   813 000004F4 F3AA                    		rep stosb
   814                                  read_mbr_retn:
   815 000004F6 C3                      		retn
   816                                  
   817                                  ; ----------------------------------------------------------------------------
   818                                  
   819                                  write_mbr:	; Write Master Boot Record/Sector (C=0,H=1,S=1)
   820                                  		; (Master Boot sector code will be restored by FDISK utility)
   821                                  
   822 000004F7 8B3E[6200]              		mov	di,[buffer]
   823 000004FB C785FE0155AA            		mov	word [di+510],0AA55h
   824                                  		;mov	si,[MBR_ADDR] ; FDISK Master Boot sector code address
   825 00000501 BE[1E12]                		mov	si,MBR
   826 00000504 B9BE01                  		mov	cx,1BEh ; Move MBR code (till Partition Table offset)
   827 00000507 F3A4                    		rep movsb
   828 00000509 B403                    		mov	ah,3
   829 0000050B B001                    		mov	al,1
   830 0000050D B90100                  		mov	cx,1
   831 00000510 B600                    		mov	dh,0
   832 00000512 8A16[7D00]              		mov	dl,[drive]
   833 00000516 0E                      		push	cs
   834 00000517 07                      		pop	es
   835 00000518 8B1E[6200]              		mov	bx,[buffer]
   836 0000051C CD13                    		int	13h	; DISK - WRITE SECTORS FROM MEMORY
   837                                  				;    AL = number of sectors to write,
   838                                  				;    CH = track, CL = sector
   839                                  				;    DH = head, DL = drive,
   840                                  				;    ES:BX -> buffer
   841                                  				; Return:
   842                                  				;    CF set on error,
   843                                  				;    AH = status,
   844                                  				;    AL = number of sectors written
   845 0000051E C3                      		retn
   846                                  
   847                                  ; ----------------------------------------------------------------------------
   848                                  
   849                                  get_partition_params:	; Convert PT entry params to cylinder (word) values
   850                                  			; (PTE index in [Partition] will be used)
   851 0000051F 50                      		push	ax
   852 00000520 53                      		push	bx
   853 00000521 51                      		push	cx
   854 00000522 56                      		push	si
   855 00000523 57                      		push	di
   856 00000524 E8DA00                  		call	locate_partition
   857 00000527 7223                    		jc	short sp_pop_retn
   858 00000529 BF[6400]                		mov	di,current_partition
   859 0000052C B91000                  		mov	cx,16
   860 0000052F F3A4                    		rep movsb
   861 00000531 A1[6600]                		mov	ax,[start_cyl_sec]
   862 00000534 E8C000                  		call	get_cylinder
   863 00000537 A3[7400]                		mov	[pt_start_cyl],ax
   864 0000053A A1[6A00]                		mov	ax,[end_cyl_sec]
   865 0000053D E8B700                  		call	get_cylinder
   866 00000540 A3[7600]                		mov	[pt_end_cyl],ax
   867 00000543 2B06[7400]              		sub	ax,[pt_start_cyl]
   868 00000547 40                      		inc	ax
   869 00000548 A3[7800]                		mov	[pt_cylinders],ax
   870 0000054B F8                      		clc
   871                                  sp_pop_retn:
   872 0000054C 5F                      		pop	di
   873 0000054D 5E                      		pop	si
   874 0000054E 59                      		pop	cx
   875 0000054F 5B                      		pop	bx
   876 00000550 58                      		pop	ax
   877 00000551 C3                      		retn
   878                                  
   879                                  ; ----------------------------------------------------------------------------
   880                                  
   881                                  create_primary_dos_partition: ; Create a DOS partition in Master Boot buffer
   882                                  			      ; (if there is an empty partition table entry)	
   883 00000552 E8C700                  		call	calc_partition_lba
   884 00000555 E80601                  		call	cyl0_sec1_fix ; Move start addr to head 1 if it is 0
   885 00000558 8B1E[6200]              		mov	bx,[buffer]
   886 0000055C 81C3FA01                		add	bx,1FAh  ; 1BEh+48+12 ; Start sector (LBA) address
   887 00000560 B90400                  		mov	cx,4
   888                                  search_empty_pte:
   889 00000563 31C0                    		xor	ax,ax
   890 00000565 0B07                    		or	ax,[bx]
   891 00000567 0B4702                  		or	ax,[bx+2]
   892 0000056A 7407                    		jz	short set_pte
   893 0000056C 83EB10                  		sub	bx,16	; next entry/row (in parition table)
   894 0000056F E2F2                    		loop	search_empty_pte
   895 00000571 F9                      		stc	; there is not an empty entry/row in partition table!		
   896 00000572 C3                      		retn
   897                                  set_pte:
   898 00000573 BE[6400]                		mov	si,current_partition  ; PTE setup address of FDISK
   899 00000576 83EB0C                  		sub	bx,12	; Move BX to beginning of the PTE/row
   900 00000579 89DF                    		mov	di,bx		; Target PTE
   901 0000057B B91000                  		mov	cx,16
   902 0000057E F3A4                    		rep movsb
   903 00000580 F8                      		clc
   904 00000581 C3                      		retn
   905                                  
   906                                  ; ----------------------------------------------------------------------------
   907                                  
   908                                  move_partition_params:	; Move FDISK setup (PTE) to the PTE in MBR buffer
   909                                  			; (Partition/Entry index in [partition] will be used)
   910 00000582 E87C00                  		call	locate_partition
   911 00000585 89F7                    		mov	di,si
   912 00000587 BE[6400]                		mov	si,current_partition
   913 0000058A B91000                  		mov	cx,16
   914 0000058D F3A4                    		rep movsb
   915 0000058F C3                      		retn
   916                                  
   917                                  ; ----------------------------------------------------------------------------
   918                                  
   919                                  delete_pte:		; Delete partition table entry (partition) in MBR buff
   920                                  			; (Partition/Entry index in [partition] will be used)
   921 00000590 E86E00                  		call	locate_partition
   922 00000593 7209                    		jc	short delete_pte_retn
   923 00000595 89F7                    		mov	di,si
   924 00000597 B91000                  		mov	cx,16
   925 0000059A 30C0                    		xor	al,al
   926 0000059C F3AA                    		rep stosb
   927                                  		;clc
   928                                  delete_pte_retn:
   929 0000059E C3                      		retn
   930                                  
   931                                  ; ----------------------------------------------------------------------------
   932                                  
   933 0000059F 00                      pt_swapped:	db	0
   934                                  
   935                                  ; ----------------------------------------------------------------------------
   936                                  
   937                                  check_set_pt_order:	; Re-order partition table entries in CYLINDER order
   938 000005A0 8B36[6200]              		mov	si,[buffer]	; MBR buffer
   939 000005A4 81C6BE01                		add	si,1BEh		; Partition table offet
   940 000005A8 89F7                    		mov	di,si
   941 000005AA 83C710                  		add	di,16		; Next partition/entry
   942 000005AD B90300                  		mov	cx,3
   943 000005B0 C606[9F05]00            		mov	byte [pt_swapped],0 ; Reset swap flag
   944                                  cspto_1:
   945 000005B5 837C0C00                		cmp	word [si+12],0  ; Partition's Start Sector = 0 ?
   946 000005B9 7419                    		je	short cspto_2
   947 000005BB 8B4402                  		mov	ax,[si+2]
   948 000005BE E83600                  		call	get_cylinder
   949 000005C1 89C3                    		mov	bx,ax
   950 000005C3 8B4506                  		mov	ax,[di+6]
   951 000005C6 E82E00                  		call	get_cylinder
   952 000005C9 39D8                    		cmp	ax,bx
   953 000005CB 7307                    		jnb	short cspto_2
   954 000005CD E81300                  		call	swap_partition_rows
   955 000005D0 FE06[9F05]              		inc	byte [pt_swapped] ; PT entries are swapped
   956                                  cspto_2:
   957 000005D4 89FE                    		mov	si,di
   958 000005D6 83C710                  		add	di,16		; Next partition/entry
   959 000005D9 E2DA                    		loop	cspto_1
   960 000005DB 803E[9F05]00            		cmp	byte [pt_swapped],0  ; There is a PTE swap ?
   961 000005E0 75BE                    		jne	short check_set_pt_order ;  Yes, re-check/re-do
   962 000005E2 C3                      		retn			     ; No, it is finished.	
   963                                  
   964                                  ; ----------------------------------------------------------------------------
   965                                  
   966                                  swap_partition_rows:	; Exchange/Swap partition data of requested PT entries
   967                                  			; (PT entries are addressed by SI and DI registers)  
   968 000005E3 51                      		push	cx
   969 000005E4 56                      		push	si
   970 000005E5 57                      		push	di
   971 000005E6 B91000                  		mov	cx,16
   972                                  spr_loop:
   973 000005E9 8A04                    		mov	al,[si]
   974 000005EB 8605                    		xchg	al,[di]
   975 000005ED 8804                    		mov	[si],al
   976 000005EF 46                      		inc	si
   977 000005F0 47                      		inc	di
   978 000005F1 E2F6                    		loop	spr_loop
   979 000005F3 5F                      		pop	di
   980 000005F4 5E                      		pop	si
   981 000005F5 59                      		pop	cx
   982 000005F6 C3                      		retn
   983                                  
   984                                  ; ----------------------------------------------------------------------------
   985                                  
   986                                  get_cylinder:	; Convert partition table Cyl+Sec entry to cylinder value
   987 000005F7 86C4                    		xchg	al,ah	; Low 8 bits of cylinder is in AL
   988 000005F9 D0C4                    		rol	ah,1	; High two bits of cylinder were in bit 7 & 8
   989 000005FB D0C4                    		rol	ah,1	; .. now, they are in bit 0 & 1 of AH
   990 000005FD 25FF03                  		and	ax,3FFh	; Mask cyl value with 1023 (mask AH with 3)
   991 00000600 C3                      		retn
   992                                  
   993                                  ; ----------------------------------------------------------------------------
   994                                  
   995                                  locate_partition: ; Return address of resuested partition table entry
   996                                  		  ; (Partition/Entry index in [partition] will be used)		
   997 00000601 A0[7C00]                		mov	al,[partition]
   998 00000604 3C05                    		cmp	al,5
   999 00000606 F5                      		cmc
  1000 00000607 7212                    		jc	short lpar_retn ; cf = 1, invalid index (> 4) 
  1001 00000609 98                      		cbw
  1002 0000060A FEC8                    		dec	al
  1003 0000060C B104                    		mov	cl,4
  1004 0000060E D2E0                    		shl	al,cl ; *16
  1005 00000610 8B36[6200]              		mov	si,[buffer]	; FDISK MBR buffer address
  1006 00000614 81C6BE01                		add	si,1BEh		; Partition table offset in MBR buff
  1007 00000618 01C6                    		add	si,ax		; + partition table entry offset
  1008 0000061A F8                      		clc	; clear carry flag (this may not be necessary here!?)
  1009                                  			; ((because SI+AX always must/will be less than 64K)) 
  1010                                  lpar_retn:
  1011 0000061B C3                      		retn
  1012                                  
  1013                                  ; ----------------------------------------------------------------------------
  1014                                  
  1015                                  calc_partition_lba: ; Convert CHS values (of current partition) to LBA address
  1016 0000061C A1[6600]                		mov	ax,[start_cyl_sec]
  1017 0000061F E8D5FF                  		call	get_cylinder ; Get normalized/word cylinder value
  1018 00000622 89C3                    		mov	bx,ax
  1019 00000624 A0[9604]                		mov	al,[heads]   ; Heads-1 (< 255) -the last head number-	
  1020 00000627 FEC0                    		inc	al	     ; Number of heads (<=255)	
  1021 00000629 98                      		cbw	; AL -> AX)
  1022 0000062A F7E3                    		mul	bx	     ; AX = Start Track (StartCYLINDER*Heads) 	
  1023 0000062C 8A0E[9904]              		mov	cl,[sectors] ; Sectors per track (<= 63)
  1024 00000630 30ED                    		xor	ch,ch
  1025 00000632 F7E1                    		mul	cx	     ; DX:AX = Start Sector (SPT*StartTRACK)	
  1026 00000634 A3[6C00]                		mov	[start_lba_lw],ax
  1027 00000637 8916[6E00]              		mov	[start_lba_hw],dx
  1028 0000063B A1[6A00]                		mov	ax,[end_cyl_sec]
  1029 0000063E E8B6FF                  		call	get_cylinder
  1030 00000641 29D8                    		sub	ax,bx
  1031 00000643 40                      		inc	ax
  1032 00000644 89C3                    		mov	bx,ax
  1033 00000646 A0[9604]                		mov	al,[heads]   ; Heads-1 (<255) -the last head number-
  1034 00000649 FEC0                    		inc	al	     ; Number of heads (<=255)	  	
  1035 0000064B 98                      		cbw	; AL -> AX
  1036 0000064C F7E3                    		mul	bx	     ; AX = End Track (EndCYLINDER*Heads) 	
  1037 0000064E 8A0E[9904]              		mov	cl,[sectors]
  1038 00000652 30ED                    		xor	ch,ch
  1039 00000654 F7E1                    		mul	cx	     ; DX:AX = End Sector (SPT*EndTRACK)	
  1040 00000656 A3[7000]                		mov	[sectors_lba_lw],ax
  1041 00000659 8916[7200]              		mov	[sectors_lba_hw],dx
  1042 0000065D C3                      		retn
  1043                                  
  1044                                  ; ----------------------------------------------------------------------------
  1045                                  
  1046                                  cyl0_sec1_fix:	; Move start address to cylinder=0, head=1, sector=1 
  1047                                  		;      if start address is 0 (cylinder=0, head=0, sector=1)
  1048 0000065E 833E[6600]01            		cmp	word [start_cyl_sec],1
  1049 00000663 7518                    		jne	short no_start_cyl_fix
  1050 00000665 803E[6500]00            		cmp	byte [start_head],0
  1051 0000066A 7511                    		jne	short no_start_cyl_fix
  1052 0000066C C606[6500]01            		mov	byte [start_head],1
  1053 00000671 A0[9904]                		mov	al,[sectors] ; SPT (Sectors Per Track)
  1054 00000674 98                      		cbw
  1055 00000675 0106[6C00]              		add	[start_lba_lw],ax	; start = start + SPT	
  1056 00000679 2906[7000]              		sub	[sectors_lba_lw],ax	; size = size - SPT
  1057                                  		;   (If SPT=63, start LBA is 63; if SPT=17, start LBA is 17) 
  1058                                  no_start_cyl_fix:
  1059 0000067D C3                      		retn
  1060                                  
  1061                                  ; ----------------------------------------------------------------------------
  1062                                  
  1063 0000067E 0000                    present_end_cylinder:	dw	0
  1064                                  
  1065                                  ; ----------------------------------------------------------------------------
  1066                                  
  1067                                  get_max_available_space: ; Get maximum available space between partitions
  1068                                  			 ;					as cylinders
  1069 00000680 E81DFF                  		call	check_set_pt_order
  1070 00000683 C706[8200]0000          		mov	word [next_start_cylinder],0
  1071 00000689 C706[8000]0000          		mov	word [max_avl_cylinders],0
  1072 0000068F C706[7E06]FFFF          		mov	word [present_end_cylinder],0FFFFh ; -1
  1073 00000695 C606[7C00]00            		mov	byte [partition],0
  1074                                  gmac1:
  1075 0000069A FE06[7C00]              		inc	byte [partition]
  1076 0000069E E87EFE                  		call	get_partition_params
  1077 000006A1 7212                    		jc	short gmac3
  1078 000006A3 A1[7000]                		mov	ax,[sectors_lba_lw]
  1079                                  gmac2:
  1080 000006A6 09C0                    		or	ax, ax
  1081 000006A8 74F0                    		jz	short gmac1
  1082 000006AA A1[6600]                		mov	ax, [start_cyl_sec]
  1083 000006AD E847FF                  		call	get_cylinder
  1084 000006B0 E86D00                  		call	set_present_avl_space ; Calculate space (as cylinders) 
  1085                                  			 ; between current/requested cyl and previous end cyl)									       	
  1086 000006B3 EBE5                    		jmp	short gmac1
  1087                                  gmac3:
  1088 000006B5 A1[9704]                		mov	ax,[totalcylinders]
  1089 000006B8 E86500                  		call	set_present_avl_space 
  1090 000006BB FF0E[8000]              		dec	word [max_avl_cylinders]
  1091 000006BF C3                      		retn
  1092                                  
  1093                                  ; ----------------------------------------------------------------------------
  1094                                  
  1095 000006C0 0000                    start_cylinder:	dw	0
  1096 000006C2 0000                    end_cylinder:	dw	0
  1097                                  		;times 4 db 0
  1098                                  
  1099                                  ; ----------------------------------------------------------------------------
  1100                                  
  1101                                  prepare_pt_entry:
  1102 000006C4 E8D9FE                  		call	check_set_pt_order
  1103 000006C7 C706[7E06]FFFF          		mov	word [present_end_cylinder],0FFFFh ; -1
  1104 000006CD 8B36[6200]              		mov	si,[buffer]
  1105 000006D1 81C6BE01                		add	si,1BEh ; MBR Partition Table offset
  1106 000006D5 B90400                  		mov	cx,4
  1107 000006D8 A1[6600]                		mov	ax,[start_cyl_sec]
  1108 000006DB E819FF                  		call	get_cylinder
  1109 000006DE A3[C006]                		mov	[start_cylinder],ax
  1110 000006E1 A1[6A00]                		mov	ax,[end_cyl_sec]
  1111 000006E4 E810FF                  		call	get_cylinder
  1112 000006E7 A3[C206]                		mov	[end_cylinder],ax
  1113                                  ppte1:
  1114 000006EA 837C0C00                		cmp	word [si+12],0
  1115 000006EE 7415                    		jz	short ppte2	; Empty PTE
  1116 000006F0 8B4402                  		mov	ax,[si+2]
  1117 000006F3 E801FF                  		call	get_cylinder
  1118 000006F6 3B06[C206]              		cmp	ax,[end_cylinder]
  1119 000006FA 7717                    		ja	short ppte3
  1120 000006FC 8B4406                  		mov	ax,[si+6]
  1121 000006FF E8F5FE                  		call	get_cylinder
  1122 00000702 A3[7E06]                		mov	[present_end_cylinder],ax
  1123                                  ppte2:
  1124 00000705 83C610                  		add	si,16
  1125 00000708 E2E0                    		loop	ppte1
  1126 0000070A A1[C206]                		mov	ax,[end_cylinder]
  1127 0000070D 3B06[9704]              		cmp	ax,[totalcylinders]
  1128 00000711 7D0B                    		jge	short ppte_error
  1129                                  ppte3:
  1130 00000713 A1[C006]                		mov	ax,[start_cylinder]
  1131 00000716 3B06[7E06]              		cmp	ax,[present_end_cylinder]
  1132 0000071A 7E02                    		jle	short ppte_error
  1133 0000071C F8                      		clc
  1134 0000071D C3                      		retn
  1135                                  ppte_error:
  1136 0000071E F9                      		stc
  1137 0000071F C3                      		retn
  1138                                  
  1139                                  ; ----------------------------------------------------------------------------
  1140                                  
  1141                                  set_present_avl_space:
  1142                                  		; Calculate available space (in cylinders unit) 
  1143                                  		; between current/requested cylinder and present end cyl)
  1144                                  		; AX = Current/requested cylinder number
  1145                                  		; [present_end_cylinder] = end cylinder of present partition	
  1146 00000720 2B06[7E06]              		sub	ax,[present_end_cylinder]
  1147 00000724 3B06[8000]              		cmp	ax,[max_avl_cylinders] ; Max. available (conseq) cyls
  1148 00000728 760A                    		jbe	short no_set_max_avl_cyl
  1149 0000072A A3[8000]                		mov	[max_avl_cylinders],ax
  1150 0000072D A1[7E06]                		mov	ax,[present_end_cylinder]
  1151 00000730 40                      		inc	ax
  1152 00000731 A3[8200]                		mov	[next_start_cylinder],ax ; Start cylinder of the next
  1153                                  						 ; partition may be just after
  1154                                  						 ; (+1 to) the end cylinder
  1155                                  						 ; of the present parition    
  1156                                  no_set_max_avl_cyl:
  1157 00000734 A1[6A00]                		mov	ax,[end_cyl_sec]
  1158 00000737 E8BDFE                  		call	get_cylinder
  1159 0000073A A3[7E06]                		mov	[present_end_cylinder],ax ; present end cylinder ..
  1160                                  				; (.. will be previous for the next partition)
  1161 0000073D C3                      		retn
  1162                                  
  1163                                  ; ----------------------------------------------------------------------------
  1164                                  
  1165                                  ; FDISK menu data and messages (with menu page format/control characters)
  1166                                  
  1167 0000073E 06                      CLSSET:		db	6
  1168 0000073F 0D                      		db	0Dh
  1169 00000740 0A                      		db	0Ah
  1170 00000741 00                      		db	0
  1171 00000742 0D0A                    NOFDISKPMSG:	db	0Dh,0Ah
  1172 00000744 0A                      		db	0Ah
  1173 00000745 4E6F20666978656420-     		db	'No fixed disks present.',0Dh,0Ah
  1174 0000074E 6469736B7320707265-
  1175 00000757 73656E742E0D0A     
  1176 0000075E 0A00                    		db	0Ah,0
  1177 00000760 05                      FDISKOPMPAGE:	db	5 ; Set Cursor Position
  1178 00000761 00                      		db	0 ; Column 0	
  1179 00000762 04                      		db	4 ; Row 4
  1180 00000763 10                      		db	16
  1181 00000764 13                      		db	19 
  1182 00000765 464449534B204F7074-     		db	'FDISK Options'
  1183 0000076E 696F6E73           
  1184 00000772 14                      		db	20
  1185 00000773 0D                      		db	0Dh
  1186 00000774 0A                      		db	0Ah
  1187 00000775 0A                      		db	0Ah
  1188 00000776 0E                      		db	14
  1189 00000777 [9504]                  		dw	harddisks
  1190 00000779 01                      		db	1
  1191 0000077A 05                      		db	5
  1192 0000077B 00                      		db	0
  1193 0000077C 06                      		db	6
  1194 0000077D 43757272656E742046-     		db	'Current Fixed Disk Drive:'
  1195 00000786 69786564204469736B-
  1196 0000078F 2044726976653A     
  1197 00000796 20                      		db	20h
  1198 00000797 13                      		db	19
  1199 00000798 0B                      		db	11
  1200 00000799 [7E00]                  		dw	disk_number
  1201 0000079B 14                      		db	20
  1202 0000079C 0F                      		db	0Fh
  1203 0000079D 05                      		db	5
  1204 0000079E 00                      		db	0
  1205 0000079F 09                      		db	9
  1206 000007A0 43686F6F7365206F6E-     		db	'Choose one of the following:',0Dh,0Ah
  1207 000007A9 65206F662074686520-
  1208 000007B2 666F6C6C6F77696E67-
  1209 000007BB 3A0D0A             
  1210 000007BE 0A                      		db	0Ah
  1211 000007BF 202020201331142E20-     		db	'    ',13h,'1',14h,'. Create DOS Partition',0Dh,0Ah
  1212 000007C8 43726561746520444F-
  1213 000007D1 532050617274697469-
  1214 000007DA 6F6E0D0A           
  1215 000007DE 202020201332142E20-     		db	'    ',13h,'2',14h,'. Change Active Partition',0Dh,0Ah
  1216 000007E7 4368616E6765204163-
  1217 000007F0 746976652050617274-
  1218 000007F9 6974696F6E0D0A     
  1219 00000800 202020201333142E20-     		db	'    ',13h,'3',14h,'. Delete DOS Partition',0Dh,0Ah
  1220 00000809 44656C65746520444F-
  1221 00000812 532050617274697469-
  1222 0000081B 6F6E0D0A           
  1223 0000081F 202020201334142E20-     		db	'    ',13h,'4',14h,'. Display Partition Data',0Dh,0Ah
  1224 00000828 446973706C61792050-
  1225 00000831 6172746974696F6E20-
  1226 0000083A 446174610D0A       
  1227 00000840 0E                      		db	14
  1228 00000841 [9504]                  		dw	harddisks
  1229 00000843 01                      		db	1
  1230 00000844 202020201335142E20-     		db	'    ',13h,'5',14h,'. Select Next Fixed Disk Drive',0Dh,0Ah
  1231 0000084D 53656C656374204E65-
  1232 00000856 787420466978656420-
  1233 0000085F 4469736B2044726976-
  1234 00000868 650D0A             
  1235 0000086B 0F                      		db	0Fh
  1236 0000086C 05                      		db	5
  1237 0000086D 00                      		db	0
  1238 0000086E 11                      		db	17
  1239 0000086F 456E7465722063686F-     		db	'Enter choice: ',13h,'[ ]',14h
  1240 00000878 6963653A20135B205D-
  1241 00000881 14                 
  1242 00000882 05                      		db	5
  1243 00000883 00                      		db	0
  1244 00000884 18                      		db	24
  1245 00000885 507265737320134573-     		db	'Press ',13h,'Esc',14h,' to return to DOS.',0
  1246 0000088E 631420746F20726574-
  1247 00000897 75726E20746F20444F-
  1248 000008A0 532E00             
  1249 000008A3 05                      WRONGSELECT:	db	5
  1250 000008A4 00                      		db	0
  1251 000008A5 17                      		db	23
  1252 000008A6 0B                      		db	11
  1253 000008A7 [F50F]                  		dw	selected_opnum
  1254 000008A9 0720206973206E6F74-     		db	7,'  is not a choice.  Enter a choice.',0
  1255 000008B2 20612063686F696365-
  1256 000008BB 2E2020456E74657220-
  1257 000008C4 612063686F6963652E-
  1258 000008CD 00                 
  1259 000008CE 31                      def_opnum:	db	'1'
  1260 000008CF 0F11                    opnum_cpos:	dw	110Fh ; Column 17, Row 15
  1261 000008D1 05                      DISPLAYPTPAGE:	db	5
  1262 000008D2 00                      		db	0
  1263 000008D3 04                      		db	4
  1264 000008D4 13446973706C617920-     		db	13h,'Display Partition Information',14h,9,5,0
  1265 000008DD 506172746974696F6E-
  1266 000008E6 20496E666F726D6174-
  1267 000008EF 696F6E14090500     
  1268 000008F6 08                      		db	8
  1269 000008F7 10                      		db	16
  1270 000008F8 05                      		db	5
  1271 000008F9 00                      		db	0
  1272 000008FA 18                      		db	24
  1273 000008FB 507265737320134573-     		db	'Press ',13h,'Esc',14h,' to return to FDISK Options',0
  1274 00000904 631420746F20726574-
  1275 0000090D 75726E20746F204644-
  1276 00000916 49534B204F7074696F-
  1277 0000091F 6E7300             
  1278 00000922 05                      TOTALDISKSIZE:	db	5
  1279 00000923 00                      		db	0
  1280 00000924 0E                      		db	14
  1281 00000925 546F74616C20646973-     		db	'Total disk space is '
  1282 0000092E 6B2073706163652069-
  1283 00000937 7320               
  1284 00000939 04                      		db	4
  1285 0000093A [9704]                  		dw	totalcylinders
  1286 0000093C 2063796C696E646572-     		db	' cylinders'
  1287 00000945 73                 
  1288 00000946 00                      		db	0
  1289 00000947 05                      CURACTIVEPART:	db	5
  1290 00000948 00                      		db	0
  1291 00000949 0F                      		db	15
  1292 0000094A 546865206375727265-     		db	'The current active partition is '
  1293 00000953 6E7420616374697665-
  1294 0000095C 20706172746974696F-
  1295 00000965 6E20697320         
  1296 0000096A 0B                      		db	11
  1297 0000096B [8900]                  		dw	active_partition
  1298 0000096D 05                      		db	5
  1299 0000096E 00                      		db	0
  1300 0000096F 18                      		db	24
  1301 00000970 507265737320134573-     		db	'Press ',13h,'Esc'
  1302 00000979 63                 
  1303 0000097A 14                      		db	14h
  1304 0000097B 20                      		db	20h
  1305 0000097C 746F2072657475726E-     		db	'to return to FDISK Options'
  1306 00000985 20746F20464449534B-
  1307 0000098E 204F7074696F6E73   
  1308 00000996 00                      		db	0
  1309 00000997 05                      PTABLEHEADER:	db	5
  1310 00000998 00                      		db	0
  1311 00000999 09                      		db	9
  1312 0000099A 506172746974696F6E-     		db	'Partition   Status   Type   Start   End   Size'
  1313 000009A3 202020537461747573-
  1314 000009AC 202020547970652020-
  1315 000009B5 205374617274202020-
  1316 000009BE 456E6420202053697A-
  1317 000009C7 65                 
  1318 000009C8 09                      		db	9
  1319 000009C9 0D                      		db	0Dh
  1320 000009CA 0A                      		db	0Ah
  1321 000009CB 09                      		db	9
  1322 000009CC 0A                      		db	0Ah
  1323 000009CD 09                      		db	9
  1324 000009CE 0A                      		db	0Ah
  1325 000009CF 09                      		db	9
  1326 000009D0 0A                      		db	0Ah
  1327 000009D1 09                      		db	9
  1328 000009D2 05                      		db	5
  1329 000009D3 00                      		db	0
  1330 000009D4 0A                      		db	10
  1331 000009D5 00                      		db	0
  1332 000009D6 20<rept>                DOSPTABLEROW:	times 4 db 20h
  1333 000009DA 0B                      		db	11
  1334 000009DB [7B00]                  		dw	cpartition_number
  1335 000009DD 20<rept>                		times 10 db 20h
  1336 000009E7 0C                      		db	12
  1337 000009E8 [6400]                  		dw	current_partition
  1338 000009EA 80                      		db	80h
  1339 000009EB 41                      		db	'A'
  1340 000009EC 0F                      		db	0Fh
  1341 000009ED 0E                      		db	14
  1342 000009EE [6400]                  		dw	current_partition
  1343 000009F0 80                      		db	80h
  1344 000009F1 4E                      		db	'N'
  1345 000009F2 0F                      		db	0Fh
  1346 000009F3 2020202020444F5320-     		db	'     DOS    '
  1347 000009FC 202020             
  1348 000009FF 04                      		db	4
  1349 00000A00 [7400]                  		dw	pt_start_cyl
  1350 00000A02 20                      		db	20h
  1351 00000A03 04                      		db	4
  1352 00000A04 [7600]                  		dw	pt_end_cyl
  1353 00000A06 20                      		db	20h
  1354 00000A07 20                      		db	20h
  1355 00000A08 04                      		db	4
  1356 00000A09 [7800]                  		dw	pt_cylinders
  1357 00000A0B 0D                      		db	0Dh
  1358 00000A0C 0A                      		db	0Ah
  1359 00000A0D 00                      		db	0
  1360 00000A0E 20<rept>                NONDOSPTABLEROW: times 4 db 20h
  1361 00000A12 0B                      		db	11
  1362 00000A13 [7B00]                  		dw	cpartition_number
  1363 00000A15 20<rept>                		times 10 db 20h
  1364 00000A1F 0C                      		db	12
  1365 00000A20 [6400]                  		dw	current_partition
  1366 00000A22 80                      		db	80h
  1367 00000A23 41                      		db	'A'
  1368 00000A24 0F                      		db	0Fh
  1369 00000A25 0E                      		db	14
  1370 00000A26 [6400]                  		dw	current_partition
  1371 00000A28 80                      		db	80h
  1372 00000A29 4E                      		db	'N'
  1373 00000A2A 0F                      		db	0Fh
  1374 00000A2B 2020206E6F6E2D444F-     		db	'   non-DOS  '
  1375 00000A34 532020             
  1376 00000A37 04                      		db	4
  1377 00000A38 [7400]                  		dw	pt_start_cyl
  1378 00000A3A 20                      		db	20h
  1379 00000A3B 04                      		db	4
  1380 00000A3C [7600]                  		dw	pt_end_cyl
  1381 00000A3E 20                      		db	20h
  1382 00000A3F 20                      		db	20h
  1383 00000A40 04                      		db	4
  1384 00000A41 [7800]                  		dw	pt_cylinders
  1385 00000A43 0D                      		db	0Dh
  1386 00000A44 0A                      		db	0Ah
  1387 00000A45 00                      		db	0
  1388 00000A46 05                      nopartdef_msg:	db	5
  1389 00000A47 00                      		db	0
  1390 00000A48 09                      		db	9
  1391 00000A49 4E6F20706172746974-     		db	'No partitions defined.'
  1392 00000A52 696F6E732064656669-
  1393 00000A5B 6E65642E           
  1394 00000A5F 09                      		db	9
  1395 00000A60 0D                      		db	0Dh
  1396 00000A61 0A                      		db	0Ah
  1397 00000A62 09                      		db	9
  1398 00000A63 0A                      		db	0Ah
  1399 00000A64 09                      		db	9
  1400 00000A65 0A                      		db	0Ah
  1401 00000A66 09                      		db	9
  1402 00000A67 0A                      		db	0Ah
  1403 00000A68 09                      		db	9
  1404 00000A69 00                      		db	0
  1405 00000A6A 20                      		db	20h
  1406 00000A6B 05                      createdosp_msg	db	5
  1407 00000A6C 00                      		db	0
  1408 00000A6D 04                      		db	4
  1409 00000A6E 13                      		db	13h
  1410 00000A6F 43726561746520444F-     		db	'Create DOS partition'
  1411 00000A78 532070617274697469-
  1412 00000A81 6F6E               
  1413 00000A83 14                      		db	14h
  1414 00000A84 09                      		db	9
  1415 00000A85 05                      		db	5
  1416 00000A86 00                      		db	0
  1417 00000A87 08                      		db	8
  1418 00000A88 10                      		db	16
  1419 00000A89 00                      		db	0
  1420 00000A8A 20                      		db	20h
  1421 00000A8B 05                      alreadydosp_msg: db	5
  1422 00000A8C 00                      		db	0
  1423 00000A8D 13                      		db	19
  1424 00000A8E 13                      		db	13h
  1425 00000A8F 466978656420646973-     		db	'Fixed disk already has a DOS partition.'
  1426 00000A98 6B20616C7265616479-
  1427 00000AA1 20686173206120444F-
  1428 00000AAA 532070617274697469-
  1429 00000AB3 6F6E2E             
  1430 00000AB6 14                      		db	14h
  1431 00000AB7 00                      		db	0
  1432 00000AB8 05                      empty_pt:	db	5
  1433 00000AB9 00                      		db	0
  1434 00000ABA 09                      		db	9
  1435 00000ABB 446F20796F75207769-     		db	'Do you wish to use the entire fixed',0Dh,0Ah
  1436 00000AC4 736820746F20757365-
  1437 00000ACD 2074686520656E7469-
  1438 00000AD6 72652066697865640D-
  1439 00000ADF 0A                 
  1440 00000AE0 6469736B20666F7220-     		db	'disk for DOS (Y/N).........................'
  1441 00000AE9 444F532028592F4E29-
  1442 00000AF2 2E2E2E2E2E2E2E2E2E-
  1443 00000AFB 2E2E2E2E2E2E2E2E2E-
  1444 00000B04 2E2E2E2E2E2E2E     
  1445 00000B0B 20                      		db	20h
  1446 00000B0C 13                      		db	13h
  1447 00000B0D 5B205D                  		db	'[ ]'
  1448 00000B10 14                      		db	14h
  1449 00000B11 05                      		db	5
  1450 00000B12 00                      		db	0
  1451 00000B13 18                      		db	24
  1452 00000B14 507265737320457363-     		db	'Press Esc to return to FDISK Options'
  1453 00000B1D 20746F207265747572-
  1454 00000B26 6E20746F2046444953-
  1455 00000B2F 4B204F7074696F6E73 
  1456 00000B38 05                      		db	5
  1457 00000B39 2D                      		db	45
  1458 00000B3A 0A                      		db	10
  1459 00000B3B 00                      		db	0
  1460 00000B3C 05                      maxavlspace_msg: db	5
  1461 00000B3D 00                      		db	0
  1462 00000B3E 0F                      		db	15
  1463 00000B3F 4D6178696D756D2061-     		db	'Maximum available space is'
  1464 00000B48 7661696C61626C6520-
  1465 00000B51 7370616365206973   
  1466 00000B59 20                      		db	20h
  1467 00000B5A 04                      		db	4
  1468 00000B5B [8000]                  		dw	max_avl_cylinders
  1469 00000B5D 0D                      		db	0Dh
  1470 00000B5E 0A                      		db	0Ah
  1471 00000B5F 63796C696E64657273-     		db	'cylinders at cylinder'
  1472 00000B68 2061742063796C696E-
  1473 00000B71 646572             
  1474 00000B74 20                      		db	20h
  1475 00000B75 04                      		db	4
  1476 00000B76 [8200]                  		dw	next_start_cylinder
  1477 00000B78 00                      		db	0
  1478 00000B79 05                      enterpsize_msg:	db	5
  1479 00000B7A 00                      		db	0
  1480 00000B7B 12                      		db	12h
  1481 00000B7C 456E74657220706172-     		db	'Enter partition size............: [    ]'
  1482 00000B85 746974696F6E207369-
  1483 00000B8E 7A652E2E2E2E2E2E2E-
  1484 00000B97 2E2E2E2E2E3A205B20-
  1485 00000BA0 2020205D           
  1486 00000BA4 08                      		db	8
  1487 00000BA5 08                      		db	8
  1488 00000BA6 00                      		db	0
  1489 00000BA7 05                      entstartcyl_msg: db	5
  1490 00000BA8 00                      		db	0
  1491 00000BA9 15                      		db	21
  1492 00000BAA 09                      		db	9
  1493 00000BAB 0D                      		db	0Dh
  1494 00000BAC 0A                      		db	0Ah
  1495 00000BAD 09                      		db	9
  1496 00000BAE 05                      		db	5
  1497 00000BAF 22                      		db	34
  1498 00000BB0 12                      		db	18
  1499 00000BB1 20                      		db	20h
  1500 00000BB2 05                      		db	5
  1501 00000BB3 27                      		db	39
  1502 00000BB4 12                      		db	18
  1503 00000BB5 20                      		db	20h
  1504 00000BB6 0D                      		db	0Dh
  1505 00000BB7 0A                      		db	0Ah
  1506 00000BB8 456E74657220737461-     		db	'Enter starting cylinder number..: [    ]'
  1507 00000BC1 7274696E672063796C-
  1508 00000BCA 696E646572206E756D-
  1509 00000BD3 6265722E2E3A205B20-
  1510 00000BDC 2020205D           
  1511 00000BE0 08                      		db	8
  1512 00000BE1 08                      		db	8
  1513 00000BE2 00                      		db	0
  1514 00000BE3 05                      zerocyl_msg:	db	5
  1515 00000BE4 00                      		db	0
  1516 00000BE5 15                      		db	21
  1517 00000BE6 4E6F20737061636520-     		db	'No space for a 0 cylinder partition.'
  1518 00000BEF 666F72206120302063-
  1519 00000BF8 796C696E6465722070-
  1520 00000C01 6172746974696F6E2E 
  1521 00000C0A 09                      		db	9
  1522 00000C0B 0D                      		db	0Dh
  1523 00000C0C 0A                      		db	0Ah
  1524 00000C0D 09                      		db	9
  1525 00000C0E 00                      		db	0
  1526 00000C0F 05                      noptspace_msg:	db	5
  1527 00000C10 00                      		db	0
  1528 00000C11 12                      		db	18
  1529 00000C12 4E6F20737061636520-     		db	'No space for a DOS partition'
  1530 00000C1B 666F72206120444F53-
  1531 00000C24 20706172746974696F-
  1532 00000C2D 6E                 
  1533 00000C2E 00                      		db	0
  1534 00000C2F 05                      nocylspace_msg:	db	5
  1535 00000C30 00                      		db	0
  1536 00000C31 15                      		db	21
  1537 00000C32 4E6F20737061636520-     		db	'No space for a'
  1538 00000C3B 666F722061         
  1539 00000C40 04                      		db	4
  1540 00000C41 [8400]                  		dw	cylinders
  1541 00000C43 2063796C696E646572-     		db	' cylinder partition'
  1542 00000C4C 20706172746974696F-
  1543 00000C55 6E                 
  1544 00000C56 09                      		db	9
  1545 00000C57 0D                      		db	0Dh
  1546 00000C58 0A                      		db	0Ah
  1547 00000C59 61742063796C696E64-     		db	'at cylinder'
  1548 00000C62 6572               
  1549 00000C64 04                      		db	4
  1550 00000C65 [8600]                  		dw	start_cyl
  1551 00000C67 09                      		db	9
  1552 00000C68 00                      		db	0
  1553 00000C69 05                      		db	5
  1554 00000C6A 00                      		db	0
  1555 00000C6B 15                      		db	21
  1556 00000C6C 446F73207061727469-     		db	'Dos partition created'
  1557 00000C75 74696F6E2063726561-
  1558 00000C7E 746564             
  1559 00000C81 00                      		db	0
  1560 00000C82 05                      blank34193919:	db	5
  1561 00000C83 22                      		db	34
  1562 00000C84 13                      		db	19
  1563 00000C85 20                      		db	20h
  1564 00000C86 05                      		db	5
  1565 00000C87 27                      		db	39
  1566 00000C88 13                      		db	19
  1567 00000C89 20                      		db	20h
  1568 00000C8A 00                      		db	0
  1569 00000C8B 59                      _yes_:		db	'Y'
  1570 00000C8C 07                      beep1:		db	7
  1571 00000C8D 00                      		db	0
  1572 00000C8E 05                      chgactpart_msg:	db	5
  1573 00000C8F 00                      		db	0
  1574 00000C90 04                      		db	4
  1575 00000C91 13                      		db	13h
  1576 00000C92 4368616E6765204163-     		db	'Change Active Partition'
  1577 00000C9B 746976652050617274-
  1578 00000CA4 6974696F6E         
  1579 00000CA9 14                      		db	14h
  1580 00000CAA 09                      		db	9
  1581 00000CAB 05                      		db	5
  1582 00000CAC 00                      		db	0
  1583 00000CAD 08                      		db	8
  1584 00000CAE 10                      		db	16
  1585 00000CAF 00                      		db	0
  1586 00000CB0 05                      entptomkact_msg: db	5
  1587 00000CB1 00                      		db	0
  1588 00000CB2 12                      		db	18
  1589 00000CB3 456E74657220746865-     		db	'Enter the number of the partition you want',0Dh,0Ah
  1590 00000CBC 206E756D626572206F-
  1591 00000CC5 662074686520706172-
  1592 00000CCE 746974696F6E20796F-
  1593 00000CD7 752077616E740D0A   
  1594 00000CDF 746F206D616B652061-     		db	'to make active..................: [ ]'
  1595 00000CE8 63746976652E2E2E2E-
  1596 00000CF1 2E2E2E2E2E2E2E2E2E-
  1597 00000CFA 2E2E2E2E2E3A205B20-
  1598 00000D03 5D                 
  1599 00000D04 08                      		db	8
  1600 00000D05 08                      		db	8
  1601 00000D06 00                      		db	0
  1602 00000D07 05                      isnotchoice_msg: db	5
  1603 00000D08 00                      		db	0
  1604 00000D09 16                      		db	22
  1605 00000D0A 0B                      		db	11
  1606 00000D0B [8800]                  		dw	active_part_input
  1607 00000D0D 20206973206E6F7420-     		db	'  is not a choice.'
  1608 00000D16 612063686F6963652E 
  1609 00000D1F 2020456E7465722061-     		db	'  Enter a choice.'
  1610 00000D28 2063686F6963652E   
  1611 00000D30 00                      		db	0
  1612 00000D31 05                      madeactive_msg:	db	5
  1613 00000D32 00                      		db	0
  1614 00000D33 0F                      		db	0Fh
  1615 00000D34 09                      		db	9
  1616 00000D35 05                      		db	5
  1617 00000D36 00                      		db	0
  1618 00000D37 12                      		db	18
  1619 00000D38 506172746974696F6E-     		db	'Partition '
  1620 00000D41 20                 
  1621 00000D42 0B                      		db	11
  1622 00000D43 [8800]                  		dw	active_part_input
  1623 00000D45 206D61646520616374-     		db	' made active.'
  1624 00000D4E 6976652E           
  1625 00000D52 09                      		db	9
  1626 00000D53 0D                      		db	0Dh
  1627 00000D54 0A                      		db	0Ah
  1628 00000D55 09                      		db	9
  1629 00000D56 00                      		db	0
  1630 00000D57 05                      alrdyactive_msg: db	5
  1631 00000D58 00                      		db	0
  1632 00000D59 12                      		db	18
  1633 00000D5A 13                      		db	13h
  1634 00000D5B 506172746974696F6E-     		db	'Partition 1 is already active.'
  1635 00000D64 203120697320616C72-
  1636 00000D6D 656164792061637469-
  1637 00000D76 76652E             
  1638 00000D79 14                      		db	14h
  1639 00000D7A 00                      		db	0
  1640 00000D7B 05                      		db	5
  1641 00000D7C 00                      		db	0
  1642 00000D7D 0F                      		db	0Fh
  1643 00000D7E 546865206375727265-     		db	'The current active partition is '
  1644 00000D87 6E7420616374697665-
  1645 00000D90 20706172746974696F-
  1646 00000D99 6E20697320         
  1647 00000D9E 0B                      		db	11
  1648 00000D9F [7B00]                  		dw	cpartition_number
  1649 00000DA1 00                      		db	0
  1650 00000DA2 05                      noptoactive_msg: db	5
  1651 00000DA3 00                      		db	0
  1652 00000DA4 12                      		db	18
  1653 00000DA5 4E6F20706172746974-     		db	'No partitions to make active.'
  1654 00000DAE 696F6E7320746F206D-
  1655 00000DB7 616B65206163746976-
  1656 00000DC0 652E               
  1657 00000DC2 00                      		db	0
  1658 00000DC3 05                      deldp_msg:	db	5
  1659 00000DC4 00                      		db	0
  1660 00000DC5 04                      		db	4
  1661 00000DC6 13                      		db	13h
  1662 00000DC7 44656C65746520444F-     		db	'Delete DOS partition'
  1663 00000DD0 532070617274697469-
  1664 00000DD9 6F6E               
  1665 00000DDB 14                      		db	14h
  1666 00000DDC 09                      		db	9
  1667 00000DDD 05                      		db	5
  1668 00000DDE 00                      		db	0
  1669 00000DDF 08                      		db	8
  1670 00000DE0 10                      		db	16
  1671 00000DE1 05                      		db	5
  1672 00000DE2 00                      		db	0
  1673 00000DE3 18                      		db	24
  1674 00000DE4 507265737320134573-     		db	'Press ',13h,'Esc'
  1675 00000DED 63                 
  1676 00000DEE 14                      		db	14h
  1677 00000DEF 20746F207265747572-     		db	' to return to FDISK Options'
  1678 00000DF8 6E20746F2046444953-
  1679 00000E01 4B204F7074696F6E73 
  1680 00000E0A 00                      		db	0
  1681 00000E0B 05                      deldp_warn_msg:	db	5
  1682 00000E0C 00                      		db	0
  1683 00000E0D 12                      		db	18
  1684 00000E0E 07                      		db	7
  1685 00000E0F 13                      		db	19
  1686 00000E10 5761726E696E672120-     		db	'Warning!  Data in the DOS partition',0Dh,0Ah
  1687 00000E19 204461746120696E20-
  1688 00000E22 74686520444F532070-
  1689 00000E2B 6172746974696F6E0D-
  1690 00000E34 0A                 
  1691 00000E35 636F756C6420626520-     		db	'could be lost.'
  1692 00000E3E 6C6F73742E         
  1693 00000E43 20                      		db	20h
  1694 00000E44 20                      		db	20h
  1695 00000E45 446F20796F75207769-     		db	'Do you wish to',0Dh,0Ah
  1696 00000E4E 736820746F0D0A     
  1697 00000E55 636F6E74696E75652E-     		db	'continue...................................? [ ]'
  1698 00000E5E 2E2E2E2E2E2E2E2E2E-
  1699 00000E67 2E2E2E2E2E2E2E2E2E-
  1700 00000E70 2E2E2E2E2E2E2E2E2E-
  1701 00000E79 2E2E2E2E2E2E2E3F20-
  1702 00000E82 5B205D             
  1703 00000E85 14                      		db	20
  1704 00000E86 00                      		db	0
  1705 00000E87 2E                      delanswer_cpos:	db	46
  1706 00000E88 14                      		db	20
  1707 00000E89 4E                      _no_:		db	'N'
  1708 00000E8A 07                      beep2:		db	7
  1709 00000E8B 00                      		db	0
  1710 00000E8C 05                      no_dosp_del_msg: db	5
  1711 00000E8D 00                      		db	0
  1712 00000E8E 12                      		db	18
  1713 00000E8F 4E6F20444F53207061-     		db	'No DOS partition to delete.'
  1714 00000E98 72746974696F6E2074-
  1715 00000EA1 6F2064656C6574652E 
  1716 00000EAA 07                      		db	7
  1717 00000EAB 00                      		db	0
  1718 00000EAC 07                      beep3:		db	7
  1719 00000EAD 00                      		db	0
  1720 00000EAE 06                      cls1:		db	6
  1721 00000EAF 00                      		db	0
  1722 00000EB0 06                      cls_reboot_msg:	db	6
  1723 00000EB1 05                      		db	5
  1724 00000EB2 00                      		db	0
  1725 00000EB3 10                      		db	16
  1726 00000EB4 53797374656D207769-     		db	'System will now reboot',0Dh,0Ah
  1727 00000EBD 6C6C206E6F77207265-
  1728 00000EC6 626F6F740D0A       
  1729 00000ECC 0A                      		db	0Ah
  1730 00000ECD 496E7365727420444F-     		db	'Insert DOS diskette in drive A:',0Dh,0Ah
  1731 00000ED6 53206469736B657474-
  1732 00000EDF 6520696E2064726976-
  1733 00000EE8 6520413A0D0A       
  1734 00000EEE 507265737320616E79-     		db	'Press any key when ready . . .'
  1735 00000EF7 206B6579207768656E-
  1736 00000F00 207265616479202E20-
  1737 00000F09 2E202E             
  1738 00000F0C 00                      		db	0
  1739 00000F0D 06                      cls2		db	6
  1740 00000F0E 00                      		db	0
  1741 00000F0F 05                      finalcpos	db	5
  1742 00000F10 25                      		db	37
  1743 00000F11 18                      		db	24
  1744 00000F12 00                      		db	0
  1745 00000F13 07                      beep4		db	7
  1746 00000F14 00                      		db	0
  1747                                  
  1748                                  ; ----------------------------------------------------------------------------
  1749                                  
  1750                                  write_on_screen: ; Write/Display partition data and messages on screen
  1751                                  		 ; (Videe mode 4h, int 10h will be used for menu pages)
  1752                                  write_on:	
  1753 00000F15 53                      		push	bx
  1754 00000F16 52                      		push	dx
  1755 00000F17 56                      		push	si
  1756 00000F18 89D6                    		mov	si,dx
  1757                                  w_get_char:
  1758 00000F1A AC                      		lodsb
  1759 00000F1B 3C20                    		cmp	al,20h
  1760 00000F1D 7205                    		jb	short w_function
  1761                                  w_put_char:
  1762 00000F1F E8CC00                  		call	chr_out
  1763 00000F22 EBF6                    		jmp	short w_get_char
  1764                                  
  1765                                  ; ----------------------------------------------------------------------------
  1766                                  
  1767                                  w_function:	; Write characters (strings) and perform requested function
  1768                                  		; for menu format/positioning/control characters
  1769 00000F24 98                      		cbw
  1770 00000F25 89C3                    		mov	bx,ax
  1771 00000F27 01C3                    		add	bx,ax
  1772 00000F29 FFA7[320F]              		jmp	word [bx+function]
  1773                                  
  1774                                  ; ----------------------------------------------------------------------------
  1775                                  
  1776                                  NOT_USED: ; This is put here for compatibility with original FDISK code (1985)
  1777 00000F2D 90                      		nop
  1778                                  w_pop_retn:	; Return from (w_function) write on screen function
  1779 00000F2E 5E                      		pop	si
  1780 00000F2F 5A                      		pop	dx
  1781 00000F30 5B                      		pop	bx
  1782 00000F31 C3                      		retn
  1783                                  
  1784                                  ; ----------------------------------------------------------------------------
  1785                                  
  1786                                  function:	; Function jump table/addresses for format/positioning/control
  1787                                  		; characters between 0 to 30.
  1788 00000F32 [2E0F]                  		dw	w_pop_retn		; 0 (return)
  1789 00000F34 [920F]                  		dw	w_byte_out		; 1 (write pointed byte as hex num)
  1790 00000F36 [2D0F]                  		dw	NOT_USED		; 2
  1791                                  		;dw	w_word_out		; 3 (write pointed word as hex num)
  1792 00000F38 [2D0F]                  		dw	NOT_USED		; 3
  1793 00000F3A [9D0F]                  		dw	w_decimal_number	; 4 (write number as decimal)
  1794 00000F3C [830F]                  		dw	w_set_cpos		; 5 (Set Cursor position)
  1795 00000F3E [740F]                  		dw	w_clear_screen		; 6 (clear screen)
  1796 00000F40 [1F0F]                  		dw	w_put_char		; 7 (write character)
  1797 00000F42 [1F0F]                  		dw	w_put_char		; 8	
  1798 00000F44 [790F]                  		dw	w_blank_row		; 9 (clear row)
  1799 00000F46 [1F0F]                  		dw	w_put_char		; 10
  1800 00000F48 [8B0F]                  		dw	w_char_indirect		; 11 (write pointed char)
  1801 00000F4A [AD0F]                  		dw	w_comp_num_skip_nz	; 12 (comp & skip text if nums are not equal)
  1802 00000F4C [1F0F]                  		dw	w_put_char		; 13
  1803 00000F4E [B80F]                  		dw	w_comp_num_skip_z	; 14 (comp & skip text if nums are equal)	
  1804 00000F50 [1A0F]                  		dw	w_get_char		; 15 (get caracter from keyboard)
  1805 00000F52 [7E0F]                  		dw	w_cls_down		; 16 (clear rows down from current row)
  1806                                  		;dw	w_blink_on		; 17 (Enable blinking)
  1807                                  		;dw	w_blink_off		; 18 (Disable blinking)
  1808 00000F54 [2D0F]                  		dw	NOT_USED		; 17
  1809 00000F56 [2D0F]                  		dw	NOT_USED		; 18
  1810 00000F58 [CB0F]                  		dw	w_bold_on		; 19 (Enable highlighting)
  1811 00000F5A [D10F]                  		dw	w_bold_off		; 20 (Disable highlighting)	
  1812 00000F5C [2D0F]                  		dw	NOT_USED		; 21		
  1813 00000F5E [2D0F]                  		dw	NOT_USED		; 22
  1814 00000F60 [2D0F]                  		dw	NOT_USED		; 23
  1815                                  		;dw	w_bg_hli		; 24 (Enable BG highligting & blinking)
  1816                                  		;dw	w_fg_hli		; 25 (Enable FG highligting & blinking)	
  1817 00000F62 [2D0F]                  		dw	NOT_USED		; 24
  1818 00000F64 [2D0F]                  		dw	NOT_USED		; 25
  1819 00000F66 [1F0F]                  		dw	w_put_char		; 26
  1820 00000F68 [1F0F]                  		dw	w_put_char		; 27
  1821 00000F6A [1F0F]                  		dw	w_put_char		; 28
  1822 00000F6C [1F0F]                  		dw	w_put_char		; 29
  1823 00000F6E [1F0F]                  		dw	w_put_char		; 30
  1824 00000F70 [2D0F]                  		dw	NOT_USED		; 31
  1825                                  nothing:
  1826 00000F72 [2D0F]                  		dw	NOT_USED		; 32
  1827                                  
  1828                                  ; ----------------------------------------------------------------------------
  1829                                  
  1830                                  w_clear_screen:		; Clear (all) screen
  1831 00000F74 E84C02                  		call	clear_screen
  1832 00000F77 EBA1                    		jmp	short w_get_char
  1833                                  
  1834                                  ; ----------------------------------------------------------------------------
  1835                                  
  1836                                  w_blank_row:		; Clear screen row
  1837 00000F79 E86002                  		call	blank_row
  1838 00000F7C EB9C                    		jmp	short w_get_char
  1839                                  
  1840                                  ; ----------------------------------------------------------------------------
  1841                                  
  1842                                  w_cls_down:		; Clear screen from the requested row to down
  1843 00000F7E E86B02                  		call	clear_screen_down
  1844 00000F81 EB97                    		jmp	short w_get_char
  1845                                  
  1846                                  ; ----------------------------------------------------------------------------
  1847                                  
  1848                                  w_set_cpos:		;  Set cursor position
  1849                                  			; (following bytes are for cursor row and column)
  1850 00000F83 AD                      		lodsw
  1851 00000F84 89C2                    		mov	dx, ax ; DL = row, DH = column
  1852 00000F86 E88E02                  		call	set_cursor_position
  1853 00000F89 EB8F                    		jmp	short w_get_char
  1854                                  
  1855                                  ; ----------------------------------------------------------------------------
  1856                                  
  1857                                  w_char_indirect:	; Write character in the following address
  1858 00000F8B AD                      		lodsw
  1859 00000F8C 89C3                    		mov	bx,ax
  1860 00000F8E 8A07                    		mov	al,[bx]
  1861 00000F90 EB8D                    		jmp	w_put_char
  1862                                  
  1863                                  ; ----------------------------------------------------------------------------
  1864                                  
  1865                                  w_byte_out:		; Write (byte) hex number in the following address
  1866 00000F92 AD                      		lodsw
  1867 00000F93 89C3                    		mov	bx,ax
  1868 00000F95 8A07                    		mov	al,[bx]
  1869 00000F97 E83D00                  		call	conv_byte_out
  1870 00000F9A E97DFF                  		jmp	w_get_char
  1871                                  
  1872                                  ; ----------------------------------------------------------------------------
  1873                                  
  1874                                  ;w_word_out:	; Write (word) hex number in the following address
  1875                                  		;lodsw
  1876                                  		;mov	bx,ax
  1877                                  		;mov	ax,[bx]
  1878                                  		;call	put_word
  1879                                  		;jmp	w_get_char
  1880                                  
  1881                                  ; ----------------------------------------------------------------------------
  1882                                  
  1883                                  w_decimal_number:	; Write
  1884 00000F9D AD                      		lodsw
  1885 00000F9E 89C3                    		mov	bx,ax
  1886 00000FA0 8B07                    		mov	ax,[bx]
  1887                                  
  1888                                  		;call	convert_to_decimal
  1889                                  		;jmp	w_get_char
  1890                                  
  1891 00000FA2 BB1027                  		mov	bx,10000 ; Divisor (proper for 5 digits, <= 65535)	
  1892 00000FA5 B100                    		mov	cl,0	; Leading zero must not be written
  1893 00000FA7 E86C01                  		call	write_digits
  1894 00000FAA E96DFF                  		jmp	w_get_char
  1895                                  
  1896                                  ; ----------------------------------------------------------------------------
  1897                                  
  1898                                  w_comp_num_skip_nz:
  1899 00000FAD AD                      		lodsw
  1900 00000FAE 89C3                    		mov	bx,ax
  1901 00000FB0 AC                      		lodsb
  1902 00000FB1 3A07                    		cmp	al,[bx]
  1903 00000FB3 750E                    		jnz	short skip_text
  1904 00000FB5 E962FF                  		jmp	w_get_char
  1905                                  
  1906                                  ; ----------------------------------------------------------------------------
  1907                                  
  1908                                  w_comp_num_skip_z:
  1909 00000FB8 AD                      		lodsw
  1910 00000FB9 89C3                    		mov	bx,ax
  1911 00000FBB AC                      		lodsb
  1912 00000FBC 3A07                    		cmp	al,[bx]
  1913 00000FBE 7403                    		jz	short skip_text
  1914 00000FC0 E957FF                  		jmp	w_get_char
  1915                                  
  1916                                  ; ----------------------------------------------------------------------------
  1917                                  
  1918                                  skip_text:
  1919 00000FC3 AC                      		lodsb
  1920 00000FC4 3C0F                    		cmp	al,0Fh
  1921 00000FC6 75FB                    		jnz	short skip_text
  1922 00000FC8 E94FFF                  		jmp	w_get_char
  1923                                  
  1924                                  ; ----------------------------------------------------------------------------
  1925                                  
  1926                                  ;w_blink_on:
  1927                                  		;call	blink_on
  1928                                  		;jmp	w_get_char
  1929                                  
  1930                                  ; ----------------------------------------------------------------------------
  1931                                  
  1932                                  ;w_blink_off:
  1933                                  		;call	blink_off
  1934                                  		;jmp	w_get_char
  1935                                  
  1936                                  ; ----------------------------------------------------------------------------
  1937                                  
  1938                                  w_bold_on:
  1939 00000FCB E83D02                  		call	hli_on
  1940 00000FCE E949FF                  		jmp	w_get_char
  1941                                  
  1942                                  ; ----------------------------------------------------------------------------
  1943                                  
  1944                                  w_bold_off:
  1945 00000FD1 E83D02                  		call	hli_off
  1946 00000FD4 E943FF                  		jmp	w_get_char
  1947                                  
  1948                                  ; ----------------------------------------------------------------------------
  1949                                  
  1950                                  ;w_bg_hli:
  1951                                  		;call	bg_hli_blink_on
  1952                                  		;jmp	w_get_char
  1953                                  
  1954                                  ; ----------------------------------------------------------------------------
  1955                                  
  1956                                  ;w_fg_hli:
  1957                                  		;call	fg_hli_blink_on
  1958                                  		;jmp	w_get_char
  1959                                  
  1960                                  ; ----------------------------------------------------------------------------
  1961                                  
  1962                                  ;convert_to_decimal:
  1963                                  ;		; Convert number (in AX) to decimal number digits/chars
  1964                                  ;		; and write them out (on screen at current cursor position)
  1965                                  ;
  1966                                  ;		pushf
  1967                                  ;		push	ax
  1968                                  ;		push	bx
  1969                                  ;		push	cx
  1970                                  ;		push	dx
  1971                                  ;		push	bp
  1972                                  ;		push	si
  1973                                  ;		push	di
  1974                                  ;		push	ds
  1975                                  ;		push	es
  1976                                  ;		mov	bx,10000 ; Divisor (proper for 5 digits, <= 65535)	
  1977                                  ;		mov	cl,0	; Leading zero must not be written
  1978                                  ;cnvtodec1:
  1979                                  ;		push	ax
  1980                                  ;		xor	dx,dx
  1981                                  ;		div	bx
  1982                                  ;		;cmp	cl,0FEh ; -2
  1983                                  ;		;jnz	short cnvtodec2
  1984                                  ;		;cmp	al,0
  1985                                  ;		;jnz	short cnvtodec3
  1986                                  ;		;jmp	short cnvtodec4
  1987                                  ;cnvtodec2:
  1988                                  ;		cmp	al,cl
  1989                                  ;		jne	short cnvtodec3 ; write if it is not a leading zero
  1990                                  ;			; Blank leading zeros (use space instead of '0')
  1991                                  ;		push	ax
  1992                                  ;		mov	al,20h	; space/blank
  1993                                  ;		call	chr_out
  1994                                  ;		pop	ax
  1995                                  ;		jmp	short cnvtodec4
  1996                                  ;cnvtodec3:
  1997                                  ;		add	al,'0'	 ; Convert to digit character as '0' to '9'
  1998                                  ;		call	chr_out
  1999                                  ;		sub	al,'0'	 ; Convert back to single digit number again
  2000                                  ;		mov	cl,0FFh ; -1 ; Write zeros -'0'- now on
  2001                                  ;cnvtodec4:
  2002                                  ;		mul	bx	; multiply the qoutient with BX
  2003                                  ;		mov	dx,ax	; this is a number with multiplies of BX
  2004                                  ;		pop	ax 	; restore the num at the beginning of this proc	
  2005                                  ;		sub	ax,dx	; get difference (< the divisor in BX)
  2006                                  ;		push	ax	; save it
  2007                                  ;		mov	ax,bx	; Divide the divisor by 10
  2008                                  ;		mov	bx,10
  2009                                  ;		xor	dx,dx
  2010                                  ;		div	bx
  2011                                  ;		mov	bx,ax	; save the new divisor in bx
  2012                                  ;		pop	ax	; restore difference (for previous divisor)
  2013                                  ;		cmp	bx,1	; If the new divisor > 1 (may be 10,100,1000)
  2014                                  ;		ja	short cnvtodec1 ; repeat this procedure for the new digit
  2015                                  ;		mov	cl,0FFh ; -1 ; Write zeros -'0'- now on
  2016                                  ;		cmp	bx,0
  2017                                  ;		jnz	short cnvtodec1 ; If the quotient is not ZERO
  2018                                  ;				  ; repeat this procedure for the next digit
  2019                                  ;				  ;( a '0' will be written at its position)
  2020                                  ;		pop	es
  2021                                  ;		pop	ds
  2022                                  ;		pop	di
  2023                                  ;		pop	si
  2024                                  ;		pop	bp
  2025                                  ;		pop	dx
  2026                                  ;		pop	cx
  2027                                  ;		pop	bx
  2028                                  ;		pop	ax
  2029                                  ;		popf
  2030                                  ;		retn
  2031                                  
  2032                                  ; ----------------------------------------------------------------------------
  2033                                  
  2034                                  ;put_word:	; Write word in AX (as hexadecimal number)
  2035                                  		;push	ax
  2036                                  		;mov	al,ah ; Write high byte of AX	
  2037                                  		;call	conv_byte_out
  2038                                  		;pop	ax
  2039                                  			      ; Write low byte of AX	
  2040                                  
  2041                                  ; ----------------------------------------------------------------------------
  2042                                  
  2043                                  conv_byte_out:	; Write byte in AL (as hexadecimal number)
  2044 00000FD7 50                      		push	ax  ; Save AL (AX)
  2045                                  			; Move/Shift high 4 bits of AL to low 4 bits
  2046 00000FD8 D1E8                    		shr	ax,1
  2047 00000FDA D1E8                    		shr	ax,1
  2048 00000FDC D1E8                    		shr	ax,1
  2049 00000FDE D1E8                    		shr	ax,1
  2050                                  			; Write high 4 bits of AL (as low 4 bits of AL)
  2051 00000FE0 E80100                  		call	bin_to_digit
  2052 00000FE3 58                      		pop	ax  ; Restore AL (AX)
  2053                                  			; Write low 4 bits of AL
  2054                                  
  2055                                  ; ----------------------------------------------------------------------------
  2056                                  
  2057                                  bin_to_digit:	; Convert low 4 bits of AL to hex digits ('0'..'F')
  2058 00000FE4 240F                    		and	al,0Fh
  2059 00000FE6 0430                    		add	al,'0'
  2060 00000FE8 3C39                    		cmp	al,'9'
  2061 00000FEA 7602                    		jbe	short btd_retn
  2062 00000FEC 0437                    		add	al,'7' ; 'A' to 'F'
  2063                                  btd_retn:
  2064                                  		;call	chr_out
  2065                                  		;retn
  2066                                  
  2067                                  ; ----------------------------------------------------------------------------
  2068                                  
  2069                                  chr_out:	; Write character on screen (AX is preserved)
  2070 00000FEE 50                      		push	ax
  2071 00000FEF E88E01                  		call	write_character	; Write char on screen (via int 10h)
  2072 00000FF2 58                      		pop	ax
  2073                                  chr_out_retn:
  2074 00000FF3 C3                      		retn
  2075                                  
  2076                                  ; ----------------------------------------------------------------------------
  2077                                  
  2078 00000FF4 00                      opnum:		db	0
  2079 00000FF5 00                      selected_opnum:	db	0
  2080                                  
  2081                                  ; ----------------------------------------------------------------------------
  2082                                  
  2083                                  select_option_number:	; Select menu option
  2084                                  			;    (waits input as number or ESC for cancel/return)
  2085 00000FF6 A2[F40F]                		mov	[opnum],al
  2086                                  		;jmp	short sopnum2
  2087                                  sopnum1:
  2088 00000FF9 A0[F40F]                		mov	al,[opnum]
  2089                                  sopnum2:
  2090 00000FFC A2[F50F]                		mov	[selected_opnum],al
  2091 00000FFF E87E01                  		call	write_character
  2092 00001002 B008                    		mov	al,8  ; Backspace (move cursor back)
  2093 00001004 E87901                  		call	write_character
  2094                                  sopnum3:
  2095 00001007 E85C01                  		call	getchar
  2096 0000100A 247F                    		and	al,7Fh ; ASCII 0-7Fh
  2097 0000100C 3C0D                    		cmp	al,0Dh ; CR   ; Carriage Return (ENTER) key	
  2098 0000100E 7417                    		je	short sopnum5 ; means selected option will be applied
  2099 00001010 3C08                    		cmp	al,8   ; BS	
  2100 00001012 74E5                    		je	short sopnum1
  2101 00001014 3C7F                    		cmp	al,7Fh ; DEL
  2102 00001016 74E1                    		je	short sopnum1
  2103 00001018 3C1B                    		cmp	al,1Bh ; ESC
  2104 0000101A 7406                    		je	short sopnum4
  2105 0000101C 3C20                    		cmp	al,20h ; SPC
  2106 0000101E 72E7                    		jb	short sopnum3
  2107 00001020 EBDA                    		jmp	short sopnum2
  2108                                  sopnum4:
  2109 00001022 C606[F50F]1B            		mov	byte [selected_opnum],1Bh ; ESC (cancel)
  2110                                  sopnum5:
  2111 00001027 A0[F50F]                		mov	al,[selected_opnum] ; selected option
  2112 0000102A C3                      		retn
  2113                                  
  2114                                  ; ----------------------------------------------------------------------------
  2115                                  
  2116 0000102B 0000                    strtnumber:	dw	0
  2117 0000102D 00                      maxdigits:	db	0
  2118 0000102E 00                      inputdigits:	db	0
  2119 0000102F 0000                    input_numcalc:	dw	0
  2120 00001031 00                      input_chr:	db	0
  2121                                  
  2122                                  ; ----------------------------------------------------------------------------
  2123                                  
  2124                                  get_and_write_number: 
  2125                                  		; Get a number via keyboard inputs and write its digits
  2126                                  		; AX = default/beginning value, CL = max. number of digits	
  2127 00001032 A3[2B10]                		mov	[strtnumber],ax
  2128 00001035 A3[2F10]                		mov	[input_numcalc],ax
  2129 00001038 880E[2D10]              		mov	[maxdigits],cl
  2130 0000103C C606[2E10]00            		mov	byte [inputdigits], 0
  2131                                  wnum1:
  2132 00001041 BA[1511]                		mov	dx,last_digit  ; the last (possible) digit address
  2133 00001044 A0[2D10]                		mov	al,[maxdigits]
  2134 00001047 98                      		cbw
  2135 00001048 29C2                    		sub	dx,ax
  2136 0000104A 42                      		inc	dx ; DX = start address of (the number) digits
  2137 0000104B E8C7FE                  		call	write_on_screen ; Write default val/num at first
  2138 0000104E B80100                  		mov	ax,1
  2139 00001051 8A0E[2D10]              		mov	cl,[maxdigits]
  2140 00001055 FEC9                    		dec	cl
  2141 00001057 E306                    		jcxz	wnum3
  2142                                  wnum2:
  2143 00001059 B30A                    		mov	bl,10
  2144 0000105B F6E3                    		mul	bl
  2145 0000105D E2FA                    		loop	wnum2
  2146                                  wnum3:
  2147 0000105F 89C3                    		mov	bx,ax
  2148                                  		;mov	cx,0 ; CL/CX is already ZERO !
  2149 00001061 A1[2F10]                		mov	ax,[input_numcalc]
  2150 00001064 E8AF00                  		call	write_digits
  2151 00001067 B008                    		mov	al,8
  2152 00001069 E81401                  		call	write_character
  2153                                  wnum4:
  2154 0000106C E8F700                  		call	getchar
  2155 0000106F BB[8010]                		mov	bx,input_type_tbl
  2156 00001072 A2[3110]                		mov	[input_chr],al
  2157 00001075 E8F300                  		call	input_type_function
  2158 00001078 BA[AC0E]                		mov	dx,beep3
  2159 0000107B E897FE                  		call	write_on_screen
  2160 0000107E EBEC                    		jmp	short wnum4
  2161                                  
  2162                                  ; ----------------------------------------------------------------------------
  2163                                  
  2164                                  input_type_tbl:	; Function table for (user) input number digits
  2165                                  		; CR, DEL, BS, ESC chars
  2166                                  		; (the 1st character is a digit or function char
  2167                                  		; and following word is the function address for it.)
  2168                                  
  2169 00001080 30                      		db	'0' 
  2170 00001081 [AB10]                  		dw	number_input
  2171 00001083 31                      		db	'1'
  2172 00001084 [AB10]                  		dw	number_input
  2173 00001086 32                      		db	'2'
  2174 00001087 [AB10]                  		dw	number_input
  2175 00001089 33                      		db	'3'
  2176 0000108A [AB10]                  		dw	number_input
  2177 0000108C 34                      		db	'4'
  2178 0000108D [AB10]                  		dw	number_input
  2179 0000108F 35                      		db	'5'
  2180 00001090 [AB10]                  		dw	number_input
  2181 00001092 36                      		db	'6'
  2182 00001093 [AB10]                  		dw	number_input
  2183 00001095 37                      		db	'7'
  2184 00001096 [AB10]                  		dw	number_input
  2185 00001098 38                      		db	'8'
  2186 00001099 [AB10]                  		dw	number_input
  2187 0000109B 39                      		db	'9'
  2188 0000109C [AB10]                  		dw	number_input
  2189 0000109E 0D                      		db	0Dh
  2190 0000109F [E110]                  		dw	cr_input
  2191 000010A1 08                      		db	8
  2192 000010A2 [E810]                  		dw	back_space_input
  2193 000010A4 7F                      		db	7Fh
  2194 000010A5 [E810]                  		dw	back_space_input
  2195 000010A7 1B                      		db	1Bh
  2196 000010A8 [E610]                  		dw	esc_key_input
  2197 000010AA 00                      		db	0
  2198                                  
  2199                                  ; ----------------------------------------------------------------------------
  2200                                  
  2201                                  number_input:
  2202                                  		; Get/Build a number via keyboard inputs and write its digits
  2203                                  		; [maxdigits] = max. number of digits
  2204                                  		; [inputdigits] = count of input number digits before this one
  2205                                  		; [input_chr] = the last digit character ('0' to '9') 		
  2206                                  
  2207 000010AB 8A1E[2D10]              		mov	bl,[maxdigits]
  2208 000010AF 3A1E[2E10]              		cmp	bl,[inputdigits]
  2209 000010B3 7429                    		je	short numinput2
  2210 000010B5 A0[3110]                		mov	al,[input_chr]
  2211 000010B8 2C30                    		sub	al,'0'
  2212 000010BA 98                      		cbw
  2213 000010BB 89C3                    		mov	bx,ax
  2214 000010BD A1[2F10]                		mov	ax,[input_numcalc]
  2215 000010C0 803E[2E10]00            		cmp	byte [inputdigits],0
  2216 000010C5 7502                    		jne	short numinput1  ; If previous count of input digits
  2217                                  				         ; is not 0, current value of
  2218                                  				         ; [input_numcalc] is multiplied by 10
  2219 000010C7 31C0                    		xor	ax,ax
  2220                                  numinput1:
  2221 000010C9 B90A00                  		mov	cx,10
  2222 000010CC F7E1                    		mul	cx
  2223 000010CE 01D8                    		add	ax,bx	    ; add the value of current digit (input)
  2224 000010D0 720C                    		jc	short numinput2	; number exceeds 65535, retry
  2225 000010D2 83FA00                  		cmp	dx,0
  2226 000010D5 7507                    		jne	short numinput2 ; number exceeds 65535, retry
  2227 000010D7 A3[2F10]                		mov	[input_numcalc],ax ; recent value of the input number
  2228 000010DA FE06[2E10]              		inc	byte [inputdigits] ; +1 digit
  2229                                  numinput2:
  2230 000010DE E960FF                  		jmp	wnum1
  2231                                  
  2232                                  ; ----------------------------------------------------------------------------
  2233                                  
  2234                                  cr_input:	; Carriage return (Enter key) completes number digits input
  2235 000010E1 A1[2F10]                		mov	ax,[input_numcalc] ; calculated input number
  2236 000010E4 F8                      		clc
  2237 000010E5 C3                      		retn
  2238                                  
  2239                                  ; ----------------------------------------------------------------------------
  2240                                  
  2241                                  esc_key_input:	; ESC key/char (1Bh) cancels number (digits) input
  2242 000010E6 F9                      		stc
  2243 000010E7 C3                      		retn
  2244                                  
  2245                                  ; ----------------------------------------------------------------------------
  2246                                  
  2247                                  back_space_input: 
  2248                                  		; Backspace (BS or DEL key) char deletes the last digit
  2249                                  		; (the value of the number input will be changed to previous)
  2250 000010E8 803E[2E10]00            		cmp	byte [inputdigits],0 ; is there number input by user
  2251 000010ED 7419                    		je	short bsi_ok	     ; no, return to redo (wnum1)	
  2252 000010EF A1[2F10]                		mov	ax,[input_numcalc]   ; yes, use it (previous number)	
  2253 000010F2 31D2                    		xor	dx,dx
  2254 000010F4 B90A00                  		mov	cx,10		     ; divide number by	10 
  2255 000010F7 F7F1                    		div	cx		     ; to remove the last digit and 
  2256 000010F9 A3[2F10]                		mov	[input_numcalc],ax   ; (so) recalculate the number		
  2257 000010FC FE0E[2E10]              		dec	byte [inputdigits]   ; (last digit has been removed)	 
  2258 00001100 7506                    		jnz	short bsi_ok ; (there is an input num at least with 1 digit)
  2259 00001102 A1[2B10]                		mov	ax,[strtnumber] ; restore default/beginning number
  2260 00001105 A3[2F10]                		mov	[input_numcalc],ax  ; if there is not an input number  
  2261                                  bsi_ok:
  2262 00001108 E936FF                  		jmp	wnum1	; return to redo (try again till a CR or ESC)
  2263                                  
  2264                                  ; ----------------------------------------------------------------------------
  2265                                  
  2266                                  number_digits:	; Space for 11 digits (for number input by the user)
  2267 0000110B 08<rept>                		times	10 db 08h
  2268                                  
  2269 00001115 00                      last_digit:	db	0
  2270                                  
  2271                                  ; ----------------------------------------------------------------------------
  2272                                  
  2273                                  write_digits:	; Write/Display digits of the number in AX -max. 5 digits-
  2274                                  		; BX = divisor (10,100,1000,10000)
  2275                                  		; (Decimal number will be written at current cursor position.)
  2276                                  		; CL = 0 (for wd2:) if the leading zero will not be written.
  2277                                  
  2278 00001116 9C                      		pushf
  2279 00001117 50                      		push	ax
  2280 00001118 53                      		push	bx
  2281 00001119 51                      		push	cx
  2282 0000111A 52                      		push	dx
  2283 0000111B 55                      		push	bp
  2284 0000111C 56                      		push	si
  2285 0000111D 57                      		push	di
  2286 0000111E 1E                      		push	ds
  2287 0000111F 06                      		push	es
  2288                                  wd1:
  2289 00001120 50                      		push	ax
  2290 00001121 31D2                    		xor	dx,dx
  2291 00001123 F7F3                    		div	bx
  2292                                  		;cmp	cl,-2 ; 0FEh
  2293                                  		;jnz	short wd2
  2294                                  		;cmp	al,0
  2295                                  		;jnz	short wd3
  2296                                  		;jmp	short wd4
  2297                                  wd2:
  2298 00001125 38C8                    		cmp	al,cl
  2299 00001127 7509                    		jne	short wd3 ; write digit -if it is not a leading zero-
  2300                                  			; AL=0 & CL=0, write blank/space instead of zero
  2301 00001129 50                      		push	ax
  2302 0000112A B020                    		mov	al,20h ; space/blank
  2303 0000112C E85100                  		call	write_character
  2304 0000112F 58                      		pop	ax
  2305 00001130 EB09                    		jmp	short wd4
  2306                                  wd3:
  2307 00001132 0430                    		add	al,'0'  ; Convert to digit character as '0' to '9'
  2308 00001134 E84900                  		call	write_character
  2309 00001137 2C30                    		sub	al,'0'  ; Convert back to single digit number again
  2310 00001139 B1FF                    		mov	cl,-1 ; 0FFh ; next zero(s) -'0'- will be written
  2311                                  wd4:
  2312 0000113B F7E3                    		mul	bx	; multiply the qoutient with BX
  2313 0000113D 89C2                    		mov	dx,ax	; this is a number with multiplies of BX
  2314 0000113F 58                      		pop	ax 	; restore the num at the beginning of this proc	
  2315 00001140 29D0                    		sub	ax,dx	; get difference (< the divisor in BX)
  2316 00001142 50                      		push	ax	; save it
  2317 00001143 89D8                    		mov	ax,bx	; Divide the divisor by 10
  2318 00001145 BB0A00                  		mov	bx,10
  2319 00001148 31D2                    		xor	dx,dx
  2320 0000114A F7F3                    		div	bx
  2321 0000114C 89C3                    		mov	bx,ax	; save the new divisor in bx
  2322 0000114E 58                      		pop	ax	; restore difference (for previous divisor)
  2323 0000114F 83FB01                  		cmp	bx,1	  ; If the new divisor > 1 (may be 10,100,1000)
  2324 00001152 77CC                    		ja	short wd1 ; repeat this procedure for the new digit
  2325                                  				
  2326 00001154 B1FF                    		mov	cl,-1 ; 0FFh ; next zero(s) -'0'- will be written
  2327 00001156 83FB00                  		cmp	bx,0
  2328 00001159 75C5                    		jne	short wd1 ; If the quotient is not ZERO
  2329                                  				  ; repeat this procedure for the next digit
  2330                                  				  ;( a '0' will be written at its position)
  2331 0000115B 07                      		pop	es
  2332 0000115C 1F                      		pop	ds
  2333 0000115D 5F                      		pop	di
  2334 0000115E 5E                      		pop	si
  2335 0000115F 5D                      		pop	bp
  2336 00001160 5A                      		pop	dx
  2337 00001161 59                      		pop	cx
  2338 00001162 5B                      		pop	bx
  2339 00001163 58                      		pop	ax
  2340 00001164 9D                      		popf
  2341 00001165 C3                      		retn
  2342                                  
  2343                                  ; ----------------------------------------------------------------------------
  2344                                  
  2345                                  getchar:	; Get a character from keyboard buffer (or getchar from STDIN)
  2346 00001166 B407                    		mov	ah,7
  2347 00001168 CD21                    		int	21h	; DOS -	DIRECT STDIN INPUT, NO ECHO
  2348 0000116A C3                      		retn
  2349                                  
  2350                                  ; ----------------------------------------------------------------------------
  2351                                  
  2352                                  input_type_function: ; Function table for character/number/digit input(s)
  2353                                  		; If AL>0 and AL=[BX], jump the routine in [BX+2] 
  2354 0000116B 803F00                  		cmp	byte [bx],0
  2355 0000116E 740E                    		je	short cit_retn
  2356 00001170 3A07                    		cmp	al,[bx]
  2357 00001172 7405                    		je	short cit_ok ; same char
  2358                                  		; check the next character in the table
  2359                                  		; (every function has 1+2 -char+pointer- bytes in the table)
  2360 00001174 43                      		inc	bx
  2361 00001175 43                      		inc	bx
  2362 00001176 43                      		inc	bx
  2363 00001177 EBF2                    		jmp	short input_type_function
  2364                                  cit_ok:
  2365 00001179 43                      		inc	bx
  2366 0000117A 8B07                    		mov	ax,[bx] ; get function address (as offset)
  2367 0000117C 5B                      		pop	bx
  2368 0000117D 50                      		push	ax
  2369                                  cit_retn:
  2370 0000117E C3                      		retn
  2371                                  
  2372                                  ; ----------------------------------------------------------------------------
  2373                                  
  2374 0000117F 07                      chr_attributes:	db	07h    ; Default (start) attrib of chars to be written
  2375                                  
  2376                                  ; ----------------------------------------------------------------------------
  2377                                  
  2378                                  write_character:	; Write ASCII character (in AL) by using int 10h (wtty)	
  2379 00001180 3C20                    		cmp	al,20h
  2380 00001182 7232                    		jb	short wtty
  2381                                  
  2382 00001184 50                      		push	ax
  2383 00001185 53                      		push	bx
  2384 00001186 51                      		push	cx
  2385 00001187 52                      		push	dx
  2386 00001188 55                      		push	bp
  2387 00001189 B409                    		mov	ah,9
  2388 0000118B 30FF                    		xor	bh,bh
  2389 0000118D 8A1E[7F11]              		mov	bl,[chr_attributes] ; Character attributes to be applied
  2390 00001191 B90100                  		mov	cx,1
  2391 00001194 CD10                    		int	10h	; - VIDEO - WRITE ATTRIBUTES/CHARACTERS	AT CURSOR POSITION
  2392                                  				;  AL = character, BH = display page
  2393                                  				;  BL = attributes of character (alpha modes) 
  2394                                  				; 	or color (graphics modes)
  2395                                  				;  CX = number of times to write character
  2396 00001196 B403                    		mov	ah,3
  2397 00001198 CD10                    		int	10h	; - VIDEO - READ CURSOR	POSITION
  2398                                  				; BH = page number
  2399                                  				; Return: DH,DL	= row,column, 
  2400                                  				;	  CH = cursor start line, CL = cursor end line
  2401 0000119A FEC2                    		inc	dl
  2402 0000119C 80FA50                  		cmp	dl,80
  2403 0000119F 720B                    		jb	short set_cpos
  2404 000011A1 30D2                    		xor	dl,dl
  2405 000011A3 FEC6                    		inc	dh
  2406 000011A5 80FE18                  		cmp	dh,24
  2407 000011A8 7202                    		jb	short set_cpos
  2408 000011AA 30F6                    		xor	dh, dh
  2409                                  set_cpos:
  2410 000011AC B402                    		mov	ah,2
  2411 000011AE CD10                    		int	10h
  2412                                  
  2413 000011B0 5D                      		pop	bp
  2414 000011B1 5A                      		pop	dx
  2415 000011B2 59                      		pop	cx
  2416 000011B3 5B                      		pop	bx
  2417 000011B4 58                      		pop	ax
  2418 000011B5 C3                      		retn
  2419                                  
  2420                                  ; ----------------------------------------------------------------------------
  2421                                  
  2422                                  wtty:			; tty write (write character and advance cursor)
  2423 000011B6 50                      		push	ax
  2424 000011B7 53                      		push	bx
  2425 000011B8 55                      		push	bp
  2426 000011B9 B40E                    		mov	ah,0Eh
  2427 000011BB 30DB                    		xor	bl,bl
  2428 000011BD CD10                    		int	10h	; - VIDEO - WRITE CHARACTER AND	ADVANCE	CURSOR (TTY WRITE)
  2429                                  				; AL = character, BH = display page (alpha modes)
  2430                                  				; BL = foreground color	(graphics modes)
  2431 000011BF 5D                      		pop	bp
  2432 000011C0 5B                      		pop	bx
  2433 000011C1 58                      		pop	ax
  2434 000011C2 C3                      		retn
  2435                                  
  2436                                  ; ----------------------------------------------------------------------------
  2437                                  
  2438                                  ;write_dos_string: 	; Write DOS string at the addr in DX (end char = '$')
  2439                                  		;push	ax
  2440                                  		;push	si
  2441                                  		;mov	si,dx
  2442                                  ;wds_next_char:
  2443                                  		;lodsb
  2444                                  		;cmp	al,'$'
  2445                                  		;je	short wds_retn
  2446                                  		;call	write_character
  2447                                  		;jmp	short wds_next_char
  2448                                  wds_retn:
  2449                                  		;pop	si
  2450                                  		;pop	ax
  2451                                  		;retn
  2452                                  
  2453                                  ; ----------------------------------------------------------------------------
  2454                                  
  2455                                  clear_screen:	; Clear (current) video page (screen)
  2456                                  		; (and set cursor pos. to left-top corner of the page/screen)
  2457 000011C3 31C9                    		xor	cx,cx
  2458 000011C5 B618                    		mov	dh,24
  2459 000011C7 B250                    		mov	dl,80
  2460 000011C9 8A3E[7F11]              		mov	bh,[chr_attributes]
  2461 000011CD B000                    		mov	al,0
  2462 000011CF B406                    		mov	ah,6
  2463 000011D1 CD10                    		int	10h	; - VIDEO - SCROLL PAGE	UP
  2464                                  				; AL = number of lines to scroll window	
  2465                                  				;		(0 = blank whole window)
  2466                                  				; BH = attributes to be	used on	blanked	lines
  2467                                  				; CH,CL	= row,column of	upper left corner of window to scroll
  2468                                  				; DH,DL	= row,column of	lower right corner of window
  2469 000011D3 31D2                    		xor	dx,dx
  2470 000011D5 30FF                    		xor	bh,bh
  2471 000011D7 B402                    		mov	ah,2
  2472 000011D9 CD10                    		int	10h	; - VIDEO - SET	CURSOR POSITION
  2473                                  				; DH,DL	= row, column (0,0 = upper left)
  2474                                  				; BH = page number
  2475 000011DB C3                      		retn
  2476                                  
  2477                                  ; ----------------------------------------------------------------------------
  2478                                  
  2479                                  clear_row:
  2480                                  	     ; Clear (current) screen/page row by filling spaces (blank chars) 
  2481                                  blank_row:
  2482 000011DC B020                    		mov	al,20h  ; ASCII code of the space (blank) character
  2483 000011DE B409                    		mov	ah,9	
  2484 000011E0 30FF                    		xor	bh,bh	; Video page 0 - FDISK uses default video page only! 
  2485 000011E2 8A1E[7F11]              		mov	bl,[chr_attributes]  ; current character attributes
  2486 000011E6 B95000                  		mov	cx,80 ; Video mode 3 - 80 characters per row
  2487 000011E9 CD10                    		int	10h	; - VIDEO - WRITE ATTRIBUTES/CHARACTERS	AT CURSOR POSITION
  2488                                  				;  AL = character, BH = display page
  2489                                  				;  BL = attributes of character (alpha modes) 
  2490                                  				;	or color (graphics modes)
  2491                                  				;  CX = number of times to write character
  2492 000011EB C3                      		retn
  2493                                  
  2494                                  ; ----------------------------------------------------------------------------
  2495                                  
  2496                                  clear_screen_down:
  2497                                  		; Clear (current) screen/page rows (via INT 10h scroll method) 
  2498                                  		; from the next of current row, to down.
  2499                                  		; (Example: If curr. row is 10, row 11 to 24 will be cleared.) 
  2500                                  
  2501 000011EC E8EDFF                  		call	blank_row
  2502 000011EF B403                    		mov	ah,3
  2503 000011F1 CD10                    		int	10h	; - VIDEO - READ CURSOR	POSITION
  2504                                  				; BH = page number
  2505                                  				; Return: DH,DL	= row,column,
  2506                                  				;   CH = cursor start line, CL = cursor end line
  2507 000011F3 80FE18                  		cmp	dh,24
  2508 000011F6 7412                    		je	short csd_retn
  2509 000011F8 88F5                    		mov	ch,dh
  2510 000011FA FEC5                    		inc	ch
  2511 000011FC 30C9                    		xor	cl,cl
  2512 000011FE B618                    		mov	dh,24
  2513 00001200 B250                    		mov	dl,80
  2514 00001202 B707                    		mov	bh,7
  2515 00001204 B000                    		mov	al,0
  2516 00001206 B406                    		mov	ah,6
  2517 00001208 CD10                    		int	10h	; - VIDEO - SCROLL PAGE	UP
  2518                                  				; AL = number of lines to scroll window	
  2519                                  				;		(0 = blank whole window)
  2520                                  				; BH = attributes to be	used on	blanked	lines
  2521                                  				; CH,CL	= row,column of	upper left corner of window to scroll
  2522                                  				; DH,DL	= row,column of	lower right corner of window
  2523                                  csd_retn:
  2524 0000120A C3                      		retn
  2525                                  
  2526                                  ; ----------------------------------------------------------------------------
  2527                                  
  2528                                  ;blink_on:	; Enable character blinking 
  2529                                  		;or	byte [chr_attributes],80h
  2530                                  		;retn
  2531                                  
  2532                                  ; ----------------------------------------------------------------------------
  2533                                  
  2534                                  ;blink_off:	; Disable character blinking 
  2535                                  		;and	byte [chr_attributes],7Fh
  2536                                  		;retn
  2537                                  
  2538                                  ; ----------------------------------------------------------------------------
  2539                                  
  2540                                  hli_on:		; Enable character highlighting 
  2541 0000120B 800E[7F11]08            		or	byte [chr_attributes],08h
  2542 00001210 C3                      		retn
  2543                                  
  2544                                  ; ----------------------------------------------------------------------------
  2545                                  
  2546                                  hli_off:	; Disable character highlighting 
  2547 00001211 8026[7F11]F7            		and	byte [chr_attributes],0F7h
  2548 00001216 C3                      		retn
  2549                                  
  2550                                  ; ----------------------------------------------------------------------------
  2551                                  
  2552                                  ;bg_hli_blink_on: ; Enable character background highlighting & blinking
  2553                                  		;and	byte [chr_attributes],88h
  2554                                  		;or	byte [chr_attributes],70h
  2555                                  		;retn
  2556                                  
  2557                                  ; ----------------------------------------------------------------------------
  2558                                  
  2559                                  ;fg_hli_blink_on: ; Enable char. foreground/color highlighting & blinking
  2560                                  		;and	byte [chr_attributes],88h
  2561                                  		;or	byte [chr_attributes],07h
  2562                                  		;retn
  2563                                  
  2564                                  ; ----------------------------------------------------------------------------
  2565                                  
  2566                                  set_cursor_position:	; Set cursor position on the default video page
  2567 00001217 B700                    		mov	bh,0  ; Video page 0 - Default video page for FDISK	
  2568 00001219 B402                    		mov	ah,2
  2569 0000121B CD10                    		int	10h	; - VIDEO - SET	CURSOR POSITION
  2570                                  				; DH,DL	= row, column (0,0 = upper left)
  2571                                  				; BH = page number
  2572 0000121D C3                      		retn
  2573                                  
  2574                                  ; ============================================================================
  2575                                  
  2576                                  _61Dh	equ	600h+mbr0-MBR
  2577                                  _6BDh	equ	600h+mbr_err3-MBR
  2578                                  _69Eh 	equ	600h+mbr_err2-MBR	 
  2579                                  _685h 	equ	600h+mbr_err1-MBR
  2580                                  
  2581                                  align 2
  2582                                  	
  2583                                  ; ----------------------------------------------------------------------------
  2584                                  
  2585                                  MBR:		; FDISK (1983/1985) - Master Boot Record/Sector (for MSDOS)
  2586                                  	
  2587                                  		; Setup segment registers and stack, then
  2588                                  		; Move masterboot sector to 0:600h, before
  2589                                  		; loading the active partition's boot sector at 0:7C00h.
  2590                                  
  2591 0000121E 31C0                    		xor	ax,ax
  2592 00001220 FA                      		cli
  2593 00001221 8ED0                    		mov	ss,ax
  2594 00001223 BC007C                  		mov	sp,7C00h
  2595 00001226 8EC0                    		mov	es,ax
  2596 00001228 8ED8                    		mov	ds,ax
  2597 0000122A FB                      		sti
  2598 0000122B 89E6                    		mov	si,sp
  2599 0000122D BF0006                  		mov	di,600h 
  2600 00001230 B90002                  		mov	cx,512
  2601 00001233 FC                      		cld
  2602 00001234 F3A4                    		rep movsb
  2603                                  
  2604 00001236 EA1D060000              		jmp	0:_61Dh
  2605                                  
  2606                                  ; ----------------------------------------------------------------------------
  2607                                  
  2608 0000123B B004                    mbr0:		mov	al, 4
  2609 0000123D BEBE07                  		mov	si,600h+1BEh ; 7BEh ; Partition Table offset
  2610                                  mbr1:
  2611                                  		; Check for active partition
  2612 00001240 803C80                  		cmp	byte [si],80h ; is there an active partition ?
  2613 00001243 740C                    		je	short mbr2 ; yes, launch it (if it is single active)
  2614 00001245 83C610                  		add	si,10h
  2615 00001248 FEC8                    		dec	al
  2616 0000124A 75F4                    		jnz	short mbr1
  2617 0000124C BEBD06                  		mov	si,_6BDh ; mbr_err3 : 'Invalid partition table'	
  2618 0000124F EB43                    		jmp	short mbr8
  2619                                  mbr2:
  2620                                  		; Check for another active partition (error!)
  2621 00001251 89F7                    		mov	di,si
  2622 00001253 8B14                    		mov	dx,[si]
  2623 00001255 8B4C02                  		mov	cx,[si+2]
  2624                                  mbr3:
  2625 00001258 83C610                  		add	si,10h
  2626 0000125B FEC8                    		dec	al
  2627 0000125D 740A                    		jz	short mbr4
  2628 0000125F 803C80                  		cmp	byte [si],80h
  2629 00001262 75F4                    		jne	short mbr3
  2630 00001264 BEBD06                  		mov	si,_6BDh ; mbr_err3 : 'Invalid partition table'		
  2631 00001267 EB2B                    		jmp	short mbr8
  2632                                  mbr4:
  2633 00001269 BD0500                  		mov	bp,5	; Retry count
  2634                                  mbr5:
  2635 0000126C BB007C                  		mov	bx,7C00h
  2636 0000126F B80102                  		mov	ax,201h
  2637 00001272 CD13                    		int	13h	; DISK - READ SECTORS INTO MEMORY
  2638                                  				; AL = number of sectors to read,
  2639                                  				; CH = track, CL = sector
  2640                                  				; DH = head, DL	= drive, ES:BX -> buffer to fill
  2641                                  				; Return: CF set on error, 
  2642                                  				;	AH = status, AL = number of sectors read
  2643 00001274 730C                    		jnc	short mbr6
  2644 00001276 31C0                    		xor	ax,ax
  2645 00001278 CD13                    		int	13h	; DISK - RESET DISK SYSTEM
  2646                                  				; DL = drive (if bit 7 is set 
  2647                                  				;	 both hard disks and floppy disks reset)
  2648 0000127A 4D                      		dec	bp
  2649 0000127B 75EF                    		jnz	short mbr5 ; Retry
  2650 0000127D BE9E06                  		mov	si,_69Eh ; mbr_err2 : 'Error loading operating system'
  2651 00001280 EB12                    		jmp	short mbr8 ; Write/Display error message and hang!
  2652                                  mbr6:
  2653                                  		; If Boot Sector offset 510 does not contain a 0AA55h (signature)
  2654                                  		; it is not a valid boot sector (code).
  2655 00001282 813EFE7D55AA            		cmp	word [7DFEh],0AA55h
  2656 00001288 7507                    		jnz	short mbr7
  2657                                  			; Valid (DOS) boot sector code, let's run it.
  2658 0000128A 89FE                    		mov	si,di
  2659 0000128C EA007C0000              		jmp	0:7C00h ; Jump to start address of the loaded boot sector
  2660                                  mbr7:
  2661 00001291 BE8506                  		mov	si,_685h ; mbr_err1 : 'Missing operating system'	
  2662                                  mbr8: 		; Write Error Message
  2663 00001294 2E                      		cs
  2664 00001295 AC                      		lodsb	
  2665 00001296 08C0                    		or	al,al
  2666 00001298 7406                    		jz	short mbr9
  2667 0000129A B40E                    		mov	ah,0Eh
  2668 0000129C CD10                    		int	10h	; - VIDEO - WRITE CHARACTER AND	ADVANCE	CURSOR (TTY WRITE)
  2669                                  				; AL = character, BH = display page (alpha modes)
  2670                                  				; BL = foreground color	(graphics modes)
  2671 0000129E EBF4                    		jmp	short mbr8
  2672                                  mbr9:
  2673 000012A0 FB                      		sti	; Enable interrupts during the infinitive loop
  2674                                  mbr10:
  2675 000012A1 EBFE                    		jmp	short mbr10  ; hang! infinive loop till restart/reset
  2676                                  ; ----------------------------------------------------------------------------
  2677                                  mbr_err:
  2678 000012A3 4D697373696E67206F-     mbr_err1:	db	'Missing operating system',0
  2679 000012AC 7065726174696E6720-
  2680 000012B5 73797374656D00     
  2681 000012BC 4572726F72206C6F61-     mbr_err2:	db	'Error loading operating system',0
  2682 000012C5 64696E67206F706572-
  2683 000012CE 6174696E6720737973-
  2684 000012D7 74656D00           
  2685 000012DB 496E76616C69642070-     mbr_err3:	db	'Invalid partition table',0
  2686 000012E4 6172746974696F6E20-
  2687 000012ED 7461626C6500       
  2688 000012F3 417574686F72202D20-     mbr_author:	db	'Author - Siegmar Schmidt',0  ; 1983 ? (writer of this MBR)
  2689 000012FC 536965676D61722053-
  2690 00001305 63686D69647400     
  2691                                  		;times	110h db 0
  2692 0000130C 00<rept>                		times	(MBR+510)-$ db 0
  2693 0000141C 55AA                    		dw	0AA55h
  2694                                  ;end_of_file:
  2695 0000141E A101                    		dw	01A1h ; The signature by Erdogan Tan
  2696 00001420 E207                    end_of_file:	dw	2018  ; Year 2018, Istanbul, Turkiye	
