     1                                  ; ****************************************************************************
     2                                  ; EPFORMAT.ASM (EPFORMAT.COM) - Retro DOS v4 Hard Disk Formatting Utility
     3                                  ; (RDEPFORM.S - RDEPFORM.COM)
     4                                  ; ----------------------------------------------------------------------------
     5                                  ; Extended DOS Partition (FAT File System) Format Utility for Retro DOS v4 OS.
     6                                  ; ----------------------------------------------------------------------------
     7                                  ; Last Update: 15/07/2024 (Previous: 04/05/2024)
     8                                  ; ----------------------------------------------------------------------------
     9                                  ; Beginning: 28/10/2023
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Assembler: NASM version 2.15 (rdepform.s)
    12                                  ; ----------------------------------------------------------------------------
    13                                  ; Modified from 'epformat.s'(EPFORMAT.COM) source code by Erdogan Tan
    14                                  ; (28/10/2023) - TRDOS 386 hard disk extended partition formatting utility -
    15                                  ; ----------------------------------------------------------------------------
    16                                  ; Derived from TRDOS Operating System v2.0 (80386) source code by Erdogan Tan
    17                                  ; hdformat.s (14/09/2020)
    18                                  ; ****************************************************************************
    19                                  ; Copyright (C) 2020-2024  Erdogan TAN 
    20                                  ; ****************************************************************************
    21                                  ; assembling: nasm epformat.s -l epformat.lst -o EPFORMAT.COM -Z error.txt
    22                                  
    23                                  ; Note: Only for formatting logical DOS drives in extended DOS partitions.
    24                                  
    25                                  ; ----------------------------------------------------------------------------
    26                                  ; equations
    27                                  ; ----------------------------------------------------------------------------
    28                                  
    29                                  ; boot sector parameters
    30                                  
    31                                  bsOemName	equ 3
    32                                  bsBytesPerSec	equ 11 ; 512 (word)
    33                                  bsSecPerClust	equ 13
    34                                  bsResSectors	equ 14
    35                                  bsFATs		equ 16
    36                                  bsRootDirEnts	equ 17
    37                                  bsSectors	equ 19
    38                                  bsMedia		equ 21
    39                                  bsFATsecs	equ 22
    40                                  bsSecPerTrack	equ 24 ; 18 (word)
    41                                  bsHeads		equ 26 ; 2 (word)
    42                                  bsHidden1	equ 28
    43                                  bsHidden2	equ 30
    44                                  bsHugeSectors	equ 32
    45                                  bsDriveNumber	equ 36
    46                                  bsReserved1	equ 37
    47                                  bsBpbSignature	equ 38 ; 29h (byte)
    48                                  bsVolumeID	equ 39
    49                                  bsVolumeLabel	equ 43
    50                                  bsFileSysType	equ 54 ; 'FAT12   '  (8 bytes)
    51                                  ;
    52                                  bsReserved2	equ 62
    53                                  ; TRDOS 386 v2.0 2018 Extensions
    54                                  bsDataStart	equ 64
    55                                  bsRootDirStart	equ 66
    56                                  bsRootDirSects	equ 68
    57                                  bsDirEntsPerSec equ 70
    58                                  
    59                                  ; FAT32 bs
    60                                  BPB_FATSz32	equ 36
    61                                  BPB_ExtFlags	equ 40
    62                                  BPB_FSVer	equ 42
    63                                  BPB_RootClus	equ 44
    64                                  BPB_FSInfo	equ 48
    65                                  BPB_BkBootSec	equ 50
    66                                  BPB_Reserved	equ 52
    67                                  BS_DrvNum	equ 64	; 80h
    68                                  BS_Reserved1	equ 65
    69                                  BS_BootSig	equ 66	; 29h (byte)
    70                                  BS_VolID	equ 67
    71                                  BS_VolLab	equ 71
    72                                  BS_FilSysType	equ 82	; 'FAT32   '  (8 bytes) 
    73                                  
    74                                  ; Masterboot / Partition Table at Beginning+1BEh
    75                                  ptBootable      equ 0
    76                                  ptBeginHead     equ 1
    77                                  ptBeginSector   equ 2
    78                                  ptBeginCylinder equ 3
    79                                  ptFileSystemID	equ 4
    80                                  ptEndHead       equ 5
    81                                  ptEndSector     equ 6
    82                                  ptEndCylinder   equ 7
    83                                  ptStartSector   equ 8
    84                                  ptSectors       equ 12
    85                                  
    86                                  partition_table equ 1BEh
    87                                  
    88                                  ; ----------------------------------------------------------------------------
    89                                  ; code
    90                                  ; ----------------------------------------------------------------------------
    91                                  
    92                                  [BITS 16]
    93                                  [ORG 100h]
    94                                  
    95 00000000 FA                      	cli
    96 00000001 FC                      	cld
    97 00000002 0E                      	push	cs
    98 00000003 17                      	pop	ss
    99 00000004 BCFEFF                  	mov	sp, 0FFFEh
   100 00000007 FB                      	sti
   101                                  
   102                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   103                                  ; see if drive specified
   104                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   105                                  
   106 00000008 BE8000                  	mov	si, 80h			; PSP command tail
   107 0000000B 8A0C                    	mov	cl, [si]
   108 0000000D 08C9                    	or	cl, cl
   109 0000000F 7424                    	jz	short T_3		; jump if zero
   110                                  T_1:
   111 00000011 46                      	inc	si
   112                                  
   113 00000012 8A04                    	mov	al, [si]
   114 00000014 3C20                    	cmp	al, ' '			; is it SPACE ?
   115 00000016 7506                    	jne	short T_2
   116                                  
   117 00000018 FEC9                    	dec	cl
   118 0000001A 75F5                    	jnz	short T_1
   119 0000001C EB17                    	jmp	short T_3
   120                                  T_2:
   121 0000001E 46                      	inc	si
   122                                  
   123 0000001F 3C68                    	cmp	al, 'h'
   124 00000021 7512                    	jne	short T_3
   125 00000023 803C64                  	cmp	byte [si], 'd'
   126 00000026 750D                    	jne	short T_3
   127 00000028 46                      	inc	si
   128 00000029 8A04                    	mov	al, [si]
   129 0000002B 3C30                    	cmp	al, '0'
   130 0000002D 740F                    	je	short T_4
   131 0000002F 7204                    	jb	short T_3
   132 00000031 3C33                    	cmp	al, '3'
   133 00000033 7609                    	jna	short T_4
   134                                  
   135                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   136                                  ; Write message
   137                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   138                                  
   139                                  T_3:
   140 00000035 BE[7015]                	mov	si, RD_Welcome
   141 00000038 E85B03                  	call	print_msg
   142                                  	;cmp	cl, 0
   143                                          ;ja	short T_44
   144 0000003B E94103                  	jmp	T_44
   145                                  
   146                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   147                                  ; get drive code
   148                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   149                                  
   150                                  T_4:
   151 0000003E 46                      	inc	si
   152 0000003F 803C20                  	cmp	byte [si], ' '
   153 00000042 77F1                    	ja	short T_3
   154                                  
   155                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   156                                  ; get drive parameters
   157                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   158                                  
   159 00000044 A2[EE17]                	mov	[RD_Drive], al	; '0' .. '3'
   160                                  
   161 00000047 A2[1F19]                	mov	[drv_str], al
   162                                  
   163 0000004A B408                    	mov	ah, 08h
   164 0000004C 88C2                    	mov	dl, al
   165 0000004E 80C250                  	add	dl, 80h -'0'		; make it 80h based 
   166 00000051 8816[6915]              	mov	[drv], dl
   167 00000055 CD13                    	int	13h			; return disk parameters
   168                                  
   169 00000057 0E                      	push	cs
   170 00000058 07                      	pop	es			; restore es
   171                                  
   172 00000059 08E4                    	or	ah, ah
   173 0000005B 7542                    	jnz	short T_6		; error
   174                                  	
   175 0000005D 88C8                    	mov	al, cl
   176 0000005F 243F                    	and	al, 63
   177 00000061 A2[6A15]                	mov	[sectors], al
   178 00000064 C0E906                  	shr	cl, 6 
   179 00000067 86E9                    	xchg	ch, cl
   180 00000069 41                      	inc	cx
   181 0000006A 890E[6E15]              	mov	[cylinders], cx
   182 0000006E FEC6                    	inc	dh
   183 00000070 8836[6C15]              	mov	[heads], dh
   184 00000074 F6E6                    	mul	dh
   185                                  		; ax = heads * spt
   186 00000076 A3[1E20]                	mov	[csize], ax
   187 00000079 F7E1                    	mul	cx ; * cylinders
   188                                  		; dx:ax = chs limit
   189 0000007B A3[E818]                	mov	[CHS_limit], ax
   190 0000007E 8916[EA18]              	mov	[CHS_limit+2], dx
   191                                  
   192                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   193                                  ; read MBR
   194                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   195                                  
   196                                  	; check for (valid) extended dos partition
   197                                  
   198                                  	;mov	byte [RetryCount], 4
   199 00000082 BF0500                  	mov	di, 5
   200                                  
   201                                  	;mov	ax, 0201h		; read disk
   202 00000085 BB[2820]                	mov	bx, MBR			; location of masterboot code
   203                                  
   204 00000088 B90100                  	mov	cx, 1			; cylinder = 0
   205                                  					; sector = 1
   206 0000008B B600                    	mov	dh, 0			; head = 0
   207                                  	;mov	dl, [RD_Drive]	; drive 
   208                                  	;add	dl, 80h -'0'		; make it 80h based 
   209 0000008D 8A16[6915]              	mov	dl, [drv]
   210                                  T_5:
   211 00000091 B80102                  	mov	ax, 0201h
   212 00000094 CD13                    	int	13h
   213                                  	;jc	short T_46
   214 00000096 7312                    	jnc	short T_7		; read masterboot sector, OK
   215                                  	
   216                                   	; reset hard disk(s)
   217 00000098 30E4                    	xor	ah, ah
   218                                  	;mov	dl, [drv]
   219 0000009A CD13                    	int	13h
   220                                  
   221                                  	;dec	byte [RetryCount]
   222 0000009C 4F                      	dec	di
   223 0000009D 75F2                    	jnz	short T_5
   224                                  
   225                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   226                                  ; write disk error message and terminate
   227                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   228                                  
   229                                  T_6:
   230 0000009F C606[1418]00            	mov	byte [zbyte], 0 ; message without (Y/N) question 
   231                                  
   232 000000A4 E8EC02                  	call	T_46			; write error message
   233 000000A7 E9D502                  	jmp	T_44 			; terminate
   234                                  
   235                                  T_7:
   236 000000AA 813E[2622]55AA          	cmp	word [MBR+510], 0AA55h
   237 000000B0 75ED                            jne	short T_6
   238                                  
   239 000000B2 BE[EA21]                	mov	si, MBR+(partition_table+ptFileSystemID)
   240                                  T_8:
   241 000000B5 E80E03                  	call	validate_extended_dos_partition
   242 000000B8 730F                    	jnc	short T_10	
   243                                   
   244 000000BA 83C610                  	add	si, 16
   245 000000BD 81FE[2A22]              	cmp	si, MBR+partition_table+ptFileSystemID+64
   246 000000C1 72F2                    	jb	short T_8
   247                                  T_9:
   248 000000C3 BE[A318]                	mov	si, RD_fatp_notfound
   249                                  	;call	print_msg
   250                                  	;jmp	T_44
   251 000000C6 E95F02                  	jmp	T_40
   252                                  T_10:
   253                                  	; AL = EP type (05h or 0Fh)
   254 000000C9 3C0F                    	cmp	al, 0Fh
   255 000000CB 7604                    	jna	short T_11
   256 000000CD FE06[6815]              	inc	byte [lba]
   257                                  T_11: 
   258 000000D1 A1[6822]                	mov	ax, [EP_Start]
   259 000000D4 8B16[6A22]              	mov	dx, [EP_Start+2]
   260                                  T_12:
   261 000000D8 A3[6C22]                	mov	[EP_Start_x], ax
   262 000000DB 8916[6E22]              	mov	[EP_Start_x+2], dx
   263                                  T_13:
   264 000000DF BB[2820]                	mov	bx, bootsector
   265 000000E2 E8B503                  	call	read_hd_sector
   266 000000E5 7309                    	jnc	short T_14
   267                                  	
   268 000000E7 803E[A218]00            	cmp	byte [ldd_count], 0
   269 000000EC 7771                    	ja	short T_18
   270 000000EE EBAF                    	jmp	short T_6
   271                                  T_14:
   272 000000F0 813E[2622]55AA          	cmp	word [bootsector+510], 0AA55h 
   273 000000F6 7409                            je	short T_15
   274                                  
   275 000000F8 803E[A218]00            	cmp	byte [ldd_count], 0
   276 000000FD 7760                    	ja	short T_18	
   277 000000FF EBC2                    	jmp	short T_9 ; there is not a valid extd dos part.
   278                                  T_15:
   279 00000101 BE[EA21]                	mov	si, bootsector+(partition_table+ptFileSystemID)
   280 00000104 E8DA02                  	call	validate_dos_partition
   281 00000107 730D                    	jnc	short T_16
   282                                  
   283 00000109 803E[A218]00            	cmp	byte [ldd_count], 0
   284 0000010E 774F                    	ja	short T_18
   285                                  
   286 00000110 BE[7B18]                	mov	si, RD_ep_ldd_defect ; not a logical dos drive
   287 00000113 E91202                  	jmp	T_40
   288                                  
   289                                  T_16:
   290 00000116 FE06[A218]              	inc	byte [ldd_count]
   291 0000011A 83EE04                  	sub	si, ptFileSystemID
   292 0000011D A1[6C22]                	mov	ax, [EP_Start_x]
   293 00000120 8B16[6E22]              	mov	dx, [EP_Start_x+2]
   294 00000124 014408                  	add	[si+ptStartSector], ax
   295 00000127 11540A                  	adc	[si+ptStartSector+2], dx
   296                                  
   297 0000012A 8B3E[1A20]              	mov	di, [lddt_ptr]
   298 0000012E B90800                  	mov	cx, 8
   299 00000131 F3A5                    	rep 	movsw
   300                                  
   301 00000133 8A4C04                  	mov	cl, [si+ptFileSystemID]
   302 00000136 80F905                  	cmp	cl, 05h
   303 00000139 7409                    	je	short T_17
   304 0000013B 80F90F                  	cmp	cl, 0Fh
   305 0000013E 751F                    	jne	short T_18 ; there is not a next logical dos drive
   306 00000140 FE06[6815]              	inc	byte [lba] ; LBA type disk r/w
   307                                  T_17:
   308 00000144 803E[A218]03            	cmp	byte [ldd_count], 3
   309 00000149 7714                    	ja	short T_18  ; max. 4 logical dos drive
   310 0000014B 893E[1A20]              	mov	[lddt_ptr], di
   311 0000014F A1[6822]                	mov	ax, [EP_Start]
   312 00000152 8B16[6A22]              	mov	dx, [EP_Start+2]
   313 00000156 034408                  	add	ax, [si+ptStartSector]
   314 00000159 13540A                  	adc	dx, [si+ptStartSector+2]
   315 0000015C E979FF                  	jmp	T_12
   316                                  
   317                                  T_18:
   318 0000015F BE[EC18]                	mov	si, ldd_table
   319 00000162 E83102                  	call	print_msg
   320                                  
   321 00000165 30FF                    	xor	bh, bh
   322                                  
   323 00000167 B301                    	mov	bl, 1
   324 00000169 E89502                  	call	fill_ldd_row
   325 0000016C BE[BC19]                	mov	si, ldd_row
   326 0000016F E82402                  	call	print_msg
   327 00000172 B302                    	mov	bl, 2 
   328 00000174 381E[A218]              	cmp	[ldd_count], bl  ; 2
   329 00000178 722B                    	jb	short T_19 ; direct question (only one ldd)
   330 0000017A E88402                  	call	fill_ldd_row
   331 0000017D BE[BC19]                	mov	si, ldd_row
   332 00000180 E81302                  	call	print_msg
   333 00000183 B303                    	mov	bl, 3 
   334 00000185 381E[A218]              	cmp	[ldd_count], bl  ; 3
   335 00000189 721A                    	jb	short T_19 ; select menu
   336 0000018B E87302                  	call	fill_ldd_row
   337 0000018E BE[BC19]                	mov	si, ldd_row
   338 00000191 E80202                  	call	print_msg
   339 00000194 B304                    	mov	bl, 4
   340 00000196 381E[A218]              	cmp	[ldd_count], bl  ; 4
   341 0000019A 7209                    	jb	short T_19 ; select menu
   342 0000019C E86202                  	call	fill_ldd_row
   343 0000019F BE[BC19]                	mov	si, ldd_row
   344 000001A2 E8F101                  	call	print_msg
   345                                  
   346                                  T_19:
   347 000001A5 BE[E619]                	mov	si, ldd_dline  ; print bottom line
   348 000001A8 E8EB01                  	call	print_msg
   349                                  
   350 000001AB 803E[A218]01            	cmp	byte [ldd_count], 1
   351 000001B0 7705                    	ja	short T_20
   352                                  
   353                                  	; the first logical dos partition in extended dos partition
   354 000001B2 BB[2822]                	mov	bx, lddt  ; start of logical dos drives
   355                                  			  ; (dos partitiona) table
   356                                  	
   357 000001B5 EB4C                    	jmp	short T_25	; pass select menu
   358                                  T_20:
   359 000001B7 A0[A218]                	mov	al, [ldd_count]
   360 000001BA 0430                    	add	al, '0'
   361 000001BC A2[3A1A]                	mov	[ldd_select_pn], al ; last logical dos drive number
   362                                  
   363                                  T_21:
   364 000001BF BE[101A]                	mov	si, ldd_select_msg
   365 000001C2 E8D101                  	call	print_msg
   366                                  	
   367                                  T_22:
   368 000001C5 31C0                    	xor	ax, ax
   369 000001C7 CD16                    	int	16h			; wait for keyboard command
   370                                  	
   371 000001C9 3C1B                    	cmp	al, 27 ; ESC key
   372 000001CB 0F84B001                	je	T_44 ; CRLF and Exit
   373                                  
   374 000001CF 3C20                    	cmp	al, 32 ; SPACE key (or control keys or CR key etc.)
   375 000001D1 7711                    	ja	short T_24
   376 000001D3 7404                    	je	short T_23
   377                                  
   378 000001D5 3C0D                    	cmp	al, 13 ; CR/ENTER key
   379 000001D7 75EC                    	jne	short T_22  ; don't beep
   380                                  
   381                                  	; Beeper
   382                                  T_23:	
   383 000001D9 B007                    	mov	al, 07h  ; beep
   384 000001DB B40E                    	mov	ah, 0Eh
   385 000001DD BB0700                  	mov	bx, 07h
   386 000001E0 CD10                    	int	10h
   387                                  	
   388 000001E2 EBE1                    	jmp	short T_22
   389                                  
   390                                  T_24:
   391 000001E4 8A26[A218]              	mov	ah, [ldd_count]
   392 000001E8 80C430                  	add	ah, '0'
   393 000001EB 3C31                    	cmp	al, '1'
   394 000001ED 72D0                    	jb	short T_21
   395 000001EF 38E0                    	cmp	al, ah
   396 000001F1 77CC                    	ja	short T_21
   397                                  	
   398 000001F3 A2[E717]                	mov	[RD_ldn], al
   399                                  
   400 000001F6 2C31                    	sub	al, '1'
   401 000001F8 C0E004                  	shl	al, 4 ; * 16
   402 000001FB 88C3                    	mov	bl, al
   403 000001FD 30FF                    	xor	bh, bh
   404 000001FF 81C3[2822]              	add	bx, lddt ; logical dos drive (partition) table
   405                                  T_25:
   406 00000203 891E[9022]              	mov	[lddt_save], bx
   407 00000207 B401                    	mov	ah, 1
   408 00000209 8A4704                  	mov	al, [bx+ptFileSystemID]  ; Partition ID
   409 0000020C 38E0                    	cmp	al, ah  ; 1 ; FAT12 file system
   410 0000020E 760E                    	jna	short T_26	
   411 00000210 FEC4                    	inc	ah  ; 2
   412 00000212 3C06                    	cmp	al, 6	; FAT 16 file system (>32MB)
   413 00000214 7408                    	je	short T_26
   414 00000216 7206                    	jb	short T_26 ; 4 ; FAT16 file sytem (<=32MB)
   415 00000218 3C0E                    	cmp	al, 0Eh
   416 0000021A 7402                    	je	short T_26 ; FAT16 LBA file sytem (>32MB)
   417 0000021C FEC4                    	inc	ah ; 3
   418                                  	; FAT32 CHS or FAT 32 LBA file system
   419                                  T_26:
   420 0000021E 8826[D618]              	mov	byte [fattype], ah
   421 00000222 A2[1C20]                	mov	[fsID], al
   422                                  
   423 00000225 80FC02                  	cmp	ah, 2
   424 00000228 7421                    	je	short T_29 ; FAT16 BS (default offset addr)
   425 0000022A 7214                    	jb	short T_28
   426                                  	; set format code pointer to FAT32 format code
   427 0000022C C706[640D][3205]        	mov	word [trdos386fc], format_FAT32_fs
   428                                  	; set FS type string
   429 00000232 C706[9917]3332          	mov	word [fattype_str],'32'	; 'FAT32'
   430                                  	; ok.. read boot sector
   431 00000238 EB11                    	jmp	short T_29
   432                                  
   433                                  T_27:
   434                                  	; Partition size defect 
   435                                  	; (less than the minimum number of sectors required)
   436 0000023A BE[2718]                	mov	si, RD_psize_defect
   437                                  	;call	print_msg
   438                                  	;jmp	T_44
   439 0000023D E9E800                  	jmp	T_40
   440                                  
   441                                  T_28:
   442                                  	; set format code pointer to FAT12 format code
   443 00000240 C706[640D][F30A]        	mov	word [trdos386fc], format_FAT12_fs
   444 00000246 C606[9A17]32            	mov	byte [fattype_str+1],'2' ; 'FAT12'
   445                                  
   446                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   447                                  ; read primary dos partition's boot sector
   448                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   449                                  
   450                                  T_29:	
   451                                  	;mov	byte [RetryCount], 5
   452                                  
   453 0000024B 8B36[9022]              	mov	si, [lddt_save] ; pt row for logical dos drive
   454                                  
   455 0000024F 8B4408                  	mov	ax, [si+ptStartSector]
   456 00000252 8B540A                  	mov	dx, [si+ptStartSector+2]
   457 00000255 A3[2020]                	mov	[dosp_start], ax
   458 00000258 8916[2220]              	mov	[dosp_start+2], dx
   459 0000025C 8B4C0C                  	mov	cx, [si+ptSectors]
   460 0000025F 8B5C0E                  	mov	bx, [si+ptSectors+2]
   461 00000262 890E[2420]              	mov	[dosp_size], cx
   462 00000266 891E[2620]              	mov	[dosp_size+2], bx
   463                                  
   464                                  	; check minimum partition size
   465 0000026A 803E[D618]03            	cmp	byte [fattype], 3 ;  FAT32 FS
   466 0000026F 730C                    	jnb	short T_31 ; yes
   467                                  T_30:
   468 00000271 09DB                    	or	bx, bx
   469 00000273 7515                    	jnz	short T_32
   470                                  
   471 00000275 3B0E[1E20]              	cmp	cx, [csize] ; sectors per cylinder
   472 00000279 730F                    	jnb	short T_32
   473 0000027B EBBD                    	jmp	short T_27
   474                                  T_31:
   475 0000027D 83FB01                  	cmp	bx, 1 ; >= 32MB ?
   476 00000280 7708                    	ja	short T_32
   477 00000282 72B6                    	jb	short T_27
   478                                  
   479 00000284 81F91504                	cmp	cx, 0415h  ; must be >= 66581 sectors
   480 00000288 72B0                    	jb	short T_27
   481                                  T_32:
   482 0000028A 01C1                    	add	cx, ax
   483 0000028C 11D3                    	adc	bx, dx
   484 0000028E 0F820DFE                	jc	T_6
   485                                  
   486 00000292 3B1E[EA18]              	cmp	bx, [CHS_limit+2]
   487 00000296 BB[2820]                	mov	bx, bootsector
   488 00000299 7711                    	ja	short T_34 ; LBA read/write
   489 0000029B 7206                    	jb	short T_33
   490 0000029D 3B0E[E818]              	cmp	cx, [CHS_limit]
   491 000002A1 7709                    	ja	short T_34
   492                                  T_33:
   493                                  	; CHS read
   494                                  
   495                                  	;mov	ax, [dosp_start]
   496                                  	;mov	dx, [dosp_start+2]
   497                                  
   498 000002A3 E8FB01                  	call	read_chs_sector
   499 000002A6 0F82F5FD                	jc	T_6
   500 000002AA EB0C                    	jmp	short T_35
   501                                  T_34:
   502 000002AC C606[6815]01            	mov	byte [lba], 1 ; LBA r/w is required
   503                                  
   504                                  	;mov	ax, [dosp_start]
   505                                  	;mov	dx, [dosp_start+2]
   506                                  	
   507 000002B1 E83B02                  	call	read_lba_sector
   508 000002B4 0F82E7FD                	jc	T_6
   509                                  T_35:
   510 000002B8 813E[2622]55AA          	cmp	word [bootsector+510], 0AA55h
   511 000002BE 7558                    	jne	short T_38
   512                                  
   513 000002C0 813E[3320]0002          	cmp	word [bootsector+bsBytesPerSec], 512
   514 000002C6 7550                    	jne	short T_38
   515                                  
   516                                  	; 04/05/2024 (BugFix)
   517 000002C8 803E[3D20]F8            	cmp	byte [bootsector+bsMedia], 0F8h
   518 000002CD 7549                    	jne	short T_38
   519                                  
   520 000002CF 803E[D618]02            	cmp	byte [fattype], 2
   521 000002D4 7722                    	ja	short T_37
   522                                  
   523 000002D6 803E[4E20]29            	cmp	byte [bootsector+bsBpbSignature], 29h
   524 000002DB 753B                    	jne	short T_38
   525 000002DD 66813E[5E20]464154-     	cmp	dword [bootsector+bsFileSysType], 'FAT1'
   525 000002E5 31                 
   526 000002E6 7530                    	jne	short T_38
   527                                  
   528 000002E8 A0[6220]                	mov	al, [bootsector+bsFileSysType+4]
   529 000002EB 3C36                    	cmp	al, '6'
   530 000002ED 7404                    	je	short T_36
   531                                  
   532 000002EF 3C32                    	cmp	al, '2'
   533 000002F1 7525                    	jne	short T_38
   534                                  
   535                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   536                                  ; format question (and warning msg)
   537                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   538                                  
   539                                  T_36:
   540 000002F3 BE[0417]                	mov	si, RD_Format_warning ; warning is required
   541 000002F6 EB23                    	jmp	short T_39
   542                                  T_37:
   543                                  	; 04/05/2024
   544 000002F8 833E[3E20]00            	cmp	word [bootsector+bsFATsecs], 0
   545 000002FD 7719                    	ja	short T_38	; not FAT32 fs
   546                                  
   547 000002FF 803E[6A20]29            	cmp	byte [bootsector+BS_BootSig], 29h
   548 00000304 7512                    	jne	short T_38
   549 00000306 66813E[7A20]464154-     	cmp	dword [bootsector+BS_FilSysType], 'FAT3'
   549 0000030E 33                 
   550 0000030F 7507                    	jne	short T_38
   551 00000311 803E[7E20]32            	cmp	byte [bootsector+BS_FilSysType+4], '2'
   552 00000316 74DB                    	je	short T_36
   553                                  T_38:
   554 00000318 BE[5A17]                	mov	si, RD_Do_you_want ; no need to warning
   555                                  T_39:
   556 0000031B E87800                  	call	print_msg
   557                                  
   558 0000031E E88400                  	call	get_answer
   559 00000321 3C59                    	cmp	al, 'Y'
   560 00000323 7408                    	je	short T_41
   561                                  
   562 00000325 BE[AF17]                	mov	si, _no_str
   563                                  T_40:
   564 00000328 E86B00                  	call	print_msg
   565                                  
   566 0000032B EB52                    	jmp	short T_44
   567                                  T_41:
   568 0000032D BE[A817]                	mov	si, _yes_str
   569 00000330 E86300                  	call	print_msg
   570                                  
   571 00000333 BE[BD17]                	mov	si, RD_PressKeyWhenReady
   572 00000336 E85D00                  	call	print_msg
   573                                  T_42:
   574 00000339 31C0                    	xor	ax, ax
   575 0000033B CD16                    	int	16h			; wait for keyboard command
   576 0000033D 3C0D                    	cmp	al, 'M'-40h		; Enter (OK) key
   577                                  	;je	short T_43		; write
   578 0000033F 740A                    	je	short T_49 ; 28/10/2023
   579 00000341 3C03                    	cmp	al, 'C'-40h
   580 00000343 743A                    	je	short T_44		; no write (exit)
   581 00000345 3C1B                    	cmp	al, 27
   582 00000347 7436                    	je	short T_44
   583 00000349 EBEE                    	jmp	short T_42
   584                                  
   585                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   586                                  ; clear fat buffer and start formatting
   587                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   588                                  
   589                                  	; 28/10/2023
   590                                  T_49:
   591 0000034B 803E[D618]03            	cmp	byte [fattype], 3 ; FAT32  ?
   592 00000350 750E                    	jne	short T_43
   593                                  
   594                                  	; Temporary FAT32 note for Retro DOS v4
   595                                  	; (This code will be removed when the Retro DOS v5
   596                                  	;  FAT32 boot sector code will be ready.)" ; 28/10/2023
   597                                  
   598 00000352 BE[001B]                	mov	si, FAT32_note
   599 00000355 E83E00                  	call	print_msg
   600 00000358 30E4                    	xor	ah, ah
   601 0000035A CD16                    	int	16h	
   602 0000035C 3C0D                    	cmp	al, 'M'-40h ; Enter (OK) key
   603 0000035E 751F                    	jne	short T_44
   604                                  T_43:
   605 00000360 BE[BA17]                	mov	si, RD_CRLF
   606 00000363 E83000                  	call	print_msg
   607                                  
   608                                  	; Clear buffer in BSS 
   609 00000366 BF[2820]                	mov	di, HDFORMAT_FATBUFFER
   610 00000369 31C0                    	xor	ax, ax
   611 0000036B B90001                  	mov	cx, 256
   612 0000036E F3AB                    	rep	stosw
   613                                  
   614                                  	; Clear volume name field
   615 00000370 BF[8422]                	mov	di, StrVolumeName
   616 00000373 B10C                    	mov	cl, 12
   617 00000375 F3AA                    	rep	stosb
   618                                  
   619 00000377 8A16[1C20]              	mov	dl, [fsID] ; Partition ID
   620                                  
   621 0000037B FF26[640D]              	jmp	word [trdos386fc]
   622                                  
   623                                  T_44:
   624 0000037F BE[BA17]                	mov	si, RD_CRLF
   625                                  Exit:
   626 00000382 E81100                  	call	print_msg
   627 00000385 B8004C                  	mov	ax, 4C00h		; terminate
   628 00000388 CD21                    	int	21h
   629                                  T_45:
   630 0000038A E81800                  	call	get_answer
   631 0000038D 3C59                    	cmp	al, 'Y'
   632 0000038F 74CF                    	je	short T_43
   633 00000391 EBEC                    	jmp	short T_44
   634                                  
   635                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   636                                  ; disk r/w error or disk not ready
   637                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   638                                  
   639                                  T_46:
   640 00000393 BE[F217]                	mov	si, RD_disk_NotReadyOrError
   641                                  	;;call	print_msg
   642                                  	;;jmp	short T_45
   643                                  	;jmp	short print_msg
   644                                  
   645                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   646                                  ; print message
   647                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   648                                  
   649                                  print_msg:
   650                                  T_47:
   651 00000396 AC                      	lodsb				; Load byte at DS:SI to AL
   652 00000397 20C0                    	and	al, al
   653 00000399 7409                    	jz	short T_48
   654 0000039B B40E                    	mov	ah, 0Eh
   655 0000039D BB0700                  	mov	bx, 07h
   656 000003A0 CD10                    	int	10h			; BIOS Service func ( ah ) = 0Eh
   657                                  					; Write char as TTY
   658                                  					; AL-char BH-page BL-color
   659 000003A2 EBF2                    	jmp     short T_47
   660                                  T_48:
   661                                  _NO_:
   662 000003A4 C3                      	retn
   663                                  
   664                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   665                                  ; Yes/No
   666                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   667                                  
   668                                  get_answer:
   669 000003A5 31C0                    	xor	ax, ax
   670 000003A7 CD16                    	int	16h			; wait for keyboard command
   671 000003A9 3C79                    	cmp	al, 'y'
   672 000003AB 7416                    	je	short _yes		; retry
   673 000003AD 3C59                    	cmp	al, 'Y'
   674 000003AF 7414                    	je	short _YES_
   675 000003B1 3C6E                    	cmp	al, 'n'
   676 000003B3 74EF                    	je	short _NO_ 		; exit
   677 000003B5 3C4E                    	cmp	al, 'N'
   678 000003B7 74EB                    	je	short _NO_
   679 000003B9 3C03                    	cmp	al, 'C'-40h
   680 000003BB 74E7                    	je	short _NO_
   681 000003BD 3C1B                    	cmp	al, 27
   682 000003BF 74E3                    	je	short _NO_
   683 000003C1 EBE2                    	jmp	short get_answer
   684                                  _yes:
   685 000003C3 B059                    	mov	al, 'Y'
   686                                  _YES_:
   687 000003C5 C3                      	retn
   688                                  
   689                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   690                                  ; get and set partition type for formatting
   691                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   692                                  
   693                                  validate_extended_dos_partition:
   694                                  	
   695                                  	; INPUT:
   696                                  	;   si = partition table entry offset + file system ID
   697                                  	; OUTPUT:
   698                                  	;   cf = 0 -> al = extended DOS partition ID
   699                                  	;			 (05h,0Fh)
   700                                  	;	      ;ah = 0
   701                                  	;
   702                                  	;	[EP_Start] is set
   703                                  	;
   704                                  	;   cf = 1 -> not an extended DOS partition
   705                                  	;
   706                                  	; Modified registers: ax, cx
   707                                  
   708                                  	;sub	ah, ah ; mov ah, 0
   709                                  
   710 000003C6 8A04                    	mov 	al, [si]
   711                                  
   712 000003C8 3C05                    	cmp	al, 05h	; Extended DOS partition (CHS)
   713 000003CA 7406                    	je	short VEP_clc
   714                                  	
   715 000003CC 3C0F                    	cmp	al, 0Fh	; Extended DOS partition (CHS)
   716 000003CE 7402                    	je	short VEP_clc
   717                                  VEP_stc:
   718 000003D0 F9                      	stc
   719 000003D1 C3                      	retn
   720                                  VEP_clc:
   721 000003D2 8B4C04                  	mov	cx, [si+ptStartSector-ptFileSystemID]
   722 000003D5 890E[6822]              	mov	[EP_Start], cx
   723 000003D9 8B4C06                  	mov	cx, [si+2+ptStartSector-ptFileSystemID]
   724 000003DC 890E[6A22]              	mov	[EP_Start+2], cx
   725                                  	;mov	cx, [si+2+ptSectors-ptFileSystemID]
   726                                  	;mov	[EP_Size+2], cx
   727                                  	;mov	cx, [si+ptSectors-ptFileSystemID]
   728                                  	;mov	[EP_Size], cx
   729 000003E0 C3                      	retn 
   730                                  
   731                                  validate_dos_partition:
   732                                  	
   733                                  	; INPUT:
   734                                  	;   si = partition table entry, partition ID offset
   735                                  	; OUTPUT:
   736                                  	;   cf = 0 -> al = primary DOS partition ID
   737                                  	;			 (01h,04h,06h,0Bh,0Ch,0Eh)
   738                                  	;
   739                                  	;   cf = 1 -> not a primary DOS partition
   740                                  
   741 000003E1 8A04                    	mov 	al, [si]
   742                                  
   743 000003E3 3C01                    	cmp	al, 01h	; FAT12 partition
   744 000003E5 7613                    	jna	short V_2
   745                                  
   746 000003E7 3C06                    	cmp 	al, 06h ; FAT16 CHS partition (>=32MB)
   747 000003E9 7707                    	ja	short V_1
   748 000003EB 740D                    	je	short V_2
   749                                  
   750 000003ED 3C04                    	cmp	al, 04h	; FAT16 CHS partition (< 32MB)
   751 000003EF 770E                    	ja	short V_4
   752 000003F1 C3                      	retn
   753                                  V_1:
   754 000003F2 3C0C                    	cmp	al, 0Ch	; FAT32 LBA partition
   755 000003F4 7404                    	je	short V_2
   756 000003F6 7703                    	ja	short V_3
   757                                  
   758 000003F8 3C0B                    	cmp	al, 0Bh	; FAT32 CHS partition 
   759                                  V_2:
   760 000003FA C3                      	retn 
   761                                  V_3:
   762 000003FB 3C0E                    	cmp	al, 0Eh	; FAT16 LBA partition
   763 000003FD 74FB                    	je	short V_2
   764                                  V_4:
   765 000003FF F9                      	stc
   766 00000400 C3                      	retn
   767                                  
   768                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   769                                  ; preparing text row for logical dos drive
   770                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   771                                  
   772                                  fill_ldd_row:
   773                                  	; bl = selected logical drive number
   774                                  	; bh = 0
   775                                  
   776                                  	;xor	bh, bh
   777                                  	
   778 00000401 88D8                    	mov	al, bl
   779 00000403 0430                    	add	al, '0'
   780 00000405 A2[CD19]                	mov	[ldd_row_dn], al
   781 00000408 FECB                    	dec	bl
   782 0000040A 7403                    	jz	short flddtr_0
   783 0000040C C0E304                  	shl	bl, 4 ; * 16
   784                                  flddtr_0:
   785 0000040F 81C3[2822]              	add	bx, lddt
   786 00000413 8A4704                  	mov	al, [bx+ptFileSystemID]
   787 00000416 3C01                    	cmp 	al, 1
   788 00000418 7508                    	jne	short flddtr_1
   789 0000041A C706[D419]3132          	mov	word [ldd_row_fs], "12"
   790 00000420 EB16                    	jmp	short flddtr_4
   791                                  flddtr_1:
   792 00000422 3C06                    	cmp	al, 06h
   793 00000424 7700                    	ja	short flddtr_2
   794                                  flddtr_2:
   795 00000426 C706[D419]3136          	mov	word [ldd_row_fs], "16"
   796 0000042C EB0A                    	jmp	short flddtr_4
   797                                  flddtr_3:
   798 0000042E 3C0E                    	cmp	al, 0Eh
   799 00000430 75F4                    	jne	short flddtr_2
   800                                  	; al = 0Bh or 0Ch
   801 00000432 C706[D419]3332          	mov	word [ldd_row_fs], "32"
   802                                  flddtr_4:
   803 00000438 8B470C                  	mov	ax, [bx+ptSectors]
   804 0000043B 8B570E                  	mov	dx, [bx+ptSectors+2]
   805 0000043E 81FA0001                	cmp	dx, 100h ; 8GB limit
   806 00000442 720D                    	jb	short flddtr_6 ; display size as MB or KB
   807                                  flddtr_5:
   808 00000444 89D0                    	mov	ax, dx
   809 00000446 C1E805                  	shr	ax, 5 ; / 32
   810                                  	; GB
   811 00000449 E83400                  	call	convert_to_decimal
   812 0000044C B84742                  	mov	ax, 'GB'
   813 0000044F EB26                    	jmp	short flddtr_9
   814                                  flddtr_6:
   815 00000451 09D2                    	or	dx, dx
   816 00000453 750F                    	jnz	short flddtr_7 ; MB
   817 00000455 3D0008                  	cmp	ax, 2048
   818 00000458 7312                    	jnb	short flddtr_8 ; MB
   819 0000045A D1E8                    	shr	ax, 1 ; / 2
   820                                  	; KB
   821 0000045C E82100                  	call	convert_to_decimal
   822                                  	; di points to unit location
   823 0000045F B84B42                  	mov	ax, 'KB'
   824 00000462 EB13                    	jmp	short flddtr_9
   825                                  flddtr_7:
   826 00000464 F6C21F                  	test	dl, 1Fh ; flat ? 
   827 00000467 74DB                    	jz	short flddtr_5
   828 00000469 C1E205                  	shl	dx, 5  ; convert GB to MB
   829                                  flddtr_8:
   830 0000046C C1E80B                  	shr	ax, 11 ; / 2048
   831 0000046F 09D0                    	or	ax, dx ; MB
   832                                  	; MB
   833 00000471 E80C00                  	call	convert_to_decimal
   834 00000474 B84D42                  	mov	ax, 'MB'
   835                                  flddtr_9:
   836 00000477 AB                      	stosw	; volume size unit (KB,MB,GB)
   837                                  	 ;CRLF
   838 00000478 B80D0A                  	mov	ax, 0A0Dh ; al = 0Dh, ah = 0Ah
   839 0000047B AB                      	stosw
   840 0000047C 28C0                    	sub al, al ; 0
   841 0000047E AA                      	stosb
   842 0000047F C3                      	retn
   843                                  
   844                                  convert_to_decimal:
   845 00000480 89E5                    	mov	bp, sp
   846 00000482 B90A00                  	mov	cx, 10
   847                                  cvd_loop1:
   848 00000485 31D2                    	xor	dx, dx
   849 00000487 F7F1                    	div	cx
   850 00000489 52                      	push	dx
   851 0000048A 09C0                    	or	ax, ax
   852 0000048C 75F7                    	jnz	short cvd_loop1
   853 0000048E BF[DB19]                	mov	di, ldd_row_sz
   854                                  cvd_loop2:
   855 00000491 58                      	pop	ax
   856 00000492 0430                    	add	al, '0'
   857 00000494 AA                      	stosb
   858 00000495 39EC                    	cmp	sp, bp
   859 00000497 75F8                    	jne	short cvd_loop2
   860                                  
   861                                  	; di points to unit location
   862 00000499 C3                      	retn
   863                                  
   864                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   865                                  ; disk read
   866                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   867                                  
   868                                  read_hd_sector:
   869 0000049A 803E[6815]00            	cmp	byte [lba], 0
   870 0000049F 774E                    	ja	short  read_lba_sector
   871                                  
   872                                  read_chs_sector:
   873                                  	; Derived from 'proc_write_chs_sector' in HDFORMAT.ASM (30/07/2011)
   874                                  	; (TRDOS v1, Singlix FS formatting utility)
   875 000004A1 C606[1D20]02            	mov	byte [rw], 2 ; read
   876 000004A6 EB05                    	jmp	short chs_rw
   877                                  
   878                                  write_chs_sector:
   879                                  	; Derived from 'proc_write_chs_sector' in HDFORMAT.ASM (30/07/2011)
   880                                  	; (TRDOS v1, Singlix FS formatting utility)
   881 000004A8 C606[1D20]03            	mov	byte [rw], 3 ; write
   882                                  	;jmp	short chs_rw
   883                                  chs_rw:
   884 000004AD 56                      	push	si
   885 000004AE 51                              push	cx
   886                                  chs_rw_0:
   887 000004AF BF0500                  	mov	di, 5
   888                                  chs_rw_1:
   889 000004B2 52                      	push	dx	; Linear sector #
   890 000004B3 50                      	push	ax	; DX_AX = Linear address (sectors)
   891 000004B4 8B0E[6A15]              	mov	cx, [sectors]
   892 000004B8 53                      	push	bx
   893                                  
   894 000004B9 E86C08                  	call    div32	; 32 bit divide
   895                                  
   896 000004BC 89D9                    	mov	cx, bx	; Sector (zero based)
   897 000004BE 41                      	inc	cx	; To make it 1 based
   898 000004BF 51                      	push	cx
   899 000004C0 8B0E[6C15]              	mov     cx, [heads]
   900 000004C4 E86108                  	call	div32	; Convert track to head & cyl
   901 000004C7 88DE                    	mov	dh, bl	; BX = Head (max. FFh)
   902 000004C9 59                      	pop	cx	; AX=Cyl, DH=Head, CX=Sector
   903 000004CA 5B                      	pop     bx	; ES:BX = Buffer
   904                                  
   905 000004CB 8A16[6915]              	mov	dl, [drv]
   906 000004CF 88C5                    	mov	ch, al
   907 000004D1 D0CC                    	ror	ah, 1	; Rotate right
   908 000004D3 D0CC                    	ror	ah, 1
   909 000004D5 08E1                    	or	cl, ah
   910                                  chs_rw_2:
   911 000004D7 8A26[1D20]              	mov	ah, [rw] ; 02h = read, 03h = write
   912 000004DB B001                    	mov	al, 01h
   913 000004DD CD13                    	int	13h	; BIOS Service func (ah) = 2/3
   914                                  			; Read/Write disk sectors
   915                                  			; AL-sec num CH-track CL-sec
   916                                  			; DH-head DL-drive ES:BX-buffer
   917                                  			; CF-flag AH-status AL-sectors written/read
   918                                  			; If CF = 1 then AH = Error code (>0) 
   919                                          
   920                                  	;mov	[error], ah
   921 000004DF 7309                    	jnc     short chs_rw_3
   922 000004E1 4F                      	dec	di
   923 000004E2 7406                    	jz	short chs_rw_3 
   924                                          
   925 000004E4 30E4                    	xor	ah, ah
   926                                  	;mov	dl, [drv]
   927 000004E6 CD13                    	int	13h	; BIOS Service func (ah) = 0
   928                                  			; Reset disk system
   929 000004E8 EBED                    	jmp	short chs_rw_2
   930                                  
   931                                  chs_rw_3:
   932 000004EA 58                      	pop	ax
   933 000004EB 5A                      	pop	dx
   934 000004EC 59                      	pop	cx
   935 000004ED 5E                      	pop	si
   936 000004EE C3                      	retn		; db 0C3h
   937                                  
   938                                  read_lba_sector:
   939                                  	; trhdboot.s (2020), hdformat.asm (2011)
   940 000004EF C606[1D20]42            	mov	byte [rw], 42h
   941 000004F4 EB0C                    	jmp	short lba_rw
   942                                  
   943                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   944                                  ; disk write
   945                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
   946                                  
   947                                  write_hd_sector:
   948 000004F6 803E[6815]00            	cmp	byte [lba], 0
   949 000004FB 76AB                    	jna	short  write_chs_sector
   950                                  
   951                                  write_lba_sector:
   952                                  	; trhdboot.s (2020), hdformat.asm (2011)
   953 000004FD C606[1D20]43            	mov	byte [rw], 43h
   954                                  	;jmp	short lba_rw
   955                                  lba_rw:
   956 00000502 BF0500                  	mov	di, 5
   957                                  lba_rw_1:
   958                                  	;pusha				; db 60h
   959 00000505 60                      	db	60h
   960                                  	;push 	0                       ; db 6Ah, 00h
   961 00000506 6A00                    	db	6Ah, 0
   962                                  	;push	0                       ; db 6Ah, 00h
   963 00000508 6A00                    	db	6Ah, 0
   964 0000050A 52                      	push    dx
   965 0000050B 50                      	push    ax
   966 0000050C 06                      	push    es
   967 0000050D 53                      	push    bx
   968                                  	;push	1			; db 6Ah, 01h
   969 0000050E 6A01                    	db	6Ah, 01h                     
   970                                  	;push	10h                     ; db 6Ah, 10h
   971 00000510 6A10                    	db	6Ah, 10h
   972                                  
   973 00000512 89E6                    	mov     si, sp
   974 00000514 8A16[6915]              	mov     dl, [drv]
   975 00000518 30C0                    	xor	al, al	; verify off 
   976                                  lba_rw_2:
   977 0000051A 8A26[1D20]              	mov     ah, [rw] ; 42h = LBA read, 43h = LBA write
   978                                  	;xor	al, al	; verify off 
   979 0000051E CD13                    	int     13h
   980                                  
   981                                  	;mov	[error], ah
   982 00000520 730D                    	jnc     short lba_rw_3
   983                                  
   984 00000522 4F                      	dec	di
   985 00000523 740A                    	jz	short lba_rw_3 
   986                                          
   987 00000525 30E4                    	xor	ah, ah
   988                                  	;mov	dl, [drv]
   989 00000527 CD13                    	int	13h	; BIOS Service func (ah) = 0
   990                                  			; Reset disk system
   991                                  
   992                                  	;mov	word [si+2], 1 ; set r/w count to 1 again
   993 00000529 C6440201                	mov	byte [si+2], 1
   994                                  
   995 0000052D EBEB                    	jmp	short lba_rw_2
   996                                  
   997                                  lba_rw_3:
   998                                  	;popa
   999 0000052F 61                      	db	61h
  1000                                  	;popa
  1001 00000530 61                      	db	61h
  1002 00000531 C3                      	retn
  1003                                  
  1004                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1005                                  ; FAT32 FORMATTING
  1006                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1007                                  
  1008                                  ; ((TRDOS 386 criter))
  1009                                  ; Minimum size of FAT32 FS = 65525 + 512 + 512 + 32
  1010                                  ; >= 66581 sectors (or >= 65525 data clusters)
  1011                                  	
  1012                                  format_FAT32_fs:
  1013                                  	;mov	ax, 000Ch ; db 0Ch, 00h ; 'or al, 0'
  1014                                  	;cmp	dl, al ; 0Ch
  1015                                  	;je	short FAT32_lba_format
  1016                                  	;mov	ax, 0C00Bh ; db 0Bh, 0C0h ; 'or ax, ax'
  1017                                  ;FAT32_lba_format:
  1018                                  	; Put TRDOS 386 FAT32 partition magic word 
  1019                                  	; at offset 5Ah, in TRDOS386 FAT32 boot sector 0.
  1020 00000532 BD[680D]                	mov	bp, RD_FAT32_hd_bs
  1021 00000535 8D7E03                  	lea	di, [bp+3]
  1022 00000538 BE[721A]                	mov	si, bs_oem_name
  1023 0000053B B90400                  	mov	cx, 4
  1024 0000053E F3A5                    	rep	movsw
  1025                                  	;mov	[bp+5Ah], ax	; [loc_5A]
  1026 00000540 C7465A0BC0              	mov	word [bp+5Ah], 0C00Bh
  1027 00000545 A1[6A15]                	mov	ax, [sectors]
  1028 00000548 894618                  	mov	[bp+18h], ax	; [BPB_SecPerTrk]
  1029 0000054B A1[6C15]                	mov	ax, [heads]
  1030 0000054E 89461A                  	mov	[bp+1Ah], ax	; [BPB_NumHeads]
  1031 00000551 A1[2020]                	mov	ax, [dosp_start]
  1032 00000554 89461C                  	mov	[bp+1Ch], ax	; [BPB_HiddSec]
  1033 00000557 A1[2220]                	mov	ax, [dosp_start+2]
  1034 0000055A 89461E                  	mov	[bp+1Eh], ax	; [BPB_HiddSec+2]
  1035 0000055D A1[2420]                	mov	ax, [dosp_size]
  1036 00000560 894620                  	mov	[bp+20h], ax	; [BPB_TotSec32]
  1037 00000563 8B16[2620]              	mov	dx, [dosp_size+2]
  1038 00000567 895622                  	mov	[bp+22h], dx	; [BPB_TotSec32+2]
  1039                                  	
  1040                                  	; Sectors per cluster calculation
  1041                                  	; (According to MS FAT32 FS specification.)
  1042 0000056A B108                    	mov	cl, 8  ; 8 sectors per cluster
  1043 0000056C 83FA08                  	cmp	dx, 8  ; >= 532480 sectors
  1044 0000056F 7709                    	ja	short FAT32_f_2 ; 8 sectors per cluster
  1045 00000571 7205                    	jb	short FAT32_f_1 ; 1 sector per cluster
  1046 00000573 3D0020                  	cmp	ax, 2000h ; dx_ax = (8*65536)+8192
  1047 00000576 7302                    	jnb	short FAT32_f_2
  1048                                  FAT32_f_1:
  1049 00000578 B101                    	mov	cl, 1	; 1 sector per cluster
  1050                                  FAT32_f_2:
  1051 0000057A 884E0D                  	mov	[bp+0Dh], cl	 ; [BPB_SecPerClus]
  1052                                  	;mov	byte [bp+10h], 2 ; [BPB_NumFATs] 
  1053                                  	;mov	word [bp+0Eh], 32 ; [BPB_RsvdSecCnt]
  1054                                  
  1055                                  	; Calculating FAT size in sectors
  1056                                  	; (According to MS FAT32 FS Specification, 2000)
  1057                                  
  1058                                  	; DX_AX = partition (volume) size in sectors
  1059 0000057D 2B460E                  	sub	ax, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 32
  1060 00000580 83DA00                  	sbb	dx, 0
  1061                                  		; TmpVal1 = DiskSize - (BPB_ResvdSecCnt +
  1062                                  		;	     		RootDirsectors)
  1063                                  		; RootDirSectors = 0 (for FAT32 FS)
  1064 00000583 89CB                    	mov	bx, cx ; ch = 0
  1065 00000585 C1E308                  	shl	bx, 8 ; * 256
  1066 00000588 8A4E10                  	mov	cl, [bp+10h] ; [BPB_NumFATs]
  1067 0000058B 01CB                    	add	bx, cx	
  1068                                  		; TmpVal2 = (256*BPB_SecPerClus)+BPB_NumFATs
  1069 0000058D D1EB                    	shr	bx, 1
  1070                                  		; TmpVal2 = TmpVal2/2
  1071 0000058F 89D9                    	mov	cx, bx
  1072 00000591 4B                      	dec	bx  ; TmpVal2-1
  1073 00000592 01D8                    	add	ax, bx
  1074 00000594 83D200                  	adc	dx, 0
  1075 00000597 E88E07                  	call	div32
  1076                                  		; FATSz = (TmpVal1+(TmpVal2-1))/TmpVal2
  1077                                  	; DX_AX = FAT size in sectors
  1078 0000059A 894624                  	mov	[bp+24h], ax	; [BPB_FATSz32]
  1079 0000059D 895626                  	mov	[bp+26h], dx	; [BPB_FATSz32+2]
  1080                                  	; * 2
  1081 000005A0 89D3                    	mov	bx, dx
  1082 000005A2 01C0                    	add	ax, ax
  1083 000005A4 11D3                    	adc	bx, dx
  1084                                  	; BX_AX = [BPB_NumFATs] * [BPB_FATSz32]
  1085 000005A6 8B4E0E                  	mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 32
  1086 000005A9 01C1                    	add	cx, ax
  1087 000005AB 83D300                  	adc	bx, 0
  1088                                  	; BX_CX = [BPB_RsvdSecCnt]+[BPB_NumFATs]*[BPB_FATSz32]
  1089 000005AE 8B4620                  	mov	ax, [bp+20h]	; [BPB_TotSec32]
  1090 000005B1 8B5622                  	mov	dx, [bp+22h]	; [BPB_TotSec32+2]
  1091 000005B4 29C8                    	sub	ax, cx
  1092 000005B6 19DA                    	sbb	dx, bx
  1093 000005B8 890E[7022]              	mov	[data_start], cx
  1094 000005BC 891E[7222]              	mov	[data_start+2], bx
  1095                                  	; DX_AX = Data sectors
  1096 000005C0 A3[7422]                	mov	[data_sectors], ax
  1097 000005C3 8916[7622]              	mov	[data_sectors+2], dx
  1098 000005C7 8A4E0D                  	mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  1099 000005CA 30ED                    	xor	ch, ch
  1100 000005CC E85907                  	call	div32 ; DX_AX/CX
  1101                                  	; DX_AX = Count of clusters (rounded down)
  1102 000005CF A3[7822]                	mov	[cluster_count], ax
  1103 000005D2 8916[7A22]              	mov	[cluster_count+2], dx
  1104                                  		
  1105 000005D6 8D7E47                  	lea	di, [bp+71] ; [BS_VolLab]
  1106 000005D9 E89B01                  	call	write_volume_name
  1107 000005DC 8D7643                  	lea	si, [bp+67] ; [BS_VolID]
  1108 000005DF E8F401                  	call	write_volume_serial
  1109 000005E2 E8F402                  	call	write_cluster_count
  1110                                  
  1111 000005E5 E87502                  	call	write_formatting_msg
  1112 000005E8 B000                    	mov	al, 0
  1113 000005EA E8CD02                  	call	write_format_percent_x
  1114                                  
  1115 000005ED 8B461C                  	mov	ax, [bp+1Ch]	; [BPB_HiddSec]
  1116 000005F0 8B561E                  	mov	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  1117 000005F3 0106[7022]              	add	[data_start], ax
  1118 000005F7 1116[7222]              	adc	[data_start+2], dx
  1119                                  FAT32_f_3:
  1120                                  	; DX_AX = FAT32 Boot Sector address
  1121 000005FB BB[680D]                	mov	bx, RD_FAT32_hd_bs
  1122                                  	; ES:BX = Boot Sector 1 Buffer
  1123 000005FE E8F5FE                  	call	write_hd_sector
  1124 00000601 0F82BC02                	jc	formatting_error
  1125 00000605 E87902                  	call	write_format_percent
  1126 00000608 83C001                  	add	ax, 1
  1127 0000060B 83D200                  	adc	dx, 0
  1128 0000060E BB[1A1E]                	mov	bx, HDFORMAT_FSINFO_BUFF
  1129                                  	; ES:BX = FS INFO Sector Buffer (= BS+1)
  1130 00000611 E8E2FE                  	call	write_hd_sector
  1131 00000614 0F82A902                	jc	formatting_error
  1132 00000618 E86602                  	call	write_format_percent
  1133 0000061B 83C001                  	add	ax, 1
  1134 0000061E 83D200                  	adc	dx, 0	
  1135 00000621 BB[680F]                	mov	bx, RD_FAT32_hd_bs + 512
  1136                                  	; ES:BX = Boot Sector 2 Buffer
  1137 00000624 E8CFFE                  	call	write_hd_sector
  1138 00000627 0F829602                	jc	formatting_error
  1139 0000062B E85302                  	call	write_format_percent
  1140 0000062E B90300                  	mov	cx, 3
  1141                                  FAT32_f_4:
  1142 00000631 51                      	push	cx
  1143 00000632 83C001                  	add	ax, 1
  1144 00000635 83D200                  	adc	dx, 0
  1145 00000638 BB[2820]                	mov	bx, HDFORMAT_EMPTY_BUFF
  1146 0000063B E8B8FE                  	call	write_hd_sector
  1147 0000063E 0F827F02                	jc	formatting_error
  1148 00000642 E83C02                  	call	write_format_percent
  1149 00000645 59                      	pop	cx
  1150 00000646 FEC9                    	dec	cl
  1151 00000648 75E7                    	jnz	short FAT32_f_4
  1152 0000064A 83C001                  	add	ax, 1
  1153 0000064D 83D200                  	adc	dx, 0
  1154 00000650 8B4E1C                  	mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  1155 00000653 8B5E1E                  	mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  1156 00000656 83C10C                  	add	cx, 12
  1157 00000659 83D300                  	adc	bx, 0
  1158                                  	; write BACKUP sectors
  1159                                  	; (6,7,8 boot+fsi and 9,10,11 empty sectors)
  1160 0000065C 39DA                    	cmp	dx, bx
  1161 0000065E 729B                    	jb	short FAT32_f_3
  1162 00000660 39C8                    	cmp	ax, cx
  1163 00000662 7297                    	jb	short FAT32_f_3
  1164                                  	; write remain part of reserved sectors
  1165 00000664 8B4E0E                  	mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt]
  1166 00000667 83E90C                  	sub	cx, 12
  1167 0000066A 7618                    	jna	short FAT32_f_6
  1168                                  FAT32_f_5:
  1169 0000066C 51                      	push	cx
  1170 0000066D BB[2820]                	mov	bx, HDFORMAT_EMPTY_BUFF
  1171 00000670 E883FE                  	call	write_hd_sector
  1172 00000673 0F824A02                	jc	formatting_error
  1173 00000677 E80702                  	call	write_format_percent
  1174 0000067A 83C001                  	add	ax, 1
  1175 0000067D 83D200                  	adc	dx, 0
  1176 00000680 59                      	pop	cx
  1177 00000681 49                      	dec	cx
  1178 00000682 75E8                    	jnz	short FAT32_f_5
  1179                                  FAT32_f_6:
  1180                                  	; write FAT sectors
  1181 00000684 8B0E[7022]              	mov	cx, [data_start] ; lba/abs addr
  1182 00000688 8B1E[7222]              	mov	bx, [data_start+2] ; lba/abs addr
  1183 0000068C 53                      	push	bx
  1184 0000068D 51                      	push	cx
  1185 0000068E BB[2820]                	mov	bx, HDFORMAT_FATBUFFER
  1186                                  	; ES:BX = FAT Sector Buffer
  1187 00000691 8A4E15                  	mov	cl, [bp+15h] ; [BPB_Media]
  1188 00000694 B5FF                    	mov	ch, 0FFh
  1189 00000696 890F                    	mov	[bx], cx
  1190 00000698 88E9                    	mov	cl, ch ; cx = 0FFFFh
  1191 0000069A 894F02                  	mov	[bx+2], cx
  1192 0000069D 894F04                  	mov	[bx+4], cx
  1193 000006A0 894F06                  	mov	[bx+6], cx
  1194                                  	; Root dir cluster number = 2
  1195                                  	; 0FFFFFFFh = end of cluster chain
  1196 000006A3 894F08                  	mov	[bx+8], cx  ; 0FFFFh
  1197 000006A6 80E50F                  	and	ch, 0Fh
  1198 000006A9 894F0A                  	mov	[bx+10], cx ; 0FFFh
  1199                                  	;inc	cx
  1200 000006AC E847FE                  	call	write_hd_sector
  1201 000006AF 0F820E02                	jc	formatting_error
  1202 000006B3 E8CB01                  	call	write_format_percent
  1203                                  	;mov	bx, HDFORMAT_FATBUFFER
  1204 000006B6 B90000                  	mov	cx, 0
  1205 000006B9 890F                    	mov	[bx], cx
  1206 000006BB 894F02                  	mov	[bx+2], cx
  1207 000006BE 894F04                  	mov	[bx+4], cx
  1208 000006C1 894F06                  	mov	[bx+6], cx
  1209 000006C4 894F08                  	mov	[bx+8], cx
  1210 000006C7 894F0A                  	mov	[bx+10], cx
  1211 000006CA EB0F                    	jmp	short FAT32_f_8
  1212                                  FAT32_f_7:	
  1213 000006CC 53                      	push	bx
  1214 000006CD 51                      	push	cx
  1215 000006CE BB[2820]                	mov	bx, HDFORMAT_FATBUFFER
  1216 000006D1 E822FE                  	call	write_hd_sector
  1217 000006D4 0F82E901                	jc	formatting_error
  1218 000006D8 E8A601                  	call	write_format_percent
  1219                                  FAT32_f_8:	
  1220 000006DB 59                      	pop	cx
  1221 000006DC 5B                      	pop	bx
  1222 000006DD 83C001                  	add	ax, 1
  1223 000006E0 83D200                  	adc	dx, 0
  1224 000006E3 39DA                    	cmp	dx, bx
  1225 000006E5 72E5                    	jb	short FAT32_f_7
  1226 000006E7 39C8                    	cmp	ax, cx
  1227 000006E9 72E1                    	jb	short FAT32_f_7
  1228                                  
  1229                                  	; write	root directory (1st cluster)
  1230                                  	; as empty sectors
  1231 000006EB 8A4E0D                  	mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  1232 000006EE 30ED                    	xor	ch, ch
  1233 000006F0 290E[7422]              	sub	[data_sectors], cx
  1234 000006F4 831E[7622]00            	sbb	word [data_sectors+2], 0
  1235                                  FAT32_f_9:
  1236 000006F9 51                      	push	cx
  1237 000006FA BB[2820]                	mov	bx, HDFORMAT_EMPTY_BUFF
  1238 000006FD E8F6FD                  	call	write_hd_sector
  1239 00000700 0F82BD01                	jc	formatting_error
  1240 00000704 E87A01                  	call	write_format_percent
  1241 00000707 83C001                  	add	ax, 1
  1242 0000070A 83D200                  	adc	dx, 0
  1243 0000070D 59                      	pop	cx
  1244 0000070E FEC9                    	dec	cl
  1245 00000710 75E7                    	jnz	short FAT32_f_9
  1246                                  
  1247                                  	; write DATA sectors 
  1248                                  	; (after root directory 1st cluster)
  1249 00000712 8B0E[7422]              	mov	cx, [data_sectors]
  1250 00000716 8B1E[7622]              	mov	bx, [data_sectors+2]
  1251                                  			; NOTE: Partition size must be >= 512 MB
  1252                                  			;	for FAT32 FS  ((BX >= 15))
  1253                                  FAT32_f_10:	
  1254 0000071A 53                      	push	bx
  1255 0000071B 51                      	push	cx
  1256 0000071C BB[1A1C]                	mov	bx, HDFORMAT_SECBUFFER
  1257 0000071F E8D4FD                  	call	write_hd_sector
  1258 00000722 0F829B01                	jc	formatting_error
  1259 00000726 E85801                  	call	write_format_percent
  1260 00000729 59                      	pop	cx
  1261 0000072A 5B                      	pop	bx
  1262 0000072B 83C001                  	add	ax, 1
  1263 0000072E 83D200                  	adc	dx, 0
  1264 00000731 49                      	dec	cx
  1265 00000732 75E6                    	jnz	short FAT32_f_10
  1266 00000734 4B                      	dec	bx
  1267 00000735 75E3                    	jnz	short FAT32_f_10
  1268                                  
  1269                                  	; If there are, format remain sectors which are
  1270                                  	; at beyond of data clusters, with zero bytes.
  1271                                  	
  1272 00000737 8B4E1C                  	mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  1273 0000073A 8B5E1E                  	mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  1274                                  FAT16_f_18:	
  1275 0000073D 034E20                  	add	cx, [bp+20h]	; [BPB_TotSec32]
  1276 00000740 135E22                  	adc	bx, [bp+22h]	; [BPB_TotSec32+2]
  1277                                  FAT16_f_19:
  1278                                  FAT12_f_8:
  1279                                  	; are there remain sectors (in partition) ?
  1280 00000743 29C1                    	sub	cx, ax
  1281 00000745 19D3                    	sbb	bx, dx
  1282                                  	; 11/02/2019
  1283                                  	; BX must be 0 (Because, 1 cluster <= 32KB. So, 
  1284                                  	;	        remain sectors must not be more than 32K)
  1285 00000747 751C                    	jnz	short FAT32_f_12 ; There is a wrong thing !!!
  1286                                  				 ; If BX is not zero,	
  1287                                  				 ; it is better to skip this stage...)
  1288 00000749 09C9                    	or	cx, cx		
  1289 0000074B 7418                    	jz	short FAT32_f_12 ; no.. 
  1290                                  				 ; (good! FAT contains all data sectors)
  1291                                  FAT32_f_11:
  1292 0000074D 51                      	push	cx
  1293 0000074E BB[2820]                	mov	bx, HDFORMAT_EMPTY_BUFF
  1294 00000751 E8A2FD                  	call	write_hd_sector
  1295 00000754 0F826901                	jc	formatting_error
  1296 00000758 E82601                  	call	write_format_percent
  1297 0000075B 59                      	pop	cx
  1298 0000075C 83C001                  	add	ax, 1
  1299 0000075F 83D200                  	adc	dx, 0
  1300 00000762 49                      	dec	cx
  1301 00000763 75E8                    	jnz	short FAT32_f_11
  1302                                  
  1303                                  FAT32_f_12:
  1304                                  	; End of FAT format routine...
  1305                                  end_of_formatting:
  1306 00000765 B064                    	mov	al, 100
  1307 00000767 E85001                  	call	write_format_percent_x
  1308                                  	;mov	si, CRLF
  1309                                  	;call	print_msg
  1310 0000076A BE[B517]                	mov	si, _msg_OK
  1311                                  	;call	print_msg
  1312 0000076D E912FC                  	jmp	Exit
  1313                                  
  1314                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1315                                  ; set & write volume name
  1316                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1317                                  
  1318                                  write_fs_volume_name:
  1319 00000770 C606[711A]40            	mov	byte [vname_length], 64
  1320 00000775 EB05                    	jmp	short svn_fs
  1321                                  
  1322                                  write_volume_name:
  1323 00000777 C606[711A]0B            	mov	byte [vname_length], 11
  1324                                  svn_fs:
  1325                                  	; DI = (BS) Volume Label address
  1326 0000077C BE[881A]                	mov	si, Msg_Volume_Name
  1327 0000077F E814FC                  	call	print_msg
  1328                                  
  1329                                  	; get cursor position
  1330                                  	; bh = 0  ; video page
  1331 00000782 B403                    	mov     ah, 3 ; get cursor pos
  1332 00000784 CD10                    	int     10h
  1333 00000786 8916[E818]              	mov	[Cursor_Pos], dx
  1334                                  
  1335 0000078A E80905                  	call	rw_char
  1336 0000078D 7207                    	jc	short svn_1
  1337                                  svn_0:
  1338 0000078F AC                      	lodsb
  1339 00000790 3C20                    	cmp	al, 20h
  1340 00000792 7706                    	ja	short svn_2
  1341 00000794 74F9                    	je	short svn_0
  1342                                  svn_1:
  1343 00000796 BE[7C1A]                	mov	si, no_name
  1344 00000799 AC                      	lodsb
  1345                                  svn_2:
  1346                                  	;mov	di, [bp+47h) ; [BS_VolLab] ; FAT32
  1347                                  	;mov	di, [bp+2Bh) ; [BS_VolLab] ; FAT16 (&FAT12)
  1348 0000079A 89FB                    	mov	bx, di ; *
  1349 0000079C 30ED                    	xor	ch, ch
  1350 0000079E 8A0E[711A]              	mov	cl, [vname_length] ; 11
  1351 000007A2 EB05                    	jmp	short svn_4
  1352                                  svn_3:
  1353 000007A4 AC                      	lodsb
  1354 000007A5 3C20                    	cmp	al, 20h
  1355 000007A7 7226                    	jb	short svn_6
  1356                                  svn_4:
  1357 000007A9 AA                      	stosb
  1358 000007AA E2F8                    	loop	svn_3
  1359                                  svn_5:
  1360 000007AC 8A0E[711A]              	mov	cl, [vname_length] ; 11
  1361 000007B0 89DE                    	mov	si, bx ; *
  1362 000007B2 BF[8422]                	mov	di, StrVolumeName
  1363 000007B5 F3A4                    	rep	movsb
  1364                                  	;mov	byte [di], 0
  1365                                  
  1366 000007B7 8B16[E818]              	mov	dx, [Cursor_Pos]
  1367 000007BB BB0700                  	mov	bx, 7
  1368 000007BE B402                    	mov	ah, 2
  1369 000007C0 CD10                    	int	10h  ; Set Cursor Position
  1370                                  
  1371 000007C2 BE[8422]                	mov	si, StrVolumeName
  1372 000007C5 E8CEFB                  	call	print_msg
  1373 000007C8 BE[EA1A]                	mov	si, CRLF
  1374 000007CB E8C8FB                  	call	print_msg
  1375 000007CE C3                      	retn
  1376                                  svn_6:
  1377 000007CF B020                    	mov	al, 20h
  1378                                  svn_7:
  1379 000007D1 AA                      	stosb
  1380 000007D2 E2FD                    	loop	svn_7
  1381 000007D4 EBD6                    	jmp	short svn_5
  1382                                  
  1383                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1384                                  ; set & write volume serial number (volume ID)
  1385                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1386                                  
  1387                                  write_volume_serial:
  1388                                  	; SI = (BS) Volume Serial Number (binary) address
  1389                                  
  1390                                  	;xor	ax, ax
  1391                                  	;int	1Ah			; get time of day
  1392                                  
  1393                                  	;mov	[si], dx
  1394                                  	;mov	[si+2], cx		; set unique volume ID
  1395                                  
  1396                                  	;mov	ah, 02h			; Return Current Time
  1397                                  	;int	1Ah
  1398                                  	;xchg	ch, cl
  1399                                  	;xchg	dh, dl
  1400                                  
  1401                                  	;add	cx, dx
  1402                                  	;add	[si+2], cx
  1403                                                 
  1404                                  	;mov	ah, 04h			; Return Current Date
  1405                                  	;int	1Ah
  1406                                  
  1407                                  	;xchg	ch,cl
  1408                                  	;xchg	dh,dl
  1409                                  
  1410                                  	;add	cx, dx
  1411                                  	;add	[si+2], cx
  1412                                  
  1413                                  	; According to Microsoft DOS 6.0 serial number
  1414                                  	; production method...
  1415                                  	; < Create unique 32 bit serial number >
  1416                                  
  1417                                  	; Create_Serial_ID (MSDOS 6.0 Source code, MSFOR.ASM)
  1418                                  	; (20/04/1987)
  1419                                  	;
  1420                                  	;  Get date (INT 21h, AH=2Bh)
  1421                                  	;  Get time (INT 21h, AH=2Ch)
  1422                                  	;  Serial_ID+0 = DX reg date + DX reg time
  1423                                  	;  Serial_ID+2 = CX reg date + CX reg time
  1424                                  	;  Serial_Num_Low = Serial_ID+2
  1425                                  	;  Serial_Num_High = Serial_ID+0
  1426                                  
  1427 000007D6 B404                    	mov	ah, 04h		; Return Current Date
  1428 000007D8 CD1A                    	int	1Ah
  1429                                  
  1430                                  	; DL = Day (BCD)	(20h)
  1431                                  	; DH = Month (BCD)	(12h)
  1432                                  	; CH = Century (BCD)	(20h)
  1433                                  	; CL = Year (BCD) 	(17h)
  1434                                  
  1435 000007DA 88D0                    	mov	al, dl
  1436 000007DC E87100                  	call	bcd_to_bin
  1437 000007DF 88C2                    	mov	dl, al 
  1438 000007E1 88F0                    	mov	al, dh
  1439 000007E3 E86A00                  	call	bcd_to_bin
  1440 000007E6 88C6                    	mov	dh, al 
  1441 000007E8 88C8                    	mov	al, cl
  1442 000007EA E86300                  	call	bcd_to_bin
  1443 000007ED 88C1                    	mov	cl, al 
  1444 000007EF 88E8                    	mov	al, ch
  1445 000007F1 E85C00                  	call	bcd_to_bin
  1446 000007F4 88C5                    	mov	ch, al
  1447                                  
  1448                                  	; DH = Month (1-10)
  1449                                  	; DL = Day (1-31)
  1450                                  	; CX = Year (1900-2099)
  1451                                  
  1452 000007F6 52                      	push	dx 
  1453 000007F7 51                      	push	cx
  1454                                  
  1455 000007F8 B402                    	mov	ah, 02h		; Return Current Time
  1456 000007FA CD1A                    	int	1Ah
  1457                                  	
  1458                                  	; DH = Seconds (BCD)	(59h)
  1459                                  	; CL = Minutes (BCD)	(59h)
  1460                                  	; CH = Hours (BCD)	(23h)
  1461                                  	; DL = Daylight savings time option (1=yes)
  1462                                  
  1463 000007FC 88F0                    	mov	al, dh
  1464 000007FE E84F00                  	call	bcd_to_bin
  1465 00000801 88C6                    	mov	dh, al 
  1466 00000803 88C8                    	mov	al, cl
  1467 00000805 E84800                  	call	bcd_to_bin
  1468 00000808 88C1                    	mov	cl, al 
  1469 0000080A 88E8                    	mov	al, ch
  1470 0000080C E84100                  	call	bcd_to_bin
  1471 0000080F 88C5                    	mov	ch, al 
  1472                                  
  1473                                  	; CH = Hour (0-23)
  1474                                  	; CL = Minutes (0-59)
  1475                                  	; DH = Seconds (0-59)
  1476                                  	; ((DL = Hundredths (0-99) - MSDOS!))
  1477                                  	; DL = 0 or 1 (here!)
  1478                                  
  1479 00000811 89C8                    	mov	ax, cx
  1480 00000813 59                      	pop	cx
  1481 00000814 01C8                    	add	ax, cx
  1482                                  
  1483 00000816 894402                  	mov	[si+2], ax
  1484                                  
  1485 00000819 89D0                    	mov	ax, dx
  1486 0000081B 5A                      	pop	dx
  1487 0000081C 01D0                    	add	ax, dx
  1488                                  
  1489 0000081E 8904                    	mov	[si], ax
  1490                                  
  1491 00000820 30E4                    	xor	ah, ah		; Read time counter
  1492 00000822 CD1A                    	int	1Ah
  1493                                  
  1494                                  	; CX = High word of clock count
  1495                                  	; DX = Low word of clock count
  1496                                  	; AL = 0 if 24 hours has not passed, else 1
  1497                                  
  1498                                  	; NOTES: 
  1499                                  	; (Ref: vitaly_filatov.tripod.com/ng/asm/asT_3029.1.html)
  1500                                  	;
  1501                                     	; Following formulas convert the clock count to
  1502                                          ; the time of day:
  1503                                   	;	Hour      = Clock / 65543 (1007h)
  1504                                  	;	Remainder = Clock MOD 65543
  1505                                   	;
  1506                                  	;	Minutes   = Remainder / 1092 (444h)
  1507                                  	;	Remainder = Remainder MOD 1092
  1508                                  	;
  1509                                  	;	Second    = Remainder / 18.21
  1510                                  	;	Remainder = Remainder MOD 18.21
  1511                                  	;
  1512                                  	;	Hundredths = CINT(Remainder * 100)
  1513                                  
  1514 00000824 0014                    	add	[si], dl
  1515                                  
  1516                                  	; SI = Volume serial number address (4 bytes)
  1517 00000826 8A04                    	mov	al, [si]
  1518 00000828 E82205                  	call	bin_to_hex
  1519 0000082B A3[B31A]                	mov	[Vol_Serial2+2], ax
  1520 0000082E 8A4401                  	mov	al, [si+1]
  1521 00000831 E81905                  	call	bin_to_hex
  1522 00000834 A3[B11A]                	mov	[Vol_Serial2], ax
  1523 00000837 8A4402                  	mov	al, [si+2]
  1524 0000083A E81005                  	call	bin_to_hex
  1525 0000083D A3[AE1A]                	mov	[Vol_Serial1+2], ax
  1526 00000840 8A4403                  	mov	al, [si+3]
  1527 00000843 E80705                  	call	bin_to_hex
  1528 00000846 A3[AC1A]                	mov	[Vol_Serial1], ax
  1529                                  
  1530 00000849 BE[9A1A]                	mov	si, Msg_Volume_Serial
  1531 0000084C E847FB                  	call	print_msg
  1532                                  
  1533 0000084F C3                      	retn
  1534                                  
  1535                                  bcd_to_bin:
  1536 00000850 53                      	push	bx
  1537 00000851 D410                    	db	0D4h,10h  ; Undocumented inst. AAM
  1538                                  			  ; AH = AL / 10h
  1539                                  			  ; AL = AL MOD 10h
  1540 00000853 88C3                    	mov	bl, al
  1541 00000855 B00A                    	mov	al, 10
  1542 00000857 F6E4                    	mul	ah
  1543 00000859 00D8                    	add	al, bl
  1544 0000085B 5B                      	pop	bx
  1545 0000085C C3                      	retn
  1546                                  
  1547                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1548                                  ; write formatting percentage
  1549                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1550                                  
  1551                                  write_formatting_msg:
  1552 0000085D A1[2420]                	mov	ax, [dosp_size]
  1553 00000860 8B16[2620]              	mov	dx, [dosp_size+2]
  1554                                  
  1555                                  	; DX_AX = Total sectors for percentage
  1556 00000864 B96400                  	mov	cx, 100
  1557 00000867 E8BE04                  	call	div32
  1558 0000086A A3[7E22]                	mov	[format_percent], ax
  1559                                  
  1560 0000086D BE[D21A]                	mov	si, msg_formatting
  1561 00000870 E823FB                  	call	print_msg
  1562                                  
  1563                                  	; get cursor position
  1564                                  	; bh = 0  ; video page
  1565 00000873 B403                    	mov     ah, 3 ; get cursor pos
  1566 00000875 CD10                    	int     10h
  1567 00000877 8916[E818]              	mov	[Cursor_Pos], dx
  1568                                  
  1569 0000087B C606[8022]FF            	mov	byte [prev_percent], 255
  1570                                  
  1571 00000880 C3                      	retn
  1572                                  
  1573                                  write_format_percent:
  1574                                  	; DX_AX = Current sector (which has been written)
  1575                                  
  1576 00000881 50                      	push	ax
  1577 00000882 52                      	push	dx
  1578 00000883 53                      	push	bx
  1579 00000884 51                      	push	cx
  1580 00000885 56                      	push	si
  1581                                  
  1582 00000886 2B461C                  	sub	ax, [bp+1Ch]	; [BPB_HiddSec]
  1583 00000889 1B561E                  	sbb	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  1584                                  wpc_t:
  1585 0000088C 8B0E[7E22]              	mov	cx, [format_percent]
  1586 00000890 E89504                  	call	div32
  1587                                  	; AL = percentage value between 1 to 100
  1588                                  wpc_x:
  1589 00000893 3A06[8022]              	cmp	al, [prev_percent]
  1590 00000897 741B                    	je	short wpc_y
  1591 00000899 A2[8022]                	mov	[prev_percent], al
  1592 0000089C 8B16[E818]              	mov	dx, [Cursor_Pos]
  1593 000008A0 BB0700                  	mov	bx, 7
  1594 000008A3 B402                    	mov	ah, 2
  1595 000008A5 CD10                    	int	10h  ; Set Cursor Position
  1596 000008A7 31D2                    	xor	dx, dx
  1597 000008A9 30E4                    	xor	ah, ah
  1598                                  	;mov	al, [prev_percent]
  1599 000008AB BE[E01A]                	mov	si, format_percent_str + 2
  1600 000008AE E88504                  	call	bin_to_decimal
  1601 000008B1 E8E2FA                  	call	print_msg
  1602                                  wpc_y:
  1603 000008B4 5E                      	pop	si
  1604 000008B5 59                      	pop	cx
  1605 000008B6 5B                      	pop	bx
  1606 000008B7 5A                      	pop	dx
  1607 000008B8 58                      	pop	ax
  1608 000008B9 C3                      	retn
  1609                                  
  1610                                  write_format_percent_x:
  1611                                  	; AL = % number
  1612                                  
  1613 000008BA 50                      	push	ax
  1614 000008BB 52                      	push	dx
  1615 000008BC 53                      	push	bx
  1616 000008BD 51                      	push	cx
  1617 000008BE 56                      	push	si
  1618                                  
  1619 000008BF EBD2                    	jmp	short wpc_x
  1620                                  
  1621                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1622                                  ; format error 
  1623                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1624                                  
  1625                                  formatting_error:
  1626 000008C1 8B26[8222]              	mov	sp, [old_sp]
  1627                                  
  1628 000008C5 88E0                    	mov	al, ah ;  error code
  1629 000008C7 E88304                  	call	bin_to_hex
  1630 000008CA A3[F81A]                	mov 	[error_code], ax
  1631                                  
  1632 000008CD BE[EA1A]                	mov	si, CRLF
  1633 000008D0 E8C3FA                  	call	print_msg
  1634                                  
  1635 000008D3 BE[ED1A]                	mov	si, Msg_Error
  1636                                  	;call	print_msg
  1637 000008D6 E9A9FA                  	jmp	Exit
  1638                                  
  1639                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1640                                  ; write cluster count
  1641                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1642                                  
  1643                                  write_cluster_count:
  1644 000008D9 BE[B81A]                	mov	si, msg_cluster_count
  1645 000008DC E8B7FA                  	call	print_msg
  1646 000008DF A1[7822]                	mov	ax, [cluster_count]
  1647 000008E2 8B16[7A22]              	mov	dx, [cluster_count+2]
  1648 000008E6 BE[CE1A]                	mov	si, cluster_count_str+6
  1649 000008E9 E84A04                  	call	bin_to_decimal
  1650 000008EC E8A7FA                  	call	print_msg
  1651 000008EF C3                      	retn 
  1652                                  
  1653                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1654                                  ; FAT16 FORMATTING
  1655                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1656                                  
  1657                                  ; ((TRDOS 386 criter))
  1658                                  ; Minimum size of FAT16 FS = [heads]*[sectors]
  1659                                  ; (1 cylinder) or 4096 sectors (for TRDOS 386)
  1660                                  
  1661                                  format_FAT16_fs:
  1662                                  ; 04/05/2024 (BugFix)
  1663                                  ; DL = Partition (FS) ID
  1664                                  ;	mov	ax, 0706h ; db 06h, 07h ; 'push es, pop es'
  1665                                  ;	cmp	dl, al ; 06h ; Big CHS partition (>= 32MB)
  1666                                  ;	je	short FAT16_big_chs_format
  1667                                  ;	;mov	ax, 070Eh ; db 0Eh, 07h	; 'push cs, pop es'
  1668                                  ;	;cmp	dl, al ; 0Eh ; LBA partition
  1669                                  ;	;je	short FAT16_lba_format
  1670                                  ;FAT16_chs_format:  
  1671                                  ;	; Partition Type: 04h, CHS (<32 MB) partition
  1672                                  ;	mov	ax, 0004h ; db 04h, 00h ; 'add al, 0'
  1673                                  ;FAT16_big_chs_format:
  1674                                  ;;;
  1675                                  ;FAT16_lba_format:
  1676                                  	; Put TRDOS 386 FAT16 partition magic word 
  1677                                  	; at offset 3Eh, in TRDOS386 FAT16 boot sector.
  1678 000008F0 BD[6811]                	mov	bp, RD_FAT16_hd_bs
  1679 000008F3 8D7E03                  	lea	di, [bp+3]
  1680 000008F6 BE[721A]                	mov	si, bs_oem_name
  1681 000008F9 B90400                  	mov	cx, 4
  1682 000008FC F3A5                    	rep	movsw
  1683                                   
  1684                                  	;mov	[bp+3Eh], ax	; [loc_3E]
  1685                                  	; 04/05/2024 (BugFix)
  1686 000008FE 80FA06                  	cmp	dl, 6
  1687 00000901 7404                    	je	short FAT16_f_x ; skip ; db 'RDv5 FAT16 06h', 0
  1688                                  	; dl = 04h or 0Eh
  1689 00000903 8896CE01                	mov	[bp+1CEh], dl	; Retro DOS v5 boot sect off 1CEh
  1690                                  				; (see: 'rd5hdbs.txt' for 1CEh)
  1691                                  FAT16_f_x:
  1692 00000907 A1[6A15]                	mov	ax, [sectors]
  1693 0000090A 894618                  	mov	[bp+18h], ax	; [BPB_SecPerTrk]
  1694 0000090D A1[6C15]                	mov	ax, [heads]
  1695 00000910 89461A                  	mov	[bp+1Ah], ax	; [BPB_NumHeads]
  1696 00000913 A1[2020]                	mov	ax, [dosp_start]
  1697 00000916 89461C                  	mov	[bp+1Ch], ax	; [BPB_HiddSec]
  1698 00000919 A1[2220]                	mov	ax, [dosp_start+2]
  1699 0000091C 89461E                  	mov	[bp+1Eh], ax	; [BPB_HiddSec+2]
  1700 0000091F A1[2420]                	mov	ax, [dosp_size]
  1701 00000922 8B16[2620]              	mov	dx, [dosp_size+2]
  1702 00000926 21D2                    	and	dx, dx
  1703 00000928 7505                    	jnz	short FAT16_f_0
  1704 0000092A 894613                  	mov	[bp+13h], ax	; [BPB_TotSec16]
  1705                                  	; CX = 0
  1706                                  	;mov	[bp+20h], cx	; [BPB_TotSec32] =  0
  1707                                  	;mov	[bp+22h], cx	; [BPB_TotSec32+2] = 0
  1708 0000092D EB06                    	jmp	short FAT16_f_1
  1709                                  FAT16_f_0:
  1710 0000092F 894620                  	mov	[bp+20h], ax	; [BPB_TotSec32]
  1711 00000932 895622                  	mov	[bp+22h], dx	; [BPB_TotSec32+2]
  1712                                  	; CX = 0
  1713                                  	;mov	[bp+13h], cx ; [BPB_TotSec16] = 0
  1714                                  FAT16_f_1:
  1715                                  	; Sectors per cluster calculation
  1716                                  	; (According to MS FAT32 FS specification.)
  1717 00000935 B102                    	mov	cl, 2  ; 2 sectors per cluster
  1718 00000937 09D2                    	or	dx, dx
  1719 00000939 7507                    	jnz	short FAT16_f_2 ; >2 sectors (>16MB)
  1720 0000093B 3DA87F                  	cmp	ax, 32680
  1721 0000093E 763C                    	jna	short FAT16_f_10 ; 2 sectors, <=16MB
  1722                                  	; > 16MB
  1723 00000940 EB38                    	jmp	short FAT16_f_9 ; 4 sectors per cluster
  1724                                  FAT16_f_2:
  1725 00000942 83FA04                  	cmp	dx, 4  ; >= 262144 sectors ; >=128MB
  1726 00000945 7708                    	ja	short FAT16_f_3 ; >4 sectors per cluster
  1727 00000947 7231                    	jb	short FAT16_f_9 ; 4 sectors per cluster	
  1728 00000949 09C0                    	or	ax, ax ; dx_ax = (4*65536)+0
  1729 0000094B 742D                    	jz	short FAT16_f_9 ; 4 sectors per cluster
  1730 0000094D EB29                    	jmp	short FAT16_f_8 ; 8 sectors per cluster
  1731                                  FAT16_f_3:
  1732 0000094F 83FA08                  	cmp	dx, 8  ; >= 524288 sectors ; >=256MB
  1733 00000952 7708                    	ja	short FAT16_f_4 ; >8 sectors per cluster
  1734 00000954 7222                    	jb	short FAT16_f_8 ; 8 sectors per cluster	
  1735 00000956 21C0                    	and	ax, ax ; dx_ax = (8*65536)+0
  1736 00000958 741E                    	jz	short FAT16_f_8 ; 8 sectors per cluster
  1737 0000095A EB1A                    	jmp	short FAT16_f_7 ; 16 sectors per cluster
  1738                                  FAT16_f_4:
  1739 0000095C 83FA10                  	cmp	dx, 16 ; >= 1048576 sectors ; >=512MB
  1740 0000095F 7708                    	ja	short FAT16_f_5 ; >16 sectors per cluster
  1741 00000961 7213                    	jb	short FAT16_f_7 ; 16 sectors per cluster
  1742 00000963 21C0                    	and	ax, ax ; dx_ax = (16*65536)+0
  1743 00000965 740F                    	jz	short FAT16_f_7 ; 16 sectors per cluster
  1744 00000967 EB0B                    	jmp	short FAT16_f_6 ; 32 sectors per cluster
  1745                                  FAT16_f_5:
  1746 00000969 83FA20                  	cmp	dx, 32 ; >= 2097152 sectors ; >=1GB
  1747 0000096C 7206                    	jb	short FAT16_f_6 ; 32 sectors per cluster
  1748 0000096E 09C0                    	or	ax, ax		; dx_ax = (32*65536)+0
  1749 00000970 7402                    	jz	short FAT16_f_6 ; 32 sectors per cluster
  1750                                  	; >1GB (<=2GB)
  1751                                  	; 64 sectors per cluster
  1752 00000972 D0E1                    	shl	cl, 1
  1753                                  FAT16_f_6:
  1754                                  	; 32 sectors per cluster (for <= 2GB volumes)
  1755 00000974 D0E1                    	shl	cl, 1
  1756                                  FAT16_f_7:
  1757                                  	; 16 sectors per cluster (for <= 1GB volumes)
  1758 00000976 D0E1                    	shl	cl, 1
  1759                                  FAT16_f_8:
  1760                                  	; 8 sectors per cluster (for <= 512MB volumes)
  1761 00000978 D0E1                    	shl	cl, 1
  1762                                  FAT16_f_9:
  1763                                  	; 4 sectors per cluster (for <= 256MB volumes)
  1764 0000097A D0E1                    	shl	cl, 1
  1765                                  FAT16_f_10:	
  1766                                  	; 2 sectors per cluster (for <= 128MB volumes)
  1767 0000097C 884E0D                  	mov	[bp+0Dh], cl	 ; [BPB_SecPerClus]
  1768                                  	;mov	byte [bp+10h], 2 ; [BPB_NumFATs] 
  1769                                  	;mov	word [bp+0Eh], 1 ; [BPB_RsvdSecCnt] 
  1770                                  	;mov	word [bp+11h], 512 ; [BPB_RootEntCnt]
  1771                                  	
  1772                                  	; Calculating FAT size in sectors
  1773                                  	; (According to MS FAT32 FS Specification, 2000)
  1774                                  
  1775                                  	; DX_AX = partition (volume) size in sectors
  1776 0000097F 8B5E11                  	mov	bx, [bp+11h]	; [BPB_RootEntCnt] = 512
  1777 00000982 83C30F                  	add	bx, 15 ; bx = 527
  1778 00000985 C1EB04                  	shr	bx, 4 ; /16 = 527/16 = 32
  1779                                  		; ((32*BX)+511)/512
  1780 00000988 891E[7C22]              	mov	[root_dir_secs], bx
  1781 0000098C 035E0E                  	add	bx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  1782 0000098F 29D8                    	sub	ax, bx
  1783 00000991 83DA00                  	sbb	dx, 0
  1784                                  		; TmpVal1 = DiskSize - (BPB_ResvdSecCnt +
  1785                                  		;	     		RootDirsectors)
  1786                                  	;mov	bx, cx ; ch = 0
  1787                                  	;shl	bx, 8 ; * 256
  1788 00000994 88CF                    	mov	bh, cl
  1789 00000996 30DB                    	xor	bl, bl
  1790 00000998 B102                    	mov	cl, 2 ; [BPB_NumFATs]
  1791 0000099A 01CB                    	add	bx, cx	
  1792                                  		; TmpVal2 = (256*BPB_SecPerClus)+BPB_NumFATs
  1793 0000099C 89D9                    	mov	cx, bx
  1794 0000099E 4B                      	dec	bx  ; TmpVal2-1
  1795 0000099F 01D8                    	add	ax, bx
  1796 000009A1 83D200                  	adc	dx, 0
  1797 000009A4 E88103                  	call	div32
  1798                                  		; FATSz = (TmpVal1+(TmpVal2-1))/TmpVal2
  1799                                  	; AX = FAT size in sectors
  1800                                  	; DX = 0
  1801 000009A7 894616                  	mov	[bp+16h], ax	; [BPB_FATSz16]
  1802                                  	; * 2
  1803 000009AA D1E0                    	shl	ax, 1
  1804                                  	; AX = [BPB_NumFATs] * [BPB_FATSz16]
  1805 000009AC 8B4E0E                  	mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  1806 000009AF 01C1                    	add	cx, ax
  1807                                  
  1808                                  	; 15/07/2024 (bugfix)
  1809 000009B1 894E42                  	mov	[bp+42h], cx	; bsRootDirStart
  1810 000009B4 8B1E[7C22]              	mov	bx, [root_dir_secs]
  1811 000009B8 895E44                  	mov	[bp+44h], bx	; bsRootDirSects
  1812                                  	;mov	word [bp+46h], 16 ; bsDirEntsPerSec
  1813                                  
  1814                                  	; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  1815                                  	;add	cx, [root_dir_secs] ; + RootDirsectors
  1816                                  	; 15/07/2024
  1817 000009BB 01D9                    	add	cx, bx
  1818 000009BD 29DB                    	sub	bx, bx ; BX = 0
  1819                                  	; BX_CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  1820                                  	;	  + RootDirSectors
  1821 000009BF 8B4613                  	mov	ax, [bp+13h]	; [BPB_TotSec16]
  1822                                  	;sub	dx, dx 
  1823                                  	; DX = 0
  1824 000009C2 21C0                    	and	ax, ax
  1825 000009C4 7506                    	jnz	short FAT16_f_11
  1826 000009C6 8B4620                  	mov	ax, [bp+20h]	; [BPB_TotSec32]
  1827 000009C9 8B5622                  	mov	dx, [bp+22h]	; [BPB_TotSec32+2]
  1828                                  FAT16_f_11:
  1829 000009CC 29C8                    	sub	ax, cx
  1830 000009CE 19DA                    	sbb	dx, bx
  1831 000009D0 890E[7022]              	mov	[data_start], cx
  1832 000009D4 891E[7222]              	mov	[data_start+2], bx
  1833                                  
  1834                                  	; 15/07/2024 (bugfix)
  1835 000009D8 894E40                  	mov	 [bp+40h], cx	; bsDataStart
  1836                                  
  1837                                  	; DX_AX = Data sectors
  1838 000009DB A3[7422]                	mov	[data_sectors], ax
  1839 000009DE 8916[7622]              	mov	[data_sectors+2], dx
  1840 000009E2 8A4E0D                  	mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  1841 000009E5 30ED                    	xor	ch, ch
  1842 000009E7 E83E03                  	call	div32 ; DX_AX/CX
  1843                                  	; AX = Count of clusters (rounded down)
  1844                                  	; DX = 0
  1845 000009EA A3[7822]                	mov	[cluster_count], ax
  1846 000009ED 8916[7A22]              	mov	[cluster_count+2], dx
  1847                                  
  1848 000009F1 8D7E2B                  	lea	di, [bp+43] ; [BS_VolLab]
  1849 000009F4 E880FD                  	call	write_volume_name
  1850 000009F7 8D7627                  	lea	si, [bp+39] ; [BS_VolID]
  1851 000009FA E8D9FD                  	call	write_volume_serial
  1852 000009FD E8D9FE                  	call	write_cluster_count
  1853                                  
  1854 00000A00 E85AFE                  	call	write_formatting_msg
  1855 00000A03 B000                    	mov	al, 0
  1856 00000A05 E8B2FE                  	call	write_format_percent_x
  1857                                  
  1858 00000A08 8B461C                  	mov	ax, [bp+1Ch]	; [BPB_HiddSec]
  1859 00000A0B 8B561E                  	mov	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  1860                                  
  1861 00000A0E 0106[7022]              	add	[data_start], ax
  1862 00000A12 1116[7222]              	adc	[data_start+2], dx
  1863                                  
  1864                                  	; DX_AX = FAT16 Boot Sector address
  1865 00000A16 BB[6811]                	mov	bx, RD_FAT16_hd_bs
  1866                                  	; ES:BX = Boot Sector Buffer
  1867 00000A19 E8DAFA                  	call	write_hd_sector
  1868 00000A1C 0F82A1FE                	jc	formatting_error
  1869 00000A20 E85EFE                  	call	write_format_percent
  1870 00000A23 83C001                  	add	ax, 1
  1871 00000A26 83D200                  	adc	dx, 0
  1872                                  	; write remain part of reserved sectors
  1873 00000A29 8B4E0E                  	mov	cx, [bp+0Eh] ; [BPB_RsvdSecCnt]
  1874                                  	;sub	cx, 1
  1875                                  	;jna	short FAT16_f_13
  1876 00000A2C 49                      	dec	cx
  1877 00000A2D 7418                    	jz	short FAT16_f_13
  1878                                  FAT16_f_12:
  1879 00000A2F 51                      	push	cx
  1880 00000A30 BB[2820]                	mov	bx, HDFORMAT_EMPTY_BUFF
  1881 00000A33 E8C0FA                  	call	write_hd_sector
  1882 00000A36 0F8287FE                	jc	formatting_error
  1883 00000A3A E844FE                  	call	write_format_percent
  1884 00000A3D 83C001                  	add	ax, 1
  1885 00000A40 83D200                  	adc	dx, 0
  1886 00000A43 59                      	pop	cx
  1887 00000A44 49                      	dec	cx ; dec cl
  1888 00000A45 75E8                    	jnz	short FAT16_f_12
  1889                                  FAT16_f_13:
  1890                                  	; write FAT sectors
  1891 00000A47 8B0E[7022]              	mov	cx, [data_start] ; lba/abs addr
  1892 00000A4B 8B1E[7222]              	mov	bx, [data_start+2] ; lba/abs addr
  1893                                  
  1894 00000A4F 2B0E[7C22]              	sub	cx, [root_dir_secs]
  1895 00000A53 83DB00                  	sbb	bx, 0
  1896                                  
  1897 00000A56 53                      	push	bx
  1898 00000A57 51                      	push	cx
  1899 00000A58 BB[2820]                	mov	bx, HDFORMAT_FATBUFFER
  1900                                  	; ES:BX = FAT Sector Buffer
  1901 00000A5B 8A4E15                  	mov	cl, [bp+15h] ; [BPB_Media]
  1902 00000A5E B5FF                    	mov	ch, 0FFh
  1903 00000A60 890F                    	mov	[bx], cx ; 0FFF8h
  1904 00000A62 88E9                    	mov	cl, ch ; cx = 0FFFFh
  1905 00000A64 894F02                  	mov	[bx+2], cx
  1906                                  	;inc	cx
  1907 00000A67 E88CFA                  	call	write_hd_sector
  1908 00000A6A 0F8253FE                	jc	formatting_error
  1909 00000A6E E810FE                  	call	write_format_percent
  1910                                  	;mov	bx, HDFORMAT_FATBUFFER
  1911 00000A71 B90000                  	mov	cx, 0
  1912 00000A74 890F                    	mov	[bx], cx
  1913 00000A76 894F02                  	mov	[bx+2], cx
  1914 00000A79 EB0F                    	jmp	short FAT16_f_15
  1915                                  FAT16_f_14:	
  1916 00000A7B 53                      	push	bx
  1917 00000A7C 51                      	push	cx
  1918 00000A7D BB[2820]                	mov	bx, HDFORMAT_FATBUFFER
  1919 00000A80 E873FA                  	call	write_hd_sector
  1920 00000A83 0F823AFE                	jc	formatting_error
  1921 00000A87 E8F7FD                  	call	write_format_percent
  1922                                  FAT16_f_15:	
  1923 00000A8A 59                      	pop	cx
  1924 00000A8B 5B                      	pop	bx
  1925 00000A8C 83C001                  	add	ax, 1
  1926 00000A8F 83D200                  	adc	dx, 0
  1927 00000A92 39DA                    	cmp	dx, bx
  1928 00000A94 72E5                    	jb	short FAT16_f_14
  1929 00000A96 39C8                    	cmp	ax, cx
  1930 00000A98 72E1                    	jb	short FAT16_f_14
  1931                                  
  1932                                  	; write	root directory sectors
  1933                                  	; as empty sectors
  1934 00000A9A 8B0E[7C22]              	mov	cx, [root_dir_secs]
  1935                                  FAT16_f_16:
  1936 00000A9E 51                      	push	cx
  1937 00000A9F BB[2820]                	mov	bx, HDFORMAT_EMPTY_BUFF
  1938 00000AA2 E851FA                  	call	write_hd_sector
  1939 00000AA5 0F8218FE                	jc	formatting_error
  1940 00000AA9 E8D5FD                  	call	write_format_percent
  1941 00000AAC 83C001                  	add	ax, 1
  1942 00000AAF 83D200                  	adc	dx, 0
  1943 00000AB2 59                      	pop	cx
  1944 00000AB3 49                      	dec	cx
  1945 00000AB4 75E8                    	jnz	short FAT16_f_16
  1946                                  
  1947                                  	; write DATA sectors 
  1948                                  	; (after root directory sectors)
  1949 00000AB6 8B0E[7422]              	mov	cx, [data_sectors]
  1950 00000ABA 8B1E[7622]              	mov	bx, [data_sectors+2]
  1951 00000ABE 43                      	inc	bx ; 0 -> 1, 1-> 2
  1952                                  FAT16_f_17:	
  1953 00000ABF 53                      	push	bx
  1954 00000AC0 51                      	push	cx
  1955 00000AC1 BB[1A1C]                	mov	bx, HDFORMAT_SECBUFFER
  1956 00000AC4 E82FFA                  	call	write_hd_sector
  1957 00000AC7 0F82F6FD                	jc	formatting_error
  1958 00000ACB E8B3FD                  	call	write_format_percent
  1959 00000ACE 59                      	pop	cx
  1960 00000ACF 5B                      	pop	bx
  1961 00000AD0 83C001                  	add	ax, 1
  1962 00000AD3 83D200                  	adc	dx, 0
  1963 00000AD6 49                      	dec	cx
  1964 00000AD7 75E6                    	jnz	short FAT16_f_17
  1965 00000AD9 4B                      	dec	bx
  1966 00000ADA 75E3                    	jnz	short FAT16_f_17
  1967                                  
  1968                                  	; If there are, format remain sectors which are
  1969                                  	; at beyond of data clusters, with zero bytes.
  1970                                  	
  1971 00000ADC 8B4E1C                  	mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  1972 00000ADF 8B5E1E                  	mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  1973                                  
  1974 00000AE2 837E1300                	cmp	word [bp+13h], 0 ; [BPB_TotSec16]
  1975 00000AE6 0F8453FC                	jz	FAT16_f_18
  1976 00000AEA 034E13                  	add	cx, [bp+13h]	; [BPB_TotSec16]
  1977 00000AED 83D300                  	adc	bx, 0
  1978 00000AF0 E950FC                  	jmp	FAT16_f_19
  1979                                  
  1980                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1981                                  ; FAT12 FORMATTING
  1982                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  1983                                  
  1984                                  ; ((TRDOS 386 criter))
  1985                                  ; Minimum size of FAT12 FS = [heads]*[sectors]
  1986                                  ; (1 cylinder) 
  1987                                  
  1988                                  format_FAT12_fs:
  1989 00000AF3 BD[6813]                	mov	bp, RD_FAT12_hd_bs
  1990 00000AF6 8D7E03                  	lea	di, [bp+3]
  1991 00000AF9 BE[721A]                	mov	si, bs_oem_name
  1992 00000AFC B90400                  	mov	cx, 4
  1993 00000AFF F3A5                    	rep	movsw 
  1994 00000B01 A1[6A15]                	mov	ax, [sectors]
  1995 00000B04 894618                  	mov	[bp+18h], ax	; [BPB_SecPerTrk]
  1996 00000B07 A1[6C15]                	mov	ax, [heads]
  1997 00000B0A 89461A                  	mov	[bp+1Ah], ax	; [BPB_NumHeads]
  1998 00000B0D A1[2020]                	mov	ax, [dosp_start]
  1999 00000B10 89461C                  	mov	[bp+1Ch], ax	; [BPB_HiddSec]
  2000 00000B13 A1[2220]                	mov	ax, [dosp_start+2]
  2001 00000B16 89461E                  	mov	[bp+1Eh], ax	; [BPB_HiddSec+2]
  2002 00000B19 A1[2420]                	mov	ax, [dosp_size]
  2003 00000B1C 894613                  	mov	[bp+13h], ax	; [BPB_TotSec16]
  2004                                  
  2005 00000B1F 31F6                    	xor	si, si ; reset (FAT size fix) flag
  2006 00000B21 8B4E0E                  	mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  2007 00000B24 8B5611                  	mov	dx, [bp+11h]	; [BPB_RootEntCnt] = 512
  2008 00000B27 83C20F                  	add	dx, 15	; (16-1) (512-1)
  2009 00000B2A C1EA04                  	shr	dx, 4	; /16  (*32/512)
  2010                                  	; AX = Root dir sectors
  2011                                  	; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  2012 00000B2D 01D1                    	add	cx, dx ; + RootDirsectors ; + 32
  2013 00000B2F 890E[7C22]              	mov	[root_dir_secs], cx ; = 33
  2014                                  
  2015                                  	;sub	ax, 33  ; 1 reserved sector, 32 root dir sectors
  2016                                  			; .. now AX has number of data sectors
  2017                                  			;	 		+ 2* (FAT sectors)
  2018 00000B33 29C8                    	sub	ax, cx
  2019                                  FAT12_f_10:
  2020                                  	; Sectors per cluster calculation
  2021                                  	; (According to MS FAT32 FS specification.)
  2022                                  	;mov	cx, 1  ; 1 sector per cluster
  2023 00000B35 B101                    	mov	cl, 1  ; CH = 0
  2024                                  	; 28/10/2023 ; (BugFix)
  2025 00000B37 50                      	push	ax
  2026                                  FAT12_f_0:
  2027 00000B38 3DF50F                  	cmp	ax, 4085 ; Max. cluster count for FAT12
  2028 00000B3B 7206                    	jb	short FAT12_f_1
  2029 00000B3D D0E1                    	shl	cl, 1 ; *2
  2030 00000B3F D1E8                    	shr	ax, 1 ; /2
  2031 00000B41 EBF5                    	jmp	short FAT12_f_0
  2032                                  FAT12_f_1:
  2033                                  	; 28/10/2023
  2034 00000B43 58                      	pop	ax
  2035 00000B44 884E0D                  	mov	[bp+0Dh], cl	 ; [BPB_SecPerClus]
  2036                                  	;mov	byte [bp+10h], 2 ; [BPB_NumFATs] 
  2037                                  	;mov	word [bp+0Eh], 1 ; [BPB_RsvdSecCnt] 
  2038                                  	;mov	word [bp+11h], 512 ; [BPB_RootEntCnt]
  2039                                  	
  2040                                  	; Calculating FAT size in sectors
  2041                                  	; AX = partition (volume, data) size in sectors
  2042                                  	; CX = sectors per clusters
  2043 00000B47 31D2                    	xor	dx, dx
  2044 00000B49 F7F1                    	div	cx
  2045                                  	; AX = cluster count (only for FAT size calc)
  2046                                  	; DX = 0
  2047 00000B4B 83C002                  	add	ax, 2  ; cluster 2 to ...
  2048 00000B4E 89C2                    	mov	dx, ax
  2049 00000B50 D1E2                    	shl	dx, 1
  2050 00000B52 01D0                    	add	ax, dx ; *3
  2051 00000B54 D1E8                    	shr	ax, 1  ; /2
  2052 00000B56 83D000                  	adc	ax, 0  ; +0.5 -> +1
  2053                                  
  2054                                  	; AX = FAT bytes for 12 bit cluster numbers
  2055                                  	
  2056 00000B59 B90002                  	mov	cx, 512		; [BPB_BytesPerSec]
  2057 00000B5C 01C8                    	add	ax, cx		
  2058 00000B5E 48                      	dec	ax		; [BPB_BytesPerSec] - 1
  2059 00000B5F 29D2                    	sub	dx, dx
  2060 00000B61 F7F1                    	div	cx
  2061 00000B63 894616                  	mov	[bp+16h], ax	; [BPB_FATSz16]
  2062                                  	; * 2
  2063 00000B66 D1E0                    	shl	ax, 1
  2064                                  	; AX = [BPB_NumFATs] * [BPB_FATSz16]
  2065                                  
  2066                                  	;mov	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  2067                                  	;add	cx, ax
  2068                                  	;mov	ax, [bp+11h]	; [BPB_RootEntCnt] = 512
  2069                                  	;add	ax, 15	; (16-1) (512-1)
  2070                                  	;shr	ax, 4	; /16  (*32/512)
  2071                                  	;; AX = Root dir sectors
  2072                                  	;; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  2073                                  	;add	cx, ax ; + RootDirsectors
  2074                                  	;mov	[root_dir_secs], ax
  2075                                  
  2076                                  ;mov	cx, 33
  2077 00000B68 8B0E[7C22]              	mov	cx, [root_dir_secs]
  2078                                  
  2079                                  	; 15/07/2024 (bugfix)
  2080                                  	; ax = 2 * FAT size (in sectors)
  2081 00000B6C 03460E                  	add	ax, [bp+0Eh] ; total FAT sectors + reserved sectors	
  2082 00000B6F 894642                  	mov	[bp+42h], ax	; bsRootDirStart
  2083 00000B72 894E44                  	mov	[bp+44h], cx	; bsRootDirSects
  2084                                  	;mov	word [bp+46h], 16 ; bsDirEntsPerSec
  2085                                  
  2086                                  	; 15/07/2024
  2087                                  	;add	cx, [bp+0Eh]	; [BPB_RsvdSecCnt] ; 1
  2088                                  		; cx = root directory sectors + reserved sectors
  2089 00000B75 01C1                    	add	cx, ax
  2090                                  		; cx = root dir sects + rsvd sects + total FAT sects
  2091                                  
  2092                                  	; CX = [BPB_RsvdSecCnt]+([BPB_NumFATs]*[BPB_FATSz16])
  2093                                  	;	  + RootDirSectors
  2094 00000B77 8B4613                  	mov	ax, [bp+13h]	; [BPB_TotSec16]
  2095 00000B7A 29C8                    	sub	ax, cx
  2096                                  		 ; AX = data sectors
  2097                                  		 ; cH = 0
  2098                                  
  2099                                  	; fix FAT size (better method)
  2100 00000B7C 09F6                    	or	si, si
  2101 00000B7E 7504                    	jnz	short FAT12_f_9
  2102                                  
  2103 00000B80 89C6                    	mov	si, ax  ; ax = data sectors
  2104 00000B82 EBB1                    	jmp	short FAT12_f_10
  2105                                  
  2106                                  FAT12_f_9:
  2107 00000B84 31D2                    	xor	dx, dx
  2108 00000B86 890E[7022]              	mov	[data_start], cx
  2109 00000B8A 8916[7222]              	mov	[data_start+2], dx ; 0
  2110                                  	
  2111                                  	; 15/07/2024 (bugfix)
  2112 00000B8E 894E40                  	mov	 [bp+40h], cx	; bsDataStart
  2113                                  
  2114                                  	; DX_AX = Data sectors
  2115 00000B91 A3[7422]                	mov	[data_sectors], ax
  2116 00000B94 8916[7622]              	mov	[data_sectors+2], dx ; 0
  2117 00000B98 8A4E0D                  	mov	cl, [bp+0Dh]	 ; [BPB_SecPerClus]
  2118 00000B9B 28ED                    	sub	ch, ch
  2119 00000B9D F7F1                    	div	cx
  2120                                  	; AX = Count of clusters (rounded down)
  2121 00000B9F 29D2                    	sub	dx, dx ; 0
  2122 00000BA1 A3[7822]                	mov	[cluster_count], ax
  2123 00000BA4 8916[7A22]              	mov	[cluster_count+2], dx ; 0
  2124                                  
  2125 00000BA8 8D7E2B                  	lea	di, [bp+43] ; [BS_VolLab]
  2126 00000BAB E8C9FB                  	call	write_volume_name
  2127 00000BAE 8D7627                  	lea	si, [bp+39] ; [BS_VolID]
  2128 00000BB1 E822FC                  	call	write_volume_serial
  2129 00000BB4 E822FD                  	call	write_cluster_count
  2130                                  
  2131 00000BB7 E8A3FC                  	call	write_formatting_msg
  2132 00000BBA B000                    	mov	al, 0
  2133 00000BBC E8FBFC                  	call	write_format_percent_x
  2134                                  
  2135 00000BBF 8B461C                  	mov	ax, [bp+1Ch]	; [BPB_HiddSec]
  2136 00000BC2 8B561E                  	mov	dx, [bp+1Eh]	; [BPB_HiddSec+2]
  2137                                  
  2138 00000BC5 0106[7022]              	add	[data_start], ax
  2139 00000BC9 1116[7222]              	adc	[data_start+2], dx
  2140                                  
  2141                                  	; DX_AX = FAT12 Boot Sector address
  2142 00000BCD BB[6813]                	mov	bx, RD_FAT12_hd_bs
  2143                                  	; ES:BX = Boot Sector Buffer
  2144 00000BD0 E823F9                  	call	write_hd_sector
  2145 00000BD3 0F82EAFC                	jc	formatting_error
  2146 00000BD7 E8A7FC                  	call	write_format_percent
  2147 00000BDA 83C001                  	add	ax, 1
  2148 00000BDD 83D200                  	adc	dx, 0
  2149                                  	; write remain part of reserved sectors
  2150 00000BE0 8B4E0E                  	mov	cx, [bp+0Eh] ; [BPB_RsvdSecCnt]
  2151                                  	;sub	cx, 1
  2152                                  	;jna	short FAT12_f_3
  2153 00000BE3 49                      	dec	cx
  2154 00000BE4 7418                    	jz	short FAT12_f_3
  2155                                  FAT12_f_2:
  2156 00000BE6 51                      	push	cx
  2157 00000BE7 BB[2820]                	mov	bx, HDFORMAT_EMPTY_BUFF
  2158 00000BEA E809F9                  	call	write_hd_sector
  2159 00000BED 0F82D0FC                	jc	formatting_error
  2160 00000BF1 E88DFC                  	call	write_format_percent
  2161 00000BF4 83C001                  	add	ax, 1
  2162 00000BF7 83D200                  	adc	dx, 0
  2163 00000BFA 59                      	pop	cx
  2164 00000BFB 49                      	dec	cx ; dec cl
  2165 00000BFC 75E8                    	jnz	short FAT12_f_2
  2166                                  FAT12_f_3:
  2167                                  	; write FAT sectors
  2168 00000BFE 8B0E[7022]              	mov	cx, [data_start] ; lba/abs addr
  2169 00000C02 8B1E[7222]              	mov	bx, [data_start+2] ; lba/abs addr
  2170                                  
  2171 00000C06 2B0E[7C22]              	sub	cx, [root_dir_secs]
  2172 00000C0A 83DB00                  	sbb	bx, 0
  2173                                  
  2174 00000C0D 53                      	push	bx
  2175 00000C0E 51                      	push	cx
  2176 00000C0F BB[2820]                	mov	bx, HDFORMAT_FATBUFFER
  2177                                  	; ES:BX = FAT Sector Buffer
  2178 00000C12 8A4E15                  	mov	cl, [bp+15h] ; [BPB_Media]
  2179 00000C15 B5FF                    	mov	ch, 0FFh
  2180 00000C17 890F                    	mov	[bx], cx ; 0FFF8h
  2181 00000C19 886F02                  	mov	[bx+2], ch ; 0FFFFF8h
  2182                                  	;xor	cx, cx
  2183 00000C1C E8D7F8                  	call	write_hd_sector
  2184 00000C1F 0F829EFC                	jc	formatting_error
  2185 00000C23 E85BFC                  	call	write_format_percent
  2186                                  	;mov	bx, HDFORMAT_FATBUFFER
  2187 00000C26 B90000                  	mov	cx, 0
  2188 00000C29 890F                    	mov	[bx], cx
  2189 00000C2B 884F02                  	mov	[bx+2], cl
  2190 00000C2E EB0F                    	jmp	short FAT12_f_5
  2191                                  FAT12_f_4:	
  2192 00000C30 53                      	push	bx
  2193 00000C31 51                      	push	cx	
  2194 00000C32 BB[2820]                	mov	bx, HDFORMAT_FATBUFFER
  2195 00000C35 E8BEF8                  	call	write_hd_sector
  2196 00000C38 0F8285FC                	jc	formatting_error
  2197 00000C3C E842FC                  	call	write_format_percent
  2198                                  FAT12_f_5:	
  2199 00000C3F 59                      	pop	cx
  2200 00000C40 5B                      	pop	bx
  2201 00000C41 83C001                  	add	ax, 1
  2202 00000C44 83D200                  	adc	dx, 0
  2203 00000C47 39DA                    	cmp	dx, bx
  2204 00000C49 72E5                    	jb	short FAT12_f_4
  2205 00000C4B 39C8                    	cmp	ax, cx
  2206 00000C4D 72E1                    	jb	short FAT12_f_4
  2207                                  
  2208                                  	; write	root directory sectors
  2209                                  	; as empty sectors
  2210 00000C4F 8B0E[7C22]              	mov	cx, [root_dir_secs]
  2211                                  FAT12_f_6:
  2212 00000C53 51                      	push	cx
  2213 00000C54 BB[2820]                	mov	bx, HDFORMAT_EMPTY_BUFF
  2214 00000C57 E89CF8                  	call	write_hd_sector
  2215 00000C5A 0F8263FC                	jc	formatting_error
  2216 00000C5E E820FC                  	call	write_format_percent
  2217 00000C61 83C001                  	add	ax, 1
  2218 00000C64 83D200                  	adc	dx, 0
  2219 00000C67 59                      	pop	cx
  2220 00000C68 49                      	dec	cx ; dec cl
  2221 00000C69 75E8                    	jnz	short FAT12_f_6
  2222                                  
  2223                                  	; write DATA sectors 
  2224                                  	; (after root directory sectors)
  2225 00000C6B 8B0E[7422]              	mov	cx, [data_sectors]
  2226                                  	;mov	bx, [data_sectors+2]
  2227                                  	;inc	bx
  2228                                  FAT12_f_7:
  2229                                  	;push	bx
  2230 00000C6F 51                      	push	cx
  2231 00000C70 BB[1A1C]                	mov	bx, HDFORMAT_SECBUFFER
  2232 00000C73 E880F8                  	call	write_hd_sector
  2233 00000C76 0F8247FC                	jc	formatting_error
  2234 00000C7A E804FC                  	call	write_format_percent
  2235 00000C7D 59                      	pop	cx
  2236                                  	;pop	bx
  2237 00000C7E 83C001                  	add	ax, 1
  2238 00000C81 83D200                  	adc	dx, 0
  2239 00000C84 49                      	dec	cx
  2240 00000C85 75E8                    	jnz	short FAT12_f_7
  2241                                  	;dec	bx
  2242                                  	;jnz	short FAT12_f_7
  2243                                  
  2244                                  	; If there are, format remain sectors which are
  2245                                  	; at beyond of data clusters, with zero bytes.
  2246                                  	
  2247 00000C87 8B4E1C                  	mov	cx, [bp+1Ch]	; [BPB_HiddSec]
  2248 00000C8A 8B5E1E                  	mov	bx, [bp+1Eh]	; [BPB_HiddSec+2]
  2249                                  
  2250 00000C8D 034E13                  	add	cx, [bp+13h]	; [BPB_TotSec16]
  2251 00000C90 83D300                  	adc	bx, 0
  2252 00000C93 E9ADFA                  	jmp	FAT12_f_8
  2253                                  
  2254                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2255                                  ; Read & Write characters
  2256                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2257                                  
  2258                                  rw_char:
  2259                                  	; OUTPUT -> DS:SI = Entered String (ASCIIZ)
  2260 00000C96 BE[8422]                	mov     si, StrVolumeName
  2261 00000C99 BB0700                  	mov     bx, 7
  2262 00000C9C B403                    	mov     ah, 3
  2263 00000C9E CD10                    	int     10h
  2264 00000CA0 8916[E818]              	mov     [Cursor_Pos], dx
  2265                                  read_next_char:
  2266 00000CA4 30E4                    	xor     ah, ah
  2267 00000CA6 CD16                    	int     16h
  2268 00000CA8 20C0                    	and     al, al
  2269 00000CAA 7439                    	jz      short loc_arrow
  2270 00000CAC 3CE0                    	cmp     al, 0E0h
  2271 00000CAE 7435                    	je      short loc_arrow
  2272 00000CB0 3C08                    	cmp     al, 8
  2273 00000CB2 753D                    	jne     short char_return
  2274                                  loc_back:
  2275 00000CB4 B403                    	mov     ah, 3
  2276 00000CB6 CD10                    	int     10h
  2277 00000CB8 3A16[E818]              	cmp     dl, byte [Cursor_Pos]
  2278 00000CBC 761F                    	jna     short loc_beep
  2279                                  prev_column:
  2280 00000CBE FECA                    	dec     dl
  2281                                  set_cursor_pos:
  2282 00000CC0 B402                    	mov     ah, 2
  2283 00000CC2 CD10                    	int     10h
  2284 00000CC4 88D3                    	mov     bl, dl
  2285 00000CC6 2A1E[E818]              	sub     bl, byte [Cursor_Pos]
  2286 00000CCA B90100                  	mov     cx, 1
  2287 00000CCD B409                    	mov     ah, 9
  2288 00000CCF B020                    	mov     al, 20h
  2289 00000CD1 8800                    	mov     [si+bx], al
  2290                                  loc_write_it:
  2291 00000CD3 B307                    	mov     bl, 7
  2292 00000CD5 CD10                    	int     10h
  2293 00000CD7 8B16[E818]              	mov     dx, [Cursor_Pos]
  2294 00000CDB EBC7                    	jmp     short read_next_char
  2295                                  loc_beep:
  2296 00000CDD B40E                    	mov     ah, 0Eh
  2297 00000CDF B007                    	mov     al, 7
  2298 00000CE1 CD10                    	int     10h
  2299 00000CE3 EBBF                    	jmp     short read_next_char
  2300                                  loc_arrow:    
  2301 00000CE5 80FC4B                  	cmp     ah, 4Bh
  2302 00000CE8 74CA                    	je      short loc_back
  2303 00000CEA 80FC53                  	cmp     ah, 53h
  2304 00000CED 74C5                    	je      short loc_back
  2305 00000CEF EBB3                    	jmp     short read_next_char
  2306                                  char_return:
  2307 00000CF1 B403                    	mov     ah, 3
  2308 00000CF3 CD10                    	int     10h
  2309                                  check_char_type:
  2310 00000CF5 3C20                    	cmp     al, 20h
  2311 00000CF7 7229                    	jb      short loc_escape
  2312 00000CF9 88D4                    	mov     ah, dl
  2313 00000CFB 2A26[E818]              	sub     ah, byte [Cursor_Pos]
  2314                                  	;cmp	ah, 10 
  2315                                  	;ja	short loc_beep
  2316 00000CFF 3A26[711A]              	cmp     ah, [vname_length]
  2317 00000D03 73D8                    	jnb	short loc_beep
  2318 00000D05 3C7A                    	cmp     al, 'z'
  2319 00000D07 779B                    	ja      short read_next_char
  2320 00000D09 3C61                    	cmp     al, 'a'
  2321 00000D0B 7202                    	jb      short pass_capitalize
  2322 00000D0D 24DF                    	and     al, 0DFh
  2323                                  pass_capitalize:
  2324 00000D0F 88E3                    	mov     bl, ah 
  2325 00000D11 30E4                    	xor     ah, ah
  2326 00000D13 8900                    	mov     [si+bx], ax
  2327 00000D15 B307                    	mov     bl, 7
  2328 00000D17 B40E                    	mov     ah, 0Eh
  2329 00000D19 CD10                    	int     10h
  2330 00000D1B EB87                    	jmp     short read_next_char
  2331                                  pass_escape:
  2332 00000D1D 3C0D                    	cmp     al, 0Dh	; 13 ; ENTER
  2333 00000D1F 7583                    	jne     short read_next_char
  2334                                  	;mov	ah, 0Eh
  2335                                  	;int	10h
  2336                                  	;mov	al, 0Ah
  2337                                  	;int	10h
  2338 00000D21 C3                      	retn
  2339                                  loc_escape:
  2340 00000D22 3C1B                    	cmp     al, 1Bh	; 27 ; ESC
  2341 00000D24 75F7                    	jne     short pass_escape
  2342 00000D26 F9                      	stc
  2343 00000D27 C3                      	retn
  2344                                  
  2345                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2346                                  ; 32 bit division
  2347                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2348                                  
  2349                                  div32:
  2350                                  	; DX_AX/CX
  2351                                  	; Result: DX_AX, BX (remainder)
  2352 00000D28 89C3                    	mov	bx, ax
  2353                                  	;or	dx, ax ; * DX_AX = 0 ?
  2354                                  	;jz	short div32_retn ; yes, do not divide!
  2355 00000D2A 89D0                    	mov	ax, dx
  2356 00000D2C 31D2                            xor	dx, dx
  2357 00000D2E F7F1                            div	cx	; at first, divide DX
  2358                                  			; remainder is in DX 
  2359 00000D30 93                      	xchg	ax, bx	; now quotient is in BX
  2360                                    			; and initial AX value is in AX
  2361 00000D31 F7F1                    	div	cx	; now, DX_AX has been divided and
  2362                                  			; AX has quotient
  2363                                  			; DX has remainder
  2364 00000D33 87D3                    	xchg	dx, bx	; finally, BX has remainder
  2365                                  ;div32_retn:
  2366 00000D35 C3                              retn
  2367                                  
  2368                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2369                                  ; Convert byte to decimal number
  2370                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2371                                  
  2372                                  bin_to_decimal:
  2373                                  	; INPUT: DS:SI = Target location
  2374                                  	;        DX_AX = Binary Number (Integer)
  2375                                  	; OUTPUT: Decimal char at DS:SI
  2376                                  	; 	 SI decremented after every division
  2377                                  	; 	 till AX<10.
  2378                                  	; CX, DX, BX will be changed.
  2379                                  	;
  2380 00000D36 B90A00                  	mov	cx, 10
  2381                                  btd_0:
  2382                                  	; DX_AX = Dividend
  2383                                  	; CX = Divisor
  2384 00000D39 E8ECFF                  	call	div32
  2385                                  	; DX_AX = Quotient
  2386                                  	; BX = remainder
  2387 00000D3C 80C330                  	add	bl, '0'
  2388 00000D3F 881C                    	mov	[si], bl
  2389 00000D41 21D2                    	and	dx, dx
  2390 00000D43 7403                    	jz	short btd_2
  2391                                  btd_1:
  2392 00000D45 4E                      	dec	si
  2393 00000D46 EBF1                    	jmp	short btd_0
  2394                                  btd_2:
  2395 00000D48 09C0                    	or	ax, ax
  2396 00000D4A 75F9                    	jnz	short btd_1
  2397                                  
  2398 00000D4C C3                      	retn
  2399                                  
  2400                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2401                                  ; Convert byte to hexadecimal number
  2402                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2403                                  
  2404                                  byte_to_hex:
  2405                                  bin_to_hex:
  2406                                  	; INPUT ->
  2407                                  	; 	AL = byte (binary number)
  2408                                  	; OUTPUT ->
  2409                                  	;	AX = hexadecimal string
  2410                                  	;
  2411 00000D4D 53                      	push	bx
  2412 00000D4E 31DB                    	xor	bx, bx
  2413 00000D50 88C3                    	mov	bl, al
  2414 00000D52 C0EB04                  	shr	bl, 4
  2415 00000D55 8A9F[D818]              	mov	bl, [bx+hexchrs]
  2416 00000D59 86D8                    	xchg	bl, al
  2417 00000D5B 80E30F                  	and	bl, 0Fh
  2418 00000D5E 8AA7[D818]              	mov	ah, [bx+hexchrs]
  2419 00000D62 5B                      	pop	bx
  2420 00000D63 C3                      	retn
  2421                                  
  2422                                  ; ----------------------------------------------------------------------------
  2423                                  ; initialized data
  2424                                  ; ----------------------------------------------------------------------------
  2425                                  
  2426                                  align 2
  2427                                  
  2428                                  trdos386fc:
  2429 00000D64 [F008]                  	dw format_FAT16_fs
  2430 00000D66 0000                    	dw 0
  2431                                  
  2432                                  ;volume_id:
  2433                                  ;	dd 0
  2434                                  
  2435                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2436                                  ;  FAT boot sector code
  2437                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2438                                  
  2439                                  RD_FAT32_hd_bs:
  2440 00000D68 <bin 400h>              	incbin	'RD5HDBS3.BIN' ; 29/04/2024
  2441                                  RD_FAT16_hd_bs: 
  2442 00001168 <bin 200h>              	incbin	'RD4HDBS.BIN' ; 24/10/2023
  2443                                  RD_FAT12_hd_bs: 
  2444 00001368 <bin 200h>              	incbin	'RD2HDBS.BIN' ; 25/10/2023
  2445                                  
  2446                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2447                                  ;  messages
  2448                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2449                                  
  2450 00001568 00                      lba:	db 0
  2451                                  
  2452 00001569 00                      drv:	db 0
  2453                                  
  2454 0000156A 00                      sectors: db 0
  2455 0000156B 00                      	 db 0
  2456 0000156C 00                      heads:	 db 0
  2457 0000156D 00                      	 db 0
  2458 0000156E 0000                    cylinders: dw 0
  2459                                  
  2460                                  RD_Welcome:
  2461 00001570 0D0A                    	db 0Dh, 0Ah
  2462 00001572 526574726F20444F53-     	db 'Retro DOS v4 Hard Disk Partition Formatting Utility '
  2462 0000157B 207634204861726420-
  2462 00001584 4469736B2050617274-
  2462 0000158D 6974696F6E20466F72-
  2462 00001596 6D617474696E672055-
  2462 0000159F 74696C69747920     
  2463 000015A6 0D0A                    	db 0Dh, 0Ah
  2464 000015A8 28666F72206C6F6769-     	db '(for logical dos drives in extended dos partitions)	'
  2464 000015B1 63616C20646F732064-
  2464 000015BA 726976657320696E20-
  2464 000015C3 657874656E64656420-
  2464 000015CC 646F73207061727469-
  2464 000015D5 74696F6E732909     
  2465 000015DC 0D0A                    	db 0Dh, 0Ah
  2466 000015DE 0D0A                    	db 0Dh, 0Ah
  2467 000015E0 76312E312E32343037-     	db 'v1.1.240715 (c) Erdogan TAN 2020-2024'
  2467 000015E9 313520286329204572-
  2467 000015F2 646F67616E2054414E-
  2467 000015FB 20323032302D323032-
  2467 00001604 34                 
  2468 00001605 0D0A                    	db 0Dh,0Ah
  2469 00001607 0D0A                    	db 0Dh,0Ah
  2470 00001609 55736167653A206570-     	db 'Usage: epformat <drive> '
  2470 00001612 666F726D6174203C64-
  2470 0000161B 726976653E20       
  2471 00001621 0D0A0D0A                	db 0Dh,0Ah, 0Dh, 0Ah
  2472 00001625 4472697665206E616D-     	db 'Drive names: '
  2472 0000162E 65733A20           
  2473 00001632 0D0A                    	db 0Dh, 0Ah
  2474 00001634 2020686430202E2E66-     	db '  hd0 ..for extended dos partition on 1st disk '
  2474 0000163D 6F7220657874656E64-
  2474 00001646 656420646F73207061-
  2474 0000164F 72746974696F6E206F-
  2474 00001658 6E2031737420646973-
  2474 00001661 6B20               
  2475 00001663 0D0A                    	db 0Dh, 0Ah
  2476 00001665 2020686431202E2E66-     	db '  hd1 ..for extended dos partition on 2nd disk '
  2476 0000166E 6F7220657874656E64-
  2476 00001677 656420646F73207061-
  2476 00001680 72746974696F6E206F-
  2476 00001689 6E20326E6420646973-
  2476 00001692 6B20               
  2477 00001694 0D0A                    	db 0Dh, 0Ah
  2478 00001696 2020686432202E2E66-     	db '  hd2 ..for extended dos partition on 3rd disk '
  2478 0000169F 6F7220657874656E64-
  2478 000016A8 656420646F73207061-
  2478 000016B1 72746974696F6E206F-
  2478 000016BA 6E2033726420646973-
  2478 000016C3 6B20               
  2479 000016C5 0D0A                    	db 0Dh, 0Ah
  2480 000016C7 2020686433202E2E66-     	db '  hd3 ..for extended dos partition on 4th disk '
  2480 000016D0 6F7220657874656E64-
  2480 000016D9 656420646F73207061-
  2480 000016E2 72746974696F6E206F-
  2480 000016EB 6E2034746820646973-
  2480 000016F4 6B20               
  2481 000016F6 0D0A00                  	db 0Dh, 0Ah, 0
  2482                                  
  2483 000016F9 32352F30392F323032-     	db '25/09/2020'
  2483 00001702 30                 
  2484 00001703 00                      	db 0
  2485                                  
  2486                                  RD_Format_warning:
  2487 00001704 0D0A                    	db 0Dh, 0Ah
  2488 00001706 5741524E494E472021-     	db "WARNING ! ", 0Dh, 0Ah 
  2488 0000170F 200D0A             
  2489 00001712 28496620796F752073-     	db "(If you say 'Yes', all of data in the logical DOS drive will be lost !) "
  2489 0000171B 61792027596573272C-
  2489 00001724 20616C6C206F662064-
  2489 0000172D 61746120696E207468-
  2489 00001736 65206C6F676963616C-
  2489 0000173F 20444F532064726976-
  2489 00001748 652077696C6C206265-
  2489 00001751 206C6F737420212920 
  2490                                  RD_Do_you_want:
  2491 0000175A 0D0A                    	db 0Dh, 0Ah
  2492 0000175C 0D0A                    	db 0Dh, 0Ah
  2493 0000175E 446F20796F75207761-     	db "Do you want to format logical DOS drive as Retro DOS v4 FAT" 
  2493 00001767 6E7420746F20666F72-
  2493 00001770 6D6174206C6F676963-
  2493 00001779 616C20444F53206472-
  2493 00001782 697665206173205265-
  2493 0000178B 74726F20444F532076-
  2493 00001794 3420464154         
  2494                                  fattype_str:
  2495 00001799 3136206673203F2028-     	db "16 fs ? (Y/N) "
  2495 000017A2 592F4E2920         
  2496 000017A7 00                      	db 0
  2497                                  
  2498                                  _yes_str:
  2499 000017A8 59455320                	db 'YES '
  2500 000017AC 0D0A00                  	db 0Dh, 0Ah, 0
  2501                                  _no_str:
  2502 000017AF 4E4F20                  	db 'NO '
  2503 000017B2 0D0A00                  	db 0Dh, 0Ah, 0
  2504                                  
  2505                                  _msg_OK:
  2506                                  	;db	07h
  2507 000017B5 0D0A                    	db	0Dh, 0Ah
  2508 000017B7 4F4B2E                  	db	"OK."
  2509                                  RD_CRLF:
  2510 000017BA 0D0A00                  	db	0Dh, 0Ah, 0
  2511                                  
  2512                                  RD_PressKeyWhenReady:
  2513 000017BD 0D0A                    	db 0Dh, 0Ah
  2514 000017BF 507265737320456E74-     	db 'Press Enter to format logical DOS drive '
  2514 000017C8 657220746F20666F72-
  2514 000017D1 6D6174206C6F676963-
  2514 000017DA 616C20444F53206472-
  2514 000017E3 69766520           
  2515                                  RD_ldn:
  2516 000017E7 31206F6E206864          	db '1 on hd'
  2517                                  RD_Drive:
  2518 000017EE 3F2E2000                	db '?. ', 0
  2519                                  
  2520                                  RD_disk_NotReadyOrError:
  2521 000017F2 0D0A                    	db 0Dh, 0Ah
  2522 000017F4 4469736B206572726F-     	db 'Disk error or drive not ready ! '
  2522 000017FD 72206F722064726976-
  2522 00001806 65206E6F7420726561-
  2522 0000180F 6479202120         
  2523 00001814 54727920616761696E-     zbyte:	db 'Try again ? (Y/N) '
  2523 0000181D 203F2028592F4E2920 
  2524 00001826 00                      	db 0
  2525                                  
  2526                                  RD_psize_defect:
  2527 00001827 0D0A                    	db 0Dh, 0Ah
  2528 00001829 4D4252207061727469-     	db 'MBR partition size defect ! '
  2528 00001832 74696F6E2073697A65-
  2528 0000183B 206465666563742021-
  2528 00001844 20                 
  2529 00001845 0D0A                    	db 0Dh, 0Ah
  2530 00001847 286C65737320746861-     	db '(less than the minimum number of sectors required) '
  2530 00001850 6E20746865206D696E-
  2530 00001859 696D756D206E756D62-
  2530 00001862 6572206F6620736563-
  2530 0000186B 746F72732072657175-
  2530 00001874 697265642920       
  2531 0000187A 00                      	db 0
  2532                                  
  2533                                  RD_ep_ldd_defect:
  2534 0000187B 0D0A                    	db 0Dh, 0Ah
  2535 0000187D 546865726520697320-     	db 'There is not a logical DOS drive ! '
  2535 00001886 6E6F742061206C6F67-
  2535 0000188F 6963616C20444F5320-
  2535 00001898 6472697665202120   
  2536 000018A0 0D0A                    	db 0Dh, 0Ah
  2537                                  ldd_count:
  2538 000018A2 00                      	db 0
  2539                                  
  2540                                  RD_fatp_notfound:
  2541 000018A3 0D0A                    	db 0Dh, 0Ah
  2542 000018A5 4D425220646F657320-     	db 'MBR does not contain an extended DOS partition ! '
  2542 000018AE 6E6F7420636F6E7461-
  2542 000018B7 696E20616E20657874-
  2542 000018C0 656E64656420444F53-
  2542 000018C9 20706172746974696F-
  2542 000018D2 6E202120           
  2543                                  fattype:
  2544 000018D6 00                      	db 0
  2545                                  ;RetryCount:
  2546                                  ;	db 4
  2547                                  
  2548                                  ;error: db 0
  2549                                  
  2550                                  ;align 2
  2551 000018D7 90                      align 4
  2552                                  
  2553                                  hexchrs:
  2554 000018D8 303132333435363738-     	db	'0123456789ABCDEF'
  2554 000018E1 39414243444546     
  2555                                  
  2556                                  Cursor_Pos: ; dw 0
  2557                                  CHS_limit:  ; dword
  2558 000018E8 0000                    	dw	0
  2559                                  	;dw	0
  2560                                  
  2561 000018EA A101                    sign:	dw	417	; magic word
  2562                                  
  2563                                  ldd_table:
  2564 000018EC 0D0A                    	db	0Dh, 0Ah
  2565 000018EE 3D3D3D3D3D3D3D3D3D-     	db	"=======================================", 0Dh, 0Ah
  2565 000018F7 3D3D3D3D3D3D3D3D3D-
  2565 00001900 3D3D3D3D3D3D3D3D3D-
  2565 00001909 3D3D3D3D3D3D3D3D3D-
  2565 00001912 3D3D3D0D0A         
  2566 00001917 2020202020204844        	db	"      HD"
  2567                                  drv_str:
  2568 0000191F 3020455854454E4445-     	db	"0 EXTENDED DOS PARTITION       ", 0Dh, 0Ah
  2568 00001928 4420444F5320504152-
  2568 00001931 544954494F4E202020-
  2568 0000193A 202020200D0A       
  2569 00001940 3D3D3D3D3D3D3D3D3D-     	db	"=======================================", 0Dh, 0Ah
  2569 00001949 3D3D3D3D3D3D3D3D3D-
  2569 00001952 3D3D3D3D3D3D3D3D3D-
  2569 0000195B 3D3D3D3D3D3D3D3D3D-
  2569 00001964 3D3D3D0D0A         
  2570 00001969 204C6F676963616C20-     	db	" Logical DOS Drive   Type      SIZE    ", 0Dh, 0Ah
  2570 00001972 444F53204472697665-
  2570 0000197B 202020547970652020-
  2570 00001984 2020202053495A4520-
  2570 0000198D 2020200D0A         
  2571 00001992 2D2D2D2D2D2D2D2D2D-     	db	"---------------------------------------", 0Dh, 0Ah, 0
  2571 0000199B 2D2D2D2D2D2D2D2D2D-
  2571 000019A4 2D2D2D2D2D2D2D2D2D-
  2571 000019AD 2D2D2D2D2D2D2D2D2D-
  2571 000019B6 2D2D2D0D0A00       
  2572                                  ldd_row:
  2573 000019BC 202020202020202020-     	db	"                 "
  2573 000019C5 2020202020202020   
  2574                                  ldd_row_dn:
  2575 000019CD 31202020464154          	db	"1   FAT"
  2576                                  ldd_row_fs:
  2577 000019D4 31322020202020          	db	"12     "
  2578                                  ldd_row_sz:
  2579 000019DB 31323847422020200D-     	db	"128GB   ", 0Dh, 0Ah, 0
  2579 000019E4 0A00               
  2580                                  ldd_dline:
  2581 000019E6 3D3D3D3D3D3D3D3D3D-     	db	"=======================================", 0Dh, 0Ah
  2581 000019EF 3D3D3D3D3D3D3D3D3D-
  2581 000019F8 3D3D3D3D3D3D3D3D3D-
  2581 00001A01 3D3D3D3D3D3D3D3D3D-
  2581 00001A0A 3D3D3D0D0A         
  2582 00001A0F 00                      	db	0
  2583                                  
  2584                                  ldd_select_msg:
  2585 00001A10 0D0A0D0A                	db	0Dh, 0Ah, 0Dh, 0Ah
  2586 00001A14 53656C656374206C6F-     	db	"Select logical DOS drive number (1 to "
  2586 00001A1D 676963616C20444F53-
  2586 00001A26 206472697665206E75-
  2586 00001A2F 6D6265722028312074-
  2586 00001A38 6F20               
  2587                                  ldd_select_pn:
  2588 00001A3A 342920746F20666F72-     	db	"4) to format. "
  2588 00001A43 6D61742E20         
  2589 00001A48 0D0A                    	db 	0Dh, 0Ah
  2590 00001A4A 286F72207072657373-     	db	"(or press ESC to cancel) ", 0Dh, 0Ah, 0
  2590 00001A53 2045534320746F2063-
  2590 00001A5C 616E63656C29200D0A-
  2590 00001A65 00                 
  2591                                  
  2592                                  ;align 4 
  2593                                  
  2594                                  msg_sectors_crlf:
  2595 00001A66 20736563746F72          	db	" sector"
  2596                                  msg_sectors_crlf_s:
  2597 00001A6D 73                      	db	"s"
  2598 00001A6E 0D0A00                  	db	0Dh, 0Ah, 0
  2599                                  
  2600                                  vname_length:
  2601 00001A71 00                      	db	0
  2602                                  
  2603                                  bs_oem_name:
  2604                                  	;db	'TRDOS2.0', 0
  2605                                  	; 28/10/2023
  2606 00001A72 524554524F444F5300      	db	'RETRODOS', 0
  2607                                  
  2608 00001A7B 90                      align 2
  2609                                  
  2610                                  no_name:
  2611 00001A7C 4E4F204E414D452020-     	db 	'NO NAME    ', 0
  2611 00001A85 202000             
  2612                                  
  2613                                  Msg_Volume_Name:
  2614 00001A88 0D0A                    	db	0Dh, 0Ah
  2615 00001A8A 0D0A                    	db	0Dh, 0Ah
  2616 00001A8C 566F6C756D65204E61-     	db	"Volume Name: ", 0
  2616 00001A95 6D653A2000         
  2617                                  
  2618                                  Msg_Volume_Serial:
  2619 00001A9A 566F6C756D65205365-     	db	"Volume Serial No: "
  2619 00001AA3 7269616C204E6F3A20 
  2620                                  Vol_Serial1:
  2621 00001AAC 30303030                	db	"0000"
  2622 00001AB0 2D                      	db	"-"
  2623                                  Vol_Serial2:
  2624 00001AB1 30303030                	db	"0000"
  2625 00001AB5 0D0A00                  	db	0Dh, 0Ah, 0
  2626                                  
  2627                                  msg_cluster_count:
  2628 00001AB8 436C75737465722043-     	db	"Cluster Count: ", 0
  2628 00001AC1 6F756E743A2000     
  2629                                  cluster_count_str:
  2630 00001AC8 30303030303030          	db	"0000000"
  2631 00001ACF 0D0A00                  	db	0Dh, 0Ah, 0
  2632                                  msg_formatting:
  2633 00001AD2 466F726D617474696E-     	db	"Formatting ", 0
  2633 00001ADB 672000             
  2634                                  format_percent_str:
  2635 00001ADE 30303025                	db	"000%"
  2636 00001AE2 00                      	db	0
  2637                                  
  2638                                  Msg_3dot_OK:
  2639 00001AE3 2E2E2E                  	db	'...'
  2640                                  Msg_OK:
  2641 00001AE6 204F4B2E                	db	' OK.'
  2642                                  CRLF:
  2643 00001AEA 0D0A00                  	db	0Dh, 0Ah, 0
  2644                                  
  2645                                  Msg_Error:
  2646 00001AED 0D0A                    	db	0Dh, 0Ah
  2647 00001AEF 4572726F72202120        	db	'Error ! '
  2648 00001AF7 28                      	db	'('
  2649                                  error_code:
  2650 00001AF8 3030                    	dw	3030h
  2651 00001AFA 68                      	db	'h'
  2652 00001AFB 2920                    	db	') '
  2653 00001AFD 0D0A                    	db	0Dh, 0Ah
  2654 00001AFF 00                      	db	0
  2655                                  
  2656                                  	; 04/05/2024
  2657                                  FAT32_note:
  2658 00001B00 0D0A                    	db	0Dh, 0Ah
  2659 00001B02 0D0A                    	db	0Dh, 0Ah
  2660 00001B04 4E4F54453A20            	db	'NOTE: '
  2661 00001B0A 0D0A                    	db	0Dh, 0Ah
  2662 00001B0C 0D0A                    	db	0Dh, 0Ah
  2663 00001B0E 526574726F20444F53-     	db	'Retro DOS v4.2 -MSDOS 6.22- does not recognize FAT32 file system.'
  2663 00001B17 2076342E32202D4D53-
  2663 00001B20 444F5320362E32322D-
  2663 00001B29 20646F6573206E6F74-
  2663 00001B32 207265636F676E697A-
  2663 00001B3B 652046415433322066-
  2663 00001B44 696C65207379737465-
  2663 00001B4D 6D2E               
  2664 00001B4F 0D0A                    	db	0Dh, 0Ah
  2665 00001B51 0D0A                    	DB	0Dh, 0Ah
  2666 00001B53 4275742C2052657472-     	db	'But, Retro DOS v5 -PCDOS 7.1- recognizes FAT32 file system and '
  2666 00001B5C 6F20444F5320763520-
  2666 00001B65 2D5043444F5320372E-
  2666 00001B6E 312D207265636F676E-
  2666 00001B77 697A65732046415433-
  2666 00001B80 322066696C65207379-
  2666 00001B89 7374656D20616E6420 
  2667 00001B92 0D0A                    	db	0Dh, 0Ah
  2668 00001B94 69747320626F6F7420-     	db	'its boot sector will be used to format the new FAT32 partition/volume.'
  2668 00001B9D 736563746F72207769-
  2668 00001BA6 6C6C20626520757365-
  2668 00001BAF 6420746F20666F726D-
  2668 00001BB8 617420746865206E65-
  2668 00001BC1 772046415433322070-
  2668 00001BCA 6172746974696F6E2F-
  2668 00001BD3 766F6C756D652E     
  2669 00001BDA 0D0A                    	db	0Dh, 0Ah
  2670 00001BDC 0D0A                    	db	0Dh, 0Ah
  2671                                  	;db	'The kernel file name of the FAT32 boot sector is ', 34,'PCDOS.SYS', 34,'.'
  2672                                  	;db	0Dh, 0Ah
  2673                                  	;db	0Dh, 0Ah 
  2674 00001BDE 507265737320454E54-     	db	'Press ENTER to CONTINUE or press another key to CANCEL.'
  2674 00001BE7 455220746F20434F4E-
  2674 00001BF0 54494E5545206F7220-
  2674 00001BF9 707265737320616E6F-
  2674 00001C02 74686572206B657920-
  2674 00001C0B 746F2043414E43454C-
  2674 00001C14 2E                 
  2675 00001C15 0D0A0D0A00              	db	0Dh, 0Ah, 0Dh, 0Ah, 0
  2676                                  
  2677                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2678                                  ;  initialized buffers
  2679                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2680                                  
  2681                                  HDFORMAT_SECBUFFER:
  2682 00001C1A F6<rep 200h>            	times	512 db 0F6h
  2683                                  HDFORMAT_FSINFO_BUFF:
  2684 00001E1A 52526141                	dd	41615252h  ; FSI_LeadSig
  2685 00001E1E 00<rep 1E0h>            	times	480 db 0   ; FSI_Reserved1
  2686 00001FFE 72724161                	dd	61417272h  ; FSI_StrucSig
  2687 00002002 FFFFFFFF                	dd	0FFFFFFFFh ; FSI_Free_Count
  2688 00002006 02000000                	dd	000000002h ; FSI_Nxt_Free
  2689 0000200A 00<rep Ch>              	times	12 db 0	   ; FSI_Reserved2
  2690 00002016 000055AA                	dd	0AA550000h ; FSI_TrailSig
  2691                                  
  2692                                  ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  2693                                  
  2694 0000201A [2822]                  lddt_ptr dw lddt
  2695                                  
  2696                                  ;SizeOfFile equ $-100
  2697                                  
  2698                                  ; ----------------------------------------------------------------------------
  2699                                  ; uninitialized data
  2700                                  ; ----------------------------------------------------------------------------
  2701                                  
  2702                                  bss_start:
  2703                                  
  2704                                  ABSOLUTE bss_start
  2705                                  
  2706                                  alignb 4
  2707                                  
  2708 0000201C ??                      fsID:	resb 1
  2709 0000201D ??                      rw:	resb 1
  2710 0000201E ????                    csize:	resw 1 ; heads*spt (sectors per cylinder)
  2711                                  
  2712 00002020 ????????                dosp_start: resd 1 ; start sector of the (primary) dos partition
  2713 00002024 ????????                dosp_size:  resd 1 ; partition size in sectors
  2714                                  
  2715                                  MBR:
  2716                                  bootsector:
  2717                                  ; 	resb 512
  2718                                  HDFORMAT_FATBUFFER:
  2719                                  HDFORMAT_EMPTY_BUFF:
  2720 00002028 <res 200h>              	resb 512
  2721                                  
  2722                                  ;HDFORMAT_FATBUFFER:
  2723                                  ;HDFORMAT_EMPTY_BUFF:
  2724                                  ;	resb 512
  2725                                  
  2726                                  ; logical dos drives table
  2727 00002228 <res 40h>               lddt:	resb 4*16 ; 64 bytes
  2728                                  
  2729 00002268 ????????                EP_Start:	resd 1
  2730 0000226C ????????                EP_Start_x:	resd 1
  2731                                  
  2732 00002270 ????????                data_start:	resd 1
  2733 00002274 ????????                data_sectors:	resd 1
  2734 00002278 ????????                cluster_count:	resd 1
  2735 0000227C ????                    root_dir_secs:	resw 1
  2736 0000227E ????                    format_percent: resw 1
  2737 00002280 ??                      prev_percent:	resb 1
  2738 00002281 ??                      rsvdbyte:	resb 1
  2739                                  
  2740 00002282 ????                    old_sp:		resw 1
  2741                                  
  2742 00002284 <res Ch>                StrVolumeName:	resb 12
  2743                                  
  2744 00002290 ????                    lddt_save:	resw 1
  2745                                  
  2746                                  end_bss:
