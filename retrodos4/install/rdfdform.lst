     1                                  ; ****************************************************************************
     2                                  ; FDFORMAT.ASM (FDFORMAT.COM) - Retro DOS v4 Floppy Disk Formatting Utility
     3                                  ; (RDFDFORM.S - RDFDFORM.COM)						      (for MSDOS/WINDOWS)
     4                                  ; ----------------------------------------------------------------------------
     5                                  ; Last Update: 28/10/2023
     6                                  ; ----------------------------------------------------------------------------
     7                                  ; Beginning: 26/10/2023
     8                                  ; ----------------------------------------------------------------------------
     9                                  ; Assembler: NASM version 2.15
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Modified from 'rdfdboot.s'(RDFHDBOOT.COM) source code by Erdogan Tan
    12                                  ; (25/10/2023) - RETRODOS v4 foppy disk boot sector update utility -
    13                                  ; ----------------------------------------------------------------------------
    14                                  ; Modified from 'fdformat.s'(FDFORMAT.COM) source code by Erdogan Tan
    15                                  ; (12/08/2018) - TRDOS 386 1440KB floppy disk formatting utility -
    16                                  ; ****************************************************************************
    17                                  ; nasm fdformat.asm -l fdformat.lst -o FDFORMAT.COM
    18                                  
    19                                  ; boot sector parameters
    20                                  
    21                                  bsOemName	equ 3
    22                                  bsBytesPerSec	equ 11 ; 512 (word)
    23                                  bsSecPerClust	equ 13
    24                                  bsResSectors	equ 14
    25                                  bsFATs		equ 16
    26                                  bsRootDirEnts	equ 17
    27                                  bsSectors	equ 19
    28                                  bsMedia		equ 21
    29                                  bsFATsecs	equ 22
    30                                  bsSecPerTrack	equ 24 ; 18 (word)
    31                                  bsHeads		equ 26 ; 2 (word)
    32                                  bsHidden1	equ 28
    33                                  bsHidden2	equ 30
    34                                  bsHugeSectors	equ 32
    35                                  bsDriveNumber	equ 36
    36                                  bsReserved1	equ 37
    37                                  bsBpbSignature	equ 38 ; 29h (byte)
    38                                  bsVolumeID	equ 39
    39                                  bsVolumeLabel	equ 43
    40                                  bsFileSysType	equ 54 ; 'FAT12   '  (8 bytes)
    41                                  bsReserved2	equ 62
    42                                  ; TRDOS 386 v2.0 2018 Extensions
    43                                  bsDataStart	equ 64
    44                                  bsRootDirStart	equ 66
    45                                  bsRootDirSects	equ 68
    46                                  bsDirEntsPerSec equ 70
    47                                  
    48                                  [BITS 16]
    49                                  [ORG 100h]
    50                                  
    51 00000000 FA                      	cli
    52 00000001 FC                      	cld
    53 00000002 0E                      	push	cs
    54 00000003 17                      	pop	ss
    55 00000004 BCFEFF                  	mov	sp, 0FFFEh
    56 00000007 FB                      	sti
    57                                  
    58                                  ;-----------------------------------------------------------------
    59                                  ; see if drive specified
    60                                  ;-----------------------------------------------------------------
    61                                  
    62 00000008 BE8000                  	mov	si, 80h			; PSP command tail
    63 0000000B 8A0C                    	mov	cl, [si]
    64 0000000D 46                      	inc	si
    65 0000000E 08C9                    	or	cl, cl                               
    66 00000010 7503                    	jnz	short T_01		; jump if not zero
    67                                  R_10:
    68 00000012 E9BF01                  	jmp	T_07
    69                                  T_01:
    70 00000015 AC                      	lodsb
    71 00000016 3C20                    	cmp	al, ' '			; is it SPACE ?
    72 00000018 753A                    	jne	short T_03
    73                                  R_01:
    74 0000001A FEC9                    	dec	cl                                  
    75 0000001C 75F7                    	jnz	short T_01                  
    76 0000001E EBF2                    	jmp	short R_10
    77                                  T_02:
    78 00000020 3C2D                    	cmp	al, '-'
    79 00000022 75EE                    	jne	short R_10
    80                                  
    81                                  	; 28/10/2023
    82 00000024 FEC9                    	dec	cl ; previous lodsb
    83 00000026 FEC9                    	dec	cl ; following lodsb
    84 00000028 7EE8                    	jng	short R_10
    85                                  
    86 0000002A AC                      	lodsb
    87 0000002B 3C35                    	cmp	al, '5'
    88 0000002D 77E3                    	ja	short R_10
    89 0000002F 3C31                    	cmp	al, '1'
    90 00000031 72DF                    	jb	short R_10
    91 00000033 803E[790A]00            	cmp	byte [option], 0
    92 00000038 77D8                    	ja	short R_10
    93 0000003A 2C30                    	sub	al, '0'
    94 0000003C A2[790A]                	mov	[option], al		; save numeric character
    95 0000003F 803C78                  	cmp	byte [si], 'x'
    96                                  	;jne	short T_01
    97                                  	; 28/10/2023
    98 00000042 7509                    	jne	short R_02	
    99                                  
   100                                  	; 28/10/2023
   101 00000044 FEC9                    	dec	cl  ; following lodsb	
   102 00000046 74CA                    	jz	short R_10
   103                                  
   104 00000048 FE06[780A]              	inc	byte [hard_format]	; INT 13h Function 05h
   105                                  	
   106                                  	; 28/10/2023
   107                                  	;lodsb	; al = 'x'
   108 0000004C 46                      	inc	si	
   109                                  	;jmp	short T_01
   110                                  R_02:
   111                                  	; 28/10/2023
   112 0000004D AC                      	lodsb
   113 0000004E 3C20                    	cmp	al, ' '
   114 00000050 75C0                    	jne	short R_10 ; must be '-#x ' or '-# ', but not !
   115 00000052 EBC6                    	jmp	short R_01 ; dec cl for previous lodsb
   116                                  T_03:
   117 00000054 3C41                    	cmp	al, 'A'
   118 00000056 72C8                    	jb	short T_02
   119 00000058 3C5A                    	cmp	al, 'Z'			; A - Z
   120 0000005A 7614                    	jna	short T_04                    
   121 0000005C 3C61                    	cmp	al, 'a'			; a - z 
   122 0000005E 72B2                    	jb	short R_10               
   123 00000060 3C7A                    	cmp	al, 'z'                           
   124 00000062 77AE                    	ja	short R_10               
   125                                  
   126 00000064 803C20                  	cmp	byte [si], 20h		; 'A ' accepted
   127 00000067 7605                    	jna	short R_11
   128                                  
   129 00000069 803C3A                  	cmp	byte [si], ':'		; 'A:' is normal
   130 0000006C 75A4                    	jne	short R_10
   131                                  R_11:
   132 0000006E 2C20                    	sub	al, 'a'-'A'		; to upper case
   133                                  
   134                                  ;-----------------------------------------------------------------
   135                                  ; write drive letter
   136                                  ;-----------------------------------------------------------------
   137                                  
   138                                  T_04:
   139 00000070 A2[FA08]                	mov	[RD_Drive], al		; save disk name 
   140                                  
   141                                  ;-----------------------------------------------------------------
   142                                  ; Check disk parameters
   143                                  ;-----------------------------------------------------------------
   144                                  
   145 00000073 2C41                    	sub	al, 'A'			; make it zero based 
   146 00000075 88C2                    	mov	dl, al                           
   147 00000077 A2[7B0A]                	mov	[DriveNumber], al 	; bios disk (drive) number	
   148 0000007A B408                    	mov	ah, 08h
   149 0000007C CD13                    	int	13h			; return disk parameters
   150 0000007E 7254                    	jc	short R_15   ; Drive not ready error
   151                                  
   152 00000080 0E                      	push	cs
   153 00000081 07                      	pop	es			; restore es
   154                                  
   155 00000082 B705                    	mov	bh, 5
   156                                  
   157 00000084 38FB                    	cmp	bl, bh ; 5		; Drive Type
   158 00000086 770C                    	ja	short T_25   ; unknown diskette drive
   159 00000088 08DB                    	or	bl, bl
   160 0000008A 7408                    	jz	short T_25   ; invalid
   161                                  
   162 0000008C 881E[7C0A]              	mov	[drive_type], bl
   163 00000090 881E[7F0A]              	mov	[disk_type], bl
   164                                  
   165                                  T_25:
   166                                  	; check for valid FAT12 BS
   167 00000094 883E[4413]              	mov	[RetryCount], bh ; 5
   168                                  	
   169 00000098 BB[4613]                	mov	bx, bootsector		; location of boot code
   170                                  
   171 0000009B B90100                  	mov	cx, 1 ; *		; cylinder = 0
   172                                  					; sector = 1
   173 0000009E B600                    	mov	dh, 0			; head = 0
   174 000000A0 8A16[7B0A]              	mov	dl, [DriveNumber] 
   175                                  R_05:
   176 000000A4 B80102                  	mov	ax, 0201h		; read disk
   177 000000A7 CD13                    	int	13h
   178                                  	;jc	short T_14	
   179 000000A9 735C                    	jnc	short R_06		; read boot sector, OK
   180                                  
   181                                  	; reset
   182 000000AB 31C0                    	xor	ax, ax
   183 000000AD CD13                    	int	13h
   184                                  
   185 000000AF FE0E[4413]              	dec	byte [RetryCount]
   186 000000B3 75EF                    	jnz	short R_05
   187                                  
   188                                  	; Compare option against default capacity
   189 000000B5 31C9                    	xor	cx, cx ; cx = 0
   190 000000B7 31DB                    	xor	bx, bx
   191 000000B9 8A1E[790A]              	mov	bl, [option]
   192 000000BD 08DB                    	or	bl, bl
   193 000000BF 750A                    	jnz	short R_04
   194                                  
   195 000000C1 803E[7C0A]00            	cmp	byte [drive_type], 0
   196 000000C6 760C                    	jna	short R_15	; disk read error 
   197                                  	; [disk_type] = [drive_type]
   198 000000C8 E9A100                  	jmp	T_32	; skip inserted and requested msgs
   199                                  
   200                                  R_04:
   201                                  	; option > 0
   202 000000CB 803E[7C0A]00            	cmp	byte [drive_type], 0 ; unknown ?
   203 000000D0 7602                    	jna	short R_15  ; error
   204 000000D2 EB79                    	jmp	short T_27  ; skip inserted disk recognization
   205                                  
   206                                  R_15:	
   207 000000D4 BE[B109]                	mov	si, Disk_NotReadyOrError
   208                                  R_14:
   209 000000D7 E8E503                  	call	print_msg
   210                                  
   211 000000DA BE[A509]                	mov	si, CRLF
   212 000000DD E8DF03                  	call	print_msg
   213                                  
   214 000000E0 CD20                    	int	20h
   215                                  
   216                                  hang:
   217 000000E2 F4                      	hlt
   218 000000E3 EBFD                    	jmp	short hang
   219                                  
   220                                  compatibility:
   221                                  	; al = disk type (option)
   222 000000E5 50                      	push	ax
   223 000000E6 30FF                    	xor	bh, bh
   224 000000E8 383E[7C0A]              	cmp	[drive_type], bh ; 0
   225 000000EC 7617                    	jna	short compat_retn
   226 000000EE 88C3                    	mov	bl, al
   227 000000F0 D1E3                    	shl	bx, 1
   228 000000F2 81C3[7E0A]              	add	bx, drive_compat-2
   229 000000F6 8B07                    	mov	ax, [bx] ; compatible drives (for the disk)
   230 000000F8 3A06[7C0A]              	cmp	al, [drive_type] ; itself
   231 000000FC 7407                    	je	short compat_retn
   232 000000FE 3A26[7C0A]              	cmp	ah, [drive_type] ; other one
   233 00000102 7601                    	jna	short compat_retn
   234 00000104 F9                      	stc	
   235                                  compat_retn:
   236 00000105 58                      	pop	ax
   237 00000106 C3                      	retn
   238                                  
   239                                  R_06:
   240                                  	; check if the disk is already formatted DOS FAT12 disk
   241                                  	; (It's type will be used if it is compatible with the drive)
   242                                  	; ((for example: 720KB disk is compatible with 1.44MB drive))
   243                                  
   244                                  R_13:	
   245 00000107 813E[5113]0002          	cmp	word [bootsector+bsBytesPerSec], 512
   246 0000010D 753E                    	jne	short T_27
   247 0000010F 803E[6C13]29            	cmp	byte [bootsector+bsBpbSignature], 29h
   248 00000114 7537                    	jne	short T_27
   249 00000116 8B16[5913]              	mov	dx, [bootsector+bsSectors]
   250 0000011A B001                    	mov	al, 1
   251 0000011C 81FAD002                	cmp	dx, 720
   252 00000120 7420                    	je	short T_26
   253 00000122 FEC0                    	inc	al ; 2
   254 00000124 81FA6009                	cmp	dx, 2400
   255 00000128 7418                    	je	short T_26
   256 0000012A FEC0                    	inc	al ; 3
   257 0000012C 81FAA005                	cmp	dx, 1440
   258 00000130 7410                    	je	short T_26
   259 00000132 FEC0                    	inc	al ; 4
   260 00000134 81FA400B                	cmp	dx, 2880
   261 00000138 7408                    	je	short T_26
   262 0000013A FEC0                    	inc	al ; 5
   263 0000013C 81FA8016                	cmp	dx, 5760
   264 00000140 750B                    	jne	short T_27
   265                                  
   266                                  T_26:
   267                                  	; al = disk/drive type
   268 00000142 E8A0FF                  	call	compatibility
   269 00000145 7206                    	jc	short T_27
   270 00000147 A2[7D0A]                	mov	[inserted], al	; inserted disk type
   271 0000014A A2[7F0A]                	mov	[disk_type], al
   272                                  T_27:
   273 0000014D A0[790A]                	mov	al, [option]
   274 00000150 08C0                    	or	al, al
   275 00000152 7411                    	jz	short T_29
   276 00000154 E88EFF                  	call	compatibility
   277 00000157 7306                    	jnc	short T_28
   278                                  R_03:	
   279 00000159 BE[E509]                	mov	si, option_not_compat_msg
   280 0000015C E978FF                  	jmp	R_14
   281                                  T_28:
   282 0000015F A2[7E0A]                	mov	[requested], al
   283 00000162 A2[7F0A]                	mov	[disk_type], al
   284                                  T_29:
   285 00000165 803E[7C0A]00            	cmp	byte [drive_type], 0
   286 0000016A 760F                    	jna	short T_30
   287                                  T_32:
   288                                  	;mov	al, [DriveNumber]
   289                                  	;add	al, 'A'
   290 0000016C A0[FA08]                	mov	al, [RD_Drive]
   291 0000016F A2[F60A]                	mov	[DrvNum_Str], al
   292 00000172 BE[EE0A]                	mov	si, DrvType_Info_Msg
   293 00000175 E84703                  	call	print_msg
   294                                  	;sub	al, al ; drive type will be used
   295 00000178 E83203                  	call	get_drive_type_str
   296                                  	;call	print_msg
   297                                  T_30:
   298 0000017B 803E[7D0A]00            	cmp	byte [inserted], 0
   299 00000180 760C                    	jna	short T_31
   300                                  
   301 00000182 BE[160B]                	mov	si, DiskType_nfo_msg
   302 00000185 E83703                  	call	print_msg
   303 00000188 A0[7D0A]                	mov	al, [inserted] ; disk type will be used
   304 0000018B E81F03                  	call	get_drive_type_str
   305                                  	;call	print_msg
   306                                  
   307                                  T_31:
   308 0000018E 803E[7E0A]00            	cmp	byte [requested], 0
   309 00000193 7612                    	jna	short T_33
   310                                  
   311 00000195 BE[090B]                	mov	si, ReqDrvType_Msg1
   312 00000198 E82403                  	call	print_msg
   313 0000019B BE[210B]                	mov	si, ReqDrvType_Msg2
   314 0000019E E81E03                  	call	print_msg
   315 000001A1 A0[7E0A]                	mov	al, [requested]
   316 000001A4 E80603                  	call	get_drive_type_str
   317                                  	;call	print_msg
   318                                  
   319                                  ;-----------------------------------------------------------------
   320                                  ; Format question
   321                                  ;-----------------------------------------------------------------
   322                                  
   323                                  T_33:
   324 000001A7 BE[9B08]                	mov	si, Msg_DoYouWantToFormat
   325 000001AA E81203                  	call	print_msg
   326                                  
   327                                  T_05:
   328 000001AD 31C0                    	xor	ax, ax
   329 000001AF CD16                    	int	16h			; wait for keyboard command
   330 000001B1 3C03                    	cmp	al, 'C'-40h
   331 000001B3 7414                    	je	short T_06 ; Exit                   
   332 000001B5 3C1B                    	cmp	al, 27
   333 000001B7 7410                    	je	short T_06 ; Exit
   334 000001B9 24DF                    	and	al, 0DFh
   335 000001BB 3C59                    	cmp	al, 'Y'				; Yes?
   336 000001BD 741D                    	je	short T_08			; write
   337 000001BF 3C4E                    	cmp	al, 'N'				; No?
   338 000001C1 75EA                    	jne	short T_05          
   339                                  						; no write (exit)  
   340 000001C3 BE[AD09]                	mov	si, Msg_NO
   341 000001C6 E8F602                  	call	print_msg 
   342                                  
   343                                  ;-----------------------------------------------------------------
   344                                  ; Nextline & Exit
   345                                  ;-----------------------------------------------------------------
   346                                  
   347                                  T_06:
   348 000001C9 BE[A509]                	mov	si, CRLF
   349 000001CC E8F002                  	call	print_msg
   350 000001CF B8004C                  	mov	ax, 4C00h		; terminate
   351 000001D2 CD21                    	int	21h
   352                                  
   353                                  T_07:
   354 000001D4 BE[F106]                	mov	si, RD_Welcome
   355 000001D7 E8E502                  	call	print_msg
   356 000001DA EBED                    	jmp	short T_06 ; Exit
   357                                  
   358                                  ;-----------------------------------------------------------------
   359                                  ; writing root directory sectors
   360                                  ;-----------------------------------------------------------------
   361                                  
   362                                  T_08:
   363 000001DC BE[A809]                	mov	si, Msg_YES
   364 000001DF E8DD02                  	call	print_msg
   365                                  T_09:
   366 000001E2 BE[A509]                	mov	si, CRLF
   367 000001E5 E8D702                  	call	print_msg
   368                                  
   369 000001E8 803E[500A]00            	cmp	byte [Error_Code], 0
   370 000001ED 7703                    	ja	short R_17
   371                                  
   372 000001EF E8DC02                  	call	set_rdfd_bs
   373                                  R_17:
   374 000001F2 803E[7A0A]00            	cmp	byte [step], 0
   375 000001F7 7715                    	ja	short R_18
   376                                  
   377                                  	;mov	byte [step], 0
   378                                  
   379 000001F9 803E[780A]00            	cmp	byte [hard_format], 0
   380 000001FE 760E                    	jna	short R_18
   381                                  
   382 00000200 BE[510A]                	mov	si, Msg_Formatting_Tracks
   383 00000203 E8B902                  	call	print_msg
   384                                  
   385 00000206 E8FC02                  	call	format_tracks	
   386 00000209 7303                    	jnc	short R_18
   387                                  R_07:
   388 0000020B E94C01                  	jmp	T_19
   389                                  R_18:
   390 0000020E 803E[7A0A]01            	cmp	byte [step], 1
   391 00000213 7727                    	ja	short R_19
   392                                  
   393 00000215 C606[7A0A]01            	mov	byte [step], 1
   394                                  
   395 0000021A BE[2E09]                	mov	si, Msg_Writing_Root_Dir
   396 0000021D E89F02                  	call	print_msg
   397                                  
   398 00000220 A1[6F0B]                	mov	ax, [RD_FAT12_fd_bs+bsRootDirStart]
   399 00000223 BB[3011]                	mov	bx, FDFORMAT_FATBUFFER_S9
   400 00000226 8B36[710B]              	mov	si, [RD_FAT12_fd_bs+bsRootDirSects]
   401 0000022A 01C6                    	add	si, ax
   402                                  T_10:
   403 0000022C E86E01                  	call	write_fd_sector
   404 0000022F 72DA                    	jc	short R_07
   405 00000231 40                      	inc	ax
   406 00000232 39F0                     	cmp	ax, si
   407 00000234 72F6                    	jb	short T_10
   408                                  
   409 00000236 BE[A109]                	mov	si, Msg_OK
   410 00000239 E88302                  	call	print_msg
   411                                  
   412                                  ;-----------------------------------------------------------------
   413                                  ; writing data sectors
   414                                  ;-----------------------------------------------------------------
   415                                  
   416                                  R_19:
   417 0000023C 803E[7A0A]02            	cmp	byte [step], 2
   418 00000241 7756                    	ja	short R_20
   419                                  
   420                                  	; If hard format is selected, do not write data sectors
   421 00000243 803E[780A]00            	cmp	byte [hard_format], 0
   422 00000248 774F                    	ja	short R_20
   423                                  
   424 0000024A C606[7A0A]02            	mov	byte [step], 2
   425                                  
   426 0000024F BE[5009]                	mov	si, Msg_Writing_Data_Sectors
   427 00000252 E86A02                  	call	print_msg
   428 00000255 B403                    	mov	ah, 3
   429 00000257 BB0700                  	mov	bx, 7
   430 0000025A CD10                    	int	10h ; Return Cursor Position
   431                                  	; DL = Column, DH= Line
   432 0000025C 8916[6B09]              	mov	[Cursor_Pos], dx
   433 00000260 A1[6D0B]                	mov	ax, [RD_FAT12_fd_bs+bsDataStart]
   434                                  T_11:
   435 00000263 50                      	push	ax
   436 00000264 40                      	inc	ax ; 1 based printing of 0 based sectors
   437 00000265 BE[6909]                	mov	si, Sector_Str + 3
   438 00000268 E89401                  	call	bin_to_decimal
   439 0000026B 8B16[6B09]              	mov	dx, [Cursor_Pos]
   440 0000026F B402                    	mov	ah, 2
   441 00000271 CD10                    	int	10h  ; Set Cursor Position
   442 00000273 E84902                  	call	print_msg
   443 00000276 58                      	pop	ax
   444 00000277 BB[2D0F]                	mov	bx, FDFORMAT_SECBUFFER
   445 0000027A E82001                  	call	write_fd_sector
   446 0000027D 730A                    	jnc	short T_12
   447 0000027F 80E416                  	and	ah, 16h  ; Errors: 2h, 4h, 10h
   448 00000282 7487                    	jz	short R_07 ; Drive not ready msg
   449                                  
   450                                  	; DX = LBA sector value
   451 00000284 52                      	push	dx
   452 00000285 E84601                  	call	mark_bad_cluster
   453 00000288 58                      	pop	ax
   454                                  T_12:
   455 00000289 BB0700                  	mov	bx, 7
   456 0000028C 40                      	inc	ax
   457 0000028D 3B06[400B]              	cmp	ax, [RD_FAT12_fd_bs+bsSectors]
   458 00000291 72D0                    	jb	short T_11
   459                                  
   460 00000293 BE[9E09]                	mov	si, Msg_3dot_OK
   461 00000296 E82602                  	call	print_msg
   462                                  
   463                                  ;-----------------------------------------------------------------
   464                                  ; writing FAT sectors
   465                                  ;-----------------------------------------------------------------
   466                                  
   467                                  R_20:
   468 00000299 803E[7A0A]03            	cmp	byte [step], 3
   469 0000029E 776B                    	ja	short T_17
   470                                  
   471 000002A0 C606[7A0A]03            	mov	byte [step], 3
   472                                  
   473 000002A5 BE[6D09]                	mov	si, Msg_Writing_FAT_Sectors
   474 000002A8 E81402                  	call	print_msg
   475 000002AB B80100                  	mov	ax, 1  ; FAT Beginning Address
   476 000002AE BB[2D11]                	mov	bx, FDFORMAT_FATBUFFER
   477 000002B1 E8E900                  	call	write_fd_sector
   478 000002B4 7225                    	jc	short R_08
   479 000002B6 BB[3011]                	mov	bx, FDFORMAT_FATBUFFER_S9
   480 000002B9 8B36[430B]              	mov	si, [RD_FAT12_fd_bs+bsFATsecs]
   481                                  T_13:
   482 000002BD 40                      	inc	ax
   483 000002BE E8DC00                  	call	write_fd_sector
   484 000002C1 7218                     	jc	short R_08
   485 000002C3 39F0                    	cmp	ax, si
   486 000002C5 72F6                    	jb	short T_13
   487 000002C7 BB[2D11]                	mov	bx, FDFORMAT_FATBUFFER
   488 000002CA 40                      	inc	ax
   489 000002CB E8CF00                  	call	write_fd_sector
   490 000002CE 720B                    	jc	short R_08
   491 000002D0 BB[3011]                	mov	bx, FDFORMAT_FATBUFFER_S9
   492 000002D3 D1E6                    	shl	si, 1 ; 2nd FAT
   493                                  T_14:
   494 000002D5 40                      	inc	ax 
   495 000002D6 E8C400                          call	write_fd_sector
   496 000002D9 7302                    	jnc	short R_09
   497                                  R_08:
   498 000002DB EB7D                    	jmp	T_19
   499                                  R_09:
   500 000002DD 39F0                    	cmp	ax, si
   501 000002DF 72F4                    	jb	short T_14
   502                                  
   503 000002E1 BE[A109]                	mov	si, Msg_OK
   504 000002E4 E8D801                  	call	print_msg
   505                                  
   506 000002E7 BE[9009]                	mov	si, Msg_Volume_Name
   507 000002EA E8D201                  	call	print_msg
   508 000002ED E82401                  	call	rw_char
   509 000002F0 7219                    	jc	short T_17
   510 000002F2 8A04                    	mov	al, [si]
   511 000002F4 3C20                    	cmp	al, 20h
   512 000002F6 7613                    	jna	short T_17
   513 000002F8 BF[580B]                	mov	di, RD_FAT12_fd_bs+bsVolumeLabel
   514 000002FB B90B00                  	mov	cx, 11
   515 000002FE 46                      	inc	si  
   516 000002FF EB06                    	jmp	short T_16  
   517                                  
   518                                  T_15:
   519 00000301 AC                      	lodsb
   520 00000302 47                      	inc	di
   521 00000303 3C20                    	cmp	al, 20h
   522 00000305 767D                    	jna	short T_22
   523                                  T_16:
   524 00000307 8805                    	mov 	[di], al
   525 00000309 E2F6                    	loop	T_15
   526                                  
   527                                  T_17:
   528 0000030B C606[7A0A]04            	mov	byte [step], 4
   529                                  
   530 00000310 BE[0809]                	mov	si, Msg_Writing_Boot_Sector
   531 00000313 E8A901                  	call	print_msg
   532                                  
   533 00000316 C606[4413]04            	mov	byte [RetryCount], 4
   534                                  T_18:
   535 0000031B BE[540B]                	mov	si, RD_FAT12_fd_bs+bsVolumeID
   536                                  
   537 0000031E 31C0                    	xor	ax, ax
   538 00000320 CD1A                    	int	1Ah			; get time of day
   539 00000322 8914                    	mov	[si], dx
   540 00000324 894C02                  	mov	[si+2], cx		; set unique volume ID
   541                                  
   542 00000327 B402                    	mov	ah, 02h			; Return Current Time
   543 00000329 CD1A                    	int	1Ah
   544 0000032B 86E9                    	xchg	ch, cl
   545 0000032D 86F2                    	xchg	dh, dl
   546                                  
   547 0000032F 01D1                    	add	cx, dx  
   548 00000331 014C02                  	add	[si+2], cx
   549                                                 
   550 00000334 B404                    	mov	ah, 04h			; Return Current Date
   551 00000336 CD1A                    	int	1Ah
   552 00000338 86E9                    	xchg	ch,cl
   553 0000033A 86F2                    	xchg	dh,dl
   554                                  
   555 0000033C 01D1                    	add	cx, dx  
   556 0000033E 014C02                  	add	[si+2], cx
   557                                  
   558 00000341 B80103                  	mov	ax, 0301h		; write to disk
   559 00000344 BB[2D0B]                	mov	bx, RD_FAT12_fd_bs	; location of boot code
   560                                  
   561 00000347 B90100                  	mov	cx, 1			; cylinder = 0
   562                                                       			; sector = 1
   563 0000034A B600                    	mov	dh, 0			; head = 0
   564 0000034C 8A16[7B0A]              	mov	dl, [DriveNumber]
   565 00000350 CD13                    	int	13h
   566 00000352 7341                    	jnc	short T_24
   567 00000354 FE0E[4413]              	dec	byte [RetryCount]
   568 00000358 75C1                    	jnz	short T_18
   569                                  
   570                                  T_19:
   571 0000035A BE[B109]                	mov	si, Disk_NotReadyOrError
   572 0000035D E85F01                  	call	print_msg
   573 00000360 BE[D309]                	mov	si, Try_Again_Msg
   574 00000363 E85901                  	call	print_msg
   575                                  
   576                                  T_20:
   577 00000366 31C0                    	xor	ax, ax
   578 00000368 CD16                    	int	16h			; wait for keyboard command
   579 0000036A 3C03                    	cmp	al, 'C'-40h
   580 0000036C 740E                    	je	short T_21 ; Exit                   
   581 0000036E 3C1B                    	cmp	al, 27
   582 00000370 740A                     	je	short T_21 ; Exit
   583 00000372 24DF                    	and	al, 0DFh
   584 00000374 3C59                    	cmp	al, 'Y'
   585 00000376 7415                    	je	short T_23		; Retry
   586 00000378 3C4E                    	cmp	al, 'N'
   587 0000037A 75EA                    	jne	short short T_20
   588                                  
   589                                  T_21:					; Exit
   590 0000037C BE[A509]                	mov	si, CRLF
   591 0000037F E83D01                  	call	print_msg
   592                                  
   593 00000382 CD20                    	int	20h
   594                                  
   595                                  T_22:
   596 00000384 C60520                  	mov	byte [DI], 20h
   597 00000387 47                      	inc	di
   598 00000388 E2FA                    	loop	T_22
   599 0000038A E97EFF                  	jmp	T_17
   600                                  
   601                                  T_23:
   602 0000038D C606[500A]FF            	mov	byte [Error_Code], 0FFh
   603 00000392 E94DFE                  	jmp	T_09
   604                                  
   605                                  T_24:
   606 00000395 BE[A109]                	mov	si, Msg_OK
   607 00000398 E82401                  	call	print_msg
   608 0000039B EBDF                    	jmp	short T_21
   609                                  
   610                                  write_fd_sector:
   611                                  	; Only for 1.44 MB FAT12 Floppy Disks
   612                                  	; INPUT -> AX = Logical Block Address
   613                                  	; ES:BX = Sector Buffer
   614                                  	; OUTPUT ->
   615                                  	; cf = 0 -> AX = Logical Block Address
   616                                  	; cf = 1 -> DX = Logical Block Address
   617                                  	; cf = 1 -> AH = Error Number
   618                                  	;
   619 0000039D B90400                  	mov	cx, 4  ; Retry Count
   620                                  loc_write_fdisk_chs:
   621 000003A0 50                      	push	ax                      ; Linear sector number
   622 000003A1 51                      	push	cx                      
   623 000003A2 8B16[450B]              	mov	dx, [RD_FAT12_fd_bs+bsSecPerTrack]
   624                                  					; Sectors per Track
   625 000003A6 F6F2                    	div	dl
   626 000003A8 88E1                    	mov	cl, ah                  ; Sector (zero based)
   627 000003AA FEC1                    	inc	cl                      ; To make it 1 based
   628 000003AC D0E8                    	shr	al, 1                   ; Convert Track to Cylinder
   629 000003AE 80D600                  	adc	dh, 0                   ; Head (0 or 1)
   630                                  	;mov	si, RD_FAT12_fd_bs+bsDriveNumber
   631                                  	;mov	dl, [si]
   632 000003B1 8A16[7B0A]              	mov	dl, [DriveNumber]
   633 000003B5 88C5                    	mov	ch, al                   
   634 000003B7 B80103                  	mov	ax, 0301h
   635 000003BA CD13                    	int	13h                     ; BIOS Service func ( ah ) = 3
   636                                                                          ; Write disk sectors
   637 000003BC 8826[500A]              	mov 	[Error_Code], ah
   638 000003C0 59                      	pop	cx
   639 000003C1 58                      	pop	ax
   640                                  
   641 000003C2 7309                    	jnc	short pass_write_fdisk_chs_error
   642 000003C4 E2DA                    	loop	loc_write_fdisk_chs
   643 000003C6 89C2                    	mov	dx, ax
   644 000003C8 8A26[500A]              	mov	ah, [Error_Code]
   645 000003CC F9                      	stc
   646                                  pass_write_fdisk_chs_error:
   647 000003CD C3                      	retn
   648                                  
   649                                  mark_bad_cluster:
   650                                  	; Only for FAT12 Floppy Disks (Full FAT Buffer)
   651                                  	; INPUT -> AX = Cluster/Sector Number
   652                                  	; OUTPUT -> 0FF7h = BAD Cluster Value
   653 000003CE BA0300                  	mov     dx, 3
   654 000003D1 F7E2                    	mul     dx
   655 000003D3 D1E8                    	shr     ax, 1 ; Divide by 2
   656 000003D5 89C3                    	mov     bx, ax  ; FAT Buffer Byte Offset
   657 000003D7 BAF70F                  	mov     dx, 0FF7h ; "BAD CLUSTER" sign
   658                                  loc_update_fat12_cell:
   659 000003DA 8B87[2D11]              	mov     ax, [FDFORMAT_FATBUFFER+BX]
   660 000003DE 7312                    	jnc     short uc_FAT12_nc_even
   661 000003E0 83E00F                  	and     ax, 0Fh
   662 000003E3 D1E2                    	shl     dx, 1
   663 000003E5 D1E2                    	shl     dx, 1
   664 000003E7 D1E2                    	shl     dx, 1
   665 000003E9 D1E2                    	shl     dx, 1
   666 000003EB 09C2                    	or      dx, ax
   667 000003ED 8997[2D11]              	mov     [FDFORMAT_FATBUFFER+bx], dx
   668 000003F1 C3                      	retn
   669                                  uc_FAT12_nc_even:
   670 000003F2 2500F0                  	and     ax, 0F000h
   671 000003F5 80E60F                  	and     dh, 0Fh
   672 000003F8 09C2                    	or      dx, ax
   673 000003FA 8997[2D11]              	mov     [FDFORMAT_FATBUFFER+bx], dx
   674 000003FE C3                      	retn
   675                                  
   676                                  bin_to_decimal:
   677                                  	; INPUT: DS:SI = Target location
   678                                  	;        AX = Binary Number (Integer)
   679                                  	; OUTPUT: Decimal char at DS:SI
   680                                  	; SI decremented after every division
   681                                  	; till AX<10.
   682                                  	; CX, DX will be changed.
   683                                  	;
   684 000003FF B90A00                  	mov	cx, 10
   685                                  loc_btd_re_divide:
   686 00000402 31D2                    	xor	dx, dx
   687 00000404 F7F1                    	div	cx
   688 00000406 80C230                  	add	dl,"0"
   689 00000409 8814                    	mov	[si], dl
   690 0000040B 83F800                  	cmp	ax, 0
   691 0000040E 7603                    	jna	short pass_btd_re_divide
   692 00000410 4E                      	dec	si
   693 00000411 EBEF                    	jmp	short loc_btd_re_divide
   694                                  pass_btd_re_divide:
   695 00000413 C3                      	retn
   696                                  
   697                                  rw_char:
   698                                  	; OUTPUT -> DS:SI = Entered String (ASCIIZ)
   699 00000414 BE[8409]                	mov     si, StrVolumeName
   700 00000417 BB0700                  	mov     bx, 7
   701 0000041A B403                    	mov     ah, 3
   702 0000041C CD10                    	int     10h
   703 0000041E 8916[6B09]              	mov     [Cursor_Pos], dx
   704                                  read_next_char:
   705 00000422 30E4                    	xor     ah, ah
   706 00000424 CD16                    	int     16h
   707 00000426 20C0                    	and     al, al
   708 00000428 7439                    	jz      short loc_arrow    
   709 0000042A 3CE0                    	cmp     al, 0E0h          
   710 0000042C 7435                    	je      short loc_arrow
   711 0000042E 3C08                    	cmp     al, 8
   712 00000430 753D                    	jne     short char_return
   713                                  loc_back:
   714 00000432 B403                    	mov     ah, 3
   715 00000434 CD10                    	int     10h
   716 00000436 3A16[6B09]              	cmp     dl, byte [Cursor_Pos]
   717 0000043A 761F                    	jna     short loc_beep
   718                                  prev_column:
   719 0000043C FECA                    	dec     dl
   720                                  set_cursor_pos:
   721 0000043E B402                    	mov     ah, 2
   722 00000440 CD10                    	int     10h
   723 00000442 88D3                    	mov     bl, dl
   724 00000444 2A1E[6B09]              	sub     bl, byte [Cursor_Pos] 
   725 00000448 B90100                  	mov     cx,1
   726 0000044B B409                    	mov     ah, 9
   727 0000044D B020                    	mov     al, 20h
   728 0000044F 8800                    	mov     [si+bx], al
   729                                  loc_write_it:
   730 00000451 B307                    	mov     bl, 7
   731 00000453 CD10                    	int     10h
   732 00000455 8B16[6B09]              	mov     dx, [Cursor_Pos]
   733 00000459 EBC7                    	jmp     short read_next_char
   734                                  loc_beep:
   735 0000045B B40E                    	mov     ah, 0Eh
   736 0000045D B007                    	mov     al, 7
   737 0000045F CD10                    	int     10h
   738 00000461 EBBF                    	jmp     short read_next_char
   739                                  loc_arrow:    
   740 00000463 80FC4B                  	cmp     ah, 4Bh
   741 00000466 74CA                    	je      short loc_back
   742 00000468 80FC53                  	cmp     ah, 53h
   743 0000046B 74C5                    	je      short loc_back
   744 0000046D EBB3                    	jmp     short read_next_char
   745                                  char_return:
   746 0000046F B403                    	mov     ah, 3
   747 00000471 CD10                    	int     10h
   748                                  check_char_type:
   749 00000473 3C20                    	cmp     al, 20h
   750 00000475 7230                    	jb      short loc_escape
   751 00000477 88D4                    	mov     ah, dl
   752 00000479 2A26[6B09]              	sub     ah, byte [Cursor_Pos] 
   753 0000047D 80FC0A                  	cmp     ah, 10
   754 00000480 77D9                    	ja      short loc_beep
   755 00000482 3C7A                    	cmp     al, "z"
   756 00000484 779C                    	ja      short read_next_char
   757 00000486 3C61                    	cmp     al, "a"
   758 00000488 7202                    	jb      short pass_capitalize
   759 0000048A 24DF                    	and     al, 0DFh
   760                                  pass_capitalize:
   761 0000048C 88E3                    	mov     bl, ah  ; 30/07/2011
   762 0000048E 30E4                    	xor     ah, ah
   763 00000490 8900                    	mov     [si+bx], ax
   764 00000492 B307                    	mov     bl, 7
   765 00000494 B40E                    	mov     ah, 0Eh
   766 00000496 CD10                    	int     10h
   767 00000498 EB88                    	jmp     short read_next_char
   768                                  pass_escape:
   769 0000049A 3C0D                    	cmp     al, 0Dh
   770 0000049C 7584                    	jne     short read_next_char
   771 0000049E B40E                    	mov     ah, 0Eh
   772 000004A0 CD10                    	int     10h
   773 000004A2 B00A                    	mov     al, 0Ah
   774 000004A4 CD10                    	int     10h
   775 000004A6 C3                      	retn
   776                                  loc_escape:
   777 000004A7 3C1B                    	cmp     al, 1Bh
   778 000004A9 75EF                    	jne     short pass_escape
   779 000004AB F9                      	stc
   780 000004AC C3                      	retn
   781                                  
   782                                  ;-----------------------------------------------------------------
   783                                  
   784                                  get_drive_type_str:
   785 000004AD BE[8A0A]                	mov	si, DiskTypes
   786 000004B0 08C0                    	or	al, al
   787 000004B2 7503                    	jnz	short R_21
   788 000004B4 A0[7C0A]                	mov	al, [drive_type]
   789                                  R_21:
   790 000004B7 FEC8                    	dec	al
   791 000004B9 B414                    	mov	ah, DiskTypeStrSize
   792 000004BB F6E4                    	mul	ah
   793 000004BD 01C6                    	add	si, ax
   794                                  	;retn
   795                                  
   796                                  ;-----------------------------------------------------------------
   797                                  
   798                                  print_msg:
   799                                  
   800                                  print_msg_LOOP:
   801 000004BF AC                      	lodsb                           ; Load byte at DS:SI to AL
   802 000004C0 20C0                    	and     al, al            
   803 000004C2 7409                    	jz      short print_msg_OK       
   804 000004C4 B40E                    	mov	ah, 0Eh			
   805 000004C6 BB0700                  	mov     bx, 07h             
   806 000004C9 CD10                    	int	10h			; BIOS Service func ( ah ) = 0Eh
   807                                  					; Write char as TTY
   808                                  					; AL-char BH-page BL-color
   809 000004CB EBF2                    	jmp     short print_msg_LOOP           
   810                                  
   811                                  print_msg_OK:
   812 000004CD C3                      	retn
   813                                  
   814                                  ;-----------------------------------------------------------------
   815                                  
   816                                  set_rdfd_bs:
   817 000004CE A0[7F0A]                	mov	al, [disk_type]
   818 000004D1 20C0                    	and	al, al
   819 000004D3 7503                    	jnz	short R_22
   820 000004D5 A0[7C0A]                	mov	al, [drive_type]
   821                                  R_22:	
   822 000004D8 FEC8                    	dec	al
   823 000004DA 3C04                    	cmp	al, 4
   824 000004DC 750D                    	jne	short R_23
   825 000004DE BE[2D0D]                	mov	si, RD_FAT12_fd_bs+512 ; 2.88MB boot sector
   826 000004E1 BF[2D0B]                	mov	di, RD_FAT12_fd_bs
   827 000004E4 B90001                  	mov	cx, 256
   828 000004E7 F3A5                    	rep	movsw
   829 000004E9 EB13                    	jmp	short R_25
   830                                  R_23:
   831 000004EB 3C03                    	cmp	al, 3
   832 000004ED 740F                    	je	short R_25 ; default BS is already 1.44MB bs
   833                                  	; al = 0 to 2  ; **
   834                                  
   835                                  	; RD_FAT12_fd_bs address contains 1.44MB boot sector
   836                                  
   837                                  	; same boot sector code for 360KB to 1440KB
   838                                  	; (only bios/boot parameters blocks are different) 
   839 000004EF B93900                  	mov	cx, RD_BPB_size	
   840 000004F2 F6E1                    	mul	cl
   841 000004F4 BF[3A0B]                	mov	di, RD_FAT12_fd_bs+13 ; 1st 13 bytes excluded
   842 000004F7 BE[4606]                	mov	si, BPB_table
   843 000004FA 01C6                    	add	si, ax
   844 000004FC F3A4                    	rep	movsb
   845                                  R_25:
   846 000004FE C3                      	retn
   847                                  
   848                                  ;-----------------------------------------------------------------
   849                                  
   850                                  ft_6:
   851 000004FF BE[400A]                	mov	si, format_error_msg
   852 00000502 E9D2FB                  	jmp	R_14	
   853                                  
   854                                  format_tracks:
   855 00000505 8A0E[450B]              	mov	cl, [RD_FAT12_fd_bs+bsSecPerTrack]
   856 00000509 880E[B405]              	mov	[spt], cl
   857 0000050D BB5000                  	mov	bx, 80
   858 00000510 803E[420B]FD            	cmp	byte [RD_FAT12_fd_bs+bsMedia], 0FDh ; 360KB ?
   859 00000515 7502                    	jne	short ft_0
   860 00000517 D1EB                    	shr	bx, 1 ; 80 -> 40
   861                                  ft_0:
   862 00000519 89DE                    	mov	si, bx
   863 0000051B D1E6                    	shl	si, 1 ; 2*80 (heads*tracks)
   864                                  
   865 0000051D B418                    	mov	ah, 18h ; set floppy disk type before format
   866 0000051F FECB                    	dec	bl ; 80 -> 79, 40 -> 39
   867 00000521 88DD                    	mov	ch, bl ; maximum number of tracks
   868                                  	; cl = sectors per track
   869 00000523 8A16[7B0A]              	mov	dl, [DriveNumber]
   870 00000527 CD13                    	int	13h
   871 00000529 72D4                    	jc	short ft_6
   872 0000052B 08E4                    	or	ah, ah
   873 0000052D 75D0                    	jnz	short ft_6
   874                                  	
   875                                  	; low level format is supported
   876                                  
   877                                  	; change int 1Eh as temporary
   878 0000052F 31DB                    	xor	bx, bx
   879 00000531 8EDB                    	mov	ds, bx
   880 00000533 BB7800                  	mov	bx, 1Eh*4
   881                                  	
   882                                  	; save previous int 1Eh vector
   883 00000536 FF7702                  	push	word [bx+2]
   884 00000539 FF37                    	push	word [bx]
   885                                  		
   886 0000053B 893F                    	mov	[bx], di
   887 0000053D 06                      	push	es
   888 0000053E 8F4702                  	pop	word [bx+2]
   889 00000541 0E                      	push	cs
   890 00000542 1F                      	pop	ds
   891                                  	
   892 00000543 1E                      	push	ds
   893 00000544 07                      	pop	es
   894                                  ft_1:
   895 00000545 31D2                    	xor	dx, dx ; track	
   896 00000547 B400                    	mov	ah, 0 ; head 0
   897                                  ft_2:
   898 00000549 8B0E[B405]              	mov	cx, [spt]
   899 0000054D BF[B605]                	mov	di, tracktable
   900                                  ft_3:
   901 00000550 88D0                    	mov	al, dl ; track
   902 00000552 AB                      	stosw
   903 00000553 47                      	inc	di ; skip sector and bytes per sector (2=512) 	
   904 00000554 47                      	inc	di
   905 00000555 E2F9                    	loop	ft_3
   906                                  
   907 00000557 89D7                    	mov	di, dx ; track
   908                                  
   909                                  	; format track DL
   910 00000559 88E6                    	mov	dh, ah
   911 0000055B B405                    	mov	ah, 05h ; format disk track
   912 0000055D A0[B405]                	mov	al, [spt]
   913 00000560 88D5                    	mov	ch, dl
   914 00000562 8A16[7B0A]              	mov	dl, [DriveNumber]
   915 00000566 BB[B605]                	mov	bx, tracktable
   916 00000569 CD13                    	int	13h
   917 0000056B 7237                    	jc	short ft_5
   918                                  	
   919 0000056D 88E8                    	mov	al, ch ; track number
   920 0000056F 30E4                    	xor	ah, ah
   921 00000571 B30A                    	mov	bl, 10
   922 00000573 F6F3                    	div	bl
   923 00000575 053030                  	add	ax, '00'
   924 00000578 A3[6B0A]                	mov	[track_str], ax
   925 0000057B 88F0                    	mov	al, dh
   926 0000057D 0430                    	add	al, '0'
   927 0000057F A2[6E0A]                	mov	[track_str+3], al	
   928                                  
   929 00000582 56                      	push	si
   930 00000583 BE[6A0A]                	mov	si, track_str-1 ; CR (column 0)
   931 00000586 E836FF                  	call	print_msg
   932 00000589 5E                      	pop	si	
   933                                  
   934 0000058A 4E                      	dec	si
   935 0000058B 740B                    	jz	short ft_4
   936                                  
   937 0000058D 88F4                    	mov	ah, dh
   938 0000058F 89FA                    	mov	dx, di
   939 00000591 00E2                    	add	dl, ah ; if ah = 1, dl = next track
   940 00000593 80F401                  	xor	ah, 1 ; 0 -> 1, 1 -> 0
   941 00000596 EBB1                    	jmp	short ft_2
   942                                  ft_4:
   943 00000598 BE[700A]                	mov	si, erase_str
   944 0000059B E821FF                  	call	print_msg
   945 0000059E BE[A209]                	mov	si, Msg_OK+1
   946 000005A1 E81BFF                  	call	print_msg
   947                                  ft_5:
   948                                  	; restore previous int 1Eh table
   949 000005A4 BB0000                  	mov	bx, 0
   950 000005A7 8EDB                    	mov	ds, bx
   951 000005A9 BB7800                  	mov	bx, 1Eh*4
   952 000005AC 8F07                    	pop	word [bx]
   953 000005AE 8F4702                  	pop	word [bx+2]
   954 000005B1 0E                      	push	cs
   955 000005B2 1F                      	pop	ds
   956                                  
   957 000005B3 C3                      	retn
   958                                  
   959                                  ;-----------------------------------------------------------------
   960                                  ;  track table for hard format
   961                                  ;-----------------------------------------------------------------
   962                                  
   963 000005B4 2400                    spt: dw 36			
   964                                  tracktable:
   965 000005B6 00000102                	db 0, 0, 1, 2		
   966 000005BA 00000202                	db 0, 0, 2, 2
   967 000005BE 00000302                	db 0, 0, 3, 2
   968 000005C2 00000402                	db 0, 0, 4, 2
   969 000005C6 00000502                	db 0, 0, 5, 2
   970 000005CA 00000602                	db 0, 0, 6, 2
   971 000005CE 00000702                	db 0, 0, 7, 2
   972 000005D2 00000802                	db 0, 0, 8, 2
   973 000005D6 00000902                	db 0, 0, 9, 2
   974 000005DA 00000A02                	db 0, 0, 10, 2
   975 000005DE 00000B02                	db 0, 0, 11, 2
   976 000005E2 00000C02                	db 0, 0, 12, 2
   977 000005E6 00000D02                	db 0, 0, 13, 2
   978 000005EA 00000E02                	db 0, 0, 14, 2
   979 000005EE 00000F02                	db 0, 0, 15, 2
   980 000005F2 00001002                	db 0, 0, 16, 2
   981 000005F6 00001102                	db 0, 0, 17, 2
   982 000005FA 00001202                	db 0, 0, 18, 2
   983 000005FE 00001302                	db 0, 0, 19, 2
   984 00000602 00001402                	db 0, 0, 20, 2
   985 00000606 00001502                	db 0, 0, 21, 2
   986 0000060A 00001602                	db 0, 0, 22, 2
   987 0000060E 00001702                	db 0, 0, 23, 2
   988 00000612 00001802                	db 0, 0, 24, 2
   989 00000616 00001902                	db 0, 0, 25, 2
   990 0000061A 00001A02                	db 0, 0, 26, 2
   991 0000061E 00001B02                	db 0, 0, 27, 2
   992 00000622 00001C02                	db 0, 0, 28, 2
   993 00000626 00001D02                	db 0, 0, 29, 2
   994 0000062A 00001E02                	db 0, 0, 30, 2
   995 0000062E 00001F02                	db 0, 0, 31, 2
   996 00000632 00002002                	db 0, 0, 32, 2
   997 00000636 00002102                	db 0, 0, 33, 2
   998 0000063A 00002202                	db 0, 0, 34, 2
   999 0000063E 00002302                	db 0, 0, 35, 2
  1000 00000642 00002402                	db 0, 0, 36, 2	
  1001                                  	
  1002                                  ;-----------------------------------------------------------------
  1003                                  ;  bpb tables (except 1.44MB and 2.88 MB diskettes)
  1004                                  ;-----------------------------------------------------------------	
  1005                                  
  1006                                  BPB_table:
  1007                                  _360K:		 ; al = 0 ; ** (drive type = 1)
  1008                                  
  1009                                  ;                 jmp short BS_01 ; 0EB,46h
  1010                                  ;                 nop		  ; 90h
  1011                                  ;bsOemName:       db 'RETRODOS'
  1012                                  ;bsBytesPerSec:   dw 512
  1013 00000646 02                      bs0SecPerClust:   db 2
  1014 00000647 0100                    bs0ResSectors:    dw 1
  1015 00000649 02                      bs0FATs:          db 2
  1016 0000064A 7000                    bs0RootDirEnts:   dw 112
  1017 0000064C D002                    bs0Sectors:       dw 720
  1018 0000064E FD                      bs0Media:         db 0FDh
  1019 0000064F 0200                    bs0FATsecs:       dw 2
  1020 00000651 0900                    bs0SecPerTrack:   dw 9
  1021 00000653 0200                    bs0Heads:         dw 2
  1022 00000655 0000                    bs0Hidden1:       dw 0
  1023 00000657 0000                    bs0Hidden2:       dw 0
  1024 00000659 D0020000                bs0HugeSectors:   dd 720
  1025 0000065D 00                      bs0DriveNumber:   db 0
  1026 0000065E 00                      bs0Reserved1:     db 0
  1027 0000065F 29                      bs0BpbSignature:  db 29h
  1028 00000660 00000000                bs0VolumeID:      dd 0
  1029 00000664 4E4F204E414D452020-     bs0VolumeLabel:   db 'NO NAME    '
  1029 0000066D 2020               
  1030 0000066F 4641543132202020        bs0FileSysType:   db 'FAT12   '
  1031                                  ; Retro DOS v4 Extensions
  1032 00000677 7634                    bs0Reserved2:	  dw 'v4'
  1033 00000679 0C00                    bs0DataStart:     dw 12
  1034 0000067B 0500                    bs0RootDirStart:  dw 5
  1035 0000067D 0700                    bs0RootDirSects:  dw 7
  1036                                  RD_BPB_size	equ $ - BPB_table
  1037                                  ;bsDirEntsPerSec: dw 16
  1038                                  ;BS_01
  1039                                  
  1040                                  _1200K:		 ; al = 1 ; ** (drive type = 2)
  1041                                  
  1042                                  ;                 jmp short BS_01 ; 0EB,46h
  1043                                  ;                 nop	          ; 90h
  1044                                  ;bsOemName:       db 'RETRODOS'
  1045                                  ;bsBytesPerSec:   dw 512
  1046 0000067F 01                      bs1SecPerClust:   db 1
  1047 00000680 0100                    bs1ResSectors:    dw 1
  1048 00000682 02                      bs1FATs:          db 2
  1049 00000683 E000                    bs1RootDirEnts:   dw 224
  1050 00000685 6009                    bs1Sectors:       dw 2400
  1051 00000687 F9                      bs1Media:         db 0F9h
  1052 00000688 0700                    bs1FATsecs:       dw 7
  1053 0000068A 0F00                    bs1SecPerTrack:   dw 15
  1054 0000068C 0200                    bs1Heads:         dw 2
  1055 0000068E 0000                    bs1Hidden1:       dw 0
  1056 00000690 0000                    bs1Hidden2:       dw 0
  1057 00000692 60090000                bs1HugeSectors:   dd 2400
  1058 00000696 00                      bs1DriveNumber:   db 0
  1059 00000697 00                      bs1Reserved1:     db 0
  1060 00000698 29                      bs1BpbSignature:  db 29h 
  1061 00000699 00000000                bs1VolumeID:      dd 0
  1062 0000069D 4E4F204E414D452020-     bs1VolumeLabel:   db 'NO NAME    '
  1062 000006A6 2020               
  1063 000006A8 4641543132202020        bs1FileSysType:   db 'FAT12   '
  1064                                  ; Retro DOS v4 Extensions
  1065 000006B0 7634                    bs1Reserved2:	  dw 'v4'
  1066 000006B2 1D00                    bs1DataStart:     dw 29
  1067 000006B4 0F00                    bs1RootDirStart:  dw 15
  1068 000006B6 0E00                    bs1RootDirSects:  dw 14
  1069                                  ;bsDirEntsPerSec: dw 16
  1070                                  ;BS_01
  1071                                  
  1072                                  _720K:		; al = 2 ; ** (drive type = 3)
  1073                                  
  1074                                  ;                 jmp short BS_01 ; 0EB,46h
  1075                                  ;                 nop	          ; 90h
  1076                                  ;bsOemName:       db 'RETRODOS'
  1077                                  ;bsBytesPerSec:   dw 512
  1078 000006B8 02                      bs2SecPerClust:   db 2
  1079 000006B9 0100                    bs2ResSectors:    dw 1
  1080 000006BB 02                      bs2FATs:          db 2
  1081 000006BC 7000                    bs2RootDirEnts:   dw 112
  1082 000006BE A005                    bs2Sectors:       dw 1440
  1083 000006C0 F9                      bs2Media:         db 0F9h
  1084 000006C1 0300                    bs2FATsecs:       dw 3
  1085 000006C3 0900                    bs2SecPerTrack:   dw 9
  1086 000006C5 0200                    bs2Heads:         dw 2
  1087 000006C7 0000                    bs2Hidden1:       dw 0
  1088 000006C9 0000                    bs2Hidden2:       dw 0
  1089 000006CB A0050000                bs2HugeSectors:   dd 1440
  1090 000006CF 00                      bs2DriveNumber:   db 0
  1091 000006D0 00                      bs2Reserved1:     db 0
  1092 000006D1 29                      bs2BpbSignature:  db 29h
  1093 000006D2 00000000                bs2VolumeID:      dd 0
  1094 000006D6 4E4F204E414D452020-     bs2VolumeLabel:   db 'NO NAME    '
  1094 000006DF 2020               
  1095 000006E1 4641543132202020        bs2FileSysType:   db 'FAT12   '
  1096                                  ; Retro DOS v4 Extensions
  1097 000006E9 7634                    bs2Reserved2:	  dw 'v4'
  1098 000006EB 0E00                    bs2DataStart:     dw 14
  1099 000006ED 0700                    bs2RootDirStart:  dw 7
  1100 000006EF 0700                    bs2RootDirSects:  dw 7
  1101                                  ;bsDirEntsPerSec: dw 16
  1102                                  ;BS_01
  1103                                  
  1104                                  ;-----------------------------------------------------------------
  1105                                  ;  messages
  1106                                  ;-----------------------------------------------------------------
  1107                                  
  1108                                  RD_Welcome:
  1109 000006F1 0D0A                    	db	0Dh, 0Ah
  1110 000006F3 526574726F20444F53-     	db	'Retro DOS v4 FAT12 Floppy Disk Format Utility '
  1110 000006FC 207634204641543132-
  1110 00000705 20466C6F7070792044-
  1110 0000070E 69736B20466F726D61-
  1110 00000717 74205574696C697479-
  1110 00000720 20                 
  1111 00000721 0D0A                    	db	0Dh, 0Ah
  1112 00000723 76312E302E32333130-     	db	'v1.0.231028  (c) Erdogan TAN 2023 '
  1112 0000072C 323820202863292045-
  1112 00000735 72646F67616E205441-
  1112 0000073E 4E203230323320     
  1113 00000745 0D0A                    	db	0Dh,0Ah
  1114 00000747 0D0A                    	db	0Dh,0Ah
  1115 00000749 55736167653A206664-     	db	'Usage: fdformat <drive> ', 0Dh, 0Ah
  1115 00000752 666F726D6174203C64-
  1115 0000075B 726976653E200D0A   
  1116 00000763 0D0A                    	db	0Dh, 0Ah
  1117 00000765 204578616D706C653A-     	db	' Example: fdformat A: ', 0Dh, 0Ah
  1117 0000076E 206664666F726D6174-
  1117 00000777 20413A200D0A       
  1118 0000077D 0D0A                    	db	0Dh, 0Ah	
  1119 0000077F 4F7074696F6E616C3A-     	db	'Optional: fdformat -type(x) <drive> ', 0Dh, 0Ah
  1119 00000788 206664666F726D6174-
  1119 00000791 202D74797065287829-
  1119 0000079A 203C64726976653E20-
  1119 000007A3 0D0A               
  1120 000007A5 0D0A                    	db	0Dh, 0Ah
  1121 000007A7 204578616D706C653A-     	db	' Example: fdformat -3 A:  (720KB soft format) '
  1121 000007B0 206664666F726D6174-
  1121 000007B9 202D3320413A202028-
  1121 000007C2 3732304B4220736F66-
  1121 000007CB 7420666F726D617429-
  1121 000007D4 20                 
  1122 000007D5 0D0A                    	db	0Dh, 0Ah
  1123 000007D7 202020202020202020-     	db	'          fdformat -3x A: (720KB hard format) '     
  1123 000007E0 206664666F726D6174-
  1123 000007E9 202D337820413A2028-
  1123 000007F2 3732304B4220686172-
  1123 000007FB 6420666F726D617429-
  1123 00000804 20                 
  1124 00000805 0D0A                    	db	0Dh, 0Ah
  1125 00000807 0D0A                    	db	0Dh, 0Ah
  1126 00000809 4F7074696F6E733A20-     	db	'Options: 1  (5.25", 360KB) '
  1126 00000812 31202028352E323522-
  1126 0000081B 2C203336304B422920 
  1127 00000824 0D0A                    	db	0Dh, 0Ah
  1128 00000826 202020202020202020-     	db	'         2  (5.25", 1200KB) '
  1128 0000082F 32202028352E323522-
  1128 00000838 2C20313230304B4229-
  1128 00000841 20                 
  1129 00000842 0D0A                    	db	0Dh, 0Ah
  1130 00000844 202020202020202020-     	db	'         3  (3.5", 720KB) '
  1130 0000084D 33202028332E35222C-
  1130 00000856 203732304B422920   
  1131 0000085E 0D0A                      	db	0Dh, 0Ah
  1132 00000860 202020202020202020-     	db	'         4  (3.5", 1440KB) '
  1132 00000869 34202028332E35222C-
  1132 00000872 20313434304B422920 
  1133 0000087B 0D0A                    	db	0Dh, 0Ah
  1134 0000087D 202020202020202020-     	db	'         5  (3.5", 2880KB) '
  1134 00000886 35202028332E35222C-
  1134 0000088F 20323838304B422920 
  1135 00000898 0D0A00                  	db	0Dh, 0Ah, 0
  1136                                      
  1137                                  Msg_DoYouWantToFormat:
  1138 0000089B 07                      	db	07h
  1139 0000089C 0D0A                    	db	0Dh, 0Ah
  1140 0000089E 0D0A                            db	0Dh, 0Ah
  1141 000008A0 5741524E494E4721        	db	'WARNING!'
  1142 000008A8 0D0A                    	db	0Dh, 0Ah
  1143 000008AA 416C6C206461746120-     	db	'All data on the disk will be erased.'
  1143 000008B3 6F6E20746865206469-
  1143 000008BC 736B2077696C6C2062-
  1143 000008C5 65206572617365642E 
  1144 000008CE 0D0A                    	db	0Dh, 0Ah
  1145 000008D0 0D0A                    	db	0Dh, 0Ah
  1146 000008D2 446F20796F75207761-     	db	'Do you want to format the disk in drive '
  1146 000008DB 6E7420746F20666F72-
  1146 000008E4 6D6174207468652064-
  1146 000008ED 69736B20696E206472-
  1146 000008F6 69766520           
  1147                                  RD_Drive:
  1148 000008FA 413A20285965732F4E-     	db	'A: (Yes/No)? ', 0
  1148 00000903 6F293F2000         
  1149                                  
  1150                                  Msg_Writing_Boot_Sector:
  1151 00000908 0D0A                    	db	0Dh, 0Ah
  1152 0000090A 57726974696E672052-     	db	"Writing Retro DOS v4 boot sector...", 0
  1152 00000913 6574726F20444F5320-
  1152 0000091C 763420626F6F742073-
  1152 00000925 6563746F722E2E2E00 
  1153                                  
  1154                                  Msg_Writing_Root_Dir:
  1155 0000092E 57726974696E672072-     	db	"Writing root directory sectors...", 0
  1155 00000937 6F6F74206469726563-
  1155 00000940 746F72792073656374-
  1155 00000949 6F72732E2E2E00     
  1156                                  
  1157                                  Msg_Writing_Data_Sectors:
  1158 00000950 57726974696E672064-     	db	"Writing data sector: ", 0
  1158 00000959 61746120736563746F-
  1158 00000962 723A2000           
  1159                                  
  1160                                  Sector_Str:
  1161 00000966 3030303000              	db	"0000", 0
  1162                                  Cursor_Pos:
  1163 0000096B 0000                    	dw	0
  1164                                  
  1165                                  Msg_Writing_FAT_Sectors:
  1166 0000096D 57726974696E672046-     	db	"Writing FAT sectors...", 0
  1166 00000976 415420736563746F72-
  1166 0000097F 732E2E2E00         
  1167                                  
  1168                                  StrVolumeName:
  1169 00000984 00<rep Ch>              	times 	12 db  0
  1170                                  
  1171                                  Msg_Volume_Name:
  1172 00000990 566F6C756D65204E61-     	db	"Volume Name: ", 0
  1172 00000999 6D653A2000         
  1173                                  
  1174                                  Msg_3dot_OK:
  1175 0000099E 2E2E2E                  	db	"..."
  1176                                  Msg_OK:
  1177 000009A1 204F4B2E                	db	' OK.'
  1178                                  CRLF:
  1179 000009A5 0D0A00                  	db	0Dh, 0Ah, 0
  1180                                  Msg_YES:
  1181 000009A8 2059455300              	db	' YES', 0
  1182                                  Msg_NO:
  1183 000009AD 204E4F00                	db	' NO', 0
  1184                                  ;
  1185                                  Disk_NotReadyOrError:
  1186 000009B1 0D0A                    	db	0Dh, 0Ah
  1187 000009B3 4469736B206572726F-     	db	'Disk error or drive not ready! ', 0
  1187 000009BC 72206F722064726976-
  1187 000009C5 65206E6F7420726561-
  1187 000009CE 6479212000         
  1188                                  Try_Again_Msg:
  1189 000009D3 54727920616761696E-     	db	'Try again? (Y/N) '
  1189 000009DC 3F2028592F4E2920   
  1190 000009E4 00                      	db	0
  1191                                  
  1192                                  option_not_compat_msg:
  1193 000009E5 0D0A                    	db	0Dh, 0Ah
  1194 000009E7 53656C656374656420-     	db	'Selected disk type option is not compatible with the drive!'
  1194 000009F0 6469736B2074797065-
  1194 000009F9 206F7074696F6E2069-
  1194 00000A02 73206E6F7420636F6D-
  1194 00000A0B 70617469626C652077-
  1194 00000A14 697468207468652064-
  1194 00000A1D 7269766521         
  1195 00000A22 0D0A00                  	db	0Dh, 0Ah, 0
  1196                                  
  1197                                  unknown_dtype_msg:
  1198 00000A25 0D0A                    	db	0Dh, 0Ah
  1199 00000A27 556E6B6E6F776E2064-     	db	'Unknown disk/drive type!'
  1199 00000A30 69736B2F6472697665-
  1199 00000A39 207479706521       
  1200 00000A3F 00                      	db	0
  1201                                  
  1202                                  format_error_msg:
  1203 00000A40 0D0A                    	db	0Dh, 0Ah
  1204 00000A42 466F726D6174206572-     	db	'Format error!'
  1204 00000A4B 726F7221           
  1205 00000A4F 00                      	db	0
  1206                                  
  1207                                  Error_Code:
  1208 00000A50 00                      	db	0
  1209                                  
  1210                                  Msg_Formatting_Tracks:
  1211 00000A51 0D0A                    	db	0Dh, 0Ah
  1212 00000A53 466F726D617474696E-     	db	"Formatting tracks...", 0Dh, 0Ah, 0
  1212 00000A5C 6720747261636B732E-
  1212 00000A65 2E2E0D0A00         
  1213                                  
  1214 00000A6A 0D                      	db	0Dh ; CR
  1215                                  track_str:
  1216 00000A6B 3030203000              	db	'00 0', 0
  1217                                  erase_str:
  1218 00000A70 0D20202020200D00        	db	0Dh, '     ', 0Dh, 0	
  1219                                  	
  1220                                  hard_format:	; INT 13h (INT 40h) Function 05h format
  1221 00000A78 00                      	db	0
  1222                                  
  1223 00000A79 00                      option:	db	0
  1224                                  
  1225 00000A7A 00                      step:	db	0
  1226                                  
  1227                                  DriveNumber:
  1228 00000A7B 00                      	db	0
  1229                                  drive_type:
  1230 00000A7C 00                      	db 	0
  1231                                  inserted:
  1232 00000A7D 00                      	db	0
  1233                                  requested:
  1234 00000A7E 00                      	db	0
  1235                                  disk_type:
  1236 00000A7F 00                      	db	0
  1237                                  
  1238                                  	; index = (selected disk type - 1) * 2 
  1239                                  drive_compat:	; disk type in drive type compatibilities
  1240 00000A80 0102                    	db	1, 2 ; drive type 1 & drive type 2 is proper
  1241 00000A82 0200                    	db	2, 0 ; drive type 2 is proper
  1242 00000A84 0304                    	db	3, 4 ; drive type 3 & drive type 4 is proper	
  1243 00000A86 0405                    	db	4, 5 ; drive type 4 & drive type 5 is proper
  1244 00000A88 0500                    	db	5, 0 ; drive type 5 is proper
  1245                                  
  1246                                  DiskTypes:
  1247 00000A8A 31202D20352E323522-     	db	'1 - 5.25",  360 KB ',0
  1247 00000A93 2C2020333630204B42-
  1247 00000A9C 2000               
  1248                                  DiskTypeStrSize equ $ - DiskTypes
  1249 00000A9E 32202D20352E323522-     	db	'2 - 5.25", 1200 KB ',0
  1249 00000AA7 2C2031323030204B42-
  1249 00000AB0 2000               
  1250 00000AB2 33202D20352E323522-      	db	'3 - 5.25",  720 KB ',0
  1250 00000ABB 2C2020373230204B42-
  1250 00000AC4 2000               
  1251 00000AC6 34202D20332E35222C-     	db	'4 - 3.5",  1440 KB ',0
  1251 00000ACF 202031343430204B42-
  1251 00000AD8 2000               
  1252 00000ADA 35202D20332E35222C-      	db	'5 - 3.5",  2880 KB ',0	
  1252 00000AE3 202032383830204B42-
  1252 00000AEC 2000               
  1253                                  
  1254                                  DrvType_Info_Msg:
  1255 00000AEE 0D0A                    	db	0Dh, 0Ah
  1256 00000AF0 447269766520            	db	'Drive '
  1257                                  DrvNum_Str:
  1258 00000AF6 403A                    	db	'@:'
  1259 00000AF8 0D0A                    	db	0Dh, 0Ah
  1260 00000AFA 0D0A                    	db	0Dh, 0Ah
  1261 00000AFC 447269766520547970-     	db	"Drive Type: ", 0
  1261 00000B05 653A2000           
  1262                                  
  1263                                  ReqDrvType_Msg1:
  1264 00000B09 0D0A                    	db	0Dh, 0Ah
  1265 00000B0B 526571756573746564-     	db	"Requested ", 0
  1265 00000B14 2000               
  1266                                  
  1267                                  DiskType_nfo_msg:
  1268 00000B16 0D0A                    	db 	0Dh, 0Ah
  1269 00000B18 496E73657274656420      	db	"Inserted "
  1270                                  ReqDrvType_Msg2:
  1271 00000B21 4469736B2054797065-     	db	"Disk Type: ", 0
  1271 00000B2A 3A2000             
  1272                                  
  1273                                  RD_FAT12_fd_bs:
  1274 00000B2D <bin 200h>              	incbin 'FDBS1440.BIN' ; 25/10/2023
  1275 00000D2D <bin 200h>              	incbin 'FDBS2880.BIN' ; 25/10/2023
  1276                                  
  1277                                  FDFORMAT_SECBUFFER:
  1278 00000F2D F6<rep 200h>            	times	512 db 0F6h
  1279                                  FDFORMAT_FATBUFFER:
  1280 0000112D F0                      	db	0F0h
  1281 0000112E FF                      	db	0FFh
  1282 0000112F FF                      	db	0FFh
  1283                                  FDFORMAT_FATBUFFER_S9:
  1284 00001130 00<rep 200h>            	times	512 db 0
  1285                                   
  1286 00001330 286329204572646F67-     	db	'(c) Erdogan TAN 2023'
  1286 00001339 616E2054414E203230-
  1286 00001342 3233               
  1287                                  
  1288                                  RetryCount:
  1289 00001344 00                      	db	0
  1290                                  
  1291                                  ; ----------------------------------------------------------------------------
  1292                                  ; uninitialized data
  1293                                  ; ----------------------------------------------------------------------------
  1294                                  
  1295                                  bss_start:
  1296                                  
  1297                                  ABSOLUTE bss_start
  1298                                  
  1299 00001345 ??                      alignb 2
  1300                                  
  1301                                  bootsector:
  1302 00001346 <res 200h>              	resb	512
  1303                                  
  1304                                  end_bss:
