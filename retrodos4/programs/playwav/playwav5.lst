     1                                  ; ****************************************************************************
     2                                  ; PLAYWAV.ASM - ICH AC97 .wav player for DOS.			   PLAYWAV.COM
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; Last Update: 19/11/2023 (Previous: 12/11/2023)
     5                                  ; ----------------------------------------------------------------------------
     6                                  ; Beginning: 17/02/2017
     7                                  ; ----------------------------------------------------------------------------
     8                                  ; Assembler: NASM version 2.11 (2.15)
     9                                  ;	     nasm playwav.asm -l playwav.lst -o PLAYWAV.COM	
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Derived from '.wav file player for DOS' Jeff Leyda, Sep 02, 2002 
    12                                  ; ****************************************************************************
    13                                  ; Modidified from 'PLAYER.COM' for VIA VT8233 wav player source code by
    14                                  ; (PLAYER.ASM) by Erdogan Tan (07/11/2016 - 08/12/2016)
    15                                  
    16                                  ; AC97 interrupt version - 09/11/2023 - Erdogan Tan
    17                                  ; sample rate conversion version - 13/11/2023 - Erdogan Tan
    18                                  ; LVI interrupt version (instead of IOC) - 18/11/2023 - Erdogan Tan
    19                                  
    20                                  [BITS 16]
    21                                  
    22                                  [ORG 100h] 
    23                                  
    24                                  	%include 'ac97.inc' ; 17/02/2017
     1                              <1> ; 11/11/2023
     2                              <1> ; 05/11/2023
     3                              <1> ; 03/11/2023
     4                              <1> ; 17/02/2017 (Erdogan Tan, PLAYWAV.ASM)
     5                              <1> ; constant.inc & codec.inc (for ICH AC97 wav player, 'PLAYWAV.COM') 
     6                              <1> 
     7                              <1> ; ----------------------------------------------------------------------------
     8                              <1> ; CONSTANT.INC
     9                              <1> ; ----------------------------------------------------------------------------
    10                              <1> 
    11                              <1> ;constants of stuff that seem hard to remember at times.
    12                              <1> 
    13                              <1> TRUE  EQU 1
    14                              <1> FALSE EQU 0
    15                              <1> 
    16                              <1> ENABLED  EQU 1
    17                              <1> DISABLED EQU 0
    18                              <1> 
    19                              <1> BIT0  EQU 1
    20                              <1> BIT1  EQU 2
    21                              <1> BIT2  EQU 4
    22                              <1> BIT3  EQU 8
    23                              <1> BIT4  EQU 10h
    24                              <1> BIT5  EQU 20h
    25                              <1> BIT6  EQU 40h
    26                              <1> BIT7  EQU 80h
    27                              <1> BIT8  EQU 100h
    28                              <1> BIT9  EQU 200h
    29                              <1> BIT10 EQU 400h
    30                              <1> BIT11 EQU 800h
    31                              <1> BIT12 EQU 1000h
    32                              <1> BIT13 EQU 2000h
    33                              <1> BIT14 EQU 4000h
    34                              <1> BIT15 EQU 8000h
    35                              <1> BIT16 EQU 10000h
    36                              <1> BIT17 EQU 20000h
    37                              <1> BIT18 EQU 40000h
    38                              <1> BIT19 EQU 80000h
    39                              <1> BIT20 EQU 100000h
    40                              <1> BIT21 EQU 200000h
    41                              <1> BIT22 EQU 400000h
    42                              <1> BIT23 EQU 800000h
    43                              <1> BIT24 EQU 1000000h
    44                              <1> BIT25 EQU 2000000h
    45                              <1> BIT26 EQU 4000000h
    46                              <1> BIT27 EQU 8000000h
    47                              <1> BIT28 EQU 10000000h
    48                              <1> BIT29 EQU 20000000h
    49                              <1> BIT30 EQU 40000000h
    50                              <1> BIT31 EQU 80000000h
    51                              <1> 
    52                              <1> ;special characters
    53                              <1> NUL     EQU 0
    54                              <1> NULL    EQU 0
    55                              <1> BELL    EQU 07
    56                              <1> BS      EQU 08
    57                              <1> TAB     EQU 09
    58                              <1> LF      EQU 10
    59                              <1> CR      EQU 13
    60                              <1> ESCAPE  EQU 27           ;ESC is a reserved word....
    61                              <1> 
    62                              <1> 
    63                              <1> ;file stuff
    64                              <1> READONLY  EQU   BIT0
    65                              <1> HIDDEN    EQU   BIT1
    66                              <1> SYSTEM    EQU   BIT2
    67                              <1> VOLUME    EQU   BIT3         ;ignored for file access
    68                              <1> DIRECTORY EQU   BIT4         ;must be 0 for file access
    69                              <1> ARCHIVE   EQU   BIT5
    70                              <1> SHAREABLE EQU   BIT7         ;for novell networks
    71                              <1> OPEN	EQU	2		; open existing file
    72                              <1> CREATE	EQU	1		; create new file
    73                              <1> 
    74                              <1> 
    75                              <1> ; PCI equates
    76                              <1> ; PCI function address (PFA)
    77                              <1> ; bit 31 = 1
    78                              <1> ; bit 23:16 = bus number     (0-255)
    79                              <1> ; bit 15:11 = device number  (0-31)
    80                              <1> ; bit 10:8 = function number (0-7)
    81                              <1> ; bit 7:0 = register number  (0-255)
    82                              <1> 
    83                              <1> IO_ADDR_MASK    EQU     0FFFEh          ; mask off bit 0 for reading BARs
    84                              <1> PCI_INDEX_PORT  EQU     0CF8h
    85                              <1> PCI_DATA_PORT   EQU     0CFCh
    86                              <1> PCI32           EQU     BIT31           ; bitflag to signal 32bit access
    87                              <1> PCI16           EQU     BIT30           ; bitflag for 16bit access
    88                              <1> 
    89                              <1> PCI_FN0         EQU     0 << 8
    90                              <1> PCI_FN1         EQU     1 << 8
    91                              <1> PCI_FN2         EQU     2 << 8
    92                              <1> PCI_FN3         EQU     3 << 8
    93                              <1> PCI_FN4         EQU     4 << 8
    94                              <1> PCI_FN5         EQU     5 << 8
    95                              <1> PCI_FN6         EQU     6 << 8
    96                              <1> PCI_FN7         EQU     7 << 8
    97                              <1> 
    98                              <1> PCI_CMD_REG		EQU	04h		; reg 04, command reg
    99                              <1>  IO_ENA			EQU	BIT0		; i/o decode enable
   100                              <1>  MEM_ENA		EQU	BIT1		; memory decode enable
   101                              <1>  BM_ENA                 EQU     BIT2		; bus master enable
   102                              <1> 
   103                              <1> ; ----------------------------------------------------------------------------
   104                              <1> ; CODEC.INC
   105                              <1> ; ----------------------------------------------------------------------------
   106                              <1> 
   107                              <1> ;Codec registers.
   108                              <1> ;
   109                              <1> ;Not all codecs are created equal. Refer to the spec for your specific codec.
   110                              <1> ;
   111                              <1> ;All registers are 16bits wide.  Access to codec registers over the AC97 link
   112                              <1> ;is defined by the OEM.  
   113                              <1> ;
   114                              <1> ;Secondary codec's are accessed by ORing in BIT7 of all register accesses.
   115                              <1> ;
   116                              <1> 
   117                              <1> ; each codec/mixer register is 16bits
   118                              <1> 
   119                              <1> CODEC_RESET_REG                 equ     00      ; reset codec
   120                              <1> CODEC_MASTER_VOL_REG            equ     02      ; master volume
   121                              <1> CODEC_HP_VOL_REG                equ     04      ; headphone volume
   122                              <1> CODEC_MASTER_MONO_VOL_REG       equ     06      ; master mono volume
   123                              <1> CODEC_MASTER_TONE_REG           equ     08      ; master tone (R+L)
   124                              <1> CODEC_PCBEEP_VOL_REG            equ     0ah     ; PC beep volume
   125                              <1> CODEC_PHONE_VOL_REG             equ     0bh     ; phone volume
   126                              <1> CODEC_MIC_VOL_REG               equ     0eh     ; MIC volume
   127                              <1> CODEC_LINE_IN_VOL_REG           equ     10h     ; line input volume
   128                              <1> CODEC_CD_VOL_REG                equ     12h     ; CD volume
   129                              <1> CODEC_VID_VOL_REG               equ     14h     ; video volume
   130                              <1> CODEC_AUX_VOL_REG               equ     16h     ; aux volume
   131                              <1> CODEC_PCM_OUT_REG               equ     18h     ; PCM output volume
   132                              <1> CODEC_RECORD_SELECT_REG         equ     1ah     ; record select input
   133                              <1> CODEC_RECORD_VOL_REG            equ     1ch     ; record volume
   134                              <1> CODEC_RECORD_MIC_VOL_REG        equ     1eh     ; record mic volume
   135                              <1> CODEC_GP_REG                    equ     20h     ; general purpose
   136                              <1> CODEC_3D_CONTROL_REG            equ     22h     ; 3D control
   137                              <1> ; 24h is reserved
   138                              <1> CODEC_POWER_CTRL_REG            equ     26h     ; powerdown control
   139                              <1> CODEC_EXT_AUDIO_REG             equ     28h     ; extended audio
   140                              <1> CODEC_EXT_AUDIO_CTRL_REG        equ     2ah     ; extended audio control
   141                              <1> CODEC_PCM_FRONT_DACRATE_REG     equ     2ch     ; PCM out sample rate
   142                              <1> CODEC_PCM_SURND_DACRATE_REG     equ     2eh     ; surround sound sample rate
   143                              <1> CODEC_PCM_LFE_DACRATE_REG       equ     30h     ; LFE sample rate
   144                              <1> CODEC_LR_ADCRATE_REG            equ     32h     ; PCM in sample rate
   145                              <1> CODEC_MIC_ADCRATE_REG           equ     34h     ; mic in sample rate
   146                              <1> 
   147                              <1> ; registers 36-7a are reserved on the ICH
   148                              <1> 
   149                              <1> CODEC_VENDORID1_REG             equ     7ch     ; codec vendor ID 1
   150                              <1> CODEC_VENDORID2_REG             equ     7eh     ; codec vendor ID 2
   151                              <1> 
   152                              <1> ; Mixer registers 0 through 51h reside in the ICH and are not forwarded over
   153                              <1> ; the AC97 link to the codec, which I think is a little weird.  Looks like
   154                              <1> ; the ICH makes it so you don't need a fully functional codec to play audio?
   155                              <1> ;
   156                              <1> ; whenever 2 codecs are present in the system, use BIT7 to access the 2nd
   157                              <1> ; set of registers, ie 80h-feh
   158                              <1> 
   159                              <1> PRIMARY_CODEC                   equ     0       ; 0-7F for primary codec
   160                              <1> SECONDARY_CODEC                 equ     BIT7    ; 80-8f registers for 2ndary
   161                              <1> 
   162                              <1> SAMPLE_RATE_441khz	equ     44100   ; 44.1Khz (cd quality) rate
   163                              <1> 
   164                              <1> ; ----------------------------------------------------------------------------
   165                              <1> ; 17/02/2017
   166                              <1> PCI_IO_BASE	equ 10h			; = NAMBAR register offset
   167                              <1> AC97_INT_LINE   equ 3Ch			; AC97 Interrupt Line register offset
   168                              <1> 
   169                              <1> ; ----------------------------------------------------------------------------
   170                              <1> ; ICH2AC97.INC
   171                              <1> ; ----------------------------------------------------------------------------
   172                              <1> 
   173                              <1> ; PCI stuff
   174                              <1> 
   175                              <1> ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
   176                              <1> 
   177                              <1> INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
   178                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   179                              <1> SIS_VID		equ	1039h
   180                              <1> NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
   181                              <1> AMD_VID		equ	1022h
   182                              <1> 
   183                              <1> ICH_DID         equ     2415h           ; ICH device ID
   184                              <1> ICH0_DID        equ     2425h           ; ICH0
   185                              <1> ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
   186                              <1>                                         ; they all should be compatible.
   187                              <1> 
   188                              <1> ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
   189                              <1> ICH3_DID	equ     2485h           ; ICH3
   190                              <1> ICH4_DID        equ     24C5h           ; ICH4
   191                              <1> ICH5_DID	equ     24D5h           ; ICH5 
   192                              <1> ICH6_DID	equ     266Eh           ; ICH6
   193                              <1> ESB6300_DID	equ     25A6h           ; 6300ESB
   194                              <1> ESB631X_DID	equ     2698h           ; 631XESB
   195                              <1> ICH7_DID	equ	27DEh		; ICH7
   196                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   197                              <1> MX82440_DID	equ	7195h
   198                              <1> SI7012_DID	equ	7012h
   199                              <1> NFORCE_DID	equ	01B1h
   200                              <1> NFORCE2_DID	equ	006Ah
   201                              <1> AMD8111_DID	equ	746Dh
   202                              <1> AMD768_DID	equ	7445h
   203                              <1> ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
   204                              <1> CK804_DID	equ	0059h
   205                              <1> MCP04_DID	equ	003Ah
   206                              <1> CK8_DID		equ	008Ah
   207                              <1> NFORCE3_DID	equ	00DAh
   208                              <1> CK8S_DID	equ	00EAh
   209                              <1> 
   210                              <1> NAMBAR_REG      equ     10h             ; native audio mixer BAR
   211                              <1>  NAM_SIZE       equ     256             ; 256 bytes required.
   212                              <1> 
   213                              <1> NABMBAR_REG     equ     14h             ; native audio bus mastering BAR
   214                              <1>  NABM_SIZE      equ     64              ; 64 bytes
   215                              <1> 
   216                              <1> ; BUS master registers, accessed via NABMBAR+offset
   217                              <1> 
   218                              <1> ; ICH supports 3 different types of register sets for three types of things
   219                              <1> ; it can do, thus:
   220                              <1> ;
   221                              <1> ; PCM in (for recording) aka PI
   222                              <1> ; PCM out (for playback) aka PO
   223                              <1> ; MIC in (for recording) aka MC
   224                              <1> 
   225                              <1> PI_BDBAR_REG            equ     0       ; PCM in buffer descriptor BAR
   226                              <1> PO_BDBAR_REG            equ     10h     ; PCM out buffer descriptor BAR
   227                              <1> MC_BDBAR_REG            equ     20h     ; MIC in buffer descriptor BAR
   228                              <1> 
   229                              <1> ; each buffer descriptor BAR holds a pointer which has entries to the buffer
   230                              <1> ; contents of the .WAV file we're going to play. Each entry is 8 bytes long
   231                              <1> ; (more on that later) and can contain 32 entries total, so each BAR is
   232                              <1> ; 256 bytes in length, thus:
   233                              <1> 
   234                              <1> BDL_SIZE                equ     32*8    ; Buffer Descriptor List size
   235                              <1> INDEX_MASK              equ     31      ; indexes must be 0-31
   236                              <1> 
   237                              <1> 
   238                              <1> 
   239                              <1> PI_CIV_REG              equ     4       ; PCM in current Index value (RO)
   240                              <1> PO_CIV_REG              equ     14h     ; PCM out current Index value (RO)
   241                              <1> MC_CIV_REG              equ     24h     ; MIC in current Index value (RO)
   242                              <1> ;8bit read only
   243                              <1> ; each current index value is simply a pointer showing us which buffer
   244                              <1> ; (0-31) the codec is currently processing. Once this counter hits 31, it
   245                              <1> ; wraps back to 0.
   246                              <1> ; this can be handy to know, as once it hits 31, we're almost out of data to
   247                              <1> ; play back or room to record!
   248                              <1> 
   249                              <1> 
   250                              <1> PI_LVI_REG              equ     5       ; PCM in Last Valid Index
   251                              <1> PO_LVI_REG              equ     15h     ; PCM out Last Valid Index
   252                              <1> MC_LVI_REG              equ     25h     ; MIC in Last Valid Index
   253                              <1> ;8bit read/write
   254                              <1> ; The Last Valid Index is a number (0-31) to let the codec know what buffer
   255                              <1> ; number to stop on after processing. It could be very nasty to play audio
   256                              <1> ; from buffers that aren't filled with the audio we want to play.
   257                              <1> 
   258                              <1> 
   259                              <1> PI_SR_REG               equ     6       ; PCM in Status register
   260                              <1> PO_SR_REG               equ     16h     ; PCM out Status register
   261                              <1> MC_SR_REG               equ     26h     ; MIC in Status register
   262                              <1> ;16bit read/write
   263                              <1> ; status registers.  Bitfields follow:
   264                              <1> 
   265                              <1> FIFO_ERR                equ     BIT4    ; FIFO Over/Underrun W1TC.
   266                              <1> 
   267                              <1> BCIS                    equ     BIT3    ; buffer completion interrupt status.
   268                              <1>                                         ; Set whenever the last sample in ANY
   269                              <1>                                         ; buffer is finished.  Bit is only
   270                              <1>                                         ; set when the Interrupt on Complete
   271                              <1>                                         ; (BIT4 of control reg) is set.
   272                              <1> 
   273                              <1> LVBCI                   equ     BIT2    ; Set whenever the codec has processed
   274                              <1>                                         ; the last buffer in the buffer list.
   275                              <1>                                         ; Will fire an interrupt if IOC bit is
   276                              <1>                                         ; set. Probably set after the last
   277                              <1>                                         ; sample in the last buffer is
   278                              <1>                                         ; processed.  W1TC
   279                              <1> 
   280                              <1>                                         ; 
   281                              <1> CELV                    equ     BIT1    ; Current buffer == last valid.
   282                              <1>                                         ; Bit is RO and remains set until LVI is
   283                              <1>                                         ; cleared.  Probably set up the start
   284                              <1>                                         ; of processing for the last buffer.
   285                              <1> 
   286                              <1> 
   287                              <1> DCH                     equ     BIT0    ; DMA controller halted.
   288                              <1>                                         ; set whenever audio stream is stopped
   289                              <1>                                         ; or something else goes wrong.
   290                              <1> 
   291                              <1> 
   292                              <1> PI_PICB_REG             equ     8       ; PCM in position in current buffer(RO)
   293                              <1> PO_PICB_REG             equ     18h     ; PCM out position in current buffer(RO)
   294                              <1> MC_PICB_REG             equ     28h     ; MIC in position in current buffer (RO)
   295                              <1> ;16bit read only
   296                              <1> ; position in current buffer regs show the number of dwords left to be
   297                              <1> ; processed in the current buffer.
   298                              <1> ; 
   299                              <1> 
   300                              <1> PI_PIV_REG              equ     0ah     ; PCM in Prefected index value
   301                              <1> PO_PIV_REG              equ     1ah     ; PCM out Prefected index value
   302                              <1> MC_PIV_REG              equ     2ah     ; MIC in Prefected index value
   303                              <1> ;8bit, read only
   304                              <1> ; Prefetched index value register.
   305                              <1> ; tells which buffer number (0-31) has be prefetched. I'd imagine this
   306                              <1> ; value follows the current index value fairly closely. (CIV+1)
   307                              <1> ;
   308                              <1> 
   309                              <1> 
   310                              <1> PI_CR_REG               equ     0bh     ; PCM in Control Register
   311                              <1> PO_CR_REG               equ     1bh     ; PCM out Control Register
   312                              <1> MC_CR_REG               equ     2bh     ; MIC in Control Register
   313                              <1> ; 8bit
   314                              <1> ; Control register *MUST* only be accessed as an 8bit value.
   315                              <1> ; Control register. See bitfields below.
   316                              <1> ;
   317                              <1> 
   318                              <1> 
   319                              <1> IOCE                    equ     BIT4    ; interrupt on complete enable.
   320                              <1>                                         ; set this bit if you want an intrtpt
   321                              <1>                                         ; to fire whenever LVBCI is set.
   322                              <1> FEIFE                   equ     BIT3    ; set if you want an interrupt to fire
   323                              <1>                                         ; whenever there is a FIFO (over or
   324                              <1>                                         ; under) error.
   325                              <1> LVBIE                   equ     BIT2    ; last valid buffer interrupt enable.
   326                              <1>                                         ; set if you want an interrupt to fire
   327                              <1>                                         ; whenever the completion of the last
   328                              <1>                                         ; valid buffer.
   329                              <1> RR                      equ     BIT1    ; reset registers.  Nukes all regs
   330                              <1>                                         ; except bits 4:2 of this register.
   331                              <1>                                         ; Only set this bit if BIT 0 is 0
   332                              <1> RPBM                    equ     BIT0    ; Run/Pause
   333                              <1>                                         ; set this bit to start the codec!
   334                              <1> 
   335                              <1> 
   336                              <1> GLOB_CNT_REG            equ     2ch     ; Global control register
   337                              <1> SEC_RES_EN              equ     BIT5    ; secondary codec resume event 
   338                              <1>                                         ; interrupt enable.  Not used here.
   339                              <1> PRI_RES_EN              equ     BIT4    ; ditto for primary. Not used here.
   340                              <1> ACLINK_OFF              equ     BIT3    ; Turn off the AC97 link
   341                              <1> ACWARM_RESET            equ     BIT2    ; Awaken the AC97 link from sleep.
   342                              <1>                                         ; registers preserved, bit self clears
   343                              <1> ACCOLD_RESET            equ     BIT1    ; Reset everything in the AC97 and
   344                              <1>                                         ; reset all registers.  Not self clearing
   345                              <1> 
   346                              <1> GPIIE                   equ     BIT0    ; GPI Interrupt enable.
   347                              <1>                                         ; set if you want an interrupt to
   348                              <1>                                         ; fire upon ANY of the bits in the
   349                              <1>                                         ; GPI (general pursose inputs?) not used.
   350                              <1> 
   351                              <1> GLOB_STS_REG            equ     30h     ; Global Status register (RO)
   352                              <1> 
   353                              <1> MD3                     equ     BIT17   ; modem powerdown status (yawn)
   354                              <1> AD3                     equ     BIT16   ; Audio powerdown status (yawn)
   355                              <1> RD_COMPLETE_STS         equ     BIT15   ; Codec read timed out. 0=normal
   356                              <1> BIT3SLOT12              equ     BIT14   ; shadowed status of bit 3 in slot 12
   357                              <1> BIT2SLOT12              equ     BIT13   ; shadowed status of bit 2 in slot 12
   358                              <1> BIT1SLOT12              equ     BIT12   ; shadowed status of bit 1 in slot 12
   359                              <1> SEC_RESUME_STS          equ     BIT11   ; secondary codec has resumed (and irqed)
   360                              <1> PRI_RESUME_STS          equ     BIT10   ; primary codec has resumed (and irqed)
   361                              <1> SEC_CODEC_RDY           equ     BIT9    ; secondary codec is ready for action
   362                              <1> PRI_CODEC_RDY           equ     BIT8    ; Primary codec is ready for action
   363                              <1>                                         ; software must check these bits before
   364                              <1>                                         ; starting the codec!
   365                              <1> MIC_IN_IRQ              equ     BIT7    ; MIC in caused an interrupt
   366                              <1> PCM_OUT_IRQ             equ     BIT6    ; One of the PCM out channels IRQed
   367                              <1> PCM_IN_IRQ              equ     BIT5    ; One of the PCM in channels IRQed
   368                              <1> MODEM_OUT_IRQ           equ     BIT2    ; modem out channel IRQed
   369                              <1> MODEM_IN_IRQ            equ     BIT1    ; modem in channel IRQed
   370                              <1> GPI_STS_CHANGE          equ     BIT0    ; set whenever GPI's have changed.
   371                              <1>                                         ; BIT0 of slot 12 also reflects this.
   372                              <1> 
   373                              <1> ACC_SEMA_REG            equ     34h     ; Codec write semiphore register
   374                              <1> CODEC_BUSY              equ     BIT0    ; codec register I/O is happening
   375                              <1>                                         ; self clearing
   376                              <1> ;
   377                              <1> ; Buffer Descriptors List
   378                              <1> ; As stated earlier, each buffer descriptor list is a set of (up to) 32 
   379                              <1> ; descriptors, each 8 bytes in length. Bytes 0-3 of a descriptor entry point
   380                              <1> ; to a chunk of memory to either play from or record to. Bytes 4-7 of an
   381                              <1> ; entry describe various control things detailed below.
   382                              <1> ; 
   383                              <1> ; Buffer pointers must always be aligned on a Dword boundry.
   384                              <1> ;
   385                              <1> 
   386                              <1> IOC                     equ     BIT31   ; Fire an interrupt whenever this
   387                              <1>                                         ; buffer is complete.
   388                              <1> 
   389                              <1> BUP                     equ     BIT30   ; Buffer Underrun Policy.
   390                              <1>                                         ; if this buffer is the last buffer
   391                              <1>                                         ; in a playback, fill the remaining
   392                              <1>                                         ; samples with 0 (silence) or not.
   393                              <1>                                         ; It's a good idea to set this to 1
   394                              <1>                                         ; for the last buffer in playback,
   395                              <1>                                         ; otherwise you're likely to get a lot
   396                              <1>                                         ; of noise at the end of the sound.
   397                              <1> 
   398                              <1> ;
   399                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   400                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   401                              <1> ; Luckily for us, that's the same format as .wav files.
   402                              <1> ;
   403                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   404                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   405                              <1> ;
   406                              <1> ; A value of 0 in these bits means play no samples.
   407                              <1> ;
   408                              <1> 
   409                              <1> ; 11/11/2023
   410                              <1> CTRL_ST_CREADY		equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
   411                              <1> CODEC_REG_POWERDOWN	equ	26h
    25                                  
    26                                  _STARTUP:
    27                                  
    28                                  ; memory allocation
    29                                  
    30 00000000 E85D01                          call    setFree				; deallocate unused DOS mem
    31                                  
    32                                  	; 17/02/2017
    33                                  	; Clear BSS (uninitialized data) area
    34 00000003 31C0                    	xor	ax, ax ; 0
    35 00000005 B91A6E                  	mov	cx, (EOF - bss_start)/2
    36 00000008 BF[A31D]                	mov	di, bss_start
    37 0000000B F3AB                    	rep	stosw
    38                                  
    39                                  ; allocate 256 bytes of data for DCM_OUT Buffer Descriptor List. (BDL)
    40                                  
    41 0000000D B81000                          mov     ax, BDL_SIZE / 16
    42 00000010 E85501                          call    memAlloc
    43 00000013 A3[D01D]                        mov     [BDL_BUFFER], ax		; segment 
    44                                  
    45                                  ; allocate 2 buffers, 64k each for now.
    46                                  
    47 00000016 B80010                          mov     ax, BUFFERSIZE / 16		; 64k for .WAV file
    48 00000019 E84C01                          call    memAlloc
    49 0000001C A3[D21D]                        mov     [WAV_BUFFER1], ax		; segment
    50                                  
    51 0000001F B80010                  	mov	ax, BUFFERSIZE / 16
    52 00000022 E84301                  	call	memAlloc
    53 00000025 A3[D41D]                	mov	[WAV_BUFFER2], ax
    54                                  
    55                                  ; Detect/reset AC97 
    56                                  
    57 00000028 E8B002                          call    pciFindDevice
    58 0000002B 7342                            jnc     short _1
    59                                  
    60                                  ; couldn't find the audio device!
    61                                  
    62 0000002D 0E                      	push	cs
    63 0000002E 1F                      	pop	ds
    64 0000002F BA[3900]                        mov     dx, noDevMsg
    65 00000032 B409                            mov     ah, 9
    66 00000034 CD21                            int     21h
    67 00000036 E91701                          jmp     exit
    68                                  
    69                                  ; 17/02/2017
    70 00000039 4572726F723A20556E-     noDevMsg: db "Error: Unable to find intel ICH based audio device!",CR,LF,"$"
    70 00000042 61626C6520746F2066-
    70 0000004B 696E6420696E74656C-
    70 00000054 204943482062617365-
    70 0000005D 6420617564696F2064-
    70 00000066 6576696365210D0A24 
    71                                  
    72                                  _1:
    73                                  	; eax = BUS/DEV/FN
    74                                  	;	00000000BBBBBBBBDDDDDFFF00000000
    75                                  	; edx = DEV/VENDOR
    76                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
    77                                  
    78 0000006F 66A3[D61D]              	mov	[bus_dev_fn], eax
    79 00000073 668916[DA1D]            	mov	[dev_vendor], edx
    80                                  
    81                                  	; get ICH base address regs for mixer and bus master
    82                                  
    83 00000078 B010                            mov     al, NAMBAR_REG
    84 0000007A E8D001                          call    pciRegRead16			; read PCI registers 10-11
    85 0000007D 83E2FE                          and     dx, IO_ADDR_MASK 		; mask off BIT0
    86                                  
    87 00000080 8916[CC1D]                      mov     [NAMBAR], dx			; save audio mixer base addy
    88                                  
    89 00000084 B014                    	mov     al, NABMBAR_REG
    90 00000086 E8C401                          call    pciRegRead16
    91 00000089 83E2FE                          and     dx, IO_ADDR_MASK
    92                                  
    93 0000008C 8916[CE1D]                      mov     [NABMBAR], dx			; save bus master base addy
    94                                  
    95                                  	; 06/11/2023
    96                                  	;; init controller
    97                                  	;; 17/02/2017
    98                                  	;mov	al, PCI_CMD_REG ; command register (04h)
    99                                  	;call	pciRegRead16 ; pciRegRead8
   100                                  	;
   101                                  	;; eax = BUS/DEV/FN/REG
   102                                  	;;  dx = PCI Command Register Content ; 17/02/2017
   103                                  	;; 	00000000CCCCCCCC
   104                                  	;mov	[stats_cmd], dx
   105                                  	;
   106                                  	; 06/11/2023
   107                                  	;mov	al, PCI_IO_BASE ; IO base address register (10h)
   108                                  	;call	pciRegRead32
   109                                  	;
   110                                  	;and	dx, 0FFC0h	; IO_ADDR_MASK (0FFFE) ?
   111                                          ;mov	[ac97_io_base], dx
   112                                  
   113 00000090 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
   114 00000092 E8B001                  	call	pciRegRead8 ; 17/02/2017
   115                                  
   116 00000095 8816[C31D]              	mov     [ac97_int_ln_reg], dl
   117                                  
   118                                  ; 09/11/2023
   119                                  ; 05/11/2023
   120                                  %if 1
   121                                  	; 28/11/2016
   122 00000099 BB0100                  	mov	bx, 1
   123 0000009C 30F6                    	xor	dh, dh 	 ; 17/02/2017
   124                                  	; 10/11/2023
   125                                  	;mov	cx, dx
   126                                  	;shl	bx, cl
   127                                  
   128                                  	; 04/11/2023
   129 0000009E FA                      	cli
   130                                  
   131                                  	;not	bx
   132 0000009F E4A1                    	in	al, 0A1h ; irq 8-15
   133 000000A1 88C4                            mov	ah, al
   134 000000A3 E421                            in	al, 21h  ; irq 0-7 
   135                                  
   136                                  	; 04/11/2023
   137                                  	; save IRQ status
   138 000000A5 A3[C61D]                	mov	[IRQ_status], ax
   139                                  
   140                                  	;and	ax, bx   ; unmask
   141 000000A8 0FB3D0                   	btr	ax, dx	 ; unmask
   142 000000AB E621                    	out	21h, al  ; enable interrupt (if irq <= 7)
   143 000000AD 88E0                    	mov	al, ah
   144 000000AF E6A1                    	out	0A1h, al ; enable interrupt (if irq > 7)
   145                                  	;not	bx
   146                                  
   147                                  	; 04/11/2023
   148                                  	;mov	dx, 4D1h			;8259 ELCR1
   149                                          ;in	al, dx
   150                                  	;mov	ah, al
   151                                  	;mov	dx, 4D0h 
   152                                          ;in	al, dx
   153                                  	;;or	ax, bx        
   154                                  	;bts	ax, cx
   155                                  	;mov	dx, 4D0h
   156                                  	;out	dx, al                          ;set level-triggered mode
   157                                  	;mov	al, ah
   158                                  	;mov	dx, 4D1h
   159                                  	;out	dx, al                          ;set level-triggered mode
   160                                  
   161                                  	; 24/11/2016 - Erdogan Tan
   162                                  	;mov	bx, cx
   163                                  	; 10/11/2023
   164 000000B1 89D3                    	mov	bx, dx
   165 000000B3 8A9F[EE1B]              	mov	bl, [bx+irq_int]
   166 000000B7 C1E302                  	shl	bx, 2 ; * 4
   167                                  
   168                                  	; set up interrupt vector
   169                                  	; 30/11/2016
   170 000000BA 06                      	push	es
   171 000000BB 31C0                    	xor	ax, ax
   172 000000BD 8EC0                    	mov	es, ax
   173                                  	; 04/11/2023
   174                                  	; save interrupt vector
   175 000000BF 268B07                  	mov	ax, [es:bx]
   176 000000C2 A3[C81D]                	mov	[IRQ_vector], ax
   177 000000C5 268B4702                	mov	ax, [es:bx+2]
   178 000000C9 A3[CA1D]                	mov	[IRQ_vector+2], ax
   179                                  
   180 000000CC 26C707[3D1B]            	mov	word [es:bx], ac97_int_handler
   181 000000D1 8CC8                    	mov	ax, cs
   182 000000D3 26894702                	mov	[es:bx+2], ax
   183 000000D7 07                      	pop	es
   184                                  
   185                                  	; 04/11/2023
   186 000000D8 FB                      	sti
   187                                  
   188                                  %endif
   189 000000D9 E8AE18                  	call	write_ac97_dev_info 
   190                                  
   191                                  ; check the command line for a file to play
   192                                  
   193                                          ;push	ds
   194 000000DC E89200                          call    processCmdline			; get the filename
   195                                  
   196                                  ; open the file
   197 000000DF B002                            mov     al, OPEN                        ; open existing file
   198 000000E1 E8AD00                          call    openFile                        ; no error? ok.
   199                                          ;pop	ds
   200 000000E4 7322                            jnc     short _gsr
   201                                  
   202                                  ; file not found!
   203                                  
   204                                          ;push   cs
   205                                          ;pop    ds
   206 000000E6 BA[EF00]                        mov	dx, noFileErrMsg
   207 000000E9 B409                            mov     ah, 9
   208 000000EB CD21                            int     21h
   209 000000ED EB61                            jmp     exit
   210                                  
   211                                  noFileErrMsg:
   212 000000EF 4572726F723A206669-     	db "Error: file not found.",CR,LF,"$"
   212 000000F8 6C65206E6F7420666F-
   212 00000101 756E642E0D0A24     
   213                                  
   214                                  _gsr:
   215 00000108 E8AD00                          call    getSampleRate                   ; read the sample rate
   216                                                                                  ; pass it onto codec.
   217 0000010B 7243                    	jc	short exit ; 19/11/2016 - nothing to do
   218                                  
   219 0000010D A3[DE1D]                	mov	[sample_rate], ax
   220                                  	
   221                                  	; 19/11/2016
   222 00000110 880E[E01D]              	mov	[stmo], cl
   223 00000114 8816[E21D]              	mov	[bps], dl
   224                                  	
   225                                  	; 17/02/2017
   226 00000118 C606[E41D]00            	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit 
   227 0000011D FEC9                    	dec	cl
   228 0000011F 7504                    	jnz	short _gsr_1 ; stereo
   229 00000121 FE06[E41D]              	inc	byte [fbs_shift] ; 1 = mono or 8 bit		
   230                                  _gsr_1:	
   231 00000125 80FA08                  	cmp	dl, 8 
   232 00000128 7704                    	ja	short _gsr_2 ; 16 bit samples
   233 0000012A FE06[E41D]              	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   234                                  _gsr_2:	
   235 0000012E E8BB19                  	call	write_sample_rate
   236                                  
   237                                  	; 05/11/2023
   238                                  _2:
   239 00000131 E82307                  	call	check4keyboardstop  ; flush keyboard buffer
   240 00000134 72FB                    	jc	short _2 	; 07/11/2023
   241                                  
   242                                  	; 09/11/2023
   243                                  	;; 05/11/2023
   244                                  	;mov	eax, [bus_dev_fn]
   245                                  	;mov	al, PCI_CMD_REG
   246                                  	;call	pciRegRead16			; read PCI command register
   247                                  	;; 17/02/2017
   248                                  	;;mov	dx, [stats_cmd]
   249                                          ;or	dl, IO_ENA+BM_ENA               ; enable IO and bus master
   250                                  	;call	pciRegWrite16 ; pciRegWrite8
   251                                  
   252                                  	;; 06/11/2023
   253                                  	;;mov	eax, [bus_dev_fn]
   254                                  	;;mov	al, PCI_CMD_REG
   255                                  	;;call	pciRegRead8                     ; read PCI command register
   256                                  	;;or	dl, IO_ENA+BM_ENA               ; enable IO and bus master
   257                                  	;;call	pciRegWrite8
   258                                  
   259                                  ; setup the Codec (actually mixer registers) 
   260 00000136 E8E401                          call    codecConfig                     ; unmute codec, set rates.
   261                                  	; 11/11/2023
   262 00000139 721C                    	jc	short init_err
   263                                  ;
   264                                  ; position file pointer to start in actual wav data
   265                                  ; MUCH improvement should really be done here to check if sample size is
   266                                  ; supported, make sure there are 2 channels, etc.  
   267                                  ;
   268 0000013B B442                            mov     ah, 42h
   269 0000013D B000                            mov     al, 0                           ; from start of file
   270 0000013F 8B1E[C01D]                      mov     bx, [filehandle]
   271 00000143 31C9                            xor     cx, cx
   272 00000145 BA2C00                          mov     dx, 44                          ; jump past .wav/riff header
   273 00000148 CD21                            int     21h
   274                                  
   275                                  ; play the .wav file. Most of the good stuff is in here.
   276                                  
   277 0000014A E86403                          call    playWav
   278                                  
   279                                  ; close the .wav file and exit.
   280                                  
   281                                  close_exit:			; 11/11/2023
   282 0000014D E85300                          call    closeFile
   283                                  
   284                                  exit:
   285 00000150 B8004C                          mov     ax, 4c00h
   286 00000153 CD21                    	int 	21h
   287                                  
   288                                  here:
   289 00000155 EBFE                    	jmp	short here
   290                                  
   291                                  	; 11/11/2023
   292                                  init_err:
   293 00000157 BA[391D]                	mov	dx, msg_init_err
   294                                  vra_err: ; 12/11/2023
   295 0000015A B409                            mov	ah, 9
   296 0000015C CD21                            int	21h
   297 0000015E EBED                    	jmp	short close_exit
   298                                  
   299                                  ; MEMALLOC.ASM
   300                                  ;-- SETFREE: Release memory not used  ----------------
   301                                  ;-- Input    : ES = address of PSP
   302                                  ;-- Output   : none
   303                                  ;-- Register : AX, BX, CL and FLAGS are changed 
   304                                  ;-- Info     : Since the stack-segment is always the last segment in an 
   305                                  ;              EXE-file, ES:0000 points to the beginning and SS:SP
   306                                  ;              to the end of the program in memory. Through this the
   307                                  ;              length of the program can be calculated 
   308                                  ; call this routine once at the beginning of the program to free up memory
   309                                  ; assigned to it by DOS.
   310                                  
   311                                  setFree:
   312 00000160 BB0010                  	  mov	bx, 65536/16	; 4K paragraphs ; 17/02/2017 (Erdogan Tan)		
   313                                  
   314 00000163 B44A                              mov	ah, 4ah		; pass new length to DOS
   315 00000165 CD21                              int	21h
   316                                  
   317 00000167 C3                                retn			; back to caller 
   318                                  				; new size (allocated memory) = 64KB
   319                                  
   320                                  memAlloc:
   321                                  ; input: AX = # of paragraphs required
   322                                  ; output: AX = segment of block to use
   323                                  
   324 00000168 53                      	push	bx
   325 00000169 89C3                    	mov	bx, ax
   326 0000016B B448                    	mov	ah, 48h
   327 0000016D CD21                    	int	21h
   328 0000016F 5B                      	pop	bx
   329 00000170 C3                      	retn
   330                                  
   331                                  ; CMDLINE.ASM
   332                                  ; parse the command line
   333                                  ; entry: none
   334                                  ; exit: DS:DX to the 1st supplied item on the command line 
   335                                  
   336                                  processCmdline:
   337 00000171 53                              push    bx
   338 00000172 56                              push    si
   339                                  
   340                                          ;mov    ah, 51h
   341                                          ;int    21h
   342                                          ;mov    ds, bx
   343                                  
   344 00000173 BE8000                          mov     si, 80h
   345 00000176 0FB61C                          movzx   bx, byte [si]
   346 00000179 01DE                            add     si, bx
   347 0000017B 46                              inc     si
   348                                  
   349 0000017C C60400                          mov     byte [si], NULL         ; zero terminate
   350                                  
   351 0000017F BE8100                          mov     si, 81h
   352                                  
   353                                  cmdlineloop:
   354 00000182 AC                              lodsb
   355                                  
   356 00000183 3C00                            cmp     al, NULL                ; found end of line?
   357 00000185 7404                            je      short exitpc
   358 00000187 3C20                            cmp     al, ' '                 ; found a space?
   359 00000189 74F7                            je      short cmdlineloop
   360                                  
   361                                          ; must be the filename here.
   362                                  exitpc:
   363 0000018B 4E                              dec     si                      ; point to start of filename
   364 0000018C 89F2                            mov     dx, si
   365 0000018E 5E                              pop     si
   366 0000018F 5B                              pop     bx
   367 00000190 C3                      	retn
   368                                  
   369                                  ; FILE.ASM
   370                                  ;open or create file
   371                                  ;
   372                                  ;input: ds:dx-->filename (asciiz)
   373                                  ;       al=file Mode (create or open)
   374                                  ;output: none  cs:[filehandle] filled
   375                                  ;
   376                                  openFile:
   377 00000191 50                      	push	ax
   378 00000192 51                      	push	cx
   379 00000193 B43B                    	mov	ah, 3bh			; start with a mode
   380 00000195 00C4                    	add	ah, al			; add in create or open mode
   381 00000197 31C9                    	xor	cx, cx
   382 00000199 CD21                    	int	21h
   383 0000019B 7203                    	jc	short _of1
   384                                  	;mov	[cs:filehandle], ax
   385 0000019D A3[C01D]                	mov	[filehandle], ax
   386                                  _of1:
   387 000001A0 59                      	pop	cx
   388 000001A1 58                      	pop	ax
   389 000001A2 C3                      	retn
   390                                  
   391                                  ; close the currently open file
   392                                  ; input: none, uses cs:[filehandle]
   393                                  closeFile:
   394 000001A3 50                      	push	ax
   395 000001A4 53                      	push	bx
   396 000001A5 833E[C01D]FF            	cmp	word [filehandle], -1
   397 000001AA 7409                    	jz	short _cf1
   398 000001AC 8B1E[C01D]              	mov     bx, [filehandle]  
   399 000001B0 B8003E                  	mov     ax,3e00h
   400 000001B3 CD21                            int     21h              ;close file
   401                                  _cf1:
   402 000001B5 5B                      	pop	bx
   403 000001B6 58                      	pop	ax
   404 000001B7 C3                      	retn
   405                                  
   406                                  getSampleRate:
   407                                  	; 08/12/2016
   408                                  ; reads the sample rate from the .wav file.
   409                                  ; entry: none - assumes file is already open
   410                                  	; 19/11/2016 - Erdogan Tan
   411                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   412                                  ;	cx = number of channels (mono=1, stereo=2)
   413                                  ;	dx = bits per sample (8, 16)
   414                                  
   415 000001B8 53                      	push    bx
   416                                  
   417 000001B9 B442                            mov     ah, 42h
   418 000001BB B000                            mov     al, 0				; from start of file
   419 000001BD 8B1E[C01D]                      mov     bx, [filehandle]
   420 000001C1 31C9                            xor     cx, cx
   421 000001C3 BA0800                          mov     dx, 08h				; "WAVE"
   422 000001C6 CD21                            int     21h
   423                                  
   424 000001C8 BA[A41D]                        mov     dx, smpRBuff
   425 000001CB B91C00                          mov     cx, 28				; 28 bytes
   426 000001CE B43F                    	mov	ah, 3fh
   427 000001D0 CD21                            int     21h
   428                                  
   429 000001D2 813E[A41D]5741          	cmp	word [smpRBuff], 'WA'
   430 000001D8 751C                    	jne	short gsr_stc
   431                                  
   432 000001DA 813E[A61D]5645          	cmp	word [smpRBuff+2], 'VE'
   433 000001E0 7514                    	jne	short gsr_stc
   434                                  
   435 000001E2 833E[B01D]01            	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   436 000001E7 750D                    	jne	short gsr_stc
   437                                  
   438                                  
   439 000001E9 8B0E[B21D]              	mov	cx, [smpRBuff+14]	; return num of channels in CX
   440 000001ED A1[B41D]                        mov     ax, [smpRBuff+16]	; return sample rate in AX
   441 000001F0 8B16[BE1D]              	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   442                                  gsr_retn:
   443 000001F4 5B                              pop     bx
   444 000001F5 C3                              retn
   445                                  
   446                                  gsr_stc:
   447 000001F6 F9                      	stc
   448 000001F7 EBFB                    	jmp	short gsr_retn
   449                                  
   450                                  ;%include 'ac97.asm' ; 29/11/2016 (AC97 codec configuration)
   451                                  %include 'ac97_vra.asm' ; 19/11/2023 (AC97 codec configuration)
     1                              <1> ; 19/11/2023 
     2                              <1> ;	(ready status optimization -in order to prevent wrong init error- )
     3                              <1> ; 18/11/2023
     4                              <1> ; 15/11/2023
     5                              <1> ; 13/11/2023
     6                              <1> ; 12/11/2023
     7                              <1> ; 11/11/2023
     8                              <1> ; 03/11/2023 - 06/11/2023
     9                              <1> ; PCI and AC97 codec functions for wav player
    10                              <1> ; Erdogan Tan (17/02/2017)
    11                              <1> 
    12                              <1> ; ----------------------------------------------------------------------------
    13                              <1> ; PCI.ASM
    14                              <1> ; ----------------------------------------------------------------------------
    15                              <1> 
    16                              <1> ; PCI device register reader/writers.
    17                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    18                              <1> ; 		Last Update: 17/02/2017
    19                              <1> 
    20                              <1> ;===============================================================
    21                              <1> ; 8/16/32bit PCI reader
    22                              <1> ;
    23                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    24                              <1> ;           BIT30 set if 32 bit access requested
    25                              <1> ;           BIT29 set if 16 bit access requested
    26                              <1> ;           otherwise defaults to 8 bit read
    27                              <1> ;
    28                              <1> ; Exit:  DL,DX,EDX register data depending on requested read size
    29                              <1> ;
    30                              <1> ; Note: this routine is meant to be called via pciRegRead8, pciRegread16,
    31                              <1> ;	or pciRegRead32, listed below.
    32                              <1> ;
    33                              <1> ; Note2: don't attempt to read 32bits of data from a non dword aligned reg
    34                              <1> ;	 number. Likewise, don't do 16bit reads from non word aligned reg #
    35                              <1> ; 
    36                              <1> pciRegRead:
    37 000001F9 6653                <1> 	push	ebx
    38 000001FB 51                  <1> 	push	cx
    39 000001FC 6689C3              <1>         mov     ebx, eax                        ; save eax, dh
    40 000001FF 88F1                <1>         mov     cl, dh
    41 00000201 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    42 00000207 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
    43 0000020D 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
    44                              <1> 
    45 0000020F BAF80C              <1>         mov     dx, PCI_INDEX_PORT
    46 00000212 66EF                <1>         out     dx, eax                         ; write PCI selector
    47                              <1> 
    48 00000214 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
    49 00000217 88D8                <1>         mov     al, bl
    50 00000219 2403                <1>         and     al, 3                           ; figure out which port to
    51 0000021B 00C2                <1>         add     dl, al                          ; read to
    52                              <1> 
    53 0000021D 66ED                <1> 	in      eax, dx                         ; do 32bit read
    54 0000021F 66F7C300000080      <1>         test    ebx, PCI32
    55 00000226 7403                <1>         jz      short _pregr1
    56                              <1> 
    57 00000228 6689C2              <1>         mov     edx, eax                        ; return 32bits of data
    58                              <1> _pregr1:
    59 0000022B 89C2                <1> 	mov     dx, ax                          ; return 16bits of data
    60 0000022D 66F7C3000000C0      <1>         test    ebx, PCI32+PCI16
    61 00000234 7502                <1>         jnz     short _pregr2
    62 00000236 88CE                <1>         mov     dh, cl                          ; restore dh for 8 bit read
    63                              <1> _pregr2:
    64 00000238 6689D8              <1>         mov     eax, ebx                        ; restore eax
    65 0000023B 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    66 00000241 59                  <1> 	pop	cx
    67 00000242 665B                <1> 	pop	ebx
    68 00000244 C3                  <1> 	retn
    69                              <1> 
    70                              <1> pciRegRead8:
    71 00000245 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32             ; set up 8 bit read size
    72 0000024B EBAC                <1>         jmp     short pciRegRead		; call generic PCI access
    73                              <1> 
    74                              <1> pciRegRead16:
    75 0000024D 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit read size
    76 00000253 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
    77 00000259 EB9E                <1>         jmp     short pciRegRead
    78                              <1> 
    79                              <1> pciRegRead32:
    80 0000025B 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit read size
    81 00000261 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
    82 00000267 EB90                <1>         jmp     short pciRegRead
    83                              <1> 
    84                              <1> ;===============================================================
    85                              <1> ; 8/16/32bit PCI writer
    86                              <1> ;
    87                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    88                              <1> ;           BIT31 set if 32 bit access requested
    89                              <1> ;           BIT30 set if 16 bit access requested
    90                              <1> ;           otherwise defaults to 8bit read
    91                              <1> ;        DL/DX/EDX data to write depending on size
    92                              <1> ;
    93                              <1> ;
    94                              <1> ; note: this routine is meant to be called via pciRegWrite8, pciRegWrite16,
    95                              <1> ; 	or pciRegWrite32 as detailed below.
    96                              <1> ;
    97                              <1> ; Note2: don't attempt to write 32bits of data from a non dword aligned reg
    98                              <1> ;	 number. Likewise, don't do 16bit writes from non word aligned reg #
    99                              <1> ;
   100                              <1> pciRegWrite:
   101 00000269 6653                <1> 	push	ebx
   102 0000026B 51                  <1> 	push	cx
   103 0000026C 6689C3              <1>         mov     ebx, eax                        ; save eax, dx
   104 0000026F 89D1                <1>         mov     cx, dx
   105 00000271 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
   106 00000277 6625FFFFFFBF        <1>         and     eax, ~PCI16 ; NOT PCI16         ; clear out data size request
   107 0000027D 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
   108                              <1> 
   109 0000027F BAF80C              <1>         mov     dx, PCI_INDEX_PORT
   110 00000282 66EF                <1>         out     dx, eax                         ; write PCI selector
   111                              <1> 
   112 00000284 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
   113 00000287 88D8                <1>         mov     al, bl
   114 00000289 2403                <1>         and     al, 3                           ; figure out which port to
   115 0000028B 00C2                <1>         add     dl, al                          ; write to
   116                              <1> 
   117 0000028D 6689D0              <1>         mov     eax, edx                        ; put data into eax
   118 00000290 89C8                <1>         mov     ax, cx
   119                              <1> 
   120 00000292 EE                  <1>         out     dx, al
   121 00000293 66F7C3000000C0      <1>         test    ebx, PCI16+PCI32                ; only 8bit access? bail
   122 0000029A 740C                <1>         jz      short _pregw1
   123                              <1> 
   124 0000029C EF                  <1>         out     dx, ax                          ; write 16 bit value
   125 0000029D 66F7C300000040      <1>         test    ebx, PCI16                      ; 16bit requested?  bail
   126 000002A4 7502                <1>         jnz     short _pregw1
   127                              <1> 
   128 000002A6 66EF                <1>         out     dx, eax                         ; write full 32bit
   129                              <1> _pregw1:
   130 000002A8 6689D8              <1>         mov     eax, ebx                        ; restore eax
   131 000002AB 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
   132 000002B1 89CA                <1>         mov     dx, cx                          ; restore dx
   133 000002B3 59                  <1> 	pop	cx
   134 000002B4 665B                <1> 	pop	ebx
   135 000002B6 C3                  <1> 	ret
   136                              <1> 
   137                              <1> pciRegWrite8:
   138 000002B7 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 8 bit write size
   139 000002BD EBAA                <1>         jmp     short pciRegWrite		; call generic PCI access
   140                              <1> 
   141                              <1> pciRegWrite16:
   142 000002BF 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit write size
   143 000002C5 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
   144 000002CB EB9C                <1>         jmp     short pciRegWrite
   145                              <1> 
   146                              <1> pciRegWrite32:
   147 000002CD 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit write size
   148 000002D3 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
   149 000002D9 EB8E                <1>         jmp     short pciRegWrite
   150                              <1> 
   151                              <1> ; 17/02/2017 (Modifed by Erdogan Tan for various ICH device IDs)
   152                              <1> ;===============================================================
   153                              <1> ; PCIFindDevice: scan through PCI space looking for a device+vendor ID
   154                              <1> ;
   155                              <1> ;  ENTRY: none
   156                              <1> ;; Entry: EAX=Device+Vendor ID
   157                              <1> ;
   158                              <1> ;  Exit: EAX=PCI address if device found
   159                              <1> ;	 EDX=Device+Vendor ID
   160                              <1> ;        CY clear if found, set if not found. EAX invalid if CY set.
   161                              <1> ;
   162                              <1> ; [old stackless] Destroys: ebx, esi, edi, cl
   163                              <1> ;
   164                              <1> pciFindDevice:
   165                              <1> 	;push	cx
   166                              <1> 	;push	eax ; *
   167                              <1> 	;push	esi
   168                              <1> 	;push	edi
   169                              <1> 
   170                              <1>  	;mov     esi, eax                ; save off vend+device ID
   171                              <1> 
   172                              <1> 	; 17/02/2017
   173 000002DB BE[FE1B]            <1> 	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
   174 000002DE B91500              <1> 	mov	cx, valid_id_count
   175                              <1> pfd_0:
   176 000002E1 66BF00FFFF7F        <1>        	mov     edi, (80000000h - 100h) ; start with bus 0, dev 0 func 0
   177                              <1> nextPCIdevice:
   178 000002E7 6681C700010000      <1>         add     edi, 100h
   179 000002EE 6681FF00F8FF80      <1>         cmp     edi, 80FFF800h		; scanned all devices?
   180                              <1>         ;stc
   181                              <1>         ;je 	short PCIScanExit       ; not found
   182 000002F5 720D                <1> 	jb	short pfd_1
   183 000002F7 66BF00000080        <1> 	mov     edi, 80000000h
   184 000002FD 83C604              <1> 	add	si, 4 ; scan for next device ID
   185 00000300 E202                <1> 	loop	pfd_1	 
   186 00000302 F9                  <1> 	stc	
   187                              <1> 	;jmp 	short PCIScanExit
   188 00000303 C3                  <1> 	retn
   189                              <1> pfd_1:
   190 00000304 6689F8              <1>         mov     eax, edi                ; read PCI registers
   191 00000307 E851FF              <1>         call    pciRegRead32
   192                              <1>         ;cmp    edx, esi                ; found device?
   193 0000030A 663B14              <1>         cmp	edx, dword [si]
   194 0000030D 75D8                <1> 	jne     short nextPCIdevice
   195                              <1>         ;clc
   196                              <1> PCIScanExit:
   197                              <1> 	;pushf
   198 0000030F 66B800000080        <1> 	mov	eax, BIT31
   199 00000315 66F7D0              <1> 	not	eax
   200 00000318 6621F8              <1> 	and	eax, edi		; return only bus/dev/fn #
   201                              <1> 	;popf
   202                              <1> 
   203                              <1> 	;pop	edi
   204                              <1> 	;pop	esi
   205                              <1> 	;pop	edx ; *
   206                              <1> 	;pop	cx
   207 0000031B C3                  <1> 	retn
   208                              <1> 
   209                              <1> ; ----------------------------------------------------------------------------
   210                              <1> ; CODEC.ASM
   211                              <1> ; ----------------------------------------------------------------------------
   212                              <1> 
   213                              <1> ; codec configuration code. Not much here really.
   214                              <1> ; NASM version: Erdogan Tan (29/11/2016)
   215                              <1> 
   216                              <1> ; enable codec, unmute stuff, set output rate to 44.1
   217                              <1> ; entry: ax = desired sample rate
   218                              <1> 
   219                              <1> ; 19/11/2023
   220                              <1> ; 11/11/2023
   221                              <1> ; 06/11/2023
   222                              <1> %if 1
   223                              <1> 
   224                              <1> ;	; 11/11/2023
   225                              <1> ;init_ac97_codec_err1:
   226                              <1> ;	stc
   227                              <1> ;init_ac97_codec_err2:
   228                              <1> ;	retn
   229                              <1> 
   230                              <1> 	; 13/11/2023
   231 0000031C 01                  <1> VRA:	db 1	
   232                              <1> 
   233                              <1> codecConfig:
   234                              <1> 	; 19/11/2023
   235                              <1> 	; 15/11/2023
   236                              <1> 	; 04/11/2023
   237                              <1> 	; 17/02/2017 
   238                              <1> 	; 07/11/2016 (Erdogan Tan)
   239                              <1> 	;PORT_NABM_GLB_CTRL_STAT equ 60h
   240                              <1> 
   241                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   242                              <1>  	; 'AC97_DEF.H'
   243                              <1> 	;AC97_EXTENDED_STATUS equ 002Ah
   244                              <1> 	AC97_EA_SPDIF	equ 0002h
   245                              <1> 	AC97_EA_VRA	equ 0001h
   246                              <1> 	; 04/11/2023
   247                              <1> 	ICH_PO_CR_RESET equ 0002h  ; reset codec
   248                              <1> 	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
   249                              <1> 	ICH_PCM_246_MASK equ 300000h ; 6 channels
   250                              <1> 
   251                              <1> 	; 04/11/2023
   252                              <1> init_ac97_controller:
   253 0000031D 66A1[D61D]          <1> 	mov	eax, [bus_dev_fn]
   254 00000321 B004                <1> 	mov	al, PCI_CMD_REG
   255 00000323 E827FF              <1> 	call	pciRegRead16		; read PCI command register
   256 00000326 80CA05              <1> 	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
   257 00000329 E893FF              <1> 	call	pciRegWrite16
   258                              <1> 
   259 0000032C E87701              <1> 	call	delay_100ms
   260                              <1> 
   261                              <1> init_ac97_codec:
   262                              <1> 	; 18/11/2023
   263 0000032F BD2800              <1> 	mov	bp, 40
   264                              <1> _initc_1:
   265                              <1> 	; 11/11/2023
   266                              <1> 	; (TRDOS 386 v2.0.5, 'audio.s')
   267 00000332 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   268 00000335 0316[CE1D]          <1> 	add	dx, [NABMBAR]
   269 00000339 66ED                <1> 	in	eax, dx
   270                              <1> 	; ?
   271                              <1> 	;; 15/11/2023
   272                              <1> 	;;mov	cx, 40
   273                              <1> 	;mov	bp, 40 ; 18/11/2023
   274                              <1> ;_initc_1:
   275 0000033B BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   276 0000033E 0316[CE1D]          <1> 	add	dx, [NABMBAR]
   277 00000342 66ED                <1> 	in	eax, dx
   278                              <1> 
   279 00000344 6683F8FF            <1> 	cmp	eax, 0FFFFFFFFh ; -1
   280                              <1> 	;je	short init_ac97_codec_err1
   281                              <1> 	; 15/11/2023
   282 00000348 7508                <1> 	jne	short _initc_3
   283                              <1> _initc_2:
   284                              <1> 	;dec	cx
   285 0000034A 4D                  <1> 	dec	bp	; 18/11/2023
   286                              <1> 	;jz	short init_ac97_codec_err1
   287                              <1> 	; 19/11/2023
   288 0000034B 7412                <1> 	jz	short _ac97_codec_ready
   289                              <1> 
   290 0000034D E85601              <1> 	call	delay_100ms
   291 00000350 EBE0                <1> 	jmp	short _initc_1
   292                              <1> _initc_3:
   293 00000352 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   294 00000358 7505                <1> 	jnz	short _ac97_codec_ready
   295                              <1> 
   296 0000035A E8C900              <1> 	call	reset_ac97_codec
   297                              <1> 	; 11/11/2023
   298                              <1> 	;jc	short init_ac97_codec_err2
   299                              <1> 	; 15/11/2023
   300 0000035D 72EB                <1> 	jc	short _initc_2
   301                              <1> 
   302                              <1> _ac97_codec_ready:
   303 0000035F 8B16[CC1D]          <1> 	mov	dx, [NAMBAR]
   304                              <1> 	;add	dx, 0 ; ac_reg_0 ; reset register
   305 00000363 EF                  <1> 	out	dx, ax
   306                              <1> 
   307 00000364 E83F01              <1> 	call	delay_100ms
   308                              <1> 
   309                              <1> 	; 19/11/2023
   310 00000367 09ED                <1> 	or	bp, bp
   311 00000369 751D                <1> 	jnz	short _ac97_codec_init_ok
   312                              <1> 
   313 0000036B 6631C0              <1> 	xor	eax, eax ; 0
   314 0000036E 8B16[CC1D]          <1> 	mov	dx, [NAMBAR]
   315 00000372 83C226              <1> 	add	dx, CODEC_REG_POWERDOWN
   316 00000375 EF                  <1> 	out	dx, ax
   317                              <1> 	
   318                              <1> 	; 19/11/2023
   319                              <1> 	; wait for 1 second
   320                              <1> 	;mov	ecx, 1000 ; 1000*4*0.25ms = 1s
   321 00000376 B90A00              <1> 	mov	cx, 10
   322                              <1> _ac97_codec_rloop:
   323                              <1> 	;call	delay1_4ms
   324                              <1> 	;call	delay1_4ms
   325                              <1> 	;call	delay1_4ms
   326                              <1> 	;call	delay1_4ms
   327 00000379 E82A01              <1> 	call	delay_100ms
   328                              <1> 	;mov	dx, [NAMBAR]
   329                              <1> 	;add	dx, CODEC_REG_POWERDOWN
   330 0000037C ED                  <1> 	in	ax, dx	
   331 0000037D 83E00F              <1> 	and	ax, 0Fh
   332 00000380 3C0F                <1> 	cmp	al, 0Fh
   333 00000382 7404                <1> 	je	short _ac97_codec_init_ok
   334 00000384 E2F3                <1> 	loop	_ac97_codec_rloop 
   335                              <1> 
   336                              <1> init_ac97_codec_err1:
   337 00000386 F9                  <1> 	stc
   338                              <1> init_ac97_codec_err2:
   339 00000387 C3                  <1> 	retn
   340                              <1> 
   341                              <1> _ac97_codec_init_ok:
   342                              <1>         ; 11/11/2023
   343                              <1> 	;mov	al, 2 ; force set 16-bit 2-channel PCM
   344                              <1> 	;mov	dx, GLOB_CNT_REG ; 2Ch
   345                              <1> 	;add	dx, [NABMBAR]
   346                              <1> 	;out	dx, eax
   347                              <1> 
   348                              <1> 	;;call	delay1_4ms
   349                              <1> 
   350 00000388 E86600              <1> 	call 	reset_ac97_controller
   351                              <1> 
   352                              <1> 	; 11/11/2023
   353 0000038B E8DC15              <1> 	call	delay1_4ms
   354                              <1> 
   355                              <1> 	;call 	setup_ac97_codec
   356                              <1> 
   357                              <1> setup_ac97_codec:
   358                              <1> 	; 12/11/2023
   359 0000038E 813E[DE1D]80BB      <1> 	cmp	word [sample_rate], 48000
   360 00000394 742F                <1> 	je	short skip_rate
   361                              <1> 
   362                              <1> ; 11/11/2023
   363                              <1> ; 05/11/2023
   364                              <1> ;%if 1
   365                              <1> 	AC97_EA_VRA equ BIT0 ; 11/11/2023
   366                              <1> 
   367                              <1> 	; 11/11/2023
   368 00000396 8B16[CC1D]          <1> 	mov    	dx, [NAMBAR]               	
   369 0000039A 83C22A              <1> 	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah  	  
   370 0000039D ED                  <1> 	in     	ax, dx
   371 0000039E 24FD                <1> 	and	al, ~BIT1 ; Clear DRA
   372 000003A0 0C01                <1> 	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
   373 000003A2 EF                  <1> 	out	dx, ax			; Enable variable rate audio
   374                              <1> 	
   375 000003A3 B90A00              <1> 	mov	cx, 10
   376                              <1> check_vra:
   377 000003A6 E8FD00              <1> 	call	delay_100ms
   378                              <1> 
   379                              <1> 	; 11/11/2023
   380 000003A9 ED                  <1> 	in	ax, dx
   381 000003AA A801                <1> 	test	al, AC97_EA_VRA ; 1
   382 000003AC 7509                <1> 	jnz	short set_rate
   383                              <1> 
   384                              <1> 	; 11/11/2023
   385 000003AE E2F6                <1> 	loop	check_vra
   386                              <1> 
   387                              <1> 	; 13/11/2023
   388 000003B0 C606[1C03]00        <1> 	mov	byte [VRA], 0
   389 000003B5 EB0E                <1> 	jmp	short skip_rate	
   390                              <1> 
   391                              <1> 	; 12/11/2023
   392                              <1> 	;pop	ax ; discard return address to the caller
   393                              <1> 	;mov	dx, msg_no_vra
   394                              <1> 	;jmp	vra_err
   395                              <1> 
   396                              <1> set_rate:
   397 000003B7 A1[DE1D]            <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   398                              <1> 
   399 000003BA 8B16[CC1D]          <1> 	mov    	dx, [NAMBAR]               	
   400 000003BE 83C22C              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   401 000003C1 EF                  <1> 	out	dx, ax 			; PCM Front/Center Output Sample Rate
   402                              <1> 
   403 000003C2 E8E100              <1> 	call	delay_100ms
   404                              <1> 
   405                              <1> 	; 12/11/2023
   406                              <1> skip_rate:
   407                              <1> 	; 11/11/2023 (temporary)
   408                              <1> 
   409                              <1> 	;mov   	dx, [NAMBAR]               	
   410                              <1> 	;add   	dx, CODEC_PCM_SURND_DACRATE_REG	; 2Eh  	  
   411                              <1> 	;out	dx, ax 			; PCM Surround Output Sample Rate
   412                              <1> 
   413                              <1> 	;call	delay_100ms
   414                              <1> 
   415                              <1> 	;mov   	dx, [NAMBAR]               	
   416                              <1> 	;add   	dx, CODEC_PCM_LFE_DACRATE_REG	; 30h  	  
   417                              <1> 	;out	dx, ax 			; PCM LFE Output Sample Rate
   418                              <1> 
   419                              <1> 	;call	delay_100ms
   420                              <1> 
   421                              <1> 	; 05/11/2023 (temporary)
   422                              <1> 	;mov	dx, [NAMBAR]               	
   423                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   424                              <1> 	;out	dx, ax 			; PCM Input Sample Rate
   425                              <1> 	;
   426                              <1> 	;call	delay_100ms
   427                              <1> 
   428 000003C5 B80202              <1> 	mov	ax, 0202h
   429 000003C8 8B16[CC1D]          <1>   	mov     dx, [NAMBAR]
   430 000003CC 83C202              <1>   	add     dx, CODEC_MASTER_VOL_REG	;02h 
   431 000003CF EF                  <1> 	out     dx, ax
   432                              <1> 
   433                              <1> 	; 11/11/2023
   434                              <1>         ;call	delay1_4ms
   435                              <1>         ;call	delay1_4ms
   436                              <1>         ;call	delay1_4ms
   437                              <1>         ;call	delay1_4ms
   438                              <1>  	;
   439                              <1>   	;mov	dx, [NAMBAR]
   440                              <1>   	;add	dx, CODEC_MASTER_MONO_VOL_REG	;06h 
   441                              <1>   	;out	dx, ax
   442                              <1> 
   443                              <1> 	; 11/11/2023
   444                              <1>         ;call	delay1_4ms
   445                              <1>         ;call	delay1_4ms
   446                              <1>         ;call	delay1_4ms
   447                              <1>         ;call	delay1_4ms
   448                              <1> 	;
   449                              <1> 	;mov	ax, 02h
   450                              <1>   	;mov	dx, [NAMBAR]
   451                              <1>   	;add	dx, CODEC_PCBEEP_VOL_REG	;0Ah 
   452                              <1>   	;out	dx, ax
   453                              <1> 
   454 000003D0 E89715              <1>         call    delay1_4ms
   455 000003D3 E89415              <1>         call    delay1_4ms
   456 000003D6 E89115              <1>         call    delay1_4ms
   457 000003D9 E88E15              <1>         call    delay1_4ms
   458                              <1> 
   459                              <1> 	;mov	ax, 0202h
   460 000003DC 8B16[CC1D]          <1>   	mov     dx, [NAMBAR]
   461 000003E0 83C218              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h 
   462 000003E3 EF                  <1>   	out     dx, ax
   463                              <1> 
   464 000003E4 E88315              <1>         call    delay1_4ms
   465 000003E7 E88015              <1>         call    delay1_4ms
   466 000003EA E87D15              <1>         call    delay1_4ms
   467 000003ED E87A15              <1>         call    delay1_4ms
   468                              <1> 
   469                              <1> 	; 11/11/2023
   470                              <1> 	;mov	ax, 8008h ; Mute
   471                              <1>   	;mov	dx, [NAMBAR]
   472                              <1> 	;add	dx, CODEC_PHONE_VOL_REG		;0Ch
   473                              <1> 	;			 ; AC97_PHONE_VOL ; TAD Input (Mono)
   474                              <1>   	;out	dx, ax
   475                              <1> 	;
   476                              <1>         ;call	delay1_4ms
   477                              <1>         ;call	delay1_4ms
   478                              <1>         ;call	delay1_4ms
   479                              <1> 	;call	delay1_4ms
   480                              <1> 
   481                              <1> 	;mov	ax, 0808h
   482                              <1> 	;mov	dx, [NAMBAR]
   483                              <1> 	;add	dx, CODEC_LINE_IN_VOL_REG ;10h ; Line Input (Stereo)
   484                              <1> 	;out	dx, ax
   485                              <1> 	;
   486                              <1>         ;call	delay1_4ms
   487                              <1>         ;call	delay1_4ms
   488                              <1>         ;call	delay1_4ms
   489                              <1> 	;call	delay1_4ms
   490                              <1> 
   491                              <1>   	;mov	dx, [NAMBAR]
   492                              <1>         ;add	dx, CODEC_CD_VOL_REG ;12h ; CD Input (Stereo)
   493                              <1>   	;out	dx, ax
   494                              <1> 	;
   495                              <1>   	;mov	dx, [NAMBAR]
   496                              <1>         ;add	dx, CODEC_AUX_VOL_REG ;16h ; Aux Input (Stereo)
   497                              <1>   	;out	dx, ax
   498                              <1> 	;
   499                              <1>         ;call	delay1_4ms
   500                              <1>         ;call	delay1_4ms
   501                              <1>         ;call	delay1_4ms
   502                              <1> 	;call	delay1_4ms
   503                              <1> 
   504                              <1> ;detect_ac97_codec:
   505 000003F0 C3                  <1>         retn
   506                              <1> 
   507                              <1> reset_ac97_controller:
   508                              <1> 	; 11/11/2023
   509                              <1> 	; 10/06/2017
   510                              <1> 	; 29/05/2017
   511                              <1> 	; 28/05/2017
   512                              <1> 	; reset AC97 audio controller registers
   513 000003F1 31C0                <1> 	xor     ax, ax
   514 000003F3 BA0B00              <1>         mov	dx, PI_CR_REG
   515 000003F6 0316[CE1D]          <1> 	add	dx, [NABMBAR]
   516 000003FA EE                  <1> 	out     dx, al
   517                              <1> 
   518 000003FB BA1B00              <1>         mov     dx, PO_CR_REG
   519 000003FE 0316[CE1D]          <1> 	add	dx, [NABMBAR]
   520 00000402 EE                  <1> 	out     dx, al
   521                              <1> 
   522 00000403 BA2B00              <1>         mov     dx, MC_CR_REG
   523 00000406 0316[CE1D]          <1> 	add	dx, [NABMBAR]
   524 0000040A EE                  <1> 	out     dx, al
   525                              <1> 
   526 0000040B B002                <1>         mov     al, RR
   527 0000040D BA0B00              <1>         mov     dx, PI_CR_REG
   528 00000410 0316[CE1D]          <1> 	add	dx, [NABMBAR]
   529 00000414 EE                  <1> 	out     dx, al
   530                              <1> 
   531 00000415 BA1B00              <1>         mov     dx, PO_CR_REG
   532 00000418 0316[CE1D]          <1> 	add	dx, [NABMBAR]
   533 0000041C EE                  <1> 	out     dx, al
   534                              <1> 
   535 0000041D BA2B00              <1>         mov     dx, MC_CR_REG
   536 00000420 0316[CE1D]          <1> 	add	dx, [NABMBAR]
   537 00000424 EE                  <1> 	out     dx, al
   538                              <1> 
   539 00000425 C3                  <1> 	retn
   540                              <1> 
   541                              <1> reset_ac97_codec:
   542                              <1> 	; 11/11/2023
   543                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   544 00000426 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   545 00000429 0316[CE1D]          <1> 	add	dx, [NABMBAR]
   546 0000042D 66ED                <1> 	in	eax, dx
   547                              <1> 
   548                              <1> 	;test	eax, 2
   549                              <1> 	; 06/08/2022
   550 0000042F A802                <1> 	test	al, 2
   551 00000431 7405                <1> 	jz	short _r_ac97codec_cold	
   552                              <1> 
   553 00000433 E80E00              <1> 	call	warm_ac97codec_reset
   554 00000436 7306                <1> 	jnc	short _r_ac97codec_ok
   555                              <1> _r_ac97codec_cold:
   556 00000438 E83400              <1>         call    cold_ac97codec_reset
   557 0000043B 7301                <1>         jnc     short _r_ac97codec_ok
   558                              <1> 	
   559                              <1> 	; 16/04/2017
   560                              <1>         ;xor	eax, eax	; timeout error
   561                              <1>        	;stc
   562 0000043D C3                  <1> 	retn
   563                              <1> 
   564                              <1> _r_ac97codec_ok:
   565 0000043E 6631C0              <1>         xor     eax, eax
   566                              <1>         ;mov	al, VIA_ACLINK_C00_READY ; 1
   567 00000441 FEC0                <1>         inc	al
   568 00000443 C3                  <1> 	retn
   569                              <1> 
   570                              <1> warm_ac97codec_reset:
   571                              <1> 	; 11/11/2023
   572                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   573                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   574 00000444 66B806000000        <1> 	mov	eax, 6
   575 0000044A BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   576 0000044D 0316[CE1D]          <1> 	add	dx, [NABMBAR]
   577 00000451 66EF                <1> 	out	dx, eax
   578                              <1> 
   579 00000453 B90A00              <1> 	mov	cx, 10	; total 1s
   580                              <1> _warm_ac97c_rst_wait:
   581 00000456 E84D00              <1> 	call	delay_100ms
   582                              <1> 
   583 00000459 BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   584 0000045C 0316[CE1D]          <1> 	add	dx, [NABMBAR]
   585 00000460 66ED                <1> 	in	eax, dx
   586                              <1> 
   587 00000462 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   588 00000468 7504                <1> 	jnz	short _warm_ac97c_rst_ok
   589                              <1> 
   590 0000046A 49                  <1>         dec     cx
   591 0000046B 75E9                <1>         jnz     short _warm_ac97c_rst_wait
   592                              <1> 
   593                              <1> _warm_ac97c_rst_fail:
   594 0000046D F9                  <1>         stc
   595                              <1> _warm_ac97c_rst_ok:
   596 0000046E C3                  <1> 	retn
   597                              <1> 
   598                              <1> cold_ac97codec_reset:
   599                              <1> 	; 11/11/2023
   600                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   601                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   602 0000046F 66B802000000        <1>         mov	eax, 2
   603 00000475 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   604 00000478 0316[CE1D]          <1> 	add	dx, [NABMBAR]
   605 0000047C 66EF                <1> 	out	dx, eax
   606                              <1> 
   607 0000047E E82500              <1> 	call	delay_100ms 	; wait 100 ms
   608 00000481 E82200              <1> 	call	delay_100ms 	; wait 100 ms
   609 00000484 E81F00              <1> 	call	delay_100ms 	; wait 100 ms
   610 00000487 E81C00              <1> 	call	delay_100ms 	; wait 100 ms
   611                              <1> 
   612 0000048A B91000              <1> 	mov	cx, 16	; total 20*100 ms = 2s
   613                              <1> 
   614                              <1> _cold_ac97c_rst_wait:
   615 0000048D BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   616 00000490 0316[CE1D]          <1> 	add	dx, [NABMBAR]
   617 00000494 66ED                <1> 	in	eax, dx
   618                              <1> 
   619 00000496 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   620 0000049C 7507                <1> 	jnz	short _cold_ac97c_rst_ok
   621                              <1> 
   622 0000049E E80500              <1> 	call	delay_100ms
   623                              <1> 
   624 000004A1 49                  <1>         dec     cx
   625 000004A2 75E9                <1>         jnz     short _cold_ac97c_rst_wait
   626                              <1> 
   627                              <1> _cold_ac97c_rst_fail:
   628 000004A4 F9                  <1>         stc
   629                              <1> _cold_ac97c_rst_ok:
   630 000004A5 C3                  <1> 	retn
   631                              <1> 
   632                              <1> delay_100ms:
   633                              <1> 	; 11/11/2023
   634                              <1> 	; 29/05/2017
   635                              <1> 	; 24/03/2017 ('codec.asm')
   636                              <1> 	; wait 100 ms
   637 000004A6 51                  <1> 	push	cx
   638 000004A7 B99001              <1> 	mov	cx, 400  ; 400*0.25ms
   639                              <1> _delay_x_ms:
   640 000004AA E8BD14              <1> 	call	delay1_4ms
   641 000004AD E2FB                <1>         loop	_delay_x_ms
   642 000004AF 59                  <1> 	pop	cx
   643 000004B0 C3                  <1> 	retn
   644                              <1> 
   645                              <1> %endif
   646                              <1> 
   647                              <1> ; 11/11/2023
   648                              <1> %if 0
   649                              <1> 
   650                              <1> codecConfig:
   651                              <1> 	; 06/11/2023
   652                              <1> 	; TUNELOOP version (playing without interrupt)
   653                              <1> 	; 04/11/2023
   654                              <1> 	; 17/02/2017 
   655                              <1> 	; 07/11/2016 (Erdogan Tan)
   656                              <1> 
   657                              <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   658                              <1> 
   659                              <1> 	mov    	dx, [NAMBAR]               	
   660                              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   661                              <1> 	out	dx, ax 				; out sample rate
   662                              <1> 		
   663                              <1> 	; 05/11/2023 temp
   664                              <1> 	;mov	dx, [NAMBAR]               	
   665                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   666                              <1> 	;out	dx, ax 
   667                              <1> 
   668                              <1>         call    delay1_4ms
   669                              <1>         call    delay1_4ms
   670                              <1>         call    delay1_4ms
   671                              <1>         call    delay1_4ms
   672                              <1> 
   673                              <1> 	mov	eax, [dev_vendor]
   674                              <1>         cmp	eax, (SI7012_DID<<16)+SIS_VID
   675                              <1>         jne	short cConfig1
   676                              <1> 
   677                              <1> 	; Unmute quirk specifically for the SiS7012
   678                              <1> 
   679                              <1> 	CUSTOM_SIS_7012_REG equ 4Ch ; SiS7012-specific register
   680                              <1> 	
   681                              <1>         mov     dx, [NABMBAR]
   682                              <1>         add     dx, CUSTOM_SIS_7012_REG
   683                              <1>         in      ax, dx
   684                              <1>         or	al, 1
   685                              <1>         out     dx, ax
   686                              <1> 
   687                              <1> cConfig1:
   688                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   689                              <1> 	; initial ac97 volumes (and clear mute flag)
   690                              <1> 		
   691                              <1>   	mov     dx, [NAMBAR]
   692                              <1>   	add     dx, CODEC_MASTER_VOL_REG        ;02h ; STEREO
   693                              <1>   	;xor	ax, ax ; volume attenuation = 0 (max. volume)
   694                              <1>   	; 03/11/2023
   695                              <1> 	mov	ax, 0202h
   696                              <1> 	out     dx, ax
   697                              <1> 
   698                              <1>         call    delay1_4ms	; delays because codecs are slow
   699                              <1>         call    delay1_4ms
   700                              <1>         call    delay1_4ms
   701                              <1>         call    delay1_4ms
   702                              <1>  
   703                              <1>   	mov     dx, [NAMBAR]
   704                              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h
   705                              <1>   	;;xor	ax, ax
   706                              <1> 	;mov	ax, 0202h
   707                              <1>   	out     dx, ax
   708                              <1> 
   709                              <1>         call    delay1_4ms
   710                              <1>         call    delay1_4ms
   711                              <1>         call    delay1_4ms
   712                              <1>         call    delay1_4ms
   713                              <1>  
   714                              <1> 	retn
   715                              <1> 
   716                              <1> %endif
   452                                  ;;%include 'ich_wav.asm' ; 17/02/2017 (ICH AC97 wav playing functions)
   453                                  ;%include 'ich_wav3.asm' ; 13/11/2023 (ICH AC97 wav playing functions)
   454                                  %include 'ich_wav5.asm' ; 18/11/2023 (ICH AC97 wav playing functions)
     1                              <1> ; 19/11/2023
     2                              <1> ; 18/11/2023
     3                              <1> ; 17/11/2023
     4                              <1> ; 16/11/2023
     5                              <1> ; 15/11/2023
     6                              <1> ; 14/11/2023
     7                              <1> ; 13/11/2023
     8                              <1> ; 03/11/2023 - 11/11/2023
     9                              <1> ; DOS based .WAV player using AC'97 and codec interface.
    10                              <1> ; ---------------------------------------------------------------
    11                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    12                              <1> ; Last Update: 17/02/2017 (by Erdogan Tan)
    13                              <1> 
    14                              <1> ; AC97 interrupt version - 09/11/2023 - Erdogan Tan
    15                              <1> ; sample rate conversion version - 13/11/2023 - Erdogan Tan
    16                              <1> ; LVI interrupt version (instead of IOC) - 18/11/2023 - Erdogan Tan
    17                              <1> 
    18                              <1> ; ICHWAV.ASM
    19                              <1> 
    20                              <1> ; player internal variables and other equates.
    21                              <1> BUFFERSIZE      equ     64 * 1024       ; 64k file buffer size.
    22                              <1> ENDOFFILE       equ     BIT0            ; flag for knowing end of file
    23                              <1> 
    24                              <1> ;===========================================================================
    25                              <1> ; entry: none. File is already open and [filehandle] filled.
    26                              <1> ; exit:  not until the song is finished or the user aborts.
    27                              <1> ;
    28                              <1> playWav:
    29                              <1> 	; 13/11/2023
    30                              <1> 
    31 000004B1 803E[1C03]01        <1> 	cmp	byte [VRA], 1
    32 000004B6 720F                <1> 	jb	short chk_sample_rate
    33                              <1> playwav_48_khz:	
    34 000004B8 C706[6706][7E07]    <1> 	mov	word [loadfromwavfile], loadFromFile
    35                              <1> 	;mov	word [loadsize], 0 ; 65536
    36 000004BE C706[6B06]0080      <1> 	mov	word [buffersize], 32768 ; samples
    37 000004C4 E9A801              <1> 	jmp	playWav_vra
    38                              <1> 
    39                              <1> chk_sample_rate:
    40                              <1> 	; set conversion parameters
    41                              <1> 	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
    42 000004C7 A1[DE1D]            <1> 	mov	ax, [sample_rate]
    43 000004CA 3D80BB              <1> 	cmp	ax, 48000
    44 000004CD 74E9                <1> 	je	short playwav_48_khz
    45                              <1> chk_22khz:
    46 000004CF 3D2256              <1> 	cmp	ax, 22050
    47 000004D2 752F                <1> 	jne	short chk_11khz
    48 000004D4 803E[E21D]08        <1> 	cmp	byte [bps], 8
    49 000004D9 760F                <1> 	jna	short chk_22khz_1
    50 000004DB BB[8D11]            <1> 	mov	bx, load_22khz_stereo_16_bit
    51 000004DE 803E[E01D]01        <1> 	cmp	byte [stmo], 1 
    52 000004E3 7512                <1> 	jne	short chk_22khz_2
    53 000004E5 BB[2411]            <1> 	mov	bx, load_22khz_mono_16_bit
    54 000004E8 EB0D                <1> 	jmp	short chk_22khz_2
    55                              <1> chk_22khz_1:
    56 000004EA BB[BF10]            <1> 	mov	bx, load_22khz_stereo_8_bit
    57 000004ED 803E[E01D]01        <1> 	cmp	byte [stmo], 1 
    58 000004F2 7503                <1> 	jne	short chk_22khz_2
    59 000004F4 BB[5610]            <1> 	mov	bx, load_22khz_mono_8_bit
    60                              <1> chk_22khz_2:
    61 000004F7 B85A1D              <1> 	mov	ax, 7514  ; (442*17)
    62 000004FA BA2500              <1> 	mov	dx, 37
    63 000004FD B91100              <1> 	mov	cx, 17 
    64 00000500 E93301              <1> 	jmp	set_sizes	
    65                              <1> chk_11khz:
    66 00000503 3D112B              <1> 	cmp	ax, 11025
    67 00000506 752F                <1> 	jne	short chk_44khz
    68 00000508 803E[E21D]08        <1> 	cmp	byte [bps], 8
    69 0000050D 760F                <1> 	jna	short chk_11khz_1
    70 0000050F BB[2113]            <1> 	mov	bx, load_11khz_stereo_16_bit
    71 00000512 803E[E01D]01        <1> 	cmp	byte [stmo], 1 
    72 00000517 7512                <1> 	jne	short chk_11khz_2
    73 00000519 BB[C612]            <1> 	mov	bx, load_11khz_mono_16_bit
    74 0000051C EB0D                <1> 	jmp	short chk_11khz_2
    75                              <1> chk_11khz_1:
    76 0000051E BB[6B12]            <1> 	mov	bx, load_11khz_stereo_8_bit
    77 00000521 803E[E01D]01        <1> 	cmp	byte [stmo], 1 
    78 00000526 7503                <1> 	jne	short chk_11khz_2
    79 00000528 BB[0D12]            <1> 	mov	bx, load_11khz_mono_8_bit
    80                              <1> chk_11khz_2:
    81 0000052B B8AD0E              <1> 	mov	ax, 3757  ; (221*17)
    82 0000052E BA4A00              <1> 	mov	dx, 74
    83 00000531 B91100              <1> 	mov	cx, 17
    84 00000534 E9FF00              <1> 	jmp	set_sizes 
    85                              <1> chk_44khz:
    86 00000537 3D44AC              <1> 	cmp	ax, 44100
    87 0000053A 752F                <1> 	jne	short chk_16khz
    88 0000053C 803E[E21D]08        <1> 	cmp	byte [bps], 8
    89 00000541 760F                <1> 	jna	short chk_44khz_1
    90 00000543 BB[D214]            <1> 	mov	bx, load_44khz_stereo_16_bit
    91 00000546 803E[E01D]01        <1> 	cmp	byte [stmo], 1 
    92 0000054B 7512                <1> 	jne	short chk_44khz_2
    93 0000054D BB[7A14]            <1> 	mov	bx, load_44khz_mono_16_bit
    94 00000550 EB0D                <1> 	jmp	short chk_44khz_2
    95                              <1> chk_44khz_1:
    96 00000552 BB[1C14]            <1> 	mov	bx, load_44khz_stereo_8_bit
    97 00000555 803E[E01D]01        <1> 	cmp	byte [stmo], 1 
    98 0000055A 7503                <1> 	jne	short chk_44khz_2
    99 0000055C BB[BF13]            <1> 	mov	bx, load_44khz_mono_8_bit
   100                              <1> chk_44khz_2:
   101                              <1> 	;mov	ax, 15065 ; (655*23)
   102                              <1> 	; 18/11/2023 ((file size + bss + stack) <= 64KB)
   103 0000055F B8FC36              <1> 	mov	ax, 14076 ; (612 *23)
   104 00000562 BA1900              <1> 	mov	dx, 25
   105 00000565 B91700              <1> 	mov	cx, 23
   106 00000568 E9CB00              <1> 	jmp	set_sizes 
   107                              <1> chk_16khz:
   108 0000056B 3D803E              <1> 	cmp	ax, 16000
   109 0000056E 752F                <1> 	jne	short chk_8khz
   110 00000570 803E[E21D]08        <1> 	cmp	byte [bps], 8
   111 00000575 760F                <1> 	jna	short chk_16khz_1
   112 00000577 BB[D40C]            <1> 	mov	bx, load_16khz_stereo_16_bit
   113 0000057A 803E[E01D]01        <1> 	cmp	byte [stmo], 1 
   114 0000057F 7512                <1> 	jne	short chk_16khz_2
   115 00000581 BB[730C]            <1> 	mov	bx, load_16khz_mono_16_bit
   116 00000584 EB0D                <1> 	jmp	short chk_16khz_2
   117                              <1> chk_16khz_1:
   118 00000586 BB[E30B]            <1> 	mov	bx, load_16khz_stereo_8_bit
   119 00000589 803E[E01D]01        <1> 	cmp	byte [stmo], 1 
   120 0000058E 7503                <1> 	jne	short chk_16khz_2
   121 00000590 BB[7F0B]            <1> 	mov	bx, load_16khz_mono_8_bit
   122                              <1> chk_16khz_2:
   123 00000593 B85515              <1> 	mov	ax, 5461
   124 00000596 BA0300              <1> 	mov	dx, 3
   125 00000599 B90100              <1> 	mov	cx, 1
   126 0000059C E99700              <1> 	jmp	set_sizes 
   127                              <1> chk_8khz:
   128 0000059F 3D401F              <1> 	cmp	ax, 8000
   129 000005A2 752E                <1> 	jne	short chk_24khz
   130 000005A4 803E[E21D]08        <1> 	cmp	byte [bps], 8
   131 000005A9 760F                <1> 	jna	short chk_8khz_1
   132 000005AB BB[980A]            <1> 	mov	bx, load_8khz_stereo_16_bit
   133 000005AE 803E[E01D]01        <1> 	cmp	byte [stmo], 1 
   134 000005B3 7512                <1> 	jne	short chk_8khz_2
   135 000005B5 BB[070A]            <1> 	mov	bx, load_8khz_mono_16_bit
   136 000005B8 EB0D                <1> 	jmp	short chk_8khz_2
   137                              <1> chk_8khz_1:
   138 000005BA BB[1709]            <1> 	mov	bx, load_8khz_stereo_8_bit
   139 000005BD 803E[E01D]01        <1> 	cmp	byte [stmo], 1 
   140 000005C2 7503                <1> 	jne	short chk_8khz_2
   141 000005C4 BB[6408]            <1> 	mov	bx, load_8khz_mono_8_bit
   142                              <1> chk_8khz_2:
   143 000005C7 B8AA0A              <1> 	mov	ax, 2730
   144 000005CA BA0600              <1> 	mov	dx, 6
   145 000005CD B90100              <1> 	mov	cx, 1
   146 000005D0 EB64                <1> 	jmp	short set_sizes 
   147                              <1> chk_24khz:
   148 000005D2 3DC05D              <1> 	cmp	ax, 24000
   149 000005D5 752E                <1> 	jne	short chk_32khz
   150 000005D7 803E[E21D]08        <1> 	cmp	byte [bps], 8
   151 000005DC 760F                <1> 	jna	short chk_24khz_1
   152 000005DE BB[690E]            <1> 	mov	bx, load_24khz_stereo_16_bit
   153 000005E1 803E[E01D]01        <1> 	cmp	byte [stmo], 1 
   154 000005E6 7512                <1> 	jne	short chk_24khz_2
   155 000005E8 BB[200E]            <1> 	mov	bx, load_24khz_mono_16_bit
   156 000005EB EB0D                <1> 	jmp	short chk_24khz_2
   157                              <1> chk_24khz_1:
   158 000005ED BB[B80D]            <1> 	mov	bx, load_24khz_stereo_8_bit
   159 000005F0 803E[E01D]01        <1> 	cmp	byte [stmo], 1 
   160 000005F5 7503                <1> 	jne	short chk_24khz_2
   161 000005F7 BB[690D]            <1> 	mov	bx, load_24khz_mono_8_bit
   162                              <1> chk_24khz_2:
   163 000005FA B80020              <1> 	mov	ax, 8192
   164 000005FD BA0200              <1> 	mov	dx, 2
   165 00000600 B90100              <1> 	mov	cx, 1
   166 00000603 EB31                <1> 	jmp	short set_sizes 
   167                              <1> chk_32khz:
   168 00000605 3D007D              <1> 	cmp	ax, 32000
   169 00000608 7556                <1> 	jne	short vra_needed
   170 0000060A 803E[E21D]08        <1> 	cmp	byte [bps], 8
   171 0000060F 760F                <1> 	jna	short chk_32khz_1
   172 00000611 BB[EB0F]            <1> 	mov	bx, load_32khz_stereo_16_bit
   173 00000614 803E[E01D]01        <1> 	cmp	byte [stmo], 1 
   174 00000619 7512                <1> 	jne	short chk_32khz_2
   175 0000061B BB[9E0F]            <1> 	mov	bx, load_32khz_mono_16_bit
   176 0000061E EB0D                <1> 	jmp	short chk_32khz_2
   177                              <1> chk_32khz_1:
   178 00000620 BB[270F]            <1> 	mov	bx, load_32khz_stereo_8_bit
   179 00000623 803E[E01D]01        <1> 	cmp	byte [stmo], 1 
   180 00000628 7503                <1> 	jne	short chk_32khz_2
   181 0000062A BB[CF0E]            <1> 	mov	bx, load_32khz_mono_8_bit
   182                              <1> chk_32khz_2:
   183 0000062D B8AA2A              <1> 	mov	ax, 10922
   184 00000630 BA0300              <1> 	mov	dx, 3
   185 00000633 B90200              <1> 	mov	cx, 2
   186                              <1> 	;jmp	short set_sizes 
   187                              <1> set_sizes:
   188 00000636 803E[E01D]01        <1> 	cmp	byte [stmo], 1
   189 0000063B 7402                <1> 	je	short ss_1
   190 0000063D D1E0                <1> 	shl	ax, 1
   191                              <1> ss_1:
   192 0000063F 803E[E21D]08        <1> 	cmp	byte [bps], 8
   193 00000644 7602                <1> 	jna	short ss_2
   194                              <1> 	; 16 bit samples
   195 00000646 D1E0                <1> 	shl	ax, 1
   196                              <1> ss_2:
   197 00000648 A3[6906]            <1> 	mov	[loadsize], ax
   198 0000064B F7E2                <1> 	mul	dx
   199                              <1> 	;cmp	cx, 1
   200                              <1> 	;je	short ss_3
   201                              <1> ;ss_3:
   202 0000064D F7F1                <1> 	div	cx
   203 0000064F 8A0E[E41D]          <1> 	mov	cl, [fbs_shift]
   204 00000653 D3E0                <1> 	shl	ax, cl
   205 00000655 D1E8                <1> 	shr	ax, 1	; buffer size is 16 bit sample count
   206 00000657 A3[6B06]            <1> 	mov	[buffersize], ax 
   207 0000065A 891E[6706]          <1> 	mov	[loadfromwavfile], bx
   208 0000065E EB0F                <1> 	jmp	short playWav_vra
   209                              <1> 
   210                              <1> vra_needed:
   211                              <1> 	; 13/11/2023
   212 00000660 58                  <1> 	pop	ax ; discard return address to the caller
   213 00000661 BA[6A1D]            <1> 	mov	dx, msg_no_vra
   214 00000664 E9F3FA              <1> 	jmp	vra_err
   215                              <1> 
   216                              <1> 	; 13/11/2023
   217                              <1> loadfromwavfile:
   218 00000667 [7E07]              <1> 	dw	loadFromFile
   219                              <1> loadsize:	; read from wav file
   220 00000669 0000                <1> 	dw	0
   221                              <1> buffersize:	; write to DMA buffer
   222 0000066B 00800000            <1> 	dd	32768 ; 16 bit samples (not bytes)
   223                              <1> 
   224                              <1> playWav_vra:
   225                              <1> 	; 07/11/2023
   226                              <1> 	; clear buffer 2
   227                              <1>         ;push	es
   228                              <1> 	;mov	ax, [WAV_BUFFER2]
   229                              <1> 	;mov	es, ax
   230                              <1> 	;sub	ax, ax
   231                              <1> 	;mov	di, ax ; 17/02/2017
   232                              <1> 	;mov	cx, (BUFFERSIZE/2)
   233                              <1> 	;rep	stosw
   234                              <1> 	;pop	es	     
   235                              <1> 	
   236                              <1> 	; load 64k into buffer 1
   237 0000066F A1[D21D]            <1>         mov     ax, [WAV_BUFFER1]
   238                              <1>         ;call	loadFromFile
   239                              <1> 	; 13/11/2023
   240 00000672 FF16[6706]          <1> 	call	word [loadfromwavfile]
   241                              <1> 
   242                              <1> 	; and 64k into buffer 2
   243 00000676 A1[D41D]            <1> 	mov     ax, [WAV_BUFFER2]
   244                              <1>        	;call	loadFromFile
   245                              <1> 	; 13/11/2023
   246 00000679 FF16[6706]          <1> 	call	word [loadfromwavfile]
   247                              <1> 
   248                              <1> ; register reset the DMA engine. This may cause a pop noise on the output
   249                              <1> ; lines when the device is reset. Prolly a better idea to mute output, then
   250                              <1> ; reset.
   251                              <1> 
   252                              <1> 	; 11/11/2023
   253                              <1>         ;mov	dx, [NABMBAR]
   254                              <1>         ;add	dx, PO_CR_REG		; set pointer to Ctrl reg
   255                              <1>         ;mov	al, RR			; set reset
   256                              <1> 	;out	dx, al			; self clearing bit
   257                              <1> 
   258                              <1> ; write last valid index to 31 to start with.
   259                              <1> ; The Last Valid Index register tells the DMA engine when to stop playing.
   260                              <1> ; 
   261                              <1> ; As we progress through the song we change the last valid index to always be
   262                              <1> ; something other than the index we're currently playing.  
   263                              <1> ;
   264                              <1> 	; 08/11/2023
   265                              <1> 	;; 07/11/2023
   266                              <1> 	;mov	al, 1
   267                              <1>         ;;mov	al, 31
   268                              <1> 	;call	setLastValidIndex
   269                              <1> 
   270                              <1> ; create Buffer Descriptor List
   271                              <1> ;
   272                              <1> ; A buffer descriptor list is a list of pointers and control bits that the
   273                              <1> ; DMA engine uses to know where to get the .wav data and how to play it.
   274                              <1> ;
   275                              <1> ; I set it up to use only 2 buffers of .wav data, and whenever 1 buffer is
   276                              <1> ; playing, I refresh the other one with good data.
   277                              <1> ;
   278                              <1> ;
   279                              <1> ; For the control bits, you can specify that the DMA engine fire an interrupt
   280                              <1> ; after a buffer has been processed, but I poll the current index register
   281                              <1> ; to know when it's safe to update the other buffer.
   282                              <1> ;
   283                              <1> ; I set the BUP bit, which tells the DMA engine to just play 0's (silence)
   284                              <1> ; if it ever runs out of data to play. Good for safety.
   285                              <1> ;
   286 0000067D 06                  <1>         push    es
   287 0000067E A1[D01D]            <1>         mov     ax, [BDL_BUFFER]		; get segment # for BDL
   288 00000681 8EC0                <1>         mov     es, ax
   289                              <1> 
   290 00000683 B91000              <1>         mov     cx, 32 / 2                      ; make 32 entries in BDL
   291 00000686 31FF                <1>         xor     di, di                          
   292                              <1> _0:
   293                              <1> 
   294                              <1> ; set buffer descriptor 0 to start of data file in memory
   295 00000688 660FB706[D21D]      <1>         movzx   eax, word [WAV_BUFFER1]
   296 0000068E 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   297 00000692 66AB                <1>         stosd                                   ; store pointer to wavbuffer1
   298                              <1> 
   299                              <1> ;
   300                              <1> ; set length to 32k samples. 1 sample is 16bits or 2bytes.
   301                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples.
   302                              <1> ; 
   303                              <1> 
   304                              <1> ; 17/02/2017 (Erdogan Tan)
   305                              <1> ; Intel 82801AA (ICH) & Intel 82801AB (ICH0) I/O Controller Hub AC97
   306                              <1> ; Programmers Reference Manual
   307                              <1> 
   308                              <1> ; 2.2.1 Buffer Descriptor List  (on Page 13)
   309                              <1> 	;
   310                              <1> 	;  Generic Form of Buffer Descriptor
   311                              <1> 	;  ---------------------------------
   312                              <1> 	;  63   62    61-48    47-32   31-0
   313                              <1> 	;  ---  ---  --------  ------- -----
   314                              <1> 	;  IOC  BUP -reserved- Buffer  Buffer
   315                              <1> 	;		      Length   Pointer
   316                              <1> 	;		      [15:0]   [31:0]
   317                              <1> 	;
   318                              <1> 	;  IOC:	Interrupt On Completion. 
   319                              <1> 	;	1 = Enabled. 
   320                              <1> 	;	    When this is set, it means that the controller should
   321                              <1> 	;	    issue an interrupt upon completion of this buffer.
   322                              <1> 	;	    It should also set the IOC bit in the status register
   323                              <1> 	;	0 = Disabled	
   324                              <1> 	;
   325                              <1> 	;  BUP: Buffer Underrun Policy.
   326                              <1> 	;       0 = When this buffer is complete,
   327                              <1> 	;	    if the next buffer is not yet ready 
   328                              <1> 	;	    (i.e., the last valid buffer has been processed),
   329                              <1> 	;	    then continue to transmit the last valid sample.
   330                              <1> 	;	1 = When this buffer is complete,
   331                              <1> 	;     	    if this is the last valid buffer, transmit zeros after
   332                              <1> 	;	    this buffer has been processed completely.
   333                              <1> 	;	    This bit typically is set only if this is the last 
   334                              <1> 	;	    buffer in the current stream.
   335                              <1> 	;
   336                              <1> 	; [31:0]: Buffer pointer. This field points to the location of
   337                              <1> 	;	  the data buffer. Since samples can be as wide as one
   338                              <1> 	;	  word, the buffer must be aligned with word boundaries,
   339                              <1> 	;	  to prevent samples from straddling DWord boundaries.
   340                              <1> 	;
   341                              <1> 	; [15:0]: Buffer Length: This is the length of the data buffer,
   342                              <1> 	;	  in number of samples. The controller uses this data
   343                              <1> 	;	  to determine the length of the buffer, in bytes.
   344                              <1> 	;	  "0" indicates no sample to process.
   345                              <1> 
   346                              <1> ; ICH2AC97.INC
   347                              <1> 
   348                              <1> ;	IOC	equ     BIT31   ; Fire an interrupt whenever this
   349                              <1> 				; buffer is complete.
   350                              <1> 
   351                              <1> ;	BUP	equ     BIT30   ; Buffer Underrun Policy.
   352                              <1> 				; if this buffer is the last buffer
   353                              <1> 				; in a playback, fill the remaining
   354                              <1> 				; samples with 0 (silence) or not.
   355                              <1> 				; It's a good idea to set this to 1
   356                              <1> 				; for the last buffer in playback,
   357                              <1> 				; otherwise you're likely to get a lot
   358                              <1> 				; of noise at the end of the sound.
   359                              <1> ;
   360                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   361                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   362                              <1> ; Luckily for us, that's the same format as .wav files.
   363                              <1> ;
   364                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   365                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   366                              <1> ;
   367                              <1> ; A value of 0 in these bits means play no samples.
   368                              <1> ;
   369                              <1> 
   370                              <1> ; ICHWAV.ASM
   371                              <1> 
   372                              <1> 	;mov	eax, BUFFERSIZE / 2 ; size of half buffer (32K)
   373                              <1> 	; 13/11/2023
   374 00000694 66A1[6B06]          <1> 	mov	eax, [buffersize]
   375                              <1> 
   376                              <1> 	; 18/11/2023
   377                              <1> 	; 09/11/2023
   378                              <1> 	;or	eax, IOC + BUP
   379                              <1> 	; 06/11/2023
   380 00000698 660D00000040        <1> 	or	eax, BUP
   381 0000069E 66AB                <1> 	stosd
   382                              <1> 
   383                              <1> ; 2nd buffer:
   384                              <1> 
   385 000006A0 660FB706[D41D]      <1>         movzx   eax, word [WAV_BUFFER2]
   386 000006A6 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   387 000006AA 66AB                <1>         stosd                                   ; store pointer to wavbuffer2
   388                              <1> 
   389                              <1> ; set length to 64k (32k of two 16 bit samples)
   390                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples
   391                              <1> ; 
   392                              <1> 	;mov	eax, BUFFERSIZE / 2
   393                              <1> 	; 13/11/2023
   394 000006AC 66A1[6B06]          <1> 	mov	eax, [buffersize]
   395                              <1> 
   396                              <1> 	; 18/11/2023
   397                              <1> 	; 09/11/2023
   398                              <1> 	;or	eax, IOC + BUP
   399                              <1> 	; 06/11/2023
   400 000006B0 660D00000040        <1> 	or	eax, BUP
   401 000006B6 66AB                <1> 	stosd
   402                              <1> 
   403 000006B8 E2CE                <1>         loop    _0
   404 000006BA 07                  <1>         pop     es
   405                              <1> 
   406                              <1> ;
   407                              <1> ; tell the DMA engine where to find our list of Buffer Descriptors.
   408                              <1> ; this 32bit value is a flat mode memory offset (ie no segment:offset)
   409                              <1> ;
   410                              <1> ; write NABMBAR+10h with offset of buffer descriptor list
   411                              <1> ;
   412 000006BB 660FB706[D01D]      <1>         movzx   eax, word [BDL_BUFFER]
   413 000006C1 66C1E004            <1> 	shl     eax, 4                          ; convert seg:off to 0:off
   414 000006C5 8B16[CE1D]          <1>         mov     dx, [NABMBAR]
   415 000006C9 83C210              <1>         add     dx, PO_BDBAR_REG                ; set pointer to BDL
   416 000006CC 66EF                <1>         out     dx, eax                         ; write to AC97 controller
   417                              <1> 
   418                              <1> ;
   419                              <1> ; All set. Let's play some music.
   420                              <1> ;
   421                              <1> 
   422                              <1> 	; 18/11/2023
   423                              <1> 	; 10/11/2023
   424                              <1> 	; 08/11/2023
   425                              <1> 	; 07/11/2023
   426                              <1> 	; 08/12/2016
   427                              <1> 	; 07/10/2016
   428 000006CE B001                <1> 	mov	al, 1	; 18/11/2023
   429                              <1> 	;mov	al, 31
   430 000006D0 A2[E61D]            <1> 	mov	[LVI], al ; 10/11/2023
   431 000006D3 E87501              <1> 	call	setLastValidIndex
   432                              <1> 
   433                              <1> 	; 06/11/2023 (not neccessary)
   434                              <1> 	;; 05/11/2023
   435                              <1> 	;; reset current index
   436                              <1> 	;mov	al, 0
   437                              <1> 	;call	setCurrentIndex
   438                              <1> 
   439                              <1> 	; 06/11/2023
   440                              <1> 	;mov	byte [tLoop], 1 ; 30/11/2016
   441                              <1> 
   442                              <1> 	; 17/02/2017
   443 000006D6 8B16[CE1D]          <1>         mov     dx, [NABMBAR]
   444 000006DA 83C21B              <1>         add     dx, PO_CR_REG                   ; PCM out Control Register
   445                              <1>         ; 18/11/2023
   446 000006DD B005                <1> 	mov	al, LVBIE + RPBM ; Enable LVBI interrupt and run bus master
   447                              <1> 	; 09/11/2023
   448                              <1> 	;mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
   449                              <1> 	;			; (LVBI interrupt will not be enabled)
   450                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   451                              <1> 	;mov	al, RPBM
   452 000006DF EE                  <1> 	out     dx, al                          ; Start bus master operation.
   453                              <1> 
   454                              <1> 	; 09/11/2023
   455 000006E0 C606[E51D]3F        <1> 	mov	byte [b_indicator], '?'	
   456                              <1> 
   457                              <1> 	; 06/11/2023
   458                              <1> 	;call	delay1_4ms
   459                              <1> 	;call	delay1_4ms
   460                              <1> 	;call	delay1_4ms
   461                              <1> 	;call	delay1_4ms
   462                              <1> 
   463                              <1> 	; 10/11/2023
   464                              <1> 	;mov	byte [tloop], 1
   465                              <1> 
   466                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   467                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   468                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   469                              <1> 
   470                              <1> ; 09/11/2023   
   471                              <1> ; 06/11/2023
   472                              <1> %if 1
   473                              <1> 	; 08/12/2016
   474                              <1> 	; 28/11/2016
   475                              <1> p_loop:
   476 000006E5 E86F01              <1> 	call    check4keyboardstop ; keyboard halt?
   477 000006E8 732A                <1>         jnc	short r_loop 	   ; no ; 09/11/2023
   478                              <1> 
   479                              <1> 	; 09/11/2023
   480                              <1> 	;or	byte [flags], ENDOFFILE
   481                              <1> 	;mov	byte [b_indicator], '0'
   482                              <1> q_loop:
   483                              <1> 	;mov	al, '0'
   484 000006EA E88300              <1> 	call	tL0
   485                              <1> 
   486                              <1> 	; 04/11/2023
   487                              <1> 	; finished with song, stop everything
   488 000006ED E89814              <1> 	call	ac97_stop
   489                              <1> 
   490                              <1> 	; 11/11/2023
   491                              <1> irq_restore:	
   492                              <1> 	; restore previous interrupt vector and interrupt_status
   493 000006F0 FA                  <1> 	cli
   494 000006F1 E4A1                <1> 	in	al, 0A1h ; irq 8-15
   495 000006F3 A0[C71D]            <1> 	mov	al, [IRQ_status+1]
   496 000006F6 E6A1                <1> 	out	0A1h, al 
   497 000006F8 E421                <1> 	in	al, 021h ; irq 0-7
   498 000006FA A0[C61D]            <1> 	mov	al, [IRQ_status]
   499 000006FD E621                <1> 	out	21h, al 
   500                              <1> 	; ...
   501 000006FF 06                  <1> 	push	es
   502 00000700 31C0                <1> 	xor	ax, ax
   503 00000702 8EC0                <1> 	mov	es, ax
   504 00000704 A1[C81D]            <1> 	mov	ax, [IRQ_vector]
   505 00000707 268907              <1> 	mov	[es:bx], ax
   506 0000070A A1[CA1D]            <1> 	mov	ax, [IRQ_vector+2]
   507 0000070D 26894702            <1> 	mov	[es:bx+2], ax
   508 00000711 07                  <1> 	pop	es
   509 00000712 FB                  <1> 	sti
   510 00000713 C3                  <1> 	retn
   511                              <1> 
   512                              <1> r_loop:
   513                              <1> 	; 10/11/2023
   514                              <1> 	;nop
   515                              <1> 	;nop
   516                              <1> 	;nop
   517                              <1> 
   518                              <1> 	; 11/11/2023	
   519 00000714 B030                <1> 	mov	al, '0'
   520 00000716 803E[C51D]00        <1> 	cmp	byte [tloop], 0
   521 0000071B 74C8                <1> 	je	short p_loop
   522 0000071D 7CCB                <1> 	jl	short q_loop
   523                              <1> 
   524 0000071F FE0E[C51D]          <1> 	dec	byte [tloop] ; 0
   525                              <1> 
   526 00000723 803E[E51D]31        <1> 	cmp	byte [b_indicator], '1' ; will be played
   527 00000728 7515                <1> 	jne	short s_loop
   528                              <1> 	
   529                              <1> 	; 19/11/2023
   530                              <1> 	; load buffer 1
   531 0000072A A1[D21D]            <1> 	mov	ax, [WAV_BUFFER1] ; will be played
   532                              <1> u_loop:
   533                              <1> 	;call	loadFromFile
   534                              <1> 	; 13/11/2023
   535 0000072D FF16[6706]          <1> 	call	word [loadfromwavfile]
   536 00000731 7304                <1> 	jnc	short v_loop
   537                              <1> 	
   538                              <1> 	; 19/11/2023
   539                              <1> 	;cmp	byte [tloop], -1
   540                              <1> 	;jne	short v_loop
   541                              <1> 	
   542 00000733 B030                <1> 	mov	al, '0'
   543 00000735 EBB3                <1> 	jmp	short q_loop
   544                              <1> v_loop:
   545                              <1> 	; 09/11/2023 - Erdogan Tan
   546                              <1> 	; (print buffer number on top left of the screen)
   547 00000737 A0[E51D]            <1> 	mov	al, [b_indicator] ; going to be played
   548 0000073A E83300              <1> 	call	tL0
   549 0000073D EBA6                <1> 	jmp	short p_loop
   550                              <1> s_loop:
   551                              <1> 	; load buffer 2
   552 0000073F A1[D41D]            <1> 	mov	ax, [WAV_BUFFER2] ; will be played
   553 00000742 EBE9                <1> 	jmp	short u_loop
   554                              <1> 
   555                              <1> %endif
   556                              <1> 
   557                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   558                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   559                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   560                              <1> 
   561                              <1> ; 18/11/2023
   562                              <1> %if 1
   563                              <1> 
   564                              <1> tuneLoop:
   565                              <1> 	; 19/11/2023
   566                              <1> 	; 18/11/2023
   567 00000744 F606[C21D]01        <1> 	test	byte [flags], ENDOFFILE
   568 00000749 751E                <1> 	jnz	short tL3
   569                              <1> 
   570                              <1> 	; 19/11/2023
   571 0000074B C606[C51D]01        <1> 	mov	byte [tloop], 1
   572                              <1> 	
   573                              <1> 	; set LVI to the next
   574                              <1> 	; (and then load audio data in that buffer) 
   575 00000750 A0[E61D]            <1> 	mov	al, [LVI]
   576 00000753 40                  <1> 	inc	ax
   577 00000754 241F                <1> 	and	al, 1Fh 
   578 00000756 E8F200              <1> 	call	setLastValidIndex
   579                              <1> 	;mov	[LVI], al
   580                              <1> tL1:
   581                              <1> 	; al = next buffer index (not for the buffer being played)
   582 00000759 A801                <1> 	test	al, BIT0
   583 0000075B 7506                <1> 	jnz	short tL2
   584                              <1> 
   585                              <1> 	; 19/11/2023
   586                              <1> 	; load buffer 1
   587                              <1> 	;mov	ax, [WAV_BUFFER1] ; will be played
   588                              <1> 	;call	word [loadfromwavfile]
   589                              <1> 	;jc	short tL3
   590                              <1> 
   591 0000075D C606[E51D]31        <1> 	mov	byte [b_indicator], '1'
   592 00000762 C3                  <1> 	retn
   593                              <1> tL2:	
   594                              <1> 	; 19/11/2023
   595                              <1> 	; load buffer 2
   596                              <1> 	;mov	ax, [WAV_BUFFER2] ; will be played
   597                              <1> 	;call	word [loadfromwavfile]
   598                              <1> 	;jc	short tL3
   599                              <1> 
   600 00000763 C606[E51D]32        <1> 	mov	byte [b_indicator], '2'
   601 00000768 C3                  <1> 	retn
   602                              <1> tL3:
   603 00000769 C606[C51D]FF        <1> 	mov	byte [tloop], -1
   604 0000076E F9                  <1> 	stc
   605 0000076F C3                  <1> 	retn
   606                              <1> 
   607                              <1> 	; 18/11/2023
   608                              <1> tL0:
   609                              <1> 	; al = buffer indicator ('1', '2' or '0' -stop- )
   610 00000770 1E                  <1> 	push	ds
   611                              <1> 	;push	bx 
   612 00000771 BB00B8              <1> 	mov	bx, 0B800h ; video display page segment
   613 00000774 8EDB                <1> 	mov	ds, bx
   614 00000776 29DB                <1> 	sub	bx, bx ; 0
   615 00000778 B44E                <1> 	mov	ah, 4Eh
   616 0000077A 8907                <1> 	mov	[bx], ax ; show current play buffer (1, 2)
   617                              <1> 	;pop	bx
   618 0000077C 1F                  <1> 	pop	ds
   619 0000077D C3                  <1> 	retn
   620                              <1> 
   621                              <1> %endif
   622                              <1> 
   623                              <1> ; 11/11/2023
   624                              <1> ; 10/11/2023
   625                              <1> ; 09/11/2023
   626                              <1> ; 08/11/2023
   627                              <1> ; 07/11/2023
   628                              <1> %if 0	; 18/11/2023
   629                              <1> 
   630                              <1> tuneLoop:
   631                              <1> 	; 11/11/2023
   632                              <1> 	; 10/11/2023
   633                              <1> 	; 09/11/2023
   634                              <1> 	; 08/11/2023
   635                              <1> 	; 06/11/2023
   636                              <1> 	;mov	al, '1'
   637                              <1> 	;call	tL0
   638                              <1> tL1:
   639                              <1> 	; 10/11/2023
   640                              <1> 	;mov	byte [tloop], 1
   641                              <1> 
   642                              <1> 	; 11/11/2023
   643                              <1> 	;call    updateLVI	; set LVI != CIV
   644                              <1> 	;jz	short tL4	
   645                              <1> 
   646                              <1> 	; 11/11/2023
   647                              <1> 	mov	byte [tloop], 1
   648                              <1> 
   649                              <1> 	call    getCurrentIndex
   650                              <1> 
   651                              <1> 	; 10/11/2023
   652                              <1> 	cmp	al, [LVI]
   653                              <1> 	jne	short tL2
   654                              <1> 
   655                              <1> 	test	byte [flags], ENDOFFILE
   656                              <1> 	;jnz	short tL2
   657                              <1> 	jnz	short tL4
   658                              <1> 
   659                              <1> 	dec	ax
   660                              <1> 	and	al, 1Fh 
   661                              <1> 	call	setLastValidIndex	
   662                              <1> 	xchg	al, [LVI]
   663                              <1> tL2:
   664                              <1> 	test	al, BIT0
   665                              <1> 	jz	short tL3
   666                              <1> 
   667                              <1> 	mov	byte [b_indicator], '1'
   668                              <1> 	retn
   669                              <1> tL3:	
   670                              <1> 	mov	byte [b_indicator], '2'
   671                              <1> 	retn
   672                              <1> tL4:
   673                              <1> 	; 11/11/2023
   674                              <1> 	mov	byte [tloop], -1
   675                              <1> 	stc
   676                              <1> 	retn
   677                              <1> 
   678                              <1> 	; 06/11/2023
   679                              <1> tL0:
   680                              <1> 	; 08/11/2023
   681                              <1> 	; 05/11/2023
   682                              <1> 	; 17/02/2017 - Buffer switch test (temporary)
   683                              <1> 	; 06/11/2023
   684                              <1> 	; al = buffer indicator ('1', '2' or '0' -stop- )
   685                              <1> 	push	ds
   686                              <1> 	;push	bx 
   687                              <1> 	mov	bx, 0B800h ; video display page segment
   688                              <1> 	mov	ds, bx
   689                              <1> 	sub	bx, bx ; 0
   690                              <1> 	mov	ah, 4Eh
   691                              <1> 	mov	[bx], ax ; show current play buffer (1, 2)
   692                              <1> 	;pop	bx
   693                              <1> 	pop	ds
   694                              <1> 	retn
   695                              <1> 
   696                              <1> %endif
   697                              <1> 
   698                              <1> ; 08/11/2023
   699                              <1> ; 07/11/2023
   700                              <1> %if 1
   701                              <1> 
   702                              <1> loadFromFile:
   703                              <1> 	; 07/11/2023
   704                              <1> 
   705 0000077E F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
   706                              <1> 					; last of the file?
   707 00000783 7402                <1> 	jz	short lff_0		; no
   708 00000785 F9                  <1> 	stc
   709 00000786 C3                  <1> 	retn
   710                              <1> 
   711                              <1> lff_0:
   712                              <1> 	; 08/11/2023
   713 00000787 89C5                <1> 	mov	bp, ax ; save buffer segment	
   714                              <1> 
   715 00000789 8A0E[E41D]          <1> 	mov	cl, [fbs_shift]   
   716 0000078D 20C9                <1> 	and	cl, cl
   717 0000078F 7470                <1> 	jz	short lff_1 ; stereo, 16 bit	
   718                              <1> 
   719 00000791 BFFFFF              <1> 	mov	di, BUFFERSIZE - 1 ; 65535
   720                              <1> 
   721                              <1> 	; fbs_shift =
   722                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   723                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   724 00000794 D3EF                <1> 	shr	di, cl
   725 00000796 47                  <1> 	inc	di ; 16384 for 8 bit and mono	
   726                              <1> 		   ; 32768 for 8 bit or mono	
   727                              <1> 
   728 00000797 8CC8                <1> 	mov	ax, cs
   729 00000799 BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   730                              <1> 
   731                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   732                              <1> 	; load file into memory
   733 0000079C 89F9                <1>         mov	cx, di                       
   734 0000079E 8B1E[C01D]          <1> 	mov	bx, [filehandle]
   735 000007A2 8ED8                <1> 	mov     ds, ax
   736 000007A4 B43F                <1>        	mov	ah, 3Fh
   737 000007A6 CD21                <1> 	int	21h
   738                              <1> 
   739 000007A8 8CCB                <1> 	mov	bx, cs
   740 000007AA 8EDB                <1> 	mov	ds, bx
   741                              <1> 
   742 000007AC 724A                <1> 	jc	short lff_4 ; error !
   743                              <1> 
   744                              <1> 	; 08/11/2023
   745 000007AE 31D2                <1> 	xor	dx, dx ; 0
   746                              <1> 
   747 000007B0 21C0                <1> 	and	ax, ax
   748 000007B2 7476                <1> 	jz	short lff_3
   749                              <1> 
   750 000007B4 8A1E[E41D]          <1> 	mov	bl, [fbs_shift]
   751                              <1> 
   752 000007B8 06                  <1> 	push	es
   753 000007B9 89D7                <1> 	mov	di, dx ; 0 ; [fbs_off]
   754                              <1> 	;mov	bp, [fbs_seg] ; buffer segment
   755 000007BB 8EC5                <1> 	mov	es, bp
   756 000007BD BE[E81D]            <1> 	mov	si, temp_buffer ; temporary buffer address
   757 000007C0 89C1                <1> 	mov	cx, ax ; byte count
   758 000007C2 803E[E21D]08        <1> 	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   759 000007C7 751B                <1> 	jne	short lff_7 ; 16 bit samples
   760                              <1> 	; 8 bit samples
   761 000007C9 FECB                <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   762 000007CB 740C                <1> 	jz	short lff_6 ; 8 bit, stereo
   763                              <1> lff_5:
   764                              <1> 	; mono & 8 bit
   765 000007CD AC                  <1> 	lodsb
   766 000007CE 2C80                <1> 	sub	al, 80h ; 08/11/2023
   767 000007D0 C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   768 000007D3 AB                  <1> 	stosw	; left channel
   769 000007D4 AB                  <1> 	stosw	; right channel
   770 000007D5 E2F6                <1> 	loop	lff_5
   771 000007D7 EB12                <1> 	jmp	short lff_9	
   772                              <1> lff_6:
   773                              <1> 	; stereo & 8 bit
   774 000007D9 AC                  <1> 	lodsb
   775 000007DA 2C80                <1> 	sub	al, 80h ; 08/11/2023
   776 000007DC C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   777 000007DF AB                  <1> 	stosw
   778 000007E0 E2F7                <1> 	loop	lff_6			
   779 000007E2 EB07                <1> 	jmp	short lff_9
   780                              <1> lff_7:
   781 000007E4 D1E9                <1> 	shr	cx, 1 ; word count
   782                              <1> lff_8:
   783 000007E6 AD                  <1> 	lodsw
   784 000007E7 AB                  <1> 	stosw	; left channel
   785 000007E8 AB                  <1> 	stosw	; right channel
   786 000007E9 E2FB                <1> 	loop	lff_8
   787                              <1> lff_9:
   788 000007EB 07                  <1> 	pop	es
   789 000007EC 09FF                <1> 	or	di, di
   790 000007EE 7442                <1> 	jz	short endLFF ; 64KB ok 
   791                              <1> 	
   792 000007F0 89F8                <1> 	mov	ax, di ; [fbs_off]
   793 000007F2 48                  <1> 	dec	ax
   794 000007F3 B9FFFF              <1> 	mov	cx, BUFFERSIZE - 1 ; 65535
   795 000007F6 EB32                <1> 	jmp	short lff_3
   796                              <1> 
   797                              <1> lff_4:
   798                              <1> 	; 08/11/2023
   799 000007F8 B021                <1> 	mov	al, '!'  ; error
   800 000007FA E873FF              <1> 	call	tL0
   801                              <1> 
   802 000007FD 31C0                <1> 	xor	ax, ax
   803 000007FF EB29                <1> 	jmp	short lff_3
   804                              <1> 	
   805                              <1> lff_1:  
   806                              <1> 	;mov	bp, ax ; save buffer segment
   807 00000801 31D2                <1> 	xor	dx, dx
   808                              <1> 	; load file into memory
   809 00000803 B90080              <1>         mov	cx, (BUFFERSIZE / 2)	; 32k chunk
   810 00000806 8B1E[C01D]          <1> 	mov	bx, [filehandle]
   811 0000080A 8ED8                <1> 	mov     ds, ax
   812 0000080C B43F                <1>        	mov	ah, 3Fh
   813 0000080E CD21                <1> 	int	21h
   814                              <1> 
   815 00000810 8CCF                <1> 	mov	di, cs
   816 00000812 8EDF                <1> 	mov	ds, di
   817                              <1> 
   818                              <1> 	; 07/11/2023
   819 00000814 72E2                <1> 	jc	short lff_4 ; error !
   820                              <1> 	
   821 00000816 39C8                <1> 	cmp	ax, cx
   822 00000818 7510                <1> 	jne	short lff_3
   823                              <1> lff_2:
   824                              <1> 	; 08/11/2023
   825 0000081A 01C2                <1> 	add	dx, ax
   826                              <1> 	;mov	cx, (BUFFERSIZE / 2)	; 32k chunk
   827                              <1> 	;mov	bx, [filehandle]
   828 0000081C 8EDD                <1> 	mov     ds, bp
   829 0000081E B43F                <1>        	mov	ah, 3Fh
   830 00000820 CD21                <1> 	int	21h
   831                              <1> 
   832                              <1> 	;mov	di, cs
   833 00000822 8EDF                <1> 	mov	ds, di
   834                              <1> 
   835 00000824 72D2                <1> 	jc	short lff_4 ; error !
   836                              <1> 
   837 00000826 39C8                <1> 	cmp	ax, cx
   838 00000828 7408                <1> 	je	short endLFF
   839                              <1> lff_3:
   840 0000082A E80600              <1> 	call    padfill			; blank pad the remainder
   841                              <1>         ;clc				; don't exit with CY yet.
   842 0000082D 800E[C21D]01        <1>         or	byte [flags], ENDOFFILE	; end of file flag
   843                              <1> endLFF:
   844 00000832 C3                  <1>         retn
   845                              <1> 
   846                              <1> %endif
   847                              <1> 
   848                              <1> ; entry ds:ax points to last byte in file
   849                              <1> ; cx=target size
   850                              <1> ; note: must do byte size fill
   851                              <1> ; destroys bx, cx
   852                              <1> ;
   853                              <1> padfill:
   854                              <1> 	; 07/11/2023
   855                              <1> 	; 06/11/2023
   856                              <1> 	; 17/02/2017
   857 00000833 06                  <1> 	push	es
   858                              <1>         ;push	di
   859                              <1> 	;mov	di, [fbs_seg]
   860                              <1> 	;mov	es, di
   861 00000834 8EC5                <1>         mov	es, bp
   862 00000836 29C1                <1> 	sub	cx, ax
   863                              <1> 	; 08/11/2023
   864                              <1> 	;mov	di, ax ; (wrong)
   865 00000838 89D7                <1> 	mov	di, dx ; buffer offset
   866 0000083A 01C7                <1> 	add	di, ax       	
   867                              <1> 	; 07/11/2023
   868                              <1> 	;add	di, [fbs_off]
   869 0000083C 30C0                <1>         xor	al, al
   870 0000083E F3AA                <1> 	rep	stosb
   871                              <1> 	;mov	[fbs_off], di
   872                              <1> 	;pop	di
   873 00000840 07                  <1>         pop	es
   874 00000841 C3                  <1> 	retn
   875                              <1> 
   876                              <1> ; returns AL = current index value
   877                              <1> getCurrentIndex:
   878                              <1> 	; 08/11/2023
   879                              <1> 	;push	dx
   880 00000842 8B16[CE1D]          <1> 	mov	dx, [NABMBAR]      		
   881 00000846 83C214              <1> 	add	dx, PO_CIV_REG
   882 00000849 EC                  <1> 	in	al, dx
   883                              <1> 	;pop	dx
   884                              <1> uLVI2:	;	06/11/2023
   885 0000084A C3                  <1> 	retn
   886                              <1> 
   887                              <1> ; examines the CIV and the LVI. When they're the same, we set LVI <> CIV
   888                              <1> ; that way, we never run out of buffers to play
   889                              <1> 
   890                              <1> ; 08/11/2023
   891                              <1> ; 07/11/2023
   892                              <1> %if 0
   893                              <1> updateLVI:
   894                              <1> 	; 06/11/2023
   895                              <1> 	mov	dx, [NABMBAR]      		
   896                              <1> 	add	dx, PO_CIV_REG
   897                              <1> 	; (Current Index Value and Last Valid Index value)
   898                              <1> 	in	ax, dx
   899                              <1> 
   900                              <1> 	cmp	al, ah ; is current index = last index ?
   901                              <1> 	jne	short uLVI2
   902                              <1> 
   903                              <1> 	; 10/11/2023
   904                              <1> 	; 08/11/2023	
   905                              <1> 	call	getCurrentIndex
   906                              <1>  
   907                              <1> 	test	byte [flags], ENDOFFILE
   908                              <1> 	;jnz	short uLVI1
   909                              <1> 	jz	short uLVI0  ; 08/11/2023
   910                              <1> 
   911                              <1> 	; 08/11/2023
   912                              <1> 	push	ax
   913                              <1> 	mov	dx, [NABMBAR]
   914                              <1> 	add	dx, PO_SR_REG  ; PCM out status register
   915                              <1> 	in	ax, dx
   916                              <1> 
   917                              <1> 	;test	al, 2
   918                              <1> 	test	al, 3 ; bit 1 = Current Equals Last Valid (CELV)
   919                              <1> 		      ; (has been processed)
   920                              <1> 		      ; bit 0 = 1 -> DMA Controller Halted (DCH)
   921                              <1> 	pop	ax
   922                              <1> 	jz	short uLVI1
   923                              <1> uLVI3:
   924                              <1> 	xor	ax, ax
   925                              <1> 	; zf = 1
   926                              <1> 	retn
   927                              <1> uLVI0:
   928                              <1>         ; not at the end of the file yet.
   929                              <1> 	dec	al
   930                              <1> 	and	al, 1Fh
   931                              <1> uLVI1:
   932                              <1> 	;call	setLastValidIndex
   933                              <1> ;uLVI2:
   934                              <1> 	;retn
   935                              <1> 
   936                              <1> %endif
   937                              <1> 	
   938                              <1> ;input AL = index # to stop on
   939                              <1> setLastValidIndex:
   940                              <1> 	; 08/11/2023
   941                              <1> 	;push	dx
   942 0000084B 8B16[CE1D]          <1> 	mov	dx, [NABMBAR]
   943 0000084F 83C215              <1> 	add	dx, PO_LVI_REG
   944 00000852 EE                  <1>         out     dx, al
   945                              <1> 	; 18/11/2023
   946 00000853 A2[E61D]            <1> 	mov	[LVI], al
   947                              <1> 	;pop	dx
   948 00000856 C3                  <1> 	retn
   949                              <1> 
   950                              <1> ; checks if either shift key has been pressed. Exits with CY if so.
   951                              <1> ; 
   952                              <1> check4keyboardstop:
   953                              <1> 
   954                              <1> ; 06/11/2023
   955                              <1> %if 1
   956                              <1> 	; 08/11/2023
   957                              <1> 	; 04/11/2023
   958 00000857 B401                <1> 	mov	ah, 1
   959 00000859 CD16                <1> 	int	16h
   960 0000085B F8                  <1> 	clc
   961 0000085C 7405                <1> 	jz	short _cksr
   962 0000085E 30E4                <1> 	xor	ah, ah
   963 00000860 CD16                <1> 	int	16h
   964 00000862 F9                  <1> 	stc
   965                              <1> _cksr:
   966 00000863 C3                  <1> 	retn
   967                              <1> %endif
   968                              <1> 
   969                              <1> ; 06/11/2023
   970                              <1> ; 04/11/2023
   971                              <1> %if 0	
   972                              <1>         push    ds
   973                              <1>         push    0
   974                              <1>         pop     ds		       ; examine BDA for keyboard flags
   975                              <1>         test    byte [417h], (BIT0 | BIT1)
   976                              <1>         pop     ds
   977                              <1>         stc
   978                              <1>         jnz	short _cksr ; 07/11/2023
   979                              <1> 	;jz	short _cksr ; 06/11/2023
   980                              <1>         clc
   981                              <1> _cksr:
   982                              <1>         retn
   983                              <1> %endif
   984                              <1> 
   985                              <1> ; 15/11/2023
   986                              <1> ; 14/11/2023
   987                              <1> ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
   988                              <1> ; --------------------------------------------------------
   989                              <1> 
   990                              <1> ;;Note:	At the end of every buffer load,
   991                              <1> ;;	during buffer switch/swap, there will be discontinuity
   992                              <1> ;;	between the last converted sample and the 1st sample
   993                              <1> ;;	of the next buffer.
   994                              <1> ;;	(like as a dot noises vaguely between normal sound samples)
   995                              <1> ;;	-To avoid this defect, the 1st sample of
   996                              <1> ;;	the next buffer may be read from the wav file but
   997                              <1> ;;	the file pointer would need to be set to 1 sample back
   998                              <1> ;;	again via seek system call. Time comsumption problem! -
   999                              <1> ;;
  1000                              <1> ;;	Erdogan Tan - 15/11/2023
  1001                              <1> ;;
  1002                              <1> ;;	((If entire wav data would be loaded at once.. conversion
  1003                              <1> ;;	defect/noise would disappear.. but for DOS, to keep
  1004                              <1> ;;	64KB buffer limit is important also it is important
  1005                              <1> ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  1006                              <1> ;;	I have tested this program by using 2-30MB wav files.))
  1007                              <1> ;;
  1008                              <1> ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  1009                              <1> ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  1010                              <1> ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  1011                              <1> ;;			Realtek ALC850 codec.
  1012                              <1> ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  1013                              <1> 
  1014                              <1> load_8khz_mono_8_bit:
  1015                              <1> 	; 15/11/2023
  1016                              <1> 	; 14/11/2023
  1017                              <1> 	; 13/11/2023
  1018 00000864 F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1019                              <1> 					; last of the file?
  1020 00000869 7402                <1> 	jz	short lff8m_0		; no
  1021 0000086B F9                  <1> 	stc
  1022 0000086C C3                  <1> 	retn
  1023                              <1> 
  1024                              <1> lff8m_0:
  1025 0000086D 8EC0                <1> 	mov	es, ax ; buffer segment	
  1026 0000086F 31FF                <1> 	xor	di, di
  1027 00000871 BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1028                              <1> 	; ds = cs
  1029                              <1> 
  1030                              <1> 	; load file into memory
  1031 00000874 8B0E[6906]          <1>         mov	cx, [loadsize]
  1032 00000878 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  1033 0000087C B43F                <1>        	mov	ah, 3Fh
  1034 0000087E CD21                <1> 	int	21h
  1035                              <1> 	;jc	short lff8m_5 ; error !
  1036                              <1> 	; 14/11/2023
  1037 00000880 7303                <1> 	jnc	short lff8m_6
  1038 00000882 E98B00              <1> 	jmp	lff8m_5
  1039                              <1> 
  1040                              <1> lff8m_6:
  1041 00000885 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1042 00000887 21C0                <1> 	and	ax, ax
  1043                              <1> 	;jz	short lff8m_3
  1044                              <1> 	; 15/11/2023
  1045 00000889 747E                <1> 	jz	short lff8_eof
  1046                              <1> 
  1047 0000088B 89C1                <1> 	mov	cx, ax		; byte count
  1048                              <1> lff8m_1:
  1049 0000088D AC                  <1> 	lodsb
  1050 0000088E A2[6119]            <1> 	mov	[previous_val], al
  1051 00000891 2C80                <1> 	sub	al, 80h
  1052 00000893 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1053 00000896 AB                  <1> 	stosw		; original sample (left channel)
  1054 00000897 AB                  <1> 	stosw		; original sample (right channel)
  1055                              <1> 	;xor	ax, ax
  1056                              <1> 	; 14/11/2023
  1057 00000898 B080                <1> 	mov	al, 80h
  1058 0000089A 49                  <1> 	dec	cx
  1059 0000089B 7402                <1> 	jz	short lff8m_2
  1060 0000089D 8A04                <1> 	mov	al, [si]
  1061                              <1> lff8m_2:
  1062                              <1> 	;mov	[next_val], ax
  1063 0000089F 88C7                <1> 	mov	bh, al	; [next_val]
  1064 000008A1 8A26[6119]          <1> 	mov	ah, [previous_val]
  1065 000008A5 00E0                <1> 	add	al, ah	; [previous_val]
  1066 000008A7 D0D8                <1> 	rcr	al, 1
  1067 000008A9 88C2                <1> 	mov	dl, al	; this is interpolated middle (3th) sample
  1068 000008AB 00E0                <1> 	add	al, ah	; [previous_val]
  1069 000008AD D0D8                <1> 	rcr	al, 1	
  1070 000008AF 88C3                <1> 	mov	bl, al 	; this is temporary interpolation value	
  1071 000008B1 00E0                <1> 	add	al, ah	; [previous_val]
  1072 000008B3 D0D8                <1> 	rcr	al, 1
  1073 000008B5 2C80                <1> 	sub	al, 80h
  1074 000008B7 C1E008              <1> 	shl	ax, 8	
  1075 000008BA AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1076 000008BB AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1077 000008BC 88D8                <1> 	mov	al, bl
  1078 000008BE 00D0                <1> 	add	al, dl
  1079 000008C0 D0D8                <1> 	rcr	al, 1
  1080 000008C2 2C80                <1> 	sub	al, 80h
  1081 000008C4 C1E008              <1> 	shl	ax, 8
  1082 000008C7 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1083 000008C8 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1084 000008C9 88D0                <1> 	mov	al, dl
  1085 000008CB 2C80                <1> 	sub	al, 80h
  1086 000008CD C1E008              <1> 	shl	ax, 8
  1087 000008D0 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1088 000008D1 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1089                              <1> 	;mov	al, [next_val]
  1090 000008D2 88F8                <1> 	mov	al, bh
  1091 000008D4 00D0                <1> 	add	al, dl
  1092 000008D6 D0D8                <1> 	rcr	al, 1
  1093 000008D8 88C3                <1> 	mov	bl, al	; this is temporary interpolation value
  1094 000008DA 00D0                <1> 	add	al, dl
  1095 000008DC D0D8                <1> 	rcr	al, 1
  1096 000008DE 2C80                <1> 	sub	al, 80h
  1097 000008E0 C1E008              <1> 	shl	ax, 8
  1098 000008E3 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1099 000008E4 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1100                              <1> 	;mov	al, [next_val]
  1101 000008E5 88F8                <1> 	mov	al, bh
  1102 000008E7 00D8                <1> 	add	al, bl
  1103 000008E9 D0D8                <1> 	rcr	al, 1
  1104 000008EB 2C80                <1> 	sub	al, 80h
  1105 000008ED C1E008              <1> 	shl	ax, 8
  1106 000008F0 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1107 000008F1 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1108                              <1> 	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1109 000008F2 09C9                <1> 	or	cx, cx
  1110 000008F4 7597                <1> 	jnz	short lff8m_1
  1111                              <1> 
  1112                              <1> 	; --------------
  1113                              <1> 
  1114                              <1> lff8s_3:
  1115                              <1> lff8m_3:
  1116                              <1> lff8s2_3:
  1117                              <1> lff8m2_3:
  1118                              <1> lff16s_3:
  1119                              <1> lff16m_3:
  1120                              <1> lff16s2_3:
  1121                              <1> lff16m2_3:
  1122                              <1> lff24_3:
  1123                              <1> lff32_3:
  1124                              <1> lff44_3:
  1125                              <1> lff22_3:
  1126                              <1> lff11_3:
  1127 000008F6 8B0E[6B06]          <1> 	mov	cx, [buffersize] ; 16 bit (48 kHZ, stereo) sample size
  1128 000008FA D1E1                <1> 	shl	cx, 1	; byte count
  1129 000008FC 29F9                <1> 	sub	cx, di
  1130 000008FE 7606                <1> 	jna	short lff8m_4
  1131                              <1> 	;inc	cx
  1132 00000900 D1E9                <1> 	shr	cx, 1
  1133 00000902 31C0                <1> 	xor	ax, ax	; fill (remain part of) buffer with zeros	
  1134 00000904 F3AB                <1> 	rep	stosw
  1135                              <1> lff8m_4:
  1136 00000906 0E                  <1> 	push	cs
  1137 00000907 07                  <1> 	pop	es
  1138 00000908 C3                  <1> 	retn
  1139                              <1> 
  1140                              <1> lff8_eof:
  1141                              <1> lff16_eof:
  1142                              <1> lff24_eof:
  1143                              <1> lff32_eof:
  1144                              <1> lff44_eof:
  1145                              <1> lff22_eof:
  1146                              <1> lff11_eof:
  1147                              <1> 	; 15/11/2023
  1148 00000909 C606[C21D]01        <1> 	mov	byte [flags], ENDOFFILE
  1149 0000090E EBE6                <1> 	jmp	short lff8m_3
  1150                              <1> 
  1151                              <1> lff8s_5:
  1152                              <1> lff8m_5:
  1153                              <1> lff8s2_5:
  1154                              <1> lff8m2_5:
  1155                              <1> lff16s_5:
  1156                              <1> lff16m_5:
  1157                              <1> lff16s2_5:
  1158                              <1> lff16m2_5:
  1159                              <1> lff24_5:
  1160                              <1> lff32_5:
  1161                              <1> lff44_5:
  1162                              <1> lff22_5:
  1163                              <1> lff11_5:
  1164 00000910 B021                <1> 	mov	al, '!'  ; error
  1165 00000912 E85BFE              <1> 	call	tL0
  1166                              <1> 	
  1167                              <1> 	;jmp	short lff8m_3
  1168                              <1> 	; 15/11/2023
  1169 00000915 EBF2                <1> 	jmp	lff8_eof
  1170                              <1> 
  1171                              <1> 	; --------------
  1172                              <1> 
  1173                              <1> load_8khz_stereo_8_bit:
  1174                              <1> 	; 15/11/2023
  1175                              <1> 	; 14/11/2023
  1176                              <1> 	; 13/11/2023
  1177 00000917 F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1178                              <1> 					; last of the file?
  1179 0000091C 7402                <1> 	jz	short lff8s_0		; no
  1180 0000091E F9                  <1> 	stc
  1181 0000091F C3                  <1> 	retn
  1182                              <1> 
  1183                              <1> lff8s_0:
  1184 00000920 8EC0                <1> 	mov	es, ax ; buffer segment	
  1185 00000922 31FF                <1> 	xor	di, di
  1186 00000924 BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1187                              <1> 	; ds = cs
  1188                              <1> 
  1189                              <1> 	; load file into memory
  1190 00000927 8B0E[6906]          <1>         mov	cx, [loadsize]
  1191 0000092B 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  1192 0000092F B43F                <1>        	mov	ah, 3Fh
  1193 00000931 CD21                <1> 	int	21h
  1194 00000933 72DB                <1> 	jc	short lff8s_5 ; error !
  1195                              <1> 
  1196 00000935 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1197                              <1> 	
  1198 00000937 D1E8                <1> 	shr	ax, 1
  1199                              <1> 	;;and	ax, ax
  1200                              <1> 	;jz	short lff8s_3
  1201                              <1> 	; 15/11/2023
  1202 00000939 74CE                <1> 	jz	short lff8_eof
  1203                              <1> 
  1204 0000093B 89C1                <1> 	mov	cx, ax		; word count
  1205                              <1> lff8s_1:
  1206 0000093D AC                  <1> 	lodsb
  1207 0000093E A2[6119]            <1> 	mov	[previous_val_l], al
  1208 00000941 2C80                <1> 	sub	al, 80h
  1209 00000943 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1210 00000946 AB                  <1> 	stosw		; original sample (L)
  1211 00000947 AC                  <1> 	lodsb
  1212 00000948 A2[6319]            <1> 	mov	[previous_val_r], al
  1213 0000094B 2C80                <1> 	sub	al, 80h
  1214 0000094D C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1215 00000950 AB                  <1> 	stosw		; original sample (R)
  1216                              <1> 
  1217                              <1> 	;xor	ax, ax
  1218                              <1> 	; 14/11/2023
  1219 00000951 B88080              <1> 	mov	ax, 8080h
  1220 00000954 49                  <1> 	dec	cx
  1221 00000955 7402                <1> 	jz	short lff8s_2
  1222                              <1> 		; convert 8 bit sample to 16 bit sample
  1223 00000957 8B04                <1> 	mov	ax, [si]
  1224                              <1> lff8s_2:
  1225 00000959 A2[6519]            <1> 	mov	[next_val_l], al
  1226 0000095C 8826[6719]          <1> 	mov	[next_val_r], ah
  1227 00000960 8A26[6119]          <1> 	mov	ah, [previous_val_l]
  1228 00000964 00E0                <1> 	add	al, ah
  1229 00000966 D0D8                <1> 	rcr	al, 1
  1230 00000968 88C2                <1> 	mov	dl, al	; this is interpolated middle (3th) sample (L)
  1231 0000096A 00E0                <1> 	add	al, ah
  1232 0000096C D0D8                <1> 	rcr	al, 1	
  1233 0000096E 88C3                <1> 	mov	bl, al	; this is temporary interpolation value (L)
  1234 00000970 00E0                <1> 	add	al, ah
  1235 00000972 D0D8                <1> 	rcr	al, 1
  1236 00000974 2C80                <1> 	sub	al, 80h
  1237 00000976 C1E008              <1> 	shl	ax, 8
  1238 00000979 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1239 0000097A A0[6719]            <1> 	mov	al, [next_val_r]
  1240 0000097D 8A26[6319]          <1> 	mov	ah, [previous_val_r]
  1241 00000981 00E0                <1> 	add	al, ah
  1242 00000983 D0D8                <1> 	rcr	al, 1
  1243 00000985 88C6                <1> 	mov	dh, al	; this is interpolated middle (3th) sample (R)
  1244 00000987 00E0                <1> 	add	al, ah
  1245 00000989 D0D8                <1> 	rcr	al, 1
  1246 0000098B 88C7                <1> 	mov	bh, al	; this is temporary interpolation value (R)
  1247 0000098D 00E0                <1> 	add	al, ah
  1248 0000098F D0D8                <1> 	rcr	al, 1
  1249 00000991 2C80                <1> 	sub	al, 80h
  1250 00000993 C1E008              <1> 	shl	ax, 8
  1251 00000996 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1252 00000997 88D8                <1> 	mov	al, bl
  1253 00000999 00D0                <1> 	add	al, dl
  1254 0000099B D0D8                <1> 	rcr	al, 1
  1255 0000099D 2C80                <1> 	sub	al, 80h
  1256 0000099F C1E008              <1> 	shl	ax, 8
  1257 000009A2 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1258 000009A3 88F8                <1> 	mov	al, bh
  1259 000009A5 00F0                <1> 	add	al, dh
  1260 000009A7 D0D8                <1> 	rcr	al, 1
  1261 000009A9 2C80                <1> 	sub	al, 80h
  1262 000009AB C1E008              <1> 	shl	ax, 8
  1263 000009AE AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1264 000009AF 88D0                <1> 	mov	al, dl
  1265 000009B1 2C80                <1> 	sub	al, 80h
  1266 000009B3 C1E008              <1> 	shl	ax, 8
  1267 000009B6 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1268 000009B7 88F0                <1> 	mov	al, dh
  1269 000009B9 2C80                <1> 	sub	al, 80h
  1270 000009BB C1E008              <1> 	shl	ax, 8
  1271 000009BE AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1272 000009BF A0[6519]            <1> 	mov	al, [next_val_l]
  1273 000009C2 00D0                <1> 	add	al, dl
  1274 000009C4 D0D8                <1> 	rcr	al, 1
  1275 000009C6 88C3                <1> 	mov	bl, al	; this is temporary interpolation value (L)
  1276 000009C8 00D0                <1> 	add	al, dl
  1277 000009CA D0D8                <1> 	rcr	al, 1
  1278 000009CC 2C80                <1> 	sub	al, 80h
  1279 000009CE C1E008              <1> 	shl	ax, 8
  1280 000009D1 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1281 000009D2 A0[6719]            <1> 	mov	al, [next_val_r]
  1282 000009D5 00F0                <1> 	add	al, dh
  1283 000009D7 D0D8                <1> 	rcr	al, 1
  1284 000009D9 88C7                <1> 	mov	bh, al	; this is temporary interpolation value (R)
  1285 000009DB 00F0                <1> 	add	al, dh
  1286 000009DD D0D8                <1> 	rcr	al, 1
  1287 000009DF 2C80                <1> 	sub	al, 80h
  1288 000009E1 C1E008              <1> 	shl	ax, 8
  1289 000009E4 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1290 000009E5 A0[6519]            <1> 	mov	al, [next_val_l]
  1291 000009E8 00D8                <1> 	add	al, bl
  1292 000009EA D0D8                <1> 	rcr	al, 1
  1293 000009EC 2C80                <1> 	sub	al, 80h
  1294 000009EE C1E008              <1> 	shl	ax, 8
  1295 000009F1 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1296 000009F2 A0[6719]            <1> 	mov	al, [next_val_r]
  1297 000009F5 00F8                <1> 	add	al, bh
  1298 000009F7 D0D8                <1> 	rcr	al, 1
  1299 000009F9 2C80                <1> 	sub	al, 80h
  1300 000009FB C1E008              <1> 	shl	ax, 8
  1301 000009FE AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1302                              <1> 	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1303 000009FF E303                <1> 	jcxz	lff8s_6
  1304 00000A01 E939FF              <1> 	jmp	lff8s_1
  1305                              <1> lff8s_6:
  1306 00000A04 E9EFFE              <1> 	jmp	lff8s_3
  1307                              <1> 
  1308                              <1> load_8khz_mono_16_bit:
  1309                              <1> 	; 13/11/2023
  1310 00000A07 F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1311                              <1> 					; last of the file?
  1312 00000A0C 7402                <1> 	jz	short lff8m2_0		; no
  1313 00000A0E F9                  <1> 	stc
  1314 00000A0F C3                  <1> 	retn
  1315                              <1> 
  1316                              <1> lff8m2_0:
  1317 00000A10 8EC0                <1> 	mov	es, ax ; buffer segment	
  1318 00000A12 31FF                <1> 	xor	di, di
  1319 00000A14 BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1320                              <1> 	; ds = cs
  1321                              <1> 
  1322                              <1> 	; load file into memory
  1323 00000A17 8B0E[6906]          <1>         mov	cx, [loadsize]
  1324 00000A1B 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  1325 00000A1F B43F                <1>        	mov	ah, 3Fh
  1326 00000A21 CD21                <1> 	int	21h
  1327 00000A23 7270                <1> 	jc	short lff8m2_7 ; error !
  1328                              <1> 
  1329 00000A25 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1330                              <1> 	
  1331 00000A27 D1E8                <1> 	shr	ax, 1
  1332                              <1> 	;and	ax, ax
  1333 00000A29 7503                <1> 	jnz	short lff8m2_8
  1334                              <1> 	;jmp	lff8m2_3
  1335                              <1> 	; 15/11/2023
  1336 00000A2B E9DBFE              <1> 	jmp	lff8_eof
  1337                              <1> 
  1338                              <1> lff8m2_8:
  1339 00000A2E 89C1                <1> 	mov	cx, ax		; word count
  1340                              <1> lff8m2_1:
  1341 00000A30 AD                  <1> 	lodsw
  1342 00000A31 AB                  <1> 	stosw		; original sample (left channel)
  1343 00000A32 AB                  <1> 	stosw		; original sample (right channel)
  1344 00000A33 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1345 00000A36 A3[6119]            <1> 	mov	[previous_val], ax
  1346 00000A39 31C0                <1> 	xor	ax, ax
  1347 00000A3B 49                  <1> 	dec	cx
  1348 00000A3C 7402                <1> 	jz	short lff8m2_2
  1349 00000A3E 8B04                <1> 	mov	ax, [si]
  1350                              <1> lff8m2_2:
  1351 00000A40 80C480              <1> 	add	ah, 80h ; convert sound level to 0-65535 format
  1352 00000A43 89C5                <1> 	mov	bp, ax	; [next_val]
  1353 00000A45 0306[6119]          <1> 	add	ax, [previous_val]
  1354 00000A49 D1D8                <1> 	rcr	ax, 1
  1355 00000A4B 89C2                <1> 	mov	dx, ax	; this is interpolated middle (3th) sample
  1356 00000A4D 0306[6119]          <1> 	add	ax, [previous_val]
  1357 00000A51 D1D8                <1> 	rcr	ax, 1	; this is temporary interpolation value
  1358 00000A53 89C3                <1> 	mov	bx, ax 		
  1359 00000A55 0306[6119]          <1> 	add	ax, [previous_val]
  1360 00000A59 D1D8                <1> 	rcr	ax, 1
  1361 00000A5B 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1362 00000A5E AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1363 00000A5F AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1364 00000A60 89D8                <1> 	mov	ax, bx
  1365 00000A62 01D0                <1> 	add	ax, dx
  1366 00000A64 D1D8                <1> 	rcr	ax, 1
  1367 00000A66 80EC80              <1> 	sub	ah, 80h
  1368 00000A69 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1369 00000A6A AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1370 00000A6B 89D0                <1> 	mov	ax, dx
  1371 00000A6D 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1372 00000A70 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1373 00000A71 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1374 00000A72 89E8                <1> 	mov	ax, bp
  1375 00000A74 01D0                <1> 	add	ax, dx
  1376 00000A76 D1D8                <1> 	rcr	ax, 1
  1377 00000A78 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value
  1378 00000A7A 01D0                <1> 	add	ax, dx
  1379 00000A7C D1D8                <1> 	rcr	ax, 1
  1380 00000A7E 80EC80              <1> 	sub	ah, 80h
  1381 00000A81 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1382 00000A82 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1383 00000A83 89E8                <1> 	mov	ax, bp
  1384 00000A85 01D8                <1> 	add	ax, bx
  1385 00000A87 D1D8                <1> 	rcr	ax, 1
  1386 00000A89 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1387 00000A8C AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1388 00000A8D AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1389                              <1> 	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1390 00000A8E 09C9                <1> 	or	cx, cx
  1391 00000A90 759E                <1> 	jnz	short lff8m2_1
  1392 00000A92 E961FE              <1> 	jmp	lff8m2_3
  1393                              <1> 
  1394                              <1> lff8m2_7:
  1395                              <1> lff8s2_7:
  1396 00000A95 E978FE              <1> 	jmp	lff8m2_5  ; error
  1397                              <1> 
  1398                              <1> load_8khz_stereo_16_bit:
  1399                              <1> 	; 16/11/2023
  1400                              <1> 	; 15/11/2023
  1401                              <1> 	; 13/11/2023
  1402 00000A98 F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1403                              <1> 					; last of the file?
  1404 00000A9D 7402                <1> 	jz	short lff8s2_0		; no
  1405 00000A9F F9                  <1> 	stc
  1406 00000AA0 C3                  <1> 	retn
  1407                              <1> 
  1408                              <1> lff8s2_0:
  1409 00000AA1 8EC0                <1> 	mov	es, ax ; buffer segment	
  1410 00000AA3 31FF                <1> 	xor	di, di
  1411 00000AA5 BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1412                              <1> 	; ds = cs
  1413                              <1> 
  1414                              <1> 	; load file into memory
  1415 00000AA8 8B0E[6906]          <1>         mov	cx, [loadsize]
  1416 00000AAC 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  1417 00000AB0 B43F                <1>        	mov	ah, 3Fh
  1418 00000AB2 CD21                <1> 	int	21h
  1419 00000AB4 72DF                <1> 	jc	short lff8s2_7 ; error !
  1420                              <1> 
  1421 00000AB6 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1422                              <1> 	
  1423 00000AB8 C1E802              <1> 	shr	ax, 2	; 16/11/2023
  1424                              <1> 	;and	ax, ax
  1425 00000ABB 7503                <1> 	jnz	short lff8s2_8
  1426                              <1> 	;jmp	lff8s2_3
  1427                              <1> 	; 15/11/2023
  1428 00000ABD E949FE              <1> 	jmp	lff8_eof
  1429                              <1> 
  1430                              <1> lff8s2_8:
  1431 00000AC0 89C1                <1> 	mov	cx, ax ; dword count
  1432                              <1> lff8s2_1:
  1433 00000AC2 AD                  <1> 	lodsw
  1434 00000AC3 AB                  <1> 	stosw		; original sample (L)
  1435                              <1> 	; 15/11/2023
  1436 00000AC4 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1437 00000AC7 A3[6119]            <1> 	mov	[previous_val_l], ax
  1438 00000ACA AD                  <1> 	lodsw
  1439 00000ACB AB                  <1> 	stosw		; original sample (R)
  1440 00000ACC 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1441 00000ACF A3[6319]            <1> 	mov	[previous_val_r], ax
  1442 00000AD2 31D2                <1> 	xor	dx, dx
  1443 00000AD4 31C0                <1> 	xor	ax, ax
  1444                              <1> 	; 16/11/2023
  1445 00000AD6 49                  <1> 	dec	cx
  1446 00000AD7 7405                <1> 	jz	short lff8s2_2
  1447 00000AD9 8B04                <1> 	mov	ax, [si]
  1448 00000ADB 8B5402              <1> 	mov	dx, [si+2]
  1449                              <1> lff8s2_2:
  1450 00000ADE 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1451 00000AE1 A3[6519]            <1> 	mov	[next_val_l], ax
  1452 00000AE4 80C680              <1> 	add	dh, 80h	; convert sound level to 0-65535 format
  1453 00000AE7 8916[6719]          <1> 	mov	[next_val_r], dx
  1454 00000AEB 0306[6119]          <1> 	add	ax, [previous_val_l]
  1455 00000AEF D1D8                <1> 	rcr	ax, 1
  1456 00000AF1 89C2                <1> 	mov	dx, ax	; this is interpolated middle (3th) sample (L)
  1457 00000AF3 0306[6119]          <1> 	add	ax, [previous_val_l]
  1458 00000AF7 D1D8                <1> 	rcr	ax, 1	
  1459 00000AF9 89C3                <1> 	mov	bx, ax 	; this is temporary interpolation value (L)
  1460 00000AFB 0306[6119]          <1> 	add	ax, [previous_val_l]
  1461 00000AFF D1D8                <1> 	rcr	ax, 1
  1462 00000B01 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1463 00000B04 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1464 00000B05 A1[6719]            <1> 	mov	ax, [next_val_r]
  1465 00000B08 0306[6319]          <1> 	add	ax, [previous_val_r]
  1466 00000B0C D1D8                <1> 	rcr	ax, 1
  1467 00000B0E 89C5                <1> 	mov	bp, ax	; this is interpolated middle (3th) sample (R)
  1468 00000B10 0306[6319]          <1> 	add	ax, [previous_val_r]
  1469 00000B14 D1D8                <1> 	rcr	ax, 1
  1470 00000B16 50                  <1> 	push	ax ; *	; this is temporary interpolation value (R)
  1471 00000B17 0306[6319]          <1> 	add	ax, [previous_val_r]
  1472 00000B1B D1D8                <1> 	rcr	ax, 1
  1473 00000B1D 80EC80              <1> 	sub	ah, 80h
  1474 00000B20 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1475 00000B21 89D8                <1> 	mov	ax, bx
  1476 00000B23 01D0                <1> 	add	ax, dx
  1477 00000B25 D1D8                <1> 	rcr	ax, 1
  1478 00000B27 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1479 00000B2A AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1480 00000B2B 58                  <1> 	pop	ax ; *
  1481 00000B2C 01E8                <1> 	add	ax, bp
  1482 00000B2E D1D8                <1> 	rcr	ax, 1
  1483 00000B30 80EC80              <1> 	sub	ah, 80h
  1484 00000B33 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1485 00000B34 89D0                <1> 	mov	ax, dx
  1486 00000B36 80EC80              <1> 	sub	ah, 80h
  1487 00000B39 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1488 00000B3A 89E8                <1> 	mov	ax, bp
  1489 00000B3C 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1490 00000B3F AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1491 00000B40 A1[6519]            <1> 	mov	ax, [next_val_l]
  1492 00000B43 01D0                <1> 	add	ax, dx
  1493 00000B45 D1D8                <1> 	rcr	ax, 1
  1494 00000B47 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value (L)
  1495 00000B49 01D0                <1> 	add	ax, dx
  1496 00000B4B D1D8                <1> 	rcr	ax, 1
  1497 00000B4D 80EC80              <1> 	sub	ah, 80h
  1498 00000B50 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1499 00000B51 A1[6719]            <1> 	mov	ax, [next_val_r]
  1500 00000B54 01E8                <1> 	add	ax, bp
  1501 00000B56 D1D8                <1> 	rcr	ax, 1
  1502 00000B58 50                  <1> 	push	ax ; ** ; this is temporary interpolation value (R)
  1503 00000B59 01E8                <1> 	add	ax, bp
  1504 00000B5B D1D8                <1> 	rcr	ax, 1
  1505 00000B5D 80EC80              <1> 	sub	ah, 80h
  1506 00000B60 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1507 00000B61 A1[6519]            <1> 	mov	ax, [next_val_l]
  1508 00000B64 01D8                <1> 	add	ax, bx
  1509 00000B66 D1D8                <1> 	rcr	ax, 1
  1510 00000B68 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1511 00000B6B AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1512 00000B6C 58                  <1> 	pop	ax ; **
  1513 00000B6D 0306[6719]          <1> 	add	ax, [next_val_r]
  1514 00000B71 D1D8                <1> 	rcr	ax, 1
  1515 00000B73 80EC80              <1> 	sub	ah, 80h
  1516 00000B76 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1517                              <1> 	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1518 00000B77 E303                <1> 	jcxz	lff8_s2_9
  1519 00000B79 E946FF              <1> 	jmp	lff8s2_1
  1520                              <1> lff8_s2_9:
  1521 00000B7C E977FD              <1> 	jmp	lff8s2_3
  1522                              <1> 
  1523                              <1> ; .....................
  1524                              <1> 
  1525                              <1> load_16khz_mono_8_bit:
  1526                              <1> 	; 14/11/2023
  1527                              <1> 	; 13/11/2023
  1528 00000B7F F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1529                              <1> 					; last of the file?
  1530 00000B84 7402                <1> 	jz	short lff16m_0		; no
  1531 00000B86 F9                  <1> 	stc
  1532 00000B87 C3                  <1> 	retn
  1533                              <1> 
  1534                              <1> lff16m_0:
  1535 00000B88 8EC0                <1> 	mov	es, ax ; buffer segment	
  1536 00000B8A 31FF                <1> 	xor	di, di
  1537 00000B8C BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1538                              <1> 	; ds = cs
  1539                              <1> 
  1540                              <1> 	; load file into memory
  1541 00000B8F 8B0E[6906]          <1>         mov	cx, [loadsize]
  1542 00000B93 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  1543 00000B97 B43F                <1>        	mov	ah, 3Fh
  1544 00000B99 CD21                <1> 	int	21h
  1545 00000B9B 7243                <1> 	jc	short lff16m_7 ; error !
  1546                              <1> 
  1547 00000B9D 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1548                              <1> 	
  1549 00000B9F 21C0                <1> 	and	ax, ax
  1550 00000BA1 7503                <1> 	jnz	short lff16m_8
  1551                              <1> 	;jmp	lff16m_3
  1552                              <1> 	; 15/11/2023
  1553 00000BA3 E963FD              <1> 	jmp	lff16_eof
  1554                              <1> 
  1555                              <1> lff16m_8:
  1556 00000BA6 89C1                <1> 	mov	cx, ax		; byte count
  1557                              <1> lff16m_1:
  1558 00000BA8 AC                  <1> 	lodsb
  1559                              <1> 	;mov	[previous_val], al
  1560 00000BA9 88C3                <1> 	mov	bl, al
  1561 00000BAB 2C80                <1> 	sub	al, 80h
  1562 00000BAD C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1563 00000BB0 AB                  <1> 	stosw		; original sample (left channel)
  1564 00000BB1 AB                  <1> 	stosw		; original sample (right channel)
  1565                              <1> 	;xor	ax, ax
  1566                              <1> 	; 14/11/22023
  1567 00000BB2 B080                <1> 	mov	al, 80h
  1568 00000BB4 49                  <1> 	dec	cx
  1569 00000BB5 7402                <1> 	jz	short lff16m_2
  1570 00000BB7 8A04                <1> 	mov	al, [si]
  1571                              <1> lff16m_2:
  1572                              <1> 	;mov	[next_val], al
  1573 00000BB9 88C7                <1> 	mov	bh, al
  1574                              <1> 	;add	al, [previous_val]
  1575 00000BBB 00D8                <1> 	add	al, bl
  1576 00000BBD D0D8                <1> 	rcr	al, 1
  1577 00000BBF 88C2                <1> 	mov	dl, al	; this is interpolated middle (temp) sample
  1578                              <1> 	;add	al, [previous_val]
  1579 00000BC1 00D8                <1> 	add	al, bl
  1580 00000BC3 D0D8                <1> 	rcr	al, 1
  1581 00000BC5 2C80                <1> 	sub	al, 80h
  1582 00000BC7 C1E008              <1> 	shl	ax, 8
  1583 00000BCA AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1584 00000BCB AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1585                              <1> 	;mov	al, [next_val]
  1586 00000BCC 88F8                <1> 	mov	al, bh
  1587 00000BCE 00D0                <1> 	add	al, dl
  1588 00000BD0 D0D8                <1> 	rcr	al, 1
  1589 00000BD2 2C80                <1> 	sub	al, 80h
  1590 00000BD4 C1E008              <1> 	shl	ax, 8
  1591 00000BD7 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1592 00000BD8 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1593                              <1> 	
  1594                              <1> 	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1595 00000BD9 09C9                <1> 	or	cx, cx
  1596 00000BDB 75CB                <1> 	jnz	short lff16m_1
  1597 00000BDD E916FD              <1> 	jmp	lff16m_3
  1598                              <1> 
  1599                              <1> lff16m_7:
  1600                              <1> lff16s_7:
  1601 00000BE0 E92DFD              <1> 	jmp	lff16m_5  ; error
  1602                              <1> 
  1603                              <1> load_16khz_stereo_8_bit:
  1604                              <1> 	; 14/11/2023
  1605                              <1> 	; 13/11/2023
  1606 00000BE3 F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1607                              <1> 					; last of the file?
  1608 00000BE8 7402                <1> 	jz	short lff16s_0		; no
  1609 00000BEA F9                  <1> 	stc
  1610 00000BEB C3                  <1> 	retn
  1611                              <1> 
  1612                              <1> lff16s_0:
  1613 00000BEC 8EC0                <1> 	mov	es, ax ; buffer segment	
  1614 00000BEE 31FF                <1> 	xor	di, di
  1615 00000BF0 BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1616                              <1> 	; ds = cs
  1617                              <1> 
  1618                              <1> 	; load file into memory
  1619 00000BF3 8B0E[6906]          <1>         mov	cx, [loadsize]
  1620 00000BF7 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  1621 00000BFB B43F                <1>        	mov	ah, 3Fh
  1622 00000BFD CD21                <1> 	int	21h
  1623 00000BFF 72DF                <1> 	jc	short lff16s_7 ; error !
  1624                              <1> 
  1625 00000C01 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1626                              <1> 	
  1627 00000C03 D1E8                <1> 	shr	ax, 1
  1628                              <1> 	;and	ax, ax
  1629 00000C05 7503                <1> 	jnz	short lff16s_8
  1630                              <1> 	;jmp	lff16s_3
  1631                              <1> 	; 15/11/2023
  1632 00000C07 E9FFFC              <1> 	jmp	lff16_eof
  1633                              <1> 
  1634                              <1> lff16s_8:
  1635 00000C0A 89C1                <1> 	mov	cx, ax		; word count
  1636                              <1> lff16s_1:
  1637 00000C0C AC                  <1> 	lodsb
  1638 00000C0D A2[6119]            <1> 	mov	[previous_val_l], al
  1639 00000C10 2C80                <1> 	sub	al, 80h
  1640 00000C12 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1641 00000C15 AB                  <1> 	stosw		; original sample (L)
  1642 00000C16 AC                  <1> 	lodsb
  1643 00000C17 A2[6319]            <1> 	mov	[previous_val_r], al
  1644 00000C1A 2C80                <1> 	sub	al, 80h
  1645 00000C1C C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1646 00000C1F AB                  <1> 	stosw		; original sample (R)
  1647                              <1> 
  1648                              <1> 	;xor	ax, ax
  1649                              <1> 	; 14/11/2023
  1650 00000C20 B88080              <1> 	mov	ax, 8080h
  1651 00000C23 49                  <1> 	dec	cx
  1652 00000C24 7402                <1> 	jz	short lff16s_2
  1653                              <1> 		; convert 8 bit sample to 16 bit sample
  1654 00000C26 8B04                <1> 	mov	ax, [si]
  1655                              <1> lff16s_2:
  1656                              <1> 	;mov	[next_val_l], al
  1657                              <1> 	;mov	[next_val_r], ah
  1658 00000C28 89C3                <1> 	mov	bx, ax
  1659 00000C2A 0206[6119]          <1> 	add	al, [previous_val_l]
  1660 00000C2E D0D8                <1> 	rcr	al, 1
  1661 00000C30 88C2                <1> 	mov	dl, al	; this is temporary interpolation value (L)
  1662 00000C32 0206[6119]          <1> 	add	al, [previous_val_l]
  1663 00000C36 D0D8                <1> 	rcr	al, 1
  1664 00000C38 2C80                <1> 	sub	al, 80h
  1665 00000C3A C1E008              <1> 	shl	ax, 8
  1666 00000C3D AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1667 00000C3E 88F8                <1> 	mov	al, bh	; [next_val_r]
  1668 00000C40 0206[6319]          <1> 	add	al, [previous_val_r]
  1669 00000C44 D0D8                <1> 	rcr	al, 1
  1670 00000C46 88C6                <1> 	mov	dh, al	; this is temporary interpolation value (R)
  1671 00000C48 0206[6319]          <1> 	add	al, [previous_val_r]
  1672 00000C4C D0D8                <1> 	rcr	al, 1
  1673 00000C4E 2C80                <1> 	sub	al, 80h
  1674 00000C50 C1E008              <1> 	shl	ax, 8
  1675 00000C53 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1676 00000C54 88D0                <1> 	mov	al, dl
  1677 00000C56 00D8                <1> 	add	al, bl	; [next_val_l]
  1678 00000C58 D0D8                <1> 	rcr	al, 1
  1679 00000C5A 2C80                <1> 	sub	al, 80h
  1680 00000C5C C1E008              <1> 	shl	ax, 8
  1681 00000C5F AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1682 00000C60 88F0                <1> 	mov	al, dh
  1683 00000C62 00F8                <1> 	add	al, bh	; [next_val_r]
  1684 00000C64 D0D8                <1> 	rcr	al, 1
  1685 00000C66 2C80                <1> 	sub	al, 80h
  1686 00000C68 C1E008              <1> 	shl	ax, 8
  1687 00000C6B AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1688                              <1> 	
  1689                              <1> 	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1690 00000C6C 09C9                <1> 	or	cx, cx
  1691 00000C6E 759C                <1> 	jnz	short lff16s_1
  1692 00000C70 E983FC              <1> 	jmp	lff16s_3
  1693                              <1> 
  1694                              <1> load_16khz_mono_16_bit:
  1695                              <1> 	; 15/11/2023
  1696                              <1> 	; 13/11/2023
  1697 00000C73 F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1698                              <1> 					; last of the file?
  1699 00000C78 7402                <1> 	jz	short lff16m2_0		; no
  1700 00000C7A F9                  <1> 	stc
  1701 00000C7B C3                  <1> 	retn
  1702                              <1> 
  1703                              <1> lff16m2_0:
  1704 00000C7C 8EC0                <1> 	mov	es, ax ; buffer segment	
  1705 00000C7E 31FF                <1> 	xor	di, di
  1706 00000C80 BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1707                              <1> 	; ds = cs
  1708                              <1> 
  1709                              <1> 	; load file into memory
  1710 00000C83 8B0E[6906]          <1>         mov	cx, [loadsize]
  1711 00000C87 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  1712 00000C8B B43F                <1>        	mov	ah, 3Fh
  1713 00000C8D CD21                <1> 	int	21h
  1714 00000C8F 7240                <1> 	jc	short lff16m2_7 ; error !
  1715                              <1> 
  1716 00000C91 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1717                              <1> 	
  1718 00000C93 D1E8                <1> 	shr	ax, 1
  1719                              <1> 	;and	ax, ax
  1720 00000C95 7503                <1> 	jnz	short lff16m2_8
  1721                              <1> 	;jmp	lff16m2_3
  1722                              <1> 	; 15/11/2023
  1723 00000C97 E96FFC              <1> 	jmp	lff16_eof
  1724                              <1> 
  1725                              <1> lff16m2_8:
  1726 00000C9A 89C1                <1> 	mov	cx, ax	; word count
  1727                              <1> lff16m2_1:
  1728 00000C9C AD                  <1> 	lodsw
  1729 00000C9D AB                  <1> 	stosw		; original sample (left channel)
  1730 00000C9E AB                  <1> 	stosw		; original sample (right channel)
  1731 00000C9F 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  1732                              <1> 	;mov	[previous_val], ax
  1733 00000CA2 89C3                <1> 	mov	bx, ax	
  1734 00000CA4 31C0                <1> 	xor	ax, ax
  1735 00000CA6 49                  <1> 	dec	cx
  1736 00000CA7 7402                <1> 	jz	short lff16m2_2
  1737 00000CA9 8B04                <1> 	mov	ax, [si]
  1738                              <1> lff16m2_2:
  1739 00000CAB 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  1740 00000CAE 89C5                <1> 	mov	bp, ax	; [next_val]
  1741                              <1> 	;add	ax, [previous_val]
  1742 00000CB0 01D8                <1> 	add	ax, bx
  1743 00000CB2 D1D8                <1> 	rcr	ax, 1
  1744 00000CB4 89C2                <1> 	mov	dx, ax	; this is temporary interpolation value
  1745                              <1> 	;add	ax, [previous_val]
  1746 00000CB6 01D8                <1> 	add	ax, bx
  1747 00000CB8 D1D8                <1> 	rcr	ax, 1
  1748 00000CBA 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1749 00000CBD AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1750 00000CBE AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1751 00000CBF 89E8                <1> 	mov	ax, bp 
  1752 00000CC1 01D0                <1> 	add	ax, dx
  1753 00000CC3 D1D8                <1> 	rcr	ax, 1
  1754 00000CC5 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1755 00000CC8 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1756 00000CC9 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1757                              <1> 	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1758 00000CCA 09C9                <1> 	or	cx, cx
  1759 00000CCC 75CE                <1> 	jnz	short lff16m2_1
  1760 00000CCE E925FC              <1> 	jmp	lff16m2_3
  1761                              <1> 
  1762                              <1> lff16m2_7:
  1763                              <1> lff16s2_7:
  1764 00000CD1 E93CFC              <1> 	jmp	lff16m2_5  ; error
  1765                              <1> 
  1766                              <1> load_16khz_stereo_16_bit:
  1767                              <1> 	; 16/11/2023
  1768                              <1> 	; 15/11/2023
  1769                              <1> 	; 13/11/2023
  1770 00000CD4 F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1771                              <1> 					; last of the file?
  1772 00000CD9 7402                <1> 	jz	short lff16s2_0		; no
  1773 00000CDB F9                  <1> 	stc
  1774 00000CDC C3                  <1> 	retn
  1775                              <1> 
  1776                              <1> lff16s2_0:
  1777 00000CDD 8EC0                <1> 	mov	es, ax ; buffer segment	
  1778 00000CDF 31FF                <1> 	xor	di, di
  1779 00000CE1 BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1780                              <1> 	; ds = cs
  1781                              <1> 
  1782                              <1> 	; load file into memory
  1783 00000CE4 8B0E[6906]          <1>         mov	cx, [loadsize]
  1784 00000CE8 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  1785 00000CEC B43F                <1>        	mov	ah, 3Fh
  1786 00000CEE CD21                <1> 	int	21h
  1787 00000CF0 72DF                <1> 	jc	short lff16s2_7 ; error !
  1788                              <1> 
  1789 00000CF2 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1790                              <1> 	
  1791                              <1> 	;shr	ax, 1
  1792 00000CF4 C1E802              <1> 	shr	ax, 2	; 16/11/2023
  1793                              <1> 	;and	ax, ax
  1794 00000CF7 7503                <1> 	jnz	short lff16s2_8
  1795                              <1> 	;jmp	lff16s2_3
  1796                              <1> 	; 15/11/2023
  1797 00000CF9 E90DFC              <1> 	jmp	lff16_eof
  1798                              <1> 
  1799                              <1> lff16s2_8:
  1800 00000CFC 89C1                <1> 	mov	cx, ax		; dword count
  1801                              <1> lff16s2_1:
  1802 00000CFE AD                  <1> 	lodsw
  1803 00000CFF AB                  <1> 	stosw		; original sample (L)
  1804 00000D00 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  1805 00000D03 A3[6119]            <1> 	mov	[previous_val_l], ax
  1806 00000D06 AD                  <1> 	lodsw
  1807 00000D07 AB                  <1> 	stosw		; original sample (R)
  1808 00000D08 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  1809 00000D0B A3[6319]            <1> 	mov	[previous_val_r], ax
  1810 00000D0E 31D2                <1> 	xor	dx, dx
  1811 00000D10 31C0                <1> 	xor	ax, ax
  1812                              <1> 	; 16/11/2023
  1813 00000D12 49                  <1> 	dec	cx
  1814 00000D13 7405                <1> 	jz	short lff16s2_2
  1815 00000D15 8B04                <1> 	mov	ax, [si]
  1816 00000D17 8B5402              <1> 	mov	dx, [si+2]
  1817                              <1> lff16s2_2:
  1818 00000D1A 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  1819                              <1> 	;mov	[next_val_l], ax
  1820 00000D1D 89C5                <1> 	mov	bp, ax
  1821 00000D1F 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format 
  1822 00000D22 8916[6719]          <1> 	mov	[next_val_r], dx
  1823 00000D26 0306[6119]          <1> 	add	ax, [previous_val_l]
  1824 00000D2A D1D8                <1> 	rcr	ax, 1
  1825 00000D2C 89C2                <1> 	mov	dx, ax	; this is temporary interpolation value (L)
  1826 00000D2E 0306[6119]          <1> 	add	ax, [previous_val_l]
  1827 00000D32 D1D8                <1> 	rcr	ax, 1
  1828 00000D34 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  1829 00000D37 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1830 00000D38 A1[6719]            <1> 	mov	ax, [next_val_r]
  1831 00000D3B 0306[6319]          <1> 	add	ax, [previous_val_r]
  1832 00000D3F D1D8                <1> 	rcr	ax, 1
  1833 00000D41 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value (R)
  1834 00000D43 0306[6319]          <1> 	add	ax, [previous_val_r]
  1835 00000D47 D1D8                <1> 	rcr	ax, 1
  1836 00000D49 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1837 00000D4C AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1838                              <1> 	;mov	ax, [next_val_l]
  1839 00000D4D 89E8                <1> 	mov	ax, bp
  1840 00000D4F 01D0                <1> 	add	ax, dx
  1841 00000D51 D1D8                <1> 	rcr	ax, 1
  1842 00000D53 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1843 00000D56 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1844 00000D57 A1[6719]            <1> 	mov	ax, [next_val_r]
  1845 00000D5A 01D8                <1> 	add	ax, bx
  1846 00000D5C D1D8                <1> 	rcr	ax, 1
  1847 00000D5E 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1848 00000D61 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1849                              <1> 	
  1850                              <1> 	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1851 00000D62 09C9                <1> 	or	cx, cx
  1852 00000D64 7598                <1> 	jnz	short lff16s2_1
  1853 00000D66 E98DFB              <1> 	jmp	lff16s2_3
  1854                              <1> 
  1855                              <1> ; .....................
  1856                              <1> 
  1857                              <1> load_24khz_mono_8_bit:
  1858                              <1> 	; 15/11/2023
  1859 00000D69 F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1860                              <1> 					; last of the file?
  1861 00000D6E 7402                <1> 	jz	short lff24m_0		; no
  1862 00000D70 F9                  <1> 	stc
  1863 00000D71 C3                  <1> 	retn
  1864                              <1> 
  1865                              <1> lff24m_0:
  1866 00000D72 8EC0                <1> 	mov	es, ax ; buffer segment	
  1867 00000D74 31FF                <1> 	xor	di, di
  1868 00000D76 BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1869                              <1> 	; ds = cs
  1870                              <1> 
  1871                              <1> 	; load file into memory
  1872 00000D79 8B0E[6906]          <1>         mov	cx, [loadsize]
  1873 00000D7D 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  1874 00000D81 B43F                <1>        	mov	ah, 3Fh
  1875 00000D83 CD21                <1> 	int	21h
  1876 00000D85 722E                <1> 	jc	short lff24m_7 ; error !
  1877                              <1> 
  1878 00000D87 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1879                              <1> 	
  1880 00000D89 21C0                <1> 	and	ax, ax
  1881 00000D8B 7503                <1> 	jnz	short lff24m_8
  1882 00000D8D E979FB              <1> 	jmp	lff24_eof
  1883                              <1> 
  1884                              <1> lff24m_8:
  1885 00000D90 89C1                <1> 	mov	cx, ax		; byte count
  1886                              <1> lff24m_1:
  1887 00000D92 AC                  <1> 	lodsb
  1888                              <1> 	;mov	[previous_val], al
  1889 00000D93 88C3                <1> 	mov	bl, al
  1890 00000D95 2C80                <1> 	sub	al, 80h
  1891 00000D97 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1892 00000D9A AB                  <1> 	stosw		; original sample (left channel)
  1893 00000D9B AB                  <1> 	stosw		; original sample (right channel)
  1894                              <1> 	;xor	ax, ax
  1895 00000D9C B080                <1> 	mov	al, 80h
  1896 00000D9E 49                  <1> 	dec	cx
  1897 00000D9F 7402                <1> 	jz	short lff24m_2
  1898 00000DA1 8A04                <1> 	mov	al, [si]
  1899                              <1> lff24m_2:
  1900                              <1> 	;;mov	[next_val], al
  1901                              <1> 	;mov	bh, al
  1902                              <1> 	;add	al, [previous_val]
  1903 00000DA3 00D8                <1> 	add	al, bl
  1904 00000DA5 D0D8                <1> 	rcr	al, 1
  1905 00000DA7 2C80                <1> 	sub	al, 80h
  1906 00000DA9 C1E008              <1> 	shl	ax, 8
  1907 00000DAC AB                  <1> 	stosw		; this is interpolated sample (L)
  1908 00000DAD AB                  <1> 	stosw		; this is interpolated sample (R)
  1909                              <1> 	
  1910                              <1> 	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1911 00000DAE 09C9                <1> 	or	cx, cx
  1912 00000DB0 75E0                <1> 	jnz	short lff24m_1
  1913 00000DB2 E941FB              <1> 	jmp	lff24_3
  1914                              <1> 
  1915                              <1> lff24m_7:
  1916                              <1> lff24s_7:
  1917 00000DB5 E958FB              <1> 	jmp	lff24_5  ; error
  1918                              <1> 
  1919                              <1> load_24khz_stereo_8_bit:
  1920                              <1> 	; 15/11/2023
  1921 00000DB8 F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1922                              <1> 					; last of the file?
  1923 00000DBD 7402                <1> 	jz	short lff24s_0		; no
  1924 00000DBF F9                  <1> 	stc
  1925 00000DC0 C3                  <1> 	retn
  1926                              <1> 
  1927                              <1> lff24s_0:
  1928 00000DC1 8EC0                <1> 	mov	es, ax ; buffer segment	
  1929 00000DC3 31FF                <1> 	xor	di, di
  1930 00000DC5 BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1931                              <1> 	; ds = cs
  1932                              <1> 
  1933                              <1> 	; load file into memory
  1934 00000DC8 8B0E[6906]          <1>         mov	cx, [loadsize]
  1935 00000DCC 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  1936 00000DD0 B43F                <1>        	mov	ah, 3Fh
  1937 00000DD2 CD21                <1> 	int	21h
  1938 00000DD4 72DF                <1> 	jc	short lff24s_7 ; error !
  1939                              <1> 
  1940 00000DD6 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1941                              <1> 	
  1942 00000DD8 D1E8                <1> 	shr	ax, 1
  1943                              <1> 	;and	ax, ax
  1944 00000DDA 7503                <1> 	jnz	short lff24s_8
  1945 00000DDC E92AFB              <1> 	jmp	lff24_eof
  1946                              <1> 
  1947                              <1> lff24s_8:
  1948 00000DDF 89C1                <1> 	mov	cx, ax		; word count
  1949                              <1> lff24s_1:
  1950 00000DE1 AC                  <1> 	lodsb
  1951 00000DE2 A2[6119]            <1> 	mov	[previous_val_l], al
  1952 00000DE5 2C80                <1> 	sub	al, 80h
  1953 00000DE7 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1954 00000DEA AB                  <1> 	stosw		; original sample (L)
  1955 00000DEB AC                  <1> 	lodsb
  1956 00000DEC A2[6319]            <1> 	mov	[previous_val_r], al
  1957 00000DEF 2C80                <1> 	sub	al, 80h
  1958 00000DF1 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1959 00000DF4 AB                  <1> 	stosw		; original sample (R)
  1960                              <1> 
  1961                              <1> 	;xor	ax, ax
  1962 00000DF5 B88080              <1> 	mov	ax, 8080h
  1963 00000DF8 49                  <1> 	dec	cx
  1964 00000DF9 7402                <1> 	jz	short lff24s_2
  1965                              <1> 		; convert 8 bit sample to 16 bit sample
  1966 00000DFB 8B04                <1> 	mov	ax, [si]
  1967                              <1> lff24s_2:
  1968                              <1> 	;;mov	[next_val_l], al
  1969                              <1> 	;;mov	[next_val_r], ah
  1970                              <1> 	;mov	bx, ax
  1971 00000DFD 88E7                <1> 	mov	bh, ah
  1972 00000DFF 0206[6119]          <1> 	add	al, [previous_val_l]
  1973 00000E03 D0D8                <1> 	rcr	al, 1
  1974                              <1> 	;mov	dl, al
  1975 00000E05 2C80                <1> 	sub	al, 80h
  1976 00000E07 C1E008              <1> 	shl	ax, 8
  1977 00000E0A AB                  <1> 	stosw		; this is interpolated sample (L)
  1978 00000E0B 88F8                <1> 	mov	al, bh	; [next_val_r]
  1979 00000E0D 0206[6319]          <1> 	add	al, [previous_val_r]
  1980 00000E11 D0D8                <1> 	rcr	al, 1
  1981                              <1> 	;mov	dh, al
  1982 00000E13 2C80                <1> 	sub	al, 80h
  1983 00000E15 C1E008              <1> 	shl	ax, 8
  1984 00000E18 AB                  <1> 	stosw		; this is interpolated sample (R)
  1985                              <1> 		
  1986                              <1> 	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1987 00000E19 09C9                <1> 	or	cx, cx
  1988 00000E1B 75C4                <1> 	jnz	short lff24s_1
  1989 00000E1D E9D6FA              <1> 	jmp	lff24_3
  1990                              <1> 
  1991                              <1> load_24khz_mono_16_bit:
  1992                              <1> 	; 15/11/2023
  1993 00000E20 F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1994                              <1> 					; last of the file?
  1995 00000E25 7402                <1> 	jz	short lff24m2_0		; no
  1996 00000E27 F9                  <1> 	stc
  1997 00000E28 C3                  <1> 	retn
  1998                              <1> 
  1999                              <1> lff24m2_0:
  2000 00000E29 8EC0                <1> 	mov	es, ax ; buffer segment	
  2001 00000E2B 31FF                <1> 	xor	di, di
  2002 00000E2D BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2003                              <1> 	; ds = cs
  2004                              <1> 
  2005                              <1> 	; load file into memory
  2006 00000E30 8B0E[6906]          <1>         mov	cx, [loadsize]
  2007 00000E34 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  2008 00000E38 B43F                <1>        	mov	ah, 3Fh
  2009 00000E3A CD21                <1> 	int	21h
  2010 00000E3C 7228                <1> 	jc	short lff24m2_7 ; error !
  2011                              <1> 
  2012 00000E3E 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2013                              <1> 	
  2014 00000E40 D1E8                <1> 	shr	ax, 1
  2015                              <1> 	;and	ax, ax
  2016 00000E42 7503                <1> 	jnz	short lff24m2_8
  2017 00000E44 E9C2FA              <1> 	jmp	lff24_eof
  2018                              <1> 
  2019                              <1> lff24m2_8:
  2020 00000E47 89C1                <1> 	mov	cx, ax	; word count
  2021                              <1> lff24m2_1:
  2022 00000E49 AD                  <1> 	lodsw
  2023 00000E4A AB                  <1> 	stosw		; original sample (left channel)
  2024 00000E4B AB                  <1> 	stosw		; original sample (right channel)
  2025 00000E4C 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  2026                              <1> 	;mov	[previous_val], ax
  2027                              <1> 	;mov	bx, ax	
  2028                              <1> 	;xor	ax, ax
  2029 00000E4F 31DB                <1> 	xor	bx, bx
  2030 00000E51 49                  <1> 	dec	cx
  2031 00000E52 7402                <1> 	jz	short lff24m2_2
  2032                              <1> 	;mov	ax, [si
  2033 00000E54 8B1C                <1> 	mov	bx, [si]
  2034                              <1> lff24m2_2:
  2035                              <1> 	;add	ah, 80h ; convert sound level 0 to 65535 format
  2036                              <1> 	;mov	bp, ax	; [next_val]
  2037                              <1> 	;add	ax, [previous_val]
  2038                              <1> 	; ax = [previous_val]
  2039                              <1> 	; bx = [next_val]
  2040 00000E56 01D8                <1> 	add	ax, bx
  2041 00000E58 D1D8                <1> 	rcr	ax, 1
  2042 00000E5A 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2043 00000E5D AB                  <1> 	stosw		; this is interpolated sample (L)
  2044 00000E5E AB                  <1> 	stosw		; this is interpolated sample (R)
  2045                              <1> 	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2046 00000E5F 09C9                <1> 	or	cx, cx
  2047 00000E61 75E6                <1> 	jnz	short lff24m2_1
  2048 00000E63 E990FA              <1> 	jmp	lff24_3
  2049                              <1> 
  2050                              <1> lff24m2_7:
  2051                              <1> lff24s2_7:
  2052 00000E66 E9A7FA              <1> 	jmp	lff24_5  ; error
  2053                              <1> 
  2054                              <1> load_24khz_stereo_16_bit:
  2055                              <1> 	; 16/11/2023
  2056                              <1> 	; 15/11/2023
  2057 00000E69 F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2058                              <1> 					; last of the file?
  2059 00000E6E 7402                <1> 	jz	short lff24s2_0		; no
  2060 00000E70 F9                  <1> 	stc
  2061 00000E71 C3                  <1> 	retn
  2062                              <1> 
  2063                              <1> lff24s2_0:
  2064 00000E72 8EC0                <1> 	mov	es, ax ; buffer segment	
  2065 00000E74 31FF                <1> 	xor	di, di
  2066 00000E76 BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2067                              <1> 	; ds = cs
  2068                              <1> 
  2069                              <1> 	; load file into memory
  2070 00000E79 8B0E[6906]          <1>         mov	cx, [loadsize]
  2071 00000E7D 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  2072 00000E81 B43F                <1>        	mov	ah, 3Fh
  2073 00000E83 CD21                <1> 	int	21h
  2074 00000E85 72DF                <1> 	jc	short lff24s2_7 ; error !
  2075                              <1> 
  2076 00000E87 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2077                              <1> 	
  2078                              <1> 	;shr	ax, 1
  2079 00000E89 C1E802              <1> 	shr	ax, 2	; 16/11/2023
  2080                              <1> 	;and	ax, ax
  2081 00000E8C 7503                <1> 	jnz	short lff24s2_8
  2082 00000E8E E978FA              <1> 	jmp	lff24_eof
  2083                              <1> 
  2084                              <1> lff24s2_8:
  2085 00000E91 89C1                <1> 	mov	cx, ax		; dword count
  2086                              <1> lff24s2_1:
  2087 00000E93 AD                  <1> 	lodsw
  2088 00000E94 AB                  <1> 	stosw		; original sample (L)
  2089 00000E95 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2090 00000E98 A3[6119]            <1> 	mov	[previous_val_l], ax
  2091 00000E9B AD                  <1> 	lodsw
  2092 00000E9C AB                  <1> 	stosw		; original sample (R)
  2093 00000E9D 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2094                              <1> 	;mov	[previous_val_r], ax
  2095 00000EA0 89C3                <1> 	mov	bx, ax
  2096 00000EA2 31D2                <1> 	xor	dx, dx
  2097 00000EA4 31C0                <1> 	xor	ax, ax
  2098                              <1> 	; 16/11/2023
  2099 00000EA6 49                  <1> 	dec	cx
  2100 00000EA7 7405                <1> 	jz	short lff24s2_2
  2101 00000EA9 8B04                <1> 	mov	ax, [si]
  2102 00000EAB 8B5402              <1> 	mov	dx, [si+2]
  2103                              <1> lff24s2_2:
  2104 00000EAE 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2105                              <1> 	;;mov	[next_val_l], ax
  2106                              <1> 	;mov	bp, ax
  2107 00000EB1 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format 
  2108                              <1> 	;mov	[next_val_r], dx
  2109 00000EB4 0306[6119]          <1> 	add	ax, [previous_val_l]
  2110 00000EB8 D1D8                <1> 	rcr	ax, 1
  2111 00000EBA 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  2112 00000EBD AB                  <1> 	stosw		; this is interpolated sample (L)
  2113                              <1> 	;mov	ax, [next_val_r]
  2114 00000EBE 89D0                <1> 	mov	ax, dx
  2115                              <1> 	;add	ax, [previous_val_r]
  2116 00000EC0 01D8                <1> 	add	ax, bx
  2117 00000EC2 D1D8                <1> 	rcr	ax, 1
  2118 00000EC4 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2119 00000EC7 AB                  <1> 	stosw		; this is interpolated sample (R)
  2120                              <1> 	
  2121                              <1> 	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2122 00000EC8 09C9                <1> 	or	cx, cx
  2123 00000ECA 75C7                <1> 	jnz	short lff24s2_1
  2124 00000ECC E927FA              <1> 	jmp	lff24_3
  2125                              <1> 
  2126                              <1> ; .....................
  2127                              <1> 
  2128                              <1> load_32khz_mono_8_bit:
  2129                              <1> 	; 15/11/2023
  2130 00000ECF F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2131                              <1> 					; last of the file?
  2132 00000ED4 7402                <1> 	jz	short lff32m_0		; no
  2133 00000ED6 F9                  <1> 	stc
  2134 00000ED7 C3                  <1> 	retn
  2135                              <1> 
  2136                              <1> lff32m_0:
  2137 00000ED8 8EC0                <1> 	mov	es, ax ; buffer segment	
  2138 00000EDA 31FF                <1> 	xor	di, di
  2139 00000EDC BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2140                              <1> 	; ds = cs
  2141                              <1> 
  2142                              <1> 	; load file into memory
  2143 00000EDF 8B0E[6906]          <1>         mov	cx, [loadsize]
  2144 00000EE3 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  2145 00000EE7 B43F                <1>        	mov	ah, 3Fh
  2146 00000EE9 CD21                <1> 	int	21h
  2147 00000EEB 7237                <1> 	jc	short lff32m_7 ; error !
  2148                              <1> 
  2149 00000EED 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2150                              <1> 	
  2151 00000EEF 21C0                <1> 	and	ax, ax
  2152 00000EF1 7503                <1> 	jnz	short lff32m_8
  2153 00000EF3 E913FA              <1> 	jmp	lff32_eof
  2154                              <1> 
  2155                              <1> lff32m_8:
  2156 00000EF6 89C1                <1> 	mov	cx, ax		; byte count
  2157                              <1> lff32m_1:
  2158 00000EF8 AC                  <1> 	lodsb
  2159                              <1> 	;mov	[previous_val], al
  2160 00000EF9 88C3                <1> 	mov	bl, al
  2161 00000EFB 2C80                <1> 	sub	al, 80h
  2162 00000EFD C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2163 00000F00 AB                  <1> 	stosw		; original sample (left channel)
  2164 00000F01 AB                  <1> 	stosw		; original sample (right channel)
  2165                              <1> 	;xor	ax, ax
  2166 00000F02 B080                <1> 	mov	al, 80h
  2167 00000F04 49                  <1> 	dec	cx
  2168 00000F05 7402                <1> 	jz	short lff32m_2
  2169 00000F07 8A04                <1> 	mov	al, [si]
  2170                              <1> lff32m_2:
  2171                              <1> 	;;mov	[next_val], al
  2172                              <1> 	;mov	bh, al
  2173                              <1> 	;add	al, [previous_val]
  2174 00000F09 00D8                <1> 	add	al, bl
  2175 00000F0B D0D8                <1> 	rcr	al, 1
  2176 00000F0D 2C80                <1> 	sub	al, 80h
  2177 00000F0F C1E008              <1> 	shl	ax, 8
  2178 00000F12 AB                  <1> 	stosw		; this is interpolated sample (L)
  2179 00000F13 AB                  <1> 	stosw		; this is interpolated sample (R)
  2180                              <1> 	
  2181                              <1> 	; different than 8-16-24 kHZ !
  2182                              <1> 	; 'original-interpolated-original' trio samples 
  2183 00000F14 E30B                <1> 	jcxz	lff32m_3
  2184                              <1> 
  2185 00000F16 AC                  <1> 	lodsb
  2186 00000F17 2C80                <1> 	sub	al, 80h
  2187 00000F19 C1E008              <1> 	shl	ax, 8
  2188 00000F1C AB                  <1> 	stosw		; original sample (left channel)
  2189 00000F1D AB                  <1> 	stosw		; original sample (right channel)
  2190                              <1> 
  2191                              <1> 	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2192 00000F1E 49                  <1> 	dec	cx
  2193 00000F1F 75D7                <1> 	jnz	short lff32m_1
  2194                              <1> lff32m_3:
  2195 00000F21 E9D2F9              <1> 	jmp	lff32_3
  2196                              <1> 
  2197                              <1> lff32m_7:
  2198                              <1> lff32s_7:
  2199 00000F24 E9E9F9              <1> 	jmp	lff32_5  ; error
  2200                              <1> 
  2201                              <1> load_32khz_stereo_8_bit:
  2202                              <1> 	; 15/11/2023
  2203 00000F27 F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2204                              <1> 					; last of the file?
  2205 00000F2C 7402                <1> 	jz	short lff32s_0		; no
  2206 00000F2E F9                  <1> 	stc
  2207 00000F2F C3                  <1> 	retn
  2208                              <1> 
  2209                              <1> lff32s_0:
  2210 00000F30 8EC0                <1> 	mov	es, ax ; buffer segment	
  2211 00000F32 31FF                <1> 	xor	di, di
  2212 00000F34 BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2213                              <1> 	; ds = cs
  2214                              <1> 
  2215                              <1> 	; load file into memory
  2216 00000F37 8B0E[6906]          <1>         mov	cx, [loadsize]
  2217 00000F3B 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  2218 00000F3F B43F                <1>        	mov	ah, 3Fh
  2219 00000F41 CD21                <1> 	int	21h
  2220 00000F43 72DF                <1> 	jc	short lff32s_7 ; error !
  2221                              <1> 
  2222 00000F45 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2223                              <1> 	
  2224 00000F47 D1E8                <1> 	shr	ax, 1
  2225                              <1> 	;and	ax, ax
  2226 00000F49 7503                <1> 	jnz	short lff32s_8
  2227 00000F4B E9BBF9              <1> 	jmp	lff32_eof
  2228                              <1> 
  2229                              <1> lff32s_8:
  2230 00000F4E 89C1                <1> 	mov	cx, ax		; word count
  2231                              <1> lff32s_1:
  2232 00000F50 AC                  <1> 	lodsb
  2233 00000F51 A2[6119]            <1> 	mov	[previous_val_l], al
  2234 00000F54 2C80                <1> 	sub	al, 80h
  2235 00000F56 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2236 00000F59 AB                  <1> 	stosw		; original sample (L)
  2237 00000F5A AC                  <1> 	lodsb
  2238 00000F5B A2[6319]            <1> 	mov	[previous_val_r], al
  2239 00000F5E 2C80                <1> 	sub	al, 80h
  2240 00000F60 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2241 00000F63 AB                  <1> 	stosw		; original sample (R)
  2242                              <1> 
  2243                              <1> 	;xor	ax, ax
  2244 00000F64 B88080              <1> 	mov	ax, 8080h
  2245 00000F67 49                  <1> 	dec	cx
  2246 00000F68 7402                <1> 	jz	short lff32s_2
  2247                              <1> 		; convert 8 bit sample to 16 bit sample
  2248 00000F6A 8B04                <1> 	mov	ax, [si]
  2249                              <1> lff32s_2:
  2250                              <1> 	;;mov	[next_val_l], al
  2251                              <1> 	;;mov	[next_val_r], ah
  2252                              <1> 	;mov	bx, ax
  2253 00000F6C 88E7                <1> 	mov	bh, ah
  2254 00000F6E 0206[6119]          <1> 	add	al, [previous_val_l]
  2255 00000F72 D0D8                <1> 	rcr	al, 1
  2256                              <1> 	;mov	dl, al
  2257 00000F74 2C80                <1> 	sub	al, 80h
  2258 00000F76 C1E008              <1> 	shl	ax, 8
  2259 00000F79 AB                  <1> 	stosw		; this is interpolated sample (L)
  2260 00000F7A 88F8                <1> 	mov	al, bh	; [next_val_r]
  2261 00000F7C 0206[6319]          <1> 	add	al, [previous_val_r]
  2262 00000F80 D0D8                <1> 	rcr	al, 1
  2263                              <1> 	;mov	dh, al
  2264 00000F82 2C80                <1> 	sub	al, 80h
  2265 00000F84 C1E008              <1> 	shl	ax, 8
  2266 00000F87 AB                  <1> 	stosw		; this is interpolated sample (R)
  2267                              <1> 
  2268                              <1> 	; different than 8-16-24 kHZ !
  2269                              <1> 	; 'original-interpolated-original' trio samples 
  2270 00000F88 E311                <1> 	jcxz	lff32s_3
  2271                              <1> 
  2272 00000F8A AC                  <1> 	lodsb
  2273 00000F8B 2C80                <1> 	sub	al, 80h
  2274 00000F8D C1E008              <1> 	shl	ax, 8
  2275 00000F90 AB                  <1> 	stosw		; original sample (left channel)
  2276                              <1> 
  2277 00000F91 AC                  <1> 	lodsb
  2278 00000F92 2C80                <1> 	sub	al, 80h
  2279 00000F94 C1E008              <1> 	shl	ax, 8
  2280 00000F97 AB                  <1> 	stosw		; original sample (right channel)
  2281                              <1> 		
  2282                              <1> 	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2283 00000F98 49                  <1> 	dec	cx
  2284 00000F99 75B5                <1> 	jnz	short lff32s_1
  2285                              <1> lff32s_3:
  2286 00000F9B E958F9              <1> 	jmp	lff32_3
  2287                              <1> 
  2288                              <1> load_32khz_mono_16_bit:
  2289                              <1> 	; 15/11/2023
  2290 00000F9E F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2291                              <1> 					; last of the file?
  2292 00000FA3 7402                <1> 	jz	short lff32m2_0		; no
  2293 00000FA5 F9                  <1> 	stc
  2294 00000FA6 C3                  <1> 	retn
  2295                              <1> 
  2296                              <1> lff32m2_0:
  2297 00000FA7 8EC0                <1> 	mov	es, ax ; buffer segment	
  2298 00000FA9 31FF                <1> 	xor	di, di
  2299 00000FAB BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2300                              <1> 	; ds = cs
  2301                              <1> 
  2302                              <1> 	; load file into memory
  2303 00000FAE 8B0E[6906]          <1>         mov	cx, [loadsize]
  2304 00000FB2 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  2305 00000FB6 B43F                <1>        	mov	ah, 3Fh
  2306 00000FB8 CD21                <1> 	int	21h
  2307 00000FBA 722C                <1> 	jc	short lff32m2_7 ; error !
  2308                              <1> 
  2309 00000FBC 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2310                              <1> 	
  2311 00000FBE D1E8                <1> 	shr	ax, 1
  2312                              <1> 	;and	ax, ax
  2313 00000FC0 7503                <1> 	jnz	short lff32m2_8
  2314 00000FC2 E944F9              <1> 	jmp	lff32_eof
  2315                              <1> 
  2316                              <1> lff32m2_8:
  2317 00000FC5 89C1                <1> 	mov	cx, ax	; word count
  2318                              <1> lff32m2_1:
  2319 00000FC7 AD                  <1> 	lodsw
  2320 00000FC8 AB                  <1> 	stosw		; original sample (left channel)
  2321 00000FC9 AB                  <1> 	stosw		; original sample (right channel)
  2322 00000FCA 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  2323                              <1> 	;mov	[previous_val], ax
  2324                              <1> 	;mov	bx, ax	
  2325                              <1> 	;xor	ax, ax
  2326 00000FCD 31DB                <1> 	xor	bx, bx
  2327 00000FCF 49                  <1> 	dec	cx
  2328 00000FD0 7402                <1> 	jz	short lff32m2_2
  2329                              <1> 	;mov	ax, [si
  2330 00000FD2 8B1C                <1> 	mov	bx, [si]
  2331                              <1> lff32m2_2:
  2332                              <1> 	;add	ah, 80h ; convert sound level 0 to 65535 format
  2333                              <1> 	;mov	bp, ax	; [next_val]
  2334                              <1> 	;add	ax, [previous_val]
  2335                              <1> 	; ax = [previous_val]
  2336                              <1> 	; bx = [next_val]
  2337 00000FD4 01D8                <1> 	add	ax, bx
  2338 00000FD6 D1D8                <1> 	rcr	ax, 1
  2339 00000FD8 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2340 00000FDB AB                  <1> 	stosw		; this is interpolated sample (L)
  2341 00000FDC AB                  <1> 	stosw		; this is interpolated sample (R)
  2342                              <1> 
  2343                              <1> 	; different than 8-16-24 kHZ !
  2344                              <1> 	; 'original-interpolated-original' trio samples 
  2345 00000FDD E306                <1> 	jcxz	lff32m2_3
  2346                              <1> 
  2347 00000FDF AD                  <1> 	lodsw
  2348 00000FE0 AB                  <1> 	stosw		; original sample (left channel)
  2349 00000FE1 AB                  <1> 	stosw		; original sample (right channel)
  2350                              <1> 
  2351                              <1> 	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2352 00000FE2 49                  <1> 	dec	cx
  2353 00000FE3 75E2                <1> 	jnz	short lff32m2_1
  2354                              <1> lff32m2_3:
  2355 00000FE5 E90EF9              <1> 	jmp	lff32_3
  2356                              <1> 
  2357                              <1> lff32m2_7:
  2358                              <1> lff32s2_7:
  2359 00000FE8 E925F9              <1> 	jmp	lff32_5  ; error
  2360                              <1> 
  2361                              <1> load_32khz_stereo_16_bit:
  2362                              <1> 	 ;16/11/2023
  2363                              <1> 	; 15/11/2023
  2364 00000FEB F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2365                              <1> 					; last of the file?
  2366 00000FF0 7402                <1> 	jz	short lff32s2_0		; no
  2367 00000FF2 F9                  <1> 	stc
  2368 00000FF3 C3                  <1> 	retn
  2369                              <1> 
  2370                              <1> lff32s2_0:
  2371 00000FF4 8EC0                <1> 	mov	es, ax ; buffer segment	
  2372 00000FF6 31FF                <1> 	xor	di, di
  2373 00000FF8 BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2374                              <1> 	; ds = cs
  2375                              <1> 
  2376                              <1> 	; load file into memory
  2377 00000FFB 8B0E[6906]          <1>         mov	cx, [loadsize]
  2378 00000FFF 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  2379 00001003 B43F                <1>        	mov	ah, 3Fh
  2380 00001005 CD21                <1> 	int	21h
  2381 00001007 72DF                <1> 	jc	short lff32s2_7 ; error !
  2382                              <1> 
  2383 00001009 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2384                              <1> 	
  2385 0000100B C1E802              <1> 	shr	ax, 2	; 16/11/2023 (word left ch + word right ch) 
  2386                              <1> 	;and	ax, ax
  2387 0000100E 7503                <1> 	jnz	short lff32s2_8
  2388 00001010 E9F6F8              <1> 	jmp	lff32_eof
  2389                              <1> 
  2390                              <1> lff32s2_8:
  2391 00001013 89C1                <1> 	mov	cx, ax		; dword count
  2392                              <1> lff32s2_1:
  2393 00001015 AD                  <1> 	lodsw
  2394 00001016 AB                  <1> 	stosw		; original sample (L)
  2395 00001017 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2396 0000101A A3[6119]            <1> 	mov	[previous_val_l], ax
  2397 0000101D AD                  <1> 	lodsw
  2398 0000101E AB                  <1> 	stosw		; original sample (R)
  2399 0000101F 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2400                              <1> 	;mov	[previous_val_r], ax
  2401 00001022 89C3                <1> 	mov	bx, ax
  2402 00001024 31D2                <1> 	xor	dx, dx
  2403 00001026 31C0                <1> 	xor	ax, ax
  2404                              <1> 	; 16/11/2023
  2405 00001028 49                  <1> 	dec	cx
  2406 00001029 7405                <1> 	jz	short lff32s2_2
  2407 0000102B 8B04                <1> 	mov	ax, [si]
  2408 0000102D 8B5402              <1> 	mov	dx, [si+2]
  2409                              <1> lff32s2_2:
  2410 00001030 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2411                              <1> 	;;mov	[next_val_l], ax
  2412                              <1> 	;mov	bp, ax
  2413 00001033 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format 
  2414                              <1> 	;mov	[next_val_r], dx
  2415 00001036 0306[6119]          <1> 	add	ax, [previous_val_l]
  2416 0000103A D1D8                <1> 	rcr	ax, 1
  2417 0000103C 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  2418 0000103F AB                  <1> 	stosw		; this is interpolated sample (L)
  2419                              <1> 	;mov	ax, [next_val_r]
  2420 00001040 89D0                <1> 	mov	ax, dx
  2421                              <1> 	;add	ax, [previous_val_r]
  2422 00001042 01D8                <1> 	add	ax, bx
  2423 00001044 D1D8                <1> 	rcr	ax, 1
  2424 00001046 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2425 00001049 AB                  <1> 	stosw		; this is interpolated sample (R)
  2426                              <1> 
  2427                              <1> 	; different than 8-16-24 kHZ !
  2428                              <1> 	; 'original-interpolated-original' trio samples 
  2429 0000104A E307                <1> 	jcxz	lff32s2_3
  2430                              <1> 
  2431 0000104C AD                  <1> 	lodsw
  2432 0000104D AB                  <1> 	stosw	; original sample (L)
  2433 0000104E AD                  <1> 	lodsw
  2434 0000104F AB                  <1> 	stosw	; original sample (R)
  2435                              <1> 	
  2436                              <1> 	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2437 00001050 49                  <1> 	dec	cx
  2438 00001051 75C2                <1> 	jnz	short lff32s2_1
  2439                              <1> lff32s2_3:
  2440 00001053 E9A0F8              <1> 	jmp	lff32_3
  2441                              <1> 
  2442                              <1> ; .....................
  2443                              <1> 
  2444                              <1> load_22khz_mono_8_bit:
  2445                              <1> 	; 16/11/2023
  2446 00001056 F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2447                              <1> 					; last of the file?
  2448 0000105B 7402                <1> 	jz	short lff22m_0		; no
  2449 0000105D F9                  <1> 	stc
  2450 0000105E C3                  <1> 	retn
  2451                              <1> 
  2452                              <1> lff22m_0:
  2453 0000105F 8EC0                <1> 	mov	es, ax ; buffer segment	
  2454 00001061 31FF                <1> 	xor	di, di
  2455 00001063 BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2456                              <1> 	; ds = cs
  2457                              <1> 
  2458                              <1> 	; load file into memory
  2459 00001066 8B0E[6906]          <1>         mov	cx, [loadsize]
  2460 0000106A 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  2461 0000106E B43F                <1>        	mov	ah, 3Fh
  2462 00001070 CD21                <1> 	int	21h
  2463 00001072 7248                <1> 	jc	short lff22m_7 ; error !
  2464                              <1> 
  2465 00001074 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2466                              <1> 	
  2467 00001076 21C0                <1> 	and	ax, ax
  2468 00001078 7503                <1> 	jnz	short lff22m_8
  2469 0000107A E98CF8              <1> 	jmp	lff22_eof
  2470                              <1> 
  2471                              <1> lff22m_8:
  2472 0000107D 89C1                <1> 	mov	cx, ax		; byte count
  2473                              <1> lff22m_9:
  2474 0000107F BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2475 00001082 C606[6919]03        <1> 	mov	byte [faz], 3  ; 3 steps/phases
  2476                              <1> lff22m_1:
  2477                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2478 00001087 AC                  <1> 	lodsb
  2479 00001088 B280                <1> 	mov	dl, 80h
  2480 0000108A 49                  <1> 	dec	cx
  2481 0000108B 7402                <1> 	jz	short lff22m_2_1
  2482 0000108D 8A14                <1> 	mov	dl, [si]
  2483                              <1> lff22m_2_1:	
  2484                              <1> 	; al = [previous_val]
  2485                              <1> 	; dl = [next_val]
  2486 0000108F E8A004              <1> 	call	interpolating_3_8bit_mono ; 1 of 17
  2487 00001092 E325                <1> 	jcxz	lff22m_3
  2488                              <1> lff22m_2_2:
  2489 00001094 AC                  <1> 	lodsb
  2490 00001095 B280                <1> 	mov	dl, 80h
  2491 00001097 49                  <1> 	dec	cx
  2492 00001098 7402                <1> 	jz	short lff22m_2_3
  2493 0000109A 8A14                <1> 	mov	dl, [si]
  2494                              <1> lff22m_2_3:
  2495 0000109C E80205              <1>  	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  2496 0000109F E318                <1> 	jcxz	lff22m_3
  2497 000010A1 4D                  <1> 	dec	bp
  2498 000010A2 75F0                <1> 	jnz	short lff22m_2_2
  2499                              <1> 
  2500 000010A4 A0[6919]            <1> 	mov	al, [faz]
  2501 000010A7 FEC8                <1> 	dec	al
  2502 000010A9 74D4                <1> 	jz	short lff22m_9
  2503 000010AB FE0E[6919]          <1> 	dec	byte [faz]
  2504 000010AF BD0400              <1> 	mov	bp, 4
  2505 000010B2 FEC8                <1> 	dec	al
  2506 000010B4 75D1                <1> 	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  2507 000010B6 45                  <1> 	inc	bp ; 5
  2508 000010B7 EBCE                <1> 	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2509                              <1> 
  2510                              <1> lff22m_3:
  2511                              <1> lff22s_3:
  2512 000010B9 E93AF8              <1> 	jmp	lff22_3	; padfill
  2513                              <1> 		; (put zeros in the remain words of the buffer)
  2514                              <1> lff22m_7:
  2515                              <1> lff22s_7:
  2516 000010BC E951F8              <1> 	jmp	lff22_5  ; error
  2517                              <1> 
  2518                              <1> load_22khz_stereo_8_bit:
  2519                              <1> 	; 16/11/2023
  2520 000010BF F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2521                              <1> 					; last of the file?
  2522 000010C4 7402                <1> 	jz	short lff22s_0		; no
  2523 000010C6 F9                  <1> 	stc
  2524 000010C7 C3                  <1> 	retn
  2525                              <1> 
  2526                              <1> lff22s_0:
  2527 000010C8 8EC0                <1> 	mov	es, ax ; buffer segment	
  2528 000010CA 31FF                <1> 	xor	di, di
  2529 000010CC BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2530                              <1> 	; ds = cs
  2531                              <1> 
  2532                              <1> 	; load file into memory
  2533 000010CF 8B0E[6906]          <1>         mov	cx, [loadsize]
  2534 000010D3 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  2535 000010D7 B43F                <1>        	mov	ah, 3Fh
  2536 000010D9 CD21                <1> 	int	21h
  2537 000010DB 72DF                <1> 	jc	short lff22s_7 ; error !
  2538                              <1> 
  2539 000010DD 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2540                              <1> 	
  2541 000010DF D1E8                <1> 	shr	ax, 1
  2542                              <1> 	;and	ax, ax
  2543 000010E1 7503                <1> 	jnz	short lff22s_8
  2544 000010E3 E923F8              <1> 	jmp	lff22_eof
  2545                              <1> 
  2546                              <1> lff22s_8:
  2547 000010E6 89C1                <1> 	mov	cx, ax		; word count
  2548                              <1> lff22s_9:
  2549 000010E8 BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2550 000010EB C606[6919]03        <1> 	mov	byte [faz], 3  ; 3 steps/phase
  2551                              <1> lff22s_1:
  2552                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2553 000010F0 AD                  <1> 	lodsw
  2554 000010F1 BA8080              <1> 	mov	dx, 8080h
  2555 000010F4 49                  <1> 	dec	cx
  2556 000010F5 7402                <1> 	jz	short lff22s_2_1 
  2557 000010F7 8B14                <1> 	mov	dx, [si]
  2558                              <1> lff22s_2_1:	
  2559                              <1> 	; al = [previous_val_l]
  2560                              <1> 	; ah = [previous_val_r]
  2561                              <1> 	; dl = [next_val_l]
  2562                              <1> 	; dl = [next_val_r]	
  2563 000010F9 E85E04              <1> 	call	interpolating_3_8bit_stereo ; 1 of 17 
  2564 000010FC E3BB                <1> 	jcxz	lff22s_3
  2565                              <1> lff22s_2_2:
  2566 000010FE AD                  <1> 	lodsw
  2567 000010FF BA8080              <1> 	mov	dx, 8080h
  2568 00001102 49                  <1> 	dec	cx
  2569 00001103 7402                <1> 	jz	short lff22s_2_3
  2570 00001105 8B14                <1> 	mov	dx, [si]
  2571                              <1> lff22s_2_3:
  2572 00001107 E8AE04              <1>  	call	interpolating_2_8bit_stereo ; 2 of 17 .. 6 of 17
  2573 0000110A E3AD                <1> 	jcxz	lff22s_3
  2574 0000110C 4D                  <1> 	dec	bp
  2575 0000110D 75EF                <1> 	jnz	short lff22s_2_2
  2576                              <1> 
  2577 0000110F A0[6919]            <1> 	mov	al, [faz]
  2578 00001112 FEC8                <1> 	dec	al
  2579 00001114 74D2                <1> 	jz	short lff22s_9
  2580 00001116 FE0E[6919]          <1> 	dec	byte [faz]
  2581 0000111A BD0400              <1> 	mov	bp, 4
  2582 0000111D FEC8                <1> 	dec	al
  2583 0000111F 75CF                <1> 	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  2584 00001121 45                  <1> 	inc	bp ; 5
  2585 00001122 EBCC                <1> 	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2586                              <1> 
  2587                              <1> load_22khz_mono_16_bit:
  2588                              <1> 	; 16/11/2023
  2589 00001124 F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2590                              <1> 					; last of the file?
  2591 00001129 7402                <1> 	jz	short lff22m2_0		; no
  2592 0000112B F9                  <1> 	stc
  2593 0000112C C3                  <1> 	retn
  2594                              <1> 
  2595                              <1> lff22m2_0:
  2596 0000112D 8EC0                <1> 	mov	es, ax ; buffer segment	
  2597 0000112F 31FF                <1> 	xor	di, di
  2598 00001131 BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2599                              <1> 	; ds = cs
  2600                              <1> 
  2601                              <1> 	; load file into memory
  2602 00001134 8B0E[6906]          <1>         mov	cx, [loadsize]
  2603 00001138 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  2604 0000113C B43F                <1>        	mov	ah, 3Fh
  2605 0000113E CD21                <1> 	int	21h
  2606 00001140 7248                <1> 	jc	short lff22m2_7 ; error !
  2607                              <1> 
  2608 00001142 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2609                              <1> 	
  2610 00001144 D1E8                <1> 	shr	ax, 1
  2611                              <1> 	;and	ax, ax
  2612 00001146 7503                <1> 	jnz	short lff22m2_8
  2613 00001148 E9BEF7              <1> 	jmp	lff22_eof
  2614                              <1> 
  2615                              <1> lff22m2_8:
  2616 0000114B 89C1                <1> 	mov	cx, ax		; word count
  2617                              <1> lff22m2_9:
  2618 0000114D BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2619 00001150 C606[6919]03        <1> 	mov	byte [faz], 3  ; 3 steps/phases
  2620                              <1> lff22m2_1:
  2621                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2622 00001155 AD                  <1> 	lodsw
  2623 00001156 31D2                <1> 	xor	dx, dx
  2624 00001158 49                  <1> 	dec	cx
  2625 00001159 7402                <1> 	jz	short lff22m2_2_1
  2626 0000115B 8B14                <1> 	mov	dx, [si]
  2627                              <1> lff22m2_2_1:	
  2628                              <1> 	; ax = [previous_val]
  2629                              <1> 	; dx = [next_val]
  2630 0000115D E88104              <1> 	call	interpolating_3_16bit_mono ; 1 of 17
  2631 00001160 E325                <1> 	jcxz	lff22m2_3
  2632                              <1> lff22m2_2_2:
  2633 00001162 AD                  <1> 	lodsw
  2634 00001163 31D2                <1> 	xor	dx, dx
  2635 00001165 49                  <1> 	dec	cx
  2636 00001166 7402                <1> 	jz	short lff22m2_2_3
  2637 00001168 8B14                <1> 	mov	dx, [si]
  2638                              <1> lff22m2_2_3:
  2639 0000116A E8E104              <1>  	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  2640 0000116D E318                <1> 	jcxz	lff22m2_3
  2641 0000116F 4D                  <1> 	dec	bp
  2642 00001170 75F0                <1> 	jnz	short lff22m2_2_2
  2643                              <1> 
  2644 00001172 A0[6919]            <1> 	mov	al, [faz]
  2645 00001175 FEC8                <1> 	dec	al
  2646 00001177 74D4                <1> 	jz	short lff22m2_9
  2647 00001179 FE0E[6919]          <1> 	dec	byte [faz]
  2648 0000117D BD0400              <1> 	mov	bp, 4
  2649 00001180 FEC8                <1> 	dec	al
  2650 00001182 75D1                <1> 	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2651 00001184 45                  <1> 	inc	bp ; 5
  2652 00001185 EBCE                <1> 	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2653                              <1> 
  2654                              <1> lff22m2_3:
  2655                              <1> lff22s2_3:
  2656 00001187 E96CF7              <1> 	jmp	lff22_3	; padfill
  2657                              <1> 		; (put zeros in the remain words of the buffer)
  2658                              <1> lff22m2_7:
  2659                              <1> lff22s2_7:
  2660 0000118A E983F7              <1> 	jmp	lff22_5  ; error
  2661                              <1> 
  2662                              <1> load_22khz_stereo_16_bit:
  2663                              <1> 	; 16/11/2023
  2664 0000118D F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2665                              <1> 					; last of the file?
  2666 00001192 7402                <1> 	jz	short lff22s2_0		; no
  2667 00001194 F9                  <1> 	stc
  2668 00001195 C3                  <1> 	retn
  2669                              <1> 
  2670                              <1> lff22s2_0:
  2671 00001196 8EC0                <1> 	mov	es, ax ; buffer segment	
  2672 00001198 31FF                <1> 	xor	di, di
  2673 0000119A BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2674                              <1> 	; ds = cs
  2675                              <1> 
  2676                              <1> 	; load file into memory
  2677 0000119D 8B0E[6906]          <1>         mov	cx, [loadsize]
  2678 000011A1 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  2679 000011A5 B43F                <1>        	mov	ah, 3Fh
  2680 000011A7 CD21                <1> 	int	21h
  2681 000011A9 72DF                <1> 	jc	short lff22s2_7 ; error !
  2682                              <1> 
  2683 000011AB 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2684                              <1> 	
  2685 000011AD C1E802              <1> 	shr	ax, 2	; dword (left chan word + right chan word)
  2686                              <1> 	;and	ax, ax
  2687 000011B0 7503                <1> 	jnz	short lff22s2_8
  2688 000011B2 E954F7              <1> 	jmp	lff22_eof
  2689                              <1> 
  2690                              <1> lff22s2_8:
  2691 000011B5 89C1                <1> 	mov	cx, ax		; dword count
  2692                              <1> lff22s2_9:
  2693 000011B7 BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2694 000011BA C606[6919]03        <1> 	mov	byte [faz], 3  ; 3 steps/phase
  2695                              <1> lff22s2_1:
  2696                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2697 000011BF AD                  <1> 	lodsw
  2698 000011C0 89C3                <1> 	mov	bx, ax
  2699 000011C2 AD                  <1> 	lodsw
  2700 000011C3 8B14                <1> 	mov	dx, [si]
  2701 000011C5 8916[6519]          <1> 	mov	[next_val_l], dx
  2702 000011C9 8B5402              <1> 	mov	dx, [si+2]
  2703 000011CC 49                  <1> 	dec	cx
  2704 000011CD 7506                <1> 	jnz	short lff22s2_2_1
  2705 000011CF 31D2                <1> 	xor	dx, dx ; 0
  2706 000011D1 8916[6519]          <1> 	mov	[next_val_l], dx
  2707                              <1> lff22s2_2_1:
  2708                              <1> 	; bx = [previous_val_l]
  2709                              <1> 	; ax = [previous_val_r]
  2710                              <1> 	; [next_val_l]
  2711                              <1> 	; dx = [next_val_r]
  2712 000011D5 E82D04              <1> 	call	interpolating_3_16bit_stereo ; 1 of 17 
  2713 000011D8 E3AD                <1> 	jcxz	lff22s2_3
  2714                              <1> lff22s2_2_2:
  2715 000011DA AD                  <1> 	lodsw
  2716 000011DB 89C3                <1> 	mov	bx, ax
  2717 000011DD AD                  <1> 	lodsw
  2718 000011DE 8B14                <1> 	mov	dx, [si]
  2719 000011E0 8916[6519]          <1> 	mov	[next_val_l], dx
  2720 000011E4 8B5402              <1> 	mov	dx, [si+2]
  2721 000011E7 49                  <1> 	dec	cx
  2722 000011E8 7506                <1> 	jnz	short lff22s2_2_3
  2723 000011EA 31D2                <1> 	xor	dx, dx ; 0
  2724 000011EC 8916[6519]          <1> 	mov	[next_val_l], dx
  2725                              <1> lff22s2_2_3:
  2726 000011F0 E86D04              <1>  	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  2727 000011F3 E392                <1> 	jcxz	lff22s2_3
  2728 000011F5 4D                  <1> 	dec	bp
  2729 000011F6 75E2                <1> 	jnz	short lff22s2_2_2
  2730                              <1> 
  2731 000011F8 A0[6919]            <1> 	mov	al, [faz]
  2732 000011FB FEC8                <1> 	dec	al
  2733 000011FD 74B8                <1> 	jz	short lff22s2_9
  2734 000011FF FE0E[6919]          <1> 	dec	byte [faz]
  2735 00001203 BD0400              <1> 	mov	bp, 4
  2736 00001206 FEC8                <1> 	dec	al
  2737 00001208 75B5                <1> 	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2738 0000120A 45                  <1> 	inc	bp ; 5
  2739 0000120B EBB2                <1> 	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2740                              <1> 
  2741                              <1> ; .....................
  2742                              <1> 
  2743                              <1> load_11khz_mono_8_bit:
  2744                              <1> 	; 18/11/2023
  2745 0000120D F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2746                              <1> 					; last of the file?
  2747 00001212 7402                <1> 	jz	short lff11m_0		; no
  2748 00001214 F9                  <1> 	stc
  2749 00001215 C3                  <1> 	retn
  2750                              <1> 
  2751                              <1> lff11m_0:
  2752 00001216 8EC0                <1> 	mov	es, ax ; buffer segment	
  2753 00001218 31FF                <1> 	xor	di, di
  2754 0000121A BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2755                              <1> 	; ds = cs
  2756                              <1> 
  2757                              <1> 	; load file into memory
  2758 0000121D 8B0E[6906]          <1>         mov	cx, [loadsize]
  2759 00001221 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  2760 00001225 B43F                <1>        	mov	ah, 3Fh
  2761 00001227 CD21                <1> 	int	21h
  2762 00001229 723D                <1> 	jc	short lff11m_7 ; error !
  2763                              <1> 
  2764 0000122B 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2765                              <1> 	
  2766 0000122D 21C0                <1> 	and	ax, ax
  2767 0000122F 7503                <1> 	jnz	short lff11m_8
  2768 00001231 E9D5F6              <1> 	jmp	lff11_eof
  2769                              <1> 
  2770                              <1> lff11m_8:
  2771 00001234 89C1                <1> 	mov	cx, ax		; byte count
  2772                              <1> lff11m_9:
  2773 00001236 BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  2774                              <1> lff11m_1:
  2775                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  2776 00001239 AC                  <1> 	lodsb
  2777 0000123A B280                <1> 	mov	dl, 80h
  2778 0000123C 49                  <1> 	dec	cx
  2779 0000123D 7402                <1> 	jz	short lff11m_2_1
  2780 0000123F 8A14                <1> 	mov	dl, [si]
  2781                              <1> lff11m_2_1:	
  2782                              <1> 	; al = [previous_val]
  2783                              <1> 	; dl = [next_val]
  2784 00001241 E84204              <1> 	call	interpolating_5_8bit_mono
  2785 00001244 E31F                <1> 	jcxz	lff11m_3
  2786                              <1> lff11m_2_2:
  2787 00001246 AC                  <1> 	lodsb
  2788 00001247 B280                <1> 	mov	dl, 80h
  2789 00001249 49                  <1> 	dec	cx
  2790 0000124A 7402                <1> 	jz	short lff11m_2_3
  2791 0000124C 8A14                <1> 	mov	dl, [si]
  2792                              <1> lff11m_2_3:
  2793 0000124E E81E05              <1>  	call	interpolating_4_8bit_mono
  2794 00001251 E312                <1> 	jcxz	lff11m_3
  2795                              <1> 
  2796 00001253 4D                  <1> 	dec	bp
  2797 00001254 74E0                <1> 	jz	short lff11m_9
  2798                              <1> 
  2799 00001256 AC                  <1> 	lodsb
  2800 00001257 B280                <1> 	mov	dl, 80h
  2801 00001259 49                  <1> 	dec	cx
  2802 0000125A 7402                <1> 	jz	short lff11m_2_4
  2803 0000125C 8A14                <1> 	mov	dl, [si]
  2804                              <1> lff11m_2_4:
  2805 0000125E E80E05              <1> 	call	interpolating_4_8bit_mono
  2806 00001261 E302                <1> 	jcxz	lff11m_3
  2807 00001263 EBD4                <1> 	jmp	short lff11m_1
  2808                              <1> 
  2809                              <1> lff11m_3:
  2810                              <1> lff11s_3:
  2811 00001265 E98EF6              <1> 	jmp	lff11_3	; padfill
  2812                              <1> 		; (put zeros in the remain words of the buffer)
  2813                              <1> lff11m_7:
  2814                              <1> lff11s_7:
  2815 00001268 E9A5F6              <1> 	jmp	lff11_5  ; error
  2816                              <1> 
  2817                              <1> load_11khz_stereo_8_bit:
  2818                              <1> 	; 18/11/2023
  2819 0000126B F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2820                              <1> 					; last of the file?
  2821 00001270 7402                <1> 	jz	short lff11s_0		; no
  2822 00001272 F9                  <1> 	stc
  2823 00001273 C3                  <1> 	retn
  2824                              <1> 
  2825                              <1> lff11s_0:
  2826 00001274 8EC0                <1> 	mov	es, ax ; buffer segment	
  2827 00001276 31FF                <1> 	xor	di, di
  2828 00001278 BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2829                              <1> 	; ds = cs
  2830                              <1> 
  2831                              <1> 	; load file into memory
  2832 0000127B 8B0E[6906]          <1>         mov	cx, [loadsize]
  2833 0000127F 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  2834 00001283 B43F                <1>        	mov	ah, 3Fh
  2835 00001285 CD21                <1> 	int	21h
  2836 00001287 72DF                <1> 	jc	short lff11s_7 ; error !
  2837                              <1> 
  2838 00001289 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2839                              <1> 	
  2840 0000128B D1E8                <1> 	shr	ax, 1
  2841                              <1> 	;and	ax, ax
  2842 0000128D 7503                <1> 	jnz	short lff11s_8
  2843 0000128F E977F6              <1> 	jmp	lff11_eof
  2844                              <1> 
  2845                              <1> lff11s_8:
  2846 00001292 89C1                <1> 	mov	cx, ax		; word count
  2847                              <1> lff11s_9:
  2848 00001294 BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  2849                              <1> lff11s_1:
  2850                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  2851 00001297 AD                  <1> 	lodsw
  2852 00001298 BA8080              <1> 	mov	dx, 8080h
  2853 0000129B 49                  <1> 	dec	cx
  2854 0000129C 7402                <1> 	jz	short lff11s_2_1 
  2855 0000129E 8B14                <1> 	mov	dx, [si]
  2856                              <1> lff11s_2_1:	
  2857                              <1> 	; al = [previous_val_l]
  2858                              <1> 	; ah = [previous_val_r]
  2859                              <1> 	; dl = [next_val_l]
  2860                              <1> 	; dl = [next_val_r]	
  2861 000012A0 E83304              <1> 	call	interpolating_5_8bit_stereo
  2862 000012A3 E3C0                <1> 	jcxz	lff11s_3
  2863                              <1> lff11s_2_2:
  2864 000012A5 AD                  <1> 	lodsw
  2865 000012A6 BA8080              <1> 	mov	dx, 8080h
  2866 000012A9 49                  <1> 	dec	cx
  2867 000012AA 7402                <1> 	jz	short lff11s_2_3
  2868 000012AC 8B14                <1> 	mov	dx, [si]
  2869                              <1> lff11s_2_3:
  2870 000012AE E8F104              <1>  	call	interpolating_4_8bit_stereo
  2871 000012B1 E3B2                <1> 	jcxz	lff11s_3
  2872                              <1> 	
  2873 000012B3 4D                  <1> 	dec	bp
  2874 000012B4 74DE                <1> 	jz	short lff11s_9
  2875                              <1> 
  2876 000012B6 AD                  <1> 	lodsw
  2877 000012B7 BA8080              <1> 	mov	dx, 8080h
  2878 000012BA 49                  <1> 	dec	cx
  2879 000012BB 7402                <1> 	jz	short lff11s_2_4
  2880 000012BD 8B14                <1> 	mov	dx, [si]
  2881                              <1> lff11s_2_4:
  2882 000012BF E8E004              <1> 	call	interpolating_4_8bit_stereo
  2883 000012C2 E3A1                <1> 	jcxz	lff11s_3
  2884 000012C4 EBD1                <1> 	jmp	short lff11s_1
  2885                              <1> 
  2886                              <1> load_11khz_mono_16_bit:
  2887                              <1> 	; 18/11/2023
  2888 000012C6 F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2889                              <1> 					; last of the file?
  2890 000012CB 7402                <1> 	jz	short lff11m2_0		; no
  2891 000012CD F9                  <1> 	stc
  2892 000012CE C3                  <1> 	retn
  2893                              <1> 
  2894                              <1> lff11m2_0:
  2895 000012CF 8EC0                <1> 	mov	es, ax ; buffer segment	
  2896 000012D1 31FF                <1> 	xor	di, di
  2897 000012D3 BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2898                              <1> 	; ds = cs
  2899                              <1> 
  2900                              <1> 	; load file into memory
  2901 000012D6 8B0E[6906]          <1>         mov	cx, [loadsize]
  2902 000012DA 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  2903 000012DE B43F                <1>        	mov	ah, 3Fh
  2904 000012E0 CD21                <1> 	int	21h
  2905 000012E2 723A                <1> 	jc	short lff11m2_7 ; error !
  2906                              <1> 
  2907 000012E4 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2908                              <1> 	
  2909 000012E6 D1E8                <1> 	shr	ax, 1
  2910                              <1> 	;and	ax, ax
  2911 000012E8 7503                <1> 	jnz	short lff11m2_8
  2912 000012EA E91CF6              <1> 	jmp	lff11_eof
  2913                              <1> 
  2914                              <1> lff11m2_8:
  2915 000012ED 89C1                <1> 	mov	cx, ax		; word count
  2916                              <1> lff11m2_9:
  2917 000012EF BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  2918                              <1> lff11m2_1:
  2919                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  2920 000012F2 AD                  <1> 	lodsw
  2921 000012F3 31D2                <1> 	xor	dx, dx
  2922 000012F5 49                  <1> 	dec	cx
  2923 000012F6 7402                <1> 	jz	short lff11m2_2_1
  2924 000012F8 8B14                <1> 	mov	dx, [si]
  2925                              <1> lff11m2_2_1:	
  2926                              <1> 	; ax = [previous_val]
  2927                              <1> 	; dx = [next_val]
  2928 000012FA E80205              <1> 	call	interpolating_5_16bit_mono
  2929 000012FD E34A                <1> 	jcxz	lff11m2_3
  2930                              <1> lff11m2_2_2:
  2931 000012FF AD                  <1> 	lodsw
  2932 00001300 31D2                <1> 	xor	dx, dx
  2933 00001302 49                  <1> 	dec	cx
  2934 00001303 7402                <1> 	jz	short lff11m2_2_3
  2935 00001305 8B14                <1> 	mov	dx, [si]
  2936                              <1> lff11m2_2_3:
  2937 00001307 E8D005              <1>  	call	interpolating_4_16bit_mono
  2938 0000130A E33D                <1> 	jcxz	lff11m2_3
  2939                              <1> 
  2940 0000130C 4D                  <1> 	dec	bp
  2941 0000130D 74E0                <1> 	jz	short lff11m2_9
  2942                              <1> 
  2943 0000130F AD                  <1> 	lodsw
  2944 00001310 31D2                <1> 	xor	dx, dx
  2945 00001312 49                  <1> 	dec	cx
  2946 00001313 7402                <1> 	jz	short lff11m2_2_4
  2947 00001315 8B14                <1> 	mov	dx, [si]
  2948                              <1> lff11m2_2_4:
  2949 00001317 E8C005              <1>  	call	interpolating_4_16bit_mono
  2950 0000131A E32D                <1> 	jcxz	lff11m2_3
  2951 0000131C EBD4                <1> 	jmp	short lff11m2_1
  2952                              <1> 
  2953                              <1> lff11m2_7:
  2954                              <1> lff11s2_7:
  2955 0000131E E9EFF5              <1> 	jmp	lff11_5  ; error
  2956                              <1> 
  2957                              <1> load_11khz_stereo_16_bit:
  2958                              <1> 	; 18/11/2023
  2959 00001321 F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2960                              <1> 					; last of the file?
  2961 00001326 7402                <1> 	jz	short lff11s2_0		; no
  2962 00001328 F9                  <1> 	stc
  2963 00001329 C3                  <1> 	retn
  2964                              <1> 
  2965                              <1> lff11s2_0:
  2966 0000132A 8EC0                <1> 	mov	es, ax ; buffer segment	
  2967 0000132C 31FF                <1> 	xor	di, di
  2968 0000132E BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2969                              <1> 	; ds = cs
  2970                              <1> 
  2971                              <1> 	; load file into memory
  2972 00001331 8B0E[6906]          <1>         mov	cx, [loadsize]
  2973 00001335 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  2974 00001339 B43F                <1>        	mov	ah, 3Fh
  2975 0000133B CD21                <1> 	int	21h
  2976 0000133D 72DF                <1> 	jc	short lff11s2_7 ; error !
  2977                              <1> 
  2978 0000133F 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2979                              <1> 	
  2980 00001341 C1E802              <1> 	shr	ax, 2	; dword (left chan word + right chan word)
  2981                              <1> 	;and	ax, ax
  2982 00001344 7506                <1> 	jnz	short lff11s2_8
  2983 00001346 E9C0F5              <1> 	jmp	lff11_eof
  2984                              <1> 
  2985                              <1> lff11m2_3:
  2986                              <1> lff11s2_3:
  2987 00001349 E9AAF5              <1> 	jmp	lff11_3	; padfill
  2988                              <1> 		; (put zeros in the remain words of the buffer)
  2989                              <1> 
  2990                              <1> lff11s2_8:
  2991 0000134C 89C1                <1> 	mov	cx, ax		; dword count
  2992                              <1> lff11s2_9:
  2993 0000134E BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  2994                              <1> lff11s2_1:
  2995                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  2996 00001351 AD                  <1> 	lodsw
  2997 00001352 89C3                <1> 	mov	bx, ax
  2998 00001354 AD                  <1> 	lodsw
  2999 00001355 8B14                <1> 	mov	dx, [si]
  3000 00001357 8916[6519]          <1> 	mov	[next_val_l], dx
  3001 0000135B 8B5402              <1> 	mov	dx, [si+2]
  3002 0000135E 8916[6719]          <1> 	mov	[next_val_r], dx
  3003 00001362 49                  <1> 	dec	cx
  3004 00001363 750A                <1> 	jnz	short lff11s2_2_1
  3005 00001365 31D2                <1> 	xor	dx, dx ; 0
  3006 00001367 8916[6519]          <1> 	mov	[next_val_l], dx
  3007 0000136B 8916[6719]          <1> 	mov	[next_val_r], dx
  3008                              <1> lff11s2_2_1:
  3009                              <1> 	; bx = [previous_val_l]
  3010                              <1> 	; ax = [previous_val_r]
  3011                              <1> 	; [next_val_l]
  3012                              <1> 	; dx = [next_val_r]
  3013 0000136F E8D004              <1> 	call	interpolating_5_16bit_stereo
  3014 00001372 E3D5                <1> 	jcxz	lff11s2_3
  3015                              <1> lff11s2_2_2:
  3016 00001374 AD                  <1> 	lodsw
  3017 00001375 89C3                <1> 	mov	bx, ax
  3018 00001377 AD                  <1> 	lodsw
  3019 00001378 8B14                <1> 	mov	dx, [si]
  3020 0000137A 8916[6519]          <1> 	mov	[next_val_l], dx
  3021 0000137E 8B5402              <1> 	mov	dx, [si+2]
  3022 00001381 8916[6719]          <1> 	mov	[next_val_r], dx
  3023 00001385 49                  <1> 	dec	cx
  3024 00001386 750A                <1> 	jnz	short lff11s2_2_3
  3025 00001388 31D2                <1> 	xor	dx, dx ; 0
  3026 0000138A 8916[6519]          <1> 	mov	[next_val_l], dx
  3027 0000138E 8916[6719]          <1> 	mov	[next_val_r], dx
  3028                              <1> lff11s2_2_3:
  3029 00001392 E87005              <1>  	call	interpolating_4_16bit_stereo
  3030 00001395 E3B2                <1> 	jcxz	lff11s2_3
  3031                              <1> 	
  3032 00001397 4D                  <1> 	dec	bp
  3033 00001398 74B4                <1> 	jz	short lff11s2_9
  3034                              <1> 
  3035 0000139A AD                  <1> 	lodsw
  3036 0000139B 89C3                <1> 	mov	bx, ax
  3037 0000139D AD                  <1> 	lodsw
  3038 0000139E 8B14                <1> 	mov	dx, [si]
  3039 000013A0 8916[6519]          <1> 	mov	[next_val_l], dx
  3040 000013A4 8B5402              <1> 	mov	dx, [si+2]
  3041 000013A7 8916[6719]          <1> 	mov	[next_val_r], dx
  3042 000013AB 49                  <1> 	dec	cx
  3043 000013AC 750A                <1> 	jnz	short lff11s2_2_4
  3044 000013AE 31D2                <1> 	xor	dx, dx ; 0
  3045 000013B0 8916[6519]          <1> 	mov	[next_val_l], dx
  3046 000013B4 8916[6719]          <1> 	mov	[next_val_r], dx
  3047                              <1> lff11s2_2_4:
  3048 000013B8 E84A05              <1>  	call	interpolating_4_16bit_stereo
  3049 000013BB E38C                <1> 	jcxz	lff11s2_3
  3050 000013BD EB92                <1> 	jmp	short lff11s2_1
  3051                              <1> 
  3052                              <1> ; .....................
  3053                              <1> 
  3054                              <1> load_44khz_mono_8_bit:
  3055                              <1> 	; 18/11/2023
  3056 000013BF F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3057                              <1> 					; last of the file?
  3058 000013C4 7402                <1> 	jz	short lff44m_0		; no
  3059 000013C6 F9                  <1> 	stc
  3060 000013C7 C3                  <1> 	retn
  3061                              <1> 
  3062                              <1> lff44m_0:
  3063 000013C8 8EC0                <1> 	mov	es, ax ; buffer segment	
  3064 000013CA 31FF                <1> 	xor	di, di
  3065 000013CC BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3066                              <1> 	; ds = cs
  3067                              <1> 
  3068                              <1> 	; load file into memory
  3069 000013CF 8B0E[6906]          <1>         mov	cx, [loadsize]
  3070 000013D3 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  3071 000013D7 B43F                <1>        	mov	ah, 3Fh
  3072 000013D9 CD21                <1> 	int	21h
  3073 000013DB 723C                <1> 	jc	short lff44m_7 ; error !
  3074                              <1> 
  3075 000013DD 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3076                              <1> 	
  3077 000013DF 21C0                <1> 	and	ax, ax
  3078 000013E1 7503                <1> 	jnz	short lff44m_8
  3079 000013E3 E923F5              <1> 	jmp	lff44_eof
  3080                              <1> 
  3081                              <1> lff44m_8:
  3082 000013E6 89C1                <1> 	mov	cx, ax		; byte count
  3083                              <1> lff44m_9:
  3084 000013E8 BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3085 000013EB C606[6919]02        <1> 	mov	byte [faz], 2  ; 2 steps/phases
  3086                              <1> lff44m_1:
  3087                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3088                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3089 000013F0 AC                  <1> 	lodsb
  3090 000013F1 B280                <1> 	mov	dl, 80h
  3091 000013F3 49                  <1> 	dec	cx
  3092 000013F4 7402                <1> 	jz	short lff44m_2_1
  3093 000013F6 8A14                <1> 	mov	dl, [si]
  3094                              <1> lff44m_2_1:	
  3095                              <1> 	; al = [previous_val]
  3096                              <1> 	; dl = [next_val]
  3097 000013F8 E8A601              <1> 	call	interpolating_2_8bit_mono
  3098 000013FB E319                <1> 	jcxz	lff44m_3
  3099                              <1> lff44m_2_2:
  3100 000013FD AC                  <1> 	lodsb
  3101 000013FE 2C80                <1> 	sub	al, 80h
  3102 00001400 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3103 00001403 AB                  <1> 	stosw		; (L)
  3104 00001404 AB                  <1> 	stosw		; (R)	
  3105                              <1> 
  3106 00001405 49                  <1> 	dec	cx
  3107 00001406 740E                <1> 	jz	short lff44m_3	
  3108 00001408 4D                  <1> 	dec	bp
  3109 00001409 75F2                <1> 	jnz	short lff44m_2_2
  3110                              <1> 	
  3111 0000140B FE0E[6919]          <1> 	dec	byte [faz]
  3112 0000140F 74D7                <1> 	jz	short lff44m_9 
  3113 00001411 BD0B00              <1> 	mov	bp, 11
  3114 00001414 EBDA                <1> 	jmp	short lff44m_1
  3115                              <1> 
  3116                              <1> lff44m_3:
  3117                              <1> lff44s_3:
  3118 00001416 E9DDF4              <1> 	jmp	lff44_3	; padfill
  3119                              <1> 		; (put zeros in the remain words of the buffer)
  3120                              <1> lff44m_7:
  3121                              <1> lff44s_7:
  3122 00001419 E9F4F4              <1> 	jmp	lff44_5  ; error
  3123                              <1> 
  3124                              <1> load_44khz_stereo_8_bit:
  3125                              <1> 	; 16/11/2023
  3126 0000141C F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3127                              <1> 					; last of the file?
  3128 00001421 7402                <1> 	jz	short lff44s_0		; no
  3129 00001423 F9                  <1> 	stc
  3130 00001424 C3                  <1> 	retn
  3131                              <1> 
  3132                              <1> lff44s_0:
  3133 00001425 8EC0                <1> 	mov	es, ax ; buffer segment	
  3134 00001427 31FF                <1> 	xor	di, di
  3135 00001429 BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3136                              <1> 	; ds = cs
  3137                              <1> 
  3138                              <1> 	; load file into memory
  3139 0000142C 8B0E[6906]          <1>         mov	cx, [loadsize]
  3140 00001430 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  3141 00001434 B43F                <1>        	mov	ah, 3Fh
  3142 00001436 CD21                <1> 	int	21h
  3143 00001438 72DF                <1> 	jc	short lff44s_7 ; error !
  3144                              <1> 
  3145 0000143A 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3146                              <1> 	
  3147 0000143C D1E8                <1> 	shr	ax, 1
  3148                              <1> 	;and	ax, ax
  3149 0000143E 7503                <1> 	jnz	short lff44s_8
  3150 00001440 E9C6F4              <1> 	jmp	lff44_eof
  3151                              <1> 
  3152                              <1> lff44s_8:
  3153 00001443 89C1                <1> 	mov	cx, ax		; word count
  3154                              <1> lff44s_9:
  3155 00001445 BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3156 00001448 C606[6919]02        <1> 	mov	byte [faz], 2  ; 2 steps/phase
  3157                              <1> lff44s_1:
  3158                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3159                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3160 0000144D AD                  <1> 	lodsw
  3161 0000144E BA8080              <1> 	mov	dx, 8080h
  3162 00001451 49                  <1> 	dec	cx
  3163 00001452 7402                <1> 	jz	short lff44s_2_1 
  3164 00001454 8B14                <1> 	mov	dx, [si]
  3165                              <1> lff44s_2_1:	
  3166                              <1> 	; al = [previous_val_l]
  3167                              <1> 	; ah = [previous_val_r]
  3168                              <1> 	; dl = [next_val_l]
  3169                              <1> 	; dl = [next_val_r]	
  3170 00001456 E85F01              <1> 	call	interpolating_2_8bit_stereo
  3171 00001459 E3BB                <1> 	jcxz	lff44s_3
  3172                              <1> lff44s_2_2:
  3173 0000145B AC                  <1> 	lodsb
  3174 0000145C 2C80                <1> 	sub	al, 80h
  3175 0000145E C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3176 00001461 AB                  <1> 	stosw		; (L)
  3177 00001462 AC                  <1> 	lodsb
  3178 00001463 2C80                <1> 	sub	al, 80h
  3179 00001465 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3180 00001468 AB                  <1> 	stosw		; (R)
  3181                              <1> 
  3182 00001469 49                  <1> 	dec	cx
  3183 0000146A 74AA                <1> 	jz	short lff44s_3	
  3184 0000146C 4D                  <1> 	dec	bp
  3185 0000146D 75EC                <1> 	jnz	short lff44s_2_2
  3186                              <1> 	
  3187 0000146F FE0E[6919]          <1> 	dec	byte [faz]
  3188 00001473 74D0                <1> 	jz	short lff44s_9 
  3189 00001475 BD0B00              <1> 	mov	bp, 11
  3190 00001478 EBD3                <1> 	jmp	short lff44s_1
  3191                              <1> 
  3192                              <1> load_44khz_mono_16_bit:
  3193                              <1> 	; 18/11/2023
  3194 0000147A F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3195                              <1> 					; last of the file?
  3196 0000147F 7402                <1> 	jz	short lff44m2_0		; no
  3197 00001481 F9                  <1> 	stc
  3198 00001482 C3                  <1> 	retn
  3199                              <1> 
  3200                              <1> lff44m2_0:
  3201 00001483 8EC0                <1> 	mov	es, ax ; buffer segment	
  3202 00001485 31FF                <1> 	xor	di, di
  3203 00001487 BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3204                              <1> 	; ds = cs
  3205                              <1> 
  3206                              <1> 	; load file into memory
  3207 0000148A 8B0E[6906]          <1>         mov	cx, [loadsize]
  3208 0000148E 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  3209 00001492 B43F                <1>        	mov	ah, 3Fh
  3210 00001494 CD21                <1> 	int	21h
  3211 00001496 7237                <1> 	jc	short lff44m2_7 ; error !
  3212                              <1> 
  3213 00001498 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3214                              <1> 	
  3215 0000149A D1E8                <1> 	shr	ax, 1
  3216                              <1> 	;and	ax, ax
  3217 0000149C 7503                <1> 	jnz	short lff44m2_8
  3218 0000149E E968F4              <1> 	jmp	lff44_eof
  3219                              <1> 
  3220                              <1> lff44m2_8:
  3221 000014A1 89C1                <1> 	mov	cx, ax		; word count
  3222                              <1> lff44m2_9:
  3223 000014A3 BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3224 000014A6 C606[6919]02        <1> 	mov	byte [faz], 2  ; 2 steps/phases
  3225                              <1> lff44m2_1:
  3226                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3227                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3228 000014AB AD                  <1> 	lodsw
  3229 000014AC 31D2                <1> 	xor	dx, dx
  3230 000014AE 49                  <1> 	dec	cx
  3231 000014AF 7402                <1> 	jz	short lff44m2_2_1
  3232 000014B1 8B14                <1> 	mov	dx, [si]
  3233                              <1> lff44m2_2_1:	
  3234                              <1> 	; ax = [previous_val]
  3235                              <1> 	; dx = [next_val]
  3236 000014B3 E89801              <1> 	call	interpolating_2_16bit_mono
  3237 000014B6 E314                <1> 	jcxz	lff44m2_3
  3238                              <1> lff44m2_2_2:
  3239 000014B8 AD                  <1> 	lodsw
  3240 000014B9 AB                  <1> 	stosw		; (L)eft Channel
  3241 000014BA AB                  <1> 	stosw		; (R)ight Channel
  3242                              <1> 
  3243 000014BB 49                  <1> 	dec	cx
  3244 000014BC 740E                <1> 	jz	short lff44m2_3	
  3245 000014BE 4D                  <1> 	dec	bp
  3246 000014BF 75F7                <1> 	jnz	short lff44m2_2_2
  3247                              <1> 	
  3248 000014C1 FE0E[6919]          <1> 	dec	byte [faz]
  3249 000014C5 74DC                <1> 	jz	short lff44m2_9 
  3250 000014C7 BD0B00              <1> 	mov	bp, 11
  3251 000014CA EBDF                <1> 	jmp	short lff44m2_1
  3252                              <1> 
  3253                              <1> lff44m2_3:
  3254                              <1> lff44s2_3:
  3255 000014CC E927F4              <1> 	jmp	lff44_3	; padfill
  3256                              <1> 		; (put zeros in the remain words of the buffer)
  3257                              <1> lff44m2_7:
  3258                              <1> lff44s2_7:
  3259 000014CF E93EF4              <1> 	jmp	lff44_5  ; error
  3260                              <1> 
  3261                              <1> load_44khz_stereo_16_bit:
  3262                              <1> 	; 18/11/2023
  3263 000014D2 F606[C21D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3264                              <1> 					; last of the file?
  3265 000014D7 7402                <1> 	jz	short lff44s2_0		; no
  3266 000014D9 F9                  <1> 	stc
  3267 000014DA C3                  <1> 	retn
  3268                              <1> 
  3269                              <1> lff44s2_0:
  3270 000014DB 8EC0                <1> 	mov	es, ax ; buffer segment	
  3271 000014DD 31FF                <1> 	xor	di, di
  3272 000014DF BA[E81D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3273                              <1> 	; ds = cs
  3274                              <1> 
  3275                              <1> 	; load file into memory
  3276 000014E2 8B0E[6906]          <1>         mov	cx, [loadsize]
  3277 000014E6 8B1E[C01D]          <1> 	mov	bx, [filehandle]
  3278 000014EA B43F                <1>        	mov	ah, 3Fh
  3279 000014EC CD21                <1> 	int	21h
  3280 000014EE 72DF                <1> 	jc	short lff44s2_7 ; error !
  3281                              <1> 
  3282 000014F0 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3283                              <1> 	
  3284 000014F2 C1E802              <1> 	shr	ax, 2	; dword (left chan word + right chan word)
  3285                              <1> 	;and	ax, ax
  3286 000014F5 7503                <1> 	jnz	short lff44s2_8
  3287 000014F7 E90FF4              <1> 	jmp	lff44_eof
  3288                              <1> 
  3289                              <1> lff44s2_8:
  3290 000014FA 89C1                <1> 	mov	cx, ax		; dword count
  3291                              <1> lff44s2_9:
  3292 000014FC BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3293 000014FF C606[6919]02        <1> 	mov	byte [faz], 2  ; 2 steps/phase
  3294                              <1> lff44s2_1:
  3295                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3296                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3297 00001504 AD                  <1> 	lodsw
  3298 00001505 89C3                <1> 	mov	bx, ax
  3299 00001507 AD                  <1> 	lodsw
  3300 00001508 8B14                <1> 	mov	dx, [si]
  3301 0000150A 8916[6519]          <1> 	mov	[next_val_l], dx
  3302 0000150E 8B5402              <1> 	mov	dx, [si+2]
  3303 00001511 49                  <1> 	dec	cx
  3304 00001512 7506                <1> 	jnz	short lff44s2_2_1
  3305 00001514 31D2                <1> 	xor	dx, dx ; 0
  3306 00001516 8916[6519]          <1> 	mov	[next_val_l], dx
  3307                              <1> lff44s2_2_1:
  3308                              <1> 	; bx = [previous_val_l]
  3309                              <1> 	; ax = [previous_val_r]
  3310                              <1> 	; [next_val_l]
  3311                              <1> 	; dx = [next_val_r]
  3312 0000151A E84301              <1> 	call	interpolating_2_16bit_stereo
  3313 0000151D E3AD                <1> 	jcxz	lff44s2_3
  3314                              <1> lff44s2_2_2:
  3315                              <1> 	;lodsw
  3316                              <1> 	;stosw		; (L)
  3317                              <1> 	;lodsw
  3318                              <1> 	;stosw		; (R)
  3319 0000151F A5                  <1> 	movsw		; (L)eft Channel
  3320 00001520 A5                  <1> 	movsw		; (R)ight Channel
  3321                              <1> 
  3322 00001521 49                  <1> 	dec	cx
  3323 00001522 74A8                <1> 	jz	short lff44s2_3	
  3324 00001524 4D                  <1> 	dec	bp
  3325 00001525 75F8                <1> 	jnz	short lff44s2_2_2
  3326                              <1> 	
  3327 00001527 FE0E[6919]          <1> 	dec	byte [faz]
  3328 0000152B 74CF                <1> 	jz	short lff44s2_9 
  3329 0000152D BD0B00              <1> 	mov	bp, 11
  3330 00001530 EBD2                <1> 	jmp	short lff44s2_1
  3331                              <1> 
  3332                              <1> ; .....................
  3333                              <1> 
  3334                              <1> interpolating_3_8bit_mono:
  3335                              <1> 	; 16/11/2023
  3336                              <1> 	; al = [previous_val]
  3337                              <1> 	; dl = [next_val]
  3338                              <1> 	; original-interpolated-interpolated
  3339 00001532 88C3                <1> 	mov	bl, al
  3340 00001534 2C80                <1> 	sub	al, 80h
  3341 00001536 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3342 00001539 AB                  <1> 	stosw		; original sample (L)
  3343 0000153A AB                  <1> 	stosw		; original sample (R)
  3344 0000153B 88D8                <1> 	mov	al, bl
  3345 0000153D 00D0                <1> 	add	al, dl	
  3346 0000153F D0D8                <1> 	rcr	al, 1
  3347 00001541 88C7                <1> 	mov	bh, al	; interpolated middle (temporary)
  3348 00001543 00D8                <1> 	add	al, bl
  3349 00001545 D0D8                <1> 	rcr	al, 1
  3350 00001547 2C80                <1> 	sub	al, 80h
  3351 00001549 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3352 0000154C AB                  <1> 	stosw		; interpolated sample 1 (L)
  3353 0000154D AB                  <1> 	stosw		; interpolated sample 1 (R)
  3354 0000154E 88F8                <1> 	mov	al, bh
  3355 00001550 00D0                <1> 	add	al, dl	; [next_val]
  3356 00001552 D0D8                <1> 	rcr	al, 1
  3357 00001554 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3358 00001557 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3359 00001558 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3360 00001559 C3                  <1> 	retn
  3361                              <1> 
  3362                              <1> interpolating_3_8bit_stereo:
  3363                              <1> 	; 16/11/2023
  3364                              <1> 	; al = [previous_val_l]
  3365                              <1> 	; ah = [previous_val_r]
  3366                              <1> 	; dl = [next_val_l]
  3367                              <1> 	; dh = [next_val_r]	
  3368                              <1> 	; original-interpolated-interpolated
  3369 0000155A 89C3                <1> 	mov	bx, ax
  3370 0000155C 2C80                <1> 	sub	al, 80h
  3371 0000155E C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3372 00001561 AB                  <1> 	stosw		; original sample (L)
  3373 00001562 88F8                <1> 	mov	al, bh
  3374 00001564 2C80                <1> 	sub	al, 80h
  3375 00001566 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3376 00001569 AB                  <1> 	stosw		; original sample (R)
  3377 0000156A 88D8                <1> 	mov	al, bl
  3378 0000156C 00D0                <1> 	add	al, dl	; [next_val_l]	
  3379 0000156E D0D8                <1> 	rcr	al, 1
  3380 00001570 50                  <1> 	push	ax ; *	; al = interpolated middle (L) (temporary)
  3381 00001571 00D8                <1> 	add	al, bl	; [previous_val_l]
  3382 00001573 D0D8                <1> 	rcr	al, 1
  3383 00001575 2C80                <1> 	sub	al, 80h
  3384 00001577 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3385 0000157A AB                  <1> 	stosw		; interpolated sample 1 (L)
  3386 0000157B 88F8                <1> 	mov	al, bh
  3387 0000157D 00F0                <1> 	add	al, dh	; [next_val_r]
  3388 0000157F D0D8                <1> 	rcr	al, 1
  3389 00001581 50                  <1> 	push	ax ; ** ; al = interpolated middle (R) (temporary)
  3390 00001582 00F8                <1> 	add	al, bh	; [previous_val_r]
  3391 00001584 D0D8                <1> 	rcr	al, 1
  3392 00001586 2C80                <1> 	sub	al, 80h
  3393 00001588 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3394 0000158B AB                  <1> 	stosw		; interpolated sample 1 (R)
  3395 0000158C 5B                  <1> 	pop	bx ; **
  3396 0000158D 58                  <1> 	pop	ax ; *
  3397 0000158E 00D0                <1> 	add	al, dl	; [next_val_l]
  3398 00001590 D0D8                <1> 	rcr	al, 1
  3399 00001592 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3400 00001595 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3401 00001596 88D8                <1> 	mov	al, bl
  3402 00001598 00F0                <1> 	add	al, dh	; [next_val_r]
  3403 0000159A D0D8                <1> 	rcr	al, 1
  3404 0000159C C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3405 0000159F AB                  <1> 	stosw		; interpolated sample 2 (R)
  3406 000015A0 C3                  <1> 	retn
  3407                              <1> 
  3408                              <1> interpolating_2_8bit_mono:
  3409                              <1> 	; 16/11/2023
  3410                              <1> 	; al = [previous_val]
  3411                              <1> 	; dl = [next_val]
  3412                              <1> 	; original-interpolated
  3413 000015A1 88C3                <1> 	mov	bl, al
  3414 000015A3 2C80                <1> 	sub	al, 80h
  3415 000015A5 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3416 000015A8 AB                  <1> 	stosw		; original sample (L)
  3417 000015A9 AB                  <1> 	stosw		; original sample (R)
  3418 000015AA 88D8                <1> 	mov	al, bl
  3419 000015AC 00D0                <1> 	add	al, dl	
  3420 000015AE D0D8                <1> 	rcr	al, 1
  3421 000015B0 2C80                <1> 	sub	al, 80h
  3422 000015B2 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3423 000015B5 AB                  <1> 	stosw		; interpolated sample (L)
  3424 000015B6 AB                  <1> 	stosw		; interpolated sample (R)
  3425 000015B7 C3                  <1> 	retn
  3426                              <1> 
  3427                              <1> interpolating_2_8bit_stereo:
  3428                              <1> 	; 16/11/2023
  3429                              <1> 	; al = [previous_val_l]
  3430                              <1> 	; ah = [previous_val_r]
  3431                              <1> 	; dl = [next_val_l]
  3432                              <1> 	; dh = [next_val_r]	
  3433                              <1> 	; original-interpolated
  3434 000015B8 89C3                <1> 	mov	bx, ax
  3435 000015BA 2C80                <1> 	sub	al, 80h
  3436 000015BC C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3437 000015BF AB                  <1> 	stosw		; original sample (L)
  3438 000015C0 88F8                <1> 	mov	al, bh
  3439 000015C2 2C80                <1> 	sub	al, 80h
  3440 000015C4 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3441 000015C7 AB                  <1> 	stosw		; original sample (R)
  3442 000015C8 88D8                <1> 	mov	al, bl	; [previous_val_l]
  3443 000015CA 00D0                <1> 	add	al, dl	; [next_val_l]	
  3444 000015CC D0D8                <1> 	rcr	al, 1
  3445 000015CE 2C80                <1> 	sub	al, 80h
  3446 000015D0 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3447 000015D3 AB                  <1> 	stosw		; interpolated sample (L)
  3448 000015D4 88F8                <1> 	mov	al, bh
  3449 000015D6 00F0                <1> 	add	al, dh	; [next_val_r]
  3450 000015D8 D0D8                <1> 	rcr	al, 1
  3451 000015DA 2C80                <1> 	sub	al, 80h
  3452 000015DC C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3453 000015DF AB                  <1> 	stosw		; interpolated sample (R)
  3454 000015E0 C3                  <1> 	retn
  3455                              <1> 
  3456                              <1> interpolating_3_16bit_mono:
  3457                              <1> 	; 16/11/2023
  3458                              <1> 	; ax = [previous_val]
  3459                              <1> 	; dx = [next_val]
  3460                              <1> 	; original-interpolated-interpolated
  3461                              <1> 
  3462 000015E1 AB                  <1> 	stosw		; original sample (L)
  3463 000015E2 AB                  <1> 	stosw		; original sample (R)
  3464 000015E3 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3465 000015E6 50                  <1> 	push	ax ; *	; [previous_val]
  3466 000015E7 80C680              <1> 	add	dh, 80h
  3467 000015EA 01D0                <1> 	add	ax, dx
  3468 000015EC D1D8                <1> 	rcr	ax, 1
  3469 000015EE 5B                  <1> 	pop	bx ; *		
  3470 000015EF 93                  <1> 	xchg	bx, ax	; bx  = interpolated middle (temporary)
  3471 000015F0 01D8                <1> 	add	ax, bx	; [previous_val] + interpolated middle
  3472 000015F2 D1D8                <1> 	rcr	ax, 1
  3473 000015F4 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3474 000015F7 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3475 000015F8 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3476 000015F9 89D8                <1> 	mov	ax, bx
  3477 000015FB 01D0                <1> 	add	ax, dx	 ;interpolated middle + [next_val]
  3478 000015FD D1D8                <1> 	rcr	ax, 1
  3479 000015FF 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3480 00001602 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3481 00001603 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3482 00001604 C3                  <1> 	retn
  3483                              <1> 
  3484                              <1> interpolating_3_16bit_stereo:
  3485                              <1> 	; 16/11/2023
  3486                              <1> 	; bx = [previous_val_l]
  3487                              <1> 	; ax = [previous_val_r]
  3488                              <1> 	; [next_val_l]
  3489                              <1> 	; dx = [next_val_r]
  3490                              <1> 	; original-interpolated-interpolated
  3491                              <1> 
  3492 00001605 93                  <1> 	xchg	ax, bx
  3493 00001606 AB                  <1> 	stosw		; original sample (L)
  3494 00001607 93                  <1> 	xchg	ax, bx
  3495 00001608 AB                  <1> 	stosw		; original sample (R)
  3496 00001609 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3497 0000160C 50                  <1> 	push	ax ; *	; [previous_val_r]
  3498 0000160D 80C780              <1> 	add	bh, 80h
  3499 00001610 8006[6619]80        <1> 	add	byte [next_val_l+1], 80h
  3500 00001615 A1[6519]            <1> 	mov	ax, [next_val_l]
  3501 00001618 01D8                <1> 	add	ax, bx	; [previous_val_l]
  3502 0000161A D1D8                <1> 	rcr	ax, 1
  3503 0000161C 93                  <1> 	xchg	ax, bx	; ax = [previous_val_l]	
  3504 0000161D 01D8                <1> 	add	ax, bx	; bx = interpolated middle (L)
  3505 0000161F D1D8                <1> 	rcr	ax, 1
  3506 00001621 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3507 00001624 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3508 00001625 58                  <1> 	pop	ax  ; *
  3509 00001626 80C680              <1> 	add	dh, 80h ; convert sound level 0 to 65535 format
  3510 00001629 52                  <1> 	push	dx  ; * ; [next_val_r]
  3511 0000162A 92                  <1> 	xchg	ax, dx
  3512 0000162B 01D0                <1> 	add	ax, dx	; [next_val_r] + [previous_val_r]
  3513 0000162D D1D8                <1> 	rcr	ax, 1	; / 2
  3514 0000162F 50                  <1> 	push	ax ; ** ; interpolated middle (R)
  3515 00001630 01D0                <1> 	add	ax, dx	; + [previous_val_r]
  3516 00001632 D1D8                <1> 	rcr	ax, 1
  3517 00001634 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3518 00001637 AB                  <1> 	stosw 		; interpolated sample 1 (R)
  3519 00001638 A1[6519]            <1> 	mov	ax, [next_val_l]
  3520 0000163B 01D8                <1> 	add	ax, bx	; + interpolated middle (L)
  3521 0000163D D1D8                <1> 	rcr	ax, 1
  3522 0000163F 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3523 00001642 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  3524 00001643 58                  <1> 	pop	ax ; **
  3525 00001644 5A                  <1> 	pop	dx ; *	
  3526 00001645 01D0                <1> 	add	ax, dx	; interpolated middle + [next_val_r]
  3527 00001647 D1D8                <1> 	rcr	ax, 1	; / 2
  3528 00001649 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3529 0000164C AB                  <1> 	stosw 		; interpolated sample 2 (L)
  3530 0000164D C3                  <1> 	retn
  3531                              <1> 
  3532                              <1> interpolating_2_16bit_mono:
  3533                              <1> 	; 16/11/2023
  3534                              <1> 	; ax = [previous_val]
  3535                              <1> 	; dx = [next_val]
  3536                              <1> 	; original-interpolated
  3537                              <1> 
  3538 0000164E AB                  <1> 	stosw		; original sample (L)
  3539 0000164F AB                  <1> 	stosw		; original sample (R)
  3540 00001650 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3541 00001653 80C680              <1> 	add	dh, 80h
  3542 00001656 01D0                <1> 	add	ax, dx
  3543 00001658 D1D8                <1> 	rcr	ax, 1
  3544 0000165A 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3545 0000165D AB                  <1> 	stosw		; interpolated sample (L)
  3546 0000165E AB                  <1> 	stosw		; interpolated sample (R)
  3547 0000165F C3                  <1> 	retn
  3548                              <1> 
  3549                              <1> interpolating_2_16bit_stereo:
  3550                              <1> 	; 16/11/2023
  3551                              <1> 	; bx = [previous_val_l]
  3552                              <1> 	; ax = [previous_val_r]
  3553                              <1> 	; [next_val_l]
  3554                              <1> 	; dx = [next_val_r]
  3555                              <1> 	; original-interpolated
  3556                              <1> 
  3557 00001660 93                  <1> 	xchg	ax, bx
  3558 00001661 AB                  <1> 	stosw		; original sample (L)
  3559 00001662 93                  <1> 	xchg	ax, bx
  3560 00001663 AB                  <1> 	stosw		; original sample (R)
  3561 00001664 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3562 00001667 80C680              <1> 	add	dh, 80h
  3563 0000166A 01D0                <1> 	add	ax, dx	; [previous_val_r] + [next_val_r]
  3564 0000166C D1D8                <1> 	rcr	ax, 1	; / 2
  3565 0000166E 50                  <1> 	push	ax ; *	; interpolated sample (R)
  3566 0000166F A1[6519]            <1> 	mov	ax, [next_val_l]
  3567 00001672 80C480              <1> 	add	ah, 80h
  3568 00001675 80C780              <1> 	add	bh, 80h
  3569 00001678 01D8                <1> 	add	ax, bx	; [next_val_l] + [previous_val_l]
  3570 0000167A D1D8                <1> 	rcr	ax, 1	; / 2		
  3571 0000167C 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3572 0000167F AB                  <1> 	stosw 		; interpolated sample (L)
  3573 00001680 58                  <1> 	pop	ax ; *	
  3574 00001681 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3575 00001684 AB                  <1> 	stosw 		; interpolated sample (R)
  3576 00001685 C3                  <1> 	retn
  3577                              <1> 
  3578                              <1> interpolating_5_8bit_mono:
  3579                              <1> 	; 17/11/2023
  3580                              <1> 	; al = [previous_val]
  3581                              <1> 	; dl = [next_val]
  3582                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  3583 00001686 88C3                <1> 	mov	bl, al
  3584 00001688 2C80                <1> 	sub	al, 80h
  3585 0000168A C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3586 0000168D AB                  <1> 	stosw		; original sample (L)
  3587 0000168E AB                  <1> 	stosw		; original sample (R)
  3588 0000168F 88D8                <1> 	mov	al, bl
  3589 00001691 00D0                <1> 	add	al, dl	
  3590 00001693 D0D8                <1> 	rcr	al, 1
  3591 00001695 88C7                <1> 	mov	bh, al	; interpolated middle (temporary)
  3592 00001697 00D8                <1> 	add	al, bl  ; [previous_val]
  3593 00001699 D0D8                <1> 	rcr	al, 1 	
  3594 0000169B 88C6                <1> 	mov	dh, al	; interpolated 1st quarter (temporary)
  3595 0000169D 00D8                <1> 	add	al, bl
  3596 0000169F D0D8                <1> 	rcr	al, 1
  3597 000016A1 2C80                <1> 	sub	al, 80h
  3598 000016A3 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3599 000016A6 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3600 000016A7 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3601 000016A8 88F8                <1> 	mov	al, bh
  3602 000016AA 00F0                <1> 	add	al, dh
  3603 000016AC D0D8                <1> 	rcr	al, 1
  3604 000016AE 2C80                <1> 	sub	al, 80h
  3605 000016B0 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3606 000016B3 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3607 000016B4 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3608 000016B5 88F8                <1> 	mov	al, bh
  3609 000016B7 00D0                <1> 	add	al, dl	; [next_val]
  3610 000016B9 D0D8                <1> 	rcr	al, 1
  3611 000016BB 88C6                <1> 	mov	dh, al	; interpolated 3rd quarter (temporary)
  3612 000016BD 00F8                <1> 	add	al, bh
  3613 000016BF D0D8                <1> 	rcr	al, 1
  3614 000016C1 2C80                <1> 	sub	al, 80h
  3615 000016C3 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3616 000016C6 AB                  <1> 	stosw		; interpolated sample 3 (L)
  3617 000016C7 AB                  <1> 	stosw		; interpolated sample 3 (R)
  3618 000016C8 88F0                <1> 	mov	al, dh
  3619 000016CA 00D0                <1> 	add	al, dl
  3620 000016CC D0D8                <1> 	rcr	al, 1
  3621 000016CE 2C80                <1> 	sub	al, 80h
  3622 000016D0 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3623 000016D3 AB                  <1> 	stosw		; interpolated sample 4 (L)
  3624 000016D4 AB                  <1> 	stosw		; interpolated sample 4 (R)
  3625 000016D5 C3                  <1> 	retn
  3626                              <1> 
  3627                              <1> interpolating_5_8bit_stereo:
  3628                              <1> 	; 17/11/2023
  3629                              <1> 	; al = [previous_val_l]
  3630                              <1> 	; ah = [previous_val_r]
  3631                              <1> 	; dl = [next_val_l]
  3632                              <1> 	; dh = [next_val_r]	
  3633                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  3634 000016D6 89C3                <1> 	mov	bx, ax
  3635 000016D8 2C80                <1> 	sub	al, 80h
  3636 000016DA C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3637 000016DD AB                  <1> 	stosw		; original sample (L)
  3638 000016DE 88F8                <1> 	mov	al, bh
  3639 000016E0 2C80                <1> 	sub	al, 80h
  3640 000016E2 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3641 000016E5 AB                  <1> 	stosw		; original sample (R)
  3642 000016E6 52                  <1> 	push	dx ; *
  3643 000016E7 88D8                <1> 	mov	al, bl
  3644 000016E9 00D0                <1> 	add	al, dl	; [next_val_l]
  3645 000016EB D0D8                <1> 	rcr	al, 1
  3646 000016ED 50                  <1> 	push	ax ; **	; al = interpolated middle (L) (temporary)
  3647 000016EE 00D8                <1> 	add	al, bl	; [previous_val_l]
  3648 000016F0 D0D8                <1> 	rcr	al, 1
  3649 000016F2 86C3                <1> 	xchg	al, bl	
  3650 000016F4 00D8                <1> 	add	al, bl	; bl = interpolated 1st quarter (L) (temp)
  3651 000016F6 D0D8                <1> 	rcr	al, 1
  3652 000016F8 2C80                <1> 	sub	al, 80h
  3653 000016FA C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3654 000016FD AB                  <1> 	stosw		; interpolated sample 1 (L)
  3655 000016FE 88F8                <1> 	mov	al, bh
  3656 00001700 00F0                <1> 	add	al, dh	; [next_val_r]
  3657 00001702 D0D8                <1> 	rcr	al, 1
  3658 00001704 50                  <1> 	push	ax ; *** ; al = interpolated middle (R) (temporary)
  3659 00001705 00F8                <1> 	add	al, bh	; [previous_val_r]
  3660 00001707 D0D8                <1> 	rcr	al, 1
  3661 00001709 86C7                <1> 	xchg	al, bh	
  3662 0000170B 00F8                <1> 	add	al, bh	; bh = interpolated 1st quarter (R) (temp)
  3663 0000170D D0D8                <1> 	rcr	al, 1
  3664 0000170F 2C80                <1> 	sub	al, 80h
  3665 00001711 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3666 00001714 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3667 00001715 5A                  <1> 	pop	dx ; ***
  3668 00001716 58                  <1> 	pop	ax ; **	; al = interpolated middle (L) (temporary)
  3669 00001717 86C3                <1> 	xchg	al, bl	; al = interpolated 1st quarter (L) (temp)
  3670 00001719 00D8                <1> 	add	al, bl	; bl = interpolated middle (L) (temporary)
  3671 0000171B D0D8                <1> 	rcr	al, 1
  3672 0000171D 2C80                <1> 	sub	al, 80h
  3673 0000171F C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3674 00001722 AB                  <1> 	stosw		; interpolated sample 2 (L)	
  3675 00001723 88D0                <1> 	mov	al, dl 	; interpolated middle (R) (temporary)
  3676 00001725 86C7                <1> 	xchg	al, bh	; al = interpolated 1st quarter (R) (temp)
  3677 00001727 00F8                <1> 	add	al, bh	; bh = interpolated middle (R) (temporary)
  3678 00001729 D0D8                <1> 	rcr	al, 1
  3679 0000172B 2C80                <1> 	sub	al, 80h
  3680 0000172D C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3681 00001730 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3682 00001731 5A                  <1> 	pop	dx ; *
  3683 00001732 88D8                <1> 	mov	al, bl	; interpolated middle (L) (temporary)
  3684 00001734 00D0                <1> 	add	al, dl	; [next_val_l]
  3685 00001736 D0D8                <1> 	rcr	al, 1
  3686 00001738 86C3                <1> 	xchg	al, bl	; al = interpolated middle (R) (temporary)	
  3687 0000173A 00D8                <1> 	add	al, bl	; bl = interpolated 3rd quarter (L) (temp) 
  3688 0000173C D0D8                <1> 	rcr	al, 1
  3689 0000173E 2C80                <1> 	sub	al, 80h
  3690 00001740 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3691 00001743 AB                  <1> 	stosw		; interpolated sample 3 (L)
  3692 00001744 88F8                <1> 	mov	al, bh	
  3693 00001746 00F0                <1> 	add	al, dh	; interpolated middle (R) + [next_val_r]
  3694 00001748 D0D8                <1> 	rcr	al, 1
  3695 0000174A 86C7                <1> 	xchg	al, bh	; al = interpolated middle (R)
  3696 0000174C 00F8                <1> 	add	al, bh	; bh = interpolated 3rd quarter (R) (temp)
  3697 0000174E D0D8                <1> 	rcr	al, 1
  3698 00001750 2C80                <1> 	sub	al, 80h
  3699 00001752 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3700 00001755 AB                  <1> 	stosw		; interpolated sample 3 (R)
  3701 00001756 88D8                <1> 	mov	al, bl
  3702 00001758 00D0                <1> 	add	al, dl	; [next_val_l]
  3703 0000175A D0D8                <1> 	rcr	al, 1
  3704 0000175C 2C80                <1> 	sub	al, 80h
  3705 0000175E C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3706 00001761 AB                  <1> 	stosw		; interpolated sample 4 (L)
  3707 00001762 88F8                <1> 	mov	al, bh
  3708 00001764 00F0                <1> 	add	al, dh	; [next_val_r]
  3709 00001766 D0D8                <1> 	rcr	al, 1
  3710 00001768 2C80                <1> 	sub	al, 80h
  3711 0000176A C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3712 0000176D AB                  <1> 	stosw		; interpolated sample 4 (R)
  3713 0000176E C3                  <1> 	retn
  3714                              <1> 
  3715                              <1> interpolating_4_8bit_mono:
  3716                              <1> 	; 17/11/2023
  3717                              <1> 	; al = [previous_val]
  3718                              <1> 	; dl = [next_val]
  3719                              <1> 	; original-interpolated-interpolated-interpolated
  3720 0000176F 88C3                <1> 	mov	bl, al
  3721 00001771 2C80                <1> 	sub	al, 80h
  3722 00001773 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3723 00001776 AB                  <1> 	stosw		; original sample (L)
  3724 00001777 AB                  <1> 	stosw		; original sample (R)
  3725 00001778 88D8                <1> 	mov	al, bl
  3726 0000177A 00D0                <1> 	add	al, dl	
  3727 0000177C D0D8                <1> 	rcr	al, 1
  3728 0000177E 86C3                <1> 	xchg	al, bl  ; al = [previous_val]
  3729 00001780 00D8                <1> 	add	al, bl	; bl = interpolated middle (sample 2)
  3730 00001782 D0D8                <1> 	rcr	al, 1 	
  3731 00001784 2C80                <1> 	sub	al, 80h
  3732 00001786 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3733 00001789 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3734 0000178A AB                  <1> 	stosw		; interpolated sample 1 (R)
  3735 0000178B 88D8                <1> 	mov	al, bl	; interpolated middle (sample 2)
  3736 0000178D 2C80                <1> 	sub	al, 80h
  3737 0000178F C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3738 00001792 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3739 00001793 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3740 00001794 88D8                <1> 	mov	al, bl
  3741 00001796 00D0                <1> 	add	al, dl	; [next_val]
  3742 00001798 D0D8                <1> 	rcr	al, 1
  3743 0000179A 2C80                <1> 	sub	al, 80h
  3744 0000179C C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3745 0000179F AB                  <1> 	stosw		; interpolated sample 3 (L)
  3746 000017A0 AB                  <1> 	stosw		; interpolated sample 3 (R)
  3747 000017A1 C3                  <1> 	retn
  3748                              <1> 
  3749                              <1> interpolating_4_8bit_stereo:
  3750                              <1> 	; 17/11/2023
  3751                              <1> 	; al = [previous_val_l]
  3752                              <1> 	; ah = [previous_val_r]
  3753                              <1> 	; dl = [next_val_l]
  3754                              <1> 	; dh = [next_val_r]	
  3755                              <1> 	; original-interpolated-interpolated-interpolated
  3756 000017A2 89C3                <1> 	mov	bx, ax
  3757 000017A4 2C80                <1> 	sub	al, 80h
  3758 000017A6 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3759 000017A9 AB                  <1> 	stosw		; original sample (L)
  3760 000017AA 88F8                <1> 	mov	al, bh
  3761 000017AC 2C80                <1> 	sub	al, 80h
  3762 000017AE C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3763 000017B1 AB                  <1> 	stosw		; original sample (R)
  3764 000017B2 88D8                <1> 	mov	al, bl
  3765 000017B4 00D0                <1> 	add	al, dl	; [next_val_l]
  3766 000017B6 D0D8                <1> 	rcr	al, 1
  3767 000017B8 86C3                <1> 	xchg	al, bl	; al = [previous_val_l]
  3768 000017BA 00D8                <1> 	add	al, bl	; bl = interpolated middle (L) (sample 2)
  3769 000017BC D0D8                <1> 	rcr	al, 1
  3770 000017BE 2C80                <1> 	sub	al, 80h
  3771 000017C0 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3772 000017C3 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3773 000017C4 88F8                <1> 	mov	al, bh
  3774 000017C6 00F0                <1> 	add	al, dh	; [next_val_r]
  3775 000017C8 D0D8                <1> 	rcr	al, 1
  3776 000017CA 86C7                <1> 	xchg	al, bh	; al = [previous_val_h]
  3777 000017CC 00F8                <1> 	add	al, bh	; bh = interpolated middle (R) (sample 2)
  3778 000017CE D0D8                <1> 	rcr	al, 1
  3779 000017D0 2C80                <1> 	sub	al, 80h
  3780 000017D2 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3781 000017D5 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3782 000017D6 88D8                <1> 	mov	al, bl	; interpolated middle (L) (sample 2)
  3783 000017D8 2C80                <1> 	sub	al, 80h
  3784 000017DA C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3785 000017DD AB                  <1> 	stosw		; interpolated sample 2 (L)
  3786 000017DE 88F8                <1> 	mov	al, bh	; interpolated middle (L) (sample 2)
  3787 000017E0 2C80                <1> 	sub	al, 80h
  3788 000017E2 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3789 000017E5 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3790 000017E6 88D8                <1> 	mov	al, bl
  3791 000017E8 00D0                <1> 	add	al, dl	; [next_val_l]
  3792 000017EA D0D8                <1> 	rcr	al, 1
  3793 000017EC 2C80                <1> 	sub	al, 80h
  3794 000017EE C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3795 000017F1 AB                  <1> 	stosw		; interpolated sample 3 (L)
  3796 000017F2 88F8                <1> 	mov	al, bh
  3797 000017F4 00F0                <1> 	add	al, dh	; [next_val_r]
  3798 000017F6 D0D8                <1> 	rcr	al, 1
  3799 000017F8 2C80                <1> 	sub	al, 80h
  3800 000017FA C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3801 000017FD AB                  <1> 	stosw		; interpolated sample 3 (R)
  3802 000017FE C3                  <1> 	retn
  3803                              <1> 
  3804                              <1> interpolating_5_16bit_mono:
  3805                              <1> 	; 18/11/2023
  3806                              <1> 	; ax = [previous_val]
  3807                              <1> 	; dx = [next_val]
  3808                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  3809 000017FF AB                  <1> 	stosw		; original sample (L)
  3810 00001800 AB                  <1> 	stosw		; original sample (R)
  3811 00001801 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3812 00001804 89C3                <1> 	mov	bx, ax	; [previous_val]
  3813 00001806 80C680              <1> 	add	dh, 80h
  3814 00001809 01D0                <1> 	add	ax, dx
  3815 0000180B D1D8                <1> 	rcr	ax, 1
  3816 0000180D 50                  <1> 	push	ax ; *	; interpolated middle (temporary)
  3817 0000180E 01D8                <1> 	add	ax, bx	; interpolated middle + [previous_val] 
  3818 00001810 D1D8                <1> 	rcr	ax, 1
  3819 00001812 50                  <1> 	push	ax ; **	; interpolated 1st quarter (temporary)
  3820 00001813 01D8                <1> 	add	ax, bx	; 1st quarter + [previous_val]
  3821 00001815 D1D8                <1> 	rcr	ax, 1	
  3822 00001817 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3823 0000181A AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3824 0000181B AB                  <1> 	stosw		; interpolated sample 1 (R)
  3825 0000181C 58                  <1> 	pop	ax ; **	
  3826 0000181D 5B                  <1> 	pop	bx ; *
  3827 0000181E 01D8                <1> 	add	ax, bx	; 1st quarter + middle
  3828 00001820 D1D8                <1> 	rcr	ax, 1	; / 2
  3829 00001822 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again	
  3830 00001825 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3831 00001826 AB                  <1> 	stosw		; interpolated sample 2 (R)		
  3832 00001827 89D8                <1> 	mov	ax, bx
  3833 00001829 01D0                <1> 	add	ax, dx	; interpolated middle + [next_val]
  3834 0000182B D1D8                <1> 	rcr	ax, 1
  3835 0000182D 50                  <1> 	push	ax ; *	; interpolated 3rd quarter (temporary)
  3836 0000182E 01D8                <1> 	add	ax, bx	; + interpolated middle
  3837 00001830 D1D8                <1> 	rcr	ax, 1
  3838 00001832 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3839 00001835 AB                  <1> 	stosw		; interpolated sample 3 (L)
  3840 00001836 AB                  <1> 	stosw		; interpolated sample 3 (R)
  3841 00001837 58                  <1> 	pop	ax ; *	
  3842 00001838 01D0                <1> 	add	ax, dx	; 3rd quarter + [next_val]
  3843 0000183A D1D8                <1> 	rcr	ax, 1	; / 2
  3844 0000183C 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3845 0000183F AB                  <1> 	stosw		; interpolated sample 4 (L)
  3846 00001840 AB                  <1> 	stosw		; interpolated sample 4 (R)
  3847 00001841 C3                  <1> 	retn
  3848                              <1> 
  3849                              <1> interpolating_5_16bit_stereo:
  3850                              <1> 	; 18/11/2023
  3851                              <1> 	; bx = [previous_val_l]
  3852                              <1> 	; ax = [previous_val_r]
  3853                              <1> 	; [next_val_l]
  3854                              <1> 	; [next_val_r]
  3855                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  3856 00001842 51                  <1> 	push	cx ; !
  3857 00001843 93                  <1> 	xchg	ax, bx
  3858 00001844 AB                  <1> 	stosw		; original sample (L)
  3859 00001845 93                  <1> 	xchg	ax, bx
  3860 00001846 AB                  <1> 	stosw		; original sample (R)
  3861 00001847 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3862 0000184A 50                  <1> 	push	ax ; *	; [previous_val_r]
  3863 0000184B 80C780              <1> 	add	bh, 80h
  3864 0000184E 8006[6619]80        <1> 	add	byte [next_val_l+1], 80h
  3865 00001853 A1[6519]            <1> 	mov	ax, [next_val_l]
  3866 00001856 01D8                <1> 	add	ax, bx	; [previous_val_l]
  3867 00001858 D1D8                <1> 	rcr	ax, 1
  3868 0000185A 89C1                <1> 	mov	cx, ax	; interpolated middle (L)
  3869 0000185C 01D8                <1> 	add	ax, bx	
  3870 0000185E D1D8                <1> 	rcr	ax, 1
  3871 00001860 89C2                <1> 	mov	dx, ax	; interpolated 1st quarter (L)	
  3872 00001862 01D8                <1> 	add	ax, bx	; [previous_val_l]
  3873 00001864 D1D8                <1> 	rcr	ax, 1
  3874 00001866 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3875 00001869 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3876 0000186A 89C8                <1> 	mov	ax, cx
  3877 0000186C 01D0                <1> 	add	ax, dx	; middle (L) + 1st quarter (L) 
  3878 0000186E D1D8                <1> 	rcr	ax, 1	; / 2
  3879 00001870 89C3                <1> 	mov	bx, ax  ; interpolated sample 2 (L)
  3880 00001872 5A                  <1> 	pop	dx ; *	; [previous_val_r]
  3881 00001873 89D0                <1> 	mov	ax, dx
  3882 00001875 8006[6819]80        <1> 	add	byte [next_val_r+1], 80h
  3883 0000187A 0306[6719]          <1> 	add	ax, [next_val_r]
  3884 0000187E D1D8                <1> 	rcr	ax, 1
  3885 00001880 50                  <1> 	push	ax ; *	; interpolated middle (R)
  3886 00001881 01D0                <1> 	add	ax, dx
  3887 00001883 D1D8                <1> 	rcr	ax, 1
  3888 00001885 50                  <1> 	push	ax ; **	; interpolated 1st quarter (R)
  3889 00001886 01D0                <1> 	add	ax, dx	; [previous_val_r]
  3890 00001888 D1D8                <1> 	rcr	ax, 1
  3891 0000188A 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3892 0000188D AB                  <1> 	stosw 		; interpolated sample 1 (R)
  3893 0000188E 89D8                <1> 	mov	ax, bx
  3894 00001890 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3895 00001893 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  3896 00001894 58                  <1> 	pop	ax ; **
  3897 00001895 5A                  <1> 	pop	dx ; *
  3898 00001896 01D0                <1> 	add	ax, dx	; 1st quarter (R) + middle (R)
  3899 00001898 D1D8                <1> 	rcr	ax, 1	; / 2
  3900 0000189A 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3901 0000189D AB                  <1> 	stosw 		; interpolated sample 2 (R)
  3902 0000189E 89C8                <1> 	mov	ax, cx
  3903 000018A0 0306[6519]          <1> 	add	ax, [next_val_l]
  3904 000018A4 D1D8                <1> 	rcr	ax, 1
  3905 000018A6 50                  <1> 	push	ax ; * 	; interpolated 3rd quarter (L)
  3906 000018A7 01C8                <1> 	add	ax, cx	; interpolated middle (L)
  3907 000018A9 D1D8                <1> 	rcr	ax, 1
  3908 000018AB 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3909 000018AE AB                  <1> 	stosw 		; interpolated sample 3 (L)
  3910 000018AF 89D0                <1> 	mov	ax, dx
  3911 000018B1 0306[6719]          <1> 	add	ax, [next_val_r]
  3912 000018B5 D1D8                <1> 	rcr	ax, 1
  3913 000018B7 50                  <1> 	push	ax ; ** ; interpolated 3rd quarter (R)
  3914 000018B8 01D0                <1> 	add	ax, dx	; interpolated middle (R)
  3915 000018BA D1D8                <1> 	rcr	ax, 1
  3916 000018BC 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3917 000018BF AB                  <1> 	stosw 		; interpolated sample 3 (R)
  3918 000018C0 5B                  <1> 	pop	bx ; **
  3919 000018C1 58                  <1> 	pop	ax ; *
  3920 000018C2 0306[6519]          <1> 	add	ax, [next_val_l]
  3921 000018C6 D1D8                <1> 	rcr	ax, 1
  3922 000018C8 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3923 000018CB AB                  <1> 	stosw 		; interpolated sample 4 (L)
  3924 000018CC 89D8                <1> 	mov	ax, bx	
  3925 000018CE 0306[6719]          <1> 	add	ax, [next_val_r]
  3926 000018D2 D1D8                <1> 	rcr	ax, 1
  3927 000018D4 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3928 000018D7 AB                  <1> 	stosw 		; interpolated sample 4 (R)
  3929 000018D8 59                  <1> 	pop	cx ; !
  3930 000018D9 C3                  <1> 	retn
  3931                              <1> 
  3932                              <1> interpolating_4_16bit_mono:
  3933                              <1> 	; 18/11/2023
  3934                              <1> 	; ax = [previous_val]
  3935                              <1> 	; dx = [next_val]
  3936                              <1> 	; original-interpolated
  3937                              <1> 
  3938 000018DA AB                  <1> 	stosw		; original sample (L)
  3939 000018DB AB                  <1> 	stosw		; original sample (R)
  3940 000018DC 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3941 000018DF 89C3                <1> 	mov	bx, ax	; [previous_val]
  3942 000018E1 80C680              <1> 	add	dh, 80h
  3943 000018E4 01D0                <1> 	add	ax, dx	; [previous_val] + [next_val]
  3944 000018E6 D1D8                <1> 	rcr	ax, 1
  3945 000018E8 93                  <1> 	xchg	ax, bx	
  3946 000018E9 01D8                <1> 	add	ax, bx	; [previous_val] + interpolated middle
  3947 000018EB D1D8                <1> 	rcr	ax, 1
  3948 000018ED 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3949 000018F0 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3950 000018F1 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3951 000018F2 89D8                <1> 	mov	ax, bx	; interpolated middle
  3952 000018F4 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3953 000018F7 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  3954 000018F8 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3955 000018F9 89D8                <1> 	mov	ax, bx
  3956 000018FB 01D0                <1> 	add	ax, dx	; interpolated middle + [next_val]
  3957 000018FD D1D8                <1> 	rcr	ax, 1
  3958 000018FF 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3959 00001902 AB                  <1> 	stosw		; interpolated sample 3 (L)
  3960 00001903 AB                  <1> 	stosw		; interpolated sample 3 (R)
  3961 00001904 C3                  <1> 	retn
  3962                              <1> 
  3963                              <1> interpolating_4_16bit_stereo:
  3964                              <1> 	; 18/11/2023
  3965                              <1> 	; bx = [previous_val_l]
  3966                              <1> 	; ax = [previous_val_r]
  3967                              <1> 	; [next_val_l]
  3968                              <1> 	; [next_val_r]
  3969                              <1> 	; original-interpolated-interpolated-interpolated
  3970 00001905 93                  <1> 	xchg	ax, bx
  3971 00001906 AB                  <1> 	stosw		; original sample (L)
  3972 00001907 93                  <1> 	xchg	ax, bx
  3973 00001908 AB                  <1> 	stosw		; original sample (R)
  3974 00001909 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3975 0000190C 89C2                <1> 	mov	dx, ax	; [previous_val_r]
  3976 0000190E 80C780              <1> 	add	bh, 80h
  3977 00001911 8006[6619]80        <1> 	add	byte [next_val_l+1], 80h
  3978 00001916 A1[6519]            <1> 	mov	ax, [next_val_l]
  3979 00001919 01D8                <1> 	add	ax, bx	; [previous_val_l]
  3980 0000191B D1D8                <1> 	rcr	ax, 1
  3981 0000191D 93                  <1> 	xchg	ax, bx	
  3982 0000191E 01D8                <1> 	add	ax, bx	; bx = interpolated middle (L)
  3983 00001920 D1D8                <1> 	rcr	ax, 1
  3984 00001922 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3985 00001925 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3986 00001926 8006[6819]80        <1> 	add	byte [next_val_r+1], 80h
  3987 0000192B 89D0                <1> 	mov	ax, dx	; [previous_val_r]
  3988 0000192D 0306[6719]          <1> 	add	ax, [next_val_r]
  3989 00001931 D1D8                <1> 	rcr	ax, 1
  3990 00001933 92                  <1> 	xchg	ax, dx	
  3991 00001934 01D0                <1> 	add	ax, dx	; dx = interpolated middle (R)
  3992 00001936 D1D8                <1> 	rcr	ax, 1
  3993 00001938 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3994 0000193B AB                  <1> 	stosw 		; interpolated sample 1 (R)
  3995 0000193C 89D8                <1> 	mov	ax, bx
  3996 0000193E 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3997 00001941 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  3998 00001942 89D0                <1> 	mov	ax, dx
  3999 00001944 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4000 00001947 AB                  <1> 	stosw 		; interpolated sample 2 (R)
  4001 00001948 89D8                <1> 	mov	ax, bx
  4002 0000194A 0306[6519]          <1> 	add	ax, [next_val_l]
  4003 0000194E D1D8                <1> 	rcr	ax, 1
  4004 00001950 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4005 00001953 AB                  <1> 	stosw 		; interpolated sample 3 (L)
  4006 00001954 89D0                <1> 	mov	ax, dx
  4007 00001956 0306[6719]          <1> 	add	ax, [next_val_r]
  4008 0000195A D1D8                <1> 	rcr	ax, 1
  4009 0000195C 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4010 0000195F AB                  <1> 	stosw 		; interpolated sample 3 (R)
  4011 00001960 C3                  <1> 	retn
  4012                              <1> 
  4013                              <1> ; 13/11/2023
  4014                              <1> previous_val:
  4015 00001961 0000                <1> previous_val_l: dw 0
  4016 00001963 0000                <1> previous_val_r: dw 0
  4017                              <1> next_val:
  4018 00001965 0000                <1> next_val_l: dw 0
  4019 00001967 0000                <1> next_val_r: dw 0
  4020                              <1> 
  4021                              <1> ; 16/11/2023
  4022 00001969 00                  <1> faz:	db 0	
  4023                              <1> 	
  4024                              <1> ; --------------------------------------------------------
   455                                  
   456                                  ; UTILS.ASM
   457                                  ;----------------------------------------------------------------------------
   458                                  ;       delay1_4ms - Delay for 1/4 millisecond.
   459                                  ;		    1mS = 1000us
   460                                  ;       Entry:
   461                                  ;         None
   462                                  ;       Exit:
   463                                  ;	  None
   464                                  ;
   465                                  ;       Modified:
   466                                  ;         None
   467                                  ;
   468                                  PORTB			EQU	061h
   469                                    REFRESH_STATUS	EQU	010h		; Refresh signal status
   470                                  
   471                                  delay1_4ms:
   472 0000196A 50                              push    ax 
   473 0000196B 51                              push    cx
   474 0000196C B91000                          mov     cx, 16			; close enough.
   475 0000196F E461                    	in	al,PORTB
   476 00001971 2410                    	and	al,REFRESH_STATUS
   477 00001973 88C4                    	mov	ah,al			; Start toggle state
   478 00001975 09C9                    	or	cx, cx
   479 00001977 7401                    	jz	short _d4ms1
   480 00001979 41                      	inc	cx			; Throwaway first toggle
   481                                  _d4ms1:	
   482 0000197A E461                    	in	al,PORTB		; Read system control port
   483 0000197C 2410                    	and	al,REFRESH_STATUS	; Refresh toggles 15.085 microseconds
   484 0000197E 38C4                    	cmp	ah,al
   485 00001980 74F8                    	je	short _d4ms1		; Wait for state change
   486                                  
   487 00001982 88C4                    	mov	ah,al			; Update with new state
   488 00001984 49                      	dec	cx
   489 00001985 75F3                    	jnz	short _d4ms1
   490                                  
   491 00001987 59                              pop     cx
   492 00001988 58                              pop     ax
   493 00001989 C3                              retn
   494                                  
   495                                  	; 13/11/2016 - Erdogan Tan
   496                                  write_ac97_dev_info:
   497                                  	; BUS/DEV/FN
   498                                  	;	00000000BBBBBBBBDDDDDFFF00000000
   499                                  	; DEV/VENDOR
   500                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
   501                                  
   502 0000198A 30FF                    	xor	bh, bh
   503 0000198C 668B36[DA1D]            	mov	esi, [dev_vendor]
   504 00001991 89F0                    	mov	ax, si
   505 00001993 88C3                    	mov	bl, al
   506 00001995 88DA                    	mov	dl, bl
   507 00001997 80E30F                  	and	bl, 0Fh
   508 0000199A 8A87[521C]              	mov	al, [bx+hex_chars]
   509 0000199E A2[951C]                	mov	[msgVendorId+3], al
   510 000019A1 88D3                    	mov	bl, dl
   511 000019A3 C0EB04                  	shr	bl, 4
   512 000019A6 8A87[521C]              	mov	al, [bx+hex_chars]
   513 000019AA A2[941C]                	mov	[msgVendorId+2], al
   514 000019AD 88E3                    	mov	bl, ah
   515 000019AF 88DA                    	mov	dl, bl
   516 000019B1 80E30F                  	and	bl, 0Fh
   517 000019B4 8A87[521C]              	mov	al, [bx+hex_chars]
   518 000019B8 A2[931C]                	mov	[msgVendorId+1], al
   519 000019BB 88D3                    	mov	bl, dl
   520 000019BD C0EB04                  	shr	bl, 4
   521 000019C0 8A87[521C]              	mov	al, [bx+hex_chars]
   522 000019C4 A2[921C]                	mov	[msgVendorId], al
   523 000019C7 66C1EE10                	shr	esi, 16
   524 000019CB 89F0                    	mov	ax, si
   525 000019CD 88C3                    	mov	bl, al
   526 000019CF 88DA                    	mov	dl, bl
   527 000019D1 80E30F                  	and	bl, 0Fh
   528 000019D4 8A87[521C]              	mov	al, [bx+hex_chars]
   529 000019D8 A2[A61C]                	mov	[msgDevId+3], al
   530 000019DB 88D3                    	mov	bl, dl
   531 000019DD C0EB04                  	shr	bl, 4
   532 000019E0 8A87[521C]              	mov	al, [bx+hex_chars]
   533 000019E4 A2[A51C]                	mov	[msgDevId+2], al
   534 000019E7 88E3                    	mov	bl, ah
   535 000019E9 88DA                    	mov	dl, bl
   536 000019EB 80E30F                  	and	bl, 0Fh
   537 000019EE 8A87[521C]              	mov	al, [bx+hex_chars]
   538 000019F2 A2[A41C]                	mov	[msgDevId+1], al
   539 000019F5 88D3                    	mov	bl, dl
   540 000019F7 C0EB04                  	shr	bl, 4
   541 000019FA 8A87[521C]              	mov	al, [bx+hex_chars]
   542 000019FE A2[A31C]                	mov	[msgDevId], al
   543                                  
   544 00001A01 668B36[D61D]            	mov	esi, [bus_dev_fn]
   545 00001A06 66C1EE08                	shr	esi, 8
   546 00001A0A 89F0                    	mov	ax, si
   547 00001A0C 88C3                    	mov	bl, al
   548 00001A0E 88DA                    	mov	dl, bl
   549 00001A10 80E307                  	and	bl, 7 ; bit 0,1,2
   550 00001A13 8A87[521C]              	mov	al, [bx+hex_chars]
   551 00001A17 A2[CA1C]                	mov	[msgFncNo+1], al
   552 00001A1A 88D3                    	mov	bl, dl
   553 00001A1C C0EB03                  	shr	bl, 3
   554 00001A1F 88DA                    	mov	dl, bl
   555 00001A21 80E30F                  	and	bl, 0Fh
   556 00001A24 8A87[521C]              	mov	al, [bx+hex_chars]
   557 00001A28 A2[BC1C]                	mov	[msgDevNo+1], al
   558 00001A2B 88D3                    	mov	bl, dl
   559 00001A2D C0EB04                  	shr	bl, 4
   560 00001A30 8A87[521C]              	mov	al, [bx+hex_chars]
   561 00001A34 A2[BB1C]                	mov	[msgDevNo], al
   562 00001A37 88E3                    	mov	bl, ah
   563 00001A39 88DA                    	mov	dl, bl
   564 00001A3B 80E30F                  	and	bl, 0Fh
   565 00001A3E 8A87[521C]              	mov	al, [bx+hex_chars]
   566 00001A42 A2[B01C]                	mov	[msgBusNo+1], al
   567 00001A45 88D3                    	mov	bl, dl
   568 00001A47 C0EB04                  	shr	bl, 4
   569 00001A4A 8A87[521C]              	mov	al, [bx+hex_chars]
   570 00001A4E A2[AF1C]                	mov	[msgBusNo], al
   571                                  
   572 00001A51 A1[CC1D]                	mov	ax, [NAMBAR]
   573 00001A54 88C3                    	mov	bl, al
   574 00001A56 88DA                    	mov	dl, bl
   575 00001A58 80E30F                  	and	bl, 0Fh
   576 00001A5B 8A87[521C]              	mov	al, [bx+hex_chars]
   577 00001A5F A2[D91C]                	mov	[msgNamBar+3], al
   578 00001A62 88D3                    	mov	bl, dl
   579 00001A64 C0EB04                  	shr	bl, 4
   580 00001A67 8A87[521C]              	mov	al, [bx+hex_chars]
   581 00001A6B A2[D81C]                	mov	[msgNamBar+2], al
   582 00001A6E 88E3                    	mov	bl, ah
   583 00001A70 88DA                    	mov	dl, bl
   584 00001A72 80E30F                  	and	bl, 0Fh
   585 00001A75 8A87[521C]              	mov	al, [bx+hex_chars]
   586 00001A79 A2[D71C]                	mov	[msgNamBar+1], al
   587 00001A7C 88D3                    	mov	bl, dl
   588 00001A7E C0EB04                  	shr	bl, 4
   589 00001A81 8A87[521C]              	mov	al, [bx+hex_chars]
   590 00001A85 A2[D61C]                	mov	[msgNamBar], al
   591                                  
   592                                  	; 05/11/2023
   593 00001A88 A1[CE1D]                	mov	ax, [NABMBAR]
   594 00001A8B 88C3                    	mov	bl, al
   595 00001A8D 88DA                    	mov	dl, bl
   596 00001A8F 80E30F                  	and	bl, 0Fh
   597 00001A92 678A83[521C0000]        	mov	al, [ebx+hex_chars]
   598 00001A99 A2[E81C]                	mov	[msgNabmBar+3], al
   599 00001A9C 88D3                    	mov	bl, dl
   600 00001A9E C0EB04                  	shr	bl, 4
   601 00001AA1 678A83[521C0000]        	mov	al, [ebx+hex_chars]
   602 00001AA8 A2[E71C]                	mov	[msgNabmBar+2], al
   603 00001AAB 88E3                    	mov	bl, ah
   604 00001AAD 88DA                    	mov	dl, bl
   605 00001AAF 80E30F                  	and	bl, 0Fh
   606 00001AB2 678A83[521C0000]        	mov	al, [ebx+hex_chars]
   607 00001AB9 A2[E61C]                	mov	[msgNabmBar+1], al
   608 00001ABC 88D3                    	mov	bl, dl
   609 00001ABE C0EB04                  	shr	bl, 4
   610 00001AC1 678A83[521C0000]        	mov	al, [ebx+hex_chars]
   611 00001AC8 A2[E51C]                	mov	[msgNabmBar], al
   612                                  
   613                                  	; 24/11/2016
   614 00001ACB 30E4                    	xor	ah, ah
   615 00001ACD A0[C31D]                	mov	al, [ac97_int_ln_reg]
   616 00001AD0 B10A                    	mov	cl, 10
   617 00001AD2 F6F1                    	div	cl
   618 00001AD4 0106[F01C]              	add	[msgIRQ], ax
   619 00001AD8 20C0                    	and	al, al
   620 00001ADA 7508                    	jnz	short _pmi
   621 00001ADC A0[F11C]                	mov	al, [msgIRQ+1]
   622 00001ADF B420                    	mov	ah, ' '
   623 00001AE1 A3[F01C]                	mov	[msgIRQ], ax
   624                                  _pmi:
   625 00001AE4 BA[631C]                        mov	dx, msgAC97Info
   626 00001AE7 B409                            mov     ah, 9
   627 00001AE9 CD21                            int     21h
   628 00001AEB C3                              retn
   629                                  
   630                                  write_sample_rate:
   631                                  	; ax = sample rate (hertz)
   632                                  
   633 00001AEC 31D2                    	xor	dx, dx
   634 00001AEE B90A00                  	mov	cx, 10
   635 00001AF1 F7F1                    	div	cx
   636 00001AF3 0016[061D]              	add	[msgHertz+4], dl
   637 00001AF7 29D2                    	sub	dx, dx
   638 00001AF9 F7F1                    	div	cx
   639 00001AFB 0016[051D]              	add	[msgHertz+3], dl
   640 00001AFF 29D2                    	sub	dx, dx
   641 00001B01 F7F1                    	div	cx
   642 00001B03 0016[041D]              	add	[msgHertz+2], dl
   643 00001B07 29D2                    	sub	dx, dx
   644 00001B09 F7F1                    	div	cx
   645 00001B0B 0016[031D]              	add	[msgHertz+1], dl
   646 00001B0F 0006[021D]              	add	[msgHertz], al
   647                                  	
   648 00001B13 BA[F51C]                        mov     dx, msgSampleRate
   649 00001B16 B409                            mov     ah, 9
   650 00001B18 CD21                            int     21h
   651                                  
   652                                  	; 19/11/2016
   653 00001B1A BA[1B1D]                	mov	dx, msg16Bits
   654 00001B1D 803E[E21D]10            	cmp	byte [bps], 16
   655 00001B22 7403                    	je	short wsr_1
   656 00001B24 BA[0C1D]                	mov	dx, msg8Bits
   657                                  wsr_1:
   658 00001B27 B409                            mov     ah, 9
   659 00001B29 CD21                            int     21h
   660                                  
   661 00001B2B BA[141D]                	mov	dx, msgMono
   662 00001B2E 803E[E01D]01            	cmp	byte [stmo], 1
   663 00001B33 7403                    	je	short wsr_2
   664 00001B35 BA[241D]                	mov	dx, msgStereo		
   665                                  wsr_2:
   666 00001B38 B409                            mov     ah, 9
   667 00001B3A CD21                            int     21h
   668                                  
   669 00001B3C C3                              retn
   670                                  
   671                                  ; 18/11/2023
   672                                  ; 11/11/2023
   673                                  ; 10/11/2023
   674                                  ; 09/11/2023
   675                                  ; 06/11/2023
   676                                  %if 1
   677                                  
   678                                  ac97_int_handler:
   679                                  	; 19/11/2023
   680                                  	; 18/11/2023
   681                                  	; 11/11/2023
   682                                  	; 10/11/2023
   683                                  	; 17/02/2016
   684 00001B3D 6650                    	push	eax	; 11/11/2023
   685 00001B3F 52                      	push	dx
   686                                  	; 05/11/2023	
   687                                  	;push	cx
   688                                  	;push	bx
   689                                  	;push	si
   690                                  	;push	di
   691                                  
   692                                  ;	; 10/11/2023
   693                                  ;	; EOI at first
   694                                  ;	mov	al, 20h
   695                                  ;	test	byte [ac97_int_ln_reg], 8
   696                                  ;	jz	short _ih_0
   697                                  ;	out 	0A0h, al ; 20h	; EOI
   698                                  ;_ih_0:
   699                                  ;	out	20h, al  ; 20h	; EOI
   700                                  
   701                                  	; 11/11/2023
   702                                  	; 09/11/2023
   703 00001B40 BA3000                  	mov	dx, GLOB_STS_REG
   704 00001B43 0316[CE1D]                      add	dx, [NABMBAR]
   705 00001B47 66ED                    	in	eax, dx
   706                                  	
   707                                  	; 09/11/2023,
   708 00001B49 6683F8FF                        cmp	eax, 0FFFFFFFFh ; -1
   709 00001B4D 741D                    	je	short _ih_2
   710                                  	
   711 00001B4F A840                    	test	al, 40h		; PCM Out Interrupt
   712 00001B51 7509                    	jnz	short _ih_1
   713                                  
   714 00001B53 6685C0                  	test	eax, eax
   715 00001B56 7414                    	jz	short _ih_2
   716                                  
   717                                   	;mov	dx, GLOB_STS_REG
   718                                          ;add	dx, [NABMBAR]
   719 00001B58 66EF                    	out	dx, eax
   720 00001B5A EB10                    	jmp	short _ih_2
   721                                  _ih_1:
   722                                  	; 11/11/2023
   723 00001B5C 6650                    	push	eax
   724                                  
   725                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   726                                  	;mov	dx, PO_SR_REG
   727                                          ;add	dx, [NABMBAR]
   728                                  	;out	dx, ax
   729                                  
   730                                  	; 10/11/2023
   731                                  	; 28/11/2016 - Erdogan Tan
   732 00001B5E E8E3EB                  	call	tuneLoop
   733                                  
   734                                  	; 11/11/2023
   735 00001B61 6658                    	pop	eax
   736                                  	
   737 00001B63 BA3000                  	mov	dx, GLOB_STS_REG
   738 00001B66 0316[CE1D]                      add	dx, [NABMBAR]
   739 00001B6A 66EF                    	out	dx, eax
   740                                  _ih_2:
   741                                  	; 11/11/2023
   742 00001B6C 8B16[CE1D]              	mov	dx, [NABMBAR]
   743 00001B70 83C216                  	add	dx, PO_SR_REG	; set pointer to Status reg
   744 00001B73 B81C00                  	mov	ax, 1Ch ; clear FIFOE, BCIS, LVBCI
   745 00001B76 EF                      	out	dx, ax
   746                                  
   747                                  _ih_3:	; 19/11/2023
   748 00001B77 B020                    	mov	al, 20h
   749 00001B79 F606[C31D]08            	test	byte [ac97_int_ln_reg], 8
   750 00001B7E 7402                    	jz	short _ih_0
   751 00001B80 E6A0                    	out 	0A0h, al ; 20h	; EOI
   752                                  _ih_0:
   753 00001B82 E620                    	out	20h, al  ; 20h	; EOI
   754                                  
   755 00001B84 5A                      	pop	dx
   756 00001B85 6658                    	pop	eax
   757 00001B87 CF                      	iret
   758                                  
   759                                  %endif
   760                                  
   761                                  ac97_stop:
   762                                  	; 11/11/2023
   763                                  	; 09/11/2023
   764                                  	; 05/11/2023
   765                                  	; 04/11/2023 
   766                                  	; 28/05/2017 (TRDOS 386 v2, 'audio.s')
   767                                  	;mov	byte [tLoop], 0 ; stop ! ; 05/11/2023
   768                                  ;_ac97_stop:
   769                                  
   770                                  	; 11/11/2023
   771 00001B88 8B16[CC1D]              	mov	dx, [NAMBAR]
   772                                  	;add	dx, 0 ; ac_reg_0 ; reset register
   773 00001B8C EF                      	out	dx, ax
   774                                  
   775                                  	; 04/11/2023
   776                                  	; 09/10/2017 (TRDOS 386 v2, 'audio.s')
   777                                  	; 11/06/2017
   778 00001B8D 30C0                    	xor	al, al ; 0
   779 00001B8F E80D00                  	call	ac97_po_cmd
   780                                  
   781                                  	; (Ref: KolibriOS, intelac97.asm, 'stop:')
   782                                  	; Clear FIFOE, BCIS, LVBCI (Ref: Intel ICH hub manual)
   783 00001B92 B81C00                  	mov     ax, 1Ch
   784 00001B95 8B16[CE1D]              	mov     dx, [NABMBAR]
   785 00001B99 83C216                  	add     dx, PO_SR_REG
   786 00001B9C EF                      	out     dx, ax
   787                                  
   788                                  	; 11/06/2017
   789 00001B9D B002                    	mov     al, RR
   790                                  ac97_po_cmd:
   791                                  	; 11/06/2017
   792                                  	; 29/05/2017
   793 00001B9F 8B16[CE1D]              	mov     dx, [NABMBAR]
   794 00001BA3 83C21B                          add     dx, PO_CR_REG		; PCM out control register
   795 00001BA6 EE                      	out	dx, al
   796 00001BA7 C3                      	retn
   797                                  
   798                                  print_msg:
   799                                  	; 13/11/2016 - Erdogan Tan 
   800                                  	; esi = ASCIIZ text address
   801                                  	;
   802 00001BA8 BB0700                  	mov	bx, 7h
   803 00001BAB B40E                    	mov	ah, 0Eh 
   804                                  pm_next_char:
   805 00001BAD AC                      	lodsb
   806 00001BAE 20C0                    	and	al, al
   807 00001BB0 7404                    	jz	short pm_retn
   808 00001BB2 CD10                    	int	10h
   809 00001BB4 EBF7                    	jmp	short pm_next_char
   810                                  pm_retn:
   811 00001BB6 C3                      	retn
   812                                  
   813                                  ; 06/11/2023
   814                                  ;dword2str:
   815                                  ;	; 13/11/2016 - Erdogan Tan 
   816                                  ;	; eax = dword value
   817                                  ;	;
   818                                  ;	call	dwordtohex
   819                                  ;	mov	[dword_str], edx
   820                                  ;	mov	[dword_str+4], eax
   821                                  ;	mov	si, dword_str
   822                                  ;	retn
   823                                  
   824                                  	; trdos386.s (unix386.s) - 10/05/2015
   825                                  	; Convert binary number to hexadecimal string
   826                                  
   827                                  bytetohex:
   828                                  	; INPUT ->
   829                                  	; 	AL = byte (binary number)
   830                                  	; OUTPUT ->
   831                                  	;	AX = hexadecimal string
   832                                  	;
   833 00001BB7 53                      	push	bx
   834 00001BB8 30FF                    	xor	bh, bh
   835 00001BBA 88C3                    	mov	bl, al
   836 00001BBC C0EB04                  	shr	bl, 4
   837 00001BBF 8A9F[521C]              	mov	bl, [bx+hex_chars] 	 	
   838 00001BC3 86D8                    	xchg	bl, al
   839 00001BC5 80E30F                  	and	bl, 0Fh
   840 00001BC8 8AA7[521C]              	mov	ah, [bx+hex_chars] 
   841 00001BCC 5B                      	pop	bx	
   842 00001BCD C3                      	retn
   843                                  
   844                                  wordtohex:
   845                                  	; INPUT ->
   846                                  	; 	AX = word (binary number)
   847                                  	; OUTPUT ->
   848                                  	;	EAX = hexadecimal string
   849                                  	;
   850 00001BCE 53                      	push	bx
   851 00001BCF 30FF                    	xor	bh, bh
   852 00001BD1 86E0                    	xchg	ah, al
   853 00001BD3 50                      	push	ax
   854 00001BD4 88E3                    	mov	bl, ah
   855 00001BD6 C0EB04                  	shr	bl, 4
   856 00001BD9 8A87[521C]              	mov	al, [bx+hex_chars] 	 	
   857 00001BDD 88E3                    	mov	bl, ah
   858 00001BDF 80E30F                  	and	bl, 0Fh
   859 00001BE2 8AA7[521C]              	mov	ah, [bx+hex_chars]
   860 00001BE6 66C1E010                	shl	eax, 16
   861 00001BEA 58                      	pop	ax
   862 00001BEB 5B                      	pop	bx
   863 00001BEC EBC9                    	jmp	short bytetohex
   864                                  
   865                                  ; 06/11/2023
   866                                  ;dwordtohex:
   867                                  ;	; INPUT ->
   868                                  ;	; 	EAX = dword (binary number)
   869                                  ;	; OUTPUT ->
   870                                  ;	;	EDX:EAX = hexadecimal string
   871                                  ;	;
   872                                  ;	push	eax
   873                                  ;	shr	eax, 16
   874                                  ;	call	wordtohex
   875                                  ;	mov	edx, eax
   876                                  ;	pop	eax
   877                                  ;	call	wordtohex
   878                                  ;	retn
   879                                  
   880                                  _DATA:
   881                                  
   882                                  ; 24/11/2016
   883                                  ;	IRQ  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 
   884 00001BEE 08090A0B0C0D0E0F70-     irq_int	 db 08h,09h,0Ah,0Bh,0Ch,0Dh,0Eh,0Fh,70h,71h,72h,73h,74h,75h,76h,77h
   884 00001BF7 71727374757677     
   885                                  
   886                                  ; 17/02/2017
   887                                  ; Valid ICH device IDs
   888                                  
   889                                  valid_ids:
   890 00001BFE 86801524                dd	(ICH_DID << 16) + INTEL_VID  	 ; 8086h:2415h 
   891 00001C02 86802524                dd	(ICH0_DID << 16) + INTEL_VID 	 ; 8086h:2425h 
   892 00001C06 86804524                dd	(ICH2_DID << 16) + INTEL_VID 	 ; 8086h:2445h 
   893 00001C0A 86808524                dd	(ICH3_DID << 16) + INTEL_VID 	 ; 8086h:2485h 
   894 00001C0E 8680C524                dd	(ICH4_DID << 16) + INTEL_VID 	 ; 8086h:24C5h
   895 00001C12 8680D524                dd	(ICH5_DID << 16) + INTEL_VID 	 ; 8086h:24D5h
   896 00001C16 86806E26                dd	(ICH6_DID << 16) + INTEL_VID 	 ; 8086h:266Eh
   897 00001C1A 8680A625                dd	(ESB6300_DID << 16) + INTEL_VID  ; 8086h:25A6h
   898 00001C1E 86809826                dd	(ESB631X_DID << 16) + INTEL_VID  ; 8086h:2698h
   899 00001C22 8680DE27                dd	(ICH7_DID << 16) + INTEL_VID 	 ; 8086h:27DEh
   900                                  ; 03/11/2023 - Erdogan Tan
   901 00001C26 86809571                dd	(MX82440_DID << 16) + INTEL_VID  ; 8086h:7195h
   902 00001C2A 39101270                dd	(SI7012_DID << 16)  + SIS_VID	 ; 1039h:7012h
   903 00001C2E DE10B101                dd 	(NFORCE_DID << 16)  + NVIDIA_VID ; 10DEh:01B1h
   904 00001C32 DE106A00                dd 	(NFORCE2_DID << 16) + NVIDIA_VID ; 10DEh:006Ah
   905 00001C36 22106D74                dd 	(AMD8111_DID << 16) + AMD_VID 	 ; 1022h:746Dh
   906 00001C3A 22104574                dd 	(AMD768_DID << 16)  + AMD_VID 	 ; 1022h:7445h
   907 00001C3E DE105900                dd 	(CK804_DID << 16) + NVIDIA_VID	 ; 10DEh:0059h
   908 00001C42 DE103A00                dd 	(MCP04_DID << 16) + NVIDIA_VID	 ; 10DEh:003Ah
   909 00001C46 DE108A00                dd 	(CK8_DID << 16) + NVIDIA_VID	 ; 1022h:008Ah
   910 00001C4A DE10DA00                dd 	(NFORCE3_DID << 16) + NVIDIA_VID ; 10DEh:00DAh
   911 00001C4E DE10EA00                dd 	(CK8S_DID << 16) + NVIDIA_VID	 ; 10DEh:00EAh
   912                                  
   913                                  valid_id_count:	equ ($ - valid_ids)>>2 ; 05/11/2023
   914                                  
   915                                  ; 13/11/2016
   916 00001C52 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
   916 00001C5B 3941424344454600   
   917 00001C63 414339372041756469-     msgAC97Info	db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
   917 00001C6C 6F20436F6E74726F6C-
   917 00001C75 6C6572202620436F64-
   917 00001C7E 656320496E666F0D0A 
   918 00001C87 56656E646F72204944-     		db "Vendor ID: "
   918 00001C90 3A20               
   919 00001C92 303030306820446576-     msgVendorId	db "0000h Device ID: "
   919 00001C9B 6963652049443A20   
   920 00001CA3 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
   921 00001CAA 4275733A20              		db "Bus: "
   922 00001CAF 303068204465766963-     msgBusNo	db "00h Device: "
   922 00001CB8 653A20             
   923 00001CBB 3030682046756E6374-     msgDevNo	db "00h Function: "
   923 00001CC4 696F6E3A20         
   924 00001CC9 303068                  msgFncNo	db "00h"
   925 00001CCC 0D0A                    		db 0Dh, 0Ah
   926                                  ; 05/11/2023	
   927 00001CCE 4E414D4241523A20        		db "NAMBAR: "
   928 00001CD6 303030306820            msgNamBar	db "0000h "
   929 00001CDC 4E41424D4241523A20      		db "NABMBAR: "
   930 00001CE5 303030306820495251-     msgNabmBar	db "0000h IRQ: "
   930 00001CEE 3A20               
   931 00001CF0 3030                    msgIRQ		dw 3030h
   932 00001CF2 0D0A24                  		db 0Dh, 0Ah, "$"
   933 00001CF5 53616D706C65205261-     msgSampleRate	db "Sample Rate: "
   933 00001CFE 74653A20           
   934 00001D02 303030303020487A20-     msgHertz	db "00000 Hz ", "$" 
   934 00001D0B 24                 
   935 00001D0C 3820626974732024        msg8Bits	db "8 bits ", "$" 
   936 00001D14 4D6F6E6F0D0A24          msgMono		db "Mono", 0Dh, 0Ah, "$"
   937 00001D1B 313620626974732024      msg16Bits	db "16 bits ", "$" 
   938 00001D24 53746572656F0D0A24      msgStereo	db "Stereo", 0Dh, 0Ah, "$"
   939                                  
   940                                  ;; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   941                                  ;codec_id	dd 0
   942                                  ;codec_chip_id	dd 0
   943                                  ;codec_vendor_ids dw 0
   944                                  ;codec_chip_ids	dw 0
   945                                  
   946 00001D2D 3030303030303030        dword_str	 dd 30303030h, 30303030h
   947 00001D35 680D0A00                		 db 'h', 0Dh, 0Ah, 0
   948                                  
   949                                  ;ac_unknown     db 'unknown manufacturer',13,10,0
   950                                  ;ac_Realtek     db 'Realtek Semiconductor',13,10,0
   951                                  ;ac_Analog      db 'Analog Devices',13,10,0
   952                                  ;ac_CMedia      db 'C-Media Electronics',13,10,0
   953                                  ;ac_Cirrus      db 'Cirrus Logic',13,10,0
   954                                  ;ac_Wolfson     db 'Wolfson Microelectronics',13,10,0
   955                                  ;ac_VIA         db 'VIA Technologies',13,10,0
   956                                  ;ac_SigmaTel    db 'SigmaTel',13,10,0
   957                                  ;ac_eMicro      db 'eMicro',13,10,0
   958                                  ;
   959                                  ;chip_unknown   db 'unknown codec id ', 0
   960                                  
   961                                  ;CHIP_REALTEK   equ 414C4700h
   962                                  ;CHIP_CMEDIA    equ 434D4900h
   963                                  ;CHIP_VIA       equ 56494100h
   964                                  
   965                                  ;codecs        dd CHIP_CMEDIA
   966                                  ;	       dw ac_CMedia, chips_CMedia
   967                                  ;              dd CHIP_REALTEK
   968                                  ;	       dw ac_Realtek, chips_Realtek
   969                                  ;              dd CHIP_VIA
   970                                  ;	       dw ac_VIA, chips_VIA
   971                                  ;              dd 0
   972                                  
   973                                  ;chips_Realtek dw 10h, chip_ALC201a
   974                                  ;              dw 20h, chip_ALC650
   975                                  ;              dw 21h, chip_ALC650D
   976                                  ;              dw 22h, chip_ALC650E
   977                                  ;              dw 23h, chip_ALC650F
   978                                  ;              dw 60h, chip_ALC655
   979                                  ;              dw 80h, chip_ALC658
   980                                  ;              dw 81h, chip_ALC658D
   981                                  ;              dw 90h, chip_ALC850
   982                                  ;              dw 0FFh
   983                                  
   984                                  ;chips_CMedia  dw 41h, chip_CM9738
   985                                  ;              dw 61h, chip_CM9739
   986                                  ;              dw 69h, chip_CM9780
   987                                  ;              dw 78h, chip_CM9761
   988                                  ;              dw 82h, chip_CM9761
   989                                  ;              dw 83h, chip_CM9761
   990                                  ;              dw 0FFh
   991                                  
   992                                  ;chips_VIA     dw 61h, chip_VIA1612A
   993                                  ;              dw 0FFh
   994                                  
   995                                  ;Realtek
   996                                  ;chip_ALC201a    db 'ALC201a',0dh,0ah,00h
   997                                  ;chip_ALC650     db 'ALC650 ',0dh,0ah,00h
   998                                  ;chip_ALC650D    db 'ALC650D',0dh,0ah,00h
   999                                  ;chip_ALC650E    db 'ALC650E',0dh,0ah,00h
  1000                                  ;chip_ALC650F    db 'ALC650F',0dh,0ah,00h
  1001                                  ;chip_ALC655     db 'ALC655 ',0dh,0ah,00h
  1002                                  ;chip_ALC658     db 'ALC658 ',0dh,0ah,00h
  1003                                  ;chip_ALC658D    db 'ALC658D',0dh,0ah,00h
  1004                                  ;chip_ALC850     db 'ALC850 ',0dh,0ah,00h
  1005                                  
  1006                                  ;CMedia
  1007                                  ;chip_CM9738     db 'CMI9738', 0dh,0ah,0
  1008                                  ;chip_CM9739     db 'CMI9739', 0dh,0ah,0
  1009                                  ;chip_CM9780     db 'CMI9780', 0dh,0ah,0
  1010                                  ;chip_CM9761     db 'CMI9761', 0dh,0ah,0
  1011                                  
  1012                                  ;VIA
  1013                                  ;chip_VIA1612A   db 'VIA1612A',13,10,0
  1014                                  
  1015                                  ; 11/11/2023
  1016                                  msg_init_err:
  1017 00001D39 0D0A                    	db	CR, LF
  1018 00001D3B 4143393720436F6E74-     	db	"AC97 Controller/Codec initialization error !"
  1018 00001D44 726F6C6C65722F436F-
  1018 00001D4D 64656320696E697469-
  1018 00001D56 616C697A6174696F6E-
  1018 00001D5F 206572726F722021   
  1019 00001D67 0D0A24                  	db	CR, LF, "$"
  1020                                  
  1021                                  ; 12/11/2023
  1022                                  msg_no_vra:
  1023 00001D6A 0D0A                    	db	CR, LF
  1024 00001D6C 4E6F20565241207375-     	db	"No VRA support ! Only 48 kHZ sample rate supported !"
  1024 00001D75 70706F72742021204F-
  1024 00001D7E 6E6C79203438206B48-
  1024 00001D87 5A2073616D706C6520-
  1024 00001D90 726174652073757070-
  1024 00001D99 6F727465642021     
  1025 00001DA0 0D0A24                  	db	CR, LF, "$"
  1026                                  
  1027                                  ; 17/02/2017
  1028                                  bss_start:
  1029                                  
  1030                                  ABSOLUTE bss_start
  1031                                  
  1032 00001DA3 ??                      alignb 2
  1033                                  
  1034                                  ; 28/11/2016
  1035                                  
  1036 00001DA4 <res 1Ch>               smpRBuff:	resw 14 ; 19/11/2016 - Erdogan Tan
  1037                                  
  1038 00001DC0 ????                    filehandle:	resw 1
  1039                                  
  1040 00001DC2 ??                      flags:		resb 1
  1041                                  ; 06/11/2023
  1042 00001DC3 ??                      ac97_int_ln_reg: resb 1
  1043                                  
  1044                                  ; 09/11/2023
  1045                                  ; 06/11/2023
  1046                                  ;pcm_irq_status: resb 1	; 05/11/2023
  1047 00001DC4 ??                      inside:		resb 1
  1048 00001DC5 ??                      tloop:		resb 1	; 10/11/2023
  1049                                  
  1050                                  ; 09/11/2023
  1051                                  ; 04/11/2023 - 06/11/2023
  1052 00001DC6 ????                    IRQ_status:	resw 1	; IRQ status before enabling audio interrupt
  1053 00001DC8 ????????                IRQ_vector:	resd 1  ; Previous interrupt handler address	
  1054                                  
  1055                                  ; 17/02/2017
  1056                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  1057                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  1058                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  1059                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  1060 00001DCC ????                    NAMBAR:		resw 1			; BAR for mixer
  1061 00001DCE ????                    NABMBAR:	resw 1			; BAR for bus master regs
  1062                                  
  1063                                  ; 256 byte buffer for descriptor list
  1064 00001DD0 ????                    BDL_BUFFER:	resw 1			; segment of our 256byte BDL buffer
  1065 00001DD2 ????                    WAV_BUFFER1:	resw 1			; segment of our WAV storage
  1066                                  ; 64k buffers for wav file storage
  1067 00001DD4 ????                    WAV_BUFFER2:	resw 1			; segment of 2nd wav buffer
  1068                                  
  1069                                  ; 06/11/2023
  1070                                  ;tBuff:		resb 1
  1071                                  ;ac97_int_ln_reg: resb 1
  1072                                  
  1073                                  ; 12/11/2016 - Erdogan Tan
  1074                                  
  1075 00001DD6 ????????                bus_dev_fn:	resd 1
  1076 00001DDA ????????                dev_vendor:	resd 1
  1077                                  ; 06/11/2023
  1078                                  ;stats_cmd:	resw 1 ; 17/02/2017
  1079                                  ; 05/11/2023
  1080                                  ;ac97_io_base:	resw 1
  1081 00001DDE ????                    sample_rate:	resw 1
  1082                                  
  1083                                  ; 19/11/2016
  1084 00001DE0 ????                    stmo:		resw 1 
  1085 00001DE2 ????                    bps:		resw 1
  1086                                  
  1087                                  ; 08/11/2023
  1088                                  ; 07/11/2023
  1089 00001DE4 ??                      fbs_shift:	resb 1
  1090                                  ; 09/11/2023
  1091 00001DE5 ??                      b_indicator:	resb 1
  1092                                  ; 10/11/2023
  1093 00001DE6 ??                      LVI:		resb 1
  1094 00001DE7 ??                      		resb 1 ; 10/11/2023 
  1095                                  
  1096                                  ;fbs_seg:	resw 1
  1097                                  ;fbs_off:	resw 1
  1098                                  
  1099                                  ;alignb 2
  1100                                  
  1101                                  ; 32 kilo bytes for temporay buffer
  1102                                  ; (for stereo-mono, 8bit/16bit corrections)
  1103                                  ;temp_buffer:	resb 32768
  1104                                  ; 18/11/2023
  1105 00001DE8 <res DBF0h>             temp_buffer:	resb 56304  ; (44.1 kHZ stereo 14076 samples)	
  1106                                  
  1107                                  ;alignb 16
  1108                                  EOF:
