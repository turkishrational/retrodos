     1                                  ; ****************************************************************************
     2                                  ; PLAYWAV.ASM - ICH AC97 .wav player for DOS.			   PLAYWAV.COM
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; Last Update: 08/11/2023 (Previous: 17/02/2017)
     5                                  ; ----------------------------------------------------------------------------
     6                                  ; Beginning: 17/02/2017
     7                                  ; ----------------------------------------------------------------------------
     8                                  ; Assembler: NASM version 2.11 (2.15)
     9                                  ;	     nasm playwav.asm -l playwav.lst -o PLAYWAV.COM	
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Derived from '.wav file player for DOS' Jeff Leyda, Sep 02, 2002 
    12                                  ; ****************************************************************************
    13                                  ; Modidified from 'PLAYER.COM' for VIA VT8233 wav player source code by
    14                                  ; (PLAYER.ASM) by Erdogan Tan (07/11/2016 - 08/12/2016)
    15                                  
    16                                  ; TUNELOOP version (playing without AC97 interrupt) - 06/11/2023 - Erdogan Tan
    17                                  
    18                                  [BITS 16]
    19                                  
    20                                  [ORG 100h] 
    21                                  
    22                                  	%include 'ac97.inc' ; 17/02/2017
     1                              <1> ; 05/11/2023
     2                              <1> ; 03/11/2023
     3                              <1> ; 17/02/2017 (Erdogan Tan, PLAYWAV.ASM)
     4                              <1> ; constant.inc & codec.inc (for ICH AC97 wav player, 'PLAYWAV.COM') 
     5                              <1> 
     6                              <1> ; ----------------------------------------------------------------------------
     7                              <1> ; CONSTANT.INC
     8                              <1> ; ----------------------------------------------------------------------------
     9                              <1> 
    10                              <1> ;constants of stuff that seem hard to remember at times.
    11                              <1> 
    12                              <1> TRUE  EQU 1
    13                              <1> FALSE EQU 0
    14                              <1> 
    15                              <1> ENABLED  EQU 1
    16                              <1> DISABLED EQU 0
    17                              <1> 
    18                              <1> BIT0  EQU 1
    19                              <1> BIT1  EQU 2
    20                              <1> BIT2  EQU 4
    21                              <1> BIT3  EQU 8
    22                              <1> BIT4  EQU 10h
    23                              <1> BIT5  EQU 20h
    24                              <1> BIT6  EQU 40h
    25                              <1> BIT7  EQU 80h
    26                              <1> BIT8  EQU 100h
    27                              <1> BIT9  EQU 200h
    28                              <1> BIT10 EQU 400h
    29                              <1> BIT11 EQU 800h
    30                              <1> BIT12 EQU 1000h
    31                              <1> BIT13 EQU 2000h
    32                              <1> BIT14 EQU 4000h
    33                              <1> BIT15 EQU 8000h
    34                              <1> BIT16 EQU 10000h
    35                              <1> BIT17 EQU 20000h
    36                              <1> BIT18 EQU 40000h
    37                              <1> BIT19 EQU 80000h
    38                              <1> BIT20 EQU 100000h
    39                              <1> BIT21 EQU 200000h
    40                              <1> BIT22 EQU 400000h
    41                              <1> BIT23 EQU 800000h
    42                              <1> BIT24 EQU 1000000h
    43                              <1> BIT25 EQU 2000000h
    44                              <1> BIT26 EQU 4000000h
    45                              <1> BIT27 EQU 8000000h
    46                              <1> BIT28 EQU 10000000h
    47                              <1> BIT29 EQU 20000000h
    48                              <1> BIT30 EQU 40000000h
    49                              <1> BIT31 EQU 80000000h
    50                              <1> 
    51                              <1> ;special characters
    52                              <1> NUL     EQU 0
    53                              <1> NULL    EQU 0
    54                              <1> BELL    EQU 07
    55                              <1> BS      EQU 08
    56                              <1> TAB     EQU 09
    57                              <1> LF      EQU 10
    58                              <1> CR      EQU 13
    59                              <1> ESCAPE  EQU 27           ;ESC is a reserved word....
    60                              <1> 
    61                              <1> 
    62                              <1> ;file stuff
    63                              <1> READONLY  EQU   BIT0
    64                              <1> HIDDEN    EQU   BIT1
    65                              <1> SYSTEM    EQU   BIT2
    66                              <1> VOLUME    EQU   BIT3         ;ignored for file access
    67                              <1> DIRECTORY EQU   BIT4         ;must be 0 for file access
    68                              <1> ARCHIVE   EQU   BIT5
    69                              <1> SHAREABLE EQU   BIT7         ;for novell networks
    70                              <1> OPEN	EQU	2		; open existing file
    71                              <1> CREATE	EQU	1		; create new file
    72                              <1> 
    73                              <1> 
    74                              <1> ; PCI equates
    75                              <1> ; PCI function address (PFA)
    76                              <1> ; bit 31 = 1
    77                              <1> ; bit 23:16 = bus number     (0-255)
    78                              <1> ; bit 15:11 = device number  (0-31)
    79                              <1> ; bit 10:8 = function number (0-7)
    80                              <1> ; bit 7:0 = register number  (0-255)
    81                              <1> 
    82                              <1> IO_ADDR_MASK    EQU     0FFFEh          ; mask off bit 0 for reading BARs
    83                              <1> PCI_INDEX_PORT  EQU     0CF8h
    84                              <1> PCI_DATA_PORT   EQU     0CFCh
    85                              <1> PCI32           EQU     BIT31           ; bitflag to signal 32bit access
    86                              <1> PCI16           EQU     BIT30           ; bitflag for 16bit access
    87                              <1> 
    88                              <1> PCI_FN0         EQU     0 << 8
    89                              <1> PCI_FN1         EQU     1 << 8
    90                              <1> PCI_FN2         EQU     2 << 8
    91                              <1> PCI_FN3         EQU     3 << 8
    92                              <1> PCI_FN4         EQU     4 << 8
    93                              <1> PCI_FN5         EQU     5 << 8
    94                              <1> PCI_FN6         EQU     6 << 8
    95                              <1> PCI_FN7         EQU     7 << 8
    96                              <1> 
    97                              <1> PCI_CMD_REG		EQU	04h		; reg 04, command reg
    98                              <1>  IO_ENA			EQU	BIT0		; i/o decode enable
    99                              <1>  MEM_ENA		EQU	BIT1		; memory decode enable
   100                              <1>  BM_ENA                 EQU     BIT2		; bus master enable
   101                              <1> 
   102                              <1> ; ----------------------------------------------------------------------------
   103                              <1> ; CODEC.INC
   104                              <1> ; ----------------------------------------------------------------------------
   105                              <1> 
   106                              <1> ;Codec registers.
   107                              <1> ;
   108                              <1> ;Not all codecs are created equal. Refer to the spec for your specific codec.
   109                              <1> ;
   110                              <1> ;All registers are 16bits wide.  Access to codec registers over the AC97 link
   111                              <1> ;is defined by the OEM.  
   112                              <1> ;
   113                              <1> ;Secondary codec's are accessed by ORing in BIT7 of all register accesses.
   114                              <1> ;
   115                              <1> 
   116                              <1> ; each codec/mixer register is 16bits
   117                              <1> 
   118                              <1> CODEC_RESET_REG                 equ     00      ; reset codec
   119                              <1> CODEC_MASTER_VOL_REG            equ     02      ; master volume
   120                              <1> CODEC_HP_VOL_REG                equ     04      ; headphone volume
   121                              <1> CODEC_MASTER_MONO_VOL_REG       equ     06      ; master mono volume
   122                              <1> CODEC_MASTER_TONE_REG           equ     08      ; master tone (R+L)
   123                              <1> CODEC_PCBEEP_VOL_REG            equ     0ah     ; PC beep volume
   124                              <1> CODEC_PHONE_VOL_REG             equ     0bh     ; phone volume
   125                              <1> CODEC_MIC_VOL_REG               equ     0eh     ; MIC volume
   126                              <1> CODEC_LINE_IN_VOL_REG           equ     10h     ; line input volume
   127                              <1> CODEC_CD_VOL_REG                equ     12h     ; CD volume
   128                              <1> CODEC_VID_VOL_REG               equ     14h     ; video volume
   129                              <1> CODEC_AUX_VOL_REG               equ     16h     ; aux volume
   130                              <1> CODEC_PCM_OUT_REG               equ     18h     ; PCM output volume
   131                              <1> CODEC_RECORD_SELECT_REG         equ     1ah     ; record select input
   132                              <1> CODEC_RECORD_VOL_REG            equ     1ch     ; record volume
   133                              <1> CODEC_RECORD_MIC_VOL_REG        equ     1eh     ; record mic volume
   134                              <1> CODEC_GP_REG                    equ     20h     ; general purpose
   135                              <1> CODEC_3D_CONTROL_REG            equ     22h     ; 3D control
   136                              <1> ; 24h is reserved
   137                              <1> CODEC_POWER_CTRL_REG            equ     26h     ; powerdown control
   138                              <1> CODEC_EXT_AUDIO_REG             equ     28h     ; extended audio
   139                              <1> CODEC_EXT_AUDIO_CTRL_REG        equ     2ah     ; extended audio control
   140                              <1> CODEC_PCM_FRONT_DACRATE_REG     equ     2ch     ; PCM out sample rate
   141                              <1> CODEC_PCM_SURND_DACRATE_REG     equ     2eh     ; surround sound sample rate
   142                              <1> CODEC_PCM_LFE_DACRATE_REG       equ     30h     ; LFE sample rate
   143                              <1> CODEC_LR_ADCRATE_REG            equ     32h     ; PCM in sample rate
   144                              <1> CODEC_MIC_ADCRATE_REG           equ     34h     ; mic in sample rate
   145                              <1> 
   146                              <1> ; registers 36-7a are reserved on the ICH
   147                              <1> 
   148                              <1> CODEC_VENDORID1_REG             equ     7ch     ; codec vendor ID 1
   149                              <1> CODEC_VENDORID2_REG             equ     7eh     ; codec vendor ID 2
   150                              <1> 
   151                              <1> ; Mixer registers 0 through 51h reside in the ICH and are not forwarded over
   152                              <1> ; the AC97 link to the codec, which I think is a little weird.  Looks like
   153                              <1> ; the ICH makes it so you don't need a fully functional codec to play audio?
   154                              <1> ;
   155                              <1> ; whenever 2 codecs are present in the system, use BIT7 to access the 2nd
   156                              <1> ; set of registers, ie 80h-feh
   157                              <1> 
   158                              <1> PRIMARY_CODEC                   equ     0       ; 0-7F for primary codec
   159                              <1> SECONDARY_CODEC                 equ     BIT7    ; 80-8f registers for 2ndary
   160                              <1> 
   161                              <1> SAMPLE_RATE_441khz	equ     44100   ; 44.1Khz (cd quality) rate
   162                              <1> 
   163                              <1> ; ----------------------------------------------------------------------------
   164                              <1> ; 17/02/2017
   165                              <1> PCI_IO_BASE	equ 10h			; = NAMBAR register offset
   166                              <1> AC97_INT_LINE   equ 3Ch			; AC97 Interrupt Line register offset
   167                              <1> 
   168                              <1> ; ----------------------------------------------------------------------------
   169                              <1> ; ICH2AC97.INC
   170                              <1> ; ----------------------------------------------------------------------------
   171                              <1> 
   172                              <1> ; PCI stuff
   173                              <1> 
   174                              <1> ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
   175                              <1> 
   176                              <1> INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
   177                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   178                              <1> SIS_VID		equ	1039h
   179                              <1> NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
   180                              <1> AMD_VID		equ	1022h
   181                              <1> 
   182                              <1> ICH_DID         equ     2415h           ; ICH device ID
   183                              <1> ICH0_DID        equ     2425h           ; ICH0
   184                              <1> ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
   185                              <1>                                         ; they all should be compatible.
   186                              <1> 
   187                              <1> ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
   188                              <1> ICH3_DID	equ     2485h           ; ICH3
   189                              <1> ICH4_DID        equ     24C5h           ; ICH4
   190                              <1> ICH5_DID	equ     24D5h           ; ICH5 
   191                              <1> ICH6_DID	equ     266Eh           ; ICH6
   192                              <1> ESB6300_DID	equ     25A6h           ; 6300ESB
   193                              <1> ESB631X_DID	equ     2698h           ; 631XESB
   194                              <1> ICH7_DID	equ	27DEh		; ICH7
   195                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   196                              <1> MX82440_DID	equ	7195h
   197                              <1> SI7012_DID	equ	7012h
   198                              <1> NFORCE_DID	equ	01B1h
   199                              <1> NFORCE2_DID	equ	006Ah
   200                              <1> AMD8111_DID	equ	746Dh
   201                              <1> AMD768_DID	equ	7445h
   202                              <1> ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
   203                              <1> CK804_DID	equ	0059h
   204                              <1> MCP04_DID	equ	003Ah
   205                              <1> CK8_DID		equ	008Ah
   206                              <1> NFORCE3_DID	equ	00DAh
   207                              <1> CK8S_DID	equ	00EAh
   208                              <1> 
   209                              <1> NAMBAR_REG      equ     10h             ; native audio mixer BAR
   210                              <1>  NAM_SIZE       equ     256             ; 256 bytes required.
   211                              <1> 
   212                              <1> NABMBAR_REG     equ     14h             ; native audio bus mastering BAR
   213                              <1>  NABM_SIZE      equ     64              ; 64 bytes
   214                              <1> 
   215                              <1> ; BUS master registers, accessed via NABMBAR+offset
   216                              <1> 
   217                              <1> ; ICH supports 3 different types of register sets for three types of things
   218                              <1> ; it can do, thus:
   219                              <1> ;
   220                              <1> ; PCM in (for recording) aka PI
   221                              <1> ; PCM out (for playback) aka PO
   222                              <1> ; MIC in (for recording) aka MC
   223                              <1> 
   224                              <1> PI_BDBAR_REG            equ     0       ; PCM in buffer descriptor BAR
   225                              <1> PO_BDBAR_REG            equ     10h     ; PCM out buffer descriptor BAR
   226                              <1> MC_BDBAR_REG            equ     20h     ; MIC in buffer descriptor BAR
   227                              <1> 
   228                              <1> ; each buffer descriptor BAR holds a pointer which has entries to the buffer
   229                              <1> ; contents of the .WAV file we're going to play. Each entry is 8 bytes long
   230                              <1> ; (more on that later) and can contain 32 entries total, so each BAR is
   231                              <1> ; 256 bytes in length, thus:
   232                              <1> 
   233                              <1> BDL_SIZE                equ     32*8    ; Buffer Descriptor List size
   234                              <1> INDEX_MASK              equ     31      ; indexes must be 0-31
   235                              <1> 
   236                              <1> 
   237                              <1> 
   238                              <1> PI_CIV_REG              equ     4       ; PCM in current Index value (RO)
   239                              <1> PO_CIV_REG              equ     14h     ; PCM out current Index value (RO)
   240                              <1> MC_CIV_REG              equ     24h     ; MIC in current Index value (RO)
   241                              <1> ;8bit read only
   242                              <1> ; each current index value is simply a pointer showing us which buffer
   243                              <1> ; (0-31) the codec is currently processing. Once this counter hits 31, it
   244                              <1> ; wraps back to 0.
   245                              <1> ; this can be handy to know, as once it hits 31, we're almost out of data to
   246                              <1> ; play back or room to record!
   247                              <1> 
   248                              <1> 
   249                              <1> PI_LVI_REG              equ     5       ; PCM in Last Valid Index
   250                              <1> PO_LVI_REG              equ     15h     ; PCM out Last Valid Index
   251                              <1> MC_LVI_REG              equ     25h     ; MIC in Last Valid Index
   252                              <1> ;8bit read/write
   253                              <1> ; The Last Valid Index is a number (0-31) to let the codec know what buffer
   254                              <1> ; number to stop on after processing. It could be very nasty to play audio
   255                              <1> ; from buffers that aren't filled with the audio we want to play.
   256                              <1> 
   257                              <1> 
   258                              <1> PI_SR_REG               equ     6       ; PCM in Status register
   259                              <1> PO_SR_REG               equ     16h     ; PCM out Status register
   260                              <1> MC_SR_REG               equ     26h     ; MIC in Status register
   261                              <1> ;16bit read/write
   262                              <1> ; status registers.  Bitfields follow:
   263                              <1> 
   264                              <1> FIFO_ERR                equ     BIT4    ; FIFO Over/Underrun W1TC.
   265                              <1> 
   266                              <1> BCIS                    equ     BIT3    ; buffer completion interrupt status.
   267                              <1>                                         ; Set whenever the last sample in ANY
   268                              <1>                                         ; buffer is finished.  Bit is only
   269                              <1>                                         ; set when the Interrupt on Complete
   270                              <1>                                         ; (BIT4 of control reg) is set.
   271                              <1> 
   272                              <1> LVBCI                   equ     BIT2    ; Set whenever the codec has processed
   273                              <1>                                         ; the last buffer in the buffer list.
   274                              <1>                                         ; Will fire an interrupt if IOC bit is
   275                              <1>                                         ; set. Probably set after the last
   276                              <1>                                         ; sample in the last buffer is
   277                              <1>                                         ; processed.  W1TC
   278                              <1> 
   279                              <1>                                         ; 
   280                              <1> CELV                    equ     BIT1    ; Current buffer == last valid.
   281                              <1>                                         ; Bit is RO and remains set until LVI is
   282                              <1>                                         ; cleared.  Probably set up the start
   283                              <1>                                         ; of processing for the last buffer.
   284                              <1> 
   285                              <1> 
   286                              <1> DCH                     equ     BIT0    ; DMA controller halted.
   287                              <1>                                         ; set whenever audio stream is stopped
   288                              <1>                                         ; or something else goes wrong.
   289                              <1> 
   290                              <1> 
   291                              <1> PI_PICB_REG             equ     8       ; PCM in position in current buffer(RO)
   292                              <1> PO_PICB_REG             equ     18h     ; PCM out position in current buffer(RO)
   293                              <1> MC_PICB_REG             equ     28h     ; MIC in position in current buffer (RO)
   294                              <1> ;16bit read only
   295                              <1> ; position in current buffer regs show the number of dwords left to be
   296                              <1> ; processed in the current buffer.
   297                              <1> ; 
   298                              <1> 
   299                              <1> PI_PIV_REG              equ     0ah     ; PCM in Prefected index value
   300                              <1> PO_PIV_REG              equ     1ah     ; PCM out Prefected index value
   301                              <1> MC_PIV_REG              equ     2ah     ; MIC in Prefected index value
   302                              <1> ;8bit, read only
   303                              <1> ; Prefetched index value register.
   304                              <1> ; tells which buffer number (0-31) has be prefetched. I'd imagine this
   305                              <1> ; value follows the current index value fairly closely. (CIV+1)
   306                              <1> ;
   307                              <1> 
   308                              <1> 
   309                              <1> PI_CR_REG               equ     0bh     ; PCM in Control Register
   310                              <1> PO_CR_REG               equ     1bh     ; PCM out Control Register
   311                              <1> MC_CR_REG               equ     2bh     ; MIC in Control Register
   312                              <1> ; 8bit
   313                              <1> ; Control register *MUST* only be accessed as an 8bit value.
   314                              <1> ; Control register. See bitfields below.
   315                              <1> ;
   316                              <1> 
   317                              <1> 
   318                              <1> IOCE                    equ     BIT4    ; interrupt on complete enable.
   319                              <1>                                         ; set this bit if you want an intrtpt
   320                              <1>                                         ; to fire whenever LVBCI is set.
   321                              <1> FEIFE                   equ     BIT3    ; set if you want an interrupt to fire
   322                              <1>                                         ; whenever there is a FIFO (over or
   323                              <1>                                         ; under) error.
   324                              <1> LVBIE                   equ     BIT2    ; last valid buffer interrupt enable.
   325                              <1>                                         ; set if you want an interrupt to fire
   326                              <1>                                         ; whenever the completion of the last
   327                              <1>                                         ; valid buffer.
   328                              <1> RR                      equ     BIT1    ; reset registers.  Nukes all regs
   329                              <1>                                         ; except bits 4:2 of this register.
   330                              <1>                                         ; Only set this bit if BIT 0 is 0
   331                              <1> RPBM                    equ     BIT0    ; Run/Pause
   332                              <1>                                         ; set this bit to start the codec!
   333                              <1> 
   334                              <1> 
   335                              <1> GLOB_CNT_REG            equ     2ch     ; Global control register
   336                              <1> SEC_RES_EN              equ     BIT5    ; secondary codec resume event 
   337                              <1>                                         ; interrupt enable.  Not used here.
   338                              <1> PRI_RES_EN              equ     BIT4    ; ditto for primary. Not used here.
   339                              <1> ACLINK_OFF              equ     BIT3    ; Turn off the AC97 link
   340                              <1> ACWARM_RESET            equ     BIT2    ; Awaken the AC97 link from sleep.
   341                              <1>                                         ; registers preserved, bit self clears
   342                              <1> ACCOLD_RESET            equ     BIT1    ; Reset everything in the AC97 and
   343                              <1>                                         ; reset all registers.  Not self clearing
   344                              <1> 
   345                              <1> GPIIE                   equ     BIT0    ; GPI Interrupt enable.
   346                              <1>                                         ; set if you want an interrupt to
   347                              <1>                                         ; fire upon ANY of the bits in the
   348                              <1>                                         ; GPI (general pursose inputs?) not used.
   349                              <1> 
   350                              <1> GLOB_STS_REG            equ     30h     ; Global Status register (RO)
   351                              <1> 
   352                              <1> MD3                     equ     BIT17   ; modem powerdown status (yawn)
   353                              <1> AD3                     equ     BIT16   ; Audio powerdown status (yawn)
   354                              <1> RD_COMPLETE_STS         equ     BIT15   ; Codec read timed out. 0=normal
   355                              <1> BIT3SLOT12              equ     BIT14   ; shadowed status of bit 3 in slot 12
   356                              <1> BIT2SLOT12              equ     BIT13   ; shadowed status of bit 2 in slot 12
   357                              <1> BIT1SLOT12              equ     BIT12   ; shadowed status of bit 1 in slot 12
   358                              <1> SEC_RESUME_STS          equ     BIT11   ; secondary codec has resumed (and irqed)
   359                              <1> PRI_RESUME_STS          equ     BIT10   ; primary codec has resumed (and irqed)
   360                              <1> SEC_CODEC_RDY           equ     BIT9    ; secondary codec is ready for action
   361                              <1> PRI_CODEC_RDY           equ     BIT8    ; Primary codec is ready for action
   362                              <1>                                         ; software must check these bits before
   363                              <1>                                         ; starting the codec!
   364                              <1> MIC_IN_IRQ              equ     BIT7    ; MIC in caused an interrupt
   365                              <1> PCM_OUT_IRQ             equ     BIT6    ; One of the PCM out channels IRQed
   366                              <1> PCM_IN_IRQ              equ     BIT5    ; One of the PCM in channels IRQed
   367                              <1> MODEM_OUT_IRQ           equ     BIT2    ; modem out channel IRQed
   368                              <1> MODEM_IN_IRQ            equ     BIT1    ; modem in channel IRQed
   369                              <1> GPI_STS_CHANGE          equ     BIT0    ; set whenever GPI's have changed.
   370                              <1>                                         ; BIT0 of slot 12 also reflects this.
   371                              <1> 
   372                              <1> ACC_SEMA_REG            equ     34h     ; Codec write semiphore register
   373                              <1> CODEC_BUSY              equ     BIT0    ; codec register I/O is happening
   374                              <1>                                         ; self clearing
   375                              <1> ;
   376                              <1> ; Buffer Descriptors List
   377                              <1> ; As stated earlier, each buffer descriptor list is a set of (up to) 32 
   378                              <1> ; descriptors, each 8 bytes in length. Bytes 0-3 of a descriptor entry point
   379                              <1> ; to a chunk of memory to either play from or record to. Bytes 4-7 of an
   380                              <1> ; entry describe various control things detailed below.
   381                              <1> ; 
   382                              <1> ; Buffer pointers must always be aligned on a Dword boundry.
   383                              <1> ;
   384                              <1> 
   385                              <1> IOC                     equ     BIT31   ; Fire an interrupt whenever this
   386                              <1>                                         ; buffer is complete.
   387                              <1> 
   388                              <1> BUP                     equ     BIT30   ; Buffer Underrun Policy.
   389                              <1>                                         ; if this buffer is the last buffer
   390                              <1>                                         ; in a playback, fill the remaining
   391                              <1>                                         ; samples with 0 (silence) or not.
   392                              <1>                                         ; It's a good idea to set this to 1
   393                              <1>                                         ; for the last buffer in playback,
   394                              <1>                                         ; otherwise you're likely to get a lot
   395                              <1>                                         ; of noise at the end of the sound.
   396                              <1> 
   397                              <1> ;
   398                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   399                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   400                              <1> ; Luckily for us, that's the same format as .wav files.
   401                              <1> ;
   402                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   403                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   404                              <1> ;
   405                              <1> ; A value of 0 in these bits means play no samples.
   406                              <1> ;
    23                                  
    24                                  _STARTUP:
    25                                  
    26                                  ; memory allocation
    27                                  
    28 00000000 E82101                          call    setFree				; deallocate unused DOS mem
    29                                  
    30                                  	; 17/02/2017
    31                                  	; Clear BSS (uninitialized data) area
    32 00000003 31C0                    	xor	ax, ax ; 0
    33 00000005 B91D40                  	mov	cx, (EOF - bss_start)/2
    34 00000008 BF[7B08]                	mov	di, bss_start
    35 0000000B F3AB                    	rep	stosw
    36                                  
    37                                  ; allocate 256 bytes of data for DCM_OUT Buffer Descriptor List. (BDL)
    38                                  
    39 0000000D B81000                          mov     ax, BDL_SIZE / 16
    40 00000010 E81901                          call    memAlloc
    41 00000013 A3[A008]                        mov     [BDL_BUFFER], ax		; segment 
    42                                  
    43                                  ; allocate 2 buffers, 64k each for now.
    44                                  
    45 00000016 B80010                          mov     ax, BUFFERSIZE / 16		; 64k for .WAV file
    46 00000019 E81001                          call    memAlloc
    47 0000001C A3[A208]                        mov     [WAV_BUFFER1], ax		; segment
    48                                  
    49 0000001F B80010                  	mov	ax, BUFFERSIZE / 16
    50 00000022 E80701                  	call	memAlloc
    51 00000025 A3[A408]                	mov	[WAV_BUFFER2], ax
    52                                  
    53                                  ; Detect/reset AC97 
    54                                  
    55 00000028 E87402                          call    pciFindDevice
    56 0000002B 7342                            jnc     short _1
    57                                  
    58                                  ; couldn't find the audio device!
    59                                  
    60 0000002D 0E                      	push	cs
    61 0000002E 1F                      	pop	ds
    62 0000002F BA[3900]                        mov     dx, noDevMsg
    63 00000032 B409                            mov     ah, 9
    64 00000034 CD21                            int     21h
    65 00000036 E9E400                          jmp     exit
    66                                  
    67                                  ; 17/02/2017
    68 00000039 4572726F723A20556E-     noDevMsg db "Error: Unable to find intel ICH based audio device!",CR,LF,"$"
    68 00000042 61626C6520746F2066-
    68 0000004B 696E6420696E74656C-
    68 00000054 204943482062617365-
    68 0000005D 6420617564696F2064-
    68 00000066 6576696365210D0A24 
    69                                  
    70                                  _1:
    71                                  	; eax = BUS/DEV/FN
    72                                  	;	00000000BBBBBBBBDDDDDFFF00000000
    73                                  	; edx = DEV/VENDOR
    74                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
    75                                  
    76 0000006F 66A3[A608]              	mov	[bus_dev_fn], eax
    77 00000073 668916[AA08]            	mov	[dev_vendor], edx
    78                                  
    79                                  	; get ICH base address regs for mixer and bus master
    80                                  
    81 00000078 B010                            mov     al, NAMBAR_REG
    82 0000007A E89401                          call    pciRegRead16			; read PCI registers 10-11
    83 0000007D 83E2FE                          and     dx, IO_ADDR_MASK 		; mask off BIT0
    84                                  
    85 00000080 8916[9C08]                      mov     [NAMBAR], dx			; save audio mixer base addy
    86                                  
    87 00000084 B014                    	mov     al, NABMBAR_REG
    88 00000086 E88801                          call    pciRegRead16
    89 00000089 83E2FE                          and     dx, IO_ADDR_MASK
    90                                  
    91 0000008C 8916[9E08]                      mov     [NABMBAR], dx			; save bus master base addy
    92                                  
    93                                  	; 06/11/2023
    94                                  	;; init controller
    95                                  	;; 17/02/2017
    96                                  	;mov	al, PCI_CMD_REG ; command register (04h)
    97                                  	;call	pciRegRead16 ; pciRegRead8
    98                                  	;
    99                                  	;; eax = BUS/DEV/FN/REG
   100                                  	;;  dx = PCI Command Register Content ; 17/02/2017
   101                                  	;; 	00000000CCCCCCCC
   102                                  	;mov	[stats_cmd], dx
   103                                  	;
   104                                  	; 06/11/2023
   105                                  	;mov	al, PCI_IO_BASE ; IO base address register (10h)
   106                                  	;call	pciRegRead32
   107                                  	;
   108                                  	;and	dx, 0FFC0h	; IO_ADDR_MASK (0FFFE) ?
   109                                          ;mov	[ac97_io_base], dx
   110                                  
   111 00000090 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
   112 00000092 E87401                  	call	pciRegRead8 ; 17/02/2017
   113                                  
   114 00000095 8816[9B08]              	mov     [ac97_int_ln_reg], dl
   115                                  
   116                                  ; 05/11/2023
   117                                  %if 0
   118                                  	; 28/11/2016
   119                                  	mov	bx, 1
   120                                  	xor	dh, dh 	 ; 17/02/2017
   121                                  	mov	cx, dx
   122                                  	shl	bx, cl
   123                                  
   124                                  	; 04/11/2023
   125                                  	cli
   126                                  
   127                                  	;not	bx
   128                                  	in	al, 0A1h ; irq 8-15
   129                                          mov	ah, al
   130                                          in	al, 21h  ; irq 0-7 
   131                                  
   132                                  	; 04/11/2023
   133                                  	; save IRQ status
   134                                  	mov	[IRQ_status], ax
   135                                  
   136                                  	;and	ax, bx   ; unmask
   137                                   	btr	ax, dx	 ; unmask
   138                                  	out	21h, al  ; enable interrupt (if irq <= 7)
   139                                  	mov	al, ah
   140                                  	out	0A1h, al ; enable interrupt (if irq > 7)
   141                                  	;not	bx
   142                                  
   143                                  	; 04/11/2023
   144                                  	;mov	dx, 4D1h			;8259 ELCR1
   145                                          ;in	al, dx
   146                                  	;mov	ah, al
   147                                  	;mov	dx, 4D0h 
   148                                          ;in	al, dx
   149                                  	;;or	ax, bx        
   150                                  	;bts	ax, cx
   151                                  	;mov	dx, 4D0h
   152                                  	;out	dx, al                          ;set level-triggered mode
   153                                  	;mov	al, ah
   154                                  	;mov	dx, 4D1h
   155                                  	;out	dx, al                          ;set level-triggered mode
   156                                  
   157                                  	; 24/11/2016 - Erdogan Tan
   158                                  	mov	bx, cx
   159                                  	;mov	bx, dx
   160                                  	mov	bl, [bx+irq_int]
   161                                  	shl	bx, 2 ; * 4
   162                                  
   163                                  	; set up interrupt vector
   164                                  	; 30/11/2016
   165                                  	push	es
   166                                  	xor	ax, ax
   167                                  	mov	es, ax
   168                                  	; 04/11/2023
   169                                  	; save interrupt vector
   170                                  	mov	ax, [es:bx]
   171                                  	mov	[IRQ_vector], ax
   172                                  	mov	ax, [es:bx+2]
   173                                  	mov	[IRQ_vector+2], ax
   174                                  
   175                                  	mov	word [es:bx], ac97_int_handler
   176                                  	mov	ax, cs
   177                                  	mov	[es:bx+2], ax
   178                                  	pop	es
   179                                  
   180                                  	; 04/11/2023
   181                                  	sti
   182                                  
   183                                  %endif
   184 00000099 E89B04                  	call	write_ac97_dev_info 
   185                                  
   186                                  ; check the command line for a file to play
   187                                  
   188                                          ;push	ds
   189 0000009C E89600                          call    processCmdline			; get the filename
   190                                  
   191                                  ; open the file
   192 0000009F B002                            mov     al, OPEN                        ; open existing file
   193 000000A1 E8B100                          call    openFile                        ; no error? ok.
   194                                          ;pop	ds
   195 000000A4 7322                            jnc     short _gsr
   196                                  
   197                                  ; file not found!
   198                                  
   199                                          ;push   cs
   200                                          ;pop    ds
   201 000000A6 BA[AF00]                        mov	dx, noFileErrMsg
   202 000000A9 B409                            mov     ah, 9
   203 000000AB CD21                            int     21h
   204 000000AD EB6E                            jmp     exit
   205                                  
   206                                  noFileErrMsg:
   207 000000AF 4572726F723A206669-     	db "Error: file not found.",CR,LF,"$"
   207 000000B8 6C65206E6F7420666F-
   207 000000C1 756E642E0D0A24     
   208                                  
   209                                  _gsr:
   210 000000C8 E8B100                          call    getSampleRate                   ; read the sample rate
   211                                                                                  ; pass it onto codec.
   212 000000CB 7250                    	jc	short exit ; 19/11/2016 - nothing to do
   213                                  
   214 000000CD A3[AE08]                	mov	[sample_rate], ax
   215                                  	
   216                                  	; 19/11/2016
   217 000000D0 880E[B008]              	mov	[stmo], cl
   218 000000D4 8816[B208]              	mov	[bps], dl
   219                                  	
   220                                  	; 17/02/2017
   221 000000D8 C606[B408]00            	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit 
   222 000000DD FEC9                    	dec	cl
   223 000000DF 7504                    	jnz	short _gsr_1 ; stereo
   224 000000E1 FE06[B408]              	inc	byte [fbs_shift] ; 1 = mono or 8 bit		
   225                                  _gsr_1:	
   226 000000E5 80FA08                  	cmp	dl, 8 
   227 000000E8 7704                    	ja	short _gsr_2 ; 16 bit samples
   228 000000EA FE06[B408]              	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   229                                  _gsr_2:	
   230 000000EE E8A805                  	call	write_sample_rate
   231                                  
   232                                  	; 05/11/2023
   233                                  _2:
   234 000000F1 E81704                  	call	check4keyboardstop  ; flush keyboard buffer
   235 000000F4 72FB                    	jc	short _2 	; 07/11/2023
   236                                  
   237                                  	; 05/11/2023
   238                                  	;mov	eax, [bus_dev_fn]
   239                                  	;mov	al, PCI_CMD_REG
   240                                  	;call	pciRegRead16			; read PCI command register
   241                                  	; 17/02/2017
   242                                  	;mov	dx, [stats_cmd]
   243                                          ;or	dl, IO_ENA+BM_ENA               ; enable IO and bus master
   244                                  	;call	pciRegWrite16 ; pciRegWrite8
   245                                  
   246                                  	; 06/11/2023
   247 000000F6 66A1[A608]              	mov	eax, [bus_dev_fn]
   248 000000FA B004                            mov     al, PCI_CMD_REG
   249 000000FC E80A01                          call    pciRegRead8                     ; read PCI command register
   250 000000FF 80CA05                          or      dl, IO_ENA+BM_ENA               ; enable IO and bus master
   251 00000102 E87601                          call    pciRegWrite8
   252                                  
   253                                  ; setup the Codec (actually mixer registers) 
   254 00000105 E8D801                          call    codecConfig                     ; unmute codec, set rates.
   255                                  ;
   256                                  ; position file pointer to start in actual wav data
   257                                  ; MUCH improvement should really be done here to check if sample size is
   258                                  ; supported, make sure there are 2 channels, etc.  
   259                                  ;
   260 00000108 B442                            mov     ah, 42h
   261 0000010A B000                            mov     al, 0                           ; from start of file
   262 0000010C 8B1E[9808]                      mov     bx, [filehandle]
   263 00000110 31C9                            xor     cx, cx
   264 00000112 BA2C00                          mov     dx, 44                          ; jump past .wav/riff header
   265 00000115 CD21                            int     21h
   266                                  
   267                                  ; play the .wav file. Most of the good stuff is in here.
   268                                  
   269 00000117 E82002                          call    playWav
   270                                  
   271                                  ; close the .wav file and exit.
   272                                  
   273 0000011A E84A00                          call    closeFile
   274                                  
   275                                  exit:
   276 0000011D B8004C                          mov     ax, 4c00h
   277 00000120 CD21                    	int 	21h
   278                                  
   279                                  here:
   280 00000122 EBFE                    	jmp	short here
   281                                  
   282                                  ; MEMALLOC.ASM
   283                                  ;-- SETFREE: Release memory not used  ----------------
   284                                  ;-- Input    : ES = address of PSP
   285                                  ;-- Output   : none
   286                                  ;-- Register : AX, BX, CL and FLAGS are changed 
   287                                  ;-- Info     : Since the stack-segment is always the last segment in an 
   288                                  ;              EXE-file, ES:0000 points to the beginning and SS:SP
   289                                  ;              to the end of the program in memory. Through this the
   290                                  ;              length of the program can be calculated 
   291                                  ; call this routine once at the beginning of the program to free up memory
   292                                  ; assigned to it by DOS.
   293                                  
   294                                  setFree:
   295 00000124 BB0010                  	  mov	bx, 65536/16	; 4K paragraphs ; 17/02/2017 (Erdogan Tan)		
   296                                  
   297 00000127 B44A                              mov	ah, 4ah		;pass new length to DOS
   298 00000129 CD21                              int	21h
   299                                  
   300 0000012B C3                                retn			; back to caller 
   301                                  				; new size (allocated memory) = 64KB
   302                                  
   303                                  memAlloc:
   304                                  ; input: AX = # of paragraphs required
   305                                  ; output: AX = segment of block to use
   306                                  
   307 0000012C 53                      	push	bx
   308 0000012D 89C3                    	mov	bx, ax
   309 0000012F B448                    	mov	ah, 48h
   310 00000131 CD21                    	int	21h
   311 00000133 5B                      	pop	bx
   312 00000134 C3                      	retn
   313                                  
   314                                  ; CMDLINE.ASM
   315                                  ; parse the command line
   316                                  ; entry: none
   317                                  ; exit: DS:DX to the 1st supplied item on the command line 
   318                                  
   319                                  processCmdline:
   320 00000135 53                              push    bx
   321 00000136 56                              push    si
   322                                  
   323                                          ;mov    ah, 51h
   324                                          ;int    21h
   325                                          ;mov    ds, bx
   326                                  
   327 00000137 BE8000                          mov     si, 80h
   328 0000013A 0FB61C                          movzx   bx, byte [si]
   329 0000013D 01DE                            add     si, bx
   330 0000013F 46                              inc     si
   331                                  
   332 00000140 C60400                          mov     byte [si], NULL         ; zero terminate
   333                                  
   334 00000143 BE8100                          mov     si, 81h
   335                                  
   336                                  cmdlineloop:
   337 00000146 AC                              lodsb
   338                                  
   339 00000147 3C00                            cmp     al, NULL                ; found end of line?
   340 00000149 7404                            je      short exitpc
   341 0000014B 3C20                            cmp     al, ' '                 ; found a space?
   342 0000014D 74F7                            je      short cmdlineloop
   343                                  
   344                                          ; must be the filename here.
   345                                  exitpc:
   346 0000014F 4E                              dec     si                      ; point to start of filename
   347 00000150 89F2                            mov     dx, si
   348 00000152 5E                              pop     si
   349 00000153 5B                              pop     bx
   350 00000154 C3                      	retn
   351                                  
   352                                  ; FILE.ASM
   353                                  ;open or create file
   354                                  ;
   355                                  ;input: ds:dx-->filename (asciiz)
   356                                  ;       al=file Mode (create or open)
   357                                  ;output: none  cs:[filehandle] filled
   358                                  ;
   359                                  openFile:
   360 00000155 50                      	push	ax
   361 00000156 51                      	push	cx
   362 00000157 B43B                    	mov	ah, 3bh			; start with a mode
   363 00000159 00C4                    	add	ah, al			; add in create or open mode
   364 0000015B 31C9                    	xor	cx, cx
   365 0000015D CD21                    	int	21h
   366 0000015F 7203                    	jc	short _of1
   367                                  	;mov	[cs:filehandle], ax
   368 00000161 A3[9808]                	mov	[filehandle], ax
   369                                  _of1:
   370 00000164 59                      	pop	cx
   371 00000165 58                      	pop	ax
   372 00000166 C3                      	retn
   373                                  
   374                                  ; close the currently open file
   375                                  ; input: none, uses cs:[filehandle]
   376                                  closeFile:
   377 00000167 50                      	push	ax
   378 00000168 53                      	push	bx
   379 00000169 833E[9808]FF            	cmp	word [filehandle], -1
   380 0000016E 7409                    	jz	short _cf1
   381 00000170 8B1E[9808]              	mov     bx, [filehandle]  
   382 00000174 B8003E                  	mov     ax,3e00h
   383 00000177 CD21                            int     21h              ;close file
   384                                  _cf1:
   385 00000179 5B                      	pop	bx
   386 0000017A 58                      	pop	ax
   387 0000017B C3                      	retn
   388                                  
   389                                  getSampleRate:
   390                                  	; 08/12/2016
   391                                  ; reads the sample rate from the .wav file.
   392                                  ; entry: none - assumes file is already open
   393                                  	; 19/11/2016 - Erdogan Tan
   394                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   395                                  ;	cx = number of channels (mono=1, stereo=2)
   396                                  ;	dx = bits per sample (8, 16)
   397                                  
   398 0000017C 53                      	push    bx
   399                                  
   400 0000017D B442                            mov     ah, 42h
   401 0000017F B000                            mov     al, 0				; from start of file
   402 00000181 8B1E[9808]                      mov     bx, [filehandle]
   403 00000185 31C9                            xor     cx, cx
   404 00000187 BA0800                          mov     dx, 08h				; "WAVE"
   405 0000018A CD21                            int     21h
   406                                  
   407 0000018C BA[7C08]                        mov     dx, smpRBuff
   408 0000018F B91C00                          mov     cx, 28				; 28 bytes
   409 00000192 B43F                    	mov	ah, 3fh
   410 00000194 CD21                            int     21h
   411                                  
   412 00000196 813E[7C08]5741          	cmp	word [smpRBuff], 'WA'
   413 0000019C 751C                    	jne	short gsr_stc
   414                                  
   415 0000019E 813E[7E08]5645          	cmp	word [smpRBuff+2], 'VE'
   416 000001A4 7514                    	jne	short gsr_stc
   417                                  
   418 000001A6 833E[8808]01            	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   419 000001AB 750D                    	jne	short gsr_stc
   420                                  
   421                                  
   422 000001AD 8B0E[8A08]              	mov	cx, [smpRBuff+14]	; return num of channels in CX
   423 000001B1 A1[8C08]                        mov     ax, [smpRBuff+16]	; return sample rate in AX
   424 000001B4 8B16[9608]              	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   425                                  gsr_retn:
   426 000001B8 5B                              pop     bx
   427 000001B9 C3                              retn
   428                                  
   429                                  gsr_stc:
   430 000001BA F9                      	stc
   431 000001BB EBFB                    	jmp	short gsr_retn
   432                                  
   433                                  %include 'ac97.asm' ; 29/11/2016 (AC97 codec configuration)
     1                              <1> ; 06/11/2023
     2                              <1> ; 05/11/2023
     3                              <1> ; 04/11/2023
     4                              <1> ; 03/11/2023
     5                              <1> ; PCI and AC97 codec functions for wav player
     6                              <1> ; Erdogan Tan (17/02/2017)
     7                              <1> 
     8                              <1> ; TUNELOOP version (playing without interrupt) - 06/11/2023 - Erdogan Tan
     9                              <1>  
    10                              <1> ; ----------------------------------------------------------------------------
    11                              <1> ; PCI.ASM
    12                              <1> ; ----------------------------------------------------------------------------
    13                              <1> 
    14                              <1> ; PCI device register reader/writers.
    15                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    16                              <1> ; 		Last Update: 17/02/2017
    17                              <1> 
    18                              <1> ;===============================================================
    19                              <1> ; 8/16/32bit PCI reader
    20                              <1> ;
    21                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    22                              <1> ;           BIT30 set if 32 bit access requested
    23                              <1> ;           BIT29 set if 16 bit access requested
    24                              <1> ;           otherwise defaults to 8bit read
    25                              <1> ;
    26                              <1> ; Exit:  DL,DX,EDX register data depending on requested read size
    27                              <1> ;
    28                              <1> ; Note: this routine is meant to be called via pciRegRead8, pciRegread16,
    29                              <1> ;	or pciRegRead32, listed below.
    30                              <1> ;
    31                              <1> ; Note2: don't attempt to read 32bits of data from a non dword aligned reg
    32                              <1> ;	 number. Likewise, don't do 16bit reads from non word aligned reg #
    33                              <1> ; 
    34                              <1> pciRegRead:
    35 000001BD 6653                <1> 	push	ebx
    36 000001BF 51                  <1> 	push	cx
    37 000001C0 6689C3              <1>         mov     ebx, eax                        ; save eax, dh
    38 000001C3 88F1                <1>         mov     cl, dh
    39 000001C5 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    40 000001CB 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
    41 000001D1 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
    42                              <1> 
    43 000001D3 BAF80C              <1>         mov     dx, PCI_INDEX_PORT
    44 000001D6 66EF                <1>         out     dx, eax                         ; write PCI selector
    45                              <1> 
    46 000001D8 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
    47 000001DB 88D8                <1>         mov     al, bl
    48 000001DD 2403                <1>         and     al, 3                           ; figure out which port to
    49 000001DF 00C2                <1>         add     dl, al                          ; read to
    50                              <1> 
    51 000001E1 66ED                <1> 	in      eax, dx                         ; do 32bit read
    52 000001E3 66F7C300000080      <1>         test    ebx, PCI32
    53 000001EA 7403                <1>         jz      short _pregr1
    54                              <1> 
    55 000001EC 6689C2              <1>         mov     edx, eax                        ; return 32bits of data
    56                              <1> _pregr1:
    57 000001EF 89C2                <1> 	mov     dx, ax                          ; return 16bits of data
    58 000001F1 66F7C3000000C0      <1>         test    ebx, PCI32+PCI16
    59 000001F8 7502                <1>         jnz     short _pregr2
    60 000001FA 88CE                <1>         mov     dh, cl                          ; restore dh for 8 bit read
    61                              <1> _pregr2:
    62 000001FC 6689D8              <1>         mov     eax, ebx                        ; restore eax
    63 000001FF 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    64 00000205 59                  <1> 	pop	cx
    65 00000206 665B                <1> 	pop	ebx
    66 00000208 C3                  <1> 	retn
    67                              <1> 
    68                              <1> pciRegRead8:
    69 00000209 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32             ; set up 8 bit read size
    70 0000020F EBAC                <1>         jmp     short pciRegRead		; call generic PCI access
    71                              <1> 
    72                              <1> pciRegRead16:
    73 00000211 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit read size
    74 00000217 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
    75 0000021D EB9E                <1>         jmp     short pciRegRead
    76                              <1> 
    77                              <1> pciRegRead32:
    78 0000021F 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit read size
    79 00000225 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
    80 0000022B EB90                <1>         jmp     short pciRegRead
    81                              <1> 
    82                              <1> ;===============================================================
    83                              <1> ; 8/16/32bit PCI writer
    84                              <1> ;
    85                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    86                              <1> ;           BIT31 set if 32 bit access requested
    87                              <1> ;           BIT30 set if 16 bit access requested
    88                              <1> ;           otherwise defaults to 8bit read
    89                              <1> ;        DL/DX/EDX data to write depending on size
    90                              <1> ;
    91                              <1> ;
    92                              <1> ; note: this routine is meant to be called via pciRegWrite8, pciRegWrite16,
    93                              <1> ; 	or pciRegWrite32 as detailed below.
    94                              <1> ;
    95                              <1> ; Note2: don't attempt to write 32bits of data from a non dword aligned reg
    96                              <1> ;	 number. Likewise, don't do 16bit writes from non word aligned reg #
    97                              <1> ;
    98                              <1> pciRegWrite:
    99 0000022D 6653                <1> 	push	ebx
   100 0000022F 51                  <1> 	push	cx
   101 00000230 6689C3              <1>         mov     ebx, eax                        ; save eax, dx
   102 00000233 89D1                <1>         mov     cx, dx
   103 00000235 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
   104 0000023B 6625FFFFFFBF        <1>         and     eax, ~PCI16 ; NOT PCI16         ; clear out data size request
   105 00000241 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
   106                              <1> 
   107 00000243 BAF80C              <1>         mov     dx, PCI_INDEX_PORT
   108 00000246 66EF                <1>         out     dx, eax                         ; write PCI selector
   109                              <1> 
   110 00000248 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
   111 0000024B 88D8                <1>         mov     al, bl
   112 0000024D 2403                <1>         and     al, 3                           ; figure out which port to
   113 0000024F 00C2                <1>         add     dl, al                          ; write to
   114                              <1> 
   115 00000251 6689D0              <1>         mov     eax, edx                        ; put data into eax
   116 00000254 89C8                <1>         mov     ax, cx
   117                              <1> 
   118 00000256 EE                  <1>         out     dx, al
   119 00000257 66F7C3000000C0      <1>         test    ebx, PCI16+PCI32                ; only 8bit access? bail
   120 0000025E 740C                <1>         jz      short _pregw1
   121                              <1> 
   122 00000260 EF                  <1>         out     dx, ax                          ; write 16 bit value
   123 00000261 66F7C300000040      <1>         test    ebx, PCI16                      ; 16bit requested?  bail
   124 00000268 7502                <1>         jnz     short _pregw1
   125                              <1> 
   126 0000026A 66EF                <1>         out     dx, eax                         ; write full 32bit
   127                              <1> _pregw1:
   128 0000026C 6689D8              <1>         mov     eax, ebx                        ; restore eax
   129 0000026F 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
   130 00000275 89CA                <1>         mov     dx, cx                          ; restore dx
   131 00000277 59                  <1> 	pop	cx
   132 00000278 665B                <1> 	pop	ebx
   133 0000027A C3                  <1> 	ret
   134                              <1> 
   135                              <1> pciRegWrite8:
   136 0000027B 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 8 bit write size
   137 00000281 EBAA                <1>         jmp     short pciRegWrite		; call generic PCI access
   138                              <1> 
   139                              <1> pciRegWrite16:
   140 00000283 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit write size
   141 00000289 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
   142 0000028F EB9C                <1>         jmp     short pciRegWrite
   143                              <1> 
   144                              <1> pciRegWrite32:
   145 00000291 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit write size
   146 00000297 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
   147 0000029D EB8E                <1>         jmp     short pciRegWrite
   148                              <1> 
   149                              <1> ; 17/02/2017 (Modifed by Erdogan Tan for various ICH device IDs)
   150                              <1> ;===============================================================
   151                              <1> ; PCIFindDevice: scan through PCI space looking for a device+vendor ID
   152                              <1> ;
   153                              <1> ;  ENTRY: none
   154                              <1> ;; Entry: EAX=Device+Vendor ID
   155                              <1> ;
   156                              <1> ;  Exit: EAX=PCI address if device found
   157                              <1> ;	 EDX=Device+Vendor ID
   158                              <1> ;        CY clear if found, set if not found. EAX invalid if CY set.
   159                              <1> ;
   160                              <1> ; [old stackless] Destroys: ebx, esi, edi, cl
   161                              <1> ;
   162                              <1> pciFindDevice:
   163                              <1> 	;push	cx
   164                              <1> 	;push	eax ; *
   165                              <1> 	;push	esi
   166                              <1> 	;push	edi
   167                              <1> 
   168                              <1>  	;mov     esi, eax                ; save off vend+device ID
   169                              <1> 
   170                              <1> 	; 17/02/2017
   171 0000029F BE[4007]            <1> 	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
   172 000002A2 B91500              <1> 	mov	cx, valid_id_count
   173                              <1> pfd_0:
   174 000002A5 66BF00FFFF7F        <1>        	mov     edi, (80000000h - 100h) ; start with bus 0, dev 0 func 0
   175                              <1> nextPCIdevice:
   176 000002AB 6681C700010000      <1>         add     edi, 100h
   177 000002B2 6681FF00F8FF80      <1>         cmp     edi, 80FFF800h		; scanned all devices?
   178                              <1>         ;stc
   179                              <1>         ;je 	short PCIScanExit       ; not found
   180 000002B9 720D                <1> 	jb	short pfd_1
   181 000002BB 66BF00000080        <1> 	mov     edi, 80000000h
   182 000002C1 83C604              <1> 	add	si, 4 ; scan for next device ID
   183 000002C4 E202                <1> 	loop	pfd_1	 
   184 000002C6 F9                  <1> 	stc	
   185                              <1> 	;jmp 	short PCIScanExit
   186 000002C7 C3                  <1> 	retn
   187                              <1> pfd_1:
   188 000002C8 6689F8              <1>         mov     eax, edi                ; read PCI registers
   189 000002CB E851FF              <1>         call    pciRegRead32
   190                              <1>         ;cmp    edx, esi                ; found device?
   191 000002CE 663B14              <1>         cmp	edx, dword [si]
   192 000002D1 75D8                <1> 	jne     short nextPCIdevice
   193                              <1>         ;clc
   194                              <1> PCIScanExit:
   195                              <1> 	;pushf
   196 000002D3 66B800000080        <1> 	mov	eax, BIT31
   197 000002D9 66F7D0              <1> 	not	eax
   198 000002DC 6621F8              <1> 	and	eax, edi		; return only bus/dev/fn #
   199                              <1> 	;popf
   200                              <1> 
   201                              <1> 	;pop	edi
   202                              <1> 	;pop	esi
   203                              <1> 	;pop	edx ; *
   204                              <1> 	;pop	cx
   205 000002DF C3                  <1> 	retn
   206                              <1> 
   207                              <1> ; ----------------------------------------------------------------------------
   208                              <1> ; CODEC.ASM
   209                              <1> ; ----------------------------------------------------------------------------
   210                              <1> 
   211                              <1> ; codec configuration code. Not much here really.
   212                              <1> ; NASM version: Erdogan Tan (29/11/2016)
   213                              <1> 
   214                              <1> ; enable codec, unmute stuff, set output rate to 44.1
   215                              <1> ; entry: ax = desired sample rate
   216                              <1> 
   217                              <1> ; 06/11/2023
   218                              <1> %if 0
   219                              <1> 
   220                              <1> codecConfig:
   221                              <1> 	; 04/11/2023
   222                              <1> 	; 17/02/2017 
   223                              <1> 	; 07/11/2016 (Erdogan Tan)
   224                              <1> 	;PORT_NABM_GLB_CTRL_STAT equ 60h
   225                              <1> 
   226                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   227                              <1>  	; 'AC97_DEF.H'
   228                              <1> 	;AC97_EXTENDED_STATUS equ 002Ah
   229                              <1> 	AC97_EA_SPDIF	equ 0002h
   230                              <1> 	AC97_EA_VRA	equ 0001h
   231                              <1> 	; 04/11/2023
   232                              <1> 	ICH_PO_CR_RESET equ 0002h  ; reset codec
   233                              <1> 	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
   234                              <1> 	ICH_PCM_246_MASK equ 300000h ; 6 channels
   235                              <1> 
   236                              <1> 	; 04/11/2023
   237                              <1> init_ac97_controller:
   238                              <1> 	mov	eax, [bus_dev_fn]
   239                              <1> 	mov	al, PCI_CMD_REG
   240                              <1> 	call	pciRegRead16		; read PCI command register
   241                              <1> 	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
   242                              <1> 	call	pciRegWrite16
   243                              <1> 
   244                              <1> delay_100ms:
   245                              <1> 	; 29/05/2017
   246                              <1> 	; 24/03/2017 ('codec.asm')
   247                              <1> 	; wait 100 ms
   248                              <1> 	mov	ecx, 400  ; 400*0.25ms
   249                              <1> _delay_x_ms:
   250                              <1> 	call	delay1_4ms
   251                              <1>         loop	_delay_x_ms
   252                              <1> 
   253                              <1> init_ac97_codec:
   254                              <1> 	; 04/11/2023
   255                              <1> 	; reset codec
   256                              <1> 	mov     dx, [NABMBAR]
   257                              <1> 	add	dx, PO_CR_REG
   258                              <1> 	in	al, dx
   259                              <1> 	or	al, ICH_PO_CR_RESET
   260                              <1> 	out	dx, al
   261                              <1> 
   262                              <1> 	call	delay1_4ms
   263                              <1> 
   264                              <1> 	; set channels (2) and bits (16/32)
   265                              <1> 	mov     dx, [NABMBAR]
   266                              <1> 	add	dx, GLOB_CNT_REG
   267                              <1> 	in	eax, dx
   268                              <1> 	and	eax, ~(ICH_PCM_246_MASK | ICH_PCM_20BIT)
   269                              <1> 	out	dx, eax
   270                              <1> 
   271                              <1> 	; 05/11/2023
   272                              <1> _ssr:
   273                              <1> 
   274                              <1> ; 05/11/2023
   275                              <1> ;%if 1
   276                              <1> 	AC97_EA_VRA equ 0001h ; 04/11/2023
   277                              <1> 
   278                              <1> 	mov    	dx, [NAMBAR]               	
   279                              <1> 	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah  	  
   280                              <1> 	in     	ax, dx
   281                              <1> 	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
   282                              <1> 	out	dx, ax 				; Enable variable rate audio
   283                              <1> 
   284                              <1>         call    delay1_4ms
   285                              <1>         call    delay1_4ms
   286                              <1>         call    delay1_4ms
   287                              <1>         call    delay1_4ms
   288                              <1> 
   289                              <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   290                              <1> 
   291                              <1> 	mov    	dx, [NAMBAR]               	
   292                              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   293                              <1> 	out	dx, ax 				; out sample rate
   294                              <1> 		
   295                              <1> 	; 05/11/2023 temp
   296                              <1> 	mov    dx, [NAMBAR]               	
   297                              <1> 	add    dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   298                              <1> 	out	dx, ax 
   299                              <1> 
   300                              <1>         call    delay1_4ms
   301                              <1>         call    delay1_4ms
   302                              <1>         call    delay1_4ms
   303                              <1>         call    delay1_4ms
   304                              <1> 
   305                              <1> ;%endif
   306                              <1> 
   307                              <1> ; 05/11/2023
   308                              <1> ;%if 0
   309                              <1> 	mov     dx, [NAMBAR]			; mixer base address
   310                              <1>         add     dx, CODEC_RESET_REG  		; reset register
   311                              <1>         mov	ax, 42
   312                              <1> 	out     dx, ax                          ; reset
   313                              <1> 
   314                              <1> 	mov     dx, [NABMBAR]			; bus master base address
   315                              <1>         add     dx, PORT_NABM_GLB_CTRL_STAT
   316                              <1>         mov	ax, 2
   317                              <1> 	out     dx, ax                         
   318                              <1> 
   319                              <1> 	mov	cx, 7
   320                              <1> _100ms:
   321                              <1> 	push	cx
   322                              <1>         call    delay1_4ms
   323                              <1>         call    delay1_4ms
   324                              <1>         call    delay1_4ms
   325                              <1>         call    delay1_4ms
   326                              <1> 	pop	cx
   327                              <1> 	loop	_100ms
   328                              <1> ;%endif
   329                              <1> 
   330                              <1> 	mov	dx, [NAMBAR]
   331                              <1> 	;add	dx, 0 ; ac_reg_0 ; reset register
   332                              <1> 	out	dx, ax
   333                              <1> 
   334                              <1> 	xor	eax, eax ; 0
   335                              <1> 	mov	dx, [NAMBAR]
   336                              <1> 	add	dx, CODEC_POWER_CTRL_REG ; CODEC_REG_POWERDOWN
   337                              <1> 	out	dx, ax
   338                              <1> 
   339                              <1> 	; wait for (max.) 1 second
   340                              <1> 	mov	cx, 1000 ; 100*0.25ms = 1s
   341                              <1> _ac97_codec_rloop:
   342                              <1> 	call	delay1_4ms
   343                              <1> 	call	delay1_4ms
   344                              <1> 	call	delay1_4ms
   345                              <1> 	call	delay1_4ms
   346                              <1> 	;mov	dx, [NAMBAR]
   347                              <1> 	;add	dx, CODEC_POWER_CTRL_REG ; CODEC_REG_POWERDOWN
   348                              <1> 	in	ax, dx	
   349                              <1> 	and	ax, 0Fh
   350                              <1> 	cmp	al, 0Fh
   351                              <1> 	je	short _ac97_codec_init_ok
   352                              <1> 	loop	_ac97_codec_rloop 
   353                              <1> 
   354                              <1> _ac97_codec_init_ok:
   355                              <1> reset_ac97_controller:
   356                              <1> 	; 04/11/2023
   357                              <1> 	xor     ax, ax
   358                              <1>         mov	dx, PI_CR_REG
   359                              <1> 	add	dx, [NABMBAR]
   360                              <1> 	out     dx, al
   361                              <1> 
   362                              <1>         mov     dx, PO_CR_REG
   363                              <1> 	add	dx, [NABMBAR]
   364                              <1> 	out     dx, al
   365                              <1> 
   366                              <1>         mov     dx, MC_CR_REG
   367                              <1> 	add	dx, [NABMBAR]
   368                              <1> 	out     dx, al
   369                              <1> 
   370                              <1>         mov     al, RR
   371                              <1>         mov     dx, PI_CR_REG
   372                              <1> 	add	dx, [NABMBAR]
   373                              <1> 	out     dx, al
   374                              <1> 
   375                              <1>         mov     dx, PO_CR_REG
   376                              <1> 	add	dx, [NABMBAR]
   377                              <1> 	out     dx, al
   378                              <1> 
   379                              <1>         mov     dx, MC_CR_REG
   380                              <1> 	add	dx, [NABMBAR]
   381                              <1> 	out     dx, al
   382                              <1> 
   383                              <1> setup_ac97_codec:
   384                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   385                              <1> 	; initial ac97 volumes (and clear mute flag)
   386                              <1> 		
   387                              <1>   	mov     dx, [NAMBAR]
   388                              <1>   	add     dx, CODEC_MASTER_VOL_REG        ;02h ; STEREO
   389                              <1>   	;xor	ax, ax ; volume attenuation = 0 (max. volume)
   390                              <1>   	; 03/11/2023
   391                              <1> 	mov	ax, 0202h
   392                              <1> 	out     dx, ax
   393                              <1>  
   394                              <1>   	mov     dx, [NAMBAR]
   395                              <1>   	add     dx, CODEC_MASTER_MONO_VOL_REG   ;06h 
   396                              <1>   	;;xor	ax, ax
   397                              <1> 	;mov	ax, 0202h
   398                              <1>   	out     dx, ax
   399                              <1> 
   400                              <1>   	mov     dx, [NAMBAR]
   401                              <1>   	add     dx, CODEC_PCBEEP_VOL_REG        ;0Ah 
   402                              <1>   	;;xor	ax, ax
   403                              <1>   	;mov	ax, 0202h
   404                              <1> 	out     dx, ax
   405                              <1> 
   406                              <1>   	mov     dx, [NAMBAR]
   407                              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h
   408                              <1>   	;;xor	ax, ax
   409                              <1> 	;mov	ax, 0202h
   410                              <1>   	out     dx, ax
   411                              <1> 
   412                              <1> 	; 05/11/2023 temp
   413                              <1> 	mov     dx, [NAMBAR]
   414                              <1>   	add     dx, 36h				;36h 
   415                              <1> 					; Center + LFE Master Volume
   416                              <1>   	;;xor	ax, ax
   417                              <1> 	;mov	ax, 0202h
   418                              <1>   	out     dx, ax
   419                              <1> 
   420                              <1> 	;mov	ax, 8008h ; Mute
   421                              <1>   	;mov	dx, [NAMBAR]
   422                              <1> 	;add	dx, CODEC_PHONE_VOL_REG		;0Ch
   423                              <1> 	;			 ; AC97_PHONE_VOL ; TAD Input (Mono)
   424                              <1>   	;out	dx, ax
   425                              <1> 	;
   426                              <1>         ;mov	ax, 0808h
   427                              <1>   	;mov	dx, [NAMBAR]
   428                              <1>         ;add	dx, CODEC_LINE_IN_VOL_REG ;10h ; Line Input (Stereo)
   429                              <1>   	;out	dx, ax
   430                              <1> 	;
   431                              <1> 	;;mov	ax, 0808h
   432                              <1>   	;mov	dx, [NAMBAR]
   433                              <1>         ;add	dx, CODEC_CD_VOL_REG ;12h ; CR Input (Stereo)
   434                              <1>   	;out	dx, ax
   435                              <1> 	;
   436                              <1> 	;;mov	ax, 0808h
   437                              <1>   	;mov	dx, [NAMBAR]
   438                              <1>         ;add	dx, CODEC_AUX_VOL_REG ;16h ; Aux Input (Stereo)
   439                              <1>   	;out	dx, ax
   440                              <1> 
   441                              <1> 	; 03/11/2023
   442                              <1>         ;call	delay1_4ms
   443                              <1>         ;call	delay1_4ms
   444                              <1>         ;call	delay1_4ms
   445                              <1> 	;call	delay1_4ms
   446                              <1> 
   447                              <1> 	retn
   448                              <1> 
   449                              <1> %endif
   450                              <1> 
   451                              <1> codecConfig:
   452                              <1> 	; 06/11/2023
   453                              <1> 	; TUNELOOP version (playing without interrupt)
   454                              <1> 	; 04/11/2023
   455                              <1> 	; 17/02/2017 
   456                              <1> 	; 07/11/2016 (Erdogan Tan)
   457                              <1> 
   458 000002E0 A1[AE08]            <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   459                              <1> 
   460 000002E3 8B16[9C08]          <1> 	mov    	dx, [NAMBAR]               	
   461 000002E7 83C22C              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   462 000002EA EF                  <1> 	out	dx, ax 				; out sample rate
   463                              <1> 		
   464                              <1> 	; 05/11/2023 temp
   465                              <1> 	;mov	dx, [NAMBAR]               	
   466                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   467                              <1> 	;out	dx, ax 
   468                              <1> 
   469 000002EB E82902              <1>         call    delay1_4ms
   470 000002EE E82602              <1>         call    delay1_4ms
   471 000002F1 E82302              <1>         call    delay1_4ms
   472 000002F4 E82002              <1>         call    delay1_4ms
   473                              <1> 
   474 000002F7 66A1[AA08]          <1> 	mov	eax, [dev_vendor]
   475 000002FB 663D39101270        <1>         cmp	eax, (SI7012_DID<<16)+SIS_VID
   476 00000301 750B                <1>         jne	short cConfig1
   477                              <1> 
   478                              <1> 	; Unmute quirk specifically for the SiS7012
   479                              <1> 
   480                              <1> 	CUSTOM_SIS_7012_REG equ 4Ch ; SiS7012-specific register
   481                              <1> 	
   482 00000303 8B16[9E08]          <1>         mov     dx, [NABMBAR]
   483 00000307 83C24C              <1>         add     dx, CUSTOM_SIS_7012_REG
   484 0000030A ED                  <1>         in      ax, dx
   485 0000030B 0C01                <1>         or	al, 1
   486 0000030D EF                  <1>         out     dx, ax
   487                              <1> 
   488                              <1> cConfig1:
   489                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   490                              <1> 	; initial ac97 volumes (and clear mute flag)
   491                              <1> 		
   492 0000030E 8B16[9C08]          <1>   	mov     dx, [NAMBAR]
   493 00000312 83C202              <1>   	add     dx, CODEC_MASTER_VOL_REG        ;02h ; STEREO
   494                              <1>   	;xor	ax, ax ; volume attenuation = 0 (max. volume)
   495                              <1>   	; 03/11/2023
   496 00000315 B80202              <1> 	mov	ax, 0202h
   497 00000318 EF                  <1> 	out     dx, ax
   498                              <1> 
   499 00000319 E8FB01              <1>         call    delay1_4ms	; delays because codecs are slow
   500 0000031C E8F801              <1>         call    delay1_4ms
   501 0000031F E8F501              <1>         call    delay1_4ms
   502 00000322 E8F201              <1>         call    delay1_4ms
   503                              <1>  
   504 00000325 8B16[9C08]          <1>   	mov     dx, [NAMBAR]
   505 00000329 83C218              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h
   506                              <1>   	;;xor	ax, ax
   507                              <1> 	;mov	ax, 0202h
   508 0000032C EF                  <1>   	out     dx, ax
   509                              <1> 
   510 0000032D E8E701              <1>         call    delay1_4ms
   511 00000330 E8E401              <1>         call    delay1_4ms
   512 00000333 E8E101              <1>         call    delay1_4ms
   513 00000336 E8DE01              <1>         call    delay1_4ms
   514                              <1>  
   515 00000339 C3                  <1> 	retn
   434                                  %include 'ich_wav.asm' ; 17/02/2017 (ICH AC97 wav playing functions)
     1                              <1> ; 08/11/2023
     2                              <1> ; 06/11/2023
     3                              <1> ; 05/11/2023
     4                              <1> ; 04/11/2023
     5                              <1> ; 03/11/2023
     6                              <1> ; DOS based .WAV player using AC'97 and codec interface.
     7                              <1> ; ---------------------------------------------------------------
     8                              <1> ; NASM version: Erdogan Tan (29/11/2016)
     9                              <1> ; Last Update: 17/02/2017 (by Erdogan Tan)
    10                              <1> 
    11                              <1> ; TUNELOOP version (playing without interrupt) - 06/11/2023 - Erdogan Tan
    12                              <1> 
    13                              <1> ; ICHWAV.ASM
    14                              <1> 
    15                              <1> ; player internal variables and other equates.
    16                              <1> BUFFERSIZE      equ     64 * 1024       ; 64k file buffer size.
    17                              <1> ENDOFFILE       equ     BIT0            ; flag for knowing end of file
    18                              <1> 
    19                              <1> ;===========================================================================
    20                              <1> ; entry: none. File is already open and [filehandle] filled.
    21                              <1> ; exit:  not until the song is finished or the user aborts.
    22                              <1> ;
    23                              <1> playWav:
    24                              <1> 	; 07/11/2023
    25                              <1> 	; clear buffer 2
    26                              <1>         ;push	es
    27                              <1> 	;mov	ax, [WAV_BUFFER2]
    28                              <1> 	;mov	es, ax
    29                              <1> 	;sub	ax, ax
    30                              <1> 	;mov	di, ax ; 17/02/2017
    31                              <1> 	;mov	cx, (BUFFERSIZE/2)
    32                              <1> 	;rep	stosw
    33                              <1> 	;pop	es	     
    34                              <1> 	
    35                              <1> 	; load 64k into buffer 1
    36 0000033A A1[A208]            <1>         mov     ax, [WAV_BUFFER1]
    37 0000033D E8CA00              <1>         call    loadFromFile
    38                              <1> 
    39                              <1> 	; and 64k into buffer 2
    40 00000340 A1[A408]            <1> 	mov     ax, [WAV_BUFFER2]
    41 00000343 E8C400              <1>        	call    loadFromFile
    42                              <1> 
    43                              <1> ; register reset the DMA engine. This may cause a pop noise on the output
    44                              <1> ; lines when the device is reset. Prolly a better idea to mute output, then
    45                              <1> ; reset.
    46                              <1> ;
    47 00000346 8B16[9E08]          <1>         mov     dx, [NABMBAR]
    48 0000034A 83C21B              <1>         add     dx, PO_CR_REG		; set pointer to Ctrl reg
    49 0000034D B002                <1>         mov	al, RR			; set reset
    50 0000034F EE                  <1> 	out     dx, al			; self clearing bit
    51                              <1> 
    52                              <1> ; write last valid index to 31 to start with.
    53                              <1> ; The Last Valid Index register tells the DMA engine when to stop playing.
    54                              <1> ; 
    55                              <1> ; As we progress through the song we change the last valid index to always be
    56                              <1> ; something other than the index we're currently playing.  
    57                              <1> ;
    58                              <1> 	; 08/11/2023
    59                              <1> 	;; 07/11/2023
    60                              <1> 	;mov	al, 1
    61                              <1>         ;;mov	al, 31
    62                              <1> 	;call	setLastValidIndex
    63                              <1> 
    64                              <1> ; create Buffer Descriptor List
    65                              <1> ;
    66                              <1> ; A buffer descriptor list is a list of pointers and control bits that the
    67                              <1> ; DMA engine uses to know where to get the .wav data and how to play it.
    68                              <1> ;
    69                              <1> ; I set it up to use only 2 buffers of .wav data, and whenever 1 buffer is
    70                              <1> ; playing, I refresh the other one with good data.
    71                              <1> ;
    72                              <1> ;
    73                              <1> ; For the control bits, you can specify that the DMA engine fire an interrupt
    74                              <1> ; after a buffer has been processed, but I poll the current index register
    75                              <1> ; to know when it's safe to update the other buffer.
    76                              <1> ;
    77                              <1> ; I set the BUP bit, which tells the DMA engine to just play 0's (silence)
    78                              <1> ; if it ever runs out of data to play. Good for safety.
    79                              <1> ;
    80 00000350 06                  <1>         push    es
    81 00000351 A1[A008]            <1>         mov     ax, [BDL_BUFFER]		; get segment # for BDL
    82 00000354 8EC0                <1>         mov     es, ax
    83                              <1> 
    84 00000356 B91000              <1>         mov     cx, 32 / 2                      ; make 32 entries in BDL
    85 00000359 31FF                <1>         xor     di, di                          
    86                              <1> _0:
    87                              <1> 
    88                              <1> ; set buffer descriptor 0 to start of data file in memory
    89 0000035B 660FB706[A208]      <1>         movzx   eax, word [WAV_BUFFER1]
    90 00000361 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
    91 00000365 66AB                <1>         stosd                                   ; store pointer to wavbuffer1
    92                              <1> 
    93                              <1> ;
    94                              <1> ; set length to 32k samples. 1 sample is 16bits or 2bytes.
    95                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples.
    96                              <1> ; 
    97                              <1> 
    98                              <1> ; 17/02/2017 (Erdogan Tan)
    99                              <1> ; Intel 82801AA (ICH) & Intel 82801AB (ICH0) I/O Controller Hub AC97
   100                              <1> ; Programmers Reference Manual
   101                              <1> 
   102                              <1> ; 2.2.1 Buffer Descriptor List  (on Page 13)
   103                              <1> 	;
   104                              <1> 	;  Generic Form of Buffer Descriptor
   105                              <1> 	;  ---------------------------------
   106                              <1> 	;  63   62    61-48    47-32   31-0
   107                              <1> 	;  ---  ---  --------  ------- -----
   108                              <1> 	;  IOC  BUP -reserved- Buffer  Buffer
   109                              <1> 	;		      Length   Pointer
   110                              <1> 	;		      [15:0]   [31:0]
   111                              <1> 	;
   112                              <1> 	;  IOC:	Interrupt On Completion. 
   113                              <1> 	;	1 = Enabled. 
   114                              <1> 	;	    When this is set, it means that the controller should
   115                              <1> 	;	    issue an interrupt upon completion of this buffer.
   116                              <1> 	;	    It should also set the IOC bit in the status register
   117                              <1> 	;	0 = Disabled	
   118                              <1> 	;
   119                              <1> 	;  BUP: Buffer Underrun Policy.
   120                              <1> 	;       0 = When this buffer is complete,
   121                              <1> 	;	    if the next buffer is not yet ready 
   122                              <1> 	;	    (i.e., the last valid buffer has been processed),
   123                              <1> 	;	    then continue to transmit the last valid sample.
   124                              <1> 	;	1 = When this buffer is complete,
   125                              <1> 	;     	    if this is the last valid buffer, transmit zeros after
   126                              <1> 	;	    this buffer has been processed completely.
   127                              <1> 	;	    This bit typically is set only if this is the last 
   128                              <1> 	;	    buffer in the current stream.
   129                              <1> 	;
   130                              <1> 	; [31:0]: Buffer pointer. This field points to the location of
   131                              <1> 	;	  the data buffer. Since samples can be as wide as one
   132                              <1> 	;	  word, the buffer must be aligned with word boundaries,
   133                              <1> 	;	  to prevent samples from straddling DWord boundaries.
   134                              <1> 	;
   135                              <1> 	; [15:0]: Buffer Length: This is the length of the data buffer,
   136                              <1> 	;	  in number of samples. The controller uses this data
   137                              <1> 	;	  to determine the length of the buffer, in bytes.
   138                              <1> 	;	  "0" indicates no sample to process.
   139                              <1> 
   140                              <1> ; ICH2AC97.INC
   141                              <1> 
   142                              <1> ;	IOC	equ     BIT31   ; Fire an interrupt whenever this
   143                              <1> 				; buffer is complete.
   144                              <1> 
   145                              <1> ;	BUP	equ     BIT30   ; Buffer Underrun Policy.
   146                              <1> 				; if this buffer is the last buffer
   147                              <1> 				; in a playback, fill the remaining
   148                              <1> 				; samples with 0 (silence) or not.
   149                              <1> 				; It's a good idea to set this to 1
   150                              <1> 				; for the last buffer in playback,
   151                              <1> 				; otherwise you're likely to get a lot
   152                              <1> 				; of noise at the end of the sound.
   153                              <1> ;
   154                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   155                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   156                              <1> ; Luckily for us, that's the same format as .wav files.
   157                              <1> ;
   158                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   159                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   160                              <1> ;
   161                              <1> ; A value of 0 in these bits means play no samples.
   162                              <1> ;
   163                              <1> 
   164                              <1> ; ICHWAV.ASM
   165                              <1> 
   166 00000367 66B800800000        <1> 	mov	eax, BUFFERSIZE / 2 ; size of half buffer (32K)
   167                              <1> 	;or	eax, IOC + BUP
   168                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   169 0000036D 660D00000040        <1> 	or	eax, BUP
   170 00000373 66AB                <1> 	stosd
   171                              <1> 
   172                              <1> ; 2nd buffer:
   173                              <1> 
   174 00000375 660FB706[A408]      <1>         movzx   eax, word [WAV_BUFFER2]
   175 0000037B 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   176 0000037F 66AB                <1>         stosd                                   ; store pointer to wavbuffer2
   177                              <1> 
   178                              <1> ; set length to 64k (32k of two 16 bit samples)
   179                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples
   180                              <1> ; 
   181 00000381 66B800800000        <1> 	mov	eax, BUFFERSIZE / 2
   182                              <1> 	;or	eax, IOC + BUP
   183                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   184 00000387 660D00000040        <1> 	or	eax, BUP
   185 0000038D 66AB                <1> 	stosd
   186                              <1> 
   187 0000038F E2CA                <1>         loop    _0
   188 00000391 07                  <1>         pop     es
   189                              <1> 
   190                              <1> ;
   191                              <1> ; tell the DMA engine where to find our list of Buffer Descriptors.
   192                              <1> ; this 32bit value is a flat mode memory offset (ie no segment:offset)
   193                              <1> ;
   194                              <1> ; write NABMBAR+10h with offset of buffer descriptor list
   195                              <1> ;
   196 00000392 660FB706[A008]      <1>         movzx   eax, word [BDL_BUFFER]
   197 00000398 66C1E004            <1> 	shl     eax, 4                          ; convert seg:off to 0:off
   198 0000039C 8B16[9E08]          <1>         mov     dx, [NABMBAR]
   199 000003A0 83C210              <1>         add     dx, PO_BDBAR_REG                ; set pointer to BDL
   200 000003A3 66EF                <1>         out     dx, eax                         ; write to AC97 controller
   201                              <1> 
   202                              <1> ;
   203                              <1> ; All set. Let's play some music.
   204                              <1> ;
   205                              <1> 
   206                              <1> 	; 08/11/2023
   207                              <1> 	; 07/11/2023
   208                              <1> 	; 08/12/2016
   209                              <1> 	; 07/10/2016
   210                              <1>         ;mov	al, 1
   211 000003A5 B01F                <1>         mov	al, 31
   212 000003A7 E85801              <1> 	call	setLastValidIndex
   213                              <1> 
   214                              <1> 	; 06/11/2023 (not neccessary)
   215                              <1> 	;; 05/11/2023
   216                              <1> 	;; reset current index
   217                              <1> 	;mov	al, 0
   218                              <1> 	;call	setCurrentIndex
   219                              <1> 
   220                              <1> 	; 06/11/2023
   221                              <1> 	;mov	byte [tLoop], 1 ; 30/11/2016
   222                              <1> 
   223                              <1> 	; 17/02/2017
   224 000003AA 8B16[9E08]          <1>         mov     dx, [NABMBAR]
   225 000003AE 83C21B              <1>         add     dx, PO_CR_REG                   ; PCM out Control Register
   226                              <1>         ;mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
   227                              <1> 	;			; (LVBI interrupt will not be enabled)
   228                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   229 000003B1 B001                <1> 	mov	al, RPBM
   230 000003B3 EE                  <1> 	out     dx, al                          ; Start bus master operation.
   231                              <1> 
   232                              <1> 	; 06/11/2023
   233                              <1> 	;call	delay1_4ms
   234                              <1> 	;call	delay1_4ms
   235                              <1> 	;call	delay1_4ms
   236                              <1> 	;call	delay1_4ms
   237                              <1> 
   238                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   239                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   240                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   241                              <1>    
   242                              <1> ; 06/11/2023 (TUNELOOP version, without interrupt)
   243                              <1> %if 0
   244                              <1> 	; 08/12/2016
   245                              <1> 	; 28/11/2016
   246                              <1> p_loop:
   247                              <1> 	call    check4keyboardstop      ; keyboard halt?
   248                              <1>         jc	short r_loop 	; no ; 05/11/2023
   249                              <1> 
   250                              <1> 	;mov	byte [tLoop], 0
   251                              <1> 	; 04/11/2023
   252                              <1> 	;mov	byte [audio_play_cmd], 0
   253                              <1> 	;call	ac97_stop
   254                              <1> 	;retn
   255                              <1> _exit_:
   256                              <1> 	; 04/11/2023
   257                              <1> 	; finished with song, stop everything
   258                              <1> 	call	ac97_stop
   259                              <1> 	
   260                              <1> 	; restore previous interrupt vector and interrupt_status
   261                              <1> 	cli
   262                              <1> 	in	al, 0A1h ; irq 8-15
   263                              <1> 	mov	al, [IRQ_status+1]
   264                              <1> 	out	0A1h, al 
   265                              <1> 	in	al, 021h ; irq 0-7
   266                              <1> 	mov	al, [IRQ_status]
   267                              <1> 	out	21h, al 
   268                              <1> 	; ...
   269                              <1> 	push	es
   270                              <1> 	xor	ax, ax
   271                              <1> 	mov	es, ax
   272                              <1> 	mov	ax, [IRQ_vector]
   273                              <1> 	mov	[es:bx], ax
   274                              <1> 	mov	ax, [IRQ_vector+2]
   275                              <1> 	mov	[es:bx+2], ax
   276                              <1> 	pop	es
   277                              <1> 	sti
   278                              <1> 	retn
   279                              <1> 
   280                              <1> r_loop:
   281                              <1> 	; 07/12/2016 - Erdogan Tan
   282                              <1> 	nop
   283                              <1> 	nop
   284                              <1> 	nop
   285                              <1> 	; 17/02/2017
   286                              <1> 	mov	al, [tBuff]
   287                              <1> 	dec	al ; 1-32 -> 0-31 or 0 -> 0FFh
   288                              <1> 	js	short  p_loop
   289                              <1> 	mov	byte [tBuff], 0 ; reset
   290                              <1> 	and	al, 1
   291                              <1> 	jnz	short q_loop
   292                              <1>         mov     ax, [WAV_BUFFER2] ; [tBuff]=2 (from tuneLoop)
   293                              <1> s_loop:
   294                              <1>         call    loadFromFile
   295                              <1> 	;jc	short _exit_
   296                              <1> 	; 05/11/2023
   297                              <1> 	jc	short exit_loop
   298                              <1> 	jmp	short r_loop
   299                              <1> q_loop:
   300                              <1>      	mov     ax, [WAV_BUFFER1] ; [tBuff]=1 (from tuneLoop)
   301                              <1>         ;call	loadFromFile
   302                              <1> 	;jc	short _exit_
   303                              <1> 	;jmp	short r_loop
   304                              <1> 	; 05/11/2023
   305                              <1> 	jmp	short s_loop
   306                              <1> 
   307                              <1> exit_loop: 
   308                              <1> 	mov	byte [tLoop], 0
   309                              <1> 	retn
   310                              <1> 		
   311                              <1> tuneLoop:
   312                              <1> 	; 05/11/2023
   313                              <1> 	; 08/12/2016
   314                              <1> 	; 28/11/2016 - Erdogan Tan
   315                              <1> 	
   316                              <1> 	cmp	byte [tLoop], 1
   317                              <1> 	jb	short _exit_ ; 05/11/2023
   318                              <1> _tlp_1:	
   319                              <1> 	; 17/02/2017
   320                              <1> 	call	getCurrentIndex
   321                              <1> 	inc	al ; 0-31 -> 1-32
   322                              <1> 	mov	[tBuff], al
   323                              <1> 
   324                              <1> 	; 05/11/2023
   325                              <1> 	dec	ax
   326                              <1> 	dec	ax
   327                              <1> 	and	al, 1Fh
   328                              <1> 	call	setLastValidIndex
   329                              <1> 
   330                              <1> 	; 05/11/2023
   331                              <1> 	; 17/02/2017 - Buffer switch test (temporary)
   332                              <1> 	push	ds
   333                              <1> 	push	si 
   334                              <1> 	mov	si, 0B800h ; video display page segment
   335                              <1> 	mov	ds, si
   336                              <1> 	sub	si, si ; 0
   337                              <1> 	mov	ah, 4Eh
   338                              <1> 	and	al, 1
   339                              <1> 	add	al, '1'
   340                              <1> 	mov	[si], ax ; show current play buffer (1, 2)
   341                              <1> 	pop	si
   342                              <1> 	pop	ds
   343                              <1> 
   344                              <1> 	; 17/02/2017
   345                              <1> 
   346                              <1> 	;test	byte [irq_status], LVBCI ; last buff completion intr.
   347                              <1> 	;jz	short _tlp2 ; BCIS ; Buffer completion interrupt
   348                              <1> 
   349                              <1> 	; Last Valid Buffer Completion Interrupt (LVBCI).
   350                              <1> 	;   1 = Last valid buffer has been processed. 
   351                              <1> 	;	It remains active until cleared by software. 
   352                              <1> 	;	This bit indicates the occurrence of the event 
   353                              <1> 	;	signified by the last valid buffer being processed.
   354                              <1> 	;	Thus, this is an event status bit that can be cleared
   355                              <1> 	;	by software once this event has been recognized.
   356                              <1> 	;	This event causes an interrupt if the enable bit
   357                              <1> 	;	in the Control Register is set. The interrupt is
   358                              <1> 	;	cleared when the software clears this bit.
   359                              <1> 	;	In the case of Transmits (PCM out, Modem out) this bit
   360                              <1> 	;	is set, after the last valid buffer has been
   361                              <1> 	;	fetched (not after transmitting it).
   362                              <1> 	;	While in the case of Receives, this bit is set after
   363                              <1> 	;	the data for the last buffer has been written to memory.
   364                              <1> 	;   0 = Cleared by writing a "1" to this bit position.
   365                              <1> 
   366                              <1> 	; Note: We are not using LVBCI 
   367                              <1> 	;     Last Buffer Completion Interrupt !!!
   368                              <1> 
   369                              <1> 	; 17/02/2017
   370                              <1>         ;mov     dx, [NABMBAR]
   371                              <1>         ;add     dx, PO_SR_REG	; PCM out Status register
   372                              <1>         ;mov     al, [irq_status]
   373                              <1>         ;out     dx, al		; Clear (LVBCI) interrupt status
   374                              <1> 	;retn
   375                              <1> 
   376                              <1> ;_tlp2:
   377                              <1> 	; Buffer Completion Interrupt Status (BCIS).
   378                              <1> 	;   1 =	Set by the hardware after the last sample 
   379                              <1> 	; 	of a buffer has been processed, AND if the Interrupt
   380                              <1> 	; 	on Completion (IOC) bit is set in the command byte of 
   381                              <1> 	; 	the buffer descriptor. It remains active
   382                              <1> 	; 	until cleared by software.
   383                              <1> 	;   0 =	Cleared by writing a "1" to this bit position.
   384                              <1> 
   385                              <1> 	; 17/02/2017
   386                              <1>         mov     dx, [NABMBAR]
   387                              <1>         add     dx, PO_SR_REG	; PCM out Status register
   388                              <1>         mov     al, [pcm_irq_status] ; 05/11/2023
   389                              <1>         out     dx, al		; Clear (BCI) interrupt status
   390                              <1> 	retn
   391                              <1> 
   392                              <1> ;_exit_:
   393                              <1> ;	mov	byte [tLoop], 0
   394                              <1> ;_exit:
   395                              <1> ;       ; finished with song, stop everything
   396                              <1> ;	mov     dx, [NABMBAR]		
   397                              <1> ;       add     dx, PO_CR_REG           ; PCM out Control Register
   398                              <1> ;       mov     al, 0
   399                              <1> ;       out     dx, al                  ; stop player
   400                              <1> ;_return:
   401                              <1> ;	retn
   402                              <1> 
   403                              <1> %endif
   404                              <1> 
   405                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   406                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   407                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   408                              <1> 
   409                              <1> ; 08/11/2023
   410                              <1> ; 07/11/2023
   411                              <1> %if 1
   412                              <1> 
   413                              <1> tuneLoop:
   414                              <1> 	; 08/11/2023
   415                              <1> 	; 06/11/2023
   416 000003B4 B031                <1> 	mov	al, '1'
   417 000003B6 E84300              <1> 	call	tL0
   418                              <1> tL1:
   419 000003B9 E81B01              <1> 	call    updateLVI	; /set LVI != CIV/
   420 000003BC 7432                <1> 	jz	short _exit_	; 08/11/2023
   421 000003BE E84A01              <1> 	call    check4keyboardstop
   422 000003C1 722D                <1> 	jc	short _exit_
   423 000003C3 E80801              <1> 	call    getCurrentIndex
   424 000003C6 A801                <1> 	test	al, BIT0
   425 000003C8 74EF                <1> 	jz	short tL1	; loop if buffer 2 is not playing
   426                              <1> 
   427                              <1> 	; load buffer 1
   428 000003CA A1[A208]            <1> 	mov     ax, [WAV_BUFFER1]
   429 000003CD E83A00              <1> 	call	loadFromFile
   430 000003D0 721E                <1> 	jc	short _exit_	; end of file
   431                              <1> 
   432 000003D2 B032                <1> 	mov	al, '2'
   433 000003D4 E82500              <1> 	call	tL0
   434                              <1> tL2:
   435 000003D7 E8FD00              <1> 	call    updateLVI
   436 000003DA 7414                <1> 	jz	short _exit_	; 08/11/2023
   437 000003DC E82C01              <1> 	call    check4keyboardstop
   438 000003DF 720F                <1> 	jc	short _exit_
   439 000003E1 E8EA00              <1> 	call    getCurrentIndex
   440 000003E4 A801                <1> 	test	al, BIT0
   441 000003E6 75EF                <1> 	jnz	short tL2	; loop if buffer 1 is not playing
   442                              <1> 
   443                              <1> 	; load buffer 2
   444 000003E8 A1[A408]            <1> 	mov     ax, [WAV_BUFFER2]
   445 000003EB E81C00              <1> 	call	loadFromFile
   446 000003EE 73C4                <1> 	jnc	short tuneLoop
   447                              <1> _exit_:
   448 000003F0 8B16[9E08]          <1> 	mov	dx, [NABMBAR]		
   449 000003F4 83C21B              <1> 	add	dx, PO_CR_REG	; PCM out Control Register
   450 000003F7 B000                <1> 	mov	al, 0
   451 000003F9 EE                  <1> 	out	dx, al		; stop player
   452                              <1> 
   453 000003FA 0430                <1> 	add	al, '0'
   454                              <1> 	;call	tL0
   455                              <1> 	;
   456                              <1> 	;retn
   457                              <1> 	; 06/11/2023
   458                              <1> 	;jmp	short tL0
   459                              <1> 	;retn
   460                              <1> 
   461                              <1> 	; 06/11/2023
   462                              <1> tL0:
   463                              <1> 	; 08/11/2023
   464                              <1> 	; 05/11/2023
   465                              <1> 	; 17/02/2017 - Buffer switch test (temporary)
   466                              <1> 	; 06/11/2023
   467                              <1> 	; al = buffer indicator ('1', '2' or '0' -stop- )
   468 000003FC 1E                  <1> 	push	ds
   469                              <1> 	;push	bx 
   470 000003FD BB00B8              <1> 	mov	bx, 0B800h ; video display page segment
   471 00000400 8EDB                <1> 	mov	ds, bx
   472 00000402 29DB                <1> 	sub	bx, bx ; 0
   473 00000404 B44E                <1> 	mov	ah, 4Eh
   474 00000406 8907                <1> 	mov	[bx], ax ; show current play buffer (1, 2)
   475                              <1> 	;pop	bx
   476 00000408 1F                  <1> 	pop	ds
   477 00000409 C3                  <1> 	retn
   478                              <1> 
   479                              <1> %endif
   480                              <1> 
   481                              <1> ; 08/11/2023
   482                              <1> ; 07/11/2023
   483                              <1> %if 0
   484                              <1> 
   485                              <1> tuneLoop:
   486                              <1> 	; 07/11/2023
   487                              <1> 	;mov	dx, NABMBAR
   488                              <1> 	;add	dx, PO_CIV_REG ; 14h
   489                              <1> tL1:
   490                              <1> 	call    updateLVI	; set LVI != CIV
   491                              <1> 	call    check4keyboardstop
   492                              <1> 	jc	short _exit_
   493                              <1> 	call    getCurrentIndex
   494                              <1> 	test	al, BIT0
   495                              <1> 	jz	short tL1	; loop if buffer 2 is not playing
   496                              <1> 
   497                              <1> 	; load buffer 1
   498                              <1> 	mov     ax, [WAV_BUFFER1]
   499                              <1> 	call	loadFromFile
   500                              <1> 	jc	short _exit_	; end of file
   501                              <1> tL2:
   502                              <1> 	call    updateLVI
   503                              <1> 	call    check4keyboardstop
   504                              <1> 	jc	short _exit_
   505                              <1> 	call    getCurrentIndex
   506                              <1> 	test	al, BIT0
   507                              <1> 	jnz	short tL2	; loop if buffer 1 is not playing
   508                              <1> 
   509                              <1> 	; load buffer 2
   510                              <1> 	mov     ax, [WAV_BUFFER2]
   511                              <1> 	call	loadFromFile
   512                              <1> 	jnc	short tuneLoop
   513                              <1> _exit_:
   514                              <1> 	mov	dx, [NABMBAR]		
   515                              <1> 	add	dx, PO_CR_REG	; PCM out Control Register
   516                              <1> 	mov	al, 0
   517                              <1> 	out	dx, al		; stop player
   518                              <1> 	retn
   519                              <1> 
   520                              <1> %endif
   521                              <1> 
   522                              <1> ; load data from file in 32k chunks. Would be nice to load 1 64k chunk,
   523                              <1> ; but in DOS you can only load FFFF bytes at a time.
   524                              <1> ;
   525                              <1> ; entry: ax = segment to load data to
   526                              <1> ; exit: CY set if end of file reached.
   527                              <1> ; note: last file buffer is padded with 0's to avoid pops at the end of song.
   528                              <1> ; assumes file is already open. uses [filehandle]
   529                              <1> 
   530                              <1> ; 07/11/2023
   531                              <1> %if 0
   532                              <1> 
   533                              <1> loadFromFile:
   534                              <1> 	; 07/11/2023
   535                              <1> 	; 06/11/2023
   536                              <1> 	; 17/02/2017
   537                              <1> 	;push	ax
   538                              <1> 	;push	cx
   539                              <1> 	;push	dx
   540                              <1> 	;push	bx
   541                              <1> 
   542                              <1> 	;push	es
   543                              <1> 	;push	ds
   544                              <1> 	
   545                              <1>         test    byte [flags], ENDOFFILE	; have we already read the
   546                              <1> 	;stc				; last of the file?
   547                              <1> 	; 05/11/2023
   548                              <1> 	;jnz	endLFF
   549                              <1> 	jz	short lff_12	; 06/11/2023
   550                              <1> 	; 06/11/2023
   551                              <1> 	;;mov	byte [tLoop], 0
   552                              <1> 	;jmp	endLFF
   553                              <1> 	stc
   554                              <1> 	retn
   555                              <1> 
   556                              <1> lff_12:	; 06/11/2023    
   557                              <1> 	mov	[fbs_seg], ax ; save buffer segment
   558                              <1> 	xor	dx, dx
   559                              <1> lff_0:
   560                              <1> 	mov	[fbs_off], dx ; buffer offset
   561                              <1> 
   562                              <1> 	mov     bx, (BUFFERSIZE / 2)	; 32k chunk
   563                              <1> 	mov	cl, [fbs_shift]   
   564                              <1> 	and	cl, cl
   565                              <1> 	jz	short lff_1 ; stereo, 16 bit	
   566                              <1> 
   567                              <1> 	; fbs_shift =
   568                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   569                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   570                              <1> 	shr	bx, cl ; 32K / multiplier
   571                              <1> 
   572                              <1> 	mov	ax, cs
   573                              <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   574                              <1> lff_1:
   575                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   576                              <1> 	; load file into memory
   577                              <1>         mov	cx, bx                         
   578                              <1> 	mov	bx, [filehandle]
   579                              <1> 	mov     ds, ax
   580                              <1>        	mov	ah, 3fh
   581                              <1> 	int	21h
   582                              <1> 
   583                              <1> 	mov	bx, cs
   584                              <1> 	mov	ds, bx
   585                              <1> 
   586                              <1> 	jc	short lff_9 ; error !
   587                              <1> 
   588                              <1> 	and	ax, ax
   589                              <1> 	jz	short lff_10
   590                              <1> 	
   591                              <1> 	mov	bl, [fbs_shift] ; shift count  
   592                              <1> 	or	bl, bl
   593                              <1> 	jz	short lff_7 ; 16 bit stereo samples
   594                              <1> 
   595                              <1> 	push	es
   596                              <1> 	; 06/11/2023
   597                              <1> 	;push	di
   598                              <1> 	;push	si
   599                              <1> 	mov	di, [fbs_off]
   600                              <1> 	mov	si, [fbs_seg] ; buffer segment
   601                              <1> 	mov	es, si
   602                              <1> 	mov	si, temp_buffer ; temporary buffer address
   603                              <1> 	mov	cl, [bps] ; bits per sample (8 or 16)
   604                              <1> 	cmp	cl, 8
   605                              <1> 	jne	short lff_4 ; 16 bit samples
   606                              <1> 	; 8 bit samples
   607                              <1> 	mov	cx, ax ; byte count
   608                              <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   609                              <1> 	jz	short lff_3 ; 8 bit, stereo
   610                              <1> lff_2:
   611                              <1> 	; mono & 8 bit
   612                              <1> 	lodsb
   613                              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   614                              <1> 	stosw	; left channel
   615                              <1> 	stosw	; right channel
   616                              <1> 	loop	lff_2
   617                              <1> 	jmp	short lff_6	
   618                              <1> lff_3:
   619                              <1> 	; stereo & 8 bit
   620                              <1> 	lodsb
   621                              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   622                              <1> 	stosw
   623                              <1> 	loop	lff_3			
   624                              <1> 	jmp	short lff_6
   625                              <1> lff_4:
   626                              <1> 	; 16 bit mono samples
   627                              <1> 	mov	cx, ax ; word count
   628                              <1> lff_5:	
   629                              <1> 	lodsw
   630                              <1> 	stosw	; left channel
   631                              <1> 	stosw	; right channel
   632                              <1> 	loop	lff_5
   633                              <1> lff_6:
   634                              <1> 	mov	ax, di ; save next buffer offset/position
   635                              <1> 	; 06/11/2023
   636                              <1> 	;pop	si
   637                              <1> 	;pop	di
   638                              <1> 	pop	es
   639                              <1> ;lff_7:        
   640                              <1> 	; 06/11/2023
   641                              <1> 	and	ax, ax
   642                              <1> 	jz	short endLFF ; end of 2nd half
   643                              <1> 	mov	cx, (BUFFERSIZE / 2)
   644                              <1> lff_7:
   645                              <1> 	cmp	ax, cx
   646                              <1> 	je	short endLFF	 ; 06/11/2023
   647                              <1> 	;jb	short lff_11
   648                              <1> 	;xor	cx, cx
   649                              <1> 	;sub	cx, ax
   650                              <1> 	;neg	cx
   651                              <1> 	jmp	short lff_11
   652                              <1> lff_8:
   653                              <1> 	; 07/11/2023
   654                              <1> 	cmp	word [fbs_off], (BUFFERSIZE / 2) ; 32768
   655                              <1> 	jnb	short endLFF
   656                              <1> 	
   657                              <1> 	mov	dx, ax ; buffer offset
   658                              <1> 	mov	ax, [fbs_seg] ; buffer segment
   659                              <1> 	jmp	lff_0
   660                              <1> lff_9:  
   661                              <1> 	; 07/11/2023
   662                              <1> 	;; 06/11/2023 (temporary)
   663                              <1> 	;mov	al, '!'  ; error
   664                              <1> 	;call	tL0
   665                              <1> 
   666                              <1> 	xor	ax, ax
   667                              <1> lff_10:
   668                              <1> 	; 07/11/2023
   669                              <1> 	;mov	cx, (BUFFERSIZE / 2)  
   670                              <1> lff_11:
   671                              <1> 	call    padfill				; blank pad the remainder
   672                              <1>         ;clc					; don't exit with CY yet.
   673                              <1>         or	byte [flags], ENDOFFILE		; end of file flag
   674                              <1> endLFF:
   675                              <1>         ;pop	ds
   676                              <1> 	;pop	es
   677                              <1> 	; 06/11/2023
   678                              <1> 	;pop	bx
   679                              <1> 	;pop	dx
   680                              <1>         ;pop	cx
   681                              <1>         ;pop	ax
   682                              <1>         retn
   683                              <1> 
   684                              <1> %endif
   685                              <1> 
   686                              <1> ; 08/11/2023
   687                              <1> ; 07/11/2023
   688                              <1> %if 1
   689                              <1> 
   690                              <1> loadFromFile:
   691                              <1> 	; 07/11/2023
   692                              <1> 
   693 0000040A F606[9A08]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
   694                              <1> 					; last of the file?
   695 0000040F 7402                <1> 	jz	short lff_0		; no
   696 00000411 F9                  <1> 	stc
   697 00000412 C3                  <1> 	retn
   698                              <1> 
   699                              <1> lff_0:
   700                              <1> 	; 08/11/2023
   701 00000413 89C5                <1> 	mov	bp, ax ; save buffer segment	
   702                              <1> 
   703 00000415 8A0E[B408]          <1> 	mov	cl, [fbs_shift]   
   704 00000419 20C9                <1> 	and	cl, cl
   705 0000041B 7467                <1> 	jz	short lff_1 ; stereo, 16 bit	
   706                              <1> 
   707 0000041D BFFFFF              <1> 	mov	di, BUFFERSIZE - 1 ; 65535
   708                              <1> 
   709                              <1> 	; fbs_shift =
   710                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   711                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   712 00000420 D3EF                <1> 	shr	di, cl
   713 00000422 47                  <1> 	inc	di ; 16384 for 8 bit and mono	
   714                              <1> 		   ; 32768 for 8 bit or mono	
   715                              <1> 
   716 00000423 8CC8                <1> 	mov	ax, cs
   717 00000425 BA[B608]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   718                              <1> 
   719                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   720                              <1> 	; load file into memory
   721 00000428 89F9                <1>         mov	cx, di                       
   722 0000042A 8B1E[9808]          <1> 	mov	bx, [filehandle]
   723 0000042E 8ED8                <1> 	mov     ds, ax
   724 00000430 B43F                <1>        	mov	ah, 3Fh
   725 00000432 CD21                <1> 	int	21h
   726                              <1> 
   727 00000434 8CCB                <1> 	mov	bx, cs
   728 00000436 8EDB                <1> 	mov	ds, bx
   729                              <1> 
   730 00000438 727C                <1> 	jc	short lff_4 ; error !
   731                              <1> 
   732                              <1> 	; 08/11/2023
   733 0000043A 31D2                <1> 	xor	dx, dx ; 0
   734                              <1> 
   735 0000043C 21C0                <1> 	and	ax, ax
   736 0000043E 746D                <1> 	jz	short lff_3
   737                              <1> 
   738 00000440 8A1E[B408]          <1> 	mov	bl, [fbs_shift]
   739                              <1> 
   740 00000444 06                  <1> 	push	es
   741 00000445 89D7                <1> 	mov	di, dx ; 0 ; [fbs_off]
   742                              <1> 	;mov	bp, [fbs_seg] ; buffer segment
   743 00000447 8EC5                <1> 	mov	es, bp
   744 00000449 BE[B608]            <1> 	mov	si, temp_buffer ; temporary buffer address
   745 0000044C 89C1                <1> 	mov	cx, ax ; byte count
   746 0000044E 803E[B208]08        <1> 	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   747 00000453 751B                <1> 	jne	short lff_7 ; 16 bit samples
   748                              <1> 	; 8 bit samples
   749 00000455 FECB                <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   750 00000457 740C                <1> 	jz	short lff_6 ; 8 bit, stereo
   751                              <1> lff_5:
   752                              <1> 	; mono & 8 bit
   753 00000459 AC                  <1> 	lodsb
   754 0000045A 2C80                <1> 	sub	al, 80h ; 08/11/2023
   755 0000045C C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   756 0000045F AB                  <1> 	stosw	; left channel
   757 00000460 AB                  <1> 	stosw	; right channel
   758 00000461 E2F6                <1> 	loop	lff_5
   759 00000463 EB12                <1> 	jmp	short lff_9	
   760                              <1> lff_6:
   761                              <1> 	; stereo & 8 bit
   762 00000465 AC                  <1> 	lodsb
   763 00000466 2C80                <1> 	sub	al, 80h ; 08/11/2023
   764 00000468 C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   765 0000046B AB                  <1> 	stosw
   766 0000046C E2F7                <1> 	loop	lff_6			
   767 0000046E EB07                <1> 	jmp	short lff_9
   768                              <1> lff_7:
   769 00000470 D1E9                <1> 	shr	cx, 1 ; word count
   770                              <1> lff_8:
   771 00000472 AD                  <1> 	lodsw
   772 00000473 AB                  <1> 	stosw	; left channel
   773 00000474 AB                  <1> 	stosw	; right channel
   774 00000475 E2FB                <1> 	loop	lff_8
   775                              <1> lff_9:
   776 00000477 07                  <1> 	pop	es
   777 00000478 09FF                <1> 	or	di, di
   778 0000047A 7439                <1> 	jz	short endLFF ; 64KB ok 
   779                              <1> 	
   780 0000047C 89F8                <1> 	mov	ax, di ; [fbs_off]
   781 0000047E 48                  <1> 	dec	ax
   782 0000047F B9FFFF              <1> 	mov	cx, BUFFERSIZE - 1 ; 65535
   783 00000482 EB29                <1> 	jmp	short lff_3
   784                              <1> 	
   785                              <1> lff_1:  
   786                              <1> 	;mov	bp, ax ; save buffer segment
   787 00000484 31D2                <1> 	xor	dx, dx
   788                              <1> 	; load file into memory
   789 00000486 B90080              <1>         mov	cx, (BUFFERSIZE / 2)	; 32k chunk
   790 00000489 8B1E[9808]          <1> 	mov	bx, [filehandle]
   791 0000048D 8ED8                <1> 	mov     ds, ax
   792 0000048F B43F                <1>        	mov	ah, 3Fh
   793 00000491 CD21                <1> 	int	21h
   794                              <1> 
   795 00000493 8CCF                <1> 	mov	di, cs
   796 00000495 8EDF                <1> 	mov	ds, di
   797                              <1> 
   798                              <1> 	; 07/11/2023
   799 00000497 721D                <1> 	jc	short lff_4 ; error !
   800                              <1> 	
   801 00000499 39C8                <1> 	cmp	ax, cx
   802 0000049B 7510                <1> 	jne	short lff_3
   803                              <1> lff_2:
   804                              <1> 	; 08/11/2023
   805 0000049D 01C2                <1> 	add	dx, ax
   806                              <1> 	;mov	cx, (BUFFERSIZE / 2)	; 32k chunk
   807                              <1> 	;mov	bx, [filehandle]
   808 0000049F 8EDD                <1> 	mov     ds, bp
   809 000004A1 B43F                <1>        	mov	ah, 3Fh
   810 000004A3 CD21                <1> 	int	21h
   811                              <1> 
   812                              <1> 	;mov	di, cs
   813 000004A5 8EDF                <1> 	mov	ds, di
   814                              <1> 
   815 000004A7 720D                <1> 	jc	short lff_4 ; error !
   816                              <1> 
   817 000004A9 39C8                <1> 	cmp	ax, cx
   818 000004AB 7408                <1> 	je	short endLFF
   819                              <1> lff_3:
   820 000004AD E80F00              <1> 	call    padfill			; blank pad the remainder
   821                              <1>         ;clc				; don't exit with CY yet.
   822 000004B0 800E[9A08]01        <1>         or	byte [flags], ENDOFFILE	; end of file flag
   823                              <1> endLFF:
   824 000004B5 C3                  <1>         retn
   825                              <1> lff_4:
   826                              <1> 	; 08/11/2023
   827 000004B6 B021                <1> 	mov	al, '!'  ; error
   828 000004B8 E841FF              <1> 	call	tL0
   829                              <1> 
   830 000004BB 31C0                <1> 	xor	ax, ax
   831 000004BD EBEE                <1> 	jmp	short lff_3
   832                              <1> 
   833                              <1> %endif
   834                              <1> 
   835                              <1> ; entry ds:ax points to last byte in file
   836                              <1> ; cx=target size
   837                              <1> ; note: must do byte size fill
   838                              <1> ; destroys bx, cx
   839                              <1> ;
   840                              <1> padfill:
   841                              <1> 	; 07/11/2023
   842                              <1> 	; 06/11/2023
   843                              <1> 	; 17/02/2017
   844 000004BF 06                  <1> 	push	es
   845                              <1>         ;push	di
   846                              <1> 	;mov	di, [fbs_seg]
   847                              <1> 	;mov	es, di
   848 000004C0 8EC5                <1>         mov	es, bp
   849 000004C2 29C1                <1> 	sub	cx, ax
   850                              <1> 	; 08/11/2023
   851                              <1> 	;mov	di, ax ; (wrong)
   852 000004C4 89D7                <1> 	mov	di, dx ; buffer offset
   853 000004C6 01C7                <1> 	add	di, ax       	
   854                              <1> 	; 07/11/2023
   855                              <1> 	;add	di, [fbs_off]
   856 000004C8 30C0                <1>         xor	al, al
   857 000004CA F3AA                <1> 	rep	stosb
   858                              <1> 	;mov	[fbs_off], di
   859                              <1> 	;pop	di
   860 000004CC 07                  <1>         pop	es
   861 000004CD C3                  <1> 	retn
   862                              <1> 
   863                              <1> ; returns AL = current index value
   864                              <1> getCurrentIndex:
   865                              <1> 	; 08/11/2023
   866                              <1> 	;push	dx
   867 000004CE 8B16[9E08]          <1> 	mov	dx, [NABMBAR]      		
   868 000004D2 83C214              <1> 	add	dx, PO_CIV_REG
   869 000004D5 EC                  <1> 	in	al, dx
   870                              <1> 	;pop	dx
   871                              <1> uLVI2:	;	06/11/2023
   872 000004D6 C3                  <1> 	retn
   873                              <1> 
   874                              <1> ; examines the CIV and the LVI. When they're the same, we set LVI <> CIV
   875                              <1> ; that way, we never run out of buffers to play
   876                              <1> 
   877                              <1> ; 08/11/2023
   878                              <1> %if 0
   879                              <1> 	; 07/11/2023
   880                              <1> updateLVI:
   881                              <1> 	push	ax
   882                              <1> 	push	dx
   883                              <1> 	; 06/11/2023
   884                              <1> 	mov	dx, [NABMBAR]
   885                              <1> 	add	dx, PO_CIV_REG
   886                              <1> 	; (Current Index Value and Last Valid Index value)
   887                              <1> 	in	ax, dx
   888                              <1> 
   889                              <1> 	cmp	al, ah ; is current index = last index ?
   890                              <1> 	jne	short uLVI1
   891                              <1> 
   892                              <1> 	call	setNewIndex
   893                              <1> uLVI1:
   894                              <1> 	pop	dx
   895                              <1> 	pop	ax
   896                              <1> 	retn
   897                              <1> 
   898                              <1> setNewIndex:
   899                              <1> 	; 07/11/2023
   900                              <1> 	push	ax
   901                              <1>         call    getCurrentIndex                 ; get CIV
   902                              <1>         test    byte [flags], ENDOFFILE
   903                              <1>         jnz     short sni_1
   904                              <1>         ; not at the end of the file yet.
   905                              <1>         dec     al                              ; make new index <> current
   906                              <1>         and     al, INDEX_MASK                  ; make sure new value is 0-31
   907                              <1> sni_1:
   908                              <1>         call    setLastValidIndex               ; write new value
   909                              <1>         clc
   910                              <1>         pop	ax
   911                              <1> 	retn
   912                              <1> 
   913                              <1> %endif	
   914                              <1> 
   915                              <1> ; 08/11/2023
   916                              <1> ; 07/11/2023
   917                              <1> ;%if 1
   918                              <1> updateLVI:
   919                              <1> 	; 06/11/2023
   920 000004D7 8B16[9E08]          <1> 	mov	dx, [NABMBAR]      		
   921 000004DB 83C214              <1> 	add	dx, PO_CIV_REG
   922                              <1> 	; (Current Index Value and Last Valid Index value)
   923 000004DE ED                  <1> 	in	ax, dx
   924                              <1> 
   925 000004DF 38E0                <1> 	cmp	al, ah ; is current index = last index ?
   926 000004E1 75F3                <1> 	jne	short uLVI2
   927                              <1> 
   928                              <1> 	; 08/11/2023	
   929 000004E3 E8E8FF              <1> 	call	getCurrentIndex
   930                              <1>  
   931 000004E6 F606[9A08]01        <1> 	test	byte [flags], ENDOFFILE
   932                              <1> 	;jnz	short uLVI1
   933 000004EB 7411                <1> 	jz	short uLVI0  ; 08/11/2023
   934                              <1> 
   935                              <1> 	; 08/11/2023
   936 000004ED 50                  <1> 	push	ax
   937 000004EE 8B16[9E08]          <1> 	mov	dx, [NABMBAR]
   938 000004F2 83C216              <1> 	add	dx, PO_SR_REG  ; PCM out status register
   939 000004F5 ED                  <1> 	in	ax, dx
   940                              <1> 
   941 000004F6 A803                <1> 	test	al, 3 ; bit 1 = Current Equals Last Valid (CELV)
   942                              <1> 		      ; (has been processed)
   943                              <1> 		      ; bit 0 = 1 -> DMA Controller Halted (DCH)
   944 000004F8 58                  <1> 	pop	ax
   945 000004F9 7407                <1> 	jz	short uLVI1
   946                              <1> uLVI3:
   947 000004FB 31C0                <1> 	xor	ax, ax
   948                              <1> 	; zf = 1
   949 000004FD C3                  <1> 	retn
   950                              <1> uLVI0:
   951                              <1>         ; not at the end of the file yet.
   952 000004FE FEC8                <1> 	dec	al
   953 00000500 241F                <1> 	and	al, 1Fh
   954                              <1> uLVI1:
   955                              <1> 	;call	setLastValidIndex
   956                              <1> ;uLVI2:
   957                              <1> 	;retn
   958                              <1> 
   959                              <1> ;%endif
   960                              <1> 	
   961                              <1> ;input AL = index # to stop on
   962                              <1> setLastValidIndex:
   963                              <1> 	; 08/11/2023
   964                              <1> 	;push	dx
   965 00000502 8B16[9E08]          <1> 	mov	dx, [NABMBAR]
   966 00000506 83C215              <1> 	add	dx, PO_LVI_REG
   967 00000509 EE                  <1>         out     dx, al
   968                              <1> 	;pop	dx
   969 0000050A C3                  <1> 	retn
   970                              <1> 
   971                              <1> ; 06/11/2023
   972                              <1> ;	; 05/11/2023
   973                              <1> ;setCurrentIndex:
   974                              <1> ;	;push	dx
   975                              <1> ;	mov	dx, [NABMBAR]
   976                              <1> ;	add	dx, PO_CIV_REG
   977                              <1> ;	out	dx, al
   978                              <1> ;	;pop	dx
   979                              <1> ;	retn
   980                              <1> 
   981                              <1> ; checks if either shift key has been pressed. Exits with CY if so.
   982                              <1> ; 
   983                              <1> check4keyboardstop:
   984                              <1> 
   985                              <1> ; 06/11/2023
   986                              <1> %if 1
   987                              <1> 	; 08/11/2023
   988                              <1> 	; 04/11/2023
   989 0000050B B401                <1> 	mov	ah, 1
   990 0000050D CD16                <1> 	int	16h
   991 0000050F 7405                <1> 	jz	short _cksr
   992 00000511 30E4                <1> 	xor	ah, ah
   993 00000513 CD16                <1> 	int	16h
   994 00000515 F9                  <1> 	stc
   995                              <1> _cksr:
   996 00000516 C3                  <1> 	retn
   997                              <1> %endif
   998                              <1> 
   999                              <1> ; 06/11/2023
  1000                              <1> ; 04/11/2023
  1001                              <1> %if 0	
  1002                              <1>         push    ds
  1003                              <1>         push    0
  1004                              <1>         pop     ds		       ; examine BDA for keyboard flags
  1005                              <1>         test    byte [417h], (BIT0 | BIT1)
  1006                              <1>         pop     ds
  1007                              <1>         stc
  1008                              <1>         jnz	short _cksr ; 07/11/2023
  1009                              <1> 	;jz	short _cksr ; 06/11/2023
  1010                              <1>         clc
  1011                              <1> _cksr:
  1012                              <1>         retn
  1013                              <1> %endif
   435                                  
   436                                  ; UTILS.ASM
   437                                  ;----------------------------------------------------------------------------
   438                                  ;       delay1_4ms - Delay for 1/4 millisecond.
   439                                  ;		    1mS = 1000us
   440                                  ;       Entry:
   441                                  ;         None
   442                                  ;       Exit:
   443                                  ;	  None
   444                                  ;
   445                                  ;       Modified:
   446                                  ;         None
   447                                  ;
   448                                  PORTB			EQU	061h
   449                                    REFRESH_STATUS	EQU	010h		; Refresh signal status
   450                                  
   451                                  delay1_4ms:
   452 00000517 50                              push    ax 
   453 00000518 51                              push    cx
   454 00000519 B91000                          mov     cx, 16			; close enough.
   455 0000051C E461                    	in	al,PORTB
   456 0000051E 2410                    	and	al,REFRESH_STATUS
   457 00000520 88C4                    	mov	ah,al			; Start toggle state
   458 00000522 09C9                    	or	cx, cx
   459 00000524 7401                    	jz	short _d4ms1
   460 00000526 41                      	inc	cx			; Throwaway first toggle
   461                                  _d4ms1:	
   462 00000527 E461                    	in	al,PORTB		; Read system control port
   463 00000529 2410                    	and	al,REFRESH_STATUS	; Refresh toggles 15.085 microseconds
   464 0000052B 38C4                    	cmp	ah,al
   465 0000052D 74F8                    	je	short _d4ms1		; Wait for state change
   466                                  
   467 0000052F 88C4                    	mov	ah,al			; Update with new state
   468 00000531 49                      	dec	cx
   469 00000532 75F3                    	jnz	short _d4ms1
   470                                  
   471 00000534 59                              pop     cx
   472 00000535 58                              pop     ax
   473 00000536 C3                              retn
   474                                  
   475                                  	; 13/11/2016 - Erdogan Tan
   476                                  write_ac97_dev_info:
   477                                  	; BUS/DEV/FN
   478                                  	;	00000000BBBBBBBBDDDDDFFF00000000
   479                                  	; DEV/VENDOR
   480                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
   481                                  
   482 00000537 30FF                    	xor	bh, bh
   483 00000539 668B36[AA08]            	mov	esi, [dev_vendor]
   484 0000053E 89F0                    	mov	ax, si
   485 00000540 88C3                    	mov	bl, al
   486 00000542 88DA                    	mov	dl, bl
   487 00000544 80E30F                  	and	bl, 0Fh
   488 00000547 8A87[9407]              	mov	al, [bx+hex_chars]
   489 0000054B A2[D707]                	mov	[msgVendorId+3], al
   490 0000054E 88D3                    	mov	bl, dl
   491 00000550 C0EB04                  	shr	bl, 4
   492 00000553 8A87[9407]              	mov	al, [bx+hex_chars]
   493 00000557 A2[D607]                	mov	[msgVendorId+2], al
   494 0000055A 88E3                    	mov	bl, ah
   495 0000055C 88DA                    	mov	dl, bl
   496 0000055E 80E30F                  	and	bl, 0Fh
   497 00000561 8A87[9407]              	mov	al, [bx+hex_chars]
   498 00000565 A2[D507]                	mov	[msgVendorId+1], al
   499 00000568 88D3                    	mov	bl, dl
   500 0000056A C0EB04                  	shr	bl, 4
   501 0000056D 8A87[9407]              	mov	al, [bx+hex_chars]
   502 00000571 A2[D407]                	mov	[msgVendorId], al
   503 00000574 66C1EE10                	shr	esi, 16
   504 00000578 89F0                    	mov	ax, si
   505 0000057A 88C3                    	mov	bl, al
   506 0000057C 88DA                    	mov	dl, bl
   507 0000057E 80E30F                  	and	bl, 0Fh
   508 00000581 8A87[9407]              	mov	al, [bx+hex_chars]
   509 00000585 A2[E807]                	mov	[msgDevId+3], al
   510 00000588 88D3                    	mov	bl, dl
   511 0000058A C0EB04                  	shr	bl, 4
   512 0000058D 8A87[9407]              	mov	al, [bx+hex_chars]
   513 00000591 A2[E707]                	mov	[msgDevId+2], al
   514 00000594 88E3                    	mov	bl, ah
   515 00000596 88DA                    	mov	dl, bl
   516 00000598 80E30F                  	and	bl, 0Fh
   517 0000059B 8A87[9407]              	mov	al, [bx+hex_chars]
   518 0000059F A2[E607]                	mov	[msgDevId+1], al
   519 000005A2 88D3                    	mov	bl, dl
   520 000005A4 C0EB04                  	shr	bl, 4
   521 000005A7 8A87[9407]              	mov	al, [bx+hex_chars]
   522 000005AB A2[E507]                	mov	[msgDevId], al
   523                                  
   524 000005AE 668B36[A608]            	mov	esi, [bus_dev_fn]
   525 000005B3 66C1EE08                	shr	esi, 8
   526 000005B7 89F0                    	mov	ax, si
   527 000005B9 88C3                    	mov	bl, al
   528 000005BB 88DA                    	mov	dl, bl
   529 000005BD 80E307                  	and	bl, 7 ; bit 0,1,2
   530 000005C0 8A87[9407]              	mov	al, [bx+hex_chars]
   531 000005C4 A2[0C08]                	mov	[msgFncNo+1], al
   532 000005C7 88D3                    	mov	bl, dl
   533 000005C9 C0EB03                  	shr	bl, 3
   534 000005CC 88DA                    	mov	dl, bl
   535 000005CE 80E30F                  	and	bl, 0Fh
   536 000005D1 8A87[9407]              	mov	al, [bx+hex_chars]
   537 000005D5 A2[FE07]                	mov	[msgDevNo+1], al
   538 000005D8 88D3                    	mov	bl, dl
   539 000005DA C0EB04                  	shr	bl, 4
   540 000005DD 8A87[9407]              	mov	al, [bx+hex_chars]
   541 000005E1 A2[FD07]                	mov	[msgDevNo], al
   542 000005E4 88E3                    	mov	bl, ah
   543 000005E6 88DA                    	mov	dl, bl
   544 000005E8 80E30F                  	and	bl, 0Fh
   545 000005EB 8A87[9407]              	mov	al, [bx+hex_chars]
   546 000005EF A2[F207]                	mov	[msgBusNo+1], al
   547 000005F2 88D3                    	mov	bl, dl
   548 000005F4 C0EB04                  	shr	bl, 4
   549 000005F7 8A87[9407]              	mov	al, [bx+hex_chars]
   550 000005FB A2[F107]                	mov	[msgBusNo], al
   551                                  
   552 000005FE A1[9C08]                	mov	ax, [NAMBAR]
   553 00000601 88C3                    	mov	bl, al
   554 00000603 88DA                    	mov	dl, bl
   555 00000605 80E30F                  	and	bl, 0Fh
   556 00000608 8A87[9407]              	mov	al, [bx+hex_chars]
   557 0000060C A2[1B08]                	mov	[msgNamBar+3], al
   558 0000060F 88D3                    	mov	bl, dl
   559 00000611 C0EB04                  	shr	bl, 4
   560 00000614 8A87[9407]              	mov	al, [bx+hex_chars]
   561 00000618 A2[1A08]                	mov	[msgNamBar+2], al
   562 0000061B 88E3                    	mov	bl, ah
   563 0000061D 88DA                    	mov	dl, bl
   564 0000061F 80E30F                  	and	bl, 0Fh
   565 00000622 8A87[9407]              	mov	al, [bx+hex_chars]
   566 00000626 A2[1908]                	mov	[msgNamBar+1], al
   567 00000629 88D3                    	mov	bl, dl
   568 0000062B C0EB04                  	shr	bl, 4
   569 0000062E 8A87[9407]              	mov	al, [bx+hex_chars]
   570 00000632 A2[1808]                	mov	[msgNamBar], al
   571                                  
   572                                  	; 05/11/2023
   573 00000635 A1[9E08]                	mov	ax, [NABMBAR]
   574 00000638 88C3                    	mov	bl, al
   575 0000063A 88DA                    	mov	dl, bl
   576 0000063C 80E30F                  	and	bl, 0Fh
   577 0000063F 678A83[94070000]        	mov	al, [ebx+hex_chars]
   578 00000646 A2[2A08]                	mov	[msgNabmBar+3], al
   579 00000649 88D3                    	mov	bl, dl
   580 0000064B C0EB04                  	shr	bl, 4
   581 0000064E 678A83[94070000]        	mov	al, [ebx+hex_chars]
   582 00000655 A2[2908]                	mov	[msgNabmBar+2], al
   583 00000658 88E3                    	mov	bl, ah
   584 0000065A 88DA                    	mov	dl, bl
   585 0000065C 80E30F                  	and	bl, 0Fh
   586 0000065F 678A83[94070000]        	mov	al, [ebx+hex_chars]
   587 00000666 A2[2808]                	mov	[msgNabmBar+1], al
   588 00000669 88D3                    	mov	bl, dl
   589 0000066B C0EB04                  	shr	bl, 4
   590 0000066E 678A83[94070000]        	mov	al, [ebx+hex_chars]
   591 00000675 A2[2708]                	mov	[msgNabmBar], al
   592                                  
   593                                  	; 24/11/2016
   594 00000678 30E4                    	xor	ah, ah
   595 0000067A A0[9B08]                	mov	al, [ac97_int_ln_reg]
   596 0000067D B10A                    	mov	cl, 10
   597 0000067F F6F1                    	div	cl
   598 00000681 0106[3208]              	add	[msgIRQ], ax
   599 00000685 20C0                    	and	al, al
   600 00000687 7508                    	jnz	short _pmi
   601 00000689 A0[3308]                	mov	al, [msgIRQ+1]
   602 0000068C B420                    	mov	ah, ' '
   603 0000068E A3[3208]                	mov	[msgIRQ], ax
   604                                  _pmi:
   605 00000691 BA[A507]                        mov	dx, msgAC97Info
   606 00000694 B409                            mov     ah, 9
   607 00000696 CD21                            int     21h
   608 00000698 C3                              retn
   609                                  
   610                                  write_sample_rate:
   611                                  	; ax = sample rate (hertz)
   612                                  
   613 00000699 31D2                    	xor	dx, dx
   614 0000069B B90A00                  	mov	cx, 10
   615 0000069E F7F1                    	div	cx
   616 000006A0 0016[4808]              	add	[msgHertz+4], dl
   617 000006A4 29D2                    	sub	dx, dx
   618 000006A6 F7F1                    	div	cx
   619 000006A8 0016[4708]              	add	[msgHertz+3], dl
   620 000006AC 29D2                    	sub	dx, dx
   621 000006AE F7F1                    	div	cx
   622 000006B0 0016[4608]              	add	[msgHertz+2], dl
   623 000006B4 29D2                    	sub	dx, dx
   624 000006B6 F7F1                    	div	cx
   625 000006B8 0016[4508]              	add	[msgHertz+1], dl
   626 000006BC 0006[4408]              	add	[msgHertz], al
   627                                  	
   628 000006C0 BA[3708]                        mov     dx, msgSampleRate
   629 000006C3 B409                            mov     ah, 9
   630 000006C5 CD21                            int     21h
   631                                  
   632                                  	; 19/11/2016
   633 000006C7 BA[5D08]                	mov	dx, msg16Bits
   634 000006CA 803E[B208]10            	cmp	byte [bps], 16
   635 000006CF 7403                    	je	short wsr_1
   636 000006D1 BA[4E08]                	mov	dx, msg8Bits
   637                                  wsr_1:
   638 000006D4 B409                            mov     ah, 9
   639 000006D6 CD21                            int     21h
   640                                  
   641 000006D8 BA[5608]                	mov	dx, msgMono
   642 000006DB 803E[B008]01            	cmp	byte [stmo], 1
   643 000006E0 7403                    	je	short wsr_2
   644 000006E2 BA[6608]                	mov	dx, msgStereo		
   645                                  wsr_2:
   646 000006E5 B409                            mov     ah, 9
   647 000006E7 CD21                            int     21h
   648                                  
   649 000006E9 C3                              retn
   650                                  
   651                                  ;detect_codec:
   652                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   653                                  ;	mov	eax, 7Ch
   654                                  ;	call	codec_read
   655                                  ;       shl     eax, 16
   656                                  ;       mov     [codec_id], eax
   657                                  ;
   658                                  ;	mov	eax, 7Eh
   659                                  ;       call	codec_read
   660                                  ;       or      eax, [codec_id]
   661                                  ;       mov     [codec_chip_id], eax
   662                                  ;       and     eax, 0FFFFFF00h
   663                                  ;
   664                                  ;       mov     edi, codecs
   665                                  ;_dcb:
   666                                  ;       mov     ebx, [di]
   667                                  ;       test    ebx, ebx
   668                                  ;       jz      short _dco_unknown
   669                                  ;
   670                                  ;       cmp     eax, ebx
   671                                  ;       jne     short _dco_next
   672                                  ;       mov     ax, [di+4]
   673                                  ;       mov     [codec_vendor_ids], ax
   674                                  ;       movzx   esi, ax
   675                                  ;       call	print_msg
   676                                  ;       
   677                                  ;	mov	ax, [di+6]
   678                                  ;	call	detect_chip
   679                                  ;       retn
   680                                  ;
   681                                  ;_dco_next:
   682                                  ;       add     di, 8
   683                                  ;       jmp     short _dcb
   684                                  ;
   685                                  ;_dco_unknown:
   686                                  ;       mov    word [codec_vendor_ids], ac_unknown
   687                                  ;       mov    word [codec_chip_ids], chip_unknown
   688                                  ;       mov     esi, chip_unknown
   689                                  ;	call	print_msg
   690                                  ;       mov     eax, [codec_chip_id]
   691                                  ;       call    dword2str
   692                                  ;       call	print_msg
   693                                  ;       retn
   694                                  
   695                                  ;detect_chip:
   696                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   697                                  ;	mov	di, ax ; chip_tab
   698                                  ;       mov     eax, [codec_chip_id]
   699                                  ;       and     ax, 0FFh
   700                                  ;_dch1:
   701                                  ;       mov     bx, [di]
   702                                  ;       cmp     bx, 0FFh
   703                                  ;       je      short _dch_unknown
   704                                  ;
   705                                  ;       cmp     ax, bx
   706                                  ;       jne     short _dch_next
   707                                  ;       mov     ax, [di+2]
   708                                  ;       mov     [codec_chip_ids], ax
   709                                  ;       mov     si, ax
   710                                  ;       call	print_msg
   711                                  ;       retn
   712                                  
   713                                  ;_dch_next:
   714                                  ;       add     di, 4
   715                                  ;       jmp     short _dch1
   716                                  ;
   717                                  ;_dch_unknown:
   718                                  ;       mov    word [codec_chip_ids], chip_unknown
   719                                  ;       mov     si, chip_unknown
   720                                  ;       call	print_msg
   721                                  ;       mov     eax, [codec_chip_id]
   722                                  ;       call    dword2str
   723                                  ;       call	print_msg
   724                                  ;       retn
   725                                  
   726                                  ; 06/11/2023
   727                                  %if 0
   728                                  
   729                                  ac97_int_handler:
   730                                  	; 17/02/2016
   731                                  	push	ax
   732                                  	push	dx
   733                                  	; 05/11/2023	
   734                                  	;push	cx
   735                                  	;push	bx
   736                                  	;push	si
   737                                  	;push	di
   738                                  
   739                                  	cmp	byte [inside], 1
   740                                  	jnb	short _busy
   741                                  
   742                                  	mov	byte [inside], 1
   743                                  
   744                                          mov     dx, [NABMBAR]
   745                                          add     dx, PO_SR_REG	; set pointer to Status reg
   746                                  	in	al, dx
   747                                  	mov	[pcm_irq_status], al ; 05/11/2023
   748                                  	test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
   749                                  	jz	short _ih_3
   750                                  
   751                                  	; 28/11/2016 - Erdogan Tan
   752                                  	call	tuneLoop
   753                                  _ih0:
   754                                  	mov	byte [inside], 0
   755                                  _busy:
   756                                  	mov	al, 20h
   757                                  	test	byte [ac97_int_ln_reg], 8
   758                                  	jz	short _ih_1
   759                                  	out 	0A0h, al ; 20h ; EOI
   760                                  _ih_1:
   761                                  	out	20h, al  ; 20h ; EOI
   762                                  _ih_2:
   763                                  	;pop	di
   764                                  	;pop	si
   765                                  	;pop	bx
   766                                  	;pop	cx
   767                                  	pop	dx
   768                                  	pop	ax
   769                                  	iret
   770                                  _ih_3:
   771                                  	; 17/02/2017
   772                                  	out	dx, al ; clear interrupt event (by writing 1 to same bits)
   773                                  	jmp	short _ih0
   774                                  
   775                                  ac97_stop:
   776                                  	; 05/11/2023
   777                                  	; 04/11/2023 
   778                                  	; 28/05/2017 (TRDOS 386 v2, 'audio.s')
   779                                  	mov	byte [tLoop], 0 ; stop ! ; 05/11/2023
   780                                  ;_ac97_stop:
   781                                  	; 04/11/2023
   782                                  	; 09/10/2017 (TRDOS 386 v2, 'audio.s')
   783                                  	; 11/06/2017
   784                                  	xor	al, al ; 0
   785                                  	call	ac97_po_cmd
   786                                  
   787                                  	; (Ref: KolibriOS, intelac97.asm, 'stop:')
   788                                  	; Clear FIFOE, BCIS, LVBCI (Ref: Intel ICH hub manual)
   789                                  	mov     ax, 1Ch
   790                                  	mov     dx, [NABMBAR]
   791                                  	add     dx, PO_SR_REG
   792                                  	out     dx, ax
   793                                  
   794                                  	; 11/06/2017
   795                                  	mov     al, RR
   796                                  ac97_po_cmd:
   797                                  	 ;11/06/2017
   798                                  	; 29/05/2017
   799                                  	mov     dx, [NABMBAR]
   800                                          add     dx, PO_CR_REG		; PCM out control register
   801                                  	out	dx, al
   802                                  	retn
   803                                  
   804                                  %endif
   805                                  
   806                                  print_msg:
   807                                  	; 13/11/2016 - Erdogan Tan 
   808                                  	; esi = ASCIIZ text address
   809                                  	;
   810 000006EA BB0700                  	mov	bx, 7h
   811 000006ED B40E                    	mov	ah, 0Eh 
   812                                  pm_next_char:
   813 000006EF AC                      	lodsb
   814 000006F0 20C0                    	and	al, al
   815 000006F2 7404                    	jz	short pm_retn
   816 000006F4 CD10                    	int	10h
   817 000006F6 EBF7                    	jmp	short pm_next_char
   818                                  pm_retn:
   819 000006F8 C3                      	retn
   820                                  
   821                                  ; 06/11/2023
   822                                  ;dword2str:
   823                                  ;	; 13/11/2016 - Erdogan Tan 
   824                                  ;	; eax = dword value
   825                                  ;	;
   826                                  ;	call	dwordtohex
   827                                  ;	mov	[dword_str], edx
   828                                  ;	mov	[dword_str+4], eax
   829                                  ;	mov	si, dword_str
   830                                  ;	retn
   831                                  
   832                                  	; trdos386.s (unix386.s) - 10/05/2015
   833                                  	; Convert binary number to hexadecimal string
   834                                  
   835                                  bytetohex:
   836                                  	; INPUT ->
   837                                  	; 	AL = byte (binary number)
   838                                  	; OUTPUT ->
   839                                  	;	AX = hexadecimal string
   840                                  	;
   841 000006F9 53                      	push	bx
   842 000006FA 30FF                    	xor	bh, bh
   843 000006FC 88C3                    	mov	bl, al
   844 000006FE C0EB04                  	shr	bl, 4
   845 00000701 8A9F[9407]              	mov	bl, [bx+hex_chars] 	 	
   846 00000705 86D8                    	xchg	bl, al
   847 00000707 80E30F                  	and	bl, 0Fh
   848 0000070A 8AA7[9407]              	mov	ah, [bx+hex_chars] 
   849 0000070E 5B                      	pop	bx	
   850 0000070F C3                      	retn
   851                                  
   852                                  wordtohex:
   853                                  	; INPUT ->
   854                                  	; 	AX = word (binary number)
   855                                  	; OUTPUT ->
   856                                  	;	EAX = hexadecimal string
   857                                  	;
   858 00000710 53                      	push	bx
   859 00000711 30FF                    	xor	bh, bh
   860 00000713 86E0                    	xchg	ah, al
   861 00000715 50                      	push	ax
   862 00000716 88E3                    	mov	bl, ah
   863 00000718 C0EB04                  	shr	bl, 4
   864 0000071B 8A87[9407]              	mov	al, [bx+hex_chars] 	 	
   865 0000071F 88E3                    	mov	bl, ah
   866 00000721 80E30F                  	and	bl, 0Fh
   867 00000724 8AA7[9407]              	mov	ah, [bx+hex_chars]
   868 00000728 66C1E010                	shl	eax, 16
   869 0000072C 58                      	pop	ax
   870 0000072D 5B                      	pop	bx
   871 0000072E EBC9                    	jmp	short bytetohex
   872                                  
   873                                  ; 06/11/2023
   874                                  ;dwordtohex:
   875                                  ;	; INPUT ->
   876                                  ;	; 	EAX = dword (binary number)
   877                                  ;	; OUTPUT ->
   878                                  ;	;	EDX:EAX = hexadecimal string
   879                                  ;	;
   880                                  ;	push	eax
   881                                  ;	shr	eax, 16
   882                                  ;	call	wordtohex
   883                                  ;	mov	edx, eax
   884                                  ;	pop	eax
   885                                  ;	call	wordtohex
   886                                  ;	retn
   887                                  
   888                                  _DATA:
   889                                  
   890                                  ; 24/11/2016
   891                                  ;	IRQ  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 
   892 00000730 08090A0B0C0D0E0F70-     irq_int	 db 08h,09h,0Ah,0Bh,0Ch,0Dh,0Eh,0Fh,70h,71h,72h,73h,74h,75h,76h,77h
   892 00000739 71727374757677     
   893                                  
   894                                  ; 17/02/2017
   895                                  ; Valid ICH device IDs
   896                                  
   897                                  valid_ids:
   898 00000740 86801524                dd	(ICH_DID << 16) + INTEL_VID  	 ; 8086h:2415h 
   899 00000744 86802524                dd	(ICH0_DID << 16) + INTEL_VID 	 ; 8086h:2425h 
   900 00000748 86804524                dd	(ICH2_DID << 16) + INTEL_VID 	 ; 8086h:2445h 
   901 0000074C 86808524                dd	(ICH3_DID << 16) + INTEL_VID 	 ; 8086h:2485h 
   902 00000750 8680C524                dd	(ICH4_DID << 16) + INTEL_VID 	 ; 8086h:24C5h
   903 00000754 8680D524                dd	(ICH5_DID << 16) + INTEL_VID 	 ; 8086h:24D5h
   904 00000758 86806E26                dd	(ICH6_DID << 16) + INTEL_VID 	 ; 8086h:266Eh
   905 0000075C 8680A625                dd	(ESB6300_DID << 16) + INTEL_VID  ; 8086h:25A6h
   906 00000760 86809826                dd	(ESB631X_DID << 16) + INTEL_VID  ; 8086h:2698h
   907 00000764 8680DE27                dd	(ICH7_DID << 16) + INTEL_VID 	 ; 8086h:27DEh
   908                                  ; 03/11/2023 - Erdogan Tan
   909 00000768 86809571                dd	(MX82440_DID << 16) + INTEL_VID  ; 8086h:7195h
   910 0000076C 39101270                dd	(SI7012_DID << 16)  + SIS_VID	 ; 1039h:7012h
   911 00000770 DE10B101                dd 	(NFORCE_DID << 16)  + NVIDIA_VID ; 10DEh:01B1h
   912 00000774 DE106A00                dd 	(NFORCE2_DID << 16) + NVIDIA_VID ; 10DEh:006Ah
   913 00000778 22106D74                dd 	(AMD8111_DID << 16) + AMD_VID 	 ; 1022h:746Dh
   914 0000077C 22104574                dd 	(AMD768_DID << 16)  + AMD_VID 	 ; 1022h:7445h
   915 00000780 DE105900                dd 	(CK804_DID << 16) + NVIDIA_VID	 ; 10DEh:0059h
   916 00000784 DE103A00                dd 	(MCP04_DID << 16) + NVIDIA_VID	 ; 10DEh:003Ah
   917 00000788 DE108A00                dd 	(CK8_DID << 16) + NVIDIA_VID	 ; 1022h:008Ah
   918 0000078C DE10DA00                dd 	(NFORCE3_DID << 16) + NVIDIA_VID ; 10DEh:00DAh
   919 00000790 DE10EA00                dd 	(CK8S_DID << 16) + NVIDIA_VID	 ; 10DEh:00EAh
   920                                  
   921                                  valid_id_count:	equ ($ - valid_ids)>>2 ; 05/11/2023
   922                                  
   923                                  ; 13/11/2016
   924 00000794 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
   924 0000079D 3941424344454600   
   925 000007A5 414339372041756469-     msgAC97Info	db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
   925 000007AE 6F20436F6E74726F6C-
   925 000007B7 6C6572202620436F64-
   925 000007C0 656320496E666F0D0A 
   926 000007C9 56656E646F72204944-     		db "Vendor ID: "
   926 000007D2 3A20               
   927 000007D4 303030306820446576-     msgVendorId	db "0000h Device ID: "
   927 000007DD 6963652049443A20   
   928 000007E5 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
   929 000007EC 4275733A20              		db "Bus: "
   930 000007F1 303068204465766963-     msgBusNo	db "00h Device: "
   930 000007FA 653A20             
   931 000007FD 3030682046756E6374-     msgDevNo	db "00h Function: "
   931 00000806 696F6E3A20         
   932 0000080B 303068                  msgFncNo	db "00h"
   933 0000080E 0D0A                    		db 0Dh, 0Ah
   934                                  ; 05/11/2023	
   935 00000810 4E414D4241523A20        		db "NAMBAR: "
   936 00000818 303030306820            msgNamBar	db "0000h "
   937 0000081E 4E41424D4241523A20      		db "NABMBAR: "
   938 00000827 303030306820495251-     msgNabmBar	db "0000h IRQ: "
   938 00000830 3A20               
   939 00000832 3030                    msgIRQ		dw 3030h
   940 00000834 0D0A24                  		db 0Dh, 0Ah, "$"
   941 00000837 53616D706C65205261-     msgSampleRate	db "Sample Rate: "
   941 00000840 74653A20           
   942 00000844 303030303020487A20-     msgHertz	db "00000 Hz ", "$" 
   942 0000084D 24                 
   943 0000084E 3820626974732024        msg8Bits	db "8 bits ", "$" 
   944 00000856 4D6F6E6F0D0A24          msgMono		db "Mono", 0Dh, 0Ah, "$"
   945 0000085D 313620626974732024      msg16Bits	db "16 bits ", "$" 
   946 00000866 53746572656F0D0A24      msgStereo	db "Stereo", 0Dh, 0Ah, "$"
   947                                  
   948                                  ;; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   949                                  ;codec_id	dd 0
   950                                  ;codec_chip_id	dd 0
   951                                  ;codec_vendor_ids dw 0
   952                                  ;codec_chip_ids	dw 0
   953                                  
   954 0000086F 3030303030303030        dword_str	 dd 30303030h, 30303030h
   955 00000877 680D0A00                		 db 'h', 0Dh, 0Ah, 0
   956                                  
   957                                  ;ac_unknown     db 'unknown manufacturer',13,10,0
   958                                  ;ac_Realtek     db 'Realtek Semiconductor',13,10,0
   959                                  ;ac_Analog      db 'Analog Devices',13,10,0
   960                                  ;ac_CMedia      db 'C-Media Electronics',13,10,0
   961                                  ;ac_Cirrus      db 'Cirrus Logic',13,10,0
   962                                  ;ac_Wolfson     db 'Wolfson Microelectronics',13,10,0
   963                                  ;ac_VIA         db 'VIA Technologies',13,10,0
   964                                  ;ac_SigmaTel    db 'SigmaTel',13,10,0
   965                                  ;ac_eMicro      db 'eMicro',13,10,0
   966                                  ;
   967                                  ;chip_unknown   db 'unknown codec id ', 0
   968                                  
   969                                  ;CHIP_REALTEK   equ 414C4700h
   970                                  ;CHIP_CMEDIA    equ 434D4900h
   971                                  ;CHIP_VIA       equ 56494100h
   972                                  
   973                                  ;codecs        dd CHIP_CMEDIA
   974                                  ;	       dw ac_CMedia, chips_CMedia
   975                                  ;              dd CHIP_REALTEK
   976                                  ;	       dw ac_Realtek, chips_Realtek
   977                                  ;              dd CHIP_VIA
   978                                  ;	       dw ac_VIA, chips_VIA
   979                                  ;              dd 0
   980                                  
   981                                  ;chips_Realtek dw 10h, chip_ALC201a
   982                                  ;              dw 20h, chip_ALC650
   983                                  ;              dw 21h, chip_ALC650D
   984                                  ;              dw 22h, chip_ALC650E
   985                                  ;              dw 23h, chip_ALC650F
   986                                  ;              dw 60h, chip_ALC655
   987                                  ;              dw 80h, chip_ALC658
   988                                  ;              dw 81h, chip_ALC658D
   989                                  ;              dw 90h, chip_ALC850
   990                                  ;              dw 0FFh
   991                                  
   992                                  ;chips_CMedia  dw 41h, chip_CM9738
   993                                  ;              dw 61h, chip_CM9739
   994                                  ;              dw 69h, chip_CM9780
   995                                  ;              dw 78h, chip_CM9761
   996                                  ;              dw 82h, chip_CM9761
   997                                  ;              dw 83h, chip_CM9761
   998                                  ;              dw 0FFh
   999                                  
  1000                                  ;chips_VIA     dw 61h, chip_VIA1612A
  1001                                  ;              dw 0FFh
  1002                                  
  1003                                  ;Realtek
  1004                                  ;chip_ALC201a    db 'ALC201a',0dh,0ah,00h
  1005                                  ;chip_ALC650     db 'ALC650 ',0dh,0ah,00h
  1006                                  ;chip_ALC650D    db 'ALC650D',0dh,0ah,00h
  1007                                  ;chip_ALC650E    db 'ALC650E',0dh,0ah,00h
  1008                                  ;chip_ALC650F    db 'ALC650F',0dh,0ah,00h
  1009                                  ;chip_ALC655     db 'ALC655 ',0dh,0ah,00h
  1010                                  ;chip_ALC658     db 'ALC658 ',0dh,0ah,00h
  1011                                  ;chip_ALC658D    db 'ALC658D',0dh,0ah,00h
  1012                                  ;chip_ALC850     db 'ALC850 ',0dh,0ah,00h
  1013                                  
  1014                                  ;CMedia
  1015                                  ;chip_CM9738     db 'CMI9738', 0dh,0ah,0
  1016                                  ;chip_CM9739     db 'CMI9739', 0dh,0ah,0
  1017                                  ;chip_CM9780     db 'CMI9780', 0dh,0ah,0
  1018                                  ;chip_CM9761     db 'CMI9761', 0dh,0ah,0
  1019                                  
  1020                                  ;VIA
  1021                                  ;chip_VIA1612A   db 'VIA1612A',13,10,0
  1022                                  
  1023                                  ; 17/02/2017
  1024                                  bss_start:
  1025                                  
  1026                                  ABSOLUTE bss_start
  1027                                  
  1028 0000087B ??                      alignb 2
  1029                                  
  1030                                  ; 28/11/2016
  1031                                  
  1032 0000087C <res 1Ch>               smpRBuff:	resw 14 ; 19/11/2016 - Erdogan Tan
  1033                                  
  1034 00000898 ????                    filehandle:	resw 1
  1035                                  
  1036 0000089A ??                      flags:		resb 1
  1037                                  ; 06/11/2023
  1038 0000089B ??                      ac97_int_ln_reg: resb 1
  1039                                  
  1040                                  ; 06/11/2023
  1041                                  ;pcm_irq_status: resb 1	; 05/11/2023
  1042                                  ;
  1043                                  ;inside:	resb 1
  1044                                  ;tLoop:		resb 1
  1045                                  
  1046                                  ; 06/11/2023
  1047                                  ; 05/11/2023
  1048                                  ; 04/11/2023
  1049                                  ;IRQ_status:	resw 1	; IRQ status before enabling audio interrupt
  1050                                  ;IRQ_vector:	resd 1  ; Previous interrupt handler address	
  1051                                  
  1052                                  ; 17/02/2017
  1053                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  1054                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  1055                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  1056                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  1057 0000089C ????                    NAMBAR:		resw 1			; BAR for mixer
  1058 0000089E ????                    NABMBAR:	resw 1			; BAR for bus master regs
  1059                                  
  1060                                  ; 256 byte buffer for descriptor list
  1061 000008A0 ????                    BDL_BUFFER:	resw 1			; segment of our 256byte BDL buffer
  1062 000008A2 ????                    WAV_BUFFER1:	resw 1			; segment of our WAV storage
  1063                                  ; 64k buffers for wav file storage
  1064 000008A4 ????                    WAV_BUFFER2:	resw 1			; segment of 2nd wav buffer
  1065                                  
  1066                                  ; 06/11/2023
  1067                                  ;tBuff:		resb 1
  1068                                  ;ac97_int_ln_reg: resb 1
  1069                                  
  1070                                  ; 12/11/2016 - Erdogan Tan
  1071                                  
  1072 000008A6 ????????                bus_dev_fn:	resd 1
  1073 000008AA ????????                dev_vendor:	resd 1
  1074                                  ; 06/11/2023
  1075                                  ;stats_cmd:	resw 1 ; 17/02/2017
  1076                                  ; 05/11/2023
  1077                                  ;ac97_io_base:	resw 1
  1078 000008AE ????                    sample_rate:	resw 1
  1079                                  
  1080                                  ; 19/11/2016
  1081 000008B0 ????                    stmo:		resw 1 
  1082 000008B2 ????                    bps:		resw 1
  1083                                  
  1084                                  ; 08/11/2023
  1085                                  ; 07/11/2023
  1086 000008B4 ??                      fbs_shift:	resb 1
  1087 000008B5 ??                      		resb 1 ; 08/11/2023
  1088                                  
  1089                                  ;fbs_seg:	resw 1
  1090                                  ;fbs_off:	resw 1
  1091                                  
  1092                                  ;alignb 2
  1093                                  
  1094                                  ; 32 kilo bytes for temporay buffer
  1095                                  ; (for stereo-mono, 8bit/16bit corrections)
  1096 000008B6 <res 8000h>             temp_buffer:	resb 32768
  1097                                  
  1098                                  ;alignb 16
  1099                                  EOF:
