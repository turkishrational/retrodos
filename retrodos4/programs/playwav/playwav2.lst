     1                                  ; ****************************************************************************
     2                                  ; PLAYWAV.ASM - ICH AC97 .wav player for DOS.			   PLAYWAV.COM
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; Last Update: 12/11/2023 (Previous: 17/02/2017)
     5                                  ; ----------------------------------------------------------------------------
     6                                  ; Beginning: 17/02/2017
     7                                  ; ----------------------------------------------------------------------------
     8                                  ; Assembler: NASM version 2.11 (2.15)
     9                                  ;	     nasm playwav.asm -l playwav.lst -o PLAYWAV.COM	
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Derived from '.wav file player for DOS' Jeff Leyda, Sep 02, 2002 
    12                                  ; ****************************************************************************
    13                                  ; Modidified from 'PLAYER.COM' for VIA VT8233 wav player source code by
    14                                  ; (PLAYER.ASM) by Erdogan Tan (07/11/2016 - 08/12/2016)
    15                                  
    16                                  ; TUNELOOP version (playing without AC97 interrupt) - 06/11/2023 - Erdogan Tan
    17                                  
    18                                  [BITS 16]
    19                                  
    20                                  [ORG 100h] 
    21                                  
    22                                  	%include 'ac97.inc' ; 17/02/2017
     1                              <1> ; 11/11/2023
     2                              <1> ; 05/11/2023
     3                              <1> ; 03/11/2023
     4                              <1> ; 17/02/2017 (Erdogan Tan, PLAYWAV.ASM)
     5                              <1> ; constant.inc & codec.inc (for ICH AC97 wav player, 'PLAYWAV.COM') 
     6                              <1> 
     7                              <1> ; ----------------------------------------------------------------------------
     8                              <1> ; CONSTANT.INC
     9                              <1> ; ----------------------------------------------------------------------------
    10                              <1> 
    11                              <1> ;constants of stuff that seem hard to remember at times.
    12                              <1> 
    13                              <1> TRUE  EQU 1
    14                              <1> FALSE EQU 0
    15                              <1> 
    16                              <1> ENABLED  EQU 1
    17                              <1> DISABLED EQU 0
    18                              <1> 
    19                              <1> BIT0  EQU 1
    20                              <1> BIT1  EQU 2
    21                              <1> BIT2  EQU 4
    22                              <1> BIT3  EQU 8
    23                              <1> BIT4  EQU 10h
    24                              <1> BIT5  EQU 20h
    25                              <1> BIT6  EQU 40h
    26                              <1> BIT7  EQU 80h
    27                              <1> BIT8  EQU 100h
    28                              <1> BIT9  EQU 200h
    29                              <1> BIT10 EQU 400h
    30                              <1> BIT11 EQU 800h
    31                              <1> BIT12 EQU 1000h
    32                              <1> BIT13 EQU 2000h
    33                              <1> BIT14 EQU 4000h
    34                              <1> BIT15 EQU 8000h
    35                              <1> BIT16 EQU 10000h
    36                              <1> BIT17 EQU 20000h
    37                              <1> BIT18 EQU 40000h
    38                              <1> BIT19 EQU 80000h
    39                              <1> BIT20 EQU 100000h
    40                              <1> BIT21 EQU 200000h
    41                              <1> BIT22 EQU 400000h
    42                              <1> BIT23 EQU 800000h
    43                              <1> BIT24 EQU 1000000h
    44                              <1> BIT25 EQU 2000000h
    45                              <1> BIT26 EQU 4000000h
    46                              <1> BIT27 EQU 8000000h
    47                              <1> BIT28 EQU 10000000h
    48                              <1> BIT29 EQU 20000000h
    49                              <1> BIT30 EQU 40000000h
    50                              <1> BIT31 EQU 80000000h
    51                              <1> 
    52                              <1> ;special characters
    53                              <1> NUL     EQU 0
    54                              <1> NULL    EQU 0
    55                              <1> BELL    EQU 07
    56                              <1> BS      EQU 08
    57                              <1> TAB     EQU 09
    58                              <1> LF      EQU 10
    59                              <1> CR      EQU 13
    60                              <1> ESCAPE  EQU 27           ;ESC is a reserved word....
    61                              <1> 
    62                              <1> 
    63                              <1> ;file stuff
    64                              <1> READONLY  EQU   BIT0
    65                              <1> HIDDEN    EQU   BIT1
    66                              <1> SYSTEM    EQU   BIT2
    67                              <1> VOLUME    EQU   BIT3         ;ignored for file access
    68                              <1> DIRECTORY EQU   BIT4         ;must be 0 for file access
    69                              <1> ARCHIVE   EQU   BIT5
    70                              <1> SHAREABLE EQU   BIT7         ;for novell networks
    71                              <1> OPEN	EQU	2		; open existing file
    72                              <1> CREATE	EQU	1		; create new file
    73                              <1> 
    74                              <1> 
    75                              <1> ; PCI equates
    76                              <1> ; PCI function address (PFA)
    77                              <1> ; bit 31 = 1
    78                              <1> ; bit 23:16 = bus number     (0-255)
    79                              <1> ; bit 15:11 = device number  (0-31)
    80                              <1> ; bit 10:8 = function number (0-7)
    81                              <1> ; bit 7:0 = register number  (0-255)
    82                              <1> 
    83                              <1> IO_ADDR_MASK    EQU     0FFFEh          ; mask off bit 0 for reading BARs
    84                              <1> PCI_INDEX_PORT  EQU     0CF8h
    85                              <1> PCI_DATA_PORT   EQU     0CFCh
    86                              <1> PCI32           EQU     BIT31           ; bitflag to signal 32bit access
    87                              <1> PCI16           EQU     BIT30           ; bitflag for 16bit access
    88                              <1> 
    89                              <1> PCI_FN0         EQU     0 << 8
    90                              <1> PCI_FN1         EQU     1 << 8
    91                              <1> PCI_FN2         EQU     2 << 8
    92                              <1> PCI_FN3         EQU     3 << 8
    93                              <1> PCI_FN4         EQU     4 << 8
    94                              <1> PCI_FN5         EQU     5 << 8
    95                              <1> PCI_FN6         EQU     6 << 8
    96                              <1> PCI_FN7         EQU     7 << 8
    97                              <1> 
    98                              <1> PCI_CMD_REG		EQU	04h		; reg 04, command reg
    99                              <1>  IO_ENA			EQU	BIT0		; i/o decode enable
   100                              <1>  MEM_ENA		EQU	BIT1		; memory decode enable
   101                              <1>  BM_ENA                 EQU     BIT2		; bus master enable
   102                              <1> 
   103                              <1> ; ----------------------------------------------------------------------------
   104                              <1> ; CODEC.INC
   105                              <1> ; ----------------------------------------------------------------------------
   106                              <1> 
   107                              <1> ;Codec registers.
   108                              <1> ;
   109                              <1> ;Not all codecs are created equal. Refer to the spec for your specific codec.
   110                              <1> ;
   111                              <1> ;All registers are 16bits wide.  Access to codec registers over the AC97 link
   112                              <1> ;is defined by the OEM.  
   113                              <1> ;
   114                              <1> ;Secondary codec's are accessed by ORing in BIT7 of all register accesses.
   115                              <1> ;
   116                              <1> 
   117                              <1> ; each codec/mixer register is 16bits
   118                              <1> 
   119                              <1> CODEC_RESET_REG                 equ     00      ; reset codec
   120                              <1> CODEC_MASTER_VOL_REG            equ     02      ; master volume
   121                              <1> CODEC_HP_VOL_REG                equ     04      ; headphone volume
   122                              <1> CODEC_MASTER_MONO_VOL_REG       equ     06      ; master mono volume
   123                              <1> CODEC_MASTER_TONE_REG           equ     08      ; master tone (R+L)
   124                              <1> CODEC_PCBEEP_VOL_REG            equ     0ah     ; PC beep volume
   125                              <1> CODEC_PHONE_VOL_REG             equ     0bh     ; phone volume
   126                              <1> CODEC_MIC_VOL_REG               equ     0eh     ; MIC volume
   127                              <1> CODEC_LINE_IN_VOL_REG           equ     10h     ; line input volume
   128                              <1> CODEC_CD_VOL_REG                equ     12h     ; CD volume
   129                              <1> CODEC_VID_VOL_REG               equ     14h     ; video volume
   130                              <1> CODEC_AUX_VOL_REG               equ     16h     ; aux volume
   131                              <1> CODEC_PCM_OUT_REG               equ     18h     ; PCM output volume
   132                              <1> CODEC_RECORD_SELECT_REG         equ     1ah     ; record select input
   133                              <1> CODEC_RECORD_VOL_REG            equ     1ch     ; record volume
   134                              <1> CODEC_RECORD_MIC_VOL_REG        equ     1eh     ; record mic volume
   135                              <1> CODEC_GP_REG                    equ     20h     ; general purpose
   136                              <1> CODEC_3D_CONTROL_REG            equ     22h     ; 3D control
   137                              <1> ; 24h is reserved
   138                              <1> CODEC_POWER_CTRL_REG            equ     26h     ; powerdown control
   139                              <1> CODEC_EXT_AUDIO_REG             equ     28h     ; extended audio
   140                              <1> CODEC_EXT_AUDIO_CTRL_REG        equ     2ah     ; extended audio control
   141                              <1> CODEC_PCM_FRONT_DACRATE_REG     equ     2ch     ; PCM out sample rate
   142                              <1> CODEC_PCM_SURND_DACRATE_REG     equ     2eh     ; surround sound sample rate
   143                              <1> CODEC_PCM_LFE_DACRATE_REG       equ     30h     ; LFE sample rate
   144                              <1> CODEC_LR_ADCRATE_REG            equ     32h     ; PCM in sample rate
   145                              <1> CODEC_MIC_ADCRATE_REG           equ     34h     ; mic in sample rate
   146                              <1> 
   147                              <1> ; registers 36-7a are reserved on the ICH
   148                              <1> 
   149                              <1> CODEC_VENDORID1_REG             equ     7ch     ; codec vendor ID 1
   150                              <1> CODEC_VENDORID2_REG             equ     7eh     ; codec vendor ID 2
   151                              <1> 
   152                              <1> ; Mixer registers 0 through 51h reside in the ICH and are not forwarded over
   153                              <1> ; the AC97 link to the codec, which I think is a little weird.  Looks like
   154                              <1> ; the ICH makes it so you don't need a fully functional codec to play audio?
   155                              <1> ;
   156                              <1> ; whenever 2 codecs are present in the system, use BIT7 to access the 2nd
   157                              <1> ; set of registers, ie 80h-feh
   158                              <1> 
   159                              <1> PRIMARY_CODEC                   equ     0       ; 0-7F for primary codec
   160                              <1> SECONDARY_CODEC                 equ     BIT7    ; 80-8f registers for 2ndary
   161                              <1> 
   162                              <1> SAMPLE_RATE_441khz	equ     44100   ; 44.1Khz (cd quality) rate
   163                              <1> 
   164                              <1> ; ----------------------------------------------------------------------------
   165                              <1> ; 17/02/2017
   166                              <1> PCI_IO_BASE	equ 10h			; = NAMBAR register offset
   167                              <1> AC97_INT_LINE   equ 3Ch			; AC97 Interrupt Line register offset
   168                              <1> 
   169                              <1> ; ----------------------------------------------------------------------------
   170                              <1> ; ICH2AC97.INC
   171                              <1> ; ----------------------------------------------------------------------------
   172                              <1> 
   173                              <1> ; PCI stuff
   174                              <1> 
   175                              <1> ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
   176                              <1> 
   177                              <1> INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
   178                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   179                              <1> SIS_VID		equ	1039h
   180                              <1> NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
   181                              <1> AMD_VID		equ	1022h
   182                              <1> 
   183                              <1> ICH_DID         equ     2415h           ; ICH device ID
   184                              <1> ICH0_DID        equ     2425h           ; ICH0
   185                              <1> ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
   186                              <1>                                         ; they all should be compatible.
   187                              <1> 
   188                              <1> ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
   189                              <1> ICH3_DID	equ     2485h           ; ICH3
   190                              <1> ICH4_DID        equ     24C5h           ; ICH4
   191                              <1> ICH5_DID	equ     24D5h           ; ICH5 
   192                              <1> ICH6_DID	equ     266Eh           ; ICH6
   193                              <1> ESB6300_DID	equ     25A6h           ; 6300ESB
   194                              <1> ESB631X_DID	equ     2698h           ; 631XESB
   195                              <1> ICH7_DID	equ	27DEh		; ICH7
   196                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   197                              <1> MX82440_DID	equ	7195h
   198                              <1> SI7012_DID	equ	7012h
   199                              <1> NFORCE_DID	equ	01B1h
   200                              <1> NFORCE2_DID	equ	006Ah
   201                              <1> AMD8111_DID	equ	746Dh
   202                              <1> AMD768_DID	equ	7445h
   203                              <1> ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
   204                              <1> CK804_DID	equ	0059h
   205                              <1> MCP04_DID	equ	003Ah
   206                              <1> CK8_DID		equ	008Ah
   207                              <1> NFORCE3_DID	equ	00DAh
   208                              <1> CK8S_DID	equ	00EAh
   209                              <1> 
   210                              <1> NAMBAR_REG      equ     10h             ; native audio mixer BAR
   211                              <1>  NAM_SIZE       equ     256             ; 256 bytes required.
   212                              <1> 
   213                              <1> NABMBAR_REG     equ     14h             ; native audio bus mastering BAR
   214                              <1>  NABM_SIZE      equ     64              ; 64 bytes
   215                              <1> 
   216                              <1> ; BUS master registers, accessed via NABMBAR+offset
   217                              <1> 
   218                              <1> ; ICH supports 3 different types of register sets for three types of things
   219                              <1> ; it can do, thus:
   220                              <1> ;
   221                              <1> ; PCM in (for recording) aka PI
   222                              <1> ; PCM out (for playback) aka PO
   223                              <1> ; MIC in (for recording) aka MC
   224                              <1> 
   225                              <1> PI_BDBAR_REG            equ     0       ; PCM in buffer descriptor BAR
   226                              <1> PO_BDBAR_REG            equ     10h     ; PCM out buffer descriptor BAR
   227                              <1> MC_BDBAR_REG            equ     20h     ; MIC in buffer descriptor BAR
   228                              <1> 
   229                              <1> ; each buffer descriptor BAR holds a pointer which has entries to the buffer
   230                              <1> ; contents of the .WAV file we're going to play. Each entry is 8 bytes long
   231                              <1> ; (more on that later) and can contain 32 entries total, so each BAR is
   232                              <1> ; 256 bytes in length, thus:
   233                              <1> 
   234                              <1> BDL_SIZE                equ     32*8    ; Buffer Descriptor List size
   235                              <1> INDEX_MASK              equ     31      ; indexes must be 0-31
   236                              <1> 
   237                              <1> 
   238                              <1> 
   239                              <1> PI_CIV_REG              equ     4       ; PCM in current Index value (RO)
   240                              <1> PO_CIV_REG              equ     14h     ; PCM out current Index value (RO)
   241                              <1> MC_CIV_REG              equ     24h     ; MIC in current Index value (RO)
   242                              <1> ;8bit read only
   243                              <1> ; each current index value is simply a pointer showing us which buffer
   244                              <1> ; (0-31) the codec is currently processing. Once this counter hits 31, it
   245                              <1> ; wraps back to 0.
   246                              <1> ; this can be handy to know, as once it hits 31, we're almost out of data to
   247                              <1> ; play back or room to record!
   248                              <1> 
   249                              <1> 
   250                              <1> PI_LVI_REG              equ     5       ; PCM in Last Valid Index
   251                              <1> PO_LVI_REG              equ     15h     ; PCM out Last Valid Index
   252                              <1> MC_LVI_REG              equ     25h     ; MIC in Last Valid Index
   253                              <1> ;8bit read/write
   254                              <1> ; The Last Valid Index is a number (0-31) to let the codec know what buffer
   255                              <1> ; number to stop on after processing. It could be very nasty to play audio
   256                              <1> ; from buffers that aren't filled with the audio we want to play.
   257                              <1> 
   258                              <1> 
   259                              <1> PI_SR_REG               equ     6       ; PCM in Status register
   260                              <1> PO_SR_REG               equ     16h     ; PCM out Status register
   261                              <1> MC_SR_REG               equ     26h     ; MIC in Status register
   262                              <1> ;16bit read/write
   263                              <1> ; status registers.  Bitfields follow:
   264                              <1> 
   265                              <1> FIFO_ERR                equ     BIT4    ; FIFO Over/Underrun W1TC.
   266                              <1> 
   267                              <1> BCIS                    equ     BIT3    ; buffer completion interrupt status.
   268                              <1>                                         ; Set whenever the last sample in ANY
   269                              <1>                                         ; buffer is finished.  Bit is only
   270                              <1>                                         ; set when the Interrupt on Complete
   271                              <1>                                         ; (BIT4 of control reg) is set.
   272                              <1> 
   273                              <1> LVBCI                   equ     BIT2    ; Set whenever the codec has processed
   274                              <1>                                         ; the last buffer in the buffer list.
   275                              <1>                                         ; Will fire an interrupt if IOC bit is
   276                              <1>                                         ; set. Probably set after the last
   277                              <1>                                         ; sample in the last buffer is
   278                              <1>                                         ; processed.  W1TC
   279                              <1> 
   280                              <1>                                         ; 
   281                              <1> CELV                    equ     BIT1    ; Current buffer == last valid.
   282                              <1>                                         ; Bit is RO and remains set until LVI is
   283                              <1>                                         ; cleared.  Probably set up the start
   284                              <1>                                         ; of processing for the last buffer.
   285                              <1> 
   286                              <1> 
   287                              <1> DCH                     equ     BIT0    ; DMA controller halted.
   288                              <1>                                         ; set whenever audio stream is stopped
   289                              <1>                                         ; or something else goes wrong.
   290                              <1> 
   291                              <1> 
   292                              <1> PI_PICB_REG             equ     8       ; PCM in position in current buffer(RO)
   293                              <1> PO_PICB_REG             equ     18h     ; PCM out position in current buffer(RO)
   294                              <1> MC_PICB_REG             equ     28h     ; MIC in position in current buffer (RO)
   295                              <1> ;16bit read only
   296                              <1> ; position in current buffer regs show the number of dwords left to be
   297                              <1> ; processed in the current buffer.
   298                              <1> ; 
   299                              <1> 
   300                              <1> PI_PIV_REG              equ     0ah     ; PCM in Prefected index value
   301                              <1> PO_PIV_REG              equ     1ah     ; PCM out Prefected index value
   302                              <1> MC_PIV_REG              equ     2ah     ; MIC in Prefected index value
   303                              <1> ;8bit, read only
   304                              <1> ; Prefetched index value register.
   305                              <1> ; tells which buffer number (0-31) has be prefetched. I'd imagine this
   306                              <1> ; value follows the current index value fairly closely. (CIV+1)
   307                              <1> ;
   308                              <1> 
   309                              <1> 
   310                              <1> PI_CR_REG               equ     0bh     ; PCM in Control Register
   311                              <1> PO_CR_REG               equ     1bh     ; PCM out Control Register
   312                              <1> MC_CR_REG               equ     2bh     ; MIC in Control Register
   313                              <1> ; 8bit
   314                              <1> ; Control register *MUST* only be accessed as an 8bit value.
   315                              <1> ; Control register. See bitfields below.
   316                              <1> ;
   317                              <1> 
   318                              <1> 
   319                              <1> IOCE                    equ     BIT4    ; interrupt on complete enable.
   320                              <1>                                         ; set this bit if you want an intrtpt
   321                              <1>                                         ; to fire whenever LVBCI is set.
   322                              <1> FEIFE                   equ     BIT3    ; set if you want an interrupt to fire
   323                              <1>                                         ; whenever there is a FIFO (over or
   324                              <1>                                         ; under) error.
   325                              <1> LVBIE                   equ     BIT2    ; last valid buffer interrupt enable.
   326                              <1>                                         ; set if you want an interrupt to fire
   327                              <1>                                         ; whenever the completion of the last
   328                              <1>                                         ; valid buffer.
   329                              <1> RR                      equ     BIT1    ; reset registers.  Nukes all regs
   330                              <1>                                         ; except bits 4:2 of this register.
   331                              <1>                                         ; Only set this bit if BIT 0 is 0
   332                              <1> RPBM                    equ     BIT0    ; Run/Pause
   333                              <1>                                         ; set this bit to start the codec!
   334                              <1> 
   335                              <1> 
   336                              <1> GLOB_CNT_REG            equ     2ch     ; Global control register
   337                              <1> SEC_RES_EN              equ     BIT5    ; secondary codec resume event 
   338                              <1>                                         ; interrupt enable.  Not used here.
   339                              <1> PRI_RES_EN              equ     BIT4    ; ditto for primary. Not used here.
   340                              <1> ACLINK_OFF              equ     BIT3    ; Turn off the AC97 link
   341                              <1> ACWARM_RESET            equ     BIT2    ; Awaken the AC97 link from sleep.
   342                              <1>                                         ; registers preserved, bit self clears
   343                              <1> ACCOLD_RESET            equ     BIT1    ; Reset everything in the AC97 and
   344                              <1>                                         ; reset all registers.  Not self clearing
   345                              <1> 
   346                              <1> GPIIE                   equ     BIT0    ; GPI Interrupt enable.
   347                              <1>                                         ; set if you want an interrupt to
   348                              <1>                                         ; fire upon ANY of the bits in the
   349                              <1>                                         ; GPI (general pursose inputs?) not used.
   350                              <1> 
   351                              <1> GLOB_STS_REG            equ     30h     ; Global Status register (RO)
   352                              <1> 
   353                              <1> MD3                     equ     BIT17   ; modem powerdown status (yawn)
   354                              <1> AD3                     equ     BIT16   ; Audio powerdown status (yawn)
   355                              <1> RD_COMPLETE_STS         equ     BIT15   ; Codec read timed out. 0=normal
   356                              <1> BIT3SLOT12              equ     BIT14   ; shadowed status of bit 3 in slot 12
   357                              <1> BIT2SLOT12              equ     BIT13   ; shadowed status of bit 2 in slot 12
   358                              <1> BIT1SLOT12              equ     BIT12   ; shadowed status of bit 1 in slot 12
   359                              <1> SEC_RESUME_STS          equ     BIT11   ; secondary codec has resumed (and irqed)
   360                              <1> PRI_RESUME_STS          equ     BIT10   ; primary codec has resumed (and irqed)
   361                              <1> SEC_CODEC_RDY           equ     BIT9    ; secondary codec is ready for action
   362                              <1> PRI_CODEC_RDY           equ     BIT8    ; Primary codec is ready for action
   363                              <1>                                         ; software must check these bits before
   364                              <1>                                         ; starting the codec!
   365                              <1> MIC_IN_IRQ              equ     BIT7    ; MIC in caused an interrupt
   366                              <1> PCM_OUT_IRQ             equ     BIT6    ; One of the PCM out channels IRQed
   367                              <1> PCM_IN_IRQ              equ     BIT5    ; One of the PCM in channels IRQed
   368                              <1> MODEM_OUT_IRQ           equ     BIT2    ; modem out channel IRQed
   369                              <1> MODEM_IN_IRQ            equ     BIT1    ; modem in channel IRQed
   370                              <1> GPI_STS_CHANGE          equ     BIT0    ; set whenever GPI's have changed.
   371                              <1>                                         ; BIT0 of slot 12 also reflects this.
   372                              <1> 
   373                              <1> ACC_SEMA_REG            equ     34h     ; Codec write semiphore register
   374                              <1> CODEC_BUSY              equ     BIT0    ; codec register I/O is happening
   375                              <1>                                         ; self clearing
   376                              <1> ;
   377                              <1> ; Buffer Descriptors List
   378                              <1> ; As stated earlier, each buffer descriptor list is a set of (up to) 32 
   379                              <1> ; descriptors, each 8 bytes in length. Bytes 0-3 of a descriptor entry point
   380                              <1> ; to a chunk of memory to either play from or record to. Bytes 4-7 of an
   381                              <1> ; entry describe various control things detailed below.
   382                              <1> ; 
   383                              <1> ; Buffer pointers must always be aligned on a Dword boundry.
   384                              <1> ;
   385                              <1> 
   386                              <1> IOC                     equ     BIT31   ; Fire an interrupt whenever this
   387                              <1>                                         ; buffer is complete.
   388                              <1> 
   389                              <1> BUP                     equ     BIT30   ; Buffer Underrun Policy.
   390                              <1>                                         ; if this buffer is the last buffer
   391                              <1>                                         ; in a playback, fill the remaining
   392                              <1>                                         ; samples with 0 (silence) or not.
   393                              <1>                                         ; It's a good idea to set this to 1
   394                              <1>                                         ; for the last buffer in playback,
   395                              <1>                                         ; otherwise you're likely to get a lot
   396                              <1>                                         ; of noise at the end of the sound.
   397                              <1> 
   398                              <1> ;
   399                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   400                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   401                              <1> ; Luckily for us, that's the same format as .wav files.
   402                              <1> ;
   403                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   404                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   405                              <1> ;
   406                              <1> ; A value of 0 in these bits means play no samples.
   407                              <1> ;
   408                              <1> 
   409                              <1> ; 11/11/2023
   410                              <1> CTRL_ST_CREADY		equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
   411                              <1> CODEC_REG_POWERDOWN	equ	26h
    23                                  
    24                                  _STARTUP:
    25                                  
    26                                  ; memory allocation
    27                                  
    28 00000000 E82C01                          call    setFree				; deallocate unused DOS mem
    29                                  
    30                                  	; 17/02/2017
    31                                  	; Clear BSS (uninitialized data) area
    32 00000003 31C0                    	xor	ax, ax ; 0
    33 00000005 B91D40                  	mov	cx, (EOF - bss_start)/2
    34 00000008 BF[F409]                	mov	di, bss_start
    35 0000000B F3AB                    	rep	stosw
    36                                  
    37                                  ; allocate 256 bytes of data for DCM_OUT Buffer Descriptor List. (BDL)
    38                                  
    39 0000000D B81000                          mov     ax, BDL_SIZE / 16
    40 00000010 E82401                          call    memAlloc
    41 00000013 A3[180A]                        mov     [BDL_BUFFER], ax		; segment 
    42                                  
    43                                  ; allocate 2 buffers, 64k each for now.
    44                                  
    45 00000016 B80010                          mov     ax, BUFFERSIZE / 16		; 64k for .WAV file
    46 00000019 E81B01                          call    memAlloc
    47 0000001C A3[1A0A]                        mov     [WAV_BUFFER1], ax		; segment
    48                                  
    49 0000001F B80010                  	mov	ax, BUFFERSIZE / 16
    50 00000022 E81201                  	call	memAlloc
    51 00000025 A3[1C0A]                	mov	[WAV_BUFFER2], ax
    52                                  
    53                                  ; Detect/reset AC97 
    54                                  
    55 00000028 E87F02                          call    pciFindDevice
    56 0000002B 7342                            jnc     short _1
    57                                  
    58                                  ; couldn't find the audio device!
    59                                  
    60 0000002D 0E                      	push	cs
    61 0000002E 1F                      	pop	ds
    62 0000002F BA[3900]                        mov     dx, noDevMsg
    63 00000032 B409                            mov     ah, 9
    64 00000034 CD21                            int     21h
    65 00000036 E9E600                          jmp     exit
    66                                  
    67                                  ; 17/02/2017
    68 00000039 4572726F723A20556E-     noDevMsg db "Error: Unable to find intel ICH based audio device!",CR,LF,"$"
    68 00000042 61626C6520746F2066-
    68 0000004B 696E6420696E74656C-
    68 00000054 204943482062617365-
    68 0000005D 6420617564696F2064-
    68 00000066 6576696365210D0A24 
    69                                  
    70                                  _1:
    71                                  	; eax = BUS/DEV/FN
    72                                  	;	00000000BBBBBBBBDDDDDFFF00000000
    73                                  	; edx = DEV/VENDOR
    74                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
    75                                  
    76 0000006F 66A3[1E0A]              	mov	[bus_dev_fn], eax
    77 00000073 668916[220A]            	mov	[dev_vendor], edx
    78                                  
    79                                  	; get ICH base address regs for mixer and bus master
    80                                  
    81 00000078 B010                            mov     al, NAMBAR_REG
    82 0000007A E89F01                          call    pciRegRead16			; read PCI registers 10-11
    83 0000007D 83E2FE                          and     dx, IO_ADDR_MASK 		; mask off BIT0
    84                                  
    85 00000080 8916[140A]                      mov     [NAMBAR], dx			; save audio mixer base addy
    86                                  
    87 00000084 B014                    	mov     al, NABMBAR_REG
    88 00000086 E89301                          call    pciRegRead16
    89 00000089 83E2FE                          and     dx, IO_ADDR_MASK
    90                                  
    91 0000008C 8916[160A]                      mov     [NABMBAR], dx			; save bus master base addy
    92                                  
    93                                  	; 06/11/2023
    94                                  	;; init controller
    95                                  	;; 17/02/2017
    96                                  	;mov	al, PCI_CMD_REG ; command register (04h)
    97                                  	;call	pciRegRead16 ; pciRegRead8
    98                                  	;
    99                                  	;; eax = BUS/DEV/FN/REG
   100                                  	;;  dx = PCI Command Register Content ; 17/02/2017
   101                                  	;; 	00000000CCCCCCCC
   102                                  	;mov	[stats_cmd], dx
   103                                  	;
   104                                  	; 06/11/2023
   105                                  	;mov	al, PCI_IO_BASE ; IO base address register (10h)
   106                                  	;call	pciRegRead32
   107                                  	;
   108                                  	;and	dx, 0FFC0h	; IO_ADDR_MASK (0FFFE) ?
   109                                          ;mov	[ac97_io_base], dx
   110                                  
   111 00000090 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
   112 00000092 E87F01                  	call	pciRegRead8 ; 17/02/2017
   113                                  
   114 00000095 8816[130A]              	mov     [ac97_int_ln_reg], dl
   115                                  
   116                                  ; 05/11/2023
   117                                  %if 0
   118                                  	; 28/11/2016
   119                                  	mov	bx, 1
   120                                  	xor	dh, dh 	 ; 17/02/2017
   121                                  	mov	cx, dx
   122                                  	shl	bx, cl
   123                                  
   124                                  	; 04/11/2023
   125                                  	cli
   126                                  
   127                                  	;not	bx
   128                                  	in	al, 0A1h ; irq 8-15
   129                                          mov	ah, al
   130                                          in	al, 21h  ; irq 0-7 
   131                                  
   132                                  	; 04/11/2023
   133                                  	; save IRQ status
   134                                  	mov	[IRQ_status], ax
   135                                  
   136                                  	;and	ax, bx   ; unmask
   137                                   	btr	ax, dx	 ; unmask
   138                                  	out	21h, al  ; enable interrupt (if irq <= 7)
   139                                  	mov	al, ah
   140                                  	out	0A1h, al ; enable interrupt (if irq > 7)
   141                                  	;not	bx
   142                                  
   143                                  	; 04/11/2023
   144                                  	;mov	dx, 4D1h			;8259 ELCR1
   145                                          ;in	al, dx
   146                                  	;mov	ah, al
   147                                  	;mov	dx, 4D0h 
   148                                          ;in	al, dx
   149                                  	;;or	ax, bx        
   150                                  	;bts	ax, cx
   151                                  	;mov	dx, 4D0h
   152                                  	;out	dx, al                          ;set level-triggered mode
   153                                  	;mov	al, ah
   154                                  	;mov	dx, 4D1h
   155                                  	;out	dx, al                          ;set level-triggered mode
   156                                  
   157                                  	; 24/11/2016 - Erdogan Tan
   158                                  	mov	bx, cx
   159                                  	;mov	bx, dx
   160                                  	mov	bl, [bx+irq_int]
   161                                  	shl	bx, 2 ; * 4
   162                                  
   163                                  	; set up interrupt vector
   164                                  	; 30/11/2016
   165                                  	push	es
   166                                  	xor	ax, ax
   167                                  	mov	es, ax
   168                                  	; 04/11/2023
   169                                  	; save interrupt vector
   170                                  	mov	ax, [es:bx]
   171                                  	mov	[IRQ_vector], ax
   172                                  	mov	ax, [es:bx+2]
   173                                  	mov	[IRQ_vector+2], ax
   174                                  
   175                                  	mov	word [es:bx], ac97_int_handler
   176                                  	mov	ax, cs
   177                                  	mov	[es:bx+2], ax
   178                                  	pop	es
   179                                  
   180                                  	; 04/11/2023
   181                                  	sti
   182                                  
   183                                  %endif
   184 00000099 E8AA05                  	call	write_ac97_dev_info 
   185                                  
   186                                  ; check the command line for a file to play
   187                                  
   188                                          ;push	ds
   189 0000009C E8A100                          call    processCmdline			; get the filename
   190                                  
   191                                  ; open the file
   192 0000009F B002                            mov     al, OPEN                        ; open existing file
   193 000000A1 E8BC00                          call    openFile                        ; no error? ok.
   194                                          ;pop	ds
   195 000000A4 7322                            jnc     short _gsr
   196                                  
   197                                  ; file not found!
   198                                  
   199                                          ;push   cs
   200                                          ;pop    ds
   201 000000A6 BA[AF00]                        mov	dx, noFileErrMsg
   202 000000A9 B409                            mov     ah, 9
   203 000000AB CD21                            int     21h
   204 000000AD EB70                            jmp     exit
   205                                  
   206                                  noFileErrMsg:
   207 000000AF 4572726F723A206669-     	db "Error: file not found.",CR,LF,"$"
   207 000000B8 6C65206E6F7420666F-
   207 000000C1 756E642E0D0A24     
   208                                  
   209                                  _gsr:
   210 000000C8 E8BC00                          call    getSampleRate                   ; read the sample rate
   211                                                                                  ; pass it onto codec.
   212 000000CB 7252                    	jc	short exit ; 19/11/2016 - nothing to do
   213                                  
   214 000000CD A3[260A]                	mov	[sample_rate], ax
   215                                  	
   216                                  	; 19/11/2016
   217 000000D0 880E[280A]              	mov	[stmo], cl
   218 000000D4 8816[2A0A]              	mov	[bps], dl
   219                                  	
   220                                  	; 17/02/2017
   221 000000D8 C606[2C0A]00            	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit 
   222 000000DD FEC9                    	dec	cl
   223 000000DF 7504                    	jnz	short _gsr_1 ; stereo
   224 000000E1 FE06[2C0A]              	inc	byte [fbs_shift] ; 1 = mono or 8 bit		
   225                                  _gsr_1:	
   226 000000E5 80FA08                  	cmp	dl, 8 
   227 000000E8 7704                    	ja	short _gsr_2 ; 16 bit samples
   228 000000EA FE06[2C0A]              	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   229                                  _gsr_2:	
   230 000000EE E8B706                  	call	write_sample_rate
   231                                  
   232                                  	; 05/11/2023
   233                                  _2:
   234 000000F1 E82605                  	call	check4keyboardstop  ; flush keyboard buffer
   235 000000F4 72FB                    	jc	short _2 	; 07/11/2023
   236                                  
   237                                  	; 05/11/2023
   238                                  	;mov	eax, [bus_dev_fn]
   239                                  	;mov	al, PCI_CMD_REG
   240                                  	;call	pciRegRead16			; read PCI command register
   241                                  	; 17/02/2017
   242                                  	;mov	dx, [stats_cmd]
   243                                          ;or	dl, IO_ENA+BM_ENA               ; enable IO and bus master
   244                                  	;call	pciRegWrite16 ; pciRegWrite8
   245                                  
   246                                  	; 06/11/2023
   247 000000F6 66A1[1E0A]              	mov	eax, [bus_dev_fn]
   248 000000FA B004                            mov     al, PCI_CMD_REG
   249 000000FC E81501                          call    pciRegRead8                     ; read PCI command register
   250 000000FF 80CA05                          or      dl, IO_ENA+BM_ENA               ; enable IO and bus master
   251 00000102 E88101                          call    pciRegWrite8
   252                                  
   253                                  ; setup the Codec (actually mixer registers) 
   254 00000105 E8E501                          call    codecConfig                     ; unmute codec, set rates.
   255                                  	; 11/11/2023
   256 00000108 721C                    	jc	short init_err
   257                                  ;
   258                                  ; position file pointer to start in actual wav data
   259                                  ; MUCH improvement should really be done here to check if sample size is
   260                                  ; supported, make sure there are 2 channels, etc.  
   261                                  ;
   262 0000010A B442                            mov     ah, 42h
   263 0000010C B000                            mov     al, 0                           ; from start of file
   264 0000010E 8B1E[100A]                      mov     bx, [filehandle]
   265 00000112 31C9                            xor     cx, cx
   266 00000114 BA2C00                          mov     dx, 44                          ; jump past .wav/riff header
   267 00000117 CD21                            int     21h
   268                                  
   269                                  ; play the .wav file. Most of the good stuff is in here.
   270                                  
   271 00000119 E83703                          call    playWav
   272                                  
   273                                  ; close the .wav file and exit.
   274                                  
   275                                  close_exit:			; 11/11/2023
   276 0000011C E85300                          call    closeFile
   277                                  
   278                                  exit:
   279 0000011F B8004C                          mov     ax, 4c00h
   280 00000122 CD21                    	int 	21h
   281                                  
   282                                  here:
   283 00000124 EBFE                    	jmp	short here
   284                                  
   285                                  	; 11/11/2023
   286                                  init_err:
   287 00000126 BA[8A09]                	mov	dx, msg_init_err
   288                                  vra_err: ; 12/11/2023
   289 00000129 B409                            mov	ah, 9
   290 0000012B CD21                            int	21h
   291 0000012D EBED                    	jmp	short close_exit
   292                                  
   293                                  ; MEMALLOC.ASM
   294                                  ;-- SETFREE: Release memory not used  ----------------
   295                                  ;-- Input    : ES = address of PSP
   296                                  ;-- Output   : none
   297                                  ;-- Register : AX, BX, CL and FLAGS are changed 
   298                                  ;-- Info     : Since the stack-segment is always the last segment in an 
   299                                  ;              EXE-file, ES:0000 points to the beginning and SS:SP
   300                                  ;              to the end of the program in memory. Through this the
   301                                  ;              length of the program can be calculated 
   302                                  ; call this routine once at the beginning of the program to free up memory
   303                                  ; assigned to it by DOS.
   304                                  
   305                                  setFree:
   306 0000012F BB0010                  	  mov	bx, 65536/16	; 4K paragraphs ; 17/02/2017 (Erdogan Tan)		
   307                                  
   308 00000132 B44A                              mov	ah, 4ah		;pass new length to DOS
   309 00000134 CD21                              int	21h
   310                                  
   311 00000136 C3                                retn			; back to caller 
   312                                  				; new size (allocated memory) = 64KB
   313                                  
   314                                  memAlloc:
   315                                  ; input: AX = # of paragraphs required
   316                                  ; output: AX = segment of block to use
   317                                  
   318 00000137 53                      	push	bx
   319 00000138 89C3                    	mov	bx, ax
   320 0000013A B448                    	mov	ah, 48h
   321 0000013C CD21                    	int	21h
   322 0000013E 5B                      	pop	bx
   323 0000013F C3                      	retn
   324                                  
   325                                  ; CMDLINE.ASM
   326                                  ; parse the command line
   327                                  ; entry: none
   328                                  ; exit: DS:DX to the 1st supplied item on the command line 
   329                                  
   330                                  processCmdline:
   331 00000140 53                              push    bx
   332 00000141 56                              push    si
   333                                  
   334                                          ;mov    ah, 51h
   335                                          ;int    21h
   336                                          ;mov    ds, bx
   337                                  
   338 00000142 BE8000                          mov     si, 80h
   339 00000145 0FB61C                          movzx   bx, byte [si]
   340 00000148 01DE                            add     si, bx
   341 0000014A 46                              inc     si
   342                                  
   343 0000014B C60400                          mov     byte [si], NULL         ; zero terminate
   344                                  
   345 0000014E BE8100                          mov     si, 81h
   346                                  
   347                                  cmdlineloop:
   348 00000151 AC                              lodsb
   349                                  
   350 00000152 3C00                            cmp     al, NULL                ; found end of line?
   351 00000154 7404                            je      short exitpc
   352 00000156 3C20                            cmp     al, ' '                 ; found a space?
   353 00000158 74F7                            je      short cmdlineloop
   354                                  
   355                                          ; must be the filename here.
   356                                  exitpc:
   357 0000015A 4E                              dec     si                      ; point to start of filename
   358 0000015B 89F2                            mov     dx, si
   359 0000015D 5E                              pop     si
   360 0000015E 5B                              pop     bx
   361 0000015F C3                      	retn
   362                                  
   363                                  ; FILE.ASM
   364                                  ;open or create file
   365                                  ;
   366                                  ;input: ds:dx-->filename (asciiz)
   367                                  ;       al=file Mode (create or open)
   368                                  ;output: none  cs:[filehandle] filled
   369                                  ;
   370                                  openFile:
   371 00000160 50                      	push	ax
   372 00000161 51                      	push	cx
   373 00000162 B43B                    	mov	ah, 3bh			; start with a mode
   374 00000164 00C4                    	add	ah, al			; add in create or open mode
   375 00000166 31C9                    	xor	cx, cx
   376 00000168 CD21                    	int	21h
   377 0000016A 7203                    	jc	short _of1
   378                                  	;mov	[cs:filehandle], ax
   379 0000016C A3[100A]                	mov	[filehandle], ax
   380                                  _of1:
   381 0000016F 59                      	pop	cx
   382 00000170 58                      	pop	ax
   383 00000171 C3                      	retn
   384                                  
   385                                  ; close the currently open file
   386                                  ; input: none, uses cs:[filehandle]
   387                                  closeFile:
   388 00000172 50                      	push	ax
   389 00000173 53                      	push	bx
   390 00000174 833E[100A]FF            	cmp	word [filehandle], -1
   391 00000179 7409                    	jz	short _cf1
   392 0000017B 8B1E[100A]              	mov     bx, [filehandle]  
   393 0000017F B8003E                  	mov     ax,3e00h
   394 00000182 CD21                            int     21h              ;close file
   395                                  _cf1:
   396 00000184 5B                      	pop	bx
   397 00000185 58                      	pop	ax
   398 00000186 C3                      	retn
   399                                  
   400                                  getSampleRate:
   401                                  	; 08/12/2016
   402                                  ; reads the sample rate from the .wav file.
   403                                  ; entry: none - assumes file is already open
   404                                  	; 19/11/2016 - Erdogan Tan
   405                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   406                                  ;	cx = number of channels (mono=1, stereo=2)
   407                                  ;	dx = bits per sample (8, 16)
   408                                  
   409 00000187 53                      	push    bx
   410                                  
   411 00000188 B442                            mov     ah, 42h
   412 0000018A B000                            mov     al, 0				; from start of file
   413 0000018C 8B1E[100A]                      mov     bx, [filehandle]
   414 00000190 31C9                            xor     cx, cx
   415 00000192 BA0800                          mov     dx, 08h				; "WAVE"
   416 00000195 CD21                            int     21h
   417                                  
   418 00000197 BA[F409]                        mov     dx, smpRBuff
   419 0000019A B91C00                          mov     cx, 28				; 28 bytes
   420 0000019D B43F                    	mov	ah, 3fh
   421 0000019F CD21                            int     21h
   422                                  
   423 000001A1 813E[F409]5741          	cmp	word [smpRBuff], 'WA'
   424 000001A7 751C                    	jne	short gsr_stc
   425                                  
   426 000001A9 813E[F609]5645          	cmp	word [smpRBuff+2], 'VE'
   427 000001AF 7514                    	jne	short gsr_stc
   428                                  
   429 000001B1 833E[000A]01            	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   430 000001B6 750D                    	jne	short gsr_stc
   431                                  
   432                                  
   433 000001B8 8B0E[020A]              	mov	cx, [smpRBuff+14]	; return num of channels in CX
   434 000001BC A1[040A]                        mov     ax, [smpRBuff+16]	; return sample rate in AX
   435 000001BF 8B16[0E0A]              	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   436                                  gsr_retn:
   437 000001C3 5B                              pop     bx
   438 000001C4 C3                              retn
   439                                  
   440                                  gsr_stc:
   441 000001C5 F9                      	stc
   442 000001C6 EBFB                    	jmp	short gsr_retn
   443                                  
   444                                  %include 'ac97.asm' ; 29/11/2016 (AC97 codec configuration)
     1                              <1> ; 12/11/2023
     2                              <1> ; 11/11/2023
     3                              <1> ; 06/11/2023
     4                              <1> ; 05/11/2023
     5                              <1> ; 04/11/2023
     6                              <1> ; 03/11/2023
     7                              <1> ; PCI and AC97 codec functions for wav player
     8                              <1> ; Erdogan Tan (17/02/2017)
     9                              <1> 
    10                              <1> ; ----------------------------------------------------------------------------
    11                              <1> ; PCI.ASM
    12                              <1> ; ----------------------------------------------------------------------------
    13                              <1> 
    14                              <1> ; PCI device register reader/writers.
    15                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    16                              <1> ; 		Last Update: 17/02/2017
    17                              <1> 
    18                              <1> ;===============================================================
    19                              <1> ; 8/16/32bit PCI reader
    20                              <1> ;
    21                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    22                              <1> ;           BIT30 set if 32 bit access requested
    23                              <1> ;           BIT29 set if 16 bit access requested
    24                              <1> ;           otherwise defaults to 8 bit read
    25                              <1> ;
    26                              <1> ; Exit:  DL,DX,EDX register data depending on requested read size
    27                              <1> ;
    28                              <1> ; Note: this routine is meant to be called via pciRegRead8, pciRegread16,
    29                              <1> ;	or pciRegRead32, listed below.
    30                              <1> ;
    31                              <1> ; Note2: don't attempt to read 32bits of data from a non dword aligned reg
    32                              <1> ;	 number. Likewise, don't do 16bit reads from non word aligned reg #
    33                              <1> ; 
    34                              <1> pciRegRead:
    35 000001C8 6653                <1> 	push	ebx
    36 000001CA 51                  <1> 	push	cx
    37 000001CB 6689C3              <1>         mov     ebx, eax                        ; save eax, dh
    38 000001CE 88F1                <1>         mov     cl, dh
    39 000001D0 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    40 000001D6 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
    41 000001DC 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
    42                              <1> 
    43 000001DE BAF80C              <1>         mov     dx, PCI_INDEX_PORT
    44 000001E1 66EF                <1>         out     dx, eax                         ; write PCI selector
    45                              <1> 
    46 000001E3 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
    47 000001E6 88D8                <1>         mov     al, bl
    48 000001E8 2403                <1>         and     al, 3                           ; figure out which port to
    49 000001EA 00C2                <1>         add     dl, al                          ; read to
    50                              <1> 
    51 000001EC 66ED                <1> 	in      eax, dx                         ; do 32bit read
    52 000001EE 66F7C300000080      <1>         test    ebx, PCI32
    53 000001F5 7403                <1>         jz      short _pregr1
    54                              <1> 
    55 000001F7 6689C2              <1>         mov     edx, eax                        ; return 32bits of data
    56                              <1> _pregr1:
    57 000001FA 89C2                <1> 	mov     dx, ax                          ; return 16bits of data
    58 000001FC 66F7C3000000C0      <1>         test    ebx, PCI32+PCI16
    59 00000203 7502                <1>         jnz     short _pregr2
    60 00000205 88CE                <1>         mov     dh, cl                          ; restore dh for 8 bit read
    61                              <1> _pregr2:
    62 00000207 6689D8              <1>         mov     eax, ebx                        ; restore eax
    63 0000020A 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    64 00000210 59                  <1> 	pop	cx
    65 00000211 665B                <1> 	pop	ebx
    66 00000213 C3                  <1> 	retn
    67                              <1> 
    68                              <1> pciRegRead8:
    69 00000214 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32             ; set up 8 bit read size
    70 0000021A EBAC                <1>         jmp     short pciRegRead		; call generic PCI access
    71                              <1> 
    72                              <1> pciRegRead16:
    73 0000021C 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit read size
    74 00000222 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
    75 00000228 EB9E                <1>         jmp     short pciRegRead
    76                              <1> 
    77                              <1> pciRegRead32:
    78 0000022A 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit read size
    79 00000230 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
    80 00000236 EB90                <1>         jmp     short pciRegRead
    81                              <1> 
    82                              <1> ;===============================================================
    83                              <1> ; 8/16/32bit PCI writer
    84                              <1> ;
    85                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    86                              <1> ;           BIT31 set if 32 bit access requested
    87                              <1> ;           BIT30 set if 16 bit access requested
    88                              <1> ;           otherwise defaults to 8bit read
    89                              <1> ;        DL/DX/EDX data to write depending on size
    90                              <1> ;
    91                              <1> ;
    92                              <1> ; note: this routine is meant to be called via pciRegWrite8, pciRegWrite16,
    93                              <1> ; 	or pciRegWrite32 as detailed below.
    94                              <1> ;
    95                              <1> ; Note2: don't attempt to write 32bits of data from a non dword aligned reg
    96                              <1> ;	 number. Likewise, don't do 16bit writes from non word aligned reg #
    97                              <1> ;
    98                              <1> pciRegWrite:
    99 00000238 6653                <1> 	push	ebx
   100 0000023A 51                  <1> 	push	cx
   101 0000023B 6689C3              <1>         mov     ebx, eax                        ; save eax, dx
   102 0000023E 89D1                <1>         mov     cx, dx
   103 00000240 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
   104 00000246 6625FFFFFFBF        <1>         and     eax, ~PCI16 ; NOT PCI16         ; clear out data size request
   105 0000024C 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
   106                              <1> 
   107 0000024E BAF80C              <1>         mov     dx, PCI_INDEX_PORT
   108 00000251 66EF                <1>         out     dx, eax                         ; write PCI selector
   109                              <1> 
   110 00000253 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
   111 00000256 88D8                <1>         mov     al, bl
   112 00000258 2403                <1>         and     al, 3                           ; figure out which port to
   113 0000025A 00C2                <1>         add     dl, al                          ; write to
   114                              <1> 
   115 0000025C 6689D0              <1>         mov     eax, edx                        ; put data into eax
   116 0000025F 89C8                <1>         mov     ax, cx
   117                              <1> 
   118 00000261 EE                  <1>         out     dx, al
   119 00000262 66F7C3000000C0      <1>         test    ebx, PCI16+PCI32                ; only 8bit access? bail
   120 00000269 740C                <1>         jz      short _pregw1
   121                              <1> 
   122 0000026B EF                  <1>         out     dx, ax                          ; write 16 bit value
   123 0000026C 66F7C300000040      <1>         test    ebx, PCI16                      ; 16bit requested?  bail
   124 00000273 7502                <1>         jnz     short _pregw1
   125                              <1> 
   126 00000275 66EF                <1>         out     dx, eax                         ; write full 32bit
   127                              <1> _pregw1:
   128 00000277 6689D8              <1>         mov     eax, ebx                        ; restore eax
   129 0000027A 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
   130 00000280 89CA                <1>         mov     dx, cx                          ; restore dx
   131 00000282 59                  <1> 	pop	cx
   132 00000283 665B                <1> 	pop	ebx
   133 00000285 C3                  <1> 	ret
   134                              <1> 
   135                              <1> pciRegWrite8:
   136 00000286 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 8 bit write size
   137 0000028C EBAA                <1>         jmp     short pciRegWrite		; call generic PCI access
   138                              <1> 
   139                              <1> pciRegWrite16:
   140 0000028E 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit write size
   141 00000294 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
   142 0000029A EB9C                <1>         jmp     short pciRegWrite
   143                              <1> 
   144                              <1> pciRegWrite32:
   145 0000029C 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit write size
   146 000002A2 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
   147 000002A8 EB8E                <1>         jmp     short pciRegWrite
   148                              <1> 
   149                              <1> ; 17/02/2017 (Modifed by Erdogan Tan for various ICH device IDs)
   150                              <1> ;===============================================================
   151                              <1> ; PCIFindDevice: scan through PCI space looking for a device+vendor ID
   152                              <1> ;
   153                              <1> ;  ENTRY: none
   154                              <1> ;; Entry: EAX=Device+Vendor ID
   155                              <1> ;
   156                              <1> ;  Exit: EAX=PCI address if device found
   157                              <1> ;	 EDX=Device+Vendor ID
   158                              <1> ;        CY clear if found, set if not found. EAX invalid if CY set.
   159                              <1> ;
   160                              <1> ; [old stackless] Destroys: ebx, esi, edi, cl
   161                              <1> ;
   162                              <1> pciFindDevice:
   163                              <1> 	;push	cx
   164                              <1> 	;push	eax ; *
   165                              <1> 	;push	esi
   166                              <1> 	;push	edi
   167                              <1> 
   168                              <1>  	;mov     esi, eax                ; save off vend+device ID
   169                              <1> 
   170                              <1> 	; 17/02/2017
   171 000002AA BE[4F08]            <1> 	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
   172 000002AD B91500              <1> 	mov	cx, valid_id_count
   173                              <1> pfd_0:
   174 000002B0 66BF00FFFF7F        <1>        	mov     edi, (80000000h - 100h) ; start with bus 0, dev 0 func 0
   175                              <1> nextPCIdevice:
   176 000002B6 6681C700010000      <1>         add     edi, 100h
   177 000002BD 6681FF00F8FF80      <1>         cmp     edi, 80FFF800h		; scanned all devices?
   178                              <1>         ;stc
   179                              <1>         ;je 	short PCIScanExit       ; not found
   180 000002C4 720D                <1> 	jb	short pfd_1
   181 000002C6 66BF00000080        <1> 	mov     edi, 80000000h
   182 000002CC 83C604              <1> 	add	si, 4 ; scan for next device ID
   183 000002CF E202                <1> 	loop	pfd_1	 
   184 000002D1 F9                  <1> 	stc	
   185                              <1> 	;jmp 	short PCIScanExit
   186 000002D2 C3                  <1> 	retn
   187                              <1> pfd_1:
   188 000002D3 6689F8              <1>         mov     eax, edi                ; read PCI registers
   189 000002D6 E851FF              <1>         call    pciRegRead32
   190                              <1>         ;cmp    edx, esi                ; found device?
   191 000002D9 663B14              <1>         cmp	edx, dword [si]
   192 000002DC 75D8                <1> 	jne     short nextPCIdevice
   193                              <1>         ;clc
   194                              <1> PCIScanExit:
   195                              <1> 	;pushf
   196 000002DE 66B800000080        <1> 	mov	eax, BIT31
   197 000002E4 66F7D0              <1> 	not	eax
   198 000002E7 6621F8              <1> 	and	eax, edi		; return only bus/dev/fn #
   199                              <1> 	;popf
   200                              <1> 
   201                              <1> 	;pop	edi
   202                              <1> 	;pop	esi
   203                              <1> 	;pop	edx ; *
   204                              <1> 	;pop	cx
   205 000002EA C3                  <1> 	retn
   206                              <1> 
   207                              <1> ; ----------------------------------------------------------------------------
   208                              <1> ; CODEC.ASM
   209                              <1> ; ----------------------------------------------------------------------------
   210                              <1> 
   211                              <1> ; codec configuration code. Not much here really.
   212                              <1> ; NASM version: Erdogan Tan (29/11/2016)
   213                              <1> 
   214                              <1> ; enable codec, unmute stuff, set output rate to 44.1
   215                              <1> ; entry: ax = desired sample rate
   216                              <1> 
   217                              <1> ; 11/11/2023
   218                              <1> ; 06/11/2023
   219                              <1> %if 1
   220                              <1> 
   221                              <1> 	; 11/11/2023
   222                              <1> init_ac97_codec_err1:
   223 000002EB F9                  <1> 	stc
   224                              <1> init_ac97_codec_err2:
   225 000002EC C3                  <1> 	retn
   226                              <1> 
   227                              <1> codecConfig:
   228                              <1> 	; 04/11/2023
   229                              <1> 	; 17/02/2017 
   230                              <1> 	; 07/11/2016 (Erdogan Tan)
   231                              <1> 	;PORT_NABM_GLB_CTRL_STAT equ 60h
   232                              <1> 
   233                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   234                              <1>  	; 'AC97_DEF.H'
   235                              <1> 	;AC97_EXTENDED_STATUS equ 002Ah
   236                              <1> 	AC97_EA_SPDIF	equ 0002h
   237                              <1> 	AC97_EA_VRA	equ 0001h
   238                              <1> 	; 04/11/2023
   239                              <1> 	ICH_PO_CR_RESET equ 0002h  ; reset codec
   240                              <1> 	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
   241                              <1> 	ICH_PCM_246_MASK equ 300000h ; 6 channels
   242                              <1> 
   243                              <1> 	; 04/11/2023
   244                              <1> init_ac97_controller:
   245 000002ED 66A1[1E0A]          <1> 	mov	eax, [bus_dev_fn]
   246 000002F1 B004                <1> 	mov	al, PCI_CMD_REG
   247 000002F3 E826FF              <1> 	call	pciRegRead16		; read PCI command register
   248 000002F6 80CA05              <1> 	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
   249 000002F9 E892FF              <1> 	call	pciRegWrite16
   250                              <1> 
   251 000002FC E84901              <1> 	call	delay_100ms
   252                              <1> 
   253                              <1> init_ac97_codec:
   254                              <1> 	; 11/11/2023
   255                              <1> 	; (TRDOS 386 v2.0.5, 'audio.s')
   256 000002FF BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   257 00000302 0316[160A]          <1> 	add	dx, [NABMBAR]
   258 00000306 66ED                <1> 	in	eax, dx
   259                              <1> 	; ?
   260 00000308 BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   261 0000030B 0316[160A]          <1> 	add	dx, [NABMBAR]
   262 0000030F 66ED                <1> 	in	eax, dx
   263                              <1> 
   264 00000311 6683F8FF            <1> 	cmp	eax, 0FFFFFFFFh ; -1
   265 00000315 74D4                <1> 	je	short init_ac97_codec_err1
   266                              <1> 
   267 00000317 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   268 0000031D 7503                <1> 	jnz	short _ac97_codec_ready
   269                              <1> 
   270 0000031F E8A600              <1> 	call	reset_ac97_codec
   271                              <1> 	; 11/11/2023
   272                              <1> 	;jc	short init_ac97_codec_err2
   273                              <1> 
   274                              <1> _ac97_codec_ready:
   275 00000322 8B16[140A]          <1> 	mov	dx, [NAMBAR]
   276                              <1> 	;add	dx, 0 ; ac_reg_0 ; reset register
   277 00000326 EF                  <1> 	out	dx, ax
   278                              <1> 
   279 00000327 E81E01              <1> 	call	delay_100ms
   280                              <1> 
   281                              <1> ;	xor	eax, eax ; 0
   282                              <1> ;	mov	dx, [NAMBAR]
   283                              <1> ;	add	dx, CODEC_REG_POWERDOWN
   284                              <1> ;	out	dx, ax
   285                              <1> ;
   286                              <1> ;	; wait for 1 second
   287                              <1> ;	mov	ecx, 1000 ; 1000*0.25ms = 1s
   288                              <1> ;_ac97_codec_rloop:
   289                              <1> ;	call	delay1_4ms
   290                              <1> ;	call	delay1_4ms
   291                              <1> ;	call	delay1_4ms
   292                              <1> ;	call	delay1_4ms
   293                              <1> ;	;mov	dx, [NAMBAR]
   294                              <1> ;	;add	dx, CODEC_REG_POWERDOWN
   295                              <1> ;	in	ax, dx	
   296                              <1> ;	and	ax, 0Fh
   297                              <1> ;	cmp	al, 0Fh
   298                              <1> ;	je	short _ac97_codec_init_ok
   299                              <1> ;	loop	_ac97_codec_rloop 
   300                              <1> ;
   301                              <1> ;init_ac97_codec_err1:
   302                              <1> ;	stc
   303                              <1> ;
   304                              <1> ;init_ac97_codec_err2:
   305                              <1> ;	retn
   306                              <1> 
   307                              <1> _ac97_codec_init_ok:
   308                              <1>         ; 11/11/2023
   309                              <1> 	;mov	al, 2 ; force set 16-bit 2-channel PCM
   310                              <1> 	;mov	dx, GLOB_CNT_REG ; 2Ch
   311                              <1> 	;add	dx, [NABMBAR]
   312                              <1> 	;out	dx, eax
   313                              <1> 
   314                              <1> 	;;call	delay1_4ms
   315                              <1> 
   316 0000032A E86600              <1> 	call 	reset_ac97_controller
   317                              <1> 
   318                              <1> 	; 11/11/2023
   319 0000032D E8F602              <1> 	call	delay1_4ms
   320                              <1> 
   321                              <1> 	;call 	setup_ac97_codec
   322                              <1> 
   323                              <1> setup_ac97_codec:
   324                              <1> 	; 12/11/2023
   325 00000330 813E[260A]80BB      <1> 	cmp	word [sample_rate], 48000
   326 00000336 742F                <1> 	je	short skip_rate
   327                              <1> 
   328                              <1> ; 11/11/2023
   329                              <1> ; 05/11/2023
   330                              <1> ;%if 1
   331                              <1> 	AC97_EA_VRA equ BIT0 ; 11/11/2023
   332                              <1> 
   333                              <1> 	; 11/11/2023
   334 00000338 8B16[140A]          <1> 	mov    	dx, [NAMBAR]               	
   335 0000033C 83C22A              <1> 	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah  	  
   336 0000033F ED                  <1> 	in     	ax, dx
   337 00000340 24FD                <1> 	and	al, ~BIT1 ; Clear DRA
   338 00000342 0C01                <1> 	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
   339 00000344 EF                  <1> 	out	dx, ax			; Enable variable rate audio
   340                              <1> 	
   341 00000345 B90A00              <1> 	mov	cx, 10
   342                              <1> check_vra:
   343 00000348 E8FD00              <1> 	call	delay_100ms
   344                              <1> 
   345                              <1> 	; 11/11/2023
   346 0000034B ED                  <1> 	in	ax, dx
   347 0000034C A801                <1> 	test	al, AC97_EA_VRA ; 1
   348 0000034E 7509                <1> 	jnz	short set_rate
   349                              <1> 
   350                              <1> 	; 11/11/2023
   351 00000350 E2F6                <1> 	loop	check_vra
   352                              <1> 
   353                              <1> 	; 12/11/2023
   354 00000352 58                  <1> 	pop	ax ; discard return address to the caller
   355 00000353 BA[BB09]            <1> 	mov	dx, msg_no_vra
   356 00000356 E9D0FD              <1> 	jmp	vra_err
   357                              <1> 
   358                              <1> set_rate:
   359 00000359 A1[260A]            <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   360                              <1> 
   361 0000035C 8B16[140A]          <1> 	mov    	dx, [NAMBAR]               	
   362 00000360 83C22C              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   363 00000363 EF                  <1> 	out	dx, ax 			; PCM Front/Center Output Sample Rate
   364                              <1> 
   365 00000364 E8E100              <1> 	call	delay_100ms
   366                              <1> 
   367                              <1> 	; 12/11/2023
   368                              <1> skip_rate:
   369                              <1> 	; 11/11/2023 (temporary)
   370                              <1> 
   371                              <1> 	;mov   	dx, [NAMBAR]               	
   372                              <1> 	;add   	dx, CODEC_PCM_SURND_DACRATE_REG	; 2Eh  	  
   373                              <1> 	;out	dx, ax 			; PCM Surround Output Sample Rate
   374                              <1> 
   375                              <1> 	;call	delay_100ms
   376                              <1> 
   377                              <1> 	;mov   	dx, [NAMBAR]               	
   378                              <1> 	;add   	dx, CODEC_PCM_LFE_DACRATE_REG	; 30h  	  
   379                              <1> 	;out	dx, ax 			; PCM LFE Output Sample Rate
   380                              <1> 
   381                              <1> 	;call	delay_100ms
   382                              <1> 
   383                              <1> 	; 05/11/2023 (temporary)
   384                              <1> 	;mov	dx, [NAMBAR]               	
   385                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   386                              <1> 	;out	dx, ax 			; PCM Input Sample Rate
   387                              <1> 	;
   388                              <1> 	;call	delay_100ms
   389                              <1> 
   390 00000367 B80202              <1> 	mov	ax, 0202h
   391 0000036A 8B16[140A]          <1>   	mov     dx, [NAMBAR]
   392 0000036E 83C202              <1>   	add     dx, CODEC_MASTER_VOL_REG	;02h 
   393 00000371 EF                  <1> 	out     dx, ax
   394                              <1> 
   395                              <1> 	; 11/11/2023
   396                              <1>         ;call	delay1_4ms
   397                              <1>         ;call	delay1_4ms
   398                              <1>         ;call	delay1_4ms
   399                              <1>         ;call	delay1_4ms
   400                              <1>  	;
   401                              <1>   	;mov	dx, [NAMBAR]
   402                              <1>   	;add	dx, CODEC_MASTER_MONO_VOL_REG	;06h 
   403                              <1>   	;out	dx, ax
   404                              <1> 
   405                              <1> 	; 11/11/2023
   406                              <1>         ;call	delay1_4ms
   407                              <1>         ;call	delay1_4ms
   408                              <1>         ;call	delay1_4ms
   409                              <1>         ;call	delay1_4ms
   410                              <1> 	;
   411                              <1> 	;mov	ax, 02h
   412                              <1>   	;mov	dx, [NAMBAR]
   413                              <1>   	;add	dx, CODEC_PCBEEP_VOL_REG	;0Ah 
   414                              <1>   	;out	dx, ax
   415                              <1> 
   416 00000372 E8B102              <1>         call    delay1_4ms
   417 00000375 E8AE02              <1>         call    delay1_4ms
   418 00000378 E8AB02              <1>         call    delay1_4ms
   419 0000037B E8A802              <1>         call    delay1_4ms
   420                              <1> 
   421                              <1> 	;mov	ax, 0202h
   422 0000037E 8B16[140A]          <1>   	mov     dx, [NAMBAR]
   423 00000382 83C218              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h 
   424 00000385 EF                  <1>   	out     dx, ax
   425                              <1> 
   426 00000386 E89D02              <1>         call    delay1_4ms
   427 00000389 E89A02              <1>         call    delay1_4ms
   428 0000038C E89702              <1>         call    delay1_4ms
   429 0000038F E89402              <1>         call    delay1_4ms
   430                              <1> 
   431                              <1> 	; 11/11/2023
   432                              <1> 	;mov	ax, 8008h ; Mute
   433                              <1>   	;mov	dx, [NAMBAR]
   434                              <1> 	;add	dx, CODEC_PHONE_VOL_REG		;0Ch
   435                              <1> 	;			 ; AC97_PHONE_VOL ; TAD Input (Mono)
   436                              <1>   	;out	dx, ax
   437                              <1> 	;
   438                              <1>         ;call	delay1_4ms
   439                              <1>         ;call	delay1_4ms
   440                              <1>         ;call	delay1_4ms
   441                              <1> 	;call	delay1_4ms
   442                              <1> 
   443                              <1> 	;mov	ax, 0808h
   444                              <1> 	;mov	dx, [NAMBAR]
   445                              <1> 	;add	dx, CODEC_LINE_IN_VOL_REG ;10h ; Line Input (Stereo)
   446                              <1> 	;out	dx, ax
   447                              <1> 	;
   448                              <1>         ;call	delay1_4ms
   449                              <1>         ;call	delay1_4ms
   450                              <1>         ;call	delay1_4ms
   451                              <1> 	;call	delay1_4ms
   452                              <1> 
   453                              <1>   	;mov	dx, [NAMBAR]
   454                              <1>         ;add	dx, CODEC_CD_VOL_REG ;12h ; CD Input (Stereo)
   455                              <1>   	;out	dx, ax
   456                              <1> 	;
   457                              <1>   	;mov	dx, [NAMBAR]
   458                              <1>         ;add	dx, CODEC_AUX_VOL_REG ;16h ; Aux Input (Stereo)
   459                              <1>   	;out	dx, ax
   460                              <1> 	;
   461                              <1>         ;call	delay1_4ms
   462                              <1>         ;call	delay1_4ms
   463                              <1>         ;call	delay1_4ms
   464                              <1> 	;call	delay1_4ms
   465                              <1> 
   466                              <1> ;detect_ac97_codec:
   467 00000392 C3                  <1>         retn
   468                              <1> 
   469                              <1> reset_ac97_controller:
   470                              <1> 	; 11/11/2023
   471                              <1> 	; 10/06/2017
   472                              <1> 	; 29/05/2017
   473                              <1> 	; 28/05/2017
   474                              <1> 	; reset AC97 audio controller registers
   475 00000393 31C0                <1> 	xor     ax, ax
   476 00000395 BA0B00              <1>         mov	dx, PI_CR_REG
   477 00000398 0316[160A]          <1> 	add	dx, [NABMBAR]
   478 0000039C EE                  <1> 	out     dx, al
   479                              <1> 
   480 0000039D BA1B00              <1>         mov     dx, PO_CR_REG
   481 000003A0 0316[160A]          <1> 	add	dx, [NABMBAR]
   482 000003A4 EE                  <1> 	out     dx, al
   483                              <1> 
   484 000003A5 BA2B00              <1>         mov     dx, MC_CR_REG
   485 000003A8 0316[160A]          <1> 	add	dx, [NABMBAR]
   486 000003AC EE                  <1> 	out     dx, al
   487                              <1> 
   488 000003AD B002                <1>         mov     al, RR
   489 000003AF BA0B00              <1>         mov     dx, PI_CR_REG
   490 000003B2 0316[160A]          <1> 	add	dx, [NABMBAR]
   491 000003B6 EE                  <1> 	out     dx, al
   492                              <1> 
   493 000003B7 BA1B00              <1>         mov     dx, PO_CR_REG
   494 000003BA 0316[160A]          <1> 	add	dx, [NABMBAR]
   495 000003BE EE                  <1> 	out     dx, al
   496                              <1> 
   497 000003BF BA2B00              <1>         mov     dx, MC_CR_REG
   498 000003C2 0316[160A]          <1> 	add	dx, [NABMBAR]
   499 000003C6 EE                  <1> 	out     dx, al
   500                              <1> 
   501 000003C7 C3                  <1> 	retn
   502                              <1> 
   503                              <1> reset_ac97_codec:
   504                              <1> 	; 11/11/2023
   505                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   506 000003C8 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   507 000003CB 0316[160A]          <1> 	add	dx, [NABMBAR]
   508 000003CF 66ED                <1> 	in	eax, dx
   509                              <1> 
   510                              <1> 	;test	eax, 2
   511                              <1> 	; 06/08/2022
   512 000003D1 A802                <1> 	test	al, 2
   513 000003D3 7405                <1> 	jz	short _r_ac97codec_cold	
   514                              <1> 
   515 000003D5 E80E00              <1> 	call	warm_ac97codec_reset
   516 000003D8 7306                <1> 	jnc	short _r_ac97codec_ok
   517                              <1> _r_ac97codec_cold:
   518 000003DA E83400              <1>         call    cold_ac97codec_reset
   519 000003DD 7301                <1>         jnc     short _r_ac97codec_ok
   520                              <1> 	
   521                              <1> 	; 16/04/2017
   522                              <1>         ;xor	eax, eax	; timeout error
   523                              <1>        	;stc
   524 000003DF C3                  <1> 	retn
   525                              <1> 
   526                              <1> _r_ac97codec_ok:
   527 000003E0 6631C0              <1>         xor     eax, eax
   528                              <1>         ;mov	al, VIA_ACLINK_C00_READY ; 1
   529 000003E3 FEC0                <1>         inc	al
   530 000003E5 C3                  <1> 	retn
   531                              <1> 
   532                              <1> warm_ac97codec_reset:
   533                              <1> 	; 11/11/2023
   534                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   535                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   536 000003E6 66B806000000        <1> 	mov	eax, 6
   537 000003EC BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   538 000003EF 0316[160A]          <1> 	add	dx, [NABMBAR]
   539 000003F3 66EF                <1> 	out	dx, eax
   540                              <1> 
   541 000003F5 B90A00              <1> 	mov	cx, 10	; total 1s
   542                              <1> _warm_ac97c_rst_wait:
   543 000003F8 E84D00              <1> 	call	delay_100ms
   544                              <1> 
   545 000003FB BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   546 000003FE 0316[160A]          <1> 	add	dx, [NABMBAR]
   547 00000402 66ED                <1> 	in	eax, dx
   548                              <1> 
   549 00000404 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   550 0000040A 7504                <1> 	jnz	short _warm_ac97c_rst_ok
   551                              <1> 
   552 0000040C 49                  <1>         dec     cx
   553 0000040D 75E9                <1>         jnz     short _warm_ac97c_rst_wait
   554                              <1> 
   555                              <1> _warm_ac97c_rst_fail:
   556 0000040F F9                  <1>         stc
   557                              <1> _warm_ac97c_rst_ok:
   558 00000410 C3                  <1> 	retn
   559                              <1> 
   560                              <1> cold_ac97codec_reset:
   561                              <1> 	; 11/11/2023
   562                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   563                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   564 00000411 66B802000000        <1>         mov	eax, 2
   565 00000417 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   566 0000041A 0316[160A]          <1> 	add	dx, [NABMBAR]
   567 0000041E 66EF                <1> 	out	dx, eax
   568                              <1> 
   569 00000420 E82500              <1> 	call	delay_100ms 	; wait 100 ms
   570 00000423 E82200              <1> 	call	delay_100ms 	; wait 100 ms
   571 00000426 E81F00              <1> 	call	delay_100ms 	; wait 100 ms
   572 00000429 E81C00              <1> 	call	delay_100ms 	; wait 100 ms
   573                              <1> 
   574 0000042C B91000              <1> 	mov	cx, 16	; total 20*100 ms = 2s
   575                              <1> 
   576                              <1> _cold_ac97c_rst_wait:
   577 0000042F BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   578 00000432 0316[160A]          <1> 	add	dx, [NABMBAR]
   579 00000436 66ED                <1> 	in	eax, dx
   580                              <1> 
   581 00000438 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   582 0000043E 7507                <1> 	jnz	short _cold_ac97c_rst_ok
   583                              <1> 
   584 00000440 E80500              <1> 	call	delay_100ms
   585                              <1> 
   586 00000443 49                  <1>         dec     cx
   587 00000444 75E9                <1>         jnz     short _cold_ac97c_rst_wait
   588                              <1> 
   589                              <1> _cold_ac97c_rst_fail:
   590 00000446 F9                  <1>         stc
   591                              <1> _cold_ac97c_rst_ok:
   592 00000447 C3                  <1> 	retn
   593                              <1> 
   594                              <1> delay_100ms:
   595                              <1> 	; 11/11/2023
   596                              <1> 	; 29/05/2017
   597                              <1> 	; 24/03/2017 ('codec.asm')
   598                              <1> 	; wait 100 ms
   599 00000448 51                  <1> 	push	cx
   600 00000449 B99001              <1> 	mov	cx, 400  ; 400*0.25ms
   601                              <1> _delay_x_ms:
   602 0000044C E8D701              <1> 	call	delay1_4ms
   603 0000044F E2FB                <1>         loop	_delay_x_ms
   604 00000451 59                  <1> 	pop	cx
   605 00000452 C3                  <1> 	retn
   606                              <1> 
   607                              <1> %endif
   608                              <1> 
   609                              <1> ; 11/11/2023
   610                              <1> %if 0
   611                              <1> 
   612                              <1> codecConfig:
   613                              <1> 	; 06/11/2023
   614                              <1> 	; TUNELOOP version (playing without interrupt)
   615                              <1> 	; 04/11/2023
   616                              <1> 	; 17/02/2017 
   617                              <1> 	; 07/11/2016 (Erdogan Tan)
   618                              <1> 
   619                              <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   620                              <1> 
   621                              <1> 	mov    	dx, [NAMBAR]               	
   622                              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   623                              <1> 	out	dx, ax 				; out sample rate
   624                              <1> 		
   625                              <1> 	; 05/11/2023 temp
   626                              <1> 	;mov	dx, [NAMBAR]               	
   627                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   628                              <1> 	;out	dx, ax 
   629                              <1> 
   630                              <1>         call    delay1_4ms
   631                              <1>         call    delay1_4ms
   632                              <1>         call    delay1_4ms
   633                              <1>         call    delay1_4ms
   634                              <1> 
   635                              <1> 	mov	eax, [dev_vendor]
   636                              <1>         cmp	eax, (SI7012_DID<<16)+SIS_VID
   637                              <1>         jne	short cConfig1
   638                              <1> 
   639                              <1> 	; Unmute quirk specifically for the SiS7012
   640                              <1> 
   641                              <1> 	CUSTOM_SIS_7012_REG equ 4Ch ; SiS7012-specific register
   642                              <1> 	
   643                              <1>         mov     dx, [NABMBAR]
   644                              <1>         add     dx, CUSTOM_SIS_7012_REG
   645                              <1>         in      ax, dx
   646                              <1>         or	al, 1
   647                              <1>         out     dx, ax
   648                              <1> 
   649                              <1> cConfig1:
   650                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   651                              <1> 	; initial ac97 volumes (and clear mute flag)
   652                              <1> 		
   653                              <1>   	mov     dx, [NAMBAR]
   654                              <1>   	add     dx, CODEC_MASTER_VOL_REG        ;02h ; STEREO
   655                              <1>   	;xor	ax, ax ; volume attenuation = 0 (max. volume)
   656                              <1>   	; 03/11/2023
   657                              <1> 	mov	ax, 0202h
   658                              <1> 	out     dx, ax
   659                              <1> 
   660                              <1>         call    delay1_4ms	; delays because codecs are slow
   661                              <1>         call    delay1_4ms
   662                              <1>         call    delay1_4ms
   663                              <1>         call    delay1_4ms
   664                              <1>  
   665                              <1>   	mov     dx, [NAMBAR]
   666                              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h
   667                              <1>   	;;xor	ax, ax
   668                              <1> 	;mov	ax, 0202h
   669                              <1>   	out     dx, ax
   670                              <1> 
   671                              <1>         call    delay1_4ms
   672                              <1>         call    delay1_4ms
   673                              <1>         call    delay1_4ms
   674                              <1>         call    delay1_4ms
   675                              <1>  
   676                              <1> 	retn
   677                              <1> 
   678                              <1> %endif
   445                                  %include 'ich_wav.asm' ; 17/02/2017 (ICH AC97 wav playing functions)
     1                              <1> ; 11/11/2023
     2                              <1> ; 08/11/2023
     3                              <1> ; 06/11/2023
     4                              <1> ; 05/11/2023
     5                              <1> ; 04/11/2023
     6                              <1> ; 03/11/2023
     7                              <1> ; DOS based .WAV player using AC'97 and codec interface.
     8                              <1> ; ---------------------------------------------------------------
     9                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    10                              <1> ; Last Update: 17/02/2017 (by Erdogan Tan)
    11                              <1> 
    12                              <1> ; TUNELOOP version (playing without interrupt) - 06/11/2023 - Erdogan Tan
    13                              <1> 
    14                              <1> ; ICHWAV.ASM
    15                              <1> 
    16                              <1> ; player internal variables and other equates.
    17                              <1> BUFFERSIZE      equ     64 * 1024       ; 64k file buffer size.
    18                              <1> ENDOFFILE       equ     BIT0            ; flag for knowing end of file
    19                              <1> 
    20                              <1> ;===========================================================================
    21                              <1> ; entry: none. File is already open and [filehandle] filled.
    22                              <1> ; exit:  not until the song is finished or the user aborts.
    23                              <1> ;
    24                              <1> playWav:
    25                              <1> 	; 07/11/2023
    26                              <1> 	; clear buffer 2
    27                              <1>         ;push	es
    28                              <1> 	;mov	ax, [WAV_BUFFER2]
    29                              <1> 	;mov	es, ax
    30                              <1> 	;sub	ax, ax
    31                              <1> 	;mov	di, ax ; 17/02/2017
    32                              <1> 	;mov	cx, (BUFFERSIZE/2)
    33                              <1> 	;rep	stosw
    34                              <1> 	;pop	es	     
    35                              <1> 	
    36                              <1> 	; load 64k into buffer 1
    37 00000453 A1[1A0A]            <1>         mov     ax, [WAV_BUFFER1]
    38 00000456 E8C000              <1>         call    loadFromFile
    39                              <1> 
    40                              <1> 	; and 64k into buffer 2
    41 00000459 A1[1C0A]            <1> 	mov     ax, [WAV_BUFFER2]
    42 0000045C E8BA00              <1>        	call    loadFromFile
    43                              <1> 
    44                              <1> ; register reset the DMA engine. This may cause a pop noise on the output
    45                              <1> ; lines when the device is reset. Prolly a better idea to mute output, then
    46                              <1> ; reset.
    47                              <1> ;
    48                              <1> 	; 11/11/2023
    49                              <1>         ;mov	dx, [NABMBAR]
    50                              <1>         ;add	dx, PO_CR_REG		; set pointer to Ctrl reg
    51                              <1>         ;mov	al, RR			; set reset
    52                              <1> 	;out	dx, al			; self clearing bit
    53                              <1> 
    54                              <1> ; write last valid index to 31 to start with.
    55                              <1> ; The Last Valid Index register tells the DMA engine when to stop playing.
    56                              <1> ; 
    57                              <1> ; As we progress through the song we change the last valid index to always be
    58                              <1> ; something other than the index we're currently playing.  
    59                              <1> ;
    60                              <1> 	; 08/11/2023
    61                              <1> 	;; 07/11/2023
    62                              <1> 	;mov	al, 1
    63                              <1>         ;;mov	al, 31
    64                              <1> 	;call	setLastValidIndex
    65                              <1> 
    66                              <1> ; create Buffer Descriptor List
    67                              <1> ;
    68                              <1> ; A buffer descriptor list is a list of pointers and control bits that the
    69                              <1> ; DMA engine uses to know where to get the .wav data and how to play it.
    70                              <1> ;
    71                              <1> ; I set it up to use only 2 buffers of .wav data, and whenever 1 buffer is
    72                              <1> ; playing, I refresh the other one with good data.
    73                              <1> ;
    74                              <1> ;
    75                              <1> ; For the control bits, you can specify that the DMA engine fire an interrupt
    76                              <1> ; after a buffer has been processed, but I poll the current index register
    77                              <1> ; to know when it's safe to update the other buffer.
    78                              <1> ;
    79                              <1> ; I set the BUP bit, which tells the DMA engine to just play 0's (silence)
    80                              <1> ; if it ever runs out of data to play. Good for safety.
    81                              <1> ;
    82 0000045F 06                  <1>         push    es
    83 00000460 A1[180A]            <1>         mov     ax, [BDL_BUFFER]		; get segment # for BDL
    84 00000463 8EC0                <1>         mov     es, ax
    85                              <1> 
    86 00000465 B91000              <1>         mov     cx, 32 / 2                      ; make 32 entries in BDL
    87 00000468 31FF                <1>         xor     di, di                          
    88                              <1> _0:
    89                              <1> 
    90                              <1> ; set buffer descriptor 0 to start of data file in memory
    91 0000046A 660FB706[1A0A]      <1>         movzx   eax, word [WAV_BUFFER1]
    92 00000470 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
    93 00000474 66AB                <1>         stosd                                   ; store pointer to wavbuffer1
    94                              <1> 
    95                              <1> ;
    96                              <1> ; set length to 32k samples. 1 sample is 16bits or 2bytes.
    97                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples.
    98                              <1> ; 
    99                              <1> 
   100                              <1> ; 17/02/2017 (Erdogan Tan)
   101                              <1> ; Intel 82801AA (ICH) & Intel 82801AB (ICH0) I/O Controller Hub AC97
   102                              <1> ; Programmers Reference Manual
   103                              <1> 
   104                              <1> ; 2.2.1 Buffer Descriptor List  (on Page 13)
   105                              <1> 	;
   106                              <1> 	;  Generic Form of Buffer Descriptor
   107                              <1> 	;  ---------------------------------
   108                              <1> 	;  63   62    61-48    47-32   31-0
   109                              <1> 	;  ---  ---  --------  ------- -----
   110                              <1> 	;  IOC  BUP -reserved- Buffer  Buffer
   111                              <1> 	;		      Length   Pointer
   112                              <1> 	;		      [15:0]   [31:0]
   113                              <1> 	;
   114                              <1> 	;  IOC:	Interrupt On Completion. 
   115                              <1> 	;	1 = Enabled. 
   116                              <1> 	;	    When this is set, it means that the controller should
   117                              <1> 	;	    issue an interrupt upon completion of this buffer.
   118                              <1> 	;	    It should also set the IOC bit in the status register
   119                              <1> 	;	0 = Disabled	
   120                              <1> 	;
   121                              <1> 	;  BUP: Buffer Underrun Policy.
   122                              <1> 	;       0 = When this buffer is complete,
   123                              <1> 	;	    if the next buffer is not yet ready 
   124                              <1> 	;	    (i.e., the last valid buffer has been processed),
   125                              <1> 	;	    then continue to transmit the last valid sample.
   126                              <1> 	;	1 = When this buffer is complete,
   127                              <1> 	;     	    if this is the last valid buffer, transmit zeros after
   128                              <1> 	;	    this buffer has been processed completely.
   129                              <1> 	;	    This bit typically is set only if this is the last 
   130                              <1> 	;	    buffer in the current stream.
   131                              <1> 	;
   132                              <1> 	; [31:0]: Buffer pointer. This field points to the location of
   133                              <1> 	;	  the data buffer. Since samples can be as wide as one
   134                              <1> 	;	  word, the buffer must be aligned with word boundaries,
   135                              <1> 	;	  to prevent samples from straddling DWord boundaries.
   136                              <1> 	;
   137                              <1> 	; [15:0]: Buffer Length: This is the length of the data buffer,
   138                              <1> 	;	  in number of samples. The controller uses this data
   139                              <1> 	;	  to determine the length of the buffer, in bytes.
   140                              <1> 	;	  "0" indicates no sample to process.
   141                              <1> 
   142                              <1> ; ICH2AC97.INC
   143                              <1> 
   144                              <1> ;	IOC	equ     BIT31   ; Fire an interrupt whenever this
   145                              <1> 				; buffer is complete.
   146                              <1> 
   147                              <1> ;	BUP	equ     BIT30   ; Buffer Underrun Policy.
   148                              <1> 				; if this buffer is the last buffer
   149                              <1> 				; in a playback, fill the remaining
   150                              <1> 				; samples with 0 (silence) or not.
   151                              <1> 				; It's a good idea to set this to 1
   152                              <1> 				; for the last buffer in playback,
   153                              <1> 				; otherwise you're likely to get a lot
   154                              <1> 				; of noise at the end of the sound.
   155                              <1> ;
   156                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   157                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   158                              <1> ; Luckily for us, that's the same format as .wav files.
   159                              <1> ;
   160                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   161                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   162                              <1> ;
   163                              <1> ; A value of 0 in these bits means play no samples.
   164                              <1> ;
   165                              <1> 
   166                              <1> ; ICHWAV.ASM
   167                              <1> 
   168 00000476 66B800800000        <1> 	mov	eax, BUFFERSIZE / 2 ; size of half buffer (32K)
   169                              <1> 	;or	eax, IOC + BUP
   170                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   171 0000047C 660D00000040        <1> 	or	eax, BUP
   172 00000482 66AB                <1> 	stosd
   173                              <1> 
   174                              <1> ; 2nd buffer:
   175                              <1> 
   176 00000484 660FB706[1C0A]      <1>         movzx   eax, word [WAV_BUFFER2]
   177 0000048A 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   178 0000048E 66AB                <1>         stosd                                   ; store pointer to wavbuffer2
   179                              <1> 
   180                              <1> ; set length to 64k (32k of two 16 bit samples)
   181                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples
   182                              <1> ; 
   183 00000490 66B800800000        <1> 	mov	eax, BUFFERSIZE / 2
   184                              <1> 	;or	eax, IOC + BUP
   185                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   186 00000496 660D00000040        <1> 	or	eax, BUP
   187 0000049C 66AB                <1> 	stosd
   188                              <1> 
   189 0000049E E2CA                <1>         loop    _0
   190 000004A0 07                  <1>         pop     es
   191                              <1> 
   192                              <1> ;
   193                              <1> ; tell the DMA engine where to find our list of Buffer Descriptors.
   194                              <1> ; this 32bit value is a flat mode memory offset (ie no segment:offset)
   195                              <1> ;
   196                              <1> ; write NABMBAR+10h with offset of buffer descriptor list
   197                              <1> ;
   198 000004A1 660FB706[180A]      <1>         movzx   eax, word [BDL_BUFFER]
   199 000004A7 66C1E004            <1> 	shl     eax, 4                          ; convert seg:off to 0:off
   200 000004AB 8B16[160A]          <1>         mov     dx, [NABMBAR]
   201 000004AF 83C210              <1>         add     dx, PO_BDBAR_REG                ; set pointer to BDL
   202 000004B2 66EF                <1>         out     dx, eax                         ; write to AC97 controller
   203                              <1> 
   204                              <1> ;
   205                              <1> ; All set. Let's play some music.
   206                              <1> ;
   207                              <1> 
   208                              <1> 	; 08/11/2023
   209                              <1> 	; 07/11/2023
   210                              <1> 	; 08/12/2016
   211                              <1> 	; 07/10/2016
   212                              <1>         ;mov	al, 1
   213 000004B4 B01F                <1>         mov	al, 31
   214 000004B6 E85801              <1> 	call	setLastValidIndex
   215                              <1> 
   216                              <1> 	; 06/11/2023 (not neccessary)
   217                              <1> 	;; 05/11/2023
   218                              <1> 	;; reset current index
   219                              <1> 	;mov	al, 0
   220                              <1> 	;call	setCurrentIndex
   221                              <1> 
   222                              <1> 	; 06/11/2023
   223                              <1> 	;mov	byte [tLoop], 1 ; 30/11/2016
   224                              <1> 
   225                              <1> 	; 17/02/2017
   226 000004B9 8B16[160A]          <1>         mov     dx, [NABMBAR]
   227 000004BD 83C21B              <1>         add     dx, PO_CR_REG                   ; PCM out Control Register
   228                              <1>         ;mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
   229                              <1> 	;			; (LVBI interrupt will not be enabled)
   230                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   231 000004C0 B001                <1> 	mov	al, RPBM
   232 000004C2 EE                  <1> 	out     dx, al                          ; Start bus master operation.
   233                              <1> 
   234                              <1> 	; 06/11/2023
   235                              <1> 	;call	delay1_4ms
   236                              <1> 	;call	delay1_4ms
   237                              <1> 	;call	delay1_4ms
   238                              <1> 	;call	delay1_4ms
   239                              <1> 
   240                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   241                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   242                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   243                              <1>    
   244                              <1> ; 06/11/2023 (TUNELOOP version, without interrupt)
   245                              <1> %if 0
   246                              <1> 	; 08/12/2016
   247                              <1> 	; 28/11/2016
   248                              <1> p_loop:
   249                              <1> 	call    check4keyboardstop      ; keyboard halt?
   250                              <1>         jc	short r_loop 	; no ; 05/11/2023
   251                              <1> 
   252                              <1> 	;mov	byte [tLoop], 0
   253                              <1> 	; 04/11/2023
   254                              <1> 	;mov	byte [audio_play_cmd], 0
   255                              <1> 	;call	ac97_stop
   256                              <1> 	;retn
   257                              <1> _exit_:
   258                              <1> 	; 04/11/2023
   259                              <1> 	; finished with song, stop everything
   260                              <1> 	call	ac97_stop
   261                              <1> 	
   262                              <1> 	; restore previous interrupt vector and interrupt_status
   263                              <1> 	cli
   264                              <1> 	in	al, 0A1h ; irq 8-15
   265                              <1> 	mov	al, [IRQ_status+1]
   266                              <1> 	out	0A1h, al 
   267                              <1> 	in	al, 021h ; irq 0-7
   268                              <1> 	mov	al, [IRQ_status]
   269                              <1> 	out	21h, al 
   270                              <1> 	; ...
   271                              <1> 	push	es
   272                              <1> 	xor	ax, ax
   273                              <1> 	mov	es, ax
   274                              <1> 	mov	ax, [IRQ_vector]
   275                              <1> 	mov	[es:bx], ax
   276                              <1> 	mov	ax, [IRQ_vector+2]
   277                              <1> 	mov	[es:bx+2], ax
   278                              <1> 	pop	es
   279                              <1> 	sti
   280                              <1> 	retn
   281                              <1> 
   282                              <1> r_loop:
   283                              <1> 	; 07/12/2016 - Erdogan Tan
   284                              <1> 	nop
   285                              <1> 	nop
   286                              <1> 	nop
   287                              <1> 	; 17/02/2017
   288                              <1> 	mov	al, [tBuff]
   289                              <1> 	dec	al ; 1-32 -> 0-31 or 0 -> 0FFh
   290                              <1> 	js	short  p_loop
   291                              <1> 	mov	byte [tBuff], 0 ; reset
   292                              <1> 	and	al, 1
   293                              <1> 	jnz	short q_loop
   294                              <1>         mov     ax, [WAV_BUFFER2] ; [tBuff]=2 (from tuneLoop)
   295                              <1> s_loop:
   296                              <1>         call    loadFromFile
   297                              <1> 	;jc	short _exit_
   298                              <1> 	; 05/11/2023
   299                              <1> 	jc	short exit_loop
   300                              <1> 	jmp	short r_loop
   301                              <1> q_loop:
   302                              <1>      	mov     ax, [WAV_BUFFER1] ; [tBuff]=1 (from tuneLoop)
   303                              <1>         ;call	loadFromFile
   304                              <1> 	;jc	short _exit_
   305                              <1> 	;jmp	short r_loop
   306                              <1> 	; 05/11/2023
   307                              <1> 	jmp	short s_loop
   308                              <1> 
   309                              <1> exit_loop: 
   310                              <1> 	mov	byte [tLoop], 0
   311                              <1> 	retn
   312                              <1> 		
   313                              <1> tuneLoop:
   314                              <1> 	; 05/11/2023
   315                              <1> 	; 08/12/2016
   316                              <1> 	; 28/11/2016 - Erdogan Tan
   317                              <1> 	
   318                              <1> 	cmp	byte [tLoop], 1
   319                              <1> 	jb	short _exit_ ; 05/11/2023
   320                              <1> _tlp_1:	
   321                              <1> 	; 17/02/2017
   322                              <1> 	call	getCurrentIndex
   323                              <1> 	inc	al ; 0-31 -> 1-32
   324                              <1> 	mov	[tBuff], al
   325                              <1> 
   326                              <1> 	; 05/11/2023
   327                              <1> 	dec	ax
   328                              <1> 	dec	ax
   329                              <1> 	and	al, 1Fh
   330                              <1> 	call	setLastValidIndex
   331                              <1> 
   332                              <1> 	; 05/11/2023
   333                              <1> 	; 17/02/2017 - Buffer switch test (temporary)
   334                              <1> 	push	ds
   335                              <1> 	push	si 
   336                              <1> 	mov	si, 0B800h ; video display page segment
   337                              <1> 	mov	ds, si
   338                              <1> 	sub	si, si ; 0
   339                              <1> 	mov	ah, 4Eh
   340                              <1> 	and	al, 1
   341                              <1> 	add	al, '1'
   342                              <1> 	mov	[si], ax ; show current play buffer (1, 2)
   343                              <1> 	pop	si
   344                              <1> 	pop	ds
   345                              <1> 
   346                              <1> 	; 17/02/2017
   347                              <1> 
   348                              <1> 	;test	byte [irq_status], LVBCI ; last buff completion intr.
   349                              <1> 	;jz	short _tlp2 ; BCIS ; Buffer completion interrupt
   350                              <1> 
   351                              <1> 	; Last Valid Buffer Completion Interrupt (LVBCI).
   352                              <1> 	;   1 = Last valid buffer has been processed. 
   353                              <1> 	;	It remains active until cleared by software. 
   354                              <1> 	;	This bit indicates the occurrence of the event 
   355                              <1> 	;	signified by the last valid buffer being processed.
   356                              <1> 	;	Thus, this is an event status bit that can be cleared
   357                              <1> 	;	by software once this event has been recognized.
   358                              <1> 	;	This event causes an interrupt if the enable bit
   359                              <1> 	;	in the Control Register is set. The interrupt is
   360                              <1> 	;	cleared when the software clears this bit.
   361                              <1> 	;	In the case of Transmits (PCM out, Modem out) this bit
   362                              <1> 	;	is set, after the last valid buffer has been
   363                              <1> 	;	fetched (not after transmitting it).
   364                              <1> 	;	While in the case of Receives, this bit is set after
   365                              <1> 	;	the data for the last buffer has been written to memory.
   366                              <1> 	;   0 = Cleared by writing a "1" to this bit position.
   367                              <1> 
   368                              <1> 	; Note: We are not using LVBCI 
   369                              <1> 	;     Last Buffer Completion Interrupt !!!
   370                              <1> 
   371                              <1> 	; 17/02/2017
   372                              <1>         ;mov     dx, [NABMBAR]
   373                              <1>         ;add     dx, PO_SR_REG	; PCM out Status register
   374                              <1>         ;mov     al, [irq_status]
   375                              <1>         ;out     dx, al		; Clear (LVBCI) interrupt status
   376                              <1> 	;retn
   377                              <1> 
   378                              <1> ;_tlp2:
   379                              <1> 	; Buffer Completion Interrupt Status (BCIS).
   380                              <1> 	;   1 =	Set by the hardware after the last sample 
   381                              <1> 	; 	of a buffer has been processed, AND if the Interrupt
   382                              <1> 	; 	on Completion (IOC) bit is set in the command byte of 
   383                              <1> 	; 	the buffer descriptor. It remains active
   384                              <1> 	; 	until cleared by software.
   385                              <1> 	;   0 =	Cleared by writing a "1" to this bit position.
   386                              <1> 
   387                              <1> 	; 17/02/2017
   388                              <1>         mov     dx, [NABMBAR]
   389                              <1>         add     dx, PO_SR_REG	; PCM out Status register
   390                              <1>         mov     al, [pcm_irq_status] ; 05/11/2023
   391                              <1>         out     dx, al		; Clear (BCI) interrupt status
   392                              <1> 	retn
   393                              <1> 
   394                              <1> ;_exit_:
   395                              <1> ;	mov	byte [tLoop], 0
   396                              <1> ;_exit:
   397                              <1> ;       ; finished with song, stop everything
   398                              <1> ;	mov     dx, [NABMBAR]		
   399                              <1> ;       add     dx, PO_CR_REG           ; PCM out Control Register
   400                              <1> ;       mov     al, 0
   401                              <1> ;       out     dx, al                  ; stop player
   402                              <1> ;_return:
   403                              <1> ;	retn
   404                              <1> 
   405                              <1> %endif
   406                              <1> 
   407                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   408                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   409                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   410                              <1> 
   411                              <1> ; 08/11/2023
   412                              <1> ; 07/11/2023
   413                              <1> %if 1
   414                              <1> 
   415                              <1> tuneLoop:
   416                              <1> 	; 08/11/2023
   417                              <1> 	; 06/11/2023
   418 000004C3 B031                <1> 	mov	al, '1'
   419 000004C5 E84300              <1> 	call	tL0
   420                              <1> tL1:
   421 000004C8 E81B01              <1> 	call    updateLVI	; /set LVI != CIV/
   422 000004CB 7432                <1> 	jz	short _exit_	; 08/11/2023
   423 000004CD E84A01              <1> 	call    check4keyboardstop
   424 000004D0 722D                <1> 	jc	short _exit_
   425 000004D2 E80801              <1> 	call    getCurrentIndex
   426 000004D5 A801                <1> 	test	al, BIT0
   427 000004D7 74EF                <1> 	jz	short tL1	; loop if buffer 2 is not playing
   428                              <1> 
   429                              <1> 	; load buffer 1
   430 000004D9 A1[1A0A]            <1> 	mov     ax, [WAV_BUFFER1]
   431 000004DC E83A00              <1> 	call	loadFromFile
   432 000004DF 721E                <1> 	jc	short _exit_	; end of file
   433                              <1> 
   434 000004E1 B032                <1> 	mov	al, '2'
   435 000004E3 E82500              <1> 	call	tL0
   436                              <1> tL2:
   437 000004E6 E8FD00              <1> 	call    updateLVI
   438 000004E9 7414                <1> 	jz	short _exit_	; 08/11/2023
   439 000004EB E82C01              <1> 	call    check4keyboardstop
   440 000004EE 720F                <1> 	jc	short _exit_
   441 000004F0 E8EA00              <1> 	call    getCurrentIndex
   442 000004F3 A801                <1> 	test	al, BIT0
   443 000004F5 75EF                <1> 	jnz	short tL2	; loop if buffer 1 is not playing
   444                              <1> 
   445                              <1> 	; load buffer 2
   446 000004F7 A1[1C0A]            <1> 	mov     ax, [WAV_BUFFER2]
   447 000004FA E81C00              <1> 	call	loadFromFile
   448 000004FD 73C4                <1> 	jnc	short tuneLoop
   449                              <1> _exit_:
   450 000004FF 8B16[160A]          <1> 	mov	dx, [NABMBAR]		
   451 00000503 83C21B              <1> 	add	dx, PO_CR_REG	; PCM out Control Register
   452 00000506 B000                <1> 	mov	al, 0
   453 00000508 EE                  <1> 	out	dx, al		; stop player
   454                              <1> 
   455 00000509 0430                <1> 	add	al, '0'
   456                              <1> 	;call	tL0
   457                              <1> 	;
   458                              <1> 	;retn
   459                              <1> 	; 06/11/2023
   460                              <1> 	;jmp	short tL0
   461                              <1> 	;retn
   462                              <1> 
   463                              <1> 	; 06/11/2023
   464                              <1> tL0:
   465                              <1> 	; 08/11/2023
   466                              <1> 	; 05/11/2023
   467                              <1> 	; 17/02/2017 - Buffer switch test (temporary)
   468                              <1> 	; 06/11/2023
   469                              <1> 	; al = buffer indicator ('1', '2' or '0' -stop- )
   470 0000050B 1E                  <1> 	push	ds
   471                              <1> 	;push	bx 
   472 0000050C BB00B8              <1> 	mov	bx, 0B800h ; video display page segment
   473 0000050F 8EDB                <1> 	mov	ds, bx
   474 00000511 29DB                <1> 	sub	bx, bx ; 0
   475 00000513 B44E                <1> 	mov	ah, 4Eh
   476 00000515 8907                <1> 	mov	[bx], ax ; show current play buffer (1, 2)
   477                              <1> 	;pop	bx
   478 00000517 1F                  <1> 	pop	ds
   479 00000518 C3                  <1> 	retn
   480                              <1> 
   481                              <1> %endif
   482                              <1> 
   483                              <1> ; 08/11/2023
   484                              <1> ; 07/11/2023
   485                              <1> %if 0
   486                              <1> 
   487                              <1> tuneLoop:
   488                              <1> 	; 07/11/2023
   489                              <1> 	;mov	dx, NABMBAR
   490                              <1> 	;add	dx, PO_CIV_REG ; 14h
   491                              <1> tL1:
   492                              <1> 	call    updateLVI	; set LVI != CIV
   493                              <1> 	call    check4keyboardstop
   494                              <1> 	jc	short _exit_
   495                              <1> 	call    getCurrentIndex
   496                              <1> 	test	al, BIT0
   497                              <1> 	jz	short tL1	; loop if buffer 2 is not playing
   498                              <1> 
   499                              <1> 	; load buffer 1
   500                              <1> 	mov     ax, [WAV_BUFFER1]
   501                              <1> 	call	loadFromFile
   502                              <1> 	jc	short _exit_	; end of file
   503                              <1> tL2:
   504                              <1> 	call    updateLVI
   505                              <1> 	call    check4keyboardstop
   506                              <1> 	jc	short _exit_
   507                              <1> 	call    getCurrentIndex
   508                              <1> 	test	al, BIT0
   509                              <1> 	jnz	short tL2	; loop if buffer 1 is not playing
   510                              <1> 
   511                              <1> 	; load buffer 2
   512                              <1> 	mov     ax, [WAV_BUFFER2]
   513                              <1> 	call	loadFromFile
   514                              <1> 	jnc	short tuneLoop
   515                              <1> _exit_:
   516                              <1> 	mov	dx, [NABMBAR]		
   517                              <1> 	add	dx, PO_CR_REG	; PCM out Control Register
   518                              <1> 	mov	al, 0
   519                              <1> 	out	dx, al		; stop player
   520                              <1> 	retn
   521                              <1> 
   522                              <1> %endif
   523                              <1> 
   524                              <1> ; load data from file in 32k chunks. Would be nice to load 1 64k chunk,
   525                              <1> ; but in DOS you can only load FFFF bytes at a time.
   526                              <1> ;
   527                              <1> ; entry: ax = segment to load data to
   528                              <1> ; exit: CY set if end of file reached.
   529                              <1> ; note: last file buffer is padded with 0's to avoid pops at the end of song.
   530                              <1> ; assumes file is already open. uses [filehandle]
   531                              <1> 
   532                              <1> ; 07/11/2023
   533                              <1> %if 0
   534                              <1> 
   535                              <1> loadFromFile:
   536                              <1> 	; 07/11/2023
   537                              <1> 	; 06/11/2023
   538                              <1> 	; 17/02/2017
   539                              <1> 	;push	ax
   540                              <1> 	;push	cx
   541                              <1> 	;push	dx
   542                              <1> 	;push	bx
   543                              <1> 
   544                              <1> 	;push	es
   545                              <1> 	;push	ds
   546                              <1> 	
   547                              <1>         test    byte [flags], ENDOFFILE	; have we already read the
   548                              <1> 	;stc				; last of the file?
   549                              <1> 	; 05/11/2023
   550                              <1> 	;jnz	endLFF
   551                              <1> 	jz	short lff_12	; 06/11/2023
   552                              <1> 	; 06/11/2023
   553                              <1> 	;;mov	byte [tLoop], 0
   554                              <1> 	;jmp	endLFF
   555                              <1> 	stc
   556                              <1> 	retn
   557                              <1> 
   558                              <1> lff_12:	; 06/11/2023    
   559                              <1> 	mov	[fbs_seg], ax ; save buffer segment
   560                              <1> 	xor	dx, dx
   561                              <1> lff_0:
   562                              <1> 	mov	[fbs_off], dx ; buffer offset
   563                              <1> 
   564                              <1> 	mov     bx, (BUFFERSIZE / 2)	; 32k chunk
   565                              <1> 	mov	cl, [fbs_shift]   
   566                              <1> 	and	cl, cl
   567                              <1> 	jz	short lff_1 ; stereo, 16 bit	
   568                              <1> 
   569                              <1> 	; fbs_shift =
   570                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   571                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   572                              <1> 	shr	bx, cl ; 32K / multiplier
   573                              <1> 
   574                              <1> 	mov	ax, cs
   575                              <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   576                              <1> lff_1:
   577                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   578                              <1> 	; load file into memory
   579                              <1>         mov	cx, bx                         
   580                              <1> 	mov	bx, [filehandle]
   581                              <1> 	mov     ds, ax
   582                              <1>        	mov	ah, 3fh
   583                              <1> 	int	21h
   584                              <1> 
   585                              <1> 	mov	bx, cs
   586                              <1> 	mov	ds, bx
   587                              <1> 
   588                              <1> 	jc	short lff_9 ; error !
   589                              <1> 
   590                              <1> 	and	ax, ax
   591                              <1> 	jz	short lff_10
   592                              <1> 	
   593                              <1> 	mov	bl, [fbs_shift] ; shift count  
   594                              <1> 	or	bl, bl
   595                              <1> 	jz	short lff_7 ; 16 bit stereo samples
   596                              <1> 
   597                              <1> 	push	es
   598                              <1> 	; 06/11/2023
   599                              <1> 	;push	di
   600                              <1> 	;push	si
   601                              <1> 	mov	di, [fbs_off]
   602                              <1> 	mov	si, [fbs_seg] ; buffer segment
   603                              <1> 	mov	es, si
   604                              <1> 	mov	si, temp_buffer ; temporary buffer address
   605                              <1> 	mov	cl, [bps] ; bits per sample (8 or 16)
   606                              <1> 	cmp	cl, 8
   607                              <1> 	jne	short lff_4 ; 16 bit samples
   608                              <1> 	; 8 bit samples
   609                              <1> 	mov	cx, ax ; byte count
   610                              <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   611                              <1> 	jz	short lff_3 ; 8 bit, stereo
   612                              <1> lff_2:
   613                              <1> 	; mono & 8 bit
   614                              <1> 	lodsb
   615                              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   616                              <1> 	stosw	; left channel
   617                              <1> 	stosw	; right channel
   618                              <1> 	loop	lff_2
   619                              <1> 	jmp	short lff_6	
   620                              <1> lff_3:
   621                              <1> 	; stereo & 8 bit
   622                              <1> 	lodsb
   623                              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   624                              <1> 	stosw
   625                              <1> 	loop	lff_3			
   626                              <1> 	jmp	short lff_6
   627                              <1> lff_4:
   628                              <1> 	; 16 bit mono samples
   629                              <1> 	mov	cx, ax ; word count
   630                              <1> lff_5:	
   631                              <1> 	lodsw
   632                              <1> 	stosw	; left channel
   633                              <1> 	stosw	; right channel
   634                              <1> 	loop	lff_5
   635                              <1> lff_6:
   636                              <1> 	mov	ax, di ; save next buffer offset/position
   637                              <1> 	; 06/11/2023
   638                              <1> 	;pop	si
   639                              <1> 	;pop	di
   640                              <1> 	pop	es
   641                              <1> ;lff_7:        
   642                              <1> 	; 06/11/2023
   643                              <1> 	and	ax, ax
   644                              <1> 	jz	short endLFF ; end of 2nd half
   645                              <1> 	mov	cx, (BUFFERSIZE / 2)
   646                              <1> lff_7:
   647                              <1> 	cmp	ax, cx
   648                              <1> 	je	short endLFF	 ; 06/11/2023
   649                              <1> 	;jb	short lff_11
   650                              <1> 	;xor	cx, cx
   651                              <1> 	;sub	cx, ax
   652                              <1> 	;neg	cx
   653                              <1> 	jmp	short lff_11
   654                              <1> lff_8:
   655                              <1> 	; 07/11/2023
   656                              <1> 	cmp	word [fbs_off], (BUFFERSIZE / 2) ; 32768
   657                              <1> 	jnb	short endLFF
   658                              <1> 	
   659                              <1> 	mov	dx, ax ; buffer offset
   660                              <1> 	mov	ax, [fbs_seg] ; buffer segment
   661                              <1> 	jmp	lff_0
   662                              <1> lff_9:  
   663                              <1> 	; 07/11/2023
   664                              <1> 	;; 06/11/2023 (temporary)
   665                              <1> 	;mov	al, '!'  ; error
   666                              <1> 	;call	tL0
   667                              <1> 
   668                              <1> 	xor	ax, ax
   669                              <1> lff_10:
   670                              <1> 	; 07/11/2023
   671                              <1> 	;mov	cx, (BUFFERSIZE / 2)  
   672                              <1> lff_11:
   673                              <1> 	call    padfill				; blank pad the remainder
   674                              <1>         ;clc					; don't exit with CY yet.
   675                              <1>         or	byte [flags], ENDOFFILE		; end of file flag
   676                              <1> endLFF:
   677                              <1>         ;pop	ds
   678                              <1> 	;pop	es
   679                              <1> 	; 06/11/2023
   680                              <1> 	;pop	bx
   681                              <1> 	;pop	dx
   682                              <1>         ;pop	cx
   683                              <1>         ;pop	ax
   684                              <1>         retn
   685                              <1> 
   686                              <1> %endif
   687                              <1> 
   688                              <1> ; 08/11/2023
   689                              <1> ; 07/11/2023
   690                              <1> %if 1
   691                              <1> 
   692                              <1> loadFromFile:
   693                              <1> 	; 07/11/2023
   694                              <1> 
   695 00000519 F606[120A]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
   696                              <1> 					; last of the file?
   697 0000051E 7402                <1> 	jz	short lff_0		; no
   698 00000520 F9                  <1> 	stc
   699 00000521 C3                  <1> 	retn
   700                              <1> 
   701                              <1> lff_0:
   702                              <1> 	; 08/11/2023
   703 00000522 89C5                <1> 	mov	bp, ax ; save buffer segment	
   704                              <1> 
   705 00000524 8A0E[2C0A]          <1> 	mov	cl, [fbs_shift]   
   706 00000528 20C9                <1> 	and	cl, cl
   707 0000052A 7467                <1> 	jz	short lff_1 ; stereo, 16 bit	
   708                              <1> 
   709 0000052C BFFFFF              <1> 	mov	di, BUFFERSIZE - 1 ; 65535
   710                              <1> 
   711                              <1> 	; fbs_shift =
   712                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   713                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   714 0000052F D3EF                <1> 	shr	di, cl
   715 00000531 47                  <1> 	inc	di ; 16384 for 8 bit and mono	
   716                              <1> 		   ; 32768 for 8 bit or mono	
   717                              <1> 
   718 00000532 8CC8                <1> 	mov	ax, cs
   719 00000534 BA[2E0A]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   720                              <1> 
   721                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   722                              <1> 	; load file into memory
   723 00000537 89F9                <1>         mov	cx, di                       
   724 00000539 8B1E[100A]          <1> 	mov	bx, [filehandle]
   725 0000053D 8ED8                <1> 	mov     ds, ax
   726 0000053F B43F                <1>        	mov	ah, 3Fh
   727 00000541 CD21                <1> 	int	21h
   728                              <1> 
   729 00000543 8CCB                <1> 	mov	bx, cs
   730 00000545 8EDB                <1> 	mov	ds, bx
   731                              <1> 
   732 00000547 727C                <1> 	jc	short lff_4 ; error !
   733                              <1> 
   734                              <1> 	; 08/11/2023
   735 00000549 31D2                <1> 	xor	dx, dx ; 0
   736                              <1> 
   737 0000054B 21C0                <1> 	and	ax, ax
   738 0000054D 746D                <1> 	jz	short lff_3
   739                              <1> 
   740 0000054F 8A1E[2C0A]          <1> 	mov	bl, [fbs_shift]
   741                              <1> 
   742 00000553 06                  <1> 	push	es
   743 00000554 89D7                <1> 	mov	di, dx ; 0 ; [fbs_off]
   744                              <1> 	;mov	bp, [fbs_seg] ; buffer segment
   745 00000556 8EC5                <1> 	mov	es, bp
   746 00000558 BE[2E0A]            <1> 	mov	si, temp_buffer ; temporary buffer address
   747 0000055B 89C1                <1> 	mov	cx, ax ; byte count
   748 0000055D 803E[2A0A]08        <1> 	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   749 00000562 751B                <1> 	jne	short lff_7 ; 16 bit samples
   750                              <1> 	; 8 bit samples
   751 00000564 FECB                <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   752 00000566 740C                <1> 	jz	short lff_6 ; 8 bit, stereo
   753                              <1> lff_5:
   754                              <1> 	; mono & 8 bit
   755 00000568 AC                  <1> 	lodsb
   756 00000569 2C80                <1> 	sub	al, 80h ; 08/11/2023
   757 0000056B C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   758 0000056E AB                  <1> 	stosw	; left channel
   759 0000056F AB                  <1> 	stosw	; right channel
   760 00000570 E2F6                <1> 	loop	lff_5
   761 00000572 EB12                <1> 	jmp	short lff_9	
   762                              <1> lff_6:
   763                              <1> 	; stereo & 8 bit
   764 00000574 AC                  <1> 	lodsb
   765 00000575 2C80                <1> 	sub	al, 80h ; 08/11/2023
   766 00000577 C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   767 0000057A AB                  <1> 	stosw
   768 0000057B E2F7                <1> 	loop	lff_6			
   769 0000057D EB07                <1> 	jmp	short lff_9
   770                              <1> lff_7:
   771 0000057F D1E9                <1> 	shr	cx, 1 ; word count
   772                              <1> lff_8:
   773 00000581 AD                  <1> 	lodsw
   774 00000582 AB                  <1> 	stosw	; left channel
   775 00000583 AB                  <1> 	stosw	; right channel
   776 00000584 E2FB                <1> 	loop	lff_8
   777                              <1> lff_9:
   778 00000586 07                  <1> 	pop	es
   779 00000587 09FF                <1> 	or	di, di
   780 00000589 7439                <1> 	jz	short endLFF ; 64KB ok 
   781                              <1> 	
   782 0000058B 89F8                <1> 	mov	ax, di ; [fbs_off]
   783 0000058D 48                  <1> 	dec	ax
   784 0000058E B9FFFF              <1> 	mov	cx, BUFFERSIZE - 1 ; 65535
   785 00000591 EB29                <1> 	jmp	short lff_3
   786                              <1> 	
   787                              <1> lff_1:  
   788                              <1> 	;mov	bp, ax ; save buffer segment
   789 00000593 31D2                <1> 	xor	dx, dx
   790                              <1> 	; load file into memory
   791 00000595 B90080              <1>         mov	cx, (BUFFERSIZE / 2)	; 32k chunk
   792 00000598 8B1E[100A]          <1> 	mov	bx, [filehandle]
   793 0000059C 8ED8                <1> 	mov     ds, ax
   794 0000059E B43F                <1>        	mov	ah, 3Fh
   795 000005A0 CD21                <1> 	int	21h
   796                              <1> 
   797 000005A2 8CCF                <1> 	mov	di, cs
   798 000005A4 8EDF                <1> 	mov	ds, di
   799                              <1> 
   800                              <1> 	; 07/11/2023
   801 000005A6 721D                <1> 	jc	short lff_4 ; error !
   802                              <1> 	
   803 000005A8 39C8                <1> 	cmp	ax, cx
   804 000005AA 7510                <1> 	jne	short lff_3
   805                              <1> lff_2:
   806                              <1> 	; 08/11/2023
   807 000005AC 01C2                <1> 	add	dx, ax
   808                              <1> 	;mov	cx, (BUFFERSIZE / 2)	; 32k chunk
   809                              <1> 	;mov	bx, [filehandle]
   810 000005AE 8EDD                <1> 	mov     ds, bp
   811 000005B0 B43F                <1>        	mov	ah, 3Fh
   812 000005B2 CD21                <1> 	int	21h
   813                              <1> 
   814                              <1> 	;mov	di, cs
   815 000005B4 8EDF                <1> 	mov	ds, di
   816                              <1> 
   817 000005B6 720D                <1> 	jc	short lff_4 ; error !
   818                              <1> 
   819 000005B8 39C8                <1> 	cmp	ax, cx
   820 000005BA 7408                <1> 	je	short endLFF
   821                              <1> lff_3:
   822 000005BC E80F00              <1> 	call    padfill			; blank pad the remainder
   823                              <1>         ;clc				; don't exit with CY yet.
   824 000005BF 800E[120A]01        <1>         or	byte [flags], ENDOFFILE	; end of file flag
   825                              <1> endLFF:
   826 000005C4 C3                  <1>         retn
   827                              <1> lff_4:
   828                              <1> 	; 08/11/2023
   829 000005C5 B021                <1> 	mov	al, '!'  ; error
   830 000005C7 E841FF              <1> 	call	tL0
   831                              <1> 
   832 000005CA 31C0                <1> 	xor	ax, ax
   833 000005CC EBEE                <1> 	jmp	short lff_3
   834                              <1> 
   835                              <1> %endif
   836                              <1> 
   837                              <1> ; entry ds:ax points to last byte in file
   838                              <1> ; cx=target size
   839                              <1> ; note: must do byte size fill
   840                              <1> ; destroys bx, cx
   841                              <1> ;
   842                              <1> padfill:
   843                              <1> 	; 07/11/2023
   844                              <1> 	; 06/11/2023
   845                              <1> 	; 17/02/2017
   846 000005CE 06                  <1> 	push	es
   847                              <1>         ;push	di
   848                              <1> 	;mov	di, [fbs_seg]
   849                              <1> 	;mov	es, di
   850 000005CF 8EC5                <1>         mov	es, bp
   851 000005D1 29C1                <1> 	sub	cx, ax
   852                              <1> 	; 08/11/2023
   853                              <1> 	;mov	di, ax ; (wrong)
   854 000005D3 89D7                <1> 	mov	di, dx ; buffer offset
   855 000005D5 01C7                <1> 	add	di, ax       	
   856                              <1> 	; 07/11/2023
   857                              <1> 	;add	di, [fbs_off]
   858 000005D7 30C0                <1>         xor	al, al
   859 000005D9 F3AA                <1> 	rep	stosb
   860                              <1> 	;mov	[fbs_off], di
   861                              <1> 	;pop	di
   862 000005DB 07                  <1>         pop	es
   863 000005DC C3                  <1> 	retn
   864                              <1> 
   865                              <1> ; returns AL = current index value
   866                              <1> getCurrentIndex:
   867                              <1> 	; 08/11/2023
   868                              <1> 	;push	dx
   869 000005DD 8B16[160A]          <1> 	mov	dx, [NABMBAR]      		
   870 000005E1 83C214              <1> 	add	dx, PO_CIV_REG
   871 000005E4 EC                  <1> 	in	al, dx
   872                              <1> 	;pop	dx
   873                              <1> uLVI2:	;	06/11/2023
   874 000005E5 C3                  <1> 	retn
   875                              <1> 
   876                              <1> ; examines the CIV and the LVI. When they're the same, we set LVI <> CIV
   877                              <1> ; that way, we never run out of buffers to play
   878                              <1> 
   879                              <1> ; 08/11/2023
   880                              <1> %if 0
   881                              <1> 	; 07/11/2023
   882                              <1> updateLVI:
   883                              <1> 	push	ax
   884                              <1> 	push	dx
   885                              <1> 	; 06/11/2023
   886                              <1> 	mov	dx, [NABMBAR]
   887                              <1> 	add	dx, PO_CIV_REG
   888                              <1> 	; (Current Index Value and Last Valid Index value)
   889                              <1> 	in	ax, dx
   890                              <1> 
   891                              <1> 	cmp	al, ah ; is current index = last index ?
   892                              <1> 	jne	short uLVI1
   893                              <1> 
   894                              <1> 	call	setNewIndex
   895                              <1> uLVI1:
   896                              <1> 	pop	dx
   897                              <1> 	pop	ax
   898                              <1> 	retn
   899                              <1> 
   900                              <1> setNewIndex:
   901                              <1> 	; 07/11/2023
   902                              <1> 	push	ax
   903                              <1>         call    getCurrentIndex                 ; get CIV
   904                              <1>         test    byte [flags], ENDOFFILE
   905                              <1>         jnz     short sni_1
   906                              <1>         ; not at the end of the file yet.
   907                              <1>         dec     al                              ; make new index <> current
   908                              <1>         and     al, INDEX_MASK                  ; make sure new value is 0-31
   909                              <1> sni_1:
   910                              <1>         call    setLastValidIndex               ; write new value
   911                              <1>         clc
   912                              <1>         pop	ax
   913                              <1> 	retn
   914                              <1> 
   915                              <1> %endif	
   916                              <1> 
   917                              <1> ; 08/11/2023
   918                              <1> ; 07/11/2023
   919                              <1> ;%if 1
   920                              <1> updateLVI:
   921                              <1> 	; 06/11/2023
   922 000005E6 8B16[160A]          <1> 	mov	dx, [NABMBAR]      		
   923 000005EA 83C214              <1> 	add	dx, PO_CIV_REG
   924                              <1> 	; (Current Index Value and Last Valid Index value)
   925 000005ED ED                  <1> 	in	ax, dx
   926                              <1> 
   927 000005EE 38E0                <1> 	cmp	al, ah ; is current index = last index ?
   928 000005F0 75F3                <1> 	jne	short uLVI2
   929                              <1> 
   930                              <1> 	; 08/11/2023	
   931 000005F2 E8E8FF              <1> 	call	getCurrentIndex
   932                              <1>  
   933 000005F5 F606[120A]01        <1> 	test	byte [flags], ENDOFFILE
   934                              <1> 	;jnz	short uLVI1
   935 000005FA 7411                <1> 	jz	short uLVI0  ; 08/11/2023
   936                              <1> 
   937                              <1> 	; 08/11/2023
   938 000005FC 50                  <1> 	push	ax
   939 000005FD 8B16[160A]          <1> 	mov	dx, [NABMBAR]
   940 00000601 83C216              <1> 	add	dx, PO_SR_REG  ; PCM out status register
   941 00000604 ED                  <1> 	in	ax, dx
   942                              <1> 
   943 00000605 A803                <1> 	test	al, 3 ; bit 1 = Current Equals Last Valid (CELV)
   944                              <1> 		      ; (has been processed)
   945                              <1> 		      ; bit 0 = 1 -> DMA Controller Halted (DCH)
   946 00000607 58                  <1> 	pop	ax
   947 00000608 7407                <1> 	jz	short uLVI1
   948                              <1> uLVI3:
   949 0000060A 31C0                <1> 	xor	ax, ax
   950                              <1> 	; zf = 1
   951 0000060C C3                  <1> 	retn
   952                              <1> uLVI0:
   953                              <1>         ; not at the end of the file yet.
   954 0000060D FEC8                <1> 	dec	al
   955 0000060F 241F                <1> 	and	al, 1Fh
   956                              <1> uLVI1:
   957                              <1> 	;call	setLastValidIndex
   958                              <1> ;uLVI2:
   959                              <1> 	;retn
   960                              <1> 
   961                              <1> ;%endif
   962                              <1> 	
   963                              <1> ;input AL = index # to stop on
   964                              <1> setLastValidIndex:
   965                              <1> 	; 08/11/2023
   966                              <1> 	;push	dx
   967 00000611 8B16[160A]          <1> 	mov	dx, [NABMBAR]
   968 00000615 83C215              <1> 	add	dx, PO_LVI_REG
   969 00000618 EE                  <1>         out     dx, al
   970                              <1> 	;pop	dx
   971 00000619 C3                  <1> 	retn
   972                              <1> 
   973                              <1> ; 06/11/2023
   974                              <1> ;	; 05/11/2023
   975                              <1> ;setCurrentIndex:
   976                              <1> ;	;push	dx
   977                              <1> ;	mov	dx, [NABMBAR]
   978                              <1> ;	add	dx, PO_CIV_REG
   979                              <1> ;	out	dx, al
   980                              <1> ;	;pop	dx
   981                              <1> ;	retn
   982                              <1> 
   983                              <1> ; checks if either shift key has been pressed. Exits with CY if so.
   984                              <1> ; 
   985                              <1> check4keyboardstop:
   986                              <1> 
   987                              <1> ; 06/11/2023
   988                              <1> %if 1
   989                              <1> 	; 08/11/2023
   990                              <1> 	; 04/11/2023
   991 0000061A B401                <1> 	mov	ah, 1
   992 0000061C CD16                <1> 	int	16h
   993 0000061E 7405                <1> 	jz	short _cksr
   994 00000620 30E4                <1> 	xor	ah, ah
   995 00000622 CD16                <1> 	int	16h
   996 00000624 F9                  <1> 	stc
   997                              <1> _cksr:
   998 00000625 C3                  <1> 	retn
   999                              <1> %endif
  1000                              <1> 
  1001                              <1> ; 06/11/2023
  1002                              <1> ; 04/11/2023
  1003                              <1> %if 0	
  1004                              <1>         push    ds
  1005                              <1>         push    0
  1006                              <1>         pop     ds		       ; examine BDA for keyboard flags
  1007                              <1>         test    byte [417h], (BIT0 | BIT1)
  1008                              <1>         pop     ds
  1009                              <1>         stc
  1010                              <1>         jnz	short _cksr ; 07/11/2023
  1011                              <1> 	;jz	short _cksr ; 06/11/2023
  1012                              <1>         clc
  1013                              <1> _cksr:
  1014                              <1>         retn
  1015                              <1> %endif
   446                                  
   447                                  ; UTILS.ASM
   448                                  ;----------------------------------------------------------------------------
   449                                  ;       delay1_4ms - Delay for 1/4 millisecond.
   450                                  ;		    1mS = 1000us
   451                                  ;       Entry:
   452                                  ;         None
   453                                  ;       Exit:
   454                                  ;	  None
   455                                  ;
   456                                  ;       Modified:
   457                                  ;         None
   458                                  ;
   459                                  PORTB			EQU	061h
   460                                    REFRESH_STATUS	EQU	010h		; Refresh signal status
   461                                  
   462                                  delay1_4ms:
   463 00000626 50                              push    ax 
   464 00000627 51                              push    cx
   465 00000628 B91000                          mov     cx, 16			; close enough.
   466 0000062B E461                    	in	al,PORTB
   467 0000062D 2410                    	and	al,REFRESH_STATUS
   468 0000062F 88C4                    	mov	ah,al			; Start toggle state
   469 00000631 09C9                    	or	cx, cx
   470 00000633 7401                    	jz	short _d4ms1
   471 00000635 41                      	inc	cx			; Throwaway first toggle
   472                                  _d4ms1:	
   473 00000636 E461                    	in	al,PORTB		; Read system control port
   474 00000638 2410                    	and	al,REFRESH_STATUS	; Refresh toggles 15.085 microseconds
   475 0000063A 38C4                    	cmp	ah,al
   476 0000063C 74F8                    	je	short _d4ms1		; Wait for state change
   477                                  
   478 0000063E 88C4                    	mov	ah,al			; Update with new state
   479 00000640 49                      	dec	cx
   480 00000641 75F3                    	jnz	short _d4ms1
   481                                  
   482 00000643 59                              pop     cx
   483 00000644 58                              pop     ax
   484 00000645 C3                              retn
   485                                  
   486                                  	; 13/11/2016 - Erdogan Tan
   487                                  write_ac97_dev_info:
   488                                  	; BUS/DEV/FN
   489                                  	;	00000000BBBBBBBBDDDDDFFF00000000
   490                                  	; DEV/VENDOR
   491                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
   492                                  
   493 00000646 30FF                    	xor	bh, bh
   494 00000648 668B36[220A]            	mov	esi, [dev_vendor]
   495 0000064D 89F0                    	mov	ax, si
   496 0000064F 88C3                    	mov	bl, al
   497 00000651 88DA                    	mov	dl, bl
   498 00000653 80E30F                  	and	bl, 0Fh
   499 00000656 8A87[A308]              	mov	al, [bx+hex_chars]
   500 0000065A A2[E608]                	mov	[msgVendorId+3], al
   501 0000065D 88D3                    	mov	bl, dl
   502 0000065F C0EB04                  	shr	bl, 4
   503 00000662 8A87[A308]              	mov	al, [bx+hex_chars]
   504 00000666 A2[E508]                	mov	[msgVendorId+2], al
   505 00000669 88E3                    	mov	bl, ah
   506 0000066B 88DA                    	mov	dl, bl
   507 0000066D 80E30F                  	and	bl, 0Fh
   508 00000670 8A87[A308]              	mov	al, [bx+hex_chars]
   509 00000674 A2[E408]                	mov	[msgVendorId+1], al
   510 00000677 88D3                    	mov	bl, dl
   511 00000679 C0EB04                  	shr	bl, 4
   512 0000067C 8A87[A308]              	mov	al, [bx+hex_chars]
   513 00000680 A2[E308]                	mov	[msgVendorId], al
   514 00000683 66C1EE10                	shr	esi, 16
   515 00000687 89F0                    	mov	ax, si
   516 00000689 88C3                    	mov	bl, al
   517 0000068B 88DA                    	mov	dl, bl
   518 0000068D 80E30F                  	and	bl, 0Fh
   519 00000690 8A87[A308]              	mov	al, [bx+hex_chars]
   520 00000694 A2[F708]                	mov	[msgDevId+3], al
   521 00000697 88D3                    	mov	bl, dl
   522 00000699 C0EB04                  	shr	bl, 4
   523 0000069C 8A87[A308]              	mov	al, [bx+hex_chars]
   524 000006A0 A2[F608]                	mov	[msgDevId+2], al
   525 000006A3 88E3                    	mov	bl, ah
   526 000006A5 88DA                    	mov	dl, bl
   527 000006A7 80E30F                  	and	bl, 0Fh
   528 000006AA 8A87[A308]              	mov	al, [bx+hex_chars]
   529 000006AE A2[F508]                	mov	[msgDevId+1], al
   530 000006B1 88D3                    	mov	bl, dl
   531 000006B3 C0EB04                  	shr	bl, 4
   532 000006B6 8A87[A308]              	mov	al, [bx+hex_chars]
   533 000006BA A2[F408]                	mov	[msgDevId], al
   534                                  
   535 000006BD 668B36[1E0A]            	mov	esi, [bus_dev_fn]
   536 000006C2 66C1EE08                	shr	esi, 8
   537 000006C6 89F0                    	mov	ax, si
   538 000006C8 88C3                    	mov	bl, al
   539 000006CA 88DA                    	mov	dl, bl
   540 000006CC 80E307                  	and	bl, 7 ; bit 0,1,2
   541 000006CF 8A87[A308]              	mov	al, [bx+hex_chars]
   542 000006D3 A2[1B09]                	mov	[msgFncNo+1], al
   543 000006D6 88D3                    	mov	bl, dl
   544 000006D8 C0EB03                  	shr	bl, 3
   545 000006DB 88DA                    	mov	dl, bl
   546 000006DD 80E30F                  	and	bl, 0Fh
   547 000006E0 8A87[A308]              	mov	al, [bx+hex_chars]
   548 000006E4 A2[0D09]                	mov	[msgDevNo+1], al
   549 000006E7 88D3                    	mov	bl, dl
   550 000006E9 C0EB04                  	shr	bl, 4
   551 000006EC 8A87[A308]              	mov	al, [bx+hex_chars]
   552 000006F0 A2[0C09]                	mov	[msgDevNo], al
   553 000006F3 88E3                    	mov	bl, ah
   554 000006F5 88DA                    	mov	dl, bl
   555 000006F7 80E30F                  	and	bl, 0Fh
   556 000006FA 8A87[A308]              	mov	al, [bx+hex_chars]
   557 000006FE A2[0109]                	mov	[msgBusNo+1], al
   558 00000701 88D3                    	mov	bl, dl
   559 00000703 C0EB04                  	shr	bl, 4
   560 00000706 8A87[A308]              	mov	al, [bx+hex_chars]
   561 0000070A A2[0009]                	mov	[msgBusNo], al
   562                                  
   563 0000070D A1[140A]                	mov	ax, [NAMBAR]
   564 00000710 88C3                    	mov	bl, al
   565 00000712 88DA                    	mov	dl, bl
   566 00000714 80E30F                  	and	bl, 0Fh
   567 00000717 8A87[A308]              	mov	al, [bx+hex_chars]
   568 0000071B A2[2A09]                	mov	[msgNamBar+3], al
   569 0000071E 88D3                    	mov	bl, dl
   570 00000720 C0EB04                  	shr	bl, 4
   571 00000723 8A87[A308]              	mov	al, [bx+hex_chars]
   572 00000727 A2[2909]                	mov	[msgNamBar+2], al
   573 0000072A 88E3                    	mov	bl, ah
   574 0000072C 88DA                    	mov	dl, bl
   575 0000072E 80E30F                  	and	bl, 0Fh
   576 00000731 8A87[A308]              	mov	al, [bx+hex_chars]
   577 00000735 A2[2809]                	mov	[msgNamBar+1], al
   578 00000738 88D3                    	mov	bl, dl
   579 0000073A C0EB04                  	shr	bl, 4
   580 0000073D 8A87[A308]              	mov	al, [bx+hex_chars]
   581 00000741 A2[2709]                	mov	[msgNamBar], al
   582                                  
   583                                  	; 05/11/2023
   584 00000744 A1[160A]                	mov	ax, [NABMBAR]
   585 00000747 88C3                    	mov	bl, al
   586 00000749 88DA                    	mov	dl, bl
   587 0000074B 80E30F                  	and	bl, 0Fh
   588 0000074E 678A83[A3080000]        	mov	al, [ebx+hex_chars]
   589 00000755 A2[3909]                	mov	[msgNabmBar+3], al
   590 00000758 88D3                    	mov	bl, dl
   591 0000075A C0EB04                  	shr	bl, 4
   592 0000075D 678A83[A3080000]        	mov	al, [ebx+hex_chars]
   593 00000764 A2[3809]                	mov	[msgNabmBar+2], al
   594 00000767 88E3                    	mov	bl, ah
   595 00000769 88DA                    	mov	dl, bl
   596 0000076B 80E30F                  	and	bl, 0Fh
   597 0000076E 678A83[A3080000]        	mov	al, [ebx+hex_chars]
   598 00000775 A2[3709]                	mov	[msgNabmBar+1], al
   599 00000778 88D3                    	mov	bl, dl
   600 0000077A C0EB04                  	shr	bl, 4
   601 0000077D 678A83[A3080000]        	mov	al, [ebx+hex_chars]
   602 00000784 A2[3609]                	mov	[msgNabmBar], al
   603                                  
   604                                  	; 24/11/2016
   605 00000787 30E4                    	xor	ah, ah
   606 00000789 A0[130A]                	mov	al, [ac97_int_ln_reg]
   607 0000078C B10A                    	mov	cl, 10
   608 0000078E F6F1                    	div	cl
   609 00000790 0106[4109]              	add	[msgIRQ], ax
   610 00000794 20C0                    	and	al, al
   611 00000796 7508                    	jnz	short _pmi
   612 00000798 A0[4209]                	mov	al, [msgIRQ+1]
   613 0000079B B420                    	mov	ah, ' '
   614 0000079D A3[4109]                	mov	[msgIRQ], ax
   615                                  _pmi:
   616 000007A0 BA[B408]                        mov	dx, msgAC97Info
   617 000007A3 B409                            mov     ah, 9
   618 000007A5 CD21                            int     21h
   619 000007A7 C3                              retn
   620                                  
   621                                  write_sample_rate:
   622                                  	; ax = sample rate (hertz)
   623                                  
   624 000007A8 31D2                    	xor	dx, dx
   625 000007AA B90A00                  	mov	cx, 10
   626 000007AD F7F1                    	div	cx
   627 000007AF 0016[5709]              	add	[msgHertz+4], dl
   628 000007B3 29D2                    	sub	dx, dx
   629 000007B5 F7F1                    	div	cx
   630 000007B7 0016[5609]              	add	[msgHertz+3], dl
   631 000007BB 29D2                    	sub	dx, dx
   632 000007BD F7F1                    	div	cx
   633 000007BF 0016[5509]              	add	[msgHertz+2], dl
   634 000007C3 29D2                    	sub	dx, dx
   635 000007C5 F7F1                    	div	cx
   636 000007C7 0016[5409]              	add	[msgHertz+1], dl
   637 000007CB 0006[5309]              	add	[msgHertz], al
   638                                  	
   639 000007CF BA[4609]                        mov     dx, msgSampleRate
   640 000007D2 B409                            mov     ah, 9
   641 000007D4 CD21                            int     21h
   642                                  
   643                                  	; 19/11/2016
   644 000007D6 BA[6C09]                	mov	dx, msg16Bits
   645 000007D9 803E[2A0A]10            	cmp	byte [bps], 16
   646 000007DE 7403                    	je	short wsr_1
   647 000007E0 BA[5D09]                	mov	dx, msg8Bits
   648                                  wsr_1:
   649 000007E3 B409                            mov     ah, 9
   650 000007E5 CD21                            int     21h
   651                                  
   652 000007E7 BA[6509]                	mov	dx, msgMono
   653 000007EA 803E[280A]01            	cmp	byte [stmo], 1
   654 000007EF 7403                    	je	short wsr_2
   655 000007F1 BA[7509]                	mov	dx, msgStereo		
   656                                  wsr_2:
   657 000007F4 B409                            mov     ah, 9
   658 000007F6 CD21                            int     21h
   659                                  
   660 000007F8 C3                              retn
   661                                  
   662                                  ;detect_codec:
   663                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   664                                  ;	mov	eax, 7Ch
   665                                  ;	call	codec_read
   666                                  ;       shl     eax, 16
   667                                  ;       mov     [codec_id], eax
   668                                  ;
   669                                  ;	mov	eax, 7Eh
   670                                  ;       call	codec_read
   671                                  ;       or      eax, [codec_id]
   672                                  ;       mov     [codec_chip_id], eax
   673                                  ;       and     eax, 0FFFFFF00h
   674                                  ;
   675                                  ;       mov     edi, codecs
   676                                  ;_dcb:
   677                                  ;       mov     ebx, [di]
   678                                  ;       test    ebx, ebx
   679                                  ;       jz      short _dco_unknown
   680                                  ;
   681                                  ;       cmp     eax, ebx
   682                                  ;       jne     short _dco_next
   683                                  ;       mov     ax, [di+4]
   684                                  ;       mov     [codec_vendor_ids], ax
   685                                  ;       movzx   esi, ax
   686                                  ;       call	print_msg
   687                                  ;       
   688                                  ;	mov	ax, [di+6]
   689                                  ;	call	detect_chip
   690                                  ;       retn
   691                                  ;
   692                                  ;_dco_next:
   693                                  ;       add     di, 8
   694                                  ;       jmp     short _dcb
   695                                  ;
   696                                  ;_dco_unknown:
   697                                  ;       mov    word [codec_vendor_ids], ac_unknown
   698                                  ;       mov    word [codec_chip_ids], chip_unknown
   699                                  ;       mov     esi, chip_unknown
   700                                  ;	call	print_msg
   701                                  ;       mov     eax, [codec_chip_id]
   702                                  ;       call    dword2str
   703                                  ;       call	print_msg
   704                                  ;       retn
   705                                  
   706                                  ;detect_chip:
   707                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   708                                  ;	mov	di, ax ; chip_tab
   709                                  ;       mov     eax, [codec_chip_id]
   710                                  ;       and     ax, 0FFh
   711                                  ;_dch1:
   712                                  ;       mov     bx, [di]
   713                                  ;       cmp     bx, 0FFh
   714                                  ;       je      short _dch_unknown
   715                                  ;
   716                                  ;       cmp     ax, bx
   717                                  ;       jne     short _dch_next
   718                                  ;       mov     ax, [di+2]
   719                                  ;       mov     [codec_chip_ids], ax
   720                                  ;       mov     si, ax
   721                                  ;       call	print_msg
   722                                  ;       retn
   723                                  
   724                                  ;_dch_next:
   725                                  ;       add     di, 4
   726                                  ;       jmp     short _dch1
   727                                  ;
   728                                  ;_dch_unknown:
   729                                  ;       mov    word [codec_chip_ids], chip_unknown
   730                                  ;       mov     si, chip_unknown
   731                                  ;       call	print_msg
   732                                  ;       mov     eax, [codec_chip_id]
   733                                  ;       call    dword2str
   734                                  ;       call	print_msg
   735                                  ;       retn
   736                                  
   737                                  ; 06/11/2023
   738                                  %if 0
   739                                  
   740                                  ac97_int_handler:
   741                                  	; 17/02/2016
   742                                  	push	ax
   743                                  	push	dx
   744                                  	; 05/11/2023	
   745                                  	;push	cx
   746                                  	;push	bx
   747                                  	;push	si
   748                                  	;push	di
   749                                  
   750                                  	cmp	byte [inside], 1
   751                                  	jnb	short _busy
   752                                  
   753                                  	mov	byte [inside], 1
   754                                  
   755                                          mov     dx, [NABMBAR]
   756                                          add     dx, PO_SR_REG	; set pointer to Status reg
   757                                  	in	al, dx
   758                                  	mov	[pcm_irq_status], al ; 05/11/2023
   759                                  	test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
   760                                  	jz	short _ih_3
   761                                  
   762                                  	; 28/11/2016 - Erdogan Tan
   763                                  	call	tuneLoop
   764                                  _ih0:
   765                                  	mov	byte [inside], 0
   766                                  _busy:
   767                                  	mov	al, 20h
   768                                  	test	byte [ac97_int_ln_reg], 8
   769                                  	jz	short _ih_1
   770                                  	out 	0A0h, al ; 20h ; EOI
   771                                  _ih_1:
   772                                  	out	20h, al  ; 20h ; EOI
   773                                  _ih_2:
   774                                  	;pop	di
   775                                  	;pop	si
   776                                  	;pop	bx
   777                                  	;pop	cx
   778                                  	pop	dx
   779                                  	pop	ax
   780                                  	iret
   781                                  _ih_3:
   782                                  	; 17/02/2017
   783                                  	out	dx, al ; clear interrupt event (by writing 1 to same bits)
   784                                  	jmp	short _ih0
   785                                  
   786                                  ac97_stop:
   787                                  	; 11/11/2023
   788                                  	; 05/11/2023
   789                                  	; 04/11/2023 
   790                                  	; 28/05/2017 (TRDOS 386 v2, 'audio.s')
   791                                  	mov	byte [tLoop], 0 ; stop ! ; 05/11/2023
   792                                  ;_ac97_stop:
   793                                  	; 11/11/2023
   794                                  	mov	dx, [NAMBAR]
   795                                  	;add	dx, 0 ; ac_reg_0 ; reset register
   796                                  	out	dx, ax
   797                                  
   798                                  	; 04/11/2023
   799                                  	; 09/10/2017 (TRDOS 386 v2, 'audio.s')
   800                                  	; 11/06/2017
   801                                  	xor	al, al ; 0
   802                                  	call	ac97_po_cmd
   803                                  
   804                                  	; (Ref: KolibriOS, intelac97.asm, 'stop:')
   805                                  	; Clear FIFOE, BCIS, LVBCI (Ref: Intel ICH hub manual)
   806                                  	mov     ax, 1Ch
   807                                  	mov     dx, [NABMBAR]
   808                                  	add     dx, PO_SR_REG
   809                                  	out     dx, ax
   810                                  
   811                                  	; 11/06/2017
   812                                  	mov     al, RR
   813                                  ac97_po_cmd:
   814                                  	 ;11/06/2017
   815                                  	; 29/05/2017
   816                                  	mov     dx, [NABMBAR]
   817                                          add     dx, PO_CR_REG		; PCM out control register
   818                                  	out	dx, al
   819                                  	retn
   820                                  
   821                                  %endif
   822                                  
   823                                  print_msg:
   824                                  	; 13/11/2016 - Erdogan Tan 
   825                                  	; esi = ASCIIZ text address
   826                                  	;
   827 000007F9 BB0700                  	mov	bx, 7h
   828 000007FC B40E                    	mov	ah, 0Eh 
   829                                  pm_next_char:
   830 000007FE AC                      	lodsb
   831 000007FF 20C0                    	and	al, al
   832 00000801 7404                    	jz	short pm_retn
   833 00000803 CD10                    	int	10h
   834 00000805 EBF7                    	jmp	short pm_next_char
   835                                  pm_retn:
   836 00000807 C3                      	retn
   837                                  
   838                                  ; 06/11/2023
   839                                  ;dword2str:
   840                                  ;	; 13/11/2016 - Erdogan Tan 
   841                                  ;	; eax = dword value
   842                                  ;	;
   843                                  ;	call	dwordtohex
   844                                  ;	mov	[dword_str], edx
   845                                  ;	mov	[dword_str+4], eax
   846                                  ;	mov	si, dword_str
   847                                  ;	retn
   848                                  
   849                                  	; trdos386.s (unix386.s) - 10/05/2015
   850                                  	; Convert binary number to hexadecimal string
   851                                  
   852                                  bytetohex:
   853                                  	; INPUT ->
   854                                  	; 	AL = byte (binary number)
   855                                  	; OUTPUT ->
   856                                  	;	AX = hexadecimal string
   857                                  	;
   858 00000808 53                      	push	bx
   859 00000809 30FF                    	xor	bh, bh
   860 0000080B 88C3                    	mov	bl, al
   861 0000080D C0EB04                  	shr	bl, 4
   862 00000810 8A9F[A308]              	mov	bl, [bx+hex_chars] 	 	
   863 00000814 86D8                    	xchg	bl, al
   864 00000816 80E30F                  	and	bl, 0Fh
   865 00000819 8AA7[A308]              	mov	ah, [bx+hex_chars] 
   866 0000081D 5B                      	pop	bx	
   867 0000081E C3                      	retn
   868                                  
   869                                  wordtohex:
   870                                  	; INPUT ->
   871                                  	; 	AX = word (binary number)
   872                                  	; OUTPUT ->
   873                                  	;	EAX = hexadecimal string
   874                                  	;
   875 0000081F 53                      	push	bx
   876 00000820 30FF                    	xor	bh, bh
   877 00000822 86E0                    	xchg	ah, al
   878 00000824 50                      	push	ax
   879 00000825 88E3                    	mov	bl, ah
   880 00000827 C0EB04                  	shr	bl, 4
   881 0000082A 8A87[A308]              	mov	al, [bx+hex_chars] 	 	
   882 0000082E 88E3                    	mov	bl, ah
   883 00000830 80E30F                  	and	bl, 0Fh
   884 00000833 8AA7[A308]              	mov	ah, [bx+hex_chars]
   885 00000837 66C1E010                	shl	eax, 16
   886 0000083B 58                      	pop	ax
   887 0000083C 5B                      	pop	bx
   888 0000083D EBC9                    	jmp	short bytetohex
   889                                  
   890                                  ; 06/11/2023
   891                                  ;dwordtohex:
   892                                  ;	; INPUT ->
   893                                  ;	; 	EAX = dword (binary number)
   894                                  ;	; OUTPUT ->
   895                                  ;	;	EDX:EAX = hexadecimal string
   896                                  ;	;
   897                                  ;	push	eax
   898                                  ;	shr	eax, 16
   899                                  ;	call	wordtohex
   900                                  ;	mov	edx, eax
   901                                  ;	pop	eax
   902                                  ;	call	wordtohex
   903                                  ;	retn
   904                                  
   905                                  _DATA:
   906                                  
   907                                  ; 24/11/2016
   908                                  ;	IRQ  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 
   909 0000083F 08090A0B0C0D0E0F70-     irq_int	 db 08h,09h,0Ah,0Bh,0Ch,0Dh,0Eh,0Fh,70h,71h,72h,73h,74h,75h,76h,77h
   909 00000848 71727374757677     
   910                                  
   911                                  ; 17/02/2017
   912                                  ; Valid ICH device IDs
   913                                  
   914                                  valid_ids:
   915 0000084F 86801524                dd	(ICH_DID << 16) + INTEL_VID  	 ; 8086h:2415h 
   916 00000853 86802524                dd	(ICH0_DID << 16) + INTEL_VID 	 ; 8086h:2425h 
   917 00000857 86804524                dd	(ICH2_DID << 16) + INTEL_VID 	 ; 8086h:2445h 
   918 0000085B 86808524                dd	(ICH3_DID << 16) + INTEL_VID 	 ; 8086h:2485h 
   919 0000085F 8680C524                dd	(ICH4_DID << 16) + INTEL_VID 	 ; 8086h:24C5h
   920 00000863 8680D524                dd	(ICH5_DID << 16) + INTEL_VID 	 ; 8086h:24D5h
   921 00000867 86806E26                dd	(ICH6_DID << 16) + INTEL_VID 	 ; 8086h:266Eh
   922 0000086B 8680A625                dd	(ESB6300_DID << 16) + INTEL_VID  ; 8086h:25A6h
   923 0000086F 86809826                dd	(ESB631X_DID << 16) + INTEL_VID  ; 8086h:2698h
   924 00000873 8680DE27                dd	(ICH7_DID << 16) + INTEL_VID 	 ; 8086h:27DEh
   925                                  ; 03/11/2023 - Erdogan Tan
   926 00000877 86809571                dd	(MX82440_DID << 16) + INTEL_VID  ; 8086h:7195h
   927 0000087B 39101270                dd	(SI7012_DID << 16)  + SIS_VID	 ; 1039h:7012h
   928 0000087F DE10B101                dd 	(NFORCE_DID << 16)  + NVIDIA_VID ; 10DEh:01B1h
   929 00000883 DE106A00                dd 	(NFORCE2_DID << 16) + NVIDIA_VID ; 10DEh:006Ah
   930 00000887 22106D74                dd 	(AMD8111_DID << 16) + AMD_VID 	 ; 1022h:746Dh
   931 0000088B 22104574                dd 	(AMD768_DID << 16)  + AMD_VID 	 ; 1022h:7445h
   932 0000088F DE105900                dd 	(CK804_DID << 16) + NVIDIA_VID	 ; 10DEh:0059h
   933 00000893 DE103A00                dd 	(MCP04_DID << 16) + NVIDIA_VID	 ; 10DEh:003Ah
   934 00000897 DE108A00                dd 	(CK8_DID << 16) + NVIDIA_VID	 ; 1022h:008Ah
   935 0000089B DE10DA00                dd 	(NFORCE3_DID << 16) + NVIDIA_VID ; 10DEh:00DAh
   936 0000089F DE10EA00                dd 	(CK8S_DID << 16) + NVIDIA_VID	 ; 10DEh:00EAh
   937                                  
   938                                  valid_id_count:	equ ($ - valid_ids)>>2 ; 05/11/2023
   939                                  
   940                                  ; 13/11/2016
   941 000008A3 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
   941 000008AC 3941424344454600   
   942 000008B4 414339372041756469-     msgAC97Info	db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
   942 000008BD 6F20436F6E74726F6C-
   942 000008C6 6C6572202620436F64-
   942 000008CF 656320496E666F0D0A 
   943 000008D8 56656E646F72204944-     		db "Vendor ID: "
   943 000008E1 3A20               
   944 000008E3 303030306820446576-     msgVendorId	db "0000h Device ID: "
   944 000008EC 6963652049443A20   
   945 000008F4 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
   946 000008FB 4275733A20              		db "Bus: "
   947 00000900 303068204465766963-     msgBusNo	db "00h Device: "
   947 00000909 653A20             
   948 0000090C 3030682046756E6374-     msgDevNo	db "00h Function: "
   948 00000915 696F6E3A20         
   949 0000091A 303068                  msgFncNo	db "00h"
   950 0000091D 0D0A                    		db 0Dh, 0Ah
   951                                  ; 05/11/2023	
   952 0000091F 4E414D4241523A20        		db "NAMBAR: "
   953 00000927 303030306820            msgNamBar	db "0000h "
   954 0000092D 4E41424D4241523A20      		db "NABMBAR: "
   955 00000936 303030306820495251-     msgNabmBar	db "0000h IRQ: "
   955 0000093F 3A20               
   956 00000941 3030                    msgIRQ		dw 3030h
   957 00000943 0D0A24                  		db 0Dh, 0Ah, "$"
   958 00000946 53616D706C65205261-     msgSampleRate	db "Sample Rate: "
   958 0000094F 74653A20           
   959 00000953 303030303020487A20-     msgHertz	db "00000 Hz ", "$" 
   959 0000095C 24                 
   960 0000095D 3820626974732024        msg8Bits	db "8 bits ", "$" 
   961 00000965 4D6F6E6F0D0A24          msgMono		db "Mono", 0Dh, 0Ah, "$"
   962 0000096C 313620626974732024      msg16Bits	db "16 bits ", "$" 
   963 00000975 53746572656F0D0A24      msgStereo	db "Stereo", 0Dh, 0Ah, "$"
   964                                  
   965                                  ;; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   966                                  ;codec_id	dd 0
   967                                  ;codec_chip_id	dd 0
   968                                  ;codec_vendor_ids dw 0
   969                                  ;codec_chip_ids	dw 0
   970                                  
   971 0000097E 3030303030303030        dword_str	 dd 30303030h, 30303030h
   972 00000986 680D0A00                		 db 'h', 0Dh, 0Ah, 0
   973                                  
   974                                  ;ac_unknown     db 'unknown manufacturer',13,10,0
   975                                  ;ac_Realtek     db 'Realtek Semiconductor',13,10,0
   976                                  ;ac_Analog      db 'Analog Devices',13,10,0
   977                                  ;ac_CMedia      db 'C-Media Electronics',13,10,0
   978                                  ;ac_Cirrus      db 'Cirrus Logic',13,10,0
   979                                  ;ac_Wolfson     db 'Wolfson Microelectronics',13,10,0
   980                                  ;ac_VIA         db 'VIA Technologies',13,10,0
   981                                  ;ac_SigmaTel    db 'SigmaTel',13,10,0
   982                                  ;ac_eMicro      db 'eMicro',13,10,0
   983                                  ;
   984                                  ;chip_unknown   db 'unknown codec id ', 0
   985                                  
   986                                  ;CHIP_REALTEK   equ 414C4700h
   987                                  ;CHIP_CMEDIA    equ 434D4900h
   988                                  ;CHIP_VIA       equ 56494100h
   989                                  
   990                                  ;codecs        dd CHIP_CMEDIA
   991                                  ;	       dw ac_CMedia, chips_CMedia
   992                                  ;              dd CHIP_REALTEK
   993                                  ;	       dw ac_Realtek, chips_Realtek
   994                                  ;              dd CHIP_VIA
   995                                  ;	       dw ac_VIA, chips_VIA
   996                                  ;              dd 0
   997                                  
   998                                  ;chips_Realtek dw 10h, chip_ALC201a
   999                                  ;              dw 20h, chip_ALC650
  1000                                  ;              dw 21h, chip_ALC650D
  1001                                  ;              dw 22h, chip_ALC650E
  1002                                  ;              dw 23h, chip_ALC650F
  1003                                  ;              dw 60h, chip_ALC655
  1004                                  ;              dw 80h, chip_ALC658
  1005                                  ;              dw 81h, chip_ALC658D
  1006                                  ;              dw 90h, chip_ALC850
  1007                                  ;              dw 0FFh
  1008                                  
  1009                                  ;chips_CMedia  dw 41h, chip_CM9738
  1010                                  ;              dw 61h, chip_CM9739
  1011                                  ;              dw 69h, chip_CM9780
  1012                                  ;              dw 78h, chip_CM9761
  1013                                  ;              dw 82h, chip_CM9761
  1014                                  ;              dw 83h, chip_CM9761
  1015                                  ;              dw 0FFh
  1016                                  
  1017                                  ;chips_VIA     dw 61h, chip_VIA1612A
  1018                                  ;              dw 0FFh
  1019                                  
  1020                                  ;Realtek
  1021                                  ;chip_ALC201a    db 'ALC201a',0dh,0ah,00h
  1022                                  ;chip_ALC650     db 'ALC650 ',0dh,0ah,00h
  1023                                  ;chip_ALC650D    db 'ALC650D',0dh,0ah,00h
  1024                                  ;chip_ALC650E    db 'ALC650E',0dh,0ah,00h
  1025                                  ;chip_ALC650F    db 'ALC650F',0dh,0ah,00h
  1026                                  ;chip_ALC655     db 'ALC655 ',0dh,0ah,00h
  1027                                  ;chip_ALC658     db 'ALC658 ',0dh,0ah,00h
  1028                                  ;chip_ALC658D    db 'ALC658D',0dh,0ah,00h
  1029                                  ;chip_ALC850     db 'ALC850 ',0dh,0ah,00h
  1030                                  
  1031                                  ;CMedia
  1032                                  ;chip_CM9738     db 'CMI9738', 0dh,0ah,0
  1033                                  ;chip_CM9739     db 'CMI9739', 0dh,0ah,0
  1034                                  ;chip_CM9780     db 'CMI9780', 0dh,0ah,0
  1035                                  ;chip_CM9761     db 'CMI9761', 0dh,0ah,0
  1036                                  
  1037                                  ;VIA
  1038                                  ;chip_VIA1612A   db 'VIA1612A',13,10,0
  1039                                  
  1040                                  ; 11/11/2023
  1041                                  msg_init_err:
  1042 0000098A 0D0A                    	db	CR, LF
  1043 0000098C 4143393720436F6E74-     	db	"AC97 Controller/Codec initialization error !"
  1043 00000995 726F6C6C65722F436F-
  1043 0000099E 64656320696E697469-
  1043 000009A7 616C697A6174696F6E-
  1043 000009B0 206572726F722021   
  1044 000009B8 0D0A24                  	db	CR, LF, "$"
  1045                                  
  1046                                  ; 12/11/2023
  1047                                  msg_no_vra:
  1048 000009BB 0D0A                    	db	CR, LF
  1049 000009BD 4E6F20565241207375-     	db	"No VRA support ! Only 48 kHZ sample rate supported !"
  1049 000009C6 70706F72742021204F-
  1049 000009CF 6E6C79203438206B48-
  1049 000009D8 5A2073616D706C6520-
  1049 000009E1 726174652073757070-
  1049 000009EA 6F727465642021     
  1050 000009F1 0D0A24                  	db	CR, LF, "$"
  1051                                  
  1052                                  ; 17/02/2017
  1053                                  bss_start:
  1054                                  
  1055                                  ABSOLUTE bss_start
  1056                                  
  1057                                  alignb 2
  1058                                  
  1059                                  ; 28/11/2016
  1060                                  
  1061 000009F4 <res 1Ch>               smpRBuff:	resw 14 ; 19/11/2016 - Erdogan Tan
  1062                                  
  1063 00000A10 ????                    filehandle:	resw 1
  1064                                  
  1065 00000A12 ??                      flags:		resb 1
  1066                                  ; 06/11/2023
  1067 00000A13 ??                      ac97_int_ln_reg: resb 1
  1068                                  
  1069                                  ; 06/11/2023
  1070                                  ;pcm_irq_status: resb 1	; 05/11/2023
  1071                                  ;
  1072                                  ;inside:	resb 1
  1073                                  ;tLoop:		resb 1
  1074                                  
  1075                                  ; 06/11/2023
  1076                                  ; 05/11/2023
  1077                                  ; 04/11/2023
  1078                                  ;IRQ_status:	resw 1	; IRQ status before enabling audio interrupt
  1079                                  ;IRQ_vector:	resd 1  ; Previous interrupt handler address	
  1080                                  
  1081                                  ; 17/02/2017
  1082                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  1083                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  1084                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  1085                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  1086 00000A14 ????                    NAMBAR:		resw 1			; BAR for mixer
  1087 00000A16 ????                    NABMBAR:	resw 1			; BAR for bus master regs
  1088                                  
  1089                                  ; 256 byte buffer for descriptor list
  1090 00000A18 ????                    BDL_BUFFER:	resw 1			; segment of our 256byte BDL buffer
  1091 00000A1A ????                    WAV_BUFFER1:	resw 1			; segment of our WAV storage
  1092                                  ; 64k buffers for wav file storage
  1093 00000A1C ????                    WAV_BUFFER2:	resw 1			; segment of 2nd wav buffer
  1094                                  
  1095                                  ; 06/11/2023
  1096                                  ;tBuff:		resb 1
  1097                                  ;ac97_int_ln_reg: resb 1
  1098                                  
  1099                                  ; 12/11/2016 - Erdogan Tan
  1100                                  
  1101 00000A1E ????????                bus_dev_fn:	resd 1
  1102 00000A22 ????????                dev_vendor:	resd 1
  1103                                  ; 06/11/2023
  1104                                  ;stats_cmd:	resw 1 ; 17/02/2017
  1105                                  ; 05/11/2023
  1106                                  ;ac97_io_base:	resw 1
  1107 00000A26 ????                    sample_rate:	resw 1
  1108                                  
  1109                                  ; 19/11/2016
  1110 00000A28 ????                    stmo:		resw 1 
  1111 00000A2A ????                    bps:		resw 1
  1112                                  
  1113                                  ; 08/11/2023
  1114                                  ; 07/11/2023
  1115 00000A2C ??                      fbs_shift:	resb 1
  1116 00000A2D ??                      		resb 1 ; 08/11/2023
  1117                                  
  1118                                  ;fbs_seg:	resw 1
  1119                                  ;fbs_off:	resw 1
  1120                                  
  1121                                  ;alignb 2
  1122                                  
  1123                                  ; 32 kilo bytes for temporay buffer
  1124                                  ; (for stereo-mono, 8bit/16bit corrections)
  1125 00000A2E <res 8000h>             temp_buffer:	resb 32768
  1126                                  
  1127                                  ;alignb 16
  1128                                  EOF:
