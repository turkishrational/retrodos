     1                                  ; ****************************************************************************
     2                                  ; PLAYWAV.ASM - ICH AC97 .wav player for DOS.			   PLAYWAV.COM
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; Last Update: 19/05/2024 (Previous: 08/05/2024)
     5                                  ; ----------------------------------------------------------------------------
     6                                  ; Beginning: 17/02/2017
     7                                  ; ----------------------------------------------------------------------------
     8                                  ; Assembler: NASM version 2.15
     9                                  ;	     nasm playwav.asm -l playwav.lst -o PLAYWAV.COM	
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Derived from '.wav file player for DOS' Jeff Leyda, Sep 02, 2002 
    12                                  ; ****************************************************************************
    13                                  ; Modidified from 'PLAYER.COM' for VIA VT8233 wav player source code by
    14                                  ; (PLAYER.ASM) by Erdogan Tan (07/11/2016 - 08/12/2016)
    15                                  
    16                                  ; AC97 interrupt version - 09/11/2023 - Erdogan Tan
    17                                  ; sample rate conversion version - 13/11/2023 - Erdogan Tan
    18                                  ; LVI interrupt version (instead of IOC) - 18/11/2023 - Erdogan Tan
    19                                  
    20                                  [BITS 16]
    21                                  
    22                                  [ORG 100h] 
    23                                  
    24                                  	%include 'ac97.inc' ; 17/02/2017
     1                              <1> ; 11/11/2023
     2                              <1> ; 05/11/2023
     3                              <1> ; 03/11/2023
     4                              <1> ; 17/02/2017 (Erdogan Tan, PLAYWAV.ASM)
     5                              <1> ; constant.inc & codec.inc (for ICH AC97 wav player, 'PLAYWAV.COM') 
     6                              <1> 
     7                              <1> ; ----------------------------------------------------------------------------
     8                              <1> ; CONSTANT.INC
     9                              <1> ; ----------------------------------------------------------------------------
    10                              <1> 
    11                              <1> ;constants of stuff that seem hard to remember at times.
    12                              <1> 
    13                              <1> TRUE  EQU 1
    14                              <1> FALSE EQU 0
    15                              <1> 
    16                              <1> ENABLED  EQU 1
    17                              <1> DISABLED EQU 0
    18                              <1> 
    19                              <1> BIT0  EQU 1
    20                              <1> BIT1  EQU 2
    21                              <1> BIT2  EQU 4
    22                              <1> BIT3  EQU 8
    23                              <1> BIT4  EQU 10h
    24                              <1> BIT5  EQU 20h
    25                              <1> BIT6  EQU 40h
    26                              <1> BIT7  EQU 80h
    27                              <1> BIT8  EQU 100h
    28                              <1> BIT9  EQU 200h
    29                              <1> BIT10 EQU 400h
    30                              <1> BIT11 EQU 800h
    31                              <1> BIT12 EQU 1000h
    32                              <1> BIT13 EQU 2000h
    33                              <1> BIT14 EQU 4000h
    34                              <1> BIT15 EQU 8000h
    35                              <1> BIT16 EQU 10000h
    36                              <1> BIT17 EQU 20000h
    37                              <1> BIT18 EQU 40000h
    38                              <1> BIT19 EQU 80000h
    39                              <1> BIT20 EQU 100000h
    40                              <1> BIT21 EQU 200000h
    41                              <1> BIT22 EQU 400000h
    42                              <1> BIT23 EQU 800000h
    43                              <1> BIT24 EQU 1000000h
    44                              <1> BIT25 EQU 2000000h
    45                              <1> BIT26 EQU 4000000h
    46                              <1> BIT27 EQU 8000000h
    47                              <1> BIT28 EQU 10000000h
    48                              <1> BIT29 EQU 20000000h
    49                              <1> BIT30 EQU 40000000h
    50                              <1> BIT31 EQU 80000000h
    51                              <1> 
    52                              <1> ;special characters
    53                              <1> NUL     EQU 0
    54                              <1> NULL    EQU 0
    55                              <1> BELL    EQU 07
    56                              <1> BS      EQU 08
    57                              <1> TAB     EQU 09
    58                              <1> LF      EQU 10
    59                              <1> CR      EQU 13
    60                              <1> ESCAPE  EQU 27           ;ESC is a reserved word....
    61                              <1> 
    62                              <1> 
    63                              <1> ;file stuff
    64                              <1> READONLY  EQU   BIT0
    65                              <1> HIDDEN    EQU   BIT1
    66                              <1> SYSTEM    EQU   BIT2
    67                              <1> VOLUME    EQU   BIT3         ;ignored for file access
    68                              <1> DIRECTORY EQU   BIT4         ;must be 0 for file access
    69                              <1> ARCHIVE   EQU   BIT5
    70                              <1> SHAREABLE EQU   BIT7         ;for novell networks
    71                              <1> OPEN	EQU	2		; open existing file
    72                              <1> CREATE	EQU	1		; create new file
    73                              <1> 
    74                              <1> 
    75                              <1> ; PCI equates
    76                              <1> ; PCI function address (PFA)
    77                              <1> ; bit 31 = 1
    78                              <1> ; bit 23:16 = bus number     (0-255)
    79                              <1> ; bit 15:11 = device number  (0-31)
    80                              <1> ; bit 10:8 = function number (0-7)
    81                              <1> ; bit 7:0 = register number  (0-255)
    82                              <1> 
    83                              <1> IO_ADDR_MASK    EQU     0FFFEh          ; mask off bit 0 for reading BARs
    84                              <1> PCI_INDEX_PORT  EQU     0CF8h
    85                              <1> PCI_DATA_PORT   EQU     0CFCh
    86                              <1> PCI32           EQU     BIT31           ; bitflag to signal 32bit access
    87                              <1> PCI16           EQU     BIT30           ; bitflag for 16bit access
    88                              <1> 
    89                              <1> PCI_FN0         EQU     0 << 8
    90                              <1> PCI_FN1         EQU     1 << 8
    91                              <1> PCI_FN2         EQU     2 << 8
    92                              <1> PCI_FN3         EQU     3 << 8
    93                              <1> PCI_FN4         EQU     4 << 8
    94                              <1> PCI_FN5         EQU     5 << 8
    95                              <1> PCI_FN6         EQU     6 << 8
    96                              <1> PCI_FN7         EQU     7 << 8
    97                              <1> 
    98                              <1> PCI_CMD_REG		EQU	04h		; reg 04, command reg
    99                              <1>  IO_ENA			EQU	BIT0		; i/o decode enable
   100                              <1>  MEM_ENA		EQU	BIT1		; memory decode enable
   101                              <1>  BM_ENA                 EQU     BIT2		; bus master enable
   102                              <1> 
   103                              <1> ; ----------------------------------------------------------------------------
   104                              <1> ; CODEC.INC
   105                              <1> ; ----------------------------------------------------------------------------
   106                              <1> 
   107                              <1> ;Codec registers.
   108                              <1> ;
   109                              <1> ;Not all codecs are created equal. Refer to the spec for your specific codec.
   110                              <1> ;
   111                              <1> ;All registers are 16bits wide.  Access to codec registers over the AC97 link
   112                              <1> ;is defined by the OEM.  
   113                              <1> ;
   114                              <1> ;Secondary codec's are accessed by ORing in BIT7 of all register accesses.
   115                              <1> ;
   116                              <1> 
   117                              <1> ; each codec/mixer register is 16bits
   118                              <1> 
   119                              <1> CODEC_RESET_REG                 equ     00      ; reset codec
   120                              <1> CODEC_MASTER_VOL_REG            equ     02      ; master volume
   121                              <1> CODEC_HP_VOL_REG                equ     04      ; headphone volume
   122                              <1> CODEC_MASTER_MONO_VOL_REG       equ     06      ; master mono volume
   123                              <1> CODEC_MASTER_TONE_REG           equ     08      ; master tone (R+L)
   124                              <1> CODEC_PCBEEP_VOL_REG            equ     0ah     ; PC beep volume
   125                              <1> CODEC_PHONE_VOL_REG             equ     0bh     ; phone volume
   126                              <1> CODEC_MIC_VOL_REG               equ     0eh     ; MIC volume
   127                              <1> CODEC_LINE_IN_VOL_REG           equ     10h     ; line input volume
   128                              <1> CODEC_CD_VOL_REG                equ     12h     ; CD volume
   129                              <1> CODEC_VID_VOL_REG               equ     14h     ; video volume
   130                              <1> CODEC_AUX_VOL_REG               equ     16h     ; aux volume
   131                              <1> CODEC_PCM_OUT_REG               equ     18h     ; PCM output volume
   132                              <1> CODEC_RECORD_SELECT_REG         equ     1ah     ; record select input
   133                              <1> CODEC_RECORD_VOL_REG            equ     1ch     ; record volume
   134                              <1> CODEC_RECORD_MIC_VOL_REG        equ     1eh     ; record mic volume
   135                              <1> CODEC_GP_REG                    equ     20h     ; general purpose
   136                              <1> CODEC_3D_CONTROL_REG            equ     22h     ; 3D control
   137                              <1> ; 24h is reserved
   138                              <1> CODEC_POWER_CTRL_REG            equ     26h     ; powerdown control
   139                              <1> CODEC_EXT_AUDIO_REG             equ     28h     ; extended audio
   140                              <1> CODEC_EXT_AUDIO_CTRL_REG        equ     2ah     ; extended audio control
   141                              <1> CODEC_PCM_FRONT_DACRATE_REG     equ     2ch     ; PCM out sample rate
   142                              <1> CODEC_PCM_SURND_DACRATE_REG     equ     2eh     ; surround sound sample rate
   143                              <1> CODEC_PCM_LFE_DACRATE_REG       equ     30h     ; LFE sample rate
   144                              <1> CODEC_LR_ADCRATE_REG            equ     32h     ; PCM in sample rate
   145                              <1> CODEC_MIC_ADCRATE_REG           equ     34h     ; mic in sample rate
   146                              <1> 
   147                              <1> ; registers 36-7a are reserved on the ICH
   148                              <1> 
   149                              <1> CODEC_VENDORID1_REG             equ     7ch     ; codec vendor ID 1
   150                              <1> CODEC_VENDORID2_REG             equ     7eh     ; codec vendor ID 2
   151                              <1> 
   152                              <1> ; Mixer registers 0 through 51h reside in the ICH and are not forwarded over
   153                              <1> ; the AC97 link to the codec, which I think is a little weird.  Looks like
   154                              <1> ; the ICH makes it so you don't need a fully functional codec to play audio?
   155                              <1> ;
   156                              <1> ; whenever 2 codecs are present in the system, use BIT7 to access the 2nd
   157                              <1> ; set of registers, ie 80h-feh
   158                              <1> 
   159                              <1> PRIMARY_CODEC                   equ     0       ; 0-7F for primary codec
   160                              <1> SECONDARY_CODEC                 equ     BIT7    ; 80-8f registers for 2ndary
   161                              <1> 
   162                              <1> SAMPLE_RATE_441khz	equ     44100   ; 44.1Khz (cd quality) rate
   163                              <1> 
   164                              <1> ; ----------------------------------------------------------------------------
   165                              <1> ; 17/02/2017
   166                              <1> PCI_IO_BASE	equ 10h			; = NAMBAR register offset
   167                              <1> AC97_INT_LINE   equ 3Ch			; AC97 Interrupt Line register offset
   168                              <1> 
   169                              <1> ; ----------------------------------------------------------------------------
   170                              <1> ; ICH2AC97.INC
   171                              <1> ; ----------------------------------------------------------------------------
   172                              <1> 
   173                              <1> ; PCI stuff
   174                              <1> 
   175                              <1> ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
   176                              <1> 
   177                              <1> INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
   178                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   179                              <1> SIS_VID		equ	1039h
   180                              <1> NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
   181                              <1> AMD_VID		equ	1022h
   182                              <1> 
   183                              <1> ICH_DID         equ     2415h           ; ICH device ID
   184                              <1> ICH0_DID        equ     2425h           ; ICH0
   185                              <1> ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
   186                              <1>                                         ; they all should be compatible.
   187                              <1> 
   188                              <1> ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
   189                              <1> ICH3_DID	equ     2485h           ; ICH3
   190                              <1> ICH4_DID        equ     24C5h           ; ICH4
   191                              <1> ICH5_DID	equ     24D5h           ; ICH5 
   192                              <1> ICH6_DID	equ     266Eh           ; ICH6
   193                              <1> ESB6300_DID	equ     25A6h           ; 6300ESB
   194                              <1> ESB631X_DID	equ     2698h           ; 631XESB
   195                              <1> ICH7_DID	equ	27DEh		; ICH7
   196                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   197                              <1> MX82440_DID	equ	7195h
   198                              <1> SI7012_DID	equ	7012h
   199                              <1> NFORCE_DID	equ	01B1h
   200                              <1> NFORCE2_DID	equ	006Ah
   201                              <1> AMD8111_DID	equ	746Dh
   202                              <1> AMD768_DID	equ	7445h
   203                              <1> ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
   204                              <1> CK804_DID	equ	0059h
   205                              <1> MCP04_DID	equ	003Ah
   206                              <1> CK8_DID		equ	008Ah
   207                              <1> NFORCE3_DID	equ	00DAh
   208                              <1> CK8S_DID	equ	00EAh
   209                              <1> 
   210                              <1> NAMBAR_REG      equ     10h             ; native audio mixer BAR
   211                              <1>  NAM_SIZE       equ     256             ; 256 bytes required.
   212                              <1> 
   213                              <1> NABMBAR_REG     equ     14h             ; native audio bus mastering BAR
   214                              <1>  NABM_SIZE      equ     64              ; 64 bytes
   215                              <1> 
   216                              <1> ; BUS master registers, accessed via NABMBAR+offset
   217                              <1> 
   218                              <1> ; ICH supports 3 different types of register sets for three types of things
   219                              <1> ; it can do, thus:
   220                              <1> ;
   221                              <1> ; PCM in (for recording) aka PI
   222                              <1> ; PCM out (for playback) aka PO
   223                              <1> ; MIC in (for recording) aka MC
   224                              <1> 
   225                              <1> PI_BDBAR_REG            equ     0       ; PCM in buffer descriptor BAR
   226                              <1> PO_BDBAR_REG            equ     10h     ; PCM out buffer descriptor BAR
   227                              <1> MC_BDBAR_REG            equ     20h     ; MIC in buffer descriptor BAR
   228                              <1> 
   229                              <1> ; each buffer descriptor BAR holds a pointer which has entries to the buffer
   230                              <1> ; contents of the .WAV file we're going to play. Each entry is 8 bytes long
   231                              <1> ; (more on that later) and can contain 32 entries total, so each BAR is
   232                              <1> ; 256 bytes in length, thus:
   233                              <1> 
   234                              <1> BDL_SIZE                equ     32*8    ; Buffer Descriptor List size
   235                              <1> INDEX_MASK              equ     31      ; indexes must be 0-31
   236                              <1> 
   237                              <1> 
   238                              <1> 
   239                              <1> PI_CIV_REG              equ     4       ; PCM in current Index value (RO)
   240                              <1> PO_CIV_REG              equ     14h     ; PCM out current Index value (RO)
   241                              <1> MC_CIV_REG              equ     24h     ; MIC in current Index value (RO)
   242                              <1> ;8bit read only
   243                              <1> ; each current index value is simply a pointer showing us which buffer
   244                              <1> ; (0-31) the codec is currently processing. Once this counter hits 31, it
   245                              <1> ; wraps back to 0.
   246                              <1> ; this can be handy to know, as once it hits 31, we're almost out of data to
   247                              <1> ; play back or room to record!
   248                              <1> 
   249                              <1> 
   250                              <1> PI_LVI_REG              equ     5       ; PCM in Last Valid Index
   251                              <1> PO_LVI_REG              equ     15h     ; PCM out Last Valid Index
   252                              <1> MC_LVI_REG              equ     25h     ; MIC in Last Valid Index
   253                              <1> ;8bit read/write
   254                              <1> ; The Last Valid Index is a number (0-31) to let the codec know what buffer
   255                              <1> ; number to stop on after processing. It could be very nasty to play audio
   256                              <1> ; from buffers that aren't filled with the audio we want to play.
   257                              <1> 
   258                              <1> 
   259                              <1> PI_SR_REG               equ     6       ; PCM in Status register
   260                              <1> PO_SR_REG               equ     16h     ; PCM out Status register
   261                              <1> MC_SR_REG               equ     26h     ; MIC in Status register
   262                              <1> ;16bit read/write
   263                              <1> ; status registers.  Bitfields follow:
   264                              <1> 
   265                              <1> FIFO_ERR                equ     BIT4    ; FIFO Over/Underrun W1TC.
   266                              <1> 
   267                              <1> BCIS                    equ     BIT3    ; buffer completion interrupt status.
   268                              <1>                                         ; Set whenever the last sample in ANY
   269                              <1>                                         ; buffer is finished.  Bit is only
   270                              <1>                                         ; set when the Interrupt on Complete
   271                              <1>                                         ; (BIT4 of control reg) is set.
   272                              <1> 
   273                              <1> LVBCI                   equ     BIT2    ; Set whenever the codec has processed
   274                              <1>                                         ; the last buffer in the buffer list.
   275                              <1>                                         ; Will fire an interrupt if IOC bit is
   276                              <1>                                         ; set. Probably set after the last
   277                              <1>                                         ; sample in the last buffer is
   278                              <1>                                         ; processed.  W1TC
   279                              <1> 
   280                              <1>                                         ; 
   281                              <1> CELV                    equ     BIT1    ; Current buffer == last valid.
   282                              <1>                                         ; Bit is RO and remains set until LVI is
   283                              <1>                                         ; cleared.  Probably set up the start
   284                              <1>                                         ; of processing for the last buffer.
   285                              <1> 
   286                              <1> 
   287                              <1> DCH                     equ     BIT0    ; DMA controller halted.
   288                              <1>                                         ; set whenever audio stream is stopped
   289                              <1>                                         ; or something else goes wrong.
   290                              <1> 
   291                              <1> 
   292                              <1> PI_PICB_REG             equ     8       ; PCM in position in current buffer(RO)
   293                              <1> PO_PICB_REG             equ     18h     ; PCM out position in current buffer(RO)
   294                              <1> MC_PICB_REG             equ     28h     ; MIC in position in current buffer (RO)
   295                              <1> ;16bit read only
   296                              <1> ; position in current buffer regs show the number of dwords left to be
   297                              <1> ; processed in the current buffer.
   298                              <1> ; 
   299                              <1> 
   300                              <1> PI_PIV_REG              equ     0ah     ; PCM in Prefected index value
   301                              <1> PO_PIV_REG              equ     1ah     ; PCM out Prefected index value
   302                              <1> MC_PIV_REG              equ     2ah     ; MIC in Prefected index value
   303                              <1> ;8bit, read only
   304                              <1> ; Prefetched index value register.
   305                              <1> ; tells which buffer number (0-31) has be prefetched. I'd imagine this
   306                              <1> ; value follows the current index value fairly closely. (CIV+1)
   307                              <1> ;
   308                              <1> 
   309                              <1> 
   310                              <1> PI_CR_REG               equ     0bh     ; PCM in Control Register
   311                              <1> PO_CR_REG               equ     1bh     ; PCM out Control Register
   312                              <1> MC_CR_REG               equ     2bh     ; MIC in Control Register
   313                              <1> ; 8bit
   314                              <1> ; Control register *MUST* only be accessed as an 8bit value.
   315                              <1> ; Control register. See bitfields below.
   316                              <1> ;
   317                              <1> 
   318                              <1> 
   319                              <1> IOCE                    equ     BIT4    ; interrupt on complete enable.
   320                              <1>                                         ; set this bit if you want an intrtpt
   321                              <1>                                         ; to fire whenever LVBCI is set.
   322                              <1> FEIFE                   equ     BIT3    ; set if you want an interrupt to fire
   323                              <1>                                         ; whenever there is a FIFO (over or
   324                              <1>                                         ; under) error.
   325                              <1> LVBIE                   equ     BIT2    ; last valid buffer interrupt enable.
   326                              <1>                                         ; set if you want an interrupt to fire
   327                              <1>                                         ; whenever the completion of the last
   328                              <1>                                         ; valid buffer.
   329                              <1> RR                      equ     BIT1    ; reset registers.  Nukes all regs
   330                              <1>                                         ; except bits 4:2 of this register.
   331                              <1>                                         ; Only set this bit if BIT 0 is 0
   332                              <1> RPBM                    equ     BIT0    ; Run/Pause
   333                              <1>                                         ; set this bit to start the codec!
   334                              <1> 
   335                              <1> 
   336                              <1> GLOB_CNT_REG            equ     2ch     ; Global control register
   337                              <1> SEC_RES_EN              equ     BIT5    ; secondary codec resume event 
   338                              <1>                                         ; interrupt enable.  Not used here.
   339                              <1> PRI_RES_EN              equ     BIT4    ; ditto for primary. Not used here.
   340                              <1> ACLINK_OFF              equ     BIT3    ; Turn off the AC97 link
   341                              <1> ACWARM_RESET            equ     BIT2    ; Awaken the AC97 link from sleep.
   342                              <1>                                         ; registers preserved, bit self clears
   343                              <1> ACCOLD_RESET            equ     BIT1    ; Reset everything in the AC97 and
   344                              <1>                                         ; reset all registers.  Not self clearing
   345                              <1> 
   346                              <1> GPIIE                   equ     BIT0    ; GPI Interrupt enable.
   347                              <1>                                         ; set if you want an interrupt to
   348                              <1>                                         ; fire upon ANY of the bits in the
   349                              <1>                                         ; GPI (general pursose inputs?) not used.
   350                              <1> 
   351                              <1> GLOB_STS_REG            equ     30h     ; Global Status register (RO)
   352                              <1> 
   353                              <1> MD3                     equ     BIT17   ; modem powerdown status (yawn)
   354                              <1> AD3                     equ     BIT16   ; Audio powerdown status (yawn)
   355                              <1> RD_COMPLETE_STS         equ     BIT15   ; Codec read timed out. 0=normal
   356                              <1> BIT3SLOT12              equ     BIT14   ; shadowed status of bit 3 in slot 12
   357                              <1> BIT2SLOT12              equ     BIT13   ; shadowed status of bit 2 in slot 12
   358                              <1> BIT1SLOT12              equ     BIT12   ; shadowed status of bit 1 in slot 12
   359                              <1> SEC_RESUME_STS          equ     BIT11   ; secondary codec has resumed (and irqed)
   360                              <1> PRI_RESUME_STS          equ     BIT10   ; primary codec has resumed (and irqed)
   361                              <1> SEC_CODEC_RDY           equ     BIT9    ; secondary codec is ready for action
   362                              <1> PRI_CODEC_RDY           equ     BIT8    ; Primary codec is ready for action
   363                              <1>                                         ; software must check these bits before
   364                              <1>                                         ; starting the codec!
   365                              <1> MIC_IN_IRQ              equ     BIT7    ; MIC in caused an interrupt
   366                              <1> PCM_OUT_IRQ             equ     BIT6    ; One of the PCM out channels IRQed
   367                              <1> PCM_IN_IRQ              equ     BIT5    ; One of the PCM in channels IRQed
   368                              <1> MODEM_OUT_IRQ           equ     BIT2    ; modem out channel IRQed
   369                              <1> MODEM_IN_IRQ            equ     BIT1    ; modem in channel IRQed
   370                              <1> GPI_STS_CHANGE          equ     BIT0    ; set whenever GPI's have changed.
   371                              <1>                                         ; BIT0 of slot 12 also reflects this.
   372                              <1> 
   373                              <1> ACC_SEMA_REG            equ     34h     ; Codec write semiphore register
   374                              <1> CODEC_BUSY              equ     BIT0    ; codec register I/O is happening
   375                              <1>                                         ; self clearing
   376                              <1> ;
   377                              <1> ; Buffer Descriptors List
   378                              <1> ; As stated earlier, each buffer descriptor list is a set of (up to) 32 
   379                              <1> ; descriptors, each 8 bytes in length. Bytes 0-3 of a descriptor entry point
   380                              <1> ; to a chunk of memory to either play from or record to. Bytes 4-7 of an
   381                              <1> ; entry describe various control things detailed below.
   382                              <1> ; 
   383                              <1> ; Buffer pointers must always be aligned on a Dword boundry.
   384                              <1> ;
   385                              <1> 
   386                              <1> IOC                     equ     BIT31   ; Fire an interrupt whenever this
   387                              <1>                                         ; buffer is complete.
   388                              <1> 
   389                              <1> BUP                     equ     BIT30   ; Buffer Underrun Policy.
   390                              <1>                                         ; if this buffer is the last buffer
   391                              <1>                                         ; in a playback, fill the remaining
   392                              <1>                                         ; samples with 0 (silence) or not.
   393                              <1>                                         ; It's a good idea to set this to 1
   394                              <1>                                         ; for the last buffer in playback,
   395                              <1>                                         ; otherwise you're likely to get a lot
   396                              <1>                                         ; of noise at the end of the sound.
   397                              <1> 
   398                              <1> ;
   399                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   400                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   401                              <1> ; Luckily for us, that's the same format as .wav files.
   402                              <1> ;
   403                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   404                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   405                              <1> ;
   406                              <1> ; A value of 0 in these bits means play no samples.
   407                              <1> ;
   408                              <1> 
   409                              <1> ; 11/11/2023
   410                              <1> CTRL_ST_CREADY		equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
   411                              <1> CODEC_REG_POWERDOWN	equ	26h
    25                                  
    26                                  _STARTUP:
    27                                  
    28                                  ; memory allocation
    29                                  
    30 00000000 E85401                          call    setFree				; deallocate unused DOS mem
    31                                  
    32                                  	; 17/02/2017
    33                                  	; Clear BSS (uninitialized data) area
    34 00000003 31C0                    	xor	ax, ax ; 0
    35 00000005 B91A6E                  	mov	cx, (EOF - bss_start)/2
    36 00000008 BF[DB1D]                	mov	di, bss_start
    37 0000000B F3AB                    	rep	stosw
    38                                  
    39                                  ; allocate 256 bytes of data for DCM_OUT Buffer Descriptor List. (BDL)
    40                                  
    41 0000000D B81000                          mov     ax, BDL_SIZE / 16
    42 00000010 E84C01                          call    memAlloc
    43 00000013 A3[081E]                        mov     [BDL_BUFFER], ax		; segment
    44                                  
    45                                  ; allocate 2 buffers, 64k each for now.
    46                                  
    47 00000016 B80010                          mov     ax, BUFFERSIZE / 16		; 64k for .WAV file
    48 00000019 E84301                          call    memAlloc
    49 0000001C A3[0A1E]                        mov     [WAV_BUFFER1], ax		; segment
    50                                  
    51 0000001F B80010                  	mov	ax, BUFFERSIZE / 16
    52 00000022 E83A01                  	call	memAlloc
    53 00000025 A3[0C1E]                	mov	[WAV_BUFFER2], ax
    54                                  
    55                                  ; Detect/reset AC97 
    56                                  
    57 00000028 E8A702                          call    pciFindDevice
    58 0000002B 7342                            jnc     short _1
    59                                  
    60                                  ; couldn't find the audio device!
    61                                  
    62 0000002D 0E                      	push	cs
    63 0000002E 1F                      	pop	ds
    64 0000002F BA[3900]                        mov     dx, noDevMsg
    65 00000032 B409                            mov     ah, 9
    66 00000034 CD21                            int     21h
    67 00000036 E90E01                          jmp     exit
    68                                  
    69                                  ; 17/02/2017
    70 00000039 4572726F723A20556E-     noDevMsg: db "Error: Unable to find intel ICH based audio device!",CR,LF,"$"
    70 00000042 61626C6520746F2066-
    70 0000004B 696E6420696E74656C-
    70 00000054 204943482062617365-
    70 0000005D 6420617564696F2064-
    70 00000066 6576696365210D0A24 
    71                                  
    72                                  _1:
    73                                  	; eax = BUS/DEV/FN
    74                                  	;	00000000BBBBBBBBDDDDDFFF00000000
    75                                  	; edx = DEV/VENDOR
    76                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
    77                                  
    78 0000006F 66A3[0E1E]              	mov	[bus_dev_fn], eax
    79 00000073 668916[121E]            	mov	[dev_vendor], edx
    80                                  
    81                                  	; get ICH base address regs for mixer and bus master
    82                                  
    83 00000078 B010                            mov     al, NAMBAR_REG
    84 0000007A E8C701                          call    pciRegRead16			; read PCI registers 10-11
    85                                          ;and    dx, IO_ADDR_MASK 		; mask off BIT0
    86                                  	; 19/05/2024
    87 0000007D 80E2FE                  	and	dl, 0FEh
    88                                  
    89 00000080 8916[041E]                      mov     [NAMBAR], dx			; save audio mixer base addr
    90                                  
    91 00000084 B014                    	mov     al, NABMBAR_REG
    92 00000086 E8BB01                          call    pciRegRead16
    93                                          ;and    dx, IO_ADDR_MASK
    94                                  	; 19/05/2024
    95 00000089 80E2C0                  	and	dl, 0C0h
    96                                  
    97 0000008C 8916[061E]                      mov     [NABMBAR], dx			; save bus master base addr
    98                                  
    99                                  	; 06/11/2023
   100                                  	;; init controller
   101                                  	;; 17/02/2017
   102                                  	;mov	al, PCI_CMD_REG ; command register (04h)
   103                                  	;call	pciRegRead16 ; pciRegRead8
   104                                  	;
   105                                  	;; eax = BUS/DEV/FN/REG
   106                                  	;;  dx = PCI Command Register Content ; 17/02/2017
   107                                  	;; 	00000000CCCCCCCC
   108                                  	;mov	[stats_cmd], dx
   109                                  	;
   110                                  	; 06/11/2023
   111                                  	;mov	al, PCI_IO_BASE ; IO base address register (10h)
   112                                  	;call	pciRegRead32
   113                                  	;
   114                                  	;and	dx, 0FFC0h	; IO_ADDR_MASK (0FFFE) ?
   115                                          ;mov	[ac97_io_base], dx
   116                                  
   117 00000090 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
   118 00000092 E8A701                  	call	pciRegRead8 ; 17/02/2017
   119                                  
   120 00000095 8816[FB1D]              	mov     [ac97_int_ln_reg], dl
   121                                  
   122                                  ; 09/11/2023
   123                                  ; 05/11/2023
   124                                  %if 1
   125                                  	; 28/11/2016
   126                                  	;mov	bx, 1	; 08/05/2024
   127 00000099 30F6                    	xor	dh, dh	; 17/02/2017
   128                                  	; 10/11/2023
   129                                  	;mov	cx, dx
   130                                  	;shl	bx, cl
   131                                  
   132                                  	; 04/11/2023
   133 0000009B FA                      	cli
   134                                  
   135                                  	;not	bx
   136 0000009C E4A1                    	in	al, 0A1h ; irq 8-15
   137 0000009E 88C4                            mov	ah, al
   138 000000A0 E421                            in	al, 21h  ; irq 0-7
   139                                  
   140                                  	; 04/11/2023
   141                                  	; save IRQ status
   142 000000A2 A3[FE1D]                	mov	[IRQ_status], ax
   143                                  
   144                                  	; 12/05/2024 (enable AC97 IRQ)
   145                                  	;mov	cl, dl
   146                                  	;mov	bx, 1
   147                                  	;shl	bx, cl
   148                                  	;not	bx
   149                                  	;and	ax, bx
   150                                  	;out	21h, al
   151                                  	;mov	al, ah
   152                                  	;out	0A1h, al
   153                                  
   154                                  	;and	ax, bx   ; unmask
   155 000000A5 0FB3D0                   	btr	ax, dx	 ; unmask
   156 000000A8 E621                    	out	21h, al  ; enable interrupt (if irq <= 7)
   157 000000AA 88E0                    	mov	al, ah
   158 000000AC E6A1                    	out	0A1h, al ; enable interrupt (if irq > 7)
   159                                  	;not	bx
   160                                  
   161                                  	; 04/11/2023
   162                                  	;mov	dx, 4D1h			;8259 ELCR1
   163                                          ;in	al, dx
   164                                  	;mov	ah, al
   165                                  	;mov	dx, 4D0h
   166                                          ;in	al, dx
   167                                  	;;or	ax, bx
   168                                  	;bts	ax, cx
   169                                  	;mov	dx, 4D0h
   170                                  	;out	dx, al                          ;set level-triggered mode
   171                                  	;mov	al, ah
   172                                  	;mov	dx, 4D1h
   173                                  	;out	dx, al                          ;set level-triggered mode
   174                                  
   175                                  	; 24/11/2016 - Erdogan Tan
   176                                  	;mov	bx, cx
   177                                  	; 10/11/2023
   178 000000AE 89D3                    	mov	bx, dx
   179 000000B0 8A9F[261C]              	mov	bl, [bx+irq_int]
   180 000000B4 C1E302                  	shl	bx, 2 ; * 4
   181                                  
   182                                  	; set up interrupt vector
   183                                  	; 30/11/2016
   184 000000B7 06                      	push	es
   185 000000B8 31C0                    	xor	ax, ax
   186 000000BA 8EC0                    	mov	es, ax
   187                                  	; 04/11/2023
   188                                  	; save interrupt vector
   189                                  	;mov	ax, [es:bx]
   190                                  	; 13/05/2024
   191 000000BC B8[951B]                	mov	ax, ac97_int_handler
   192 000000BF 268707                  	xchg	ax, [es:bx]
   193 000000C2 A3[001E]                	mov	[IRQ_vector], ax
   194                                  	;mov	ax, [es:bx+2]
   195                                  	; 13/05/2024
   196 000000C5 8CC8                    	mov	ax, cs
   197 000000C7 26874702                	xchg	ax, [es:bx+2]
   198 000000CB A3[021E]                	mov	[IRQ_vector+2], ax
   199                                  
   200                                  	; 13/05/2024
   201                                  	;mov	word [es:bx], ac97_int_handler
   202                                  	;mov	ax, cs
   203                                  	;mov	[es:bx+2], ax
   204                                  
   205 000000CE 07                      	pop	es
   206                                  
   207                                  	; 04/11/2023
   208 000000CF FB                      	sti
   209                                  
   210                                  %endif
   211 000000D0 E81B19                  	call	write_ac97_dev_info 
   212                                  
   213                                  ; check the command line for a file to play
   214                                  
   215                                          ;push	ds
   216 000000D3 E89200                          call    processCmdline			; get the filename
   217                                  
   218                                  ; open the file
   219 000000D6 B002                            mov     al, OPEN                        ; open existing file
   220 000000D8 E8AD00                          call    openFile                        ; no error? ok.
   221                                          ;pop	ds
   222 000000DB 7322                            jnc     short _gsr
   223                                  
   224                                  ; file not found!
   225                                  
   226                                          ;push   cs
   227                                          ;pop    ds
   228 000000DD BA[E600]                        mov	dx, noFileErrMsg
   229 000000E0 B409                            mov     ah, 9
   230 000000E2 CD21                            int     21h
   231 000000E4 EB61                            jmp     exit
   232                                  
   233                                  noFileErrMsg:
   234 000000E6 4572726F723A206669-     	db "Error: file not found.",CR,LF,"$"
   234 000000EF 6C65206E6F7420666F-
   234 000000F8 756E642E0D0A24     
   235                                  
   236                                  _gsr:
   237 000000FF E8AD00                          call    getSampleRate                   ; read the sample rate
   238                                                                                  ; pass it onto codec.
   239 00000102 7243                    	jc	short exit ; 19/11/2016 - nothing to do
   240                                  
   241 00000104 A3[161E]                	mov	[sample_rate], ax
   242                                  	
   243                                  	; 19/11/2016
   244 00000107 880E[181E]              	mov	[stmo], cl
   245 0000010B 8816[1A1E]              	mov	[bps], dl
   246                                  	
   247                                  	; 17/02/2017
   248 0000010F C606[1C1E]00            	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit 
   249 00000114 FEC9                    	dec	cl
   250 00000116 7504                    	jnz	short _gsr_1 ; stereo
   251 00000118 FE06[1C1E]              	inc	byte [fbs_shift] ; 1 = mono or 8 bit
   252                                  _gsr_1:	
   253 0000011C 80FA08                  	cmp	dl, 8 
   254 0000011F 7704                    	ja	short _gsr_2 ; 16 bit samples
   255 00000121 FE06[1C1E]              	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   256                                  _gsr_2:	
   257 00000125 E81C1A                  	call	write_sample_rate
   258                                  
   259                                  	; 05/11/2023
   260                                  _2:
   261 00000128 E85907                  	call	check4keyboardstop  ; flush keyboard buffer
   262 0000012B 72FB                    	jc	short _2 	; 07/11/2023
   263                                  
   264                                  	; 09/11/2023
   265                                  	;; 05/11/2023
   266                                  	;mov	eax, [bus_dev_fn]
   267                                  	;mov	al, PCI_CMD_REG
   268                                  	;call	pciRegRead16			; read PCI command register
   269                                  	;; 17/02/2017
   270                                  	;;mov	dx, [stats_cmd]
   271                                          ;or	dl, IO_ENA+BM_ENA               ; enable IO and bus master
   272                                  	;call	pciRegWrite16 ; pciRegWrite8
   273                                  
   274                                  	;; 06/11/2023
   275                                  	;;mov	eax, [bus_dev_fn]
   276                                  	;;mov	al, PCI_CMD_REG
   277                                  	;;call	pciRegRead8                     ; read PCI command register
   278                                  	;;or	dl, IO_ENA+BM_ENA               ; enable IO and bus master
   279                                  	;;call	pciRegWrite8
   280                                  
   281                                  ; setup the Codec (actually mixer registers)
   282 0000012D E8E401                          call    codecConfig                     ; unmute codec, set rates.
   283                                  	; 11/11/2023
   284 00000130 721C                    	jc	short init_err
   285                                  ;
   286                                  ; position file pointer to start in actual wav data
   287                                  ; MUCH improvement should really be done here to check if sample size is
   288                                  ; supported, make sure there are 2 channels, etc.  
   289                                  ;
   290 00000132 B442                            mov     ah, 42h
   291 00000134 B000                            mov     al, 0                           ; from start of file
   292 00000136 8B1E[F81D]                      mov     bx, [filehandle]
   293 0000013A 31C9                            xor     cx, cx
   294 0000013C BA2C00                          mov     dx, 44                          ; jump past .wav/riff header
   295 0000013F CD21                            int     21h
   296                                  
   297                                  ; play the .wav file. Most of the good stuff is in here.
   298                                  
   299 00000141 E88503                          call    playWav
   300                                  
   301                                  ; close the .wav file and exit.
   302                                  
   303                                  close_exit:			; 11/11/2023
   304 00000144 E85300                          call    closeFile
   305                                  
   306                                  exit:
   307 00000147 B8004C                          mov     ax, 4c00h
   308 0000014A CD21                    	int 	21h
   309                                  
   310                                  here:
   311 0000014C EBFE                    	jmp	short here
   312                                  
   313                                  	; 11/11/2023
   314                                  init_err:
   315 0000014E BA[711D]                	mov	dx, msg_init_err
   316                                  vra_err: ; 12/11/2023
   317 00000151 B409                            mov	ah, 9
   318 00000153 CD21                            int	21h
   319 00000155 EBED                    	jmp	short close_exit
   320                                  
   321                                  ; MEMALLOC.ASM
   322                                  ;-- SETFREE: Release memory not used  ----------------
   323                                  ;-- Input    : ES = address of PSP
   324                                  ;-- Output   : none
   325                                  ;-- Register : AX, BX, CL and FLAGS are changed 
   326                                  ;-- Info     : Since the stack-segment is always the last segment in an 
   327                                  ;              EXE-file, ES:0000 points to the beginning and SS:SP
   328                                  ;              to the end of the program in memory. Through this the
   329                                  ;              length of the program can be calculated 
   330                                  ; call this routine once at the beginning of the program to free up memory
   331                                  ; assigned to it by DOS.
   332                                  
   333                                  setFree:
   334 00000157 BB0010                  	  mov	bx, 65536/16	; 4K paragraphs ; 17/02/2017 (Erdogan Tan)
   335                                  
   336 0000015A B44A                              mov	ah, 4ah		; pass new length to DOS
   337 0000015C CD21                              int	21h
   338                                  
   339 0000015E C3                                retn			; back to caller 
   340                                  				; new size (allocated memory) = 64KB
   341                                  
   342                                  memAlloc:
   343                                  ; input: AX = # of paragraphs required
   344                                  ; output: AX = segment of block to use
   345                                  
   346 0000015F 53                      	push	bx
   347 00000160 89C3                    	mov	bx, ax
   348 00000162 B448                    	mov	ah, 48h
   349 00000164 CD21                    	int	21h
   350 00000166 5B                      	pop	bx
   351 00000167 C3                      	retn
   352                                  
   353                                  ; CMDLINE.ASM
   354                                  ; parse the command line
   355                                  ; entry: none
   356                                  ; exit: DS:DX to the 1st supplied item on the command line 
   357                                  
   358                                  processCmdline:
   359 00000168 53                              push    bx
   360 00000169 56                              push    si
   361                                  
   362                                          ;mov    ah, 51h
   363                                          ;int    21h
   364                                          ;mov    ds, bx
   365                                  
   366 0000016A BE8000                          mov     si, 80h
   367 0000016D 0FB61C                          movzx   bx, byte [si]
   368 00000170 01DE                            add     si, bx
   369 00000172 46                              inc     si
   370                                  
   371 00000173 C60400                          mov     byte [si], NULL         ; zero terminate
   372                                  
   373 00000176 BE8100                          mov     si, 81h
   374                                  
   375                                  cmdlineloop:
   376 00000179 AC                              lodsb
   377                                  
   378 0000017A 3C00                            cmp     al, NULL                ; found end of line?
   379 0000017C 7404                            je      short exitpc
   380 0000017E 3C20                            cmp     al, ' '                 ; found a space?
   381 00000180 74F7                            je      short cmdlineloop
   382                                  
   383                                          ; must be the filename here.
   384                                  exitpc:
   385 00000182 4E                              dec     si                      ; point to start of filename
   386 00000183 89F2                            mov     dx, si
   387 00000185 5E                              pop     si
   388 00000186 5B                              pop     bx
   389 00000187 C3                      	retn
   390                                  
   391                                  ; FILE.ASM
   392                                  ;open or create file
   393                                  ;
   394                                  ;input: ds:dx-->filename (asciiz)
   395                                  ;       al=file Mode (create or open)
   396                                  ;output: none  cs:[filehandle] filled
   397                                  ;
   398                                  openFile:
   399 00000188 50                      	push	ax
   400 00000189 51                      	push	cx
   401 0000018A B43B                    	mov	ah, 3bh			; start with a mode
   402 0000018C 00C4                    	add	ah, al			; add in create or open mode
   403 0000018E 31C9                    	xor	cx, cx
   404 00000190 CD21                    	int	21h
   405 00000192 7203                    	jc	short _of1
   406                                  	;mov	[cs:filehandle], ax
   407 00000194 A3[F81D]                	mov	[filehandle], ax
   408                                  _of1:
   409 00000197 59                      	pop	cx
   410 00000198 58                      	pop	ax
   411 00000199 C3                      	retn
   412                                  
   413                                  ; close the currently open file
   414                                  ; input: none, uses cs:[filehandle]
   415                                  closeFile:
   416 0000019A 50                      	push	ax
   417 0000019B 53                      	push	bx
   418 0000019C 833E[F81D]FF            	cmp	word [filehandle], -1
   419 000001A1 7409                    	jz	short _cf1
   420 000001A3 8B1E[F81D]              	mov     bx, [filehandle]
   421 000001A7 B8003E                  	mov     ax,3e00h
   422 000001AA CD21                            int     21h              ;close file
   423                                  _cf1:
   424 000001AC 5B                      	pop	bx
   425 000001AD 58                      	pop	ax
   426 000001AE C3                      	retn
   427                                  
   428                                  getSampleRate:
   429                                  	; 08/12/2016
   430                                  ; reads the sample rate from the .wav file.
   431                                  ; entry: none - assumes file is already open
   432                                  	; 19/11/2016 - Erdogan Tan
   433                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   434                                  ;	cx = number of channels (mono=1, stereo=2)
   435                                  ;	dx = bits per sample (8, 16)
   436                                  
   437 000001AF 53                      	push    bx
   438                                  
   439 000001B0 B442                            mov     ah, 42h
   440 000001B2 B000                            mov     al, 0				; from start of file
   441 000001B4 8B1E[F81D]                      mov     bx, [filehandle]
   442 000001B8 31C9                            xor     cx, cx
   443 000001BA BA0800                          mov     dx, 08h				; "WAVE"
   444 000001BD CD21                            int     21h
   445                                  
   446 000001BF BA[DC1D]                        mov     dx, smpRBuff
   447 000001C2 B91C00                          mov     cx, 28				; 28 bytes
   448 000001C5 B43F                    	mov	ah, 3fh
   449 000001C7 CD21                            int     21h
   450                                  
   451 000001C9 813E[DC1D]5741          	cmp	word [smpRBuff], 'WA'
   452 000001CF 751C                    	jne	short gsr_stc
   453                                  
   454 000001D1 813E[DE1D]5645          	cmp	word [smpRBuff+2], 'VE'
   455 000001D7 7514                    	jne	short gsr_stc
   456                                  
   457 000001D9 833E[E81D]01            	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   458 000001DE 750D                    	jne	short gsr_stc
   459                                  
   460                                  
   461 000001E0 8B0E[EA1D]              	mov	cx, [smpRBuff+14]	; return num of channels in CX
   462 000001E4 A1[EC1D]                        mov     ax, [smpRBuff+16]	; return sample rate in AX
   463 000001E7 8B16[F61D]              	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   464                                  gsr_retn:
   465 000001EB 5B                              pop     bx
   466 000001EC C3                              retn
   467                                  
   468                                  gsr_stc:
   469 000001ED F9                      	stc
   470 000001EE EBFB                    	jmp	short gsr_retn
   471                                  
   472                                  ;%include 'ac97.asm' ; 29/11/2016 (AC97 codec configuration)
   473                                  %include 'ac97_vra.asm' ; 19/11/2023 (AC97 codec configuration)
     1                              <1> ; 19/05/2024
     2                              <1> ; 19/11/2023 
     3                              <1> ;	(ready status optimization -in order to prevent wrong init error- )
     4                              <1> ; 18/11/2023
     5                              <1> ; 15/11/2023
     6                              <1> ; 13/11/2023
     7                              <1> ; 12/11/2023
     8                              <1> ; 11/11/2023
     9                              <1> ; 03/11/2023 - 06/11/2023
    10                              <1> ; PCI and AC97 codec functions for wav player
    11                              <1> ; Erdogan Tan (17/02/2017)
    12                              <1> 
    13                              <1> ; ----------------------------------------------------------------------------
    14                              <1> ; PCI.ASM
    15                              <1> ; ----------------------------------------------------------------------------
    16                              <1> 
    17                              <1> ; PCI device register reader/writers.
    18                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    19                              <1> ; 		Last Update: 17/02/2017
    20                              <1> 
    21                              <1> ;===============================================================
    22                              <1> ; 8/16/32bit PCI reader
    23                              <1> ;
    24                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    25                              <1> ;           BIT30 set if 32 bit access requested
    26                              <1> ;           BIT29 set if 16 bit access requested
    27                              <1> ;           otherwise defaults to 8 bit read
    28                              <1> ;
    29                              <1> ; Exit:  DL,DX,EDX register data depending on requested read size
    30                              <1> ;
    31                              <1> ; Note: this routine is meant to be called via pciRegRead8, pciRegread16,
    32                              <1> ;	or pciRegRead32, listed below.
    33                              <1> ;
    34                              <1> ; Note2: don't attempt to read 32bits of data from a non dword aligned reg
    35                              <1> ;	 number. Likewise, don't do 16bit reads from non word aligned reg #
    36                              <1> ; 
    37                              <1> pciRegRead:
    38 000001F0 6653                <1> 	push	ebx
    39 000001F2 51                  <1> 	push	cx
    40 000001F3 6689C3              <1>         mov     ebx, eax                        ; save eax, dh
    41 000001F6 88F1                <1>         mov     cl, dh
    42 000001F8 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    43 000001FE 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
    44 00000204 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
    45                              <1> 
    46 00000206 BAF80C              <1>         mov     dx, PCI_INDEX_PORT
    47 00000209 66EF                <1>         out     dx, eax                         ; write PCI selector
    48                              <1> 
    49 0000020B BAFC0C              <1>         mov     dx, PCI_DATA_PORT
    50 0000020E 88D8                <1>         mov     al, bl
    51 00000210 2403                <1>         and     al, 3                           ; figure out which port to
    52 00000212 00C2                <1>         add     dl, al                          ; read to
    53                              <1> 
    54 00000214 66ED                <1> 	in      eax, dx                         ; do 32bit read
    55 00000216 66F7C300000080      <1>         test    ebx, PCI32
    56 0000021D 7403                <1>         jz      short _pregr1
    57                              <1> 
    58 0000021F 6689C2              <1>         mov     edx, eax                        ; return 32bits of data
    59                              <1> _pregr1:
    60 00000222 89C2                <1> 	mov     dx, ax                          ; return 16bits of data
    61 00000224 66F7C3000000C0      <1>         test    ebx, PCI32+PCI16
    62 0000022B 7502                <1>         jnz     short _pregr2
    63 0000022D 88CE                <1>         mov     dh, cl                          ; restore dh for 8 bit read
    64                              <1> _pregr2:
    65 0000022F 6689D8              <1>         mov     eax, ebx                        ; restore eax
    66 00000232 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    67 00000238 59                  <1> 	pop	cx
    68 00000239 665B                <1> 	pop	ebx
    69 0000023B C3                  <1> 	retn
    70                              <1> 
    71                              <1> pciRegRead8:
    72 0000023C 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32             ; set up 8 bit read size
    73 00000242 EBAC                <1>         jmp     short pciRegRead		; call generic PCI access
    74                              <1> 
    75                              <1> pciRegRead16:
    76 00000244 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit read size
    77 0000024A 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
    78 00000250 EB9E                <1>         jmp     short pciRegRead
    79                              <1> 
    80                              <1> pciRegRead32:
    81 00000252 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit read size
    82 00000258 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
    83 0000025E EB90                <1>         jmp     short pciRegRead
    84                              <1> 
    85                              <1> ;===============================================================
    86                              <1> ; 8/16/32bit PCI writer
    87                              <1> ;
    88                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    89                              <1> ;           BIT31 set if 32 bit access requested
    90                              <1> ;           BIT30 set if 16 bit access requested
    91                              <1> ;           otherwise defaults to 8bit read
    92                              <1> ;        DL/DX/EDX data to write depending on size
    93                              <1> ;
    94                              <1> ;
    95                              <1> ; note: this routine is meant to be called via pciRegWrite8, pciRegWrite16,
    96                              <1> ; 	or pciRegWrite32 as detailed below.
    97                              <1> ;
    98                              <1> ; Note2: don't attempt to write 32bits of data from a non dword aligned reg
    99                              <1> ;	 number. Likewise, don't do 16bit writes from non word aligned reg #
   100                              <1> ;
   101                              <1> pciRegWrite:
   102 00000260 6653                <1> 	push	ebx
   103 00000262 51                  <1> 	push	cx
   104 00000263 6689C3              <1>         mov     ebx, eax                        ; save eax, dx
   105 00000266 89D1                <1>         mov     cx, dx
   106 00000268 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
   107 0000026E 6625FFFFFFBF        <1>         and     eax, ~PCI16 ; NOT PCI16         ; clear out data size request
   108 00000274 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
   109                              <1> 
   110 00000276 BAF80C              <1>         mov     dx, PCI_INDEX_PORT
   111 00000279 66EF                <1>         out     dx, eax                         ; write PCI selector
   112                              <1> 
   113 0000027B BAFC0C              <1>         mov     dx, PCI_DATA_PORT
   114 0000027E 88D8                <1>         mov     al, bl
   115 00000280 2403                <1>         and     al, 3                           ; figure out which port to
   116 00000282 00C2                <1>         add     dl, al                          ; write to
   117                              <1> 
   118 00000284 6689D0              <1>         mov     eax, edx                        ; put data into eax
   119 00000287 89C8                <1>         mov     ax, cx
   120                              <1> 
   121 00000289 EE                  <1>         out     dx, al
   122 0000028A 66F7C3000000C0      <1>         test    ebx, PCI16+PCI32                ; only 8bit access? bail
   123 00000291 740C                <1>         jz      short _pregw1
   124                              <1> 
   125 00000293 EF                  <1>         out     dx, ax                          ; write 16 bit value
   126 00000294 66F7C300000040      <1>         test    ebx, PCI16                      ; 16bit requested?  bail
   127 0000029B 7502                <1>         jnz     short _pregw1
   128                              <1> 
   129 0000029D 66EF                <1>         out     dx, eax                         ; write full 32bit
   130                              <1> _pregw1:
   131 0000029F 6689D8              <1>         mov     eax, ebx                        ; restore eax
   132 000002A2 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
   133 000002A8 89CA                <1>         mov     dx, cx                          ; restore dx
   134 000002AA 59                  <1> 	pop	cx
   135 000002AB 665B                <1> 	pop	ebx
   136 000002AD C3                  <1> 	ret
   137                              <1> 
   138                              <1> pciRegWrite8:
   139 000002AE 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 8 bit write size
   140 000002B4 EBAA                <1>         jmp     short pciRegWrite		; call generic PCI access
   141                              <1> 
   142                              <1> pciRegWrite16:
   143 000002B6 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit write size
   144 000002BC 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
   145 000002C2 EB9C                <1>         jmp     short pciRegWrite
   146                              <1> 
   147                              <1> pciRegWrite32:
   148 000002C4 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit write size
   149 000002CA 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
   150 000002D0 EB8E                <1>         jmp     short pciRegWrite
   151                              <1> 
   152                              <1> ; 17/02/2017 (Modifed by Erdogan Tan for various ICH device IDs)
   153                              <1> ;===============================================================
   154                              <1> ; PCIFindDevice: scan through PCI space looking for a device+vendor ID
   155                              <1> ;
   156                              <1> ;  ENTRY: none
   157                              <1> ;; Entry: EAX=Device+Vendor ID
   158                              <1> ;
   159                              <1> ;  Exit: EAX=PCI address if device found
   160                              <1> ;	 EDX=Device+Vendor ID
   161                              <1> ;        CY clear if found, set if not found. EAX invalid if CY set.
   162                              <1> ;
   163                              <1> ; [old stackless] Destroys: ebx, esi, edi, cl
   164                              <1> ;
   165                              <1> pciFindDevice:
   166                              <1> 	;push	cx
   167                              <1> 	;push	eax ; *
   168                              <1> 	;push	esi
   169                              <1> 	;push	edi
   170                              <1> 
   171                              <1>  	;mov     esi, eax                ; save off vend+device ID
   172                              <1> 
   173                              <1> 	; 17/02/2017
   174 000002D2 BE[361C]            <1> 	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
   175 000002D5 B91500              <1> 	mov	cx, valid_id_count
   176                              <1> pfd_0:
   177 000002D8 66BF00FFFF7F        <1>        	mov     edi, (80000000h - 100h) ; start with bus 0, dev 0 func 0
   178                              <1> nextPCIdevice:
   179 000002DE 6681C700010000      <1>         add     edi, 100h
   180 000002E5 6681FF00F8FF80      <1>         cmp     edi, 80FFF800h		; scanned all devices?
   181                              <1>         ;stc
   182                              <1>         ;je 	short PCIScanExit       ; not found
   183 000002EC 720D                <1> 	jb	short pfd_1
   184 000002EE 66BF00000080        <1> 	mov     edi, 80000000h
   185 000002F4 83C604              <1> 	add	si, 4 ; scan for next device ID
   186 000002F7 E202                <1> 	loop	pfd_1	 
   187 000002F9 F9                  <1> 	stc	
   188                              <1> 	;jmp 	short PCIScanExit
   189 000002FA C3                  <1> 	retn
   190                              <1> pfd_1:
   191 000002FB 6689F8              <1>         mov     eax, edi                ; read PCI registers
   192 000002FE E851FF              <1>         call    pciRegRead32
   193                              <1>         ;cmp    edx, esi                ; found device?
   194 00000301 663B14              <1>         cmp	edx, dword [si]
   195 00000304 75D8                <1> 	jne     short nextPCIdevice
   196                              <1>         ;clc
   197                              <1> PCIScanExit:
   198                              <1> 	;pushf
   199 00000306 66B800000080        <1> 	mov	eax, BIT31
   200 0000030C 66F7D0              <1> 	not	eax
   201 0000030F 6621F8              <1> 	and	eax, edi		; return only bus/dev/fn #
   202                              <1> 	;popf
   203                              <1> 
   204                              <1> 	;pop	edi
   205                              <1> 	;pop	esi
   206                              <1> 	;pop	edx ; *
   207                              <1> 	;pop	cx
   208 00000312 C3                  <1> 	retn
   209                              <1> 
   210                              <1> ; ----------------------------------------------------------------------------
   211                              <1> ; CODEC.ASM
   212                              <1> ; ----------------------------------------------------------------------------
   213                              <1> 
   214                              <1> ; codec configuration code. Not much here really.
   215                              <1> ; NASM version: Erdogan Tan (29/11/2016)
   216                              <1> 
   217                              <1> ; enable codec, unmute stuff, set output rate to 44.1
   218                              <1> ; entry: ax = desired sample rate
   219                              <1> 
   220                              <1> ; 19/05/2024
   221                              <1> ; 19/11/2023
   222                              <1> ; 11/11/2023
   223                              <1> ; 06/11/2023
   224                              <1> %if 1
   225                              <1> 
   226                              <1> ;	; 11/11/2023
   227                              <1> ;init_ac97_codec_err1:
   228                              <1> ;	stc
   229                              <1> ;init_ac97_codec_err2:
   230                              <1> ;	retn
   231                              <1> 
   232                              <1> 	; 13/11/2023
   233 00000313 01                  <1> VRA:	db 1	
   234                              <1> 
   235                              <1> codecConfig:
   236                              <1> 	; 19/05/2024
   237                              <1> 	; 19/11/2023
   238                              <1> 	; 15/11/2023
   239                              <1> 	; 04/11/2023
   240                              <1> 	; 17/02/2017 
   241                              <1> 	; 07/11/2016 (Erdogan Tan)
   242                              <1> 	;PORT_NABM_GLB_CTRL_STAT equ 60h
   243                              <1> 
   244                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   245                              <1>  	; 'AC97_DEF.H'
   246                              <1> 	;AC97_EXTENDED_STATUS equ 002Ah
   247                              <1> 	AC97_EA_SPDIF	equ 0002h
   248                              <1> 	AC97_EA_VRA	equ 0001h
   249                              <1> 	; 04/11/2023
   250                              <1> 	ICH_PO_CR_RESET equ 0002h  ; reset codec
   251                              <1> 	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
   252                              <1> 	ICH_PCM_246_MASK equ 300000h ; 6 channels
   253                              <1> 
   254                              <1> 	; 04/11/2023
   255                              <1> init_ac97_controller:
   256 00000314 66A1[0E1E]          <1> 	mov	eax, [bus_dev_fn]
   257 00000318 B004                <1> 	mov	al, PCI_CMD_REG
   258 0000031A E827FF              <1> 	call	pciRegRead16		; read PCI command register
   259 0000031D 80CA05              <1> 	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
   260 00000320 E893FF              <1> 	call	pciRegWrite16
   261                              <1> 
   262 00000323 E89801              <1> 	call	delay_100ms
   263                              <1> 
   264                              <1> 	; 19/05/2024
   265                              <1> 	; ('PLAYMOD3.ASM', Erdogan Tan, 18/05/2024)
   266                              <1> 
   267                              <1> init_ac97_codec:
   268                              <1> 	; 18/11/2023
   269 00000326 BD2800              <1> 	mov	bp, 40
   270                              <1> _initc_1:
   271                              <1> 	; 11/11/2023
   272                              <1> 	; (TRDOS 386 v2.0.5, 'audio.s')
   273 00000329 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   274 0000032C 0316[061E]          <1> 	add	dx, [NABMBAR]
   275 00000330 66ED                <1> 	in	eax, dx
   276                              <1> 
   277                              <1> 	; 19/05/2024
   278 00000332 E89916              <1> 	call	delay1_4ms
   279                              <1> 
   280                              <1> 	; ?
   281 00000335 BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   282 00000338 0316[061E]          <1> 	add	dx, [NABMBAR]
   283 0000033C 66ED                <1> 	in	eax, dx
   284                              <1> 
   285                              <1> 	; 19/05/2024
   286 0000033E E88D16              <1> 	call	delay1_4ms
   287                              <1> 
   288 00000341 6683F8FF            <1> 	cmp	eax, 0FFFFFFFFh ; -1
   289 00000345 7508                <1> 	jne	short _initc_3
   290                              <1> _initc_2:
   291                              <1> 	;dec	cx
   292 00000347 4D                  <1> 	dec	bp	; 18/11/2023
   293                              <1> 	;jz	short init_ac97_codec_err1
   294                              <1> 	; 19/11/2023
   295 00000348 7412                <1> 	jz	short _ac97_codec_ready
   296                              <1> 
   297 0000034A E87101              <1> 	call	delay_100ms
   298 0000034D EBDA                <1> 	jmp	short _initc_1
   299                              <1> _initc_3:
   300 0000034F 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   301 00000355 7505                <1> 	jnz	short _ac97_codec_ready
   302                              <1> 
   303 00000357 E8E400              <1> 	call	reset_ac97_codec
   304                              <1> 	; 15/11/2023
   305                              <1> 	;jc	short _initc_2
   306                              <1> 	; 19/05/2024
   307 0000035A EBEB                <1> 	jmp	short _initc_2
   308                              <1> 
   309                              <1> _ac97_codec_ready:
   310 0000035C 8B16[041E]          <1> 	mov	dx, [NAMBAR]
   311                              <1> 	;add	dx, 0 ; ac_reg_0 ; reset register
   312 00000360 EF                  <1> 	out	dx, ax
   313                              <1> 
   314 00000361 E85A01              <1> 	call	delay_100ms
   315                              <1> 
   316                              <1> 	; 19/11/2023
   317 00000364 09ED                <1> 	or	bp, bp
   318 00000366 751F                <1> 	jnz	short _ac97_codec_init_ok
   319                              <1> 
   320 00000368 6631C0              <1> 	xor	eax, eax ; 0
   321 0000036B 8B16[041E]          <1> 	mov	dx, [NAMBAR]
   322 0000036F 83C226              <1> 	add	dx, CODEC_REG_POWERDOWN
   323 00000372 EF                  <1> 	out	dx, ax
   324                              <1> 	
   325                              <1> 	; 19/11/2023
   326                              <1> 	; wait for 1 second
   327                              <1> 	; 19/05/2024
   328                              <1> 	;mov	ecx, 1000 ; 1000*4*0.25ms = 1s
   329                              <1> 	;mov	cx, 10
   330 00000373 B92800              <1> 	mov	cx, 40
   331                              <1> _ac97_codec_rloop:
   332                              <1> 	;call	delay1_4ms
   333                              <1> 	;call	delay1_4ms
   334                              <1> 	;call	delay1_4ms
   335                              <1> 	;call	delay1_4ms
   336 00000376 E84501              <1> 	call	delay_100ms
   337                              <1> 
   338                              <1> 	;mov	dx, [NAMBAR]
   339                              <1> 	;add	dx, CODEC_REG_POWERDOWN
   340 00000379 ED                  <1> 	in	ax, dx
   341                              <1> 
   342 0000037A E85116              <1> 	call	delay1_4ms
   343                              <1> 	
   344 0000037D 83E00F              <1> 	and	ax, 0Fh
   345 00000380 3C0F                <1> 	cmp	al, 0Fh
   346 00000382 7403                <1> 	je	short _ac97_codec_init_ok
   347 00000384 E2F0                <1> 	loop	_ac97_codec_rloop 
   348                              <1> 
   349                              <1> init_ac97_codec_err1:
   350                              <1> 	;stc	; cf = 1 ; 19/05/2024
   351                              <1> init_ac97_codec_err2:
   352 00000386 C3                  <1> 	retn
   353                              <1> 
   354                              <1> _ac97_codec_init_ok:
   355                              <1>         ; 11/11/2023
   356                              <1> 	;mov	al, 2 ; force set 16-bit 2-channel PCM
   357                              <1> 	;mov	dx, GLOB_CNT_REG ; 2Ch
   358                              <1> 	;add	dx, [NABMBAR]
   359                              <1> 	;out	dx, eax
   360                              <1> 
   361                              <1> 	;;call	delay1_4ms
   362                              <1> 
   363 00000387 E86D00              <1> 	call 	reset_ac97_controller
   364                              <1> 
   365                              <1> 	; 11/11/2023
   366                              <1> 	;call	delay1_4ms
   367                              <1> 	; 19/05/2024
   368 0000038A E83101              <1> 	call	delay_100ms
   369                              <1> 
   370                              <1> 	;call 	setup_ac97_codec
   371                              <1> 
   372                              <1> setup_ac97_codec:
   373                              <1> 	; 12/11/2023
   374 0000038D 813E[161E]80BB      <1> 	cmp	word [sample_rate], 48000
   375 00000393 7435                <1> 	je	short skip_rate
   376                              <1> 
   377                              <1> ; 11/11/2023
   378                              <1> ; 05/11/2023
   379                              <1> ;%if 1
   380                              <1> 	AC97_EA_VRA equ BIT0 ; 11/11/2023
   381                              <1> 
   382                              <1> 	; 19/05/2024
   383 00000395 E83616              <1> 	call	delay1_4ms
   384                              <1> 
   385                              <1> 	;; 19/05/2024
   386                              <1> 	;;mov	dx, [NAMBAR]
   387                              <1> 	;;add	dx, CODEC_EXT_AUDIO_REG	; 28h
   388                              <1> 	;;in	ax, dx
   389                              <1> 	;
   390                              <1> 	;; 19/05/2024
   391                              <1> 	;;test	al, 1 ; BIT0 ; Variable Rate Audio bit
   392                              <1> 	;;jz	short vra_not_supported
   393                              <1> 	;
   394                              <1> 	;; 19/05/2024
   395                              <1> 	;;call	delay1_4ms
   396                              <1> 
   397                              <1> 	; 11/11/2023
   398 00000398 8B16[041E]          <1> 	mov    	dx, [NAMBAR]
   399 0000039C 83C22A              <1> 	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
   400 0000039F ED                  <1> 	in     	ax, dx
   401                              <1> 
   402                              <1> 	; 19/05/2024
   403 000003A0 E82B16              <1> 	call	delay1_4ms
   404                              <1> 	
   405 000003A3 24FD                <1> 	and	al, ~BIT1 ; Clear DRA
   406 000003A5 0C01                <1> 	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
   407 000003A7 EF                  <1> 	out	dx, ax			; Enable variable rate audio
   408                              <1> 	
   409 000003A8 B90A00              <1> 	mov	cx, 10
   410                              <1> check_vra:
   411 000003AB E81001              <1> 	call	delay_100ms
   412                              <1> 
   413                              <1> 	; 11/11/2023
   414 000003AE ED                  <1> 	in	ax, dx
   415 000003AF A801                <1> 	test	al, AC97_EA_VRA ; 1
   416 000003B1 7509                <1> 	jnz	short set_rate
   417                              <1> 
   418                              <1> 	; 11/11/2023
   419 000003B3 E2F6                <1> 	loop	check_vra
   420                              <1> 
   421                              <1> ;vra_not_supported:	; 19/05/2024
   422                              <1> 	; 13/11/2023
   423 000003B5 C606[1303]00        <1> 	mov	byte [VRA], 0
   424 000003BA EB0E                <1> 	jmp	short skip_rate	
   425                              <1> 
   426                              <1> 	; 19/05/2024
   427                              <1> ;;vra_not_supported:
   428                              <1> 	; 12/11/2023
   429                              <1> 	;pop	ax ; discard return address to the caller
   430                              <1> 	;mov	dx, msg_no_vra
   431                              <1> 	;jmp	vra_err
   432                              <1> 
   433                              <1> set_rate:
   434 000003BC A1[161E]            <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   435                              <1> 
   436 000003BF 8B16[041E]          <1> 	mov    	dx, [NAMBAR]               	
   437 000003C3 83C22C              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   438 000003C6 EF                  <1> 	out	dx, ax 			; PCM Front/Center Output Sample Rate
   439                              <1> 
   440 000003C7 E8F400              <1> 	call	delay_100ms
   441                              <1> 
   442                              <1> 	; 12/11/2023
   443                              <1> skip_rate:
   444                              <1> 	; 11/11/2023 (temporary)
   445                              <1> 
   446                              <1> 	;mov   	dx, [NAMBAR]               	
   447                              <1> 	;add   	dx, CODEC_PCM_SURND_DACRATE_REG	; 2Eh  	  
   448                              <1> 	;out	dx, ax 			; PCM Surround Output Sample Rate
   449                              <1> 
   450                              <1> 	;call	delay_100ms
   451                              <1> 
   452                              <1> 	;mov   	dx, [NAMBAR]               	
   453                              <1> 	;add   	dx, CODEC_PCM_LFE_DACRATE_REG	; 30h  	  
   454                              <1> 	;out	dx, ax 			; PCM LFE Output Sample Rate
   455                              <1> 
   456                              <1> 	;call	delay_100ms
   457                              <1> 
   458                              <1> 	; 05/11/2023 (temporary)
   459                              <1> 	;mov	dx, [NAMBAR]               	
   460                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   461                              <1> 	;out	dx, ax 			; PCM Input Sample Rate
   462                              <1> 	;
   463                              <1> 	;call	delay_100ms
   464                              <1> 
   465 000003CA B80202              <1> 	mov	ax, 0202h
   466 000003CD 8B16[041E]          <1>   	mov     dx, [NAMBAR]
   467 000003D1 83C202              <1>   	add     dx, CODEC_MASTER_VOL_REG	;02h 
   468 000003D4 EF                  <1> 	out     dx, ax
   469                              <1> 
   470                              <1> 	; 11/11/2023
   471                              <1>         ;call	delay1_4ms
   472                              <1>         ;call	delay1_4ms
   473                              <1>         ;call	delay1_4ms
   474                              <1>         ;call	delay1_4ms
   475                              <1>  	;
   476                              <1>   	;mov	dx, [NAMBAR]
   477                              <1>   	;add	dx, CODEC_MASTER_MONO_VOL_REG	;06h 
   478                              <1>   	;out	dx, ax
   479                              <1> 
   480                              <1> 	; 11/11/2023
   481                              <1>         ;call	delay1_4ms
   482                              <1>         ;call	delay1_4ms
   483                              <1>         ;call	delay1_4ms
   484                              <1>         ;call	delay1_4ms
   485                              <1> 	;
   486                              <1> 	;mov	ax, 02h
   487                              <1>   	;mov	dx, [NAMBAR]
   488                              <1>   	;add	dx, CODEC_PCBEEP_VOL_REG	;0Ah 
   489                              <1>   	;out	dx, ax
   490                              <1> 
   491 000003D5 E8F615              <1>         call    delay1_4ms
   492 000003D8 E8F315              <1>         call    delay1_4ms
   493 000003DB E8F015              <1>         call    delay1_4ms
   494 000003DE E8ED15              <1>         call    delay1_4ms
   495                              <1> 
   496                              <1> 	;mov	ax, 0202h
   497 000003E1 8B16[041E]          <1>   	mov     dx, [NAMBAR]
   498 000003E5 83C218              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h 
   499 000003E8 EF                  <1>   	out     dx, ax
   500                              <1> 
   501 000003E9 E8E215              <1>         call    delay1_4ms
   502 000003EC E8DF15              <1>         call    delay1_4ms
   503 000003EF E8DC15              <1>         call    delay1_4ms
   504 000003F2 E8D915              <1>         call    delay1_4ms
   505                              <1> 
   506                              <1> 	; 11/11/2023
   507                              <1> 	;mov	ax, 8008h ; Mute
   508                              <1>   	;mov	dx, [NAMBAR]
   509                              <1> 	;add	dx, CODEC_PHONE_VOL_REG		;0Ch
   510                              <1> 	;			 ; AC97_PHONE_VOL ; TAD Input (Mono)
   511                              <1>   	;out	dx, ax
   512                              <1> 	;
   513                              <1>         ;call	delay1_4ms
   514                              <1>         ;call	delay1_4ms
   515                              <1>         ;call	delay1_4ms
   516                              <1> 	;call	delay1_4ms
   517                              <1> 
   518                              <1> 	;mov	ax, 0808h
   519                              <1> 	;mov	dx, [NAMBAR]
   520                              <1> 	;add	dx, CODEC_LINE_IN_VOL_REG ;10h ; Line Input (Stereo)
   521                              <1> 	;out	dx, ax
   522                              <1> 	;
   523                              <1>         ;call	delay1_4ms
   524                              <1>         ;call	delay1_4ms
   525                              <1>         ;call	delay1_4ms
   526                              <1> 	;call	delay1_4ms
   527                              <1> 
   528                              <1>   	;mov	dx, [NAMBAR]
   529                              <1>         ;add	dx, CODEC_CD_VOL_REG ;12h ; CD Input (Stereo)
   530                              <1>   	;out	dx, ax
   531                              <1> 	;
   532                              <1>   	;mov	dx, [NAMBAR]
   533                              <1>         ;add	dx, CODEC_AUX_VOL_REG ;16h ; Aux Input (Stereo)
   534                              <1>   	;out	dx, ax
   535                              <1> 	;
   536                              <1>         ;call	delay1_4ms
   537                              <1>         ;call	delay1_4ms
   538                              <1>         ;call	delay1_4ms
   539                              <1> 	;call	delay1_4ms
   540                              <1> 
   541                              <1> 	; 19/05/2024
   542 000003F5 F8                  <1> 	clc
   543                              <1> 
   544                              <1> ;detect_ac97_codec:
   545 000003F6 C3                  <1>         retn
   546                              <1> 
   547                              <1> reset_ac97_controller:
   548                              <1> 	; 19/05/2024
   549                              <1> 	; 11/11/2023
   550                              <1> 	; 10/06/2017
   551                              <1> 	; 29/05/2017
   552                              <1> 	; 28/05/2017
   553                              <1> 	; reset AC97 audio controller registers
   554 000003F7 31C0                <1> 	xor     ax, ax
   555 000003F9 BA0B00              <1>         mov	dx, PI_CR_REG
   556 000003FC 0316[061E]          <1> 	add	dx, [NABMBAR]
   557 00000400 EE                  <1> 	out     dx, al
   558                              <1> 
   559                              <1> 	; 19/05/2024
   560 00000401 E8CA15              <1> 	call	delay1_4ms
   561                              <1> 
   562 00000404 BA1B00              <1>         mov     dx, PO_CR_REG
   563 00000407 0316[061E]          <1> 	add	dx, [NABMBAR]
   564 0000040B EE                  <1> 	out     dx, al
   565                              <1> 
   566                              <1> 	; 19/05/2024
   567 0000040C E8BF15              <1> 	call	delay1_4ms
   568                              <1> 
   569 0000040F BA2B00              <1>         mov     dx, MC_CR_REG
   570 00000412 0316[061E]          <1> 	add	dx, [NABMBAR]
   571 00000416 EE                  <1> 	out     dx, al
   572                              <1> 
   573                              <1> 	; 19/05/2024
   574 00000417 E8B415              <1> 	call	delay1_4ms
   575                              <1> 
   576 0000041A B002                <1>         mov     al, RR
   577 0000041C BA0B00              <1>         mov     dx, PI_CR_REG
   578 0000041F 0316[061E]          <1> 	add	dx, [NABMBAR]
   579 00000423 EE                  <1> 	out     dx, al
   580                              <1> 
   581                              <1> 	; 19/05/2024
   582 00000424 E8A715              <1> 	call	delay1_4ms
   583                              <1> 
   584 00000427 BA1B00              <1>         mov     dx, PO_CR_REG
   585 0000042A 0316[061E]          <1> 	add	dx, [NABMBAR]
   586 0000042E EE                  <1> 	out     dx, al
   587                              <1> 
   588                              <1> 	; 19/05/2024
   589 0000042F E89C15              <1> 	call	delay1_4ms
   590                              <1> 
   591 00000432 BA2B00              <1>         mov     dx, MC_CR_REG
   592 00000435 0316[061E]          <1> 	add	dx, [NABMBAR]
   593 00000439 EE                  <1> 	out     dx, al
   594                              <1> 
   595                              <1> 	; 19/05/2024
   596 0000043A E89115              <1> 	call	delay1_4ms
   597                              <1> 
   598 0000043D C3                  <1> 	retn
   599                              <1> 
   600                              <1> reset_ac97_codec:
   601                              <1> 	; 11/11/2023
   602                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   603 0000043E BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   604 00000441 0316[061E]          <1> 	add	dx, [NABMBAR]
   605 00000445 66ED                <1> 	in	eax, dx
   606                              <1> 
   607                              <1> 	;test	eax, 2
   608                              <1> 	; 06/08/2022
   609 00000447 A802                <1> 	test	al, 2
   610 00000449 7405                <1> 	jz	short _r_ac97codec_cold	
   611                              <1> 
   612 0000044B E80E00              <1> 	call	warm_ac97codec_reset
   613 0000044E 7306                <1> 	jnc	short _r_ac97codec_ok
   614                              <1> _r_ac97codec_cold:
   615 00000450 E83400              <1>         call    cold_ac97codec_reset
   616 00000453 7301                <1>         jnc     short _r_ac97codec_ok
   617                              <1> 	
   618                              <1> 	; 16/04/2017
   619                              <1>         ;xor	eax, eax	; timeout error
   620                              <1>        	;stc
   621 00000455 C3                  <1> 	retn
   622                              <1> 
   623                              <1> _r_ac97codec_ok:
   624 00000456 6631C0              <1>         xor     eax, eax
   625                              <1>         ;mov	al, VIA_ACLINK_C00_READY ; 1
   626 00000459 FEC0                <1>         inc	al
   627 0000045B C3                  <1> 	retn
   628                              <1> 
   629                              <1> warm_ac97codec_reset:
   630                              <1> 	; 11/11/2023
   631                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   632                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   633 0000045C 66B806000000        <1> 	mov	eax, 6
   634 00000462 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   635 00000465 0316[061E]          <1> 	add	dx, [NABMBAR]
   636 00000469 66EF                <1> 	out	dx, eax
   637                              <1> 
   638 0000046B B90A00              <1> 	mov	cx, 10	; total 1s
   639                              <1> _warm_ac97c_rst_wait:
   640 0000046E E84D00              <1> 	call	delay_100ms
   641                              <1> 
   642 00000471 BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   643 00000474 0316[061E]          <1> 	add	dx, [NABMBAR]
   644 00000478 66ED                <1> 	in	eax, dx
   645                              <1> 
   646 0000047A 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   647 00000480 7504                <1> 	jnz	short _warm_ac97c_rst_ok
   648                              <1> 
   649 00000482 49                  <1>         dec     cx
   650 00000483 75E9                <1>         jnz     short _warm_ac97c_rst_wait
   651                              <1> 
   652                              <1> _warm_ac97c_rst_fail:
   653 00000485 F9                  <1>         stc
   654                              <1> _warm_ac97c_rst_ok:
   655 00000486 C3                  <1> 	retn
   656                              <1> 
   657                              <1> cold_ac97codec_reset:
   658                              <1> 	; 11/11/2023
   659                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   660                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   661 00000487 66B802000000        <1>         mov	eax, 2
   662 0000048D BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   663 00000490 0316[061E]          <1> 	add	dx, [NABMBAR]
   664 00000494 66EF                <1> 	out	dx, eax
   665                              <1> 
   666 00000496 E82500              <1> 	call	delay_100ms 	; wait 100 ms
   667 00000499 E82200              <1> 	call	delay_100ms 	; wait 100 ms
   668 0000049C E81F00              <1> 	call	delay_100ms 	; wait 100 ms
   669 0000049F E81C00              <1> 	call	delay_100ms 	; wait 100 ms
   670                              <1> 
   671 000004A2 B91000              <1> 	mov	cx, 16	; total 20*100 ms = 2s
   672                              <1> 
   673                              <1> _cold_ac97c_rst_wait:
   674 000004A5 BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   675 000004A8 0316[061E]          <1> 	add	dx, [NABMBAR]
   676 000004AC 66ED                <1> 	in	eax, dx
   677                              <1> 
   678 000004AE 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   679 000004B4 7507                <1> 	jnz	short _cold_ac97c_rst_ok
   680                              <1> 
   681 000004B6 E80500              <1> 	call	delay_100ms
   682                              <1> 
   683 000004B9 49                  <1>         dec     cx
   684 000004BA 75E9                <1>         jnz     short _cold_ac97c_rst_wait
   685                              <1> 
   686                              <1> _cold_ac97c_rst_fail:
   687 000004BC F9                  <1>         stc
   688                              <1> _cold_ac97c_rst_ok:
   689 000004BD C3                  <1> 	retn
   690                              <1> 
   691                              <1> delay_100ms:
   692                              <1> 	; 11/11/2023
   693                              <1> 	; 29/05/2017
   694                              <1> 	; 24/03/2017 ('codec.asm')
   695                              <1> 	; wait 100 ms
   696 000004BE 51                  <1> 	push	cx
   697 000004BF B99001              <1> 	mov	cx, 400  ; 400*0.25ms
   698                              <1> _delay_x_ms:
   699 000004C2 E80915              <1> 	call	delay1_4ms
   700 000004C5 E2FB                <1>         loop	_delay_x_ms
   701 000004C7 59                  <1> 	pop	cx
   702 000004C8 C3                  <1> 	retn
   703                              <1> 
   704                              <1> %endif
   705                              <1> 
   706                              <1> ; 11/11/2023
   707                              <1> %if 0
   708                              <1> 
   709                              <1> codecConfig:
   710                              <1> 	; 06/11/2023
   711                              <1> 	; TUNELOOP version (playing without interrupt)
   712                              <1> 	; 04/11/2023
   713                              <1> 	; 17/02/2017 
   714                              <1> 	; 07/11/2016 (Erdogan Tan)
   715                              <1> 
   716                              <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   717                              <1> 
   718                              <1> 	mov    	dx, [NAMBAR]               	
   719                              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   720                              <1> 	out	dx, ax 				; out sample rate
   721                              <1> 		
   722                              <1> 	; 05/11/2023 temp
   723                              <1> 	;mov	dx, [NAMBAR]               	
   724                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   725                              <1> 	;out	dx, ax 
   726                              <1> 
   727                              <1>         call    delay1_4ms
   728                              <1>         call    delay1_4ms
   729                              <1>         call    delay1_4ms
   730                              <1>         call    delay1_4ms
   731                              <1> 
   732                              <1> 	mov	eax, [dev_vendor]
   733                              <1>         cmp	eax, (SI7012_DID<<16)+SIS_VID
   734                              <1>         jne	short cConfig1
   735                              <1> 
   736                              <1> 	; Unmute quirk specifically for the SiS7012
   737                              <1> 
   738                              <1> 	CUSTOM_SIS_7012_REG equ 4Ch ; SiS7012-specific register
   739                              <1> 	
   740                              <1>         mov     dx, [NABMBAR]
   741                              <1>         add     dx, CUSTOM_SIS_7012_REG
   742                              <1>         in      ax, dx
   743                              <1>         or	al, 1
   744                              <1>         out     dx, ax
   745                              <1> 
   746                              <1> cConfig1:
   747                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   748                              <1> 	; initial ac97 volumes (and clear mute flag)
   749                              <1> 		
   750                              <1>   	mov     dx, [NAMBAR]
   751                              <1>   	add     dx, CODEC_MASTER_VOL_REG        ;02h ; STEREO
   752                              <1>   	;xor	ax, ax ; volume attenuation = 0 (max. volume)
   753                              <1>   	; 03/11/2023
   754                              <1> 	mov	ax, 0202h
   755                              <1> 	out     dx, ax
   756                              <1> 
   757                              <1>         call    delay1_4ms	; delays because codecs are slow
   758                              <1>         call    delay1_4ms
   759                              <1>         call    delay1_4ms
   760                              <1>         call    delay1_4ms
   761                              <1>  
   762                              <1>   	mov     dx, [NAMBAR]
   763                              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h
   764                              <1>   	;;xor	ax, ax
   765                              <1> 	;mov	ax, 0202h
   766                              <1>   	out     dx, ax
   767                              <1> 
   768                              <1>         call    delay1_4ms
   769                              <1>         call    delay1_4ms
   770                              <1>         call    delay1_4ms
   771                              <1>         call    delay1_4ms
   772                              <1>  
   773                              <1> 	retn
   774                              <1> 
   775                              <1> %endif
   474                                  ;;%include 'ich_wav.asm' ; 17/02/2017 (ICH AC97 wav playing functions)
   475                                  ;%include 'ich_wav3.asm' ; 13/11/2023 (ICH AC97 wav playing functions)
   476                                  %include 'ich_wav5.asm' ; 18/11/2023 (ICH AC97 wav playing functions)
     1                              <1> ; 19/05/2024
     2                              <1> ; 19/11/2023
     3                              <1> ; 18/11/2023
     4                              <1> ; 17/11/2023
     5                              <1> ; 16/11/2023
     6                              <1> ; 15/11/2023
     7                              <1> ; 14/11/2023
     8                              <1> ; 13/11/2023
     9                              <1> ; 03/11/2023 - 11/11/2023
    10                              <1> ; DOS based .WAV player using AC'97 and codec interface.
    11                              <1> ; ---------------------------------------------------------------
    12                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    13                              <1> ; Last Update: 17/02/2017 (by Erdogan Tan)
    14                              <1> 
    15                              <1> ; AC97 interrupt version - 09/11/2023 - Erdogan Tan
    16                              <1> ; sample rate conversion version - 13/11/2023 - Erdogan Tan
    17                              <1> ; LVI interrupt version (instead of IOC) - 18/11/2023 - Erdogan Tan
    18                              <1> 
    19                              <1> ; ICHWAV.ASM
    20                              <1> 
    21                              <1> ; player internal variables and other equates.
    22                              <1> BUFFERSIZE      equ     64 * 1024       ; 64k file buffer size.
    23                              <1> ENDOFFILE       equ     BIT0            ; flag for knowing end of file
    24                              <1> 
    25                              <1> ;===========================================================================
    26                              <1> ; entry: none. File is already open and [filehandle] filled.
    27                              <1> ; exit:  not until the song is finished or the user aborts.
    28                              <1> ;
    29                              <1> playWav:
    30                              <1> 	; 13/11/2023
    31                              <1> 
    32 000004C9 803E[1303]01        <1> 	cmp	byte [VRA], 1
    33 000004CE 720F                <1> 	jb	short chk_sample_rate
    34                              <1> playwav_48_khz:	
    35 000004D0 C706[7F06][AB07]    <1> 	mov	word [loadfromwavfile], loadFromFile
    36                              <1> 	;mov	word [loadsize], 0 ; 65536
    37 000004D6 C706[8306]0080      <1> 	mov	word [buffersize], 32768 ; samples
    38 000004DC E9A801              <1> 	jmp	playWav_vra
    39                              <1> 
    40                              <1> chk_sample_rate:
    41                              <1> 	; set conversion parameters
    42                              <1> 	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
    43 000004DF A1[161E]            <1> 	mov	ax, [sample_rate]
    44 000004E2 3D80BB              <1> 	cmp	ax, 48000
    45 000004E5 74E9                <1> 	je	short playwav_48_khz
    46                              <1> chk_22khz:
    47 000004E7 3D2256              <1> 	cmp	ax, 22050
    48 000004EA 752F                <1> 	jne	short chk_11khz
    49 000004EC 803E[1A1E]08        <1> 	cmp	byte [bps], 8
    50 000004F1 760F                <1> 	jna	short chk_22khz_1
    51 000004F3 BB[F111]            <1> 	mov	bx, load_22khz_stereo_16_bit
    52 000004F6 803E[181E]01        <1> 	cmp	byte [stmo], 1 
    53 000004FB 7512                <1> 	jne	short chk_22khz_2
    54 000004FD BB[8811]            <1> 	mov	bx, load_22khz_mono_16_bit
    55 00000500 EB0D                <1> 	jmp	short chk_22khz_2
    56                              <1> chk_22khz_1:
    57 00000502 BB[2311]            <1> 	mov	bx, load_22khz_stereo_8_bit
    58 00000505 803E[181E]01        <1> 	cmp	byte [stmo], 1 
    59 0000050A 7503                <1> 	jne	short chk_22khz_2
    60 0000050C BB[BA10]            <1> 	mov	bx, load_22khz_mono_8_bit
    61                              <1> chk_22khz_2:
    62 0000050F B85A1D              <1> 	mov	ax, 7514  ; (442*17)
    63 00000512 BA2500              <1> 	mov	dx, 37
    64 00000515 B91100              <1> 	mov	cx, 17 
    65 00000518 E93301              <1> 	jmp	set_sizes	
    66                              <1> chk_11khz:
    67 0000051B 3D112B              <1> 	cmp	ax, 11025
    68 0000051E 752F                <1> 	jne	short chk_44khz
    69 00000520 803E[1A1E]08        <1> 	cmp	byte [bps], 8
    70 00000525 760F                <1> 	jna	short chk_11khz_1
    71 00000527 BB[8513]            <1> 	mov	bx, load_11khz_stereo_16_bit
    72 0000052A 803E[181E]01        <1> 	cmp	byte [stmo], 1 
    73 0000052F 7512                <1> 	jne	short chk_11khz_2
    74 00000531 BB[2A13]            <1> 	mov	bx, load_11khz_mono_16_bit
    75 00000534 EB0D                <1> 	jmp	short chk_11khz_2
    76                              <1> chk_11khz_1:
    77 00000536 BB[CF12]            <1> 	mov	bx, load_11khz_stereo_8_bit
    78 00000539 803E[181E]01        <1> 	cmp	byte [stmo], 1 
    79 0000053E 7503                <1> 	jne	short chk_11khz_2
    80 00000540 BB[7112]            <1> 	mov	bx, load_11khz_mono_8_bit
    81                              <1> chk_11khz_2:
    82 00000543 B8AD0E              <1> 	mov	ax, 3757  ; (221*17)
    83 00000546 BA4A00              <1> 	mov	dx, 74
    84 00000549 B91100              <1> 	mov	cx, 17
    85 0000054C E9FF00              <1> 	jmp	set_sizes 
    86                              <1> chk_44khz:
    87 0000054F 3D44AC              <1> 	cmp	ax, 44100
    88 00000552 752F                <1> 	jne	short chk_16khz
    89 00000554 803E[1A1E]08        <1> 	cmp	byte [bps], 8
    90 00000559 760F                <1> 	jna	short chk_44khz_1
    91 0000055B BB[3615]            <1> 	mov	bx, load_44khz_stereo_16_bit
    92 0000055E 803E[181E]01        <1> 	cmp	byte [stmo], 1 
    93 00000563 7512                <1> 	jne	short chk_44khz_2
    94 00000565 BB[DE14]            <1> 	mov	bx, load_44khz_mono_16_bit
    95 00000568 EB0D                <1> 	jmp	short chk_44khz_2
    96                              <1> chk_44khz_1:
    97 0000056A BB[8014]            <1> 	mov	bx, load_44khz_stereo_8_bit
    98 0000056D 803E[181E]01        <1> 	cmp	byte [stmo], 1 
    99 00000572 7503                <1> 	jne	short chk_44khz_2
   100 00000574 BB[2314]            <1> 	mov	bx, load_44khz_mono_8_bit
   101                              <1> chk_44khz_2:
   102                              <1> 	;mov	ax, 15065 ; (655*23)
   103                              <1> 	; 18/11/2023 ((file size + bss + stack) <= 64KB)
   104 00000577 B8FC36              <1> 	mov	ax, 14076 ; (612 *23)
   105 0000057A BA1900              <1> 	mov	dx, 25
   106 0000057D B91700              <1> 	mov	cx, 23
   107 00000580 E9CB00              <1> 	jmp	set_sizes 
   108                              <1> chk_16khz:
   109 00000583 3D803E              <1> 	cmp	ax, 16000
   110 00000586 752F                <1> 	jne	short chk_8khz
   111 00000588 803E[1A1E]08        <1> 	cmp	byte [bps], 8
   112 0000058D 760F                <1> 	jna	short chk_16khz_1
   113 0000058F BB[380D]            <1> 	mov	bx, load_16khz_stereo_16_bit
   114 00000592 803E[181E]01        <1> 	cmp	byte [stmo], 1 
   115 00000597 7512                <1> 	jne	short chk_16khz_2
   116 00000599 BB[D70C]            <1> 	mov	bx, load_16khz_mono_16_bit
   117 0000059C EB0D                <1> 	jmp	short chk_16khz_2
   118                              <1> chk_16khz_1:
   119 0000059E BB[470C]            <1> 	mov	bx, load_16khz_stereo_8_bit
   120 000005A1 803E[181E]01        <1> 	cmp	byte [stmo], 1 
   121 000005A6 7503                <1> 	jne	short chk_16khz_2
   122 000005A8 BB[E30B]            <1> 	mov	bx, load_16khz_mono_8_bit
   123                              <1> chk_16khz_2:
   124 000005AB B85515              <1> 	mov	ax, 5461
   125 000005AE BA0300              <1> 	mov	dx, 3
   126 000005B1 B90100              <1> 	mov	cx, 1
   127 000005B4 E99700              <1> 	jmp	set_sizes 
   128                              <1> chk_8khz:
   129 000005B7 3D401F              <1> 	cmp	ax, 8000
   130 000005BA 752E                <1> 	jne	short chk_24khz
   131 000005BC 803E[1A1E]08        <1> 	cmp	byte [bps], 8
   132 000005C1 760F                <1> 	jna	short chk_8khz_1
   133 000005C3 BB[FC0A]            <1> 	mov	bx, load_8khz_stereo_16_bit
   134 000005C6 803E[181E]01        <1> 	cmp	byte [stmo], 1 
   135 000005CB 7512                <1> 	jne	short chk_8khz_2
   136 000005CD BB[6B0A]            <1> 	mov	bx, load_8khz_mono_16_bit
   137 000005D0 EB0D                <1> 	jmp	short chk_8khz_2
   138                              <1> chk_8khz_1:
   139 000005D2 BB[7B09]            <1> 	mov	bx, load_8khz_stereo_8_bit
   140 000005D5 803E[181E]01        <1> 	cmp	byte [stmo], 1 
   141 000005DA 7503                <1> 	jne	short chk_8khz_2
   142 000005DC BB[C808]            <1> 	mov	bx, load_8khz_mono_8_bit
   143                              <1> chk_8khz_2:
   144 000005DF B8AA0A              <1> 	mov	ax, 2730
   145 000005E2 BA0600              <1> 	mov	dx, 6
   146 000005E5 B90100              <1> 	mov	cx, 1
   147 000005E8 EB64                <1> 	jmp	short set_sizes 
   148                              <1> chk_24khz:
   149 000005EA 3DC05D              <1> 	cmp	ax, 24000
   150 000005ED 752E                <1> 	jne	short chk_32khz
   151 000005EF 803E[1A1E]08        <1> 	cmp	byte [bps], 8
   152 000005F4 760F                <1> 	jna	short chk_24khz_1
   153 000005F6 BB[CD0E]            <1> 	mov	bx, load_24khz_stereo_16_bit
   154 000005F9 803E[181E]01        <1> 	cmp	byte [stmo], 1 
   155 000005FE 7512                <1> 	jne	short chk_24khz_2
   156 00000600 BB[840E]            <1> 	mov	bx, load_24khz_mono_16_bit
   157 00000603 EB0D                <1> 	jmp	short chk_24khz_2
   158                              <1> chk_24khz_1:
   159 00000605 BB[1C0E]            <1> 	mov	bx, load_24khz_stereo_8_bit
   160 00000608 803E[181E]01        <1> 	cmp	byte [stmo], 1 
   161 0000060D 7503                <1> 	jne	short chk_24khz_2
   162 0000060F BB[CD0D]            <1> 	mov	bx, load_24khz_mono_8_bit
   163                              <1> chk_24khz_2:
   164 00000612 B80020              <1> 	mov	ax, 8192
   165 00000615 BA0200              <1> 	mov	dx, 2
   166 00000618 B90100              <1> 	mov	cx, 1
   167 0000061B EB31                <1> 	jmp	short set_sizes 
   168                              <1> chk_32khz:
   169 0000061D 3D007D              <1> 	cmp	ax, 32000
   170 00000620 7556                <1> 	jne	short vra_needed
   171 00000622 803E[1A1E]08        <1> 	cmp	byte [bps], 8
   172 00000627 760F                <1> 	jna	short chk_32khz_1
   173 00000629 BB[4F10]            <1> 	mov	bx, load_32khz_stereo_16_bit
   174 0000062C 803E[181E]01        <1> 	cmp	byte [stmo], 1 
   175 00000631 7512                <1> 	jne	short chk_32khz_2
   176 00000633 BB[0210]            <1> 	mov	bx, load_32khz_mono_16_bit
   177 00000636 EB0D                <1> 	jmp	short chk_32khz_2
   178                              <1> chk_32khz_1:
   179 00000638 BB[8B0F]            <1> 	mov	bx, load_32khz_stereo_8_bit
   180 0000063B 803E[181E]01        <1> 	cmp	byte [stmo], 1 
   181 00000640 7503                <1> 	jne	short chk_32khz_2
   182 00000642 BB[330F]            <1> 	mov	bx, load_32khz_mono_8_bit
   183                              <1> chk_32khz_2:
   184 00000645 B8AA2A              <1> 	mov	ax, 10922
   185 00000648 BA0300              <1> 	mov	dx, 3
   186 0000064B B90200              <1> 	mov	cx, 2
   187                              <1> 	;jmp	short set_sizes 
   188                              <1> set_sizes:
   189 0000064E 803E[181E]01        <1> 	cmp	byte [stmo], 1
   190 00000653 7402                <1> 	je	short ss_1
   191 00000655 D1E0                <1> 	shl	ax, 1
   192                              <1> ss_1:
   193 00000657 803E[1A1E]08        <1> 	cmp	byte [bps], 8
   194 0000065C 7602                <1> 	jna	short ss_2
   195                              <1> 	; 16 bit samples
   196 0000065E D1E0                <1> 	shl	ax, 1
   197                              <1> ss_2:
   198 00000660 A3[8106]            <1> 	mov	[loadsize], ax
   199 00000663 F7E2                <1> 	mul	dx
   200                              <1> 	;cmp	cx, 1
   201                              <1> 	;je	short ss_3
   202                              <1> ;ss_3:
   203 00000665 F7F1                <1> 	div	cx
   204 00000667 8A0E[1C1E]          <1> 	mov	cl, [fbs_shift]
   205 0000066B D3E0                <1> 	shl	ax, cl
   206 0000066D D1E8                <1> 	shr	ax, 1	; buffer size is 16 bit sample count
   207 0000066F A3[8306]            <1> 	mov	[buffersize], ax 
   208 00000672 891E[7F06]          <1> 	mov	[loadfromwavfile], bx
   209 00000676 EB0F                <1> 	jmp	short playWav_vra
   210                              <1> 
   211                              <1> vra_needed:
   212                              <1> 	; 13/11/2023
   213 00000678 58                  <1> 	pop	ax ; discard return address to the caller
   214 00000679 BA[A21D]            <1> 	mov	dx, msg_no_vra
   215 0000067C E9D2FA              <1> 	jmp	vra_err
   216                              <1> 
   217                              <1> 	; 13/11/2023
   218                              <1> loadfromwavfile:
   219 0000067F [AB07]              <1> 	dw	loadFromFile
   220                              <1> loadsize:	; read from wav file
   221 00000681 0000                <1> 	dw	0
   222                              <1> buffersize:	; write to DMA buffer
   223 00000683 00800000            <1> 	dd	32768 ; 16 bit samples (not bytes)
   224                              <1> 
   225                              <1> playWav_vra:
   226                              <1> 	; 07/11/2023
   227                              <1> 	; clear buffer 2
   228                              <1>         ;push	es
   229                              <1> 	;mov	ax, [WAV_BUFFER2]
   230                              <1> 	;mov	es, ax
   231                              <1> 	;sub	ax, ax
   232                              <1> 	;mov	di, ax ; 17/02/2017
   233                              <1> 	;mov	cx, (BUFFERSIZE/2)
   234                              <1> 	;rep	stosw
   235                              <1> 	;pop	es	     
   236                              <1> 	
   237                              <1> 	; load 64k into buffer 1
   238 00000687 A1[0A1E]            <1>         mov     ax, [WAV_BUFFER1]
   239                              <1>         ;call	loadFromFile
   240                              <1> 	; 13/11/2023
   241 0000068A FF16[7F06]          <1> 	call	word [loadfromwavfile]
   242                              <1> 
   243                              <1> 	; and 64k into buffer 2
   244 0000068E A1[0C1E]            <1> 	mov     ax, [WAV_BUFFER2]
   245                              <1>        	;call	loadFromFile
   246                              <1> 	; 13/11/2023
   247 00000691 FF16[7F06]          <1> 	call	word [loadfromwavfile]
   248                              <1> 
   249                              <1> ; register reset the DMA engine. This may cause a pop noise on the output
   250                              <1> ; lines when the device is reset. Prolly a better idea to mute output, then
   251                              <1> ; reset.
   252                              <1> 
   253                              <1> 	; 11/11/2023
   254                              <1>         ;mov	dx, [NABMBAR]
   255                              <1>         ;add	dx, PO_CR_REG		; set pointer to Ctrl reg
   256                              <1>         ;mov	al, RR			; set reset
   257                              <1> 	;out	dx, al			; self clearing bit
   258                              <1> 
   259                              <1> ; write last valid index to 31 to start with.
   260                              <1> ; The Last Valid Index register tells the DMA engine when to stop playing.
   261                              <1> ; 
   262                              <1> ; As we progress through the song we change the last valid index to always be
   263                              <1> ; something other than the index we're currently playing.  
   264                              <1> ;
   265                              <1> 	; 08/11/2023
   266                              <1> 	;; 07/11/2023
   267                              <1> 	;mov	al, 1
   268                              <1>         ;;mov	al, 31
   269                              <1> 	;call	setLastValidIndex
   270                              <1> 
   271                              <1> ; create Buffer Descriptor List
   272                              <1> ;
   273                              <1> ; A buffer descriptor list is a list of pointers and control bits that the
   274                              <1> ; DMA engine uses to know where to get the .wav data and how to play it.
   275                              <1> ;
   276                              <1> ; I set it up to use only 2 buffers of .wav data, and whenever 1 buffer is
   277                              <1> ; playing, I refresh the other one with good data.
   278                              <1> ;
   279                              <1> ;
   280                              <1> ; For the control bits, you can specify that the DMA engine fire an interrupt
   281                              <1> ; after a buffer has been processed, but I poll the current index register
   282                              <1> ; to know when it's safe to update the other buffer.
   283                              <1> ;
   284                              <1> ; I set the BUP bit, which tells the DMA engine to just play 0's (silence)
   285                              <1> ; if it ever runs out of data to play. Good for safety.
   286                              <1> ;
   287 00000695 06                  <1>         push    es
   288 00000696 A1[081E]            <1>         mov     ax, [BDL_BUFFER]		; get segment # for BDL
   289 00000699 8EC0                <1>         mov     es, ax
   290                              <1> 
   291 0000069B B91000              <1>         mov     cx, 32 / 2                      ; make 32 entries in BDL
   292 0000069E 31FF                <1>         xor     di, di                          
   293                              <1> _0:
   294                              <1> 
   295                              <1> ; set buffer descriptor 0 to start of data file in memory
   296 000006A0 660FB706[0A1E]      <1>         movzx   eax, word [WAV_BUFFER1]
   297 000006A6 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   298 000006AA 66AB                <1>         stosd                                   ; store pointer to wavbuffer1
   299                              <1> 
   300                              <1> ;
   301                              <1> ; set length to 32k samples. 1 sample is 16bits or 2bytes.
   302                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples.
   303                              <1> ; 
   304                              <1> 
   305                              <1> ; 17/02/2017 (Erdogan Tan)
   306                              <1> ; Intel 82801AA (ICH) & Intel 82801AB (ICH0) I/O Controller Hub AC97
   307                              <1> ; Programmers Reference Manual
   308                              <1> 
   309                              <1> ; 2.2.1 Buffer Descriptor List  (on Page 13)
   310                              <1> 	;
   311                              <1> 	;  Generic Form of Buffer Descriptor
   312                              <1> 	;  ---------------------------------
   313                              <1> 	;  63   62    61-48    47-32   31-0
   314                              <1> 	;  ---  ---  --------  ------- -----
   315                              <1> 	;  IOC  BUP -reserved- Buffer  Buffer
   316                              <1> 	;		      Length   Pointer
   317                              <1> 	;		      [15:0]   [31:0]
   318                              <1> 	;
   319                              <1> 	;  IOC:	Interrupt On Completion. 
   320                              <1> 	;	1 = Enabled. 
   321                              <1> 	;	    When this is set, it means that the controller should
   322                              <1> 	;	    issue an interrupt upon completion of this buffer.
   323                              <1> 	;	    It should also set the IOC bit in the status register
   324                              <1> 	;	0 = Disabled	
   325                              <1> 	;
   326                              <1> 	;  BUP: Buffer Underrun Policy.
   327                              <1> 	;       0 = When this buffer is complete,
   328                              <1> 	;	    if the next buffer is not yet ready 
   329                              <1> 	;	    (i.e., the last valid buffer has been processed),
   330                              <1> 	;	    then continue to transmit the last valid sample.
   331                              <1> 	;	1 = When this buffer is complete,
   332                              <1> 	;     	    if this is the last valid buffer, transmit zeros after
   333                              <1> 	;	    this buffer has been processed completely.
   334                              <1> 	;	    This bit typically is set only if this is the last 
   335                              <1> 	;	    buffer in the current stream.
   336                              <1> 	;
   337                              <1> 	; [31:0]: Buffer pointer. This field points to the location of
   338                              <1> 	;	  the data buffer. Since samples can be as wide as one
   339                              <1> 	;	  word, the buffer must be aligned with word boundaries,
   340                              <1> 	;	  to prevent samples from straddling DWord boundaries.
   341                              <1> 	;
   342                              <1> 	; [15:0]: Buffer Length: This is the length of the data buffer,
   343                              <1> 	;	  in number of samples. The controller uses this data
   344                              <1> 	;	  to determine the length of the buffer, in bytes.
   345                              <1> 	;	  "0" indicates no sample to process.
   346                              <1> 
   347                              <1> ; ICH2AC97.INC
   348                              <1> 
   349                              <1> ;	IOC	equ     BIT31   ; Fire an interrupt whenever this
   350                              <1> 				; buffer is complete.
   351                              <1> 
   352                              <1> ;	BUP	equ     BIT30   ; Buffer Underrun Policy.
   353                              <1> 				; if this buffer is the last buffer
   354                              <1> 				; in a playback, fill the remaining
   355                              <1> 				; samples with 0 (silence) or not.
   356                              <1> 				; It's a good idea to set this to 1
   357                              <1> 				; for the last buffer in playback,
   358                              <1> 				; otherwise you're likely to get a lot
   359                              <1> 				; of noise at the end of the sound.
   360                              <1> ;
   361                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   362                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   363                              <1> ; Luckily for us, that's the same format as .wav files.
   364                              <1> ;
   365                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   366                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   367                              <1> ;
   368                              <1> ; A value of 0 in these bits means play no samples.
   369                              <1> ;
   370                              <1> 
   371                              <1> ; ICHWAV.ASM
   372                              <1> 				    ; 19/05/2024
   373                              <1> 	;mov	eax, BUFFERSIZE / 2 ; size of buffer (32K) in (16bit) words
   374                              <1> 	; 13/11/2023
   375 000006AC 66A1[8306]          <1> 	mov	eax, [buffersize]
   376                              <1> 
   377                              <1> 	; 18/11/2023
   378                              <1> 	; 09/11/2023
   379                              <1> 	;or	eax, IOC + BUP
   380                              <1> 	; 06/11/2023
   381 000006B0 660D00000040        <1> 	or	eax, BUP
   382 000006B6 66AB                <1> 	stosd
   383                              <1> 
   384                              <1> ; 2nd buffer:
   385                              <1> 
   386 000006B8 660FB706[0C1E]      <1>         movzx   eax, word [WAV_BUFFER2]
   387 000006BE 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   388 000006C2 66AB                <1>         stosd                                   ; store pointer to wavbuffer2
   389                              <1> 
   390                              <1> ; set length to 64k (32k of two 16 bit samples)
   391                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples
   392                              <1> ; 
   393                              <1> 	;mov	eax, BUFFERSIZE / 2
   394                              <1> 	; 13/11/2023
   395 000006C4 66A1[8306]          <1> 	mov	eax, [buffersize]
   396                              <1> 
   397                              <1> 	; 18/11/2023
   398                              <1> 	; 09/11/2023
   399                              <1> 	;or	eax, IOC + BUP
   400                              <1> 	; 06/11/2023
   401 000006C8 660D00000040        <1> 	or	eax, BUP
   402 000006CE 66AB                <1> 	stosd
   403                              <1> 
   404 000006D0 E2CE                <1>         loop    _0
   405 000006D2 07                  <1>         pop     es
   406                              <1> 
   407                              <1> ;
   408                              <1> ; tell the DMA engine where to find our list of Buffer Descriptors.
   409                              <1> ; this 32bit value is a flat mode memory offset (ie no segment:offset)
   410                              <1> ;
   411                              <1> ; write NABMBAR+10h with offset of buffer descriptor list
   412                              <1> ;
   413 000006D3 660FB706[081E]      <1>         movzx   eax, word [BDL_BUFFER]
   414 000006D9 66C1E004            <1> 	shl     eax, 4                          ; convert seg:off to 0:off
   415 000006DD 8B16[061E]          <1>         mov     dx, [NABMBAR]
   416 000006E1 83C210              <1>         add     dx, PO_BDBAR_REG                ; set pointer to BDL
   417 000006E4 66EF                <1>         out     dx, eax                         ; write to AC97 controller
   418                              <1> 
   419                              <1> 	; 19/05/2024
   420 000006E6 E8E512              <1> 	call	delay1_4ms
   421                              <1> 
   422                              <1> ;
   423                              <1> ; All set. Let's play some music.
   424                              <1> ;
   425                              <1> 
   426                              <1> 	; 18/11/2023
   427                              <1> 	; 10/11/2023
   428                              <1> 	; 08/11/2023
   429                              <1> 	; 07/11/2023
   430                              <1> 	; 08/12/2016
   431                              <1> 	; 07/10/2016
   432 000006E9 B001                <1> 	mov	al, 1	; 18/11/2023
   433                              <1> 	;mov	al, 31
   434 000006EB A2[1E1E]            <1> 	mov	[LVI], al ; 10/11/2023
   435 000006EE E88701              <1> 	call	setLastValidIndex
   436                              <1> 
   437                              <1> 	; 06/11/2023 (not neccessary)
   438                              <1> 	;; 05/11/2023
   439                              <1> 	;; reset current index
   440                              <1> 	;mov	al, 0
   441                              <1> 	;call	setCurrentIndex
   442                              <1> 
   443                              <1> 	; 06/11/2023
   444                              <1> 	;mov	byte [tLoop], 1 ; 30/11/2016
   445                              <1> 
   446                              <1> 	; 19/05/2024
   447 000006F1 E8DA12              <1> 	call	delay1_4ms
   448                              <1> 
   449                              <1> 	; 17/02/2017
   450 000006F4 8B16[061E]          <1>         mov     dx, [NABMBAR]
   451 000006F8 83C21B              <1>         add     dx, PO_CR_REG                   ; PCM out Control Register
   452                              <1>         ; 18/11/2023
   453 000006FB B005                <1> 	mov	al, LVBIE + RPBM ; Enable LVBI interrupt and run bus master
   454                              <1> 	; 09/11/2023
   455                              <1> 	;mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
   456                              <1> 	;			; (LVBI interrupt will not be enabled)
   457                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   458                              <1> 	;mov	al, RPBM
   459 000006FD EE                  <1> 	out     dx, al                          ; Start bus master operation.
   460                              <1> 
   461                              <1> 	; 09/11/2023
   462 000006FE C606[1D1E]3F        <1> 	mov	byte [b_indicator], '?'	
   463                              <1> 
   464                              <1> 	; 19/05/2024
   465                              <1> 	; 06/11/2023
   466 00000703 E8C812              <1> 	call	delay1_4ms
   467 00000706 E8C512              <1> 	call	delay1_4ms
   468 00000709 E8C212              <1> 	call	delay1_4ms
   469 0000070C E8BF12              <1> 	call	delay1_4ms
   470                              <1> 
   471                              <1> 	; 10/11/2023
   472                              <1> 	;mov	byte [tloop], 1
   473                              <1> 
   474                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   475                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   476                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   477                              <1> 
   478                              <1> ; 09/11/2023   
   479                              <1> ; 06/11/2023
   480                              <1> %if 1
   481                              <1> 	; 08/12/2016
   482                              <1> 	; 28/11/2016
   483                              <1> p_loop:
   484 0000070F E87201              <1> 	call    check4keyboardstop ; keyboard halt?
   485 00000712 732A                <1>         jnc	short r_loop 	   ; no ; 09/11/2023
   486                              <1> 
   487                              <1> 	; 09/11/2023
   488                              <1> 	;or	byte [flags], ENDOFFILE
   489                              <1> 	;mov	byte [b_indicator], '0'
   490                              <1> q_loop:
   491                              <1> 	;mov	al, '0'
   492 00000714 E88600              <1> 	call	tL0
   493                              <1> 
   494                              <1> 	; 04/11/2023
   495                              <1> 	; finished with song, stop everything
   496 00000717 E8A614              <1> 	call	ac97_stop
   497                              <1> 
   498                              <1> 	; 11/11/2023
   499                              <1> irq_restore:	
   500                              <1> 	; restore previous interrupt vector and interrupt_status
   501 0000071A FA                  <1> 	cli
   502 0000071B E4A1                <1> 	in	al, 0A1h ; irq 8-15
   503 0000071D A0[FF1D]            <1> 	mov	al, [IRQ_status+1]
   504 00000720 E6A1                <1> 	out	0A1h, al 
   505 00000722 E421                <1> 	in	al, 021h ; irq 0-7
   506 00000724 A0[FE1D]            <1> 	mov	al, [IRQ_status]
   507 00000727 E621                <1> 	out	21h, al 
   508                              <1> 	; ...
   509 00000729 06                  <1> 	push	es
   510 0000072A 31C0                <1> 	xor	ax, ax
   511 0000072C 8EC0                <1> 	mov	es, ax
   512 0000072E A1[001E]            <1> 	mov	ax, [IRQ_vector]
   513 00000731 268907              <1> 	mov	[es:bx], ax
   514 00000734 A1[021E]            <1> 	mov	ax, [IRQ_vector+2]
   515 00000737 26894702            <1> 	mov	[es:bx+2], ax
   516 0000073B 07                  <1> 	pop	es
   517 0000073C FB                  <1> 	sti
   518 0000073D C3                  <1> 	retn
   519                              <1> 
   520                              <1> r_loop:
   521                              <1> 	; 19/05/2024
   522                              <1> 	; 10/11/2023
   523 0000073E 90                  <1> 	nop
   524 0000073F 90                  <1> 	nop
   525 00000740 90                  <1> 	nop
   526                              <1> 
   527                              <1> 	; 11/11/2023	
   528 00000741 B030                <1> 	mov	al, '0'
   529 00000743 803E[FD1D]00        <1> 	cmp	byte [tloop], 0
   530 00000748 74C5                <1> 	je	short p_loop
   531 0000074A 7CC8                <1> 	jl	short q_loop
   532                              <1> 
   533 0000074C FE0E[FD1D]          <1> 	dec	byte [tloop] ; 0
   534                              <1> 
   535 00000750 803E[1D1E]31        <1> 	cmp	byte [b_indicator], '1' ; will be played
   536 00000755 7515                <1> 	jne	short s_loop
   537                              <1> 	
   538                              <1> 	; 19/11/2023
   539                              <1> 	; load buffer 1
   540 00000757 A1[0A1E]            <1> 	mov	ax, [WAV_BUFFER1] ; will be played
   541                              <1> u_loop:
   542                              <1> 	;call	loadFromFile
   543                              <1> 	; 13/11/2023
   544 0000075A FF16[7F06]          <1> 	call	word [loadfromwavfile]
   545 0000075E 7304                <1> 	jnc	short v_loop
   546                              <1> 	
   547                              <1> 	; 19/11/2023
   548                              <1> 	;cmp	byte [tloop], -1
   549                              <1> 	;jne	short v_loop
   550                              <1> 	
   551 00000760 B030                <1> 	mov	al, '0'
   552 00000762 EBB0                <1> 	jmp	short q_loop
   553                              <1> v_loop:
   554                              <1> 	; 09/11/2023 - Erdogan Tan
   555                              <1> 	; (print buffer number on top left of the screen)
   556 00000764 A0[1D1E]            <1> 	mov	al, [b_indicator] ; going to be played
   557 00000767 E83300              <1> 	call	tL0
   558 0000076A EBA3                <1> 	jmp	short p_loop
   559                              <1> s_loop:
   560                              <1> 	; load buffer 2
   561 0000076C A1[0C1E]            <1> 	mov	ax, [WAV_BUFFER2] ; will be played
   562 0000076F EBE9                <1> 	jmp	short u_loop
   563                              <1> 
   564                              <1> %endif
   565                              <1> 
   566                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   567                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   568                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   569                              <1> 
   570                              <1> ; 18/11/2023
   571                              <1> %if 1
   572                              <1> 
   573                              <1> tuneLoop:
   574                              <1> 	; 19/11/2023
   575                              <1> 	; 18/11/2023
   576 00000771 F606[FA1D]01        <1> 	test	byte [flags], ENDOFFILE
   577 00000776 751E                <1> 	jnz	short tL3
   578                              <1> 
   579                              <1> 	; 19/11/2023
   580 00000778 C606[FD1D]01        <1> 	mov	byte [tloop], 1
   581                              <1> 	
   582                              <1> 	; set LVI to the next
   583                              <1> 	; (and then load audio data in that buffer) 
   584 0000077D A0[1E1E]            <1> 	mov	al, [LVI]
   585 00000780 40                  <1> 	inc	ax
   586 00000781 241F                <1> 	and	al, 1Fh 
   587 00000783 E8F200              <1> 	call	setLastValidIndex
   588                              <1> 	;mov	[LVI], al
   589                              <1> tL1:
   590                              <1> 	; al = next buffer index (not for the buffer being played)
   591 00000786 A801                <1> 	test	al, BIT0
   592 00000788 7506                <1> 	jnz	short tL2
   593                              <1> 
   594                              <1> 	; 19/11/2023
   595                              <1> 	; load buffer 1
   596                              <1> 	;mov	ax, [WAV_BUFFER1] ; will be played
   597                              <1> 	;call	word [loadfromwavfile]
   598                              <1> 	;jc	short tL3
   599                              <1> 
   600 0000078A C606[1D1E]31        <1> 	mov	byte [b_indicator], '1'
   601 0000078F C3                  <1> 	retn
   602                              <1> tL2:	
   603                              <1> 	; 19/11/2023
   604                              <1> 	; load buffer 2
   605                              <1> 	;mov	ax, [WAV_BUFFER2] ; will be played
   606                              <1> 	;call	word [loadfromwavfile]
   607                              <1> 	;jc	short tL3
   608                              <1> 
   609 00000790 C606[1D1E]32        <1> 	mov	byte [b_indicator], '2'
   610 00000795 C3                  <1> 	retn
   611                              <1> tL3:
   612 00000796 C606[FD1D]FF        <1> 	mov	byte [tloop], -1
   613 0000079B F9                  <1> 	stc
   614 0000079C C3                  <1> 	retn
   615                              <1> 
   616                              <1> 	; 18/11/2023
   617                              <1> tL0:
   618                              <1> 	; al = buffer indicator ('1', '2' or '0' -stop- )
   619 0000079D 1E                  <1> 	push	ds
   620                              <1> 	;push	bx 
   621 0000079E BB00B8              <1> 	mov	bx, 0B800h ; video display page segment
   622 000007A1 8EDB                <1> 	mov	ds, bx
   623 000007A3 29DB                <1> 	sub	bx, bx ; 0
   624 000007A5 B44E                <1> 	mov	ah, 4Eh
   625 000007A7 8907                <1> 	mov	[bx], ax ; show current play buffer (1, 2)
   626                              <1> 	;pop	bx
   627 000007A9 1F                  <1> 	pop	ds
   628 000007AA C3                  <1> 	retn
   629                              <1> 
   630                              <1> %endif
   631                              <1> 
   632                              <1> ; 11/11/2023
   633                              <1> ; 10/11/2023
   634                              <1> ; 09/11/2023
   635                              <1> ; 08/11/2023
   636                              <1> ; 07/11/2023
   637                              <1> %if 0	; 18/11/2023
   638                              <1> 
   639                              <1> tuneLoop:
   640                              <1> 	; 11/11/2023
   641                              <1> 	; 10/11/2023
   642                              <1> 	; 09/11/2023
   643                              <1> 	; 08/11/2023
   644                              <1> 	; 06/11/2023
   645                              <1> 	;mov	al, '1'
   646                              <1> 	;call	tL0
   647                              <1> tL1:
   648                              <1> 	; 10/11/2023
   649                              <1> 	;mov	byte [tloop], 1
   650                              <1> 
   651                              <1> 	; 11/11/2023
   652                              <1> 	;call    updateLVI	; set LVI != CIV
   653                              <1> 	;jz	short tL4	
   654                              <1> 
   655                              <1> 	; 11/11/2023
   656                              <1> 	mov	byte [tloop], 1
   657                              <1> 
   658                              <1> 	call    getCurrentIndex
   659                              <1> 
   660                              <1> 	; 10/11/2023
   661                              <1> 	cmp	al, [LVI]
   662                              <1> 	jne	short tL2
   663                              <1> 
   664                              <1> 	test	byte [flags], ENDOFFILE
   665                              <1> 	;jnz	short tL2
   666                              <1> 	jnz	short tL4
   667                              <1> 
   668                              <1> 	dec	ax
   669                              <1> 	and	al, 1Fh 
   670                              <1> 	call	setLastValidIndex	
   671                              <1> 	xchg	al, [LVI]
   672                              <1> tL2:
   673                              <1> 	test	al, BIT0
   674                              <1> 	jz	short tL3
   675                              <1> 
   676                              <1> 	mov	byte [b_indicator], '1'
   677                              <1> 	retn
   678                              <1> tL3:	
   679                              <1> 	mov	byte [b_indicator], '2'
   680                              <1> 	retn
   681                              <1> tL4:
   682                              <1> 	; 11/11/2023
   683                              <1> 	mov	byte [tloop], -1
   684                              <1> 	stc
   685                              <1> 	retn
   686                              <1> 
   687                              <1> 	; 06/11/2023
   688                              <1> tL0:
   689                              <1> 	; 08/11/2023
   690                              <1> 	; 05/11/2023
   691                              <1> 	; 17/02/2017 - Buffer switch test (temporary)
   692                              <1> 	; 06/11/2023
   693                              <1> 	; al = buffer indicator ('1', '2' or '0' -stop- )
   694                              <1> 	push	ds
   695                              <1> 	;push	bx 
   696                              <1> 	mov	bx, 0B800h ; video display page segment
   697                              <1> 	mov	ds, bx
   698                              <1> 	sub	bx, bx ; 0
   699                              <1> 	mov	ah, 4Eh
   700                              <1> 	mov	[bx], ax ; show current play buffer (1, 2)
   701                              <1> 	;pop	bx
   702                              <1> 	pop	ds
   703                              <1> 	retn
   704                              <1> 
   705                              <1> %endif
   706                              <1> 
   707                              <1> ; 08/11/2023
   708                              <1> ; 07/11/2023
   709                              <1> %if 1
   710                              <1> 
   711                              <1> loadFromFile:
   712                              <1> 	; 07/11/2023
   713                              <1> 
   714 000007AB F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
   715                              <1> 					; last of the file?
   716 000007B0 7402                <1> 	jz	short lff_0		; no
   717 000007B2 F9                  <1> 	stc
   718 000007B3 C3                  <1> 	retn
   719                              <1> 
   720                              <1> lff_0:
   721                              <1> 	; 08/11/2023
   722 000007B4 89C5                <1> 	mov	bp, ax ; save buffer segment	
   723                              <1> 
   724 000007B6 8A0E[1C1E]          <1> 	mov	cl, [fbs_shift]   
   725 000007BA 20C9                <1> 	and	cl, cl
   726 000007BC 7470                <1> 	jz	short lff_1 ; stereo, 16 bit	
   727                              <1> 
   728 000007BE BFFFFF              <1> 	mov	di, BUFFERSIZE - 1 ; 65535
   729                              <1> 
   730                              <1> 	; fbs_shift =
   731                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   732                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   733 000007C1 D3EF                <1> 	shr	di, cl
   734 000007C3 47                  <1> 	inc	di ; 16384 for 8 bit and mono	
   735                              <1> 		   ; 32768 for 8 bit or mono	
   736                              <1> 
   737 000007C4 8CC8                <1> 	mov	ax, cs
   738 000007C6 BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   739                              <1> 
   740                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   741                              <1> 	; load file into memory
   742 000007C9 89F9                <1>         mov	cx, di                       
   743 000007CB 8B1E[F81D]          <1> 	mov	bx, [filehandle]
   744 000007CF 8ED8                <1> 	mov     ds, ax
   745 000007D1 B43F                <1>        	mov	ah, 3Fh
   746 000007D3 CD21                <1> 	int	21h
   747                              <1> 
   748 000007D5 8CCB                <1> 	mov	bx, cs
   749 000007D7 8EDB                <1> 	mov	ds, bx
   750                              <1> 
   751 000007D9 724A                <1> 	jc	short lff_4 ; error !
   752                              <1> 
   753                              <1> 	; 08/11/2023
   754 000007DB 31D2                <1> 	xor	dx, dx ; 0
   755                              <1> 
   756 000007DD 21C0                <1> 	and	ax, ax
   757 000007DF 7476                <1> 	jz	short lff_3
   758                              <1> 
   759 000007E1 8A1E[1C1E]          <1> 	mov	bl, [fbs_shift]
   760                              <1> 
   761 000007E5 06                  <1> 	push	es
   762 000007E6 89D7                <1> 	mov	di, dx ; 0 ; [fbs_off]
   763                              <1> 	;mov	bp, [fbs_seg] ; buffer segment
   764 000007E8 8EC5                <1> 	mov	es, bp
   765 000007EA BE[201E]            <1> 	mov	si, temp_buffer ; temporary buffer address
   766 000007ED 89C1                <1> 	mov	cx, ax ; byte count
   767 000007EF 803E[1A1E]08        <1> 	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   768 000007F4 751B                <1> 	jne	short lff_7 ; 16 bit samples
   769                              <1> 	; 8 bit samples
   770 000007F6 FECB                <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   771 000007F8 740C                <1> 	jz	short lff_6 ; 8 bit, stereo
   772                              <1> lff_5:
   773                              <1> 	; mono & 8 bit
   774 000007FA AC                  <1> 	lodsb
   775 000007FB 2C80                <1> 	sub	al, 80h ; 08/11/2023
   776 000007FD C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   777 00000800 AB                  <1> 	stosw	; left channel
   778 00000801 AB                  <1> 	stosw	; right channel
   779 00000802 E2F6                <1> 	loop	lff_5
   780 00000804 EB12                <1> 	jmp	short lff_9	
   781                              <1> lff_6:
   782                              <1> 	; stereo & 8 bit
   783 00000806 AC                  <1> 	lodsb
   784 00000807 2C80                <1> 	sub	al, 80h ; 08/11/2023
   785 00000809 C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   786 0000080C AB                  <1> 	stosw
   787 0000080D E2F7                <1> 	loop	lff_6			
   788 0000080F EB07                <1> 	jmp	short lff_9
   789                              <1> lff_7:
   790 00000811 D1E9                <1> 	shr	cx, 1 ; word count
   791                              <1> lff_8:
   792 00000813 AD                  <1> 	lodsw
   793 00000814 AB                  <1> 	stosw	; left channel
   794 00000815 AB                  <1> 	stosw	; right channel
   795 00000816 E2FB                <1> 	loop	lff_8
   796                              <1> lff_9:
   797 00000818 07                  <1> 	pop	es
   798 00000819 09FF                <1> 	or	di, di
   799 0000081B 7442                <1> 	jz	short endLFF ; 64KB ok 
   800                              <1> 	
   801 0000081D 89F8                <1> 	mov	ax, di ; [fbs_off]
   802 0000081F 48                  <1> 	dec	ax
   803 00000820 B9FFFF              <1> 	mov	cx, BUFFERSIZE - 1 ; 65535
   804 00000823 EB32                <1> 	jmp	short lff_3
   805                              <1> 
   806                              <1> lff_4:
   807                              <1> 	; 08/11/2023
   808 00000825 B021                <1> 	mov	al, '!'  ; error
   809 00000827 E873FF              <1> 	call	tL0
   810                              <1> 
   811 0000082A 31C0                <1> 	xor	ax, ax
   812 0000082C EB29                <1> 	jmp	short lff_3
   813                              <1> 	
   814                              <1> lff_1:  
   815                              <1> 	;mov	bp, ax ; save buffer segment
   816 0000082E 31D2                <1> 	xor	dx, dx
   817                              <1> 	; load file into memory
   818 00000830 B90080              <1>         mov	cx, (BUFFERSIZE / 2)	; 32k chunk
   819 00000833 8B1E[F81D]          <1> 	mov	bx, [filehandle]
   820 00000837 8ED8                <1> 	mov     ds, ax
   821 00000839 B43F                <1>        	mov	ah, 3Fh
   822 0000083B CD21                <1> 	int	21h
   823                              <1> 
   824 0000083D 8CCF                <1> 	mov	di, cs
   825 0000083F 8EDF                <1> 	mov	ds, di
   826                              <1> 
   827                              <1> 	; 07/11/2023
   828 00000841 72E2                <1> 	jc	short lff_4 ; error !
   829                              <1> 	
   830 00000843 39C8                <1> 	cmp	ax, cx
   831 00000845 7510                <1> 	jne	short lff_3
   832                              <1> lff_2:
   833                              <1> 	; 08/11/2023
   834 00000847 01C2                <1> 	add	dx, ax
   835                              <1> 	;mov	cx, (BUFFERSIZE / 2)	; 32k chunk
   836                              <1> 	;mov	bx, [filehandle]
   837 00000849 8EDD                <1> 	mov     ds, bp
   838 0000084B B43F                <1>        	mov	ah, 3Fh
   839 0000084D CD21                <1> 	int	21h
   840                              <1> 
   841                              <1> 	;mov	di, cs
   842 0000084F 8EDF                <1> 	mov	ds, di
   843                              <1> 
   844 00000851 72D2                <1> 	jc	short lff_4 ; error !
   845                              <1> 
   846 00000853 39C8                <1> 	cmp	ax, cx
   847 00000855 7408                <1> 	je	short endLFF
   848                              <1> lff_3:
   849 00000857 E80600              <1> 	call    padfill			; blank pad the remainder
   850                              <1>         ;clc				; don't exit with CY yet.
   851 0000085A 800E[FA1D]01        <1>         or	byte [flags], ENDOFFILE	; end of file flag
   852                              <1> endLFF:
   853 0000085F C3                  <1>         retn
   854                              <1> 
   855                              <1> %endif
   856                              <1> 
   857                              <1> ; entry ds:ax points to last byte in file
   858                              <1> ; cx=target size
   859                              <1> ; note: must do byte size fill
   860                              <1> ; destroys bx, cx
   861                              <1> ;
   862                              <1> padfill:
   863                              <1> 	; 07/11/2023
   864                              <1> 	; 06/11/2023
   865                              <1> 	; 17/02/2017
   866 00000860 06                  <1> 	push	es
   867                              <1>         ;push	di
   868                              <1> 	;mov	di, [fbs_seg]
   869                              <1> 	;mov	es, di
   870 00000861 8EC5                <1>         mov	es, bp
   871 00000863 29C1                <1> 	sub	cx, ax
   872                              <1> 	; 08/11/2023
   873                              <1> 	;mov	di, ax ; (wrong)
   874 00000865 89D7                <1> 	mov	di, dx ; buffer offset
   875 00000867 01C7                <1> 	add	di, ax       	
   876                              <1> 	; 07/11/2023
   877                              <1> 	;add	di, [fbs_off]
   878 00000869 30C0                <1>         xor	al, al
   879 0000086B F3AA                <1> 	rep	stosb
   880                              <1> 	;mov	[fbs_off], di
   881                              <1> 	;pop	di
   882 0000086D 07                  <1>         pop	es
   883 0000086E C3                  <1> 	retn
   884                              <1> 
   885                              <1> ; returns AL = current index value
   886                              <1> getCurrentIndex:
   887                              <1> 	; 08/11/2023
   888                              <1> 	;push	dx
   889 0000086F 8B16[061E]          <1> 	mov	dx, [NABMBAR]      		
   890 00000873 83C214              <1> 	add	dx, PO_CIV_REG
   891 00000876 EC                  <1> 	in	al, dx
   892                              <1> 	;pop	dx
   893                              <1> uLVI2:	;	06/11/2023
   894 00000877 C3                  <1> 	retn
   895                              <1> 
   896                              <1> ; examines the CIV and the LVI. When they're the same, we set LVI <> CIV
   897                              <1> ; that way, we never run out of buffers to play
   898                              <1> 
   899                              <1> ; 08/11/2023
   900                              <1> ; 07/11/2023
   901                              <1> %if 0
   902                              <1> updateLVI:
   903                              <1> 	; 06/11/2023
   904                              <1> 	mov	dx, [NABMBAR]      		
   905                              <1> 	add	dx, PO_CIV_REG
   906                              <1> 	; (Current Index Value and Last Valid Index value)
   907                              <1> 	in	ax, dx
   908                              <1> 
   909                              <1> 	cmp	al, ah ; is current index = last index ?
   910                              <1> 	jne	short uLVI2
   911                              <1> 
   912                              <1> 	; 10/11/2023
   913                              <1> 	; 08/11/2023	
   914                              <1> 	call	getCurrentIndex
   915                              <1>  
   916                              <1> 	test	byte [flags], ENDOFFILE
   917                              <1> 	;jnz	short uLVI1
   918                              <1> 	jz	short uLVI0  ; 08/11/2023
   919                              <1> 
   920                              <1> 	; 08/11/2023
   921                              <1> 	push	ax
   922                              <1> 	mov	dx, [NABMBAR]
   923                              <1> 	add	dx, PO_SR_REG  ; PCM out status register
   924                              <1> 	in	ax, dx
   925                              <1> 
   926                              <1> 	;test	al, 2
   927                              <1> 	test	al, 3 ; bit 1 = Current Equals Last Valid (CELV)
   928                              <1> 		      ; (has been processed)
   929                              <1> 		      ; bit 0 = 1 -> DMA Controller Halted (DCH)
   930                              <1> 	pop	ax
   931                              <1> 	jz	short uLVI1
   932                              <1> uLVI3:
   933                              <1> 	xor	ax, ax
   934                              <1> 	; zf = 1
   935                              <1> 	retn
   936                              <1> uLVI0:
   937                              <1>         ; not at the end of the file yet.
   938                              <1> 	dec	al
   939                              <1> 	and	al, 1Fh
   940                              <1> uLVI1:
   941                              <1> 	;call	setLastValidIndex
   942                              <1> ;uLVI2:
   943                              <1> 	;retn
   944                              <1> 
   945                              <1> %endif
   946                              <1> 	
   947                              <1> ;input AL = index # to stop on
   948                              <1> setLastValidIndex:
   949                              <1> 	; 08/11/2023
   950                              <1> 	;push	dx
   951 00000878 8B16[061E]          <1> 	mov	dx, [NABMBAR]
   952 0000087C 83C215              <1> 	add	dx, PO_LVI_REG
   953 0000087F EE                  <1>         out     dx, al
   954                              <1> 	; 18/11/2023
   955 00000880 A2[1E1E]            <1> 	mov	[LVI], al
   956                              <1> 	;pop	dx
   957 00000883 C3                  <1> 	retn
   958                              <1> 
   959                              <1> ; checks if either shift key has been pressed. Exits with CY if so.
   960                              <1> ; 
   961                              <1> check4keyboardstop:
   962                              <1> 
   963                              <1> ; 06/11/2023
   964                              <1> %if 1
   965                              <1> 	; 19/05/2024
   966                              <1> 	; 08/11/2023
   967                              <1> 	; 04/11/2023
   968 00000884 B401                <1> 	mov	ah, 1
   969 00000886 CD16                <1> 	int	16h
   970                              <1> 	;clc
   971 00000888 7439                <1> 	jz	short _cksr
   972                              <1> 
   973 0000088A 30E4                <1> 	xor	ah, ah
   974 0000088C CD16                <1> 	int	16h
   975                              <1> 
   976                              <1> 	;;;
   977                              <1> 	; 19/05/2024 (change PCM out volume)
   978 0000088E 3C2B                <1> 	cmp	al, '+'
   979 00000890 750B                <1> 	jne	short p_1
   980                              <1> 	
   981 00000892 A0[C708]            <1> 	mov	al, [volume]
   982 00000895 3C00                <1> 	cmp	al, 0
   983 00000897 762B                <1> 	jna	short p_3
   984 00000899 FEC8                <1> 	dec	al
   985 0000089B EB0D                <1> 	jmp	short p_2
   986                              <1> p_1:
   987 0000089D 3C2D                <1> 	cmp	al, '-'
   988 0000089F 7524                <1> 	jne	short p_4
   989                              <1> 
   990 000008A1 A0[C708]            <1> 	mov	al, [volume]
   991 000008A4 3C1F                <1> 	cmp	al, 31
   992 000008A6 731C                <1> 	jnb	short p_3
   993 000008A8 FEC0                <1> 	inc	al
   994                              <1> p_2:
   995 000008AA A2[C708]            <1> 	mov	[volume], al
   996 000008AD 88C4                <1> 	mov	ah, al
   997 000008AF 8B16[041E]          <1> 	mov     dx, [NAMBAR]
   998                              <1>   	;add    dx, CODEC_MASTER_VOL_REG
   999 000008B3 83C218              <1> 	add	dx, CODEC_PCM_OUT_REG
  1000 000008B6 EF                  <1> 	out     dx, ax
  1001                              <1> 
  1002 000008B7 E81411              <1> 	call    delay1_4ms
  1003 000008BA E81111              <1>         call    delay1_4ms
  1004 000008BD E80E11              <1>         call    delay1_4ms
  1005 000008C0 E80B11              <1>         call    delay1_4ms
  1006                              <1> _cksr:		; 19/05/2024
  1007 000008C3 F8                  <1> 	clc
  1008                              <1> p_3:
  1009 000008C4 C3                  <1> 	retn
  1010                              <1> p_4:
  1011                              <1> 	;;;
  1012                              <1> ;_cskr:	
  1013 000008C5 F9                  <1> 	stc
  1014 000008C6 C3                  <1> 	retn
  1015                              <1> 
  1016                              <1> ; 19/05/2024
  1017 000008C7 02                  <1> volume:	db 02h
  1018                              <1> 
  1019                              <1> %endif
  1020                              <1> 
  1021                              <1> ; 15/11/2023
  1022                              <1> ; 14/11/2023
  1023                              <1> ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  1024                              <1> ; --------------------------------------------------------
  1025                              <1> 
  1026                              <1> ;;Note:	At the end of every buffer load,
  1027                              <1> ;;	during buffer switch/swap, there will be discontinuity
  1028                              <1> ;;	between the last converted sample and the 1st sample
  1029                              <1> ;;	of the next buffer.
  1030                              <1> ;;	(like as a dot noises vaguely between normal sound samples)
  1031                              <1> ;;	-To avoid this defect, the 1st sample of
  1032                              <1> ;;	the next buffer may be read from the wav file but
  1033                              <1> ;;	the file pointer would need to be set to 1 sample back
  1034                              <1> ;;	again via seek system call. Time comsumption problem! -
  1035                              <1> ;;
  1036                              <1> ;;	Erdogan Tan - 15/11/2023
  1037                              <1> ;;
  1038                              <1> ;;	((If entire wav data would be loaded at once.. conversion
  1039                              <1> ;;	defect/noise would disappear.. but for DOS, to keep
  1040                              <1> ;;	64KB buffer limit is important also it is important
  1041                              <1> ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  1042                              <1> ;;	I have tested this program by using 2-30MB wav files.))
  1043                              <1> ;;
  1044                              <1> ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  1045                              <1> ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  1046                              <1> ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  1047                              <1> ;;			Realtek ALC850 codec.
  1048                              <1> ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  1049                              <1> 
  1050                              <1> load_8khz_mono_8_bit:
  1051                              <1> 	; 15/11/2023
  1052                              <1> 	; 14/11/2023
  1053                              <1> 	; 13/11/2023
  1054 000008C8 F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1055                              <1> 					; last of the file?
  1056 000008CD 7402                <1> 	jz	short lff8m_0		; no
  1057 000008CF F9                  <1> 	stc
  1058 000008D0 C3                  <1> 	retn
  1059                              <1> 
  1060                              <1> lff8m_0:
  1061 000008D1 8EC0                <1> 	mov	es, ax ; buffer segment	
  1062 000008D3 31FF                <1> 	xor	di, di
  1063 000008D5 BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1064                              <1> 	; ds = cs
  1065                              <1> 
  1066                              <1> 	; load file into memory
  1067 000008D8 8B0E[8106]          <1>         mov	cx, [loadsize]
  1068 000008DC 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  1069 000008E0 B43F                <1>        	mov	ah, 3Fh
  1070 000008E2 CD21                <1> 	int	21h
  1071                              <1> 	;jc	short lff8m_5 ; error !
  1072                              <1> 	; 14/11/2023
  1073 000008E4 7303                <1> 	jnc	short lff8m_6
  1074 000008E6 E98B00              <1> 	jmp	lff8m_5
  1075                              <1> 
  1076                              <1> lff8m_6:
  1077 000008E9 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1078 000008EB 21C0                <1> 	and	ax, ax
  1079                              <1> 	;jz	short lff8m_3
  1080                              <1> 	; 15/11/2023
  1081 000008ED 747E                <1> 	jz	short lff8_eof
  1082                              <1> 
  1083 000008EF 89C1                <1> 	mov	cx, ax		; byte count
  1084                              <1> lff8m_1:
  1085 000008F1 AC                  <1> 	lodsb
  1086 000008F2 A2[C519]            <1> 	mov	[previous_val], al
  1087 000008F5 2C80                <1> 	sub	al, 80h
  1088 000008F7 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1089 000008FA AB                  <1> 	stosw		; original sample (left channel)
  1090 000008FB AB                  <1> 	stosw		; original sample (right channel)
  1091                              <1> 	;xor	ax, ax
  1092                              <1> 	; 14/11/2023
  1093 000008FC B080                <1> 	mov	al, 80h
  1094 000008FE 49                  <1> 	dec	cx
  1095 000008FF 7402                <1> 	jz	short lff8m_2
  1096 00000901 8A04                <1> 	mov	al, [si]
  1097                              <1> lff8m_2:
  1098                              <1> 	;mov	[next_val], ax
  1099 00000903 88C7                <1> 	mov	bh, al	; [next_val]
  1100 00000905 8A26[C519]          <1> 	mov	ah, [previous_val]
  1101 00000909 00E0                <1> 	add	al, ah	; [previous_val]
  1102 0000090B D0D8                <1> 	rcr	al, 1
  1103 0000090D 88C2                <1> 	mov	dl, al	; this is interpolated middle (3th) sample
  1104 0000090F 00E0                <1> 	add	al, ah	; [previous_val]
  1105 00000911 D0D8                <1> 	rcr	al, 1	
  1106 00000913 88C3                <1> 	mov	bl, al 	; this is temporary interpolation value	
  1107 00000915 00E0                <1> 	add	al, ah	; [previous_val]
  1108 00000917 D0D8                <1> 	rcr	al, 1
  1109 00000919 2C80                <1> 	sub	al, 80h
  1110 0000091B C1E008              <1> 	shl	ax, 8	
  1111 0000091E AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1112 0000091F AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1113 00000920 88D8                <1> 	mov	al, bl
  1114 00000922 00D0                <1> 	add	al, dl
  1115 00000924 D0D8                <1> 	rcr	al, 1
  1116 00000926 2C80                <1> 	sub	al, 80h
  1117 00000928 C1E008              <1> 	shl	ax, 8
  1118 0000092B AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1119 0000092C AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1120 0000092D 88D0                <1> 	mov	al, dl
  1121 0000092F 2C80                <1> 	sub	al, 80h
  1122 00000931 C1E008              <1> 	shl	ax, 8
  1123 00000934 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1124 00000935 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1125                              <1> 	;mov	al, [next_val]
  1126 00000936 88F8                <1> 	mov	al, bh
  1127 00000938 00D0                <1> 	add	al, dl
  1128 0000093A D0D8                <1> 	rcr	al, 1
  1129 0000093C 88C3                <1> 	mov	bl, al	; this is temporary interpolation value
  1130 0000093E 00D0                <1> 	add	al, dl
  1131 00000940 D0D8                <1> 	rcr	al, 1
  1132 00000942 2C80                <1> 	sub	al, 80h
  1133 00000944 C1E008              <1> 	shl	ax, 8
  1134 00000947 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1135 00000948 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1136                              <1> 	;mov	al, [next_val]
  1137 00000949 88F8                <1> 	mov	al, bh
  1138 0000094B 00D8                <1> 	add	al, bl
  1139 0000094D D0D8                <1> 	rcr	al, 1
  1140 0000094F 2C80                <1> 	sub	al, 80h
  1141 00000951 C1E008              <1> 	shl	ax, 8
  1142 00000954 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1143 00000955 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1144                              <1> 	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1145 00000956 09C9                <1> 	or	cx, cx
  1146 00000958 7597                <1> 	jnz	short lff8m_1
  1147                              <1> 
  1148                              <1> 	; --------------
  1149                              <1> 
  1150                              <1> lff8s_3:
  1151                              <1> lff8m_3:
  1152                              <1> lff8s2_3:
  1153                              <1> lff8m2_3:
  1154                              <1> lff16s_3:
  1155                              <1> lff16m_3:
  1156                              <1> lff16s2_3:
  1157                              <1> lff16m2_3:
  1158                              <1> lff24_3:
  1159                              <1> lff32_3:
  1160                              <1> lff44_3:
  1161                              <1> lff22_3:
  1162                              <1> lff11_3:
  1163 0000095A 8B0E[8306]          <1> 	mov	cx, [buffersize] ; 16 bit (48 kHZ, stereo) sample size
  1164 0000095E D1E1                <1> 	shl	cx, 1	; byte count
  1165 00000960 29F9                <1> 	sub	cx, di
  1166 00000962 7606                <1> 	jna	short lff8m_4
  1167                              <1> 	;inc	cx
  1168 00000964 D1E9                <1> 	shr	cx, 1
  1169 00000966 31C0                <1> 	xor	ax, ax	; fill (remain part of) buffer with zeros	
  1170 00000968 F3AB                <1> 	rep	stosw
  1171                              <1> lff8m_4:
  1172 0000096A 0E                  <1> 	push	cs
  1173 0000096B 07                  <1> 	pop	es
  1174 0000096C C3                  <1> 	retn
  1175                              <1> 
  1176                              <1> lff8_eof:
  1177                              <1> lff16_eof:
  1178                              <1> lff24_eof:
  1179                              <1> lff32_eof:
  1180                              <1> lff44_eof:
  1181                              <1> lff22_eof:
  1182                              <1> lff11_eof:
  1183                              <1> 	; 15/11/2023
  1184 0000096D C606[FA1D]01        <1> 	mov	byte [flags], ENDOFFILE
  1185 00000972 EBE6                <1> 	jmp	short lff8m_3
  1186                              <1> 
  1187                              <1> lff8s_5:
  1188                              <1> lff8m_5:
  1189                              <1> lff8s2_5:
  1190                              <1> lff8m2_5:
  1191                              <1> lff16s_5:
  1192                              <1> lff16m_5:
  1193                              <1> lff16s2_5:
  1194                              <1> lff16m2_5:
  1195                              <1> lff24_5:
  1196                              <1> lff32_5:
  1197                              <1> lff44_5:
  1198                              <1> lff22_5:
  1199                              <1> lff11_5:
  1200 00000974 B021                <1> 	mov	al, '!'  ; error
  1201 00000976 E824FE              <1> 	call	tL0
  1202                              <1> 	
  1203                              <1> 	;jmp	short lff8m_3
  1204                              <1> 	; 15/11/2023
  1205 00000979 EBF2                <1> 	jmp	lff8_eof
  1206                              <1> 
  1207                              <1> 	; --------------
  1208                              <1> 
  1209                              <1> load_8khz_stereo_8_bit:
  1210                              <1> 	; 15/11/2023
  1211                              <1> 	; 14/11/2023
  1212                              <1> 	; 13/11/2023
  1213 0000097B F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1214                              <1> 					; last of the file?
  1215 00000980 7402                <1> 	jz	short lff8s_0		; no
  1216 00000982 F9                  <1> 	stc
  1217 00000983 C3                  <1> 	retn
  1218                              <1> 
  1219                              <1> lff8s_0:
  1220 00000984 8EC0                <1> 	mov	es, ax ; buffer segment	
  1221 00000986 31FF                <1> 	xor	di, di
  1222 00000988 BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1223                              <1> 	; ds = cs
  1224                              <1> 
  1225                              <1> 	; load file into memory
  1226 0000098B 8B0E[8106]          <1>         mov	cx, [loadsize]
  1227 0000098F 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  1228 00000993 B43F                <1>        	mov	ah, 3Fh
  1229 00000995 CD21                <1> 	int	21h
  1230 00000997 72DB                <1> 	jc	short lff8s_5 ; error !
  1231                              <1> 
  1232 00000999 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1233                              <1> 	
  1234 0000099B D1E8                <1> 	shr	ax, 1
  1235                              <1> 	;;and	ax, ax
  1236                              <1> 	;jz	short lff8s_3
  1237                              <1> 	; 15/11/2023
  1238 0000099D 74CE                <1> 	jz	short lff8_eof
  1239                              <1> 
  1240 0000099F 89C1                <1> 	mov	cx, ax		; word count
  1241                              <1> lff8s_1:
  1242 000009A1 AC                  <1> 	lodsb
  1243 000009A2 A2[C519]            <1> 	mov	[previous_val_l], al
  1244 000009A5 2C80                <1> 	sub	al, 80h
  1245 000009A7 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1246 000009AA AB                  <1> 	stosw		; original sample (L)
  1247 000009AB AC                  <1> 	lodsb
  1248 000009AC A2[C719]            <1> 	mov	[previous_val_r], al
  1249 000009AF 2C80                <1> 	sub	al, 80h
  1250 000009B1 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1251 000009B4 AB                  <1> 	stosw		; original sample (R)
  1252                              <1> 
  1253                              <1> 	;xor	ax, ax
  1254                              <1> 	; 14/11/2023
  1255 000009B5 B88080              <1> 	mov	ax, 8080h
  1256 000009B8 49                  <1> 	dec	cx
  1257 000009B9 7402                <1> 	jz	short lff8s_2
  1258                              <1> 		; convert 8 bit sample to 16 bit sample
  1259 000009BB 8B04                <1> 	mov	ax, [si]
  1260                              <1> lff8s_2:
  1261 000009BD A2[C919]            <1> 	mov	[next_val_l], al
  1262 000009C0 8826[CB19]          <1> 	mov	[next_val_r], ah
  1263 000009C4 8A26[C519]          <1> 	mov	ah, [previous_val_l]
  1264 000009C8 00E0                <1> 	add	al, ah
  1265 000009CA D0D8                <1> 	rcr	al, 1
  1266 000009CC 88C2                <1> 	mov	dl, al	; this is interpolated middle (3th) sample (L)
  1267 000009CE 00E0                <1> 	add	al, ah
  1268 000009D0 D0D8                <1> 	rcr	al, 1	
  1269 000009D2 88C3                <1> 	mov	bl, al	; this is temporary interpolation value (L)
  1270 000009D4 00E0                <1> 	add	al, ah
  1271 000009D6 D0D8                <1> 	rcr	al, 1
  1272 000009D8 2C80                <1> 	sub	al, 80h
  1273 000009DA C1E008              <1> 	shl	ax, 8
  1274 000009DD AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1275 000009DE A0[CB19]            <1> 	mov	al, [next_val_r]
  1276 000009E1 8A26[C719]          <1> 	mov	ah, [previous_val_r]
  1277 000009E5 00E0                <1> 	add	al, ah
  1278 000009E7 D0D8                <1> 	rcr	al, 1
  1279 000009E9 88C6                <1> 	mov	dh, al	; this is interpolated middle (3th) sample (R)
  1280 000009EB 00E0                <1> 	add	al, ah
  1281 000009ED D0D8                <1> 	rcr	al, 1
  1282 000009EF 88C7                <1> 	mov	bh, al	; this is temporary interpolation value (R)
  1283 000009F1 00E0                <1> 	add	al, ah
  1284 000009F3 D0D8                <1> 	rcr	al, 1
  1285 000009F5 2C80                <1> 	sub	al, 80h
  1286 000009F7 C1E008              <1> 	shl	ax, 8
  1287 000009FA AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1288 000009FB 88D8                <1> 	mov	al, bl
  1289 000009FD 00D0                <1> 	add	al, dl
  1290 000009FF D0D8                <1> 	rcr	al, 1
  1291 00000A01 2C80                <1> 	sub	al, 80h
  1292 00000A03 C1E008              <1> 	shl	ax, 8
  1293 00000A06 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1294 00000A07 88F8                <1> 	mov	al, bh
  1295 00000A09 00F0                <1> 	add	al, dh
  1296 00000A0B D0D8                <1> 	rcr	al, 1
  1297 00000A0D 2C80                <1> 	sub	al, 80h
  1298 00000A0F C1E008              <1> 	shl	ax, 8
  1299 00000A12 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1300 00000A13 88D0                <1> 	mov	al, dl
  1301 00000A15 2C80                <1> 	sub	al, 80h
  1302 00000A17 C1E008              <1> 	shl	ax, 8
  1303 00000A1A AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1304 00000A1B 88F0                <1> 	mov	al, dh
  1305 00000A1D 2C80                <1> 	sub	al, 80h
  1306 00000A1F C1E008              <1> 	shl	ax, 8
  1307 00000A22 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1308 00000A23 A0[C919]            <1> 	mov	al, [next_val_l]
  1309 00000A26 00D0                <1> 	add	al, dl
  1310 00000A28 D0D8                <1> 	rcr	al, 1
  1311 00000A2A 88C3                <1> 	mov	bl, al	; this is temporary interpolation value (L)
  1312 00000A2C 00D0                <1> 	add	al, dl
  1313 00000A2E D0D8                <1> 	rcr	al, 1
  1314 00000A30 2C80                <1> 	sub	al, 80h
  1315 00000A32 C1E008              <1> 	shl	ax, 8
  1316 00000A35 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1317 00000A36 A0[CB19]            <1> 	mov	al, [next_val_r]
  1318 00000A39 00F0                <1> 	add	al, dh
  1319 00000A3B D0D8                <1> 	rcr	al, 1
  1320 00000A3D 88C7                <1> 	mov	bh, al	; this is temporary interpolation value (R)
  1321 00000A3F 00F0                <1> 	add	al, dh
  1322 00000A41 D0D8                <1> 	rcr	al, 1
  1323 00000A43 2C80                <1> 	sub	al, 80h
  1324 00000A45 C1E008              <1> 	shl	ax, 8
  1325 00000A48 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1326 00000A49 A0[C919]            <1> 	mov	al, [next_val_l]
  1327 00000A4C 00D8                <1> 	add	al, bl
  1328 00000A4E D0D8                <1> 	rcr	al, 1
  1329 00000A50 2C80                <1> 	sub	al, 80h
  1330 00000A52 C1E008              <1> 	shl	ax, 8
  1331 00000A55 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1332 00000A56 A0[CB19]            <1> 	mov	al, [next_val_r]
  1333 00000A59 00F8                <1> 	add	al, bh
  1334 00000A5B D0D8                <1> 	rcr	al, 1
  1335 00000A5D 2C80                <1> 	sub	al, 80h
  1336 00000A5F C1E008              <1> 	shl	ax, 8
  1337 00000A62 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1338                              <1> 	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1339 00000A63 E303                <1> 	jcxz	lff8s_6
  1340 00000A65 E939FF              <1> 	jmp	lff8s_1
  1341                              <1> lff8s_6:
  1342 00000A68 E9EFFE              <1> 	jmp	lff8s_3
  1343                              <1> 
  1344                              <1> load_8khz_mono_16_bit:
  1345                              <1> 	; 13/11/2023
  1346 00000A6B F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1347                              <1> 					; last of the file?
  1348 00000A70 7402                <1> 	jz	short lff8m2_0		; no
  1349 00000A72 F9                  <1> 	stc
  1350 00000A73 C3                  <1> 	retn
  1351                              <1> 
  1352                              <1> lff8m2_0:
  1353 00000A74 8EC0                <1> 	mov	es, ax ; buffer segment	
  1354 00000A76 31FF                <1> 	xor	di, di
  1355 00000A78 BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1356                              <1> 	; ds = cs
  1357                              <1> 
  1358                              <1> 	; load file into memory
  1359 00000A7B 8B0E[8106]          <1>         mov	cx, [loadsize]
  1360 00000A7F 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  1361 00000A83 B43F                <1>        	mov	ah, 3Fh
  1362 00000A85 CD21                <1> 	int	21h
  1363 00000A87 7270                <1> 	jc	short lff8m2_7 ; error !
  1364                              <1> 
  1365 00000A89 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1366                              <1> 	
  1367 00000A8B D1E8                <1> 	shr	ax, 1
  1368                              <1> 	;and	ax, ax
  1369 00000A8D 7503                <1> 	jnz	short lff8m2_8
  1370                              <1> 	;jmp	lff8m2_3
  1371                              <1> 	; 15/11/2023
  1372 00000A8F E9DBFE              <1> 	jmp	lff8_eof
  1373                              <1> 
  1374                              <1> lff8m2_8:
  1375 00000A92 89C1                <1> 	mov	cx, ax		; word count
  1376                              <1> lff8m2_1:
  1377 00000A94 AD                  <1> 	lodsw
  1378 00000A95 AB                  <1> 	stosw		; original sample (left channel)
  1379 00000A96 AB                  <1> 	stosw		; original sample (right channel)
  1380 00000A97 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1381 00000A9A A3[C519]            <1> 	mov	[previous_val], ax
  1382 00000A9D 31C0                <1> 	xor	ax, ax
  1383 00000A9F 49                  <1> 	dec	cx
  1384 00000AA0 7402                <1> 	jz	short lff8m2_2
  1385 00000AA2 8B04                <1> 	mov	ax, [si]
  1386                              <1> lff8m2_2:
  1387 00000AA4 80C480              <1> 	add	ah, 80h ; convert sound level to 0-65535 format
  1388 00000AA7 89C5                <1> 	mov	bp, ax	; [next_val]
  1389 00000AA9 0306[C519]          <1> 	add	ax, [previous_val]
  1390 00000AAD D1D8                <1> 	rcr	ax, 1
  1391 00000AAF 89C2                <1> 	mov	dx, ax	; this is interpolated middle (3th) sample
  1392 00000AB1 0306[C519]          <1> 	add	ax, [previous_val]
  1393 00000AB5 D1D8                <1> 	rcr	ax, 1	; this is temporary interpolation value
  1394 00000AB7 89C3                <1> 	mov	bx, ax 		
  1395 00000AB9 0306[C519]          <1> 	add	ax, [previous_val]
  1396 00000ABD D1D8                <1> 	rcr	ax, 1
  1397 00000ABF 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1398 00000AC2 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1399 00000AC3 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1400 00000AC4 89D8                <1> 	mov	ax, bx
  1401 00000AC6 01D0                <1> 	add	ax, dx
  1402 00000AC8 D1D8                <1> 	rcr	ax, 1
  1403 00000ACA 80EC80              <1> 	sub	ah, 80h
  1404 00000ACD AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1405 00000ACE AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1406 00000ACF 89D0                <1> 	mov	ax, dx
  1407 00000AD1 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1408 00000AD4 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1409 00000AD5 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1410 00000AD6 89E8                <1> 	mov	ax, bp
  1411 00000AD8 01D0                <1> 	add	ax, dx
  1412 00000ADA D1D8                <1> 	rcr	ax, 1
  1413 00000ADC 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value
  1414 00000ADE 01D0                <1> 	add	ax, dx
  1415 00000AE0 D1D8                <1> 	rcr	ax, 1
  1416 00000AE2 80EC80              <1> 	sub	ah, 80h
  1417 00000AE5 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1418 00000AE6 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1419 00000AE7 89E8                <1> 	mov	ax, bp
  1420 00000AE9 01D8                <1> 	add	ax, bx
  1421 00000AEB D1D8                <1> 	rcr	ax, 1
  1422 00000AED 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1423 00000AF0 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1424 00000AF1 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1425                              <1> 	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1426 00000AF2 09C9                <1> 	or	cx, cx
  1427 00000AF4 759E                <1> 	jnz	short lff8m2_1
  1428 00000AF6 E961FE              <1> 	jmp	lff8m2_3
  1429                              <1> 
  1430                              <1> lff8m2_7:
  1431                              <1> lff8s2_7:
  1432 00000AF9 E978FE              <1> 	jmp	lff8m2_5  ; error
  1433                              <1> 
  1434                              <1> load_8khz_stereo_16_bit:
  1435                              <1> 	; 16/11/2023
  1436                              <1> 	; 15/11/2023
  1437                              <1> 	; 13/11/2023
  1438 00000AFC F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1439                              <1> 					; last of the file?
  1440 00000B01 7402                <1> 	jz	short lff8s2_0		; no
  1441 00000B03 F9                  <1> 	stc
  1442 00000B04 C3                  <1> 	retn
  1443                              <1> 
  1444                              <1> lff8s2_0:
  1445 00000B05 8EC0                <1> 	mov	es, ax ; buffer segment	
  1446 00000B07 31FF                <1> 	xor	di, di
  1447 00000B09 BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1448                              <1> 	; ds = cs
  1449                              <1> 
  1450                              <1> 	; load file into memory
  1451 00000B0C 8B0E[8106]          <1>         mov	cx, [loadsize]
  1452 00000B10 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  1453 00000B14 B43F                <1>        	mov	ah, 3Fh
  1454 00000B16 CD21                <1> 	int	21h
  1455 00000B18 72DF                <1> 	jc	short lff8s2_7 ; error !
  1456                              <1> 
  1457 00000B1A 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1458                              <1> 	
  1459 00000B1C C1E802              <1> 	shr	ax, 2	; 16/11/2023
  1460                              <1> 	;and	ax, ax
  1461 00000B1F 7503                <1> 	jnz	short lff8s2_8
  1462                              <1> 	;jmp	lff8s2_3
  1463                              <1> 	; 15/11/2023
  1464 00000B21 E949FE              <1> 	jmp	lff8_eof
  1465                              <1> 
  1466                              <1> lff8s2_8:
  1467 00000B24 89C1                <1> 	mov	cx, ax ; dword count
  1468                              <1> lff8s2_1:
  1469 00000B26 AD                  <1> 	lodsw
  1470 00000B27 AB                  <1> 	stosw		; original sample (L)
  1471                              <1> 	; 15/11/2023
  1472 00000B28 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1473 00000B2B A3[C519]            <1> 	mov	[previous_val_l], ax
  1474 00000B2E AD                  <1> 	lodsw
  1475 00000B2F AB                  <1> 	stosw		; original sample (R)
  1476 00000B30 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1477 00000B33 A3[C719]            <1> 	mov	[previous_val_r], ax
  1478 00000B36 31D2                <1> 	xor	dx, dx
  1479 00000B38 31C0                <1> 	xor	ax, ax
  1480                              <1> 	; 16/11/2023
  1481 00000B3A 49                  <1> 	dec	cx
  1482 00000B3B 7405                <1> 	jz	short lff8s2_2
  1483 00000B3D 8B04                <1> 	mov	ax, [si]
  1484 00000B3F 8B5402              <1> 	mov	dx, [si+2]
  1485                              <1> lff8s2_2:
  1486 00000B42 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1487 00000B45 A3[C919]            <1> 	mov	[next_val_l], ax
  1488 00000B48 80C680              <1> 	add	dh, 80h	; convert sound level to 0-65535 format
  1489 00000B4B 8916[CB19]          <1> 	mov	[next_val_r], dx
  1490 00000B4F 0306[C519]          <1> 	add	ax, [previous_val_l]
  1491 00000B53 D1D8                <1> 	rcr	ax, 1
  1492 00000B55 89C2                <1> 	mov	dx, ax	; this is interpolated middle (3th) sample (L)
  1493 00000B57 0306[C519]          <1> 	add	ax, [previous_val_l]
  1494 00000B5B D1D8                <1> 	rcr	ax, 1	
  1495 00000B5D 89C3                <1> 	mov	bx, ax 	; this is temporary interpolation value (L)
  1496 00000B5F 0306[C519]          <1> 	add	ax, [previous_val_l]
  1497 00000B63 D1D8                <1> 	rcr	ax, 1
  1498 00000B65 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1499 00000B68 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1500 00000B69 A1[CB19]            <1> 	mov	ax, [next_val_r]
  1501 00000B6C 0306[C719]          <1> 	add	ax, [previous_val_r]
  1502 00000B70 D1D8                <1> 	rcr	ax, 1
  1503 00000B72 89C5                <1> 	mov	bp, ax	; this is interpolated middle (3th) sample (R)
  1504 00000B74 0306[C719]          <1> 	add	ax, [previous_val_r]
  1505 00000B78 D1D8                <1> 	rcr	ax, 1
  1506 00000B7A 50                  <1> 	push	ax ; *	; this is temporary interpolation value (R)
  1507 00000B7B 0306[C719]          <1> 	add	ax, [previous_val_r]
  1508 00000B7F D1D8                <1> 	rcr	ax, 1
  1509 00000B81 80EC80              <1> 	sub	ah, 80h
  1510 00000B84 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1511 00000B85 89D8                <1> 	mov	ax, bx
  1512 00000B87 01D0                <1> 	add	ax, dx
  1513 00000B89 D1D8                <1> 	rcr	ax, 1
  1514 00000B8B 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1515 00000B8E AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1516 00000B8F 58                  <1> 	pop	ax ; *
  1517 00000B90 01E8                <1> 	add	ax, bp
  1518 00000B92 D1D8                <1> 	rcr	ax, 1
  1519 00000B94 80EC80              <1> 	sub	ah, 80h
  1520 00000B97 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1521 00000B98 89D0                <1> 	mov	ax, dx
  1522 00000B9A 80EC80              <1> 	sub	ah, 80h
  1523 00000B9D AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1524 00000B9E 89E8                <1> 	mov	ax, bp
  1525 00000BA0 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1526 00000BA3 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1527 00000BA4 A1[C919]            <1> 	mov	ax, [next_val_l]
  1528 00000BA7 01D0                <1> 	add	ax, dx
  1529 00000BA9 D1D8                <1> 	rcr	ax, 1
  1530 00000BAB 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value (L)
  1531 00000BAD 01D0                <1> 	add	ax, dx
  1532 00000BAF D1D8                <1> 	rcr	ax, 1
  1533 00000BB1 80EC80              <1> 	sub	ah, 80h
  1534 00000BB4 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1535 00000BB5 A1[CB19]            <1> 	mov	ax, [next_val_r]
  1536 00000BB8 01E8                <1> 	add	ax, bp
  1537 00000BBA D1D8                <1> 	rcr	ax, 1
  1538 00000BBC 50                  <1> 	push	ax ; ** ; this is temporary interpolation value (R)
  1539 00000BBD 01E8                <1> 	add	ax, bp
  1540 00000BBF D1D8                <1> 	rcr	ax, 1
  1541 00000BC1 80EC80              <1> 	sub	ah, 80h
  1542 00000BC4 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1543 00000BC5 A1[C919]            <1> 	mov	ax, [next_val_l]
  1544 00000BC8 01D8                <1> 	add	ax, bx
  1545 00000BCA D1D8                <1> 	rcr	ax, 1
  1546 00000BCC 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1547 00000BCF AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1548 00000BD0 58                  <1> 	pop	ax ; **
  1549 00000BD1 0306[CB19]          <1> 	add	ax, [next_val_r]
  1550 00000BD5 D1D8                <1> 	rcr	ax, 1
  1551 00000BD7 80EC80              <1> 	sub	ah, 80h
  1552 00000BDA AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1553                              <1> 	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1554 00000BDB E303                <1> 	jcxz	lff8_s2_9
  1555 00000BDD E946FF              <1> 	jmp	lff8s2_1
  1556                              <1> lff8_s2_9:
  1557 00000BE0 E977FD              <1> 	jmp	lff8s2_3
  1558                              <1> 
  1559                              <1> ; .....................
  1560                              <1> 
  1561                              <1> load_16khz_mono_8_bit:
  1562                              <1> 	; 14/11/2023
  1563                              <1> 	; 13/11/2023
  1564 00000BE3 F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1565                              <1> 					; last of the file?
  1566 00000BE8 7402                <1> 	jz	short lff16m_0		; no
  1567 00000BEA F9                  <1> 	stc
  1568 00000BEB C3                  <1> 	retn
  1569                              <1> 
  1570                              <1> lff16m_0:
  1571 00000BEC 8EC0                <1> 	mov	es, ax ; buffer segment	
  1572 00000BEE 31FF                <1> 	xor	di, di
  1573 00000BF0 BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1574                              <1> 	; ds = cs
  1575                              <1> 
  1576                              <1> 	; load file into memory
  1577 00000BF3 8B0E[8106]          <1>         mov	cx, [loadsize]
  1578 00000BF7 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  1579 00000BFB B43F                <1>        	mov	ah, 3Fh
  1580 00000BFD CD21                <1> 	int	21h
  1581 00000BFF 7243                <1> 	jc	short lff16m_7 ; error !
  1582                              <1> 
  1583 00000C01 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1584                              <1> 	
  1585 00000C03 21C0                <1> 	and	ax, ax
  1586 00000C05 7503                <1> 	jnz	short lff16m_8
  1587                              <1> 	;jmp	lff16m_3
  1588                              <1> 	; 15/11/2023
  1589 00000C07 E963FD              <1> 	jmp	lff16_eof
  1590                              <1> 
  1591                              <1> lff16m_8:
  1592 00000C0A 89C1                <1> 	mov	cx, ax		; byte count
  1593                              <1> lff16m_1:
  1594 00000C0C AC                  <1> 	lodsb
  1595                              <1> 	;mov	[previous_val], al
  1596 00000C0D 88C3                <1> 	mov	bl, al
  1597 00000C0F 2C80                <1> 	sub	al, 80h
  1598 00000C11 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1599 00000C14 AB                  <1> 	stosw		; original sample (left channel)
  1600 00000C15 AB                  <1> 	stosw		; original sample (right channel)
  1601                              <1> 	;xor	ax, ax
  1602                              <1> 	; 14/11/22023
  1603 00000C16 B080                <1> 	mov	al, 80h
  1604 00000C18 49                  <1> 	dec	cx
  1605 00000C19 7402                <1> 	jz	short lff16m_2
  1606 00000C1B 8A04                <1> 	mov	al, [si]
  1607                              <1> lff16m_2:
  1608                              <1> 	;mov	[next_val], al
  1609 00000C1D 88C7                <1> 	mov	bh, al
  1610                              <1> 	;add	al, [previous_val]
  1611 00000C1F 00D8                <1> 	add	al, bl
  1612 00000C21 D0D8                <1> 	rcr	al, 1
  1613 00000C23 88C2                <1> 	mov	dl, al	; this is interpolated middle (temp) sample
  1614                              <1> 	;add	al, [previous_val]
  1615 00000C25 00D8                <1> 	add	al, bl
  1616 00000C27 D0D8                <1> 	rcr	al, 1
  1617 00000C29 2C80                <1> 	sub	al, 80h
  1618 00000C2B C1E008              <1> 	shl	ax, 8
  1619 00000C2E AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1620 00000C2F AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1621                              <1> 	;mov	al, [next_val]
  1622 00000C30 88F8                <1> 	mov	al, bh
  1623 00000C32 00D0                <1> 	add	al, dl
  1624 00000C34 D0D8                <1> 	rcr	al, 1
  1625 00000C36 2C80                <1> 	sub	al, 80h
  1626 00000C38 C1E008              <1> 	shl	ax, 8
  1627 00000C3B AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1628 00000C3C AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1629                              <1> 	
  1630                              <1> 	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1631 00000C3D 09C9                <1> 	or	cx, cx
  1632 00000C3F 75CB                <1> 	jnz	short lff16m_1
  1633 00000C41 E916FD              <1> 	jmp	lff16m_3
  1634                              <1> 
  1635                              <1> lff16m_7:
  1636                              <1> lff16s_7:
  1637 00000C44 E92DFD              <1> 	jmp	lff16m_5  ; error
  1638                              <1> 
  1639                              <1> load_16khz_stereo_8_bit:
  1640                              <1> 	; 14/11/2023
  1641                              <1> 	; 13/11/2023
  1642 00000C47 F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1643                              <1> 					; last of the file?
  1644 00000C4C 7402                <1> 	jz	short lff16s_0		; no
  1645 00000C4E F9                  <1> 	stc
  1646 00000C4F C3                  <1> 	retn
  1647                              <1> 
  1648                              <1> lff16s_0:
  1649 00000C50 8EC0                <1> 	mov	es, ax ; buffer segment	
  1650 00000C52 31FF                <1> 	xor	di, di
  1651 00000C54 BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1652                              <1> 	; ds = cs
  1653                              <1> 
  1654                              <1> 	; load file into memory
  1655 00000C57 8B0E[8106]          <1>         mov	cx, [loadsize]
  1656 00000C5B 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  1657 00000C5F B43F                <1>        	mov	ah, 3Fh
  1658 00000C61 CD21                <1> 	int	21h
  1659 00000C63 72DF                <1> 	jc	short lff16s_7 ; error !
  1660                              <1> 
  1661 00000C65 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1662                              <1> 	
  1663 00000C67 D1E8                <1> 	shr	ax, 1
  1664                              <1> 	;and	ax, ax
  1665 00000C69 7503                <1> 	jnz	short lff16s_8
  1666                              <1> 	;jmp	lff16s_3
  1667                              <1> 	; 15/11/2023
  1668 00000C6B E9FFFC              <1> 	jmp	lff16_eof
  1669                              <1> 
  1670                              <1> lff16s_8:
  1671 00000C6E 89C1                <1> 	mov	cx, ax		; word count
  1672                              <1> lff16s_1:
  1673 00000C70 AC                  <1> 	lodsb
  1674 00000C71 A2[C519]            <1> 	mov	[previous_val_l], al
  1675 00000C74 2C80                <1> 	sub	al, 80h
  1676 00000C76 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1677 00000C79 AB                  <1> 	stosw		; original sample (L)
  1678 00000C7A AC                  <1> 	lodsb
  1679 00000C7B A2[C719]            <1> 	mov	[previous_val_r], al
  1680 00000C7E 2C80                <1> 	sub	al, 80h
  1681 00000C80 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1682 00000C83 AB                  <1> 	stosw		; original sample (R)
  1683                              <1> 
  1684                              <1> 	;xor	ax, ax
  1685                              <1> 	; 14/11/2023
  1686 00000C84 B88080              <1> 	mov	ax, 8080h
  1687 00000C87 49                  <1> 	dec	cx
  1688 00000C88 7402                <1> 	jz	short lff16s_2
  1689                              <1> 		; convert 8 bit sample to 16 bit sample
  1690 00000C8A 8B04                <1> 	mov	ax, [si]
  1691                              <1> lff16s_2:
  1692                              <1> 	;mov	[next_val_l], al
  1693                              <1> 	;mov	[next_val_r], ah
  1694 00000C8C 89C3                <1> 	mov	bx, ax
  1695 00000C8E 0206[C519]          <1> 	add	al, [previous_val_l]
  1696 00000C92 D0D8                <1> 	rcr	al, 1
  1697 00000C94 88C2                <1> 	mov	dl, al	; this is temporary interpolation value (L)
  1698 00000C96 0206[C519]          <1> 	add	al, [previous_val_l]
  1699 00000C9A D0D8                <1> 	rcr	al, 1
  1700 00000C9C 2C80                <1> 	sub	al, 80h
  1701 00000C9E C1E008              <1> 	shl	ax, 8
  1702 00000CA1 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1703 00000CA2 88F8                <1> 	mov	al, bh	; [next_val_r]
  1704 00000CA4 0206[C719]          <1> 	add	al, [previous_val_r]
  1705 00000CA8 D0D8                <1> 	rcr	al, 1
  1706 00000CAA 88C6                <1> 	mov	dh, al	; this is temporary interpolation value (R)
  1707 00000CAC 0206[C719]          <1> 	add	al, [previous_val_r]
  1708 00000CB0 D0D8                <1> 	rcr	al, 1
  1709 00000CB2 2C80                <1> 	sub	al, 80h
  1710 00000CB4 C1E008              <1> 	shl	ax, 8
  1711 00000CB7 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1712 00000CB8 88D0                <1> 	mov	al, dl
  1713 00000CBA 00D8                <1> 	add	al, bl	; [next_val_l]
  1714 00000CBC D0D8                <1> 	rcr	al, 1
  1715 00000CBE 2C80                <1> 	sub	al, 80h
  1716 00000CC0 C1E008              <1> 	shl	ax, 8
  1717 00000CC3 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1718 00000CC4 88F0                <1> 	mov	al, dh
  1719 00000CC6 00F8                <1> 	add	al, bh	; [next_val_r]
  1720 00000CC8 D0D8                <1> 	rcr	al, 1
  1721 00000CCA 2C80                <1> 	sub	al, 80h
  1722 00000CCC C1E008              <1> 	shl	ax, 8
  1723 00000CCF AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1724                              <1> 	
  1725                              <1> 	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1726 00000CD0 09C9                <1> 	or	cx, cx
  1727 00000CD2 759C                <1> 	jnz	short lff16s_1
  1728 00000CD4 E983FC              <1> 	jmp	lff16s_3
  1729                              <1> 
  1730                              <1> load_16khz_mono_16_bit:
  1731                              <1> 	; 15/11/2023
  1732                              <1> 	; 13/11/2023
  1733 00000CD7 F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1734                              <1> 					; last of the file?
  1735 00000CDC 7402                <1> 	jz	short lff16m2_0		; no
  1736 00000CDE F9                  <1> 	stc
  1737 00000CDF C3                  <1> 	retn
  1738                              <1> 
  1739                              <1> lff16m2_0:
  1740 00000CE0 8EC0                <1> 	mov	es, ax ; buffer segment	
  1741 00000CE2 31FF                <1> 	xor	di, di
  1742 00000CE4 BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1743                              <1> 	; ds = cs
  1744                              <1> 
  1745                              <1> 	; load file into memory
  1746 00000CE7 8B0E[8106]          <1>         mov	cx, [loadsize]
  1747 00000CEB 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  1748 00000CEF B43F                <1>        	mov	ah, 3Fh
  1749 00000CF1 CD21                <1> 	int	21h
  1750 00000CF3 7240                <1> 	jc	short lff16m2_7 ; error !
  1751                              <1> 
  1752 00000CF5 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1753                              <1> 	
  1754 00000CF7 D1E8                <1> 	shr	ax, 1
  1755                              <1> 	;and	ax, ax
  1756 00000CF9 7503                <1> 	jnz	short lff16m2_8
  1757                              <1> 	;jmp	lff16m2_3
  1758                              <1> 	; 15/11/2023
  1759 00000CFB E96FFC              <1> 	jmp	lff16_eof
  1760                              <1> 
  1761                              <1> lff16m2_8:
  1762 00000CFE 89C1                <1> 	mov	cx, ax	; word count
  1763                              <1> lff16m2_1:
  1764 00000D00 AD                  <1> 	lodsw
  1765 00000D01 AB                  <1> 	stosw		; original sample (left channel)
  1766 00000D02 AB                  <1> 	stosw		; original sample (right channel)
  1767 00000D03 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  1768                              <1> 	;mov	[previous_val], ax
  1769 00000D06 89C3                <1> 	mov	bx, ax	
  1770 00000D08 31C0                <1> 	xor	ax, ax
  1771 00000D0A 49                  <1> 	dec	cx
  1772 00000D0B 7402                <1> 	jz	short lff16m2_2
  1773 00000D0D 8B04                <1> 	mov	ax, [si]
  1774                              <1> lff16m2_2:
  1775 00000D0F 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  1776 00000D12 89C5                <1> 	mov	bp, ax	; [next_val]
  1777                              <1> 	;add	ax, [previous_val]
  1778 00000D14 01D8                <1> 	add	ax, bx
  1779 00000D16 D1D8                <1> 	rcr	ax, 1
  1780 00000D18 89C2                <1> 	mov	dx, ax	; this is temporary interpolation value
  1781                              <1> 	;add	ax, [previous_val]
  1782 00000D1A 01D8                <1> 	add	ax, bx
  1783 00000D1C D1D8                <1> 	rcr	ax, 1
  1784 00000D1E 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1785 00000D21 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1786 00000D22 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1787 00000D23 89E8                <1> 	mov	ax, bp 
  1788 00000D25 01D0                <1> 	add	ax, dx
  1789 00000D27 D1D8                <1> 	rcr	ax, 1
  1790 00000D29 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1791 00000D2C AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1792 00000D2D AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1793                              <1> 	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1794 00000D2E 09C9                <1> 	or	cx, cx
  1795 00000D30 75CE                <1> 	jnz	short lff16m2_1
  1796 00000D32 E925FC              <1> 	jmp	lff16m2_3
  1797                              <1> 
  1798                              <1> lff16m2_7:
  1799                              <1> lff16s2_7:
  1800 00000D35 E93CFC              <1> 	jmp	lff16m2_5  ; error
  1801                              <1> 
  1802                              <1> load_16khz_stereo_16_bit:
  1803                              <1> 	; 16/11/2023
  1804                              <1> 	; 15/11/2023
  1805                              <1> 	; 13/11/2023
  1806 00000D38 F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1807                              <1> 					; last of the file?
  1808 00000D3D 7402                <1> 	jz	short lff16s2_0		; no
  1809 00000D3F F9                  <1> 	stc
  1810 00000D40 C3                  <1> 	retn
  1811                              <1> 
  1812                              <1> lff16s2_0:
  1813 00000D41 8EC0                <1> 	mov	es, ax ; buffer segment	
  1814 00000D43 31FF                <1> 	xor	di, di
  1815 00000D45 BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1816                              <1> 	; ds = cs
  1817                              <1> 
  1818                              <1> 	; load file into memory
  1819 00000D48 8B0E[8106]          <1>         mov	cx, [loadsize]
  1820 00000D4C 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  1821 00000D50 B43F                <1>        	mov	ah, 3Fh
  1822 00000D52 CD21                <1> 	int	21h
  1823 00000D54 72DF                <1> 	jc	short lff16s2_7 ; error !
  1824                              <1> 
  1825 00000D56 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1826                              <1> 	
  1827                              <1> 	;shr	ax, 1
  1828 00000D58 C1E802              <1> 	shr	ax, 2	; 16/11/2023
  1829                              <1> 	;and	ax, ax
  1830 00000D5B 7503                <1> 	jnz	short lff16s2_8
  1831                              <1> 	;jmp	lff16s2_3
  1832                              <1> 	; 15/11/2023
  1833 00000D5D E90DFC              <1> 	jmp	lff16_eof
  1834                              <1> 
  1835                              <1> lff16s2_8:
  1836 00000D60 89C1                <1> 	mov	cx, ax		; dword count
  1837                              <1> lff16s2_1:
  1838 00000D62 AD                  <1> 	lodsw
  1839 00000D63 AB                  <1> 	stosw		; original sample (L)
  1840 00000D64 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  1841 00000D67 A3[C519]            <1> 	mov	[previous_val_l], ax
  1842 00000D6A AD                  <1> 	lodsw
  1843 00000D6B AB                  <1> 	stosw		; original sample (R)
  1844 00000D6C 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  1845 00000D6F A3[C719]            <1> 	mov	[previous_val_r], ax
  1846 00000D72 31D2                <1> 	xor	dx, dx
  1847 00000D74 31C0                <1> 	xor	ax, ax
  1848                              <1> 	; 16/11/2023
  1849 00000D76 49                  <1> 	dec	cx
  1850 00000D77 7405                <1> 	jz	short lff16s2_2
  1851 00000D79 8B04                <1> 	mov	ax, [si]
  1852 00000D7B 8B5402              <1> 	mov	dx, [si+2]
  1853                              <1> lff16s2_2:
  1854 00000D7E 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  1855                              <1> 	;mov	[next_val_l], ax
  1856 00000D81 89C5                <1> 	mov	bp, ax
  1857 00000D83 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format 
  1858 00000D86 8916[CB19]          <1> 	mov	[next_val_r], dx
  1859 00000D8A 0306[C519]          <1> 	add	ax, [previous_val_l]
  1860 00000D8E D1D8                <1> 	rcr	ax, 1
  1861 00000D90 89C2                <1> 	mov	dx, ax	; this is temporary interpolation value (L)
  1862 00000D92 0306[C519]          <1> 	add	ax, [previous_val_l]
  1863 00000D96 D1D8                <1> 	rcr	ax, 1
  1864 00000D98 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  1865 00000D9B AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1866 00000D9C A1[CB19]            <1> 	mov	ax, [next_val_r]
  1867 00000D9F 0306[C719]          <1> 	add	ax, [previous_val_r]
  1868 00000DA3 D1D8                <1> 	rcr	ax, 1
  1869 00000DA5 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value (R)
  1870 00000DA7 0306[C719]          <1> 	add	ax, [previous_val_r]
  1871 00000DAB D1D8                <1> 	rcr	ax, 1
  1872 00000DAD 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1873 00000DB0 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1874                              <1> 	;mov	ax, [next_val_l]
  1875 00000DB1 89E8                <1> 	mov	ax, bp
  1876 00000DB3 01D0                <1> 	add	ax, dx
  1877 00000DB5 D1D8                <1> 	rcr	ax, 1
  1878 00000DB7 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1879 00000DBA AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1880 00000DBB A1[CB19]            <1> 	mov	ax, [next_val_r]
  1881 00000DBE 01D8                <1> 	add	ax, bx
  1882 00000DC0 D1D8                <1> 	rcr	ax, 1
  1883 00000DC2 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1884 00000DC5 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1885                              <1> 	
  1886                              <1> 	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1887 00000DC6 09C9                <1> 	or	cx, cx
  1888 00000DC8 7598                <1> 	jnz	short lff16s2_1
  1889 00000DCA E98DFB              <1> 	jmp	lff16s2_3
  1890                              <1> 
  1891                              <1> ; .....................
  1892                              <1> 
  1893                              <1> load_24khz_mono_8_bit:
  1894                              <1> 	; 15/11/2023
  1895 00000DCD F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1896                              <1> 					; last of the file?
  1897 00000DD2 7402                <1> 	jz	short lff24m_0		; no
  1898 00000DD4 F9                  <1> 	stc
  1899 00000DD5 C3                  <1> 	retn
  1900                              <1> 
  1901                              <1> lff24m_0:
  1902 00000DD6 8EC0                <1> 	mov	es, ax ; buffer segment	
  1903 00000DD8 31FF                <1> 	xor	di, di
  1904 00000DDA BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1905                              <1> 	; ds = cs
  1906                              <1> 
  1907                              <1> 	; load file into memory
  1908 00000DDD 8B0E[8106]          <1>         mov	cx, [loadsize]
  1909 00000DE1 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  1910 00000DE5 B43F                <1>        	mov	ah, 3Fh
  1911 00000DE7 CD21                <1> 	int	21h
  1912 00000DE9 722E                <1> 	jc	short lff24m_7 ; error !
  1913                              <1> 
  1914 00000DEB 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1915                              <1> 	
  1916 00000DED 21C0                <1> 	and	ax, ax
  1917 00000DEF 7503                <1> 	jnz	short lff24m_8
  1918 00000DF1 E979FB              <1> 	jmp	lff24_eof
  1919                              <1> 
  1920                              <1> lff24m_8:
  1921 00000DF4 89C1                <1> 	mov	cx, ax		; byte count
  1922                              <1> lff24m_1:
  1923 00000DF6 AC                  <1> 	lodsb
  1924                              <1> 	;mov	[previous_val], al
  1925 00000DF7 88C3                <1> 	mov	bl, al
  1926 00000DF9 2C80                <1> 	sub	al, 80h
  1927 00000DFB C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1928 00000DFE AB                  <1> 	stosw		; original sample (left channel)
  1929 00000DFF AB                  <1> 	stosw		; original sample (right channel)
  1930                              <1> 	;xor	ax, ax
  1931 00000E00 B080                <1> 	mov	al, 80h
  1932 00000E02 49                  <1> 	dec	cx
  1933 00000E03 7402                <1> 	jz	short lff24m_2
  1934 00000E05 8A04                <1> 	mov	al, [si]
  1935                              <1> lff24m_2:
  1936                              <1> 	;;mov	[next_val], al
  1937                              <1> 	;mov	bh, al
  1938                              <1> 	;add	al, [previous_val]
  1939 00000E07 00D8                <1> 	add	al, bl
  1940 00000E09 D0D8                <1> 	rcr	al, 1
  1941 00000E0B 2C80                <1> 	sub	al, 80h
  1942 00000E0D C1E008              <1> 	shl	ax, 8
  1943 00000E10 AB                  <1> 	stosw		; this is interpolated sample (L)
  1944 00000E11 AB                  <1> 	stosw		; this is interpolated sample (R)
  1945                              <1> 	
  1946                              <1> 	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1947 00000E12 09C9                <1> 	or	cx, cx
  1948 00000E14 75E0                <1> 	jnz	short lff24m_1
  1949 00000E16 E941FB              <1> 	jmp	lff24_3
  1950                              <1> 
  1951                              <1> lff24m_7:
  1952                              <1> lff24s_7:
  1953 00000E19 E958FB              <1> 	jmp	lff24_5  ; error
  1954                              <1> 
  1955                              <1> load_24khz_stereo_8_bit:
  1956                              <1> 	; 15/11/2023
  1957 00000E1C F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1958                              <1> 					; last of the file?
  1959 00000E21 7402                <1> 	jz	short lff24s_0		; no
  1960 00000E23 F9                  <1> 	stc
  1961 00000E24 C3                  <1> 	retn
  1962                              <1> 
  1963                              <1> lff24s_0:
  1964 00000E25 8EC0                <1> 	mov	es, ax ; buffer segment	
  1965 00000E27 31FF                <1> 	xor	di, di
  1966 00000E29 BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1967                              <1> 	; ds = cs
  1968                              <1> 
  1969                              <1> 	; load file into memory
  1970 00000E2C 8B0E[8106]          <1>         mov	cx, [loadsize]
  1971 00000E30 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  1972 00000E34 B43F                <1>        	mov	ah, 3Fh
  1973 00000E36 CD21                <1> 	int	21h
  1974 00000E38 72DF                <1> 	jc	short lff24s_7 ; error !
  1975                              <1> 
  1976 00000E3A 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1977                              <1> 	
  1978 00000E3C D1E8                <1> 	shr	ax, 1
  1979                              <1> 	;and	ax, ax
  1980 00000E3E 7503                <1> 	jnz	short lff24s_8
  1981 00000E40 E92AFB              <1> 	jmp	lff24_eof
  1982                              <1> 
  1983                              <1> lff24s_8:
  1984 00000E43 89C1                <1> 	mov	cx, ax		; word count
  1985                              <1> lff24s_1:
  1986 00000E45 AC                  <1> 	lodsb
  1987 00000E46 A2[C519]            <1> 	mov	[previous_val_l], al
  1988 00000E49 2C80                <1> 	sub	al, 80h
  1989 00000E4B C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1990 00000E4E AB                  <1> 	stosw		; original sample (L)
  1991 00000E4F AC                  <1> 	lodsb
  1992 00000E50 A2[C719]            <1> 	mov	[previous_val_r], al
  1993 00000E53 2C80                <1> 	sub	al, 80h
  1994 00000E55 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1995 00000E58 AB                  <1> 	stosw		; original sample (R)
  1996                              <1> 
  1997                              <1> 	;xor	ax, ax
  1998 00000E59 B88080              <1> 	mov	ax, 8080h
  1999 00000E5C 49                  <1> 	dec	cx
  2000 00000E5D 7402                <1> 	jz	short lff24s_2
  2001                              <1> 		; convert 8 bit sample to 16 bit sample
  2002 00000E5F 8B04                <1> 	mov	ax, [si]
  2003                              <1> lff24s_2:
  2004                              <1> 	;;mov	[next_val_l], al
  2005                              <1> 	;;mov	[next_val_r], ah
  2006                              <1> 	;mov	bx, ax
  2007 00000E61 88E7                <1> 	mov	bh, ah
  2008 00000E63 0206[C519]          <1> 	add	al, [previous_val_l]
  2009 00000E67 D0D8                <1> 	rcr	al, 1
  2010                              <1> 	;mov	dl, al
  2011 00000E69 2C80                <1> 	sub	al, 80h
  2012 00000E6B C1E008              <1> 	shl	ax, 8
  2013 00000E6E AB                  <1> 	stosw		; this is interpolated sample (L)
  2014 00000E6F 88F8                <1> 	mov	al, bh	; [next_val_r]
  2015 00000E71 0206[C719]          <1> 	add	al, [previous_val_r]
  2016 00000E75 D0D8                <1> 	rcr	al, 1
  2017                              <1> 	;mov	dh, al
  2018 00000E77 2C80                <1> 	sub	al, 80h
  2019 00000E79 C1E008              <1> 	shl	ax, 8
  2020 00000E7C AB                  <1> 	stosw		; this is interpolated sample (R)
  2021                              <1> 		
  2022                              <1> 	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2023 00000E7D 09C9                <1> 	or	cx, cx
  2024 00000E7F 75C4                <1> 	jnz	short lff24s_1
  2025 00000E81 E9D6FA              <1> 	jmp	lff24_3
  2026                              <1> 
  2027                              <1> load_24khz_mono_16_bit:
  2028                              <1> 	; 15/11/2023
  2029 00000E84 F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2030                              <1> 					; last of the file?
  2031 00000E89 7402                <1> 	jz	short lff24m2_0		; no
  2032 00000E8B F9                  <1> 	stc
  2033 00000E8C C3                  <1> 	retn
  2034                              <1> 
  2035                              <1> lff24m2_0:
  2036 00000E8D 8EC0                <1> 	mov	es, ax ; buffer segment	
  2037 00000E8F 31FF                <1> 	xor	di, di
  2038 00000E91 BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2039                              <1> 	; ds = cs
  2040                              <1> 
  2041                              <1> 	; load file into memory
  2042 00000E94 8B0E[8106]          <1>         mov	cx, [loadsize]
  2043 00000E98 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  2044 00000E9C B43F                <1>        	mov	ah, 3Fh
  2045 00000E9E CD21                <1> 	int	21h
  2046 00000EA0 7228                <1> 	jc	short lff24m2_7 ; error !
  2047                              <1> 
  2048 00000EA2 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2049                              <1> 	
  2050 00000EA4 D1E8                <1> 	shr	ax, 1
  2051                              <1> 	;and	ax, ax
  2052 00000EA6 7503                <1> 	jnz	short lff24m2_8
  2053 00000EA8 E9C2FA              <1> 	jmp	lff24_eof
  2054                              <1> 
  2055                              <1> lff24m2_8:
  2056 00000EAB 89C1                <1> 	mov	cx, ax	; word count
  2057                              <1> lff24m2_1:
  2058 00000EAD AD                  <1> 	lodsw
  2059 00000EAE AB                  <1> 	stosw		; original sample (left channel)
  2060 00000EAF AB                  <1> 	stosw		; original sample (right channel)
  2061 00000EB0 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  2062                              <1> 	;mov	[previous_val], ax
  2063                              <1> 	;mov	bx, ax	
  2064                              <1> 	;xor	ax, ax
  2065 00000EB3 31DB                <1> 	xor	bx, bx
  2066 00000EB5 49                  <1> 	dec	cx
  2067 00000EB6 7402                <1> 	jz	short lff24m2_2
  2068                              <1> 	;mov	ax, [si
  2069 00000EB8 8B1C                <1> 	mov	bx, [si]
  2070                              <1> lff24m2_2:
  2071                              <1> 	;add	ah, 80h ; convert sound level 0 to 65535 format
  2072                              <1> 	;mov	bp, ax	; [next_val]
  2073                              <1> 	;add	ax, [previous_val]
  2074                              <1> 	; ax = [previous_val]
  2075                              <1> 	; bx = [next_val]
  2076 00000EBA 01D8                <1> 	add	ax, bx
  2077 00000EBC D1D8                <1> 	rcr	ax, 1
  2078 00000EBE 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2079 00000EC1 AB                  <1> 	stosw		; this is interpolated sample (L)
  2080 00000EC2 AB                  <1> 	stosw		; this is interpolated sample (R)
  2081                              <1> 	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2082 00000EC3 09C9                <1> 	or	cx, cx
  2083 00000EC5 75E6                <1> 	jnz	short lff24m2_1
  2084 00000EC7 E990FA              <1> 	jmp	lff24_3
  2085                              <1> 
  2086                              <1> lff24m2_7:
  2087                              <1> lff24s2_7:
  2088 00000ECA E9A7FA              <1> 	jmp	lff24_5  ; error
  2089                              <1> 
  2090                              <1> load_24khz_stereo_16_bit:
  2091                              <1> 	; 16/11/2023
  2092                              <1> 	; 15/11/2023
  2093 00000ECD F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2094                              <1> 					; last of the file?
  2095 00000ED2 7402                <1> 	jz	short lff24s2_0		; no
  2096 00000ED4 F9                  <1> 	stc
  2097 00000ED5 C3                  <1> 	retn
  2098                              <1> 
  2099                              <1> lff24s2_0:
  2100 00000ED6 8EC0                <1> 	mov	es, ax ; buffer segment	
  2101 00000ED8 31FF                <1> 	xor	di, di
  2102 00000EDA BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2103                              <1> 	; ds = cs
  2104                              <1> 
  2105                              <1> 	; load file into memory
  2106 00000EDD 8B0E[8106]          <1>         mov	cx, [loadsize]
  2107 00000EE1 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  2108 00000EE5 B43F                <1>        	mov	ah, 3Fh
  2109 00000EE7 CD21                <1> 	int	21h
  2110 00000EE9 72DF                <1> 	jc	short lff24s2_7 ; error !
  2111                              <1> 
  2112 00000EEB 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2113                              <1> 	
  2114                              <1> 	;shr	ax, 1
  2115 00000EED C1E802              <1> 	shr	ax, 2	; 16/11/2023
  2116                              <1> 	;and	ax, ax
  2117 00000EF0 7503                <1> 	jnz	short lff24s2_8
  2118 00000EF2 E978FA              <1> 	jmp	lff24_eof
  2119                              <1> 
  2120                              <1> lff24s2_8:
  2121 00000EF5 89C1                <1> 	mov	cx, ax		; dword count
  2122                              <1> lff24s2_1:
  2123 00000EF7 AD                  <1> 	lodsw
  2124 00000EF8 AB                  <1> 	stosw		; original sample (L)
  2125 00000EF9 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2126 00000EFC A3[C519]            <1> 	mov	[previous_val_l], ax
  2127 00000EFF AD                  <1> 	lodsw
  2128 00000F00 AB                  <1> 	stosw		; original sample (R)
  2129 00000F01 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2130                              <1> 	;mov	[previous_val_r], ax
  2131 00000F04 89C3                <1> 	mov	bx, ax
  2132 00000F06 31D2                <1> 	xor	dx, dx
  2133 00000F08 31C0                <1> 	xor	ax, ax
  2134                              <1> 	; 16/11/2023
  2135 00000F0A 49                  <1> 	dec	cx
  2136 00000F0B 7405                <1> 	jz	short lff24s2_2
  2137 00000F0D 8B04                <1> 	mov	ax, [si]
  2138 00000F0F 8B5402              <1> 	mov	dx, [si+2]
  2139                              <1> lff24s2_2:
  2140 00000F12 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2141                              <1> 	;;mov	[next_val_l], ax
  2142                              <1> 	;mov	bp, ax
  2143 00000F15 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format 
  2144                              <1> 	;mov	[next_val_r], dx
  2145 00000F18 0306[C519]          <1> 	add	ax, [previous_val_l]
  2146 00000F1C D1D8                <1> 	rcr	ax, 1
  2147 00000F1E 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  2148 00000F21 AB                  <1> 	stosw		; this is interpolated sample (L)
  2149                              <1> 	;mov	ax, [next_val_r]
  2150 00000F22 89D0                <1> 	mov	ax, dx
  2151                              <1> 	;add	ax, [previous_val_r]
  2152 00000F24 01D8                <1> 	add	ax, bx
  2153 00000F26 D1D8                <1> 	rcr	ax, 1
  2154 00000F28 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2155 00000F2B AB                  <1> 	stosw		; this is interpolated sample (R)
  2156                              <1> 	
  2157                              <1> 	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2158 00000F2C 09C9                <1> 	or	cx, cx
  2159 00000F2E 75C7                <1> 	jnz	short lff24s2_1
  2160 00000F30 E927FA              <1> 	jmp	lff24_3
  2161                              <1> 
  2162                              <1> ; .....................
  2163                              <1> 
  2164                              <1> load_32khz_mono_8_bit:
  2165                              <1> 	; 15/11/2023
  2166 00000F33 F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2167                              <1> 					; last of the file?
  2168 00000F38 7402                <1> 	jz	short lff32m_0		; no
  2169 00000F3A F9                  <1> 	stc
  2170 00000F3B C3                  <1> 	retn
  2171                              <1> 
  2172                              <1> lff32m_0:
  2173 00000F3C 8EC0                <1> 	mov	es, ax ; buffer segment	
  2174 00000F3E 31FF                <1> 	xor	di, di
  2175 00000F40 BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2176                              <1> 	; ds = cs
  2177                              <1> 
  2178                              <1> 	; load file into memory
  2179 00000F43 8B0E[8106]          <1>         mov	cx, [loadsize]
  2180 00000F47 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  2181 00000F4B B43F                <1>        	mov	ah, 3Fh
  2182 00000F4D CD21                <1> 	int	21h
  2183 00000F4F 7237                <1> 	jc	short lff32m_7 ; error !
  2184                              <1> 
  2185 00000F51 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2186                              <1> 	
  2187 00000F53 21C0                <1> 	and	ax, ax
  2188 00000F55 7503                <1> 	jnz	short lff32m_8
  2189 00000F57 E913FA              <1> 	jmp	lff32_eof
  2190                              <1> 
  2191                              <1> lff32m_8:
  2192 00000F5A 89C1                <1> 	mov	cx, ax		; byte count
  2193                              <1> lff32m_1:
  2194 00000F5C AC                  <1> 	lodsb
  2195                              <1> 	;mov	[previous_val], al
  2196 00000F5D 88C3                <1> 	mov	bl, al
  2197 00000F5F 2C80                <1> 	sub	al, 80h
  2198 00000F61 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2199 00000F64 AB                  <1> 	stosw		; original sample (left channel)
  2200 00000F65 AB                  <1> 	stosw		; original sample (right channel)
  2201                              <1> 	;xor	ax, ax
  2202 00000F66 B080                <1> 	mov	al, 80h
  2203 00000F68 49                  <1> 	dec	cx
  2204 00000F69 7402                <1> 	jz	short lff32m_2
  2205 00000F6B 8A04                <1> 	mov	al, [si]
  2206                              <1> lff32m_2:
  2207                              <1> 	;;mov	[next_val], al
  2208                              <1> 	;mov	bh, al
  2209                              <1> 	;add	al, [previous_val]
  2210 00000F6D 00D8                <1> 	add	al, bl
  2211 00000F6F D0D8                <1> 	rcr	al, 1
  2212 00000F71 2C80                <1> 	sub	al, 80h
  2213 00000F73 C1E008              <1> 	shl	ax, 8
  2214 00000F76 AB                  <1> 	stosw		; this is interpolated sample (L)
  2215 00000F77 AB                  <1> 	stosw		; this is interpolated sample (R)
  2216                              <1> 	
  2217                              <1> 	; different than 8-16-24 kHZ !
  2218                              <1> 	; 'original-interpolated-original' trio samples 
  2219 00000F78 E30B                <1> 	jcxz	lff32m_3
  2220                              <1> 
  2221 00000F7A AC                  <1> 	lodsb
  2222 00000F7B 2C80                <1> 	sub	al, 80h
  2223 00000F7D C1E008              <1> 	shl	ax, 8
  2224 00000F80 AB                  <1> 	stosw		; original sample (left channel)
  2225 00000F81 AB                  <1> 	stosw		; original sample (right channel)
  2226                              <1> 
  2227                              <1> 	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2228 00000F82 49                  <1> 	dec	cx
  2229 00000F83 75D7                <1> 	jnz	short lff32m_1
  2230                              <1> lff32m_3:
  2231 00000F85 E9D2F9              <1> 	jmp	lff32_3
  2232                              <1> 
  2233                              <1> lff32m_7:
  2234                              <1> lff32s_7:
  2235 00000F88 E9E9F9              <1> 	jmp	lff32_5  ; error
  2236                              <1> 
  2237                              <1> load_32khz_stereo_8_bit:
  2238                              <1> 	; 15/11/2023
  2239 00000F8B F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2240                              <1> 					; last of the file?
  2241 00000F90 7402                <1> 	jz	short lff32s_0		; no
  2242 00000F92 F9                  <1> 	stc
  2243 00000F93 C3                  <1> 	retn
  2244                              <1> 
  2245                              <1> lff32s_0:
  2246 00000F94 8EC0                <1> 	mov	es, ax ; buffer segment	
  2247 00000F96 31FF                <1> 	xor	di, di
  2248 00000F98 BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2249                              <1> 	; ds = cs
  2250                              <1> 
  2251                              <1> 	; load file into memory
  2252 00000F9B 8B0E[8106]          <1>         mov	cx, [loadsize]
  2253 00000F9F 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  2254 00000FA3 B43F                <1>        	mov	ah, 3Fh
  2255 00000FA5 CD21                <1> 	int	21h
  2256 00000FA7 72DF                <1> 	jc	short lff32s_7 ; error !
  2257                              <1> 
  2258 00000FA9 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2259                              <1> 	
  2260 00000FAB D1E8                <1> 	shr	ax, 1
  2261                              <1> 	;and	ax, ax
  2262 00000FAD 7503                <1> 	jnz	short lff32s_8
  2263 00000FAF E9BBF9              <1> 	jmp	lff32_eof
  2264                              <1> 
  2265                              <1> lff32s_8:
  2266 00000FB2 89C1                <1> 	mov	cx, ax		; word count
  2267                              <1> lff32s_1:
  2268 00000FB4 AC                  <1> 	lodsb
  2269 00000FB5 A2[C519]            <1> 	mov	[previous_val_l], al
  2270 00000FB8 2C80                <1> 	sub	al, 80h
  2271 00000FBA C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2272 00000FBD AB                  <1> 	stosw		; original sample (L)
  2273 00000FBE AC                  <1> 	lodsb
  2274 00000FBF A2[C719]            <1> 	mov	[previous_val_r], al
  2275 00000FC2 2C80                <1> 	sub	al, 80h
  2276 00000FC4 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2277 00000FC7 AB                  <1> 	stosw		; original sample (R)
  2278                              <1> 
  2279                              <1> 	;xor	ax, ax
  2280 00000FC8 B88080              <1> 	mov	ax, 8080h
  2281 00000FCB 49                  <1> 	dec	cx
  2282 00000FCC 7402                <1> 	jz	short lff32s_2
  2283                              <1> 		; convert 8 bit sample to 16 bit sample
  2284 00000FCE 8B04                <1> 	mov	ax, [si]
  2285                              <1> lff32s_2:
  2286                              <1> 	;;mov	[next_val_l], al
  2287                              <1> 	;;mov	[next_val_r], ah
  2288                              <1> 	;mov	bx, ax
  2289 00000FD0 88E7                <1> 	mov	bh, ah
  2290 00000FD2 0206[C519]          <1> 	add	al, [previous_val_l]
  2291 00000FD6 D0D8                <1> 	rcr	al, 1
  2292                              <1> 	;mov	dl, al
  2293 00000FD8 2C80                <1> 	sub	al, 80h
  2294 00000FDA C1E008              <1> 	shl	ax, 8
  2295 00000FDD AB                  <1> 	stosw		; this is interpolated sample (L)
  2296 00000FDE 88F8                <1> 	mov	al, bh	; [next_val_r]
  2297 00000FE0 0206[C719]          <1> 	add	al, [previous_val_r]
  2298 00000FE4 D0D8                <1> 	rcr	al, 1
  2299                              <1> 	;mov	dh, al
  2300 00000FE6 2C80                <1> 	sub	al, 80h
  2301 00000FE8 C1E008              <1> 	shl	ax, 8
  2302 00000FEB AB                  <1> 	stosw		; this is interpolated sample (R)
  2303                              <1> 
  2304                              <1> 	; different than 8-16-24 kHZ !
  2305                              <1> 	; 'original-interpolated-original' trio samples 
  2306 00000FEC E311                <1> 	jcxz	lff32s_3
  2307                              <1> 
  2308 00000FEE AC                  <1> 	lodsb
  2309 00000FEF 2C80                <1> 	sub	al, 80h
  2310 00000FF1 C1E008              <1> 	shl	ax, 8
  2311 00000FF4 AB                  <1> 	stosw		; original sample (left channel)
  2312                              <1> 
  2313 00000FF5 AC                  <1> 	lodsb
  2314 00000FF6 2C80                <1> 	sub	al, 80h
  2315 00000FF8 C1E008              <1> 	shl	ax, 8
  2316 00000FFB AB                  <1> 	stosw		; original sample (right channel)
  2317                              <1> 		
  2318                              <1> 	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2319 00000FFC 49                  <1> 	dec	cx
  2320 00000FFD 75B5                <1> 	jnz	short lff32s_1
  2321                              <1> lff32s_3:
  2322 00000FFF E958F9              <1> 	jmp	lff32_3
  2323                              <1> 
  2324                              <1> load_32khz_mono_16_bit:
  2325                              <1> 	; 15/11/2023
  2326 00001002 F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2327                              <1> 					; last of the file?
  2328 00001007 7402                <1> 	jz	short lff32m2_0		; no
  2329 00001009 F9                  <1> 	stc
  2330 0000100A C3                  <1> 	retn
  2331                              <1> 
  2332                              <1> lff32m2_0:
  2333 0000100B 8EC0                <1> 	mov	es, ax ; buffer segment	
  2334 0000100D 31FF                <1> 	xor	di, di
  2335 0000100F BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2336                              <1> 	; ds = cs
  2337                              <1> 
  2338                              <1> 	; load file into memory
  2339 00001012 8B0E[8106]          <1>         mov	cx, [loadsize]
  2340 00001016 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  2341 0000101A B43F                <1>        	mov	ah, 3Fh
  2342 0000101C CD21                <1> 	int	21h
  2343 0000101E 722C                <1> 	jc	short lff32m2_7 ; error !
  2344                              <1> 
  2345 00001020 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2346                              <1> 	
  2347 00001022 D1E8                <1> 	shr	ax, 1
  2348                              <1> 	;and	ax, ax
  2349 00001024 7503                <1> 	jnz	short lff32m2_8
  2350 00001026 E944F9              <1> 	jmp	lff32_eof
  2351                              <1> 
  2352                              <1> lff32m2_8:
  2353 00001029 89C1                <1> 	mov	cx, ax	; word count
  2354                              <1> lff32m2_1:
  2355 0000102B AD                  <1> 	lodsw
  2356 0000102C AB                  <1> 	stosw		; original sample (left channel)
  2357 0000102D AB                  <1> 	stosw		; original sample (right channel)
  2358 0000102E 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  2359                              <1> 	;mov	[previous_val], ax
  2360                              <1> 	;mov	bx, ax	
  2361                              <1> 	;xor	ax, ax
  2362 00001031 31DB                <1> 	xor	bx, bx
  2363 00001033 49                  <1> 	dec	cx
  2364 00001034 7402                <1> 	jz	short lff32m2_2
  2365                              <1> 	;mov	ax, [si
  2366 00001036 8B1C                <1> 	mov	bx, [si]
  2367                              <1> lff32m2_2:
  2368                              <1> 	;add	ah, 80h ; convert sound level 0 to 65535 format
  2369                              <1> 	;mov	bp, ax	; [next_val]
  2370                              <1> 	;add	ax, [previous_val]
  2371                              <1> 	; ax = [previous_val]
  2372                              <1> 	; bx = [next_val]
  2373 00001038 01D8                <1> 	add	ax, bx
  2374 0000103A D1D8                <1> 	rcr	ax, 1
  2375 0000103C 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2376 0000103F AB                  <1> 	stosw		; this is interpolated sample (L)
  2377 00001040 AB                  <1> 	stosw		; this is interpolated sample (R)
  2378                              <1> 
  2379                              <1> 	; different than 8-16-24 kHZ !
  2380                              <1> 	; 'original-interpolated-original' trio samples 
  2381 00001041 E306                <1> 	jcxz	lff32m2_3
  2382                              <1> 
  2383 00001043 AD                  <1> 	lodsw
  2384 00001044 AB                  <1> 	stosw		; original sample (left channel)
  2385 00001045 AB                  <1> 	stosw		; original sample (right channel)
  2386                              <1> 
  2387                              <1> 	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2388 00001046 49                  <1> 	dec	cx
  2389 00001047 75E2                <1> 	jnz	short lff32m2_1
  2390                              <1> lff32m2_3:
  2391 00001049 E90EF9              <1> 	jmp	lff32_3
  2392                              <1> 
  2393                              <1> lff32m2_7:
  2394                              <1> lff32s2_7:
  2395 0000104C E925F9              <1> 	jmp	lff32_5  ; error
  2396                              <1> 
  2397                              <1> load_32khz_stereo_16_bit:
  2398                              <1> 	 ;16/11/2023
  2399                              <1> 	; 15/11/2023
  2400 0000104F F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2401                              <1> 					; last of the file?
  2402 00001054 7402                <1> 	jz	short lff32s2_0		; no
  2403 00001056 F9                  <1> 	stc
  2404 00001057 C3                  <1> 	retn
  2405                              <1> 
  2406                              <1> lff32s2_0:
  2407 00001058 8EC0                <1> 	mov	es, ax ; buffer segment	
  2408 0000105A 31FF                <1> 	xor	di, di
  2409 0000105C BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2410                              <1> 	; ds = cs
  2411                              <1> 
  2412                              <1> 	; load file into memory
  2413 0000105F 8B0E[8106]          <1>         mov	cx, [loadsize]
  2414 00001063 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  2415 00001067 B43F                <1>        	mov	ah, 3Fh
  2416 00001069 CD21                <1> 	int	21h
  2417 0000106B 72DF                <1> 	jc	short lff32s2_7 ; error !
  2418                              <1> 
  2419 0000106D 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2420                              <1> 	
  2421 0000106F C1E802              <1> 	shr	ax, 2	; 16/11/2023 (word left ch + word right ch) 
  2422                              <1> 	;and	ax, ax
  2423 00001072 7503                <1> 	jnz	short lff32s2_8
  2424 00001074 E9F6F8              <1> 	jmp	lff32_eof
  2425                              <1> 
  2426                              <1> lff32s2_8:
  2427 00001077 89C1                <1> 	mov	cx, ax		; dword count
  2428                              <1> lff32s2_1:
  2429 00001079 AD                  <1> 	lodsw
  2430 0000107A AB                  <1> 	stosw		; original sample (L)
  2431 0000107B 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2432 0000107E A3[C519]            <1> 	mov	[previous_val_l], ax
  2433 00001081 AD                  <1> 	lodsw
  2434 00001082 AB                  <1> 	stosw		; original sample (R)
  2435 00001083 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2436                              <1> 	;mov	[previous_val_r], ax
  2437 00001086 89C3                <1> 	mov	bx, ax
  2438 00001088 31D2                <1> 	xor	dx, dx
  2439 0000108A 31C0                <1> 	xor	ax, ax
  2440                              <1> 	; 16/11/2023
  2441 0000108C 49                  <1> 	dec	cx
  2442 0000108D 7405                <1> 	jz	short lff32s2_2
  2443 0000108F 8B04                <1> 	mov	ax, [si]
  2444 00001091 8B5402              <1> 	mov	dx, [si+2]
  2445                              <1> lff32s2_2:
  2446 00001094 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2447                              <1> 	;;mov	[next_val_l], ax
  2448                              <1> 	;mov	bp, ax
  2449 00001097 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format 
  2450                              <1> 	;mov	[next_val_r], dx
  2451 0000109A 0306[C519]          <1> 	add	ax, [previous_val_l]
  2452 0000109E D1D8                <1> 	rcr	ax, 1
  2453 000010A0 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  2454 000010A3 AB                  <1> 	stosw		; this is interpolated sample (L)
  2455                              <1> 	;mov	ax, [next_val_r]
  2456 000010A4 89D0                <1> 	mov	ax, dx
  2457                              <1> 	;add	ax, [previous_val_r]
  2458 000010A6 01D8                <1> 	add	ax, bx
  2459 000010A8 D1D8                <1> 	rcr	ax, 1
  2460 000010AA 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2461 000010AD AB                  <1> 	stosw		; this is interpolated sample (R)
  2462                              <1> 
  2463                              <1> 	; different than 8-16-24 kHZ !
  2464                              <1> 	; 'original-interpolated-original' trio samples 
  2465 000010AE E307                <1> 	jcxz	lff32s2_3
  2466                              <1> 
  2467 000010B0 AD                  <1> 	lodsw
  2468 000010B1 AB                  <1> 	stosw	; original sample (L)
  2469 000010B2 AD                  <1> 	lodsw
  2470 000010B3 AB                  <1> 	stosw	; original sample (R)
  2471                              <1> 	
  2472                              <1> 	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2473 000010B4 49                  <1> 	dec	cx
  2474 000010B5 75C2                <1> 	jnz	short lff32s2_1
  2475                              <1> lff32s2_3:
  2476 000010B7 E9A0F8              <1> 	jmp	lff32_3
  2477                              <1> 
  2478                              <1> ; .....................
  2479                              <1> 
  2480                              <1> load_22khz_mono_8_bit:
  2481                              <1> 	; 16/11/2023
  2482 000010BA F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2483                              <1> 					; last of the file?
  2484 000010BF 7402                <1> 	jz	short lff22m_0		; no
  2485 000010C1 F9                  <1> 	stc
  2486 000010C2 C3                  <1> 	retn
  2487                              <1> 
  2488                              <1> lff22m_0:
  2489 000010C3 8EC0                <1> 	mov	es, ax ; buffer segment	
  2490 000010C5 31FF                <1> 	xor	di, di
  2491 000010C7 BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2492                              <1> 	; ds = cs
  2493                              <1> 
  2494                              <1> 	; load file into memory
  2495 000010CA 8B0E[8106]          <1>         mov	cx, [loadsize]
  2496 000010CE 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  2497 000010D2 B43F                <1>        	mov	ah, 3Fh
  2498 000010D4 CD21                <1> 	int	21h
  2499 000010D6 7248                <1> 	jc	short lff22m_7 ; error !
  2500                              <1> 
  2501 000010D8 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2502                              <1> 	
  2503 000010DA 21C0                <1> 	and	ax, ax
  2504 000010DC 7503                <1> 	jnz	short lff22m_8
  2505 000010DE E98CF8              <1> 	jmp	lff22_eof
  2506                              <1> 
  2507                              <1> lff22m_8:
  2508 000010E1 89C1                <1> 	mov	cx, ax		; byte count
  2509                              <1> lff22m_9:
  2510 000010E3 BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2511 000010E6 C606[CD19]03        <1> 	mov	byte [faz], 3  ; 3 steps/phases
  2512                              <1> lff22m_1:
  2513                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2514 000010EB AC                  <1> 	lodsb
  2515 000010EC B280                <1> 	mov	dl, 80h
  2516 000010EE 49                  <1> 	dec	cx
  2517 000010EF 7402                <1> 	jz	short lff22m_2_1
  2518 000010F1 8A14                <1> 	mov	dl, [si]
  2519                              <1> lff22m_2_1:	
  2520                              <1> 	; al = [previous_val]
  2521                              <1> 	; dl = [next_val]
  2522 000010F3 E8A004              <1> 	call	interpolating_3_8bit_mono ; 1 of 17
  2523 000010F6 E325                <1> 	jcxz	lff22m_3
  2524                              <1> lff22m_2_2:
  2525 000010F8 AC                  <1> 	lodsb
  2526 000010F9 B280                <1> 	mov	dl, 80h
  2527 000010FB 49                  <1> 	dec	cx
  2528 000010FC 7402                <1> 	jz	short lff22m_2_3
  2529 000010FE 8A14                <1> 	mov	dl, [si]
  2530                              <1> lff22m_2_3:
  2531 00001100 E80205              <1>  	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  2532 00001103 E318                <1> 	jcxz	lff22m_3
  2533 00001105 4D                  <1> 	dec	bp
  2534 00001106 75F0                <1> 	jnz	short lff22m_2_2
  2535                              <1> 
  2536 00001108 A0[CD19]            <1> 	mov	al, [faz]
  2537 0000110B FEC8                <1> 	dec	al
  2538 0000110D 74D4                <1> 	jz	short lff22m_9
  2539 0000110F FE0E[CD19]          <1> 	dec	byte [faz]
  2540 00001113 BD0400              <1> 	mov	bp, 4
  2541 00001116 FEC8                <1> 	dec	al
  2542 00001118 75D1                <1> 	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  2543 0000111A 45                  <1> 	inc	bp ; 5
  2544 0000111B EBCE                <1> 	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2545                              <1> 
  2546                              <1> lff22m_3:
  2547                              <1> lff22s_3:
  2548 0000111D E93AF8              <1> 	jmp	lff22_3	; padfill
  2549                              <1> 		; (put zeros in the remain words of the buffer)
  2550                              <1> lff22m_7:
  2551                              <1> lff22s_7:
  2552 00001120 E951F8              <1> 	jmp	lff22_5  ; error
  2553                              <1> 
  2554                              <1> load_22khz_stereo_8_bit:
  2555                              <1> 	; 16/11/2023
  2556 00001123 F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2557                              <1> 					; last of the file?
  2558 00001128 7402                <1> 	jz	short lff22s_0		; no
  2559 0000112A F9                  <1> 	stc
  2560 0000112B C3                  <1> 	retn
  2561                              <1> 
  2562                              <1> lff22s_0:
  2563 0000112C 8EC0                <1> 	mov	es, ax ; buffer segment	
  2564 0000112E 31FF                <1> 	xor	di, di
  2565 00001130 BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2566                              <1> 	; ds = cs
  2567                              <1> 
  2568                              <1> 	; load file into memory
  2569 00001133 8B0E[8106]          <1>         mov	cx, [loadsize]
  2570 00001137 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  2571 0000113B B43F                <1>        	mov	ah, 3Fh
  2572 0000113D CD21                <1> 	int	21h
  2573 0000113F 72DF                <1> 	jc	short lff22s_7 ; error !
  2574                              <1> 
  2575 00001141 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2576                              <1> 	
  2577 00001143 D1E8                <1> 	shr	ax, 1
  2578                              <1> 	;and	ax, ax
  2579 00001145 7503                <1> 	jnz	short lff22s_8
  2580 00001147 E923F8              <1> 	jmp	lff22_eof
  2581                              <1> 
  2582                              <1> lff22s_8:
  2583 0000114A 89C1                <1> 	mov	cx, ax		; word count
  2584                              <1> lff22s_9:
  2585 0000114C BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2586 0000114F C606[CD19]03        <1> 	mov	byte [faz], 3  ; 3 steps/phase
  2587                              <1> lff22s_1:
  2588                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2589 00001154 AD                  <1> 	lodsw
  2590 00001155 BA8080              <1> 	mov	dx, 8080h
  2591 00001158 49                  <1> 	dec	cx
  2592 00001159 7402                <1> 	jz	short lff22s_2_1 
  2593 0000115B 8B14                <1> 	mov	dx, [si]
  2594                              <1> lff22s_2_1:	
  2595                              <1> 	; al = [previous_val_l]
  2596                              <1> 	; ah = [previous_val_r]
  2597                              <1> 	; dl = [next_val_l]
  2598                              <1> 	; dl = [next_val_r]	
  2599 0000115D E85E04              <1> 	call	interpolating_3_8bit_stereo ; 1 of 17 
  2600 00001160 E3BB                <1> 	jcxz	lff22s_3
  2601                              <1> lff22s_2_2:
  2602 00001162 AD                  <1> 	lodsw
  2603 00001163 BA8080              <1> 	mov	dx, 8080h
  2604 00001166 49                  <1> 	dec	cx
  2605 00001167 7402                <1> 	jz	short lff22s_2_3
  2606 00001169 8B14                <1> 	mov	dx, [si]
  2607                              <1> lff22s_2_3:
  2608 0000116B E8AE04              <1>  	call	interpolating_2_8bit_stereo ; 2 of 17 .. 6 of 17
  2609 0000116E E3AD                <1> 	jcxz	lff22s_3
  2610 00001170 4D                  <1> 	dec	bp
  2611 00001171 75EF                <1> 	jnz	short lff22s_2_2
  2612                              <1> 
  2613 00001173 A0[CD19]            <1> 	mov	al, [faz]
  2614 00001176 FEC8                <1> 	dec	al
  2615 00001178 74D2                <1> 	jz	short lff22s_9
  2616 0000117A FE0E[CD19]          <1> 	dec	byte [faz]
  2617 0000117E BD0400              <1> 	mov	bp, 4
  2618 00001181 FEC8                <1> 	dec	al
  2619 00001183 75CF                <1> 	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  2620 00001185 45                  <1> 	inc	bp ; 5
  2621 00001186 EBCC                <1> 	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2622                              <1> 
  2623                              <1> load_22khz_mono_16_bit:
  2624                              <1> 	; 16/11/2023
  2625 00001188 F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2626                              <1> 					; last of the file?
  2627 0000118D 7402                <1> 	jz	short lff22m2_0		; no
  2628 0000118F F9                  <1> 	stc
  2629 00001190 C3                  <1> 	retn
  2630                              <1> 
  2631                              <1> lff22m2_0:
  2632 00001191 8EC0                <1> 	mov	es, ax ; buffer segment	
  2633 00001193 31FF                <1> 	xor	di, di
  2634 00001195 BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2635                              <1> 	; ds = cs
  2636                              <1> 
  2637                              <1> 	; load file into memory
  2638 00001198 8B0E[8106]          <1>         mov	cx, [loadsize]
  2639 0000119C 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  2640 000011A0 B43F                <1>        	mov	ah, 3Fh
  2641 000011A2 CD21                <1> 	int	21h
  2642 000011A4 7248                <1> 	jc	short lff22m2_7 ; error !
  2643                              <1> 
  2644 000011A6 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2645                              <1> 	
  2646 000011A8 D1E8                <1> 	shr	ax, 1
  2647                              <1> 	;and	ax, ax
  2648 000011AA 7503                <1> 	jnz	short lff22m2_8
  2649 000011AC E9BEF7              <1> 	jmp	lff22_eof
  2650                              <1> 
  2651                              <1> lff22m2_8:
  2652 000011AF 89C1                <1> 	mov	cx, ax		; word count
  2653                              <1> lff22m2_9:
  2654 000011B1 BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2655 000011B4 C606[CD19]03        <1> 	mov	byte [faz], 3  ; 3 steps/phases
  2656                              <1> lff22m2_1:
  2657                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2658 000011B9 AD                  <1> 	lodsw
  2659 000011BA 31D2                <1> 	xor	dx, dx
  2660 000011BC 49                  <1> 	dec	cx
  2661 000011BD 7402                <1> 	jz	short lff22m2_2_1
  2662 000011BF 8B14                <1> 	mov	dx, [si]
  2663                              <1> lff22m2_2_1:	
  2664                              <1> 	; ax = [previous_val]
  2665                              <1> 	; dx = [next_val]
  2666 000011C1 E88104              <1> 	call	interpolating_3_16bit_mono ; 1 of 17
  2667 000011C4 E325                <1> 	jcxz	lff22m2_3
  2668                              <1> lff22m2_2_2:
  2669 000011C6 AD                  <1> 	lodsw
  2670 000011C7 31D2                <1> 	xor	dx, dx
  2671 000011C9 49                  <1> 	dec	cx
  2672 000011CA 7402                <1> 	jz	short lff22m2_2_3
  2673 000011CC 8B14                <1> 	mov	dx, [si]
  2674                              <1> lff22m2_2_3:
  2675 000011CE E8E104              <1>  	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  2676 000011D1 E318                <1> 	jcxz	lff22m2_3
  2677 000011D3 4D                  <1> 	dec	bp
  2678 000011D4 75F0                <1> 	jnz	short lff22m2_2_2
  2679                              <1> 
  2680 000011D6 A0[CD19]            <1> 	mov	al, [faz]
  2681 000011D9 FEC8                <1> 	dec	al
  2682 000011DB 74D4                <1> 	jz	short lff22m2_9
  2683 000011DD FE0E[CD19]          <1> 	dec	byte [faz]
  2684 000011E1 BD0400              <1> 	mov	bp, 4
  2685 000011E4 FEC8                <1> 	dec	al
  2686 000011E6 75D1                <1> 	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2687 000011E8 45                  <1> 	inc	bp ; 5
  2688 000011E9 EBCE                <1> 	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2689                              <1> 
  2690                              <1> lff22m2_3:
  2691                              <1> lff22s2_3:
  2692 000011EB E96CF7              <1> 	jmp	lff22_3	; padfill
  2693                              <1> 		; (put zeros in the remain words of the buffer)
  2694                              <1> lff22m2_7:
  2695                              <1> lff22s2_7:
  2696 000011EE E983F7              <1> 	jmp	lff22_5  ; error
  2697                              <1> 
  2698                              <1> load_22khz_stereo_16_bit:
  2699                              <1> 	; 16/11/2023
  2700 000011F1 F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2701                              <1> 					; last of the file?
  2702 000011F6 7402                <1> 	jz	short lff22s2_0		; no
  2703 000011F8 F9                  <1> 	stc
  2704 000011F9 C3                  <1> 	retn
  2705                              <1> 
  2706                              <1> lff22s2_0:
  2707 000011FA 8EC0                <1> 	mov	es, ax ; buffer segment	
  2708 000011FC 31FF                <1> 	xor	di, di
  2709 000011FE BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2710                              <1> 	; ds = cs
  2711                              <1> 
  2712                              <1> 	; load file into memory
  2713 00001201 8B0E[8106]          <1>         mov	cx, [loadsize]
  2714 00001205 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  2715 00001209 B43F                <1>        	mov	ah, 3Fh
  2716 0000120B CD21                <1> 	int	21h
  2717 0000120D 72DF                <1> 	jc	short lff22s2_7 ; error !
  2718                              <1> 
  2719 0000120F 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2720                              <1> 	
  2721 00001211 C1E802              <1> 	shr	ax, 2	; dword (left chan word + right chan word)
  2722                              <1> 	;and	ax, ax
  2723 00001214 7503                <1> 	jnz	short lff22s2_8
  2724 00001216 E954F7              <1> 	jmp	lff22_eof
  2725                              <1> 
  2726                              <1> lff22s2_8:
  2727 00001219 89C1                <1> 	mov	cx, ax		; dword count
  2728                              <1> lff22s2_9:
  2729 0000121B BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2730 0000121E C606[CD19]03        <1> 	mov	byte [faz], 3  ; 3 steps/phase
  2731                              <1> lff22s2_1:
  2732                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2733 00001223 AD                  <1> 	lodsw
  2734 00001224 89C3                <1> 	mov	bx, ax
  2735 00001226 AD                  <1> 	lodsw
  2736 00001227 8B14                <1> 	mov	dx, [si]
  2737 00001229 8916[C919]          <1> 	mov	[next_val_l], dx
  2738 0000122D 8B5402              <1> 	mov	dx, [si+2]
  2739 00001230 49                  <1> 	dec	cx
  2740 00001231 7506                <1> 	jnz	short lff22s2_2_1
  2741 00001233 31D2                <1> 	xor	dx, dx ; 0
  2742 00001235 8916[C919]          <1> 	mov	[next_val_l], dx
  2743                              <1> lff22s2_2_1:
  2744                              <1> 	; bx = [previous_val_l]
  2745                              <1> 	; ax = [previous_val_r]
  2746                              <1> 	; [next_val_l]
  2747                              <1> 	; dx = [next_val_r]
  2748 00001239 E82D04              <1> 	call	interpolating_3_16bit_stereo ; 1 of 17 
  2749 0000123C E3AD                <1> 	jcxz	lff22s2_3
  2750                              <1> lff22s2_2_2:
  2751 0000123E AD                  <1> 	lodsw
  2752 0000123F 89C3                <1> 	mov	bx, ax
  2753 00001241 AD                  <1> 	lodsw
  2754 00001242 8B14                <1> 	mov	dx, [si]
  2755 00001244 8916[C919]          <1> 	mov	[next_val_l], dx
  2756 00001248 8B5402              <1> 	mov	dx, [si+2]
  2757 0000124B 49                  <1> 	dec	cx
  2758 0000124C 7506                <1> 	jnz	short lff22s2_2_3
  2759 0000124E 31D2                <1> 	xor	dx, dx ; 0
  2760 00001250 8916[C919]          <1> 	mov	[next_val_l], dx
  2761                              <1> lff22s2_2_3:
  2762 00001254 E86D04              <1>  	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  2763 00001257 E392                <1> 	jcxz	lff22s2_3
  2764 00001259 4D                  <1> 	dec	bp
  2765 0000125A 75E2                <1> 	jnz	short lff22s2_2_2
  2766                              <1> 
  2767 0000125C A0[CD19]            <1> 	mov	al, [faz]
  2768 0000125F FEC8                <1> 	dec	al
  2769 00001261 74B8                <1> 	jz	short lff22s2_9
  2770 00001263 FE0E[CD19]          <1> 	dec	byte [faz]
  2771 00001267 BD0400              <1> 	mov	bp, 4
  2772 0000126A FEC8                <1> 	dec	al
  2773 0000126C 75B5                <1> 	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2774 0000126E 45                  <1> 	inc	bp ; 5
  2775 0000126F EBB2                <1> 	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2776                              <1> 
  2777                              <1> ; .....................
  2778                              <1> 
  2779                              <1> load_11khz_mono_8_bit:
  2780                              <1> 	; 18/11/2023
  2781 00001271 F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2782                              <1> 					; last of the file?
  2783 00001276 7402                <1> 	jz	short lff11m_0		; no
  2784 00001278 F9                  <1> 	stc
  2785 00001279 C3                  <1> 	retn
  2786                              <1> 
  2787                              <1> lff11m_0:
  2788 0000127A 8EC0                <1> 	mov	es, ax ; buffer segment	
  2789 0000127C 31FF                <1> 	xor	di, di
  2790 0000127E BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2791                              <1> 	; ds = cs
  2792                              <1> 
  2793                              <1> 	; load file into memory
  2794 00001281 8B0E[8106]          <1>         mov	cx, [loadsize]
  2795 00001285 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  2796 00001289 B43F                <1>        	mov	ah, 3Fh
  2797 0000128B CD21                <1> 	int	21h
  2798 0000128D 723D                <1> 	jc	short lff11m_7 ; error !
  2799                              <1> 
  2800 0000128F 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2801                              <1> 	
  2802 00001291 21C0                <1> 	and	ax, ax
  2803 00001293 7503                <1> 	jnz	short lff11m_8
  2804 00001295 E9D5F6              <1> 	jmp	lff11_eof
  2805                              <1> 
  2806                              <1> lff11m_8:
  2807 00001298 89C1                <1> 	mov	cx, ax		; byte count
  2808                              <1> lff11m_9:
  2809 0000129A BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  2810                              <1> lff11m_1:
  2811                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  2812 0000129D AC                  <1> 	lodsb
  2813 0000129E B280                <1> 	mov	dl, 80h
  2814 000012A0 49                  <1> 	dec	cx
  2815 000012A1 7402                <1> 	jz	short lff11m_2_1
  2816 000012A3 8A14                <1> 	mov	dl, [si]
  2817                              <1> lff11m_2_1:	
  2818                              <1> 	; al = [previous_val]
  2819                              <1> 	; dl = [next_val]
  2820 000012A5 E84204              <1> 	call	interpolating_5_8bit_mono
  2821 000012A8 E31F                <1> 	jcxz	lff11m_3
  2822                              <1> lff11m_2_2:
  2823 000012AA AC                  <1> 	lodsb
  2824 000012AB B280                <1> 	mov	dl, 80h
  2825 000012AD 49                  <1> 	dec	cx
  2826 000012AE 7402                <1> 	jz	short lff11m_2_3
  2827 000012B0 8A14                <1> 	mov	dl, [si]
  2828                              <1> lff11m_2_3:
  2829 000012B2 E81E05              <1>  	call	interpolating_4_8bit_mono
  2830 000012B5 E312                <1> 	jcxz	lff11m_3
  2831                              <1> 
  2832 000012B7 4D                  <1> 	dec	bp
  2833 000012B8 74E0                <1> 	jz	short lff11m_9
  2834                              <1> 
  2835 000012BA AC                  <1> 	lodsb
  2836 000012BB B280                <1> 	mov	dl, 80h
  2837 000012BD 49                  <1> 	dec	cx
  2838 000012BE 7402                <1> 	jz	short lff11m_2_4
  2839 000012C0 8A14                <1> 	mov	dl, [si]
  2840                              <1> lff11m_2_4:
  2841 000012C2 E80E05              <1> 	call	interpolating_4_8bit_mono
  2842 000012C5 E302                <1> 	jcxz	lff11m_3
  2843 000012C7 EBD4                <1> 	jmp	short lff11m_1
  2844                              <1> 
  2845                              <1> lff11m_3:
  2846                              <1> lff11s_3:
  2847 000012C9 E98EF6              <1> 	jmp	lff11_3	; padfill
  2848                              <1> 		; (put zeros in the remain words of the buffer)
  2849                              <1> lff11m_7:
  2850                              <1> lff11s_7:
  2851 000012CC E9A5F6              <1> 	jmp	lff11_5  ; error
  2852                              <1> 
  2853                              <1> load_11khz_stereo_8_bit:
  2854                              <1> 	; 18/11/2023
  2855 000012CF F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2856                              <1> 					; last of the file?
  2857 000012D4 7402                <1> 	jz	short lff11s_0		; no
  2858 000012D6 F9                  <1> 	stc
  2859 000012D7 C3                  <1> 	retn
  2860                              <1> 
  2861                              <1> lff11s_0:
  2862 000012D8 8EC0                <1> 	mov	es, ax ; buffer segment	
  2863 000012DA 31FF                <1> 	xor	di, di
  2864 000012DC BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2865                              <1> 	; ds = cs
  2866                              <1> 
  2867                              <1> 	; load file into memory
  2868 000012DF 8B0E[8106]          <1>         mov	cx, [loadsize]
  2869 000012E3 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  2870 000012E7 B43F                <1>        	mov	ah, 3Fh
  2871 000012E9 CD21                <1> 	int	21h
  2872 000012EB 72DF                <1> 	jc	short lff11s_7 ; error !
  2873                              <1> 
  2874 000012ED 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2875                              <1> 	
  2876 000012EF D1E8                <1> 	shr	ax, 1
  2877                              <1> 	;and	ax, ax
  2878 000012F1 7503                <1> 	jnz	short lff11s_8
  2879 000012F3 E977F6              <1> 	jmp	lff11_eof
  2880                              <1> 
  2881                              <1> lff11s_8:
  2882 000012F6 89C1                <1> 	mov	cx, ax		; word count
  2883                              <1> lff11s_9:
  2884 000012F8 BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  2885                              <1> lff11s_1:
  2886                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  2887 000012FB AD                  <1> 	lodsw
  2888 000012FC BA8080              <1> 	mov	dx, 8080h
  2889 000012FF 49                  <1> 	dec	cx
  2890 00001300 7402                <1> 	jz	short lff11s_2_1 
  2891 00001302 8B14                <1> 	mov	dx, [si]
  2892                              <1> lff11s_2_1:	
  2893                              <1> 	; al = [previous_val_l]
  2894                              <1> 	; ah = [previous_val_r]
  2895                              <1> 	; dl = [next_val_l]
  2896                              <1> 	; dl = [next_val_r]	
  2897 00001304 E83304              <1> 	call	interpolating_5_8bit_stereo
  2898 00001307 E3C0                <1> 	jcxz	lff11s_3
  2899                              <1> lff11s_2_2:
  2900 00001309 AD                  <1> 	lodsw
  2901 0000130A BA8080              <1> 	mov	dx, 8080h
  2902 0000130D 49                  <1> 	dec	cx
  2903 0000130E 7402                <1> 	jz	short lff11s_2_3
  2904 00001310 8B14                <1> 	mov	dx, [si]
  2905                              <1> lff11s_2_3:
  2906 00001312 E8F104              <1>  	call	interpolating_4_8bit_stereo
  2907 00001315 E3B2                <1> 	jcxz	lff11s_3
  2908                              <1> 	
  2909 00001317 4D                  <1> 	dec	bp
  2910 00001318 74DE                <1> 	jz	short lff11s_9
  2911                              <1> 
  2912 0000131A AD                  <1> 	lodsw
  2913 0000131B BA8080              <1> 	mov	dx, 8080h
  2914 0000131E 49                  <1> 	dec	cx
  2915 0000131F 7402                <1> 	jz	short lff11s_2_4
  2916 00001321 8B14                <1> 	mov	dx, [si]
  2917                              <1> lff11s_2_4:
  2918 00001323 E8E004              <1> 	call	interpolating_4_8bit_stereo
  2919 00001326 E3A1                <1> 	jcxz	lff11s_3
  2920 00001328 EBD1                <1> 	jmp	short lff11s_1
  2921                              <1> 
  2922                              <1> load_11khz_mono_16_bit:
  2923                              <1> 	; 18/11/2023
  2924 0000132A F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2925                              <1> 					; last of the file?
  2926 0000132F 7402                <1> 	jz	short lff11m2_0		; no
  2927 00001331 F9                  <1> 	stc
  2928 00001332 C3                  <1> 	retn
  2929                              <1> 
  2930                              <1> lff11m2_0:
  2931 00001333 8EC0                <1> 	mov	es, ax ; buffer segment	
  2932 00001335 31FF                <1> 	xor	di, di
  2933 00001337 BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2934                              <1> 	; ds = cs
  2935                              <1> 
  2936                              <1> 	; load file into memory
  2937 0000133A 8B0E[8106]          <1>         mov	cx, [loadsize]
  2938 0000133E 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  2939 00001342 B43F                <1>        	mov	ah, 3Fh
  2940 00001344 CD21                <1> 	int	21h
  2941 00001346 723A                <1> 	jc	short lff11m2_7 ; error !
  2942                              <1> 
  2943 00001348 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2944                              <1> 	
  2945 0000134A D1E8                <1> 	shr	ax, 1
  2946                              <1> 	;and	ax, ax
  2947 0000134C 7503                <1> 	jnz	short lff11m2_8
  2948 0000134E E91CF6              <1> 	jmp	lff11_eof
  2949                              <1> 
  2950                              <1> lff11m2_8:
  2951 00001351 89C1                <1> 	mov	cx, ax		; word count
  2952                              <1> lff11m2_9:
  2953 00001353 BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  2954                              <1> lff11m2_1:
  2955                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  2956 00001356 AD                  <1> 	lodsw
  2957 00001357 31D2                <1> 	xor	dx, dx
  2958 00001359 49                  <1> 	dec	cx
  2959 0000135A 7402                <1> 	jz	short lff11m2_2_1
  2960 0000135C 8B14                <1> 	mov	dx, [si]
  2961                              <1> lff11m2_2_1:	
  2962                              <1> 	; ax = [previous_val]
  2963                              <1> 	; dx = [next_val]
  2964 0000135E E80205              <1> 	call	interpolating_5_16bit_mono
  2965 00001361 E34A                <1> 	jcxz	lff11m2_3
  2966                              <1> lff11m2_2_2:
  2967 00001363 AD                  <1> 	lodsw
  2968 00001364 31D2                <1> 	xor	dx, dx
  2969 00001366 49                  <1> 	dec	cx
  2970 00001367 7402                <1> 	jz	short lff11m2_2_3
  2971 00001369 8B14                <1> 	mov	dx, [si]
  2972                              <1> lff11m2_2_3:
  2973 0000136B E8D005              <1>  	call	interpolating_4_16bit_mono
  2974 0000136E E33D                <1> 	jcxz	lff11m2_3
  2975                              <1> 
  2976 00001370 4D                  <1> 	dec	bp
  2977 00001371 74E0                <1> 	jz	short lff11m2_9
  2978                              <1> 
  2979 00001373 AD                  <1> 	lodsw
  2980 00001374 31D2                <1> 	xor	dx, dx
  2981 00001376 49                  <1> 	dec	cx
  2982 00001377 7402                <1> 	jz	short lff11m2_2_4
  2983 00001379 8B14                <1> 	mov	dx, [si]
  2984                              <1> lff11m2_2_4:
  2985 0000137B E8C005              <1>  	call	interpolating_4_16bit_mono
  2986 0000137E E32D                <1> 	jcxz	lff11m2_3
  2987 00001380 EBD4                <1> 	jmp	short lff11m2_1
  2988                              <1> 
  2989                              <1> lff11m2_7:
  2990                              <1> lff11s2_7:
  2991 00001382 E9EFF5              <1> 	jmp	lff11_5  ; error
  2992                              <1> 
  2993                              <1> load_11khz_stereo_16_bit:
  2994                              <1> 	; 18/11/2023
  2995 00001385 F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2996                              <1> 					; last of the file?
  2997 0000138A 7402                <1> 	jz	short lff11s2_0		; no
  2998 0000138C F9                  <1> 	stc
  2999 0000138D C3                  <1> 	retn
  3000                              <1> 
  3001                              <1> lff11s2_0:
  3002 0000138E 8EC0                <1> 	mov	es, ax ; buffer segment	
  3003 00001390 31FF                <1> 	xor	di, di
  3004 00001392 BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3005                              <1> 	; ds = cs
  3006                              <1> 
  3007                              <1> 	; load file into memory
  3008 00001395 8B0E[8106]          <1>         mov	cx, [loadsize]
  3009 00001399 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  3010 0000139D B43F                <1>        	mov	ah, 3Fh
  3011 0000139F CD21                <1> 	int	21h
  3012 000013A1 72DF                <1> 	jc	short lff11s2_7 ; error !
  3013                              <1> 
  3014 000013A3 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3015                              <1> 	
  3016 000013A5 C1E802              <1> 	shr	ax, 2	; dword (left chan word + right chan word)
  3017                              <1> 	;and	ax, ax
  3018 000013A8 7506                <1> 	jnz	short lff11s2_8
  3019 000013AA E9C0F5              <1> 	jmp	lff11_eof
  3020                              <1> 
  3021                              <1> lff11m2_3:
  3022                              <1> lff11s2_3:
  3023 000013AD E9AAF5              <1> 	jmp	lff11_3	; padfill
  3024                              <1> 		; (put zeros in the remain words of the buffer)
  3025                              <1> 
  3026                              <1> lff11s2_8:
  3027 000013B0 89C1                <1> 	mov	cx, ax		; dword count
  3028                              <1> lff11s2_9:
  3029 000013B2 BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  3030                              <1> lff11s2_1:
  3031                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3032 000013B5 AD                  <1> 	lodsw
  3033 000013B6 89C3                <1> 	mov	bx, ax
  3034 000013B8 AD                  <1> 	lodsw
  3035 000013B9 8B14                <1> 	mov	dx, [si]
  3036 000013BB 8916[C919]          <1> 	mov	[next_val_l], dx
  3037 000013BF 8B5402              <1> 	mov	dx, [si+2]
  3038 000013C2 8916[CB19]          <1> 	mov	[next_val_r], dx
  3039 000013C6 49                  <1> 	dec	cx
  3040 000013C7 750A                <1> 	jnz	short lff11s2_2_1
  3041 000013C9 31D2                <1> 	xor	dx, dx ; 0
  3042 000013CB 8916[C919]          <1> 	mov	[next_val_l], dx
  3043 000013CF 8916[CB19]          <1> 	mov	[next_val_r], dx
  3044                              <1> lff11s2_2_1:
  3045                              <1> 	; bx = [previous_val_l]
  3046                              <1> 	; ax = [previous_val_r]
  3047                              <1> 	; [next_val_l]
  3048                              <1> 	; dx = [next_val_r]
  3049 000013D3 E8D004              <1> 	call	interpolating_5_16bit_stereo
  3050 000013D6 E3D5                <1> 	jcxz	lff11s2_3
  3051                              <1> lff11s2_2_2:
  3052 000013D8 AD                  <1> 	lodsw
  3053 000013D9 89C3                <1> 	mov	bx, ax
  3054 000013DB AD                  <1> 	lodsw
  3055 000013DC 8B14                <1> 	mov	dx, [si]
  3056 000013DE 8916[C919]          <1> 	mov	[next_val_l], dx
  3057 000013E2 8B5402              <1> 	mov	dx, [si+2]
  3058 000013E5 8916[CB19]          <1> 	mov	[next_val_r], dx
  3059 000013E9 49                  <1> 	dec	cx
  3060 000013EA 750A                <1> 	jnz	short lff11s2_2_3
  3061 000013EC 31D2                <1> 	xor	dx, dx ; 0
  3062 000013EE 8916[C919]          <1> 	mov	[next_val_l], dx
  3063 000013F2 8916[CB19]          <1> 	mov	[next_val_r], dx
  3064                              <1> lff11s2_2_3:
  3065 000013F6 E87005              <1>  	call	interpolating_4_16bit_stereo
  3066 000013F9 E3B2                <1> 	jcxz	lff11s2_3
  3067                              <1> 	
  3068 000013FB 4D                  <1> 	dec	bp
  3069 000013FC 74B4                <1> 	jz	short lff11s2_9
  3070                              <1> 
  3071 000013FE AD                  <1> 	lodsw
  3072 000013FF 89C3                <1> 	mov	bx, ax
  3073 00001401 AD                  <1> 	lodsw
  3074 00001402 8B14                <1> 	mov	dx, [si]
  3075 00001404 8916[C919]          <1> 	mov	[next_val_l], dx
  3076 00001408 8B5402              <1> 	mov	dx, [si+2]
  3077 0000140B 8916[CB19]          <1> 	mov	[next_val_r], dx
  3078 0000140F 49                  <1> 	dec	cx
  3079 00001410 750A                <1> 	jnz	short lff11s2_2_4
  3080 00001412 31D2                <1> 	xor	dx, dx ; 0
  3081 00001414 8916[C919]          <1> 	mov	[next_val_l], dx
  3082 00001418 8916[CB19]          <1> 	mov	[next_val_r], dx
  3083                              <1> lff11s2_2_4:
  3084 0000141C E84A05              <1>  	call	interpolating_4_16bit_stereo
  3085 0000141F E38C                <1> 	jcxz	lff11s2_3
  3086 00001421 EB92                <1> 	jmp	short lff11s2_1
  3087                              <1> 
  3088                              <1> ; .....................
  3089                              <1> 
  3090                              <1> load_44khz_mono_8_bit:
  3091                              <1> 	; 18/11/2023
  3092 00001423 F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3093                              <1> 					; last of the file?
  3094 00001428 7402                <1> 	jz	short lff44m_0		; no
  3095 0000142A F9                  <1> 	stc
  3096 0000142B C3                  <1> 	retn
  3097                              <1> 
  3098                              <1> lff44m_0:
  3099 0000142C 8EC0                <1> 	mov	es, ax ; buffer segment	
  3100 0000142E 31FF                <1> 	xor	di, di
  3101 00001430 BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3102                              <1> 	; ds = cs
  3103                              <1> 
  3104                              <1> 	; load file into memory
  3105 00001433 8B0E[8106]          <1>         mov	cx, [loadsize]
  3106 00001437 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  3107 0000143B B43F                <1>        	mov	ah, 3Fh
  3108 0000143D CD21                <1> 	int	21h
  3109 0000143F 723C                <1> 	jc	short lff44m_7 ; error !
  3110                              <1> 
  3111 00001441 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3112                              <1> 	
  3113 00001443 21C0                <1> 	and	ax, ax
  3114 00001445 7503                <1> 	jnz	short lff44m_8
  3115 00001447 E923F5              <1> 	jmp	lff44_eof
  3116                              <1> 
  3117                              <1> lff44m_8:
  3118 0000144A 89C1                <1> 	mov	cx, ax		; byte count
  3119                              <1> lff44m_9:
  3120 0000144C BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3121 0000144F C606[CD19]02        <1> 	mov	byte [faz], 2  ; 2 steps/phases
  3122                              <1> lff44m_1:
  3123                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3124                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3125 00001454 AC                  <1> 	lodsb
  3126 00001455 B280                <1> 	mov	dl, 80h
  3127 00001457 49                  <1> 	dec	cx
  3128 00001458 7402                <1> 	jz	short lff44m_2_1
  3129 0000145A 8A14                <1> 	mov	dl, [si]
  3130                              <1> lff44m_2_1:	
  3131                              <1> 	; al = [previous_val]
  3132                              <1> 	; dl = [next_val]
  3133 0000145C E8A601              <1> 	call	interpolating_2_8bit_mono
  3134 0000145F E319                <1> 	jcxz	lff44m_3
  3135                              <1> lff44m_2_2:
  3136 00001461 AC                  <1> 	lodsb
  3137 00001462 2C80                <1> 	sub	al, 80h
  3138 00001464 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3139 00001467 AB                  <1> 	stosw		; (L)
  3140 00001468 AB                  <1> 	stosw		; (R)	
  3141                              <1> 
  3142 00001469 49                  <1> 	dec	cx
  3143 0000146A 740E                <1> 	jz	short lff44m_3	
  3144 0000146C 4D                  <1> 	dec	bp
  3145 0000146D 75F2                <1> 	jnz	short lff44m_2_2
  3146                              <1> 	
  3147 0000146F FE0E[CD19]          <1> 	dec	byte [faz]
  3148 00001473 74D7                <1> 	jz	short lff44m_9 
  3149 00001475 BD0B00              <1> 	mov	bp, 11
  3150 00001478 EBDA                <1> 	jmp	short lff44m_1
  3151                              <1> 
  3152                              <1> lff44m_3:
  3153                              <1> lff44s_3:
  3154 0000147A E9DDF4              <1> 	jmp	lff44_3	; padfill
  3155                              <1> 		; (put zeros in the remain words of the buffer)
  3156                              <1> lff44m_7:
  3157                              <1> lff44s_7:
  3158 0000147D E9F4F4              <1> 	jmp	lff44_5  ; error
  3159                              <1> 
  3160                              <1> load_44khz_stereo_8_bit:
  3161                              <1> 	; 16/11/2023
  3162 00001480 F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3163                              <1> 					; last of the file?
  3164 00001485 7402                <1> 	jz	short lff44s_0		; no
  3165 00001487 F9                  <1> 	stc
  3166 00001488 C3                  <1> 	retn
  3167                              <1> 
  3168                              <1> lff44s_0:
  3169 00001489 8EC0                <1> 	mov	es, ax ; buffer segment	
  3170 0000148B 31FF                <1> 	xor	di, di
  3171 0000148D BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3172                              <1> 	; ds = cs
  3173                              <1> 
  3174                              <1> 	; load file into memory
  3175 00001490 8B0E[8106]          <1>         mov	cx, [loadsize]
  3176 00001494 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  3177 00001498 B43F                <1>        	mov	ah, 3Fh
  3178 0000149A CD21                <1> 	int	21h
  3179 0000149C 72DF                <1> 	jc	short lff44s_7 ; error !
  3180                              <1> 
  3181 0000149E 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3182                              <1> 	
  3183 000014A0 D1E8                <1> 	shr	ax, 1
  3184                              <1> 	;and	ax, ax
  3185 000014A2 7503                <1> 	jnz	short lff44s_8
  3186 000014A4 E9C6F4              <1> 	jmp	lff44_eof
  3187                              <1> 
  3188                              <1> lff44s_8:
  3189 000014A7 89C1                <1> 	mov	cx, ax		; word count
  3190                              <1> lff44s_9:
  3191 000014A9 BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3192 000014AC C606[CD19]02        <1> 	mov	byte [faz], 2  ; 2 steps/phase
  3193                              <1> lff44s_1:
  3194                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3195                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3196 000014B1 AD                  <1> 	lodsw
  3197 000014B2 BA8080              <1> 	mov	dx, 8080h
  3198 000014B5 49                  <1> 	dec	cx
  3199 000014B6 7402                <1> 	jz	short lff44s_2_1 
  3200 000014B8 8B14                <1> 	mov	dx, [si]
  3201                              <1> lff44s_2_1:	
  3202                              <1> 	; al = [previous_val_l]
  3203                              <1> 	; ah = [previous_val_r]
  3204                              <1> 	; dl = [next_val_l]
  3205                              <1> 	; dl = [next_val_r]	
  3206 000014BA E85F01              <1> 	call	interpolating_2_8bit_stereo
  3207 000014BD E3BB                <1> 	jcxz	lff44s_3
  3208                              <1> lff44s_2_2:
  3209 000014BF AC                  <1> 	lodsb
  3210 000014C0 2C80                <1> 	sub	al, 80h
  3211 000014C2 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3212 000014C5 AB                  <1> 	stosw		; (L)
  3213 000014C6 AC                  <1> 	lodsb
  3214 000014C7 2C80                <1> 	sub	al, 80h
  3215 000014C9 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3216 000014CC AB                  <1> 	stosw		; (R)
  3217                              <1> 
  3218 000014CD 49                  <1> 	dec	cx
  3219 000014CE 74AA                <1> 	jz	short lff44s_3	
  3220 000014D0 4D                  <1> 	dec	bp
  3221 000014D1 75EC                <1> 	jnz	short lff44s_2_2
  3222                              <1> 	
  3223 000014D3 FE0E[CD19]          <1> 	dec	byte [faz]
  3224 000014D7 74D0                <1> 	jz	short lff44s_9 
  3225 000014D9 BD0B00              <1> 	mov	bp, 11
  3226 000014DC EBD3                <1> 	jmp	short lff44s_1
  3227                              <1> 
  3228                              <1> load_44khz_mono_16_bit:
  3229                              <1> 	; 18/11/2023
  3230 000014DE F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3231                              <1> 					; last of the file?
  3232 000014E3 7402                <1> 	jz	short lff44m2_0		; no
  3233 000014E5 F9                  <1> 	stc
  3234 000014E6 C3                  <1> 	retn
  3235                              <1> 
  3236                              <1> lff44m2_0:
  3237 000014E7 8EC0                <1> 	mov	es, ax ; buffer segment	
  3238 000014E9 31FF                <1> 	xor	di, di
  3239 000014EB BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3240                              <1> 	; ds = cs
  3241                              <1> 
  3242                              <1> 	; load file into memory
  3243 000014EE 8B0E[8106]          <1>         mov	cx, [loadsize]
  3244 000014F2 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  3245 000014F6 B43F                <1>        	mov	ah, 3Fh
  3246 000014F8 CD21                <1> 	int	21h
  3247 000014FA 7237                <1> 	jc	short lff44m2_7 ; error !
  3248                              <1> 
  3249 000014FC 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3250                              <1> 	
  3251 000014FE D1E8                <1> 	shr	ax, 1
  3252                              <1> 	;and	ax, ax
  3253 00001500 7503                <1> 	jnz	short lff44m2_8
  3254 00001502 E968F4              <1> 	jmp	lff44_eof
  3255                              <1> 
  3256                              <1> lff44m2_8:
  3257 00001505 89C1                <1> 	mov	cx, ax		; word count
  3258                              <1> lff44m2_9:
  3259 00001507 BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3260 0000150A C606[CD19]02        <1> 	mov	byte [faz], 2  ; 2 steps/phases
  3261                              <1> lff44m2_1:
  3262                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3263                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3264 0000150F AD                  <1> 	lodsw
  3265 00001510 31D2                <1> 	xor	dx, dx
  3266 00001512 49                  <1> 	dec	cx
  3267 00001513 7402                <1> 	jz	short lff44m2_2_1
  3268 00001515 8B14                <1> 	mov	dx, [si]
  3269                              <1> lff44m2_2_1:	
  3270                              <1> 	; ax = [previous_val]
  3271                              <1> 	; dx = [next_val]
  3272 00001517 E89801              <1> 	call	interpolating_2_16bit_mono
  3273 0000151A E314                <1> 	jcxz	lff44m2_3
  3274                              <1> lff44m2_2_2:
  3275 0000151C AD                  <1> 	lodsw
  3276 0000151D AB                  <1> 	stosw		; (L)eft Channel
  3277 0000151E AB                  <1> 	stosw		; (R)ight Channel
  3278                              <1> 
  3279 0000151F 49                  <1> 	dec	cx
  3280 00001520 740E                <1> 	jz	short lff44m2_3	
  3281 00001522 4D                  <1> 	dec	bp
  3282 00001523 75F7                <1> 	jnz	short lff44m2_2_2
  3283                              <1> 	
  3284 00001525 FE0E[CD19]          <1> 	dec	byte [faz]
  3285 00001529 74DC                <1> 	jz	short lff44m2_9 
  3286 0000152B BD0B00              <1> 	mov	bp, 11
  3287 0000152E EBDF                <1> 	jmp	short lff44m2_1
  3288                              <1> 
  3289                              <1> lff44m2_3:
  3290                              <1> lff44s2_3:
  3291 00001530 E927F4              <1> 	jmp	lff44_3	; padfill
  3292                              <1> 		; (put zeros in the remain words of the buffer)
  3293                              <1> lff44m2_7:
  3294                              <1> lff44s2_7:
  3295 00001533 E93EF4              <1> 	jmp	lff44_5  ; error
  3296                              <1> 
  3297                              <1> load_44khz_stereo_16_bit:
  3298                              <1> 	; 18/11/2023
  3299 00001536 F606[FA1D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3300                              <1> 					; last of the file?
  3301 0000153B 7402                <1> 	jz	short lff44s2_0		; no
  3302 0000153D F9                  <1> 	stc
  3303 0000153E C3                  <1> 	retn
  3304                              <1> 
  3305                              <1> lff44s2_0:
  3306 0000153F 8EC0                <1> 	mov	es, ax ; buffer segment	
  3307 00001541 31FF                <1> 	xor	di, di
  3308 00001543 BA[201E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3309                              <1> 	; ds = cs
  3310                              <1> 
  3311                              <1> 	; load file into memory
  3312 00001546 8B0E[8106]          <1>         mov	cx, [loadsize]
  3313 0000154A 8B1E[F81D]          <1> 	mov	bx, [filehandle]
  3314 0000154E B43F                <1>        	mov	ah, 3Fh
  3315 00001550 CD21                <1> 	int	21h
  3316 00001552 72DF                <1> 	jc	short lff44s2_7 ; error !
  3317                              <1> 
  3318 00001554 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3319                              <1> 	
  3320 00001556 C1E802              <1> 	shr	ax, 2	; dword (left chan word + right chan word)
  3321                              <1> 	;and	ax, ax
  3322 00001559 7503                <1> 	jnz	short lff44s2_8
  3323 0000155B E90FF4              <1> 	jmp	lff44_eof
  3324                              <1> 
  3325                              <1> lff44s2_8:
  3326 0000155E 89C1                <1> 	mov	cx, ax		; dword count
  3327                              <1> lff44s2_9:
  3328 00001560 BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3329 00001563 C606[CD19]02        <1> 	mov	byte [faz], 2  ; 2 steps/phase
  3330                              <1> lff44s2_1:
  3331                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3332                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3333 00001568 AD                  <1> 	lodsw
  3334 00001569 89C3                <1> 	mov	bx, ax
  3335 0000156B AD                  <1> 	lodsw
  3336 0000156C 8B14                <1> 	mov	dx, [si]
  3337 0000156E 8916[C919]          <1> 	mov	[next_val_l], dx
  3338 00001572 8B5402              <1> 	mov	dx, [si+2]
  3339 00001575 49                  <1> 	dec	cx
  3340 00001576 7506                <1> 	jnz	short lff44s2_2_1
  3341 00001578 31D2                <1> 	xor	dx, dx ; 0
  3342 0000157A 8916[C919]          <1> 	mov	[next_val_l], dx
  3343                              <1> lff44s2_2_1:
  3344                              <1> 	; bx = [previous_val_l]
  3345                              <1> 	; ax = [previous_val_r]
  3346                              <1> 	; [next_val_l]
  3347                              <1> 	; dx = [next_val_r]
  3348 0000157E E84301              <1> 	call	interpolating_2_16bit_stereo
  3349 00001581 E3AD                <1> 	jcxz	lff44s2_3
  3350                              <1> lff44s2_2_2:
  3351                              <1> 	;lodsw
  3352                              <1> 	;stosw		; (L)
  3353                              <1> 	;lodsw
  3354                              <1> 	;stosw		; (R)
  3355 00001583 A5                  <1> 	movsw		; (L)eft Channel
  3356 00001584 A5                  <1> 	movsw		; (R)ight Channel
  3357                              <1> 
  3358 00001585 49                  <1> 	dec	cx
  3359 00001586 74A8                <1> 	jz	short lff44s2_3	
  3360 00001588 4D                  <1> 	dec	bp
  3361 00001589 75F8                <1> 	jnz	short lff44s2_2_2
  3362                              <1> 	
  3363 0000158B FE0E[CD19]          <1> 	dec	byte [faz]
  3364 0000158F 74CF                <1> 	jz	short lff44s2_9 
  3365 00001591 BD0B00              <1> 	mov	bp, 11
  3366 00001594 EBD2                <1> 	jmp	short lff44s2_1
  3367                              <1> 
  3368                              <1> ; .....................
  3369                              <1> 
  3370                              <1> interpolating_3_8bit_mono:
  3371                              <1> 	; 16/11/2023
  3372                              <1> 	; al = [previous_val]
  3373                              <1> 	; dl = [next_val]
  3374                              <1> 	; original-interpolated-interpolated
  3375 00001596 88C3                <1> 	mov	bl, al
  3376 00001598 2C80                <1> 	sub	al, 80h
  3377 0000159A C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3378 0000159D AB                  <1> 	stosw		; original sample (L)
  3379 0000159E AB                  <1> 	stosw		; original sample (R)
  3380 0000159F 88D8                <1> 	mov	al, bl
  3381 000015A1 00D0                <1> 	add	al, dl	
  3382 000015A3 D0D8                <1> 	rcr	al, 1
  3383 000015A5 88C7                <1> 	mov	bh, al	; interpolated middle (temporary)
  3384 000015A7 00D8                <1> 	add	al, bl
  3385 000015A9 D0D8                <1> 	rcr	al, 1
  3386 000015AB 2C80                <1> 	sub	al, 80h
  3387 000015AD C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3388 000015B0 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3389 000015B1 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3390 000015B2 88F8                <1> 	mov	al, bh
  3391 000015B4 00D0                <1> 	add	al, dl	; [next_val]
  3392 000015B6 D0D8                <1> 	rcr	al, 1
  3393 000015B8 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3394 000015BB AB                  <1> 	stosw		; interpolated sample 2 (L)
  3395 000015BC AB                  <1> 	stosw		; interpolated sample 2 (R)
  3396 000015BD C3                  <1> 	retn
  3397                              <1> 
  3398                              <1> interpolating_3_8bit_stereo:
  3399                              <1> 	; 16/11/2023
  3400                              <1> 	; al = [previous_val_l]
  3401                              <1> 	; ah = [previous_val_r]
  3402                              <1> 	; dl = [next_val_l]
  3403                              <1> 	; dh = [next_val_r]	
  3404                              <1> 	; original-interpolated-interpolated
  3405 000015BE 89C3                <1> 	mov	bx, ax
  3406 000015C0 2C80                <1> 	sub	al, 80h
  3407 000015C2 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3408 000015C5 AB                  <1> 	stosw		; original sample (L)
  3409 000015C6 88F8                <1> 	mov	al, bh
  3410 000015C8 2C80                <1> 	sub	al, 80h
  3411 000015CA C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3412 000015CD AB                  <1> 	stosw		; original sample (R)
  3413 000015CE 88D8                <1> 	mov	al, bl
  3414 000015D0 00D0                <1> 	add	al, dl	; [next_val_l]	
  3415 000015D2 D0D8                <1> 	rcr	al, 1
  3416 000015D4 50                  <1> 	push	ax ; *	; al = interpolated middle (L) (temporary)
  3417 000015D5 00D8                <1> 	add	al, bl	; [previous_val_l]
  3418 000015D7 D0D8                <1> 	rcr	al, 1
  3419 000015D9 2C80                <1> 	sub	al, 80h
  3420 000015DB C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3421 000015DE AB                  <1> 	stosw		; interpolated sample 1 (L)
  3422 000015DF 88F8                <1> 	mov	al, bh
  3423 000015E1 00F0                <1> 	add	al, dh	; [next_val_r]
  3424 000015E3 D0D8                <1> 	rcr	al, 1
  3425 000015E5 50                  <1> 	push	ax ; ** ; al = interpolated middle (R) (temporary)
  3426 000015E6 00F8                <1> 	add	al, bh	; [previous_val_r]
  3427 000015E8 D0D8                <1> 	rcr	al, 1
  3428 000015EA 2C80                <1> 	sub	al, 80h
  3429 000015EC C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3430 000015EF AB                  <1> 	stosw		; interpolated sample 1 (R)
  3431 000015F0 5B                  <1> 	pop	bx ; **
  3432 000015F1 58                  <1> 	pop	ax ; *
  3433 000015F2 00D0                <1> 	add	al, dl	; [next_val_l]
  3434 000015F4 D0D8                <1> 	rcr	al, 1
  3435 000015F6 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3436 000015F9 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3437 000015FA 88D8                <1> 	mov	al, bl
  3438 000015FC 00F0                <1> 	add	al, dh	; [next_val_r]
  3439 000015FE D0D8                <1> 	rcr	al, 1
  3440 00001600 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3441 00001603 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3442 00001604 C3                  <1> 	retn
  3443                              <1> 
  3444                              <1> interpolating_2_8bit_mono:
  3445                              <1> 	; 16/11/2023
  3446                              <1> 	; al = [previous_val]
  3447                              <1> 	; dl = [next_val]
  3448                              <1> 	; original-interpolated
  3449 00001605 88C3                <1> 	mov	bl, al
  3450 00001607 2C80                <1> 	sub	al, 80h
  3451 00001609 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3452 0000160C AB                  <1> 	stosw		; original sample (L)
  3453 0000160D AB                  <1> 	stosw		; original sample (R)
  3454 0000160E 88D8                <1> 	mov	al, bl
  3455 00001610 00D0                <1> 	add	al, dl	
  3456 00001612 D0D8                <1> 	rcr	al, 1
  3457 00001614 2C80                <1> 	sub	al, 80h
  3458 00001616 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3459 00001619 AB                  <1> 	stosw		; interpolated sample (L)
  3460 0000161A AB                  <1> 	stosw		; interpolated sample (R)
  3461 0000161B C3                  <1> 	retn
  3462                              <1> 
  3463                              <1> interpolating_2_8bit_stereo:
  3464                              <1> 	; 16/11/2023
  3465                              <1> 	; al = [previous_val_l]
  3466                              <1> 	; ah = [previous_val_r]
  3467                              <1> 	; dl = [next_val_l]
  3468                              <1> 	; dh = [next_val_r]	
  3469                              <1> 	; original-interpolated
  3470 0000161C 89C3                <1> 	mov	bx, ax
  3471 0000161E 2C80                <1> 	sub	al, 80h
  3472 00001620 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3473 00001623 AB                  <1> 	stosw		; original sample (L)
  3474 00001624 88F8                <1> 	mov	al, bh
  3475 00001626 2C80                <1> 	sub	al, 80h
  3476 00001628 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3477 0000162B AB                  <1> 	stosw		; original sample (R)
  3478 0000162C 88D8                <1> 	mov	al, bl	; [previous_val_l]
  3479 0000162E 00D0                <1> 	add	al, dl	; [next_val_l]	
  3480 00001630 D0D8                <1> 	rcr	al, 1
  3481 00001632 2C80                <1> 	sub	al, 80h
  3482 00001634 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3483 00001637 AB                  <1> 	stosw		; interpolated sample (L)
  3484 00001638 88F8                <1> 	mov	al, bh
  3485 0000163A 00F0                <1> 	add	al, dh	; [next_val_r]
  3486 0000163C D0D8                <1> 	rcr	al, 1
  3487 0000163E 2C80                <1> 	sub	al, 80h
  3488 00001640 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3489 00001643 AB                  <1> 	stosw		; interpolated sample (R)
  3490 00001644 C3                  <1> 	retn
  3491                              <1> 
  3492                              <1> interpolating_3_16bit_mono:
  3493                              <1> 	; 16/11/2023
  3494                              <1> 	; ax = [previous_val]
  3495                              <1> 	; dx = [next_val]
  3496                              <1> 	; original-interpolated-interpolated
  3497                              <1> 
  3498 00001645 AB                  <1> 	stosw		; original sample (L)
  3499 00001646 AB                  <1> 	stosw		; original sample (R)
  3500 00001647 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3501 0000164A 50                  <1> 	push	ax ; *	; [previous_val]
  3502 0000164B 80C680              <1> 	add	dh, 80h
  3503 0000164E 01D0                <1> 	add	ax, dx
  3504 00001650 D1D8                <1> 	rcr	ax, 1
  3505 00001652 5B                  <1> 	pop	bx ; *		
  3506 00001653 93                  <1> 	xchg	bx, ax	; bx  = interpolated middle (temporary)
  3507 00001654 01D8                <1> 	add	ax, bx	; [previous_val] + interpolated middle
  3508 00001656 D1D8                <1> 	rcr	ax, 1
  3509 00001658 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3510 0000165B AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3511 0000165C AB                  <1> 	stosw		; interpolated sample 1 (R)
  3512 0000165D 89D8                <1> 	mov	ax, bx
  3513 0000165F 01D0                <1> 	add	ax, dx	 ;interpolated middle + [next_val]
  3514 00001661 D1D8                <1> 	rcr	ax, 1
  3515 00001663 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3516 00001666 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3517 00001667 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3518 00001668 C3                  <1> 	retn
  3519                              <1> 
  3520                              <1> interpolating_3_16bit_stereo:
  3521                              <1> 	; 16/11/2023
  3522                              <1> 	; bx = [previous_val_l]
  3523                              <1> 	; ax = [previous_val_r]
  3524                              <1> 	; [next_val_l]
  3525                              <1> 	; dx = [next_val_r]
  3526                              <1> 	; original-interpolated-interpolated
  3527                              <1> 
  3528 00001669 93                  <1> 	xchg	ax, bx
  3529 0000166A AB                  <1> 	stosw		; original sample (L)
  3530 0000166B 93                  <1> 	xchg	ax, bx
  3531 0000166C AB                  <1> 	stosw		; original sample (R)
  3532 0000166D 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3533 00001670 50                  <1> 	push	ax ; *	; [previous_val_r]
  3534 00001671 80C780              <1> 	add	bh, 80h
  3535 00001674 8006[CA19]80        <1> 	add	byte [next_val_l+1], 80h
  3536 00001679 A1[C919]            <1> 	mov	ax, [next_val_l]
  3537 0000167C 01D8                <1> 	add	ax, bx	; [previous_val_l]
  3538 0000167E D1D8                <1> 	rcr	ax, 1
  3539 00001680 93                  <1> 	xchg	ax, bx	; ax = [previous_val_l]	
  3540 00001681 01D8                <1> 	add	ax, bx	; bx = interpolated middle (L)
  3541 00001683 D1D8                <1> 	rcr	ax, 1
  3542 00001685 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3543 00001688 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3544 00001689 58                  <1> 	pop	ax  ; *
  3545 0000168A 80C680              <1> 	add	dh, 80h ; convert sound level 0 to 65535 format
  3546 0000168D 52                  <1> 	push	dx  ; * ; [next_val_r]
  3547 0000168E 92                  <1> 	xchg	ax, dx
  3548 0000168F 01D0                <1> 	add	ax, dx	; [next_val_r] + [previous_val_r]
  3549 00001691 D1D8                <1> 	rcr	ax, 1	; / 2
  3550 00001693 50                  <1> 	push	ax ; ** ; interpolated middle (R)
  3551 00001694 01D0                <1> 	add	ax, dx	; + [previous_val_r]
  3552 00001696 D1D8                <1> 	rcr	ax, 1
  3553 00001698 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3554 0000169B AB                  <1> 	stosw 		; interpolated sample 1 (R)
  3555 0000169C A1[C919]            <1> 	mov	ax, [next_val_l]
  3556 0000169F 01D8                <1> 	add	ax, bx	; + interpolated middle (L)
  3557 000016A1 D1D8                <1> 	rcr	ax, 1
  3558 000016A3 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3559 000016A6 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  3560 000016A7 58                  <1> 	pop	ax ; **
  3561 000016A8 5A                  <1> 	pop	dx ; *	
  3562 000016A9 01D0                <1> 	add	ax, dx	; interpolated middle + [next_val_r]
  3563 000016AB D1D8                <1> 	rcr	ax, 1	; / 2
  3564 000016AD 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3565 000016B0 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  3566 000016B1 C3                  <1> 	retn
  3567                              <1> 
  3568                              <1> interpolating_2_16bit_mono:
  3569                              <1> 	; 16/11/2023
  3570                              <1> 	; ax = [previous_val]
  3571                              <1> 	; dx = [next_val]
  3572                              <1> 	; original-interpolated
  3573                              <1> 
  3574 000016B2 AB                  <1> 	stosw		; original sample (L)
  3575 000016B3 AB                  <1> 	stosw		; original sample (R)
  3576 000016B4 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3577 000016B7 80C680              <1> 	add	dh, 80h
  3578 000016BA 01D0                <1> 	add	ax, dx
  3579 000016BC D1D8                <1> 	rcr	ax, 1
  3580 000016BE 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3581 000016C1 AB                  <1> 	stosw		; interpolated sample (L)
  3582 000016C2 AB                  <1> 	stosw		; interpolated sample (R)
  3583 000016C3 C3                  <1> 	retn
  3584                              <1> 
  3585                              <1> interpolating_2_16bit_stereo:
  3586                              <1> 	; 16/11/2023
  3587                              <1> 	; bx = [previous_val_l]
  3588                              <1> 	; ax = [previous_val_r]
  3589                              <1> 	; [next_val_l]
  3590                              <1> 	; dx = [next_val_r]
  3591                              <1> 	; original-interpolated
  3592                              <1> 
  3593 000016C4 93                  <1> 	xchg	ax, bx
  3594 000016C5 AB                  <1> 	stosw		; original sample (L)
  3595 000016C6 93                  <1> 	xchg	ax, bx
  3596 000016C7 AB                  <1> 	stosw		; original sample (R)
  3597 000016C8 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3598 000016CB 80C680              <1> 	add	dh, 80h
  3599 000016CE 01D0                <1> 	add	ax, dx	; [previous_val_r] + [next_val_r]
  3600 000016D0 D1D8                <1> 	rcr	ax, 1	; / 2
  3601 000016D2 50                  <1> 	push	ax ; *	; interpolated sample (R)
  3602 000016D3 A1[C919]            <1> 	mov	ax, [next_val_l]
  3603 000016D6 80C480              <1> 	add	ah, 80h
  3604 000016D9 80C780              <1> 	add	bh, 80h
  3605 000016DC 01D8                <1> 	add	ax, bx	; [next_val_l] + [previous_val_l]
  3606 000016DE D1D8                <1> 	rcr	ax, 1	; / 2		
  3607 000016E0 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3608 000016E3 AB                  <1> 	stosw 		; interpolated sample (L)
  3609 000016E4 58                  <1> 	pop	ax ; *	
  3610 000016E5 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3611 000016E8 AB                  <1> 	stosw 		; interpolated sample (R)
  3612 000016E9 C3                  <1> 	retn
  3613                              <1> 
  3614                              <1> interpolating_5_8bit_mono:
  3615                              <1> 	; 17/11/2023
  3616                              <1> 	; al = [previous_val]
  3617                              <1> 	; dl = [next_val]
  3618                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  3619 000016EA 88C3                <1> 	mov	bl, al
  3620 000016EC 2C80                <1> 	sub	al, 80h
  3621 000016EE C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3622 000016F1 AB                  <1> 	stosw		; original sample (L)
  3623 000016F2 AB                  <1> 	stosw		; original sample (R)
  3624 000016F3 88D8                <1> 	mov	al, bl
  3625 000016F5 00D0                <1> 	add	al, dl	
  3626 000016F7 D0D8                <1> 	rcr	al, 1
  3627 000016F9 88C7                <1> 	mov	bh, al	; interpolated middle (temporary)
  3628 000016FB 00D8                <1> 	add	al, bl  ; [previous_val]
  3629 000016FD D0D8                <1> 	rcr	al, 1 	
  3630 000016FF 88C6                <1> 	mov	dh, al	; interpolated 1st quarter (temporary)
  3631 00001701 00D8                <1> 	add	al, bl
  3632 00001703 D0D8                <1> 	rcr	al, 1
  3633 00001705 2C80                <1> 	sub	al, 80h
  3634 00001707 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3635 0000170A AB                  <1> 	stosw		; interpolated sample 1 (L)
  3636 0000170B AB                  <1> 	stosw		; interpolated sample 1 (R)
  3637 0000170C 88F8                <1> 	mov	al, bh
  3638 0000170E 00F0                <1> 	add	al, dh
  3639 00001710 D0D8                <1> 	rcr	al, 1
  3640 00001712 2C80                <1> 	sub	al, 80h
  3641 00001714 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3642 00001717 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3643 00001718 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3644 00001719 88F8                <1> 	mov	al, bh
  3645 0000171B 00D0                <1> 	add	al, dl	; [next_val]
  3646 0000171D D0D8                <1> 	rcr	al, 1
  3647 0000171F 88C6                <1> 	mov	dh, al	; interpolated 3rd quarter (temporary)
  3648 00001721 00F8                <1> 	add	al, bh
  3649 00001723 D0D8                <1> 	rcr	al, 1
  3650 00001725 2C80                <1> 	sub	al, 80h
  3651 00001727 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3652 0000172A AB                  <1> 	stosw		; interpolated sample 3 (L)
  3653 0000172B AB                  <1> 	stosw		; interpolated sample 3 (R)
  3654 0000172C 88F0                <1> 	mov	al, dh
  3655 0000172E 00D0                <1> 	add	al, dl
  3656 00001730 D0D8                <1> 	rcr	al, 1
  3657 00001732 2C80                <1> 	sub	al, 80h
  3658 00001734 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3659 00001737 AB                  <1> 	stosw		; interpolated sample 4 (L)
  3660 00001738 AB                  <1> 	stosw		; interpolated sample 4 (R)
  3661 00001739 C3                  <1> 	retn
  3662                              <1> 
  3663                              <1> interpolating_5_8bit_stereo:
  3664                              <1> 	; 17/11/2023
  3665                              <1> 	; al = [previous_val_l]
  3666                              <1> 	; ah = [previous_val_r]
  3667                              <1> 	; dl = [next_val_l]
  3668                              <1> 	; dh = [next_val_r]	
  3669                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  3670 0000173A 89C3                <1> 	mov	bx, ax
  3671 0000173C 2C80                <1> 	sub	al, 80h
  3672 0000173E C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3673 00001741 AB                  <1> 	stosw		; original sample (L)
  3674 00001742 88F8                <1> 	mov	al, bh
  3675 00001744 2C80                <1> 	sub	al, 80h
  3676 00001746 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3677 00001749 AB                  <1> 	stosw		; original sample (R)
  3678 0000174A 52                  <1> 	push	dx ; *
  3679 0000174B 88D8                <1> 	mov	al, bl
  3680 0000174D 00D0                <1> 	add	al, dl	; [next_val_l]
  3681 0000174F D0D8                <1> 	rcr	al, 1
  3682 00001751 50                  <1> 	push	ax ; **	; al = interpolated middle (L) (temporary)
  3683 00001752 00D8                <1> 	add	al, bl	; [previous_val_l]
  3684 00001754 D0D8                <1> 	rcr	al, 1
  3685 00001756 86C3                <1> 	xchg	al, bl	
  3686 00001758 00D8                <1> 	add	al, bl	; bl = interpolated 1st quarter (L) (temp)
  3687 0000175A D0D8                <1> 	rcr	al, 1
  3688 0000175C 2C80                <1> 	sub	al, 80h
  3689 0000175E C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3690 00001761 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3691 00001762 88F8                <1> 	mov	al, bh
  3692 00001764 00F0                <1> 	add	al, dh	; [next_val_r]
  3693 00001766 D0D8                <1> 	rcr	al, 1
  3694 00001768 50                  <1> 	push	ax ; *** ; al = interpolated middle (R) (temporary)
  3695 00001769 00F8                <1> 	add	al, bh	; [previous_val_r]
  3696 0000176B D0D8                <1> 	rcr	al, 1
  3697 0000176D 86C7                <1> 	xchg	al, bh	
  3698 0000176F 00F8                <1> 	add	al, bh	; bh = interpolated 1st quarter (R) (temp)
  3699 00001771 D0D8                <1> 	rcr	al, 1
  3700 00001773 2C80                <1> 	sub	al, 80h
  3701 00001775 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3702 00001778 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3703 00001779 5A                  <1> 	pop	dx ; ***
  3704 0000177A 58                  <1> 	pop	ax ; **	; al = interpolated middle (L) (temporary)
  3705 0000177B 86C3                <1> 	xchg	al, bl	; al = interpolated 1st quarter (L) (temp)
  3706 0000177D 00D8                <1> 	add	al, bl	; bl = interpolated middle (L) (temporary)
  3707 0000177F D0D8                <1> 	rcr	al, 1
  3708 00001781 2C80                <1> 	sub	al, 80h
  3709 00001783 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3710 00001786 AB                  <1> 	stosw		; interpolated sample 2 (L)	
  3711 00001787 88D0                <1> 	mov	al, dl 	; interpolated middle (R) (temporary)
  3712 00001789 86C7                <1> 	xchg	al, bh	; al = interpolated 1st quarter (R) (temp)
  3713 0000178B 00F8                <1> 	add	al, bh	; bh = interpolated middle (R) (temporary)
  3714 0000178D D0D8                <1> 	rcr	al, 1
  3715 0000178F 2C80                <1> 	sub	al, 80h
  3716 00001791 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3717 00001794 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3718 00001795 5A                  <1> 	pop	dx ; *
  3719 00001796 88D8                <1> 	mov	al, bl	; interpolated middle (L) (temporary)
  3720 00001798 00D0                <1> 	add	al, dl	; [next_val_l]
  3721 0000179A D0D8                <1> 	rcr	al, 1
  3722 0000179C 86C3                <1> 	xchg	al, bl	; al = interpolated middle (R) (temporary)	
  3723 0000179E 00D8                <1> 	add	al, bl	; bl = interpolated 3rd quarter (L) (temp) 
  3724 000017A0 D0D8                <1> 	rcr	al, 1
  3725 000017A2 2C80                <1> 	sub	al, 80h
  3726 000017A4 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3727 000017A7 AB                  <1> 	stosw		; interpolated sample 3 (L)
  3728 000017A8 88F8                <1> 	mov	al, bh	
  3729 000017AA 00F0                <1> 	add	al, dh	; interpolated middle (R) + [next_val_r]
  3730 000017AC D0D8                <1> 	rcr	al, 1
  3731 000017AE 86C7                <1> 	xchg	al, bh	; al = interpolated middle (R)
  3732 000017B0 00F8                <1> 	add	al, bh	; bh = interpolated 3rd quarter (R) (temp)
  3733 000017B2 D0D8                <1> 	rcr	al, 1
  3734 000017B4 2C80                <1> 	sub	al, 80h
  3735 000017B6 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3736 000017B9 AB                  <1> 	stosw		; interpolated sample 3 (R)
  3737 000017BA 88D8                <1> 	mov	al, bl
  3738 000017BC 00D0                <1> 	add	al, dl	; [next_val_l]
  3739 000017BE D0D8                <1> 	rcr	al, 1
  3740 000017C0 2C80                <1> 	sub	al, 80h
  3741 000017C2 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3742 000017C5 AB                  <1> 	stosw		; interpolated sample 4 (L)
  3743 000017C6 88F8                <1> 	mov	al, bh
  3744 000017C8 00F0                <1> 	add	al, dh	; [next_val_r]
  3745 000017CA D0D8                <1> 	rcr	al, 1
  3746 000017CC 2C80                <1> 	sub	al, 80h
  3747 000017CE C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3748 000017D1 AB                  <1> 	stosw		; interpolated sample 4 (R)
  3749 000017D2 C3                  <1> 	retn
  3750                              <1> 
  3751                              <1> interpolating_4_8bit_mono:
  3752                              <1> 	; 17/11/2023
  3753                              <1> 	; al = [previous_val]
  3754                              <1> 	; dl = [next_val]
  3755                              <1> 	; original-interpolated-interpolated-interpolated
  3756 000017D3 88C3                <1> 	mov	bl, al
  3757 000017D5 2C80                <1> 	sub	al, 80h
  3758 000017D7 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3759 000017DA AB                  <1> 	stosw		; original sample (L)
  3760 000017DB AB                  <1> 	stosw		; original sample (R)
  3761 000017DC 88D8                <1> 	mov	al, bl
  3762 000017DE 00D0                <1> 	add	al, dl	
  3763 000017E0 D0D8                <1> 	rcr	al, 1
  3764 000017E2 86C3                <1> 	xchg	al, bl  ; al = [previous_val]
  3765 000017E4 00D8                <1> 	add	al, bl	; bl = interpolated middle (sample 2)
  3766 000017E6 D0D8                <1> 	rcr	al, 1 	
  3767 000017E8 2C80                <1> 	sub	al, 80h
  3768 000017EA C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3769 000017ED AB                  <1> 	stosw		; interpolated sample 1 (L)
  3770 000017EE AB                  <1> 	stosw		; interpolated sample 1 (R)
  3771 000017EF 88D8                <1> 	mov	al, bl	; interpolated middle (sample 2)
  3772 000017F1 2C80                <1> 	sub	al, 80h
  3773 000017F3 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3774 000017F6 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3775 000017F7 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3776 000017F8 88D8                <1> 	mov	al, bl
  3777 000017FA 00D0                <1> 	add	al, dl	; [next_val]
  3778 000017FC D0D8                <1> 	rcr	al, 1
  3779 000017FE 2C80                <1> 	sub	al, 80h
  3780 00001800 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3781 00001803 AB                  <1> 	stosw		; interpolated sample 3 (L)
  3782 00001804 AB                  <1> 	stosw		; interpolated sample 3 (R)
  3783 00001805 C3                  <1> 	retn
  3784                              <1> 
  3785                              <1> interpolating_4_8bit_stereo:
  3786                              <1> 	; 17/11/2023
  3787                              <1> 	; al = [previous_val_l]
  3788                              <1> 	; ah = [previous_val_r]
  3789                              <1> 	; dl = [next_val_l]
  3790                              <1> 	; dh = [next_val_r]	
  3791                              <1> 	; original-interpolated-interpolated-interpolated
  3792 00001806 89C3                <1> 	mov	bx, ax
  3793 00001808 2C80                <1> 	sub	al, 80h
  3794 0000180A C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3795 0000180D AB                  <1> 	stosw		; original sample (L)
  3796 0000180E 88F8                <1> 	mov	al, bh
  3797 00001810 2C80                <1> 	sub	al, 80h
  3798 00001812 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3799 00001815 AB                  <1> 	stosw		; original sample (R)
  3800 00001816 88D8                <1> 	mov	al, bl
  3801 00001818 00D0                <1> 	add	al, dl	; [next_val_l]
  3802 0000181A D0D8                <1> 	rcr	al, 1
  3803 0000181C 86C3                <1> 	xchg	al, bl	; al = [previous_val_l]
  3804 0000181E 00D8                <1> 	add	al, bl	; bl = interpolated middle (L) (sample 2)
  3805 00001820 D0D8                <1> 	rcr	al, 1
  3806 00001822 2C80                <1> 	sub	al, 80h
  3807 00001824 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3808 00001827 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3809 00001828 88F8                <1> 	mov	al, bh
  3810 0000182A 00F0                <1> 	add	al, dh	; [next_val_r]
  3811 0000182C D0D8                <1> 	rcr	al, 1
  3812 0000182E 86C7                <1> 	xchg	al, bh	; al = [previous_val_h]
  3813 00001830 00F8                <1> 	add	al, bh	; bh = interpolated middle (R) (sample 2)
  3814 00001832 D0D8                <1> 	rcr	al, 1
  3815 00001834 2C80                <1> 	sub	al, 80h
  3816 00001836 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3817 00001839 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3818 0000183A 88D8                <1> 	mov	al, bl	; interpolated middle (L) (sample 2)
  3819 0000183C 2C80                <1> 	sub	al, 80h
  3820 0000183E C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3821 00001841 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3822 00001842 88F8                <1> 	mov	al, bh	; interpolated middle (L) (sample 2)
  3823 00001844 2C80                <1> 	sub	al, 80h
  3824 00001846 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3825 00001849 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3826 0000184A 88D8                <1> 	mov	al, bl
  3827 0000184C 00D0                <1> 	add	al, dl	; [next_val_l]
  3828 0000184E D0D8                <1> 	rcr	al, 1
  3829 00001850 2C80                <1> 	sub	al, 80h
  3830 00001852 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3831 00001855 AB                  <1> 	stosw		; interpolated sample 3 (L)
  3832 00001856 88F8                <1> 	mov	al, bh
  3833 00001858 00F0                <1> 	add	al, dh	; [next_val_r]
  3834 0000185A D0D8                <1> 	rcr	al, 1
  3835 0000185C 2C80                <1> 	sub	al, 80h
  3836 0000185E C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3837 00001861 AB                  <1> 	stosw		; interpolated sample 3 (R)
  3838 00001862 C3                  <1> 	retn
  3839                              <1> 
  3840                              <1> interpolating_5_16bit_mono:
  3841                              <1> 	; 18/11/2023
  3842                              <1> 	; ax = [previous_val]
  3843                              <1> 	; dx = [next_val]
  3844                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  3845 00001863 AB                  <1> 	stosw		; original sample (L)
  3846 00001864 AB                  <1> 	stosw		; original sample (R)
  3847 00001865 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3848 00001868 89C3                <1> 	mov	bx, ax	; [previous_val]
  3849 0000186A 80C680              <1> 	add	dh, 80h
  3850 0000186D 01D0                <1> 	add	ax, dx
  3851 0000186F D1D8                <1> 	rcr	ax, 1
  3852 00001871 50                  <1> 	push	ax ; *	; interpolated middle (temporary)
  3853 00001872 01D8                <1> 	add	ax, bx	; interpolated middle + [previous_val] 
  3854 00001874 D1D8                <1> 	rcr	ax, 1
  3855 00001876 50                  <1> 	push	ax ; **	; interpolated 1st quarter (temporary)
  3856 00001877 01D8                <1> 	add	ax, bx	; 1st quarter + [previous_val]
  3857 00001879 D1D8                <1> 	rcr	ax, 1	
  3858 0000187B 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3859 0000187E AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3860 0000187F AB                  <1> 	stosw		; interpolated sample 1 (R)
  3861 00001880 58                  <1> 	pop	ax ; **	
  3862 00001881 5B                  <1> 	pop	bx ; *
  3863 00001882 01D8                <1> 	add	ax, bx	; 1st quarter + middle
  3864 00001884 D1D8                <1> 	rcr	ax, 1	; / 2
  3865 00001886 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again	
  3866 00001889 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3867 0000188A AB                  <1> 	stosw		; interpolated sample 2 (R)		
  3868 0000188B 89D8                <1> 	mov	ax, bx
  3869 0000188D 01D0                <1> 	add	ax, dx	; interpolated middle + [next_val]
  3870 0000188F D1D8                <1> 	rcr	ax, 1
  3871 00001891 50                  <1> 	push	ax ; *	; interpolated 3rd quarter (temporary)
  3872 00001892 01D8                <1> 	add	ax, bx	; + interpolated middle
  3873 00001894 D1D8                <1> 	rcr	ax, 1
  3874 00001896 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3875 00001899 AB                  <1> 	stosw		; interpolated sample 3 (L)
  3876 0000189A AB                  <1> 	stosw		; interpolated sample 3 (R)
  3877 0000189B 58                  <1> 	pop	ax ; *	
  3878 0000189C 01D0                <1> 	add	ax, dx	; 3rd quarter + [next_val]
  3879 0000189E D1D8                <1> 	rcr	ax, 1	; / 2
  3880 000018A0 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3881 000018A3 AB                  <1> 	stosw		; interpolated sample 4 (L)
  3882 000018A4 AB                  <1> 	stosw		; interpolated sample 4 (R)
  3883 000018A5 C3                  <1> 	retn
  3884                              <1> 
  3885                              <1> interpolating_5_16bit_stereo:
  3886                              <1> 	; 18/11/2023
  3887                              <1> 	; bx = [previous_val_l]
  3888                              <1> 	; ax = [previous_val_r]
  3889                              <1> 	; [next_val_l]
  3890                              <1> 	; [next_val_r]
  3891                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  3892 000018A6 51                  <1> 	push	cx ; !
  3893 000018A7 93                  <1> 	xchg	ax, bx
  3894 000018A8 AB                  <1> 	stosw		; original sample (L)
  3895 000018A9 93                  <1> 	xchg	ax, bx
  3896 000018AA AB                  <1> 	stosw		; original sample (R)
  3897 000018AB 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3898 000018AE 50                  <1> 	push	ax ; *	; [previous_val_r]
  3899 000018AF 80C780              <1> 	add	bh, 80h
  3900 000018B2 8006[CA19]80        <1> 	add	byte [next_val_l+1], 80h
  3901 000018B7 A1[C919]            <1> 	mov	ax, [next_val_l]
  3902 000018BA 01D8                <1> 	add	ax, bx	; [previous_val_l]
  3903 000018BC D1D8                <1> 	rcr	ax, 1
  3904 000018BE 89C1                <1> 	mov	cx, ax	; interpolated middle (L)
  3905 000018C0 01D8                <1> 	add	ax, bx	
  3906 000018C2 D1D8                <1> 	rcr	ax, 1
  3907 000018C4 89C2                <1> 	mov	dx, ax	; interpolated 1st quarter (L)	
  3908 000018C6 01D8                <1> 	add	ax, bx	; [previous_val_l]
  3909 000018C8 D1D8                <1> 	rcr	ax, 1
  3910 000018CA 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3911 000018CD AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3912 000018CE 89C8                <1> 	mov	ax, cx
  3913 000018D0 01D0                <1> 	add	ax, dx	; middle (L) + 1st quarter (L) 
  3914 000018D2 D1D8                <1> 	rcr	ax, 1	; / 2
  3915 000018D4 89C3                <1> 	mov	bx, ax  ; interpolated sample 2 (L)
  3916 000018D6 5A                  <1> 	pop	dx ; *	; [previous_val_r]
  3917 000018D7 89D0                <1> 	mov	ax, dx
  3918 000018D9 8006[CC19]80        <1> 	add	byte [next_val_r+1], 80h
  3919 000018DE 0306[CB19]          <1> 	add	ax, [next_val_r]
  3920 000018E2 D1D8                <1> 	rcr	ax, 1
  3921 000018E4 50                  <1> 	push	ax ; *	; interpolated middle (R)
  3922 000018E5 01D0                <1> 	add	ax, dx
  3923 000018E7 D1D8                <1> 	rcr	ax, 1
  3924 000018E9 50                  <1> 	push	ax ; **	; interpolated 1st quarter (R)
  3925 000018EA 01D0                <1> 	add	ax, dx	; [previous_val_r]
  3926 000018EC D1D8                <1> 	rcr	ax, 1
  3927 000018EE 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3928 000018F1 AB                  <1> 	stosw 		; interpolated sample 1 (R)
  3929 000018F2 89D8                <1> 	mov	ax, bx
  3930 000018F4 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3931 000018F7 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  3932 000018F8 58                  <1> 	pop	ax ; **
  3933 000018F9 5A                  <1> 	pop	dx ; *
  3934 000018FA 01D0                <1> 	add	ax, dx	; 1st quarter (R) + middle (R)
  3935 000018FC D1D8                <1> 	rcr	ax, 1	; / 2
  3936 000018FE 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3937 00001901 AB                  <1> 	stosw 		; interpolated sample 2 (R)
  3938 00001902 89C8                <1> 	mov	ax, cx
  3939 00001904 0306[C919]          <1> 	add	ax, [next_val_l]
  3940 00001908 D1D8                <1> 	rcr	ax, 1
  3941 0000190A 50                  <1> 	push	ax ; * 	; interpolated 3rd quarter (L)
  3942 0000190B 01C8                <1> 	add	ax, cx	; interpolated middle (L)
  3943 0000190D D1D8                <1> 	rcr	ax, 1
  3944 0000190F 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3945 00001912 AB                  <1> 	stosw 		; interpolated sample 3 (L)
  3946 00001913 89D0                <1> 	mov	ax, dx
  3947 00001915 0306[CB19]          <1> 	add	ax, [next_val_r]
  3948 00001919 D1D8                <1> 	rcr	ax, 1
  3949 0000191B 50                  <1> 	push	ax ; ** ; interpolated 3rd quarter (R)
  3950 0000191C 01D0                <1> 	add	ax, dx	; interpolated middle (R)
  3951 0000191E D1D8                <1> 	rcr	ax, 1
  3952 00001920 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3953 00001923 AB                  <1> 	stosw 		; interpolated sample 3 (R)
  3954 00001924 5B                  <1> 	pop	bx ; **
  3955 00001925 58                  <1> 	pop	ax ; *
  3956 00001926 0306[C919]          <1> 	add	ax, [next_val_l]
  3957 0000192A D1D8                <1> 	rcr	ax, 1
  3958 0000192C 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3959 0000192F AB                  <1> 	stosw 		; interpolated sample 4 (L)
  3960 00001930 89D8                <1> 	mov	ax, bx	
  3961 00001932 0306[CB19]          <1> 	add	ax, [next_val_r]
  3962 00001936 D1D8                <1> 	rcr	ax, 1
  3963 00001938 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3964 0000193B AB                  <1> 	stosw 		; interpolated sample 4 (R)
  3965 0000193C 59                  <1> 	pop	cx ; !
  3966 0000193D C3                  <1> 	retn
  3967                              <1> 
  3968                              <1> interpolating_4_16bit_mono:
  3969                              <1> 	; 18/11/2023
  3970                              <1> 	; ax = [previous_val]
  3971                              <1> 	; dx = [next_val]
  3972                              <1> 	; original-interpolated
  3973                              <1> 
  3974 0000193E AB                  <1> 	stosw		; original sample (L)
  3975 0000193F AB                  <1> 	stosw		; original sample (R)
  3976 00001940 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3977 00001943 89C3                <1> 	mov	bx, ax	; [previous_val]
  3978 00001945 80C680              <1> 	add	dh, 80h
  3979 00001948 01D0                <1> 	add	ax, dx	; [previous_val] + [next_val]
  3980 0000194A D1D8                <1> 	rcr	ax, 1
  3981 0000194C 93                  <1> 	xchg	ax, bx	
  3982 0000194D 01D8                <1> 	add	ax, bx	; [previous_val] + interpolated middle
  3983 0000194F D1D8                <1> 	rcr	ax, 1
  3984 00001951 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3985 00001954 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3986 00001955 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3987 00001956 89D8                <1> 	mov	ax, bx	; interpolated middle
  3988 00001958 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3989 0000195B AB                  <1> 	stosw 		; interpolated sample 2 (L)
  3990 0000195C AB                  <1> 	stosw		; interpolated sample 2 (R)
  3991 0000195D 89D8                <1> 	mov	ax, bx
  3992 0000195F 01D0                <1> 	add	ax, dx	; interpolated middle + [next_val]
  3993 00001961 D1D8                <1> 	rcr	ax, 1
  3994 00001963 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3995 00001966 AB                  <1> 	stosw		; interpolated sample 3 (L)
  3996 00001967 AB                  <1> 	stosw		; interpolated sample 3 (R)
  3997 00001968 C3                  <1> 	retn
  3998                              <1> 
  3999                              <1> interpolating_4_16bit_stereo:
  4000                              <1> 	; 18/11/2023
  4001                              <1> 	; bx = [previous_val_l]
  4002                              <1> 	; ax = [previous_val_r]
  4003                              <1> 	; [next_val_l]
  4004                              <1> 	; [next_val_r]
  4005                              <1> 	; original-interpolated-interpolated-interpolated
  4006 00001969 93                  <1> 	xchg	ax, bx
  4007 0000196A AB                  <1> 	stosw		; original sample (L)
  4008 0000196B 93                  <1> 	xchg	ax, bx
  4009 0000196C AB                  <1> 	stosw		; original sample (R)
  4010 0000196D 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  4011 00001970 89C2                <1> 	mov	dx, ax	; [previous_val_r]
  4012 00001972 80C780              <1> 	add	bh, 80h
  4013 00001975 8006[CA19]80        <1> 	add	byte [next_val_l+1], 80h
  4014 0000197A A1[C919]            <1> 	mov	ax, [next_val_l]
  4015 0000197D 01D8                <1> 	add	ax, bx	; [previous_val_l]
  4016 0000197F D1D8                <1> 	rcr	ax, 1
  4017 00001981 93                  <1> 	xchg	ax, bx	
  4018 00001982 01D8                <1> 	add	ax, bx	; bx = interpolated middle (L)
  4019 00001984 D1D8                <1> 	rcr	ax, 1
  4020 00001986 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4021 00001989 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  4022 0000198A 8006[CC19]80        <1> 	add	byte [next_val_r+1], 80h
  4023 0000198F 89D0                <1> 	mov	ax, dx	; [previous_val_r]
  4024 00001991 0306[CB19]          <1> 	add	ax, [next_val_r]
  4025 00001995 D1D8                <1> 	rcr	ax, 1
  4026 00001997 92                  <1> 	xchg	ax, dx	
  4027 00001998 01D0                <1> 	add	ax, dx	; dx = interpolated middle (R)
  4028 0000199A D1D8                <1> 	rcr	ax, 1
  4029 0000199C 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4030 0000199F AB                  <1> 	stosw 		; interpolated sample 1 (R)
  4031 000019A0 89D8                <1> 	mov	ax, bx
  4032 000019A2 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4033 000019A5 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  4034 000019A6 89D0                <1> 	mov	ax, dx
  4035 000019A8 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4036 000019AB AB                  <1> 	stosw 		; interpolated sample 2 (R)
  4037 000019AC 89D8                <1> 	mov	ax, bx
  4038 000019AE 0306[C919]          <1> 	add	ax, [next_val_l]
  4039 000019B2 D1D8                <1> 	rcr	ax, 1
  4040 000019B4 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4041 000019B7 AB                  <1> 	stosw 		; interpolated sample 3 (L)
  4042 000019B8 89D0                <1> 	mov	ax, dx
  4043 000019BA 0306[CB19]          <1> 	add	ax, [next_val_r]
  4044 000019BE D1D8                <1> 	rcr	ax, 1
  4045 000019C0 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4046 000019C3 AB                  <1> 	stosw 		; interpolated sample 3 (R)
  4047 000019C4 C3                  <1> 	retn
  4048                              <1> 
  4049                              <1> ; 13/11/2023
  4050                              <1> previous_val:
  4051 000019C5 0000                <1> previous_val_l: dw 0
  4052 000019C7 0000                <1> previous_val_r: dw 0
  4053                              <1> next_val:
  4054 000019C9 0000                <1> next_val_l: dw 0
  4055 000019CB 0000                <1> next_val_r: dw 0
  4056                              <1> 
  4057                              <1> ; 16/11/2023
  4058 000019CD 00                  <1> faz:	db 0	
  4059                              <1> 	
  4060                              <1> ; --------------------------------------------------------
   477                                  
   478                                  ; UTILS.ASM
   479                                  ;----------------------------------------------------------------------------
   480                                  ;       delay1_4ms - Delay for 1/4 millisecond.
   481                                  ;		    1mS = 1000us
   482                                  ;       Entry:
   483                                  ;         None
   484                                  ;       Exit:
   485                                  ;	  None
   486                                  ;
   487                                  ;       Modified:
   488                                  ;         None
   489                                  ;
   490                                  PORTB			EQU	061h
   491                                    REFRESH_STATUS	EQU	010h		; Refresh signal status
   492                                  
   493                                  delay1_4ms:
   494 000019CE 50                              push    ax 
   495 000019CF 51                              push    cx
   496 000019D0 B91000                          mov     cx, 16			; close enough.
   497 000019D3 E461                    	in	al,PORTB
   498 000019D5 2410                    	and	al,REFRESH_STATUS
   499 000019D7 88C4                    	mov	ah,al			; Start toggle state
   500 000019D9 09C9                    	or	cx, cx
   501 000019DB 7401                    	jz	short _d4ms1
   502 000019DD 41                      	inc	cx			; Throwaway first toggle
   503                                  _d4ms1:	
   504 000019DE E461                    	in	al,PORTB		; Read system control port
   505 000019E0 2410                    	and	al,REFRESH_STATUS	; Refresh toggles 15.085 microseconds
   506 000019E2 38C4                    	cmp	ah,al
   507 000019E4 74F8                    	je	short _d4ms1		; Wait for state change
   508                                  
   509 000019E6 88C4                    	mov	ah,al			; Update with new state
   510 000019E8 49                      	dec	cx
   511 000019E9 75F3                    	jnz	short _d4ms1
   512                                  
   513 000019EB 59                              pop     cx
   514 000019EC 58                              pop     ax
   515 000019ED C3                              retn
   516                                  
   517                                  	; 13/11/2016 - Erdogan Tan
   518                                  write_ac97_dev_info:
   519                                  	; BUS/DEV/FN
   520                                  	;	00000000BBBBBBBBDDDDDFFF00000000
   521                                  	; DEV/VENDOR
   522                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
   523                                  
   524 000019EE 30FF                    	xor	bh, bh
   525 000019F0 668B36[121E]            	mov	esi, [dev_vendor]
   526 000019F5 89F0                    	mov	ax, si
   527 000019F7 88C3                    	mov	bl, al
   528 000019F9 88DA                    	mov	dl, bl
   529 000019FB 80E30F                  	and	bl, 0Fh
   530 000019FE 8A87[8A1C]              	mov	al, [bx+hex_chars]
   531 00001A02 A2[CD1C]                	mov	[msgVendorId+3], al
   532 00001A05 88D3                    	mov	bl, dl
   533 00001A07 C0EB04                  	shr	bl, 4
   534 00001A0A 8A87[8A1C]              	mov	al, [bx+hex_chars]
   535 00001A0E A2[CC1C]                	mov	[msgVendorId+2], al
   536 00001A11 88E3                    	mov	bl, ah
   537 00001A13 88DA                    	mov	dl, bl
   538 00001A15 80E30F                  	and	bl, 0Fh
   539 00001A18 8A87[8A1C]              	mov	al, [bx+hex_chars]
   540 00001A1C A2[CB1C]                	mov	[msgVendorId+1], al
   541 00001A1F 88D3                    	mov	bl, dl
   542 00001A21 C0EB04                  	shr	bl, 4
   543 00001A24 8A87[8A1C]              	mov	al, [bx+hex_chars]
   544 00001A28 A2[CA1C]                	mov	[msgVendorId], al
   545 00001A2B 66C1EE10                	shr	esi, 16
   546 00001A2F 89F0                    	mov	ax, si
   547 00001A31 88C3                    	mov	bl, al
   548 00001A33 88DA                    	mov	dl, bl
   549 00001A35 80E30F                  	and	bl, 0Fh
   550 00001A38 8A87[8A1C]              	mov	al, [bx+hex_chars]
   551 00001A3C A2[DE1C]                	mov	[msgDevId+3], al
   552 00001A3F 88D3                    	mov	bl, dl
   553 00001A41 C0EB04                  	shr	bl, 4
   554 00001A44 8A87[8A1C]              	mov	al, [bx+hex_chars]
   555 00001A48 A2[DD1C]                	mov	[msgDevId+2], al
   556 00001A4B 88E3                    	mov	bl, ah
   557 00001A4D 88DA                    	mov	dl, bl
   558 00001A4F 80E30F                  	and	bl, 0Fh
   559 00001A52 8A87[8A1C]              	mov	al, [bx+hex_chars]
   560 00001A56 A2[DC1C]                	mov	[msgDevId+1], al
   561 00001A59 88D3                    	mov	bl, dl
   562 00001A5B C0EB04                  	shr	bl, 4
   563 00001A5E 8A87[8A1C]              	mov	al, [bx+hex_chars]
   564 00001A62 A2[DB1C]                	mov	[msgDevId], al
   565                                  
   566 00001A65 668B36[0E1E]            	mov	esi, [bus_dev_fn]
   567 00001A6A 66C1EE08                	shr	esi, 8
   568 00001A6E 89F0                    	mov	ax, si
   569 00001A70 88C3                    	mov	bl, al
   570 00001A72 88DA                    	mov	dl, bl
   571 00001A74 80E307                  	and	bl, 7 ; bit 0,1,2
   572 00001A77 8A87[8A1C]              	mov	al, [bx+hex_chars]
   573 00001A7B A2[021D]                	mov	[msgFncNo+1], al
   574 00001A7E 88D3                    	mov	bl, dl
   575 00001A80 C0EB03                  	shr	bl, 3
   576 00001A83 88DA                    	mov	dl, bl
   577 00001A85 80E30F                  	and	bl, 0Fh
   578 00001A88 8A87[8A1C]              	mov	al, [bx+hex_chars]
   579 00001A8C A2[F41C]                	mov	[msgDevNo+1], al
   580 00001A8F 88D3                    	mov	bl, dl
   581 00001A91 C0EB04                  	shr	bl, 4
   582 00001A94 8A87[8A1C]              	mov	al, [bx+hex_chars]
   583 00001A98 A2[F31C]                	mov	[msgDevNo], al
   584 00001A9B 88E3                    	mov	bl, ah
   585 00001A9D 88DA                    	mov	dl, bl
   586 00001A9F 80E30F                  	and	bl, 0Fh
   587 00001AA2 8A87[8A1C]              	mov	al, [bx+hex_chars]
   588 00001AA6 A2[E81C]                	mov	[msgBusNo+1], al
   589 00001AA9 88D3                    	mov	bl, dl
   590 00001AAB C0EB04                  	shr	bl, 4
   591 00001AAE 8A87[8A1C]              	mov	al, [bx+hex_chars]
   592 00001AB2 A2[E71C]                	mov	[msgBusNo], al
   593                                  
   594 00001AB5 A1[041E]                	mov	ax, [NAMBAR]
   595 00001AB8 88C3                    	mov	bl, al
   596 00001ABA 88DA                    	mov	dl, bl
   597 00001ABC 80E30F                  	and	bl, 0Fh
   598 00001ABF 8A87[8A1C]              	mov	al, [bx+hex_chars]
   599 00001AC3 A2[111D]                	mov	[msgNamBar+3], al
   600 00001AC6 88D3                    	mov	bl, dl
   601 00001AC8 C0EB04                  	shr	bl, 4
   602 00001ACB 8A87[8A1C]              	mov	al, [bx+hex_chars]
   603 00001ACF A2[101D]                	mov	[msgNamBar+2], al
   604 00001AD2 88E3                    	mov	bl, ah
   605 00001AD4 88DA                    	mov	dl, bl
   606 00001AD6 80E30F                  	and	bl, 0Fh
   607 00001AD9 8A87[8A1C]              	mov	al, [bx+hex_chars]
   608 00001ADD A2[0F1D]                	mov	[msgNamBar+1], al
   609 00001AE0 88D3                    	mov	bl, dl
   610 00001AE2 C0EB04                  	shr	bl, 4
   611 00001AE5 8A87[8A1C]              	mov	al, [bx+hex_chars]
   612 00001AE9 A2[0E1D]                	mov	[msgNamBar], al
   613                                  
   614                                  	; 08/05/2024 (ebx->bx)
   615                                  	; 05/11/2023
   616 00001AEC A1[061E]                	mov	ax, [NABMBAR]
   617 00001AEF 88C3                    	mov	bl, al
   618 00001AF1 88DA                    	mov	dl, bl
   619 00001AF3 80E30F                  	and	bl, 0Fh
   620 00001AF6 8A87[8A1C]              	mov	al, [bx+hex_chars]
   621 00001AFA A2[201D]                	mov	[msgNabmBar+3], al
   622 00001AFD 88D3                    	mov	bl, dl
   623 00001AFF C0EB04                  	shr	bl, 4
   624 00001B02 8A87[8A1C]              	mov	al, [bx+hex_chars]
   625 00001B06 A2[1F1D]                	mov	[msgNabmBar+2], al
   626 00001B09 88E3                    	mov	bl, ah
   627 00001B0B 88DA                    	mov	dl, bl
   628 00001B0D 80E30F                  	and	bl, 0Fh
   629 00001B10 8A87[8A1C]              	mov	al, [bx+hex_chars]
   630 00001B14 A2[1E1D]                	mov	[msgNabmBar+1], al
   631 00001B17 88D3                    	mov	bl, dl
   632 00001B19 C0EB04                  	shr	bl, 4
   633 00001B1C 8A87[8A1C]              	mov	al, [bx+hex_chars]
   634 00001B20 A2[1D1D]                	mov	[msgNabmBar], al
   635                                  
   636                                  	; 24/11/2016
   637 00001B23 30E4                    	xor	ah, ah
   638 00001B25 A0[FB1D]                	mov	al, [ac97_int_ln_reg]
   639 00001B28 B10A                    	mov	cl, 10
   640 00001B2A F6F1                    	div	cl
   641 00001B2C 0106[281D]              	add	[msgIRQ], ax
   642 00001B30 20C0                    	and	al, al
   643 00001B32 7508                    	jnz	short _pmi
   644 00001B34 A0[291D]                	mov	al, [msgIRQ+1]
   645 00001B37 B420                    	mov	ah, ' '
   646 00001B39 A3[281D]                	mov	[msgIRQ], ax
   647                                  _pmi:
   648 00001B3C BA[9B1C]                        mov	dx, msgAC97Info
   649 00001B3F B409                            mov     ah, 9
   650 00001B41 CD21                            int     21h
   651 00001B43 C3                              retn
   652                                  
   653                                  write_sample_rate:
   654                                  	; ax = sample rate (hertz)
   655                                  
   656 00001B44 31D2                    	xor	dx, dx
   657 00001B46 B90A00                  	mov	cx, 10
   658 00001B49 F7F1                    	div	cx
   659 00001B4B 0016[3E1D]              	add	[msgHertz+4], dl
   660 00001B4F 29D2                    	sub	dx, dx
   661 00001B51 F7F1                    	div	cx
   662 00001B53 0016[3D1D]              	add	[msgHertz+3], dl
   663 00001B57 29D2                    	sub	dx, dx
   664 00001B59 F7F1                    	div	cx
   665 00001B5B 0016[3C1D]              	add	[msgHertz+2], dl
   666 00001B5F 29D2                    	sub	dx, dx
   667 00001B61 F7F1                    	div	cx
   668 00001B63 0016[3B1D]              	add	[msgHertz+1], dl
   669 00001B67 0006[3A1D]              	add	[msgHertz], al
   670                                  	
   671 00001B6B BA[2D1D]                        mov     dx, msgSampleRate
   672 00001B6E B409                            mov     ah, 9
   673 00001B70 CD21                            int     21h
   674                                  
   675                                  	; 19/11/2016
   676 00001B72 BA[531D]                	mov	dx, msg16Bits
   677 00001B75 803E[1A1E]10            	cmp	byte [bps], 16
   678 00001B7A 7403                    	je	short wsr_1
   679 00001B7C BA[441D]                	mov	dx, msg8Bits
   680                                  wsr_1:
   681 00001B7F B409                            mov     ah, 9
   682 00001B81 CD21                            int     21h
   683                                  
   684 00001B83 BA[4C1D]                	mov	dx, msgMono
   685 00001B86 803E[181E]01            	cmp	byte [stmo], 1
   686 00001B8B 7403                    	je	short wsr_2
   687 00001B8D BA[5C1D]                	mov	dx, msgStereo
   688                                  wsr_2:
   689 00001B90 B409                            mov     ah, 9
   690 00001B92 CD21                            int     21h
   691                                  
   692 00001B94 C3                              retn
   693                                  
   694                                  ; 19/05/2024
   695                                  ; 10/11/2023
   696                                  ; 09/11/2023
   697                                  ; 06/11/2023
   698                                  %if 1
   699                                  
   700                                  ac97_int_handler:
   701                                  	; 19/05/2024
   702                                  	; 16/05/2024 ('PLAYMOD3.ASM', 18/05/2024, Erdogan Tan)
   703                                  	; 11/11/2023
   704                                  	; 10/11/2023
   705                                  	; 17/02/2016
   706 00001B95 50                      	push	ax ; +	; 16/05/2024
   707                                  	;push	eax ; *	; 11/11/2023
   708 00001B96 52                      	push	dx ; **
   709                                  	; 05/11/2023
   710                                  	;push	cx
   711                                  	;push	bx
   712                                  	;push	si
   713                                  	;push	di
   714                                  
   715                                  	; 10/11/2023
   716                                  	; EOI at first
   717 00001B97 B020                    	mov	al, 20h
   718 00001B99 F606[FB1D]08            	test	byte [ac97_int_ln_reg], 8
   719 00001B9E 7402                    	jz	short _ih_0
   720 00001BA0 E6A0                    	out 	0A0h, al ; 20h	; EOI
   721                                  _ih_0:
   722 00001BA2 E620                    	out	20h, al  ; 20h	; EOI
   723                                  
   724                                  	; 16/05/2024
   725                                  ;	mov	dx, GLOB_STS_REG
   726                                  ;	add	dx, [NABMBAR]
   727                                  ;	in	eax, dx
   728                                  ;
   729                                  ;	inc	eax	; 0FFFFFFFFh
   730                                  ;	jz	short _ih_3
   731                                  ;	dec	eax	; 0
   732                                  ;	;jz	short _ih_3
   733                                  ;_ih_3:
   734                                  ;	; 16/05/2024
   735                                  ;	push	eax ; ***
   736                                  
   737                                  	; 16/05/2024
   738                                  	; 24/11/2023 (TRDOS386 'audio.s')
   739 00001BA4 8B16[061E]                      mov	dx, [NABMBAR]
   740 00001BA8 83C216                  	add	dx, PO_SR_REG
   741 00001BAB ED                      	in	ax, dx
   742                                  
   743 00001BAC A808                    	test	al, BCIS ; bit 3, 8
   744 00001BAE 7405                    	jz	short _ih_2
   745                                  
   746                                  	; 19/05/2024
   747                                  	; 15/05/2024
   748                                  	;cmp	byte [tLoop], 1
   749                                  	;jb	short _ih_2
   750                                  
   751                                  _ih_1:
   752                                  	; 19/05/2024
   753 00001BB0 50                      	push	ax ; ****
   754                                  
   755                                  	; 10/11/2023
   756                                  	; 28/11/2016 - Erdogan Tan
   757 00001BB1 E8BDEB                  	call	tuneLoop
   758                                  
   759                                  	; 19/05/2024
   760 00001BB4 58                      	pop	ax ; ****
   761                                  
   762                                  	; 16/05/2024
   763                                  _ih_2:
   764                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   765 00001BB5 8B16[061E]              	mov	dx, [NABMBAR]
   766 00001BB9 83C216                  	add	dx, PO_SR_REG
   767 00001BBC EF                      	out	dx, ax
   768                                  
   769                                  ;	; 16/05/2024
   770                                  ;	pop	eax ; ***
   771                                  ;	
   772                                  ;	or	eax, eax
   773                                  ;	jz	short _ih_4
   774                                  ;	
   775                                  ;	mov	dx, GLOB_STS_REG
   776                                  ;	add	dx, [NABMBAR]
   777                                  ;	out	dx, eax
   778                                  
   779                                  	; 16/05/2024
   780                                  _ih_4:
   781                                  	; 10/11/2023
   782                                  	;mov	al, 20h
   783                                  	;test	byte [ac97_int_ln_reg], 8
   784                                  	;jz	short _ih_5
   785                                  	;out 	0A0h, al ; 20h	; EOI
   786                                  ;_ih_5:
   787                                  	;out	20h, al  ; 20h	; EOI
   788                                  ;_ih_6:
   789                                  	;pop	di
   790                                  	;pop	si
   791                                  	;pop	bx
   792                                  	;pop	cx
   793 00001BBD 5A                      	pop	dx ; **
   794                                  	;pop	eax ; *	; 11/11/2023
   795 00001BBE 58                      	pop	ax ; + ; 16/05/2024
   796 00001BBF CF                      	iret
   797                                  
   798                                  %else
   799                                  
   800                                  ac97_int_handler:
   801                                  	; 19/11/2023
   802                                  	; 18/11/2023
   803                                  	; 11/11/2023
   804                                  	; 10/11/2023
   805                                  	; 17/02/2016
   806                                  	push	eax	; 11/11/2023
   807                                  	push	dx
   808                                  	; 05/11/2023
   809                                  	;push	cx
   810                                  	;push	bx
   811                                  	;push	si
   812                                  	;push	di
   813                                  
   814                                  ;	; 10/11/2023
   815                                  ;	; EOI at first
   816                                  ;	mov	al, 20h
   817                                  ;	test	byte [ac97_int_ln_reg], 8
   818                                  ;	jz	short _ih_0
   819                                  ;	out 	0A0h, al ; 20h	; EOI
   820                                  ;_ih_0:
   821                                  ;	out	20h, al  ; 20h	; EOI
   822                                  
   823                                  	; 11/11/2023
   824                                  	; 09/11/2023
   825                                  	mov	dx, GLOB_STS_REG
   826                                          add	dx, [NABMBAR]
   827                                  	in	eax, dx
   828                                  	
   829                                  	; 09/11/2023,
   830                                          cmp	eax, 0FFFFFFFFh ; -1
   831                                  	je	short _ih_2
   832                                  	
   833                                  	test	al, 40h		; PCM Out Interrupt
   834                                  	jnz	short _ih_1
   835                                  
   836                                  	test	eax, eax
   837                                  	jz	short _ih_2
   838                                  
   839                                   	;mov	dx, GLOB_STS_REG
   840                                          ;add	dx, [NABMBAR]
   841                                  	out	dx, eax
   842                                  	jmp	short _ih_2
   843                                  _ih_1:
   844                                  	; 11/11/2023
   845                                  	push	eax
   846                                  
   847                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   848                                  	;mov	dx, PO_SR_REG
   849                                          ;add	dx, [NABMBAR]
   850                                  	;out	dx, ax
   851                                  
   852                                  	; 10/11/2023
   853                                  	; 28/11/2016 - Erdogan Tan
   854                                  	call	tuneLoop
   855                                  
   856                                  	; 11/11/2023
   857                                  	pop	eax
   858                                  	
   859                                  	mov	dx, GLOB_STS_REG
   860                                          add	dx, [NABMBAR]
   861                                  	out	dx, eax
   862                                  _ih_2:
   863                                  	; 11/11/2023
   864                                  	mov	dx, [NABMBAR]
   865                                  	add	dx, PO_SR_REG	; set pointer to Status reg
   866                                  	mov	ax, 1Ch ; clear FIFOE, BCIS, LVBCI
   867                                  	out	dx, ax
   868                                  
   869                                  _ih_3:	; 19/11/2023
   870                                  	mov	al, 20h
   871                                  	test	byte [ac97_int_ln_reg], 8
   872                                  	jz	short _ih_0
   873                                  	out 	0A0h, al ; 20h	; EOI
   874                                  _ih_0:
   875                                  	out	20h, al  ; 20h	; EOI
   876                                  
   877                                  	pop	dx
   878                                  	pop	eax
   879                                  	iret
   880                                  
   881                                  %endif
   882                                  
   883                                  ac97_stop:
   884                                  	; 11/11/2023
   885                                  	; 09/11/2023
   886                                  	; 05/11/2023
   887                                  	; 04/11/2023 
   888                                  	; 28/05/2017 (TRDOS 386 v2, 'audio.s')
   889                                  	;mov	byte [tLoop], 0 ; stop ! ; 05/11/2023
   890                                  ;_ac97_stop:
   891                                  
   892                                  	; 11/11/2023
   893 00001BC0 8B16[041E]              	mov	dx, [NAMBAR]
   894                                  	;add	dx, 0 ; ac_reg_0 ; reset register
   895 00001BC4 EF                      	out	dx, ax
   896                                  
   897                                  	; 04/11/2023
   898                                  	; 09/10/2017 (TRDOS 386 v2, 'audio.s')
   899                                  	; 11/06/2017
   900 00001BC5 30C0                    	xor	al, al ; 0
   901 00001BC7 E80D00                  	call	ac97_po_cmd
   902                                  
   903                                  	; (Ref: KolibriOS, intelac97.asm, 'stop:')
   904                                  	; Clear FIFOE, BCIS, LVBCI (Ref: Intel ICH hub manual)
   905 00001BCA B81C00                  	mov     ax, 1Ch
   906 00001BCD 8B16[061E]              	mov     dx, [NABMBAR]
   907 00001BD1 83C216                  	add     dx, PO_SR_REG
   908 00001BD4 EF                      	out     dx, ax
   909                                  
   910                                  	; 11/06/2017
   911 00001BD5 B002                    	mov     al, RR
   912                                  ac97_po_cmd:
   913                                  	; 11/06/2017
   914                                  	; 29/05/2017
   915 00001BD7 8B16[061E]              	mov     dx, [NABMBAR]
   916 00001BDB 83C21B                          add     dx, PO_CR_REG		; PCM out control register
   917 00001BDE EE                      	out	dx, al
   918 00001BDF C3                      	retn
   919                                  
   920                                  print_msg:
   921                                  	; 13/11/2016 - Erdogan Tan 
   922                                  	; esi = ASCIIZ text address
   923                                  	;
   924 00001BE0 BB0700                  	mov	bx, 7h
   925 00001BE3 B40E                    	mov	ah, 0Eh 
   926                                  pm_next_char:
   927 00001BE5 AC                      	lodsb
   928 00001BE6 20C0                    	and	al, al
   929 00001BE8 7404                    	jz	short pm_retn
   930 00001BEA CD10                    	int	10h
   931 00001BEC EBF7                    	jmp	short pm_next_char
   932                                  pm_retn:
   933 00001BEE C3                      	retn
   934                                  
   935                                  ; 06/11/2023
   936                                  ;dword2str:
   937                                  ;	; 13/11/2016 - Erdogan Tan
   938                                  ;	; eax = dword value
   939                                  ;	;
   940                                  ;	call	dwordtohex
   941                                  ;	mov	[dword_str], edx
   942                                  ;	mov	[dword_str+4], eax
   943                                  ;	mov	si, dword_str
   944                                  ;	retn
   945                                  
   946                                  	; trdos386.s (unix386.s) - 10/05/2015
   947                                  	; Convert binary number to hexadecimal string
   948                                  
   949                                  bytetohex:
   950                                  	; INPUT ->
   951                                  	; 	AL = byte (binary number)
   952                                  	; OUTPUT ->
   953                                  	;	AX = hexadecimal string
   954                                  	;
   955 00001BEF 53                      	push	bx
   956 00001BF0 30FF                    	xor	bh, bh
   957 00001BF2 88C3                    	mov	bl, al
   958 00001BF4 C0EB04                  	shr	bl, 4
   959 00001BF7 8A9F[8A1C]              	mov	bl, [bx+hex_chars]
   960 00001BFB 86D8                    	xchg	bl, al
   961 00001BFD 80E30F                  	and	bl, 0Fh
   962 00001C00 8AA7[8A1C]              	mov	ah, [bx+hex_chars]
   963 00001C04 5B                      	pop	bx	
   964 00001C05 C3                      	retn
   965                                  
   966                                  wordtohex:
   967                                  	; INPUT ->
   968                                  	; 	AX = word (binary number)
   969                                  	; OUTPUT ->
   970                                  	;	EAX = hexadecimal string
   971                                  	;
   972 00001C06 53                      	push	bx
   973 00001C07 30FF                    	xor	bh, bh
   974 00001C09 86E0                    	xchg	ah, al
   975 00001C0B 50                      	push	ax
   976 00001C0C 88E3                    	mov	bl, ah
   977 00001C0E C0EB04                  	shr	bl, 4
   978 00001C11 8A87[8A1C]              	mov	al, [bx+hex_chars]
   979 00001C15 88E3                    	mov	bl, ah
   980 00001C17 80E30F                  	and	bl, 0Fh
   981 00001C1A 8AA7[8A1C]              	mov	ah, [bx+hex_chars]
   982 00001C1E 66C1E010                	shl	eax, 16
   983 00001C22 58                      	pop	ax
   984 00001C23 5B                      	pop	bx
   985 00001C24 EBC9                    	jmp	short bytetohex
   986                                  
   987                                  ; 06/11/2023
   988                                  ;dwordtohex:
   989                                  ;	; INPUT ->
   990                                  ;	; 	EAX = dword (binary number)
   991                                  ;	; OUTPUT ->
   992                                  ;	;	EDX:EAX = hexadecimal string
   993                                  ;	;
   994                                  ;	push	eax
   995                                  ;	shr	eax, 16
   996                                  ;	call	wordtohex
   997                                  ;	mov	edx, eax
   998                                  ;	pop	eax
   999                                  ;	call	wordtohex
  1000                                  ;	retn
  1001                                  
  1002                                  _DATA:
  1003                                  
  1004                                  ; 24/11/2016
  1005                                  ;	IRQ  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 
  1006 00001C26 08090A0B0C0D0E0F70-     irq_int	 db 08h,09h,0Ah,0Bh,0Ch,0Dh,0Eh,0Fh,70h,71h,72h,73h,74h,75h,76h,77h
  1006 00001C2F 71727374757677     
  1007                                  
  1008                                  ; 17/02/2017
  1009                                  ; Valid ICH device IDs
  1010                                  
  1011                                  valid_ids:
  1012 00001C36 86801524                dd	(ICH_DID << 16) + INTEL_VID  	 ; 8086h:2415h
  1013 00001C3A 86802524                dd	(ICH0_DID << 16) + INTEL_VID 	 ; 8086h:2425h
  1014 00001C3E 86804524                dd	(ICH2_DID << 16) + INTEL_VID 	 ; 8086h:2445h
  1015 00001C42 86808524                dd	(ICH3_DID << 16) + INTEL_VID 	 ; 8086h:2485h
  1016 00001C46 8680C524                dd	(ICH4_DID << 16) + INTEL_VID 	 ; 8086h:24C5h
  1017 00001C4A 8680D524                dd	(ICH5_DID << 16) + INTEL_VID 	 ; 8086h:24D5h
  1018 00001C4E 86806E26                dd	(ICH6_DID << 16) + INTEL_VID 	 ; 8086h:266Eh
  1019 00001C52 8680A625                dd	(ESB6300_DID << 16) + INTEL_VID  ; 8086h:25A6h
  1020 00001C56 86809826                dd	(ESB631X_DID << 16) + INTEL_VID  ; 8086h:2698h
  1021 00001C5A 8680DE27                dd	(ICH7_DID << 16) + INTEL_VID 	 ; 8086h:27DEh
  1022                                  ; 03/11/2023 - Erdogan Tan
  1023 00001C5E 86809571                dd	(MX82440_DID << 16) + INTEL_VID  ; 8086h:7195h
  1024 00001C62 39101270                dd	(SI7012_DID << 16)  + SIS_VID	 ; 1039h:7012h
  1025 00001C66 DE10B101                dd 	(NFORCE_DID << 16)  + NVIDIA_VID ; 10DEh:01B1h
  1026 00001C6A DE106A00                dd 	(NFORCE2_DID << 16) + NVIDIA_VID ; 10DEh:006Ah
  1027 00001C6E 22106D74                dd 	(AMD8111_DID << 16) + AMD_VID 	 ; 1022h:746Dh
  1028 00001C72 22104574                dd 	(AMD768_DID << 16)  + AMD_VID 	 ; 1022h:7445h
  1029 00001C76 DE105900                dd 	(CK804_DID << 16) + NVIDIA_VID	 ; 10DEh:0059h
  1030 00001C7A DE103A00                dd 	(MCP04_DID << 16) + NVIDIA_VID	 ; 10DEh:003Ah
  1031 00001C7E DE108A00                dd 	(CK8_DID << 16) + NVIDIA_VID	 ; 1022h:008Ah
  1032 00001C82 DE10DA00                dd 	(NFORCE3_DID << 16) + NVIDIA_VID ; 10DEh:00DAh
  1033 00001C86 DE10EA00                dd 	(CK8S_DID << 16) + NVIDIA_VID	 ; 10DEh:00EAh
  1034                                  
  1035                                  valid_id_count:	equ ($ - valid_ids)>>2 ; 05/11/2023
  1036                                  
  1037                                  ; 13/11/2016
  1038 00001C8A 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  1038 00001C93 3941424344454600   
  1039 00001C9B 414339372041756469-     msgAC97Info	db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  1039 00001CA4 6F20436F6E74726F6C-
  1039 00001CAD 6C6572202620436F64-
  1039 00001CB6 656320496E666F0D0A 
  1040 00001CBF 56656E646F72204944-     		db "Vendor ID: "
  1040 00001CC8 3A20               
  1041 00001CCA 303030306820446576-     msgVendorId	db "0000h Device ID: "
  1041 00001CD3 6963652049443A20   
  1042 00001CDB 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  1043 00001CE2 4275733A20              		db "Bus: "
  1044 00001CE7 303068204465766963-     msgBusNo	db "00h Device: "
  1044 00001CF0 653A20             
  1045 00001CF3 3030682046756E6374-     msgDevNo	db "00h Function: "
  1045 00001CFC 696F6E3A20         
  1046 00001D01 303068                  msgFncNo	db "00h"
  1047 00001D04 0D0A                    		db 0Dh, 0Ah
  1048                                  ; 05/11/2023	
  1049 00001D06 4E414D4241523A20        		db "NAMBAR: "
  1050 00001D0E 303030306820            msgNamBar	db "0000h "
  1051 00001D14 4E41424D4241523A20      		db "NABMBAR: "
  1052 00001D1D 303030306820495251-     msgNabmBar	db "0000h IRQ: "
  1052 00001D26 3A20               
  1053 00001D28 3030                    msgIRQ		dw 3030h
  1054 00001D2A 0D0A24                  		db 0Dh, 0Ah, "$"
  1055 00001D2D 53616D706C65205261-     msgSampleRate	db "Sample Rate: "
  1055 00001D36 74653A20           
  1056 00001D3A 303030303020487A20-     msgHertz	db "00000 Hz ", "$" 
  1056 00001D43 24                 
  1057 00001D44 3820626974732024        msg8Bits	db "8 bits ", "$" 
  1058 00001D4C 4D6F6E6F0D0A24          msgMono		db "Mono", 0Dh, 0Ah, "$"
  1059 00001D53 313620626974732024      msg16Bits	db "16 bits ", "$" 
  1060 00001D5C 53746572656F0D0A24      msgStereo	db "Stereo", 0Dh, 0Ah, "$"
  1061                                  
  1062                                  ;; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
  1063                                  ;codec_id	dd 0
  1064                                  ;codec_chip_id	dd 0
  1065                                  ;codec_vendor_ids dw 0
  1066                                  ;codec_chip_ids	dw 0
  1067                                  
  1068 00001D65 3030303030303030        dword_str	 dd 30303030h, 30303030h
  1069 00001D6D 680D0A00                		 db 'h', 0Dh, 0Ah, 0
  1070                                  
  1071                                  ;ac_unknown     db 'unknown manufacturer',13,10,0
  1072                                  ;ac_Realtek     db 'Realtek Semiconductor',13,10,0
  1073                                  ;ac_Analog      db 'Analog Devices',13,10,0
  1074                                  ;ac_CMedia      db 'C-Media Electronics',13,10,0
  1075                                  ;ac_Cirrus      db 'Cirrus Logic',13,10,0
  1076                                  ;ac_Wolfson     db 'Wolfson Microelectronics',13,10,0
  1077                                  ;ac_VIA         db 'VIA Technologies',13,10,0
  1078                                  ;ac_SigmaTel    db 'SigmaTel',13,10,0
  1079                                  ;ac_eMicro      db 'eMicro',13,10,0
  1080                                  ;
  1081                                  ;chip_unknown   db 'unknown codec id ', 0
  1082                                  
  1083                                  ;CHIP_REALTEK   equ 414C4700h
  1084                                  ;CHIP_CMEDIA    equ 434D4900h
  1085                                  ;CHIP_VIA       equ 56494100h
  1086                                  
  1087                                  ;codecs        dd CHIP_CMEDIA
  1088                                  ;	       dw ac_CMedia, chips_CMedia
  1089                                  ;              dd CHIP_REALTEK
  1090                                  ;	       dw ac_Realtek, chips_Realtek
  1091                                  ;              dd CHIP_VIA
  1092                                  ;	       dw ac_VIA, chips_VIA
  1093                                  ;              dd 0
  1094                                  
  1095                                  ;chips_Realtek dw 10h, chip_ALC201a
  1096                                  ;              dw 20h, chip_ALC650
  1097                                  ;              dw 21h, chip_ALC650D
  1098                                  ;              dw 22h, chip_ALC650E
  1099                                  ;              dw 23h, chip_ALC650F
  1100                                  ;              dw 60h, chip_ALC655
  1101                                  ;              dw 80h, chip_ALC658
  1102                                  ;              dw 81h, chip_ALC658D
  1103                                  ;              dw 90h, chip_ALC850
  1104                                  ;              dw 0FFh
  1105                                  
  1106                                  ;chips_CMedia  dw 41h, chip_CM9738
  1107                                  ;              dw 61h, chip_CM9739
  1108                                  ;              dw 69h, chip_CM9780
  1109                                  ;              dw 78h, chip_CM9761
  1110                                  ;              dw 82h, chip_CM9761
  1111                                  ;              dw 83h, chip_CM9761
  1112                                  ;              dw 0FFh
  1113                                  
  1114                                  ;chips_VIA     dw 61h, chip_VIA1612A
  1115                                  ;              dw 0FFh
  1116                                  
  1117                                  ;Realtek
  1118                                  ;chip_ALC201a    db 'ALC201a',0dh,0ah,00h
  1119                                  ;chip_ALC650     db 'ALC650 ',0dh,0ah,00h
  1120                                  ;chip_ALC650D    db 'ALC650D',0dh,0ah,00h
  1121                                  ;chip_ALC650E    db 'ALC650E',0dh,0ah,00h
  1122                                  ;chip_ALC650F    db 'ALC650F',0dh,0ah,00h
  1123                                  ;chip_ALC655     db 'ALC655 ',0dh,0ah,00h
  1124                                  ;chip_ALC658     db 'ALC658 ',0dh,0ah,00h
  1125                                  ;chip_ALC658D    db 'ALC658D',0dh,0ah,00h
  1126                                  ;chip_ALC850     db 'ALC850 ',0dh,0ah,00h
  1127                                  
  1128                                  ;CMedia
  1129                                  ;chip_CM9738     db 'CMI9738', 0dh,0ah,0
  1130                                  ;chip_CM9739     db 'CMI9739', 0dh,0ah,0
  1131                                  ;chip_CM9780     db 'CMI9780', 0dh,0ah,0
  1132                                  ;chip_CM9761     db 'CMI9761', 0dh,0ah,0
  1133                                  
  1134                                  ;VIA
  1135                                  ;chip_VIA1612A   db 'VIA1612A',13,10,0
  1136                                  
  1137                                  ; 11/11/2023
  1138                                  msg_init_err:
  1139 00001D71 0D0A                    	db	CR, LF
  1140 00001D73 4143393720436F6E74-     	db	"AC97 Controller/Codec initialization error !"
  1140 00001D7C 726F6C6C65722F436F-
  1140 00001D85 64656320696E697469-
  1140 00001D8E 616C697A6174696F6E-
  1140 00001D97 206572726F722021   
  1141 00001D9F 0D0A24                  	db	CR, LF, "$"
  1142                                  
  1143                                  ; 12/11/2023
  1144                                  msg_no_vra:
  1145 00001DA2 0D0A                    	db	CR, LF
  1146 00001DA4 4E6F20565241207375-     	db	"No VRA support ! Only 48 kHZ sample rate supported !"
  1146 00001DAD 70706F72742021204F-
  1146 00001DB6 6E6C79203438206B48-
  1146 00001DBF 5A2073616D706C6520-
  1146 00001DC8 726174652073757070-
  1146 00001DD1 6F727465642021     
  1147 00001DD8 0D0A24                  	db	CR, LF, "$"
  1148                                  
  1149                                  ; 17/02/2017
  1150                                  bss_start:
  1151                                  
  1152                                  ABSOLUTE bss_start
  1153                                  
  1154 00001DDB ??                      alignb 2
  1155                                  
  1156                                  ; 28/11/2016
  1157                                  
  1158 00001DDC <res 1Ch>               smpRBuff:	resw 14 ; 19/11/2016 - Erdogan Tan
  1159                                  
  1160 00001DF8 ????                    filehandle:	resw 1
  1161                                  
  1162 00001DFA ??                      flags:		resb 1
  1163                                  ; 06/11/2023
  1164 00001DFB ??                      ac97_int_ln_reg: resb 1
  1165                                  
  1166                                  ; 09/11/2023
  1167                                  ; 06/11/2023
  1168                                  ;pcm_irq_status: resb 1	; 05/11/2023
  1169 00001DFC ??                      inside:		resb 1
  1170 00001DFD ??                      tloop:		resb 1	; 10/11/2023
  1171                                  
  1172                                  ; 09/11/2023
  1173                                  ; 04/11/2023 - 06/11/2023
  1174 00001DFE ????                    IRQ_status:	resw 1	; IRQ status before enabling audio interrupt
  1175 00001E00 ????????                IRQ_vector:	resd 1  ; Previous interrupt handler address
  1176                                  
  1177                                  ; 17/02/2017
  1178                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  1179                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  1180                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  1181                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  1182 00001E04 ????                    NAMBAR:		resw 1			; BAR for mixer
  1183 00001E06 ????                    NABMBAR:	resw 1			; BAR for bus master regs
  1184                                  
  1185                                  ; 256 byte buffer for descriptor list
  1186 00001E08 ????                    BDL_BUFFER:	resw 1			; segment of our 256byte BDL buffer
  1187 00001E0A ????                    WAV_BUFFER1:	resw 1			; segment of our WAV storage
  1188                                  ; 64k buffers for wav file storage
  1189 00001E0C ????                    WAV_BUFFER2:	resw 1			; segment of 2nd wav buffer
  1190                                  
  1191                                  ; 06/11/2023
  1192                                  ;tBuff:		resb 1
  1193                                  ;ac97_int_ln_reg: resb 1
  1194                                  
  1195                                  ; 12/11/2016 - Erdogan Tan
  1196                                  
  1197 00001E0E ????????                bus_dev_fn:	resd 1
  1198 00001E12 ????????                dev_vendor:	resd 1
  1199                                  ; 06/11/2023
  1200                                  ;stats_cmd:	resw 1 ; 17/02/2017
  1201                                  ; 05/11/2023
  1202                                  ;ac97_io_base:	resw 1
  1203 00001E16 ????                    sample_rate:	resw 1
  1204                                  
  1205                                  ; 19/11/2016
  1206 00001E18 ????                    stmo:		resw 1
  1207 00001E1A ????                    bps:		resw 1
  1208                                  
  1209                                  ; 08/11/2023
  1210                                  ; 07/11/2023
  1211 00001E1C ??                      fbs_shift:	resb 1
  1212                                  ; 09/11/2023
  1213 00001E1D ??                      b_indicator:	resb 1
  1214                                  ; 10/11/2023
  1215 00001E1E ??                      LVI:		resb 1
  1216 00001E1F ??                      		resb 1 ; 10/11/2023 
  1217                                  
  1218                                  ;fbs_seg:	resw 1
  1219                                  ;fbs_off:	resw 1
  1220                                  
  1221                                  ;alignb 2
  1222                                  
  1223                                  ; 32 kilo bytes for temporay buffer
  1224                                  ; (for stereo-mono, 8bit/16bit corrections)
  1225                                  ;temp_buffer:	resb 32768
  1226                                  ; 18/11/2023
  1227 00001E20 <res DBF0h>             temp_buffer:	resb 56304  ; (44.1 kHZ stereo 14076 samples)
  1228                                  
  1229                                  ;alignb 16
  1230                                  EOF:
