     1                                  ; ****************************************************************************
     2                                  ; PLAYWAV.ASM - ICH AC97 .wav player for DOS.			   PLAYWAV.COM
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; Last Update: 16/11/2023 (Previous: 12/11/2023)
     5                                  ; ----------------------------------------------------------------------------
     6                                  ; Beginning: 17/02/2017
     7                                  ; ----------------------------------------------------------------------------
     8                                  ; Assembler: NASM version 2.11 (2.15)
     9                                  ;	     nasm playwav.asm -l playwav.lst -o PLAYWAV.COM	
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Derived from '.wav file player for DOS' Jeff Leyda, Sep 02, 2002 
    12                                  ; ****************************************************************************
    13                                  ; Modidified from 'PLAYER.COM' for VIA VT8233 wav player source code by
    14                                  ; (PLAYER.ASM) by Erdogan Tan (07/11/2016 - 08/12/2016)
    15                                  
    16                                  ; AC97 interrupt version - 09/11/2023 - Erdogan Tan
    17                                  ; sample rate conversion version - 13/11/2023 - Erdogan Tan
    18                                  
    19                                  [BITS 16]
    20                                  
    21                                  [ORG 100h] 
    22                                  
    23                                  	%include 'ac97.inc' ; 17/02/2017
     1                              <1> ; 11/11/2023
     2                              <1> ; 05/11/2023
     3                              <1> ; 03/11/2023
     4                              <1> ; 17/02/2017 (Erdogan Tan, PLAYWAV.ASM)
     5                              <1> ; constant.inc & codec.inc (for ICH AC97 wav player, 'PLAYWAV.COM') 
     6                              <1> 
     7                              <1> ; ----------------------------------------------------------------------------
     8                              <1> ; CONSTANT.INC
     9                              <1> ; ----------------------------------------------------------------------------
    10                              <1> 
    11                              <1> ;constants of stuff that seem hard to remember at times.
    12                              <1> 
    13                              <1> TRUE  EQU 1
    14                              <1> FALSE EQU 0
    15                              <1> 
    16                              <1> ENABLED  EQU 1
    17                              <1> DISABLED EQU 0
    18                              <1> 
    19                              <1> BIT0  EQU 1
    20                              <1> BIT1  EQU 2
    21                              <1> BIT2  EQU 4
    22                              <1> BIT3  EQU 8
    23                              <1> BIT4  EQU 10h
    24                              <1> BIT5  EQU 20h
    25                              <1> BIT6  EQU 40h
    26                              <1> BIT7  EQU 80h
    27                              <1> BIT8  EQU 100h
    28                              <1> BIT9  EQU 200h
    29                              <1> BIT10 EQU 400h
    30                              <1> BIT11 EQU 800h
    31                              <1> BIT12 EQU 1000h
    32                              <1> BIT13 EQU 2000h
    33                              <1> BIT14 EQU 4000h
    34                              <1> BIT15 EQU 8000h
    35                              <1> BIT16 EQU 10000h
    36                              <1> BIT17 EQU 20000h
    37                              <1> BIT18 EQU 40000h
    38                              <1> BIT19 EQU 80000h
    39                              <1> BIT20 EQU 100000h
    40                              <1> BIT21 EQU 200000h
    41                              <1> BIT22 EQU 400000h
    42                              <1> BIT23 EQU 800000h
    43                              <1> BIT24 EQU 1000000h
    44                              <1> BIT25 EQU 2000000h
    45                              <1> BIT26 EQU 4000000h
    46                              <1> BIT27 EQU 8000000h
    47                              <1> BIT28 EQU 10000000h
    48                              <1> BIT29 EQU 20000000h
    49                              <1> BIT30 EQU 40000000h
    50                              <1> BIT31 EQU 80000000h
    51                              <1> 
    52                              <1> ;special characters
    53                              <1> NUL     EQU 0
    54                              <1> NULL    EQU 0
    55                              <1> BELL    EQU 07
    56                              <1> BS      EQU 08
    57                              <1> TAB     EQU 09
    58                              <1> LF      EQU 10
    59                              <1> CR      EQU 13
    60                              <1> ESCAPE  EQU 27           ;ESC is a reserved word....
    61                              <1> 
    62                              <1> 
    63                              <1> ;file stuff
    64                              <1> READONLY  EQU   BIT0
    65                              <1> HIDDEN    EQU   BIT1
    66                              <1> SYSTEM    EQU   BIT2
    67                              <1> VOLUME    EQU   BIT3         ;ignored for file access
    68                              <1> DIRECTORY EQU   BIT4         ;must be 0 for file access
    69                              <1> ARCHIVE   EQU   BIT5
    70                              <1> SHAREABLE EQU   BIT7         ;for novell networks
    71                              <1> OPEN	EQU	2		; open existing file
    72                              <1> CREATE	EQU	1		; create new file
    73                              <1> 
    74                              <1> 
    75                              <1> ; PCI equates
    76                              <1> ; PCI function address (PFA)
    77                              <1> ; bit 31 = 1
    78                              <1> ; bit 23:16 = bus number     (0-255)
    79                              <1> ; bit 15:11 = device number  (0-31)
    80                              <1> ; bit 10:8 = function number (0-7)
    81                              <1> ; bit 7:0 = register number  (0-255)
    82                              <1> 
    83                              <1> IO_ADDR_MASK    EQU     0FFFEh          ; mask off bit 0 for reading BARs
    84                              <1> PCI_INDEX_PORT  EQU     0CF8h
    85                              <1> PCI_DATA_PORT   EQU     0CFCh
    86                              <1> PCI32           EQU     BIT31           ; bitflag to signal 32bit access
    87                              <1> PCI16           EQU     BIT30           ; bitflag for 16bit access
    88                              <1> 
    89                              <1> PCI_FN0         EQU     0 << 8
    90                              <1> PCI_FN1         EQU     1 << 8
    91                              <1> PCI_FN2         EQU     2 << 8
    92                              <1> PCI_FN3         EQU     3 << 8
    93                              <1> PCI_FN4         EQU     4 << 8
    94                              <1> PCI_FN5         EQU     5 << 8
    95                              <1> PCI_FN6         EQU     6 << 8
    96                              <1> PCI_FN7         EQU     7 << 8
    97                              <1> 
    98                              <1> PCI_CMD_REG		EQU	04h		; reg 04, command reg
    99                              <1>  IO_ENA			EQU	BIT0		; i/o decode enable
   100                              <1>  MEM_ENA		EQU	BIT1		; memory decode enable
   101                              <1>  BM_ENA                 EQU     BIT2		; bus master enable
   102                              <1> 
   103                              <1> ; ----------------------------------------------------------------------------
   104                              <1> ; CODEC.INC
   105                              <1> ; ----------------------------------------------------------------------------
   106                              <1> 
   107                              <1> ;Codec registers.
   108                              <1> ;
   109                              <1> ;Not all codecs are created equal. Refer to the spec for your specific codec.
   110                              <1> ;
   111                              <1> ;All registers are 16bits wide.  Access to codec registers over the AC97 link
   112                              <1> ;is defined by the OEM.  
   113                              <1> ;
   114                              <1> ;Secondary codec's are accessed by ORing in BIT7 of all register accesses.
   115                              <1> ;
   116                              <1> 
   117                              <1> ; each codec/mixer register is 16bits
   118                              <1> 
   119                              <1> CODEC_RESET_REG                 equ     00      ; reset codec
   120                              <1> CODEC_MASTER_VOL_REG            equ     02      ; master volume
   121                              <1> CODEC_HP_VOL_REG                equ     04      ; headphone volume
   122                              <1> CODEC_MASTER_MONO_VOL_REG       equ     06      ; master mono volume
   123                              <1> CODEC_MASTER_TONE_REG           equ     08      ; master tone (R+L)
   124                              <1> CODEC_PCBEEP_VOL_REG            equ     0ah     ; PC beep volume
   125                              <1> CODEC_PHONE_VOL_REG             equ     0bh     ; phone volume
   126                              <1> CODEC_MIC_VOL_REG               equ     0eh     ; MIC volume
   127                              <1> CODEC_LINE_IN_VOL_REG           equ     10h     ; line input volume
   128                              <1> CODEC_CD_VOL_REG                equ     12h     ; CD volume
   129                              <1> CODEC_VID_VOL_REG               equ     14h     ; video volume
   130                              <1> CODEC_AUX_VOL_REG               equ     16h     ; aux volume
   131                              <1> CODEC_PCM_OUT_REG               equ     18h     ; PCM output volume
   132                              <1> CODEC_RECORD_SELECT_REG         equ     1ah     ; record select input
   133                              <1> CODEC_RECORD_VOL_REG            equ     1ch     ; record volume
   134                              <1> CODEC_RECORD_MIC_VOL_REG        equ     1eh     ; record mic volume
   135                              <1> CODEC_GP_REG                    equ     20h     ; general purpose
   136                              <1> CODEC_3D_CONTROL_REG            equ     22h     ; 3D control
   137                              <1> ; 24h is reserved
   138                              <1> CODEC_POWER_CTRL_REG            equ     26h     ; powerdown control
   139                              <1> CODEC_EXT_AUDIO_REG             equ     28h     ; extended audio
   140                              <1> CODEC_EXT_AUDIO_CTRL_REG        equ     2ah     ; extended audio control
   141                              <1> CODEC_PCM_FRONT_DACRATE_REG     equ     2ch     ; PCM out sample rate
   142                              <1> CODEC_PCM_SURND_DACRATE_REG     equ     2eh     ; surround sound sample rate
   143                              <1> CODEC_PCM_LFE_DACRATE_REG       equ     30h     ; LFE sample rate
   144                              <1> CODEC_LR_ADCRATE_REG            equ     32h     ; PCM in sample rate
   145                              <1> CODEC_MIC_ADCRATE_REG           equ     34h     ; mic in sample rate
   146                              <1> 
   147                              <1> ; registers 36-7a are reserved on the ICH
   148                              <1> 
   149                              <1> CODEC_VENDORID1_REG             equ     7ch     ; codec vendor ID 1
   150                              <1> CODEC_VENDORID2_REG             equ     7eh     ; codec vendor ID 2
   151                              <1> 
   152                              <1> ; Mixer registers 0 through 51h reside in the ICH and are not forwarded over
   153                              <1> ; the AC97 link to the codec, which I think is a little weird.  Looks like
   154                              <1> ; the ICH makes it so you don't need a fully functional codec to play audio?
   155                              <1> ;
   156                              <1> ; whenever 2 codecs are present in the system, use BIT7 to access the 2nd
   157                              <1> ; set of registers, ie 80h-feh
   158                              <1> 
   159                              <1> PRIMARY_CODEC                   equ     0       ; 0-7F for primary codec
   160                              <1> SECONDARY_CODEC                 equ     BIT7    ; 80-8f registers for 2ndary
   161                              <1> 
   162                              <1> SAMPLE_RATE_441khz	equ     44100   ; 44.1Khz (cd quality) rate
   163                              <1> 
   164                              <1> ; ----------------------------------------------------------------------------
   165                              <1> ; 17/02/2017
   166                              <1> PCI_IO_BASE	equ 10h			; = NAMBAR register offset
   167                              <1> AC97_INT_LINE   equ 3Ch			; AC97 Interrupt Line register offset
   168                              <1> 
   169                              <1> ; ----------------------------------------------------------------------------
   170                              <1> ; ICH2AC97.INC
   171                              <1> ; ----------------------------------------------------------------------------
   172                              <1> 
   173                              <1> ; PCI stuff
   174                              <1> 
   175                              <1> ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
   176                              <1> 
   177                              <1> INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
   178                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   179                              <1> SIS_VID		equ	1039h
   180                              <1> NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
   181                              <1> AMD_VID		equ	1022h
   182                              <1> 
   183                              <1> ICH_DID         equ     2415h           ; ICH device ID
   184                              <1> ICH0_DID        equ     2425h           ; ICH0
   185                              <1> ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
   186                              <1>                                         ; they all should be compatible.
   187                              <1> 
   188                              <1> ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
   189                              <1> ICH3_DID	equ     2485h           ; ICH3
   190                              <1> ICH4_DID        equ     24C5h           ; ICH4
   191                              <1> ICH5_DID	equ     24D5h           ; ICH5 
   192                              <1> ICH6_DID	equ     266Eh           ; ICH6
   193                              <1> ESB6300_DID	equ     25A6h           ; 6300ESB
   194                              <1> ESB631X_DID	equ     2698h           ; 631XESB
   195                              <1> ICH7_DID	equ	27DEh		; ICH7
   196                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   197                              <1> MX82440_DID	equ	7195h
   198                              <1> SI7012_DID	equ	7012h
   199                              <1> NFORCE_DID	equ	01B1h
   200                              <1> NFORCE2_DID	equ	006Ah
   201                              <1> AMD8111_DID	equ	746Dh
   202                              <1> AMD768_DID	equ	7445h
   203                              <1> ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
   204                              <1> CK804_DID	equ	0059h
   205                              <1> MCP04_DID	equ	003Ah
   206                              <1> CK8_DID		equ	008Ah
   207                              <1> NFORCE3_DID	equ	00DAh
   208                              <1> CK8S_DID	equ	00EAh
   209                              <1> 
   210                              <1> NAMBAR_REG      equ     10h             ; native audio mixer BAR
   211                              <1>  NAM_SIZE       equ     256             ; 256 bytes required.
   212                              <1> 
   213                              <1> NABMBAR_REG     equ     14h             ; native audio bus mastering BAR
   214                              <1>  NABM_SIZE      equ     64              ; 64 bytes
   215                              <1> 
   216                              <1> ; BUS master registers, accessed via NABMBAR+offset
   217                              <1> 
   218                              <1> ; ICH supports 3 different types of register sets for three types of things
   219                              <1> ; it can do, thus:
   220                              <1> ;
   221                              <1> ; PCM in (for recording) aka PI
   222                              <1> ; PCM out (for playback) aka PO
   223                              <1> ; MIC in (for recording) aka MC
   224                              <1> 
   225                              <1> PI_BDBAR_REG            equ     0       ; PCM in buffer descriptor BAR
   226                              <1> PO_BDBAR_REG            equ     10h     ; PCM out buffer descriptor BAR
   227                              <1> MC_BDBAR_REG            equ     20h     ; MIC in buffer descriptor BAR
   228                              <1> 
   229                              <1> ; each buffer descriptor BAR holds a pointer which has entries to the buffer
   230                              <1> ; contents of the .WAV file we're going to play. Each entry is 8 bytes long
   231                              <1> ; (more on that later) and can contain 32 entries total, so each BAR is
   232                              <1> ; 256 bytes in length, thus:
   233                              <1> 
   234                              <1> BDL_SIZE                equ     32*8    ; Buffer Descriptor List size
   235                              <1> INDEX_MASK              equ     31      ; indexes must be 0-31
   236                              <1> 
   237                              <1> 
   238                              <1> 
   239                              <1> PI_CIV_REG              equ     4       ; PCM in current Index value (RO)
   240                              <1> PO_CIV_REG              equ     14h     ; PCM out current Index value (RO)
   241                              <1> MC_CIV_REG              equ     24h     ; MIC in current Index value (RO)
   242                              <1> ;8bit read only
   243                              <1> ; each current index value is simply a pointer showing us which buffer
   244                              <1> ; (0-31) the codec is currently processing. Once this counter hits 31, it
   245                              <1> ; wraps back to 0.
   246                              <1> ; this can be handy to know, as once it hits 31, we're almost out of data to
   247                              <1> ; play back or room to record!
   248                              <1> 
   249                              <1> 
   250                              <1> PI_LVI_REG              equ     5       ; PCM in Last Valid Index
   251                              <1> PO_LVI_REG              equ     15h     ; PCM out Last Valid Index
   252                              <1> MC_LVI_REG              equ     25h     ; MIC in Last Valid Index
   253                              <1> ;8bit read/write
   254                              <1> ; The Last Valid Index is a number (0-31) to let the codec know what buffer
   255                              <1> ; number to stop on after processing. It could be very nasty to play audio
   256                              <1> ; from buffers that aren't filled with the audio we want to play.
   257                              <1> 
   258                              <1> 
   259                              <1> PI_SR_REG               equ     6       ; PCM in Status register
   260                              <1> PO_SR_REG               equ     16h     ; PCM out Status register
   261                              <1> MC_SR_REG               equ     26h     ; MIC in Status register
   262                              <1> ;16bit read/write
   263                              <1> ; status registers.  Bitfields follow:
   264                              <1> 
   265                              <1> FIFO_ERR                equ     BIT4    ; FIFO Over/Underrun W1TC.
   266                              <1> 
   267                              <1> BCIS                    equ     BIT3    ; buffer completion interrupt status.
   268                              <1>                                         ; Set whenever the last sample in ANY
   269                              <1>                                         ; buffer is finished.  Bit is only
   270                              <1>                                         ; set when the Interrupt on Complete
   271                              <1>                                         ; (BIT4 of control reg) is set.
   272                              <1> 
   273                              <1> LVBCI                   equ     BIT2    ; Set whenever the codec has processed
   274                              <1>                                         ; the last buffer in the buffer list.
   275                              <1>                                         ; Will fire an interrupt if IOC bit is
   276                              <1>                                         ; set. Probably set after the last
   277                              <1>                                         ; sample in the last buffer is
   278                              <1>                                         ; processed.  W1TC
   279                              <1> 
   280                              <1>                                         ; 
   281                              <1> CELV                    equ     BIT1    ; Current buffer == last valid.
   282                              <1>                                         ; Bit is RO and remains set until LVI is
   283                              <1>                                         ; cleared.  Probably set up the start
   284                              <1>                                         ; of processing for the last buffer.
   285                              <1> 
   286                              <1> 
   287                              <1> DCH                     equ     BIT0    ; DMA controller halted.
   288                              <1>                                         ; set whenever audio stream is stopped
   289                              <1>                                         ; or something else goes wrong.
   290                              <1> 
   291                              <1> 
   292                              <1> PI_PICB_REG             equ     8       ; PCM in position in current buffer(RO)
   293                              <1> PO_PICB_REG             equ     18h     ; PCM out position in current buffer(RO)
   294                              <1> MC_PICB_REG             equ     28h     ; MIC in position in current buffer (RO)
   295                              <1> ;16bit read only
   296                              <1> ; position in current buffer regs show the number of dwords left to be
   297                              <1> ; processed in the current buffer.
   298                              <1> ; 
   299                              <1> 
   300                              <1> PI_PIV_REG              equ     0ah     ; PCM in Prefected index value
   301                              <1> PO_PIV_REG              equ     1ah     ; PCM out Prefected index value
   302                              <1> MC_PIV_REG              equ     2ah     ; MIC in Prefected index value
   303                              <1> ;8bit, read only
   304                              <1> ; Prefetched index value register.
   305                              <1> ; tells which buffer number (0-31) has be prefetched. I'd imagine this
   306                              <1> ; value follows the current index value fairly closely. (CIV+1)
   307                              <1> ;
   308                              <1> 
   309                              <1> 
   310                              <1> PI_CR_REG               equ     0bh     ; PCM in Control Register
   311                              <1> PO_CR_REG               equ     1bh     ; PCM out Control Register
   312                              <1> MC_CR_REG               equ     2bh     ; MIC in Control Register
   313                              <1> ; 8bit
   314                              <1> ; Control register *MUST* only be accessed as an 8bit value.
   315                              <1> ; Control register. See bitfields below.
   316                              <1> ;
   317                              <1> 
   318                              <1> 
   319                              <1> IOCE                    equ     BIT4    ; interrupt on complete enable.
   320                              <1>                                         ; set this bit if you want an intrtpt
   321                              <1>                                         ; to fire whenever LVBCI is set.
   322                              <1> FEIFE                   equ     BIT3    ; set if you want an interrupt to fire
   323                              <1>                                         ; whenever there is a FIFO (over or
   324                              <1>                                         ; under) error.
   325                              <1> LVBIE                   equ     BIT2    ; last valid buffer interrupt enable.
   326                              <1>                                         ; set if you want an interrupt to fire
   327                              <1>                                         ; whenever the completion of the last
   328                              <1>                                         ; valid buffer.
   329                              <1> RR                      equ     BIT1    ; reset registers.  Nukes all regs
   330                              <1>                                         ; except bits 4:2 of this register.
   331                              <1>                                         ; Only set this bit if BIT 0 is 0
   332                              <1> RPBM                    equ     BIT0    ; Run/Pause
   333                              <1>                                         ; set this bit to start the codec!
   334                              <1> 
   335                              <1> 
   336                              <1> GLOB_CNT_REG            equ     2ch     ; Global control register
   337                              <1> SEC_RES_EN              equ     BIT5    ; secondary codec resume event 
   338                              <1>                                         ; interrupt enable.  Not used here.
   339                              <1> PRI_RES_EN              equ     BIT4    ; ditto for primary. Not used here.
   340                              <1> ACLINK_OFF              equ     BIT3    ; Turn off the AC97 link
   341                              <1> ACWARM_RESET            equ     BIT2    ; Awaken the AC97 link from sleep.
   342                              <1>                                         ; registers preserved, bit self clears
   343                              <1> ACCOLD_RESET            equ     BIT1    ; Reset everything in the AC97 and
   344                              <1>                                         ; reset all registers.  Not self clearing
   345                              <1> 
   346                              <1> GPIIE                   equ     BIT0    ; GPI Interrupt enable.
   347                              <1>                                         ; set if you want an interrupt to
   348                              <1>                                         ; fire upon ANY of the bits in the
   349                              <1>                                         ; GPI (general pursose inputs?) not used.
   350                              <1> 
   351                              <1> GLOB_STS_REG            equ     30h     ; Global Status register (RO)
   352                              <1> 
   353                              <1> MD3                     equ     BIT17   ; modem powerdown status (yawn)
   354                              <1> AD3                     equ     BIT16   ; Audio powerdown status (yawn)
   355                              <1> RD_COMPLETE_STS         equ     BIT15   ; Codec read timed out. 0=normal
   356                              <1> BIT3SLOT12              equ     BIT14   ; shadowed status of bit 3 in slot 12
   357                              <1> BIT2SLOT12              equ     BIT13   ; shadowed status of bit 2 in slot 12
   358                              <1> BIT1SLOT12              equ     BIT12   ; shadowed status of bit 1 in slot 12
   359                              <1> SEC_RESUME_STS          equ     BIT11   ; secondary codec has resumed (and irqed)
   360                              <1> PRI_RESUME_STS          equ     BIT10   ; primary codec has resumed (and irqed)
   361                              <1> SEC_CODEC_RDY           equ     BIT9    ; secondary codec is ready for action
   362                              <1> PRI_CODEC_RDY           equ     BIT8    ; Primary codec is ready for action
   363                              <1>                                         ; software must check these bits before
   364                              <1>                                         ; starting the codec!
   365                              <1> MIC_IN_IRQ              equ     BIT7    ; MIC in caused an interrupt
   366                              <1> PCM_OUT_IRQ             equ     BIT6    ; One of the PCM out channels IRQed
   367                              <1> PCM_IN_IRQ              equ     BIT5    ; One of the PCM in channels IRQed
   368                              <1> MODEM_OUT_IRQ           equ     BIT2    ; modem out channel IRQed
   369                              <1> MODEM_IN_IRQ            equ     BIT1    ; modem in channel IRQed
   370                              <1> GPI_STS_CHANGE          equ     BIT0    ; set whenever GPI's have changed.
   371                              <1>                                         ; BIT0 of slot 12 also reflects this.
   372                              <1> 
   373                              <1> ACC_SEMA_REG            equ     34h     ; Codec write semiphore register
   374                              <1> CODEC_BUSY              equ     BIT0    ; codec register I/O is happening
   375                              <1>                                         ; self clearing
   376                              <1> ;
   377                              <1> ; Buffer Descriptors List
   378                              <1> ; As stated earlier, each buffer descriptor list is a set of (up to) 32 
   379                              <1> ; descriptors, each 8 bytes in length. Bytes 0-3 of a descriptor entry point
   380                              <1> ; to a chunk of memory to either play from or record to. Bytes 4-7 of an
   381                              <1> ; entry describe various control things detailed below.
   382                              <1> ; 
   383                              <1> ; Buffer pointers must always be aligned on a Dword boundry.
   384                              <1> ;
   385                              <1> 
   386                              <1> IOC                     equ     BIT31   ; Fire an interrupt whenever this
   387                              <1>                                         ; buffer is complete.
   388                              <1> 
   389                              <1> BUP                     equ     BIT30   ; Buffer Underrun Policy.
   390                              <1>                                         ; if this buffer is the last buffer
   391                              <1>                                         ; in a playback, fill the remaining
   392                              <1>                                         ; samples with 0 (silence) or not.
   393                              <1>                                         ; It's a good idea to set this to 1
   394                              <1>                                         ; for the last buffer in playback,
   395                              <1>                                         ; otherwise you're likely to get a lot
   396                              <1>                                         ; of noise at the end of the sound.
   397                              <1> 
   398                              <1> ;
   399                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   400                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   401                              <1> ; Luckily for us, that's the same format as .wav files.
   402                              <1> ;
   403                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   404                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   405                              <1> ;
   406                              <1> ; A value of 0 in these bits means play no samples.
   407                              <1> ;
   408                              <1> 
   409                              <1> ; 11/11/2023
   410                              <1> CTRL_ST_CREADY		equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
   411                              <1> CODEC_REG_POWERDOWN	equ	26h
    24                                  
    25                                  _STARTUP:
    26                                  
    27                                  ; memory allocation
    28                                  
    29 00000000 E85D01                          call    setFree				; deallocate unused DOS mem
    30                                  
    31                                  	; 17/02/2017
    32                                  	; Clear BSS (uninitialized data) area
    33 00000003 31C0                    	xor	ax, ax ; 0
    34 00000005 B92240                  	mov	cx, (EOF - bss_start)/2
    35 00000008 BF[8717]                	mov	di, bss_start
    36 0000000B F3AB                    	rep	stosw
    37                                  
    38                                  ; allocate 256 bytes of data for DCM_OUT Buffer Descriptor List. (BDL)
    39                                  
    40 0000000D B81000                          mov     ax, BDL_SIZE / 16
    41 00000010 E85501                          call    memAlloc
    42 00000013 A3[B417]                        mov     [BDL_BUFFER], ax		; segment 
    43                                  
    44                                  ; allocate 2 buffers, 64k each for now.
    45                                  
    46 00000016 B80010                          mov     ax, BUFFERSIZE / 16		; 64k for .WAV file
    47 00000019 E84C01                          call    memAlloc
    48 0000001C A3[B617]                        mov     [WAV_BUFFER1], ax		; segment
    49                                  
    50 0000001F B80010                  	mov	ax, BUFFERSIZE / 16
    51 00000022 E84301                  	call	memAlloc
    52 00000025 A3[B817]                	mov	[WAV_BUFFER2], ax
    53                                  
    54                                  ; Detect/reset AC97 
    55                                  
    56 00000028 E8B002                          call    pciFindDevice
    57 0000002B 7342                            jnc     short _1
    58                                  
    59                                  ; couldn't find the audio device!
    60                                  
    61 0000002D 0E                      	push	cs
    62 0000002E 1F                      	pop	ds
    63 0000002F BA[3900]                        mov     dx, noDevMsg
    64 00000032 B409                            mov     ah, 9
    65 00000034 CD21                            int     21h
    66 00000036 E91701                          jmp     exit
    67                                  
    68                                  ; 17/02/2017
    69 00000039 4572726F723A20556E-     noDevMsg: db "Error: Unable to find intel ICH based audio device!",CR,LF,"$"
    69 00000042 61626C6520746F2066-
    69 0000004B 696E6420696E74656C-
    69 00000054 204943482062617365-
    69 0000005D 6420617564696F2064-
    69 00000066 6576696365210D0A24 
    70                                  
    71                                  _1:
    72                                  	; eax = BUS/DEV/FN
    73                                  	;	00000000BBBBBBBBDDDDDFFF00000000
    74                                  	; edx = DEV/VENDOR
    75                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
    76                                  
    77 0000006F 66A3[BA17]              	mov	[bus_dev_fn], eax
    78 00000073 668916[BE17]            	mov	[dev_vendor], edx
    79                                  
    80                                  	; get ICH base address regs for mixer and bus master
    81                                  
    82 00000078 B010                            mov     al, NAMBAR_REG
    83 0000007A E8D001                          call    pciRegRead16			; read PCI registers 10-11
    84 0000007D 83E2FE                          and     dx, IO_ADDR_MASK 		; mask off BIT0
    85                                  
    86 00000080 8916[B017]                      mov     [NAMBAR], dx			; save audio mixer base addy
    87                                  
    88 00000084 B014                    	mov     al, NABMBAR_REG
    89 00000086 E8C401                          call    pciRegRead16
    90 00000089 83E2FE                          and     dx, IO_ADDR_MASK
    91                                  
    92 0000008C 8916[B217]                      mov     [NABMBAR], dx			; save bus master base addy
    93                                  
    94                                  	; 06/11/2023
    95                                  	;; init controller
    96                                  	;; 17/02/2017
    97                                  	;mov	al, PCI_CMD_REG ; command register (04h)
    98                                  	;call	pciRegRead16 ; pciRegRead8
    99                                  	;
   100                                  	;; eax = BUS/DEV/FN/REG
   101                                  	;;  dx = PCI Command Register Content ; 17/02/2017
   102                                  	;; 	00000000CCCCCCCC
   103                                  	;mov	[stats_cmd], dx
   104                                  	;
   105                                  	; 06/11/2023
   106                                  	;mov	al, PCI_IO_BASE ; IO base address register (10h)
   107                                  	;call	pciRegRead32
   108                                  	;
   109                                  	;and	dx, 0FFC0h	; IO_ADDR_MASK (0FFFE) ?
   110                                          ;mov	[ac97_io_base], dx
   111                                  
   112 00000090 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
   113 00000092 E8B001                  	call	pciRegRead8 ; 17/02/2017
   114                                  
   115 00000095 8816[A717]              	mov     [ac97_int_ln_reg], dl
   116                                  
   117                                  ; 09/11/2023
   118                                  ; 05/11/2023
   119                                  %if 1
   120                                  	; 28/11/2016
   121 00000099 BB0100                  	mov	bx, 1
   122 0000009C 30F6                    	xor	dh, dh 	 ; 17/02/2017
   123                                  	; 10/11/2023
   124                                  	;mov	cx, dx
   125                                  	;shl	bx, cl
   126                                  
   127                                  	; 04/11/2023
   128 0000009E FA                      	cli
   129                                  
   130                                  	;not	bx
   131 0000009F E4A1                    	in	al, 0A1h ; irq 8-15
   132 000000A1 88C4                            mov	ah, al
   133 000000A3 E421                            in	al, 21h  ; irq 0-7 
   134                                  
   135                                  	; 04/11/2023
   136                                  	; save IRQ status
   137 000000A5 A3[AA17]                	mov	[IRQ_status], ax
   138                                  
   139                                  	;and	ax, bx   ; unmask
   140 000000A8 0FB3D0                   	btr	ax, dx	 ; unmask
   141 000000AB E621                    	out	21h, al  ; enable interrupt (if irq <= 7)
   142 000000AD 88E0                    	mov	al, ah
   143 000000AF E6A1                    	out	0A1h, al ; enable interrupt (if irq > 7)
   144                                  	;not	bx
   145                                  
   146                                  	; 04/11/2023
   147                                  	;mov	dx, 4D1h			;8259 ELCR1
   148                                          ;in	al, dx
   149                                  	;mov	ah, al
   150                                  	;mov	dx, 4D0h 
   151                                          ;in	al, dx
   152                                  	;;or	ax, bx        
   153                                  	;bts	ax, cx
   154                                  	;mov	dx, 4D0h
   155                                  	;out	dx, al                          ;set level-triggered mode
   156                                  	;mov	al, ah
   157                                  	;mov	dx, 4D1h
   158                                  	;out	dx, al                          ;set level-triggered mode
   159                                  
   160                                  	; 24/11/2016 - Erdogan Tan
   161                                  	;mov	bx, cx
   162                                  	; 10/11/2023
   163 000000B1 89D3                    	mov	bx, dx
   164 000000B3 8A9F[D215]              	mov	bl, [bx+irq_int]
   165 000000B7 C1E302                  	shl	bx, 2 ; * 4
   166                                  
   167                                  	; set up interrupt vector
   168                                  	; 30/11/2016
   169 000000BA 06                      	push	es
   170 000000BB 31C0                    	xor	ax, ax
   171 000000BD 8EC0                    	mov	es, ax
   172                                  	; 04/11/2023
   173                                  	; save interrupt vector
   174 000000BF 268B07                  	mov	ax, [es:bx]
   175 000000C2 A3[AC17]                	mov	[IRQ_vector], ax
   176 000000C5 268B4702                	mov	ax, [es:bx+2]
   177 000000C9 A3[AE17]                	mov	[IRQ_vector+2], ax
   178                                  
   179 000000CC 26C707[2115]            	mov	word [es:bx], ac97_int_handler
   180 000000D1 8CC8                    	mov	ax, cs
   181 000000D3 26894702                	mov	[es:bx+2], ax
   182 000000D7 07                      	pop	es
   183                                  
   184                                  	; 04/11/2023
   185 000000D8 FB                      	sti
   186                                  
   187                                  %endif
   188 000000D9 E89212                  	call	write_ac97_dev_info 
   189                                  
   190                                  ; check the command line for a file to play
   191                                  
   192                                          ;push	ds
   193 000000DC E89200                          call    processCmdline			; get the filename
   194                                  
   195                                  ; open the file
   196 000000DF B002                            mov     al, OPEN                        ; open existing file
   197 000000E1 E8AD00                          call    openFile                        ; no error? ok.
   198                                          ;pop	ds
   199 000000E4 7322                            jnc     short _gsr
   200                                  
   201                                  ; file not found!
   202                                  
   203                                          ;push   cs
   204                                          ;pop    ds
   205 000000E6 BA[EF00]                        mov	dx, noFileErrMsg
   206 000000E9 B409                            mov     ah, 9
   207 000000EB CD21                            int     21h
   208 000000ED EB61                            jmp     exit
   209                                  
   210                                  noFileErrMsg:
   211 000000EF 4572726F723A206669-     	db "Error: file not found.",CR,LF,"$"
   211 000000F8 6C65206E6F7420666F-
   211 00000101 756E642E0D0A24     
   212                                  
   213                                  _gsr:
   214 00000108 E8AD00                          call    getSampleRate                   ; read the sample rate
   215                                                                                  ; pass it onto codec.
   216 0000010B 7243                    	jc	short exit ; 19/11/2016 - nothing to do
   217                                  
   218 0000010D A3[C217]                	mov	[sample_rate], ax
   219                                  	
   220                                  	; 19/11/2016
   221 00000110 880E[C417]              	mov	[stmo], cl
   222 00000114 8816[C617]              	mov	[bps], dl
   223                                  	
   224                                  	; 17/02/2017
   225 00000118 C606[C817]00            	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit 
   226 0000011D FEC9                    	dec	cl
   227 0000011F 7504                    	jnz	short _gsr_1 ; stereo
   228 00000121 FE06[C817]              	inc	byte [fbs_shift] ; 1 = mono or 8 bit		
   229                                  _gsr_1:	
   230 00000125 80FA08                  	cmp	dl, 8 
   231 00000128 7704                    	ja	short _gsr_2 ; 16 bit samples
   232 0000012A FE06[C817]              	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   233                                  _gsr_2:	
   234 0000012E E89F13                  	call	write_sample_rate
   235                                  
   236                                  	; 05/11/2023
   237                                  _2:
   238 00000131 E80807                  	call	check4keyboardstop  ; flush keyboard buffer
   239 00000134 72FB                    	jc	short _2 	; 07/11/2023
   240                                  
   241                                  	; 09/11/2023
   242                                  	;; 05/11/2023
   243                                  	;mov	eax, [bus_dev_fn]
   244                                  	;mov	al, PCI_CMD_REG
   245                                  	;call	pciRegRead16			; read PCI command register
   246                                  	;; 17/02/2017
   247                                  	;;mov	dx, [stats_cmd]
   248                                          ;or	dl, IO_ENA+BM_ENA               ; enable IO and bus master
   249                                  	;call	pciRegWrite16 ; pciRegWrite8
   250                                  
   251                                  	;; 06/11/2023
   252                                  	;;mov	eax, [bus_dev_fn]
   253                                  	;;mov	al, PCI_CMD_REG
   254                                  	;;call	pciRegRead8                     ; read PCI command register
   255                                  	;;or	dl, IO_ENA+BM_ENA               ; enable IO and bus master
   256                                  	;;call	pciRegWrite8
   257                                  
   258                                  ; setup the Codec (actually mixer registers) 
   259 00000136 E8E601                          call    codecConfig                     ; unmute codec, set rates.
   260                                  	; 11/11/2023
   261 00000139 721C                    	jc	short init_err
   262                                  ;
   263                                  ; position file pointer to start in actual wav data
   264                                  ; MUCH improvement should really be done here to check if sample size is
   265                                  ; supported, make sure there are 2 channels, etc.  
   266                                  ;
   267 0000013B B442                            mov     ah, 42h
   268 0000013D B000                            mov     al, 0                           ; from start of file
   269 0000013F 8B1E[A417]                      mov     bx, [filehandle]
   270 00000143 31C9                            xor     cx, cx
   271 00000145 BA2C00                          mov     dx, 44                          ; jump past .wav/riff header
   272 00000148 CD21                            int     21h
   273                                  
   274                                  ; play the .wav file. Most of the good stuff is in here.
   275                                  
   276 0000014A E84203                          call    playWav
   277                                  
   278                                  ; close the .wav file and exit.
   279                                  
   280                                  close_exit:			; 11/11/2023
   281 0000014D E85300                          call    closeFile
   282                                  
   283                                  exit:
   284 00000150 B8004C                          mov     ax, 4c00h
   285 00000153 CD21                    	int 	21h
   286                                  
   287                                  here:
   288 00000155 EBFE                    	jmp	short here
   289                                  
   290                                  	; 11/11/2023
   291                                  init_err:
   292 00000157 BA[1D17]                	mov	dx, msg_init_err
   293                                  vra_err: ; 12/11/2023
   294 0000015A B409                            mov	ah, 9
   295 0000015C CD21                            int	21h
   296 0000015E EBED                    	jmp	short close_exit
   297                                  
   298                                  ; MEMALLOC.ASM
   299                                  ;-- SETFREE: Release memory not used  ----------------
   300                                  ;-- Input    : ES = address of PSP
   301                                  ;-- Output   : none
   302                                  ;-- Register : AX, BX, CL and FLAGS are changed 
   303                                  ;-- Info     : Since the stack-segment is always the last segment in an 
   304                                  ;              EXE-file, ES:0000 points to the beginning and SS:SP
   305                                  ;              to the end of the program in memory. Through this the
   306                                  ;              length of the program can be calculated 
   307                                  ; call this routine once at the beginning of the program to free up memory
   308                                  ; assigned to it by DOS.
   309                                  
   310                                  setFree:
   311 00000160 BB0010                  	  mov	bx, 65536/16	; 4K paragraphs ; 17/02/2017 (Erdogan Tan)		
   312                                  
   313 00000163 B44A                              mov	ah, 4ah		; pass new length to DOS
   314 00000165 CD21                              int	21h
   315                                  
   316 00000167 C3                                retn			; back to caller 
   317                                  				; new size (allocated memory) = 64KB
   318                                  
   319                                  memAlloc:
   320                                  ; input: AX = # of paragraphs required
   321                                  ; output: AX = segment of block to use
   322                                  
   323 00000168 53                      	push	bx
   324 00000169 89C3                    	mov	bx, ax
   325 0000016B B448                    	mov	ah, 48h
   326 0000016D CD21                    	int	21h
   327 0000016F 5B                      	pop	bx
   328 00000170 C3                      	retn
   329                                  
   330                                  ; CMDLINE.ASM
   331                                  ; parse the command line
   332                                  ; entry: none
   333                                  ; exit: DS:DX to the 1st supplied item on the command line 
   334                                  
   335                                  processCmdline:
   336 00000171 53                              push    bx
   337 00000172 56                              push    si
   338                                  
   339                                          ;mov    ah, 51h
   340                                          ;int    21h
   341                                          ;mov    ds, bx
   342                                  
   343 00000173 BE8000                          mov     si, 80h
   344 00000176 0FB61C                          movzx   bx, byte [si]
   345 00000179 01DE                            add     si, bx
   346 0000017B 46                              inc     si
   347                                  
   348 0000017C C60400                          mov     byte [si], NULL         ; zero terminate
   349                                  
   350 0000017F BE8100                          mov     si, 81h
   351                                  
   352                                  cmdlineloop:
   353 00000182 AC                              lodsb
   354                                  
   355 00000183 3C00                            cmp     al, NULL                ; found end of line?
   356 00000185 7404                            je      short exitpc
   357 00000187 3C20                            cmp     al, ' '                 ; found a space?
   358 00000189 74F7                            je      short cmdlineloop
   359                                  
   360                                          ; must be the filename here.
   361                                  exitpc:
   362 0000018B 4E                              dec     si                      ; point to start of filename
   363 0000018C 89F2                            mov     dx, si
   364 0000018E 5E                              pop     si
   365 0000018F 5B                              pop     bx
   366 00000190 C3                      	retn
   367                                  
   368                                  ; FILE.ASM
   369                                  ;open or create file
   370                                  ;
   371                                  ;input: ds:dx-->filename (asciiz)
   372                                  ;       al=file Mode (create or open)
   373                                  ;output: none  cs:[filehandle] filled
   374                                  ;
   375                                  openFile:
   376 00000191 50                      	push	ax
   377 00000192 51                      	push	cx
   378 00000193 B43B                    	mov	ah, 3bh			; start with a mode
   379 00000195 00C4                    	add	ah, al			; add in create or open mode
   380 00000197 31C9                    	xor	cx, cx
   381 00000199 CD21                    	int	21h
   382 0000019B 7203                    	jc	short _of1
   383                                  	;mov	[cs:filehandle], ax
   384 0000019D A3[A417]                	mov	[filehandle], ax
   385                                  _of1:
   386 000001A0 59                      	pop	cx
   387 000001A1 58                      	pop	ax
   388 000001A2 C3                      	retn
   389                                  
   390                                  ; close the currently open file
   391                                  ; input: none, uses cs:[filehandle]
   392                                  closeFile:
   393 000001A3 50                      	push	ax
   394 000001A4 53                      	push	bx
   395 000001A5 833E[A417]FF            	cmp	word [filehandle], -1
   396 000001AA 7409                    	jz	short _cf1
   397 000001AC 8B1E[A417]              	mov     bx, [filehandle]  
   398 000001B0 B8003E                  	mov     ax,3e00h
   399 000001B3 CD21                            int     21h              ;close file
   400                                  _cf1:
   401 000001B5 5B                      	pop	bx
   402 000001B6 58                      	pop	ax
   403 000001B7 C3                      	retn
   404                                  
   405                                  getSampleRate:
   406                                  	; 08/12/2016
   407                                  ; reads the sample rate from the .wav file.
   408                                  ; entry: none - assumes file is already open
   409                                  	; 19/11/2016 - Erdogan Tan
   410                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   411                                  ;	cx = number of channels (mono=1, stereo=2)
   412                                  ;	dx = bits per sample (8, 16)
   413                                  
   414 000001B8 53                      	push    bx
   415                                  
   416 000001B9 B442                            mov     ah, 42h
   417 000001BB B000                            mov     al, 0				; from start of file
   418 000001BD 8B1E[A417]                      mov     bx, [filehandle]
   419 000001C1 31C9                            xor     cx, cx
   420 000001C3 BA0800                          mov     dx, 08h				; "WAVE"
   421 000001C6 CD21                            int     21h
   422                                  
   423 000001C8 BA[8817]                        mov     dx, smpRBuff
   424 000001CB B91C00                          mov     cx, 28				; 28 bytes
   425 000001CE B43F                    	mov	ah, 3fh
   426 000001D0 CD21                            int     21h
   427                                  
   428 000001D2 813E[8817]5741          	cmp	word [smpRBuff], 'WA'
   429 000001D8 751C                    	jne	short gsr_stc
   430                                  
   431 000001DA 813E[8A17]5645          	cmp	word [smpRBuff+2], 'VE'
   432 000001E0 7514                    	jne	short gsr_stc
   433                                  
   434 000001E2 833E[9417]01            	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   435 000001E7 750D                    	jne	short gsr_stc
   436                                  
   437                                  
   438 000001E9 8B0E[9617]              	mov	cx, [smpRBuff+14]	; return num of channels in CX
   439 000001ED A1[9817]                        mov     ax, [smpRBuff+16]	; return sample rate in AX
   440 000001F0 8B16[A217]              	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   441                                  gsr_retn:
   442 000001F4 5B                              pop     bx
   443 000001F5 C3                              retn
   444                                  
   445                                  gsr_stc:
   446 000001F6 F9                      	stc
   447 000001F7 EBFB                    	jmp	short gsr_retn
   448                                  
   449                                  ;%include 'ac97.asm' ; 29/11/2016 (AC97 codec configuration)
   450                                  %include 'ac97_vra.asm' ; 13/11/2023 (AC97 codec configuration)
     1                              <1> ; 15/11/2023
     2                              <1> ; 13/11/2023
     3                              <1> ; 12/11/2023
     4                              <1> ; 11/11/2023
     5                              <1> ; 03/11/2023 - 06/11/2023
     6                              <1> ; PCI and AC97 codec functions for wav player
     7                              <1> ; Erdogan Tan (17/02/2017)
     8                              <1> 
     9                              <1> ; ----------------------------------------------------------------------------
    10                              <1> ; PCI.ASM
    11                              <1> ; ----------------------------------------------------------------------------
    12                              <1> 
    13                              <1> ; PCI device register reader/writers.
    14                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    15                              <1> ; 		Last Update: 17/02/2017
    16                              <1> 
    17                              <1> ;===============================================================
    18                              <1> ; 8/16/32bit PCI reader
    19                              <1> ;
    20                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    21                              <1> ;           BIT30 set if 32 bit access requested
    22                              <1> ;           BIT29 set if 16 bit access requested
    23                              <1> ;           otherwise defaults to 8 bit read
    24                              <1> ;
    25                              <1> ; Exit:  DL,DX,EDX register data depending on requested read size
    26                              <1> ;
    27                              <1> ; Note: this routine is meant to be called via pciRegRead8, pciRegread16,
    28                              <1> ;	or pciRegRead32, listed below.
    29                              <1> ;
    30                              <1> ; Note2: don't attempt to read 32bits of data from a non dword aligned reg
    31                              <1> ;	 number. Likewise, don't do 16bit reads from non word aligned reg #
    32                              <1> ; 
    33                              <1> pciRegRead:
    34 000001F9 6653                <1> 	push	ebx
    35 000001FB 51                  <1> 	push	cx
    36 000001FC 6689C3              <1>         mov     ebx, eax                        ; save eax, dh
    37 000001FF 88F1                <1>         mov     cl, dh
    38 00000201 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    39 00000207 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
    40 0000020D 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
    41                              <1> 
    42 0000020F BAF80C              <1>         mov     dx, PCI_INDEX_PORT
    43 00000212 66EF                <1>         out     dx, eax                         ; write PCI selector
    44                              <1> 
    45 00000214 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
    46 00000217 88D8                <1>         mov     al, bl
    47 00000219 2403                <1>         and     al, 3                           ; figure out which port to
    48 0000021B 00C2                <1>         add     dl, al                          ; read to
    49                              <1> 
    50 0000021D 66ED                <1> 	in      eax, dx                         ; do 32bit read
    51 0000021F 66F7C300000080      <1>         test    ebx, PCI32
    52 00000226 7403                <1>         jz      short _pregr1
    53                              <1> 
    54 00000228 6689C2              <1>         mov     edx, eax                        ; return 32bits of data
    55                              <1> _pregr1:
    56 0000022B 89C2                <1> 	mov     dx, ax                          ; return 16bits of data
    57 0000022D 66F7C3000000C0      <1>         test    ebx, PCI32+PCI16
    58 00000234 7502                <1>         jnz     short _pregr2
    59 00000236 88CE                <1>         mov     dh, cl                          ; restore dh for 8 bit read
    60                              <1> _pregr2:
    61 00000238 6689D8              <1>         mov     eax, ebx                        ; restore eax
    62 0000023B 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    63 00000241 59                  <1> 	pop	cx
    64 00000242 665B                <1> 	pop	ebx
    65 00000244 C3                  <1> 	retn
    66                              <1> 
    67                              <1> pciRegRead8:
    68 00000245 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32             ; set up 8 bit read size
    69 0000024B EBAC                <1>         jmp     short pciRegRead		; call generic PCI access
    70                              <1> 
    71                              <1> pciRegRead16:
    72 0000024D 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit read size
    73 00000253 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
    74 00000259 EB9E                <1>         jmp     short pciRegRead
    75                              <1> 
    76                              <1> pciRegRead32:
    77 0000025B 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit read size
    78 00000261 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
    79 00000267 EB90                <1>         jmp     short pciRegRead
    80                              <1> 
    81                              <1> ;===============================================================
    82                              <1> ; 8/16/32bit PCI writer
    83                              <1> ;
    84                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    85                              <1> ;           BIT31 set if 32 bit access requested
    86                              <1> ;           BIT30 set if 16 bit access requested
    87                              <1> ;           otherwise defaults to 8bit read
    88                              <1> ;        DL/DX/EDX data to write depending on size
    89                              <1> ;
    90                              <1> ;
    91                              <1> ; note: this routine is meant to be called via pciRegWrite8, pciRegWrite16,
    92                              <1> ; 	or pciRegWrite32 as detailed below.
    93                              <1> ;
    94                              <1> ; Note2: don't attempt to write 32bits of data from a non dword aligned reg
    95                              <1> ;	 number. Likewise, don't do 16bit writes from non word aligned reg #
    96                              <1> ;
    97                              <1> pciRegWrite:
    98 00000269 6653                <1> 	push	ebx
    99 0000026B 51                  <1> 	push	cx
   100 0000026C 6689C3              <1>         mov     ebx, eax                        ; save eax, dx
   101 0000026F 89D1                <1>         mov     cx, dx
   102 00000271 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
   103 00000277 6625FFFFFFBF        <1>         and     eax, ~PCI16 ; NOT PCI16         ; clear out data size request
   104 0000027D 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
   105                              <1> 
   106 0000027F BAF80C              <1>         mov     dx, PCI_INDEX_PORT
   107 00000282 66EF                <1>         out     dx, eax                         ; write PCI selector
   108                              <1> 
   109 00000284 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
   110 00000287 88D8                <1>         mov     al, bl
   111 00000289 2403                <1>         and     al, 3                           ; figure out which port to
   112 0000028B 00C2                <1>         add     dl, al                          ; write to
   113                              <1> 
   114 0000028D 6689D0              <1>         mov     eax, edx                        ; put data into eax
   115 00000290 89C8                <1>         mov     ax, cx
   116                              <1> 
   117 00000292 EE                  <1>         out     dx, al
   118 00000293 66F7C3000000C0      <1>         test    ebx, PCI16+PCI32                ; only 8bit access? bail
   119 0000029A 740C                <1>         jz      short _pregw1
   120                              <1> 
   121 0000029C EF                  <1>         out     dx, ax                          ; write 16 bit value
   122 0000029D 66F7C300000040      <1>         test    ebx, PCI16                      ; 16bit requested?  bail
   123 000002A4 7502                <1>         jnz     short _pregw1
   124                              <1> 
   125 000002A6 66EF                <1>         out     dx, eax                         ; write full 32bit
   126                              <1> _pregw1:
   127 000002A8 6689D8              <1>         mov     eax, ebx                        ; restore eax
   128 000002AB 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
   129 000002B1 89CA                <1>         mov     dx, cx                          ; restore dx
   130 000002B3 59                  <1> 	pop	cx
   131 000002B4 665B                <1> 	pop	ebx
   132 000002B6 C3                  <1> 	ret
   133                              <1> 
   134                              <1> pciRegWrite8:
   135 000002B7 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 8 bit write size
   136 000002BD EBAA                <1>         jmp     short pciRegWrite		; call generic PCI access
   137                              <1> 
   138                              <1> pciRegWrite16:
   139 000002BF 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit write size
   140 000002C5 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
   141 000002CB EB9C                <1>         jmp     short pciRegWrite
   142                              <1> 
   143                              <1> pciRegWrite32:
   144 000002CD 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit write size
   145 000002D3 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
   146 000002D9 EB8E                <1>         jmp     short pciRegWrite
   147                              <1> 
   148                              <1> ; 17/02/2017 (Modifed by Erdogan Tan for various ICH device IDs)
   149                              <1> ;===============================================================
   150                              <1> ; PCIFindDevice: scan through PCI space looking for a device+vendor ID
   151                              <1> ;
   152                              <1> ;  ENTRY: none
   153                              <1> ;; Entry: EAX=Device+Vendor ID
   154                              <1> ;
   155                              <1> ;  Exit: EAX=PCI address if device found
   156                              <1> ;	 EDX=Device+Vendor ID
   157                              <1> ;        CY clear if found, set if not found. EAX invalid if CY set.
   158                              <1> ;
   159                              <1> ; [old stackless] Destroys: ebx, esi, edi, cl
   160                              <1> ;
   161                              <1> pciFindDevice:
   162                              <1> 	;push	cx
   163                              <1> 	;push	eax ; *
   164                              <1> 	;push	esi
   165                              <1> 	;push	edi
   166                              <1> 
   167                              <1>  	;mov     esi, eax                ; save off vend+device ID
   168                              <1> 
   169                              <1> 	; 17/02/2017
   170 000002DB BE[E215]            <1> 	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
   171 000002DE B91500              <1> 	mov	cx, valid_id_count
   172                              <1> pfd_0:
   173 000002E1 66BF00FFFF7F        <1>        	mov     edi, (80000000h - 100h) ; start with bus 0, dev 0 func 0
   174                              <1> nextPCIdevice:
   175 000002E7 6681C700010000      <1>         add     edi, 100h
   176 000002EE 6681FF00F8FF80      <1>         cmp     edi, 80FFF800h		; scanned all devices?
   177                              <1>         ;stc
   178                              <1>         ;je 	short PCIScanExit       ; not found
   179 000002F5 720D                <1> 	jb	short pfd_1
   180 000002F7 66BF00000080        <1> 	mov     edi, 80000000h
   181 000002FD 83C604              <1> 	add	si, 4 ; scan for next device ID
   182 00000300 E202                <1> 	loop	pfd_1	 
   183 00000302 F9                  <1> 	stc	
   184                              <1> 	;jmp 	short PCIScanExit
   185 00000303 C3                  <1> 	retn
   186                              <1> pfd_1:
   187 00000304 6689F8              <1>         mov     eax, edi                ; read PCI registers
   188 00000307 E851FF              <1>         call    pciRegRead32
   189                              <1>         ;cmp    edx, esi                ; found device?
   190 0000030A 663B14              <1>         cmp	edx, dword [si]
   191 0000030D 75D8                <1> 	jne     short nextPCIdevice
   192                              <1>         ;clc
   193                              <1> PCIScanExit:
   194                              <1> 	;pushf
   195 0000030F 66B800000080        <1> 	mov	eax, BIT31
   196 00000315 66F7D0              <1> 	not	eax
   197 00000318 6621F8              <1> 	and	eax, edi		; return only bus/dev/fn #
   198                              <1> 	;popf
   199                              <1> 
   200                              <1> 	;pop	edi
   201                              <1> 	;pop	esi
   202                              <1> 	;pop	edx ; *
   203                              <1> 	;pop	cx
   204 0000031B C3                  <1> 	retn
   205                              <1> 
   206                              <1> ; ----------------------------------------------------------------------------
   207                              <1> ; CODEC.ASM
   208                              <1> ; ----------------------------------------------------------------------------
   209                              <1> 
   210                              <1> ; codec configuration code. Not much here really.
   211                              <1> ; NASM version: Erdogan Tan (29/11/2016)
   212                              <1> 
   213                              <1> ; enable codec, unmute stuff, set output rate to 44.1
   214                              <1> ; entry: ax = desired sample rate
   215                              <1> 
   216                              <1> ; 11/11/2023
   217                              <1> ; 06/11/2023
   218                              <1> %if 1
   219                              <1> 
   220                              <1> 	; 11/11/2023
   221                              <1> init_ac97_codec_err1:
   222 0000031C F9                  <1> 	stc
   223                              <1> init_ac97_codec_err2:
   224 0000031D C3                  <1> 	retn
   225                              <1> 
   226                              <1> 	; 13/11/2023
   227 0000031E 01                  <1> VRA:	db 1	
   228                              <1> 
   229                              <1> codecConfig:
   230                              <1> 	; 15/11/2023
   231                              <1> 	; 04/11/2023
   232                              <1> 	; 17/02/2017 
   233                              <1> 	; 07/11/2016 (Erdogan Tan)
   234                              <1> 	;PORT_NABM_GLB_CTRL_STAT equ 60h
   235                              <1> 
   236                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   237                              <1>  	; 'AC97_DEF.H'
   238                              <1> 	;AC97_EXTENDED_STATUS equ 002Ah
   239                              <1> 	AC97_EA_SPDIF	equ 0002h
   240                              <1> 	AC97_EA_VRA	equ 0001h
   241                              <1> 	; 04/11/2023
   242                              <1> 	ICH_PO_CR_RESET equ 0002h  ; reset codec
   243                              <1> 	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
   244                              <1> 	ICH_PCM_246_MASK equ 300000h ; 6 channels
   245                              <1> 
   246                              <1> 	; 04/11/2023
   247                              <1> init_ac97_controller:
   248 0000031F 66A1[BA17]          <1> 	mov	eax, [bus_dev_fn]
   249 00000323 B004                <1> 	mov	al, PCI_CMD_REG
   250 00000325 E825FF              <1> 	call	pciRegRead16		; read PCI command register
   251 00000328 80CA05              <1> 	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
   252 0000032B E891FF              <1> 	call	pciRegWrite16
   253                              <1> 
   254 0000032E E85301              <1> 	call	delay_100ms
   255                              <1> 
   256                              <1> init_ac97_codec:
   257                              <1> 	; 11/11/2023
   258                              <1> 	; (TRDOS 386 v2.0.5, 'audio.s')
   259 00000331 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   260 00000334 0316[B217]          <1> 	add	dx, [NABMBAR]
   261 00000338 66ED                <1> 	in	eax, dx
   262                              <1> 	; ?
   263                              <1> 	; 15/11/2023
   264 0000033A B92800              <1> 	mov	cx, 40
   265                              <1> _initc_1:
   266 0000033D BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   267 00000340 0316[B217]          <1> 	add	dx, [NABMBAR]
   268 00000344 66ED                <1> 	in	eax, dx
   269                              <1> 
   270 00000346 6683F8FF            <1> 	cmp	eax, 0FFFFFFFFh ; -1
   271                              <1> 	;je	short init_ac97_codec_err1
   272                              <1> 	; 15/11/2023
   273 0000034A 7508                <1> 	jne	short _initc_3
   274                              <1> _initc_2:
   275 0000034C 49                  <1> 	dec	cx
   276 0000034D 74CD                <1> 	jz	short init_ac97_codec_err1
   277                              <1> 
   278 0000034F E83201              <1> 	call	delay_100ms
   279 00000352 EBE9                <1> 	jmp	short _initc_1
   280                              <1> _initc_3:
   281 00000354 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   282 0000035A 7505                <1> 	jnz	short _ac97_codec_ready
   283                              <1> 
   284 0000035C E8A500              <1> 	call	reset_ac97_codec
   285                              <1> 	; 11/11/2023
   286                              <1> 	;jc	short init_ac97_codec_err2
   287                              <1> 	; 15/11/2023
   288 0000035F 72EB                <1> 	jc	short _initc_2
   289                              <1> 
   290                              <1> _ac97_codec_ready:
   291 00000361 8B16[B017]          <1> 	mov	dx, [NAMBAR]
   292                              <1> 	;add	dx, 0 ; ac_reg_0 ; reset register
   293 00000365 EF                  <1> 	out	dx, ax
   294                              <1> 
   295                              <1> ;	call	delay_100ms
   296                              <1> ;
   297                              <1> ;	xor	eax, eax ; 0
   298                              <1> ;	mov	dx, [NAMBAR]
   299                              <1> ;	add	dx, CODEC_REG_POWERDOWN
   300                              <1> ;	out	dx, ax
   301                              <1> ;
   302                              <1> ;	; wait for 1 second
   303                              <1> ;	mov	ecx, 1000 ; 1000*0.25ms = 1s
   304                              <1> ;_ac97_codec_rloop:
   305                              <1> ;	call	delay1_4ms
   306                              <1> ;	call	delay1_4ms
   307                              <1> ;	call	delay1_4ms
   308                              <1> ;	call	delay1_4ms
   309                              <1> ;	;mov	dx, [NAMBAR]
   310                              <1> ;	;add	dx, CODEC_REG_POWERDOWN
   311                              <1> ;	in	ax, dx	
   312                              <1> ;	and	ax, 0Fh
   313                              <1> ;	cmp	al, 0Fh
   314                              <1> ;	je	short _ac97_codec_init_ok
   315                              <1> ;	loop	_ac97_codec_rloop 
   316                              <1> ;
   317                              <1> ;init_ac97_codec_err1:
   318                              <1> ;	stc
   319                              <1> ;init_ac97_codec_err2:
   320                              <1> ;	retn
   321                              <1> 
   322                              <1> _ac97_codec_init_ok:
   323                              <1>         ; 11/11/2023
   324                              <1> 	;mov	al, 2 ; force set 16-bit 2-channel PCM
   325                              <1> 	;mov	dx, GLOB_CNT_REG ; 2Ch
   326                              <1> 	;add	dx, [NABMBAR]
   327                              <1> 	;out	dx, eax
   328                              <1> 
   329                              <1> 	;;call	delay1_4ms
   330                              <1> 
   331 00000366 E86600              <1> 	call 	reset_ac97_controller
   332                              <1> 
   333                              <1> 	; 11/11/2023
   334 00000369 E8E20F              <1> 	call	delay1_4ms
   335                              <1> 
   336                              <1> 	;call 	setup_ac97_codec
   337                              <1> 
   338                              <1> setup_ac97_codec:
   339                              <1> 	; 12/11/2023
   340 0000036C 813E[C217]80BB      <1> 	cmp	word [sample_rate], 48000
   341 00000372 742F                <1> 	je	short skip_rate
   342                              <1> 
   343                              <1> ; 11/11/2023
   344                              <1> ; 05/11/2023
   345                              <1> ;%if 1
   346                              <1> 	AC97_EA_VRA equ BIT0 ; 11/11/2023
   347                              <1> 
   348                              <1> 	; 11/11/2023
   349 00000374 8B16[B017]          <1> 	mov    	dx, [NAMBAR]               	
   350 00000378 83C22A              <1> 	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah  	  
   351 0000037B ED                  <1> 	in     	ax, dx
   352 0000037C 24FD                <1> 	and	al, ~BIT1 ; Clear DRA
   353 0000037E 0C01                <1> 	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
   354 00000380 EF                  <1> 	out	dx, ax			; Enable variable rate audio
   355                              <1> 	
   356 00000381 B90A00              <1> 	mov	cx, 10
   357                              <1> check_vra:
   358 00000384 E8FD00              <1> 	call	delay_100ms
   359                              <1> 
   360                              <1> 	; 11/11/2023
   361 00000387 ED                  <1> 	in	ax, dx
   362 00000388 A801                <1> 	test	al, AC97_EA_VRA ; 1
   363 0000038A 7509                <1> 	jnz	short set_rate
   364                              <1> 
   365                              <1> 	; 11/11/2023
   366 0000038C E2F6                <1> 	loop	check_vra
   367                              <1> 
   368                              <1> 	; 13/11/2023
   369 0000038E C606[1E03]00        <1> 	mov	byte [VRA], 0
   370 00000393 EB0E                <1> 	jmp	short skip_rate	
   371                              <1> 
   372                              <1> 	; 12/11/2023
   373                              <1> 	;pop	ax ; discard return address to the caller
   374                              <1> 	;mov	dx, msg_no_vra
   375                              <1> 	;jmp	vra_err
   376                              <1> 
   377                              <1> set_rate:
   378 00000395 A1[C217]            <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   379                              <1> 
   380 00000398 8B16[B017]          <1> 	mov    	dx, [NAMBAR]               	
   381 0000039C 83C22C              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   382 0000039F EF                  <1> 	out	dx, ax 			; PCM Front/Center Output Sample Rate
   383                              <1> 
   384 000003A0 E8E100              <1> 	call	delay_100ms
   385                              <1> 
   386                              <1> 	; 12/11/2023
   387                              <1> skip_rate:
   388                              <1> 	; 11/11/2023 (temporary)
   389                              <1> 
   390                              <1> 	;mov   	dx, [NAMBAR]               	
   391                              <1> 	;add   	dx, CODEC_PCM_SURND_DACRATE_REG	; 2Eh  	  
   392                              <1> 	;out	dx, ax 			; PCM Surround Output Sample Rate
   393                              <1> 
   394                              <1> 	;call	delay_100ms
   395                              <1> 
   396                              <1> 	;mov   	dx, [NAMBAR]               	
   397                              <1> 	;add   	dx, CODEC_PCM_LFE_DACRATE_REG	; 30h  	  
   398                              <1> 	;out	dx, ax 			; PCM LFE Output Sample Rate
   399                              <1> 
   400                              <1> 	;call	delay_100ms
   401                              <1> 
   402                              <1> 	; 05/11/2023 (temporary)
   403                              <1> 	;mov	dx, [NAMBAR]               	
   404                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   405                              <1> 	;out	dx, ax 			; PCM Input Sample Rate
   406                              <1> 	;
   407                              <1> 	;call	delay_100ms
   408                              <1> 
   409 000003A3 B80202              <1> 	mov	ax, 0202h
   410 000003A6 8B16[B017]          <1>   	mov     dx, [NAMBAR]
   411 000003AA 83C202              <1>   	add     dx, CODEC_MASTER_VOL_REG	;02h 
   412 000003AD EF                  <1> 	out     dx, ax
   413                              <1> 
   414                              <1> 	; 11/11/2023
   415                              <1>         ;call	delay1_4ms
   416                              <1>         ;call	delay1_4ms
   417                              <1>         ;call	delay1_4ms
   418                              <1>         ;call	delay1_4ms
   419                              <1>  	;
   420                              <1>   	;mov	dx, [NAMBAR]
   421                              <1>   	;add	dx, CODEC_MASTER_MONO_VOL_REG	;06h 
   422                              <1>   	;out	dx, ax
   423                              <1> 
   424                              <1> 	; 11/11/2023
   425                              <1>         ;call	delay1_4ms
   426                              <1>         ;call	delay1_4ms
   427                              <1>         ;call	delay1_4ms
   428                              <1>         ;call	delay1_4ms
   429                              <1> 	;
   430                              <1> 	;mov	ax, 02h
   431                              <1>   	;mov	dx, [NAMBAR]
   432                              <1>   	;add	dx, CODEC_PCBEEP_VOL_REG	;0Ah 
   433                              <1>   	;out	dx, ax
   434                              <1> 
   435 000003AE E89D0F              <1>         call    delay1_4ms
   436 000003B1 E89A0F              <1>         call    delay1_4ms
   437 000003B4 E8970F              <1>         call    delay1_4ms
   438 000003B7 E8940F              <1>         call    delay1_4ms
   439                              <1> 
   440                              <1> 	;mov	ax, 0202h
   441 000003BA 8B16[B017]          <1>   	mov     dx, [NAMBAR]
   442 000003BE 83C218              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h 
   443 000003C1 EF                  <1>   	out     dx, ax
   444                              <1> 
   445 000003C2 E8890F              <1>         call    delay1_4ms
   446 000003C5 E8860F              <1>         call    delay1_4ms
   447 000003C8 E8830F              <1>         call    delay1_4ms
   448 000003CB E8800F              <1>         call    delay1_4ms
   449                              <1> 
   450                              <1> 	; 11/11/2023
   451                              <1> 	;mov	ax, 8008h ; Mute
   452                              <1>   	;mov	dx, [NAMBAR]
   453                              <1> 	;add	dx, CODEC_PHONE_VOL_REG		;0Ch
   454                              <1> 	;			 ; AC97_PHONE_VOL ; TAD Input (Mono)
   455                              <1>   	;out	dx, ax
   456                              <1> 	;
   457                              <1>         ;call	delay1_4ms
   458                              <1>         ;call	delay1_4ms
   459                              <1>         ;call	delay1_4ms
   460                              <1> 	;call	delay1_4ms
   461                              <1> 
   462                              <1> 	;mov	ax, 0808h
   463                              <1> 	;mov	dx, [NAMBAR]
   464                              <1> 	;add	dx, CODEC_LINE_IN_VOL_REG ;10h ; Line Input (Stereo)
   465                              <1> 	;out	dx, ax
   466                              <1> 	;
   467                              <1>         ;call	delay1_4ms
   468                              <1>         ;call	delay1_4ms
   469                              <1>         ;call	delay1_4ms
   470                              <1> 	;call	delay1_4ms
   471                              <1> 
   472                              <1>   	;mov	dx, [NAMBAR]
   473                              <1>         ;add	dx, CODEC_CD_VOL_REG ;12h ; CD Input (Stereo)
   474                              <1>   	;out	dx, ax
   475                              <1> 	;
   476                              <1>   	;mov	dx, [NAMBAR]
   477                              <1>         ;add	dx, CODEC_AUX_VOL_REG ;16h ; Aux Input (Stereo)
   478                              <1>   	;out	dx, ax
   479                              <1> 	;
   480                              <1>         ;call	delay1_4ms
   481                              <1>         ;call	delay1_4ms
   482                              <1>         ;call	delay1_4ms
   483                              <1> 	;call	delay1_4ms
   484                              <1> 
   485                              <1> ;detect_ac97_codec:
   486 000003CE C3                  <1>         retn
   487                              <1> 
   488                              <1> reset_ac97_controller:
   489                              <1> 	; 11/11/2023
   490                              <1> 	; 10/06/2017
   491                              <1> 	; 29/05/2017
   492                              <1> 	; 28/05/2017
   493                              <1> 	; reset AC97 audio controller registers
   494 000003CF 31C0                <1> 	xor     ax, ax
   495 000003D1 BA0B00              <1>         mov	dx, PI_CR_REG
   496 000003D4 0316[B217]          <1> 	add	dx, [NABMBAR]
   497 000003D8 EE                  <1> 	out     dx, al
   498                              <1> 
   499 000003D9 BA1B00              <1>         mov     dx, PO_CR_REG
   500 000003DC 0316[B217]          <1> 	add	dx, [NABMBAR]
   501 000003E0 EE                  <1> 	out     dx, al
   502                              <1> 
   503 000003E1 BA2B00              <1>         mov     dx, MC_CR_REG
   504 000003E4 0316[B217]          <1> 	add	dx, [NABMBAR]
   505 000003E8 EE                  <1> 	out     dx, al
   506                              <1> 
   507 000003E9 B002                <1>         mov     al, RR
   508 000003EB BA0B00              <1>         mov     dx, PI_CR_REG
   509 000003EE 0316[B217]          <1> 	add	dx, [NABMBAR]
   510 000003F2 EE                  <1> 	out     dx, al
   511                              <1> 
   512 000003F3 BA1B00              <1>         mov     dx, PO_CR_REG
   513 000003F6 0316[B217]          <1> 	add	dx, [NABMBAR]
   514 000003FA EE                  <1> 	out     dx, al
   515                              <1> 
   516 000003FB BA2B00              <1>         mov     dx, MC_CR_REG
   517 000003FE 0316[B217]          <1> 	add	dx, [NABMBAR]
   518 00000402 EE                  <1> 	out     dx, al
   519                              <1> 
   520 00000403 C3                  <1> 	retn
   521                              <1> 
   522                              <1> reset_ac97_codec:
   523                              <1> 	; 11/11/2023
   524                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   525 00000404 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   526 00000407 0316[B217]          <1> 	add	dx, [NABMBAR]
   527 0000040B 66ED                <1> 	in	eax, dx
   528                              <1> 
   529                              <1> 	;test	eax, 2
   530                              <1> 	; 06/08/2022
   531 0000040D A802                <1> 	test	al, 2
   532 0000040F 7405                <1> 	jz	short _r_ac97codec_cold	
   533                              <1> 
   534 00000411 E80E00              <1> 	call	warm_ac97codec_reset
   535 00000414 7306                <1> 	jnc	short _r_ac97codec_ok
   536                              <1> _r_ac97codec_cold:
   537 00000416 E83400              <1>         call    cold_ac97codec_reset
   538 00000419 7301                <1>         jnc     short _r_ac97codec_ok
   539                              <1> 	
   540                              <1> 	; 16/04/2017
   541                              <1>         ;xor	eax, eax	; timeout error
   542                              <1>        	;stc
   543 0000041B C3                  <1> 	retn
   544                              <1> 
   545                              <1> _r_ac97codec_ok:
   546 0000041C 6631C0              <1>         xor     eax, eax
   547                              <1>         ;mov	al, VIA_ACLINK_C00_READY ; 1
   548 0000041F FEC0                <1>         inc	al
   549 00000421 C3                  <1> 	retn
   550                              <1> 
   551                              <1> warm_ac97codec_reset:
   552                              <1> 	; 11/11/2023
   553                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   554                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   555 00000422 66B806000000        <1> 	mov	eax, 6
   556 00000428 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   557 0000042B 0316[B217]          <1> 	add	dx, [NABMBAR]
   558 0000042F 66EF                <1> 	out	dx, eax
   559                              <1> 
   560 00000431 B90A00              <1> 	mov	cx, 10	; total 1s
   561                              <1> _warm_ac97c_rst_wait:
   562 00000434 E84D00              <1> 	call	delay_100ms
   563                              <1> 
   564 00000437 BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   565 0000043A 0316[B217]          <1> 	add	dx, [NABMBAR]
   566 0000043E 66ED                <1> 	in	eax, dx
   567                              <1> 
   568 00000440 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   569 00000446 7504                <1> 	jnz	short _warm_ac97c_rst_ok
   570                              <1> 
   571 00000448 49                  <1>         dec     cx
   572 00000449 75E9                <1>         jnz     short _warm_ac97c_rst_wait
   573                              <1> 
   574                              <1> _warm_ac97c_rst_fail:
   575 0000044B F9                  <1>         stc
   576                              <1> _warm_ac97c_rst_ok:
   577 0000044C C3                  <1> 	retn
   578                              <1> 
   579                              <1> cold_ac97codec_reset:
   580                              <1> 	; 11/11/2023
   581                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   582                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   583 0000044D 66B802000000        <1>         mov	eax, 2
   584 00000453 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   585 00000456 0316[B217]          <1> 	add	dx, [NABMBAR]
   586 0000045A 66EF                <1> 	out	dx, eax
   587                              <1> 
   588 0000045C E82500              <1> 	call	delay_100ms 	; wait 100 ms
   589 0000045F E82200              <1> 	call	delay_100ms 	; wait 100 ms
   590 00000462 E81F00              <1> 	call	delay_100ms 	; wait 100 ms
   591 00000465 E81C00              <1> 	call	delay_100ms 	; wait 100 ms
   592                              <1> 
   593 00000468 B91000              <1> 	mov	cx, 16	; total 20*100 ms = 2s
   594                              <1> 
   595                              <1> _cold_ac97c_rst_wait:
   596 0000046B BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   597 0000046E 0316[B217]          <1> 	add	dx, [NABMBAR]
   598 00000472 66ED                <1> 	in	eax, dx
   599                              <1> 
   600 00000474 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   601 0000047A 7507                <1> 	jnz	short _cold_ac97c_rst_ok
   602                              <1> 
   603 0000047C E80500              <1> 	call	delay_100ms
   604                              <1> 
   605 0000047F 49                  <1>         dec     cx
   606 00000480 75E9                <1>         jnz     short _cold_ac97c_rst_wait
   607                              <1> 
   608                              <1> _cold_ac97c_rst_fail:
   609 00000482 F9                  <1>         stc
   610                              <1> _cold_ac97c_rst_ok:
   611 00000483 C3                  <1> 	retn
   612                              <1> 
   613                              <1> delay_100ms:
   614                              <1> 	; 11/11/2023
   615                              <1> 	; 29/05/2017
   616                              <1> 	; 24/03/2017 ('codec.asm')
   617                              <1> 	; wait 100 ms
   618 00000484 51                  <1> 	push	cx
   619 00000485 B99001              <1> 	mov	cx, 400  ; 400*0.25ms
   620                              <1> _delay_x_ms:
   621 00000488 E8C30E              <1> 	call	delay1_4ms
   622 0000048B E2FB                <1>         loop	_delay_x_ms
   623 0000048D 59                  <1> 	pop	cx
   624 0000048E C3                  <1> 	retn
   625                              <1> 
   626                              <1> %endif
   627                              <1> 
   628                              <1> ; 11/11/2023
   629                              <1> %if 0
   630                              <1> 
   631                              <1> codecConfig:
   632                              <1> 	; 06/11/2023
   633                              <1> 	; TUNELOOP version (playing without interrupt)
   634                              <1> 	; 04/11/2023
   635                              <1> 	; 17/02/2017 
   636                              <1> 	; 07/11/2016 (Erdogan Tan)
   637                              <1> 
   638                              <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   639                              <1> 
   640                              <1> 	mov    	dx, [NAMBAR]               	
   641                              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   642                              <1> 	out	dx, ax 				; out sample rate
   643                              <1> 		
   644                              <1> 	; 05/11/2023 temp
   645                              <1> 	;mov	dx, [NAMBAR]               	
   646                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   647                              <1> 	;out	dx, ax 
   648                              <1> 
   649                              <1>         call    delay1_4ms
   650                              <1>         call    delay1_4ms
   651                              <1>         call    delay1_4ms
   652                              <1>         call    delay1_4ms
   653                              <1> 
   654                              <1> 	mov	eax, [dev_vendor]
   655                              <1>         cmp	eax, (SI7012_DID<<16)+SIS_VID
   656                              <1>         jne	short cConfig1
   657                              <1> 
   658                              <1> 	; Unmute quirk specifically for the SiS7012
   659                              <1> 
   660                              <1> 	CUSTOM_SIS_7012_REG equ 4Ch ; SiS7012-specific register
   661                              <1> 	
   662                              <1>         mov     dx, [NABMBAR]
   663                              <1>         add     dx, CUSTOM_SIS_7012_REG
   664                              <1>         in      ax, dx
   665                              <1>         or	al, 1
   666                              <1>         out     dx, ax
   667                              <1> 
   668                              <1> cConfig1:
   669                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   670                              <1> 	; initial ac97 volumes (and clear mute flag)
   671                              <1> 		
   672                              <1>   	mov     dx, [NAMBAR]
   673                              <1>   	add     dx, CODEC_MASTER_VOL_REG        ;02h ; STEREO
   674                              <1>   	;xor	ax, ax ; volume attenuation = 0 (max. volume)
   675                              <1>   	; 03/11/2023
   676                              <1> 	mov	ax, 0202h
   677                              <1> 	out     dx, ax
   678                              <1> 
   679                              <1>         call    delay1_4ms	; delays because codecs are slow
   680                              <1>         call    delay1_4ms
   681                              <1>         call    delay1_4ms
   682                              <1>         call    delay1_4ms
   683                              <1>  
   684                              <1>   	mov     dx, [NAMBAR]
   685                              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h
   686                              <1>   	;;xor	ax, ax
   687                              <1> 	;mov	ax, 0202h
   688                              <1>   	out     dx, ax
   689                              <1> 
   690                              <1>         call    delay1_4ms
   691                              <1>         call    delay1_4ms
   692                              <1>         call    delay1_4ms
   693                              <1>         call    delay1_4ms
   694                              <1>  
   695                              <1> 	retn
   696                              <1> 
   697                              <1> %endif
   451                                  ;%include 'ich_wav.asm' ; 17/02/2017 (ICH AC97 wav playing functions)
   452                                  %include 'ich_wav3.asm' ; 13/11/2023 (ICH AC97 wav playing functions)
     1                              <1> ; 16/11/2023
     2                              <1> ; 15/11/2023
     3                              <1> ; 14/11/2023
     4                              <1> ; 13/11/2023
     5                              <1> ; 03/11/2023 - 11/11/2023
     6                              <1> ; DOS based .WAV player using AC'97 and codec interface.
     7                              <1> ; ---------------------------------------------------------------
     8                              <1> ; NASM version: Erdogan Tan (29/11/2016)
     9                              <1> ; Last Update: 17/02/2017 (by Erdogan Tan)
    10                              <1> 
    11                              <1> ; AC97 interrupt version - 09/11/2023 - Erdogan Tan
    12                              <1> ; sample rate conversion version - 13/11/2023 - Erdogan Tan
    13                              <1> 
    14                              <1> ; ICHWAV.ASM
    15                              <1> 
    16                              <1> ; player internal variables and other equates.
    17                              <1> BUFFERSIZE      equ     64 * 1024       ; 64k file buffer size.
    18                              <1> ENDOFFILE       equ     BIT0            ; flag for knowing end of file
    19                              <1> 
    20                              <1> ;===========================================================================
    21                              <1> ; entry: none. File is already open and [filehandle] filled.
    22                              <1> ; exit:  not until the song is finished or the user aborts.
    23                              <1> ;
    24                              <1> playWav:
    25                              <1> 	; 13/11/2023
    26                              <1> 
    27 0000048F 803E[1E03]01        <1> 	cmp	byte [VRA], 1
    28 00000494 720F                <1> 	jb	short chk_sample_rate
    29                              <1> playwav_48_khz:	
    30 00000496 C706[4506][6607]    <1> 	mov	word [loadfromwavfile], loadFromFile
    31                              <1> 	;mov	word [loadsize], 0 ; 65536
    32 0000049C C706[4906]0080      <1> 	mov	word [buffersize], 32768 ; samples
    33 000004A2 E9A801              <1> 	jmp	playWav_vra
    34                              <1> 
    35                              <1> chk_sample_rate:
    36                              <1> 	; set conversion parameters
    37                              <1> 	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
    38 000004A5 A1[C217]            <1> 	mov	ax, [sample_rate]
    39 000004A8 3D80BB              <1> 	cmp	ax, 48000
    40 000004AB 74E9                <1> 	je	short playwav_48_khz
    41                              <1> chk_22khz:
    42 000004AD 3D2256              <1> 	cmp	ax, 22050
    43 000004B0 752F                <1> 	jne	short chk_11khz
    44 000004B2 803E[C617]08        <1> 	cmp	byte [bps], 8
    45 000004B7 760F                <1> 	jna	short chk_22khz_1
    46 000004B9 BB[7011]            <1> 	mov	bx, load_22khz_stereo_16_bit
    47 000004BC 803E[C417]01        <1> 	cmp	byte [stmo], 1 
    48 000004C1 7512                <1> 	jne	short chk_22khz_2
    49 000004C3 BB[0711]            <1> 	mov	bx, load_22khz_mono_16_bit
    50 000004C6 EB0D                <1> 	jmp	short chk_22khz_2
    51                              <1> chk_22khz_1:
    52 000004C8 BB[A410]            <1> 	mov	bx, load_22khz_stereo_8_bit
    53 000004CB 803E[C417]01        <1> 	cmp	byte [stmo], 1 
    54 000004D0 7503                <1> 	jne	short chk_22khz_2
    55 000004D2 BB[3B10]            <1> 	mov	bx, load_22khz_mono_8_bit
    56                              <1> chk_22khz_2:
    57 000004D5 B85A1D              <1> 	mov	ax, 7514  ; (442*17)
    58 000004D8 BA2500              <1> 	mov	dx, 37
    59 000004DB B91100              <1> 	mov	cx, 17 
    60 000004DE E93301              <1> 	jmp	set_sizes	
    61                              <1> chk_11khz:
    62 000004E1 3D112B              <1> 	cmp	ax, 11025
    63 000004E4 752F                <1> 	jne	short chk_44khz
    64 000004E6 803E[C617]08        <1> 	cmp	byte [bps], 8
    65 000004EB 760F                <1> 	jna	short chk_11khz_1
    66 000004ED BB[F011]            <1> 	mov	bx, load_11khz_stereo_16_bit
    67 000004F0 803E[C417]01        <1> 	cmp	byte [stmo], 1 
    68 000004F5 7512                <1> 	jne	short chk_11khz_2
    69 000004F7 BB[F011]            <1> 	mov	bx, load_11khz_mono_16_bit
    70 000004FA EB0D                <1> 	jmp	short chk_11khz_2
    71                              <1> chk_11khz_1:
    72 000004FC BB[F011]            <1> 	mov	bx, load_11khz_stereo_8_bit
    73 000004FF 803E[C417]01        <1> 	cmp	byte [stmo], 1 
    74 00000504 7503                <1> 	jne	short chk_11khz_2
    75 00000506 BB[F011]            <1> 	mov	bx, load_11khz_mono_8_bit
    76                              <1> chk_11khz_2:
    77 00000509 B8AD0E              <1> 	mov	ax, 3757  ; (221*17)
    78 0000050C BA4A00              <1> 	mov	dx, 74
    79 0000050F B91100              <1> 	mov	cx, 17
    80 00000512 E9FF00              <1> 	jmp	set_sizes 
    81                              <1> chk_44khz:
    82 00000515 3D44AC              <1> 	cmp	ax, 44100
    83 00000518 752F                <1> 	jne	short chk_16khz
    84 0000051A 803E[C617]08        <1> 	cmp	byte [bps], 8
    85 0000051F 760F                <1> 	jna	short chk_44khz_1
    86 00000521 BB[F011]            <1> 	mov	bx, load_44khz_stereo_16_bit
    87 00000524 803E[C417]01        <1> 	cmp	byte [stmo], 1 
    88 00000529 7512                <1> 	jne	short chk_44khz_2
    89 0000052B BB[F011]            <1> 	mov	bx, load_44khz_mono_16_bit
    90 0000052E EB0D                <1> 	jmp	short chk_44khz_2
    91                              <1> chk_44khz_1:
    92 00000530 BB[F011]            <1> 	mov	bx, load_44khz_stereo_8_bit
    93 00000533 803E[C417]01        <1> 	cmp	byte [stmo], 1 
    94 00000538 7503                <1> 	jne	short chk_44khz_2
    95 0000053A BB[F011]            <1> 	mov	bx, load_44khz_mono_8_bit
    96                              <1> chk_44khz_2:
    97 0000053D B8D93A              <1> 	mov	ax, 15065 ; (655*23)
    98 00000540 BA1900              <1> 	mov	dx, 25
    99 00000543 B91700              <1> 	mov	cx, 23
   100 00000546 E9CB00              <1> 	jmp	set_sizes 
   101                              <1> chk_16khz:
   102 00000549 3D803E              <1> 	cmp	ax, 16000
   103 0000054C 752F                <1> 	jne	short chk_8khz
   104 0000054E 803E[C617]08        <1> 	cmp	byte [bps], 8
   105 00000553 760F                <1> 	jna	short chk_16khz_1
   106 00000555 BB[B90C]            <1> 	mov	bx, load_16khz_stereo_16_bit
   107 00000558 803E[C417]01        <1> 	cmp	byte [stmo], 1 
   108 0000055D 7512                <1> 	jne	short chk_16khz_2
   109 0000055F BB[580C]            <1> 	mov	bx, load_16khz_mono_16_bit
   110 00000562 EB0D                <1> 	jmp	short chk_16khz_2
   111                              <1> chk_16khz_1:
   112 00000564 BB[C80B]            <1> 	mov	bx, load_16khz_stereo_8_bit
   113 00000567 803E[C417]01        <1> 	cmp	byte [stmo], 1 
   114 0000056C 7503                <1> 	jne	short chk_16khz_2
   115 0000056E BB[640B]            <1> 	mov	bx, load_16khz_mono_8_bit
   116                              <1> chk_16khz_2:
   117 00000571 B85515              <1> 	mov	ax, 5461
   118 00000574 BA0300              <1> 	mov	dx, 3
   119 00000577 B90100              <1> 	mov	cx, 1
   120 0000057A E99700              <1> 	jmp	set_sizes 
   121                              <1> chk_8khz:
   122 0000057D 3D401F              <1> 	cmp	ax, 8000
   123 00000580 752E                <1> 	jne	short chk_24khz
   124 00000582 803E[C617]08        <1> 	cmp	byte [bps], 8
   125 00000587 760F                <1> 	jna	short chk_8khz_1
   126 00000589 BB[7D0A]            <1> 	mov	bx, load_8khz_stereo_16_bit
   127 0000058C 803E[C417]01        <1> 	cmp	byte [stmo], 1 
   128 00000591 7512                <1> 	jne	short chk_8khz_2
   129 00000593 BB[EC09]            <1> 	mov	bx, load_8khz_mono_16_bit
   130 00000596 EB0D                <1> 	jmp	short chk_8khz_2
   131                              <1> chk_8khz_1:
   132 00000598 BB[FC08]            <1> 	mov	bx, load_8khz_stereo_8_bit
   133 0000059B 803E[C417]01        <1> 	cmp	byte [stmo], 1 
   134 000005A0 7503                <1> 	jne	short chk_8khz_2
   135 000005A2 BB[4908]            <1> 	mov	bx, load_8khz_mono_8_bit
   136                              <1> chk_8khz_2:
   137 000005A5 B8AA0A              <1> 	mov	ax, 2730
   138 000005A8 BA0600              <1> 	mov	dx, 6
   139 000005AB B90100              <1> 	mov	cx, 1
   140 000005AE EB64                <1> 	jmp	short set_sizes 
   141                              <1> chk_24khz:
   142 000005B0 3DC05D              <1> 	cmp	ax, 24000
   143 000005B3 752E                <1> 	jne	short chk_32khz
   144 000005B5 803E[C617]08        <1> 	cmp	byte [bps], 8
   145 000005BA 760F                <1> 	jna	short chk_24khz_1
   146 000005BC BB[4E0E]            <1> 	mov	bx, load_24khz_stereo_16_bit
   147 000005BF 803E[C417]01        <1> 	cmp	byte [stmo], 1 
   148 000005C4 7512                <1> 	jne	short chk_24khz_2
   149 000005C6 BB[050E]            <1> 	mov	bx, load_24khz_mono_16_bit
   150 000005C9 EB0D                <1> 	jmp	short chk_24khz_2
   151                              <1> chk_24khz_1:
   152 000005CB BB[9D0D]            <1> 	mov	bx, load_24khz_stereo_8_bit
   153 000005CE 803E[C417]01        <1> 	cmp	byte [stmo], 1 
   154 000005D3 7503                <1> 	jne	short chk_24khz_2
   155 000005D5 BB[4E0D]            <1> 	mov	bx, load_24khz_mono_8_bit
   156                              <1> chk_24khz_2:
   157 000005D8 B80020              <1> 	mov	ax, 8192
   158 000005DB BA0200              <1> 	mov	dx, 2
   159 000005DE B90100              <1> 	mov	cx, 1
   160 000005E1 EB31                <1> 	jmp	short set_sizes 
   161                              <1> chk_32khz:
   162 000005E3 3D007D              <1> 	cmp	ax, 32000
   163 000005E6 7556                <1> 	jne	short vra_needed
   164 000005E8 803E[C617]08        <1> 	cmp	byte [bps], 8
   165 000005ED 760F                <1> 	jna	short chk_32khz_1
   166 000005EF BB[D00F]            <1> 	mov	bx, load_32khz_stereo_16_bit
   167 000005F2 803E[C417]01        <1> 	cmp	byte [stmo], 1 
   168 000005F7 7512                <1> 	jne	short chk_32khz_2
   169 000005F9 BB[830F]            <1> 	mov	bx, load_32khz_mono_16_bit
   170 000005FC EB0D                <1> 	jmp	short chk_32khz_2
   171                              <1> chk_32khz_1:
   172 000005FE BB[0C0F]            <1> 	mov	bx, load_32khz_stereo_8_bit
   173 00000601 803E[C417]01        <1> 	cmp	byte [stmo], 1 
   174 00000606 7503                <1> 	jne	short chk_32khz_2
   175 00000608 BB[B40E]            <1> 	mov	bx, load_32khz_mono_8_bit
   176                              <1> chk_32khz_2:
   177 0000060B B8AA2A              <1> 	mov	ax, 10922
   178 0000060E BA0300              <1> 	mov	dx, 3
   179 00000611 B90200              <1> 	mov	cx, 2
   180                              <1> 	;jmp	short set_sizes 
   181                              <1> set_sizes:
   182 00000614 803E[C417]01        <1> 	cmp	byte [stmo], 1
   183 00000619 7402                <1> 	je	short ss_1
   184 0000061B D1E0                <1> 	shl	ax, 1
   185                              <1> ss_1:
   186 0000061D 803E[C617]08        <1> 	cmp	byte [bps], 8
   187 00000622 7602                <1> 	jna	short ss_2
   188                              <1> 	; 16 bit samples
   189 00000624 D1E0                <1> 	shl	ax, 1
   190                              <1> ss_2:
   191 00000626 A3[4706]            <1> 	mov	[loadsize], ax
   192 00000629 F7E2                <1> 	mul	dx
   193                              <1> 	;cmp	cx, 1
   194                              <1> 	;je	short ss_3
   195                              <1> ;ss_3:
   196 0000062B F7F1                <1> 	div	cx
   197 0000062D 8A0E[C817]          <1> 	mov	cl, [fbs_shift]
   198 00000631 D3E0                <1> 	shl	ax, cl
   199 00000633 D1E8                <1> 	shr	ax, 1	; buffer size is 16 bit sample count
   200 00000635 A3[4906]            <1> 	mov	[buffersize], ax 
   201 00000638 891E[4506]          <1> 	mov	[loadfromwavfile], bx
   202 0000063C EB0F                <1> 	jmp	short playWav_vra
   203                              <1> 
   204                              <1> vra_needed:
   205                              <1> 	; 13/11/2023
   206 0000063E 58                  <1> 	pop	ax ; discard return address to the caller
   207 0000063F BA[4E17]            <1> 	mov	dx, msg_no_vra
   208 00000642 E915FB              <1> 	jmp	vra_err
   209                              <1> 
   210                              <1> 	; 13/11/2023
   211                              <1> loadfromwavfile:
   212 00000645 [6607]              <1> 	dw	loadFromFile
   213                              <1> loadsize:	; read from wav file
   214 00000647 0000                <1> 	dw	0
   215                              <1> buffersize:	; write to DMA buffer
   216 00000649 00800000            <1> 	dd	32768 ; 16 bit samples (not bytes)
   217                              <1> 
   218                              <1> playWav_vra:
   219                              <1> 	; 07/11/2023
   220                              <1> 	; clear buffer 2
   221                              <1>         ;push	es
   222                              <1> 	;mov	ax, [WAV_BUFFER2]
   223                              <1> 	;mov	es, ax
   224                              <1> 	;sub	ax, ax
   225                              <1> 	;mov	di, ax ; 17/02/2017
   226                              <1> 	;mov	cx, (BUFFERSIZE/2)
   227                              <1> 	;rep	stosw
   228                              <1> 	;pop	es	     
   229                              <1> 	
   230                              <1> 	; load 64k into buffer 1
   231 0000064D A1[B617]            <1>         mov     ax, [WAV_BUFFER1]
   232                              <1>         ;call	loadFromFile
   233                              <1> 	; 13/11/2023
   234 00000650 FF16[4506]          <1> 	call	word [loadfromwavfile]
   235                              <1> 
   236                              <1> 	; and 64k into buffer 2
   237 00000654 A1[B817]            <1> 	mov     ax, [WAV_BUFFER2]
   238                              <1>        	;call	loadFromFile
   239                              <1> 	; 13/11/2023
   240 00000657 FF16[4506]          <1> 	call	word [loadfromwavfile]
   241                              <1> 
   242                              <1> ; register reset the DMA engine. This may cause a pop noise on the output
   243                              <1> ; lines when the device is reset. Prolly a better idea to mute output, then
   244                              <1> ; reset.
   245                              <1> 
   246                              <1> 	; 11/11/2023
   247                              <1>         ;mov	dx, [NABMBAR]
   248                              <1>         ;add	dx, PO_CR_REG		; set pointer to Ctrl reg
   249                              <1>         ;mov	al, RR			; set reset
   250                              <1> 	;out	dx, al			; self clearing bit
   251                              <1> 
   252                              <1> ; write last valid index to 31 to start with.
   253                              <1> ; The Last Valid Index register tells the DMA engine when to stop playing.
   254                              <1> ; 
   255                              <1> ; As we progress through the song we change the last valid index to always be
   256                              <1> ; something other than the index we're currently playing.  
   257                              <1> ;
   258                              <1> 	; 08/11/2023
   259                              <1> 	;; 07/11/2023
   260                              <1> 	;mov	al, 1
   261                              <1>         ;;mov	al, 31
   262                              <1> 	;call	setLastValidIndex
   263                              <1> 
   264                              <1> ; create Buffer Descriptor List
   265                              <1> ;
   266                              <1> ; A buffer descriptor list is a list of pointers and control bits that the
   267                              <1> ; DMA engine uses to know where to get the .wav data and how to play it.
   268                              <1> ;
   269                              <1> ; I set it up to use only 2 buffers of .wav data, and whenever 1 buffer is
   270                              <1> ; playing, I refresh the other one with good data.
   271                              <1> ;
   272                              <1> ;
   273                              <1> ; For the control bits, you can specify that the DMA engine fire an interrupt
   274                              <1> ; after a buffer has been processed, but I poll the current index register
   275                              <1> ; to know when it's safe to update the other buffer.
   276                              <1> ;
   277                              <1> ; I set the BUP bit, which tells the DMA engine to just play 0's (silence)
   278                              <1> ; if it ever runs out of data to play. Good for safety.
   279                              <1> ;
   280 0000065B 06                  <1>         push    es
   281 0000065C A1[B417]            <1>         mov     ax, [BDL_BUFFER]		; get segment # for BDL
   282 0000065F 8EC0                <1>         mov     es, ax
   283                              <1> 
   284 00000661 B91000              <1>         mov     cx, 32 / 2                      ; make 32 entries in BDL
   285 00000664 31FF                <1>         xor     di, di                          
   286                              <1> _0:
   287                              <1> 
   288                              <1> ; set buffer descriptor 0 to start of data file in memory
   289 00000666 660FB706[B617]      <1>         movzx   eax, word [WAV_BUFFER1]
   290 0000066C 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   291 00000670 66AB                <1>         stosd                                   ; store pointer to wavbuffer1
   292                              <1> 
   293                              <1> ;
   294                              <1> ; set length to 32k samples. 1 sample is 16bits or 2bytes.
   295                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples.
   296                              <1> ; 
   297                              <1> 
   298                              <1> ; 17/02/2017 (Erdogan Tan)
   299                              <1> ; Intel 82801AA (ICH) & Intel 82801AB (ICH0) I/O Controller Hub AC97
   300                              <1> ; Programmers Reference Manual
   301                              <1> 
   302                              <1> ; 2.2.1 Buffer Descriptor List  (on Page 13)
   303                              <1> 	;
   304                              <1> 	;  Generic Form of Buffer Descriptor
   305                              <1> 	;  ---------------------------------
   306                              <1> 	;  63   62    61-48    47-32   31-0
   307                              <1> 	;  ---  ---  --------  ------- -----
   308                              <1> 	;  IOC  BUP -reserved- Buffer  Buffer
   309                              <1> 	;		      Length   Pointer
   310                              <1> 	;		      [15:0]   [31:0]
   311                              <1> 	;
   312                              <1> 	;  IOC:	Interrupt On Completion. 
   313                              <1> 	;	1 = Enabled. 
   314                              <1> 	;	    When this is set, it means that the controller should
   315                              <1> 	;	    issue an interrupt upon completion of this buffer.
   316                              <1> 	;	    It should also set the IOC bit in the status register
   317                              <1> 	;	0 = Disabled	
   318                              <1> 	;
   319                              <1> 	;  BUP: Buffer Underrun Policy.
   320                              <1> 	;       0 = When this buffer is complete,
   321                              <1> 	;	    if the next buffer is not yet ready 
   322                              <1> 	;	    (i.e., the last valid buffer has been processed),
   323                              <1> 	;	    then continue to transmit the last valid sample.
   324                              <1> 	;	1 = When this buffer is complete,
   325                              <1> 	;     	    if this is the last valid buffer, transmit zeros after
   326                              <1> 	;	    this buffer has been processed completely.
   327                              <1> 	;	    This bit typically is set only if this is the last 
   328                              <1> 	;	    buffer in the current stream.
   329                              <1> 	;
   330                              <1> 	; [31:0]: Buffer pointer. This field points to the location of
   331                              <1> 	;	  the data buffer. Since samples can be as wide as one
   332                              <1> 	;	  word, the buffer must be aligned with word boundaries,
   333                              <1> 	;	  to prevent samples from straddling DWord boundaries.
   334                              <1> 	;
   335                              <1> 	; [15:0]: Buffer Length: This is the length of the data buffer,
   336                              <1> 	;	  in number of samples. The controller uses this data
   337                              <1> 	;	  to determine the length of the buffer, in bytes.
   338                              <1> 	;	  "0" indicates no sample to process.
   339                              <1> 
   340                              <1> ; ICH2AC97.INC
   341                              <1> 
   342                              <1> ;	IOC	equ     BIT31   ; Fire an interrupt whenever this
   343                              <1> 				; buffer is complete.
   344                              <1> 
   345                              <1> ;	BUP	equ     BIT30   ; Buffer Underrun Policy.
   346                              <1> 				; if this buffer is the last buffer
   347                              <1> 				; in a playback, fill the remaining
   348                              <1> 				; samples with 0 (silence) or not.
   349                              <1> 				; It's a good idea to set this to 1
   350                              <1> 				; for the last buffer in playback,
   351                              <1> 				; otherwise you're likely to get a lot
   352                              <1> 				; of noise at the end of the sound.
   353                              <1> ;
   354                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   355                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   356                              <1> ; Luckily for us, that's the same format as .wav files.
   357                              <1> ;
   358                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   359                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   360                              <1> ;
   361                              <1> ; A value of 0 in these bits means play no samples.
   362                              <1> ;
   363                              <1> 
   364                              <1> ; ICHWAV.ASM
   365                              <1> 
   366                              <1> 	;mov	eax, BUFFERSIZE / 2 ; size of half buffer (32K)
   367                              <1> 	; 13/11/2023
   368 00000672 66A1[4906]          <1> 	mov	eax, [buffersize]
   369                              <1> 
   370                              <1> 	; 09/11/2023
   371 00000676 660D000000C0        <1> 	or	eax, IOC + BUP
   372                              <1> 	; 06/11/2023
   373                              <1> 	;or	eax, BUP
   374 0000067C 66AB                <1> 	stosd
   375                              <1> 
   376                              <1> ; 2nd buffer:
   377                              <1> 
   378 0000067E 660FB706[B817]      <1>         movzx   eax, word [WAV_BUFFER2]
   379 00000684 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   380 00000688 66AB                <1>         stosd                                   ; store pointer to wavbuffer2
   381                              <1> 
   382                              <1> ; set length to 64k (32k of two 16 bit samples)
   383                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples
   384                              <1> ; 
   385                              <1> 	;mov	eax, BUFFERSIZE / 2
   386                              <1> 	; 13/11/2023
   387 0000068A 66A1[4906]          <1> 	mov	eax, [buffersize]
   388                              <1> 
   389                              <1> 	; 09/11/2023
   390 0000068E 660D000000C0        <1> 	or	eax, IOC + BUP
   391                              <1> 	; 06/11/2023
   392                              <1> 	;or	eax, BUP
   393 00000694 66AB                <1> 	stosd
   394                              <1> 
   395 00000696 E2CE                <1>         loop    _0
   396 00000698 07                  <1>         pop     es
   397                              <1> 
   398                              <1> ;
   399                              <1> ; tell the DMA engine where to find our list of Buffer Descriptors.
   400                              <1> ; this 32bit value is a flat mode memory offset (ie no segment:offset)
   401                              <1> ;
   402                              <1> ; write NABMBAR+10h with offset of buffer descriptor list
   403                              <1> ;
   404 00000699 660FB706[B417]      <1>         movzx   eax, word [BDL_BUFFER]
   405 0000069F 66C1E004            <1> 	shl     eax, 4                          ; convert seg:off to 0:off
   406 000006A3 8B16[B217]          <1>         mov     dx, [NABMBAR]
   407 000006A7 83C210              <1>         add     dx, PO_BDBAR_REG                ; set pointer to BDL
   408 000006AA 66EF                <1>         out     dx, eax                         ; write to AC97 controller
   409                              <1> 
   410                              <1> ;
   411                              <1> ; All set. Let's play some music.
   412                              <1> ;
   413                              <1> 
   414                              <1> 	; 10/11/2023
   415                              <1> 	; 08/11/2023
   416                              <1> 	; 07/11/2023
   417                              <1> 	; 08/12/2016
   418                              <1> 	; 07/10/2016
   419                              <1> 	;mov	al, 1
   420 000006AC B01F                <1> 	mov	al, 31
   421 000006AE A2[CA17]            <1> 	mov	[LVI], al ; 10/11/2023
   422 000006B1 E87F01              <1> 	call	setLastValidIndex
   423                              <1> 
   424                              <1> 	; 06/11/2023 (not neccessary)
   425                              <1> 	;; 05/11/2023
   426                              <1> 	;; reset current index
   427                              <1> 	;mov	al, 0
   428                              <1> 	;call	setCurrentIndex
   429                              <1> 
   430                              <1> 	; 06/11/2023
   431                              <1> 	;mov	byte [tLoop], 1 ; 30/11/2016
   432                              <1> 
   433                              <1> 	; 17/02/2017
   434 000006B4 8B16[B217]          <1>         mov     dx, [NABMBAR]
   435 000006B8 83C21B              <1>         add     dx, PO_CR_REG                   ; PCM out Control Register
   436                              <1>         ; 09/11/2023
   437 000006BB B011                <1> 	mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
   438                              <1> 	;			; (LVBI interrupt will not be enabled)
   439                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   440                              <1> 	;mov	al, RPBM
   441 000006BD EE                  <1> 	out     dx, al                          ; Start bus master operation.
   442                              <1> 
   443                              <1> 	; 09/11/2023
   444 000006BE C606[C917]3F        <1> 	mov	byte [b_indicator], '?'	
   445                              <1> 
   446                              <1> 	; 06/11/2023
   447                              <1> 	;call	delay1_4ms
   448                              <1> 	;call	delay1_4ms
   449                              <1> 	;call	delay1_4ms
   450                              <1> 	;call	delay1_4ms
   451                              <1> 
   452                              <1> 	; 10/11/2023
   453                              <1> 	;mov	byte [tloop], 1
   454                              <1> 
   455                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   456                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   457                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   458                              <1> 
   459                              <1> ; 09/11/2023   
   460                              <1> ; 06/11/2023
   461                              <1> %if 1
   462                              <1> 	; 08/12/2016
   463                              <1> 	; 28/11/2016
   464                              <1> p_loop:
   465 000006C3 E87601              <1> 	call    check4keyboardstop ; keyboard halt?
   466 000006C6 732A                <1>         jnc	short r_loop 	   ; no ; 09/11/2023
   467                              <1> 
   468                              <1> 	; 09/11/2023
   469                              <1> 	;or	byte [flags], ENDOFFILE
   470                              <1> 	;mov	byte [b_indicator], '0'
   471                              <1> q_loop:
   472                              <1> 	;mov	al, '0'
   473 000006C8 E88D00              <1> 	call	tL0
   474                              <1> 
   475                              <1> 	; 04/11/2023
   476                              <1> 	; finished with song, stop everything
   477 000006CB E89E0E              <1> 	call	ac97_stop
   478                              <1> 
   479                              <1> 	; 11/11/2023
   480                              <1> irq_restore:	
   481                              <1> 	; restore previous interrupt vector and interrupt_status
   482 000006CE FA                  <1> 	cli
   483 000006CF E4A1                <1> 	in	al, 0A1h ; irq 8-15
   484 000006D1 A0[AB17]            <1> 	mov	al, [IRQ_status+1]
   485 000006D4 E6A1                <1> 	out	0A1h, al 
   486 000006D6 E421                <1> 	in	al, 021h ; irq 0-7
   487 000006D8 A0[AA17]            <1> 	mov	al, [IRQ_status]
   488 000006DB E621                <1> 	out	21h, al 
   489                              <1> 	; ...
   490 000006DD 06                  <1> 	push	es
   491 000006DE 31C0                <1> 	xor	ax, ax
   492 000006E0 8EC0                <1> 	mov	es, ax
   493 000006E2 A1[AC17]            <1> 	mov	ax, [IRQ_vector]
   494 000006E5 268907              <1> 	mov	[es:bx], ax
   495 000006E8 A1[AE17]            <1> 	mov	ax, [IRQ_vector+2]
   496 000006EB 26894702            <1> 	mov	[es:bx+2], ax
   497 000006EF 07                  <1> 	pop	es
   498 000006F0 FB                  <1> 	sti
   499 000006F1 C3                  <1> 	retn
   500                              <1> 
   501                              <1> r_loop:
   502                              <1> 	; 10/11/2023
   503                              <1> 	;nop
   504                              <1> 	;nop
   505                              <1> 	;nop
   506                              <1> 
   507                              <1> 	; 11/11/2023	
   508 000006F2 B030                <1> 	mov	al, '0'
   509 000006F4 803E[A917]00        <1> 	cmp	byte [tloop], 0
   510 000006F9 74C8                <1> 	je	short p_loop
   511 000006FB 7CCB                <1> 	jl	short q_loop
   512                              <1> 
   513 000006FD FE0E[A917]          <1> 	dec	byte [tloop] ; 0
   514                              <1> 
   515 00000701 803E[C917]31        <1> 	cmp	byte [b_indicator], '1'
   516 00000706 7515                <1> 	jne	short s_loop
   517                              <1> 
   518                              <1> 	; load buffer 1
   519 00000708 A1[B617]            <1> 	mov	ax, [WAV_BUFFER1]
   520                              <1> u_loop:
   521                              <1> 	;call	loadFromFile
   522                              <1> 	; 13/11/2023
   523 0000070B FF16[4506]          <1> 	call	[loadfromwavfile]
   524 0000070F 7304                <1> 	jnc	short v_loop
   525 00000711 B030                <1> 	mov	al, '0'
   526 00000713 EBB3                <1> 	jmp	short q_loop
   527                              <1> v_loop:
   528                              <1> 	; 09/11/2023 - Erdogan Tan
   529                              <1> 	; (print buffer number on top left of the screen)
   530 00000715 A0[C917]            <1> 	mov	al, [b_indicator]
   531 00000718 E83D00              <1> 	call	tL0
   532 0000071B EBA6                <1> 	jmp	short p_loop
   533                              <1> s_loop:
   534                              <1> 	; load buffer 2
   535 0000071D A1[B817]            <1> 	mov	ax, [WAV_BUFFER2]
   536 00000720 EBE9                <1> 	jmp	short u_loop
   537                              <1> 
   538                              <1> %endif
   539                              <1> 
   540                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   541                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   542                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   543                              <1> 
   544                              <1> ; 11/11/2023
   545                              <1> ; 10/11/2023
   546                              <1> ; 09/11/2023
   547                              <1> ; 08/11/2023
   548                              <1> ; 07/11/2023
   549                              <1> %if 1
   550                              <1> 
   551                              <1> tuneLoop:
   552                              <1> 	; 11/11/2023
   553                              <1> 	; 10/11/2023
   554                              <1> 	; 09/11/2023
   555                              <1> 	; 08/11/2023
   556                              <1> 	; 06/11/2023
   557                              <1> 	;mov	al, '1'
   558                              <1> 	;call	tL0
   559                              <1> tL1:
   560                              <1> 	; 10/11/2023
   561                              <1> 	;mov	byte [tloop], 1
   562                              <1> 
   563                              <1> 	; 11/11/2023
   564                              <1> 	;call    updateLVI	; set LVI != CIV
   565                              <1> 	;jz	short tL4	
   566                              <1> 
   567                              <1> 	; 11/11/2023
   568 00000722 C606[A917]01        <1> 	mov	byte [tloop], 1
   569                              <1> 
   570 00000727 E80001              <1> 	call    getCurrentIndex
   571                              <1> 
   572                              <1> 	; 10/11/2023
   573 0000072A 3A06[CA17]          <1> 	cmp	al, [LVI]
   574 0000072E 7511                <1> 	jne	short tL2
   575                              <1> 
   576 00000730 F606[A617]01        <1> 	test	byte [flags], ENDOFFILE
   577                              <1> 	;jnz	short tL2
   578 00000735 751A                <1> 	jnz	short tL4
   579                              <1> 
   580 00000737 48                  <1> 	dec	ax
   581 00000738 241F                <1> 	and	al, 1Fh 
   582 0000073A E8F600              <1> 	call	setLastValidIndex	
   583 0000073D 8606[CA17]          <1> 	xchg	al, [LVI]
   584                              <1> 
   585                              <1> tL2:
   586 00000741 A801                <1> 	test	al, BIT0
   587 00000743 7406                <1> 	jz	short tL3
   588                              <1> 
   589 00000745 C606[C917]31        <1> 	mov	byte [b_indicator], '1'
   590 0000074A C3                  <1> 	retn
   591                              <1> tL3:	
   592 0000074B C606[C917]32        <1> 	mov	byte [b_indicator], '2'
   593 00000750 C3                  <1> 	retn
   594                              <1> tL4:
   595                              <1> 	; 11/11/2023
   596 00000751 C606[A917]FF        <1> 	mov	byte [tloop], -1
   597 00000756 F9                  <1> 	stc
   598 00000757 C3                  <1> 	retn
   599                              <1> 
   600                              <1> 
   601                              <1> 	; 06/11/2023
   602                              <1> tL0:
   603                              <1> 	; 08/11/2023
   604                              <1> 	; 05/11/2023
   605                              <1> 	; 17/02/2017 - Buffer switch test (temporary)
   606                              <1> 	; 06/11/2023
   607                              <1> 	; al = buffer indicator ('1', '2' or '0' -stop- )
   608 00000758 1E                  <1> 	push	ds
   609                              <1> 	;push	bx 
   610 00000759 BB00B8              <1> 	mov	bx, 0B800h ; video display page segment
   611 0000075C 8EDB                <1> 	mov	ds, bx
   612 0000075E 29DB                <1> 	sub	bx, bx ; 0
   613 00000760 B44E                <1> 	mov	ah, 4Eh
   614 00000762 8907                <1> 	mov	[bx], ax ; show current play buffer (1, 2)
   615                              <1> 	;pop	bx
   616 00000764 1F                  <1> 	pop	ds
   617 00000765 C3                  <1> 	retn
   618                              <1> 
   619                              <1> %endif
   620                              <1> 
   621                              <1> ; 08/11/2023
   622                              <1> ; 07/11/2023
   623                              <1> %if 0
   624                              <1> 
   625                              <1> tuneLoop:
   626                              <1> 	; 07/11/2023
   627                              <1> 	;mov	dx, NABMBAR
   628                              <1> 	;add	dx, PO_CIV_REG ; 14h
   629                              <1> tL1:
   630                              <1> 	call    updateLVI	; set LVI != CIV
   631                              <1> 	call    check4keyboardstop
   632                              <1> 	jc	short _exit_
   633                              <1> 	call    getCurrentIndex
   634                              <1> 	test	al, BIT0
   635                              <1> 	jz	short tL1	; loop if buffer 2 is not playing
   636                              <1> 
   637                              <1> 	; load buffer 1
   638                              <1> 	mov     ax, [WAV_BUFFER1]
   639                              <1> 	call	loadFromFile
   640                              <1> 	jc	short _exit_	; end of file
   641                              <1> tL2:
   642                              <1> 	call    updateLVI
   643                              <1> 	call    check4keyboardstop
   644                              <1> 	jc	short _exit_
   645                              <1> 	call    getCurrentIndex
   646                              <1> 	test	al, BIT0
   647                              <1> 	jnz	short tL2	; loop if buffer 1 is not playing
   648                              <1> 
   649                              <1> 	; load buffer 2
   650                              <1> 	mov     ax, [WAV_BUFFER2]
   651                              <1> 	call	loadFromFile
   652                              <1> 	jnc	short tuneLoop
   653                              <1> _exit_:
   654                              <1> 	mov	dx, [NABMBAR]		
   655                              <1> 	add	dx, PO_CR_REG	; PCM out Control Register
   656                              <1> 	mov	al, 0
   657                              <1> 	out	dx, al		; stop player
   658                              <1> 	retn
   659                              <1> 
   660                              <1> %endif
   661                              <1> 
   662                              <1> ; load data from file in 32k chunks. Would be nice to load 1 64k chunk,
   663                              <1> ; but in DOS you can only load FFFF bytes at a time.
   664                              <1> ;
   665                              <1> ; entry: ax = segment to load data to
   666                              <1> ; exit: CY set if end of file reached.
   667                              <1> ; note: last file buffer is padded with 0's to avoid pops at the end of song.
   668                              <1> ; assumes file is already open. uses [filehandle]
   669                              <1> 
   670                              <1> ; 07/11/2023
   671                              <1> %if 0
   672                              <1> 
   673                              <1> loadFromFile:
   674                              <1> 	; 07/11/2023
   675                              <1> 	; 06/11/2023
   676                              <1> 	; 17/02/2017
   677                              <1> 	;push	ax
   678                              <1> 	;push	cx
   679                              <1> 	;push	dx
   680                              <1> 	;push	bx
   681                              <1> 
   682                              <1> 	;push	es
   683                              <1> 	;push	ds
   684                              <1> 	
   685                              <1>         test    byte [flags], ENDOFFILE	; have we already read the
   686                              <1> 	;stc				; last of the file?
   687                              <1> 	; 05/11/2023
   688                              <1> 	;jnz	endLFF
   689                              <1> 	jz	short lff_12	; 06/11/2023
   690                              <1> 	; 06/11/2023
   691                              <1> 	;;mov	byte [tLoop], 0
   692                              <1> 	;jmp	endLFF
   693                              <1> 	stc
   694                              <1> 	retn
   695                              <1> 
   696                              <1> lff_12:	; 06/11/2023    
   697                              <1> 	mov	[fbs_seg], ax ; save buffer segment
   698                              <1> 	xor	dx, dx
   699                              <1> lff_0:
   700                              <1> 	mov	[fbs_off], dx ; buffer offset
   701                              <1> 
   702                              <1> 	mov     bx, (BUFFERSIZE / 2)	; 32k chunk
   703                              <1> 	mov	cl, [fbs_shift]   
   704                              <1> 	and	cl, cl
   705                              <1> 	jz	short lff_1 ; stereo, 16 bit	
   706                              <1> 
   707                              <1> 	; fbs_shift =
   708                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   709                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   710                              <1> 	shr	bx, cl ; 32K / multiplier
   711                              <1> 
   712                              <1> 	mov	ax, cs
   713                              <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   714                              <1> lff_1:
   715                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   716                              <1> 	; load file into memory
   717                              <1>         mov	cx, bx                         
   718                              <1> 	mov	bx, [filehandle]
   719                              <1> 	mov     ds, ax
   720                              <1>        	mov	ah, 3fh
   721                              <1> 	int	21h
   722                              <1> 
   723                              <1> 	mov	bx, cs
   724                              <1> 	mov	ds, bx
   725                              <1> 
   726                              <1> 	jc	short lff_9 ; error !
   727                              <1> 
   728                              <1> 	and	ax, ax
   729                              <1> 	jz	short lff_10
   730                              <1> 	
   731                              <1> 	mov	bl, [fbs_shift] ; shift count  
   732                              <1> 	or	bl, bl
   733                              <1> 	jz	short lff_7 ; 16 bit stereo samples
   734                              <1> 
   735                              <1> 	push	es
   736                              <1> 	; 06/11/2023
   737                              <1> 	;push	di
   738                              <1> 	;push	si
   739                              <1> 	mov	di, [fbs_off]
   740                              <1> 	mov	si, [fbs_seg] ; buffer segment
   741                              <1> 	mov	es, si
   742                              <1> 	mov	si, temp_buffer ; temporary buffer address
   743                              <1> 	mov	cl, [bps] ; bits per sample (8 or 16)
   744                              <1> 	cmp	cl, 8
   745                              <1> 	jne	short lff_4 ; 16 bit samples
   746                              <1> 	; 8 bit samples
   747                              <1> 	mov	cx, ax ; byte count
   748                              <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   749                              <1> 	jz	short lff_3 ; 8 bit, stereo
   750                              <1> lff_2:
   751                              <1> 	; mono & 8 bit
   752                              <1> 	lodsb
   753                              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   754                              <1> 	stosw	; left channel
   755                              <1> 	stosw	; right channel
   756                              <1> 	loop	lff_2
   757                              <1> 	jmp	short lff_6	
   758                              <1> lff_3:
   759                              <1> 	; stereo & 8 bit
   760                              <1> 	lodsb
   761                              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   762                              <1> 	stosw
   763                              <1> 	loop	lff_3			
   764                              <1> 	jmp	short lff_6
   765                              <1> lff_4:
   766                              <1> 	; 16 bit mono samples
   767                              <1> 	mov	cx, ax ; word count
   768                              <1> lff_5:	
   769                              <1> 	lodsw
   770                              <1> 	stosw	; left channel
   771                              <1> 	stosw	; right channel
   772                              <1> 	loop	lff_5
   773                              <1> lff_6:
   774                              <1> 	mov	ax, di ; save next buffer offset/position
   775                              <1> 	; 06/11/2023
   776                              <1> 	;pop	si
   777                              <1> 	;pop	di
   778                              <1> 	pop	es
   779                              <1> ;lff_7:        
   780                              <1> 	; 06/11/2023
   781                              <1> 	and	ax, ax
   782                              <1> 	jz	short endLFF ; end of 2nd half
   783                              <1> 	mov	cx, (BUFFERSIZE / 2)
   784                              <1> lff_7:
   785                              <1> 	cmp	ax, cx
   786                              <1> 	je	short endLFF	 ; 06/11/2023
   787                              <1> 	;jb	short lff_11
   788                              <1> 	;xor	cx, cx
   789                              <1> 	;sub	cx, ax
   790                              <1> 	;neg	cx
   791                              <1> 	jmp	short lff_11
   792                              <1> lff_8:
   793                              <1> 	; 07/11/2023
   794                              <1> 	cmp	word [fbs_off], (BUFFERSIZE / 2) ; 32768
   795                              <1> 	jnb	short endLFF
   796                              <1> 	
   797                              <1> 	mov	dx, ax ; buffer offset
   798                              <1> 	mov	ax, [fbs_seg] ; buffer segment
   799                              <1> 	jmp	lff_0
   800                              <1> lff_9:  
   801                              <1> 	; 07/11/2023
   802                              <1> 	;; 06/11/2023 (temporary)
   803                              <1> 	;mov	al, '!'  ; error
   804                              <1> 	;call	tL0
   805                              <1> 
   806                              <1> 	xor	ax, ax
   807                              <1> lff_10:
   808                              <1> 	; 07/11/2023
   809                              <1> 	;mov	cx, (BUFFERSIZE / 2)  
   810                              <1> lff_11:
   811                              <1> 	call    padfill				; blank pad the remainder
   812                              <1>         ;clc					; don't exit with CY yet.
   813                              <1>         or	byte [flags], ENDOFFILE		; end of file flag
   814                              <1> endLFF:
   815                              <1>         ;pop	ds
   816                              <1> 	;pop	es
   817                              <1> 	; 06/11/2023
   818                              <1> 	;pop	bx
   819                              <1> 	;pop	dx
   820                              <1>         ;pop	cx
   821                              <1>         ;pop	ax
   822                              <1>         retn
   823                              <1> 
   824                              <1> %endif
   825                              <1> 
   826                              <1> ; 08/11/2023
   827                              <1> ; 07/11/2023
   828                              <1> %if 1
   829                              <1> 
   830                              <1> loadFromFile:
   831                              <1> 	; 07/11/2023
   832                              <1> 
   833 00000766 F606[A617]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
   834                              <1> 					; last of the file?
   835 0000076B 7402                <1> 	jz	short lff_0		; no
   836 0000076D F9                  <1> 	stc
   837 0000076E C3                  <1> 	retn
   838                              <1> 
   839                              <1> lff_0:
   840                              <1> 	; 08/11/2023
   841 0000076F 89C5                <1> 	mov	bp, ax ; save buffer segment	
   842                              <1> 
   843 00000771 8A0E[C817]          <1> 	mov	cl, [fbs_shift]   
   844 00000775 20C9                <1> 	and	cl, cl
   845 00000777 7470                <1> 	jz	short lff_1 ; stereo, 16 bit	
   846                              <1> 
   847 00000779 BFFFFF              <1> 	mov	di, BUFFERSIZE - 1 ; 65535
   848                              <1> 
   849                              <1> 	; fbs_shift =
   850                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   851                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   852 0000077C D3EF                <1> 	shr	di, cl
   853 0000077E 47                  <1> 	inc	di ; 16384 for 8 bit and mono	
   854                              <1> 		   ; 32768 for 8 bit or mono	
   855                              <1> 
   856 0000077F 8CC8                <1> 	mov	ax, cs
   857 00000781 BA[CC17]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   858                              <1> 
   859                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   860                              <1> 	; load file into memory
   861 00000784 89F9                <1>         mov	cx, di                       
   862 00000786 8B1E[A417]          <1> 	mov	bx, [filehandle]
   863 0000078A 8ED8                <1> 	mov     ds, ax
   864 0000078C B43F                <1>        	mov	ah, 3Fh
   865 0000078E CD21                <1> 	int	21h
   866                              <1> 
   867 00000790 8CCB                <1> 	mov	bx, cs
   868 00000792 8EDB                <1> 	mov	ds, bx
   869                              <1> 
   870 00000794 724A                <1> 	jc	short lff_4 ; error !
   871                              <1> 
   872                              <1> 	; 08/11/2023
   873 00000796 31D2                <1> 	xor	dx, dx ; 0
   874                              <1> 
   875 00000798 21C0                <1> 	and	ax, ax
   876 0000079A 7476                <1> 	jz	short lff_3
   877                              <1> 
   878 0000079C 8A1E[C817]          <1> 	mov	bl, [fbs_shift]
   879                              <1> 
   880 000007A0 06                  <1> 	push	es
   881 000007A1 89D7                <1> 	mov	di, dx ; 0 ; [fbs_off]
   882                              <1> 	;mov	bp, [fbs_seg] ; buffer segment
   883 000007A3 8EC5                <1> 	mov	es, bp
   884 000007A5 BE[CC17]            <1> 	mov	si, temp_buffer ; temporary buffer address
   885 000007A8 89C1                <1> 	mov	cx, ax ; byte count
   886 000007AA 803E[C617]08        <1> 	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   887 000007AF 751B                <1> 	jne	short lff_7 ; 16 bit samples
   888                              <1> 	; 8 bit samples
   889 000007B1 FECB                <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   890 000007B3 740C                <1> 	jz	short lff_6 ; 8 bit, stereo
   891                              <1> lff_5:
   892                              <1> 	; mono & 8 bit
   893 000007B5 AC                  <1> 	lodsb
   894 000007B6 2C80                <1> 	sub	al, 80h ; 08/11/2023
   895 000007B8 C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   896 000007BB AB                  <1> 	stosw	; left channel
   897 000007BC AB                  <1> 	stosw	; right channel
   898 000007BD E2F6                <1> 	loop	lff_5
   899 000007BF EB12                <1> 	jmp	short lff_9	
   900                              <1> lff_6:
   901                              <1> 	; stereo & 8 bit
   902 000007C1 AC                  <1> 	lodsb
   903 000007C2 2C80                <1> 	sub	al, 80h ; 08/11/2023
   904 000007C4 C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   905 000007C7 AB                  <1> 	stosw
   906 000007C8 E2F7                <1> 	loop	lff_6			
   907 000007CA EB07                <1> 	jmp	short lff_9
   908                              <1> lff_7:
   909 000007CC D1E9                <1> 	shr	cx, 1 ; word count
   910                              <1> lff_8:
   911 000007CE AD                  <1> 	lodsw
   912 000007CF AB                  <1> 	stosw	; left channel
   913 000007D0 AB                  <1> 	stosw	; right channel
   914 000007D1 E2FB                <1> 	loop	lff_8
   915                              <1> lff_9:
   916 000007D3 07                  <1> 	pop	es
   917 000007D4 09FF                <1> 	or	di, di
   918 000007D6 7442                <1> 	jz	short endLFF ; 64KB ok 
   919                              <1> 	
   920 000007D8 89F8                <1> 	mov	ax, di ; [fbs_off]
   921 000007DA 48                  <1> 	dec	ax
   922 000007DB B9FFFF              <1> 	mov	cx, BUFFERSIZE - 1 ; 65535
   923 000007DE EB32                <1> 	jmp	short lff_3
   924                              <1> 
   925                              <1> lff_4:
   926                              <1> 	; 08/11/2023
   927 000007E0 B021                <1> 	mov	al, '!'  ; error
   928 000007E2 E873FF              <1> 	call	tL0
   929                              <1> 
   930 000007E5 31C0                <1> 	xor	ax, ax
   931 000007E7 EB29                <1> 	jmp	short lff_3
   932                              <1> 	
   933                              <1> lff_1:  
   934                              <1> 	;mov	bp, ax ; save buffer segment
   935 000007E9 31D2                <1> 	xor	dx, dx
   936                              <1> 	; load file into memory
   937 000007EB B90080              <1>         mov	cx, (BUFFERSIZE / 2)	; 32k chunk
   938 000007EE 8B1E[A417]          <1> 	mov	bx, [filehandle]
   939 000007F2 8ED8                <1> 	mov     ds, ax
   940 000007F4 B43F                <1>        	mov	ah, 3Fh
   941 000007F6 CD21                <1> 	int	21h
   942                              <1> 
   943 000007F8 8CCF                <1> 	mov	di, cs
   944 000007FA 8EDF                <1> 	mov	ds, di
   945                              <1> 
   946                              <1> 	; 07/11/2023
   947 000007FC 72E2                <1> 	jc	short lff_4 ; error !
   948                              <1> 	
   949 000007FE 39C8                <1> 	cmp	ax, cx
   950 00000800 7510                <1> 	jne	short lff_3
   951                              <1> lff_2:
   952                              <1> 	; 08/11/2023
   953 00000802 01C2                <1> 	add	dx, ax
   954                              <1> 	;mov	cx, (BUFFERSIZE / 2)	; 32k chunk
   955                              <1> 	;mov	bx, [filehandle]
   956 00000804 8EDD                <1> 	mov     ds, bp
   957 00000806 B43F                <1>        	mov	ah, 3Fh
   958 00000808 CD21                <1> 	int	21h
   959                              <1> 
   960                              <1> 	;mov	di, cs
   961 0000080A 8EDF                <1> 	mov	ds, di
   962                              <1> 
   963 0000080C 72D2                <1> 	jc	short lff_4 ; error !
   964                              <1> 
   965 0000080E 39C8                <1> 	cmp	ax, cx
   966 00000810 7408                <1> 	je	short endLFF
   967                              <1> lff_3:
   968 00000812 E80600              <1> 	call    padfill			; blank pad the remainder
   969                              <1>         ;clc				; don't exit with CY yet.
   970 00000815 800E[A617]01        <1>         or	byte [flags], ENDOFFILE	; end of file flag
   971                              <1> endLFF:
   972 0000081A C3                  <1>         retn
   973                              <1> 
   974                              <1> %endif
   975                              <1> 
   976                              <1> ; entry ds:ax points to last byte in file
   977                              <1> ; cx=target size
   978                              <1> ; note: must do byte size fill
   979                              <1> ; destroys bx, cx
   980                              <1> ;
   981                              <1> padfill:
   982                              <1> 	; 07/11/2023
   983                              <1> 	; 06/11/2023
   984                              <1> 	; 17/02/2017
   985 0000081B 06                  <1> 	push	es
   986                              <1>         ;push	di
   987                              <1> 	;mov	di, [fbs_seg]
   988                              <1> 	;mov	es, di
   989 0000081C 8EC5                <1>         mov	es, bp
   990 0000081E 29C1                <1> 	sub	cx, ax
   991                              <1> 	; 08/11/2023
   992                              <1> 	;mov	di, ax ; (wrong)
   993 00000820 89D7                <1> 	mov	di, dx ; buffer offset
   994 00000822 01C7                <1> 	add	di, ax       	
   995                              <1> 	; 07/11/2023
   996                              <1> 	;add	di, [fbs_off]
   997 00000824 30C0                <1>         xor	al, al
   998 00000826 F3AA                <1> 	rep	stosb
   999                              <1> 	;mov	[fbs_off], di
  1000                              <1> 	;pop	di
  1001 00000828 07                  <1>         pop	es
  1002 00000829 C3                  <1> 	retn
  1003                              <1> 
  1004                              <1> ; returns AL = current index value
  1005                              <1> getCurrentIndex:
  1006                              <1> 	; 08/11/2023
  1007                              <1> 	;push	dx
  1008 0000082A 8B16[B217]          <1> 	mov	dx, [NABMBAR]      		
  1009 0000082E 83C214              <1> 	add	dx, PO_CIV_REG
  1010 00000831 EC                  <1> 	in	al, dx
  1011                              <1> 	;pop	dx
  1012                              <1> uLVI2:	;	06/11/2023
  1013 00000832 C3                  <1> 	retn
  1014                              <1> 
  1015                              <1> ; examines the CIV and the LVI. When they're the same, we set LVI <> CIV
  1016                              <1> ; that way, we never run out of buffers to play
  1017                              <1> 
  1018                              <1> ; 08/11/2023
  1019                              <1> %if 0
  1020                              <1> 	; 07/11/2023
  1021                              <1> updateLVI:
  1022                              <1> 	push	ax
  1023                              <1> 	push	dx
  1024                              <1> 	; 06/11/2023
  1025                              <1> 	mov	dx, [NABMBAR]
  1026                              <1> 	add	dx, PO_CIV_REG
  1027                              <1> 	; (Current Index Value and Last Valid Index value)
  1028                              <1> 	in	ax, dx
  1029                              <1> 
  1030                              <1> 	cmp	al, ah ; is current index = last index ?
  1031                              <1> 	jne	short uLVI1
  1032                              <1> 
  1033                              <1> 	call	setNewIndex
  1034                              <1> uLVI1:
  1035                              <1> 	pop	dx
  1036                              <1> 	pop	ax
  1037                              <1> 	retn
  1038                              <1> 
  1039                              <1> setNewIndex:
  1040                              <1> 	; 07/11/2023
  1041                              <1> 	push	ax
  1042                              <1>         call    getCurrentIndex                 ; get CIV
  1043                              <1>         test    byte [flags], ENDOFFILE
  1044                              <1>         jnz     short sni_1
  1045                              <1>         ; not at the end of the file yet.
  1046                              <1>         dec     al                              ; make new index <> current
  1047                              <1>         and     al, INDEX_MASK                  ; make sure new value is 0-31
  1048                              <1> sni_1:
  1049                              <1>         call    setLastValidIndex               ; write new value
  1050                              <1>         clc
  1051                              <1>         pop	ax
  1052                              <1> 	retn
  1053                              <1> 
  1054                              <1> %endif	
  1055                              <1> 
  1056                              <1> ; 08/11/2023
  1057                              <1> ; 07/11/2023
  1058                              <1> %if 0
  1059                              <1> updateLVI:
  1060                              <1> 	; 06/11/2023
  1061                              <1> 	mov	dx, [NABMBAR]      		
  1062                              <1> 	add	dx, PO_CIV_REG
  1063                              <1> 	; (Current Index Value and Last Valid Index value)
  1064                              <1> 	in	ax, dx
  1065                              <1> 
  1066                              <1> 	cmp	al, ah ; is current index = last index ?
  1067                              <1> 	jne	short uLVI2
  1068                              <1> 
  1069                              <1> 	; 10/11/2023
  1070                              <1> 	; 08/11/2023	
  1071                              <1> 	call	getCurrentIndex
  1072                              <1>  
  1073                              <1> 	test	byte [flags], ENDOFFILE
  1074                              <1> 	;jnz	short uLVI1
  1075                              <1> 	jz	short uLVI0  ; 08/11/2023
  1076                              <1> 
  1077                              <1> 	; 08/11/2023
  1078                              <1> 	push	ax
  1079                              <1> 	mov	dx, [NABMBAR]
  1080                              <1> 	add	dx, PO_SR_REG  ; PCM out status register
  1081                              <1> 	in	ax, dx
  1082                              <1> 
  1083                              <1> 	;test	al, 2
  1084                              <1> 	test	al, 3 ; bit 1 = Current Equals Last Valid (CELV)
  1085                              <1> 		      ; (has been processed)
  1086                              <1> 		      ; bit 0 = 1 -> DMA Controller Halted (DCH)
  1087                              <1> 	pop	ax
  1088                              <1> 	jz	short uLVI1
  1089                              <1> uLVI3:
  1090                              <1> 	xor	ax, ax
  1091                              <1> 	; zf = 1
  1092                              <1> 	retn
  1093                              <1> uLVI0:
  1094                              <1>         ; not at the end of the file yet.
  1095                              <1> 	dec	al
  1096                              <1> 	and	al, 1Fh
  1097                              <1> uLVI1:
  1098                              <1> 	;call	setLastValidIndex
  1099                              <1> ;uLVI2:
  1100                              <1> 	;retn
  1101                              <1> 
  1102                              <1> %endif
  1103                              <1> 	
  1104                              <1> ;input AL = index # to stop on
  1105                              <1> setLastValidIndex:
  1106                              <1> 	; 08/11/2023
  1107                              <1> 	;push	dx
  1108 00000833 8B16[B217]          <1> 	mov	dx, [NABMBAR]
  1109 00000837 83C215              <1> 	add	dx, PO_LVI_REG
  1110 0000083A EE                  <1>         out     dx, al
  1111                              <1> 	;pop	dx
  1112 0000083B C3                  <1> 	retn
  1113                              <1> 
  1114                              <1> ; 06/11/2023
  1115                              <1> ;	; 05/11/2023
  1116                              <1> ;setCurrentIndex:
  1117                              <1> ;	;push	dx
  1118                              <1> ;	mov	dx, [NABMBAR]
  1119                              <1> ;	add	dx, PO_CIV_REG
  1120                              <1> ;	out	dx, al
  1121                              <1> ;	;pop	dx
  1122                              <1> ;	retn
  1123                              <1> 
  1124                              <1> ; checks if either shift key has been pressed. Exits with CY if so.
  1125                              <1> ; 
  1126                              <1> check4keyboardstop:
  1127                              <1> 
  1128                              <1> ; 06/11/2023
  1129                              <1> %if 1
  1130                              <1> 	; 08/11/2023
  1131                              <1> 	; 04/11/2023
  1132 0000083C B401                <1> 	mov	ah, 1
  1133 0000083E CD16                <1> 	int	16h
  1134 00000840 F8                  <1> 	clc
  1135 00000841 7405                <1> 	jz	short _cksr
  1136 00000843 30E4                <1> 	xor	ah, ah
  1137 00000845 CD16                <1> 	int	16h
  1138 00000847 F9                  <1> 	stc
  1139                              <1> _cksr:
  1140 00000848 C3                  <1> 	retn
  1141                              <1> %endif
  1142                              <1> 
  1143                              <1> ; 06/11/2023
  1144                              <1> ; 04/11/2023
  1145                              <1> %if 0	
  1146                              <1>         push    ds
  1147                              <1>         push    0
  1148                              <1>         pop     ds		       ; examine BDA for keyboard flags
  1149                              <1>         test    byte [417h], (BIT0 | BIT1)
  1150                              <1>         pop     ds
  1151                              <1>         stc
  1152                              <1>         jnz	short _cksr ; 07/11/2023
  1153                              <1> 	;jz	short _cksr ; 06/11/2023
  1154                              <1>         clc
  1155                              <1> _cksr:
  1156                              <1>         retn
  1157                              <1> %endif
  1158                              <1> 
  1159                              <1> ; 15/11/2023
  1160                              <1> ; 14/11/2023
  1161                              <1> ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  1162                              <1> ; --------------------------------------------------------
  1163                              <1> 
  1164                              <1> ;;Note:	At the end of every buffer load,
  1165                              <1> ;;	during buffer switch/swap, there will be discontinuity
  1166                              <1> ;;	between the last converted sample and the 1st sample
  1167                              <1> ;;	of the next buffer.
  1168                              <1> ;;	(like as a dot noises vaguely between normal sound samples)
  1169                              <1> ;;	-To avoid this defect, the 1st sample of
  1170                              <1> ;;	the next buffer may be read from the wav file but
  1171                              <1> ;;	the file pointer would need to be set to 1 sample back
  1172                              <1> ;;	again via seek system call. Time comsumption problem! -
  1173                              <1> ;;
  1174                              <1> ;;	Erdogan Tan - 15/11/2023
  1175                              <1> ;;
  1176                              <1> ;;	((If entire wav data would be loaded at once.. conversion
  1177                              <1> ;;	defect/noise would disappear.. but for DOS, to keep
  1178                              <1> ;;	64KB buffer limit is important also it is important
  1179                              <1> ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  1180                              <1> ;;	I have tested this program by using 2-30MB wav files.))
  1181                              <1> ;;
  1182                              <1> ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  1183                              <1> ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  1184                              <1> ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  1185                              <1> ;;			Realtek ALC850 codec.
  1186                              <1> ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  1187                              <1> 
  1188                              <1> load_8khz_mono_8_bit:
  1189                              <1> 	; 15/11/2023
  1190                              <1> 	; 14/11/2023
  1191                              <1> 	; 13/11/2023
  1192 00000849 F606[A617]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1193                              <1> 					; last of the file?
  1194 0000084E 7402                <1> 	jz	short lff8m_0		; no
  1195 00000850 F9                  <1> 	stc
  1196 00000851 C3                  <1> 	retn
  1197                              <1> 
  1198                              <1> lff8m_0:
  1199 00000852 8EC0                <1> 	mov	es, ax ; buffer segment	
  1200 00000854 31FF                <1> 	xor	di, di
  1201 00000856 BA[CC17]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1202                              <1> 	; ds = cs
  1203                              <1> 
  1204                              <1> 	; load file into memory
  1205 00000859 8B0E[4706]          <1>         mov	cx, [loadsize]
  1206 0000085D 8B1E[A417]          <1> 	mov	bx, [filehandle]
  1207 00000861 B43F                <1>        	mov	ah, 3Fh
  1208 00000863 CD21                <1> 	int	21h
  1209                              <1> 	;jc	short lff8m_5 ; error !
  1210                              <1> 	; 14/11/2023
  1211 00000865 7303                <1> 	jnc	short lff8m_6
  1212 00000867 E98B00              <1> 	jmp	lff8m_5
  1213                              <1> 
  1214                              <1> lff8m_6:
  1215 0000086A 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1216 0000086C 21C0                <1> 	and	ax, ax
  1217                              <1> 	;jz	short lff8m_3
  1218                              <1> 	; 15/11/2023
  1219 0000086E 747E                <1> 	jz	short lff8_eof
  1220                              <1> 
  1221 00000870 89C1                <1> 	mov	cx, ax		; byte count
  1222                              <1> lff8m_1:
  1223 00000872 AC                  <1> 	lodsb
  1224 00000873 A2[4513]            <1> 	mov	[previous_val], al
  1225 00000876 2C80                <1> 	sub	al, 80h
  1226 00000878 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1227 0000087B AB                  <1> 	stosw		; original sample (left channel)
  1228 0000087C AB                  <1> 	stosw		; original sample (right channel)
  1229                              <1> 	;xor	ax, ax
  1230                              <1> 	; 14/11/2023
  1231 0000087D B080                <1> 	mov	al, 80h
  1232 0000087F 49                  <1> 	dec	cx
  1233 00000880 7402                <1> 	jz	short lff8m_2
  1234 00000882 8A04                <1> 	mov	al, [si]
  1235                              <1> lff8m_2:
  1236                              <1> 	;mov	[next_val], ax
  1237 00000884 88C7                <1> 	mov	bh, al	; [next_val]
  1238 00000886 8A26[4513]          <1> 	mov	ah, [previous_val]
  1239 0000088A 00E0                <1> 	add	al, ah	; [previous_val]
  1240 0000088C D0D8                <1> 	rcr	al, 1
  1241 0000088E 88C2                <1> 	mov	dl, al	; this is interpolated middle (3th) sample
  1242 00000890 00E0                <1> 	add	al, ah	; [previous_val]
  1243 00000892 D0D8                <1> 	rcr	al, 1	
  1244 00000894 88C3                <1> 	mov	bl, al 	; this is temporary interpolation value	
  1245 00000896 00E0                <1> 	add	al, ah	; [previous_val]
  1246 00000898 D0D8                <1> 	rcr	al, 1
  1247 0000089A 2C80                <1> 	sub	al, 80h
  1248 0000089C C1E008              <1> 	shl	ax, 8	
  1249 0000089F AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1250 000008A0 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1251 000008A1 88D8                <1> 	mov	al, bl
  1252 000008A3 00D0                <1> 	add	al, dl
  1253 000008A5 D0D8                <1> 	rcr	al, 1
  1254 000008A7 2C80                <1> 	sub	al, 80h
  1255 000008A9 C1E008              <1> 	shl	ax, 8
  1256 000008AC AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1257 000008AD AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1258 000008AE 88D0                <1> 	mov	al, dl
  1259 000008B0 2C80                <1> 	sub	al, 80h
  1260 000008B2 C1E008              <1> 	shl	ax, 8
  1261 000008B5 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1262 000008B6 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1263                              <1> 	;mov	al, [next_val]
  1264 000008B7 88F8                <1> 	mov	al, bh
  1265 000008B9 00D0                <1> 	add	al, dl
  1266 000008BB D0D8                <1> 	rcr	al, 1
  1267 000008BD 88C3                <1> 	mov	bl, al	; this is temporary interpolation value
  1268 000008BF 00D0                <1> 	add	al, dl
  1269 000008C1 D0D8                <1> 	rcr	al, 1
  1270 000008C3 2C80                <1> 	sub	al, 80h
  1271 000008C5 C1E008              <1> 	shl	ax, 8
  1272 000008C8 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1273 000008C9 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1274                              <1> 	;mov	al, [next_val]
  1275 000008CA 88F8                <1> 	mov	al, bh
  1276 000008CC 00D8                <1> 	add	al, bl
  1277 000008CE D0D8                <1> 	rcr	al, 1
  1278 000008D0 2C80                <1> 	sub	al, 80h
  1279 000008D2 C1E008              <1> 	shl	ax, 8
  1280 000008D5 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1281 000008D6 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1282                              <1> 	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1283 000008D7 09C9                <1> 	or	cx, cx
  1284 000008D9 7597                <1> 	jnz	short lff8m_1
  1285                              <1> 
  1286                              <1> 	; --------------
  1287                              <1> 
  1288                              <1> lff8s_3:
  1289                              <1> lff8m_3:
  1290                              <1> lff8s2_3:
  1291                              <1> lff8m2_3:
  1292                              <1> lff16s_3:
  1293                              <1> lff16m_3:
  1294                              <1> lff16s2_3:
  1295                              <1> lff16m2_3:
  1296                              <1> lff24_3:
  1297                              <1> lff32_3:
  1298                              <1> lff44_3:
  1299                              <1> lff22_3:
  1300                              <1> lff11_3:
  1301 000008DB 8B0E[4906]          <1> 	mov	cx, [buffersize] ; 16 bit (48 kHZ, stereo) sample size
  1302 000008DF D1E1                <1> 	shl	cx, 1	; byte count
  1303 000008E1 29F9                <1> 	sub	cx, di
  1304 000008E3 7606                <1> 	jna	short lff8m_4
  1305                              <1> 	;inc	cx
  1306 000008E5 D1E9                <1> 	shr	cx, 1
  1307 000008E7 31C0                <1> 	xor	ax, ax	; fill (remain part of) buffer with zeros	
  1308 000008E9 F3AB                <1> 	rep	stosw
  1309                              <1> lff8m_4:
  1310 000008EB 0E                  <1> 	push	cs
  1311 000008EC 07                  <1> 	pop	es
  1312 000008ED C3                  <1> 	retn
  1313                              <1> 
  1314                              <1> lff8_eof:
  1315                              <1> lff16_eof:
  1316                              <1> lff24_eof:
  1317                              <1> lff32_eof:
  1318                              <1> lff44_eof:
  1319                              <1> lff22_eof:
  1320                              <1> lff11_eof:
  1321                              <1> 	; 15/11/2023
  1322 000008EE C606[A617]01        <1> 	mov	byte [flags], ENDOFFILE
  1323 000008F3 EBE6                <1> 	jmp	short lff8m_3
  1324                              <1> 
  1325                              <1> lff8s_5:
  1326                              <1> lff8m_5:
  1327                              <1> lff8s2_5:
  1328                              <1> lff8m2_5:
  1329                              <1> lff16s_5:
  1330                              <1> lff16m_5:
  1331                              <1> lff16s2_5:
  1332                              <1> lff16m2_5:
  1333                              <1> lff24_5:
  1334                              <1> lff32_5:
  1335                              <1> lff44_5:
  1336                              <1> lff22_5:
  1337                              <1> lff11_5:
  1338 000008F5 B021                <1> 	mov	al, '!'  ; error
  1339 000008F7 E85EFE              <1> 	call	tL0
  1340                              <1> 	
  1341                              <1> 	;jmp	short lff8m_3
  1342                              <1> 	; 15/11/2023
  1343 000008FA EBF2                <1> 	jmp	lff8_eof
  1344                              <1> 
  1345                              <1> 	; --------------
  1346                              <1> 
  1347                              <1> load_8khz_stereo_8_bit:
  1348                              <1> 	; 15/11/2023
  1349                              <1> 	; 14/11/2023
  1350                              <1> 	; 13/11/2023
  1351 000008FC F606[A617]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1352                              <1> 					; last of the file?
  1353 00000901 7402                <1> 	jz	short lff8s_0		; no
  1354 00000903 F9                  <1> 	stc
  1355 00000904 C3                  <1> 	retn
  1356                              <1> 
  1357                              <1> lff8s_0:
  1358 00000905 8EC0                <1> 	mov	es, ax ; buffer segment	
  1359 00000907 31FF                <1> 	xor	di, di
  1360 00000909 BA[CC17]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1361                              <1> 	; ds = cs
  1362                              <1> 
  1363                              <1> 	; load file into memory
  1364 0000090C 8B0E[4706]          <1>         mov	cx, [loadsize]
  1365 00000910 8B1E[A417]          <1> 	mov	bx, [filehandle]
  1366 00000914 B43F                <1>        	mov	ah, 3Fh
  1367 00000916 CD21                <1> 	int	21h
  1368 00000918 72DB                <1> 	jc	short lff8s_5 ; error !
  1369                              <1> 
  1370 0000091A 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1371                              <1> 	
  1372 0000091C D1E8                <1> 	shr	ax, 1
  1373                              <1> 	;;and	ax, ax
  1374                              <1> 	;jz	short lff8s_3
  1375                              <1> 	; 15/11/2023
  1376 0000091E 74CE                <1> 	jz	short lff8_eof
  1377                              <1> 
  1378 00000920 89C1                <1> 	mov	cx, ax		; word count
  1379                              <1> lff8s_1:
  1380 00000922 AC                  <1> 	lodsb
  1381 00000923 A2[4513]            <1> 	mov	[previous_val_l], al
  1382 00000926 2C80                <1> 	sub	al, 80h
  1383 00000928 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1384 0000092B AB                  <1> 	stosw		; original sample (L)
  1385 0000092C AC                  <1> 	lodsb
  1386 0000092D A2[4713]            <1> 	mov	[previous_val_r], al
  1387 00000930 2C80                <1> 	sub	al, 80h
  1388 00000932 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1389 00000935 AB                  <1> 	stosw		; original sample (R)
  1390                              <1> 
  1391                              <1> 	;xor	ax, ax
  1392                              <1> 	; 14/11/2023
  1393 00000936 B88080              <1> 	mov	ax, 8080h
  1394 00000939 49                  <1> 	dec	cx
  1395 0000093A 7402                <1> 	jz	short lff8s_2
  1396                              <1> 		; convert 8 bit sample to 16 bit sample
  1397 0000093C 8B04                <1> 	mov	ax, [si]
  1398                              <1> lff8s_2:
  1399 0000093E A2[4913]            <1> 	mov	[next_val_l], al
  1400 00000941 8826[4B13]          <1> 	mov	[next_val_r], ah
  1401 00000945 8A26[4513]          <1> 	mov	ah, [previous_val_l]
  1402 00000949 00E0                <1> 	add	al, ah
  1403 0000094B D0D8                <1> 	rcr	al, 1
  1404 0000094D 88C2                <1> 	mov	dl, al	; this is interpolated middle (3th) sample (L)
  1405 0000094F 00E0                <1> 	add	al, ah
  1406 00000951 D0D8                <1> 	rcr	al, 1	
  1407 00000953 88C3                <1> 	mov	bl, al	; this is temporary interpolation value (L)
  1408 00000955 00E0                <1> 	add	al, ah
  1409 00000957 D0D8                <1> 	rcr	al, 1
  1410 00000959 2C80                <1> 	sub	al, 80h
  1411 0000095B C1E008              <1> 	shl	ax, 8
  1412 0000095E AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1413 0000095F A0[4B13]            <1> 	mov	al, [next_val_r]
  1414 00000962 8A26[4713]          <1> 	mov	ah, [previous_val_r]
  1415 00000966 00E0                <1> 	add	al, ah
  1416 00000968 D0D8                <1> 	rcr	al, 1
  1417 0000096A 88C6                <1> 	mov	dh, al	; this is interpolated middle (3th) sample (R)
  1418 0000096C 00E0                <1> 	add	al, ah
  1419 0000096E D0D8                <1> 	rcr	al, 1
  1420 00000970 88C7                <1> 	mov	bh, al	; this is temporary interpolation value (R)
  1421 00000972 00E0                <1> 	add	al, ah
  1422 00000974 D0D8                <1> 	rcr	al, 1
  1423 00000976 2C80                <1> 	sub	al, 80h
  1424 00000978 C1E008              <1> 	shl	ax, 8
  1425 0000097B AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1426 0000097C 88D8                <1> 	mov	al, bl
  1427 0000097E 00D0                <1> 	add	al, dl
  1428 00000980 D0D8                <1> 	rcr	al, 1
  1429 00000982 2C80                <1> 	sub	al, 80h
  1430 00000984 C1E008              <1> 	shl	ax, 8
  1431 00000987 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1432 00000988 88F8                <1> 	mov	al, bh
  1433 0000098A 00F0                <1> 	add	al, dh
  1434 0000098C D0D8                <1> 	rcr	al, 1
  1435 0000098E 2C80                <1> 	sub	al, 80h
  1436 00000990 C1E008              <1> 	shl	ax, 8
  1437 00000993 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1438 00000994 88D0                <1> 	mov	al, dl
  1439 00000996 2C80                <1> 	sub	al, 80h
  1440 00000998 C1E008              <1> 	shl	ax, 8
  1441 0000099B AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1442 0000099C 88F0                <1> 	mov	al, dh
  1443 0000099E 2C80                <1> 	sub	al, 80h
  1444 000009A0 C1E008              <1> 	shl	ax, 8
  1445 000009A3 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1446 000009A4 A0[4913]            <1> 	mov	al, [next_val_l]
  1447 000009A7 00D0                <1> 	add	al, dl
  1448 000009A9 D0D8                <1> 	rcr	al, 1
  1449 000009AB 88C3                <1> 	mov	bl, al	; this is temporary interpolation value (L)
  1450 000009AD 00D0                <1> 	add	al, dl
  1451 000009AF D0D8                <1> 	rcr	al, 1
  1452 000009B1 2C80                <1> 	sub	al, 80h
  1453 000009B3 C1E008              <1> 	shl	ax, 8
  1454 000009B6 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1455 000009B7 A0[4B13]            <1> 	mov	al, [next_val_r]
  1456 000009BA 00F0                <1> 	add	al, dh
  1457 000009BC D0D8                <1> 	rcr	al, 1
  1458 000009BE 88C7                <1> 	mov	bh, al	; this is temporary interpolation value (R)
  1459 000009C0 00F0                <1> 	add	al, dh
  1460 000009C2 D0D8                <1> 	rcr	al, 1
  1461 000009C4 2C80                <1> 	sub	al, 80h
  1462 000009C6 C1E008              <1> 	shl	ax, 8
  1463 000009C9 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1464 000009CA A0[4913]            <1> 	mov	al, [next_val_l]
  1465 000009CD 00D8                <1> 	add	al, bl
  1466 000009CF D0D8                <1> 	rcr	al, 1
  1467 000009D1 2C80                <1> 	sub	al, 80h
  1468 000009D3 C1E008              <1> 	shl	ax, 8
  1469 000009D6 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1470 000009D7 A0[4B13]            <1> 	mov	al, [next_val_r]
  1471 000009DA 00F8                <1> 	add	al, bh
  1472 000009DC D0D8                <1> 	rcr	al, 1
  1473 000009DE 2C80                <1> 	sub	al, 80h
  1474 000009E0 C1E008              <1> 	shl	ax, 8
  1475 000009E3 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1476                              <1> 	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1477 000009E4 E303                <1> 	jcxz	lff8s_6
  1478 000009E6 E939FF              <1> 	jmp	lff8s_1
  1479                              <1> lff8s_6:
  1480 000009E9 E9EFFE              <1> 	jmp	lff8s_3
  1481                              <1> 
  1482                              <1> load_8khz_mono_16_bit:
  1483                              <1> 	; 13/11/2023
  1484 000009EC F606[A617]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1485                              <1> 					; last of the file?
  1486 000009F1 7402                <1> 	jz	short lff8m2_0		; no
  1487 000009F3 F9                  <1> 	stc
  1488 000009F4 C3                  <1> 	retn
  1489                              <1> 
  1490                              <1> lff8m2_0:
  1491 000009F5 8EC0                <1> 	mov	es, ax ; buffer segment	
  1492 000009F7 31FF                <1> 	xor	di, di
  1493 000009F9 BA[CC17]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1494                              <1> 	; ds = cs
  1495                              <1> 
  1496                              <1> 	; load file into memory
  1497 000009FC 8B0E[4706]          <1>         mov	cx, [loadsize]
  1498 00000A00 8B1E[A417]          <1> 	mov	bx, [filehandle]
  1499 00000A04 B43F                <1>        	mov	ah, 3Fh
  1500 00000A06 CD21                <1> 	int	21h
  1501 00000A08 7270                <1> 	jc	short lff8m2_7 ; error !
  1502                              <1> 
  1503 00000A0A 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1504                              <1> 	
  1505 00000A0C D1E8                <1> 	shr	ax, 1
  1506                              <1> 	;and	ax, ax
  1507 00000A0E 7503                <1> 	jnz	short lff8m2_8
  1508                              <1> 	;jmp	lff8m2_3
  1509                              <1> 	; 15/11/2023
  1510 00000A10 E9DBFE              <1> 	jmp	lff8_eof
  1511                              <1> 
  1512                              <1> lff8m2_8:
  1513 00000A13 89C1                <1> 	mov	cx, ax		; word count
  1514                              <1> lff8m2_1:
  1515 00000A15 AD                  <1> 	lodsw
  1516 00000A16 AB                  <1> 	stosw		; original sample (left channel)
  1517 00000A17 AB                  <1> 	stosw		; original sample (right channel)
  1518 00000A18 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1519 00000A1B A3[4513]            <1> 	mov	[previous_val], ax
  1520 00000A1E 31C0                <1> 	xor	ax, ax
  1521 00000A20 49                  <1> 	dec	cx
  1522 00000A21 7402                <1> 	jz	short lff8m2_2
  1523 00000A23 8B04                <1> 	mov	ax, [si]
  1524                              <1> lff8m2_2:
  1525 00000A25 80C480              <1> 	add	ah, 80h ; convert sound level to 0-65535 format
  1526 00000A28 89C5                <1> 	mov	bp, ax	; [next_val]
  1527 00000A2A 0306[4513]          <1> 	add	ax, [previous_val]
  1528 00000A2E D1D8                <1> 	rcr	ax, 1
  1529 00000A30 89C2                <1> 	mov	dx, ax	; this is interpolated middle (3th) sample
  1530 00000A32 0306[4513]          <1> 	add	ax, [previous_val]
  1531 00000A36 D1D8                <1> 	rcr	ax, 1	; this is temporary interpolation value
  1532 00000A38 89C3                <1> 	mov	bx, ax 		
  1533 00000A3A 0306[4513]          <1> 	add	ax, [previous_val]
  1534 00000A3E D1D8                <1> 	rcr	ax, 1
  1535 00000A40 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1536 00000A43 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1537 00000A44 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1538 00000A45 89D8                <1> 	mov	ax, bx
  1539 00000A47 01D0                <1> 	add	ax, dx
  1540 00000A49 D1D8                <1> 	rcr	ax, 1
  1541 00000A4B 80EC80              <1> 	sub	ah, 80h
  1542 00000A4E AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1543 00000A4F AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1544 00000A50 89D0                <1> 	mov	ax, dx
  1545 00000A52 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1546 00000A55 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1547 00000A56 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1548 00000A57 89E8                <1> 	mov	ax, bp
  1549 00000A59 01D0                <1> 	add	ax, dx
  1550 00000A5B D1D8                <1> 	rcr	ax, 1
  1551 00000A5D 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value
  1552 00000A5F 01D0                <1> 	add	ax, dx
  1553 00000A61 D1D8                <1> 	rcr	ax, 1
  1554 00000A63 80EC80              <1> 	sub	ah, 80h
  1555 00000A66 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1556 00000A67 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1557 00000A68 89E8                <1> 	mov	ax, bp
  1558 00000A6A 01D8                <1> 	add	ax, bx
  1559 00000A6C D1D8                <1> 	rcr	ax, 1
  1560 00000A6E 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1561 00000A71 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1562 00000A72 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1563                              <1> 	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1564 00000A73 09C9                <1> 	or	cx, cx
  1565 00000A75 759E                <1> 	jnz	short lff8m2_1
  1566 00000A77 E961FE              <1> 	jmp	lff8m2_3
  1567                              <1> 
  1568                              <1> lff8m2_7:
  1569                              <1> lff8s2_7:
  1570 00000A7A E978FE              <1> 	jmp	lff8m2_5  ; error
  1571                              <1> 
  1572                              <1> load_8khz_stereo_16_bit:
  1573                              <1> 	; 16/11/2023
  1574                              <1> 	; 15/11/2023
  1575                              <1> 	; 13/11/2023
  1576 00000A7D F606[A617]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1577                              <1> 					; last of the file?
  1578 00000A82 7402                <1> 	jz	short lff8s2_0		; no
  1579 00000A84 F9                  <1> 	stc
  1580 00000A85 C3                  <1> 	retn
  1581                              <1> 
  1582                              <1> lff8s2_0:
  1583 00000A86 8EC0                <1> 	mov	es, ax ; buffer segment	
  1584 00000A88 31FF                <1> 	xor	di, di
  1585 00000A8A BA[CC17]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1586                              <1> 	; ds = cs
  1587                              <1> 
  1588                              <1> 	; load file into memory
  1589 00000A8D 8B0E[4706]          <1>         mov	cx, [loadsize]
  1590 00000A91 8B1E[A417]          <1> 	mov	bx, [filehandle]
  1591 00000A95 B43F                <1>        	mov	ah, 3Fh
  1592 00000A97 CD21                <1> 	int	21h
  1593 00000A99 72DF                <1> 	jc	short lff8s2_7 ; error !
  1594                              <1> 
  1595 00000A9B 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1596                              <1> 	
  1597 00000A9D C1E802              <1> 	shr	ax, 2	; 16/11/2023
  1598                              <1> 	;and	ax, ax
  1599 00000AA0 7503                <1> 	jnz	short lff8s2_8
  1600                              <1> 	;jmp	lff8s2_3
  1601                              <1> 	; 15/11/2023
  1602 00000AA2 E949FE              <1> 	jmp	lff8_eof
  1603                              <1> 
  1604                              <1> lff8s2_8:
  1605 00000AA5 89C1                <1> 	mov	cx, ax ; dword count
  1606                              <1> lff8s2_1:
  1607 00000AA7 AD                  <1> 	lodsw
  1608 00000AA8 AB                  <1> 	stosw		; original sample (L)
  1609                              <1> 	; 15/11/2023
  1610 00000AA9 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1611 00000AAC A3[4513]            <1> 	mov	[previous_val_l], ax
  1612 00000AAF AD                  <1> 	lodsw
  1613 00000AB0 AB                  <1> 	stosw		; original sample (R)
  1614 00000AB1 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1615 00000AB4 A3[4713]            <1> 	mov	[previous_val_r], ax
  1616 00000AB7 31D2                <1> 	xor	dx, dx
  1617 00000AB9 31C0                <1> 	xor	ax, ax
  1618                              <1> 	; 16/11/2023
  1619 00000ABB 49                  <1> 	dec	cx
  1620 00000ABC 7405                <1> 	jz	short lff8s2_2
  1621 00000ABE 8B04                <1> 	mov	ax, [si]
  1622 00000AC0 8B5402              <1> 	mov	dx, [si+2]
  1623                              <1> lff8s2_2:
  1624 00000AC3 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1625 00000AC6 A3[4913]            <1> 	mov	[next_val_l], ax
  1626 00000AC9 80C680              <1> 	add	dh, 80h	; convert sound level to 0-65535 format
  1627 00000ACC 8916[4B13]          <1> 	mov	[next_val_r], dx
  1628 00000AD0 0306[4513]          <1> 	add	ax, [previous_val_l]
  1629 00000AD4 D1D8                <1> 	rcr	ax, 1
  1630 00000AD6 89C2                <1> 	mov	dx, ax	; this is interpolated middle (3th) sample (L)
  1631 00000AD8 0306[4513]          <1> 	add	ax, [previous_val_l]
  1632 00000ADC D1D8                <1> 	rcr	ax, 1	
  1633 00000ADE 89C3                <1> 	mov	bx, ax 	; this is temporary interpolation value (L)
  1634 00000AE0 0306[4513]          <1> 	add	ax, [previous_val_l]
  1635 00000AE4 D1D8                <1> 	rcr	ax, 1
  1636 00000AE6 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1637 00000AE9 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1638 00000AEA A1[4B13]            <1> 	mov	ax, [next_val_r]
  1639 00000AED 0306[4713]          <1> 	add	ax, [previous_val_r]
  1640 00000AF1 D1D8                <1> 	rcr	ax, 1
  1641 00000AF3 89C5                <1> 	mov	bp, ax	; this is interpolated middle (3th) sample (R)
  1642 00000AF5 0306[4713]          <1> 	add	ax, [previous_val_r]
  1643 00000AF9 D1D8                <1> 	rcr	ax, 1
  1644 00000AFB 50                  <1> 	push	ax ; *	; this is temporary interpolation value (R)
  1645 00000AFC 0306[4713]          <1> 	add	ax, [previous_val_r]
  1646 00000B00 D1D8                <1> 	rcr	ax, 1
  1647 00000B02 80EC80              <1> 	sub	ah, 80h
  1648 00000B05 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1649 00000B06 89D8                <1> 	mov	ax, bx
  1650 00000B08 01D0                <1> 	add	ax, dx
  1651 00000B0A D1D8                <1> 	rcr	ax, 1
  1652 00000B0C 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1653 00000B0F AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1654 00000B10 58                  <1> 	pop	ax ; *
  1655 00000B11 01E8                <1> 	add	ax, bp
  1656 00000B13 D1D8                <1> 	rcr	ax, 1
  1657 00000B15 80EC80              <1> 	sub	ah, 80h
  1658 00000B18 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1659 00000B19 89D0                <1> 	mov	ax, dx
  1660 00000B1B 80EC80              <1> 	sub	ah, 80h
  1661 00000B1E AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1662 00000B1F 89E8                <1> 	mov	ax, bp
  1663 00000B21 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1664 00000B24 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1665 00000B25 A1[4913]            <1> 	mov	ax, [next_val_l]
  1666 00000B28 01D0                <1> 	add	ax, dx
  1667 00000B2A D1D8                <1> 	rcr	ax, 1
  1668 00000B2C 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value (L)
  1669 00000B2E 01D0                <1> 	add	ax, dx
  1670 00000B30 D1D8                <1> 	rcr	ax, 1
  1671 00000B32 80EC80              <1> 	sub	ah, 80h
  1672 00000B35 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1673 00000B36 A1[4B13]            <1> 	mov	ax, [next_val_r]
  1674 00000B39 01E8                <1> 	add	ax, bp
  1675 00000B3B D1D8                <1> 	rcr	ax, 1
  1676 00000B3D 50                  <1> 	push	ax ; ** ; this is temporary interpolation value (R)
  1677 00000B3E 01E8                <1> 	add	ax, bp
  1678 00000B40 D1D8                <1> 	rcr	ax, 1
  1679 00000B42 80EC80              <1> 	sub	ah, 80h
  1680 00000B45 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1681 00000B46 A1[4913]            <1> 	mov	ax, [next_val_l]
  1682 00000B49 01D8                <1> 	add	ax, bx
  1683 00000B4B D1D8                <1> 	rcr	ax, 1
  1684 00000B4D 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1685 00000B50 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1686 00000B51 58                  <1> 	pop	ax ; **
  1687 00000B52 0306[4B13]          <1> 	add	ax, [next_val_r]
  1688 00000B56 D1D8                <1> 	rcr	ax, 1
  1689 00000B58 80EC80              <1> 	sub	ah, 80h
  1690 00000B5B AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1691                              <1> 	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1692 00000B5C E303                <1> 	jcxz	lff8_s2_9
  1693 00000B5E E946FF              <1> 	jmp	lff8s2_1
  1694                              <1> lff8_s2_9:
  1695 00000B61 E977FD              <1> 	jmp	lff8s2_3
  1696                              <1> 
  1697                              <1> ; .....................
  1698                              <1> 
  1699                              <1> load_16khz_mono_8_bit:
  1700                              <1> 	; 14/11/2023
  1701                              <1> 	; 13/11/2023
  1702 00000B64 F606[A617]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1703                              <1> 					; last of the file?
  1704 00000B69 7402                <1> 	jz	short lff16m_0		; no
  1705 00000B6B F9                  <1> 	stc
  1706 00000B6C C3                  <1> 	retn
  1707                              <1> 
  1708                              <1> lff16m_0:
  1709 00000B6D 8EC0                <1> 	mov	es, ax ; buffer segment	
  1710 00000B6F 31FF                <1> 	xor	di, di
  1711 00000B71 BA[CC17]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1712                              <1> 	; ds = cs
  1713                              <1> 
  1714                              <1> 	; load file into memory
  1715 00000B74 8B0E[4706]          <1>         mov	cx, [loadsize]
  1716 00000B78 8B1E[A417]          <1> 	mov	bx, [filehandle]
  1717 00000B7C B43F                <1>        	mov	ah, 3Fh
  1718 00000B7E CD21                <1> 	int	21h
  1719 00000B80 7243                <1> 	jc	short lff16m_7 ; error !
  1720                              <1> 
  1721 00000B82 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1722                              <1> 	
  1723 00000B84 21C0                <1> 	and	ax, ax
  1724 00000B86 7503                <1> 	jnz	short lff16m_8
  1725                              <1> 	;jmp	lff16m_3
  1726                              <1> 	; 15/11/2023
  1727 00000B88 E963FD              <1> 	jmp	lff16_eof
  1728                              <1> 
  1729                              <1> lff16m_8:
  1730 00000B8B 89C1                <1> 	mov	cx, ax		; byte count
  1731                              <1> lff16m_1:
  1732 00000B8D AC                  <1> 	lodsb
  1733                              <1> 	;mov	[previous_val], al
  1734 00000B8E 88C3                <1> 	mov	bl, al
  1735 00000B90 2C80                <1> 	sub	al, 80h
  1736 00000B92 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1737 00000B95 AB                  <1> 	stosw		; original sample (left channel)
  1738 00000B96 AB                  <1> 	stosw		; original sample (right channel)
  1739                              <1> 	;xor	ax, ax
  1740                              <1> 	; 14/11/22023
  1741 00000B97 B080                <1> 	mov	al, 80h
  1742 00000B99 49                  <1> 	dec	cx
  1743 00000B9A 7402                <1> 	jz	short lff16m_2
  1744 00000B9C 8A04                <1> 	mov	al, [si]
  1745                              <1> lff16m_2:
  1746                              <1> 	;mov	[next_val], al
  1747 00000B9E 88C7                <1> 	mov	bh, al
  1748                              <1> 	;add	al, [previous_val]
  1749 00000BA0 00D8                <1> 	add	al, bl
  1750 00000BA2 D0D8                <1> 	rcr	al, 1
  1751 00000BA4 88C2                <1> 	mov	dl, al	; this is interpolated middle (temp) sample
  1752                              <1> 	;add	al, [previous_val]
  1753 00000BA6 00D8                <1> 	add	al, bl
  1754 00000BA8 D0D8                <1> 	rcr	al, 1
  1755 00000BAA 2C80                <1> 	sub	al, 80h
  1756 00000BAC C1E008              <1> 	shl	ax, 8
  1757 00000BAF AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1758 00000BB0 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1759                              <1> 	;mov	al, [next_val]
  1760 00000BB1 88F8                <1> 	mov	al, bh
  1761 00000BB3 00D0                <1> 	add	al, dl
  1762 00000BB5 D0D8                <1> 	rcr	al, 1
  1763 00000BB7 2C80                <1> 	sub	al, 80h
  1764 00000BB9 C1E008              <1> 	shl	ax, 8
  1765 00000BBC AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1766 00000BBD AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1767                              <1> 	
  1768                              <1> 	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1769 00000BBE 09C9                <1> 	or	cx, cx
  1770 00000BC0 75CB                <1> 	jnz	short lff16m_1
  1771 00000BC2 E916FD              <1> 	jmp	lff16m_3
  1772                              <1> 
  1773                              <1> lff16m_7:
  1774                              <1> lff16s_7:
  1775 00000BC5 E92DFD              <1> 	jmp	lff16m_5  ; error
  1776                              <1> 
  1777                              <1> load_16khz_stereo_8_bit:
  1778                              <1> 	; 14/11/2023
  1779                              <1> 	; 13/11/2023
  1780 00000BC8 F606[A617]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1781                              <1> 					; last of the file?
  1782 00000BCD 7402                <1> 	jz	short lff16s_0		; no
  1783 00000BCF F9                  <1> 	stc
  1784 00000BD0 C3                  <1> 	retn
  1785                              <1> 
  1786                              <1> lff16s_0:
  1787 00000BD1 8EC0                <1> 	mov	es, ax ; buffer segment	
  1788 00000BD3 31FF                <1> 	xor	di, di
  1789 00000BD5 BA[CC17]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1790                              <1> 	; ds = cs
  1791                              <1> 
  1792                              <1> 	; load file into memory
  1793 00000BD8 8B0E[4706]          <1>         mov	cx, [loadsize]
  1794 00000BDC 8B1E[A417]          <1> 	mov	bx, [filehandle]
  1795 00000BE0 B43F                <1>        	mov	ah, 3Fh
  1796 00000BE2 CD21                <1> 	int	21h
  1797 00000BE4 72DF                <1> 	jc	short lff16s_7 ; error !
  1798                              <1> 
  1799 00000BE6 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1800                              <1> 	
  1801 00000BE8 D1E8                <1> 	shr	ax, 1
  1802                              <1> 	;and	ax, ax
  1803 00000BEA 7503                <1> 	jnz	short lff16s_8
  1804                              <1> 	;jmp	lff16s_3
  1805                              <1> 	; 15/11/2023
  1806 00000BEC E9FFFC              <1> 	jmp	lff16_eof
  1807                              <1> 
  1808                              <1> lff16s_8:
  1809 00000BEF 89C1                <1> 	mov	cx, ax		; word count
  1810                              <1> lff16s_1:
  1811 00000BF1 AC                  <1> 	lodsb
  1812 00000BF2 A2[4513]            <1> 	mov	[previous_val_l], al
  1813 00000BF5 2C80                <1> 	sub	al, 80h
  1814 00000BF7 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1815 00000BFA AB                  <1> 	stosw		; original sample (L)
  1816 00000BFB AC                  <1> 	lodsb
  1817 00000BFC A2[4713]            <1> 	mov	[previous_val_r], al
  1818 00000BFF 2C80                <1> 	sub	al, 80h
  1819 00000C01 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1820 00000C04 AB                  <1> 	stosw		; original sample (R)
  1821                              <1> 
  1822                              <1> 	;xor	ax, ax
  1823                              <1> 	; 14/11/2023
  1824 00000C05 B88080              <1> 	mov	ax, 8080h
  1825 00000C08 49                  <1> 	dec	cx
  1826 00000C09 7402                <1> 	jz	short lff16s_2
  1827                              <1> 		; convert 8 bit sample to 16 bit sample
  1828 00000C0B 8B04                <1> 	mov	ax, [si]
  1829                              <1> lff16s_2:
  1830                              <1> 	;mov	[next_val_l], al
  1831                              <1> 	;mov	[next_val_r], ah
  1832 00000C0D 89C3                <1> 	mov	bx, ax
  1833 00000C0F 0206[4513]          <1> 	add	al, [previous_val_l]
  1834 00000C13 D0D8                <1> 	rcr	al, 1
  1835 00000C15 88C2                <1> 	mov	dl, al	; this is temporary interpolation value (L)
  1836 00000C17 0206[4513]          <1> 	add	al, [previous_val_l]
  1837 00000C1B D0D8                <1> 	rcr	al, 1
  1838 00000C1D 2C80                <1> 	sub	al, 80h
  1839 00000C1F C1E008              <1> 	shl	ax, 8
  1840 00000C22 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1841 00000C23 88F8                <1> 	mov	al, bh	; [next_val_r]
  1842 00000C25 0206[4713]          <1> 	add	al, [previous_val_r]
  1843 00000C29 D0D8                <1> 	rcr	al, 1
  1844 00000C2B 88C6                <1> 	mov	dh, al	; this is temporary interpolation value (R)
  1845 00000C2D 0206[4713]          <1> 	add	al, [previous_val_r]
  1846 00000C31 D0D8                <1> 	rcr	al, 1
  1847 00000C33 2C80                <1> 	sub	al, 80h
  1848 00000C35 C1E008              <1> 	shl	ax, 8
  1849 00000C38 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1850 00000C39 88D0                <1> 	mov	al, dl
  1851 00000C3B 00D8                <1> 	add	al, bl	; [next_val_l]
  1852 00000C3D D0D8                <1> 	rcr	al, 1
  1853 00000C3F 2C80                <1> 	sub	al, 80h
  1854 00000C41 C1E008              <1> 	shl	ax, 8
  1855 00000C44 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1856 00000C45 88F0                <1> 	mov	al, dh
  1857 00000C47 00F8                <1> 	add	al, bh	; [next_val_r]
  1858 00000C49 D0D8                <1> 	rcr	al, 1
  1859 00000C4B 2C80                <1> 	sub	al, 80h
  1860 00000C4D C1E008              <1> 	shl	ax, 8
  1861 00000C50 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1862                              <1> 	
  1863                              <1> 	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1864 00000C51 09C9                <1> 	or	cx, cx
  1865 00000C53 759C                <1> 	jnz	short lff16s_1
  1866 00000C55 E983FC              <1> 	jmp	lff16s_3
  1867                              <1> 
  1868                              <1> load_16khz_mono_16_bit:
  1869                              <1> 	; 15/11/2023
  1870                              <1> 	; 13/11/2023
  1871 00000C58 F606[A617]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1872                              <1> 					; last of the file?
  1873 00000C5D 7402                <1> 	jz	short lff16m2_0		; no
  1874 00000C5F F9                  <1> 	stc
  1875 00000C60 C3                  <1> 	retn
  1876                              <1> 
  1877                              <1> lff16m2_0:
  1878 00000C61 8EC0                <1> 	mov	es, ax ; buffer segment	
  1879 00000C63 31FF                <1> 	xor	di, di
  1880 00000C65 BA[CC17]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1881                              <1> 	; ds = cs
  1882                              <1> 
  1883                              <1> 	; load file into memory
  1884 00000C68 8B0E[4706]          <1>         mov	cx, [loadsize]
  1885 00000C6C 8B1E[A417]          <1> 	mov	bx, [filehandle]
  1886 00000C70 B43F                <1>        	mov	ah, 3Fh
  1887 00000C72 CD21                <1> 	int	21h
  1888 00000C74 7240                <1> 	jc	short lff16m2_7 ; error !
  1889                              <1> 
  1890 00000C76 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1891                              <1> 	
  1892 00000C78 D1E8                <1> 	shr	ax, 1
  1893                              <1> 	;and	ax, ax
  1894 00000C7A 7503                <1> 	jnz	short lff16m2_8
  1895                              <1> 	;jmp	lff16m2_3
  1896                              <1> 	; 15/11/2023
  1897 00000C7C E96FFC              <1> 	jmp	lff16_eof
  1898                              <1> 
  1899                              <1> lff16m2_8:
  1900 00000C7F 89C1                <1> 	mov	cx, ax	; word count
  1901                              <1> lff16m2_1:
  1902 00000C81 AD                  <1> 	lodsw
  1903 00000C82 AB                  <1> 	stosw		; original sample (left channel)
  1904 00000C83 AB                  <1> 	stosw		; original sample (right channel)
  1905 00000C84 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  1906                              <1> 	;mov	[previous_val], ax
  1907 00000C87 89C3                <1> 	mov	bx, ax	
  1908 00000C89 31C0                <1> 	xor	ax, ax
  1909 00000C8B 49                  <1> 	dec	cx
  1910 00000C8C 7402                <1> 	jz	short lff16m2_2
  1911 00000C8E 8B04                <1> 	mov	ax, [si]
  1912                              <1> lff16m2_2:
  1913 00000C90 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  1914 00000C93 89C5                <1> 	mov	bp, ax	; [next_val]
  1915                              <1> 	;add	ax, [previous_val]
  1916 00000C95 01D8                <1> 	add	ax, bx
  1917 00000C97 D1D8                <1> 	rcr	ax, 1
  1918 00000C99 89C2                <1> 	mov	dx, ax	; this is temporary interpolation value
  1919                              <1> 	;add	ax, [previous_val]
  1920 00000C9B 01D8                <1> 	add	ax, bx
  1921 00000C9D D1D8                <1> 	rcr	ax, 1
  1922 00000C9F 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1923 00000CA2 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1924 00000CA3 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1925 00000CA4 89E8                <1> 	mov	ax, bp 
  1926 00000CA6 01D0                <1> 	add	ax, dx
  1927 00000CA8 D1D8                <1> 	rcr	ax, 1
  1928 00000CAA 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1929 00000CAD AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1930 00000CAE AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1931                              <1> 	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1932 00000CAF 09C9                <1> 	or	cx, cx
  1933 00000CB1 75CE                <1> 	jnz	short lff16m2_1
  1934 00000CB3 E925FC              <1> 	jmp	lff16m2_3
  1935                              <1> 
  1936                              <1> lff16m2_7:
  1937                              <1> lff16s2_7:
  1938 00000CB6 E93CFC              <1> 	jmp	lff16m2_5  ; error
  1939                              <1> 
  1940                              <1> load_16khz_stereo_16_bit:
  1941                              <1> 	; 16/11/2023
  1942                              <1> 	; 15/11/2023
  1943                              <1> 	; 13/11/2023
  1944 00000CB9 F606[A617]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1945                              <1> 					; last of the file?
  1946 00000CBE 7402                <1> 	jz	short lff16s2_0		; no
  1947 00000CC0 F9                  <1> 	stc
  1948 00000CC1 C3                  <1> 	retn
  1949                              <1> 
  1950                              <1> lff16s2_0:
  1951 00000CC2 8EC0                <1> 	mov	es, ax ; buffer segment	
  1952 00000CC4 31FF                <1> 	xor	di, di
  1953 00000CC6 BA[CC17]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1954                              <1> 	; ds = cs
  1955                              <1> 
  1956                              <1> 	; load file into memory
  1957 00000CC9 8B0E[4706]          <1>         mov	cx, [loadsize]
  1958 00000CCD 8B1E[A417]          <1> 	mov	bx, [filehandle]
  1959 00000CD1 B43F                <1>        	mov	ah, 3Fh
  1960 00000CD3 CD21                <1> 	int	21h
  1961 00000CD5 72DF                <1> 	jc	short lff16s2_7 ; error !
  1962                              <1> 
  1963 00000CD7 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1964                              <1> 	
  1965                              <1> 	;shr	ax, 1
  1966 00000CD9 C1E802              <1> 	shr	ax, 2	; 16/11/2023
  1967                              <1> 	;and	ax, ax
  1968 00000CDC 7503                <1> 	jnz	short lff16s2_8
  1969                              <1> 	;jmp	lff16s2_3
  1970                              <1> 	; 15/11/2023
  1971 00000CDE E90DFC              <1> 	jmp	lff16_eof
  1972                              <1> 
  1973                              <1> lff16s2_8:
  1974 00000CE1 89C1                <1> 	mov	cx, ax		; dword count
  1975                              <1> lff16s2_1:
  1976 00000CE3 AD                  <1> 	lodsw
  1977 00000CE4 AB                  <1> 	stosw		; original sample (L)
  1978 00000CE5 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  1979 00000CE8 A3[4513]            <1> 	mov	[previous_val_l], ax
  1980 00000CEB AD                  <1> 	lodsw
  1981 00000CEC AB                  <1> 	stosw		; original sample (R)
  1982 00000CED 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  1983 00000CF0 A3[4713]            <1> 	mov	[previous_val_r], ax
  1984 00000CF3 31D2                <1> 	xor	dx, dx
  1985 00000CF5 31C0                <1> 	xor	ax, ax
  1986                              <1> 	; 16/11/2023
  1987 00000CF7 49                  <1> 	dec	cx
  1988 00000CF8 7405                <1> 	jz	short lff16s2_2
  1989 00000CFA 8B04                <1> 	mov	ax, [si]
  1990 00000CFC 8B5402              <1> 	mov	dx, [si+2]
  1991                              <1> lff16s2_2:
  1992 00000CFF 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  1993                              <1> 	;mov	[next_val_l], ax
  1994 00000D02 89C5                <1> 	mov	bp, ax
  1995 00000D04 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format 
  1996 00000D07 8916[4B13]          <1> 	mov	[next_val_r], dx
  1997 00000D0B 0306[4513]          <1> 	add	ax, [previous_val_l]
  1998 00000D0F D1D8                <1> 	rcr	ax, 1
  1999 00000D11 89C2                <1> 	mov	dx, ax	; this is temporary interpolation value (L)
  2000 00000D13 0306[4513]          <1> 	add	ax, [previous_val_l]
  2001 00000D17 D1D8                <1> 	rcr	ax, 1
  2002 00000D19 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  2003 00000D1C AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  2004 00000D1D A1[4B13]            <1> 	mov	ax, [next_val_r]
  2005 00000D20 0306[4713]          <1> 	add	ax, [previous_val_r]
  2006 00000D24 D1D8                <1> 	rcr	ax, 1
  2007 00000D26 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value (R)
  2008 00000D28 0306[4713]          <1> 	add	ax, [previous_val_r]
  2009 00000D2C D1D8                <1> 	rcr	ax, 1
  2010 00000D2E 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2011 00000D31 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  2012                              <1> 	;mov	ax, [next_val_l]
  2013 00000D32 89E8                <1> 	mov	ax, bp
  2014 00000D34 01D0                <1> 	add	ax, dx
  2015 00000D36 D1D8                <1> 	rcr	ax, 1
  2016 00000D38 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2017 00000D3B AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  2018 00000D3C A1[4B13]            <1> 	mov	ax, [next_val_r]
  2019 00000D3F 01D8                <1> 	add	ax, bx
  2020 00000D41 D1D8                <1> 	rcr	ax, 1
  2021 00000D43 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2022 00000D46 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  2023                              <1> 	
  2024                              <1> 	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2025 00000D47 09C9                <1> 	or	cx, cx
  2026 00000D49 7598                <1> 	jnz	short lff16s2_1
  2027 00000D4B E98DFB              <1> 	jmp	lff16s2_3
  2028                              <1> 
  2029                              <1> ; .....................
  2030                              <1> 
  2031                              <1> load_24khz_mono_8_bit:
  2032                              <1> 	; 15/11/2023
  2033 00000D4E F606[A617]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2034                              <1> 					; last of the file?
  2035 00000D53 7402                <1> 	jz	short lff24m_0		; no
  2036 00000D55 F9                  <1> 	stc
  2037 00000D56 C3                  <1> 	retn
  2038                              <1> 
  2039                              <1> lff24m_0:
  2040 00000D57 8EC0                <1> 	mov	es, ax ; buffer segment	
  2041 00000D59 31FF                <1> 	xor	di, di
  2042 00000D5B BA[CC17]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2043                              <1> 	; ds = cs
  2044                              <1> 
  2045                              <1> 	; load file into memory
  2046 00000D5E 8B0E[4706]          <1>         mov	cx, [loadsize]
  2047 00000D62 8B1E[A417]          <1> 	mov	bx, [filehandle]
  2048 00000D66 B43F                <1>        	mov	ah, 3Fh
  2049 00000D68 CD21                <1> 	int	21h
  2050 00000D6A 722E                <1> 	jc	short lff24m_7 ; error !
  2051                              <1> 
  2052 00000D6C 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2053                              <1> 	
  2054 00000D6E 21C0                <1> 	and	ax, ax
  2055 00000D70 7503                <1> 	jnz	short lff24m_8
  2056 00000D72 E979FB              <1> 	jmp	lff24_eof
  2057                              <1> 
  2058                              <1> lff24m_8:
  2059 00000D75 89C1                <1> 	mov	cx, ax		; byte count
  2060                              <1> lff24m_1:
  2061 00000D77 AC                  <1> 	lodsb
  2062                              <1> 	;mov	[previous_val], al
  2063 00000D78 88C3                <1> 	mov	bl, al
  2064 00000D7A 2C80                <1> 	sub	al, 80h
  2065 00000D7C C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2066 00000D7F AB                  <1> 	stosw		; original sample (left channel)
  2067 00000D80 AB                  <1> 	stosw		; original sample (right channel)
  2068                              <1> 	;xor	ax, ax
  2069 00000D81 B080                <1> 	mov	al, 80h
  2070 00000D83 49                  <1> 	dec	cx
  2071 00000D84 7402                <1> 	jz	short lff24m_2
  2072 00000D86 8A04                <1> 	mov	al, [si]
  2073                              <1> lff24m_2:
  2074                              <1> 	;;mov	[next_val], al
  2075                              <1> 	;mov	bh, al
  2076                              <1> 	;add	al, [previous_val]
  2077 00000D88 00D8                <1> 	add	al, bl
  2078 00000D8A D0D8                <1> 	rcr	al, 1
  2079 00000D8C 2C80                <1> 	sub	al, 80h
  2080 00000D8E C1E008              <1> 	shl	ax, 8
  2081 00000D91 AB                  <1> 	stosw		; this is interpolated sample (L)
  2082 00000D92 AB                  <1> 	stosw		; this is interpolated sample (R)
  2083                              <1> 	
  2084                              <1> 	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2085 00000D93 09C9                <1> 	or	cx, cx
  2086 00000D95 75E0                <1> 	jnz	short lff24m_1
  2087 00000D97 E941FB              <1> 	jmp	lff24_3
  2088                              <1> 
  2089                              <1> lff24m_7:
  2090                              <1> lff24s_7:
  2091 00000D9A E958FB              <1> 	jmp	lff24_5  ; error
  2092                              <1> 
  2093                              <1> load_24khz_stereo_8_bit:
  2094                              <1> 	; 15/11/2023
  2095 00000D9D F606[A617]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2096                              <1> 					; last of the file?
  2097 00000DA2 7402                <1> 	jz	short lff24s_0		; no
  2098 00000DA4 F9                  <1> 	stc
  2099 00000DA5 C3                  <1> 	retn
  2100                              <1> 
  2101                              <1> lff24s_0:
  2102 00000DA6 8EC0                <1> 	mov	es, ax ; buffer segment	
  2103 00000DA8 31FF                <1> 	xor	di, di
  2104 00000DAA BA[CC17]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2105                              <1> 	; ds = cs
  2106                              <1> 
  2107                              <1> 	; load file into memory
  2108 00000DAD 8B0E[4706]          <1>         mov	cx, [loadsize]
  2109 00000DB1 8B1E[A417]          <1> 	mov	bx, [filehandle]
  2110 00000DB5 B43F                <1>        	mov	ah, 3Fh
  2111 00000DB7 CD21                <1> 	int	21h
  2112 00000DB9 72DF                <1> 	jc	short lff24s_7 ; error !
  2113                              <1> 
  2114 00000DBB 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2115                              <1> 	
  2116 00000DBD D1E8                <1> 	shr	ax, 1
  2117                              <1> 	;and	ax, ax
  2118 00000DBF 7503                <1> 	jnz	short lff24s_8
  2119 00000DC1 E92AFB              <1> 	jmp	lff24_eof
  2120                              <1> 
  2121                              <1> lff24s_8:
  2122 00000DC4 89C1                <1> 	mov	cx, ax		; word count
  2123                              <1> lff24s_1:
  2124 00000DC6 AC                  <1> 	lodsb
  2125 00000DC7 A2[4513]            <1> 	mov	[previous_val_l], al
  2126 00000DCA 2C80                <1> 	sub	al, 80h
  2127 00000DCC C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2128 00000DCF AB                  <1> 	stosw		; original sample (L)
  2129 00000DD0 AC                  <1> 	lodsb
  2130 00000DD1 A2[4713]            <1> 	mov	[previous_val_r], al
  2131 00000DD4 2C80                <1> 	sub	al, 80h
  2132 00000DD6 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2133 00000DD9 AB                  <1> 	stosw		; original sample (R)
  2134                              <1> 
  2135                              <1> 	;xor	ax, ax
  2136 00000DDA B88080              <1> 	mov	ax, 8080h
  2137 00000DDD 49                  <1> 	dec	cx
  2138 00000DDE 7402                <1> 	jz	short lff24s_2
  2139                              <1> 		; convert 8 bit sample to 16 bit sample
  2140 00000DE0 8B04                <1> 	mov	ax, [si]
  2141                              <1> lff24s_2:
  2142                              <1> 	;;mov	[next_val_l], al
  2143                              <1> 	;;mov	[next_val_r], ah
  2144                              <1> 	;mov	bx, ax
  2145 00000DE2 88E7                <1> 	mov	bh, ah
  2146 00000DE4 0206[4513]          <1> 	add	al, [previous_val_l]
  2147 00000DE8 D0D8                <1> 	rcr	al, 1
  2148                              <1> 	;mov	dl, al
  2149 00000DEA 2C80                <1> 	sub	al, 80h
  2150 00000DEC C1E008              <1> 	shl	ax, 8
  2151 00000DEF AB                  <1> 	stosw		; this is interpolated sample (L)
  2152 00000DF0 88F8                <1> 	mov	al, bh	; [next_val_r]
  2153 00000DF2 0206[4713]          <1> 	add	al, [previous_val_r]
  2154 00000DF6 D0D8                <1> 	rcr	al, 1
  2155                              <1> 	;mov	dh, al
  2156 00000DF8 2C80                <1> 	sub	al, 80h
  2157 00000DFA C1E008              <1> 	shl	ax, 8
  2158 00000DFD AB                  <1> 	stosw		; this is interpolated sample (R)
  2159                              <1> 		
  2160                              <1> 	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2161 00000DFE 09C9                <1> 	or	cx, cx
  2162 00000E00 75C4                <1> 	jnz	short lff24s_1
  2163 00000E02 E9D6FA              <1> 	jmp	lff24_3
  2164                              <1> 
  2165                              <1> load_24khz_mono_16_bit:
  2166                              <1> 	; 15/11/2023
  2167 00000E05 F606[A617]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2168                              <1> 					; last of the file?
  2169 00000E0A 7402                <1> 	jz	short lff24m2_0		; no
  2170 00000E0C F9                  <1> 	stc
  2171 00000E0D C3                  <1> 	retn
  2172                              <1> 
  2173                              <1> lff24m2_0:
  2174 00000E0E 8EC0                <1> 	mov	es, ax ; buffer segment	
  2175 00000E10 31FF                <1> 	xor	di, di
  2176 00000E12 BA[CC17]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2177                              <1> 	; ds = cs
  2178                              <1> 
  2179                              <1> 	; load file into memory
  2180 00000E15 8B0E[4706]          <1>         mov	cx, [loadsize]
  2181 00000E19 8B1E[A417]          <1> 	mov	bx, [filehandle]
  2182 00000E1D B43F                <1>        	mov	ah, 3Fh
  2183 00000E1F CD21                <1> 	int	21h
  2184 00000E21 7228                <1> 	jc	short lff24m2_7 ; error !
  2185                              <1> 
  2186 00000E23 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2187                              <1> 	
  2188 00000E25 D1E8                <1> 	shr	ax, 1
  2189                              <1> 	;and	ax, ax
  2190 00000E27 7503                <1> 	jnz	short lff24m2_8
  2191 00000E29 E9C2FA              <1> 	jmp	lff24_eof
  2192                              <1> 
  2193                              <1> lff24m2_8:
  2194 00000E2C 89C1                <1> 	mov	cx, ax	; word count
  2195                              <1> lff24m2_1:
  2196 00000E2E AD                  <1> 	lodsw
  2197 00000E2F AB                  <1> 	stosw		; original sample (left channel)
  2198 00000E30 AB                  <1> 	stosw		; original sample (right channel)
  2199 00000E31 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  2200                              <1> 	;mov	[previous_val], ax
  2201                              <1> 	;mov	bx, ax	
  2202                              <1> 	;xor	ax, ax
  2203 00000E34 31DB                <1> 	xor	bx, bx
  2204 00000E36 49                  <1> 	dec	cx
  2205 00000E37 7402                <1> 	jz	short lff24m2_2
  2206                              <1> 	;mov	ax, [si
  2207 00000E39 8B1C                <1> 	mov	bx, [si]
  2208                              <1> lff24m2_2:
  2209                              <1> 	;add	ah, 80h ; convert sound level 0 to 65535 format
  2210                              <1> 	;mov	bp, ax	; [next_val]
  2211                              <1> 	;add	ax, [previous_val]
  2212                              <1> 	; ax = [previous_val]
  2213                              <1> 	; bx = [next_val]
  2214 00000E3B 01D8                <1> 	add	ax, bx
  2215 00000E3D D1D8                <1> 	rcr	ax, 1
  2216 00000E3F 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2217 00000E42 AB                  <1> 	stosw		; this is interpolated sample (L)
  2218 00000E43 AB                  <1> 	stosw		; this is interpolated sample (R)
  2219                              <1> 	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2220 00000E44 09C9                <1> 	or	cx, cx
  2221 00000E46 75E6                <1> 	jnz	short lff24m2_1
  2222 00000E48 E990FA              <1> 	jmp	lff24_3
  2223                              <1> 
  2224                              <1> lff24m2_7:
  2225                              <1> lff24s2_7:
  2226 00000E4B E9A7FA              <1> 	jmp	lff24_5  ; error
  2227                              <1> 
  2228                              <1> load_24khz_stereo_16_bit:
  2229                              <1> 	; 16/11/2023
  2230                              <1> 	; 15/11/2023
  2231 00000E4E F606[A617]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2232                              <1> 					; last of the file?
  2233 00000E53 7402                <1> 	jz	short lff24s2_0		; no
  2234 00000E55 F9                  <1> 	stc
  2235 00000E56 C3                  <1> 	retn
  2236                              <1> 
  2237                              <1> lff24s2_0:
  2238 00000E57 8EC0                <1> 	mov	es, ax ; buffer segment	
  2239 00000E59 31FF                <1> 	xor	di, di
  2240 00000E5B BA[CC17]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2241                              <1> 	; ds = cs
  2242                              <1> 
  2243                              <1> 	; load file into memory
  2244 00000E5E 8B0E[4706]          <1>         mov	cx, [loadsize]
  2245 00000E62 8B1E[A417]          <1> 	mov	bx, [filehandle]
  2246 00000E66 B43F                <1>        	mov	ah, 3Fh
  2247 00000E68 CD21                <1> 	int	21h
  2248 00000E6A 72DF                <1> 	jc	short lff24s2_7 ; error !
  2249                              <1> 
  2250 00000E6C 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2251                              <1> 	
  2252                              <1> 	;shr	ax, 1
  2253 00000E6E C1E802              <1> 	shr	ax, 2	; 16/11/2023
  2254                              <1> 	;and	ax, ax
  2255 00000E71 7503                <1> 	jnz	short lff24s2_8
  2256 00000E73 E978FA              <1> 	jmp	lff24_eof
  2257                              <1> 
  2258                              <1> lff24s2_8:
  2259 00000E76 89C1                <1> 	mov	cx, ax		; dword count
  2260                              <1> lff24s2_1:
  2261 00000E78 AD                  <1> 	lodsw
  2262 00000E79 AB                  <1> 	stosw		; original sample (L)
  2263 00000E7A 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2264 00000E7D A3[4513]            <1> 	mov	[previous_val_l], ax
  2265 00000E80 AD                  <1> 	lodsw
  2266 00000E81 AB                  <1> 	stosw		; original sample (R)
  2267 00000E82 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2268                              <1> 	;mov	[previous_val_r], ax
  2269 00000E85 89C3                <1> 	mov	bx, ax
  2270 00000E87 31D2                <1> 	xor	dx, dx
  2271 00000E89 31C0                <1> 	xor	ax, ax
  2272                              <1> 	; 16/11/2023
  2273 00000E8B 49                  <1> 	dec	cx
  2274 00000E8C 7405                <1> 	jz	short lff24s2_2
  2275 00000E8E 8B04                <1> 	mov	ax, [si]
  2276 00000E90 8B5402              <1> 	mov	dx, [si+2]
  2277                              <1> lff24s2_2:
  2278 00000E93 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2279                              <1> 	;;mov	[next_val_l], ax
  2280                              <1> 	;mov	bp, ax
  2281 00000E96 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format 
  2282                              <1> 	;mov	[next_val_r], dx
  2283 00000E99 0306[4513]          <1> 	add	ax, [previous_val_l]
  2284 00000E9D D1D8                <1> 	rcr	ax, 1
  2285 00000E9F 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  2286 00000EA2 AB                  <1> 	stosw		; this is interpolated sample (L)
  2287                              <1> 	;mov	ax, [next_val_r]
  2288 00000EA3 89D0                <1> 	mov	ax, dx
  2289                              <1> 	;add	ax, [previous_val_r]
  2290 00000EA5 01D8                <1> 	add	ax, bx
  2291 00000EA7 D1D8                <1> 	rcr	ax, 1
  2292 00000EA9 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2293 00000EAC AB                  <1> 	stosw		; this is interpolated sample (R)
  2294                              <1> 	
  2295                              <1> 	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2296 00000EAD 09C9                <1> 	or	cx, cx
  2297 00000EAF 75C7                <1> 	jnz	short lff24s2_1
  2298 00000EB1 E927FA              <1> 	jmp	lff24_3
  2299                              <1> 
  2300                              <1> ; .....................
  2301                              <1> 
  2302                              <1> load_32khz_mono_8_bit:
  2303                              <1> 	; 15/11/2023
  2304 00000EB4 F606[A617]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2305                              <1> 					; last of the file?
  2306 00000EB9 7402                <1> 	jz	short lff32m_0		; no
  2307 00000EBB F9                  <1> 	stc
  2308 00000EBC C3                  <1> 	retn
  2309                              <1> 
  2310                              <1> lff32m_0:
  2311 00000EBD 8EC0                <1> 	mov	es, ax ; buffer segment	
  2312 00000EBF 31FF                <1> 	xor	di, di
  2313 00000EC1 BA[CC17]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2314                              <1> 	; ds = cs
  2315                              <1> 
  2316                              <1> 	; load file into memory
  2317 00000EC4 8B0E[4706]          <1>         mov	cx, [loadsize]
  2318 00000EC8 8B1E[A417]          <1> 	mov	bx, [filehandle]
  2319 00000ECC B43F                <1>        	mov	ah, 3Fh
  2320 00000ECE CD21                <1> 	int	21h
  2321 00000ED0 7237                <1> 	jc	short lff32m_7 ; error !
  2322                              <1> 
  2323 00000ED2 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2324                              <1> 	
  2325 00000ED4 21C0                <1> 	and	ax, ax
  2326 00000ED6 7503                <1> 	jnz	short lff32m_8
  2327 00000ED8 E913FA              <1> 	jmp	lff32_eof
  2328                              <1> 
  2329                              <1> lff32m_8:
  2330 00000EDB 89C1                <1> 	mov	cx, ax		; byte count
  2331                              <1> lff32m_1:
  2332 00000EDD AC                  <1> 	lodsb
  2333                              <1> 	;mov	[previous_val], al
  2334 00000EDE 88C3                <1> 	mov	bl, al
  2335 00000EE0 2C80                <1> 	sub	al, 80h
  2336 00000EE2 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2337 00000EE5 AB                  <1> 	stosw		; original sample (left channel)
  2338 00000EE6 AB                  <1> 	stosw		; original sample (right channel)
  2339                              <1> 	;xor	ax, ax
  2340 00000EE7 B080                <1> 	mov	al, 80h
  2341 00000EE9 49                  <1> 	dec	cx
  2342 00000EEA 7402                <1> 	jz	short lff32m_2
  2343 00000EEC 8A04                <1> 	mov	al, [si]
  2344                              <1> lff32m_2:
  2345                              <1> 	;;mov	[next_val], al
  2346                              <1> 	;mov	bh, al
  2347                              <1> 	;add	al, [previous_val]
  2348 00000EEE 00D8                <1> 	add	al, bl
  2349 00000EF0 D0D8                <1> 	rcr	al, 1
  2350 00000EF2 2C80                <1> 	sub	al, 80h
  2351 00000EF4 C1E008              <1> 	shl	ax, 8
  2352 00000EF7 AB                  <1> 	stosw		; this is interpolated sample (L)
  2353 00000EF8 AB                  <1> 	stosw		; this is interpolated sample (R)
  2354                              <1> 	
  2355                              <1> 	; different than 8-16-24 kHZ !
  2356                              <1> 	; 'original-interpolated-original' trio samples 
  2357 00000EF9 E30B                <1> 	jcxz	lff32m_3
  2358                              <1> 
  2359 00000EFB AC                  <1> 	lodsb
  2360 00000EFC 2C80                <1> 	sub	al, 80h
  2361 00000EFE C1E008              <1> 	shl	ax, 8
  2362 00000F01 AB                  <1> 	stosw		; original sample (left channel)
  2363 00000F02 AB                  <1> 	stosw		; original sample (right channel)
  2364                              <1> 
  2365                              <1> 	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2366 00000F03 49                  <1> 	dec	cx
  2367 00000F04 75D7                <1> 	jnz	short lff32m_1
  2368                              <1> lff32m_3:
  2369 00000F06 E9D2F9              <1> 	jmp	lff32_3
  2370                              <1> 
  2371                              <1> lff32m_7:
  2372                              <1> lff32s_7:
  2373 00000F09 E9E9F9              <1> 	jmp	lff32_5  ; error
  2374                              <1> 
  2375                              <1> load_32khz_stereo_8_bit:
  2376                              <1> 	; 15/11/2023
  2377 00000F0C F606[A617]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2378                              <1> 					; last of the file?
  2379 00000F11 7402                <1> 	jz	short lff32s_0		; no
  2380 00000F13 F9                  <1> 	stc
  2381 00000F14 C3                  <1> 	retn
  2382                              <1> 
  2383                              <1> lff32s_0:
  2384 00000F15 8EC0                <1> 	mov	es, ax ; buffer segment	
  2385 00000F17 31FF                <1> 	xor	di, di
  2386 00000F19 BA[CC17]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2387                              <1> 	; ds = cs
  2388                              <1> 
  2389                              <1> 	; load file into memory
  2390 00000F1C 8B0E[4706]          <1>         mov	cx, [loadsize]
  2391 00000F20 8B1E[A417]          <1> 	mov	bx, [filehandle]
  2392 00000F24 B43F                <1>        	mov	ah, 3Fh
  2393 00000F26 CD21                <1> 	int	21h
  2394 00000F28 72DF                <1> 	jc	short lff32s_7 ; error !
  2395                              <1> 
  2396 00000F2A 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2397                              <1> 	
  2398 00000F2C D1E8                <1> 	shr	ax, 1
  2399                              <1> 	;and	ax, ax
  2400 00000F2E 7503                <1> 	jnz	short lff32s_8
  2401 00000F30 E9BBF9              <1> 	jmp	lff32_eof
  2402                              <1> 
  2403                              <1> lff32s_8:
  2404 00000F33 89C1                <1> 	mov	cx, ax		; word count
  2405                              <1> lff32s_1:
  2406 00000F35 AC                  <1> 	lodsb
  2407 00000F36 A2[4513]            <1> 	mov	[previous_val_l], al
  2408 00000F39 2C80                <1> 	sub	al, 80h
  2409 00000F3B C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2410 00000F3E AB                  <1> 	stosw		; original sample (L)
  2411 00000F3F AC                  <1> 	lodsb
  2412 00000F40 A2[4713]            <1> 	mov	[previous_val_r], al
  2413 00000F43 2C80                <1> 	sub	al, 80h
  2414 00000F45 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2415 00000F48 AB                  <1> 	stosw		; original sample (R)
  2416                              <1> 
  2417                              <1> 	;xor	ax, ax
  2418 00000F49 B88080              <1> 	mov	ax, 8080h
  2419 00000F4C 49                  <1> 	dec	cx
  2420 00000F4D 7402                <1> 	jz	short lff32s_2
  2421                              <1> 		; convert 8 bit sample to 16 bit sample
  2422 00000F4F 8B04                <1> 	mov	ax, [si]
  2423                              <1> lff32s_2:
  2424                              <1> 	;;mov	[next_val_l], al
  2425                              <1> 	;;mov	[next_val_r], ah
  2426                              <1> 	;mov	bx, ax
  2427 00000F51 88E7                <1> 	mov	bh, ah
  2428 00000F53 0206[4513]          <1> 	add	al, [previous_val_l]
  2429 00000F57 D0D8                <1> 	rcr	al, 1
  2430                              <1> 	;mov	dl, al
  2431 00000F59 2C80                <1> 	sub	al, 80h
  2432 00000F5B C1E008              <1> 	shl	ax, 8
  2433 00000F5E AB                  <1> 	stosw		; this is interpolated sample (L)
  2434 00000F5F 88F8                <1> 	mov	al, bh	; [next_val_r]
  2435 00000F61 0206[4713]          <1> 	add	al, [previous_val_r]
  2436 00000F65 D0D8                <1> 	rcr	al, 1
  2437                              <1> 	;mov	dh, al
  2438 00000F67 2C80                <1> 	sub	al, 80h
  2439 00000F69 C1E008              <1> 	shl	ax, 8
  2440 00000F6C AB                  <1> 	stosw		; this is interpolated sample (R)
  2441                              <1> 
  2442                              <1> 	; different than 8-16-24 kHZ !
  2443                              <1> 	; 'original-interpolated-original' trio samples 
  2444 00000F6D E311                <1> 	jcxz	lff32s_3
  2445                              <1> 
  2446 00000F6F AC                  <1> 	lodsb
  2447 00000F70 2C80                <1> 	sub	al, 80h
  2448 00000F72 C1E008              <1> 	shl	ax, 8
  2449 00000F75 AB                  <1> 	stosw		; original sample (left channel)
  2450                              <1> 
  2451 00000F76 AC                  <1> 	lodsb
  2452 00000F77 2C80                <1> 	sub	al, 80h
  2453 00000F79 C1E008              <1> 	shl	ax, 8
  2454 00000F7C AB                  <1> 	stosw		; original sample (right channel)
  2455                              <1> 		
  2456                              <1> 	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2457 00000F7D 49                  <1> 	dec	cx
  2458 00000F7E 75B5                <1> 	jnz	short lff32s_1
  2459                              <1> lff32s_3:
  2460 00000F80 E958F9              <1> 	jmp	lff32_3
  2461                              <1> 
  2462                              <1> load_32khz_mono_16_bit:
  2463                              <1> 	; 15/11/2023
  2464 00000F83 F606[A617]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2465                              <1> 					; last of the file?
  2466 00000F88 7402                <1> 	jz	short lff32m2_0		; no
  2467 00000F8A F9                  <1> 	stc
  2468 00000F8B C3                  <1> 	retn
  2469                              <1> 
  2470                              <1> lff32m2_0:
  2471 00000F8C 8EC0                <1> 	mov	es, ax ; buffer segment	
  2472 00000F8E 31FF                <1> 	xor	di, di
  2473 00000F90 BA[CC17]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2474                              <1> 	; ds = cs
  2475                              <1> 
  2476                              <1> 	; load file into memory
  2477 00000F93 8B0E[4706]          <1>         mov	cx, [loadsize]
  2478 00000F97 8B1E[A417]          <1> 	mov	bx, [filehandle]
  2479 00000F9B B43F                <1>        	mov	ah, 3Fh
  2480 00000F9D CD21                <1> 	int	21h
  2481 00000F9F 722C                <1> 	jc	short lff32m2_7 ; error !
  2482                              <1> 
  2483 00000FA1 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2484                              <1> 	
  2485 00000FA3 D1E8                <1> 	shr	ax, 1
  2486                              <1> 	;and	ax, ax
  2487 00000FA5 7503                <1> 	jnz	short lff32m2_8
  2488 00000FA7 E944F9              <1> 	jmp	lff32_eof
  2489                              <1> 
  2490                              <1> lff32m2_8:
  2491 00000FAA 89C1                <1> 	mov	cx, ax	; word count
  2492                              <1> lff32m2_1:
  2493 00000FAC AD                  <1> 	lodsw
  2494 00000FAD AB                  <1> 	stosw		; original sample (left channel)
  2495 00000FAE AB                  <1> 	stosw		; original sample (right channel)
  2496 00000FAF 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  2497                              <1> 	;mov	[previous_val], ax
  2498                              <1> 	;mov	bx, ax	
  2499                              <1> 	;xor	ax, ax
  2500 00000FB2 31DB                <1> 	xor	bx, bx
  2501 00000FB4 49                  <1> 	dec	cx
  2502 00000FB5 7402                <1> 	jz	short lff32m2_2
  2503                              <1> 	;mov	ax, [si
  2504 00000FB7 8B1C                <1> 	mov	bx, [si]
  2505                              <1> lff32m2_2:
  2506                              <1> 	;add	ah, 80h ; convert sound level 0 to 65535 format
  2507                              <1> 	;mov	bp, ax	; [next_val]
  2508                              <1> 	;add	ax, [previous_val]
  2509                              <1> 	; ax = [previous_val]
  2510                              <1> 	; bx = [next_val]
  2511 00000FB9 01D8                <1> 	add	ax, bx
  2512 00000FBB D1D8                <1> 	rcr	ax, 1
  2513 00000FBD 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2514 00000FC0 AB                  <1> 	stosw		; this is interpolated sample (L)
  2515 00000FC1 AB                  <1> 	stosw		; this is interpolated sample (R)
  2516                              <1> 
  2517                              <1> 	; different than 8-16-24 kHZ !
  2518                              <1> 	; 'original-interpolated-original' trio samples 
  2519 00000FC2 E306                <1> 	jcxz	lff32m2_3
  2520                              <1> 
  2521 00000FC4 AD                  <1> 	lodsw
  2522 00000FC5 AB                  <1> 	stosw		; original sample (left channel)
  2523 00000FC6 AB                  <1> 	stosw		; original sample (right channel)
  2524                              <1> 
  2525                              <1> 	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2526 00000FC7 49                  <1> 	dec	cx
  2527 00000FC8 75E2                <1> 	jnz	short lff32m2_1
  2528                              <1> lff32m2_3:
  2529 00000FCA E90EF9              <1> 	jmp	lff32_3
  2530                              <1> 
  2531                              <1> lff32m2_7:
  2532                              <1> lff32s2_7:
  2533 00000FCD E925F9              <1> 	jmp	lff32_5  ; error
  2534                              <1> 
  2535                              <1> load_32khz_stereo_16_bit:
  2536                              <1> 	 ;16/11/2023
  2537                              <1> 	; 15/11/2023
  2538 00000FD0 F606[A617]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2539                              <1> 					; last of the file?
  2540 00000FD5 7402                <1> 	jz	short lff32s2_0		; no
  2541 00000FD7 F9                  <1> 	stc
  2542 00000FD8 C3                  <1> 	retn
  2543                              <1> 
  2544                              <1> lff32s2_0:
  2545 00000FD9 8EC0                <1> 	mov	es, ax ; buffer segment	
  2546 00000FDB 31FF                <1> 	xor	di, di
  2547 00000FDD BA[CC17]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2548                              <1> 	; ds = cs
  2549                              <1> 
  2550                              <1> 	; load file into memory
  2551 00000FE0 8B0E[4706]          <1>         mov	cx, [loadsize]
  2552 00000FE4 8B1E[A417]          <1> 	mov	bx, [filehandle]
  2553 00000FE8 B43F                <1>        	mov	ah, 3Fh
  2554 00000FEA CD21                <1> 	int	21h
  2555 00000FEC 72DF                <1> 	jc	short lff32s2_7 ; error !
  2556                              <1> 
  2557 00000FEE 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2558                              <1> 	
  2559 00000FF0 C1E802              <1> 	shr	ax, 2	; 16/11/2023 (word left ch + word right ch) 
  2560                              <1> 	;and	ax, ax
  2561 00000FF3 7503                <1> 	jnz	short lff32s2_8
  2562 00000FF5 E9F6F8              <1> 	jmp	lff32_eof
  2563                              <1> 
  2564                              <1> lff32s2_8:
  2565 00000FF8 89C1                <1> 	mov	cx, ax		; dword count
  2566                              <1> lff32s2_1:
  2567 00000FFA AD                  <1> 	lodsw
  2568 00000FFB AB                  <1> 	stosw		; original sample (L)
  2569 00000FFC 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2570 00000FFF A3[4513]            <1> 	mov	[previous_val_l], ax
  2571 00001002 AD                  <1> 	lodsw
  2572 00001003 AB                  <1> 	stosw		; original sample (R)
  2573 00001004 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2574                              <1> 	;mov	[previous_val_r], ax
  2575 00001007 89C3                <1> 	mov	bx, ax
  2576 00001009 31D2                <1> 	xor	dx, dx
  2577 0000100B 31C0                <1> 	xor	ax, ax
  2578                              <1> 	; 16/11/2023
  2579 0000100D 49                  <1> 	dec	cx
  2580 0000100E 7405                <1> 	jz	short lff32s2_2
  2581 00001010 8B04                <1> 	mov	ax, [si]
  2582 00001012 8B5402              <1> 	mov	dx, [si+2]
  2583                              <1> lff32s2_2:
  2584 00001015 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2585                              <1> 	;;mov	[next_val_l], ax
  2586                              <1> 	;mov	bp, ax
  2587 00001018 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format 
  2588                              <1> 	;mov	[next_val_r], dx
  2589 0000101B 0306[4513]          <1> 	add	ax, [previous_val_l]
  2590 0000101F D1D8                <1> 	rcr	ax, 1
  2591 00001021 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  2592 00001024 AB                  <1> 	stosw		; this is interpolated sample (L)
  2593                              <1> 	;mov	ax, [next_val_r]
  2594 00001025 89D0                <1> 	mov	ax, dx
  2595                              <1> 	;add	ax, [previous_val_r]
  2596 00001027 01D8                <1> 	add	ax, bx
  2597 00001029 D1D8                <1> 	rcr	ax, 1
  2598 0000102B 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2599 0000102E AB                  <1> 	stosw		; this is interpolated sample (R)
  2600                              <1> 
  2601                              <1> 	; different than 8-16-24 kHZ !
  2602                              <1> 	; 'original-interpolated-original' trio samples 
  2603 0000102F E307                <1> 	jcxz	lff32s2_3
  2604                              <1> 
  2605 00001031 AD                  <1> 	lodsw
  2606 00001032 AB                  <1> 	stosw	; original sample (L)
  2607 00001033 AD                  <1> 	lodsw
  2608 00001034 AB                  <1> 	stosw	; original sample (R)
  2609                              <1> 	
  2610                              <1> 	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2611 00001035 49                  <1> 	dec	cx
  2612 00001036 75C2                <1> 	jnz	short lff32s2_1
  2613                              <1> lff32s2_3:
  2614 00001038 E9A0F8              <1> 	jmp	lff32_3
  2615                              <1> 
  2616                              <1> ; .....................
  2617                              <1> 
  2618                              <1> load_22khz_mono_8_bit:
  2619                              <1> 	; 16/11/2023
  2620 0000103B F606[A617]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2621                              <1> 					; last of the file?
  2622 00001040 7402                <1> 	jz	short lff22m_0		; no
  2623 00001042 F9                  <1> 	stc
  2624 00001043 C3                  <1> 	retn
  2625                              <1> 
  2626                              <1> lff22m_0:
  2627 00001044 8EC0                <1> 	mov	es, ax ; buffer segment	
  2628 00001046 31FF                <1> 	xor	di, di
  2629 00001048 BA[CC17]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2630                              <1> 	; ds = cs
  2631                              <1> 
  2632                              <1> 	; load file into memory
  2633 0000104B 8B0E[4706]          <1>         mov	cx, [loadsize]
  2634 0000104F 8B1E[A417]          <1> 	mov	bx, [filehandle]
  2635 00001053 B43F                <1>        	mov	ah, 3Fh
  2636 00001055 CD21                <1> 	int	21h
  2637 00001057 7248                <1> 	jc	short lff22m_7 ; error !
  2638                              <1> 
  2639 00001059 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2640                              <1> 	
  2641 0000105B 21C0                <1> 	and	ax, ax
  2642 0000105D 7503                <1> 	jnz	short lff22m_8
  2643 0000105F E98CF8              <1> 	jmp	lff22_eof
  2644                              <1> 
  2645                              <1> lff22m_8:
  2646 00001062 89C1                <1> 	mov	cx, ax		; byte count
  2647                              <1> lff22m_9:
  2648 00001064 BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2649 00001067 C606[4D13]03        <1> 	mov	byte [faz], 3  ; 3 steps/phases
  2650                              <1> lff22m_1:
  2651                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2652 0000106C AC                  <1> 	lodsb
  2653 0000106D 31D2                <1> 	xor	dx, dx
  2654 0000106F 49                  <1> 	dec	cx
  2655 00001070 7402                <1> 	jz	short lff22m_2_1
  2656 00001072 8A14                <1> 	mov	dl, [si]
  2657                              <1> lff22m_2_1:	
  2658                              <1> 	; al = [previous_val]
  2659                              <1> 	; dl = [next_val]
  2660 00001074 E87A01              <1> 	call	interpolating_3_8bit_mono ; 1 of 17
  2661 00001077 E325                <1> 	jcxz	lff22m_3
  2662                              <1> lff22m_2_2:
  2663 00001079 AC                  <1> 	lodsb
  2664 0000107A 31D2                <1> 	xor	dx, dx
  2665 0000107C 49                  <1> 	dec	cx
  2666 0000107D 7402                <1> 	jz	short lff22m_2_3
  2667 0000107F 8A14                <1> 	mov	dl, [si]
  2668                              <1> lff22m_2_3:
  2669 00001081 E8DC01              <1>  	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  2670 00001084 E318                <1> 	jcxz	lff22m_3
  2671 00001086 4D                  <1> 	dec	bp
  2672 00001087 75F0                <1> 	jnz	short lff22m_2_2
  2673                              <1> 
  2674 00001089 A0[4D13]            <1> 	mov	al, [faz]
  2675 0000108C FEC8                <1> 	dec	al
  2676 0000108E 74D4                <1> 	jz	short lff22m_9
  2677 00001090 FE0E[4D13]          <1> 	dec	byte [faz]
  2678 00001094 BD0400              <1> 	mov	bp, 4
  2679 00001097 FEC8                <1> 	dec	al
  2680 00001099 75D1                <1> 	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  2681 0000109B 45                  <1> 	inc	bp ; 5
  2682 0000109C EBCE                <1> 	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2683                              <1> 
  2684                              <1> lff22m_3:
  2685                              <1> lff22s_3:
  2686 0000109E E93AF8              <1> 	jmp	lff22_3	; padfill
  2687                              <1> 		; (put zeros in the remain words of the buffer)
  2688                              <1> lff22m_7:
  2689                              <1> lff22s_7:
  2690 000010A1 E951F8              <1> 	jmp	lff22_5  ; error
  2691                              <1> 
  2692                              <1> load_22khz_stereo_8_bit:
  2693                              <1> 	; 16/11/2023
  2694 000010A4 F606[A617]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2695                              <1> 					; last of the file?
  2696 000010A9 7402                <1> 	jz	short lff22s_0		; no
  2697 000010AB F9                  <1> 	stc
  2698 000010AC C3                  <1> 	retn
  2699                              <1> 
  2700                              <1> lff22s_0:
  2701 000010AD 8EC0                <1> 	mov	es, ax ; buffer segment	
  2702 000010AF 31FF                <1> 	xor	di, di
  2703 000010B1 BA[CC17]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2704                              <1> 	; ds = cs
  2705                              <1> 
  2706                              <1> 	; load file into memory
  2707 000010B4 8B0E[4706]          <1>         mov	cx, [loadsize]
  2708 000010B8 8B1E[A417]          <1> 	mov	bx, [filehandle]
  2709 000010BC B43F                <1>        	mov	ah, 3Fh
  2710 000010BE CD21                <1> 	int	21h
  2711 000010C0 72DF                <1> 	jc	short lff22s_7 ; error !
  2712                              <1> 
  2713 000010C2 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2714                              <1> 	
  2715 000010C4 D1E8                <1> 	shr	ax, 1
  2716                              <1> 	;and	ax, ax
  2717 000010C6 7503                <1> 	jnz	short lff22s_8
  2718 000010C8 E923F8              <1> 	jmp	lff22_eof
  2719                              <1> 
  2720                              <1> lff22s_8:
  2721 000010CB 89C1                <1> 	mov	cx, ax		; word count
  2722                              <1> lff22s_9:
  2723 000010CD BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2724 000010D0 C606[4D13]03        <1> 	mov	byte [faz], 3  ; 3 steps/phase
  2725                              <1> lff22s_1:
  2726                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2727 000010D5 AD                  <1> 	lodsw
  2728 000010D6 31D2                <1> 	xor	dx, dx
  2729 000010D8 49                  <1> 	dec	cx
  2730 000010D9 7402                <1> 	jz	short lff22s_2_1 
  2731 000010DB 8B14                <1> 	mov	dx, [si]
  2732                              <1> lff22s_2_1:	
  2733                              <1> 	; al = [previous_val_l]
  2734                              <1> 	; ah = [previous_val_r]
  2735                              <1> 	; dl = [next_val_l]
  2736                              <1> 	; dl = [next_val_r]	
  2737 000010DD E81101              <1> 	call	interpolating_3_8bit_mono ; 1 of 17 
  2738 000010E0 E3BC                <1> 	jcxz	lff22s_3
  2739                              <1> lff22s_2_2:
  2740 000010E2 AD                  <1> 	lodsw
  2741 000010E3 31D2                <1> 	xor	dx, dx
  2742 000010E5 49                  <1> 	dec	cx
  2743 000010E6 7402                <1> 	jz	short lff22s_2_3
  2744 000010E8 8B14                <1> 	mov	dx, [si]
  2745                              <1> lff22s_2_3:
  2746 000010EA E87301              <1>  	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  2747 000010ED E3AF                <1> 	jcxz	lff22s_3
  2748 000010EF 4D                  <1> 	dec	bp
  2749 000010F0 75F0                <1> 	jnz	short lff22s_2_2
  2750                              <1> 
  2751 000010F2 A0[4D13]            <1> 	mov	al, [faz]
  2752 000010F5 FEC8                <1> 	dec	al
  2753 000010F7 74D4                <1> 	jz	short lff22s_9
  2754 000010F9 FE0E[4D13]          <1> 	dec	byte [faz]
  2755 000010FD BD0400              <1> 	mov	bp, 4
  2756 00001100 FEC8                <1> 	dec	al
  2757 00001102 75D1                <1> 	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  2758 00001104 45                  <1> 	inc	bp ; 5
  2759 00001105 EBCE                <1> 	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2760                              <1> 
  2761                              <1> load_22khz_mono_16_bit:
  2762                              <1> 	; 16/11/2023
  2763 00001107 F606[A617]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2764                              <1> 					; last of the file?
  2765 0000110C 7402                <1> 	jz	short lff22m2_0		; no
  2766 0000110E F9                  <1> 	stc
  2767 0000110F C3                  <1> 	retn
  2768                              <1> 
  2769                              <1> lff22m2_0:
  2770 00001110 8EC0                <1> 	mov	es, ax ; buffer segment	
  2771 00001112 31FF                <1> 	xor	di, di
  2772 00001114 BA[CC17]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2773                              <1> 	; ds = cs
  2774                              <1> 
  2775                              <1> 	; load file into memory
  2776 00001117 8B0E[4706]          <1>         mov	cx, [loadsize]
  2777 0000111B 8B1E[A417]          <1> 	mov	bx, [filehandle]
  2778 0000111F B43F                <1>        	mov	ah, 3Fh
  2779 00001121 CD21                <1> 	int	21h
  2780 00001123 7248                <1> 	jc	short lff22m2_7 ; error !
  2781                              <1> 
  2782 00001125 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2783                              <1> 	
  2784 00001127 D1E8                <1> 	shr	ax, 1
  2785                              <1> 	;and	ax, ax
  2786 00001129 7503                <1> 	jnz	short lff22m2_8
  2787 0000112B E9C0F7              <1> 	jmp	lff22_eof
  2788                              <1> 
  2789                              <1> lff22m2_8:
  2790 0000112E 89C1                <1> 	mov	cx, ax		; byte count
  2791                              <1> lff22m2_9:
  2792 00001130 BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2793 00001133 C606[4D13]03        <1> 	mov	byte [faz], 3  ; 3 steps/phases
  2794                              <1> lff22m2_1:
  2795                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2796 00001138 AD                  <1> 	lodsw
  2797 00001139 31D2                <1> 	xor	dx, dx
  2798 0000113B 49                  <1> 	dec	cx
  2799 0000113C 7402                <1> 	jz	short lff22m2_2_1
  2800 0000113E 8B14                <1> 	mov	dx, [si]
  2801                              <1> lff22m2_2_1:	
  2802                              <1> 	; ax = [previous_val]
  2803                              <1> 	; dx = [next_val]
  2804 00001140 E85D01              <1> 	call	interpolating_3_16bit_mono ; 1 of 17
  2805 00001143 E325                <1> 	jcxz	lff22m2_3
  2806                              <1> lff22m2_2_2:
  2807 00001145 AD                  <1> 	lodsw
  2808 00001146 31D2                <1> 	xor	dx, dx
  2809 00001148 49                  <1> 	dec	cx
  2810 00001149 7402                <1> 	jz	short lff22m2_2_3
  2811 0000114B 8B14                <1> 	mov	dx, [si]
  2812                              <1> lff22m2_2_3:
  2813 0000114D E8BD01              <1>  	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  2814 00001150 E318                <1> 	jcxz	lff22m2_3
  2815 00001152 4D                  <1> 	dec	bp
  2816 00001153 75F0                <1> 	jnz	short lff22m2_2_2
  2817                              <1> 
  2818 00001155 A0[4D13]            <1> 	mov	al, [faz]
  2819 00001158 FEC8                <1> 	dec	al
  2820 0000115A 74D4                <1> 	jz	short lff22m2_9
  2821 0000115C FE0E[4D13]          <1> 	dec	byte [faz]
  2822 00001160 BD0400              <1> 	mov	bp, 4
  2823 00001163 FEC8                <1> 	dec	al
  2824 00001165 75D1                <1> 	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2825 00001167 45                  <1> 	inc	bp ; 5
  2826 00001168 EBCE                <1> 	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2827                              <1> 
  2828                              <1> lff22m2_3:
  2829                              <1> lff22s2_3:
  2830 0000116A E96EF7              <1> 	jmp	lff22_3	; padfill
  2831                              <1> 		; (put zeros in the remain words of the buffer)
  2832                              <1> lff22m2_7:
  2833                              <1> lff22s2_7:
  2834 0000116D E985F7              <1> 	jmp	lff22_5  ; error
  2835                              <1> 
  2836                              <1> load_22khz_stereo_16_bit:
  2837                              <1> 	; 16/11/2023
  2838 00001170 F606[A617]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2839                              <1> 					; last of the file?
  2840 00001175 7402                <1> 	jz	short lff22s2_0		; no
  2841 00001177 F9                  <1> 	stc
  2842 00001178 C3                  <1> 	retn
  2843                              <1> 
  2844                              <1> lff22s2_0:
  2845 00001179 8EC0                <1> 	mov	es, ax ; buffer segment	
  2846 0000117B 31FF                <1> 	xor	di, di
  2847 0000117D BA[CC17]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2848                              <1> 	; ds = cs
  2849                              <1> 
  2850                              <1> 	; load file into memory
  2851 00001180 8B0E[4706]          <1>         mov	cx, [loadsize]
  2852 00001184 8B1E[A417]          <1> 	mov	bx, [filehandle]
  2853 00001188 B43F                <1>        	mov	ah, 3Fh
  2854 0000118A CD21                <1> 	int	21h
  2855 0000118C 72DF                <1> 	jc	short lff22s2_7 ; error !
  2856                              <1> 
  2857 0000118E 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2858                              <1> 	
  2859 00001190 C1E802              <1> 	shr	ax, 2	; dword (left chan word + right chan word)
  2860                              <1> 	;and	ax, ax
  2861 00001193 7503                <1> 	jnz	short lff22s2_8
  2862 00001195 E956F7              <1> 	jmp	lff22_eof
  2863                              <1> 
  2864                              <1> lff22s2_8:
  2865 00001198 89C1                <1> 	mov	cx, ax		; dword count
  2866                              <1> lff22s2_9:
  2867 0000119A BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2868 0000119D C606[4D13]03        <1> 	mov	byte [faz], 3  ; 3 steps/phase
  2869                              <1> lff22s2_1:
  2870                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2871 000011A2 AD                  <1> 	lodsw
  2872 000011A3 89C3                <1> 	mov	bx, ax
  2873 000011A5 AD                  <1> 	lodsw
  2874 000011A6 8B14                <1> 	mov	dx, [si]
  2875 000011A8 8916[4913]          <1> 	mov	[next_val_l], dx
  2876 000011AC 8B5402              <1> 	mov	dx, [si+2]
  2877 000011AF 49                  <1> 	dec	cx
  2878 000011B0 7506                <1> 	jnz	short lff22s2_2_1
  2879 000011B2 31D2                <1> 	xor	dx, dx ; 0
  2880 000011B4 8916[4913]          <1> 	mov	[next_val_l], dx
  2881                              <1> lff22s2_2_1:
  2882                              <1> 	; bx = [previous_val_l]
  2883                              <1> 	; ax = [previous_val_r]
  2884                              <1> 	; [next_val_l]
  2885                              <1> 	; dx = [next_val_r]
  2886 000011B8 E80901              <1> 	call	interpolating_3_16bit_stereo ; 1 of 17 
  2887 000011BB E3AD                <1> 	jcxz	lff22s2_3
  2888                              <1> lff22s2_2_2:
  2889 000011BD AD                  <1> 	lodsw
  2890 000011BE 89C3                <1> 	mov	bx, ax
  2891 000011C0 AD                  <1> 	lodsw
  2892 000011C1 8B14                <1> 	mov	dx, [si]
  2893 000011C3 8916[4913]          <1> 	mov	[next_val_l], dx
  2894 000011C7 8B5402              <1> 	mov	dx, [si+2]
  2895 000011CA 49                  <1> 	dec	cx
  2896 000011CB 7506                <1> 	jnz	short lff22s2_2_3
  2897 000011CD 31D2                <1> 	xor	dx, dx ; 0
  2898 000011CF 8916[4913]          <1> 	mov	[next_val_l], dx
  2899                              <1> lff22s2_2_3:
  2900 000011D3 E84901              <1>  	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  2901 000011D6 E392                <1> 	jcxz	lff22s2_3
  2902 000011D8 4D                  <1> 	dec	bp
  2903 000011D9 75E2                <1> 	jnz	short lff22s2_2_2
  2904                              <1> 
  2905 000011DB A0[4D13]            <1> 	mov	al, [faz]
  2906 000011DE FEC8                <1> 	dec	al
  2907 000011E0 74B8                <1> 	jz	short lff22s2_9
  2908 000011E2 FE0E[4D13]          <1> 	dec	byte [faz]
  2909 000011E6 BD0400              <1> 	mov	bp, 4
  2910 000011E9 FEC8                <1> 	dec	al
  2911 000011EB 75B5                <1> 	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2912 000011ED 45                  <1> 	inc	bp ; 5
  2913 000011EE EBB2                <1> 	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2914                              <1> 
  2915                              <1> ; .....................
  2916                              <1> 
  2917                              <1> load_11khz_stereo_16_bit:
  2918                              <1> load_11khz_mono_16_bit:
  2919                              <1> load_11khz_stereo_8_bit:
  2920                              <1> load_11khz_mono_8_bit:
  2921                              <1> load_44khz_stereo_16_bit:
  2922                              <1> load_44khz_mono_16_bit:
  2923                              <1> load_44khz_stereo_8_bit:
  2924                              <1> load_44khz_mono_8_bit:
  2925 000011F0 C3                  <1> 	retn
  2926                              <1> 
  2927                              <1> interpolating_3_8bit_mono:
  2928                              <1> 	; 16/11/2023
  2929                              <1> 	; al = [previous_val]
  2930                              <1> 	; dl = [next_val]
  2931                              <1> 	; original-interpolated-interpolated
  2932 000011F1 88C3                <1> 	mov	bl, al
  2933 000011F3 2C80                <1> 	sub	al, 80h
  2934 000011F5 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2935 000011F8 AB                  <1> 	stosw		; original sample (L)
  2936 000011F9 AB                  <1> 	stosw		; original sample (R)
  2937 000011FA 88D8                <1> 	mov	al, bl
  2938 000011FC 00D0                <1> 	add	al, dl	
  2939 000011FE D0D8                <1> 	rcr	al, 1
  2940 00001200 88C7                <1> 	mov	bh, al	; interpolated middle (temporary)
  2941 00001202 00D8                <1> 	add	al, bl
  2942 00001204 D0D8                <1> 	rcr	al, 1
  2943 00001206 2C80                <1> 	sub	al, 80h
  2944 00001208 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2945 0000120B AB                  <1> 	stosw		; interpolated sample 1 (L)
  2946 0000120C AB                  <1> 	stosw		; interpolated sample 1 (R)
  2947 0000120D 88F8                <1> 	mov	al, bh
  2948 0000120F 00D0                <1> 	add	al, dl	; [next_val]
  2949 00001211 D0D8                <1> 	rcr	al, 1
  2950 00001213 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2951 00001216 AB                  <1> 	stosw		; interpolated sample 2 (L)
  2952 00001217 AB                  <1> 	stosw		; interpolated sample 2 (R)
  2953 00001218 C3                  <1> 	retn
  2954                              <1> 
  2955                              <1> interpolating_3_8bit_stereo:
  2956                              <1> 	; 16/11/2023
  2957                              <1> 	; al = [previous_val_l]
  2958                              <1> 	; ah = [previous_val_r]
  2959                              <1> 	; dl = [next_val_l]
  2960                              <1> 	; dh = [next_val_r]	
  2961                              <1> 	; original-interpolated-interpolated
  2962 00001219 89C3                <1> 	mov	bx, ax
  2963 0000121B 2C80                <1> 	sub	al, 80h
  2964 0000121D C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2965 00001220 AB                  <1> 	stosw		; original sample (L)
  2966 00001221 88F8                <1> 	mov	al, bh
  2967 00001223 2C80                <1> 	sub	al, 80h
  2968 00001225 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2969 00001228 AB                  <1> 	stosw		; original sample (R)
  2970 00001229 88D8                <1> 	mov	al, bl
  2971 0000122B 00D0                <1> 	add	al, dl	; [next_val_l]	
  2972 0000122D D0D8                <1> 	rcr	al, 1
  2973 0000122F 50                  <1> 	push	ax ; *	; al = interpolated middle (L) (temporary)
  2974 00001230 00D8                <1> 	add	al, bl	; [previous_val_l]
  2975 00001232 D0D8                <1> 	rcr	al, 1
  2976 00001234 2C80                <1> 	sub	al, 80h
  2977 00001236 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2978 00001239 AB                  <1> 	stosw		; interpolated sample 1 (L)
  2979 0000123A 88F8                <1> 	mov	al, bh
  2980 0000123C 00F0                <1> 	add	al, dh	; [next_val_r]
  2981 0000123E D0D8                <1> 	rcr	al, 1
  2982 00001240 50                  <1> 	push	ax ; ** ; al = interpolated middle (R) (temporary)
  2983 00001241 00F8                <1> 	add	al, bh	; [previous_val_r]
  2984 00001243 D0D8                <1> 	rcr	al, 1
  2985 00001245 2C80                <1> 	sub	al, 80h
  2986 00001247 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2987 0000124A AB                  <1> 	stosw		; interpolated sample 1 (R)
  2988 0000124B 5B                  <1> 	pop	bx ; **
  2989 0000124C 58                  <1> 	pop	ax ; *
  2990 0000124D 00D0                <1> 	add	al, dl	; [next_val_l]
  2991 0000124F D0D8                <1> 	rcr	al, 1
  2992 00001251 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2993 00001254 AB                  <1> 	stosw		; interpolated sample 2 (L)
  2994 00001255 88D8                <1> 	mov	al, bl
  2995 00001257 00F0                <1> 	add	al, dh	; [next_val_r]
  2996 00001259 D0D8                <1> 	rcr	al, 1
  2997 0000125B C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2998 0000125E AB                  <1> 	stosw		; interpolated sample 2 (R)
  2999 0000125F C3                  <1> 	retn
  3000                              <1> 
  3001                              <1> interpolating_2_8bit_mono:
  3002                              <1> 	; 16/11/2023
  3003                              <1> 	; al = [previous_val]
  3004                              <1> 	; dl = [next_val]
  3005                              <1> 	; original-interpolated
  3006 00001260 88C3                <1> 	mov	bl, al
  3007 00001262 2C80                <1> 	sub	al, 80h
  3008 00001264 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3009 00001267 AB                  <1> 	stosw		; original sample (L)
  3010 00001268 AB                  <1> 	stosw		; original sample (R)
  3011 00001269 88D8                <1> 	mov	al, bl
  3012 0000126B 00D0                <1> 	add	al, dl	
  3013 0000126D D0D8                <1> 	rcr	al, 1
  3014 0000126F 2C80                <1> 	sub	al, 80h
  3015 00001271 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3016 00001274 AB                  <1> 	stosw		; interpolated sample (L)
  3017 00001275 AB                  <1> 	stosw		; interpolated sample (R)
  3018 00001276 C3                  <1> 	retn
  3019                              <1> 
  3020                              <1> interpolating_2_8bit_stereo:
  3021                              <1> 	; 16/11/2023
  3022                              <1> 	; al = [previous_val_l]
  3023                              <1> 	; ah = [previous_val_r]
  3024                              <1> 	; dl = [next_val_l]
  3025                              <1> 	; dh = [next_val_r]	
  3026                              <1> 	; original-interpolated
  3027 00001277 89C3                <1> 	mov	bx, ax
  3028 00001279 2C80                <1> 	sub	al, 80h
  3029 0000127B C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3030 0000127E AB                  <1> 	stosw		; original sample (L)
  3031 0000127F 88F8                <1> 	mov	al, bh
  3032 00001281 2C80                <1> 	sub	al, 80h
  3033 00001283 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3034 00001286 AB                  <1> 	stosw		; original sample (R)
  3035 00001287 88D8                <1> 	mov	al, bl	; [previous_val_l]
  3036 00001289 00D0                <1> 	add	al, dl	; [next_val_l]	
  3037 0000128B D0D8                <1> 	rcr	al, 1
  3038 0000128D 2C80                <1> 	sub	al, 80h
  3039 0000128F C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3040 00001292 AB                  <1> 	stosw		; interpolated sample (L)
  3041 00001293 88F8                <1> 	mov	al, bh
  3042 00001295 00F0                <1> 	add	al, dh	; [next_val_r]
  3043 00001297 D0D8                <1> 	rcr	al, 1
  3044 00001299 2C80                <1> 	sub	al, 80h
  3045 0000129B C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3046 0000129E AB                  <1> 	stosw		; interpolated sample (R)
  3047 0000129F C3                  <1> 	retn
  3048                              <1> 
  3049                              <1> interpolating_3_16bit_mono:
  3050                              <1> 	; 16/11/2023
  3051                              <1> 	; ax = [previous_val]
  3052                              <1> 	; dx = [next_val]
  3053                              <1> 	; original-interpolated-interpolated
  3054                              <1> 
  3055 000012A0 AB                  <1> 	stosw		; original sample (L)
  3056 000012A1 AB                  <1> 	stosw		; original sample (R)
  3057 000012A2 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3058 000012A5 50                  <1> 	push	ax ; *	; [previous_val]
  3059 000012A6 80C680              <1> 	add	dh, 80h
  3060 000012A9 01D0                <1> 	add	ax, dx
  3061 000012AB D1D8                <1> 	rcr	ax, 1
  3062 000012AD 5B                  <1> 	pop	bx ; *		
  3063 000012AE 93                  <1> 	xchg	bx, ax	; bx  = interpolated middle (temporary)
  3064 000012AF 01D8                <1> 	add	ax, bx	; [previous_val] + interpolated middle
  3065 000012B1 D1D8                <1> 	rcr	ax, 1
  3066 000012B3 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3067 000012B6 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3068 000012B7 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3069 000012B8 89D8                <1> 	mov	ax, bx
  3070 000012BA 01D0                <1> 	add	ax, dx	 ;interpolated middle + [next_val]
  3071 000012BC D1D8                <1> 	rcr	ax, 1
  3072 000012BE 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3073 000012C1 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3074 000012C2 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3075 000012C3 C3                  <1> 	retn
  3076                              <1> 
  3077                              <1> interpolating_3_16bit_stereo:
  3078                              <1> 	; 16/11/2023
  3079                              <1> 	; bx = [previous_val_l]
  3080                              <1> 	; ax = [previous_val_r]
  3081                              <1> 	; [next_val_l]
  3082                              <1> 	; dx = [next_val_r]
  3083                              <1> 	; original-interpolated-interpolated
  3084                              <1> 
  3085 000012C4 93                  <1> 	xchg	ax, bx
  3086 000012C5 AB                  <1> 	stosw		; original sample (L)
  3087 000012C6 93                  <1> 	xchg	ax, bx
  3088 000012C7 AB                  <1> 	stosw		; original sample (R)
  3089 000012C8 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3090 000012CB 50                  <1> 	push	ax ; *	; [previous_val_r]
  3091 000012CC 80C780              <1> 	add	bh, 80h
  3092 000012CF 8006[4A13]80        <1> 	add	byte [next_val_l+1], 80h
  3093 000012D4 A1[4913]            <1> 	mov	ax, [next_val_l]
  3094 000012D7 01D8                <1> 	add	ax, bx	; [previous_val_l]
  3095 000012D9 D1D8                <1> 	rcr	ax, 1
  3096 000012DB 93                  <1> 	xchg	ax, bx	; ax = [previous_val_l]	
  3097 000012DC 01D8                <1> 	add	ax, bx	; bx = interpolated middle (L)
  3098 000012DE D1D8                <1> 	rcr	ax, 1
  3099 000012E0 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3100 000012E3 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3101 000012E4 58                  <1> 	pop	ax  ; *
  3102 000012E5 80C680              <1> 	add	dh, 80h ; convert sound level 0 to 65535 format
  3103 000012E8 52                  <1> 	push	dx  ; * ; [next_val_r]
  3104 000012E9 92                  <1> 	xchg	ax, dx
  3105 000012EA 01D0                <1> 	add	ax, dx	; [next_val_r] + [previous_val_r]
  3106 000012EC D1D8                <1> 	rcr	ax, 1	; / 2
  3107 000012EE 50                  <1> 	push	ax ; ** ; interpolated middle (R)
  3108 000012EF 01D0                <1> 	add	ax, dx	; + [previous_val_r]
  3109 000012F1 D1D8                <1> 	rcr	ax, 1
  3110 000012F3 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3111 000012F6 AB                  <1> 	stosw 		; interpolated sample 1 (R)
  3112 000012F7 A1[4913]            <1> 	mov	ax, [next_val_l]
  3113 000012FA 01D8                <1> 	add	ax, bx	; + interpolated middle (L)
  3114 000012FC D1D8                <1> 	rcr	ax, 1
  3115 000012FE 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3116 00001301 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  3117 00001302 58                  <1> 	pop	ax ; **
  3118 00001303 5A                  <1> 	pop	dx ; *	
  3119 00001304 01D0                <1> 	add	ax, dx	; interpolated middle + [next_val_r]
  3120 00001306 D1D8                <1> 	rcr	ax, 1	; / 2
  3121 00001308 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3122 0000130B AB                  <1> 	stosw 		; interpolated sample 2 (L)
  3123 0000130C C3                  <1> 	retn
  3124                              <1> 
  3125                              <1> interpolating_2_16bit_mono:
  3126                              <1> 	; 16/11/2023
  3127                              <1> 	; ax = [previous_val]
  3128                              <1> 	; dx = [next_val]
  3129                              <1> 	; original-interpolated
  3130                              <1> 
  3131 0000130D AB                  <1> 	stosw		; original sample (L)
  3132 0000130E AB                  <1> 	stosw		; original sample (R)
  3133 0000130F 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3134 00001312 80C680              <1> 	add	dh, 80h
  3135 00001315 01D0                <1> 	add	ax, dx
  3136 00001317 D1D8                <1> 	rcr	ax, 1
  3137 00001319 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3138 0000131C AB                  <1> 	stosw		; interpolated sample (L)
  3139 0000131D AB                  <1> 	stosw		; interpolated sample (R)
  3140 0000131E C3                  <1> 	retn
  3141                              <1> 
  3142                              <1> interpolating_2_16bit_stereo:
  3143                              <1> 	; 16/11/2023
  3144                              <1> 	; bx = [previous_val_l]
  3145                              <1> 	; ax = [previous_val_r]
  3146                              <1> 	; [next_val_l]
  3147                              <1> 	; dx = [next_val_r]
  3148                              <1> 	; original-interpolated
  3149                              <1> 
  3150 0000131F 93                  <1> 	xchg	ax, bx
  3151 00001320 AB                  <1> 	stosw		; original sample (L)
  3152 00001321 93                  <1> 	xchg	ax, bx
  3153 00001322 AB                  <1> 	stosw		; original sample (R)
  3154 00001323 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3155 00001326 80C680              <1> 	add	dh, 80h
  3156 00001329 01D0                <1> 	add	ax, dx	; [previous_val_r] + [next_val_r]
  3157 0000132B D1D8                <1> 	rcr	ax, 1	; / 2
  3158 0000132D 50                  <1> 	push	ax ; *	; interpolated sample (R)
  3159 0000132E A1[4913]            <1> 	mov	ax, [next_val_l]
  3160 00001331 80C480              <1> 	add	ah, 80h
  3161 00001334 80C780              <1> 	add	bh, 80h
  3162 00001337 01D8                <1> 	add	ax, bx	; [next_val_l] + [previous_val_l]
  3163 00001339 D1D8                <1> 	rcr	ax, 1	; / 2		
  3164 0000133B 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3165 0000133E AB                  <1> 	stosw 		; interpolated sample (L)
  3166 0000133F 58                  <1> 	pop	ax ; *	
  3167 00001340 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3168 00001343 AB                  <1> 	stosw 		; interpolated sample (R)
  3169 00001344 C3                  <1> 	retn
  3170                              <1> 
  3171                              <1> ; 13/11/2023
  3172                              <1> previous_val:
  3173 00001345 0000                <1> previous_val_l: dw 0
  3174 00001347 0000                <1> previous_val_r: dw 0
  3175                              <1> next_val:
  3176 00001349 0000                <1> next_val_l: dw 0
  3177 0000134B 0000                <1> next_val_r: dw 0
  3178                              <1> 
  3179                              <1> ; 16/11/2023
  3180 0000134D 00                  <1> faz:	db 0	
  3181                              <1> 	
  3182                              <1> ; --------------------------------------------------------
   453                                  
   454                                  ; UTILS.ASM
   455                                  ;----------------------------------------------------------------------------
   456                                  ;       delay1_4ms - Delay for 1/4 millisecond.
   457                                  ;		    1mS = 1000us
   458                                  ;       Entry:
   459                                  ;         None
   460                                  ;       Exit:
   461                                  ;	  None
   462                                  ;
   463                                  ;       Modified:
   464                                  ;         None
   465                                  ;
   466                                  PORTB			EQU	061h
   467                                    REFRESH_STATUS	EQU	010h		; Refresh signal status
   468                                  
   469                                  delay1_4ms:
   470 0000134E 50                              push    ax 
   471 0000134F 51                              push    cx
   472 00001350 B91000                          mov     cx, 16			; close enough.
   473 00001353 E461                    	in	al,PORTB
   474 00001355 2410                    	and	al,REFRESH_STATUS
   475 00001357 88C4                    	mov	ah,al			; Start toggle state
   476 00001359 09C9                    	or	cx, cx
   477 0000135B 7401                    	jz	short _d4ms1
   478 0000135D 41                      	inc	cx			; Throwaway first toggle
   479                                  _d4ms1:	
   480 0000135E E461                    	in	al,PORTB		; Read system control port
   481 00001360 2410                    	and	al,REFRESH_STATUS	; Refresh toggles 15.085 microseconds
   482 00001362 38C4                    	cmp	ah,al
   483 00001364 74F8                    	je	short _d4ms1		; Wait for state change
   484                                  
   485 00001366 88C4                    	mov	ah,al			; Update with new state
   486 00001368 49                      	dec	cx
   487 00001369 75F3                    	jnz	short _d4ms1
   488                                  
   489 0000136B 59                              pop     cx
   490 0000136C 58                              pop     ax
   491 0000136D C3                              retn
   492                                  
   493                                  	; 13/11/2016 - Erdogan Tan
   494                                  write_ac97_dev_info:
   495                                  	; BUS/DEV/FN
   496                                  	;	00000000BBBBBBBBDDDDDFFF00000000
   497                                  	; DEV/VENDOR
   498                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
   499                                  
   500 0000136E 30FF                    	xor	bh, bh
   501 00001370 668B36[BE17]            	mov	esi, [dev_vendor]
   502 00001375 89F0                    	mov	ax, si
   503 00001377 88C3                    	mov	bl, al
   504 00001379 88DA                    	mov	dl, bl
   505 0000137B 80E30F                  	and	bl, 0Fh
   506 0000137E 8A87[3616]              	mov	al, [bx+hex_chars]
   507 00001382 A2[7916]                	mov	[msgVendorId+3], al
   508 00001385 88D3                    	mov	bl, dl
   509 00001387 C0EB04                  	shr	bl, 4
   510 0000138A 8A87[3616]              	mov	al, [bx+hex_chars]
   511 0000138E A2[7816]                	mov	[msgVendorId+2], al
   512 00001391 88E3                    	mov	bl, ah
   513 00001393 88DA                    	mov	dl, bl
   514 00001395 80E30F                  	and	bl, 0Fh
   515 00001398 8A87[3616]              	mov	al, [bx+hex_chars]
   516 0000139C A2[7716]                	mov	[msgVendorId+1], al
   517 0000139F 88D3                    	mov	bl, dl
   518 000013A1 C0EB04                  	shr	bl, 4
   519 000013A4 8A87[3616]              	mov	al, [bx+hex_chars]
   520 000013A8 A2[7616]                	mov	[msgVendorId], al
   521 000013AB 66C1EE10                	shr	esi, 16
   522 000013AF 89F0                    	mov	ax, si
   523 000013B1 88C3                    	mov	bl, al
   524 000013B3 88DA                    	mov	dl, bl
   525 000013B5 80E30F                  	and	bl, 0Fh
   526 000013B8 8A87[3616]              	mov	al, [bx+hex_chars]
   527 000013BC A2[8A16]                	mov	[msgDevId+3], al
   528 000013BF 88D3                    	mov	bl, dl
   529 000013C1 C0EB04                  	shr	bl, 4
   530 000013C4 8A87[3616]              	mov	al, [bx+hex_chars]
   531 000013C8 A2[8916]                	mov	[msgDevId+2], al
   532 000013CB 88E3                    	mov	bl, ah
   533 000013CD 88DA                    	mov	dl, bl
   534 000013CF 80E30F                  	and	bl, 0Fh
   535 000013D2 8A87[3616]              	mov	al, [bx+hex_chars]
   536 000013D6 A2[8816]                	mov	[msgDevId+1], al
   537 000013D9 88D3                    	mov	bl, dl
   538 000013DB C0EB04                  	shr	bl, 4
   539 000013DE 8A87[3616]              	mov	al, [bx+hex_chars]
   540 000013E2 A2[8716]                	mov	[msgDevId], al
   541                                  
   542 000013E5 668B36[BA17]            	mov	esi, [bus_dev_fn]
   543 000013EA 66C1EE08                	shr	esi, 8
   544 000013EE 89F0                    	mov	ax, si
   545 000013F0 88C3                    	mov	bl, al
   546 000013F2 88DA                    	mov	dl, bl
   547 000013F4 80E307                  	and	bl, 7 ; bit 0,1,2
   548 000013F7 8A87[3616]              	mov	al, [bx+hex_chars]
   549 000013FB A2[AE16]                	mov	[msgFncNo+1], al
   550 000013FE 88D3                    	mov	bl, dl
   551 00001400 C0EB03                  	shr	bl, 3
   552 00001403 88DA                    	mov	dl, bl
   553 00001405 80E30F                  	and	bl, 0Fh
   554 00001408 8A87[3616]              	mov	al, [bx+hex_chars]
   555 0000140C A2[A016]                	mov	[msgDevNo+1], al
   556 0000140F 88D3                    	mov	bl, dl
   557 00001411 C0EB04                  	shr	bl, 4
   558 00001414 8A87[3616]              	mov	al, [bx+hex_chars]
   559 00001418 A2[9F16]                	mov	[msgDevNo], al
   560 0000141B 88E3                    	mov	bl, ah
   561 0000141D 88DA                    	mov	dl, bl
   562 0000141F 80E30F                  	and	bl, 0Fh
   563 00001422 8A87[3616]              	mov	al, [bx+hex_chars]
   564 00001426 A2[9416]                	mov	[msgBusNo+1], al
   565 00001429 88D3                    	mov	bl, dl
   566 0000142B C0EB04                  	shr	bl, 4
   567 0000142E 8A87[3616]              	mov	al, [bx+hex_chars]
   568 00001432 A2[9316]                	mov	[msgBusNo], al
   569                                  
   570 00001435 A1[B017]                	mov	ax, [NAMBAR]
   571 00001438 88C3                    	mov	bl, al
   572 0000143A 88DA                    	mov	dl, bl
   573 0000143C 80E30F                  	and	bl, 0Fh
   574 0000143F 8A87[3616]              	mov	al, [bx+hex_chars]
   575 00001443 A2[BD16]                	mov	[msgNamBar+3], al
   576 00001446 88D3                    	mov	bl, dl
   577 00001448 C0EB04                  	shr	bl, 4
   578 0000144B 8A87[3616]              	mov	al, [bx+hex_chars]
   579 0000144F A2[BC16]                	mov	[msgNamBar+2], al
   580 00001452 88E3                    	mov	bl, ah
   581 00001454 88DA                    	mov	dl, bl
   582 00001456 80E30F                  	and	bl, 0Fh
   583 00001459 8A87[3616]              	mov	al, [bx+hex_chars]
   584 0000145D A2[BB16]                	mov	[msgNamBar+1], al
   585 00001460 88D3                    	mov	bl, dl
   586 00001462 C0EB04                  	shr	bl, 4
   587 00001465 8A87[3616]              	mov	al, [bx+hex_chars]
   588 00001469 A2[BA16]                	mov	[msgNamBar], al
   589                                  
   590                                  	; 05/11/2023
   591 0000146C A1[B217]                	mov	ax, [NABMBAR]
   592 0000146F 88C3                    	mov	bl, al
   593 00001471 88DA                    	mov	dl, bl
   594 00001473 80E30F                  	and	bl, 0Fh
   595 00001476 678A83[36160000]        	mov	al, [ebx+hex_chars]
   596 0000147D A2[CC16]                	mov	[msgNabmBar+3], al
   597 00001480 88D3                    	mov	bl, dl
   598 00001482 C0EB04                  	shr	bl, 4
   599 00001485 678A83[36160000]        	mov	al, [ebx+hex_chars]
   600 0000148C A2[CB16]                	mov	[msgNabmBar+2], al
   601 0000148F 88E3                    	mov	bl, ah
   602 00001491 88DA                    	mov	dl, bl
   603 00001493 80E30F                  	and	bl, 0Fh
   604 00001496 678A83[36160000]        	mov	al, [ebx+hex_chars]
   605 0000149D A2[CA16]                	mov	[msgNabmBar+1], al
   606 000014A0 88D3                    	mov	bl, dl
   607 000014A2 C0EB04                  	shr	bl, 4
   608 000014A5 678A83[36160000]        	mov	al, [ebx+hex_chars]
   609 000014AC A2[C916]                	mov	[msgNabmBar], al
   610                                  
   611                                  	; 24/11/2016
   612 000014AF 30E4                    	xor	ah, ah
   613 000014B1 A0[A717]                	mov	al, [ac97_int_ln_reg]
   614 000014B4 B10A                    	mov	cl, 10
   615 000014B6 F6F1                    	div	cl
   616 000014B8 0106[D416]              	add	[msgIRQ], ax
   617 000014BC 20C0                    	and	al, al
   618 000014BE 7508                    	jnz	short _pmi
   619 000014C0 A0[D516]                	mov	al, [msgIRQ+1]
   620 000014C3 B420                    	mov	ah, ' '
   621 000014C5 A3[D416]                	mov	[msgIRQ], ax
   622                                  _pmi:
   623 000014C8 BA[4716]                        mov	dx, msgAC97Info
   624 000014CB B409                            mov     ah, 9
   625 000014CD CD21                            int     21h
   626 000014CF C3                              retn
   627                                  
   628                                  write_sample_rate:
   629                                  	; ax = sample rate (hertz)
   630                                  
   631 000014D0 31D2                    	xor	dx, dx
   632 000014D2 B90A00                  	mov	cx, 10
   633 000014D5 F7F1                    	div	cx
   634 000014D7 0016[EA16]              	add	[msgHertz+4], dl
   635 000014DB 29D2                    	sub	dx, dx
   636 000014DD F7F1                    	div	cx
   637 000014DF 0016[E916]              	add	[msgHertz+3], dl
   638 000014E3 29D2                    	sub	dx, dx
   639 000014E5 F7F1                    	div	cx
   640 000014E7 0016[E816]              	add	[msgHertz+2], dl
   641 000014EB 29D2                    	sub	dx, dx
   642 000014ED F7F1                    	div	cx
   643 000014EF 0016[E716]              	add	[msgHertz+1], dl
   644 000014F3 0006[E616]              	add	[msgHertz], al
   645                                  	
   646 000014F7 BA[D916]                        mov     dx, msgSampleRate
   647 000014FA B409                            mov     ah, 9
   648 000014FC CD21                            int     21h
   649                                  
   650                                  	; 19/11/2016
   651 000014FE BA[FF16]                	mov	dx, msg16Bits
   652 00001501 803E[C617]10            	cmp	byte [bps], 16
   653 00001506 7403                    	je	short wsr_1
   654 00001508 BA[F016]                	mov	dx, msg8Bits
   655                                  wsr_1:
   656 0000150B B409                            mov     ah, 9
   657 0000150D CD21                            int     21h
   658                                  
   659 0000150F BA[F816]                	mov	dx, msgMono
   660 00001512 803E[C417]01            	cmp	byte [stmo], 1
   661 00001517 7403                    	je	short wsr_2
   662 00001519 BA[0817]                	mov	dx, msgStereo		
   663                                  wsr_2:
   664 0000151C B409                            mov     ah, 9
   665 0000151E CD21                            int     21h
   666                                  
   667 00001520 C3                              retn
   668                                  
   669                                  ;detect_codec:
   670                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   671                                  ;	mov	eax, 7Ch
   672                                  ;	call	codec_read
   673                                  ;       shl     eax, 16
   674                                  ;       mov     [codec_id], eax
   675                                  ;
   676                                  ;	mov	eax, 7Eh
   677                                  ;       call	codec_read
   678                                  ;       or      eax, [codec_id]
   679                                  ;       mov     [codec_chip_id], eax
   680                                  ;       and     eax, 0FFFFFF00h
   681                                  ;
   682                                  ;       mov     edi, codecs
   683                                  ;_dcb:
   684                                  ;       mov     ebx, [di]
   685                                  ;       test    ebx, ebx
   686                                  ;       jz      short _dco_unknown
   687                                  ;
   688                                  ;       cmp     eax, ebx
   689                                  ;       jne     short _dco_next
   690                                  ;       mov     ax, [di+4]
   691                                  ;       mov     [codec_vendor_ids], ax
   692                                  ;       movzx   esi, ax
   693                                  ;       call	print_msg
   694                                  ;       
   695                                  ;	mov	ax, [di+6]
   696                                  ;	call	detect_chip
   697                                  ;       retn
   698                                  ;
   699                                  ;_dco_next:
   700                                  ;       add     di, 8
   701                                  ;       jmp     short _dcb
   702                                  ;
   703                                  ;_dco_unknown:
   704                                  ;       mov    word [codec_vendor_ids], ac_unknown
   705                                  ;       mov    word [codec_chip_ids], chip_unknown
   706                                  ;       mov     esi, chip_unknown
   707                                  ;	call	print_msg
   708                                  ;       mov     eax, [codec_chip_id]
   709                                  ;       call    dword2str
   710                                  ;       call	print_msg
   711                                  ;       retn
   712                                  
   713                                  ;detect_chip:
   714                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   715                                  ;	mov	di, ax ; chip_tab
   716                                  ;       mov     eax, [codec_chip_id]
   717                                  ;       and     ax, 0FFh
   718                                  ;_dch1:
   719                                  ;       mov     bx, [di]
   720                                  ;       cmp     bx, 0FFh
   721                                  ;       je      short _dch_unknown
   722                                  ;
   723                                  ;       cmp     ax, bx
   724                                  ;       jne     short _dch_next
   725                                  ;       mov     ax, [di+2]
   726                                  ;       mov     [codec_chip_ids], ax
   727                                  ;       mov     si, ax
   728                                  ;       call	print_msg
   729                                  ;       retn
   730                                  
   731                                  ;_dch_next:
   732                                  ;       add     di, 4
   733                                  ;       jmp     short _dch1
   734                                  ;
   735                                  ;_dch_unknown:
   736                                  ;       mov    word [codec_chip_ids], chip_unknown
   737                                  ;       mov     si, chip_unknown
   738                                  ;       call	print_msg
   739                                  ;       mov     eax, [codec_chip_id]
   740                                  ;       call    dword2str
   741                                  ;       call	print_msg
   742                                  ;       retn
   743                                  
   744                                  ; 10/11/2023
   745                                  ; 09/11/2023
   746                                  ; 06/11/2023
   747                                  %if 1
   748                                  
   749                                  ac97_int_handler:
   750                                  	; 11/11/2023
   751                                  	; 10/11/2023
   752                                  	; 17/02/2016
   753 00001521 6650                    	push	eax	; 11/11/2023
   754 00001523 52                      	push	dx
   755                                  	; 05/11/2023	
   756                                  	;push	cx
   757                                  	;push	bx
   758                                  	;push	si
   759                                  	;push	di
   760                                  
   761                                  	; 10/11/2023
   762                                  	; EOI at first
   763 00001524 B020                    	mov	al, 20h
   764 00001526 F606[A717]08            	test	byte [ac97_int_ln_reg], 8
   765 0000152B 7402                    	jz	short _ih_0
   766 0000152D E6A0                    	out 	0A0h, al ; 20h	; EOI
   767                                  _ih_0:
   768 0000152F E620                    	out	20h, al  ; 20h	; EOI
   769                                  
   770                                  	; 11/11/2023
   771                                  	; 09/11/2023
   772 00001531 BA3000                  	mov	dx, GLOB_STS_REG
   773 00001534 0316[B217]                      add	dx, [NABMBAR]
   774 00001538 66ED                    	in	eax, dx
   775                                  	
   776                                  	; 09/11/2023,
   777 0000153A 6683F8FF                        cmp	eax, 0FFFFFFFFh ; -1
   778 0000153E 741D                    	je	short _ih_2
   779                                  	
   780 00001540 A840                    	test	al, 40h		; PCM Out Interrupt
   781 00001542 7509                    	jnz	short _ih_1
   782                                  
   783 00001544 6685C0                  	test	eax, eax
   784 00001547 7414                    	jz	short _ih_2
   785                                  
   786                                   	;mov	dx, GLOB_STS_REG
   787                                          ;add	dx, [NABMBAR]
   788 00001549 66EF                    	out	dx, eax
   789 0000154B EB10                    	jmp	short _ih_2
   790                                  
   791                                  	; .....
   792                                  	;mov	al, 1
   793                                  	; 10/11/2023
   794                                  	;mov	[tloop], al  ; 1
   795                                  
   796                                  	;cmp	[inside], al ; 1
   797                                  	;jnb	short _ih_3	; busy
   798                                  
   799                                  	;mov	[inside], al ; 1
   800                                  	;
   801                                  	;; 09/11/2023
   802                                          ;mov	dx, [NABMBAR]
   803                                          ;add	dx, PO_SR_REG	; set pointer to Status reg
   804                                  	;in	al, dx
   805                                  	;; 10/11/2023
   806                                  	;;;out	dx, eax
   807                                  	;;out	dx, al		; clear interrupt event
   808                                  	;			; (by writing 1 to same bits)
   809                                  	;
   810                                  	;;mov	[pcm_irq_status], al ; 05/11/2023
   811                                  	;test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
   812                                  	;jz	short _ih_2
   813                                  	; .....
   814                                  
   815                                  _ih_1:
   816                                  	; 11/11/2023
   817 0000154D 6650                    	push	eax
   818                                  
   819                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   820                                  	;mov	dx, PO_SR_REG
   821                                          ;add	dx, [NABMBAR]
   822                                  	;out	dx, ax
   823                                  
   824                                  	; 10/11/2023
   825                                  	; 28/11/2016 - Erdogan Tan
   826 0000154F E8D0F1                  	call	tuneLoop
   827                                  
   828                                  	; 11/11/2023
   829 00001552 6658                    	pop	eax
   830 00001554 BA3000                  	mov	dx, GLOB_STS_REG
   831 00001557 0316[B217]                      add	dx, [NABMBAR]
   832 0000155B 66EF                    	out	dx, eax
   833                                  _ih_2:
   834                                  	; 11/11/2023
   835 0000155D 8B16[B217]              	mov	dx, [NABMBAR]
   836 00001561 83C216                  	add	dx, PO_SR_REG	; set pointer to Status reg
   837 00001564 B81C00                  	mov	ax, 1Ch
   838 00001567 EF                      	out	dx, ax
   839                                  
   840                                  ;	; 10/11/2023
   841                                  ;	mov	al, 20h
   842                                  ;	test	byte [ac97_int_ln_reg], 8
   843                                  ;	jz	short _ih_3
   844                                  ;	out 	0A0h, al ; 20h	; EOI
   845                                  ;_ih_3:
   846                                  ;	out	20h, al  ; 20h	; EOI
   847                                  ;_ih_4:
   848                                  	;mov	byte [inside], 0
   849                                  	;pop	di
   850                                  	;pop	si
   851                                  	;pop	bx
   852                                  	;pop	cx
   853 00001568 5A                      	pop	dx
   854 00001569 6658                    	pop	eax ; 11/11/2023
   855 0000156B CF                      	iret
   856                                  
   857                                  %endif
   858                                  
   859                                  ; 10/11/2023
   860                                  ; 09/11/2023
   861                                  ; 06/11/2023
   862                                  %if 0
   863                                  
   864                                  ac97_int_handler:
   865                                  	; 10/11/2023
   866                                  	; 17/02/2016
   867                                  	push	ax	; 09/11/2023
   868                                  	push	dx
   869                                  	; 05/11/2023
   870                                  	;push	cx
   871                                  	;push	bx
   872                                  	;push	si
   873                                  	;push	di
   874                                  
   875                                  	; 10/11/2023
   876                                  	; EOI at first
   877                                  	mov	al, 20h
   878                                  	test	byte [ac97_int_ln_reg], 8
   879                                  	jz	short _ih_0
   880                                  	out 	0A0h, al ; 20h	; EOI
   881                                  _ih_0:
   882                                  	out	20h, al  ; 20h	; EOI
   883                                  
   884                                  	mov	al, 1
   885                                  
   886                                  	; 10/11/2023
   887                                  	;mov	[tloop], al  ; 1
   888                                  
   889                                  	cmp	[inside], al ; 1
   890                                  	jnb	short _ih_3	; busy
   891                                  
   892                                  	mov	[inside], al ; 1
   893                                  
   894                                  	; 09/11/2023
   895                                          mov	dx, [NABMBAR]
   896                                          add	dx, PO_SR_REG	; set pointer to Status reg
   897                                  	in	al, dx
   898                                  	; 10/11/2023
   899                                  	;out	dx, eax
   900                                  	out	dx, al		; clear interrupt event
   901                                  				; (by writing 1 to same bits)
   902                                  
   903                                  	;mov	[pcm_irq_status], al ; 05/11/2023
   904                                  	test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
   905                                  	jz	short _ih_2
   906                                  	
   907                                  	; 09/11/2023
   908                                  	;mov	dx, GLOB_STS_REG
   909                                          ;add	dx, [NABMBAR]
   910                                  	;in	eax, dx
   911                                  	
   912                                  	; 09/11/2023,
   913                                          ;cmp	eax, 0FFFFFFFFh ; -1
   914                                  	;je	short _ih_2
   915                                  	
   916                                  	;test	al, 40h		; PCM Out Interrupt
   917                                  	;jz	short _ih_2
   918                                  _ih_1:
   919                                  	; 10/11/2023
   920                                  	; 28/11/2016 - Erdogan Tan
   921                                  	call	tuneLoop
   922                                  	;jnc	short _ih_2
   923                                  	;dec	byte [tloop] ; [tloop] = 0
   924                                  _ih_2:
   925                                  	mov	byte [inside], 0
   926                                  _ih_3:
   927                                  	;pop	di
   928                                  	;pop	si
   929                                  	;pop	bx
   930                                  	;pop	cx
   931                                  	pop	dx
   932                                  	pop	ax ; 09/11/2023
   933                                  	iret
   934                                  
   935                                  %endif
   936                                  
   937                                  
   938                                  ac97_stop:
   939                                  	; 11/11/2023
   940                                  	; 09/11/2023
   941                                  	; 05/11/2023
   942                                  	; 04/11/2023 
   943                                  	; 28/05/2017 (TRDOS 386 v2, 'audio.s')
   944                                  	;mov	byte [tLoop], 0 ; stop ! ; 05/11/2023
   945                                  ;_ac97_stop:
   946                                  
   947                                  	; 11/11/2023
   948 0000156C 8B16[B017]              	mov	dx, [NAMBAR]
   949                                  	;add	dx, 0 ; ac_reg_0 ; reset register
   950 00001570 EF                      	out	dx, ax
   951                                  
   952                                  	; 04/11/2023
   953                                  	; 09/10/2017 (TRDOS 386 v2, 'audio.s')
   954                                  	; 11/06/2017
   955 00001571 30C0                    	xor	al, al ; 0
   956 00001573 E80D00                  	call	ac97_po_cmd
   957                                  
   958                                  	; (Ref: KolibriOS, intelac97.asm, 'stop:')
   959                                  	; Clear FIFOE, BCIS, LVBCI (Ref: Intel ICH hub manual)
   960 00001576 B81C00                  	mov     ax, 1Ch
   961 00001579 8B16[B217]              	mov     dx, [NABMBAR]
   962 0000157D 83C216                  	add     dx, PO_SR_REG
   963 00001580 EF                      	out     dx, ax
   964                                  
   965                                  	; 11/06/2017
   966 00001581 B002                    	mov     al, RR
   967                                  ac97_po_cmd:
   968                                  	; 11/06/2017
   969                                  	; 29/05/2017
   970 00001583 8B16[B217]              	mov     dx, [NABMBAR]
   971 00001587 83C21B                          add     dx, PO_CR_REG		; PCM out control register
   972 0000158A EE                      	out	dx, al
   973 0000158B C3                      	retn
   974                                  
   975                                  print_msg:
   976                                  	; 13/11/2016 - Erdogan Tan 
   977                                  	; esi = ASCIIZ text address
   978                                  	;
   979 0000158C BB0700                  	mov	bx, 7h
   980 0000158F B40E                    	mov	ah, 0Eh 
   981                                  pm_next_char:
   982 00001591 AC                      	lodsb
   983 00001592 20C0                    	and	al, al
   984 00001594 7404                    	jz	short pm_retn
   985 00001596 CD10                    	int	10h
   986 00001598 EBF7                    	jmp	short pm_next_char
   987                                  pm_retn:
   988 0000159A C3                      	retn
   989                                  
   990                                  ; 06/11/2023
   991                                  ;dword2str:
   992                                  ;	; 13/11/2016 - Erdogan Tan 
   993                                  ;	; eax = dword value
   994                                  ;	;
   995                                  ;	call	dwordtohex
   996                                  ;	mov	[dword_str], edx
   997                                  ;	mov	[dword_str+4], eax
   998                                  ;	mov	si, dword_str
   999                                  ;	retn
  1000                                  
  1001                                  	; trdos386.s (unix386.s) - 10/05/2015
  1002                                  	; Convert binary number to hexadecimal string
  1003                                  
  1004                                  bytetohex:
  1005                                  	; INPUT ->
  1006                                  	; 	AL = byte (binary number)
  1007                                  	; OUTPUT ->
  1008                                  	;	AX = hexadecimal string
  1009                                  	;
  1010 0000159B 53                      	push	bx
  1011 0000159C 30FF                    	xor	bh, bh
  1012 0000159E 88C3                    	mov	bl, al
  1013 000015A0 C0EB04                  	shr	bl, 4
  1014 000015A3 8A9F[3616]              	mov	bl, [bx+hex_chars] 	 	
  1015 000015A7 86D8                    	xchg	bl, al
  1016 000015A9 80E30F                  	and	bl, 0Fh
  1017 000015AC 8AA7[3616]              	mov	ah, [bx+hex_chars] 
  1018 000015B0 5B                      	pop	bx	
  1019 000015B1 C3                      	retn
  1020                                  
  1021                                  wordtohex:
  1022                                  	; INPUT ->
  1023                                  	; 	AX = word (binary number)
  1024                                  	; OUTPUT ->
  1025                                  	;	EAX = hexadecimal string
  1026                                  	;
  1027 000015B2 53                      	push	bx
  1028 000015B3 30FF                    	xor	bh, bh
  1029 000015B5 86E0                    	xchg	ah, al
  1030 000015B7 50                      	push	ax
  1031 000015B8 88E3                    	mov	bl, ah
  1032 000015BA C0EB04                  	shr	bl, 4
  1033 000015BD 8A87[3616]              	mov	al, [bx+hex_chars] 	 	
  1034 000015C1 88E3                    	mov	bl, ah
  1035 000015C3 80E30F                  	and	bl, 0Fh
  1036 000015C6 8AA7[3616]              	mov	ah, [bx+hex_chars]
  1037 000015CA 66C1E010                	shl	eax, 16
  1038 000015CE 58                      	pop	ax
  1039 000015CF 5B                      	pop	bx
  1040 000015D0 EBC9                    	jmp	short bytetohex
  1041                                  
  1042                                  ; 06/11/2023
  1043                                  ;dwordtohex:
  1044                                  ;	; INPUT ->
  1045                                  ;	; 	EAX = dword (binary number)
  1046                                  ;	; OUTPUT ->
  1047                                  ;	;	EDX:EAX = hexadecimal string
  1048                                  ;	;
  1049                                  ;	push	eax
  1050                                  ;	shr	eax, 16
  1051                                  ;	call	wordtohex
  1052                                  ;	mov	edx, eax
  1053                                  ;	pop	eax
  1054                                  ;	call	wordtohex
  1055                                  ;	retn
  1056                                  
  1057                                  _DATA:
  1058                                  
  1059                                  ; 24/11/2016
  1060                                  ;	IRQ  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 
  1061 000015D2 08090A0B0C0D0E0F70-     irq_int	 db 08h,09h,0Ah,0Bh,0Ch,0Dh,0Eh,0Fh,70h,71h,72h,73h,74h,75h,76h,77h
  1061 000015DB 71727374757677     
  1062                                  
  1063                                  ; 17/02/2017
  1064                                  ; Valid ICH device IDs
  1065                                  
  1066                                  valid_ids:
  1067 000015E2 86801524                dd	(ICH_DID << 16) + INTEL_VID  	 ; 8086h:2415h 
  1068 000015E6 86802524                dd	(ICH0_DID << 16) + INTEL_VID 	 ; 8086h:2425h 
  1069 000015EA 86804524                dd	(ICH2_DID << 16) + INTEL_VID 	 ; 8086h:2445h 
  1070 000015EE 86808524                dd	(ICH3_DID << 16) + INTEL_VID 	 ; 8086h:2485h 
  1071 000015F2 8680C524                dd	(ICH4_DID << 16) + INTEL_VID 	 ; 8086h:24C5h
  1072 000015F6 8680D524                dd	(ICH5_DID << 16) + INTEL_VID 	 ; 8086h:24D5h
  1073 000015FA 86806E26                dd	(ICH6_DID << 16) + INTEL_VID 	 ; 8086h:266Eh
  1074 000015FE 8680A625                dd	(ESB6300_DID << 16) + INTEL_VID  ; 8086h:25A6h
  1075 00001602 86809826                dd	(ESB631X_DID << 16) + INTEL_VID  ; 8086h:2698h
  1076 00001606 8680DE27                dd	(ICH7_DID << 16) + INTEL_VID 	 ; 8086h:27DEh
  1077                                  ; 03/11/2023 - Erdogan Tan
  1078 0000160A 86809571                dd	(MX82440_DID << 16) + INTEL_VID  ; 8086h:7195h
  1079 0000160E 39101270                dd	(SI7012_DID << 16)  + SIS_VID	 ; 1039h:7012h
  1080 00001612 DE10B101                dd 	(NFORCE_DID << 16)  + NVIDIA_VID ; 10DEh:01B1h
  1081 00001616 DE106A00                dd 	(NFORCE2_DID << 16) + NVIDIA_VID ; 10DEh:006Ah
  1082 0000161A 22106D74                dd 	(AMD8111_DID << 16) + AMD_VID 	 ; 1022h:746Dh
  1083 0000161E 22104574                dd 	(AMD768_DID << 16)  + AMD_VID 	 ; 1022h:7445h
  1084 00001622 DE105900                dd 	(CK804_DID << 16) + NVIDIA_VID	 ; 10DEh:0059h
  1085 00001626 DE103A00                dd 	(MCP04_DID << 16) + NVIDIA_VID	 ; 10DEh:003Ah
  1086 0000162A DE108A00                dd 	(CK8_DID << 16) + NVIDIA_VID	 ; 1022h:008Ah
  1087 0000162E DE10DA00                dd 	(NFORCE3_DID << 16) + NVIDIA_VID ; 10DEh:00DAh
  1088 00001632 DE10EA00                dd 	(CK8S_DID << 16) + NVIDIA_VID	 ; 10DEh:00EAh
  1089                                  
  1090                                  valid_id_count:	equ ($ - valid_ids)>>2 ; 05/11/2023
  1091                                  
  1092                                  ; 13/11/2016
  1093 00001636 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  1093 0000163F 3941424344454600   
  1094 00001647 414339372041756469-     msgAC97Info	db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  1094 00001650 6F20436F6E74726F6C-
  1094 00001659 6C6572202620436F64-
  1094 00001662 656320496E666F0D0A 
  1095 0000166B 56656E646F72204944-     		db "Vendor ID: "
  1095 00001674 3A20               
  1096 00001676 303030306820446576-     msgVendorId	db "0000h Device ID: "
  1096 0000167F 6963652049443A20   
  1097 00001687 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  1098 0000168E 4275733A20              		db "Bus: "
  1099 00001693 303068204465766963-     msgBusNo	db "00h Device: "
  1099 0000169C 653A20             
  1100 0000169F 3030682046756E6374-     msgDevNo	db "00h Function: "
  1100 000016A8 696F6E3A20         
  1101 000016AD 303068                  msgFncNo	db "00h"
  1102 000016B0 0D0A                    		db 0Dh, 0Ah
  1103                                  ; 05/11/2023	
  1104 000016B2 4E414D4241523A20        		db "NAMBAR: "
  1105 000016BA 303030306820            msgNamBar	db "0000h "
  1106 000016C0 4E41424D4241523A20      		db "NABMBAR: "
  1107 000016C9 303030306820495251-     msgNabmBar	db "0000h IRQ: "
  1107 000016D2 3A20               
  1108 000016D4 3030                    msgIRQ		dw 3030h
  1109 000016D6 0D0A24                  		db 0Dh, 0Ah, "$"
  1110 000016D9 53616D706C65205261-     msgSampleRate	db "Sample Rate: "
  1110 000016E2 74653A20           
  1111 000016E6 303030303020487A20-     msgHertz	db "00000 Hz ", "$" 
  1111 000016EF 24                 
  1112 000016F0 3820626974732024        msg8Bits	db "8 bits ", "$" 
  1113 000016F8 4D6F6E6F0D0A24          msgMono		db "Mono", 0Dh, 0Ah, "$"
  1114 000016FF 313620626974732024      msg16Bits	db "16 bits ", "$" 
  1115 00001708 53746572656F0D0A24      msgStereo	db "Stereo", 0Dh, 0Ah, "$"
  1116                                  
  1117                                  ;; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
  1118                                  ;codec_id	dd 0
  1119                                  ;codec_chip_id	dd 0
  1120                                  ;codec_vendor_ids dw 0
  1121                                  ;codec_chip_ids	dw 0
  1122                                  
  1123 00001711 3030303030303030        dword_str	 dd 30303030h, 30303030h
  1124 00001719 680D0A00                		 db 'h', 0Dh, 0Ah, 0
  1125                                  
  1126                                  ;ac_unknown     db 'unknown manufacturer',13,10,0
  1127                                  ;ac_Realtek     db 'Realtek Semiconductor',13,10,0
  1128                                  ;ac_Analog      db 'Analog Devices',13,10,0
  1129                                  ;ac_CMedia      db 'C-Media Electronics',13,10,0
  1130                                  ;ac_Cirrus      db 'Cirrus Logic',13,10,0
  1131                                  ;ac_Wolfson     db 'Wolfson Microelectronics',13,10,0
  1132                                  ;ac_VIA         db 'VIA Technologies',13,10,0
  1133                                  ;ac_SigmaTel    db 'SigmaTel',13,10,0
  1134                                  ;ac_eMicro      db 'eMicro',13,10,0
  1135                                  ;
  1136                                  ;chip_unknown   db 'unknown codec id ', 0
  1137                                  
  1138                                  ;CHIP_REALTEK   equ 414C4700h
  1139                                  ;CHIP_CMEDIA    equ 434D4900h
  1140                                  ;CHIP_VIA       equ 56494100h
  1141                                  
  1142                                  ;codecs        dd CHIP_CMEDIA
  1143                                  ;	       dw ac_CMedia, chips_CMedia
  1144                                  ;              dd CHIP_REALTEK
  1145                                  ;	       dw ac_Realtek, chips_Realtek
  1146                                  ;              dd CHIP_VIA
  1147                                  ;	       dw ac_VIA, chips_VIA
  1148                                  ;              dd 0
  1149                                  
  1150                                  ;chips_Realtek dw 10h, chip_ALC201a
  1151                                  ;              dw 20h, chip_ALC650
  1152                                  ;              dw 21h, chip_ALC650D
  1153                                  ;              dw 22h, chip_ALC650E
  1154                                  ;              dw 23h, chip_ALC650F
  1155                                  ;              dw 60h, chip_ALC655
  1156                                  ;              dw 80h, chip_ALC658
  1157                                  ;              dw 81h, chip_ALC658D
  1158                                  ;              dw 90h, chip_ALC850
  1159                                  ;              dw 0FFh
  1160                                  
  1161                                  ;chips_CMedia  dw 41h, chip_CM9738
  1162                                  ;              dw 61h, chip_CM9739
  1163                                  ;              dw 69h, chip_CM9780
  1164                                  ;              dw 78h, chip_CM9761
  1165                                  ;              dw 82h, chip_CM9761
  1166                                  ;              dw 83h, chip_CM9761
  1167                                  ;              dw 0FFh
  1168                                  
  1169                                  ;chips_VIA     dw 61h, chip_VIA1612A
  1170                                  ;              dw 0FFh
  1171                                  
  1172                                  ;Realtek
  1173                                  ;chip_ALC201a    db 'ALC201a',0dh,0ah,00h
  1174                                  ;chip_ALC650     db 'ALC650 ',0dh,0ah,00h
  1175                                  ;chip_ALC650D    db 'ALC650D',0dh,0ah,00h
  1176                                  ;chip_ALC650E    db 'ALC650E',0dh,0ah,00h
  1177                                  ;chip_ALC650F    db 'ALC650F',0dh,0ah,00h
  1178                                  ;chip_ALC655     db 'ALC655 ',0dh,0ah,00h
  1179                                  ;chip_ALC658     db 'ALC658 ',0dh,0ah,00h
  1180                                  ;chip_ALC658D    db 'ALC658D',0dh,0ah,00h
  1181                                  ;chip_ALC850     db 'ALC850 ',0dh,0ah,00h
  1182                                  
  1183                                  ;CMedia
  1184                                  ;chip_CM9738     db 'CMI9738', 0dh,0ah,0
  1185                                  ;chip_CM9739     db 'CMI9739', 0dh,0ah,0
  1186                                  ;chip_CM9780     db 'CMI9780', 0dh,0ah,0
  1187                                  ;chip_CM9761     db 'CMI9761', 0dh,0ah,0
  1188                                  
  1189                                  ;VIA
  1190                                  ;chip_VIA1612A   db 'VIA1612A',13,10,0
  1191                                  
  1192                                  ; 11/11/2023
  1193                                  msg_init_err:
  1194 0000171D 0D0A                    	db	CR, LF
  1195 0000171F 4143393720436F6E74-     	db	"AC97 Controller/Codec initialization error !"
  1195 00001728 726F6C6C65722F436F-
  1195 00001731 64656320696E697469-
  1195 0000173A 616C697A6174696F6E-
  1195 00001743 206572726F722021   
  1196 0000174B 0D0A24                  	db	CR, LF, "$"
  1197                                  
  1198                                  ; 12/11/2023
  1199                                  msg_no_vra:
  1200 0000174E 0D0A                    	db	CR, LF
  1201 00001750 4E6F20565241207375-     	db	"No VRA support ! Only 48 kHZ sample rate supported !"
  1201 00001759 70706F72742021204F-
  1201 00001762 6E6C79203438206B48-
  1201 0000176B 5A2073616D706C6520-
  1201 00001774 726174652073757070-
  1201 0000177D 6F727465642021     
  1202 00001784 0D0A24                  	db	CR, LF, "$"
  1203                                  
  1204                                  ; 17/02/2017
  1205                                  bss_start:
  1206                                  
  1207                                  ABSOLUTE bss_start
  1208                                  
  1209 00001787 ??                      alignb 2
  1210                                  
  1211                                  ; 28/11/2016
  1212                                  
  1213 00001788 <res 1Ch>               smpRBuff:	resw 14 ; 19/11/2016 - Erdogan Tan
  1214                                  
  1215 000017A4 ????                    filehandle:	resw 1
  1216                                  
  1217 000017A6 ??                      flags:		resb 1
  1218                                  ; 06/11/2023
  1219 000017A7 ??                      ac97_int_ln_reg: resb 1
  1220                                  
  1221                                  ; 09/11/2023
  1222                                  ; 06/11/2023
  1223                                  ;pcm_irq_status: resb 1	; 05/11/2023
  1224 000017A8 ??                      inside:		resb 1
  1225 000017A9 ??                      tloop:		resb 1	; 10/11/2023
  1226                                  
  1227                                  ; 09/11/2023
  1228                                  ; 04/11/2023 - 06/11/2023
  1229 000017AA ????                    IRQ_status:	resw 1	; IRQ status before enabling audio interrupt
  1230 000017AC ????????                IRQ_vector:	resd 1  ; Previous interrupt handler address	
  1231                                  
  1232                                  ; 17/02/2017
  1233                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  1234                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  1235                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  1236                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  1237 000017B0 ????                    NAMBAR:		resw 1			; BAR for mixer
  1238 000017B2 ????                    NABMBAR:	resw 1			; BAR for bus master regs
  1239                                  
  1240                                  ; 256 byte buffer for descriptor list
  1241 000017B4 ????                    BDL_BUFFER:	resw 1			; segment of our 256byte BDL buffer
  1242 000017B6 ????                    WAV_BUFFER1:	resw 1			; segment of our WAV storage
  1243                                  ; 64k buffers for wav file storage
  1244 000017B8 ????                    WAV_BUFFER2:	resw 1			; segment of 2nd wav buffer
  1245                                  
  1246                                  ; 06/11/2023
  1247                                  ;tBuff:		resb 1
  1248                                  ;ac97_int_ln_reg: resb 1
  1249                                  
  1250                                  ; 12/11/2016 - Erdogan Tan
  1251                                  
  1252 000017BA ????????                bus_dev_fn:	resd 1
  1253 000017BE ????????                dev_vendor:	resd 1
  1254                                  ; 06/11/2023
  1255                                  ;stats_cmd:	resw 1 ; 17/02/2017
  1256                                  ; 05/11/2023
  1257                                  ;ac97_io_base:	resw 1
  1258 000017C2 ????                    sample_rate:	resw 1
  1259                                  
  1260                                  ; 19/11/2016
  1261 000017C4 ????                    stmo:		resw 1 
  1262 000017C6 ????                    bps:		resw 1
  1263                                  
  1264                                  ; 08/11/2023
  1265                                  ; 07/11/2023
  1266 000017C8 ??                      fbs_shift:	resb 1
  1267                                  ; 09/11/2023
  1268 000017C9 ??                      b_indicator:	resb 1
  1269                                  ; 10/11/2023
  1270 000017CA ??                      LVI:		resb 1
  1271 000017CB ??                      		resb 1 ; 10/11/2023 
  1272                                  
  1273                                  ;fbs_seg:	resw 1
  1274                                  ;fbs_off:	resw 1
  1275                                  
  1276                                  ;alignb 2
  1277                                  
  1278                                  ; 32 kilo bytes for temporay buffer
  1279                                  ; (for stereo-mono, 8bit/16bit corrections)
  1280 000017CC <res 8000h>             temp_buffer:	resb 32768
  1281                                  
  1282                                  ;alignb 16
  1283                                  EOF:
