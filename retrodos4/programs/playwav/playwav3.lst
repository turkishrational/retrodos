     1                                  ; ****************************************************************************
     2                                  ; PLAYWAV.ASM - ICH AC97 .wav player for DOS.			   PLAYWAV.COM
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; Last Update: 19/05/2024 (Previous: 08/05/2024)
     5                                  ; ----------------------------------------------------------------------------
     6                                  ; Beginning: 17/02/2017
     7                                  ; ----------------------------------------------------------------------------
     8                                  ; Assembler: NASM version 2.15
     9                                  ;	     nasm playwav.asm -l playwav.lst -o PLAYWAV.COM	
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Derived from '.wav file player for DOS' Jeff Leyda, Sep 02, 2002 
    12                                  ; ****************************************************************************
    13                                  ; Modidified from 'PLAYER.COM' for VIA VT8233 wav player source code by
    14                                  ; (PLAYER.ASM) by Erdogan Tan (07/11/2016 - 08/12/2016)
    15                                  
    16                                  ; AC97 interrupt version - 09/11/2023 - Erdogan Tan
    17                                  ; sample rate conversion version - 13/11/2023 - Erdogan Tan
    18                                  
    19                                  [BITS 16]
    20                                  
    21                                  [ORG 100h] 
    22                                  
    23                                  	%include 'ac97.inc' ; 17/02/2017
     1                              <1> ; 11/11/2023
     2                              <1> ; 05/11/2023
     3                              <1> ; 03/11/2023
     4                              <1> ; 17/02/2017 (Erdogan Tan, PLAYWAV.ASM)
     5                              <1> ; constant.inc & codec.inc (for ICH AC97 wav player, 'PLAYWAV.COM') 
     6                              <1> 
     7                              <1> ; ----------------------------------------------------------------------------
     8                              <1> ; CONSTANT.INC
     9                              <1> ; ----------------------------------------------------------------------------
    10                              <1> 
    11                              <1> ;constants of stuff that seem hard to remember at times.
    12                              <1> 
    13                              <1> TRUE  EQU 1
    14                              <1> FALSE EQU 0
    15                              <1> 
    16                              <1> ENABLED  EQU 1
    17                              <1> DISABLED EQU 0
    18                              <1> 
    19                              <1> BIT0  EQU 1
    20                              <1> BIT1  EQU 2
    21                              <1> BIT2  EQU 4
    22                              <1> BIT3  EQU 8
    23                              <1> BIT4  EQU 10h
    24                              <1> BIT5  EQU 20h
    25                              <1> BIT6  EQU 40h
    26                              <1> BIT7  EQU 80h
    27                              <1> BIT8  EQU 100h
    28                              <1> BIT9  EQU 200h
    29                              <1> BIT10 EQU 400h
    30                              <1> BIT11 EQU 800h
    31                              <1> BIT12 EQU 1000h
    32                              <1> BIT13 EQU 2000h
    33                              <1> BIT14 EQU 4000h
    34                              <1> BIT15 EQU 8000h
    35                              <1> BIT16 EQU 10000h
    36                              <1> BIT17 EQU 20000h
    37                              <1> BIT18 EQU 40000h
    38                              <1> BIT19 EQU 80000h
    39                              <1> BIT20 EQU 100000h
    40                              <1> BIT21 EQU 200000h
    41                              <1> BIT22 EQU 400000h
    42                              <1> BIT23 EQU 800000h
    43                              <1> BIT24 EQU 1000000h
    44                              <1> BIT25 EQU 2000000h
    45                              <1> BIT26 EQU 4000000h
    46                              <1> BIT27 EQU 8000000h
    47                              <1> BIT28 EQU 10000000h
    48                              <1> BIT29 EQU 20000000h
    49                              <1> BIT30 EQU 40000000h
    50                              <1> BIT31 EQU 80000000h
    51                              <1> 
    52                              <1> ;special characters
    53                              <1> NUL     EQU 0
    54                              <1> NULL    EQU 0
    55                              <1> BELL    EQU 07
    56                              <1> BS      EQU 08
    57                              <1> TAB     EQU 09
    58                              <1> LF      EQU 10
    59                              <1> CR      EQU 13
    60                              <1> ESCAPE  EQU 27           ;ESC is a reserved word....
    61                              <1> 
    62                              <1> 
    63                              <1> ;file stuff
    64                              <1> READONLY  EQU   BIT0
    65                              <1> HIDDEN    EQU   BIT1
    66                              <1> SYSTEM    EQU   BIT2
    67                              <1> VOLUME    EQU   BIT3         ;ignored for file access
    68                              <1> DIRECTORY EQU   BIT4         ;must be 0 for file access
    69                              <1> ARCHIVE   EQU   BIT5
    70                              <1> SHAREABLE EQU   BIT7         ;for novell networks
    71                              <1> OPEN	EQU	2		; open existing file
    72                              <1> CREATE	EQU	1		; create new file
    73                              <1> 
    74                              <1> 
    75                              <1> ; PCI equates
    76                              <1> ; PCI function address (PFA)
    77                              <1> ; bit 31 = 1
    78                              <1> ; bit 23:16 = bus number     (0-255)
    79                              <1> ; bit 15:11 = device number  (0-31)
    80                              <1> ; bit 10:8 = function number (0-7)
    81                              <1> ; bit 7:0 = register number  (0-255)
    82                              <1> 
    83                              <1> IO_ADDR_MASK    EQU     0FFFEh          ; mask off bit 0 for reading BARs
    84                              <1> PCI_INDEX_PORT  EQU     0CF8h
    85                              <1> PCI_DATA_PORT   EQU     0CFCh
    86                              <1> PCI32           EQU     BIT31           ; bitflag to signal 32bit access
    87                              <1> PCI16           EQU     BIT30           ; bitflag for 16bit access
    88                              <1> 
    89                              <1> PCI_FN0         EQU     0 << 8
    90                              <1> PCI_FN1         EQU     1 << 8
    91                              <1> PCI_FN2         EQU     2 << 8
    92                              <1> PCI_FN3         EQU     3 << 8
    93                              <1> PCI_FN4         EQU     4 << 8
    94                              <1> PCI_FN5         EQU     5 << 8
    95                              <1> PCI_FN6         EQU     6 << 8
    96                              <1> PCI_FN7         EQU     7 << 8
    97                              <1> 
    98                              <1> PCI_CMD_REG		EQU	04h		; reg 04, command reg
    99                              <1>  IO_ENA			EQU	BIT0		; i/o decode enable
   100                              <1>  MEM_ENA		EQU	BIT1		; memory decode enable
   101                              <1>  BM_ENA                 EQU     BIT2		; bus master enable
   102                              <1> 
   103                              <1> ; ----------------------------------------------------------------------------
   104                              <1> ; CODEC.INC
   105                              <1> ; ----------------------------------------------------------------------------
   106                              <1> 
   107                              <1> ;Codec registers.
   108                              <1> ;
   109                              <1> ;Not all codecs are created equal. Refer to the spec for your specific codec.
   110                              <1> ;
   111                              <1> ;All registers are 16bits wide.  Access to codec registers over the AC97 link
   112                              <1> ;is defined by the OEM.  
   113                              <1> ;
   114                              <1> ;Secondary codec's are accessed by ORing in BIT7 of all register accesses.
   115                              <1> ;
   116                              <1> 
   117                              <1> ; each codec/mixer register is 16bits
   118                              <1> 
   119                              <1> CODEC_RESET_REG                 equ     00      ; reset codec
   120                              <1> CODEC_MASTER_VOL_REG            equ     02      ; master volume
   121                              <1> CODEC_HP_VOL_REG                equ     04      ; headphone volume
   122                              <1> CODEC_MASTER_MONO_VOL_REG       equ     06      ; master mono volume
   123                              <1> CODEC_MASTER_TONE_REG           equ     08      ; master tone (R+L)
   124                              <1> CODEC_PCBEEP_VOL_REG            equ     0ah     ; PC beep volume
   125                              <1> CODEC_PHONE_VOL_REG             equ     0bh     ; phone volume
   126                              <1> CODEC_MIC_VOL_REG               equ     0eh     ; MIC volume
   127                              <1> CODEC_LINE_IN_VOL_REG           equ     10h     ; line input volume
   128                              <1> CODEC_CD_VOL_REG                equ     12h     ; CD volume
   129                              <1> CODEC_VID_VOL_REG               equ     14h     ; video volume
   130                              <1> CODEC_AUX_VOL_REG               equ     16h     ; aux volume
   131                              <1> CODEC_PCM_OUT_REG               equ     18h     ; PCM output volume
   132                              <1> CODEC_RECORD_SELECT_REG         equ     1ah     ; record select input
   133                              <1> CODEC_RECORD_VOL_REG            equ     1ch     ; record volume
   134                              <1> CODEC_RECORD_MIC_VOL_REG        equ     1eh     ; record mic volume
   135                              <1> CODEC_GP_REG                    equ     20h     ; general purpose
   136                              <1> CODEC_3D_CONTROL_REG            equ     22h     ; 3D control
   137                              <1> ; 24h is reserved
   138                              <1> CODEC_POWER_CTRL_REG            equ     26h     ; powerdown control
   139                              <1> CODEC_EXT_AUDIO_REG             equ     28h     ; extended audio
   140                              <1> CODEC_EXT_AUDIO_CTRL_REG        equ     2ah     ; extended audio control
   141                              <1> CODEC_PCM_FRONT_DACRATE_REG     equ     2ch     ; PCM out sample rate
   142                              <1> CODEC_PCM_SURND_DACRATE_REG     equ     2eh     ; surround sound sample rate
   143                              <1> CODEC_PCM_LFE_DACRATE_REG       equ     30h     ; LFE sample rate
   144                              <1> CODEC_LR_ADCRATE_REG            equ     32h     ; PCM in sample rate
   145                              <1> CODEC_MIC_ADCRATE_REG           equ     34h     ; mic in sample rate
   146                              <1> 
   147                              <1> ; registers 36-7a are reserved on the ICH
   148                              <1> 
   149                              <1> CODEC_VENDORID1_REG             equ     7ch     ; codec vendor ID 1
   150                              <1> CODEC_VENDORID2_REG             equ     7eh     ; codec vendor ID 2
   151                              <1> 
   152                              <1> ; Mixer registers 0 through 51h reside in the ICH and are not forwarded over
   153                              <1> ; the AC97 link to the codec, which I think is a little weird.  Looks like
   154                              <1> ; the ICH makes it so you don't need a fully functional codec to play audio?
   155                              <1> ;
   156                              <1> ; whenever 2 codecs are present in the system, use BIT7 to access the 2nd
   157                              <1> ; set of registers, ie 80h-feh
   158                              <1> 
   159                              <1> PRIMARY_CODEC                   equ     0       ; 0-7F for primary codec
   160                              <1> SECONDARY_CODEC                 equ     BIT7    ; 80-8f registers for 2ndary
   161                              <1> 
   162                              <1> SAMPLE_RATE_441khz	equ     44100   ; 44.1Khz (cd quality) rate
   163                              <1> 
   164                              <1> ; ----------------------------------------------------------------------------
   165                              <1> ; 17/02/2017
   166                              <1> PCI_IO_BASE	equ 10h			; = NAMBAR register offset
   167                              <1> AC97_INT_LINE   equ 3Ch			; AC97 Interrupt Line register offset
   168                              <1> 
   169                              <1> ; ----------------------------------------------------------------------------
   170                              <1> ; ICH2AC97.INC
   171                              <1> ; ----------------------------------------------------------------------------
   172                              <1> 
   173                              <1> ; PCI stuff
   174                              <1> 
   175                              <1> ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
   176                              <1> 
   177                              <1> INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
   178                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   179                              <1> SIS_VID		equ	1039h
   180                              <1> NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
   181                              <1> AMD_VID		equ	1022h
   182                              <1> 
   183                              <1> ICH_DID         equ     2415h           ; ICH device ID
   184                              <1> ICH0_DID        equ     2425h           ; ICH0
   185                              <1> ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
   186                              <1>                                         ; they all should be compatible.
   187                              <1> 
   188                              <1> ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
   189                              <1> ICH3_DID	equ     2485h           ; ICH3
   190                              <1> ICH4_DID        equ     24C5h           ; ICH4
   191                              <1> ICH5_DID	equ     24D5h           ; ICH5 
   192                              <1> ICH6_DID	equ     266Eh           ; ICH6
   193                              <1> ESB6300_DID	equ     25A6h           ; 6300ESB
   194                              <1> ESB631X_DID	equ     2698h           ; 631XESB
   195                              <1> ICH7_DID	equ	27DEh		; ICH7
   196                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   197                              <1> MX82440_DID	equ	7195h
   198                              <1> SI7012_DID	equ	7012h
   199                              <1> NFORCE_DID	equ	01B1h
   200                              <1> NFORCE2_DID	equ	006Ah
   201                              <1> AMD8111_DID	equ	746Dh
   202                              <1> AMD768_DID	equ	7445h
   203                              <1> ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
   204                              <1> CK804_DID	equ	0059h
   205                              <1> MCP04_DID	equ	003Ah
   206                              <1> CK8_DID		equ	008Ah
   207                              <1> NFORCE3_DID	equ	00DAh
   208                              <1> CK8S_DID	equ	00EAh
   209                              <1> 
   210                              <1> NAMBAR_REG      equ     10h             ; native audio mixer BAR
   211                              <1>  NAM_SIZE       equ     256             ; 256 bytes required.
   212                              <1> 
   213                              <1> NABMBAR_REG     equ     14h             ; native audio bus mastering BAR
   214                              <1>  NABM_SIZE      equ     64              ; 64 bytes
   215                              <1> 
   216                              <1> ; BUS master registers, accessed via NABMBAR+offset
   217                              <1> 
   218                              <1> ; ICH supports 3 different types of register sets for three types of things
   219                              <1> ; it can do, thus:
   220                              <1> ;
   221                              <1> ; PCM in (for recording) aka PI
   222                              <1> ; PCM out (for playback) aka PO
   223                              <1> ; MIC in (for recording) aka MC
   224                              <1> 
   225                              <1> PI_BDBAR_REG            equ     0       ; PCM in buffer descriptor BAR
   226                              <1> PO_BDBAR_REG            equ     10h     ; PCM out buffer descriptor BAR
   227                              <1> MC_BDBAR_REG            equ     20h     ; MIC in buffer descriptor BAR
   228                              <1> 
   229                              <1> ; each buffer descriptor BAR holds a pointer which has entries to the buffer
   230                              <1> ; contents of the .WAV file we're going to play. Each entry is 8 bytes long
   231                              <1> ; (more on that later) and can contain 32 entries total, so each BAR is
   232                              <1> ; 256 bytes in length, thus:
   233                              <1> 
   234                              <1> BDL_SIZE                equ     32*8    ; Buffer Descriptor List size
   235                              <1> INDEX_MASK              equ     31      ; indexes must be 0-31
   236                              <1> 
   237                              <1> 
   238                              <1> 
   239                              <1> PI_CIV_REG              equ     4       ; PCM in current Index value (RO)
   240                              <1> PO_CIV_REG              equ     14h     ; PCM out current Index value (RO)
   241                              <1> MC_CIV_REG              equ     24h     ; MIC in current Index value (RO)
   242                              <1> ;8bit read only
   243                              <1> ; each current index value is simply a pointer showing us which buffer
   244                              <1> ; (0-31) the codec is currently processing. Once this counter hits 31, it
   245                              <1> ; wraps back to 0.
   246                              <1> ; this can be handy to know, as once it hits 31, we're almost out of data to
   247                              <1> ; play back or room to record!
   248                              <1> 
   249                              <1> 
   250                              <1> PI_LVI_REG              equ     5       ; PCM in Last Valid Index
   251                              <1> PO_LVI_REG              equ     15h     ; PCM out Last Valid Index
   252                              <1> MC_LVI_REG              equ     25h     ; MIC in Last Valid Index
   253                              <1> ;8bit read/write
   254                              <1> ; The Last Valid Index is a number (0-31) to let the codec know what buffer
   255                              <1> ; number to stop on after processing. It could be very nasty to play audio
   256                              <1> ; from buffers that aren't filled with the audio we want to play.
   257                              <1> 
   258                              <1> 
   259                              <1> PI_SR_REG               equ     6       ; PCM in Status register
   260                              <1> PO_SR_REG               equ     16h     ; PCM out Status register
   261                              <1> MC_SR_REG               equ     26h     ; MIC in Status register
   262                              <1> ;16bit read/write
   263                              <1> ; status registers.  Bitfields follow:
   264                              <1> 
   265                              <1> FIFO_ERR                equ     BIT4    ; FIFO Over/Underrun W1TC.
   266                              <1> 
   267                              <1> BCIS                    equ     BIT3    ; buffer completion interrupt status.
   268                              <1>                                         ; Set whenever the last sample in ANY
   269                              <1>                                         ; buffer is finished.  Bit is only
   270                              <1>                                         ; set when the Interrupt on Complete
   271                              <1>                                         ; (BIT4 of control reg) is set.
   272                              <1> 
   273                              <1> LVBCI                   equ     BIT2    ; Set whenever the codec has processed
   274                              <1>                                         ; the last buffer in the buffer list.
   275                              <1>                                         ; Will fire an interrupt if IOC bit is
   276                              <1>                                         ; set. Probably set after the last
   277                              <1>                                         ; sample in the last buffer is
   278                              <1>                                         ; processed.  W1TC
   279                              <1> 
   280                              <1>                                         ; 
   281                              <1> CELV                    equ     BIT1    ; Current buffer == last valid.
   282                              <1>                                         ; Bit is RO and remains set until LVI is
   283                              <1>                                         ; cleared.  Probably set up the start
   284                              <1>                                         ; of processing for the last buffer.
   285                              <1> 
   286                              <1> 
   287                              <1> DCH                     equ     BIT0    ; DMA controller halted.
   288                              <1>                                         ; set whenever audio stream is stopped
   289                              <1>                                         ; or something else goes wrong.
   290                              <1> 
   291                              <1> 
   292                              <1> PI_PICB_REG             equ     8       ; PCM in position in current buffer(RO)
   293                              <1> PO_PICB_REG             equ     18h     ; PCM out position in current buffer(RO)
   294                              <1> MC_PICB_REG             equ     28h     ; MIC in position in current buffer (RO)
   295                              <1> ;16bit read only
   296                              <1> ; position in current buffer regs show the number of dwords left to be
   297                              <1> ; processed in the current buffer.
   298                              <1> ; 
   299                              <1> 
   300                              <1> PI_PIV_REG              equ     0ah     ; PCM in Prefected index value
   301                              <1> PO_PIV_REG              equ     1ah     ; PCM out Prefected index value
   302                              <1> MC_PIV_REG              equ     2ah     ; MIC in Prefected index value
   303                              <1> ;8bit, read only
   304                              <1> ; Prefetched index value register.
   305                              <1> ; tells which buffer number (0-31) has be prefetched. I'd imagine this
   306                              <1> ; value follows the current index value fairly closely. (CIV+1)
   307                              <1> ;
   308                              <1> 
   309                              <1> 
   310                              <1> PI_CR_REG               equ     0bh     ; PCM in Control Register
   311                              <1> PO_CR_REG               equ     1bh     ; PCM out Control Register
   312                              <1> MC_CR_REG               equ     2bh     ; MIC in Control Register
   313                              <1> ; 8bit
   314                              <1> ; Control register *MUST* only be accessed as an 8bit value.
   315                              <1> ; Control register. See bitfields below.
   316                              <1> ;
   317                              <1> 
   318                              <1> 
   319                              <1> IOCE                    equ     BIT4    ; interrupt on complete enable.
   320                              <1>                                         ; set this bit if you want an intrtpt
   321                              <1>                                         ; to fire whenever LVBCI is set.
   322                              <1> FEIFE                   equ     BIT3    ; set if you want an interrupt to fire
   323                              <1>                                         ; whenever there is a FIFO (over or
   324                              <1>                                         ; under) error.
   325                              <1> LVBIE                   equ     BIT2    ; last valid buffer interrupt enable.
   326                              <1>                                         ; set if you want an interrupt to fire
   327                              <1>                                         ; whenever the completion of the last
   328                              <1>                                         ; valid buffer.
   329                              <1> RR                      equ     BIT1    ; reset registers.  Nukes all regs
   330                              <1>                                         ; except bits 4:2 of this register.
   331                              <1>                                         ; Only set this bit if BIT 0 is 0
   332                              <1> RPBM                    equ     BIT0    ; Run/Pause
   333                              <1>                                         ; set this bit to start the codec!
   334                              <1> 
   335                              <1> 
   336                              <1> GLOB_CNT_REG            equ     2ch     ; Global control register
   337                              <1> SEC_RES_EN              equ     BIT5    ; secondary codec resume event 
   338                              <1>                                         ; interrupt enable.  Not used here.
   339                              <1> PRI_RES_EN              equ     BIT4    ; ditto for primary. Not used here.
   340                              <1> ACLINK_OFF              equ     BIT3    ; Turn off the AC97 link
   341                              <1> ACWARM_RESET            equ     BIT2    ; Awaken the AC97 link from sleep.
   342                              <1>                                         ; registers preserved, bit self clears
   343                              <1> ACCOLD_RESET            equ     BIT1    ; Reset everything in the AC97 and
   344                              <1>                                         ; reset all registers.  Not self clearing
   345                              <1> 
   346                              <1> GPIIE                   equ     BIT0    ; GPI Interrupt enable.
   347                              <1>                                         ; set if you want an interrupt to
   348                              <1>                                         ; fire upon ANY of the bits in the
   349                              <1>                                         ; GPI (general pursose inputs?) not used.
   350                              <1> 
   351                              <1> GLOB_STS_REG            equ     30h     ; Global Status register (RO)
   352                              <1> 
   353                              <1> MD3                     equ     BIT17   ; modem powerdown status (yawn)
   354                              <1> AD3                     equ     BIT16   ; Audio powerdown status (yawn)
   355                              <1> RD_COMPLETE_STS         equ     BIT15   ; Codec read timed out. 0=normal
   356                              <1> BIT3SLOT12              equ     BIT14   ; shadowed status of bit 3 in slot 12
   357                              <1> BIT2SLOT12              equ     BIT13   ; shadowed status of bit 2 in slot 12
   358                              <1> BIT1SLOT12              equ     BIT12   ; shadowed status of bit 1 in slot 12
   359                              <1> SEC_RESUME_STS          equ     BIT11   ; secondary codec has resumed (and irqed)
   360                              <1> PRI_RESUME_STS          equ     BIT10   ; primary codec has resumed (and irqed)
   361                              <1> SEC_CODEC_RDY           equ     BIT9    ; secondary codec is ready for action
   362                              <1> PRI_CODEC_RDY           equ     BIT8    ; Primary codec is ready for action
   363                              <1>                                         ; software must check these bits before
   364                              <1>                                         ; starting the codec!
   365                              <1> MIC_IN_IRQ              equ     BIT7    ; MIC in caused an interrupt
   366                              <1> PCM_OUT_IRQ             equ     BIT6    ; One of the PCM out channels IRQed
   367                              <1> PCM_IN_IRQ              equ     BIT5    ; One of the PCM in channels IRQed
   368                              <1> MODEM_OUT_IRQ           equ     BIT2    ; modem out channel IRQed
   369                              <1> MODEM_IN_IRQ            equ     BIT1    ; modem in channel IRQed
   370                              <1> GPI_STS_CHANGE          equ     BIT0    ; set whenever GPI's have changed.
   371                              <1>                                         ; BIT0 of slot 12 also reflects this.
   372                              <1> 
   373                              <1> ACC_SEMA_REG            equ     34h     ; Codec write semiphore register
   374                              <1> CODEC_BUSY              equ     BIT0    ; codec register I/O is happening
   375                              <1>                                         ; self clearing
   376                              <1> ;
   377                              <1> ; Buffer Descriptors List
   378                              <1> ; As stated earlier, each buffer descriptor list is a set of (up to) 32 
   379                              <1> ; descriptors, each 8 bytes in length. Bytes 0-3 of a descriptor entry point
   380                              <1> ; to a chunk of memory to either play from or record to. Bytes 4-7 of an
   381                              <1> ; entry describe various control things detailed below.
   382                              <1> ; 
   383                              <1> ; Buffer pointers must always be aligned on a Dword boundry.
   384                              <1> ;
   385                              <1> 
   386                              <1> IOC                     equ     BIT31   ; Fire an interrupt whenever this
   387                              <1>                                         ; buffer is complete.
   388                              <1> 
   389                              <1> BUP                     equ     BIT30   ; Buffer Underrun Policy.
   390                              <1>                                         ; if this buffer is the last buffer
   391                              <1>                                         ; in a playback, fill the remaining
   392                              <1>                                         ; samples with 0 (silence) or not.
   393                              <1>                                         ; It's a good idea to set this to 1
   394                              <1>                                         ; for the last buffer in playback,
   395                              <1>                                         ; otherwise you're likely to get a lot
   396                              <1>                                         ; of noise at the end of the sound.
   397                              <1> 
   398                              <1> ;
   399                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   400                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   401                              <1> ; Luckily for us, that's the same format as .wav files.
   402                              <1> ;
   403                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   404                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   405                              <1> ;
   406                              <1> ; A value of 0 in these bits means play no samples.
   407                              <1> ;
   408                              <1> 
   409                              <1> ; 11/11/2023
   410                              <1> CTRL_ST_CREADY		equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
   411                              <1> CODEC_REG_POWERDOWN	equ	26h
    24                                  
    25                                  _STARTUP:
    26                                  
    27                                  ; memory allocation
    28                                  
    29 00000000 E85A01                          call    setFree				; deallocate unused DOS mem
    30                                  
    31                                  	; 17/02/2017
    32                                  	; Clear BSS (uninitialized data) area
    33 00000003 31C0                    	xor	ax, ax ; 0
    34 00000005 B91A6E                  	mov	cx, (EOF - bss_start)/2
    35 00000008 BF[E61D]                	mov	di, bss_start
    36 0000000B F3AB                    	rep	stosw
    37                                  
    38                                  ; allocate 256 bytes of data for DCM_OUT Buffer Descriptor List. (BDL)
    39                                  
    40 0000000D B81000                          mov     ax, BDL_SIZE / 16
    41 00000010 E85201                          call    memAlloc
    42 00000013 A3[121E]                        mov     [BDL_BUFFER], ax		; segment 
    43                                  
    44                                  ; allocate 2 buffers, 64k each for now.
    45                                  
    46 00000016 B80010                          mov     ax, BUFFERSIZE / 16		; 64k for .WAV file
    47 00000019 E84901                          call    memAlloc
    48 0000001C A3[141E]                        mov     [WAV_BUFFER1], ax		; segment
    49                                  
    50 0000001F B80010                  	mov	ax, BUFFERSIZE / 16
    51 00000022 E84001                  	call	memAlloc
    52 00000025 A3[161E]                	mov	[WAV_BUFFER2], ax
    53                                  
    54                                  ; Detect/reset AC97 
    55                                  
    56 00000028 E8AD02                          call    pciFindDevice
    57 0000002B 7342                            jnc     short _1
    58                                  
    59                                  ; couldn't find the audio device!
    60                                  
    61 0000002D 0E                      	push	cs
    62 0000002E 1F                      	pop	ds
    63 0000002F BA[3900]                        mov     dx, noDevMsg
    64 00000032 B409                            mov     ah, 9
    65 00000034 CD21                            int     21h
    66 00000036 E91401                          jmp     exit
    67                                  
    68                                  ; 17/02/2017
    69 00000039 4572726F723A20556E-     noDevMsg: db "Error: Unable to find intel ICH based audio device!",CR,LF,"$"
    69 00000042 61626C6520746F2066-
    69 0000004B 696E6420696E74656C-
    69 00000054 204943482062617365-
    69 0000005D 6420617564696F2064-
    69 00000066 6576696365210D0A24 
    70                                  
    71                                  _1:
    72                                  	; eax = BUS/DEV/FN
    73                                  	;	00000000BBBBBBBBDDDDDFFF00000000
    74                                  	; edx = DEV/VENDOR
    75                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
    76                                  
    77 0000006F 66A3[181E]              	mov	[bus_dev_fn], eax
    78 00000073 668916[1C1E]            	mov	[dev_vendor], edx
    79                                  
    80                                  	; get ICH base address regs for mixer and bus master
    81                                  
    82 00000078 B010                            mov     al, NAMBAR_REG
    83 0000007A E8CD01                          call    pciRegRead16			; read PCI registers 10-11
    84                                          ;and    dx, IO_ADDR_MASK 		; mask off BIT0
    85                                  	; 19/05/2024
    86 0000007D 80E2FE                  	and	dl, 0FEh
    87                                  
    88 00000080 8916[0E1E]                      mov     [NAMBAR], dx			; save audio mixer base addr
    89                                  
    90 00000084 B014                    	mov     al, NABMBAR_REG
    91 00000086 E8C101                          call    pciRegRead16
    92                                          ;and    dx, IO_ADDR_MASK
    93                                  	; 19/05/2024
    94 00000089 80E2C0                  	and	dl, 0C0h
    95                                  
    96 0000008C 8916[101E]                      mov     [NABMBAR], dx			; save bus master base addr
    97                                  
    98                                  	; 06/11/2023
    99                                  	;; init controller
   100                                  	;; 17/02/2017
   101                                  	;mov	al, PCI_CMD_REG ; command register (04h)
   102                                  	;call	pciRegRead16 ; pciRegRead8
   103                                  	;
   104                                  	;; eax = BUS/DEV/FN/REG
   105                                  	;;  dx = PCI Command Register Content ; 17/02/2017
   106                                  	;; 	00000000CCCCCCCC
   107                                  	;mov	[stats_cmd], dx
   108                                  	;
   109                                  	; 06/11/2023
   110                                  	;mov	al, PCI_IO_BASE ; IO base address register (10h)
   111                                  	;call	pciRegRead32
   112                                  	;
   113                                  	;and	dx, 0FFC0h	; IO_ADDR_MASK (0FFFE) ?
   114                                          ;mov	[ac97_io_base], dx
   115                                  
   116 00000090 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
   117 00000092 E8AD01                  	call	pciRegRead8 ; 17/02/2017
   118                                  
   119 00000095 8816[051E]              	mov     [ac97_int_ln_reg], dl
   120                                  
   121                                  ; 09/11/2023
   122                                  ; 05/11/2023
   123                                  %if 1
   124                                  	; 28/11/2016
   125                                  	;mov	bx, 1	; 08/05/2024
   126 00000099 30F6                    	xor	dh, dh	; 17/02/2017
   127                                  	; 10/11/2023
   128                                  	;mov	cx, dx
   129                                  	;shl	bx, cl
   130                                  
   131                                  	; 04/11/2023
   132 0000009B FA                      	cli
   133                                  
   134                                  	;not	bx
   135 0000009C E4A1                    	in	al, 0A1h ; irq 8-15
   136 0000009E 88C4                            mov	ah, al
   137 000000A0 E421                            in	al, 21h  ; irq 0-7 
   138                                  
   139                                  	; 04/11/2023
   140                                  	; save IRQ status
   141 000000A2 A3[081E]                	mov	[IRQ_status], ax
   142                                  
   143                                  	;and	ax, bx   ; unmask
   144 000000A5 0FB3D0                   	btr	ax, dx	 ; unmask
   145 000000A8 E621                    	out	21h, al  ; enable interrupt (if irq <= 7)
   146 000000AA 88E0                    	mov	al, ah
   147 000000AC E6A1                    	out	0A1h, al ; enable interrupt (if irq > 7)
   148                                  	;not	bx
   149                                  
   150                                  	; 04/11/2023
   151                                  	;mov	dx, 4D1h			;8259 ELCR1
   152                                          ;in	al, dx
   153                                  	;mov	ah, al
   154                                  	;mov	dx, 4D0h 
   155                                          ;in	al, dx
   156                                  	;;or	ax, bx        
   157                                  	;bts	ax, cx
   158                                  	;mov	dx, 4D0h
   159                                  	;out	dx, al                          ;set level-triggered mode
   160                                  	;mov	al, ah
   161                                  	;mov	dx, 4D1h
   162                                  	;out	dx, al                          ;set level-triggered mode
   163                                  
   164                                  	; 24/11/2016 - Erdogan Tan
   165                                  	;mov	bx, cx
   166                                  	; 10/11/2023
   167 000000AE 89D3                    	mov	bx, dx
   168 000000B0 8A9F[311C]              	mov	bl, [bx+irq_int]
   169 000000B4 C1E302                  	shl	bx, 2 ; * 4
   170                                  
   171                                  	; set up interrupt vector
   172                                  	; 30/11/2016
   173 000000B7 06                      	push	es
   174 000000B8 31C0                    	xor	ax, ax
   175 000000BA 8EC0                    	mov	es, ax
   176                                  	; 04/11/2023
   177                                  	; save interrupt vector
   178 000000BC 268B07                  	mov	ax, [es:bx]
   179 000000BF A3[0A1E]                	mov	[IRQ_vector], ax
   180 000000C2 268B4702                	mov	ax, [es:bx+2]
   181 000000C6 A3[0C1E]                	mov	[IRQ_vector+2], ax
   182                                  
   183 000000C9 26C707[A01B]            	mov	word [es:bx], ac97_int_handler
   184 000000CE 8CC8                    	mov	ax, cs
   185 000000D0 26894702                	mov	[es:bx+2], ax
   186 000000D4 07                      	pop	es
   187                                  
   188                                  	; 04/11/2023
   189 000000D5 FB                      	sti
   190                                  
   191                                  %endif
   192 000000D6 E82019                  	call	write_ac97_dev_info 
   193                                  
   194                                  ; check the command line for a file to play
   195                                  
   196                                          ;push	ds
   197 000000D9 E89200                          call    processCmdline			; get the filename
   198                                  
   199                                  ; open the file
   200 000000DC B002                            mov     al, OPEN                        ; open existing file
   201 000000DE E8AD00                          call    openFile                        ; no error? ok.
   202                                          ;pop	ds
   203 000000E1 7322                            jnc     short _gsr
   204                                  
   205                                  ; file not found!
   206                                  
   207                                          ;push   cs
   208                                          ;pop    ds
   209 000000E3 BA[EC00]                        mov	dx, noFileErrMsg
   210 000000E6 B409                            mov     ah, 9
   211 000000E8 CD21                            int     21h
   212 000000EA EB61                            jmp     exit
   213                                  
   214                                  noFileErrMsg:
   215 000000EC 4572726F723A206669-     	db "Error: file not found.",CR,LF,"$"
   215 000000F5 6C65206E6F7420666F-
   215 000000FE 756E642E0D0A24     
   216                                  
   217                                  _gsr:
   218 00000105 E8AD00                          call    getSampleRate                   ; read the sample rate
   219                                                                                  ; pass it onto codec.
   220 00000108 7243                    	jc	short exit ; 19/11/2016 - nothing to do
   221                                  
   222 0000010A A3[201E]                	mov	[sample_rate], ax
   223                                  	
   224                                  	; 19/11/2016
   225 0000010D 880E[221E]              	mov	[stmo], cl
   226 00000111 8816[241E]              	mov	[bps], dl
   227                                  	
   228                                  	; 17/02/2017
   229 00000115 C606[261E]00            	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit 
   230 0000011A FEC9                    	dec	cl
   231 0000011C 7504                    	jnz	short _gsr_1 ; stereo
   232 0000011E FE06[261E]              	inc	byte [fbs_shift] ; 1 = mono or 8 bit		
   233                                  _gsr_1:	
   234 00000122 80FA08                  	cmp	dl, 8 
   235 00000125 7704                    	ja	short _gsr_2 ; 16 bit samples
   236 00000127 FE06[261E]              	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   237                                  _gsr_2:	
   238 0000012B E8211A                  	call	write_sample_rate
   239                                  
   240                                  	; 05/11/2023
   241                                  _2:
   242 0000012E E85E07                  	call	check4keyboardstop  ; flush keyboard buffer
   243 00000131 72FB                    	jc	short _2 	; 07/11/2023
   244                                  
   245                                  	; 09/11/2023
   246                                  	;; 05/11/2023
   247                                  	;mov	eax, [bus_dev_fn]
   248                                  	;mov	al, PCI_CMD_REG
   249                                  	;call	pciRegRead16			; read PCI command register
   250                                  	;; 17/02/2017
   251                                  	;;mov	dx, [stats_cmd]
   252                                          ;or	dl, IO_ENA+BM_ENA               ; enable IO and bus master
   253                                  	;call	pciRegWrite16 ; pciRegWrite8
   254                                  
   255                                  	;; 06/11/2023
   256                                  	;;mov	eax, [bus_dev_fn]
   257                                  	;;mov	al, PCI_CMD_REG
   258                                  	;;call	pciRegRead8                     ; read PCI command register
   259                                  	;;or	dl, IO_ENA+BM_ENA               ; enable IO and bus master
   260                                  	;;call	pciRegWrite8
   261                                  
   262                                  ; setup the Codec (actually mixer registers) 
   263 00000133 E8E401                          call    codecConfig                     ; unmute codec, set rates.
   264                                  	; 11/11/2023
   265 00000136 721C                    	jc	short init_err
   266                                  ;
   267                                  ; position file pointer to start in actual wav data
   268                                  ; MUCH improvement should really be done here to check if sample size is
   269                                  ; supported, make sure there are 2 channels, etc.  
   270                                  ;
   271 00000138 B442                            mov     ah, 42h
   272 0000013A B000                            mov     al, 0                           ; from start of file
   273 0000013C 8B1E[021E]                      mov     bx, [filehandle]
   274 00000140 31C9                            xor     cx, cx
   275 00000142 BA2C00                          mov     dx, 44                          ; jump past .wav/riff header
   276 00000145 CD21                            int     21h
   277                                  
   278                                  ; play the .wav file. Most of the good stuff is in here.
   279                                  
   280 00000147 E88503                          call    playWav
   281                                  
   282                                  ; close the .wav file and exit.
   283                                  
   284                                  close_exit:			; 11/11/2023
   285 0000014A E85300                          call    closeFile
   286                                  
   287                                  exit:
   288 0000014D B8004C                          mov     ax, 4c00h
   289 00000150 CD21                    	int 	21h
   290                                  
   291                                  here:
   292 00000152 EBFE                    	jmp	short here
   293                                  
   294                                  	; 11/11/2023
   295                                  init_err:
   296 00000154 BA[7C1D]                	mov	dx, msg_init_err
   297                                  vra_err: ; 12/11/2023
   298 00000157 B409                            mov	ah, 9
   299 00000159 CD21                            int	21h
   300 0000015B EBED                    	jmp	short close_exit
   301                                  
   302                                  ; MEMALLOC.ASM
   303                                  ;-- SETFREE: Release memory not used  ----------------
   304                                  ;-- Input    : ES = address of PSP
   305                                  ;-- Output   : none
   306                                  ;-- Register : AX, BX, CL and FLAGS are changed 
   307                                  ;-- Info     : Since the stack-segment is always the last segment in an 
   308                                  ;              EXE-file, ES:0000 points to the beginning and SS:SP
   309                                  ;              to the end of the program in memory. Through this the
   310                                  ;              length of the program can be calculated 
   311                                  ; call this routine once at the beginning of the program to free up memory
   312                                  ; assigned to it by DOS.
   313                                  
   314                                  setFree:
   315 0000015D BB0010                  	  mov	bx, 65536/16	; 4K paragraphs ; 17/02/2017 (Erdogan Tan)		
   316                                  
   317 00000160 B44A                              mov	ah, 4ah		; pass new length to DOS
   318 00000162 CD21                              int	21h
   319                                  
   320 00000164 C3                                retn			; back to caller 
   321                                  				; new size (allocated memory) = 64KB
   322                                  
   323                                  memAlloc:
   324                                  ; input: AX = # of paragraphs required
   325                                  ; output: AX = segment of block to use
   326                                  
   327 00000165 53                      	push	bx
   328 00000166 89C3                    	mov	bx, ax
   329 00000168 B448                    	mov	ah, 48h
   330 0000016A CD21                    	int	21h
   331 0000016C 5B                      	pop	bx
   332 0000016D C3                      	retn
   333                                  
   334                                  ; CMDLINE.ASM
   335                                  ; parse the command line
   336                                  ; entry: none
   337                                  ; exit: DS:DX to the 1st supplied item on the command line 
   338                                  
   339                                  processCmdline:
   340 0000016E 53                              push    bx
   341 0000016F 56                              push    si
   342                                  
   343                                          ;mov    ah, 51h
   344                                          ;int    21h
   345                                          ;mov    ds, bx
   346                                  
   347 00000170 BE8000                          mov     si, 80h
   348 00000173 0FB61C                          movzx   bx, byte [si]
   349 00000176 01DE                            add     si, bx
   350 00000178 46                              inc     si
   351                                  
   352 00000179 C60400                          mov     byte [si], NULL         ; zero terminate
   353                                  
   354 0000017C BE8100                          mov     si, 81h
   355                                  
   356                                  cmdlineloop:
   357 0000017F AC                              lodsb
   358                                  
   359 00000180 3C00                            cmp     al, NULL                ; found end of line?
   360 00000182 7404                            je      short exitpc
   361 00000184 3C20                            cmp     al, ' '                 ; found a space?
   362 00000186 74F7                            je      short cmdlineloop
   363                                  
   364                                          ; must be the filename here.
   365                                  exitpc:
   366 00000188 4E                              dec     si                      ; point to start of filename
   367 00000189 89F2                            mov     dx, si
   368 0000018B 5E                              pop     si
   369 0000018C 5B                              pop     bx
   370 0000018D C3                      	retn
   371                                  
   372                                  ; FILE.ASM
   373                                  ;open or create file
   374                                  ;
   375                                  ;input: ds:dx-->filename (asciiz)
   376                                  ;       al=file Mode (create or open)
   377                                  ;output: none  cs:[filehandle] filled
   378                                  ;
   379                                  openFile:
   380 0000018E 50                      	push	ax
   381 0000018F 51                      	push	cx
   382 00000190 B43B                    	mov	ah, 3bh			; start with a mode
   383 00000192 00C4                    	add	ah, al			; add in create or open mode
   384 00000194 31C9                    	xor	cx, cx
   385 00000196 CD21                    	int	21h
   386 00000198 7203                    	jc	short _of1
   387                                  	;mov	[cs:filehandle], ax
   388 0000019A A3[021E]                	mov	[filehandle], ax
   389                                  _of1:
   390 0000019D 59                      	pop	cx
   391 0000019E 58                      	pop	ax
   392 0000019F C3                      	retn
   393                                  
   394                                  ; close the currently open file
   395                                  ; input: none, uses cs:[filehandle]
   396                                  closeFile:
   397 000001A0 50                      	push	ax
   398 000001A1 53                      	push	bx
   399 000001A2 833E[021E]FF            	cmp	word [filehandle], -1
   400 000001A7 7409                    	jz	short _cf1
   401 000001A9 8B1E[021E]              	mov     bx, [filehandle]  
   402 000001AD B8003E                  	mov     ax,3e00h
   403 000001B0 CD21                            int     21h              ;close file
   404                                  _cf1:
   405 000001B2 5B                      	pop	bx
   406 000001B3 58                      	pop	ax
   407 000001B4 C3                      	retn
   408                                  
   409                                  getSampleRate:
   410                                  	; 08/12/2016
   411                                  ; reads the sample rate from the .wav file.
   412                                  ; entry: none - assumes file is already open
   413                                  	; 19/11/2016 - Erdogan Tan
   414                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   415                                  ;	cx = number of channels (mono=1, stereo=2)
   416                                  ;	dx = bits per sample (8, 16)
   417                                  
   418 000001B5 53                      	push    bx
   419                                  
   420 000001B6 B442                            mov     ah, 42h
   421 000001B8 B000                            mov     al, 0				; from start of file
   422 000001BA 8B1E[021E]                      mov     bx, [filehandle]
   423 000001BE 31C9                            xor     cx, cx
   424 000001C0 BA0800                          mov     dx, 08h				; "WAVE"
   425 000001C3 CD21                            int     21h
   426                                  
   427 000001C5 BA[E61D]                        mov     dx, smpRBuff
   428 000001C8 B91C00                          mov     cx, 28				; 28 bytes
   429 000001CB B43F                    	mov	ah, 3fh
   430 000001CD CD21                            int     21h
   431                                  
   432 000001CF 813E[E61D]5741          	cmp	word [smpRBuff], 'WA'
   433 000001D5 751C                    	jne	short gsr_stc
   434                                  
   435 000001D7 813E[E81D]5645          	cmp	word [smpRBuff+2], 'VE'
   436 000001DD 7514                    	jne	short gsr_stc
   437                                  
   438 000001DF 833E[F21D]01            	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   439 000001E4 750D                    	jne	short gsr_stc
   440                                  
   441                                  
   442 000001E6 8B0E[F41D]              	mov	cx, [smpRBuff+14]	; return num of channels in CX
   443 000001EA A1[F61D]                        mov     ax, [smpRBuff+16]	; return sample rate in AX
   444 000001ED 8B16[001E]              	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   445                                  gsr_retn:
   446 000001F1 5B                              pop     bx
   447 000001F2 C3                              retn
   448                                  
   449                                  gsr_stc:
   450 000001F3 F9                      	stc
   451 000001F4 EBFB                    	jmp	short gsr_retn
   452                                  
   453                                  ;%include 'ac97.asm' ; 29/11/2016 (AC97 codec configuration)
   454                                  %include 'ac97_vra.asm' ; 19/11/2023 (AC97 codec configuration)
     1                              <1> ; 19/05/2024
     2                              <1> ; 19/11/2023 
     3                              <1> ;	(ready status optimization -in order to prevent wrong init error- )
     4                              <1> ; 18/11/2023
     5                              <1> ; 15/11/2023
     6                              <1> ; 13/11/2023
     7                              <1> ; 12/11/2023
     8                              <1> ; 11/11/2023
     9                              <1> ; 03/11/2023 - 06/11/2023
    10                              <1> ; PCI and AC97 codec functions for wav player
    11                              <1> ; Erdogan Tan (17/02/2017)
    12                              <1> 
    13                              <1> ; ----------------------------------------------------------------------------
    14                              <1> ; PCI.ASM
    15                              <1> ; ----------------------------------------------------------------------------
    16                              <1> 
    17                              <1> ; PCI device register reader/writers.
    18                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    19                              <1> ; 		Last Update: 17/02/2017
    20                              <1> 
    21                              <1> ;===============================================================
    22                              <1> ; 8/16/32bit PCI reader
    23                              <1> ;
    24                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    25                              <1> ;           BIT30 set if 32 bit access requested
    26                              <1> ;           BIT29 set if 16 bit access requested
    27                              <1> ;           otherwise defaults to 8 bit read
    28                              <1> ;
    29                              <1> ; Exit:  DL,DX,EDX register data depending on requested read size
    30                              <1> ;
    31                              <1> ; Note: this routine is meant to be called via pciRegRead8, pciRegread16,
    32                              <1> ;	or pciRegRead32, listed below.
    33                              <1> ;
    34                              <1> ; Note2: don't attempt to read 32bits of data from a non dword aligned reg
    35                              <1> ;	 number. Likewise, don't do 16bit reads from non word aligned reg #
    36                              <1> ; 
    37                              <1> pciRegRead:
    38 000001F6 6653                <1> 	push	ebx
    39 000001F8 51                  <1> 	push	cx
    40 000001F9 6689C3              <1>         mov     ebx, eax                        ; save eax, dh
    41 000001FC 88F1                <1>         mov     cl, dh
    42 000001FE 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    43 00000204 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
    44 0000020A 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
    45                              <1> 
    46 0000020C BAF80C              <1>         mov     dx, PCI_INDEX_PORT
    47 0000020F 66EF                <1>         out     dx, eax                         ; write PCI selector
    48                              <1> 
    49 00000211 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
    50 00000214 88D8                <1>         mov     al, bl
    51 00000216 2403                <1>         and     al, 3                           ; figure out which port to
    52 00000218 00C2                <1>         add     dl, al                          ; read to
    53                              <1> 
    54 0000021A 66ED                <1> 	in      eax, dx                         ; do 32bit read
    55 0000021C 66F7C300000080      <1>         test    ebx, PCI32
    56 00000223 7403                <1>         jz      short _pregr1
    57                              <1> 
    58 00000225 6689C2              <1>         mov     edx, eax                        ; return 32bits of data
    59                              <1> _pregr1:
    60 00000228 89C2                <1> 	mov     dx, ax                          ; return 16bits of data
    61 0000022A 66F7C3000000C0      <1>         test    ebx, PCI32+PCI16
    62 00000231 7502                <1>         jnz     short _pregr2
    63 00000233 88CE                <1>         mov     dh, cl                          ; restore dh for 8 bit read
    64                              <1> _pregr2:
    65 00000235 6689D8              <1>         mov     eax, ebx                        ; restore eax
    66 00000238 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    67 0000023E 59                  <1> 	pop	cx
    68 0000023F 665B                <1> 	pop	ebx
    69 00000241 C3                  <1> 	retn
    70                              <1> 
    71                              <1> pciRegRead8:
    72 00000242 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32             ; set up 8 bit read size
    73 00000248 EBAC                <1>         jmp     short pciRegRead		; call generic PCI access
    74                              <1> 
    75                              <1> pciRegRead16:
    76 0000024A 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit read size
    77 00000250 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
    78 00000256 EB9E                <1>         jmp     short pciRegRead
    79                              <1> 
    80                              <1> pciRegRead32:
    81 00000258 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit read size
    82 0000025E 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
    83 00000264 EB90                <1>         jmp     short pciRegRead
    84                              <1> 
    85                              <1> ;===============================================================
    86                              <1> ; 8/16/32bit PCI writer
    87                              <1> ;
    88                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    89                              <1> ;           BIT31 set if 32 bit access requested
    90                              <1> ;           BIT30 set if 16 bit access requested
    91                              <1> ;           otherwise defaults to 8bit read
    92                              <1> ;        DL/DX/EDX data to write depending on size
    93                              <1> ;
    94                              <1> ;
    95                              <1> ; note: this routine is meant to be called via pciRegWrite8, pciRegWrite16,
    96                              <1> ; 	or pciRegWrite32 as detailed below.
    97                              <1> ;
    98                              <1> ; Note2: don't attempt to write 32bits of data from a non dword aligned reg
    99                              <1> ;	 number. Likewise, don't do 16bit writes from non word aligned reg #
   100                              <1> ;
   101                              <1> pciRegWrite:
   102 00000266 6653                <1> 	push	ebx
   103 00000268 51                  <1> 	push	cx
   104 00000269 6689C3              <1>         mov     ebx, eax                        ; save eax, dx
   105 0000026C 89D1                <1>         mov     cx, dx
   106 0000026E 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
   107 00000274 6625FFFFFFBF        <1>         and     eax, ~PCI16 ; NOT PCI16         ; clear out data size request
   108 0000027A 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
   109                              <1> 
   110 0000027C BAF80C              <1>         mov     dx, PCI_INDEX_PORT
   111 0000027F 66EF                <1>         out     dx, eax                         ; write PCI selector
   112                              <1> 
   113 00000281 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
   114 00000284 88D8                <1>         mov     al, bl
   115 00000286 2403                <1>         and     al, 3                           ; figure out which port to
   116 00000288 00C2                <1>         add     dl, al                          ; write to
   117                              <1> 
   118 0000028A 6689D0              <1>         mov     eax, edx                        ; put data into eax
   119 0000028D 89C8                <1>         mov     ax, cx
   120                              <1> 
   121 0000028F EE                  <1>         out     dx, al
   122 00000290 66F7C3000000C0      <1>         test    ebx, PCI16+PCI32                ; only 8bit access? bail
   123 00000297 740C                <1>         jz      short _pregw1
   124                              <1> 
   125 00000299 EF                  <1>         out     dx, ax                          ; write 16 bit value
   126 0000029A 66F7C300000040      <1>         test    ebx, PCI16                      ; 16bit requested?  bail
   127 000002A1 7502                <1>         jnz     short _pregw1
   128                              <1> 
   129 000002A3 66EF                <1>         out     dx, eax                         ; write full 32bit
   130                              <1> _pregw1:
   131 000002A5 6689D8              <1>         mov     eax, ebx                        ; restore eax
   132 000002A8 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
   133 000002AE 89CA                <1>         mov     dx, cx                          ; restore dx
   134 000002B0 59                  <1> 	pop	cx
   135 000002B1 665B                <1> 	pop	ebx
   136 000002B3 C3                  <1> 	ret
   137                              <1> 
   138                              <1> pciRegWrite8:
   139 000002B4 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 8 bit write size
   140 000002BA EBAA                <1>         jmp     short pciRegWrite		; call generic PCI access
   141                              <1> 
   142                              <1> pciRegWrite16:
   143 000002BC 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit write size
   144 000002C2 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
   145 000002C8 EB9C                <1>         jmp     short pciRegWrite
   146                              <1> 
   147                              <1> pciRegWrite32:
   148 000002CA 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit write size
   149 000002D0 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
   150 000002D6 EB8E                <1>         jmp     short pciRegWrite
   151                              <1> 
   152                              <1> ; 17/02/2017 (Modifed by Erdogan Tan for various ICH device IDs)
   153                              <1> ;===============================================================
   154                              <1> ; PCIFindDevice: scan through PCI space looking for a device+vendor ID
   155                              <1> ;
   156                              <1> ;  ENTRY: none
   157                              <1> ;; Entry: EAX=Device+Vendor ID
   158                              <1> ;
   159                              <1> ;  Exit: EAX=PCI address if device found
   160                              <1> ;	 EDX=Device+Vendor ID
   161                              <1> ;        CY clear if found, set if not found. EAX invalid if CY set.
   162                              <1> ;
   163                              <1> ; [old stackless] Destroys: ebx, esi, edi, cl
   164                              <1> ;
   165                              <1> pciFindDevice:
   166                              <1> 	;push	cx
   167                              <1> 	;push	eax ; *
   168                              <1> 	;push	esi
   169                              <1> 	;push	edi
   170                              <1> 
   171                              <1>  	;mov     esi, eax                ; save off vend+device ID
   172                              <1> 
   173                              <1> 	; 17/02/2017
   174 000002D8 BE[411C]            <1> 	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
   175 000002DB B91500              <1> 	mov	cx, valid_id_count
   176                              <1> pfd_0:
   177 000002DE 66BF00FFFF7F        <1>        	mov     edi, (80000000h - 100h) ; start with bus 0, dev 0 func 0
   178                              <1> nextPCIdevice:
   179 000002E4 6681C700010000      <1>         add     edi, 100h
   180 000002EB 6681FF00F8FF80      <1>         cmp     edi, 80FFF800h		; scanned all devices?
   181                              <1>         ;stc
   182                              <1>         ;je 	short PCIScanExit       ; not found
   183 000002F2 720D                <1> 	jb	short pfd_1
   184 000002F4 66BF00000080        <1> 	mov     edi, 80000000h
   185 000002FA 83C604              <1> 	add	si, 4 ; scan for next device ID
   186 000002FD E202                <1> 	loop	pfd_1	 
   187 000002FF F9                  <1> 	stc	
   188                              <1> 	;jmp 	short PCIScanExit
   189 00000300 C3                  <1> 	retn
   190                              <1> pfd_1:
   191 00000301 6689F8              <1>         mov     eax, edi                ; read PCI registers
   192 00000304 E851FF              <1>         call    pciRegRead32
   193                              <1>         ;cmp    edx, esi                ; found device?
   194 00000307 663B14              <1>         cmp	edx, dword [si]
   195 0000030A 75D8                <1> 	jne     short nextPCIdevice
   196                              <1>         ;clc
   197                              <1> PCIScanExit:
   198                              <1> 	;pushf
   199 0000030C 66B800000080        <1> 	mov	eax, BIT31
   200 00000312 66F7D0              <1> 	not	eax
   201 00000315 6621F8              <1> 	and	eax, edi		; return only bus/dev/fn #
   202                              <1> 	;popf
   203                              <1> 
   204                              <1> 	;pop	edi
   205                              <1> 	;pop	esi
   206                              <1> 	;pop	edx ; *
   207                              <1> 	;pop	cx
   208 00000318 C3                  <1> 	retn
   209                              <1> 
   210                              <1> ; ----------------------------------------------------------------------------
   211                              <1> ; CODEC.ASM
   212                              <1> ; ----------------------------------------------------------------------------
   213                              <1> 
   214                              <1> ; codec configuration code. Not much here really.
   215                              <1> ; NASM version: Erdogan Tan (29/11/2016)
   216                              <1> 
   217                              <1> ; enable codec, unmute stuff, set output rate to 44.1
   218                              <1> ; entry: ax = desired sample rate
   219                              <1> 
   220                              <1> ; 19/05/2024
   221                              <1> ; 19/11/2023
   222                              <1> ; 11/11/2023
   223                              <1> ; 06/11/2023
   224                              <1> %if 1
   225                              <1> 
   226                              <1> ;	; 11/11/2023
   227                              <1> ;init_ac97_codec_err1:
   228                              <1> ;	stc
   229                              <1> ;init_ac97_codec_err2:
   230                              <1> ;	retn
   231                              <1> 
   232                              <1> 	; 13/11/2023
   233 00000319 01                  <1> VRA:	db 1	
   234                              <1> 
   235                              <1> codecConfig:
   236                              <1> 	; 19/05/2024
   237                              <1> 	; 19/11/2023
   238                              <1> 	; 15/11/2023
   239                              <1> 	; 04/11/2023
   240                              <1> 	; 17/02/2017 
   241                              <1> 	; 07/11/2016 (Erdogan Tan)
   242                              <1> 	;PORT_NABM_GLB_CTRL_STAT equ 60h
   243                              <1> 
   244                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   245                              <1>  	; 'AC97_DEF.H'
   246                              <1> 	;AC97_EXTENDED_STATUS equ 002Ah
   247                              <1> 	AC97_EA_SPDIF	equ 0002h
   248                              <1> 	AC97_EA_VRA	equ 0001h
   249                              <1> 	; 04/11/2023
   250                              <1> 	ICH_PO_CR_RESET equ 0002h  ; reset codec
   251                              <1> 	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
   252                              <1> 	ICH_PCM_246_MASK equ 300000h ; 6 channels
   253                              <1> 
   254                              <1> 	; 04/11/2023
   255                              <1> init_ac97_controller:
   256 0000031A 66A1[181E]          <1> 	mov	eax, [bus_dev_fn]
   257 0000031E B004                <1> 	mov	al, PCI_CMD_REG
   258 00000320 E827FF              <1> 	call	pciRegRead16		; read PCI command register
   259 00000323 80CA05              <1> 	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
   260 00000326 E893FF              <1> 	call	pciRegWrite16
   261                              <1> 
   262 00000329 E89801              <1> 	call	delay_100ms
   263                              <1> 
   264                              <1> 	; 19/05/2024
   265                              <1> 	; ('PLAYMOD3.ASM', Erdogan Tan, 18/05/2024)
   266                              <1> 
   267                              <1> init_ac97_codec:
   268                              <1> 	; 18/11/2023
   269 0000032C BD2800              <1> 	mov	bp, 40
   270                              <1> _initc_1:
   271                              <1> 	; 11/11/2023
   272                              <1> 	; (TRDOS 386 v2.0.5, 'audio.s')
   273 0000032F BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   274 00000332 0316[101E]          <1> 	add	dx, [NABMBAR]
   275 00000336 66ED                <1> 	in	eax, dx
   276                              <1> 
   277                              <1> 	; 19/05/2024
   278 00000338 E89E16              <1> 	call	delay1_4ms
   279                              <1> 
   280                              <1> 	; ?
   281 0000033B BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   282 0000033E 0316[101E]          <1> 	add	dx, [NABMBAR]
   283 00000342 66ED                <1> 	in	eax, dx
   284                              <1> 
   285                              <1> 	; 19/05/2024
   286 00000344 E89216              <1> 	call	delay1_4ms
   287                              <1> 
   288 00000347 6683F8FF            <1> 	cmp	eax, 0FFFFFFFFh ; -1
   289 0000034B 7508                <1> 	jne	short _initc_3
   290                              <1> _initc_2:
   291                              <1> 	;dec	cx
   292 0000034D 4D                  <1> 	dec	bp	; 18/11/2023
   293                              <1> 	;jz	short init_ac97_codec_err1
   294                              <1> 	; 19/11/2023
   295 0000034E 7412                <1> 	jz	short _ac97_codec_ready
   296                              <1> 
   297 00000350 E87101              <1> 	call	delay_100ms
   298 00000353 EBDA                <1> 	jmp	short _initc_1
   299                              <1> _initc_3:
   300 00000355 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   301 0000035B 7505                <1> 	jnz	short _ac97_codec_ready
   302                              <1> 
   303 0000035D E8E400              <1> 	call	reset_ac97_codec
   304                              <1> 	; 15/11/2023
   305                              <1> 	;jc	short _initc_2
   306                              <1> 	; 19/05/2024
   307 00000360 EBEB                <1> 	jmp	short _initc_2
   308                              <1> 
   309                              <1> _ac97_codec_ready:
   310 00000362 8B16[0E1E]          <1> 	mov	dx, [NAMBAR]
   311                              <1> 	;add	dx, 0 ; ac_reg_0 ; reset register
   312 00000366 EF                  <1> 	out	dx, ax
   313                              <1> 
   314 00000367 E85A01              <1> 	call	delay_100ms
   315                              <1> 
   316                              <1> 	; 19/11/2023
   317 0000036A 09ED                <1> 	or	bp, bp
   318 0000036C 751F                <1> 	jnz	short _ac97_codec_init_ok
   319                              <1> 
   320 0000036E 6631C0              <1> 	xor	eax, eax ; 0
   321 00000371 8B16[0E1E]          <1> 	mov	dx, [NAMBAR]
   322 00000375 83C226              <1> 	add	dx, CODEC_REG_POWERDOWN
   323 00000378 EF                  <1> 	out	dx, ax
   324                              <1> 	
   325                              <1> 	; 19/11/2023
   326                              <1> 	; wait for 1 second
   327                              <1> 	; 19/05/2024
   328                              <1> 	;mov	ecx, 1000 ; 1000*4*0.25ms = 1s
   329                              <1> 	;mov	cx, 10
   330 00000379 B92800              <1> 	mov	cx, 40
   331                              <1> _ac97_codec_rloop:
   332                              <1> 	;call	delay1_4ms
   333                              <1> 	;call	delay1_4ms
   334                              <1> 	;call	delay1_4ms
   335                              <1> 	;call	delay1_4ms
   336 0000037C E84501              <1> 	call	delay_100ms
   337                              <1> 
   338                              <1> 	;mov	dx, [NAMBAR]
   339                              <1> 	;add	dx, CODEC_REG_POWERDOWN
   340 0000037F ED                  <1> 	in	ax, dx
   341                              <1> 
   342 00000380 E85616              <1> 	call	delay1_4ms
   343                              <1> 	
   344 00000383 83E00F              <1> 	and	ax, 0Fh
   345 00000386 3C0F                <1> 	cmp	al, 0Fh
   346 00000388 7403                <1> 	je	short _ac97_codec_init_ok
   347 0000038A E2F0                <1> 	loop	_ac97_codec_rloop 
   348                              <1> 
   349                              <1> init_ac97_codec_err1:
   350                              <1> 	;stc	; cf = 1 ; 19/05/2024
   351                              <1> init_ac97_codec_err2:
   352 0000038C C3                  <1> 	retn
   353                              <1> 
   354                              <1> _ac97_codec_init_ok:
   355                              <1>         ; 11/11/2023
   356                              <1> 	;mov	al, 2 ; force set 16-bit 2-channel PCM
   357                              <1> 	;mov	dx, GLOB_CNT_REG ; 2Ch
   358                              <1> 	;add	dx, [NABMBAR]
   359                              <1> 	;out	dx, eax
   360                              <1> 
   361                              <1> 	;;call	delay1_4ms
   362                              <1> 
   363 0000038D E86D00              <1> 	call 	reset_ac97_controller
   364                              <1> 
   365                              <1> 	; 11/11/2023
   366                              <1> 	;call	delay1_4ms
   367                              <1> 	; 19/05/2024
   368 00000390 E83101              <1> 	call	delay_100ms
   369                              <1> 
   370                              <1> 	;call 	setup_ac97_codec
   371                              <1> 
   372                              <1> setup_ac97_codec:
   373                              <1> 	; 12/11/2023
   374 00000393 813E[201E]80BB      <1> 	cmp	word [sample_rate], 48000
   375 00000399 7435                <1> 	je	short skip_rate
   376                              <1> 
   377                              <1> ; 11/11/2023
   378                              <1> ; 05/11/2023
   379                              <1> ;%if 1
   380                              <1> 	AC97_EA_VRA equ BIT0 ; 11/11/2023
   381                              <1> 
   382                              <1> 	; 19/05/2024
   383 0000039B E83B16              <1> 	call	delay1_4ms
   384                              <1> 
   385                              <1> 	;; 19/05/2024
   386                              <1> 	;;mov	dx, [NAMBAR]
   387                              <1> 	;;add	dx, CODEC_EXT_AUDIO_REG	; 28h
   388                              <1> 	;;in	ax, dx
   389                              <1> 	;
   390                              <1> 	;; 19/05/2024
   391                              <1> 	;;test	al, 1 ; BIT0 ; Variable Rate Audio bit
   392                              <1> 	;;jz	short vra_not_supported
   393                              <1> 	;
   394                              <1> 	;; 19/05/2024
   395                              <1> 	;;call	delay1_4ms
   396                              <1> 
   397                              <1> 	; 11/11/2023
   398 0000039E 8B16[0E1E]          <1> 	mov    	dx, [NAMBAR]
   399 000003A2 83C22A              <1> 	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
   400 000003A5 ED                  <1> 	in     	ax, dx
   401                              <1> 
   402                              <1> 	; 19/05/2024
   403 000003A6 E83016              <1> 	call	delay1_4ms
   404                              <1> 	
   405 000003A9 24FD                <1> 	and	al, ~BIT1 ; Clear DRA
   406 000003AB 0C01                <1> 	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
   407 000003AD EF                  <1> 	out	dx, ax			; Enable variable rate audio
   408                              <1> 	
   409 000003AE B90A00              <1> 	mov	cx, 10
   410                              <1> check_vra:
   411 000003B1 E81001              <1> 	call	delay_100ms
   412                              <1> 
   413                              <1> 	; 11/11/2023
   414 000003B4 ED                  <1> 	in	ax, dx
   415 000003B5 A801                <1> 	test	al, AC97_EA_VRA ; 1
   416 000003B7 7509                <1> 	jnz	short set_rate
   417                              <1> 
   418                              <1> 	; 11/11/2023
   419 000003B9 E2F6                <1> 	loop	check_vra
   420                              <1> 
   421                              <1> ;vra_not_supported:	; 19/05/2024
   422                              <1> 	; 13/11/2023
   423 000003BB C606[1903]00        <1> 	mov	byte [VRA], 0
   424 000003C0 EB0E                <1> 	jmp	short skip_rate	
   425                              <1> 
   426                              <1> 	; 19/05/2024
   427                              <1> ;;vra_not_supported:
   428                              <1> 	; 12/11/2023
   429                              <1> 	;pop	ax ; discard return address to the caller
   430                              <1> 	;mov	dx, msg_no_vra
   431                              <1> 	;jmp	vra_err
   432                              <1> 
   433                              <1> set_rate:
   434 000003C2 A1[201E]            <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   435                              <1> 
   436 000003C5 8B16[0E1E]          <1> 	mov    	dx, [NAMBAR]               	
   437 000003C9 83C22C              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   438 000003CC EF                  <1> 	out	dx, ax 			; PCM Front/Center Output Sample Rate
   439                              <1> 
   440 000003CD E8F400              <1> 	call	delay_100ms
   441                              <1> 
   442                              <1> 	; 12/11/2023
   443                              <1> skip_rate:
   444                              <1> 	; 11/11/2023 (temporary)
   445                              <1> 
   446                              <1> 	;mov   	dx, [NAMBAR]               	
   447                              <1> 	;add   	dx, CODEC_PCM_SURND_DACRATE_REG	; 2Eh  	  
   448                              <1> 	;out	dx, ax 			; PCM Surround Output Sample Rate
   449                              <1> 
   450                              <1> 	;call	delay_100ms
   451                              <1> 
   452                              <1> 	;mov   	dx, [NAMBAR]               	
   453                              <1> 	;add   	dx, CODEC_PCM_LFE_DACRATE_REG	; 30h  	  
   454                              <1> 	;out	dx, ax 			; PCM LFE Output Sample Rate
   455                              <1> 
   456                              <1> 	;call	delay_100ms
   457                              <1> 
   458                              <1> 	; 05/11/2023 (temporary)
   459                              <1> 	;mov	dx, [NAMBAR]               	
   460                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   461                              <1> 	;out	dx, ax 			; PCM Input Sample Rate
   462                              <1> 	;
   463                              <1> 	;call	delay_100ms
   464                              <1> 
   465 000003D0 B80202              <1> 	mov	ax, 0202h
   466 000003D3 8B16[0E1E]          <1>   	mov     dx, [NAMBAR]
   467 000003D7 83C202              <1>   	add     dx, CODEC_MASTER_VOL_REG	;02h 
   468 000003DA EF                  <1> 	out     dx, ax
   469                              <1> 
   470                              <1> 	; 11/11/2023
   471                              <1>         ;call	delay1_4ms
   472                              <1>         ;call	delay1_4ms
   473                              <1>         ;call	delay1_4ms
   474                              <1>         ;call	delay1_4ms
   475                              <1>  	;
   476                              <1>   	;mov	dx, [NAMBAR]
   477                              <1>   	;add	dx, CODEC_MASTER_MONO_VOL_REG	;06h 
   478                              <1>   	;out	dx, ax
   479                              <1> 
   480                              <1> 	; 11/11/2023
   481                              <1>         ;call	delay1_4ms
   482                              <1>         ;call	delay1_4ms
   483                              <1>         ;call	delay1_4ms
   484                              <1>         ;call	delay1_4ms
   485                              <1> 	;
   486                              <1> 	;mov	ax, 02h
   487                              <1>   	;mov	dx, [NAMBAR]
   488                              <1>   	;add	dx, CODEC_PCBEEP_VOL_REG	;0Ah 
   489                              <1>   	;out	dx, ax
   490                              <1> 
   491 000003DB E8FB15              <1>         call    delay1_4ms
   492 000003DE E8F815              <1>         call    delay1_4ms
   493 000003E1 E8F515              <1>         call    delay1_4ms
   494 000003E4 E8F215              <1>         call    delay1_4ms
   495                              <1> 
   496                              <1> 	;mov	ax, 0202h
   497 000003E7 8B16[0E1E]          <1>   	mov     dx, [NAMBAR]
   498 000003EB 83C218              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h 
   499 000003EE EF                  <1>   	out     dx, ax
   500                              <1> 
   501 000003EF E8E715              <1>         call    delay1_4ms
   502 000003F2 E8E415              <1>         call    delay1_4ms
   503 000003F5 E8E115              <1>         call    delay1_4ms
   504 000003F8 E8DE15              <1>         call    delay1_4ms
   505                              <1> 
   506                              <1> 	; 11/11/2023
   507                              <1> 	;mov	ax, 8008h ; Mute
   508                              <1>   	;mov	dx, [NAMBAR]
   509                              <1> 	;add	dx, CODEC_PHONE_VOL_REG		;0Ch
   510                              <1> 	;			 ; AC97_PHONE_VOL ; TAD Input (Mono)
   511                              <1>   	;out	dx, ax
   512                              <1> 	;
   513                              <1>         ;call	delay1_4ms
   514                              <1>         ;call	delay1_4ms
   515                              <1>         ;call	delay1_4ms
   516                              <1> 	;call	delay1_4ms
   517                              <1> 
   518                              <1> 	;mov	ax, 0808h
   519                              <1> 	;mov	dx, [NAMBAR]
   520                              <1> 	;add	dx, CODEC_LINE_IN_VOL_REG ;10h ; Line Input (Stereo)
   521                              <1> 	;out	dx, ax
   522                              <1> 	;
   523                              <1>         ;call	delay1_4ms
   524                              <1>         ;call	delay1_4ms
   525                              <1>         ;call	delay1_4ms
   526                              <1> 	;call	delay1_4ms
   527                              <1> 
   528                              <1>   	;mov	dx, [NAMBAR]
   529                              <1>         ;add	dx, CODEC_CD_VOL_REG ;12h ; CD Input (Stereo)
   530                              <1>   	;out	dx, ax
   531                              <1> 	;
   532                              <1>   	;mov	dx, [NAMBAR]
   533                              <1>         ;add	dx, CODEC_AUX_VOL_REG ;16h ; Aux Input (Stereo)
   534                              <1>   	;out	dx, ax
   535                              <1> 	;
   536                              <1>         ;call	delay1_4ms
   537                              <1>         ;call	delay1_4ms
   538                              <1>         ;call	delay1_4ms
   539                              <1> 	;call	delay1_4ms
   540                              <1> 
   541                              <1> 	; 19/05/2024
   542 000003FB F8                  <1> 	clc
   543                              <1> 
   544                              <1> ;detect_ac97_codec:
   545 000003FC C3                  <1>         retn
   546                              <1> 
   547                              <1> reset_ac97_controller:
   548                              <1> 	; 19/05/2024
   549                              <1> 	; 11/11/2023
   550                              <1> 	; 10/06/2017
   551                              <1> 	; 29/05/2017
   552                              <1> 	; 28/05/2017
   553                              <1> 	; reset AC97 audio controller registers
   554 000003FD 31C0                <1> 	xor     ax, ax
   555 000003FF BA0B00              <1>         mov	dx, PI_CR_REG
   556 00000402 0316[101E]          <1> 	add	dx, [NABMBAR]
   557 00000406 EE                  <1> 	out     dx, al
   558                              <1> 
   559                              <1> 	; 19/05/2024
   560 00000407 E8CF15              <1> 	call	delay1_4ms
   561                              <1> 
   562 0000040A BA1B00              <1>         mov     dx, PO_CR_REG
   563 0000040D 0316[101E]          <1> 	add	dx, [NABMBAR]
   564 00000411 EE                  <1> 	out     dx, al
   565                              <1> 
   566                              <1> 	; 19/05/2024
   567 00000412 E8C415              <1> 	call	delay1_4ms
   568                              <1> 
   569 00000415 BA2B00              <1>         mov     dx, MC_CR_REG
   570 00000418 0316[101E]          <1> 	add	dx, [NABMBAR]
   571 0000041C EE                  <1> 	out     dx, al
   572                              <1> 
   573                              <1> 	; 19/05/2024
   574 0000041D E8B915              <1> 	call	delay1_4ms
   575                              <1> 
   576 00000420 B002                <1>         mov     al, RR
   577 00000422 BA0B00              <1>         mov     dx, PI_CR_REG
   578 00000425 0316[101E]          <1> 	add	dx, [NABMBAR]
   579 00000429 EE                  <1> 	out     dx, al
   580                              <1> 
   581                              <1> 	; 19/05/2024
   582 0000042A E8AC15              <1> 	call	delay1_4ms
   583                              <1> 
   584 0000042D BA1B00              <1>         mov     dx, PO_CR_REG
   585 00000430 0316[101E]          <1> 	add	dx, [NABMBAR]
   586 00000434 EE                  <1> 	out     dx, al
   587                              <1> 
   588                              <1> 	; 19/05/2024
   589 00000435 E8A115              <1> 	call	delay1_4ms
   590                              <1> 
   591 00000438 BA2B00              <1>         mov     dx, MC_CR_REG
   592 0000043B 0316[101E]          <1> 	add	dx, [NABMBAR]
   593 0000043F EE                  <1> 	out     dx, al
   594                              <1> 
   595                              <1> 	; 19/05/2024
   596 00000440 E89615              <1> 	call	delay1_4ms
   597                              <1> 
   598 00000443 C3                  <1> 	retn
   599                              <1> 
   600                              <1> reset_ac97_codec:
   601                              <1> 	; 11/11/2023
   602                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   603 00000444 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   604 00000447 0316[101E]          <1> 	add	dx, [NABMBAR]
   605 0000044B 66ED                <1> 	in	eax, dx
   606                              <1> 
   607                              <1> 	;test	eax, 2
   608                              <1> 	; 06/08/2022
   609 0000044D A802                <1> 	test	al, 2
   610 0000044F 7405                <1> 	jz	short _r_ac97codec_cold	
   611                              <1> 
   612 00000451 E80E00              <1> 	call	warm_ac97codec_reset
   613 00000454 7306                <1> 	jnc	short _r_ac97codec_ok
   614                              <1> _r_ac97codec_cold:
   615 00000456 E83400              <1>         call    cold_ac97codec_reset
   616 00000459 7301                <1>         jnc     short _r_ac97codec_ok
   617                              <1> 	
   618                              <1> 	; 16/04/2017
   619                              <1>         ;xor	eax, eax	; timeout error
   620                              <1>        	;stc
   621 0000045B C3                  <1> 	retn
   622                              <1> 
   623                              <1> _r_ac97codec_ok:
   624 0000045C 6631C0              <1>         xor     eax, eax
   625                              <1>         ;mov	al, VIA_ACLINK_C00_READY ; 1
   626 0000045F FEC0                <1>         inc	al
   627 00000461 C3                  <1> 	retn
   628                              <1> 
   629                              <1> warm_ac97codec_reset:
   630                              <1> 	; 11/11/2023
   631                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   632                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   633 00000462 66B806000000        <1> 	mov	eax, 6
   634 00000468 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   635 0000046B 0316[101E]          <1> 	add	dx, [NABMBAR]
   636 0000046F 66EF                <1> 	out	dx, eax
   637                              <1> 
   638 00000471 B90A00              <1> 	mov	cx, 10	; total 1s
   639                              <1> _warm_ac97c_rst_wait:
   640 00000474 E84D00              <1> 	call	delay_100ms
   641                              <1> 
   642 00000477 BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   643 0000047A 0316[101E]          <1> 	add	dx, [NABMBAR]
   644 0000047E 66ED                <1> 	in	eax, dx
   645                              <1> 
   646 00000480 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   647 00000486 7504                <1> 	jnz	short _warm_ac97c_rst_ok
   648                              <1> 
   649 00000488 49                  <1>         dec     cx
   650 00000489 75E9                <1>         jnz     short _warm_ac97c_rst_wait
   651                              <1> 
   652                              <1> _warm_ac97c_rst_fail:
   653 0000048B F9                  <1>         stc
   654                              <1> _warm_ac97c_rst_ok:
   655 0000048C C3                  <1> 	retn
   656                              <1> 
   657                              <1> cold_ac97codec_reset:
   658                              <1> 	; 11/11/2023
   659                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   660                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   661 0000048D 66B802000000        <1>         mov	eax, 2
   662 00000493 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   663 00000496 0316[101E]          <1> 	add	dx, [NABMBAR]
   664 0000049A 66EF                <1> 	out	dx, eax
   665                              <1> 
   666 0000049C E82500              <1> 	call	delay_100ms 	; wait 100 ms
   667 0000049F E82200              <1> 	call	delay_100ms 	; wait 100 ms
   668 000004A2 E81F00              <1> 	call	delay_100ms 	; wait 100 ms
   669 000004A5 E81C00              <1> 	call	delay_100ms 	; wait 100 ms
   670                              <1> 
   671 000004A8 B91000              <1> 	mov	cx, 16	; total 20*100 ms = 2s
   672                              <1> 
   673                              <1> _cold_ac97c_rst_wait:
   674 000004AB BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   675 000004AE 0316[101E]          <1> 	add	dx, [NABMBAR]
   676 000004B2 66ED                <1> 	in	eax, dx
   677                              <1> 
   678 000004B4 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   679 000004BA 7507                <1> 	jnz	short _cold_ac97c_rst_ok
   680                              <1> 
   681 000004BC E80500              <1> 	call	delay_100ms
   682                              <1> 
   683 000004BF 49                  <1>         dec     cx
   684 000004C0 75E9                <1>         jnz     short _cold_ac97c_rst_wait
   685                              <1> 
   686                              <1> _cold_ac97c_rst_fail:
   687 000004C2 F9                  <1>         stc
   688                              <1> _cold_ac97c_rst_ok:
   689 000004C3 C3                  <1> 	retn
   690                              <1> 
   691                              <1> delay_100ms:
   692                              <1> 	; 11/11/2023
   693                              <1> 	; 29/05/2017
   694                              <1> 	; 24/03/2017 ('codec.asm')
   695                              <1> 	; wait 100 ms
   696 000004C4 51                  <1> 	push	cx
   697 000004C5 B99001              <1> 	mov	cx, 400  ; 400*0.25ms
   698                              <1> _delay_x_ms:
   699 000004C8 E80E15              <1> 	call	delay1_4ms
   700 000004CB E2FB                <1>         loop	_delay_x_ms
   701 000004CD 59                  <1> 	pop	cx
   702 000004CE C3                  <1> 	retn
   703                              <1> 
   704                              <1> %endif
   705                              <1> 
   706                              <1> ; 11/11/2023
   707                              <1> %if 0
   708                              <1> 
   709                              <1> codecConfig:
   710                              <1> 	; 06/11/2023
   711                              <1> 	; TUNELOOP version (playing without interrupt)
   712                              <1> 	; 04/11/2023
   713                              <1> 	; 17/02/2017 
   714                              <1> 	; 07/11/2016 (Erdogan Tan)
   715                              <1> 
   716                              <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   717                              <1> 
   718                              <1> 	mov    	dx, [NAMBAR]               	
   719                              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   720                              <1> 	out	dx, ax 				; out sample rate
   721                              <1> 		
   722                              <1> 	; 05/11/2023 temp
   723                              <1> 	;mov	dx, [NAMBAR]               	
   724                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   725                              <1> 	;out	dx, ax 
   726                              <1> 
   727                              <1>         call    delay1_4ms
   728                              <1>         call    delay1_4ms
   729                              <1>         call    delay1_4ms
   730                              <1>         call    delay1_4ms
   731                              <1> 
   732                              <1> 	mov	eax, [dev_vendor]
   733                              <1>         cmp	eax, (SI7012_DID<<16)+SIS_VID
   734                              <1>         jne	short cConfig1
   735                              <1> 
   736                              <1> 	; Unmute quirk specifically for the SiS7012
   737                              <1> 
   738                              <1> 	CUSTOM_SIS_7012_REG equ 4Ch ; SiS7012-specific register
   739                              <1> 	
   740                              <1>         mov     dx, [NABMBAR]
   741                              <1>         add     dx, CUSTOM_SIS_7012_REG
   742                              <1>         in      ax, dx
   743                              <1>         or	al, 1
   744                              <1>         out     dx, ax
   745                              <1> 
   746                              <1> cConfig1:
   747                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   748                              <1> 	; initial ac97 volumes (and clear mute flag)
   749                              <1> 		
   750                              <1>   	mov     dx, [NAMBAR]
   751                              <1>   	add     dx, CODEC_MASTER_VOL_REG        ;02h ; STEREO
   752                              <1>   	;xor	ax, ax ; volume attenuation = 0 (max. volume)
   753                              <1>   	; 03/11/2023
   754                              <1> 	mov	ax, 0202h
   755                              <1> 	out     dx, ax
   756                              <1> 
   757                              <1>         call    delay1_4ms	; delays because codecs are slow
   758                              <1>         call    delay1_4ms
   759                              <1>         call    delay1_4ms
   760                              <1>         call    delay1_4ms
   761                              <1>  
   762                              <1>   	mov     dx, [NAMBAR]
   763                              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h
   764                              <1>   	;;xor	ax, ax
   765                              <1> 	;mov	ax, 0202h
   766                              <1>   	out     dx, ax
   767                              <1> 
   768                              <1>         call    delay1_4ms
   769                              <1>         call    delay1_4ms
   770                              <1>         call    delay1_4ms
   771                              <1>         call    delay1_4ms
   772                              <1>  
   773                              <1> 	retn
   774                              <1> 
   775                              <1> %endif
   455                                  ;%include 'ich_wav.asm' ; 17/02/2017 (ICH AC97 wav playing functions)
   456                                  %include 'ich_wav3.asm' ; 13/11/2023 (ICH AC97 wav playing functions)
     1                              <1> ; 19/05/2024
     2                              <1> ; 18/11/2023
     3                              <1> ; 17/11/2023
     4                              <1> ; 16/11/2023
     5                              <1> ; 15/11/2023
     6                              <1> ; 14/11/2023
     7                              <1> ; 13/11/2023
     8                              <1> ; 03/11/2023 - 11/11/2023
     9                              <1> ; DOS based .WAV player using AC'97 and codec interface.
    10                              <1> ; ---------------------------------------------------------------
    11                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    12                              <1> ; Last Update: 17/02/2017 (by Erdogan Tan)
    13                              <1> 
    14                              <1> ; AC97 interrupt version - 09/11/2023 - Erdogan Tan
    15                              <1> ; sample rate conversion version - 13/11/2023 - Erdogan Tan
    16                              <1> 
    17                              <1> ; ICHWAV.ASM
    18                              <1> 
    19                              <1> ; player internal variables and other equates.
    20                              <1> BUFFERSIZE      equ     64 * 1024       ; 64k file buffer size.
    21                              <1> ENDOFFILE       equ     BIT0            ; flag for knowing end of file
    22                              <1> 
    23                              <1> ;===========================================================================
    24                              <1> ; entry: none. File is already open and [filehandle] filled.
    25                              <1> ; exit:  not until the song is finished or the user aborts.
    26                              <1> ;
    27                              <1> playWav:
    28                              <1> 	; 13/11/2023
    29                              <1> 
    30 000004CF 803E[1903]01        <1> 	cmp	byte [VRA], 1
    31 000004D4 720F                <1> 	jb	short chk_sample_rate
    32                              <1> playwav_48_khz:	
    33 000004D6 C706[8506][B907]    <1> 	mov	word [loadfromwavfile], loadFromFile
    34                              <1> 	;mov	word [loadsize], 0 ; 65536
    35 000004DC C706[8906]0080      <1> 	mov	word [buffersize], 32768 ; samples
    36 000004E2 E9A801              <1> 	jmp	playWav_vra
    37                              <1> 
    38                              <1> chk_sample_rate:
    39                              <1> 	; set conversion parameters
    40                              <1> 	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
    41 000004E5 A1[201E]            <1> 	mov	ax, [sample_rate]
    42 000004E8 3D80BB              <1> 	cmp	ax, 48000
    43 000004EB 74E9                <1> 	je	short playwav_48_khz
    44                              <1> chk_22khz:
    45 000004ED 3D2256              <1> 	cmp	ax, 22050
    46 000004F0 752F                <1> 	jne	short chk_11khz
    47 000004F2 803E[241E]08        <1> 	cmp	byte [bps], 8
    48 000004F7 760F                <1> 	jna	short chk_22khz_1
    49 000004F9 BB[FC11]            <1> 	mov	bx, load_22khz_stereo_16_bit
    50 000004FC 803E[221E]01        <1> 	cmp	byte [stmo], 1 
    51 00000501 7512                <1> 	jne	short chk_22khz_2
    52 00000503 BB[9311]            <1> 	mov	bx, load_22khz_mono_16_bit
    53 00000506 EB0D                <1> 	jmp	short chk_22khz_2
    54                              <1> chk_22khz_1:
    55 00000508 BB[2E11]            <1> 	mov	bx, load_22khz_stereo_8_bit
    56 0000050B 803E[221E]01        <1> 	cmp	byte [stmo], 1 
    57 00000510 7503                <1> 	jne	short chk_22khz_2
    58 00000512 BB[C510]            <1> 	mov	bx, load_22khz_mono_8_bit
    59                              <1> chk_22khz_2:
    60 00000515 B85A1D              <1> 	mov	ax, 7514  ; (442*17)
    61 00000518 BA2500              <1> 	mov	dx, 37
    62 0000051B B91100              <1> 	mov	cx, 17 
    63 0000051E E93301              <1> 	jmp	set_sizes	
    64                              <1> chk_11khz:
    65 00000521 3D112B              <1> 	cmp	ax, 11025
    66 00000524 752F                <1> 	jne	short chk_44khz
    67 00000526 803E[241E]08        <1> 	cmp	byte [bps], 8
    68 0000052B 760F                <1> 	jna	short chk_11khz_1
    69 0000052D BB[9013]            <1> 	mov	bx, load_11khz_stereo_16_bit
    70 00000530 803E[221E]01        <1> 	cmp	byte [stmo], 1 
    71 00000535 7512                <1> 	jne	short chk_11khz_2
    72 00000537 BB[3513]            <1> 	mov	bx, load_11khz_mono_16_bit
    73 0000053A EB0D                <1> 	jmp	short chk_11khz_2
    74                              <1> chk_11khz_1:
    75 0000053C BB[DA12]            <1> 	mov	bx, load_11khz_stereo_8_bit
    76 0000053F 803E[221E]01        <1> 	cmp	byte [stmo], 1 
    77 00000544 7503                <1> 	jne	short chk_11khz_2
    78 00000546 BB[7C12]            <1> 	mov	bx, load_11khz_mono_8_bit
    79                              <1> chk_11khz_2:
    80 00000549 B8AD0E              <1> 	mov	ax, 3757  ; (221*17)
    81 0000054C BA4A00              <1> 	mov	dx, 74
    82 0000054F B91100              <1> 	mov	cx, 17
    83 00000552 E9FF00              <1> 	jmp	set_sizes 
    84                              <1> chk_44khz:
    85 00000555 3D44AC              <1> 	cmp	ax, 44100
    86 00000558 752F                <1> 	jne	short chk_16khz
    87 0000055A 803E[241E]08        <1> 	cmp	byte [bps], 8
    88 0000055F 760F                <1> 	jna	short chk_44khz_1
    89 00000561 BB[4115]            <1> 	mov	bx, load_44khz_stereo_16_bit
    90 00000564 803E[221E]01        <1> 	cmp	byte [stmo], 1 
    91 00000569 7512                <1> 	jne	short chk_44khz_2
    92 0000056B BB[E914]            <1> 	mov	bx, load_44khz_mono_16_bit
    93 0000056E EB0D                <1> 	jmp	short chk_44khz_2
    94                              <1> chk_44khz_1:
    95 00000570 BB[8B14]            <1> 	mov	bx, load_44khz_stereo_8_bit
    96 00000573 803E[221E]01        <1> 	cmp	byte [stmo], 1 
    97 00000578 7503                <1> 	jne	short chk_44khz_2
    98 0000057A BB[2E14]            <1> 	mov	bx, load_44khz_mono_8_bit
    99                              <1> chk_44khz_2:
   100                              <1> 	;mov	ax, 15065 ; (655*23)
   101                              <1> 	; 18/11/2023 ((file size + bss + stack) <= 64KB)
   102 0000057D B8FC36              <1> 	mov	ax, 14076 ; (612 *23)
   103 00000580 BA1900              <1> 	mov	dx, 25
   104 00000583 B91700              <1> 	mov	cx, 23
   105 00000586 E9CB00              <1> 	jmp	set_sizes 
   106                              <1> chk_16khz:
   107 00000589 3D803E              <1> 	cmp	ax, 16000
   108 0000058C 752F                <1> 	jne	short chk_8khz
   109 0000058E 803E[241E]08        <1> 	cmp	byte [bps], 8
   110 00000593 760F                <1> 	jna	short chk_16khz_1
   111 00000595 BB[430D]            <1> 	mov	bx, load_16khz_stereo_16_bit
   112 00000598 803E[221E]01        <1> 	cmp	byte [stmo], 1 
   113 0000059D 7512                <1> 	jne	short chk_16khz_2
   114 0000059F BB[E20C]            <1> 	mov	bx, load_16khz_mono_16_bit
   115 000005A2 EB0D                <1> 	jmp	short chk_16khz_2
   116                              <1> chk_16khz_1:
   117 000005A4 BB[520C]            <1> 	mov	bx, load_16khz_stereo_8_bit
   118 000005A7 803E[221E]01        <1> 	cmp	byte [stmo], 1 
   119 000005AC 7503                <1> 	jne	short chk_16khz_2
   120 000005AE BB[EE0B]            <1> 	mov	bx, load_16khz_mono_8_bit
   121                              <1> chk_16khz_2:
   122 000005B1 B85515              <1> 	mov	ax, 5461
   123 000005B4 BA0300              <1> 	mov	dx, 3
   124 000005B7 B90100              <1> 	mov	cx, 1
   125 000005BA E99700              <1> 	jmp	set_sizes 
   126                              <1> chk_8khz:
   127 000005BD 3D401F              <1> 	cmp	ax, 8000
   128 000005C0 752E                <1> 	jne	short chk_24khz
   129 000005C2 803E[241E]08        <1> 	cmp	byte [bps], 8
   130 000005C7 760F                <1> 	jna	short chk_8khz_1
   131 000005C9 BB[070B]            <1> 	mov	bx, load_8khz_stereo_16_bit
   132 000005CC 803E[221E]01        <1> 	cmp	byte [stmo], 1 
   133 000005D1 7512                <1> 	jne	short chk_8khz_2
   134 000005D3 BB[760A]            <1> 	mov	bx, load_8khz_mono_16_bit
   135 000005D6 EB0D                <1> 	jmp	short chk_8khz_2
   136                              <1> chk_8khz_1:
   137 000005D8 BB[8609]            <1> 	mov	bx, load_8khz_stereo_8_bit
   138 000005DB 803E[221E]01        <1> 	cmp	byte [stmo], 1 
   139 000005E0 7503                <1> 	jne	short chk_8khz_2
   140 000005E2 BB[D308]            <1> 	mov	bx, load_8khz_mono_8_bit
   141                              <1> chk_8khz_2:
   142 000005E5 B8AA0A              <1> 	mov	ax, 2730
   143 000005E8 BA0600              <1> 	mov	dx, 6
   144 000005EB B90100              <1> 	mov	cx, 1
   145 000005EE EB64                <1> 	jmp	short set_sizes 
   146                              <1> chk_24khz:
   147 000005F0 3DC05D              <1> 	cmp	ax, 24000
   148 000005F3 752E                <1> 	jne	short chk_32khz
   149 000005F5 803E[241E]08        <1> 	cmp	byte [bps], 8
   150 000005FA 760F                <1> 	jna	short chk_24khz_1
   151 000005FC BB[D80E]            <1> 	mov	bx, load_24khz_stereo_16_bit
   152 000005FF 803E[221E]01        <1> 	cmp	byte [stmo], 1 
   153 00000604 7512                <1> 	jne	short chk_24khz_2
   154 00000606 BB[8F0E]            <1> 	mov	bx, load_24khz_mono_16_bit
   155 00000609 EB0D                <1> 	jmp	short chk_24khz_2
   156                              <1> chk_24khz_1:
   157 0000060B BB[270E]            <1> 	mov	bx, load_24khz_stereo_8_bit
   158 0000060E 803E[221E]01        <1> 	cmp	byte [stmo], 1 
   159 00000613 7503                <1> 	jne	short chk_24khz_2
   160 00000615 BB[D80D]            <1> 	mov	bx, load_24khz_mono_8_bit
   161                              <1> chk_24khz_2:
   162 00000618 B80020              <1> 	mov	ax, 8192
   163 0000061B BA0200              <1> 	mov	dx, 2
   164 0000061E B90100              <1> 	mov	cx, 1
   165 00000621 EB31                <1> 	jmp	short set_sizes 
   166                              <1> chk_32khz:
   167 00000623 3D007D              <1> 	cmp	ax, 32000
   168 00000626 7556                <1> 	jne	short vra_needed
   169 00000628 803E[241E]08        <1> 	cmp	byte [bps], 8
   170 0000062D 760F                <1> 	jna	short chk_32khz_1
   171 0000062F BB[5A10]            <1> 	mov	bx, load_32khz_stereo_16_bit
   172 00000632 803E[221E]01        <1> 	cmp	byte [stmo], 1 
   173 00000637 7512                <1> 	jne	short chk_32khz_2
   174 00000639 BB[0D10]            <1> 	mov	bx, load_32khz_mono_16_bit
   175 0000063C EB0D                <1> 	jmp	short chk_32khz_2
   176                              <1> chk_32khz_1:
   177 0000063E BB[960F]            <1> 	mov	bx, load_32khz_stereo_8_bit
   178 00000641 803E[221E]01        <1> 	cmp	byte [stmo], 1 
   179 00000646 7503                <1> 	jne	short chk_32khz_2
   180 00000648 BB[3E0F]            <1> 	mov	bx, load_32khz_mono_8_bit
   181                              <1> chk_32khz_2:
   182 0000064B B8AA2A              <1> 	mov	ax, 10922
   183 0000064E BA0300              <1> 	mov	dx, 3
   184 00000651 B90200              <1> 	mov	cx, 2
   185                              <1> 	;jmp	short set_sizes 
   186                              <1> set_sizes:
   187 00000654 803E[221E]01        <1> 	cmp	byte [stmo], 1
   188 00000659 7402                <1> 	je	short ss_1
   189 0000065B D1E0                <1> 	shl	ax, 1
   190                              <1> ss_1:
   191 0000065D 803E[241E]08        <1> 	cmp	byte [bps], 8
   192 00000662 7602                <1> 	jna	short ss_2
   193                              <1> 	; 16 bit samples
   194 00000664 D1E0                <1> 	shl	ax, 1
   195                              <1> ss_2:
   196 00000666 A3[8706]            <1> 	mov	[loadsize], ax
   197 00000669 F7E2                <1> 	mul	dx
   198                              <1> 	;cmp	cx, 1
   199                              <1> 	;je	short ss_3
   200                              <1> ;ss_3:
   201 0000066B F7F1                <1> 	div	cx
   202 0000066D 8A0E[261E]          <1> 	mov	cl, [fbs_shift]
   203 00000671 D3E0                <1> 	shl	ax, cl
   204 00000673 D1E8                <1> 	shr	ax, 1	; buffer size is 16 bit sample count
   205 00000675 A3[8906]            <1> 	mov	[buffersize], ax 
   206 00000678 891E[8506]          <1> 	mov	[loadfromwavfile], bx
   207 0000067C EB0F                <1> 	jmp	short playWav_vra
   208                              <1> 
   209                              <1> vra_needed:
   210                              <1> 	; 13/11/2023
   211 0000067E 58                  <1> 	pop	ax ; discard return address to the caller
   212 0000067F BA[AD1D]            <1> 	mov	dx, msg_no_vra
   213 00000682 E9D2FA              <1> 	jmp	vra_err
   214                              <1> 
   215                              <1> 	; 13/11/2023
   216                              <1> loadfromwavfile:
   217 00000685 [B907]              <1> 	dw	loadFromFile
   218                              <1> loadsize:	; read from wav file
   219 00000687 0000                <1> 	dw	0
   220                              <1> buffersize:	; write to DMA buffer
   221 00000689 00800000            <1> 	dd	32768 ; 16 bit samples (not bytes)
   222                              <1> 
   223                              <1> playWav_vra:
   224                              <1> 	; 07/11/2023
   225                              <1> 	; clear buffer 2
   226                              <1>         ;push	es
   227                              <1> 	;mov	ax, [WAV_BUFFER2]
   228                              <1> 	;mov	es, ax
   229                              <1> 	;sub	ax, ax
   230                              <1> 	;mov	di, ax ; 17/02/2017
   231                              <1> 	;mov	cx, (BUFFERSIZE/2)
   232                              <1> 	;rep	stosw
   233                              <1> 	;pop	es	     
   234                              <1> 	
   235                              <1> 	; load 64k into buffer 1
   236 0000068D A1[141E]            <1>         mov     ax, [WAV_BUFFER1]
   237                              <1>         ;call	loadFromFile
   238                              <1> 	; 13/11/2023
   239 00000690 FF16[8506]          <1> 	call	word [loadfromwavfile]
   240                              <1> 
   241                              <1> 	; and 64k into buffer 2
   242 00000694 A1[161E]            <1> 	mov     ax, [WAV_BUFFER2]
   243                              <1>        	;call	loadFromFile
   244                              <1> 	; 13/11/2023
   245 00000697 FF16[8506]          <1> 	call	word [loadfromwavfile]
   246                              <1> 
   247                              <1> ; register reset the DMA engine. This may cause a pop noise on the output
   248                              <1> ; lines when the device is reset. Prolly a better idea to mute output, then
   249                              <1> ; reset.
   250                              <1> 
   251                              <1> 	; 11/11/2023
   252                              <1>         ;mov	dx, [NABMBAR]
   253                              <1>         ;add	dx, PO_CR_REG		; set pointer to Ctrl reg
   254                              <1>         ;mov	al, RR			; set reset
   255                              <1> 	;out	dx, al			; self clearing bit
   256                              <1> 
   257                              <1> ; write last valid index to 31 to start with.
   258                              <1> ; The Last Valid Index register tells the DMA engine when to stop playing.
   259                              <1> ; 
   260                              <1> ; As we progress through the song we change the last valid index to always be
   261                              <1> ; something other than the index we're currently playing.  
   262                              <1> ;
   263                              <1> 	; 08/11/2023
   264                              <1> 	;; 07/11/2023
   265                              <1> 	;mov	al, 1
   266                              <1>         ;;mov	al, 31
   267                              <1> 	;call	setLastValidIndex
   268                              <1> 
   269                              <1> ; create Buffer Descriptor List
   270                              <1> ;
   271                              <1> ; A buffer descriptor list is a list of pointers and control bits that the
   272                              <1> ; DMA engine uses to know where to get the .wav data and how to play it.
   273                              <1> ;
   274                              <1> ; I set it up to use only 2 buffers of .wav data, and whenever 1 buffer is
   275                              <1> ; playing, I refresh the other one with good data.
   276                              <1> ;
   277                              <1> ;
   278                              <1> ; For the control bits, you can specify that the DMA engine fire an interrupt
   279                              <1> ; after a buffer has been processed, but I poll the current index register
   280                              <1> ; to know when it's safe to update the other buffer.
   281                              <1> ;
   282                              <1> ; I set the BUP bit, which tells the DMA engine to just play 0's (silence)
   283                              <1> ; if it ever runs out of data to play. Good for safety.
   284                              <1> ;
   285 0000069B 06                  <1>         push    es
   286 0000069C A1[121E]            <1>         mov     ax, [BDL_BUFFER]		; get segment # for BDL
   287 0000069F 8EC0                <1>         mov     es, ax
   288                              <1> 
   289 000006A1 B91000              <1>         mov     cx, 32 / 2                      ; make 32 entries in BDL
   290 000006A4 31FF                <1>         xor     di, di                          
   291                              <1> _0:
   292                              <1> 
   293                              <1> ; set buffer descriptor 0 to start of data file in memory
   294 000006A6 660FB706[141E]      <1>         movzx   eax, word [WAV_BUFFER1]
   295 000006AC 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   296 000006B0 66AB                <1>         stosd                                   ; store pointer to wavbuffer1
   297                              <1> 
   298                              <1> ;
   299                              <1> ; set length to 32k samples. 1 sample is 16bits or 2bytes.
   300                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples.
   301                              <1> ; 
   302                              <1> 
   303                              <1> ; 17/02/2017 (Erdogan Tan)
   304                              <1> ; Intel 82801AA (ICH) & Intel 82801AB (ICH0) I/O Controller Hub AC97
   305                              <1> ; Programmers Reference Manual
   306                              <1> 
   307                              <1> ; 2.2.1 Buffer Descriptor List  (on Page 13)
   308                              <1> 	;
   309                              <1> 	;  Generic Form of Buffer Descriptor
   310                              <1> 	;  ---------------------------------
   311                              <1> 	;  63   62    61-48    47-32   31-0
   312                              <1> 	;  ---  ---  --------  ------- -----
   313                              <1> 	;  IOC  BUP -reserved- Buffer  Buffer
   314                              <1> 	;		      Length   Pointer
   315                              <1> 	;		      [15:0]   [31:0]
   316                              <1> 	;
   317                              <1> 	;  IOC:	Interrupt On Completion. 
   318                              <1> 	;	1 = Enabled. 
   319                              <1> 	;	    When this is set, it means that the controller should
   320                              <1> 	;	    issue an interrupt upon completion of this buffer.
   321                              <1> 	;	    It should also set the IOC bit in the status register
   322                              <1> 	;	0 = Disabled	
   323                              <1> 	;
   324                              <1> 	;  BUP: Buffer Underrun Policy.
   325                              <1> 	;       0 = When this buffer is complete,
   326                              <1> 	;	    if the next buffer is not yet ready 
   327                              <1> 	;	    (i.e., the last valid buffer has been processed),
   328                              <1> 	;	    then continue to transmit the last valid sample.
   329                              <1> 	;	1 = When this buffer is complete,
   330                              <1> 	;     	    if this is the last valid buffer, transmit zeros after
   331                              <1> 	;	    this buffer has been processed completely.
   332                              <1> 	;	    This bit typically is set only if this is the last 
   333                              <1> 	;	    buffer in the current stream.
   334                              <1> 	;
   335                              <1> 	; [31:0]: Buffer pointer. This field points to the location of
   336                              <1> 	;	  the data buffer. Since samples can be as wide as one
   337                              <1> 	;	  word, the buffer must be aligned with word boundaries,
   338                              <1> 	;	  to prevent samples from straddling DWord boundaries.
   339                              <1> 	;
   340                              <1> 	; [15:0]: Buffer Length: This is the length of the data buffer,
   341                              <1> 	;	  in number of samples. The controller uses this data
   342                              <1> 	;	  to determine the length of the buffer, in bytes.
   343                              <1> 	;	  "0" indicates no sample to process.
   344                              <1> 
   345                              <1> ; ICH2AC97.INC
   346                              <1> 
   347                              <1> ;	IOC	equ     BIT31   ; Fire an interrupt whenever this
   348                              <1> 				; buffer is complete.
   349                              <1> 
   350                              <1> ;	BUP	equ     BIT30   ; Buffer Underrun Policy.
   351                              <1> 				; if this buffer is the last buffer
   352                              <1> 				; in a playback, fill the remaining
   353                              <1> 				; samples with 0 (silence) or not.
   354                              <1> 				; It's a good idea to set this to 1
   355                              <1> 				; for the last buffer in playback,
   356                              <1> 				; otherwise you're likely to get a lot
   357                              <1> 				; of noise at the end of the sound.
   358                              <1> ;
   359                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   360                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   361                              <1> ; Luckily for us, that's the same format as .wav files.
   362                              <1> ;
   363                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   364                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   365                              <1> ;
   366                              <1> ; A value of 0 in these bits means play no samples.
   367                              <1> ;
   368                              <1> 
   369                              <1> ; ICHWAV.ASM
   370                              <1> 				    ; 19/05/2024
   371                              <1> 	;mov	eax, BUFFERSIZE / 2 ; size of buffer (32K) in (16bit) words
   372                              <1> 	; 13/11/2023
   373 000006B2 66A1[8906]          <1> 	mov	eax, [buffersize]
   374                              <1> 
   375                              <1> 	; 09/11/2023
   376 000006B6 660D000000C0        <1> 	or	eax, IOC + BUP
   377                              <1> 	; 06/11/2023
   378                              <1> 	;or	eax, BUP
   379 000006BC 66AB                <1> 	stosd
   380                              <1> 
   381                              <1> ; 2nd buffer:
   382                              <1> 
   383 000006BE 660FB706[161E]      <1>         movzx   eax, word [WAV_BUFFER2]
   384 000006C4 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   385 000006C8 66AB                <1>         stosd                                   ; store pointer to wavbuffer2
   386                              <1> 
   387                              <1> ; set length to 64k (32k of two 16 bit samples)
   388                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples
   389                              <1> ; 
   390                              <1> 	;mov	eax, BUFFERSIZE / 2
   391                              <1> 	; 13/11/2023
   392 000006CA 66A1[8906]          <1> 	mov	eax, [buffersize]
   393                              <1> 
   394                              <1> 	; 09/11/2023
   395 000006CE 660D000000C0        <1> 	or	eax, IOC + BUP
   396                              <1> 	; 06/11/2023
   397                              <1> 	;or	eax, BUP
   398 000006D4 66AB                <1> 	stosd
   399                              <1> 
   400 000006D6 E2CE                <1>         loop    _0
   401 000006D8 07                  <1>         pop     es
   402                              <1> 
   403                              <1> ;
   404                              <1> ; tell the DMA engine where to find our list of Buffer Descriptors.
   405                              <1> ; this 32bit value is a flat mode memory offset (ie no segment:offset)
   406                              <1> ;
   407                              <1> ; write NABMBAR+10h with offset of buffer descriptor list
   408                              <1> ;
   409 000006D9 660FB706[121E]      <1>         movzx   eax, word [BDL_BUFFER]
   410 000006DF 66C1E004            <1> 	shl     eax, 4                          ; convert seg:off to 0:off
   411 000006E3 8B16[101E]          <1>         mov     dx, [NABMBAR]
   412 000006E7 83C210              <1>         add     dx, PO_BDBAR_REG                ; set pointer to BDL
   413 000006EA 66EF                <1>         out     dx, eax                         ; write to AC97 controller
   414                              <1> 
   415                              <1> 	; 19/05/2024
   416 000006EC E8EA12              <1> 	call	delay1_4ms
   417                              <1> 
   418                              <1> ;
   419                              <1> ; All set. Let's play some music.
   420                              <1> ;
   421                              <1> 
   422                              <1> 	; 10/11/2023
   423                              <1> 	; 08/11/2023
   424                              <1> 	; 07/11/2023
   425                              <1> 	; 08/12/2016
   426                              <1> 	; 07/10/2016
   427                              <1> 	;mov	al, 1
   428 000006EF B01F                <1> 	mov	al, 31
   429 000006F1 A2[281E]            <1> 	mov	[LVI], al ; 10/11/2023
   430 000006F4 E88F01              <1> 	call	setLastValidIndex
   431                              <1> 
   432                              <1> 	; 06/11/2023 (not neccessary)
   433                              <1> 	;; 05/11/2023
   434                              <1> 	;; reset current index
   435                              <1> 	;mov	al, 0
   436                              <1> 	;call	setCurrentIndex
   437                              <1> 
   438                              <1> 	; 06/11/2023
   439                              <1> 	;mov	byte [tLoop], 1 ; 30/11/2016
   440                              <1> 
   441                              <1> 	; 19/05/2024
   442 000006F7 E8DF12              <1> 	call	delay1_4ms
   443                              <1> 
   444                              <1> 	; 17/02/2017
   445 000006FA 8B16[101E]          <1>         mov     dx, [NABMBAR]
   446 000006FE 83C21B              <1>         add     dx, PO_CR_REG                   ; PCM out Control Register
   447                              <1>         ; 09/11/2023
   448 00000701 B011                <1> 	mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
   449                              <1> 	;			; (LVBI interrupt will not be enabled)
   450                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   451                              <1> 	;mov	al, RPBM
   452 00000703 EE                  <1> 	out     dx, al                          ; Start bus master operation.
   453                              <1> 
   454                              <1> 	; 09/11/2023
   455 00000704 C606[271E]3F        <1> 	mov	byte [b_indicator], '?'	
   456                              <1> 
   457                              <1> 	; 19/05/2024
   458                              <1> 	; 06/11/2023
   459 00000709 E8CD12              <1> 	call	delay1_4ms
   460 0000070C E8CA12              <1> 	call	delay1_4ms
   461 0000070F E8C712              <1> 	call	delay1_4ms
   462 00000712 E8C412              <1> 	call	delay1_4ms
   463                              <1> 
   464                              <1> 	; 10/11/2023
   465                              <1> 	;mov	byte [tloop], 1
   466                              <1> 
   467                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   468                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   469                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   470                              <1> 
   471                              <1> ; 09/11/2023   
   472                              <1> ; 06/11/2023
   473                              <1> %if 1
   474                              <1> 	; 08/12/2016
   475                              <1> 	; 28/11/2016
   476                              <1> p_loop:
   477 00000715 E87701              <1> 	call    check4keyboardstop ; keyboard halt?
   478 00000718 732C                <1>         jnc	short r_loop 	   ; no ; 09/11/2023
   479                              <1> 
   480                              <1> 	; 09/11/2023
   481                              <1> 	;or	byte [flags], ENDOFFILE
   482                              <1> 	;mov	byte [b_indicator], '0'
   483                              <1> x_loop:
   484 0000071A B030                <1> 	mov	al, '0' ; 19/05/2024
   485                              <1> q_loop:
   486                              <1> 	;mov	al, '0'
   487 0000071C E88C00              <1> 	call	tL0
   488                              <1> 
   489                              <1> 	; 04/11/2023
   490                              <1> 	; finished with song, stop everything
   491 0000071F E8A914              <1> 	call	ac97_stop
   492                              <1> 
   493                              <1> 	; 11/11/2023
   494                              <1> irq_restore:	
   495                              <1> 	; restore previous interrupt vector and interrupt_status
   496 00000722 FA                  <1> 	cli
   497 00000723 E4A1                <1> 	in	al, 0A1h ; irq 8-15
   498 00000725 A0[091E]            <1> 	mov	al, [IRQ_status+1]
   499 00000728 E6A1                <1> 	out	0A1h, al 
   500 0000072A E421                <1> 	in	al, 021h ; irq 0-7
   501 0000072C A0[081E]            <1> 	mov	al, [IRQ_status]
   502 0000072F E621                <1> 	out	21h, al 
   503                              <1> 	; ...
   504 00000731 06                  <1> 	push	es
   505 00000732 31C0                <1> 	xor	ax, ax
   506 00000734 8EC0                <1> 	mov	es, ax
   507 00000736 A1[0A1E]            <1> 	mov	ax, [IRQ_vector]
   508 00000739 268907              <1> 	mov	[es:bx], ax
   509 0000073C A1[0C1E]            <1> 	mov	ax, [IRQ_vector+2]
   510 0000073F 26894702            <1> 	mov	[es:bx+2], ax
   511 00000743 07                  <1> 	pop	es
   512 00000744 FB                  <1> 	sti
   513 00000745 C3                  <1> 	retn
   514                              <1> 
   515                              <1> r_loop:
   516                              <1> 	; 19/05/2024
   517                              <1> 	; 10/11/2023
   518 00000746 90                  <1> 	nop
   519 00000747 90                  <1> 	nop
   520 00000748 90                  <1> 	nop
   521                              <1> 
   522                              <1> 	; 11/11/2023	
   523 00000749 B030                <1> 	mov	al, '0'
   524 0000074B 803E[071E]00        <1> 	cmp	byte [tloop], 0
   525 00000750 74C3                <1> 	je	short p_loop
   526 00000752 7CC8                <1> 	jl	short q_loop
   527                              <1> 
   528 00000754 FE0E[071E]          <1> 	dec	byte [tloop] ; 0
   529                              <1> 
   530 00000758 803E[271E]31        <1> 	cmp	byte [b_indicator], '1'
   531 0000075D 7511                <1> 	jne	short s_loop
   532                              <1> 
   533                              <1> 	; load buffer 1
   534 0000075F A1[141E]            <1> 	mov	ax, [WAV_BUFFER1]
   535                              <1> u_loop:
   536                              <1> 	;call	loadFromFile
   537                              <1> 	; 13/11/2023
   538 00000762 FF16[8506]          <1> 	call	[loadfromwavfile]
   539                              <1> 	;jnc	short v_loop
   540                              <1> 	;mov	al, '0'
   541                              <1> 	;jmp	short q_loop
   542                              <1> 	; 19/05/2024
   543 00000766 72B2                <1> 	jc	short x_loop
   544                              <1> v_loop:
   545                              <1> 	; 09/11/2023 - Erdogan Tan
   546                              <1> 	; (print buffer number on top left of the screen)
   547 00000768 A0[271E]            <1> 	mov	al, [b_indicator]
   548 0000076B E83D00              <1> 	call	tL0
   549 0000076E EBA5                <1> 	jmp	short p_loop
   550                              <1> s_loop:
   551                              <1> 	; load buffer 2
   552 00000770 A1[161E]            <1> 	mov	ax, [WAV_BUFFER2]
   553 00000773 EBED                <1> 	jmp	short u_loop
   554                              <1> 
   555                              <1> %endif
   556                              <1> 
   557                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   558                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   559                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   560                              <1> 
   561                              <1> ; 11/11/2023
   562                              <1> ; 10/11/2023
   563                              <1> ; 09/11/2023
   564                              <1> ; 08/11/2023
   565                              <1> ; 07/11/2023
   566                              <1> %if 1
   567                              <1> 
   568                              <1> tuneLoop:
   569                              <1> 	; 11/11/2023
   570                              <1> 	; 10/11/2023
   571                              <1> 	; 09/11/2023
   572                              <1> 	; 08/11/2023
   573                              <1> 	; 06/11/2023
   574                              <1> 	;mov	al, '1'
   575                              <1> 	;call	tL0
   576                              <1> tL1:
   577                              <1> 	; 10/11/2023
   578                              <1> 	;mov	byte [tloop], 1
   579                              <1> 
   580                              <1> 	; 11/11/2023
   581                              <1> 	;call    updateLVI	; set LVI != CIV
   582                              <1> 	;jz	short tL4	
   583                              <1> 
   584                              <1> 	; 11/11/2023
   585 00000775 C606[071E]01        <1> 	mov	byte [tloop], 1
   586                              <1> 
   587 0000077A E80001              <1> 	call    getCurrentIndex
   588                              <1> 
   589                              <1> 	; 10/11/2023
   590 0000077D 3A06[281E]          <1> 	cmp	al, [LVI]
   591 00000781 7511                <1> 	jne	short tL2
   592                              <1> 
   593 00000783 F606[041E]01        <1> 	test	byte [flags], ENDOFFILE
   594                              <1> 	;jnz	short tL2
   595 00000788 751A                <1> 	jnz	short tL4
   596                              <1> 
   597 0000078A 48                  <1> 	dec	ax
   598 0000078B 241F                <1> 	and	al, 1Fh 
   599 0000078D E8F600              <1> 	call	setLastValidIndex	
   600 00000790 8606[281E]          <1> 	xchg	al, [LVI]
   601                              <1> 
   602                              <1> tL2:
   603 00000794 A801                <1> 	test	al, BIT0
   604 00000796 7406                <1> 	jz	short tL3
   605                              <1> 
   606 00000798 C606[271E]31        <1> 	mov	byte [b_indicator], '1'
   607 0000079D C3                  <1> 	retn
   608                              <1> tL3:	
   609 0000079E C606[271E]32        <1> 	mov	byte [b_indicator], '2'
   610 000007A3 C3                  <1> 	retn
   611                              <1> tL4:
   612                              <1> 	; 11/11/2023
   613 000007A4 C606[071E]FF        <1> 	mov	byte [tloop], -1
   614 000007A9 F9                  <1> 	stc
   615 000007AA C3                  <1> 	retn
   616                              <1> 
   617                              <1> 
   618                              <1> 	; 06/11/2023
   619                              <1> tL0:
   620                              <1> 	; 08/11/2023
   621                              <1> 	; 05/11/2023
   622                              <1> 	; 17/02/2017 - Buffer switch test (temporary)
   623                              <1> 	; 06/11/2023
   624                              <1> 	; al = buffer indicator ('1', '2' or '0' -stop- )
   625 000007AB 1E                  <1> 	push	ds
   626                              <1> 	;push	bx 
   627 000007AC BB00B8              <1> 	mov	bx, 0B800h ; video display page segment
   628 000007AF 8EDB                <1> 	mov	ds, bx
   629 000007B1 29DB                <1> 	sub	bx, bx ; 0
   630 000007B3 B44E                <1> 	mov	ah, 4Eh
   631 000007B5 8907                <1> 	mov	[bx], ax ; show current play buffer (1, 2)
   632                              <1> 	;pop	bx
   633 000007B7 1F                  <1> 	pop	ds
   634 000007B8 C3                  <1> 	retn
   635                              <1> 
   636                              <1> %endif
   637                              <1> 
   638                              <1> ; 08/11/2023
   639                              <1> ; 07/11/2023
   640                              <1> %if 0
   641                              <1> 
   642                              <1> tuneLoop:
   643                              <1> 	; 07/11/2023
   644                              <1> 	;mov	dx, NABMBAR
   645                              <1> 	;add	dx, PO_CIV_REG ; 14h
   646                              <1> tL1:
   647                              <1> 	call    updateLVI	; set LVI != CIV
   648                              <1> 	call    check4keyboardstop
   649                              <1> 	jc	short _exit_
   650                              <1> 	call    getCurrentIndex
   651                              <1> 	test	al, BIT0
   652                              <1> 	jz	short tL1	; loop if buffer 2 is not playing
   653                              <1> 
   654                              <1> 	; load buffer 1
   655                              <1> 	mov     ax, [WAV_BUFFER1]
   656                              <1> 	call	loadFromFile
   657                              <1> 	jc	short _exit_	; end of file
   658                              <1> tL2:
   659                              <1> 	call    updateLVI
   660                              <1> 	call    check4keyboardstop
   661                              <1> 	jc	short _exit_
   662                              <1> 	call    getCurrentIndex
   663                              <1> 	test	al, BIT0
   664                              <1> 	jnz	short tL2	; loop if buffer 1 is not playing
   665                              <1> 
   666                              <1> 	; load buffer 2
   667                              <1> 	mov     ax, [WAV_BUFFER2]
   668                              <1> 	call	loadFromFile
   669                              <1> 	jnc	short tuneLoop
   670                              <1> _exit_:
   671                              <1> 	mov	dx, [NABMBAR]		
   672                              <1> 	add	dx, PO_CR_REG	; PCM out Control Register
   673                              <1> 	mov	al, 0
   674                              <1> 	out	dx, al		; stop player
   675                              <1> 	retn
   676                              <1> 
   677                              <1> %endif
   678                              <1> 
   679                              <1> ; load data from file in 32k chunks. Would be nice to load 1 64k chunk,
   680                              <1> ; but in DOS you can only load FFFF bytes at a time.
   681                              <1> ;
   682                              <1> ; entry: ax = segment to load data to
   683                              <1> ; exit: CY set if end of file reached.
   684                              <1> ; note: last file buffer is padded with 0's to avoid pops at the end of song.
   685                              <1> ; assumes file is already open. uses [filehandle]
   686                              <1> 
   687                              <1> ; 07/11/2023
   688                              <1> %if 0
   689                              <1> 
   690                              <1> loadFromFile:
   691                              <1> 	; 07/11/2023
   692                              <1> 	; 06/11/2023
   693                              <1> 	; 17/02/2017
   694                              <1> 	;push	ax
   695                              <1> 	;push	cx
   696                              <1> 	;push	dx
   697                              <1> 	;push	bx
   698                              <1> 
   699                              <1> 	;push	es
   700                              <1> 	;push	ds
   701                              <1> 	
   702                              <1>         test    byte [flags], ENDOFFILE	; have we already read the
   703                              <1> 	;stc				; last of the file?
   704                              <1> 	; 05/11/2023
   705                              <1> 	;jnz	endLFF
   706                              <1> 	jz	short lff_12	; 06/11/2023
   707                              <1> 	; 06/11/2023
   708                              <1> 	;;mov	byte [tLoop], 0
   709                              <1> 	;jmp	endLFF
   710                              <1> 	stc
   711                              <1> 	retn
   712                              <1> 
   713                              <1> lff_12:	; 06/11/2023    
   714                              <1> 	mov	[fbs_seg], ax ; save buffer segment
   715                              <1> 	xor	dx, dx
   716                              <1> lff_0:
   717                              <1> 	mov	[fbs_off], dx ; buffer offset
   718                              <1> 
   719                              <1> 	mov     bx, (BUFFERSIZE / 2)	; 32k chunk
   720                              <1> 	mov	cl, [fbs_shift]   
   721                              <1> 	and	cl, cl
   722                              <1> 	jz	short lff_1 ; stereo, 16 bit	
   723                              <1> 
   724                              <1> 	; fbs_shift =
   725                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   726                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   727                              <1> 	shr	bx, cl ; 32K / multiplier
   728                              <1> 
   729                              <1> 	mov	ax, cs
   730                              <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   731                              <1> lff_1:
   732                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   733                              <1> 	; load file into memory
   734                              <1>         mov	cx, bx                         
   735                              <1> 	mov	bx, [filehandle]
   736                              <1> 	mov     ds, ax
   737                              <1>        	mov	ah, 3fh
   738                              <1> 	int	21h
   739                              <1> 
   740                              <1> 	mov	bx, cs
   741                              <1> 	mov	ds, bx
   742                              <1> 
   743                              <1> 	jc	short lff_9 ; error !
   744                              <1> 
   745                              <1> 	and	ax, ax
   746                              <1> 	jz	short lff_10
   747                              <1> 	
   748                              <1> 	mov	bl, [fbs_shift] ; shift count  
   749                              <1> 	or	bl, bl
   750                              <1> 	jz	short lff_7 ; 16 bit stereo samples
   751                              <1> 
   752                              <1> 	push	es
   753                              <1> 	; 06/11/2023
   754                              <1> 	;push	di
   755                              <1> 	;push	si
   756                              <1> 	mov	di, [fbs_off]
   757                              <1> 	mov	si, [fbs_seg] ; buffer segment
   758                              <1> 	mov	es, si
   759                              <1> 	mov	si, temp_buffer ; temporary buffer address
   760                              <1> 	mov	cl, [bps] ; bits per sample (8 or 16)
   761                              <1> 	cmp	cl, 8
   762                              <1> 	jne	short lff_4 ; 16 bit samples
   763                              <1> 	; 8 bit samples
   764                              <1> 	mov	cx, ax ; byte count
   765                              <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   766                              <1> 	jz	short lff_3 ; 8 bit, stereo
   767                              <1> lff_2:
   768                              <1> 	; mono & 8 bit
   769                              <1> 	lodsb
   770                              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   771                              <1> 	stosw	; left channel
   772                              <1> 	stosw	; right channel
   773                              <1> 	loop	lff_2
   774                              <1> 	jmp	short lff_6	
   775                              <1> lff_3:
   776                              <1> 	; stereo & 8 bit
   777                              <1> 	lodsb
   778                              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   779                              <1> 	stosw
   780                              <1> 	loop	lff_3			
   781                              <1> 	jmp	short lff_6
   782                              <1> lff_4:
   783                              <1> 	; 16 bit mono samples
   784                              <1> 	mov	cx, ax ; word count
   785                              <1> lff_5:	
   786                              <1> 	lodsw
   787                              <1> 	stosw	; left channel
   788                              <1> 	stosw	; right channel
   789                              <1> 	loop	lff_5
   790                              <1> lff_6:
   791                              <1> 	mov	ax, di ; save next buffer offset/position
   792                              <1> 	; 06/11/2023
   793                              <1> 	;pop	si
   794                              <1> 	;pop	di
   795                              <1> 	pop	es
   796                              <1> ;lff_7:        
   797                              <1> 	; 06/11/2023
   798                              <1> 	and	ax, ax
   799                              <1> 	jz	short endLFF ; end of 2nd half
   800                              <1> 	mov	cx, (BUFFERSIZE / 2)
   801                              <1> lff_7:
   802                              <1> 	cmp	ax, cx
   803                              <1> 	je	short endLFF	 ; 06/11/2023
   804                              <1> 	;jb	short lff_11
   805                              <1> 	;xor	cx, cx
   806                              <1> 	;sub	cx, ax
   807                              <1> 	;neg	cx
   808                              <1> 	jmp	short lff_11
   809                              <1> lff_8:
   810                              <1> 	; 07/11/2023
   811                              <1> 	cmp	word [fbs_off], (BUFFERSIZE / 2) ; 32768
   812                              <1> 	jnb	short endLFF
   813                              <1> 	
   814                              <1> 	mov	dx, ax ; buffer offset
   815                              <1> 	mov	ax, [fbs_seg] ; buffer segment
   816                              <1> 	jmp	lff_0
   817                              <1> lff_9:  
   818                              <1> 	; 07/11/2023
   819                              <1> 	;; 06/11/2023 (temporary)
   820                              <1> 	;mov	al, '!'  ; error
   821                              <1> 	;call	tL0
   822                              <1> 
   823                              <1> 	xor	ax, ax
   824                              <1> lff_10:
   825                              <1> 	; 07/11/2023
   826                              <1> 	;mov	cx, (BUFFERSIZE / 2)  
   827                              <1> lff_11:
   828                              <1> 	call    padfill				; blank pad the remainder
   829                              <1>         ;clc					; don't exit with CY yet.
   830                              <1>         or	byte [flags], ENDOFFILE		; end of file flag
   831                              <1> endLFF:
   832                              <1>         ;pop	ds
   833                              <1> 	;pop	es
   834                              <1> 	; 06/11/2023
   835                              <1> 	;pop	bx
   836                              <1> 	;pop	dx
   837                              <1>         ;pop	cx
   838                              <1>         ;pop	ax
   839                              <1>         retn
   840                              <1> 
   841                              <1> %endif
   842                              <1> 
   843                              <1> ; 08/11/2023
   844                              <1> ; 07/11/2023
   845                              <1> %if 1
   846                              <1> 
   847                              <1> loadFromFile:
   848                              <1> 	; 07/11/2023
   849                              <1> 
   850 000007B9 F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
   851                              <1> 					; last of the file?
   852 000007BE 7402                <1> 	jz	short lff_0		; no
   853 000007C0 F9                  <1> 	stc
   854 000007C1 C3                  <1> 	retn
   855                              <1> 
   856                              <1> lff_0:
   857                              <1> 	; 08/11/2023
   858 000007C2 89C5                <1> 	mov	bp, ax ; save buffer segment	
   859                              <1> 
   860 000007C4 8A0E[261E]          <1> 	mov	cl, [fbs_shift]   
   861 000007C8 20C9                <1> 	and	cl, cl
   862 000007CA 7470                <1> 	jz	short lff_1 ; stereo, 16 bit	
   863                              <1> 
   864 000007CC BFFFFF              <1> 	mov	di, BUFFERSIZE - 1 ; 65535
   865                              <1> 
   866                              <1> 	; fbs_shift =
   867                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   868                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   869 000007CF D3EF                <1> 	shr	di, cl
   870 000007D1 47                  <1> 	inc	di ; 16384 for 8 bit and mono	
   871                              <1> 		   ; 32768 for 8 bit or mono	
   872                              <1> 
   873 000007D2 8CC8                <1> 	mov	ax, cs
   874 000007D4 BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   875                              <1> 
   876                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   877                              <1> 	; load file into memory
   878 000007D7 89F9                <1>         mov	cx, di                       
   879 000007D9 8B1E[021E]          <1> 	mov	bx, [filehandle]
   880 000007DD 8ED8                <1> 	mov     ds, ax
   881 000007DF B43F                <1>        	mov	ah, 3Fh
   882 000007E1 CD21                <1> 	int	21h
   883                              <1> 
   884 000007E3 8CCB                <1> 	mov	bx, cs
   885 000007E5 8EDB                <1> 	mov	ds, bx
   886                              <1> 
   887 000007E7 724A                <1> 	jc	short lff_4 ; error !
   888                              <1> 
   889                              <1> 	; 08/11/2023
   890 000007E9 31D2                <1> 	xor	dx, dx ; 0
   891                              <1> 
   892 000007EB 21C0                <1> 	and	ax, ax
   893 000007ED 7476                <1> 	jz	short lff_3
   894                              <1> 
   895 000007EF 8A1E[261E]          <1> 	mov	bl, [fbs_shift]
   896                              <1> 
   897 000007F3 06                  <1> 	push	es
   898 000007F4 89D7                <1> 	mov	di, dx ; 0 ; [fbs_off]
   899                              <1> 	;mov	bp, [fbs_seg] ; buffer segment
   900 000007F6 8EC5                <1> 	mov	es, bp
   901 000007F8 BE[2A1E]            <1> 	mov	si, temp_buffer ; temporary buffer address
   902 000007FB 89C1                <1> 	mov	cx, ax ; byte count
   903 000007FD 803E[241E]08        <1> 	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   904 00000802 751B                <1> 	jne	short lff_7 ; 16 bit samples
   905                              <1> 	; 8 bit samples
   906 00000804 FECB                <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   907 00000806 740C                <1> 	jz	short lff_6 ; 8 bit, stereo
   908                              <1> lff_5:
   909                              <1> 	; mono & 8 bit
   910 00000808 AC                  <1> 	lodsb
   911 00000809 2C80                <1> 	sub	al, 80h ; 08/11/2023
   912 0000080B C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   913 0000080E AB                  <1> 	stosw	; left channel
   914 0000080F AB                  <1> 	stosw	; right channel
   915 00000810 E2F6                <1> 	loop	lff_5
   916 00000812 EB12                <1> 	jmp	short lff_9	
   917                              <1> lff_6:
   918                              <1> 	; stereo & 8 bit
   919 00000814 AC                  <1> 	lodsb
   920 00000815 2C80                <1> 	sub	al, 80h ; 08/11/2023
   921 00000817 C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   922 0000081A AB                  <1> 	stosw
   923 0000081B E2F7                <1> 	loop	lff_6			
   924 0000081D EB07                <1> 	jmp	short lff_9
   925                              <1> lff_7:
   926 0000081F D1E9                <1> 	shr	cx, 1 ; word count
   927                              <1> lff_8:
   928 00000821 AD                  <1> 	lodsw
   929 00000822 AB                  <1> 	stosw	; left channel
   930 00000823 AB                  <1> 	stosw	; right channel
   931 00000824 E2FB                <1> 	loop	lff_8
   932                              <1> lff_9:
   933 00000826 07                  <1> 	pop	es
   934 00000827 09FF                <1> 	or	di, di
   935 00000829 7442                <1> 	jz	short endLFF ; 64KB ok 
   936                              <1> 	
   937 0000082B 89F8                <1> 	mov	ax, di ; [fbs_off]
   938 0000082D 48                  <1> 	dec	ax
   939 0000082E B9FFFF              <1> 	mov	cx, BUFFERSIZE - 1 ; 65535
   940 00000831 EB32                <1> 	jmp	short lff_3
   941                              <1> 
   942                              <1> lff_4:
   943                              <1> 	; 08/11/2023
   944 00000833 B021                <1> 	mov	al, '!'  ; error
   945 00000835 E873FF              <1> 	call	tL0
   946                              <1> 
   947 00000838 31C0                <1> 	xor	ax, ax
   948 0000083A EB29                <1> 	jmp	short lff_3
   949                              <1> 	
   950                              <1> lff_1:  
   951                              <1> 	;mov	bp, ax ; save buffer segment
   952 0000083C 31D2                <1> 	xor	dx, dx
   953                              <1> 	; load file into memory
   954 0000083E B90080              <1>         mov	cx, (BUFFERSIZE / 2)	; 32k chunk
   955 00000841 8B1E[021E]          <1> 	mov	bx, [filehandle]
   956 00000845 8ED8                <1> 	mov     ds, ax
   957 00000847 B43F                <1>        	mov	ah, 3Fh
   958 00000849 CD21                <1> 	int	21h
   959                              <1> 
   960 0000084B 8CCF                <1> 	mov	di, cs
   961 0000084D 8EDF                <1> 	mov	ds, di
   962                              <1> 
   963                              <1> 	; 07/11/2023
   964 0000084F 72E2                <1> 	jc	short lff_4 ; error !
   965                              <1> 	
   966 00000851 39C8                <1> 	cmp	ax, cx
   967 00000853 7510                <1> 	jne	short lff_3
   968                              <1> lff_2:
   969                              <1> 	; 08/11/2023
   970 00000855 01C2                <1> 	add	dx, ax
   971                              <1> 	;mov	cx, (BUFFERSIZE / 2)	; 32k chunk
   972                              <1> 	;mov	bx, [filehandle]
   973 00000857 8EDD                <1> 	mov     ds, bp
   974 00000859 B43F                <1>        	mov	ah, 3Fh
   975 0000085B CD21                <1> 	int	21h
   976                              <1> 
   977                              <1> 	;mov	di, cs
   978 0000085D 8EDF                <1> 	mov	ds, di
   979                              <1> 
   980 0000085F 72D2                <1> 	jc	short lff_4 ; error !
   981                              <1> 
   982 00000861 39C8                <1> 	cmp	ax, cx
   983 00000863 7408                <1> 	je	short endLFF
   984                              <1> lff_3:
   985 00000865 E80600              <1> 	call    padfill			; blank pad the remainder
   986                              <1>         ;clc				; don't exit with CY yet.
   987 00000868 800E[041E]01        <1>         or	byte [flags], ENDOFFILE	; end of file flag
   988                              <1> endLFF:
   989 0000086D C3                  <1>         retn
   990                              <1> 
   991                              <1> %endif
   992                              <1> 
   993                              <1> ; entry ds:ax points to last byte in file
   994                              <1> ; cx=target size
   995                              <1> ; note: must do byte size fill
   996                              <1> ; destroys bx, cx
   997                              <1> ;
   998                              <1> padfill:
   999                              <1> 	; 07/11/2023
  1000                              <1> 	; 06/11/2023
  1001                              <1> 	; 17/02/2017
  1002 0000086E 06                  <1> 	push	es
  1003                              <1>         ;push	di
  1004                              <1> 	;mov	di, [fbs_seg]
  1005                              <1> 	;mov	es, di
  1006 0000086F 8EC5                <1>         mov	es, bp
  1007 00000871 29C1                <1> 	sub	cx, ax
  1008                              <1> 	; 08/11/2023
  1009                              <1> 	;mov	di, ax ; (wrong)
  1010 00000873 89D7                <1> 	mov	di, dx ; buffer offset
  1011 00000875 01C7                <1> 	add	di, ax       	
  1012                              <1> 	; 07/11/2023
  1013                              <1> 	;add	di, [fbs_off]
  1014 00000877 30C0                <1>         xor	al, al
  1015 00000879 F3AA                <1> 	rep	stosb
  1016                              <1> 	;mov	[fbs_off], di
  1017                              <1> 	;pop	di
  1018 0000087B 07                  <1>         pop	es
  1019 0000087C C3                  <1> 	retn
  1020                              <1> 
  1021                              <1> ; returns AL = current index value
  1022                              <1> getCurrentIndex:
  1023                              <1> 	; 08/11/2023
  1024                              <1> 	;push	dx
  1025 0000087D 8B16[101E]          <1> 	mov	dx, [NABMBAR]      		
  1026 00000881 83C214              <1> 	add	dx, PO_CIV_REG
  1027 00000884 EC                  <1> 	in	al, dx
  1028                              <1> 	;pop	dx
  1029                              <1> uLVI2:	;	06/11/2023
  1030 00000885 C3                  <1> 	retn
  1031                              <1> 
  1032                              <1> ; examines the CIV and the LVI. When they're the same, we set LVI <> CIV
  1033                              <1> ; that way, we never run out of buffers to play
  1034                              <1> 
  1035                              <1> ; 08/11/2023
  1036                              <1> %if 0
  1037                              <1> 	; 07/11/2023
  1038                              <1> updateLVI:
  1039                              <1> 	push	ax
  1040                              <1> 	push	dx
  1041                              <1> 	; 06/11/2023
  1042                              <1> 	mov	dx, [NABMBAR]
  1043                              <1> 	add	dx, PO_CIV_REG
  1044                              <1> 	; (Current Index Value and Last Valid Index value)
  1045                              <1> 	in	ax, dx
  1046                              <1> 
  1047                              <1> 	cmp	al, ah ; is current index = last index ?
  1048                              <1> 	jne	short uLVI1
  1049                              <1> 
  1050                              <1> 	call	setNewIndex
  1051                              <1> uLVI1:
  1052                              <1> 	pop	dx
  1053                              <1> 	pop	ax
  1054                              <1> 	retn
  1055                              <1> 
  1056                              <1> setNewIndex:
  1057                              <1> 	; 07/11/2023
  1058                              <1> 	push	ax
  1059                              <1>         call    getCurrentIndex                 ; get CIV
  1060                              <1>         test    byte [flags], ENDOFFILE
  1061                              <1>         jnz     short sni_1
  1062                              <1>         ; not at the end of the file yet.
  1063                              <1>         dec     al                              ; make new index <> current
  1064                              <1>         and     al, INDEX_MASK                  ; make sure new value is 0-31
  1065                              <1> sni_1:
  1066                              <1>         call    setLastValidIndex               ; write new value
  1067                              <1>         clc
  1068                              <1>         pop	ax
  1069                              <1> 	retn
  1070                              <1> 
  1071                              <1> %endif	
  1072                              <1> 
  1073                              <1> ; 08/11/2023
  1074                              <1> ; 07/11/2023
  1075                              <1> %if 0
  1076                              <1> updateLVI:
  1077                              <1> 	; 06/11/2023
  1078                              <1> 	mov	dx, [NABMBAR]      		
  1079                              <1> 	add	dx, PO_CIV_REG
  1080                              <1> 	; (Current Index Value and Last Valid Index value)
  1081                              <1> 	in	ax, dx
  1082                              <1> 
  1083                              <1> 	cmp	al, ah ; is current index = last index ?
  1084                              <1> 	jne	short uLVI2
  1085                              <1> 
  1086                              <1> 	; 10/11/2023
  1087                              <1> 	; 08/11/2023	
  1088                              <1> 	call	getCurrentIndex
  1089                              <1>  
  1090                              <1> 	test	byte [flags], ENDOFFILE
  1091                              <1> 	;jnz	short uLVI1
  1092                              <1> 	jz	short uLVI0  ; 08/11/2023
  1093                              <1> 
  1094                              <1> 	; 08/11/2023
  1095                              <1> 	push	ax
  1096                              <1> 	mov	dx, [NABMBAR]
  1097                              <1> 	add	dx, PO_SR_REG  ; PCM out status register
  1098                              <1> 	in	ax, dx
  1099                              <1> 
  1100                              <1> 	;test	al, 2
  1101                              <1> 	test	al, 3 ; bit 1 = Current Equals Last Valid (CELV)
  1102                              <1> 		      ; (has been processed)
  1103                              <1> 		      ; bit 0 = 1 -> DMA Controller Halted (DCH)
  1104                              <1> 	pop	ax
  1105                              <1> 	jz	short uLVI1
  1106                              <1> uLVI3:
  1107                              <1> 	xor	ax, ax
  1108                              <1> 	; zf = 1
  1109                              <1> 	retn
  1110                              <1> uLVI0:
  1111                              <1>         ; not at the end of the file yet.
  1112                              <1> 	dec	al
  1113                              <1> 	and	al, 1Fh
  1114                              <1> uLVI1:
  1115                              <1> 	;call	setLastValidIndex
  1116                              <1> ;uLVI2:
  1117                              <1> 	;retn
  1118                              <1> 
  1119                              <1> %endif
  1120                              <1> 	
  1121                              <1> ;input AL = index # to stop on
  1122                              <1> setLastValidIndex:
  1123                              <1> 	; 08/11/2023
  1124                              <1> 	;push	dx
  1125 00000886 8B16[101E]          <1> 	mov	dx, [NABMBAR]
  1126 0000088A 83C215              <1> 	add	dx, PO_LVI_REG
  1127 0000088D EE                  <1>         out     dx, al
  1128                              <1> 	;pop	dx
  1129 0000088E C3                  <1> 	retn
  1130                              <1> 
  1131                              <1> ; 06/11/2023
  1132                              <1> ;	; 05/11/2023
  1133                              <1> ;setCurrentIndex:
  1134                              <1> ;	;push	dx
  1135                              <1> ;	mov	dx, [NABMBAR]
  1136                              <1> ;	add	dx, PO_CIV_REG
  1137                              <1> ;	out	dx, al
  1138                              <1> ;	;pop	dx
  1139                              <1> ;	retn
  1140                              <1> 
  1141                              <1> ; checks if either shift key has been pressed. Exits with CY if so.
  1142                              <1> ; 
  1143                              <1> check4keyboardstop:
  1144                              <1> 
  1145                              <1> ; 06/11/2023
  1146                              <1> %if 1
  1147                              <1> 	; 19/05/2024
  1148                              <1> 	; 08/11/2023
  1149                              <1> 	; 04/11/2023
  1150 0000088F B401                <1> 	mov	ah, 1
  1151 00000891 CD16                <1> 	int	16h
  1152                              <1> 	;clc
  1153 00000893 7439                <1> 	jz	short _cksr
  1154                              <1> 
  1155 00000895 30E4                <1> 	xor	ah, ah
  1156 00000897 CD16                <1> 	int	16h
  1157                              <1> 
  1158                              <1> 	;;;
  1159                              <1> 	; 19/05/2024 (change PCM out volume)
  1160 00000899 3C2B                <1> 	cmp	al, '+'
  1161 0000089B 750B                <1> 	jne	short p_1
  1162                              <1> 	
  1163 0000089D A0[D208]            <1> 	mov	al, [volume]
  1164 000008A0 3C00                <1> 	cmp	al, 0
  1165 000008A2 762B                <1> 	jna	short p_3
  1166 000008A4 FEC8                <1> 	dec	al
  1167 000008A6 EB0D                <1> 	jmp	short p_2
  1168                              <1> p_1:
  1169 000008A8 3C2D                <1> 	cmp	al, '-'
  1170 000008AA 7524                <1> 	jne	short p_4
  1171                              <1> 
  1172 000008AC A0[D208]            <1> 	mov	al, [volume]
  1173 000008AF 3C1F                <1> 	cmp	al, 31
  1174 000008B1 731C                <1> 	jnb	short p_3
  1175 000008B3 FEC0                <1> 	inc	al
  1176                              <1> p_2:
  1177 000008B5 A2[D208]            <1> 	mov	[volume], al
  1178 000008B8 88C4                <1> 	mov	ah, al
  1179 000008BA 8B16[0E1E]          <1> 	mov     dx, [NAMBAR]
  1180                              <1>   	;add    dx, CODEC_MASTER_VOL_REG
  1181 000008BE 83C218              <1> 	add	dx, CODEC_PCM_OUT_REG
  1182 000008C1 EF                  <1> 	out     dx, ax
  1183                              <1> 
  1184 000008C2 E81411              <1> 	call    delay1_4ms
  1185 000008C5 E81111              <1>         call    delay1_4ms
  1186 000008C8 E80E11              <1>         call    delay1_4ms
  1187 000008CB E80B11              <1>         call    delay1_4ms
  1188                              <1> _cksr:		; 19/05/2024
  1189 000008CE F8                  <1> 	clc
  1190                              <1> p_3:
  1191 000008CF C3                  <1> 	retn
  1192                              <1> p_4:
  1193                              <1> 	;;;
  1194                              <1> ;_cskr:	
  1195 000008D0 F9                  <1> 	stc
  1196 000008D1 C3                  <1> 	retn
  1197                              <1> 
  1198                              <1> ; 19/05/2024
  1199 000008D2 02                  <1> volume:	db 02h
  1200                              <1> 
  1201                              <1> %endif
  1202                              <1> 
  1203                              <1> ; 15/11/2023
  1204                              <1> ; 14/11/2023
  1205                              <1> ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  1206                              <1> ; --------------------------------------------------------
  1207                              <1> 
  1208                              <1> ;;Note:	At the end of every buffer load,
  1209                              <1> ;;	during buffer switch/swap, there will be discontinuity
  1210                              <1> ;;	between the last converted sample and the 1st sample
  1211                              <1> ;;	of the next buffer.
  1212                              <1> ;;	(like as a dot noises vaguely between normal sound samples)
  1213                              <1> ;;	-To avoid this defect, the 1st sample of
  1214                              <1> ;;	the next buffer may be read from the wav file but
  1215                              <1> ;;	the file pointer would need to be set to 1 sample back
  1216                              <1> ;;	again via seek system call. Time comsumption problem! -
  1217                              <1> ;;
  1218                              <1> ;;	Erdogan Tan - 15/11/2023
  1219                              <1> ;;
  1220                              <1> ;;	((If entire wav data would be loaded at once.. conversion
  1221                              <1> ;;	defect/noise would disappear.. but for DOS, to keep
  1222                              <1> ;;	64KB buffer limit is important also it is important
  1223                              <1> ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  1224                              <1> ;;	I have tested this program by using 2-30MB wav files.))
  1225                              <1> ;;
  1226                              <1> ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  1227                              <1> ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  1228                              <1> ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  1229                              <1> ;;			Realtek ALC850 codec.
  1230                              <1> ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  1231                              <1> 
  1232                              <1> load_8khz_mono_8_bit:
  1233                              <1> 	; 15/11/2023
  1234                              <1> 	; 14/11/2023
  1235                              <1> 	; 13/11/2023
  1236 000008D3 F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1237                              <1> 					; last of the file?
  1238 000008D8 7402                <1> 	jz	short lff8m_0		; no
  1239 000008DA F9                  <1> 	stc
  1240 000008DB C3                  <1> 	retn
  1241                              <1> 
  1242                              <1> lff8m_0:
  1243 000008DC 8EC0                <1> 	mov	es, ax ; buffer segment	
  1244 000008DE 31FF                <1> 	xor	di, di
  1245 000008E0 BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1246                              <1> 	; ds = cs
  1247                              <1> 
  1248                              <1> 	; load file into memory
  1249 000008E3 8B0E[8706]          <1>         mov	cx, [loadsize]
  1250 000008E7 8B1E[021E]          <1> 	mov	bx, [filehandle]
  1251 000008EB B43F                <1>        	mov	ah, 3Fh
  1252 000008ED CD21                <1> 	int	21h
  1253                              <1> 	;jc	short lff8m_5 ; error !
  1254                              <1> 	; 14/11/2023
  1255 000008EF 7303                <1> 	jnc	short lff8m_6
  1256 000008F1 E98B00              <1> 	jmp	lff8m_5
  1257                              <1> 
  1258                              <1> lff8m_6:
  1259 000008F4 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1260 000008F6 21C0                <1> 	and	ax, ax
  1261                              <1> 	;jz	short lff8m_3
  1262                              <1> 	; 15/11/2023
  1263 000008F8 747E                <1> 	jz	short lff8_eof
  1264                              <1> 
  1265 000008FA 89C1                <1> 	mov	cx, ax		; byte count
  1266                              <1> lff8m_1:
  1267 000008FC AC                  <1> 	lodsb
  1268 000008FD A2[D019]            <1> 	mov	[previous_val], al
  1269 00000900 2C80                <1> 	sub	al, 80h
  1270 00000902 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1271 00000905 AB                  <1> 	stosw		; original sample (left channel)
  1272 00000906 AB                  <1> 	stosw		; original sample (right channel)
  1273                              <1> 	;xor	ax, ax
  1274                              <1> 	; 14/11/2023
  1275 00000907 B080                <1> 	mov	al, 80h
  1276 00000909 49                  <1> 	dec	cx
  1277 0000090A 7402                <1> 	jz	short lff8m_2
  1278 0000090C 8A04                <1> 	mov	al, [si]
  1279                              <1> lff8m_2:
  1280                              <1> 	;mov	[next_val], ax
  1281 0000090E 88C7                <1> 	mov	bh, al	; [next_val]
  1282 00000910 8A26[D019]          <1> 	mov	ah, [previous_val]
  1283 00000914 00E0                <1> 	add	al, ah	; [previous_val]
  1284 00000916 D0D8                <1> 	rcr	al, 1
  1285 00000918 88C2                <1> 	mov	dl, al	; this is interpolated middle (3th) sample
  1286 0000091A 00E0                <1> 	add	al, ah	; [previous_val]
  1287 0000091C D0D8                <1> 	rcr	al, 1	
  1288 0000091E 88C3                <1> 	mov	bl, al 	; this is temporary interpolation value	
  1289 00000920 00E0                <1> 	add	al, ah	; [previous_val]
  1290 00000922 D0D8                <1> 	rcr	al, 1
  1291 00000924 2C80                <1> 	sub	al, 80h
  1292 00000926 C1E008              <1> 	shl	ax, 8	
  1293 00000929 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1294 0000092A AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1295 0000092B 88D8                <1> 	mov	al, bl
  1296 0000092D 00D0                <1> 	add	al, dl
  1297 0000092F D0D8                <1> 	rcr	al, 1
  1298 00000931 2C80                <1> 	sub	al, 80h
  1299 00000933 C1E008              <1> 	shl	ax, 8
  1300 00000936 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1301 00000937 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1302 00000938 88D0                <1> 	mov	al, dl
  1303 0000093A 2C80                <1> 	sub	al, 80h
  1304 0000093C C1E008              <1> 	shl	ax, 8
  1305 0000093F AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1306 00000940 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1307                              <1> 	;mov	al, [next_val]
  1308 00000941 88F8                <1> 	mov	al, bh
  1309 00000943 00D0                <1> 	add	al, dl
  1310 00000945 D0D8                <1> 	rcr	al, 1
  1311 00000947 88C3                <1> 	mov	bl, al	; this is temporary interpolation value
  1312 00000949 00D0                <1> 	add	al, dl
  1313 0000094B D0D8                <1> 	rcr	al, 1
  1314 0000094D 2C80                <1> 	sub	al, 80h
  1315 0000094F C1E008              <1> 	shl	ax, 8
  1316 00000952 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1317 00000953 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1318                              <1> 	;mov	al, [next_val]
  1319 00000954 88F8                <1> 	mov	al, bh
  1320 00000956 00D8                <1> 	add	al, bl
  1321 00000958 D0D8                <1> 	rcr	al, 1
  1322 0000095A 2C80                <1> 	sub	al, 80h
  1323 0000095C C1E008              <1> 	shl	ax, 8
  1324 0000095F AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1325 00000960 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1326                              <1> 	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1327 00000961 09C9                <1> 	or	cx, cx
  1328 00000963 7597                <1> 	jnz	short lff8m_1
  1329                              <1> 
  1330                              <1> 	; --------------
  1331                              <1> 
  1332                              <1> lff8s_3:
  1333                              <1> lff8m_3:
  1334                              <1> lff8s2_3:
  1335                              <1> lff8m2_3:
  1336                              <1> lff16s_3:
  1337                              <1> lff16m_3:
  1338                              <1> lff16s2_3:
  1339                              <1> lff16m2_3:
  1340                              <1> lff24_3:
  1341                              <1> lff32_3:
  1342                              <1> lff44_3:
  1343                              <1> lff22_3:
  1344                              <1> lff11_3:
  1345 00000965 8B0E[8906]          <1> 	mov	cx, [buffersize] ; 16 bit (48 kHZ, stereo) sample size
  1346 00000969 D1E1                <1> 	shl	cx, 1	; byte count
  1347 0000096B 29F9                <1> 	sub	cx, di
  1348 0000096D 7606                <1> 	jna	short lff8m_4
  1349                              <1> 	;inc	cx
  1350 0000096F D1E9                <1> 	shr	cx, 1
  1351 00000971 31C0                <1> 	xor	ax, ax	; fill (remain part of) buffer with zeros	
  1352 00000973 F3AB                <1> 	rep	stosw
  1353                              <1> lff8m_4:
  1354 00000975 0E                  <1> 	push	cs
  1355 00000976 07                  <1> 	pop	es
  1356 00000977 C3                  <1> 	retn
  1357                              <1> 
  1358                              <1> lff8_eof:
  1359                              <1> lff16_eof:
  1360                              <1> lff24_eof:
  1361                              <1> lff32_eof:
  1362                              <1> lff44_eof:
  1363                              <1> lff22_eof:
  1364                              <1> lff11_eof:
  1365                              <1> 	; 15/11/2023
  1366 00000978 C606[041E]01        <1> 	mov	byte [flags], ENDOFFILE
  1367 0000097D EBE6                <1> 	jmp	short lff8m_3
  1368                              <1> 
  1369                              <1> lff8s_5:
  1370                              <1> lff8m_5:
  1371                              <1> lff8s2_5:
  1372                              <1> lff8m2_5:
  1373                              <1> lff16s_5:
  1374                              <1> lff16m_5:
  1375                              <1> lff16s2_5:
  1376                              <1> lff16m2_5:
  1377                              <1> lff24_5:
  1378                              <1> lff32_5:
  1379                              <1> lff44_5:
  1380                              <1> lff22_5:
  1381                              <1> lff11_5:
  1382 0000097F B021                <1> 	mov	al, '!'  ; error
  1383 00000981 E827FE              <1> 	call	tL0
  1384                              <1> 	
  1385                              <1> 	;jmp	short lff8m_3
  1386                              <1> 	; 15/11/2023
  1387 00000984 EBF2                <1> 	jmp	lff8_eof
  1388                              <1> 
  1389                              <1> 	; --------------
  1390                              <1> 
  1391                              <1> load_8khz_stereo_8_bit:
  1392                              <1> 	; 15/11/2023
  1393                              <1> 	; 14/11/2023
  1394                              <1> 	; 13/11/2023
  1395 00000986 F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1396                              <1> 					; last of the file?
  1397 0000098B 7402                <1> 	jz	short lff8s_0		; no
  1398 0000098D F9                  <1> 	stc
  1399 0000098E C3                  <1> 	retn
  1400                              <1> 
  1401                              <1> lff8s_0:
  1402 0000098F 8EC0                <1> 	mov	es, ax ; buffer segment	
  1403 00000991 31FF                <1> 	xor	di, di
  1404 00000993 BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1405                              <1> 	; ds = cs
  1406                              <1> 
  1407                              <1> 	; load file into memory
  1408 00000996 8B0E[8706]          <1>         mov	cx, [loadsize]
  1409 0000099A 8B1E[021E]          <1> 	mov	bx, [filehandle]
  1410 0000099E B43F                <1>        	mov	ah, 3Fh
  1411 000009A0 CD21                <1> 	int	21h
  1412 000009A2 72DB                <1> 	jc	short lff8s_5 ; error !
  1413                              <1> 
  1414 000009A4 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1415                              <1> 	
  1416 000009A6 D1E8                <1> 	shr	ax, 1
  1417                              <1> 	;;and	ax, ax
  1418                              <1> 	;jz	short lff8s_3
  1419                              <1> 	; 15/11/2023
  1420 000009A8 74CE                <1> 	jz	short lff8_eof
  1421                              <1> 
  1422 000009AA 89C1                <1> 	mov	cx, ax		; word count
  1423                              <1> lff8s_1:
  1424 000009AC AC                  <1> 	lodsb
  1425 000009AD A2[D019]            <1> 	mov	[previous_val_l], al
  1426 000009B0 2C80                <1> 	sub	al, 80h
  1427 000009B2 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1428 000009B5 AB                  <1> 	stosw		; original sample (L)
  1429 000009B6 AC                  <1> 	lodsb
  1430 000009B7 A2[D219]            <1> 	mov	[previous_val_r], al
  1431 000009BA 2C80                <1> 	sub	al, 80h
  1432 000009BC C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1433 000009BF AB                  <1> 	stosw		; original sample (R)
  1434                              <1> 
  1435                              <1> 	;xor	ax, ax
  1436                              <1> 	; 14/11/2023
  1437 000009C0 B88080              <1> 	mov	ax, 8080h
  1438 000009C3 49                  <1> 	dec	cx
  1439 000009C4 7402                <1> 	jz	short lff8s_2
  1440                              <1> 		; convert 8 bit sample to 16 bit sample
  1441 000009C6 8B04                <1> 	mov	ax, [si]
  1442                              <1> lff8s_2:
  1443 000009C8 A2[D419]            <1> 	mov	[next_val_l], al
  1444 000009CB 8826[D619]          <1> 	mov	[next_val_r], ah
  1445 000009CF 8A26[D019]          <1> 	mov	ah, [previous_val_l]
  1446 000009D3 00E0                <1> 	add	al, ah
  1447 000009D5 D0D8                <1> 	rcr	al, 1
  1448 000009D7 88C2                <1> 	mov	dl, al	; this is interpolated middle (3th) sample (L)
  1449 000009D9 00E0                <1> 	add	al, ah
  1450 000009DB D0D8                <1> 	rcr	al, 1	
  1451 000009DD 88C3                <1> 	mov	bl, al	; this is temporary interpolation value (L)
  1452 000009DF 00E0                <1> 	add	al, ah
  1453 000009E1 D0D8                <1> 	rcr	al, 1
  1454 000009E3 2C80                <1> 	sub	al, 80h
  1455 000009E5 C1E008              <1> 	shl	ax, 8
  1456 000009E8 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1457 000009E9 A0[D619]            <1> 	mov	al, [next_val_r]
  1458 000009EC 8A26[D219]          <1> 	mov	ah, [previous_val_r]
  1459 000009F0 00E0                <1> 	add	al, ah
  1460 000009F2 D0D8                <1> 	rcr	al, 1
  1461 000009F4 88C6                <1> 	mov	dh, al	; this is interpolated middle (3th) sample (R)
  1462 000009F6 00E0                <1> 	add	al, ah
  1463 000009F8 D0D8                <1> 	rcr	al, 1
  1464 000009FA 88C7                <1> 	mov	bh, al	; this is temporary interpolation value (R)
  1465 000009FC 00E0                <1> 	add	al, ah
  1466 000009FE D0D8                <1> 	rcr	al, 1
  1467 00000A00 2C80                <1> 	sub	al, 80h
  1468 00000A02 C1E008              <1> 	shl	ax, 8
  1469 00000A05 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1470 00000A06 88D8                <1> 	mov	al, bl
  1471 00000A08 00D0                <1> 	add	al, dl
  1472 00000A0A D0D8                <1> 	rcr	al, 1
  1473 00000A0C 2C80                <1> 	sub	al, 80h
  1474 00000A0E C1E008              <1> 	shl	ax, 8
  1475 00000A11 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1476 00000A12 88F8                <1> 	mov	al, bh
  1477 00000A14 00F0                <1> 	add	al, dh
  1478 00000A16 D0D8                <1> 	rcr	al, 1
  1479 00000A18 2C80                <1> 	sub	al, 80h
  1480 00000A1A C1E008              <1> 	shl	ax, 8
  1481 00000A1D AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1482 00000A1E 88D0                <1> 	mov	al, dl
  1483 00000A20 2C80                <1> 	sub	al, 80h
  1484 00000A22 C1E008              <1> 	shl	ax, 8
  1485 00000A25 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1486 00000A26 88F0                <1> 	mov	al, dh
  1487 00000A28 2C80                <1> 	sub	al, 80h
  1488 00000A2A C1E008              <1> 	shl	ax, 8
  1489 00000A2D AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1490 00000A2E A0[D419]            <1> 	mov	al, [next_val_l]
  1491 00000A31 00D0                <1> 	add	al, dl
  1492 00000A33 D0D8                <1> 	rcr	al, 1
  1493 00000A35 88C3                <1> 	mov	bl, al	; this is temporary interpolation value (L)
  1494 00000A37 00D0                <1> 	add	al, dl
  1495 00000A39 D0D8                <1> 	rcr	al, 1
  1496 00000A3B 2C80                <1> 	sub	al, 80h
  1497 00000A3D C1E008              <1> 	shl	ax, 8
  1498 00000A40 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1499 00000A41 A0[D619]            <1> 	mov	al, [next_val_r]
  1500 00000A44 00F0                <1> 	add	al, dh
  1501 00000A46 D0D8                <1> 	rcr	al, 1
  1502 00000A48 88C7                <1> 	mov	bh, al	; this is temporary interpolation value (R)
  1503 00000A4A 00F0                <1> 	add	al, dh
  1504 00000A4C D0D8                <1> 	rcr	al, 1
  1505 00000A4E 2C80                <1> 	sub	al, 80h
  1506 00000A50 C1E008              <1> 	shl	ax, 8
  1507 00000A53 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1508 00000A54 A0[D419]            <1> 	mov	al, [next_val_l]
  1509 00000A57 00D8                <1> 	add	al, bl
  1510 00000A59 D0D8                <1> 	rcr	al, 1
  1511 00000A5B 2C80                <1> 	sub	al, 80h
  1512 00000A5D C1E008              <1> 	shl	ax, 8
  1513 00000A60 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1514 00000A61 A0[D619]            <1> 	mov	al, [next_val_r]
  1515 00000A64 00F8                <1> 	add	al, bh
  1516 00000A66 D0D8                <1> 	rcr	al, 1
  1517 00000A68 2C80                <1> 	sub	al, 80h
  1518 00000A6A C1E008              <1> 	shl	ax, 8
  1519 00000A6D AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1520                              <1> 	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1521 00000A6E E303                <1> 	jcxz	lff8s_6
  1522 00000A70 E939FF              <1> 	jmp	lff8s_1
  1523                              <1> lff8s_6:
  1524 00000A73 E9EFFE              <1> 	jmp	lff8s_3
  1525                              <1> 
  1526                              <1> load_8khz_mono_16_bit:
  1527                              <1> 	; 13/11/2023
  1528 00000A76 F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1529                              <1> 					; last of the file?
  1530 00000A7B 7402                <1> 	jz	short lff8m2_0		; no
  1531 00000A7D F9                  <1> 	stc
  1532 00000A7E C3                  <1> 	retn
  1533                              <1> 
  1534                              <1> lff8m2_0:
  1535 00000A7F 8EC0                <1> 	mov	es, ax ; buffer segment	
  1536 00000A81 31FF                <1> 	xor	di, di
  1537 00000A83 BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1538                              <1> 	; ds = cs
  1539                              <1> 
  1540                              <1> 	; load file into memory
  1541 00000A86 8B0E[8706]          <1>         mov	cx, [loadsize]
  1542 00000A8A 8B1E[021E]          <1> 	mov	bx, [filehandle]
  1543 00000A8E B43F                <1>        	mov	ah, 3Fh
  1544 00000A90 CD21                <1> 	int	21h
  1545 00000A92 7270                <1> 	jc	short lff8m2_7 ; error !
  1546                              <1> 
  1547 00000A94 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1548                              <1> 	
  1549 00000A96 D1E8                <1> 	shr	ax, 1
  1550                              <1> 	;and	ax, ax
  1551 00000A98 7503                <1> 	jnz	short lff8m2_8
  1552                              <1> 	;jmp	lff8m2_3
  1553                              <1> 	; 15/11/2023
  1554 00000A9A E9DBFE              <1> 	jmp	lff8_eof
  1555                              <1> 
  1556                              <1> lff8m2_8:
  1557 00000A9D 89C1                <1> 	mov	cx, ax		; word count
  1558                              <1> lff8m2_1:
  1559 00000A9F AD                  <1> 	lodsw
  1560 00000AA0 AB                  <1> 	stosw		; original sample (left channel)
  1561 00000AA1 AB                  <1> 	stosw		; original sample (right channel)
  1562 00000AA2 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1563 00000AA5 A3[D019]            <1> 	mov	[previous_val], ax
  1564 00000AA8 31C0                <1> 	xor	ax, ax
  1565 00000AAA 49                  <1> 	dec	cx
  1566 00000AAB 7402                <1> 	jz	short lff8m2_2
  1567 00000AAD 8B04                <1> 	mov	ax, [si]
  1568                              <1> lff8m2_2:
  1569 00000AAF 80C480              <1> 	add	ah, 80h ; convert sound level to 0-65535 format
  1570 00000AB2 89C5                <1> 	mov	bp, ax	; [next_val]
  1571 00000AB4 0306[D019]          <1> 	add	ax, [previous_val]
  1572 00000AB8 D1D8                <1> 	rcr	ax, 1
  1573 00000ABA 89C2                <1> 	mov	dx, ax	; this is interpolated middle (3th) sample
  1574 00000ABC 0306[D019]          <1> 	add	ax, [previous_val]
  1575 00000AC0 D1D8                <1> 	rcr	ax, 1	; this is temporary interpolation value
  1576 00000AC2 89C3                <1> 	mov	bx, ax 		
  1577 00000AC4 0306[D019]          <1> 	add	ax, [previous_val]
  1578 00000AC8 D1D8                <1> 	rcr	ax, 1
  1579 00000ACA 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1580 00000ACD AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1581 00000ACE AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1582 00000ACF 89D8                <1> 	mov	ax, bx
  1583 00000AD1 01D0                <1> 	add	ax, dx
  1584 00000AD3 D1D8                <1> 	rcr	ax, 1
  1585 00000AD5 80EC80              <1> 	sub	ah, 80h
  1586 00000AD8 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1587 00000AD9 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1588 00000ADA 89D0                <1> 	mov	ax, dx
  1589 00000ADC 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1590 00000ADF AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1591 00000AE0 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1592 00000AE1 89E8                <1> 	mov	ax, bp
  1593 00000AE3 01D0                <1> 	add	ax, dx
  1594 00000AE5 D1D8                <1> 	rcr	ax, 1
  1595 00000AE7 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value
  1596 00000AE9 01D0                <1> 	add	ax, dx
  1597 00000AEB D1D8                <1> 	rcr	ax, 1
  1598 00000AED 80EC80              <1> 	sub	ah, 80h
  1599 00000AF0 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1600 00000AF1 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1601 00000AF2 89E8                <1> 	mov	ax, bp
  1602 00000AF4 01D8                <1> 	add	ax, bx
  1603 00000AF6 D1D8                <1> 	rcr	ax, 1
  1604 00000AF8 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1605 00000AFB AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1606 00000AFC AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1607                              <1> 	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1608 00000AFD 09C9                <1> 	or	cx, cx
  1609 00000AFF 759E                <1> 	jnz	short lff8m2_1
  1610 00000B01 E961FE              <1> 	jmp	lff8m2_3
  1611                              <1> 
  1612                              <1> lff8m2_7:
  1613                              <1> lff8s2_7:
  1614 00000B04 E978FE              <1> 	jmp	lff8m2_5  ; error
  1615                              <1> 
  1616                              <1> load_8khz_stereo_16_bit:
  1617                              <1> 	; 16/11/2023
  1618                              <1> 	; 15/11/2023
  1619                              <1> 	; 13/11/2023
  1620 00000B07 F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1621                              <1> 					; last of the file?
  1622 00000B0C 7402                <1> 	jz	short lff8s2_0		; no
  1623 00000B0E F9                  <1> 	stc
  1624 00000B0F C3                  <1> 	retn
  1625                              <1> 
  1626                              <1> lff8s2_0:
  1627 00000B10 8EC0                <1> 	mov	es, ax ; buffer segment	
  1628 00000B12 31FF                <1> 	xor	di, di
  1629 00000B14 BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1630                              <1> 	; ds = cs
  1631                              <1> 
  1632                              <1> 	; load file into memory
  1633 00000B17 8B0E[8706]          <1>         mov	cx, [loadsize]
  1634 00000B1B 8B1E[021E]          <1> 	mov	bx, [filehandle]
  1635 00000B1F B43F                <1>        	mov	ah, 3Fh
  1636 00000B21 CD21                <1> 	int	21h
  1637 00000B23 72DF                <1> 	jc	short lff8s2_7 ; error !
  1638                              <1> 
  1639 00000B25 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1640                              <1> 	
  1641 00000B27 C1E802              <1> 	shr	ax, 2	; 16/11/2023
  1642                              <1> 	;and	ax, ax
  1643 00000B2A 7503                <1> 	jnz	short lff8s2_8
  1644                              <1> 	;jmp	lff8s2_3
  1645                              <1> 	; 15/11/2023
  1646 00000B2C E949FE              <1> 	jmp	lff8_eof
  1647                              <1> 
  1648                              <1> lff8s2_8:
  1649 00000B2F 89C1                <1> 	mov	cx, ax ; dword count
  1650                              <1> lff8s2_1:
  1651 00000B31 AD                  <1> 	lodsw
  1652 00000B32 AB                  <1> 	stosw		; original sample (L)
  1653                              <1> 	; 15/11/2023
  1654 00000B33 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1655 00000B36 A3[D019]            <1> 	mov	[previous_val_l], ax
  1656 00000B39 AD                  <1> 	lodsw
  1657 00000B3A AB                  <1> 	stosw		; original sample (R)
  1658 00000B3B 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1659 00000B3E A3[D219]            <1> 	mov	[previous_val_r], ax
  1660 00000B41 31D2                <1> 	xor	dx, dx
  1661 00000B43 31C0                <1> 	xor	ax, ax
  1662                              <1> 	; 16/11/2023
  1663 00000B45 49                  <1> 	dec	cx
  1664 00000B46 7405                <1> 	jz	short lff8s2_2
  1665 00000B48 8B04                <1> 	mov	ax, [si]
  1666 00000B4A 8B5402              <1> 	mov	dx, [si+2]
  1667                              <1> lff8s2_2:
  1668 00000B4D 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1669 00000B50 A3[D419]            <1> 	mov	[next_val_l], ax
  1670 00000B53 80C680              <1> 	add	dh, 80h	; convert sound level to 0-65535 format
  1671 00000B56 8916[D619]          <1> 	mov	[next_val_r], dx
  1672 00000B5A 0306[D019]          <1> 	add	ax, [previous_val_l]
  1673 00000B5E D1D8                <1> 	rcr	ax, 1
  1674 00000B60 89C2                <1> 	mov	dx, ax	; this is interpolated middle (3th) sample (L)
  1675 00000B62 0306[D019]          <1> 	add	ax, [previous_val_l]
  1676 00000B66 D1D8                <1> 	rcr	ax, 1	
  1677 00000B68 89C3                <1> 	mov	bx, ax 	; this is temporary interpolation value (L)
  1678 00000B6A 0306[D019]          <1> 	add	ax, [previous_val_l]
  1679 00000B6E D1D8                <1> 	rcr	ax, 1
  1680 00000B70 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1681 00000B73 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1682 00000B74 A1[D619]            <1> 	mov	ax, [next_val_r]
  1683 00000B77 0306[D219]          <1> 	add	ax, [previous_val_r]
  1684 00000B7B D1D8                <1> 	rcr	ax, 1
  1685 00000B7D 89C5                <1> 	mov	bp, ax	; this is interpolated middle (3th) sample (R)
  1686 00000B7F 0306[D219]          <1> 	add	ax, [previous_val_r]
  1687 00000B83 D1D8                <1> 	rcr	ax, 1
  1688 00000B85 50                  <1> 	push	ax ; *	; this is temporary interpolation value (R)
  1689 00000B86 0306[D219]          <1> 	add	ax, [previous_val_r]
  1690 00000B8A D1D8                <1> 	rcr	ax, 1
  1691 00000B8C 80EC80              <1> 	sub	ah, 80h
  1692 00000B8F AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1693 00000B90 89D8                <1> 	mov	ax, bx
  1694 00000B92 01D0                <1> 	add	ax, dx
  1695 00000B94 D1D8                <1> 	rcr	ax, 1
  1696 00000B96 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1697 00000B99 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1698 00000B9A 58                  <1> 	pop	ax ; *
  1699 00000B9B 01E8                <1> 	add	ax, bp
  1700 00000B9D D1D8                <1> 	rcr	ax, 1
  1701 00000B9F 80EC80              <1> 	sub	ah, 80h
  1702 00000BA2 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1703 00000BA3 89D0                <1> 	mov	ax, dx
  1704 00000BA5 80EC80              <1> 	sub	ah, 80h
  1705 00000BA8 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1706 00000BA9 89E8                <1> 	mov	ax, bp
  1707 00000BAB 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1708 00000BAE AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1709 00000BAF A1[D419]            <1> 	mov	ax, [next_val_l]
  1710 00000BB2 01D0                <1> 	add	ax, dx
  1711 00000BB4 D1D8                <1> 	rcr	ax, 1
  1712 00000BB6 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value (L)
  1713 00000BB8 01D0                <1> 	add	ax, dx
  1714 00000BBA D1D8                <1> 	rcr	ax, 1
  1715 00000BBC 80EC80              <1> 	sub	ah, 80h
  1716 00000BBF AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1717 00000BC0 A1[D619]            <1> 	mov	ax, [next_val_r]
  1718 00000BC3 01E8                <1> 	add	ax, bp
  1719 00000BC5 D1D8                <1> 	rcr	ax, 1
  1720 00000BC7 50                  <1> 	push	ax ; ** ; this is temporary interpolation value (R)
  1721 00000BC8 01E8                <1> 	add	ax, bp
  1722 00000BCA D1D8                <1> 	rcr	ax, 1
  1723 00000BCC 80EC80              <1> 	sub	ah, 80h
  1724 00000BCF AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1725 00000BD0 A1[D419]            <1> 	mov	ax, [next_val_l]
  1726 00000BD3 01D8                <1> 	add	ax, bx
  1727 00000BD5 D1D8                <1> 	rcr	ax, 1
  1728 00000BD7 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1729 00000BDA AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1730 00000BDB 58                  <1> 	pop	ax ; **
  1731 00000BDC 0306[D619]          <1> 	add	ax, [next_val_r]
  1732 00000BE0 D1D8                <1> 	rcr	ax, 1
  1733 00000BE2 80EC80              <1> 	sub	ah, 80h
  1734 00000BE5 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1735                              <1> 	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1736 00000BE6 E303                <1> 	jcxz	lff8_s2_9
  1737 00000BE8 E946FF              <1> 	jmp	lff8s2_1
  1738                              <1> lff8_s2_9:
  1739 00000BEB E977FD              <1> 	jmp	lff8s2_3
  1740                              <1> 
  1741                              <1> ; .....................
  1742                              <1> 
  1743                              <1> load_16khz_mono_8_bit:
  1744                              <1> 	; 14/11/2023
  1745                              <1> 	; 13/11/2023
  1746 00000BEE F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1747                              <1> 					; last of the file?
  1748 00000BF3 7402                <1> 	jz	short lff16m_0		; no
  1749 00000BF5 F9                  <1> 	stc
  1750 00000BF6 C3                  <1> 	retn
  1751                              <1> 
  1752                              <1> lff16m_0:
  1753 00000BF7 8EC0                <1> 	mov	es, ax ; buffer segment	
  1754 00000BF9 31FF                <1> 	xor	di, di
  1755 00000BFB BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1756                              <1> 	; ds = cs
  1757                              <1> 
  1758                              <1> 	; load file into memory
  1759 00000BFE 8B0E[8706]          <1>         mov	cx, [loadsize]
  1760 00000C02 8B1E[021E]          <1> 	mov	bx, [filehandle]
  1761 00000C06 B43F                <1>        	mov	ah, 3Fh
  1762 00000C08 CD21                <1> 	int	21h
  1763 00000C0A 7243                <1> 	jc	short lff16m_7 ; error !
  1764                              <1> 
  1765 00000C0C 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1766                              <1> 	
  1767 00000C0E 21C0                <1> 	and	ax, ax
  1768 00000C10 7503                <1> 	jnz	short lff16m_8
  1769                              <1> 	;jmp	lff16m_3
  1770                              <1> 	; 15/11/2023
  1771 00000C12 E963FD              <1> 	jmp	lff16_eof
  1772                              <1> 
  1773                              <1> lff16m_8:
  1774 00000C15 89C1                <1> 	mov	cx, ax		; byte count
  1775                              <1> lff16m_1:
  1776 00000C17 AC                  <1> 	lodsb
  1777                              <1> 	;mov	[previous_val], al
  1778 00000C18 88C3                <1> 	mov	bl, al
  1779 00000C1A 2C80                <1> 	sub	al, 80h
  1780 00000C1C C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1781 00000C1F AB                  <1> 	stosw		; original sample (left channel)
  1782 00000C20 AB                  <1> 	stosw		; original sample (right channel)
  1783                              <1> 	;xor	ax, ax
  1784                              <1> 	; 14/11/22023
  1785 00000C21 B080                <1> 	mov	al, 80h
  1786 00000C23 49                  <1> 	dec	cx
  1787 00000C24 7402                <1> 	jz	short lff16m_2
  1788 00000C26 8A04                <1> 	mov	al, [si]
  1789                              <1> lff16m_2:
  1790                              <1> 	;mov	[next_val], al
  1791 00000C28 88C7                <1> 	mov	bh, al
  1792                              <1> 	;add	al, [previous_val]
  1793 00000C2A 00D8                <1> 	add	al, bl
  1794 00000C2C D0D8                <1> 	rcr	al, 1
  1795 00000C2E 88C2                <1> 	mov	dl, al	; this is interpolated middle (temp) sample
  1796                              <1> 	;add	al, [previous_val]
  1797 00000C30 00D8                <1> 	add	al, bl
  1798 00000C32 D0D8                <1> 	rcr	al, 1
  1799 00000C34 2C80                <1> 	sub	al, 80h
  1800 00000C36 C1E008              <1> 	shl	ax, 8
  1801 00000C39 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1802 00000C3A AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1803                              <1> 	;mov	al, [next_val]
  1804 00000C3B 88F8                <1> 	mov	al, bh
  1805 00000C3D 00D0                <1> 	add	al, dl
  1806 00000C3F D0D8                <1> 	rcr	al, 1
  1807 00000C41 2C80                <1> 	sub	al, 80h
  1808 00000C43 C1E008              <1> 	shl	ax, 8
  1809 00000C46 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1810 00000C47 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1811                              <1> 	
  1812                              <1> 	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1813 00000C48 09C9                <1> 	or	cx, cx
  1814 00000C4A 75CB                <1> 	jnz	short lff16m_1
  1815 00000C4C E916FD              <1> 	jmp	lff16m_3
  1816                              <1> 
  1817                              <1> lff16m_7:
  1818                              <1> lff16s_7:
  1819 00000C4F E92DFD              <1> 	jmp	lff16m_5  ; error
  1820                              <1> 
  1821                              <1> load_16khz_stereo_8_bit:
  1822                              <1> 	; 14/11/2023
  1823                              <1> 	; 13/11/2023
  1824 00000C52 F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1825                              <1> 					; last of the file?
  1826 00000C57 7402                <1> 	jz	short lff16s_0		; no
  1827 00000C59 F9                  <1> 	stc
  1828 00000C5A C3                  <1> 	retn
  1829                              <1> 
  1830                              <1> lff16s_0:
  1831 00000C5B 8EC0                <1> 	mov	es, ax ; buffer segment	
  1832 00000C5D 31FF                <1> 	xor	di, di
  1833 00000C5F BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1834                              <1> 	; ds = cs
  1835                              <1> 
  1836                              <1> 	; load file into memory
  1837 00000C62 8B0E[8706]          <1>         mov	cx, [loadsize]
  1838 00000C66 8B1E[021E]          <1> 	mov	bx, [filehandle]
  1839 00000C6A B43F                <1>        	mov	ah, 3Fh
  1840 00000C6C CD21                <1> 	int	21h
  1841 00000C6E 72DF                <1> 	jc	short lff16s_7 ; error !
  1842                              <1> 
  1843 00000C70 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1844                              <1> 	
  1845 00000C72 D1E8                <1> 	shr	ax, 1
  1846                              <1> 	;and	ax, ax
  1847 00000C74 7503                <1> 	jnz	short lff16s_8
  1848                              <1> 	;jmp	lff16s_3
  1849                              <1> 	; 15/11/2023
  1850 00000C76 E9FFFC              <1> 	jmp	lff16_eof
  1851                              <1> 
  1852                              <1> lff16s_8:
  1853 00000C79 89C1                <1> 	mov	cx, ax		; word count
  1854                              <1> lff16s_1:
  1855 00000C7B AC                  <1> 	lodsb
  1856 00000C7C A2[D019]            <1> 	mov	[previous_val_l], al
  1857 00000C7F 2C80                <1> 	sub	al, 80h
  1858 00000C81 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1859 00000C84 AB                  <1> 	stosw		; original sample (L)
  1860 00000C85 AC                  <1> 	lodsb
  1861 00000C86 A2[D219]            <1> 	mov	[previous_val_r], al
  1862 00000C89 2C80                <1> 	sub	al, 80h
  1863 00000C8B C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1864 00000C8E AB                  <1> 	stosw		; original sample (R)
  1865                              <1> 
  1866                              <1> 	;xor	ax, ax
  1867                              <1> 	; 14/11/2023
  1868 00000C8F B88080              <1> 	mov	ax, 8080h
  1869 00000C92 49                  <1> 	dec	cx
  1870 00000C93 7402                <1> 	jz	short lff16s_2
  1871                              <1> 		; convert 8 bit sample to 16 bit sample
  1872 00000C95 8B04                <1> 	mov	ax, [si]
  1873                              <1> lff16s_2:
  1874                              <1> 	;mov	[next_val_l], al
  1875                              <1> 	;mov	[next_val_r], ah
  1876 00000C97 89C3                <1> 	mov	bx, ax
  1877 00000C99 0206[D019]          <1> 	add	al, [previous_val_l]
  1878 00000C9D D0D8                <1> 	rcr	al, 1
  1879 00000C9F 88C2                <1> 	mov	dl, al	; this is temporary interpolation value (L)
  1880 00000CA1 0206[D019]          <1> 	add	al, [previous_val_l]
  1881 00000CA5 D0D8                <1> 	rcr	al, 1
  1882 00000CA7 2C80                <1> 	sub	al, 80h
  1883 00000CA9 C1E008              <1> 	shl	ax, 8
  1884 00000CAC AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1885 00000CAD 88F8                <1> 	mov	al, bh	; [next_val_r]
  1886 00000CAF 0206[D219]          <1> 	add	al, [previous_val_r]
  1887 00000CB3 D0D8                <1> 	rcr	al, 1
  1888 00000CB5 88C6                <1> 	mov	dh, al	; this is temporary interpolation value (R)
  1889 00000CB7 0206[D219]          <1> 	add	al, [previous_val_r]
  1890 00000CBB D0D8                <1> 	rcr	al, 1
  1891 00000CBD 2C80                <1> 	sub	al, 80h
  1892 00000CBF C1E008              <1> 	shl	ax, 8
  1893 00000CC2 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1894 00000CC3 88D0                <1> 	mov	al, dl
  1895 00000CC5 00D8                <1> 	add	al, bl	; [next_val_l]
  1896 00000CC7 D0D8                <1> 	rcr	al, 1
  1897 00000CC9 2C80                <1> 	sub	al, 80h
  1898 00000CCB C1E008              <1> 	shl	ax, 8
  1899 00000CCE AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1900 00000CCF 88F0                <1> 	mov	al, dh
  1901 00000CD1 00F8                <1> 	add	al, bh	; [next_val_r]
  1902 00000CD3 D0D8                <1> 	rcr	al, 1
  1903 00000CD5 2C80                <1> 	sub	al, 80h
  1904 00000CD7 C1E008              <1> 	shl	ax, 8
  1905 00000CDA AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1906                              <1> 	
  1907                              <1> 	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1908 00000CDB 09C9                <1> 	or	cx, cx
  1909 00000CDD 759C                <1> 	jnz	short lff16s_1
  1910 00000CDF E983FC              <1> 	jmp	lff16s_3
  1911                              <1> 
  1912                              <1> load_16khz_mono_16_bit:
  1913                              <1> 	; 15/11/2023
  1914                              <1> 	; 13/11/2023
  1915 00000CE2 F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1916                              <1> 					; last of the file?
  1917 00000CE7 7402                <1> 	jz	short lff16m2_0		; no
  1918 00000CE9 F9                  <1> 	stc
  1919 00000CEA C3                  <1> 	retn
  1920                              <1> 
  1921                              <1> lff16m2_0:
  1922 00000CEB 8EC0                <1> 	mov	es, ax ; buffer segment	
  1923 00000CED 31FF                <1> 	xor	di, di
  1924 00000CEF BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1925                              <1> 	; ds = cs
  1926                              <1> 
  1927                              <1> 	; load file into memory
  1928 00000CF2 8B0E[8706]          <1>         mov	cx, [loadsize]
  1929 00000CF6 8B1E[021E]          <1> 	mov	bx, [filehandle]
  1930 00000CFA B43F                <1>        	mov	ah, 3Fh
  1931 00000CFC CD21                <1> 	int	21h
  1932 00000CFE 7240                <1> 	jc	short lff16m2_7 ; error !
  1933                              <1> 
  1934 00000D00 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1935                              <1> 	
  1936 00000D02 D1E8                <1> 	shr	ax, 1
  1937                              <1> 	;and	ax, ax
  1938 00000D04 7503                <1> 	jnz	short lff16m2_8
  1939                              <1> 	;jmp	lff16m2_3
  1940                              <1> 	; 15/11/2023
  1941 00000D06 E96FFC              <1> 	jmp	lff16_eof
  1942                              <1> 
  1943                              <1> lff16m2_8:
  1944 00000D09 89C1                <1> 	mov	cx, ax	; word count
  1945                              <1> lff16m2_1:
  1946 00000D0B AD                  <1> 	lodsw
  1947 00000D0C AB                  <1> 	stosw		; original sample (left channel)
  1948 00000D0D AB                  <1> 	stosw		; original sample (right channel)
  1949 00000D0E 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  1950                              <1> 	;mov	[previous_val], ax
  1951 00000D11 89C3                <1> 	mov	bx, ax	
  1952 00000D13 31C0                <1> 	xor	ax, ax
  1953 00000D15 49                  <1> 	dec	cx
  1954 00000D16 7402                <1> 	jz	short lff16m2_2
  1955 00000D18 8B04                <1> 	mov	ax, [si]
  1956                              <1> lff16m2_2:
  1957 00000D1A 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  1958 00000D1D 89C5                <1> 	mov	bp, ax	; [next_val]
  1959                              <1> 	;add	ax, [previous_val]
  1960 00000D1F 01D8                <1> 	add	ax, bx
  1961 00000D21 D1D8                <1> 	rcr	ax, 1
  1962 00000D23 89C2                <1> 	mov	dx, ax	; this is temporary interpolation value
  1963                              <1> 	;add	ax, [previous_val]
  1964 00000D25 01D8                <1> 	add	ax, bx
  1965 00000D27 D1D8                <1> 	rcr	ax, 1
  1966 00000D29 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1967 00000D2C AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1968 00000D2D AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1969 00000D2E 89E8                <1> 	mov	ax, bp 
  1970 00000D30 01D0                <1> 	add	ax, dx
  1971 00000D32 D1D8                <1> 	rcr	ax, 1
  1972 00000D34 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1973 00000D37 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1974 00000D38 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1975                              <1> 	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1976 00000D39 09C9                <1> 	or	cx, cx
  1977 00000D3B 75CE                <1> 	jnz	short lff16m2_1
  1978 00000D3D E925FC              <1> 	jmp	lff16m2_3
  1979                              <1> 
  1980                              <1> lff16m2_7:
  1981                              <1> lff16s2_7:
  1982 00000D40 E93CFC              <1> 	jmp	lff16m2_5  ; error
  1983                              <1> 
  1984                              <1> load_16khz_stereo_16_bit:
  1985                              <1> 	; 16/11/2023
  1986                              <1> 	; 15/11/2023
  1987                              <1> 	; 13/11/2023
  1988 00000D43 F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1989                              <1> 					; last of the file?
  1990 00000D48 7402                <1> 	jz	short lff16s2_0		; no
  1991 00000D4A F9                  <1> 	stc
  1992 00000D4B C3                  <1> 	retn
  1993                              <1> 
  1994                              <1> lff16s2_0:
  1995 00000D4C 8EC0                <1> 	mov	es, ax ; buffer segment	
  1996 00000D4E 31FF                <1> 	xor	di, di
  1997 00000D50 BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1998                              <1> 	; ds = cs
  1999                              <1> 
  2000                              <1> 	; load file into memory
  2001 00000D53 8B0E[8706]          <1>         mov	cx, [loadsize]
  2002 00000D57 8B1E[021E]          <1> 	mov	bx, [filehandle]
  2003 00000D5B B43F                <1>        	mov	ah, 3Fh
  2004 00000D5D CD21                <1> 	int	21h
  2005 00000D5F 72DF                <1> 	jc	short lff16s2_7 ; error !
  2006                              <1> 
  2007 00000D61 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2008                              <1> 	
  2009                              <1> 	;shr	ax, 1
  2010 00000D63 C1E802              <1> 	shr	ax, 2	; 16/11/2023
  2011                              <1> 	;and	ax, ax
  2012 00000D66 7503                <1> 	jnz	short lff16s2_8
  2013                              <1> 	;jmp	lff16s2_3
  2014                              <1> 	; 15/11/2023
  2015 00000D68 E90DFC              <1> 	jmp	lff16_eof
  2016                              <1> 
  2017                              <1> lff16s2_8:
  2018 00000D6B 89C1                <1> 	mov	cx, ax		; dword count
  2019                              <1> lff16s2_1:
  2020 00000D6D AD                  <1> 	lodsw
  2021 00000D6E AB                  <1> 	stosw		; original sample (L)
  2022 00000D6F 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2023 00000D72 A3[D019]            <1> 	mov	[previous_val_l], ax
  2024 00000D75 AD                  <1> 	lodsw
  2025 00000D76 AB                  <1> 	stosw		; original sample (R)
  2026 00000D77 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2027 00000D7A A3[D219]            <1> 	mov	[previous_val_r], ax
  2028 00000D7D 31D2                <1> 	xor	dx, dx
  2029 00000D7F 31C0                <1> 	xor	ax, ax
  2030                              <1> 	; 16/11/2023
  2031 00000D81 49                  <1> 	dec	cx
  2032 00000D82 7405                <1> 	jz	short lff16s2_2
  2033 00000D84 8B04                <1> 	mov	ax, [si]
  2034 00000D86 8B5402              <1> 	mov	dx, [si+2]
  2035                              <1> lff16s2_2:
  2036 00000D89 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2037                              <1> 	;mov	[next_val_l], ax
  2038 00000D8C 89C5                <1> 	mov	bp, ax
  2039 00000D8E 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format 
  2040 00000D91 8916[D619]          <1> 	mov	[next_val_r], dx
  2041 00000D95 0306[D019]          <1> 	add	ax, [previous_val_l]
  2042 00000D99 D1D8                <1> 	rcr	ax, 1
  2043 00000D9B 89C2                <1> 	mov	dx, ax	; this is temporary interpolation value (L)
  2044 00000D9D 0306[D019]          <1> 	add	ax, [previous_val_l]
  2045 00000DA1 D1D8                <1> 	rcr	ax, 1
  2046 00000DA3 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  2047 00000DA6 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  2048 00000DA7 A1[D619]            <1> 	mov	ax, [next_val_r]
  2049 00000DAA 0306[D219]          <1> 	add	ax, [previous_val_r]
  2050 00000DAE D1D8                <1> 	rcr	ax, 1
  2051 00000DB0 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value (R)
  2052 00000DB2 0306[D219]          <1> 	add	ax, [previous_val_r]
  2053 00000DB6 D1D8                <1> 	rcr	ax, 1
  2054 00000DB8 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2055 00000DBB AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  2056                              <1> 	;mov	ax, [next_val_l]
  2057 00000DBC 89E8                <1> 	mov	ax, bp
  2058 00000DBE 01D0                <1> 	add	ax, dx
  2059 00000DC0 D1D8                <1> 	rcr	ax, 1
  2060 00000DC2 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2061 00000DC5 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  2062 00000DC6 A1[D619]            <1> 	mov	ax, [next_val_r]
  2063 00000DC9 01D8                <1> 	add	ax, bx
  2064 00000DCB D1D8                <1> 	rcr	ax, 1
  2065 00000DCD 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2066 00000DD0 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  2067                              <1> 	
  2068                              <1> 	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2069 00000DD1 09C9                <1> 	or	cx, cx
  2070 00000DD3 7598                <1> 	jnz	short lff16s2_1
  2071 00000DD5 E98DFB              <1> 	jmp	lff16s2_3
  2072                              <1> 
  2073                              <1> ; .....................
  2074                              <1> 
  2075                              <1> load_24khz_mono_8_bit:
  2076                              <1> 	; 15/11/2023
  2077 00000DD8 F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2078                              <1> 					; last of the file?
  2079 00000DDD 7402                <1> 	jz	short lff24m_0		; no
  2080 00000DDF F9                  <1> 	stc
  2081 00000DE0 C3                  <1> 	retn
  2082                              <1> 
  2083                              <1> lff24m_0:
  2084 00000DE1 8EC0                <1> 	mov	es, ax ; buffer segment	
  2085 00000DE3 31FF                <1> 	xor	di, di
  2086 00000DE5 BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2087                              <1> 	; ds = cs
  2088                              <1> 
  2089                              <1> 	; load file into memory
  2090 00000DE8 8B0E[8706]          <1>         mov	cx, [loadsize]
  2091 00000DEC 8B1E[021E]          <1> 	mov	bx, [filehandle]
  2092 00000DF0 B43F                <1>        	mov	ah, 3Fh
  2093 00000DF2 CD21                <1> 	int	21h
  2094 00000DF4 722E                <1> 	jc	short lff24m_7 ; error !
  2095                              <1> 
  2096 00000DF6 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2097                              <1> 	
  2098 00000DF8 21C0                <1> 	and	ax, ax
  2099 00000DFA 7503                <1> 	jnz	short lff24m_8
  2100 00000DFC E979FB              <1> 	jmp	lff24_eof
  2101                              <1> 
  2102                              <1> lff24m_8:
  2103 00000DFF 89C1                <1> 	mov	cx, ax		; byte count
  2104                              <1> lff24m_1:
  2105 00000E01 AC                  <1> 	lodsb
  2106                              <1> 	;mov	[previous_val], al
  2107 00000E02 88C3                <1> 	mov	bl, al
  2108 00000E04 2C80                <1> 	sub	al, 80h
  2109 00000E06 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2110 00000E09 AB                  <1> 	stosw		; original sample (left channel)
  2111 00000E0A AB                  <1> 	stosw		; original sample (right channel)
  2112                              <1> 	;xor	ax, ax
  2113 00000E0B B080                <1> 	mov	al, 80h
  2114 00000E0D 49                  <1> 	dec	cx
  2115 00000E0E 7402                <1> 	jz	short lff24m_2
  2116 00000E10 8A04                <1> 	mov	al, [si]
  2117                              <1> lff24m_2:
  2118                              <1> 	;;mov	[next_val], al
  2119                              <1> 	;mov	bh, al
  2120                              <1> 	;add	al, [previous_val]
  2121 00000E12 00D8                <1> 	add	al, bl
  2122 00000E14 D0D8                <1> 	rcr	al, 1
  2123 00000E16 2C80                <1> 	sub	al, 80h
  2124 00000E18 C1E008              <1> 	shl	ax, 8
  2125 00000E1B AB                  <1> 	stosw		; this is interpolated sample (L)
  2126 00000E1C AB                  <1> 	stosw		; this is interpolated sample (R)
  2127                              <1> 	
  2128                              <1> 	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2129 00000E1D 09C9                <1> 	or	cx, cx
  2130 00000E1F 75E0                <1> 	jnz	short lff24m_1
  2131 00000E21 E941FB              <1> 	jmp	lff24_3
  2132                              <1> 
  2133                              <1> lff24m_7:
  2134                              <1> lff24s_7:
  2135 00000E24 E958FB              <1> 	jmp	lff24_5  ; error
  2136                              <1> 
  2137                              <1> load_24khz_stereo_8_bit:
  2138                              <1> 	; 15/11/2023
  2139 00000E27 F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2140                              <1> 					; last of the file?
  2141 00000E2C 7402                <1> 	jz	short lff24s_0		; no
  2142 00000E2E F9                  <1> 	stc
  2143 00000E2F C3                  <1> 	retn
  2144                              <1> 
  2145                              <1> lff24s_0:
  2146 00000E30 8EC0                <1> 	mov	es, ax ; buffer segment	
  2147 00000E32 31FF                <1> 	xor	di, di
  2148 00000E34 BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2149                              <1> 	; ds = cs
  2150                              <1> 
  2151                              <1> 	; load file into memory
  2152 00000E37 8B0E[8706]          <1>         mov	cx, [loadsize]
  2153 00000E3B 8B1E[021E]          <1> 	mov	bx, [filehandle]
  2154 00000E3F B43F                <1>        	mov	ah, 3Fh
  2155 00000E41 CD21                <1> 	int	21h
  2156 00000E43 72DF                <1> 	jc	short lff24s_7 ; error !
  2157                              <1> 
  2158 00000E45 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2159                              <1> 	
  2160 00000E47 D1E8                <1> 	shr	ax, 1
  2161                              <1> 	;and	ax, ax
  2162 00000E49 7503                <1> 	jnz	short lff24s_8
  2163 00000E4B E92AFB              <1> 	jmp	lff24_eof
  2164                              <1> 
  2165                              <1> lff24s_8:
  2166 00000E4E 89C1                <1> 	mov	cx, ax		; word count
  2167                              <1> lff24s_1:
  2168 00000E50 AC                  <1> 	lodsb
  2169 00000E51 A2[D019]            <1> 	mov	[previous_val_l], al
  2170 00000E54 2C80                <1> 	sub	al, 80h
  2171 00000E56 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2172 00000E59 AB                  <1> 	stosw		; original sample (L)
  2173 00000E5A AC                  <1> 	lodsb
  2174 00000E5B A2[D219]            <1> 	mov	[previous_val_r], al
  2175 00000E5E 2C80                <1> 	sub	al, 80h
  2176 00000E60 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2177 00000E63 AB                  <1> 	stosw		; original sample (R)
  2178                              <1> 
  2179                              <1> 	;xor	ax, ax
  2180 00000E64 B88080              <1> 	mov	ax, 8080h
  2181 00000E67 49                  <1> 	dec	cx
  2182 00000E68 7402                <1> 	jz	short lff24s_2
  2183                              <1> 		; convert 8 bit sample to 16 bit sample
  2184 00000E6A 8B04                <1> 	mov	ax, [si]
  2185                              <1> lff24s_2:
  2186                              <1> 	;;mov	[next_val_l], al
  2187                              <1> 	;;mov	[next_val_r], ah
  2188                              <1> 	;mov	bx, ax
  2189 00000E6C 88E7                <1> 	mov	bh, ah
  2190 00000E6E 0206[D019]          <1> 	add	al, [previous_val_l]
  2191 00000E72 D0D8                <1> 	rcr	al, 1
  2192                              <1> 	;mov	dl, al
  2193 00000E74 2C80                <1> 	sub	al, 80h
  2194 00000E76 C1E008              <1> 	shl	ax, 8
  2195 00000E79 AB                  <1> 	stosw		; this is interpolated sample (L)
  2196 00000E7A 88F8                <1> 	mov	al, bh	; [next_val_r]
  2197 00000E7C 0206[D219]          <1> 	add	al, [previous_val_r]
  2198 00000E80 D0D8                <1> 	rcr	al, 1
  2199                              <1> 	;mov	dh, al
  2200 00000E82 2C80                <1> 	sub	al, 80h
  2201 00000E84 C1E008              <1> 	shl	ax, 8
  2202 00000E87 AB                  <1> 	stosw		; this is interpolated sample (R)
  2203                              <1> 		
  2204                              <1> 	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2205 00000E88 09C9                <1> 	or	cx, cx
  2206 00000E8A 75C4                <1> 	jnz	short lff24s_1
  2207 00000E8C E9D6FA              <1> 	jmp	lff24_3
  2208                              <1> 
  2209                              <1> load_24khz_mono_16_bit:
  2210                              <1> 	; 15/11/2023
  2211 00000E8F F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2212                              <1> 					; last of the file?
  2213 00000E94 7402                <1> 	jz	short lff24m2_0		; no
  2214 00000E96 F9                  <1> 	stc
  2215 00000E97 C3                  <1> 	retn
  2216                              <1> 
  2217                              <1> lff24m2_0:
  2218 00000E98 8EC0                <1> 	mov	es, ax ; buffer segment	
  2219 00000E9A 31FF                <1> 	xor	di, di
  2220 00000E9C BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2221                              <1> 	; ds = cs
  2222                              <1> 
  2223                              <1> 	; load file into memory
  2224 00000E9F 8B0E[8706]          <1>         mov	cx, [loadsize]
  2225 00000EA3 8B1E[021E]          <1> 	mov	bx, [filehandle]
  2226 00000EA7 B43F                <1>        	mov	ah, 3Fh
  2227 00000EA9 CD21                <1> 	int	21h
  2228 00000EAB 7228                <1> 	jc	short lff24m2_7 ; error !
  2229                              <1> 
  2230 00000EAD 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2231                              <1> 	
  2232 00000EAF D1E8                <1> 	shr	ax, 1
  2233                              <1> 	;and	ax, ax
  2234 00000EB1 7503                <1> 	jnz	short lff24m2_8
  2235 00000EB3 E9C2FA              <1> 	jmp	lff24_eof
  2236                              <1> 
  2237                              <1> lff24m2_8:
  2238 00000EB6 89C1                <1> 	mov	cx, ax	; word count
  2239                              <1> lff24m2_1:
  2240 00000EB8 AD                  <1> 	lodsw
  2241 00000EB9 AB                  <1> 	stosw		; original sample (left channel)
  2242 00000EBA AB                  <1> 	stosw		; original sample (right channel)
  2243 00000EBB 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  2244                              <1> 	;mov	[previous_val], ax
  2245                              <1> 	;mov	bx, ax	
  2246                              <1> 	;xor	ax, ax
  2247 00000EBE 31DB                <1> 	xor	bx, bx
  2248 00000EC0 49                  <1> 	dec	cx
  2249 00000EC1 7402                <1> 	jz	short lff24m2_2
  2250                              <1> 	;mov	ax, [si
  2251 00000EC3 8B1C                <1> 	mov	bx, [si]
  2252                              <1> lff24m2_2:
  2253                              <1> 	;add	ah, 80h ; convert sound level 0 to 65535 format
  2254                              <1> 	;mov	bp, ax	; [next_val]
  2255                              <1> 	;add	ax, [previous_val]
  2256                              <1> 	; ax = [previous_val]
  2257                              <1> 	; bx = [next_val]
  2258 00000EC5 01D8                <1> 	add	ax, bx
  2259 00000EC7 D1D8                <1> 	rcr	ax, 1
  2260 00000EC9 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2261 00000ECC AB                  <1> 	stosw		; this is interpolated sample (L)
  2262 00000ECD AB                  <1> 	stosw		; this is interpolated sample (R)
  2263                              <1> 	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2264 00000ECE 09C9                <1> 	or	cx, cx
  2265 00000ED0 75E6                <1> 	jnz	short lff24m2_1
  2266 00000ED2 E990FA              <1> 	jmp	lff24_3
  2267                              <1> 
  2268                              <1> lff24m2_7:
  2269                              <1> lff24s2_7:
  2270 00000ED5 E9A7FA              <1> 	jmp	lff24_5  ; error
  2271                              <1> 
  2272                              <1> load_24khz_stereo_16_bit:
  2273                              <1> 	; 16/11/2023
  2274                              <1> 	; 15/11/2023
  2275 00000ED8 F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2276                              <1> 					; last of the file?
  2277 00000EDD 7402                <1> 	jz	short lff24s2_0		; no
  2278 00000EDF F9                  <1> 	stc
  2279 00000EE0 C3                  <1> 	retn
  2280                              <1> 
  2281                              <1> lff24s2_0:
  2282 00000EE1 8EC0                <1> 	mov	es, ax ; buffer segment	
  2283 00000EE3 31FF                <1> 	xor	di, di
  2284 00000EE5 BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2285                              <1> 	; ds = cs
  2286                              <1> 
  2287                              <1> 	; load file into memory
  2288 00000EE8 8B0E[8706]          <1>         mov	cx, [loadsize]
  2289 00000EEC 8B1E[021E]          <1> 	mov	bx, [filehandle]
  2290 00000EF0 B43F                <1>        	mov	ah, 3Fh
  2291 00000EF2 CD21                <1> 	int	21h
  2292 00000EF4 72DF                <1> 	jc	short lff24s2_7 ; error !
  2293                              <1> 
  2294 00000EF6 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2295                              <1> 	
  2296                              <1> 	;shr	ax, 1
  2297 00000EF8 C1E802              <1> 	shr	ax, 2	; 16/11/2023
  2298                              <1> 	;and	ax, ax
  2299 00000EFB 7503                <1> 	jnz	short lff24s2_8
  2300 00000EFD E978FA              <1> 	jmp	lff24_eof
  2301                              <1> 
  2302                              <1> lff24s2_8:
  2303 00000F00 89C1                <1> 	mov	cx, ax		; dword count
  2304                              <1> lff24s2_1:
  2305 00000F02 AD                  <1> 	lodsw
  2306 00000F03 AB                  <1> 	stosw		; original sample (L)
  2307 00000F04 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2308 00000F07 A3[D019]            <1> 	mov	[previous_val_l], ax
  2309 00000F0A AD                  <1> 	lodsw
  2310 00000F0B AB                  <1> 	stosw		; original sample (R)
  2311 00000F0C 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2312                              <1> 	;mov	[previous_val_r], ax
  2313 00000F0F 89C3                <1> 	mov	bx, ax
  2314 00000F11 31D2                <1> 	xor	dx, dx
  2315 00000F13 31C0                <1> 	xor	ax, ax
  2316                              <1> 	; 16/11/2023
  2317 00000F15 49                  <1> 	dec	cx
  2318 00000F16 7405                <1> 	jz	short lff24s2_2
  2319 00000F18 8B04                <1> 	mov	ax, [si]
  2320 00000F1A 8B5402              <1> 	mov	dx, [si+2]
  2321                              <1> lff24s2_2:
  2322 00000F1D 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2323                              <1> 	;;mov	[next_val_l], ax
  2324                              <1> 	;mov	bp, ax
  2325 00000F20 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format 
  2326                              <1> 	;mov	[next_val_r], dx
  2327 00000F23 0306[D019]          <1> 	add	ax, [previous_val_l]
  2328 00000F27 D1D8                <1> 	rcr	ax, 1
  2329 00000F29 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  2330 00000F2C AB                  <1> 	stosw		; this is interpolated sample (L)
  2331                              <1> 	;mov	ax, [next_val_r]
  2332 00000F2D 89D0                <1> 	mov	ax, dx
  2333                              <1> 	;add	ax, [previous_val_r]
  2334 00000F2F 01D8                <1> 	add	ax, bx
  2335 00000F31 D1D8                <1> 	rcr	ax, 1
  2336 00000F33 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2337 00000F36 AB                  <1> 	stosw		; this is interpolated sample (R)
  2338                              <1> 	
  2339                              <1> 	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2340 00000F37 09C9                <1> 	or	cx, cx
  2341 00000F39 75C7                <1> 	jnz	short lff24s2_1
  2342 00000F3B E927FA              <1> 	jmp	lff24_3
  2343                              <1> 
  2344                              <1> ; .....................
  2345                              <1> 
  2346                              <1> load_32khz_mono_8_bit:
  2347                              <1> 	; 15/11/2023
  2348 00000F3E F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2349                              <1> 					; last of the file?
  2350 00000F43 7402                <1> 	jz	short lff32m_0		; no
  2351 00000F45 F9                  <1> 	stc
  2352 00000F46 C3                  <1> 	retn
  2353                              <1> 
  2354                              <1> lff32m_0:
  2355 00000F47 8EC0                <1> 	mov	es, ax ; buffer segment	
  2356 00000F49 31FF                <1> 	xor	di, di
  2357 00000F4B BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2358                              <1> 	; ds = cs
  2359                              <1> 
  2360                              <1> 	; load file into memory
  2361 00000F4E 8B0E[8706]          <1>         mov	cx, [loadsize]
  2362 00000F52 8B1E[021E]          <1> 	mov	bx, [filehandle]
  2363 00000F56 B43F                <1>        	mov	ah, 3Fh
  2364 00000F58 CD21                <1> 	int	21h
  2365 00000F5A 7237                <1> 	jc	short lff32m_7 ; error !
  2366                              <1> 
  2367 00000F5C 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2368                              <1> 	
  2369 00000F5E 21C0                <1> 	and	ax, ax
  2370 00000F60 7503                <1> 	jnz	short lff32m_8
  2371 00000F62 E913FA              <1> 	jmp	lff32_eof
  2372                              <1> 
  2373                              <1> lff32m_8:
  2374 00000F65 89C1                <1> 	mov	cx, ax		; byte count
  2375                              <1> lff32m_1:
  2376 00000F67 AC                  <1> 	lodsb
  2377                              <1> 	;mov	[previous_val], al
  2378 00000F68 88C3                <1> 	mov	bl, al
  2379 00000F6A 2C80                <1> 	sub	al, 80h
  2380 00000F6C C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2381 00000F6F AB                  <1> 	stosw		; original sample (left channel)
  2382 00000F70 AB                  <1> 	stosw		; original sample (right channel)
  2383                              <1> 	;xor	ax, ax
  2384 00000F71 B080                <1> 	mov	al, 80h
  2385 00000F73 49                  <1> 	dec	cx
  2386 00000F74 7402                <1> 	jz	short lff32m_2
  2387 00000F76 8A04                <1> 	mov	al, [si]
  2388                              <1> lff32m_2:
  2389                              <1> 	;;mov	[next_val], al
  2390                              <1> 	;mov	bh, al
  2391                              <1> 	;add	al, [previous_val]
  2392 00000F78 00D8                <1> 	add	al, bl
  2393 00000F7A D0D8                <1> 	rcr	al, 1
  2394 00000F7C 2C80                <1> 	sub	al, 80h
  2395 00000F7E C1E008              <1> 	shl	ax, 8
  2396 00000F81 AB                  <1> 	stosw		; this is interpolated sample (L)
  2397 00000F82 AB                  <1> 	stosw		; this is interpolated sample (R)
  2398                              <1> 	
  2399                              <1> 	; different than 8-16-24 kHZ !
  2400                              <1> 	; 'original-interpolated-original' trio samples 
  2401 00000F83 E30B                <1> 	jcxz	lff32m_3
  2402                              <1> 
  2403 00000F85 AC                  <1> 	lodsb
  2404 00000F86 2C80                <1> 	sub	al, 80h
  2405 00000F88 C1E008              <1> 	shl	ax, 8
  2406 00000F8B AB                  <1> 	stosw		; original sample (left channel)
  2407 00000F8C AB                  <1> 	stosw		; original sample (right channel)
  2408                              <1> 
  2409                              <1> 	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2410 00000F8D 49                  <1> 	dec	cx
  2411 00000F8E 75D7                <1> 	jnz	short lff32m_1
  2412                              <1> lff32m_3:
  2413 00000F90 E9D2F9              <1> 	jmp	lff32_3
  2414                              <1> 
  2415                              <1> lff32m_7:
  2416                              <1> lff32s_7:
  2417 00000F93 E9E9F9              <1> 	jmp	lff32_5  ; error
  2418                              <1> 
  2419                              <1> load_32khz_stereo_8_bit:
  2420                              <1> 	; 15/11/2023
  2421 00000F96 F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2422                              <1> 					; last of the file?
  2423 00000F9B 7402                <1> 	jz	short lff32s_0		; no
  2424 00000F9D F9                  <1> 	stc
  2425 00000F9E C3                  <1> 	retn
  2426                              <1> 
  2427                              <1> lff32s_0:
  2428 00000F9F 8EC0                <1> 	mov	es, ax ; buffer segment	
  2429 00000FA1 31FF                <1> 	xor	di, di
  2430 00000FA3 BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2431                              <1> 	; ds = cs
  2432                              <1> 
  2433                              <1> 	; load file into memory
  2434 00000FA6 8B0E[8706]          <1>         mov	cx, [loadsize]
  2435 00000FAA 8B1E[021E]          <1> 	mov	bx, [filehandle]
  2436 00000FAE B43F                <1>        	mov	ah, 3Fh
  2437 00000FB0 CD21                <1> 	int	21h
  2438 00000FB2 72DF                <1> 	jc	short lff32s_7 ; error !
  2439                              <1> 
  2440 00000FB4 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2441                              <1> 	
  2442 00000FB6 D1E8                <1> 	shr	ax, 1
  2443                              <1> 	;and	ax, ax
  2444 00000FB8 7503                <1> 	jnz	short lff32s_8
  2445 00000FBA E9BBF9              <1> 	jmp	lff32_eof
  2446                              <1> 
  2447                              <1> lff32s_8:
  2448 00000FBD 89C1                <1> 	mov	cx, ax		; word count
  2449                              <1> lff32s_1:
  2450 00000FBF AC                  <1> 	lodsb
  2451 00000FC0 A2[D019]            <1> 	mov	[previous_val_l], al
  2452 00000FC3 2C80                <1> 	sub	al, 80h
  2453 00000FC5 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2454 00000FC8 AB                  <1> 	stosw		; original sample (L)
  2455 00000FC9 AC                  <1> 	lodsb
  2456 00000FCA A2[D219]            <1> 	mov	[previous_val_r], al
  2457 00000FCD 2C80                <1> 	sub	al, 80h
  2458 00000FCF C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2459 00000FD2 AB                  <1> 	stosw		; original sample (R)
  2460                              <1> 
  2461                              <1> 	;xor	ax, ax
  2462 00000FD3 B88080              <1> 	mov	ax, 8080h
  2463 00000FD6 49                  <1> 	dec	cx
  2464 00000FD7 7402                <1> 	jz	short lff32s_2
  2465                              <1> 		; convert 8 bit sample to 16 bit sample
  2466 00000FD9 8B04                <1> 	mov	ax, [si]
  2467                              <1> lff32s_2:
  2468                              <1> 	;;mov	[next_val_l], al
  2469                              <1> 	;;mov	[next_val_r], ah
  2470                              <1> 	;mov	bx, ax
  2471 00000FDB 88E7                <1> 	mov	bh, ah
  2472 00000FDD 0206[D019]          <1> 	add	al, [previous_val_l]
  2473 00000FE1 D0D8                <1> 	rcr	al, 1
  2474                              <1> 	;mov	dl, al
  2475 00000FE3 2C80                <1> 	sub	al, 80h
  2476 00000FE5 C1E008              <1> 	shl	ax, 8
  2477 00000FE8 AB                  <1> 	stosw		; this is interpolated sample (L)
  2478 00000FE9 88F8                <1> 	mov	al, bh	; [next_val_r]
  2479 00000FEB 0206[D219]          <1> 	add	al, [previous_val_r]
  2480 00000FEF D0D8                <1> 	rcr	al, 1
  2481                              <1> 	;mov	dh, al
  2482 00000FF1 2C80                <1> 	sub	al, 80h
  2483 00000FF3 C1E008              <1> 	shl	ax, 8
  2484 00000FF6 AB                  <1> 	stosw		; this is interpolated sample (R)
  2485                              <1> 
  2486                              <1> 	; different than 8-16-24 kHZ !
  2487                              <1> 	; 'original-interpolated-original' trio samples 
  2488 00000FF7 E311                <1> 	jcxz	lff32s_3
  2489                              <1> 
  2490 00000FF9 AC                  <1> 	lodsb
  2491 00000FFA 2C80                <1> 	sub	al, 80h
  2492 00000FFC C1E008              <1> 	shl	ax, 8
  2493 00000FFF AB                  <1> 	stosw		; original sample (left channel)
  2494                              <1> 
  2495 00001000 AC                  <1> 	lodsb
  2496 00001001 2C80                <1> 	sub	al, 80h
  2497 00001003 C1E008              <1> 	shl	ax, 8
  2498 00001006 AB                  <1> 	stosw		; original sample (right channel)
  2499                              <1> 		
  2500                              <1> 	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2501 00001007 49                  <1> 	dec	cx
  2502 00001008 75B5                <1> 	jnz	short lff32s_1
  2503                              <1> lff32s_3:
  2504 0000100A E958F9              <1> 	jmp	lff32_3
  2505                              <1> 
  2506                              <1> load_32khz_mono_16_bit:
  2507                              <1> 	; 15/11/2023
  2508 0000100D F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2509                              <1> 					; last of the file?
  2510 00001012 7402                <1> 	jz	short lff32m2_0		; no
  2511 00001014 F9                  <1> 	stc
  2512 00001015 C3                  <1> 	retn
  2513                              <1> 
  2514                              <1> lff32m2_0:
  2515 00001016 8EC0                <1> 	mov	es, ax ; buffer segment	
  2516 00001018 31FF                <1> 	xor	di, di
  2517 0000101A BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2518                              <1> 	; ds = cs
  2519                              <1> 
  2520                              <1> 	; load file into memory
  2521 0000101D 8B0E[8706]          <1>         mov	cx, [loadsize]
  2522 00001021 8B1E[021E]          <1> 	mov	bx, [filehandle]
  2523 00001025 B43F                <1>        	mov	ah, 3Fh
  2524 00001027 CD21                <1> 	int	21h
  2525 00001029 722C                <1> 	jc	short lff32m2_7 ; error !
  2526                              <1> 
  2527 0000102B 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2528                              <1> 	
  2529 0000102D D1E8                <1> 	shr	ax, 1
  2530                              <1> 	;and	ax, ax
  2531 0000102F 7503                <1> 	jnz	short lff32m2_8
  2532 00001031 E944F9              <1> 	jmp	lff32_eof
  2533                              <1> 
  2534                              <1> lff32m2_8:
  2535 00001034 89C1                <1> 	mov	cx, ax	; word count
  2536                              <1> lff32m2_1:
  2537 00001036 AD                  <1> 	lodsw
  2538 00001037 AB                  <1> 	stosw		; original sample (left channel)
  2539 00001038 AB                  <1> 	stosw		; original sample (right channel)
  2540 00001039 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  2541                              <1> 	;mov	[previous_val], ax
  2542                              <1> 	;mov	bx, ax	
  2543                              <1> 	;xor	ax, ax
  2544 0000103C 31DB                <1> 	xor	bx, bx
  2545 0000103E 49                  <1> 	dec	cx
  2546 0000103F 7402                <1> 	jz	short lff32m2_2
  2547                              <1> 	;mov	ax, [si
  2548 00001041 8B1C                <1> 	mov	bx, [si]
  2549                              <1> lff32m2_2:
  2550                              <1> 	;add	ah, 80h ; convert sound level 0 to 65535 format
  2551                              <1> 	;mov	bp, ax	; [next_val]
  2552                              <1> 	;add	ax, [previous_val]
  2553                              <1> 	; ax = [previous_val]
  2554                              <1> 	; bx = [next_val]
  2555 00001043 01D8                <1> 	add	ax, bx
  2556 00001045 D1D8                <1> 	rcr	ax, 1
  2557 00001047 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2558 0000104A AB                  <1> 	stosw		; this is interpolated sample (L)
  2559 0000104B AB                  <1> 	stosw		; this is interpolated sample (R)
  2560                              <1> 
  2561                              <1> 	; different than 8-16-24 kHZ !
  2562                              <1> 	; 'original-interpolated-original' trio samples 
  2563 0000104C E306                <1> 	jcxz	lff32m2_3
  2564                              <1> 
  2565 0000104E AD                  <1> 	lodsw
  2566 0000104F AB                  <1> 	stosw		; original sample (left channel)
  2567 00001050 AB                  <1> 	stosw		; original sample (right channel)
  2568                              <1> 
  2569                              <1> 	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2570 00001051 49                  <1> 	dec	cx
  2571 00001052 75E2                <1> 	jnz	short lff32m2_1
  2572                              <1> lff32m2_3:
  2573 00001054 E90EF9              <1> 	jmp	lff32_3
  2574                              <1> 
  2575                              <1> lff32m2_7:
  2576                              <1> lff32s2_7:
  2577 00001057 E925F9              <1> 	jmp	lff32_5  ; error
  2578                              <1> 
  2579                              <1> load_32khz_stereo_16_bit:
  2580                              <1> 	 ;16/11/2023
  2581                              <1> 	; 15/11/2023
  2582 0000105A F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2583                              <1> 					; last of the file?
  2584 0000105F 7402                <1> 	jz	short lff32s2_0		; no
  2585 00001061 F9                  <1> 	stc
  2586 00001062 C3                  <1> 	retn
  2587                              <1> 
  2588                              <1> lff32s2_0:
  2589 00001063 8EC0                <1> 	mov	es, ax ; buffer segment	
  2590 00001065 31FF                <1> 	xor	di, di
  2591 00001067 BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2592                              <1> 	; ds = cs
  2593                              <1> 
  2594                              <1> 	; load file into memory
  2595 0000106A 8B0E[8706]          <1>         mov	cx, [loadsize]
  2596 0000106E 8B1E[021E]          <1> 	mov	bx, [filehandle]
  2597 00001072 B43F                <1>        	mov	ah, 3Fh
  2598 00001074 CD21                <1> 	int	21h
  2599 00001076 72DF                <1> 	jc	short lff32s2_7 ; error !
  2600                              <1> 
  2601 00001078 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2602                              <1> 	
  2603 0000107A C1E802              <1> 	shr	ax, 2	; 16/11/2023 (word left ch + word right ch) 
  2604                              <1> 	;and	ax, ax
  2605 0000107D 7503                <1> 	jnz	short lff32s2_8
  2606 0000107F E9F6F8              <1> 	jmp	lff32_eof
  2607                              <1> 
  2608                              <1> lff32s2_8:
  2609 00001082 89C1                <1> 	mov	cx, ax		; dword count
  2610                              <1> lff32s2_1:
  2611 00001084 AD                  <1> 	lodsw
  2612 00001085 AB                  <1> 	stosw		; original sample (L)
  2613 00001086 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2614 00001089 A3[D019]            <1> 	mov	[previous_val_l], ax
  2615 0000108C AD                  <1> 	lodsw
  2616 0000108D AB                  <1> 	stosw		; original sample (R)
  2617 0000108E 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2618                              <1> 	;mov	[previous_val_r], ax
  2619 00001091 89C3                <1> 	mov	bx, ax
  2620 00001093 31D2                <1> 	xor	dx, dx
  2621 00001095 31C0                <1> 	xor	ax, ax
  2622                              <1> 	; 16/11/2023
  2623 00001097 49                  <1> 	dec	cx
  2624 00001098 7405                <1> 	jz	short lff32s2_2
  2625 0000109A 8B04                <1> 	mov	ax, [si]
  2626 0000109C 8B5402              <1> 	mov	dx, [si+2]
  2627                              <1> lff32s2_2:
  2628 0000109F 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2629                              <1> 	;;mov	[next_val_l], ax
  2630                              <1> 	;mov	bp, ax
  2631 000010A2 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format 
  2632                              <1> 	;mov	[next_val_r], dx
  2633 000010A5 0306[D019]          <1> 	add	ax, [previous_val_l]
  2634 000010A9 D1D8                <1> 	rcr	ax, 1
  2635 000010AB 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  2636 000010AE AB                  <1> 	stosw		; this is interpolated sample (L)
  2637                              <1> 	;mov	ax, [next_val_r]
  2638 000010AF 89D0                <1> 	mov	ax, dx
  2639                              <1> 	;add	ax, [previous_val_r]
  2640 000010B1 01D8                <1> 	add	ax, bx
  2641 000010B3 D1D8                <1> 	rcr	ax, 1
  2642 000010B5 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2643 000010B8 AB                  <1> 	stosw		; this is interpolated sample (R)
  2644                              <1> 
  2645                              <1> 	; different than 8-16-24 kHZ !
  2646                              <1> 	; 'original-interpolated-original' trio samples 
  2647 000010B9 E307                <1> 	jcxz	lff32s2_3
  2648                              <1> 
  2649 000010BB AD                  <1> 	lodsw
  2650 000010BC AB                  <1> 	stosw	; original sample (L)
  2651 000010BD AD                  <1> 	lodsw
  2652 000010BE AB                  <1> 	stosw	; original sample (R)
  2653                              <1> 	
  2654                              <1> 	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2655 000010BF 49                  <1> 	dec	cx
  2656 000010C0 75C2                <1> 	jnz	short lff32s2_1
  2657                              <1> lff32s2_3:
  2658 000010C2 E9A0F8              <1> 	jmp	lff32_3
  2659                              <1> 
  2660                              <1> ; .....................
  2661                              <1> 
  2662                              <1> load_22khz_mono_8_bit:
  2663                              <1> 	; 16/11/2023
  2664 000010C5 F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2665                              <1> 					; last of the file?
  2666 000010CA 7402                <1> 	jz	short lff22m_0		; no
  2667 000010CC F9                  <1> 	stc
  2668 000010CD C3                  <1> 	retn
  2669                              <1> 
  2670                              <1> lff22m_0:
  2671 000010CE 8EC0                <1> 	mov	es, ax ; buffer segment	
  2672 000010D0 31FF                <1> 	xor	di, di
  2673 000010D2 BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2674                              <1> 	; ds = cs
  2675                              <1> 
  2676                              <1> 	; load file into memory
  2677 000010D5 8B0E[8706]          <1>         mov	cx, [loadsize]
  2678 000010D9 8B1E[021E]          <1> 	mov	bx, [filehandle]
  2679 000010DD B43F                <1>        	mov	ah, 3Fh
  2680 000010DF CD21                <1> 	int	21h
  2681 000010E1 7248                <1> 	jc	short lff22m_7 ; error !
  2682                              <1> 
  2683 000010E3 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2684                              <1> 	
  2685 000010E5 21C0                <1> 	and	ax, ax
  2686 000010E7 7503                <1> 	jnz	short lff22m_8
  2687 000010E9 E98CF8              <1> 	jmp	lff22_eof
  2688                              <1> 
  2689                              <1> lff22m_8:
  2690 000010EC 89C1                <1> 	mov	cx, ax		; byte count
  2691                              <1> lff22m_9:
  2692 000010EE BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2693 000010F1 C606[D819]03        <1> 	mov	byte [faz], 3  ; 3 steps/phases
  2694                              <1> lff22m_1:
  2695                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2696 000010F6 AC                  <1> 	lodsb
  2697 000010F7 B280                <1> 	mov	dl, 80h
  2698 000010F9 49                  <1> 	dec	cx
  2699 000010FA 7402                <1> 	jz	short lff22m_2_1
  2700 000010FC 8A14                <1> 	mov	dl, [si]
  2701                              <1> lff22m_2_1:	
  2702                              <1> 	; al = [previous_val]
  2703                              <1> 	; dl = [next_val]
  2704 000010FE E8A004              <1> 	call	interpolating_3_8bit_mono ; 1 of 17
  2705 00001101 E325                <1> 	jcxz	lff22m_3
  2706                              <1> lff22m_2_2:
  2707 00001103 AC                  <1> 	lodsb
  2708 00001104 B280                <1> 	mov	dl, 80h
  2709 00001106 49                  <1> 	dec	cx
  2710 00001107 7402                <1> 	jz	short lff22m_2_3
  2711 00001109 8A14                <1> 	mov	dl, [si]
  2712                              <1> lff22m_2_3:
  2713 0000110B E80205              <1>  	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  2714 0000110E E318                <1> 	jcxz	lff22m_3
  2715 00001110 4D                  <1> 	dec	bp
  2716 00001111 75F0                <1> 	jnz	short lff22m_2_2
  2717                              <1> 
  2718 00001113 A0[D819]            <1> 	mov	al, [faz]
  2719 00001116 FEC8                <1> 	dec	al
  2720 00001118 74D4                <1> 	jz	short lff22m_9
  2721 0000111A FE0E[D819]          <1> 	dec	byte [faz]
  2722 0000111E BD0400              <1> 	mov	bp, 4
  2723 00001121 FEC8                <1> 	dec	al
  2724 00001123 75D1                <1> 	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  2725 00001125 45                  <1> 	inc	bp ; 5
  2726 00001126 EBCE                <1> 	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2727                              <1> 
  2728                              <1> lff22m_3:
  2729                              <1> lff22s_3:
  2730 00001128 E93AF8              <1> 	jmp	lff22_3	; padfill
  2731                              <1> 		; (put zeros in the remain words of the buffer)
  2732                              <1> lff22m_7:
  2733                              <1> lff22s_7:
  2734 0000112B E951F8              <1> 	jmp	lff22_5  ; error
  2735                              <1> 
  2736                              <1> load_22khz_stereo_8_bit:
  2737                              <1> 	; 16/11/2023
  2738 0000112E F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2739                              <1> 					; last of the file?
  2740 00001133 7402                <1> 	jz	short lff22s_0		; no
  2741 00001135 F9                  <1> 	stc
  2742 00001136 C3                  <1> 	retn
  2743                              <1> 
  2744                              <1> lff22s_0:
  2745 00001137 8EC0                <1> 	mov	es, ax ; buffer segment	
  2746 00001139 31FF                <1> 	xor	di, di
  2747 0000113B BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2748                              <1> 	; ds = cs
  2749                              <1> 
  2750                              <1> 	; load file into memory
  2751 0000113E 8B0E[8706]          <1>         mov	cx, [loadsize]
  2752 00001142 8B1E[021E]          <1> 	mov	bx, [filehandle]
  2753 00001146 B43F                <1>        	mov	ah, 3Fh
  2754 00001148 CD21                <1> 	int	21h
  2755 0000114A 72DF                <1> 	jc	short lff22s_7 ; error !
  2756                              <1> 
  2757 0000114C 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2758                              <1> 	
  2759 0000114E D1E8                <1> 	shr	ax, 1
  2760                              <1> 	;and	ax, ax
  2761 00001150 7503                <1> 	jnz	short lff22s_8
  2762 00001152 E923F8              <1> 	jmp	lff22_eof
  2763                              <1> 
  2764                              <1> lff22s_8:
  2765 00001155 89C1                <1> 	mov	cx, ax		; word count
  2766                              <1> lff22s_9:
  2767 00001157 BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2768 0000115A C606[D819]03        <1> 	mov	byte [faz], 3  ; 3 steps/phase
  2769                              <1> lff22s_1:
  2770                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2771 0000115F AD                  <1> 	lodsw
  2772 00001160 BA8080              <1> 	mov	dx, 8080h
  2773 00001163 49                  <1> 	dec	cx
  2774 00001164 7402                <1> 	jz	short lff22s_2_1 
  2775 00001166 8B14                <1> 	mov	dx, [si]
  2776                              <1> lff22s_2_1:	
  2777                              <1> 	; al = [previous_val_l]
  2778                              <1> 	; ah = [previous_val_r]
  2779                              <1> 	; dl = [next_val_l]
  2780                              <1> 	; dl = [next_val_r]	
  2781 00001168 E85E04              <1> 	call	interpolating_3_8bit_stereo ; 1 of 17 
  2782 0000116B E3BB                <1> 	jcxz	lff22s_3
  2783                              <1> lff22s_2_2:
  2784 0000116D AD                  <1> 	lodsw
  2785 0000116E BA8080              <1> 	mov	dx, 8080h
  2786 00001171 49                  <1> 	dec	cx
  2787 00001172 7402                <1> 	jz	short lff22s_2_3
  2788 00001174 8B14                <1> 	mov	dx, [si]
  2789                              <1> lff22s_2_3:
  2790 00001176 E8AE04              <1>  	call	interpolating_2_8bit_stereo ; 2 of 17 .. 6 of 17
  2791 00001179 E3AD                <1> 	jcxz	lff22s_3
  2792 0000117B 4D                  <1> 	dec	bp
  2793 0000117C 75EF                <1> 	jnz	short lff22s_2_2
  2794                              <1> 
  2795 0000117E A0[D819]            <1> 	mov	al, [faz]
  2796 00001181 FEC8                <1> 	dec	al
  2797 00001183 74D2                <1> 	jz	short lff22s_9
  2798 00001185 FE0E[D819]          <1> 	dec	byte [faz]
  2799 00001189 BD0400              <1> 	mov	bp, 4
  2800 0000118C FEC8                <1> 	dec	al
  2801 0000118E 75CF                <1> 	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  2802 00001190 45                  <1> 	inc	bp ; 5
  2803 00001191 EBCC                <1> 	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2804                              <1> 
  2805                              <1> load_22khz_mono_16_bit:
  2806                              <1> 	; 16/11/2023
  2807 00001193 F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2808                              <1> 					; last of the file?
  2809 00001198 7402                <1> 	jz	short lff22m2_0		; no
  2810 0000119A F9                  <1> 	stc
  2811 0000119B C3                  <1> 	retn
  2812                              <1> 
  2813                              <1> lff22m2_0:
  2814 0000119C 8EC0                <1> 	mov	es, ax ; buffer segment	
  2815 0000119E 31FF                <1> 	xor	di, di
  2816 000011A0 BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2817                              <1> 	; ds = cs
  2818                              <1> 
  2819                              <1> 	; load file into memory
  2820 000011A3 8B0E[8706]          <1>         mov	cx, [loadsize]
  2821 000011A7 8B1E[021E]          <1> 	mov	bx, [filehandle]
  2822 000011AB B43F                <1>        	mov	ah, 3Fh
  2823 000011AD CD21                <1> 	int	21h
  2824 000011AF 7248                <1> 	jc	short lff22m2_7 ; error !
  2825                              <1> 
  2826 000011B1 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2827                              <1> 	
  2828 000011B3 D1E8                <1> 	shr	ax, 1
  2829                              <1> 	;and	ax, ax
  2830 000011B5 7503                <1> 	jnz	short lff22m2_8
  2831 000011B7 E9BEF7              <1> 	jmp	lff22_eof
  2832                              <1> 
  2833                              <1> lff22m2_8:
  2834 000011BA 89C1                <1> 	mov	cx, ax		; word count
  2835                              <1> lff22m2_9:
  2836 000011BC BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2837 000011BF C606[D819]03        <1> 	mov	byte [faz], 3  ; 3 steps/phases
  2838                              <1> lff22m2_1:
  2839                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2840 000011C4 AD                  <1> 	lodsw
  2841 000011C5 31D2                <1> 	xor	dx, dx
  2842 000011C7 49                  <1> 	dec	cx
  2843 000011C8 7402                <1> 	jz	short lff22m2_2_1
  2844 000011CA 8B14                <1> 	mov	dx, [si]
  2845                              <1> lff22m2_2_1:	
  2846                              <1> 	; ax = [previous_val]
  2847                              <1> 	; dx = [next_val]
  2848 000011CC E88104              <1> 	call	interpolating_3_16bit_mono ; 1 of 17
  2849 000011CF E325                <1> 	jcxz	lff22m2_3
  2850                              <1> lff22m2_2_2:
  2851 000011D1 AD                  <1> 	lodsw
  2852 000011D2 31D2                <1> 	xor	dx, dx
  2853 000011D4 49                  <1> 	dec	cx
  2854 000011D5 7402                <1> 	jz	short lff22m2_2_3
  2855 000011D7 8B14                <1> 	mov	dx, [si]
  2856                              <1> lff22m2_2_3:
  2857 000011D9 E8E104              <1>  	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  2858 000011DC E318                <1> 	jcxz	lff22m2_3
  2859 000011DE 4D                  <1> 	dec	bp
  2860 000011DF 75F0                <1> 	jnz	short lff22m2_2_2
  2861                              <1> 
  2862 000011E1 A0[D819]            <1> 	mov	al, [faz]
  2863 000011E4 FEC8                <1> 	dec	al
  2864 000011E6 74D4                <1> 	jz	short lff22m2_9
  2865 000011E8 FE0E[D819]          <1> 	dec	byte [faz]
  2866 000011EC BD0400              <1> 	mov	bp, 4
  2867 000011EF FEC8                <1> 	dec	al
  2868 000011F1 75D1                <1> 	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2869 000011F3 45                  <1> 	inc	bp ; 5
  2870 000011F4 EBCE                <1> 	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2871                              <1> 
  2872                              <1> lff22m2_3:
  2873                              <1> lff22s2_3:
  2874 000011F6 E96CF7              <1> 	jmp	lff22_3	; padfill
  2875                              <1> 		; (put zeros in the remain words of the buffer)
  2876                              <1> lff22m2_7:
  2877                              <1> lff22s2_7:
  2878 000011F9 E983F7              <1> 	jmp	lff22_5  ; error
  2879                              <1> 
  2880                              <1> load_22khz_stereo_16_bit:
  2881                              <1> 	; 16/11/2023
  2882 000011FC F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2883                              <1> 					; last of the file?
  2884 00001201 7402                <1> 	jz	short lff22s2_0		; no
  2885 00001203 F9                  <1> 	stc
  2886 00001204 C3                  <1> 	retn
  2887                              <1> 
  2888                              <1> lff22s2_0:
  2889 00001205 8EC0                <1> 	mov	es, ax ; buffer segment	
  2890 00001207 31FF                <1> 	xor	di, di
  2891 00001209 BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2892                              <1> 	; ds = cs
  2893                              <1> 
  2894                              <1> 	; load file into memory
  2895 0000120C 8B0E[8706]          <1>         mov	cx, [loadsize]
  2896 00001210 8B1E[021E]          <1> 	mov	bx, [filehandle]
  2897 00001214 B43F                <1>        	mov	ah, 3Fh
  2898 00001216 CD21                <1> 	int	21h
  2899 00001218 72DF                <1> 	jc	short lff22s2_7 ; error !
  2900                              <1> 
  2901 0000121A 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2902                              <1> 	
  2903 0000121C C1E802              <1> 	shr	ax, 2	; dword (left chan word + right chan word)
  2904                              <1> 	;and	ax, ax
  2905 0000121F 7503                <1> 	jnz	short lff22s2_8
  2906 00001221 E954F7              <1> 	jmp	lff22_eof
  2907                              <1> 
  2908                              <1> lff22s2_8:
  2909 00001224 89C1                <1> 	mov	cx, ax		; dword count
  2910                              <1> lff22s2_9:
  2911 00001226 BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2912 00001229 C606[D819]03        <1> 	mov	byte [faz], 3  ; 3 steps/phase
  2913                              <1> lff22s2_1:
  2914                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2915 0000122E AD                  <1> 	lodsw
  2916 0000122F 89C3                <1> 	mov	bx, ax
  2917 00001231 AD                  <1> 	lodsw
  2918 00001232 8B14                <1> 	mov	dx, [si]
  2919 00001234 8916[D419]          <1> 	mov	[next_val_l], dx
  2920 00001238 8B5402              <1> 	mov	dx, [si+2]
  2921 0000123B 49                  <1> 	dec	cx
  2922 0000123C 7506                <1> 	jnz	short lff22s2_2_1
  2923 0000123E 31D2                <1> 	xor	dx, dx ; 0
  2924 00001240 8916[D419]          <1> 	mov	[next_val_l], dx
  2925                              <1> lff22s2_2_1:
  2926                              <1> 	; bx = [previous_val_l]
  2927                              <1> 	; ax = [previous_val_r]
  2928                              <1> 	; [next_val_l]
  2929                              <1> 	; dx = [next_val_r]
  2930 00001244 E82D04              <1> 	call	interpolating_3_16bit_stereo ; 1 of 17 
  2931 00001247 E3AD                <1> 	jcxz	lff22s2_3
  2932                              <1> lff22s2_2_2:
  2933 00001249 AD                  <1> 	lodsw
  2934 0000124A 89C3                <1> 	mov	bx, ax
  2935 0000124C AD                  <1> 	lodsw
  2936 0000124D 8B14                <1> 	mov	dx, [si]
  2937 0000124F 8916[D419]          <1> 	mov	[next_val_l], dx
  2938 00001253 8B5402              <1> 	mov	dx, [si+2]
  2939 00001256 49                  <1> 	dec	cx
  2940 00001257 7506                <1> 	jnz	short lff22s2_2_3
  2941 00001259 31D2                <1> 	xor	dx, dx ; 0
  2942 0000125B 8916[D419]          <1> 	mov	[next_val_l], dx
  2943                              <1> lff22s2_2_3:
  2944 0000125F E86D04              <1>  	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  2945 00001262 E392                <1> 	jcxz	lff22s2_3
  2946 00001264 4D                  <1> 	dec	bp
  2947 00001265 75E2                <1> 	jnz	short lff22s2_2_2
  2948                              <1> 
  2949 00001267 A0[D819]            <1> 	mov	al, [faz]
  2950 0000126A FEC8                <1> 	dec	al
  2951 0000126C 74B8                <1> 	jz	short lff22s2_9
  2952 0000126E FE0E[D819]          <1> 	dec	byte [faz]
  2953 00001272 BD0400              <1> 	mov	bp, 4
  2954 00001275 FEC8                <1> 	dec	al
  2955 00001277 75B5                <1> 	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2956 00001279 45                  <1> 	inc	bp ; 5
  2957 0000127A EBB2                <1> 	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2958                              <1> 
  2959                              <1> ; .....................
  2960                              <1> 
  2961                              <1> load_11khz_mono_8_bit:
  2962                              <1> 	; 18/11/2023
  2963 0000127C F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2964                              <1> 					; last of the file?
  2965 00001281 7402                <1> 	jz	short lff11m_0		; no
  2966 00001283 F9                  <1> 	stc
  2967 00001284 C3                  <1> 	retn
  2968                              <1> 
  2969                              <1> lff11m_0:
  2970 00001285 8EC0                <1> 	mov	es, ax ; buffer segment	
  2971 00001287 31FF                <1> 	xor	di, di
  2972 00001289 BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2973                              <1> 	; ds = cs
  2974                              <1> 
  2975                              <1> 	; load file into memory
  2976 0000128C 8B0E[8706]          <1>         mov	cx, [loadsize]
  2977 00001290 8B1E[021E]          <1> 	mov	bx, [filehandle]
  2978 00001294 B43F                <1>        	mov	ah, 3Fh
  2979 00001296 CD21                <1> 	int	21h
  2980 00001298 723D                <1> 	jc	short lff11m_7 ; error !
  2981                              <1> 
  2982 0000129A 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2983                              <1> 	
  2984 0000129C 21C0                <1> 	and	ax, ax
  2985 0000129E 7503                <1> 	jnz	short lff11m_8
  2986 000012A0 E9D5F6              <1> 	jmp	lff11_eof
  2987                              <1> 
  2988                              <1> lff11m_8:
  2989 000012A3 89C1                <1> 	mov	cx, ax		; byte count
  2990                              <1> lff11m_9:
  2991 000012A5 BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  2992                              <1> lff11m_1:
  2993                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  2994 000012A8 AC                  <1> 	lodsb
  2995 000012A9 B280                <1> 	mov	dl, 80h
  2996 000012AB 49                  <1> 	dec	cx
  2997 000012AC 7402                <1> 	jz	short lff11m_2_1
  2998 000012AE 8A14                <1> 	mov	dl, [si]
  2999                              <1> lff11m_2_1:	
  3000                              <1> 	; al = [previous_val]
  3001                              <1> 	; dl = [next_val]
  3002 000012B0 E84204              <1> 	call	interpolating_5_8bit_mono
  3003 000012B3 E31F                <1> 	jcxz	lff11m_3
  3004                              <1> lff11m_2_2:
  3005 000012B5 AC                  <1> 	lodsb
  3006 000012B6 B280                <1> 	mov	dl, 80h
  3007 000012B8 49                  <1> 	dec	cx
  3008 000012B9 7402                <1> 	jz	short lff11m_2_3
  3009 000012BB 8A14                <1> 	mov	dl, [si]
  3010                              <1> lff11m_2_3:
  3011 000012BD E81E05              <1>  	call	interpolating_4_8bit_mono
  3012 000012C0 E312                <1> 	jcxz	lff11m_3
  3013                              <1> 
  3014 000012C2 4D                  <1> 	dec	bp
  3015 000012C3 74E0                <1> 	jz	short lff11m_9
  3016                              <1> 
  3017 000012C5 AC                  <1> 	lodsb
  3018 000012C6 B280                <1> 	mov	dl, 80h
  3019 000012C8 49                  <1> 	dec	cx
  3020 000012C9 7402                <1> 	jz	short lff11m_2_4
  3021 000012CB 8A14                <1> 	mov	dl, [si]
  3022                              <1> lff11m_2_4:
  3023 000012CD E80E05              <1> 	call	interpolating_4_8bit_mono
  3024 000012D0 E302                <1> 	jcxz	lff11m_3
  3025 000012D2 EBD4                <1> 	jmp	short lff11m_1
  3026                              <1> 
  3027                              <1> lff11m_3:
  3028                              <1> lff11s_3:
  3029 000012D4 E98EF6              <1> 	jmp	lff11_3	; padfill
  3030                              <1> 		; (put zeros in the remain words of the buffer)
  3031                              <1> lff11m_7:
  3032                              <1> lff11s_7:
  3033 000012D7 E9A5F6              <1> 	jmp	lff11_5  ; error
  3034                              <1> 
  3035                              <1> load_11khz_stereo_8_bit:
  3036                              <1> 	; 18/11/2023
  3037 000012DA F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3038                              <1> 					; last of the file?
  3039 000012DF 7402                <1> 	jz	short lff11s_0		; no
  3040 000012E1 F9                  <1> 	stc
  3041 000012E2 C3                  <1> 	retn
  3042                              <1> 
  3043                              <1> lff11s_0:
  3044 000012E3 8EC0                <1> 	mov	es, ax ; buffer segment	
  3045 000012E5 31FF                <1> 	xor	di, di
  3046 000012E7 BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3047                              <1> 	; ds = cs
  3048                              <1> 
  3049                              <1> 	; load file into memory
  3050 000012EA 8B0E[8706]          <1>         mov	cx, [loadsize]
  3051 000012EE 8B1E[021E]          <1> 	mov	bx, [filehandle]
  3052 000012F2 B43F                <1>        	mov	ah, 3Fh
  3053 000012F4 CD21                <1> 	int	21h
  3054 000012F6 72DF                <1> 	jc	short lff11s_7 ; error !
  3055                              <1> 
  3056 000012F8 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3057                              <1> 	
  3058 000012FA D1E8                <1> 	shr	ax, 1
  3059                              <1> 	;and	ax, ax
  3060 000012FC 7503                <1> 	jnz	short lff11s_8
  3061 000012FE E977F6              <1> 	jmp	lff11_eof
  3062                              <1> 
  3063                              <1> lff11s_8:
  3064 00001301 89C1                <1> 	mov	cx, ax		; word count
  3065                              <1> lff11s_9:
  3066 00001303 BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  3067                              <1> lff11s_1:
  3068                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3069 00001306 AD                  <1> 	lodsw
  3070 00001307 BA8080              <1> 	mov	dx, 8080h
  3071 0000130A 49                  <1> 	dec	cx
  3072 0000130B 7402                <1> 	jz	short lff11s_2_1 
  3073 0000130D 8B14                <1> 	mov	dx, [si]
  3074                              <1> lff11s_2_1:	
  3075                              <1> 	; al = [previous_val_l]
  3076                              <1> 	; ah = [previous_val_r]
  3077                              <1> 	; dl = [next_val_l]
  3078                              <1> 	; dl = [next_val_r]	
  3079 0000130F E83304              <1> 	call	interpolating_5_8bit_stereo
  3080 00001312 E3C0                <1> 	jcxz	lff11s_3
  3081                              <1> lff11s_2_2:
  3082 00001314 AD                  <1> 	lodsw
  3083 00001315 BA8080              <1> 	mov	dx, 8080h
  3084 00001318 49                  <1> 	dec	cx
  3085 00001319 7402                <1> 	jz	short lff11s_2_3
  3086 0000131B 8B14                <1> 	mov	dx, [si]
  3087                              <1> lff11s_2_3:
  3088 0000131D E8F104              <1>  	call	interpolating_4_8bit_stereo
  3089 00001320 E3B2                <1> 	jcxz	lff11s_3
  3090                              <1> 	
  3091 00001322 4D                  <1> 	dec	bp
  3092 00001323 74DE                <1> 	jz	short lff11s_9
  3093                              <1> 
  3094 00001325 AD                  <1> 	lodsw
  3095 00001326 BA8080              <1> 	mov	dx, 8080h
  3096 00001329 49                  <1> 	dec	cx
  3097 0000132A 7402                <1> 	jz	short lff11s_2_4
  3098 0000132C 8B14                <1> 	mov	dx, [si]
  3099                              <1> lff11s_2_4:
  3100 0000132E E8E004              <1> 	call	interpolating_4_8bit_stereo
  3101 00001331 E3A1                <1> 	jcxz	lff11s_3
  3102 00001333 EBD1                <1> 	jmp	short lff11s_1
  3103                              <1> 
  3104                              <1> load_11khz_mono_16_bit:
  3105                              <1> 	; 18/11/2023
  3106 00001335 F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3107                              <1> 					; last of the file?
  3108 0000133A 7402                <1> 	jz	short lff11m2_0		; no
  3109 0000133C F9                  <1> 	stc
  3110 0000133D C3                  <1> 	retn
  3111                              <1> 
  3112                              <1> lff11m2_0:
  3113 0000133E 8EC0                <1> 	mov	es, ax ; buffer segment	
  3114 00001340 31FF                <1> 	xor	di, di
  3115 00001342 BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3116                              <1> 	; ds = cs
  3117                              <1> 
  3118                              <1> 	; load file into memory
  3119 00001345 8B0E[8706]          <1>         mov	cx, [loadsize]
  3120 00001349 8B1E[021E]          <1> 	mov	bx, [filehandle]
  3121 0000134D B43F                <1>        	mov	ah, 3Fh
  3122 0000134F CD21                <1> 	int	21h
  3123 00001351 723A                <1> 	jc	short lff11m2_7 ; error !
  3124                              <1> 
  3125 00001353 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3126                              <1> 	
  3127 00001355 D1E8                <1> 	shr	ax, 1
  3128                              <1> 	;and	ax, ax
  3129 00001357 7503                <1> 	jnz	short lff11m2_8
  3130 00001359 E91CF6              <1> 	jmp	lff11_eof
  3131                              <1> 
  3132                              <1> lff11m2_8:
  3133 0000135C 89C1                <1> 	mov	cx, ax		; word count
  3134                              <1> lff11m2_9:
  3135 0000135E BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  3136                              <1> lff11m2_1:
  3137                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3138 00001361 AD                  <1> 	lodsw
  3139 00001362 31D2                <1> 	xor	dx, dx
  3140 00001364 49                  <1> 	dec	cx
  3141 00001365 7402                <1> 	jz	short lff11m2_2_1
  3142 00001367 8B14                <1> 	mov	dx, [si]
  3143                              <1> lff11m2_2_1:	
  3144                              <1> 	; ax = [previous_val]
  3145                              <1> 	; dx = [next_val]
  3146 00001369 E80205              <1> 	call	interpolating_5_16bit_mono
  3147 0000136C E34A                <1> 	jcxz	lff11m2_3
  3148                              <1> lff11m2_2_2:
  3149 0000136E AD                  <1> 	lodsw
  3150 0000136F 31D2                <1> 	xor	dx, dx
  3151 00001371 49                  <1> 	dec	cx
  3152 00001372 7402                <1> 	jz	short lff11m2_2_3
  3153 00001374 8B14                <1> 	mov	dx, [si]
  3154                              <1> lff11m2_2_3:
  3155 00001376 E8D005              <1>  	call	interpolating_4_16bit_mono
  3156 00001379 E33D                <1> 	jcxz	lff11m2_3
  3157                              <1> 
  3158 0000137B 4D                  <1> 	dec	bp
  3159 0000137C 74E0                <1> 	jz	short lff11m2_9
  3160                              <1> 
  3161 0000137E AD                  <1> 	lodsw
  3162 0000137F 31D2                <1> 	xor	dx, dx
  3163 00001381 49                  <1> 	dec	cx
  3164 00001382 7402                <1> 	jz	short lff11m2_2_4
  3165 00001384 8B14                <1> 	mov	dx, [si]
  3166                              <1> lff11m2_2_4:
  3167 00001386 E8C005              <1>  	call	interpolating_4_16bit_mono
  3168 00001389 E32D                <1> 	jcxz	lff11m2_3
  3169 0000138B EBD4                <1> 	jmp	short lff11m2_1
  3170                              <1> 
  3171                              <1> lff11m2_7:
  3172                              <1> lff11s2_7:
  3173 0000138D E9EFF5              <1> 	jmp	lff11_5  ; error
  3174                              <1> 
  3175                              <1> load_11khz_stereo_16_bit:
  3176                              <1> 	; 18/11/2023
  3177 00001390 F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3178                              <1> 					; last of the file?
  3179 00001395 7402                <1> 	jz	short lff11s2_0		; no
  3180 00001397 F9                  <1> 	stc
  3181 00001398 C3                  <1> 	retn
  3182                              <1> 
  3183                              <1> lff11s2_0:
  3184 00001399 8EC0                <1> 	mov	es, ax ; buffer segment	
  3185 0000139B 31FF                <1> 	xor	di, di
  3186 0000139D BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3187                              <1> 	; ds = cs
  3188                              <1> 
  3189                              <1> 	; load file into memory
  3190 000013A0 8B0E[8706]          <1>         mov	cx, [loadsize]
  3191 000013A4 8B1E[021E]          <1> 	mov	bx, [filehandle]
  3192 000013A8 B43F                <1>        	mov	ah, 3Fh
  3193 000013AA CD21                <1> 	int	21h
  3194 000013AC 72DF                <1> 	jc	short lff11s2_7 ; error !
  3195                              <1> 
  3196 000013AE 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3197                              <1> 	
  3198 000013B0 C1E802              <1> 	shr	ax, 2	; dword (left chan word + right chan word)
  3199                              <1> 	;and	ax, ax
  3200 000013B3 7506                <1> 	jnz	short lff11s2_8
  3201 000013B5 E9C0F5              <1> 	jmp	lff11_eof
  3202                              <1> 
  3203                              <1> lff11m2_3:
  3204                              <1> lff11s2_3:
  3205 000013B8 E9AAF5              <1> 	jmp	lff11_3	; padfill
  3206                              <1> 		; (put zeros in the remain words of the buffer)
  3207                              <1> 
  3208                              <1> lff11s2_8:
  3209 000013BB 89C1                <1> 	mov	cx, ax		; dword count
  3210                              <1> lff11s2_9:
  3211 000013BD BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  3212                              <1> lff11s2_1:
  3213                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3214 000013C0 AD                  <1> 	lodsw
  3215 000013C1 89C3                <1> 	mov	bx, ax
  3216 000013C3 AD                  <1> 	lodsw
  3217 000013C4 8B14                <1> 	mov	dx, [si]
  3218 000013C6 8916[D419]          <1> 	mov	[next_val_l], dx
  3219 000013CA 8B5402              <1> 	mov	dx, [si+2]
  3220 000013CD 8916[D619]          <1> 	mov	[next_val_r], dx
  3221 000013D1 49                  <1> 	dec	cx
  3222 000013D2 750A                <1> 	jnz	short lff11s2_2_1
  3223 000013D4 31D2                <1> 	xor	dx, dx ; 0
  3224 000013D6 8916[D419]          <1> 	mov	[next_val_l], dx
  3225 000013DA 8916[D619]          <1> 	mov	[next_val_r], dx
  3226                              <1> lff11s2_2_1:
  3227                              <1> 	; bx = [previous_val_l]
  3228                              <1> 	; ax = [previous_val_r]
  3229                              <1> 	; [next_val_l]
  3230                              <1> 	; dx = [next_val_r]
  3231 000013DE E8D004              <1> 	call	interpolating_5_16bit_stereo
  3232 000013E1 E3D5                <1> 	jcxz	lff11s2_3
  3233                              <1> lff11s2_2_2:
  3234 000013E3 AD                  <1> 	lodsw
  3235 000013E4 89C3                <1> 	mov	bx, ax
  3236 000013E6 AD                  <1> 	lodsw
  3237 000013E7 8B14                <1> 	mov	dx, [si]
  3238 000013E9 8916[D419]          <1> 	mov	[next_val_l], dx
  3239 000013ED 8B5402              <1> 	mov	dx, [si+2]
  3240 000013F0 8916[D619]          <1> 	mov	[next_val_r], dx
  3241 000013F4 49                  <1> 	dec	cx
  3242 000013F5 750A                <1> 	jnz	short lff11s2_2_3
  3243 000013F7 31D2                <1> 	xor	dx, dx ; 0
  3244 000013F9 8916[D419]          <1> 	mov	[next_val_l], dx
  3245 000013FD 8916[D619]          <1> 	mov	[next_val_r], dx
  3246                              <1> lff11s2_2_3:
  3247 00001401 E87005              <1>  	call	interpolating_4_16bit_stereo
  3248 00001404 E3B2                <1> 	jcxz	lff11s2_3
  3249                              <1> 	
  3250 00001406 4D                  <1> 	dec	bp
  3251 00001407 74B4                <1> 	jz	short lff11s2_9
  3252                              <1> 
  3253 00001409 AD                  <1> 	lodsw
  3254 0000140A 89C3                <1> 	mov	bx, ax
  3255 0000140C AD                  <1> 	lodsw
  3256 0000140D 8B14                <1> 	mov	dx, [si]
  3257 0000140F 8916[D419]          <1> 	mov	[next_val_l], dx
  3258 00001413 8B5402              <1> 	mov	dx, [si+2]
  3259 00001416 8916[D619]          <1> 	mov	[next_val_r], dx
  3260 0000141A 49                  <1> 	dec	cx
  3261 0000141B 750A                <1> 	jnz	short lff11s2_2_4
  3262 0000141D 31D2                <1> 	xor	dx, dx ; 0
  3263 0000141F 8916[D419]          <1> 	mov	[next_val_l], dx
  3264 00001423 8916[D619]          <1> 	mov	[next_val_r], dx
  3265                              <1> lff11s2_2_4:
  3266 00001427 E84A05              <1>  	call	interpolating_4_16bit_stereo
  3267 0000142A E38C                <1> 	jcxz	lff11s2_3
  3268 0000142C EB92                <1> 	jmp	short lff11s2_1
  3269                              <1> 
  3270                              <1> ; .....................
  3271                              <1> 
  3272                              <1> load_44khz_mono_8_bit:
  3273                              <1> 	; 18/11/2023
  3274 0000142E F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3275                              <1> 					; last of the file?
  3276 00001433 7402                <1> 	jz	short lff44m_0		; no
  3277 00001435 F9                  <1> 	stc
  3278 00001436 C3                  <1> 	retn
  3279                              <1> 
  3280                              <1> lff44m_0:
  3281 00001437 8EC0                <1> 	mov	es, ax ; buffer segment	
  3282 00001439 31FF                <1> 	xor	di, di
  3283 0000143B BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3284                              <1> 	; ds = cs
  3285                              <1> 
  3286                              <1> 	; load file into memory
  3287 0000143E 8B0E[8706]          <1>         mov	cx, [loadsize]
  3288 00001442 8B1E[021E]          <1> 	mov	bx, [filehandle]
  3289 00001446 B43F                <1>        	mov	ah, 3Fh
  3290 00001448 CD21                <1> 	int	21h
  3291 0000144A 723C                <1> 	jc	short lff44m_7 ; error !
  3292                              <1> 
  3293 0000144C 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3294                              <1> 	
  3295 0000144E 21C0                <1> 	and	ax, ax
  3296 00001450 7503                <1> 	jnz	short lff44m_8
  3297 00001452 E923F5              <1> 	jmp	lff44_eof
  3298                              <1> 
  3299                              <1> lff44m_8:
  3300 00001455 89C1                <1> 	mov	cx, ax		; byte count
  3301                              <1> lff44m_9:
  3302 00001457 BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3303 0000145A C606[D819]02        <1> 	mov	byte [faz], 2  ; 2 steps/phases
  3304                              <1> lff44m_1:
  3305                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3306                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3307 0000145F AC                  <1> 	lodsb
  3308 00001460 B280                <1> 	mov	dl, 80h
  3309 00001462 49                  <1> 	dec	cx
  3310 00001463 7402                <1> 	jz	short lff44m_2_1
  3311 00001465 8A14                <1> 	mov	dl, [si]
  3312                              <1> lff44m_2_1:	
  3313                              <1> 	; al = [previous_val]
  3314                              <1> 	; dl = [next_val]
  3315 00001467 E8A601              <1> 	call	interpolating_2_8bit_mono
  3316 0000146A E319                <1> 	jcxz	lff44m_3
  3317                              <1> lff44m_2_2:
  3318 0000146C AC                  <1> 	lodsb
  3319 0000146D 2C80                <1> 	sub	al, 80h
  3320 0000146F C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3321 00001472 AB                  <1> 	stosw		; (L)
  3322 00001473 AB                  <1> 	stosw		; (R)	
  3323                              <1> 
  3324 00001474 49                  <1> 	dec	cx
  3325 00001475 740E                <1> 	jz	short lff44m_3	
  3326 00001477 4D                  <1> 	dec	bp
  3327 00001478 75F2                <1> 	jnz	short lff44m_2_2
  3328                              <1> 	
  3329 0000147A FE0E[D819]          <1> 	dec	byte [faz]
  3330 0000147E 74D7                <1> 	jz	short lff44m_9 
  3331 00001480 BD0B00              <1> 	mov	bp, 11
  3332 00001483 EBDA                <1> 	jmp	short lff44m_1
  3333                              <1> 
  3334                              <1> lff44m_3:
  3335                              <1> lff44s_3:
  3336 00001485 E9DDF4              <1> 	jmp	lff44_3	; padfill
  3337                              <1> 		; (put zeros in the remain words of the buffer)
  3338                              <1> lff44m_7:
  3339                              <1> lff44s_7:
  3340 00001488 E9F4F4              <1> 	jmp	lff44_5  ; error
  3341                              <1> 
  3342                              <1> load_44khz_stereo_8_bit:
  3343                              <1> 	; 16/11/2023
  3344 0000148B F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3345                              <1> 					; last of the file?
  3346 00001490 7402                <1> 	jz	short lff44s_0		; no
  3347 00001492 F9                  <1> 	stc
  3348 00001493 C3                  <1> 	retn
  3349                              <1> 
  3350                              <1> lff44s_0:
  3351 00001494 8EC0                <1> 	mov	es, ax ; buffer segment	
  3352 00001496 31FF                <1> 	xor	di, di
  3353 00001498 BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3354                              <1> 	; ds = cs
  3355                              <1> 
  3356                              <1> 	; load file into memory
  3357 0000149B 8B0E[8706]          <1>         mov	cx, [loadsize]
  3358 0000149F 8B1E[021E]          <1> 	mov	bx, [filehandle]
  3359 000014A3 B43F                <1>        	mov	ah, 3Fh
  3360 000014A5 CD21                <1> 	int	21h
  3361 000014A7 72DF                <1> 	jc	short lff44s_7 ; error !
  3362                              <1> 
  3363 000014A9 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3364                              <1> 	
  3365 000014AB D1E8                <1> 	shr	ax, 1
  3366                              <1> 	;and	ax, ax
  3367 000014AD 7503                <1> 	jnz	short lff44s_8
  3368 000014AF E9C6F4              <1> 	jmp	lff44_eof
  3369                              <1> 
  3370                              <1> lff44s_8:
  3371 000014B2 89C1                <1> 	mov	cx, ax		; word count
  3372                              <1> lff44s_9:
  3373 000014B4 BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3374 000014B7 C606[D819]02        <1> 	mov	byte [faz], 2  ; 2 steps/phase
  3375                              <1> lff44s_1:
  3376                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3377                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3378 000014BC AD                  <1> 	lodsw
  3379 000014BD BA8080              <1> 	mov	dx, 8080h
  3380 000014C0 49                  <1> 	dec	cx
  3381 000014C1 7402                <1> 	jz	short lff44s_2_1 
  3382 000014C3 8B14                <1> 	mov	dx, [si]
  3383                              <1> lff44s_2_1:	
  3384                              <1> 	; al = [previous_val_l]
  3385                              <1> 	; ah = [previous_val_r]
  3386                              <1> 	; dl = [next_val_l]
  3387                              <1> 	; dl = [next_val_r]	
  3388 000014C5 E85F01              <1> 	call	interpolating_2_8bit_stereo
  3389 000014C8 E3BB                <1> 	jcxz	lff44s_3
  3390                              <1> lff44s_2_2:
  3391 000014CA AC                  <1> 	lodsb
  3392 000014CB 2C80                <1> 	sub	al, 80h
  3393 000014CD C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3394 000014D0 AB                  <1> 	stosw		; (L)
  3395 000014D1 AC                  <1> 	lodsb
  3396 000014D2 2C80                <1> 	sub	al, 80h
  3397 000014D4 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3398 000014D7 AB                  <1> 	stosw		; (R)
  3399                              <1> 
  3400 000014D8 49                  <1> 	dec	cx
  3401 000014D9 74AA                <1> 	jz	short lff44s_3	
  3402 000014DB 4D                  <1> 	dec	bp
  3403 000014DC 75EC                <1> 	jnz	short lff44s_2_2
  3404                              <1> 	
  3405 000014DE FE0E[D819]          <1> 	dec	byte [faz]
  3406 000014E2 74D0                <1> 	jz	short lff44s_9 
  3407 000014E4 BD0B00              <1> 	mov	bp, 11
  3408 000014E7 EBD3                <1> 	jmp	short lff44s_1
  3409                              <1> 
  3410                              <1> load_44khz_mono_16_bit:
  3411                              <1> 	; 18/11/2023
  3412 000014E9 F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3413                              <1> 					; last of the file?
  3414 000014EE 7402                <1> 	jz	short lff44m2_0		; no
  3415 000014F0 F9                  <1> 	stc
  3416 000014F1 C3                  <1> 	retn
  3417                              <1> 
  3418                              <1> lff44m2_0:
  3419 000014F2 8EC0                <1> 	mov	es, ax ; buffer segment	
  3420 000014F4 31FF                <1> 	xor	di, di
  3421 000014F6 BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3422                              <1> 	; ds = cs
  3423                              <1> 
  3424                              <1> 	; load file into memory
  3425 000014F9 8B0E[8706]          <1>         mov	cx, [loadsize]
  3426 000014FD 8B1E[021E]          <1> 	mov	bx, [filehandle]
  3427 00001501 B43F                <1>        	mov	ah, 3Fh
  3428 00001503 CD21                <1> 	int	21h
  3429 00001505 7237                <1> 	jc	short lff44m2_7 ; error !
  3430                              <1> 
  3431 00001507 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3432                              <1> 	
  3433 00001509 D1E8                <1> 	shr	ax, 1
  3434                              <1> 	;and	ax, ax
  3435 0000150B 7503                <1> 	jnz	short lff44m2_8
  3436 0000150D E968F4              <1> 	jmp	lff44_eof
  3437                              <1> 
  3438                              <1> lff44m2_8:
  3439 00001510 89C1                <1> 	mov	cx, ax		; word count
  3440                              <1> lff44m2_9:
  3441 00001512 BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3442 00001515 C606[D819]02        <1> 	mov	byte [faz], 2  ; 2 steps/phases
  3443                              <1> lff44m2_1:
  3444                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3445                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3446 0000151A AD                  <1> 	lodsw
  3447 0000151B 31D2                <1> 	xor	dx, dx
  3448 0000151D 49                  <1> 	dec	cx
  3449 0000151E 7402                <1> 	jz	short lff44m2_2_1
  3450 00001520 8B14                <1> 	mov	dx, [si]
  3451                              <1> lff44m2_2_1:	
  3452                              <1> 	; ax = [previous_val]
  3453                              <1> 	; dx = [next_val]
  3454 00001522 E89801              <1> 	call	interpolating_2_16bit_mono
  3455 00001525 E314                <1> 	jcxz	lff44m2_3
  3456                              <1> lff44m2_2_2:
  3457 00001527 AD                  <1> 	lodsw
  3458 00001528 AB                  <1> 	stosw		; (L)eft Channel
  3459 00001529 AB                  <1> 	stosw		; (R)ight Channel
  3460                              <1> 
  3461 0000152A 49                  <1> 	dec	cx
  3462 0000152B 740E                <1> 	jz	short lff44m2_3	
  3463 0000152D 4D                  <1> 	dec	bp
  3464 0000152E 75F7                <1> 	jnz	short lff44m2_2_2
  3465                              <1> 	
  3466 00001530 FE0E[D819]          <1> 	dec	byte [faz]
  3467 00001534 74DC                <1> 	jz	short lff44m2_9 
  3468 00001536 BD0B00              <1> 	mov	bp, 11
  3469 00001539 EBDF                <1> 	jmp	short lff44m2_1
  3470                              <1> 
  3471                              <1> lff44m2_3:
  3472                              <1> lff44s2_3:
  3473 0000153B E927F4              <1> 	jmp	lff44_3	; padfill
  3474                              <1> 		; (put zeros in the remain words of the buffer)
  3475                              <1> lff44m2_7:
  3476                              <1> lff44s2_7:
  3477 0000153E E93EF4              <1> 	jmp	lff44_5  ; error
  3478                              <1> 
  3479                              <1> load_44khz_stereo_16_bit:
  3480                              <1> 	; 18/11/2023
  3481 00001541 F606[041E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3482                              <1> 					; last of the file?
  3483 00001546 7402                <1> 	jz	short lff44s2_0		; no
  3484 00001548 F9                  <1> 	stc
  3485 00001549 C3                  <1> 	retn
  3486                              <1> 
  3487                              <1> lff44s2_0:
  3488 0000154A 8EC0                <1> 	mov	es, ax ; buffer segment	
  3489 0000154C 31FF                <1> 	xor	di, di
  3490 0000154E BA[2A1E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3491                              <1> 	; ds = cs
  3492                              <1> 
  3493                              <1> 	; load file into memory
  3494 00001551 8B0E[8706]          <1>         mov	cx, [loadsize]
  3495 00001555 8B1E[021E]          <1> 	mov	bx, [filehandle]
  3496 00001559 B43F                <1>        	mov	ah, 3Fh
  3497 0000155B CD21                <1> 	int	21h
  3498 0000155D 72DF                <1> 	jc	short lff44s2_7 ; error !
  3499                              <1> 
  3500 0000155F 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3501                              <1> 	
  3502 00001561 C1E802              <1> 	shr	ax, 2	; dword (left chan word + right chan word)
  3503                              <1> 	;and	ax, ax
  3504 00001564 7503                <1> 	jnz	short lff44s2_8
  3505 00001566 E90FF4              <1> 	jmp	lff44_eof
  3506                              <1> 
  3507                              <1> lff44s2_8:
  3508 00001569 89C1                <1> 	mov	cx, ax		; dword count
  3509                              <1> lff44s2_9:
  3510 0000156B BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3511 0000156E C606[D819]02        <1> 	mov	byte [faz], 2  ; 2 steps/phase
  3512                              <1> lff44s2_1:
  3513                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3514                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3515 00001573 AD                  <1> 	lodsw
  3516 00001574 89C3                <1> 	mov	bx, ax
  3517 00001576 AD                  <1> 	lodsw
  3518 00001577 8B14                <1> 	mov	dx, [si]
  3519 00001579 8916[D419]          <1> 	mov	[next_val_l], dx
  3520 0000157D 8B5402              <1> 	mov	dx, [si+2]
  3521 00001580 49                  <1> 	dec	cx
  3522 00001581 7506                <1> 	jnz	short lff44s2_2_1
  3523 00001583 31D2                <1> 	xor	dx, dx ; 0
  3524 00001585 8916[D419]          <1> 	mov	[next_val_l], dx
  3525                              <1> lff44s2_2_1:
  3526                              <1> 	; bx = [previous_val_l]
  3527                              <1> 	; ax = [previous_val_r]
  3528                              <1> 	; [next_val_l]
  3529                              <1> 	; dx = [next_val_r]
  3530 00001589 E84301              <1> 	call	interpolating_2_16bit_stereo
  3531 0000158C E3AD                <1> 	jcxz	lff44s2_3
  3532                              <1> lff44s2_2_2:
  3533                              <1> 	;lodsw
  3534                              <1> 	;stosw		; (L)
  3535                              <1> 	;lodsw
  3536                              <1> 	;stosw		; (R)
  3537 0000158E A5                  <1> 	movsw		; (L)eft Channel
  3538 0000158F A5                  <1> 	movsw		; (R)ight Channel
  3539                              <1> 
  3540 00001590 49                  <1> 	dec	cx
  3541 00001591 74A8                <1> 	jz	short lff44s2_3	
  3542 00001593 4D                  <1> 	dec	bp
  3543 00001594 75F8                <1> 	jnz	short lff44s2_2_2
  3544                              <1> 	
  3545 00001596 FE0E[D819]          <1> 	dec	byte [faz]
  3546 0000159A 74CF                <1> 	jz	short lff44s2_9 
  3547 0000159C BD0B00              <1> 	mov	bp, 11
  3548 0000159F EBD2                <1> 	jmp	short lff44s2_1
  3549                              <1> 
  3550                              <1> ; .....................
  3551                              <1> 
  3552                              <1> interpolating_3_8bit_mono:
  3553                              <1> 	; 16/11/2023
  3554                              <1> 	; al = [previous_val]
  3555                              <1> 	; dl = [next_val]
  3556                              <1> 	; original-interpolated-interpolated
  3557 000015A1 88C3                <1> 	mov	bl, al
  3558 000015A3 2C80                <1> 	sub	al, 80h
  3559 000015A5 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3560 000015A8 AB                  <1> 	stosw		; original sample (L)
  3561 000015A9 AB                  <1> 	stosw		; original sample (R)
  3562 000015AA 88D8                <1> 	mov	al, bl
  3563 000015AC 00D0                <1> 	add	al, dl	
  3564 000015AE D0D8                <1> 	rcr	al, 1
  3565 000015B0 88C7                <1> 	mov	bh, al	; interpolated middle (temporary)
  3566 000015B2 00D8                <1> 	add	al, bl
  3567 000015B4 D0D8                <1> 	rcr	al, 1
  3568 000015B6 2C80                <1> 	sub	al, 80h
  3569 000015B8 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3570 000015BB AB                  <1> 	stosw		; interpolated sample 1 (L)
  3571 000015BC AB                  <1> 	stosw		; interpolated sample 1 (R)
  3572 000015BD 88F8                <1> 	mov	al, bh
  3573 000015BF 00D0                <1> 	add	al, dl	; [next_val]
  3574 000015C1 D0D8                <1> 	rcr	al, 1
  3575 000015C3 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3576 000015C6 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3577 000015C7 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3578 000015C8 C3                  <1> 	retn
  3579                              <1> 
  3580                              <1> interpolating_3_8bit_stereo:
  3581                              <1> 	; 16/11/2023
  3582                              <1> 	; al = [previous_val_l]
  3583                              <1> 	; ah = [previous_val_r]
  3584                              <1> 	; dl = [next_val_l]
  3585                              <1> 	; dh = [next_val_r]	
  3586                              <1> 	; original-interpolated-interpolated
  3587 000015C9 89C3                <1> 	mov	bx, ax
  3588 000015CB 2C80                <1> 	sub	al, 80h
  3589 000015CD C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3590 000015D0 AB                  <1> 	stosw		; original sample (L)
  3591 000015D1 88F8                <1> 	mov	al, bh
  3592 000015D3 2C80                <1> 	sub	al, 80h
  3593 000015D5 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3594 000015D8 AB                  <1> 	stosw		; original sample (R)
  3595 000015D9 88D8                <1> 	mov	al, bl
  3596 000015DB 00D0                <1> 	add	al, dl	; [next_val_l]	
  3597 000015DD D0D8                <1> 	rcr	al, 1
  3598 000015DF 50                  <1> 	push	ax ; *	; al = interpolated middle (L) (temporary)
  3599 000015E0 00D8                <1> 	add	al, bl	; [previous_val_l]
  3600 000015E2 D0D8                <1> 	rcr	al, 1
  3601 000015E4 2C80                <1> 	sub	al, 80h
  3602 000015E6 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3603 000015E9 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3604 000015EA 88F8                <1> 	mov	al, bh
  3605 000015EC 00F0                <1> 	add	al, dh	; [next_val_r]
  3606 000015EE D0D8                <1> 	rcr	al, 1
  3607 000015F0 50                  <1> 	push	ax ; ** ; al = interpolated middle (R) (temporary)
  3608 000015F1 00F8                <1> 	add	al, bh	; [previous_val_r]
  3609 000015F3 D0D8                <1> 	rcr	al, 1
  3610 000015F5 2C80                <1> 	sub	al, 80h
  3611 000015F7 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3612 000015FA AB                  <1> 	stosw		; interpolated sample 1 (R)
  3613 000015FB 5B                  <1> 	pop	bx ; **
  3614 000015FC 58                  <1> 	pop	ax ; *
  3615 000015FD 00D0                <1> 	add	al, dl	; [next_val_l]
  3616 000015FF D0D8                <1> 	rcr	al, 1
  3617 00001601 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3618 00001604 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3619 00001605 88D8                <1> 	mov	al, bl
  3620 00001607 00F0                <1> 	add	al, dh	; [next_val_r]
  3621 00001609 D0D8                <1> 	rcr	al, 1
  3622 0000160B C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3623 0000160E AB                  <1> 	stosw		; interpolated sample 2 (R)
  3624 0000160F C3                  <1> 	retn
  3625                              <1> 
  3626                              <1> interpolating_2_8bit_mono:
  3627                              <1> 	; 16/11/2023
  3628                              <1> 	; al = [previous_val]
  3629                              <1> 	; dl = [next_val]
  3630                              <1> 	; original-interpolated
  3631 00001610 88C3                <1> 	mov	bl, al
  3632 00001612 2C80                <1> 	sub	al, 80h
  3633 00001614 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3634 00001617 AB                  <1> 	stosw		; original sample (L)
  3635 00001618 AB                  <1> 	stosw		; original sample (R)
  3636 00001619 88D8                <1> 	mov	al, bl
  3637 0000161B 00D0                <1> 	add	al, dl	
  3638 0000161D D0D8                <1> 	rcr	al, 1
  3639 0000161F 2C80                <1> 	sub	al, 80h
  3640 00001621 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3641 00001624 AB                  <1> 	stosw		; interpolated sample (L)
  3642 00001625 AB                  <1> 	stosw		; interpolated sample (R)
  3643 00001626 C3                  <1> 	retn
  3644                              <1> 
  3645                              <1> interpolating_2_8bit_stereo:
  3646                              <1> 	; 16/11/2023
  3647                              <1> 	; al = [previous_val_l]
  3648                              <1> 	; ah = [previous_val_r]
  3649                              <1> 	; dl = [next_val_l]
  3650                              <1> 	; dh = [next_val_r]	
  3651                              <1> 	; original-interpolated
  3652 00001627 89C3                <1> 	mov	bx, ax
  3653 00001629 2C80                <1> 	sub	al, 80h
  3654 0000162B C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3655 0000162E AB                  <1> 	stosw		; original sample (L)
  3656 0000162F 88F8                <1> 	mov	al, bh
  3657 00001631 2C80                <1> 	sub	al, 80h
  3658 00001633 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3659 00001636 AB                  <1> 	stosw		; original sample (R)
  3660 00001637 88D8                <1> 	mov	al, bl	; [previous_val_l]
  3661 00001639 00D0                <1> 	add	al, dl	; [next_val_l]	
  3662 0000163B D0D8                <1> 	rcr	al, 1
  3663 0000163D 2C80                <1> 	sub	al, 80h
  3664 0000163F C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3665 00001642 AB                  <1> 	stosw		; interpolated sample (L)
  3666 00001643 88F8                <1> 	mov	al, bh
  3667 00001645 00F0                <1> 	add	al, dh	; [next_val_r]
  3668 00001647 D0D8                <1> 	rcr	al, 1
  3669 00001649 2C80                <1> 	sub	al, 80h
  3670 0000164B C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3671 0000164E AB                  <1> 	stosw		; interpolated sample (R)
  3672 0000164F C3                  <1> 	retn
  3673                              <1> 
  3674                              <1> interpolating_3_16bit_mono:
  3675                              <1> 	; 16/11/2023
  3676                              <1> 	; ax = [previous_val]
  3677                              <1> 	; dx = [next_val]
  3678                              <1> 	; original-interpolated-interpolated
  3679                              <1> 
  3680 00001650 AB                  <1> 	stosw		; original sample (L)
  3681 00001651 AB                  <1> 	stosw		; original sample (R)
  3682 00001652 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3683 00001655 50                  <1> 	push	ax ; *	; [previous_val]
  3684 00001656 80C680              <1> 	add	dh, 80h
  3685 00001659 01D0                <1> 	add	ax, dx
  3686 0000165B D1D8                <1> 	rcr	ax, 1
  3687 0000165D 5B                  <1> 	pop	bx ; *		
  3688 0000165E 93                  <1> 	xchg	bx, ax	; bx  = interpolated middle (temporary)
  3689 0000165F 01D8                <1> 	add	ax, bx	; [previous_val] + interpolated middle
  3690 00001661 D1D8                <1> 	rcr	ax, 1
  3691 00001663 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3692 00001666 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3693 00001667 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3694 00001668 89D8                <1> 	mov	ax, bx
  3695 0000166A 01D0                <1> 	add	ax, dx	 ;interpolated middle + [next_val]
  3696 0000166C D1D8                <1> 	rcr	ax, 1
  3697 0000166E 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3698 00001671 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3699 00001672 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3700 00001673 C3                  <1> 	retn
  3701                              <1> 
  3702                              <1> interpolating_3_16bit_stereo:
  3703                              <1> 	; 16/11/2023
  3704                              <1> 	; bx = [previous_val_l]
  3705                              <1> 	; ax = [previous_val_r]
  3706                              <1> 	; [next_val_l]
  3707                              <1> 	; dx = [next_val_r]
  3708                              <1> 	; original-interpolated-interpolated
  3709                              <1> 
  3710 00001674 93                  <1> 	xchg	ax, bx
  3711 00001675 AB                  <1> 	stosw		; original sample (L)
  3712 00001676 93                  <1> 	xchg	ax, bx
  3713 00001677 AB                  <1> 	stosw		; original sample (R)
  3714 00001678 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3715 0000167B 50                  <1> 	push	ax ; *	; [previous_val_r]
  3716 0000167C 80C780              <1> 	add	bh, 80h
  3717 0000167F 8006[D519]80        <1> 	add	byte [next_val_l+1], 80h
  3718 00001684 A1[D419]            <1> 	mov	ax, [next_val_l]
  3719 00001687 01D8                <1> 	add	ax, bx	; [previous_val_l]
  3720 00001689 D1D8                <1> 	rcr	ax, 1
  3721 0000168B 93                  <1> 	xchg	ax, bx	; ax = [previous_val_l]	
  3722 0000168C 01D8                <1> 	add	ax, bx	; bx = interpolated middle (L)
  3723 0000168E D1D8                <1> 	rcr	ax, 1
  3724 00001690 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3725 00001693 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3726 00001694 58                  <1> 	pop	ax  ; *
  3727 00001695 80C680              <1> 	add	dh, 80h ; convert sound level 0 to 65535 format
  3728 00001698 52                  <1> 	push	dx  ; * ; [next_val_r]
  3729 00001699 92                  <1> 	xchg	ax, dx
  3730 0000169A 01D0                <1> 	add	ax, dx	; [next_val_r] + [previous_val_r]
  3731 0000169C D1D8                <1> 	rcr	ax, 1	; / 2
  3732 0000169E 50                  <1> 	push	ax ; ** ; interpolated middle (R)
  3733 0000169F 01D0                <1> 	add	ax, dx	; + [previous_val_r]
  3734 000016A1 D1D8                <1> 	rcr	ax, 1
  3735 000016A3 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3736 000016A6 AB                  <1> 	stosw 		; interpolated sample 1 (R)
  3737 000016A7 A1[D419]            <1> 	mov	ax, [next_val_l]
  3738 000016AA 01D8                <1> 	add	ax, bx	; + interpolated middle (L)
  3739 000016AC D1D8                <1> 	rcr	ax, 1
  3740 000016AE 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3741 000016B1 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  3742 000016B2 58                  <1> 	pop	ax ; **
  3743 000016B3 5A                  <1> 	pop	dx ; *	
  3744 000016B4 01D0                <1> 	add	ax, dx	; interpolated middle + [next_val_r]
  3745 000016B6 D1D8                <1> 	rcr	ax, 1	; / 2
  3746 000016B8 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3747 000016BB AB                  <1> 	stosw 		; interpolated sample 2 (L)
  3748 000016BC C3                  <1> 	retn
  3749                              <1> 
  3750                              <1> interpolating_2_16bit_mono:
  3751                              <1> 	; 16/11/2023
  3752                              <1> 	; ax = [previous_val]
  3753                              <1> 	; dx = [next_val]
  3754                              <1> 	; original-interpolated
  3755                              <1> 
  3756 000016BD AB                  <1> 	stosw		; original sample (L)
  3757 000016BE AB                  <1> 	stosw		; original sample (R)
  3758 000016BF 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3759 000016C2 80C680              <1> 	add	dh, 80h
  3760 000016C5 01D0                <1> 	add	ax, dx
  3761 000016C7 D1D8                <1> 	rcr	ax, 1
  3762 000016C9 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3763 000016CC AB                  <1> 	stosw		; interpolated sample (L)
  3764 000016CD AB                  <1> 	stosw		; interpolated sample (R)
  3765 000016CE C3                  <1> 	retn
  3766                              <1> 
  3767                              <1> interpolating_2_16bit_stereo:
  3768                              <1> 	; 16/11/2023
  3769                              <1> 	; bx = [previous_val_l]
  3770                              <1> 	; ax = [previous_val_r]
  3771                              <1> 	; [next_val_l]
  3772                              <1> 	; dx = [next_val_r]
  3773                              <1> 	; original-interpolated
  3774                              <1> 
  3775 000016CF 93                  <1> 	xchg	ax, bx
  3776 000016D0 AB                  <1> 	stosw		; original sample (L)
  3777 000016D1 93                  <1> 	xchg	ax, bx
  3778 000016D2 AB                  <1> 	stosw		; original sample (R)
  3779 000016D3 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3780 000016D6 80C680              <1> 	add	dh, 80h
  3781 000016D9 01D0                <1> 	add	ax, dx	; [previous_val_r] + [next_val_r]
  3782 000016DB D1D8                <1> 	rcr	ax, 1	; / 2
  3783 000016DD 50                  <1> 	push	ax ; *	; interpolated sample (R)
  3784 000016DE A1[D419]            <1> 	mov	ax, [next_val_l]
  3785 000016E1 80C480              <1> 	add	ah, 80h
  3786 000016E4 80C780              <1> 	add	bh, 80h
  3787 000016E7 01D8                <1> 	add	ax, bx	; [next_val_l] + [previous_val_l]
  3788 000016E9 D1D8                <1> 	rcr	ax, 1	; / 2		
  3789 000016EB 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3790 000016EE AB                  <1> 	stosw 		; interpolated sample (L)
  3791 000016EF 58                  <1> 	pop	ax ; *	
  3792 000016F0 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3793 000016F3 AB                  <1> 	stosw 		; interpolated sample (R)
  3794 000016F4 C3                  <1> 	retn
  3795                              <1> 
  3796                              <1> interpolating_5_8bit_mono:
  3797                              <1> 	; 17/11/2023
  3798                              <1> 	; al = [previous_val]
  3799                              <1> 	; dl = [next_val]
  3800                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  3801 000016F5 88C3                <1> 	mov	bl, al
  3802 000016F7 2C80                <1> 	sub	al, 80h
  3803 000016F9 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3804 000016FC AB                  <1> 	stosw		; original sample (L)
  3805 000016FD AB                  <1> 	stosw		; original sample (R)
  3806 000016FE 88D8                <1> 	mov	al, bl
  3807 00001700 00D0                <1> 	add	al, dl	
  3808 00001702 D0D8                <1> 	rcr	al, 1
  3809 00001704 88C7                <1> 	mov	bh, al	; interpolated middle (temporary)
  3810 00001706 00D8                <1> 	add	al, bl  ; [previous_val]
  3811 00001708 D0D8                <1> 	rcr	al, 1 	
  3812 0000170A 88C6                <1> 	mov	dh, al	; interpolated 1st quarter (temporary)
  3813 0000170C 00D8                <1> 	add	al, bl
  3814 0000170E D0D8                <1> 	rcr	al, 1
  3815 00001710 2C80                <1> 	sub	al, 80h
  3816 00001712 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3817 00001715 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3818 00001716 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3819 00001717 88F8                <1> 	mov	al, bh
  3820 00001719 00F0                <1> 	add	al, dh
  3821 0000171B D0D8                <1> 	rcr	al, 1
  3822 0000171D 2C80                <1> 	sub	al, 80h
  3823 0000171F C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3824 00001722 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3825 00001723 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3826 00001724 88F8                <1> 	mov	al, bh
  3827 00001726 00D0                <1> 	add	al, dl	; [next_val]
  3828 00001728 D0D8                <1> 	rcr	al, 1
  3829 0000172A 88C6                <1> 	mov	dh, al	; interpolated 3rd quarter (temporary)
  3830 0000172C 00F8                <1> 	add	al, bh
  3831 0000172E D0D8                <1> 	rcr	al, 1
  3832 00001730 2C80                <1> 	sub	al, 80h
  3833 00001732 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3834 00001735 AB                  <1> 	stosw		; interpolated sample 3 (L)
  3835 00001736 AB                  <1> 	stosw		; interpolated sample 3 (R)
  3836 00001737 88F0                <1> 	mov	al, dh
  3837 00001739 00D0                <1> 	add	al, dl
  3838 0000173B D0D8                <1> 	rcr	al, 1
  3839 0000173D 2C80                <1> 	sub	al, 80h
  3840 0000173F C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3841 00001742 AB                  <1> 	stosw		; interpolated sample 4 (L)
  3842 00001743 AB                  <1> 	stosw		; interpolated sample 4 (R)
  3843 00001744 C3                  <1> 	retn
  3844                              <1> 
  3845                              <1> interpolating_5_8bit_stereo:
  3846                              <1> 	; 17/11/2023
  3847                              <1> 	; al = [previous_val_l]
  3848                              <1> 	; ah = [previous_val_r]
  3849                              <1> 	; dl = [next_val_l]
  3850                              <1> 	; dh = [next_val_r]	
  3851                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  3852 00001745 89C3                <1> 	mov	bx, ax
  3853 00001747 2C80                <1> 	sub	al, 80h
  3854 00001749 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3855 0000174C AB                  <1> 	stosw		; original sample (L)
  3856 0000174D 88F8                <1> 	mov	al, bh
  3857 0000174F 2C80                <1> 	sub	al, 80h
  3858 00001751 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3859 00001754 AB                  <1> 	stosw		; original sample (R)
  3860 00001755 52                  <1> 	push	dx ; *
  3861 00001756 88D8                <1> 	mov	al, bl
  3862 00001758 00D0                <1> 	add	al, dl	; [next_val_l]
  3863 0000175A D0D8                <1> 	rcr	al, 1
  3864 0000175C 50                  <1> 	push	ax ; **	; al = interpolated middle (L) (temporary)
  3865 0000175D 00D8                <1> 	add	al, bl	; [previous_val_l]
  3866 0000175F D0D8                <1> 	rcr	al, 1
  3867 00001761 86C3                <1> 	xchg	al, bl	
  3868 00001763 00D8                <1> 	add	al, bl	; bl = interpolated 1st quarter (L) (temp)
  3869 00001765 D0D8                <1> 	rcr	al, 1
  3870 00001767 2C80                <1> 	sub	al, 80h
  3871 00001769 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3872 0000176C AB                  <1> 	stosw		; interpolated sample 1 (L)
  3873 0000176D 88F8                <1> 	mov	al, bh
  3874 0000176F 00F0                <1> 	add	al, dh	; [next_val_r]
  3875 00001771 D0D8                <1> 	rcr	al, 1
  3876 00001773 50                  <1> 	push	ax ; *** ; al = interpolated middle (R) (temporary)
  3877 00001774 00F8                <1> 	add	al, bh	; [previous_val_r]
  3878 00001776 D0D8                <1> 	rcr	al, 1
  3879 00001778 86C7                <1> 	xchg	al, bh	
  3880 0000177A 00F8                <1> 	add	al, bh	; bh = interpolated 1st quarter (R) (temp)
  3881 0000177C D0D8                <1> 	rcr	al, 1
  3882 0000177E 2C80                <1> 	sub	al, 80h
  3883 00001780 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3884 00001783 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3885 00001784 5A                  <1> 	pop	dx ; ***
  3886 00001785 58                  <1> 	pop	ax ; **	; al = interpolated middle (L) (temporary)
  3887 00001786 86C3                <1> 	xchg	al, bl	; al = interpolated 1st quarter (L) (temp)
  3888 00001788 00D8                <1> 	add	al, bl	; bl = interpolated middle (L) (temporary)
  3889 0000178A D0D8                <1> 	rcr	al, 1
  3890 0000178C 2C80                <1> 	sub	al, 80h
  3891 0000178E C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3892 00001791 AB                  <1> 	stosw		; interpolated sample 2 (L)	
  3893 00001792 88D0                <1> 	mov	al, dl 	; interpolated middle (R) (temporary)
  3894 00001794 86C7                <1> 	xchg	al, bh	; al = interpolated 1st quarter (R) (temp)
  3895 00001796 00F8                <1> 	add	al, bh	; bh = interpolated middle (R) (temporary)
  3896 00001798 D0D8                <1> 	rcr	al, 1
  3897 0000179A 2C80                <1> 	sub	al, 80h
  3898 0000179C C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3899 0000179F AB                  <1> 	stosw		; interpolated sample 2 (R)
  3900 000017A0 5A                  <1> 	pop	dx ; *
  3901 000017A1 88D8                <1> 	mov	al, bl	; interpolated middle (L) (temporary)
  3902 000017A3 00D0                <1> 	add	al, dl	; [next_val_l]
  3903 000017A5 D0D8                <1> 	rcr	al, 1
  3904 000017A7 86C3                <1> 	xchg	al, bl	; al = interpolated middle (R) (temporary)	
  3905 000017A9 00D8                <1> 	add	al, bl	; bl = interpolated 3rd quarter (L) (temp) 
  3906 000017AB D0D8                <1> 	rcr	al, 1
  3907 000017AD 2C80                <1> 	sub	al, 80h
  3908 000017AF C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3909 000017B2 AB                  <1> 	stosw		; interpolated sample 3 (L)
  3910 000017B3 88F8                <1> 	mov	al, bh	
  3911 000017B5 00F0                <1> 	add	al, dh	; interpolated middle (R) + [next_val_r]
  3912 000017B7 D0D8                <1> 	rcr	al, 1
  3913 000017B9 86C7                <1> 	xchg	al, bh	; al = interpolated middle (R)
  3914 000017BB 00F8                <1> 	add	al, bh	; bh = interpolated 3rd quarter (R) (temp)
  3915 000017BD D0D8                <1> 	rcr	al, 1
  3916 000017BF 2C80                <1> 	sub	al, 80h
  3917 000017C1 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3918 000017C4 AB                  <1> 	stosw		; interpolated sample 3 (R)
  3919 000017C5 88D8                <1> 	mov	al, bl
  3920 000017C7 00D0                <1> 	add	al, dl	; [next_val_l]
  3921 000017C9 D0D8                <1> 	rcr	al, 1
  3922 000017CB 2C80                <1> 	sub	al, 80h
  3923 000017CD C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3924 000017D0 AB                  <1> 	stosw		; interpolated sample 4 (L)
  3925 000017D1 88F8                <1> 	mov	al, bh
  3926 000017D3 00F0                <1> 	add	al, dh	; [next_val_r]
  3927 000017D5 D0D8                <1> 	rcr	al, 1
  3928 000017D7 2C80                <1> 	sub	al, 80h
  3929 000017D9 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3930 000017DC AB                  <1> 	stosw		; interpolated sample 4 (R)
  3931 000017DD C3                  <1> 	retn
  3932                              <1> 
  3933                              <1> interpolating_4_8bit_mono:
  3934                              <1> 	; 17/11/2023
  3935                              <1> 	; al = [previous_val]
  3936                              <1> 	; dl = [next_val]
  3937                              <1> 	; original-interpolated-interpolated-interpolated
  3938 000017DE 88C3                <1> 	mov	bl, al
  3939 000017E0 2C80                <1> 	sub	al, 80h
  3940 000017E2 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3941 000017E5 AB                  <1> 	stosw		; original sample (L)
  3942 000017E6 AB                  <1> 	stosw		; original sample (R)
  3943 000017E7 88D8                <1> 	mov	al, bl
  3944 000017E9 00D0                <1> 	add	al, dl	
  3945 000017EB D0D8                <1> 	rcr	al, 1
  3946 000017ED 86C3                <1> 	xchg	al, bl  ; al = [previous_val]
  3947 000017EF 00D8                <1> 	add	al, bl	; bl = interpolated middle (sample 2)
  3948 000017F1 D0D8                <1> 	rcr	al, 1 	
  3949 000017F3 2C80                <1> 	sub	al, 80h
  3950 000017F5 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3951 000017F8 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3952 000017F9 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3953 000017FA 88D8                <1> 	mov	al, bl	; interpolated middle (sample 2)
  3954 000017FC 2C80                <1> 	sub	al, 80h
  3955 000017FE C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3956 00001801 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3957 00001802 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3958 00001803 88D8                <1> 	mov	al, bl
  3959 00001805 00D0                <1> 	add	al, dl	; [next_val]
  3960 00001807 D0D8                <1> 	rcr	al, 1
  3961 00001809 2C80                <1> 	sub	al, 80h
  3962 0000180B C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3963 0000180E AB                  <1> 	stosw		; interpolated sample 3 (L)
  3964 0000180F AB                  <1> 	stosw		; interpolated sample 3 (R)
  3965 00001810 C3                  <1> 	retn
  3966                              <1> 
  3967                              <1> interpolating_4_8bit_stereo:
  3968                              <1> 	; 17/11/2023
  3969                              <1> 	; al = [previous_val_l]
  3970                              <1> 	; ah = [previous_val_r]
  3971                              <1> 	; dl = [next_val_l]
  3972                              <1> 	; dh = [next_val_r]	
  3973                              <1> 	; original-interpolated-interpolated-interpolated
  3974 00001811 89C3                <1> 	mov	bx, ax
  3975 00001813 2C80                <1> 	sub	al, 80h
  3976 00001815 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3977 00001818 AB                  <1> 	stosw		; original sample (L)
  3978 00001819 88F8                <1> 	mov	al, bh
  3979 0000181B 2C80                <1> 	sub	al, 80h
  3980 0000181D C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3981 00001820 AB                  <1> 	stosw		; original sample (R)
  3982 00001821 88D8                <1> 	mov	al, bl
  3983 00001823 00D0                <1> 	add	al, dl	; [next_val_l]
  3984 00001825 D0D8                <1> 	rcr	al, 1
  3985 00001827 86C3                <1> 	xchg	al, bl	; al = [previous_val_l]
  3986 00001829 00D8                <1> 	add	al, bl	; bl = interpolated middle (L) (sample 2)
  3987 0000182B D0D8                <1> 	rcr	al, 1
  3988 0000182D 2C80                <1> 	sub	al, 80h
  3989 0000182F C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3990 00001832 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3991 00001833 88F8                <1> 	mov	al, bh
  3992 00001835 00F0                <1> 	add	al, dh	; [next_val_r]
  3993 00001837 D0D8                <1> 	rcr	al, 1
  3994 00001839 86C7                <1> 	xchg	al, bh	; al = [previous_val_h]
  3995 0000183B 00F8                <1> 	add	al, bh	; bh = interpolated middle (R) (sample 2)
  3996 0000183D D0D8                <1> 	rcr	al, 1
  3997 0000183F 2C80                <1> 	sub	al, 80h
  3998 00001841 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3999 00001844 AB                  <1> 	stosw		; interpolated sample 1 (R)
  4000 00001845 88D8                <1> 	mov	al, bl	; interpolated middle (L) (sample 2)
  4001 00001847 2C80                <1> 	sub	al, 80h
  4002 00001849 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4003 0000184C AB                  <1> 	stosw		; interpolated sample 2 (L)
  4004 0000184D 88F8                <1> 	mov	al, bh	; interpolated middle (L) (sample 2)
  4005 0000184F 2C80                <1> 	sub	al, 80h
  4006 00001851 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4007 00001854 AB                  <1> 	stosw		; interpolated sample 2 (L)
  4008 00001855 88D8                <1> 	mov	al, bl
  4009 00001857 00D0                <1> 	add	al, dl	; [next_val_l]
  4010 00001859 D0D8                <1> 	rcr	al, 1
  4011 0000185B 2C80                <1> 	sub	al, 80h
  4012 0000185D C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4013 00001860 AB                  <1> 	stosw		; interpolated sample 3 (L)
  4014 00001861 88F8                <1> 	mov	al, bh
  4015 00001863 00F0                <1> 	add	al, dh	; [next_val_r]
  4016 00001865 D0D8                <1> 	rcr	al, 1
  4017 00001867 2C80                <1> 	sub	al, 80h
  4018 00001869 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4019 0000186C AB                  <1> 	stosw		; interpolated sample 3 (R)
  4020 0000186D C3                  <1> 	retn
  4021                              <1> 
  4022                              <1> interpolating_5_16bit_mono:
  4023                              <1> 	; 18/11/2023
  4024                              <1> 	; ax = [previous_val]
  4025                              <1> 	; dx = [next_val]
  4026                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  4027 0000186E AB                  <1> 	stosw		; original sample (L)
  4028 0000186F AB                  <1> 	stosw		; original sample (R)
  4029 00001870 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  4030 00001873 89C3                <1> 	mov	bx, ax	; [previous_val]
  4031 00001875 80C680              <1> 	add	dh, 80h
  4032 00001878 01D0                <1> 	add	ax, dx
  4033 0000187A D1D8                <1> 	rcr	ax, 1
  4034 0000187C 50                  <1> 	push	ax ; *	; interpolated middle (temporary)
  4035 0000187D 01D8                <1> 	add	ax, bx	; interpolated middle + [previous_val] 
  4036 0000187F D1D8                <1> 	rcr	ax, 1
  4037 00001881 50                  <1> 	push	ax ; **	; interpolated 1st quarter (temporary)
  4038 00001882 01D8                <1> 	add	ax, bx	; 1st quarter + [previous_val]
  4039 00001884 D1D8                <1> 	rcr	ax, 1	
  4040 00001886 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4041 00001889 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  4042 0000188A AB                  <1> 	stosw		; interpolated sample 1 (R)
  4043 0000188B 58                  <1> 	pop	ax ; **	
  4044 0000188C 5B                  <1> 	pop	bx ; *
  4045 0000188D 01D8                <1> 	add	ax, bx	; 1st quarter + middle
  4046 0000188F D1D8                <1> 	rcr	ax, 1	; / 2
  4047 00001891 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again	
  4048 00001894 AB                  <1> 	stosw		; interpolated sample 2 (L)
  4049 00001895 AB                  <1> 	stosw		; interpolated sample 2 (R)		
  4050 00001896 89D8                <1> 	mov	ax, bx
  4051 00001898 01D0                <1> 	add	ax, dx	; interpolated middle + [next_val]
  4052 0000189A D1D8                <1> 	rcr	ax, 1
  4053 0000189C 50                  <1> 	push	ax ; *	; interpolated 3rd quarter (temporary)
  4054 0000189D 01D8                <1> 	add	ax, bx	; + interpolated middle
  4055 0000189F D1D8                <1> 	rcr	ax, 1
  4056 000018A1 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4057 000018A4 AB                  <1> 	stosw		; interpolated sample 3 (L)
  4058 000018A5 AB                  <1> 	stosw		; interpolated sample 3 (R)
  4059 000018A6 58                  <1> 	pop	ax ; *	
  4060 000018A7 01D0                <1> 	add	ax, dx	; 3rd quarter + [next_val]
  4061 000018A9 D1D8                <1> 	rcr	ax, 1	; / 2
  4062 000018AB 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4063 000018AE AB                  <1> 	stosw		; interpolated sample 4 (L)
  4064 000018AF AB                  <1> 	stosw		; interpolated sample 4 (R)
  4065 000018B0 C3                  <1> 	retn
  4066                              <1> 
  4067                              <1> interpolating_5_16bit_stereo:
  4068                              <1> 	; 18/11/2023
  4069                              <1> 	; bx = [previous_val_l]
  4070                              <1> 	; ax = [previous_val_r]
  4071                              <1> 	; [next_val_l]
  4072                              <1> 	; [next_val_r]
  4073                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  4074 000018B1 51                  <1> 	push	cx ; !
  4075 000018B2 93                  <1> 	xchg	ax, bx
  4076 000018B3 AB                  <1> 	stosw		; original sample (L)
  4077 000018B4 93                  <1> 	xchg	ax, bx
  4078 000018B5 AB                  <1> 	stosw		; original sample (R)
  4079 000018B6 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  4080 000018B9 50                  <1> 	push	ax ; *	; [previous_val_r]
  4081 000018BA 80C780              <1> 	add	bh, 80h
  4082 000018BD 8006[D519]80        <1> 	add	byte [next_val_l+1], 80h
  4083 000018C2 A1[D419]            <1> 	mov	ax, [next_val_l]
  4084 000018C5 01D8                <1> 	add	ax, bx	; [previous_val_l]
  4085 000018C7 D1D8                <1> 	rcr	ax, 1
  4086 000018C9 89C1                <1> 	mov	cx, ax	; interpolated middle (L)
  4087 000018CB 01D8                <1> 	add	ax, bx	
  4088 000018CD D1D8                <1> 	rcr	ax, 1
  4089 000018CF 89C2                <1> 	mov	dx, ax	; interpolated 1st quarter (L)	
  4090 000018D1 01D8                <1> 	add	ax, bx	; [previous_val_l]
  4091 000018D3 D1D8                <1> 	rcr	ax, 1
  4092 000018D5 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4093 000018D8 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  4094 000018D9 89C8                <1> 	mov	ax, cx
  4095 000018DB 01D0                <1> 	add	ax, dx	; middle (L) + 1st quarter (L) 
  4096 000018DD D1D8                <1> 	rcr	ax, 1	; / 2
  4097 000018DF 89C3                <1> 	mov	bx, ax  ; interpolated sample 2 (L)
  4098 000018E1 5A                  <1> 	pop	dx ; *	; [previous_val_r]
  4099 000018E2 89D0                <1> 	mov	ax, dx
  4100 000018E4 8006[D719]80        <1> 	add	byte [next_val_r+1], 80h
  4101 000018E9 0306[D619]          <1> 	add	ax, [next_val_r]
  4102 000018ED D1D8                <1> 	rcr	ax, 1
  4103 000018EF 50                  <1> 	push	ax ; *	; interpolated middle (R)
  4104 000018F0 01D0                <1> 	add	ax, dx
  4105 000018F2 D1D8                <1> 	rcr	ax, 1
  4106 000018F4 50                  <1> 	push	ax ; **	; interpolated 1st quarter (R)
  4107 000018F5 01D0                <1> 	add	ax, dx	; [previous_val_r]
  4108 000018F7 D1D8                <1> 	rcr	ax, 1
  4109 000018F9 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4110 000018FC AB                  <1> 	stosw 		; interpolated sample 1 (R)
  4111 000018FD 89D8                <1> 	mov	ax, bx
  4112 000018FF 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4113 00001902 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  4114 00001903 58                  <1> 	pop	ax ; **
  4115 00001904 5A                  <1> 	pop	dx ; *
  4116 00001905 01D0                <1> 	add	ax, dx	; 1st quarter (R) + middle (R)
  4117 00001907 D1D8                <1> 	rcr	ax, 1	; / 2
  4118 00001909 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4119 0000190C AB                  <1> 	stosw 		; interpolated sample 2 (R)
  4120 0000190D 89C8                <1> 	mov	ax, cx
  4121 0000190F 0306[D419]          <1> 	add	ax, [next_val_l]
  4122 00001913 D1D8                <1> 	rcr	ax, 1
  4123 00001915 50                  <1> 	push	ax ; * 	; interpolated 3rd quarter (L)
  4124 00001916 01C8                <1> 	add	ax, cx	; interpolated middle (L)
  4125 00001918 D1D8                <1> 	rcr	ax, 1
  4126 0000191A 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4127 0000191D AB                  <1> 	stosw 		; interpolated sample 3 (L)
  4128 0000191E 89D0                <1> 	mov	ax, dx
  4129 00001920 0306[D619]          <1> 	add	ax, [next_val_r]
  4130 00001924 D1D8                <1> 	rcr	ax, 1
  4131 00001926 50                  <1> 	push	ax ; ** ; interpolated 3rd quarter (R)
  4132 00001927 01D0                <1> 	add	ax, dx	; interpolated middle (R)
  4133 00001929 D1D8                <1> 	rcr	ax, 1
  4134 0000192B 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4135 0000192E AB                  <1> 	stosw 		; interpolated sample 3 (R)
  4136 0000192F 5B                  <1> 	pop	bx ; **
  4137 00001930 58                  <1> 	pop	ax ; *
  4138 00001931 0306[D419]          <1> 	add	ax, [next_val_l]
  4139 00001935 D1D8                <1> 	rcr	ax, 1
  4140 00001937 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4141 0000193A AB                  <1> 	stosw 		; interpolated sample 4 (L)
  4142 0000193B 89D8                <1> 	mov	ax, bx	
  4143 0000193D 0306[D619]          <1> 	add	ax, [next_val_r]
  4144 00001941 D1D8                <1> 	rcr	ax, 1
  4145 00001943 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4146 00001946 AB                  <1> 	stosw 		; interpolated sample 4 (R)
  4147 00001947 59                  <1> 	pop	cx ; !
  4148 00001948 C3                  <1> 	retn
  4149                              <1> 
  4150                              <1> interpolating_4_16bit_mono:
  4151                              <1> 	; 18/11/2023
  4152                              <1> 	; ax = [previous_val]
  4153                              <1> 	; dx = [next_val]
  4154                              <1> 	; original-interpolated
  4155                              <1> 
  4156 00001949 AB                  <1> 	stosw		; original sample (L)
  4157 0000194A AB                  <1> 	stosw		; original sample (R)
  4158 0000194B 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  4159 0000194E 89C3                <1> 	mov	bx, ax	; [previous_val]
  4160 00001950 80C680              <1> 	add	dh, 80h
  4161 00001953 01D0                <1> 	add	ax, dx	; [previous_val] + [next_val]
  4162 00001955 D1D8                <1> 	rcr	ax, 1
  4163 00001957 93                  <1> 	xchg	ax, bx	
  4164 00001958 01D8                <1> 	add	ax, bx	; [previous_val] + interpolated middle
  4165 0000195A D1D8                <1> 	rcr	ax, 1
  4166 0000195C 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4167 0000195F AB                  <1> 	stosw 		; interpolated sample 1 (L)
  4168 00001960 AB                  <1> 	stosw		; interpolated sample 1 (R)
  4169 00001961 89D8                <1> 	mov	ax, bx	; interpolated middle
  4170 00001963 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4171 00001966 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  4172 00001967 AB                  <1> 	stosw		; interpolated sample 2 (R)
  4173 00001968 89D8                <1> 	mov	ax, bx
  4174 0000196A 01D0                <1> 	add	ax, dx	; interpolated middle + [next_val]
  4175 0000196C D1D8                <1> 	rcr	ax, 1
  4176 0000196E 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4177 00001971 AB                  <1> 	stosw		; interpolated sample 3 (L)
  4178 00001972 AB                  <1> 	stosw		; interpolated sample 3 (R)
  4179 00001973 C3                  <1> 	retn
  4180                              <1> 
  4181                              <1> interpolating_4_16bit_stereo:
  4182                              <1> 	; 18/11/2023
  4183                              <1> 	; bx = [previous_val_l]
  4184                              <1> 	; ax = [previous_val_r]
  4185                              <1> 	; [next_val_l]
  4186                              <1> 	; [next_val_r]
  4187                              <1> 	; original-interpolated-interpolated-interpolated
  4188 00001974 93                  <1> 	xchg	ax, bx
  4189 00001975 AB                  <1> 	stosw		; original sample (L)
  4190 00001976 93                  <1> 	xchg	ax, bx
  4191 00001977 AB                  <1> 	stosw		; original sample (R)
  4192 00001978 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  4193 0000197B 89C2                <1> 	mov	dx, ax	; [previous_val_r]
  4194 0000197D 80C780              <1> 	add	bh, 80h
  4195 00001980 8006[D519]80        <1> 	add	byte [next_val_l+1], 80h
  4196 00001985 A1[D419]            <1> 	mov	ax, [next_val_l]
  4197 00001988 01D8                <1> 	add	ax, bx	; [previous_val_l]
  4198 0000198A D1D8                <1> 	rcr	ax, 1
  4199 0000198C 93                  <1> 	xchg	ax, bx	
  4200 0000198D 01D8                <1> 	add	ax, bx	; bx = interpolated middle (L)
  4201 0000198F D1D8                <1> 	rcr	ax, 1
  4202 00001991 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4203 00001994 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  4204 00001995 8006[D719]80        <1> 	add	byte [next_val_r+1], 80h
  4205 0000199A 89D0                <1> 	mov	ax, dx	; [previous_val_r]
  4206 0000199C 0306[D619]          <1> 	add	ax, [next_val_r]
  4207 000019A0 D1D8                <1> 	rcr	ax, 1
  4208 000019A2 92                  <1> 	xchg	ax, dx	
  4209 000019A3 01D0                <1> 	add	ax, dx	; dx = interpolated middle (R)
  4210 000019A5 D1D8                <1> 	rcr	ax, 1
  4211 000019A7 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4212 000019AA AB                  <1> 	stosw 		; interpolated sample 1 (R)
  4213 000019AB 89D8                <1> 	mov	ax, bx
  4214 000019AD 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4215 000019B0 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  4216 000019B1 89D0                <1> 	mov	ax, dx
  4217 000019B3 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4218 000019B6 AB                  <1> 	stosw 		; interpolated sample 2 (R)
  4219 000019B7 89D8                <1> 	mov	ax, bx
  4220 000019B9 0306[D419]          <1> 	add	ax, [next_val_l]
  4221 000019BD D1D8                <1> 	rcr	ax, 1
  4222 000019BF 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4223 000019C2 AB                  <1> 	stosw 		; interpolated sample 3 (L)
  4224 000019C3 89D0                <1> 	mov	ax, dx
  4225 000019C5 0306[D619]          <1> 	add	ax, [next_val_r]
  4226 000019C9 D1D8                <1> 	rcr	ax, 1
  4227 000019CB 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4228 000019CE AB                  <1> 	stosw 		; interpolated sample 3 (R)
  4229 000019CF C3                  <1> 	retn
  4230                              <1> 
  4231                              <1> ; 13/11/2023
  4232                              <1> previous_val:
  4233 000019D0 0000                <1> previous_val_l: dw 0
  4234 000019D2 0000                <1> previous_val_r: dw 0
  4235                              <1> next_val:
  4236 000019D4 0000                <1> next_val_l: dw 0
  4237 000019D6 0000                <1> next_val_r: dw 0
  4238                              <1> 
  4239                              <1> ; 16/11/2023
  4240 000019D8 00                  <1> faz:	db 0	
  4241                              <1> 	
  4242                              <1> ; --------------------------------------------------------
   457                                  
   458                                  ; UTILS.ASM
   459                                  ;----------------------------------------------------------------------------
   460                                  ;       delay1_4ms - Delay for 1/4 millisecond.
   461                                  ;		    1mS = 1000us
   462                                  ;       Entry:
   463                                  ;         None
   464                                  ;       Exit:
   465                                  ;	  None
   466                                  ;
   467                                  ;       Modified:
   468                                  ;         None
   469                                  ;
   470                                  PORTB			EQU	061h
   471                                    REFRESH_STATUS	EQU	010h		; Refresh signal status
   472                                  
   473                                  delay1_4ms:
   474 000019D9 50                              push    ax 
   475 000019DA 51                              push    cx
   476 000019DB B91000                          mov     cx, 16			; close enough.
   477 000019DE E461                    	in	al,PORTB
   478 000019E0 2410                    	and	al,REFRESH_STATUS
   479 000019E2 88C4                    	mov	ah,al			; Start toggle state
   480 000019E4 09C9                    	or	cx, cx
   481 000019E6 7401                    	jz	short _d4ms1
   482 000019E8 41                      	inc	cx			; Throwaway first toggle
   483                                  _d4ms1:	
   484 000019E9 E461                    	in	al,PORTB		; Read system control port
   485 000019EB 2410                    	and	al,REFRESH_STATUS	; Refresh toggles 15.085 microseconds
   486 000019ED 38C4                    	cmp	ah,al
   487 000019EF 74F8                    	je	short _d4ms1		; Wait for state change
   488                                  
   489 000019F1 88C4                    	mov	ah,al			; Update with new state
   490 000019F3 49                      	dec	cx
   491 000019F4 75F3                    	jnz	short _d4ms1
   492                                  
   493 000019F6 59                              pop     cx
   494 000019F7 58                              pop     ax
   495 000019F8 C3                              retn
   496                                  
   497                                  	; 13/11/2016 - Erdogan Tan
   498                                  write_ac97_dev_info:
   499                                  	; BUS/DEV/FN
   500                                  	;	00000000BBBBBBBBDDDDDFFF00000000
   501                                  	; DEV/VENDOR
   502                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
   503                                  
   504 000019F9 30FF                    	xor	bh, bh
   505 000019FB 668B36[1C1E]            	mov	esi, [dev_vendor]
   506 00001A00 89F0                    	mov	ax, si
   507 00001A02 88C3                    	mov	bl, al
   508 00001A04 88DA                    	mov	dl, bl
   509 00001A06 80E30F                  	and	bl, 0Fh
   510 00001A09 8A87[951C]              	mov	al, [bx+hex_chars]
   511 00001A0D A2[D81C]                	mov	[msgVendorId+3], al
   512 00001A10 88D3                    	mov	bl, dl
   513 00001A12 C0EB04                  	shr	bl, 4
   514 00001A15 8A87[951C]              	mov	al, [bx+hex_chars]
   515 00001A19 A2[D71C]                	mov	[msgVendorId+2], al
   516 00001A1C 88E3                    	mov	bl, ah
   517 00001A1E 88DA                    	mov	dl, bl
   518 00001A20 80E30F                  	and	bl, 0Fh
   519 00001A23 8A87[951C]              	mov	al, [bx+hex_chars]
   520 00001A27 A2[D61C]                	mov	[msgVendorId+1], al
   521 00001A2A 88D3                    	mov	bl, dl
   522 00001A2C C0EB04                  	shr	bl, 4
   523 00001A2F 8A87[951C]              	mov	al, [bx+hex_chars]
   524 00001A33 A2[D51C]                	mov	[msgVendorId], al
   525 00001A36 66C1EE10                	shr	esi, 16
   526 00001A3A 89F0                    	mov	ax, si
   527 00001A3C 88C3                    	mov	bl, al
   528 00001A3E 88DA                    	mov	dl, bl
   529 00001A40 80E30F                  	and	bl, 0Fh
   530 00001A43 8A87[951C]              	mov	al, [bx+hex_chars]
   531 00001A47 A2[E91C]                	mov	[msgDevId+3], al
   532 00001A4A 88D3                    	mov	bl, dl
   533 00001A4C C0EB04                  	shr	bl, 4
   534 00001A4F 8A87[951C]              	mov	al, [bx+hex_chars]
   535 00001A53 A2[E81C]                	mov	[msgDevId+2], al
   536 00001A56 88E3                    	mov	bl, ah
   537 00001A58 88DA                    	mov	dl, bl
   538 00001A5A 80E30F                  	and	bl, 0Fh
   539 00001A5D 8A87[951C]              	mov	al, [bx+hex_chars]
   540 00001A61 A2[E71C]                	mov	[msgDevId+1], al
   541 00001A64 88D3                    	mov	bl, dl
   542 00001A66 C0EB04                  	shr	bl, 4
   543 00001A69 8A87[951C]              	mov	al, [bx+hex_chars]
   544 00001A6D A2[E61C]                	mov	[msgDevId], al
   545                                  
   546 00001A70 668B36[181E]            	mov	esi, [bus_dev_fn]
   547 00001A75 66C1EE08                	shr	esi, 8
   548 00001A79 89F0                    	mov	ax, si
   549 00001A7B 88C3                    	mov	bl, al
   550 00001A7D 88DA                    	mov	dl, bl
   551 00001A7F 80E307                  	and	bl, 7 ; bit 0,1,2
   552 00001A82 8A87[951C]              	mov	al, [bx+hex_chars]
   553 00001A86 A2[0D1D]                	mov	[msgFncNo+1], al
   554 00001A89 88D3                    	mov	bl, dl
   555 00001A8B C0EB03                  	shr	bl, 3
   556 00001A8E 88DA                    	mov	dl, bl
   557 00001A90 80E30F                  	and	bl, 0Fh
   558 00001A93 8A87[951C]              	mov	al, [bx+hex_chars]
   559 00001A97 A2[FF1C]                	mov	[msgDevNo+1], al
   560 00001A9A 88D3                    	mov	bl, dl
   561 00001A9C C0EB04                  	shr	bl, 4
   562 00001A9F 8A87[951C]              	mov	al, [bx+hex_chars]
   563 00001AA3 A2[FE1C]                	mov	[msgDevNo], al
   564 00001AA6 88E3                    	mov	bl, ah
   565 00001AA8 88DA                    	mov	dl, bl
   566 00001AAA 80E30F                  	and	bl, 0Fh
   567 00001AAD 8A87[951C]              	mov	al, [bx+hex_chars]
   568 00001AB1 A2[F31C]                	mov	[msgBusNo+1], al
   569 00001AB4 88D3                    	mov	bl, dl
   570 00001AB6 C0EB04                  	shr	bl, 4
   571 00001AB9 8A87[951C]              	mov	al, [bx+hex_chars]
   572 00001ABD A2[F21C]                	mov	[msgBusNo], al
   573                                  
   574 00001AC0 A1[0E1E]                	mov	ax, [NAMBAR]
   575 00001AC3 88C3                    	mov	bl, al
   576 00001AC5 88DA                    	mov	dl, bl
   577 00001AC7 80E30F                  	and	bl, 0Fh
   578 00001ACA 8A87[951C]              	mov	al, [bx+hex_chars]
   579 00001ACE A2[1C1D]                	mov	[msgNamBar+3], al
   580 00001AD1 88D3                    	mov	bl, dl
   581 00001AD3 C0EB04                  	shr	bl, 4
   582 00001AD6 8A87[951C]              	mov	al, [bx+hex_chars]
   583 00001ADA A2[1B1D]                	mov	[msgNamBar+2], al
   584 00001ADD 88E3                    	mov	bl, ah
   585 00001ADF 88DA                    	mov	dl, bl
   586 00001AE1 80E30F                  	and	bl, 0Fh
   587 00001AE4 8A87[951C]              	mov	al, [bx+hex_chars]
   588 00001AE8 A2[1A1D]                	mov	[msgNamBar+1], al
   589 00001AEB 88D3                    	mov	bl, dl
   590 00001AED C0EB04                  	shr	bl, 4
   591 00001AF0 8A87[951C]              	mov	al, [bx+hex_chars]
   592 00001AF4 A2[191D]                	mov	[msgNamBar], al
   593                                  
   594                                  	; 08/05/2024 (ebx->bx)
   595                                  	; 05/11/2023
   596 00001AF7 A1[101E]                	mov	ax, [NABMBAR]
   597 00001AFA 88C3                    	mov	bl, al
   598 00001AFC 88DA                    	mov	dl, bl
   599 00001AFE 80E30F                  	and	bl, 0Fh
   600 00001B01 8A87[951C]              	mov	al, [bx+hex_chars]
   601 00001B05 A2[2B1D]                	mov	[msgNabmBar+3], al
   602 00001B08 88D3                    	mov	bl, dl
   603 00001B0A C0EB04                  	shr	bl, 4
   604 00001B0D 8A87[951C]              	mov	al, [bx+hex_chars]
   605 00001B11 A2[2A1D]                	mov	[msgNabmBar+2], al
   606 00001B14 88E3                    	mov	bl, ah
   607 00001B16 88DA                    	mov	dl, bl
   608 00001B18 80E30F                  	and	bl, 0Fh
   609 00001B1B 8A87[951C]              	mov	al, [bx+hex_chars]
   610 00001B1F A2[291D]                	mov	[msgNabmBar+1], al
   611 00001B22 88D3                    	mov	bl, dl
   612 00001B24 C0EB04                  	shr	bl, 4
   613 00001B27 8A87[951C]              	mov	al, [bx+hex_chars]
   614 00001B2B A2[281D]                	mov	[msgNabmBar], al
   615                                  
   616                                  	; 24/11/2016
   617 00001B2E 30E4                    	xor	ah, ah
   618 00001B30 A0[051E]                	mov	al, [ac97_int_ln_reg]
   619 00001B33 B10A                    	mov	cl, 10
   620 00001B35 F6F1                    	div	cl
   621 00001B37 0106[331D]              	add	[msgIRQ], ax
   622 00001B3B 20C0                    	and	al, al
   623 00001B3D 7508                    	jnz	short _pmi
   624 00001B3F A0[341D]                	mov	al, [msgIRQ+1]
   625 00001B42 B420                    	mov	ah, ' '
   626 00001B44 A3[331D]                	mov	[msgIRQ], ax
   627                                  _pmi:
   628 00001B47 BA[A61C]                        mov	dx, msgAC97Info
   629 00001B4A B409                            mov     ah, 9
   630 00001B4C CD21                            int     21h
   631 00001B4E C3                              retn
   632                                  
   633                                  write_sample_rate:
   634                                  	; ax = sample rate (hertz)
   635                                  
   636 00001B4F 31D2                    	xor	dx, dx
   637 00001B51 B90A00                  	mov	cx, 10
   638 00001B54 F7F1                    	div	cx
   639 00001B56 0016[491D]              	add	[msgHertz+4], dl
   640 00001B5A 29D2                    	sub	dx, dx
   641 00001B5C F7F1                    	div	cx
   642 00001B5E 0016[481D]              	add	[msgHertz+3], dl
   643 00001B62 29D2                    	sub	dx, dx
   644 00001B64 F7F1                    	div	cx
   645 00001B66 0016[471D]              	add	[msgHertz+2], dl
   646 00001B6A 29D2                    	sub	dx, dx
   647 00001B6C F7F1                    	div	cx
   648 00001B6E 0016[461D]              	add	[msgHertz+1], dl
   649 00001B72 0006[451D]              	add	[msgHertz], al
   650                                  	
   651 00001B76 BA[381D]                        mov     dx, msgSampleRate
   652 00001B79 B409                            mov     ah, 9
   653 00001B7B CD21                            int     21h
   654                                  
   655                                  	; 19/11/2016
   656 00001B7D BA[5E1D]                	mov	dx, msg16Bits
   657 00001B80 803E[241E]10            	cmp	byte [bps], 16
   658 00001B85 7403                    	je	short wsr_1
   659 00001B87 BA[4F1D]                	mov	dx, msg8Bits
   660                                  wsr_1:
   661 00001B8A B409                            mov     ah, 9
   662 00001B8C CD21                            int     21h
   663                                  
   664 00001B8E BA[571D]                	mov	dx, msgMono
   665 00001B91 803E[221E]01            	cmp	byte [stmo], 1
   666 00001B96 7403                    	je	short wsr_2
   667 00001B98 BA[671D]                	mov	dx, msgStereo		
   668                                  wsr_2:
   669 00001B9B B409                            mov     ah, 9
   670 00001B9D CD21                            int     21h
   671                                  
   672 00001B9F C3                              retn
   673                                  
   674                                  ;detect_codec:
   675                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   676                                  ;	mov	eax, 7Ch
   677                                  ;	call	codec_read
   678                                  ;       shl     eax, 16
   679                                  ;       mov     [codec_id], eax
   680                                  ;
   681                                  ;	mov	eax, 7Eh
   682                                  ;       call	codec_read
   683                                  ;       or      eax, [codec_id]
   684                                  ;       mov     [codec_chip_id], eax
   685                                  ;       and     eax, 0FFFFFF00h
   686                                  ;
   687                                  ;       mov     edi, codecs
   688                                  ;_dcb:
   689                                  ;       mov     ebx, [di]
   690                                  ;       test    ebx, ebx
   691                                  ;       jz      short _dco_unknown
   692                                  ;
   693                                  ;       cmp     eax, ebx
   694                                  ;       jne     short _dco_next
   695                                  ;       mov     ax, [di+4]
   696                                  ;       mov     [codec_vendor_ids], ax
   697                                  ;       movzx   esi, ax
   698                                  ;       call	print_msg
   699                                  ;       
   700                                  ;	mov	ax, [di+6]
   701                                  ;	call	detect_chip
   702                                  ;       retn
   703                                  ;
   704                                  ;_dco_next:
   705                                  ;       add     di, 8
   706                                  ;       jmp     short _dcb
   707                                  ;
   708                                  ;_dco_unknown:
   709                                  ;       mov    word [codec_vendor_ids], ac_unknown
   710                                  ;       mov    word [codec_chip_ids], chip_unknown
   711                                  ;       mov     esi, chip_unknown
   712                                  ;	call	print_msg
   713                                  ;       mov     eax, [codec_chip_id]
   714                                  ;       call    dword2str
   715                                  ;       call	print_msg
   716                                  ;       retn
   717                                  
   718                                  ;detect_chip:
   719                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   720                                  ;	mov	di, ax ; chip_tab
   721                                  ;       mov     eax, [codec_chip_id]
   722                                  ;       and     ax, 0FFh
   723                                  ;_dch1:
   724                                  ;       mov     bx, [di]
   725                                  ;       cmp     bx, 0FFh
   726                                  ;       je      short _dch_unknown
   727                                  ;
   728                                  ;       cmp     ax, bx
   729                                  ;       jne     short _dch_next
   730                                  ;       mov     ax, [di+2]
   731                                  ;       mov     [codec_chip_ids], ax
   732                                  ;       mov     si, ax
   733                                  ;       call	print_msg
   734                                  ;       retn
   735                                  
   736                                  ;_dch_next:
   737                                  ;       add     di, 4
   738                                  ;       jmp     short _dch1
   739                                  ;
   740                                  ;_dch_unknown:
   741                                  ;       mov    word [codec_chip_ids], chip_unknown
   742                                  ;       mov     si, chip_unknown
   743                                  ;       call	print_msg
   744                                  ;       mov     eax, [codec_chip_id]
   745                                  ;       call    dword2str
   746                                  ;       call	print_msg
   747                                  ;       retn
   748                                  
   749                                  ; 19/05/2024
   750                                  ; 10/11/2023
   751                                  ; 09/11/2023
   752                                  ; 06/11/2023
   753                                  %if 1
   754                                  
   755                                  ac97_int_handler:
   756                                  	; 19/05/2024
   757                                  	; 16/05/2024 ('PLAYMOD3.ASM', 18/05/2024, Erdogan Tan)
   758                                  	; 11/11/2023
   759                                  	; 10/11/2023
   760                                  	; 17/02/2016
   761 00001BA0 50                      	push	ax ; +	; 16/05/2024
   762                                  	;push	eax ; *	; 11/11/2023
   763 00001BA1 52                      	push	dx ; **
   764                                  	; 05/11/2023
   765                                  	;push	cx
   766                                  	;push	bx
   767                                  	;push	si
   768                                  	;push	di
   769                                  
   770                                  	; 10/11/2023
   771                                  	; EOI at first
   772 00001BA2 B020                    	mov	al, 20h
   773 00001BA4 F606[051E]08            	test	byte [ac97_int_ln_reg], 8
   774 00001BA9 7402                    	jz	short _ih_0
   775 00001BAB E6A0                    	out 	0A0h, al ; 20h	; EOI
   776                                  _ih_0:
   777 00001BAD E620                    	out	20h, al  ; 20h	; EOI
   778                                  
   779                                  	; 16/05/2024
   780                                  ;	mov	dx, GLOB_STS_REG
   781                                  ;	add	dx, [NABMBAR]
   782                                  ;	in	eax, dx
   783                                  ;
   784                                  ;	inc	eax	; 0FFFFFFFFh
   785                                  ;	jz	short _ih_3
   786                                  ;	dec	eax	; 0
   787                                  ;	;jz	short _ih_3
   788                                  ;_ih_3:
   789                                  ;	; 16/05/2024
   790                                  ;	push	eax ; ***
   791                                  
   792                                  	; 16/05/2024
   793                                  	; 24/11/2023 (TRDOS386 'audio.s')
   794 00001BAF 8B16[101E]                      mov	dx, [NABMBAR]
   795 00001BB3 83C216                  	add	dx, PO_SR_REG
   796 00001BB6 ED                      	in	ax, dx
   797                                  
   798 00001BB7 A808                    	test	al, BCIS ; bit 3, 8
   799 00001BB9 7405                    	jz	short _ih_2
   800                                  
   801                                  	; 19/05/2024
   802                                  	; 15/05/2024
   803                                  	;cmp	byte [tLoop], 1
   804                                  	;jb	short _ih_2
   805                                  
   806                                  _ih_1:
   807                                  	; 19/05/2024
   808 00001BBB 50                      	push	ax ; ****
   809                                  
   810                                  	; 10/11/2023
   811                                  	; 28/11/2016 - Erdogan Tan
   812 00001BBC E8B6EB                  	call	tuneLoop
   813                                  
   814                                  	; 19/05/2024
   815 00001BBF 58                      	pop	ax ; ****
   816                                  
   817                                  	; 16/05/2024
   818                                  _ih_2:
   819                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   820 00001BC0 8B16[101E]              	mov	dx, [NABMBAR]
   821 00001BC4 83C216                  	add	dx, PO_SR_REG
   822 00001BC7 EF                      	out	dx, ax
   823                                  
   824                                  ;	; 16/05/2024
   825                                  ;	pop	eax ; ***
   826                                  ;	
   827                                  ;	or	eax, eax
   828                                  ;	jz	short _ih_4
   829                                  ;	
   830                                  ;	mov	dx, GLOB_STS_REG
   831                                  ;	add	dx, [NABMBAR]
   832                                  ;	out	dx, eax
   833                                  
   834                                  	; 16/05/2024
   835                                  _ih_4:
   836                                  	; 10/11/2023
   837                                  	;mov	al, 20h
   838                                  	;test	byte [ac97_int_ln_reg], 8
   839                                  	;jz	short _ih_5
   840                                  	;out 	0A0h, al ; 20h	; EOI
   841                                  ;_ih_5:
   842                                  	;out	20h, al  ; 20h	; EOI
   843                                  ;_ih_6:
   844                                  	;pop	di
   845                                  	;pop	si
   846                                  	;pop	bx
   847                                  	;pop	cx
   848 00001BC8 5A                      	pop	dx ; **
   849                                  	;pop	eax ; *	; 11/11/2023
   850 00001BC9 58                      	pop	ax ; + ; 16/05/2024
   851 00001BCA CF                      	iret
   852                                  
   853                                  %else
   854                                  
   855                                  ac97_int_handler:
   856                                  	; 11/11/2023
   857                                  	; 10/11/2023
   858                                  	; 17/02/2016
   859                                  	push	eax	; 11/11/2023
   860                                  	push	dx
   861                                  	; 05/11/2023
   862                                  	;push	cx
   863                                  	;push	bx
   864                                  	;push	si
   865                                  	;push	di
   866                                  
   867                                  	; 10/11/2023
   868                                  	; EOI at first
   869                                  	mov	al, 20h
   870                                  	test	byte [ac97_int_ln_reg], 8
   871                                  	jz	short _ih_0
   872                                  	out 	0A0h, al ; 20h	; EOI
   873                                  _ih_0:
   874                                  	out	20h, al  ; 20h	; EOI
   875                                  
   876                                  	; 11/11/2023
   877                                  	; 09/11/2023
   878                                  	mov	dx, GLOB_STS_REG
   879                                          add	dx, [NABMBAR]
   880                                  	in	eax, dx
   881                                  	
   882                                  	; 09/11/2023,
   883                                          cmp	eax, 0FFFFFFFFh ; -1
   884                                  	je	short _ih_2
   885                                  	
   886                                  	test	al, 40h		; PCM Out Interrupt
   887                                  	jnz	short _ih_1
   888                                  
   889                                  	test	eax, eax
   890                                  	jz	short _ih_2
   891                                  
   892                                   	;mov	dx, GLOB_STS_REG
   893                                          ;add	dx, [NABMBAR]
   894                                  	out	dx, eax
   895                                  	jmp	short _ih_2
   896                                  
   897                                  	; .....
   898                                  	;mov	al, 1
   899                                  	; 10/11/2023
   900                                  	;mov	[tloop], al  ; 1
   901                                  
   902                                  	;cmp	[inside], al ; 1
   903                                  	;jnb	short _ih_3	; busy
   904                                  
   905                                  	;mov	[inside], al ; 1
   906                                  	;
   907                                  	;; 09/11/2023
   908                                          ;mov	dx, [NABMBAR]
   909                                          ;add	dx, PO_SR_REG	; set pointer to Status reg
   910                                  	;in	al, dx
   911                                  	;; 10/11/2023
   912                                  	;;;out	dx, eax
   913                                  	;;out	dx, al		; clear interrupt event
   914                                  	;			; (by writing 1 to same bits)
   915                                  	;
   916                                  	;;mov	[pcm_irq_status], al ; 05/11/2023
   917                                  	;test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
   918                                  	;jz	short _ih_2
   919                                  	; .....
   920                                  
   921                                  _ih_1:
   922                                  	; 11/11/2023
   923                                  	push	eax
   924                                  
   925                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   926                                  	;mov	dx, PO_SR_REG
   927                                          ;add	dx, [NABMBAR]
   928                                  	;out	dx, ax
   929                                  
   930                                  	; 10/11/2023
   931                                  	; 28/11/2016 - Erdogan Tan
   932                                  	call	tuneLoop
   933                                  
   934                                  	; 11/11/2023
   935                                  	pop	eax
   936                                  	mov	dx, GLOB_STS_REG
   937                                          add	dx, [NABMBAR]
   938                                  	out	dx, eax
   939                                  _ih_2:
   940                                  	; 11/11/2023
   941                                  	mov	dx, [NABMBAR]
   942                                  	add	dx, PO_SR_REG	; set pointer to Status reg
   943                                  	mov	ax, 1Ch
   944                                  	out	dx, ax
   945                                  
   946                                  ;	; 10/11/2023
   947                                  ;	mov	al, 20h
   948                                  ;	test	byte [ac97_int_ln_reg], 8
   949                                  ;	jz	short _ih_3
   950                                  ;	out 	0A0h, al ; 20h	; EOI
   951                                  ;_ih_3:
   952                                  ;	out	20h, al  ; 20h	; EOI
   953                                  ;_ih_4:
   954                                  	;mov	byte [inside], 0
   955                                  	;pop	di
   956                                  	;pop	si
   957                                  	;pop	bx
   958                                  	;pop	cx
   959                                  	pop	dx
   960                                  	pop	eax ; 11/11/2023
   961                                  	iret
   962                                  
   963                                  %endif
   964                                  
   965                                  ; 10/11/2023
   966                                  ; 09/11/2023
   967                                  ; 06/11/2023
   968                                  %if 0
   969                                  
   970                                  ac97_int_handler:
   971                                  	; 10/11/2023
   972                                  	; 17/02/2016
   973                                  	push	ax	; 09/11/2023
   974                                  	push	dx
   975                                  	; 05/11/2023
   976                                  	;push	cx
   977                                  	;push	bx
   978                                  	;push	si
   979                                  	;push	di
   980                                  
   981                                  	; 10/11/2023
   982                                  	; EOI at first
   983                                  	mov	al, 20h
   984                                  	test	byte [ac97_int_ln_reg], 8
   985                                  	jz	short _ih_0
   986                                  	out 	0A0h, al ; 20h	; EOI
   987                                  _ih_0:
   988                                  	out	20h, al  ; 20h	; EOI
   989                                  
   990                                  	mov	al, 1
   991                                  
   992                                  	; 10/11/2023
   993                                  	;mov	[tloop], al  ; 1
   994                                  
   995                                  	cmp	[inside], al ; 1
   996                                  	jnb	short _ih_3	; busy
   997                                  
   998                                  	mov	[inside], al ; 1
   999                                  
  1000                                  	; 09/11/2023
  1001                                          mov	dx, [NABMBAR]
  1002                                          add	dx, PO_SR_REG	; set pointer to Status reg
  1003                                  	in	al, dx
  1004                                  	; 10/11/2023
  1005                                  	;out	dx, eax
  1006                                  	out	dx, al		; clear interrupt event
  1007                                  				; (by writing 1 to same bits)
  1008                                  
  1009                                  	;mov	[pcm_irq_status], al ; 05/11/2023
  1010                                  	test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
  1011                                  	jz	short _ih_2
  1012                                  	
  1013                                  	; 09/11/2023
  1014                                  	;mov	dx, GLOB_STS_REG
  1015                                          ;add	dx, [NABMBAR]
  1016                                  	;in	eax, dx
  1017                                  	
  1018                                  	; 09/11/2023,
  1019                                          ;cmp	eax, 0FFFFFFFFh ; -1
  1020                                  	;je	short _ih_2
  1021                                  	
  1022                                  	;test	al, 40h		; PCM Out Interrupt
  1023                                  	;jz	short _ih_2
  1024                                  _ih_1:
  1025                                  	; 10/11/2023
  1026                                  	; 28/11/2016 - Erdogan Tan
  1027                                  	call	tuneLoop
  1028                                  	;jnc	short _ih_2
  1029                                  	;dec	byte [tloop] ; [tloop] = 0
  1030                                  _ih_2:
  1031                                  	mov	byte [inside], 0
  1032                                  _ih_3:
  1033                                  	;pop	di
  1034                                  	;pop	si
  1035                                  	;pop	bx
  1036                                  	;pop	cx
  1037                                  	pop	dx
  1038                                  	pop	ax ; 09/11/2023
  1039                                  	iret
  1040                                  
  1041                                  %endif
  1042                                  
  1043                                  ac97_stop:
  1044                                  	; 11/11/2023
  1045                                  	; 09/11/2023
  1046                                  	; 05/11/2023
  1047                                  	; 04/11/2023 
  1048                                  	; 28/05/2017 (TRDOS 386 v2, 'audio.s')
  1049                                  	;mov	byte [tLoop], 0 ; stop ! ; 05/11/2023
  1050                                  ;_ac97_stop:
  1051                                  
  1052                                  	; 11/11/2023
  1053 00001BCB 8B16[0E1E]              	mov	dx, [NAMBAR]
  1054                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  1055 00001BCF EF                      	out	dx, ax
  1056                                  
  1057                                  	; 04/11/2023
  1058                                  	; 09/10/2017 (TRDOS 386 v2, 'audio.s')
  1059                                  	; 11/06/2017
  1060 00001BD0 30C0                    	xor	al, al ; 0
  1061 00001BD2 E80D00                  	call	ac97_po_cmd
  1062                                  
  1063                                  	; (Ref: KolibriOS, intelac97.asm, 'stop:')
  1064                                  	; Clear FIFOE, BCIS, LVBCI (Ref: Intel ICH hub manual)
  1065 00001BD5 B81C00                  	mov     ax, 1Ch
  1066 00001BD8 8B16[101E]              	mov     dx, [NABMBAR]
  1067 00001BDC 83C216                  	add     dx, PO_SR_REG
  1068 00001BDF EF                      	out     dx, ax
  1069                                  
  1070                                  	; 11/06/2017
  1071 00001BE0 B002                    	mov     al, RR
  1072                                  ac97_po_cmd:
  1073                                  	; 11/06/2017
  1074                                  	; 29/05/2017
  1075 00001BE2 8B16[101E]              	mov     dx, [NABMBAR]
  1076 00001BE6 83C21B                          add     dx, PO_CR_REG		; PCM out control register
  1077 00001BE9 EE                      	out	dx, al
  1078 00001BEA C3                      	retn
  1079                                  
  1080                                  print_msg:
  1081                                  	; 13/11/2016 - Erdogan Tan 
  1082                                  	; esi = ASCIIZ text address
  1083                                  	;
  1084 00001BEB BB0700                  	mov	bx, 7h
  1085 00001BEE B40E                    	mov	ah, 0Eh 
  1086                                  pm_next_char:
  1087 00001BF0 AC                      	lodsb
  1088 00001BF1 20C0                    	and	al, al
  1089 00001BF3 7404                    	jz	short pm_retn
  1090 00001BF5 CD10                    	int	10h
  1091 00001BF7 EBF7                    	jmp	short pm_next_char
  1092                                  pm_retn:
  1093 00001BF9 C3                      	retn
  1094                                  
  1095                                  ; 06/11/2023
  1096                                  ;dword2str:
  1097                                  ;	; 13/11/2016 - Erdogan Tan 
  1098                                  ;	; eax = dword value
  1099                                  ;	;
  1100                                  ;	call	dwordtohex
  1101                                  ;	mov	[dword_str], edx
  1102                                  ;	mov	[dword_str+4], eax
  1103                                  ;	mov	si, dword_str
  1104                                  ;	retn
  1105                                  
  1106                                  	; trdos386.s (unix386.s) - 10/05/2015
  1107                                  	; Convert binary number to hexadecimal string
  1108                                  
  1109                                  bytetohex:
  1110                                  	; INPUT ->
  1111                                  	; 	AL = byte (binary number)
  1112                                  	; OUTPUT ->
  1113                                  	;	AX = hexadecimal string
  1114                                  	;
  1115 00001BFA 53                      	push	bx
  1116 00001BFB 30FF                    	xor	bh, bh
  1117 00001BFD 88C3                    	mov	bl, al
  1118 00001BFF C0EB04                  	shr	bl, 4
  1119 00001C02 8A9F[951C]              	mov	bl, [bx+hex_chars] 	 	
  1120 00001C06 86D8                    	xchg	bl, al
  1121 00001C08 80E30F                  	and	bl, 0Fh
  1122 00001C0B 8AA7[951C]              	mov	ah, [bx+hex_chars] 
  1123 00001C0F 5B                      	pop	bx	
  1124 00001C10 C3                      	retn
  1125                                  
  1126                                  wordtohex:
  1127                                  	; INPUT ->
  1128                                  	; 	AX = word (binary number)
  1129                                  	; OUTPUT ->
  1130                                  	;	EAX = hexadecimal string
  1131                                  	;
  1132 00001C11 53                      	push	bx
  1133 00001C12 30FF                    	xor	bh, bh
  1134 00001C14 86E0                    	xchg	ah, al
  1135 00001C16 50                      	push	ax
  1136 00001C17 88E3                    	mov	bl, ah
  1137 00001C19 C0EB04                  	shr	bl, 4
  1138 00001C1C 8A87[951C]              	mov	al, [bx+hex_chars] 	 	
  1139 00001C20 88E3                    	mov	bl, ah
  1140 00001C22 80E30F                  	and	bl, 0Fh
  1141 00001C25 8AA7[951C]              	mov	ah, [bx+hex_chars]
  1142 00001C29 66C1E010                	shl	eax, 16
  1143 00001C2D 58                      	pop	ax
  1144 00001C2E 5B                      	pop	bx
  1145 00001C2F EBC9                    	jmp	short bytetohex
  1146                                  
  1147                                  ; 06/11/2023
  1148                                  ;dwordtohex:
  1149                                  ;	; INPUT ->
  1150                                  ;	; 	EAX = dword (binary number)
  1151                                  ;	; OUTPUT ->
  1152                                  ;	;	EDX:EAX = hexadecimal string
  1153                                  ;	;
  1154                                  ;	push	eax
  1155                                  ;	shr	eax, 16
  1156                                  ;	call	wordtohex
  1157                                  ;	mov	edx, eax
  1158                                  ;	pop	eax
  1159                                  ;	call	wordtohex
  1160                                  ;	retn
  1161                                  
  1162                                  _DATA:
  1163                                  
  1164                                  ; 24/11/2016
  1165                                  ;	IRQ  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 
  1166 00001C31 08090A0B0C0D0E0F70-     irq_int	 db 08h,09h,0Ah,0Bh,0Ch,0Dh,0Eh,0Fh,70h,71h,72h,73h,74h,75h,76h,77h
  1166 00001C3A 71727374757677     
  1167                                  
  1168                                  ; 17/02/2017
  1169                                  ; Valid ICH device IDs
  1170                                  
  1171                                  valid_ids:
  1172 00001C41 86801524                dd	(ICH_DID << 16) + INTEL_VID  	 ; 8086h:2415h 
  1173 00001C45 86802524                dd	(ICH0_DID << 16) + INTEL_VID 	 ; 8086h:2425h 
  1174 00001C49 86804524                dd	(ICH2_DID << 16) + INTEL_VID 	 ; 8086h:2445h 
  1175 00001C4D 86808524                dd	(ICH3_DID << 16) + INTEL_VID 	 ; 8086h:2485h 
  1176 00001C51 8680C524                dd	(ICH4_DID << 16) + INTEL_VID 	 ; 8086h:24C5h
  1177 00001C55 8680D524                dd	(ICH5_DID << 16) + INTEL_VID 	 ; 8086h:24D5h
  1178 00001C59 86806E26                dd	(ICH6_DID << 16) + INTEL_VID 	 ; 8086h:266Eh
  1179 00001C5D 8680A625                dd	(ESB6300_DID << 16) + INTEL_VID  ; 8086h:25A6h
  1180 00001C61 86809826                dd	(ESB631X_DID << 16) + INTEL_VID  ; 8086h:2698h
  1181 00001C65 8680DE27                dd	(ICH7_DID << 16) + INTEL_VID 	 ; 8086h:27DEh
  1182                                  ; 03/11/2023 - Erdogan Tan
  1183 00001C69 86809571                dd	(MX82440_DID << 16) + INTEL_VID  ; 8086h:7195h
  1184 00001C6D 39101270                dd	(SI7012_DID << 16)  + SIS_VID	 ; 1039h:7012h
  1185 00001C71 DE10B101                dd 	(NFORCE_DID << 16)  + NVIDIA_VID ; 10DEh:01B1h
  1186 00001C75 DE106A00                dd 	(NFORCE2_DID << 16) + NVIDIA_VID ; 10DEh:006Ah
  1187 00001C79 22106D74                dd 	(AMD8111_DID << 16) + AMD_VID 	 ; 1022h:746Dh
  1188 00001C7D 22104574                dd 	(AMD768_DID << 16)  + AMD_VID 	 ; 1022h:7445h
  1189 00001C81 DE105900                dd 	(CK804_DID << 16) + NVIDIA_VID	 ; 10DEh:0059h
  1190 00001C85 DE103A00                dd 	(MCP04_DID << 16) + NVIDIA_VID	 ; 10DEh:003Ah
  1191 00001C89 DE108A00                dd 	(CK8_DID << 16) + NVIDIA_VID	 ; 1022h:008Ah
  1192 00001C8D DE10DA00                dd 	(NFORCE3_DID << 16) + NVIDIA_VID ; 10DEh:00DAh
  1193 00001C91 DE10EA00                dd 	(CK8S_DID << 16) + NVIDIA_VID	 ; 10DEh:00EAh
  1194                                  
  1195                                  valid_id_count:	equ ($ - valid_ids)>>2 ; 05/11/2023
  1196                                  
  1197                                  ; 13/11/2016
  1198 00001C95 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  1198 00001C9E 3941424344454600   
  1199 00001CA6 414339372041756469-     msgAC97Info	db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  1199 00001CAF 6F20436F6E74726F6C-
  1199 00001CB8 6C6572202620436F64-
  1199 00001CC1 656320496E666F0D0A 
  1200 00001CCA 56656E646F72204944-     		db "Vendor ID: "
  1200 00001CD3 3A20               
  1201 00001CD5 303030306820446576-     msgVendorId	db "0000h Device ID: "
  1201 00001CDE 6963652049443A20   
  1202 00001CE6 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  1203 00001CED 4275733A20              		db "Bus: "
  1204 00001CF2 303068204465766963-     msgBusNo	db "00h Device: "
  1204 00001CFB 653A20             
  1205 00001CFE 3030682046756E6374-     msgDevNo	db "00h Function: "
  1205 00001D07 696F6E3A20         
  1206 00001D0C 303068                  msgFncNo	db "00h"
  1207 00001D0F 0D0A                    		db 0Dh, 0Ah
  1208                                  ; 05/11/2023	
  1209 00001D11 4E414D4241523A20        		db "NAMBAR: "
  1210 00001D19 303030306820            msgNamBar	db "0000h "
  1211 00001D1F 4E41424D4241523A20      		db "NABMBAR: "
  1212 00001D28 303030306820495251-     msgNabmBar	db "0000h IRQ: "
  1212 00001D31 3A20               
  1213 00001D33 3030                    msgIRQ		dw 3030h
  1214 00001D35 0D0A24                  		db 0Dh, 0Ah, "$"
  1215 00001D38 53616D706C65205261-     msgSampleRate	db "Sample Rate: "
  1215 00001D41 74653A20           
  1216 00001D45 303030303020487A20-     msgHertz	db "00000 Hz ", "$" 
  1216 00001D4E 24                 
  1217 00001D4F 3820626974732024        msg8Bits	db "8 bits ", "$" 
  1218 00001D57 4D6F6E6F0D0A24          msgMono		db "Mono", 0Dh, 0Ah, "$"
  1219 00001D5E 313620626974732024      msg16Bits	db "16 bits ", "$" 
  1220 00001D67 53746572656F0D0A24      msgStereo	db "Stereo", 0Dh, 0Ah, "$"
  1221                                  
  1222                                  ;; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
  1223                                  ;codec_id	dd 0
  1224                                  ;codec_chip_id	dd 0
  1225                                  ;codec_vendor_ids dw 0
  1226                                  ;codec_chip_ids	dw 0
  1227                                  
  1228 00001D70 3030303030303030        dword_str	 dd 30303030h, 30303030h
  1229 00001D78 680D0A00                		 db 'h', 0Dh, 0Ah, 0
  1230                                  
  1231                                  ;ac_unknown     db 'unknown manufacturer',13,10,0
  1232                                  ;ac_Realtek     db 'Realtek Semiconductor',13,10,0
  1233                                  ;ac_Analog      db 'Analog Devices',13,10,0
  1234                                  ;ac_CMedia      db 'C-Media Electronics',13,10,0
  1235                                  ;ac_Cirrus      db 'Cirrus Logic',13,10,0
  1236                                  ;ac_Wolfson     db 'Wolfson Microelectronics',13,10,0
  1237                                  ;ac_VIA         db 'VIA Technologies',13,10,0
  1238                                  ;ac_SigmaTel    db 'SigmaTel',13,10,0
  1239                                  ;ac_eMicro      db 'eMicro',13,10,0
  1240                                  ;
  1241                                  ;chip_unknown   db 'unknown codec id ', 0
  1242                                  
  1243                                  ;CHIP_REALTEK   equ 414C4700h
  1244                                  ;CHIP_CMEDIA    equ 434D4900h
  1245                                  ;CHIP_VIA       equ 56494100h
  1246                                  
  1247                                  ;codecs        dd CHIP_CMEDIA
  1248                                  ;	       dw ac_CMedia, chips_CMedia
  1249                                  ;              dd CHIP_REALTEK
  1250                                  ;	       dw ac_Realtek, chips_Realtek
  1251                                  ;              dd CHIP_VIA
  1252                                  ;	       dw ac_VIA, chips_VIA
  1253                                  ;              dd 0
  1254                                  
  1255                                  ;chips_Realtek dw 10h, chip_ALC201a
  1256                                  ;              dw 20h, chip_ALC650
  1257                                  ;              dw 21h, chip_ALC650D
  1258                                  ;              dw 22h, chip_ALC650E
  1259                                  ;              dw 23h, chip_ALC650F
  1260                                  ;              dw 60h, chip_ALC655
  1261                                  ;              dw 80h, chip_ALC658
  1262                                  ;              dw 81h, chip_ALC658D
  1263                                  ;              dw 90h, chip_ALC850
  1264                                  ;              dw 0FFh
  1265                                  
  1266                                  ;chips_CMedia  dw 41h, chip_CM9738
  1267                                  ;              dw 61h, chip_CM9739
  1268                                  ;              dw 69h, chip_CM9780
  1269                                  ;              dw 78h, chip_CM9761
  1270                                  ;              dw 82h, chip_CM9761
  1271                                  ;              dw 83h, chip_CM9761
  1272                                  ;              dw 0FFh
  1273                                  
  1274                                  ;chips_VIA     dw 61h, chip_VIA1612A
  1275                                  ;              dw 0FFh
  1276                                  
  1277                                  ;Realtek
  1278                                  ;chip_ALC201a    db 'ALC201a',0dh,0ah,00h
  1279                                  ;chip_ALC650     db 'ALC650 ',0dh,0ah,00h
  1280                                  ;chip_ALC650D    db 'ALC650D',0dh,0ah,00h
  1281                                  ;chip_ALC650E    db 'ALC650E',0dh,0ah,00h
  1282                                  ;chip_ALC650F    db 'ALC650F',0dh,0ah,00h
  1283                                  ;chip_ALC655     db 'ALC655 ',0dh,0ah,00h
  1284                                  ;chip_ALC658     db 'ALC658 ',0dh,0ah,00h
  1285                                  ;chip_ALC658D    db 'ALC658D',0dh,0ah,00h
  1286                                  ;chip_ALC850     db 'ALC850 ',0dh,0ah,00h
  1287                                  
  1288                                  ;CMedia
  1289                                  ;chip_CM9738     db 'CMI9738', 0dh,0ah,0
  1290                                  ;chip_CM9739     db 'CMI9739', 0dh,0ah,0
  1291                                  ;chip_CM9780     db 'CMI9780', 0dh,0ah,0
  1292                                  ;chip_CM9761     db 'CMI9761', 0dh,0ah,0
  1293                                  
  1294                                  ;VIA
  1295                                  ;chip_VIA1612A   db 'VIA1612A',13,10,0
  1296                                  
  1297                                  ; 11/11/2023
  1298                                  msg_init_err:
  1299 00001D7C 0D0A                    	db	CR, LF
  1300 00001D7E 4143393720436F6E74-     	db	"AC97 Controller/Codec initialization error !"
  1300 00001D87 726F6C6C65722F436F-
  1300 00001D90 64656320696E697469-
  1300 00001D99 616C697A6174696F6E-
  1300 00001DA2 206572726F722021   
  1301 00001DAA 0D0A24                  	db	CR, LF, "$"
  1302                                  
  1303                                  ; 12/11/2023
  1304                                  msg_no_vra:
  1305 00001DAD 0D0A                    	db	CR, LF
  1306 00001DAF 4E6F20565241207375-     	db	"No VRA support ! Only 48 kHZ sample rate supported !"
  1306 00001DB8 70706F72742021204F-
  1306 00001DC1 6E6C79203438206B48-
  1306 00001DCA 5A2073616D706C6520-
  1306 00001DD3 726174652073757070-
  1306 00001DDC 6F727465642021     
  1307 00001DE3 0D0A24                  	db	CR, LF, "$"
  1308                                  
  1309                                  ; 17/02/2017
  1310                                  bss_start:
  1311                                  
  1312                                  ABSOLUTE bss_start
  1313                                  
  1314                                  alignb 2
  1315                                  
  1316                                  ; 28/11/2016
  1317                                  
  1318 00001DE6 <res 1Ch>               smpRBuff:	resw 14 ; 19/11/2016 - Erdogan Tan
  1319                                  
  1320 00001E02 ????                    filehandle:	resw 1
  1321                                  
  1322 00001E04 ??                      flags:		resb 1
  1323                                  ; 06/11/2023
  1324 00001E05 ??                      ac97_int_ln_reg: resb 1
  1325                                  
  1326                                  ; 09/11/2023
  1327                                  ; 06/11/2023
  1328                                  ;pcm_irq_status: resb 1	; 05/11/2023
  1329 00001E06 ??                      inside:		resb 1
  1330 00001E07 ??                      tloop:		resb 1	; 10/11/2023
  1331                                  
  1332                                  ; 09/11/2023
  1333                                  ; 04/11/2023 - 06/11/2023
  1334 00001E08 ????                    IRQ_status:	resw 1	; IRQ status before enabling audio interrupt
  1335 00001E0A ????????                IRQ_vector:	resd 1  ; Previous interrupt handler address	
  1336                                  
  1337                                  ; 17/02/2017
  1338                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  1339                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  1340                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  1341                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  1342 00001E0E ????                    NAMBAR:		resw 1			; BAR for mixer
  1343 00001E10 ????                    NABMBAR:	resw 1			; BAR for bus master regs
  1344                                  
  1345                                  ; 256 byte buffer for descriptor list
  1346 00001E12 ????                    BDL_BUFFER:	resw 1			; segment of our 256byte BDL buffer
  1347 00001E14 ????                    WAV_BUFFER1:	resw 1			; segment of our WAV storage
  1348                                  ; 64k buffers for wav file storage
  1349 00001E16 ????                    WAV_BUFFER2:	resw 1			; segment of 2nd wav buffer
  1350                                  
  1351                                  ; 06/11/2023
  1352                                  ;tBuff:		resb 1
  1353                                  ;ac97_int_ln_reg: resb 1
  1354                                  
  1355                                  ; 12/11/2016 - Erdogan Tan
  1356                                  
  1357 00001E18 ????????                bus_dev_fn:	resd 1
  1358 00001E1C ????????                dev_vendor:	resd 1
  1359                                  ; 06/11/2023
  1360                                  ;stats_cmd:	resw 1 ; 17/02/2017
  1361                                  ; 05/11/2023
  1362                                  ;ac97_io_base:	resw 1
  1363 00001E20 ????                    sample_rate:	resw 1
  1364                                  
  1365                                  ; 19/11/2016
  1366 00001E22 ????                    stmo:		resw 1 
  1367 00001E24 ????                    bps:		resw 1
  1368                                  
  1369                                  ; 08/11/2023
  1370                                  ; 07/11/2023
  1371 00001E26 ??                      fbs_shift:	resb 1
  1372                                  ; 09/11/2023
  1373 00001E27 ??                      b_indicator:	resb 1
  1374                                  ; 10/11/2023
  1375 00001E28 ??                      LVI:		resb 1
  1376 00001E29 ??                      		resb 1 ; 10/11/2023 
  1377                                  
  1378                                  ;fbs_seg:	resw 1
  1379                                  ;fbs_off:	resw 1
  1380                                  
  1381                                  ;alignb 2
  1382                                  
  1383                                  ; 32 kilo bytes for temporay buffer
  1384                                  ; (for stereo-mono, 8bit/16bit corrections)
  1385                                  ;temp_buffer:	resb 32768
  1386                                  ; 18/11/2023
  1387 00001E2A <res DBF0h>             temp_buffer:	resb 56304  ; (44.1 kHZ stereo 14076 samples)	
  1388                                  
  1389                                  ;alignb 16
  1390                                  EOF:
