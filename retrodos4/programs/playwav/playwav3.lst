     1                                  ; ****************************************************************************
     2                                  ; PLAYWAV.ASM - ICH AC97 .wav player for DOS.			   PLAYWAV.COM
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; Last Update: 04/02/2025 (Previous: 19/05/2024)
     5                                  ; ----------------------------------------------------------------------------
     6                                  ; Beginning: 17/02/2017
     7                                  ; ----------------------------------------------------------------------------
     8                                  ; Assembler: NASM version 2.15
     9                                  ;	     nasm playwav.asm -l playwav.lst -o PLAYWAV.COM	
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Derived from '.wav file player for DOS' Jeff Leyda, Sep 02, 2002 
    12                                  ; ****************************************************************************
    13                                  ; Modidified from 'PLAYER.COM' for VIA VT8233 wav player source code by
    14                                  ; (PLAYER.ASM) by Erdogan Tan (07/11/2016 - 08/12/2016)
    15                                  
    16                                  ; AC97 interrupt version - 09/11/2023 - Erdogan Tan
    17                                  ; sample rate conversion version - 13/11/2023 - Erdogan Tan
    18                                  
    19                                  [BITS 16]
    20                                  
    21                                  [ORG 100h] 
    22                                  
    23                                  	%include 'ac97.inc' ; 17/02/2017
     1                              <1> ; 11/11/2023
     2                              <1> ; 05/11/2023
     3                              <1> ; 03/11/2023
     4                              <1> ; 17/02/2017 (Erdogan Tan, PLAYWAV.ASM)
     5                              <1> ; constant.inc & codec.inc (for ICH AC97 wav player, 'PLAYWAV.COM') 
     6                              <1> 
     7                              <1> ; ----------------------------------------------------------------------------
     8                              <1> ; CONSTANT.INC
     9                              <1> ; ----------------------------------------------------------------------------
    10                              <1> 
    11                              <1> ;constants of stuff that seem hard to remember at times.
    12                              <1> 
    13                              <1> TRUE  EQU 1
    14                              <1> FALSE EQU 0
    15                              <1> 
    16                              <1> ENABLED  EQU 1
    17                              <1> DISABLED EQU 0
    18                              <1> 
    19                              <1> BIT0  EQU 1
    20                              <1> BIT1  EQU 2
    21                              <1> BIT2  EQU 4
    22                              <1> BIT3  EQU 8
    23                              <1> BIT4  EQU 10h
    24                              <1> BIT5  EQU 20h
    25                              <1> BIT6  EQU 40h
    26                              <1> BIT7  EQU 80h
    27                              <1> BIT8  EQU 100h
    28                              <1> BIT9  EQU 200h
    29                              <1> BIT10 EQU 400h
    30                              <1> BIT11 EQU 800h
    31                              <1> BIT12 EQU 1000h
    32                              <1> BIT13 EQU 2000h
    33                              <1> BIT14 EQU 4000h
    34                              <1> BIT15 EQU 8000h
    35                              <1> BIT16 EQU 10000h
    36                              <1> BIT17 EQU 20000h
    37                              <1> BIT18 EQU 40000h
    38                              <1> BIT19 EQU 80000h
    39                              <1> BIT20 EQU 100000h
    40                              <1> BIT21 EQU 200000h
    41                              <1> BIT22 EQU 400000h
    42                              <1> BIT23 EQU 800000h
    43                              <1> BIT24 EQU 1000000h
    44                              <1> BIT25 EQU 2000000h
    45                              <1> BIT26 EQU 4000000h
    46                              <1> BIT27 EQU 8000000h
    47                              <1> BIT28 EQU 10000000h
    48                              <1> BIT29 EQU 20000000h
    49                              <1> BIT30 EQU 40000000h
    50                              <1> BIT31 EQU 80000000h
    51                              <1> 
    52                              <1> ;special characters
    53                              <1> NUL     EQU 0
    54                              <1> NULL    EQU 0
    55                              <1> BELL    EQU 07
    56                              <1> BS      EQU 08
    57                              <1> TAB     EQU 09
    58                              <1> LF      EQU 10
    59                              <1> CR      EQU 13
    60                              <1> ESCAPE  EQU 27           ;ESC is a reserved word....
    61                              <1> 
    62                              <1> 
    63                              <1> ;file stuff
    64                              <1> READONLY  EQU   BIT0
    65                              <1> HIDDEN    EQU   BIT1
    66                              <1> SYSTEM    EQU   BIT2
    67                              <1> VOLUME    EQU   BIT3         ;ignored for file access
    68                              <1> DIRECTORY EQU   BIT4         ;must be 0 for file access
    69                              <1> ARCHIVE   EQU   BIT5
    70                              <1> SHAREABLE EQU   BIT7         ;for novell networks
    71                              <1> OPEN	EQU	2		; open existing file
    72                              <1> CREATE	EQU	1		; create new file
    73                              <1> 
    74                              <1> 
    75                              <1> ; PCI equates
    76                              <1> ; PCI function address (PFA)
    77                              <1> ; bit 31 = 1
    78                              <1> ; bit 23:16 = bus number     (0-255)
    79                              <1> ; bit 15:11 = device number  (0-31)
    80                              <1> ; bit 10:8 = function number (0-7)
    81                              <1> ; bit 7:0 = register number  (0-255)
    82                              <1> 
    83                              <1> IO_ADDR_MASK    EQU     0FFFEh          ; mask off bit 0 for reading BARs
    84                              <1> PCI_INDEX_PORT  EQU     0CF8h
    85                              <1> PCI_DATA_PORT   EQU     0CFCh
    86                              <1> PCI32           EQU     BIT31           ; bitflag to signal 32bit access
    87                              <1> PCI16           EQU     BIT30           ; bitflag for 16bit access
    88                              <1> 
    89                              <1> PCI_FN0         EQU     0 << 8
    90                              <1> PCI_FN1         EQU     1 << 8
    91                              <1> PCI_FN2         EQU     2 << 8
    92                              <1> PCI_FN3         EQU     3 << 8
    93                              <1> PCI_FN4         EQU     4 << 8
    94                              <1> PCI_FN5         EQU     5 << 8
    95                              <1> PCI_FN6         EQU     6 << 8
    96                              <1> PCI_FN7         EQU     7 << 8
    97                              <1> 
    98                              <1> PCI_CMD_REG		EQU	04h		; reg 04, command reg
    99                              <1>  IO_ENA			EQU	BIT0		; i/o decode enable
   100                              <1>  MEM_ENA		EQU	BIT1		; memory decode enable
   101                              <1>  BM_ENA                 EQU     BIT2		; bus master enable
   102                              <1> 
   103                              <1> ; ----------------------------------------------------------------------------
   104                              <1> ; CODEC.INC
   105                              <1> ; ----------------------------------------------------------------------------
   106                              <1> 
   107                              <1> ;Codec registers.
   108                              <1> ;
   109                              <1> ;Not all codecs are created equal. Refer to the spec for your specific codec.
   110                              <1> ;
   111                              <1> ;All registers are 16bits wide.  Access to codec registers over the AC97 link
   112                              <1> ;is defined by the OEM.  
   113                              <1> ;
   114                              <1> ;Secondary codec's are accessed by ORing in BIT7 of all register accesses.
   115                              <1> ;
   116                              <1> 
   117                              <1> ; each codec/mixer register is 16bits
   118                              <1> 
   119                              <1> CODEC_RESET_REG                 equ     00      ; reset codec
   120                              <1> CODEC_MASTER_VOL_REG            equ     02      ; master volume
   121                              <1> CODEC_HP_VOL_REG                equ     04      ; headphone volume
   122                              <1> CODEC_MASTER_MONO_VOL_REG       equ     06      ; master mono volume
   123                              <1> CODEC_MASTER_TONE_REG           equ     08      ; master tone (R+L)
   124                              <1> CODEC_PCBEEP_VOL_REG            equ     0ah     ; PC beep volume
   125                              <1> CODEC_PHONE_VOL_REG             equ     0bh     ; phone volume
   126                              <1> CODEC_MIC_VOL_REG               equ     0eh     ; MIC volume
   127                              <1> CODEC_LINE_IN_VOL_REG           equ     10h     ; line input volume
   128                              <1> CODEC_CD_VOL_REG                equ     12h     ; CD volume
   129                              <1> CODEC_VID_VOL_REG               equ     14h     ; video volume
   130                              <1> CODEC_AUX_VOL_REG               equ     16h     ; aux volume
   131                              <1> CODEC_PCM_OUT_REG               equ     18h     ; PCM output volume
   132                              <1> CODEC_RECORD_SELECT_REG         equ     1ah     ; record select input
   133                              <1> CODEC_RECORD_VOL_REG            equ     1ch     ; record volume
   134                              <1> CODEC_RECORD_MIC_VOL_REG        equ     1eh     ; record mic volume
   135                              <1> CODEC_GP_REG                    equ     20h     ; general purpose
   136                              <1> CODEC_3D_CONTROL_REG            equ     22h     ; 3D control
   137                              <1> ; 24h is reserved
   138                              <1> CODEC_POWER_CTRL_REG            equ     26h     ; powerdown control
   139                              <1> CODEC_EXT_AUDIO_REG             equ     28h     ; extended audio
   140                              <1> CODEC_EXT_AUDIO_CTRL_REG        equ     2ah     ; extended audio control
   141                              <1> CODEC_PCM_FRONT_DACRATE_REG     equ     2ch     ; PCM out sample rate
   142                              <1> CODEC_PCM_SURND_DACRATE_REG     equ     2eh     ; surround sound sample rate
   143                              <1> CODEC_PCM_LFE_DACRATE_REG       equ     30h     ; LFE sample rate
   144                              <1> CODEC_LR_ADCRATE_REG            equ     32h     ; PCM in sample rate
   145                              <1> CODEC_MIC_ADCRATE_REG           equ     34h     ; mic in sample rate
   146                              <1> 
   147                              <1> ; registers 36-7a are reserved on the ICH
   148                              <1> 
   149                              <1> CODEC_VENDORID1_REG             equ     7ch     ; codec vendor ID 1
   150                              <1> CODEC_VENDORID2_REG             equ     7eh     ; codec vendor ID 2
   151                              <1> 
   152                              <1> ; Mixer registers 0 through 51h reside in the ICH and are not forwarded over
   153                              <1> ; the AC97 link to the codec, which I think is a little weird.  Looks like
   154                              <1> ; the ICH makes it so you don't need a fully functional codec to play audio?
   155                              <1> ;
   156                              <1> ; whenever 2 codecs are present in the system, use BIT7 to access the 2nd
   157                              <1> ; set of registers, ie 80h-feh
   158                              <1> 
   159                              <1> PRIMARY_CODEC                   equ     0       ; 0-7F for primary codec
   160                              <1> SECONDARY_CODEC                 equ     BIT7    ; 80-8f registers for 2ndary
   161                              <1> 
   162                              <1> SAMPLE_RATE_441khz	equ     44100   ; 44.1Khz (cd quality) rate
   163                              <1> 
   164                              <1> ; ----------------------------------------------------------------------------
   165                              <1> ; 17/02/2017
   166                              <1> PCI_IO_BASE	equ 10h			; = NAMBAR register offset
   167                              <1> AC97_INT_LINE   equ 3Ch			; AC97 Interrupt Line register offset
   168                              <1> 
   169                              <1> ; ----------------------------------------------------------------------------
   170                              <1> ; ICH2AC97.INC
   171                              <1> ; ----------------------------------------------------------------------------
   172                              <1> 
   173                              <1> ; PCI stuff
   174                              <1> 
   175                              <1> ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
   176                              <1> 
   177                              <1> INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
   178                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   179                              <1> SIS_VID		equ	1039h
   180                              <1> NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
   181                              <1> AMD_VID		equ	1022h
   182                              <1> 
   183                              <1> ICH_DID         equ     2415h           ; ICH device ID
   184                              <1> ICH0_DID        equ     2425h           ; ICH0
   185                              <1> ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
   186                              <1>                                         ; they all should be compatible.
   187                              <1> 
   188                              <1> ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
   189                              <1> ICH3_DID	equ     2485h           ; ICH3
   190                              <1> ICH4_DID        equ     24C5h           ; ICH4
   191                              <1> ICH5_DID	equ     24D5h           ; ICH5 
   192                              <1> ICH6_DID	equ     266Eh           ; ICH6
   193                              <1> ESB6300_DID	equ     25A6h           ; 6300ESB
   194                              <1> ESB631X_DID	equ     2698h           ; 631XESB
   195                              <1> ICH7_DID	equ	27DEh		; ICH7
   196                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   197                              <1> MX82440_DID	equ	7195h
   198                              <1> SI7012_DID	equ	7012h
   199                              <1> NFORCE_DID	equ	01B1h
   200                              <1> NFORCE2_DID	equ	006Ah
   201                              <1> AMD8111_DID	equ	746Dh
   202                              <1> AMD768_DID	equ	7445h
   203                              <1> ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
   204                              <1> CK804_DID	equ	0059h
   205                              <1> MCP04_DID	equ	003Ah
   206                              <1> CK8_DID		equ	008Ah
   207                              <1> NFORCE3_DID	equ	00DAh
   208                              <1> CK8S_DID	equ	00EAh
   209                              <1> 
   210                              <1> NAMBAR_REG      equ     10h             ; native audio mixer BAR
   211                              <1>  NAM_SIZE       equ     256             ; 256 bytes required.
   212                              <1> 
   213                              <1> NABMBAR_REG     equ     14h             ; native audio bus mastering BAR
   214                              <1>  NABM_SIZE      equ     64              ; 64 bytes
   215                              <1> 
   216                              <1> ; BUS master registers, accessed via NABMBAR+offset
   217                              <1> 
   218                              <1> ; ICH supports 3 different types of register sets for three types of things
   219                              <1> ; it can do, thus:
   220                              <1> ;
   221                              <1> ; PCM in (for recording) aka PI
   222                              <1> ; PCM out (for playback) aka PO
   223                              <1> ; MIC in (for recording) aka MC
   224                              <1> 
   225                              <1> PI_BDBAR_REG            equ     0       ; PCM in buffer descriptor BAR
   226                              <1> PO_BDBAR_REG            equ     10h     ; PCM out buffer descriptor BAR
   227                              <1> MC_BDBAR_REG            equ     20h     ; MIC in buffer descriptor BAR
   228                              <1> 
   229                              <1> ; each buffer descriptor BAR holds a pointer which has entries to the buffer
   230                              <1> ; contents of the .WAV file we're going to play. Each entry is 8 bytes long
   231                              <1> ; (more on that later) and can contain 32 entries total, so each BAR is
   232                              <1> ; 256 bytes in length, thus:
   233                              <1> 
   234                              <1> BDL_SIZE                equ     32*8    ; Buffer Descriptor List size
   235                              <1> INDEX_MASK              equ     31      ; indexes must be 0-31
   236                              <1> 
   237                              <1> 
   238                              <1> 
   239                              <1> PI_CIV_REG              equ     4       ; PCM in current Index value (RO)
   240                              <1> PO_CIV_REG              equ     14h     ; PCM out current Index value (RO)
   241                              <1> MC_CIV_REG              equ     24h     ; MIC in current Index value (RO)
   242                              <1> ;8bit read only
   243                              <1> ; each current index value is simply a pointer showing us which buffer
   244                              <1> ; (0-31) the codec is currently processing. Once this counter hits 31, it
   245                              <1> ; wraps back to 0.
   246                              <1> ; this can be handy to know, as once it hits 31, we're almost out of data to
   247                              <1> ; play back or room to record!
   248                              <1> 
   249                              <1> 
   250                              <1> PI_LVI_REG              equ     5       ; PCM in Last Valid Index
   251                              <1> PO_LVI_REG              equ     15h     ; PCM out Last Valid Index
   252                              <1> MC_LVI_REG              equ     25h     ; MIC in Last Valid Index
   253                              <1> ;8bit read/write
   254                              <1> ; The Last Valid Index is a number (0-31) to let the codec know what buffer
   255                              <1> ; number to stop on after processing. It could be very nasty to play audio
   256                              <1> ; from buffers that aren't filled with the audio we want to play.
   257                              <1> 
   258                              <1> 
   259                              <1> PI_SR_REG               equ     6       ; PCM in Status register
   260                              <1> PO_SR_REG               equ     16h     ; PCM out Status register
   261                              <1> MC_SR_REG               equ     26h     ; MIC in Status register
   262                              <1> ;16bit read/write
   263                              <1> ; status registers.  Bitfields follow:
   264                              <1> 
   265                              <1> FIFO_ERR                equ     BIT4    ; FIFO Over/Underrun W1TC.
   266                              <1> 
   267                              <1> BCIS                    equ     BIT3    ; buffer completion interrupt status.
   268                              <1>                                         ; Set whenever the last sample in ANY
   269                              <1>                                         ; buffer is finished.  Bit is only
   270                              <1>                                         ; set when the Interrupt on Complete
   271                              <1>                                         ; (BIT4 of control reg) is set.
   272                              <1> 
   273                              <1> LVBCI                   equ     BIT2    ; Set whenever the codec has processed
   274                              <1>                                         ; the last buffer in the buffer list.
   275                              <1>                                         ; Will fire an interrupt if IOC bit is
   276                              <1>                                         ; set. Probably set after the last
   277                              <1>                                         ; sample in the last buffer is
   278                              <1>                                         ; processed.  W1TC
   279                              <1> 
   280                              <1>                                         ; 
   281                              <1> CELV                    equ     BIT1    ; Current buffer == last valid.
   282                              <1>                                         ; Bit is RO and remains set until LVI is
   283                              <1>                                         ; cleared.  Probably set up the start
   284                              <1>                                         ; of processing for the last buffer.
   285                              <1> 
   286                              <1> 
   287                              <1> DCH                     equ     BIT0    ; DMA controller halted.
   288                              <1>                                         ; set whenever audio stream is stopped
   289                              <1>                                         ; or something else goes wrong.
   290                              <1> 
   291                              <1> 
   292                              <1> PI_PICB_REG             equ     8       ; PCM in position in current buffer(RO)
   293                              <1> PO_PICB_REG             equ     18h     ; PCM out position in current buffer(RO)
   294                              <1> MC_PICB_REG             equ     28h     ; MIC in position in current buffer (RO)
   295                              <1> ;16bit read only
   296                              <1> ; position in current buffer regs show the number of dwords left to be
   297                              <1> ; processed in the current buffer.
   298                              <1> ; 
   299                              <1> 
   300                              <1> PI_PIV_REG              equ     0ah     ; PCM in Prefected index value
   301                              <1> PO_PIV_REG              equ     1ah     ; PCM out Prefected index value
   302                              <1> MC_PIV_REG              equ     2ah     ; MIC in Prefected index value
   303                              <1> ;8bit, read only
   304                              <1> ; Prefetched index value register.
   305                              <1> ; tells which buffer number (0-31) has be prefetched. I'd imagine this
   306                              <1> ; value follows the current index value fairly closely. (CIV+1)
   307                              <1> ;
   308                              <1> 
   309                              <1> 
   310                              <1> PI_CR_REG               equ     0bh     ; PCM in Control Register
   311                              <1> PO_CR_REG               equ     1bh     ; PCM out Control Register
   312                              <1> MC_CR_REG               equ     2bh     ; MIC in Control Register
   313                              <1> ; 8bit
   314                              <1> ; Control register *MUST* only be accessed as an 8bit value.
   315                              <1> ; Control register. See bitfields below.
   316                              <1> ;
   317                              <1> 
   318                              <1> 
   319                              <1> IOCE                    equ     BIT4    ; interrupt on complete enable.
   320                              <1>                                         ; set this bit if you want an intrtpt
   321                              <1>                                         ; to fire whenever LVBCI is set.
   322                              <1> FEIFE                   equ     BIT3    ; set if you want an interrupt to fire
   323                              <1>                                         ; whenever there is a FIFO (over or
   324                              <1>                                         ; under) error.
   325                              <1> LVBIE                   equ     BIT2    ; last valid buffer interrupt enable.
   326                              <1>                                         ; set if you want an interrupt to fire
   327                              <1>                                         ; whenever the completion of the last
   328                              <1>                                         ; valid buffer.
   329                              <1> RR                      equ     BIT1    ; reset registers.  Nukes all regs
   330                              <1>                                         ; except bits 4:2 of this register.
   331                              <1>                                         ; Only set this bit if BIT 0 is 0
   332                              <1> RPBM                    equ     BIT0    ; Run/Pause
   333                              <1>                                         ; set this bit to start the codec!
   334                              <1> 
   335                              <1> 
   336                              <1> GLOB_CNT_REG            equ     2ch     ; Global control register
   337                              <1> SEC_RES_EN              equ     BIT5    ; secondary codec resume event 
   338                              <1>                                         ; interrupt enable.  Not used here.
   339                              <1> PRI_RES_EN              equ     BIT4    ; ditto for primary. Not used here.
   340                              <1> ACLINK_OFF              equ     BIT3    ; Turn off the AC97 link
   341                              <1> ACWARM_RESET            equ     BIT2    ; Awaken the AC97 link from sleep.
   342                              <1>                                         ; registers preserved, bit self clears
   343                              <1> ACCOLD_RESET            equ     BIT1    ; Reset everything in the AC97 and
   344                              <1>                                         ; reset all registers.  Not self clearing
   345                              <1> 
   346                              <1> GPIIE                   equ     BIT0    ; GPI Interrupt enable.
   347                              <1>                                         ; set if you want an interrupt to
   348                              <1>                                         ; fire upon ANY of the bits in the
   349                              <1>                                         ; GPI (general pursose inputs?) not used.
   350                              <1> 
   351                              <1> GLOB_STS_REG            equ     30h     ; Global Status register (RO)
   352                              <1> 
   353                              <1> MD3                     equ     BIT17   ; modem powerdown status (yawn)
   354                              <1> AD3                     equ     BIT16   ; Audio powerdown status (yawn)
   355                              <1> RD_COMPLETE_STS         equ     BIT15   ; Codec read timed out. 0=normal
   356                              <1> BIT3SLOT12              equ     BIT14   ; shadowed status of bit 3 in slot 12
   357                              <1> BIT2SLOT12              equ     BIT13   ; shadowed status of bit 2 in slot 12
   358                              <1> BIT1SLOT12              equ     BIT12   ; shadowed status of bit 1 in slot 12
   359                              <1> SEC_RESUME_STS          equ     BIT11   ; secondary codec has resumed (and irqed)
   360                              <1> PRI_RESUME_STS          equ     BIT10   ; primary codec has resumed (and irqed)
   361                              <1> SEC_CODEC_RDY           equ     BIT9    ; secondary codec is ready for action
   362                              <1> PRI_CODEC_RDY           equ     BIT8    ; Primary codec is ready for action
   363                              <1>                                         ; software must check these bits before
   364                              <1>                                         ; starting the codec!
   365                              <1> MIC_IN_IRQ              equ     BIT7    ; MIC in caused an interrupt
   366                              <1> PCM_OUT_IRQ             equ     BIT6    ; One of the PCM out channels IRQed
   367                              <1> PCM_IN_IRQ              equ     BIT5    ; One of the PCM in channels IRQed
   368                              <1> MODEM_OUT_IRQ           equ     BIT2    ; modem out channel IRQed
   369                              <1> MODEM_IN_IRQ            equ     BIT1    ; modem in channel IRQed
   370                              <1> GPI_STS_CHANGE          equ     BIT0    ; set whenever GPI's have changed.
   371                              <1>                                         ; BIT0 of slot 12 also reflects this.
   372                              <1> 
   373                              <1> ACC_SEMA_REG            equ     34h     ; Codec write semiphore register
   374                              <1> CODEC_BUSY              equ     BIT0    ; codec register I/O is happening
   375                              <1>                                         ; self clearing
   376                              <1> ;
   377                              <1> ; Buffer Descriptors List
   378                              <1> ; As stated earlier, each buffer descriptor list is a set of (up to) 32 
   379                              <1> ; descriptors, each 8 bytes in length. Bytes 0-3 of a descriptor entry point
   380                              <1> ; to a chunk of memory to either play from or record to. Bytes 4-7 of an
   381                              <1> ; entry describe various control things detailed below.
   382                              <1> ; 
   383                              <1> ; Buffer pointers must always be aligned on a Dword boundry.
   384                              <1> ;
   385                              <1> 
   386                              <1> IOC                     equ     BIT31   ; Fire an interrupt whenever this
   387                              <1>                                         ; buffer is complete.
   388                              <1> 
   389                              <1> BUP                     equ     BIT30   ; Buffer Underrun Policy.
   390                              <1>                                         ; if this buffer is the last buffer
   391                              <1>                                         ; in a playback, fill the remaining
   392                              <1>                                         ; samples with 0 (silence) or not.
   393                              <1>                                         ; It's a good idea to set this to 1
   394                              <1>                                         ; for the last buffer in playback,
   395                              <1>                                         ; otherwise you're likely to get a lot
   396                              <1>                                         ; of noise at the end of the sound.
   397                              <1> 
   398                              <1> ;
   399                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   400                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   401                              <1> ; Luckily for us, that's the same format as .wav files.
   402                              <1> ;
   403                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   404                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   405                              <1> ;
   406                              <1> ; A value of 0 in these bits means play no samples.
   407                              <1> ;
   408                              <1> 
   409                              <1> ; 11/11/2023
   410                              <1> CTRL_ST_CREADY		equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
   411                              <1> CODEC_REG_POWERDOWN	equ	26h
    24                                  
    25                                  _STARTUP:
    26                                  
    27                                  ; memory allocation
    28                                  
    29 00000000 E85A01                          call    setFree				; deallocate unused DOS mem
    30                                  
    31                                  	; 17/02/2017
    32                                  	; Clear BSS (uninitialized data) area
    33 00000003 31C0                    	xor	ax, ax ; 0
    34 00000005 B91A6E                  	mov	cx, (EOF - bss_start)/2
    35 00000008 BF[F11D]                	mov	di, bss_start
    36 0000000B F3AB                    	rep	stosw
    37                                  
    38                                  ; allocate 256 bytes of data for DCM_OUT Buffer Descriptor List. (BDL)
    39                                  
    40 0000000D B81000                          mov     ax, BDL_SIZE / 16
    41 00000010 E85201                          call    memAlloc
    42 00000013 A3[1E1E]                        mov     [BDL_BUFFER], ax		; segment 
    43                                  
    44                                  ; allocate 2 buffers, 64k each for now.
    45                                  
    46 00000016 B80010                          mov     ax, BUFFERSIZE / 16		; 64k for .WAV file
    47 00000019 E84901                          call    memAlloc
    48 0000001C A3[201E]                        mov     [WAV_BUFFER1], ax		; segment
    49                                  
    50 0000001F B80010                  	mov	ax, BUFFERSIZE / 16
    51 00000022 E84001                  	call	memAlloc
    52 00000025 A3[221E]                	mov	[WAV_BUFFER2], ax
    53                                  
    54                                  ; Detect/reset AC97 
    55                                  
    56 00000028 E8AD02                          call    pciFindDevice
    57 0000002B 7342                            jnc     short _1
    58                                  
    59                                  ; couldn't find the audio device!
    60                                  
    61 0000002D 0E                      	push	cs
    62 0000002E 1F                      	pop	ds
    63 0000002F BA[3900]                        mov     dx, noDevMsg
    64 00000032 B409                            mov     ah, 9
    65 00000034 CD21                            int     21h
    66 00000036 E91401                          jmp     exit
    67                                  
    68                                  ; 17/02/2017
    69 00000039 4572726F723A20556E-     noDevMsg: db "Error: Unable to find intel ICH based audio device!",CR,LF,"$"
    69 00000042 61626C6520746F2066-
    69 0000004B 696E6420696E74656C-
    69 00000054 204943482062617365-
    69 0000005D 6420617564696F2064-
    69 00000066 6576696365210D0A24 
    70                                  
    71                                  _1:
    72                                  	; eax = BUS/DEV/FN
    73                                  	;	00000000BBBBBBBBDDDDDFFF00000000
    74                                  	; edx = DEV/VENDOR
    75                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
    76                                  
    77 0000006F 66A3[241E]              	mov	[bus_dev_fn], eax
    78 00000073 668916[281E]            	mov	[dev_vendor], edx
    79                                  
    80                                  	; get ICH base address regs for mixer and bus master
    81                                  
    82 00000078 B010                            mov     al, NAMBAR_REG
    83 0000007A E8CD01                          call    pciRegRead16			; read PCI registers 10-11
    84                                          ;and    dx, IO_ADDR_MASK 		; mask off BIT0
    85                                  	; 19/05/2024
    86 0000007D 80E2FE                  	and	dl, 0FEh
    87                                  
    88 00000080 8916[1A1E]                      mov     [NAMBAR], dx			; save audio mixer base addr
    89                                  
    90 00000084 B014                    	mov     al, NABMBAR_REG
    91 00000086 E8C101                          call    pciRegRead16
    92                                          ;and    dx, IO_ADDR_MASK
    93                                  	; 19/05/2024
    94 00000089 80E2C0                  	and	dl, 0C0h
    95                                  
    96 0000008C 8916[1C1E]                      mov     [NABMBAR], dx			; save bus master base addr
    97                                  
    98                                  	; 06/11/2023
    99                                  	;; init controller
   100                                  	;; 17/02/2017
   101                                  	;mov	al, PCI_CMD_REG ; command register (04h)
   102                                  	;call	pciRegRead16 ; pciRegRead8
   103                                  	;
   104                                  	;; eax = BUS/DEV/FN/REG
   105                                  	;;  dx = PCI Command Register Content ; 17/02/2017
   106                                  	;; 	00000000CCCCCCCC
   107                                  	;mov	[stats_cmd], dx
   108                                  	;
   109                                  	; 06/11/2023
   110                                  	;mov	al, PCI_IO_BASE ; IO base address register (10h)
   111                                  	;call	pciRegRead32
   112                                  	;
   113                                  	;and	dx, 0FFC0h	; IO_ADDR_MASK (0FFFE) ?
   114                                          ;mov	[ac97_io_base], dx
   115                                  
   116 00000090 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
   117 00000092 E8AD01                  	call	pciRegRead8 ; 17/02/2017
   118                                  
   119 00000095 8816[111E]              	mov     [ac97_int_ln_reg], dl
   120                                  
   121                                  ; 09/11/2023
   122                                  ; 05/11/2023
   123                                  %if 1
   124                                  	; 28/11/2016
   125                                  	;mov	bx, 1	; 08/05/2024
   126 00000099 30F6                    	xor	dh, dh	; 17/02/2017
   127                                  	; 10/11/2023
   128                                  	;mov	cx, dx
   129                                  	;shl	bx, cl
   130                                  
   131                                  	; 04/11/2023
   132 0000009B FA                      	cli
   133                                  
   134                                  	;not	bx
   135 0000009C E4A1                    	in	al, 0A1h ; irq 8-15
   136 0000009E 88C4                            mov	ah, al
   137 000000A0 E421                            in	al, 21h  ; irq 0-7 
   138                                  
   139                                  	; 04/11/2023
   140                                  	; save IRQ status
   141 000000A2 A3[141E]                	mov	[IRQ_status], ax
   142                                  
   143                                  	;and	ax, bx   ; unmask
   144 000000A5 0FB3D0                   	btr	ax, dx	 ; unmask
   145 000000A8 E621                    	out	21h, al  ; enable interrupt (if irq <= 7)
   146 000000AA 88E0                    	mov	al, ah
   147 000000AC E6A1                    	out	0A1h, al ; enable interrupt (if irq > 7)
   148                                  	;not	bx
   149                                  
   150                                  	; 04/11/2023
   151                                  	;mov	dx, 4D1h			;8259 ELCR1
   152                                          ;in	al, dx
   153                                  	;mov	ah, al
   154                                  	;mov	dx, 4D0h 
   155                                          ;in	al, dx
   156                                  	;;or	ax, bx        
   157                                  	;bts	ax, cx
   158                                  	;mov	dx, 4D0h
   159                                  	;out	dx, al                          ;set level-triggered mode
   160                                  	;mov	al, ah
   161                                  	;mov	dx, 4D1h
   162                                  	;out	dx, al                          ;set level-triggered mode
   163                                  
   164                                  	; 24/11/2016 - Erdogan Tan
   165                                  	;mov	bx, cx
   166                                  	; 10/11/2023
   167 000000AE 89D3                    	mov	bx, dx
   168 000000B0 8A9F[3C1C]              	mov	bl, [bx+irq_int]
   169 000000B4 C1E302                  	shl	bx, 2 ; * 4
   170                                  
   171                                  	; set up interrupt vector
   172                                  	; 30/11/2016
   173 000000B7 06                      	push	es
   174 000000B8 31C0                    	xor	ax, ax
   175 000000BA 8EC0                    	mov	es, ax
   176                                  	; 04/11/2023
   177                                  	; save interrupt vector
   178 000000BC 268B07                  	mov	ax, [es:bx]
   179 000000BF A3[161E]                	mov	[IRQ_vector], ax
   180 000000C2 268B4702                	mov	ax, [es:bx+2]
   181 000000C6 A3[181E]                	mov	[IRQ_vector+2], ax
   182                                  
   183 000000C9 26C707[AB1B]            	mov	word [es:bx], ac97_int_handler
   184 000000CE 8CC8                    	mov	ax, cs
   185 000000D0 26894702                	mov	[es:bx+2], ax
   186 000000D4 07                      	pop	es
   187                                  
   188                                  	; 04/11/2023
   189 000000D5 FB                      	sti
   190                                  
   191                                  %endif
   192 000000D6 E82B19                  	call	write_ac97_dev_info 
   193                                  
   194                                  ; check the command line for a file to play
   195                                  
   196                                          ;push	ds
   197 000000D9 E89200                          call    processCmdline			; get the filename
   198                                  
   199                                  ; open the file
   200 000000DC B002                            mov     al, OPEN                        ; open existing file
   201 000000DE E8AD00                          call    openFile                        ; no error? ok.
   202                                          ;pop	ds
   203 000000E1 7322                            jnc     short _gsr
   204                                  
   205                                  ; file not found!
   206                                  
   207                                          ;push   cs
   208                                          ;pop    ds
   209 000000E3 BA[EC00]                        mov	dx, noFileErrMsg
   210 000000E6 B409                            mov     ah, 9
   211 000000E8 CD21                            int     21h
   212 000000EA EB61                            jmp     exit
   213                                  
   214                                  noFileErrMsg:
   215 000000EC 4572726F723A206669-     	db "Error: file not found.",CR,LF,"$"
   215 000000F5 6C65206E6F7420666F-
   215 000000FE 756E642E0D0A24     
   216                                  
   217                                  _gsr:
   218 00000105 E8AD00                          call    getSampleRate                   ; read the sample rate
   219                                                                                  ; pass it onto codec.
   220 00000108 7243                    	jc	short exit ; 19/11/2016 - nothing to do
   221                                  
   222 0000010A A3[2C1E]                	mov	[sample_rate], ax
   223                                  	
   224                                  	; 19/11/2016
   225 0000010D 880E[2E1E]              	mov	[stmo], cl
   226 00000111 8816[301E]              	mov	[bps], dl
   227                                  	
   228                                  	; 17/02/2017
   229 00000115 C606[321E]00            	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit 
   230 0000011A FEC9                    	dec	cl
   231 0000011C 7504                    	jnz	short _gsr_1 ; stereo
   232 0000011E FE06[321E]              	inc	byte [fbs_shift] ; 1 = mono or 8 bit		
   233                                  _gsr_1:	
   234 00000122 80FA08                  	cmp	dl, 8 
   235 00000125 7704                    	ja	short _gsr_2 ; 16 bit samples
   236 00000127 FE06[321E]              	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   237                                  _gsr_2:	
   238 0000012B E82C1A                  	call	write_sample_rate
   239                                  
   240                                  	; 05/11/2023
   241                                  _2:
   242 0000012E E85D07                  	call	check4keyboardstop  ; flush keyboard buffer
   243 00000131 72FB                    	jc	short _2 	; 07/11/2023
   244                                  
   245                                  	; 09/11/2023
   246                                  	;; 05/11/2023
   247                                  	;mov	eax, [bus_dev_fn]
   248                                  	;mov	al, PCI_CMD_REG
   249                                  	;call	pciRegRead16			; read PCI command register
   250                                  	;; 17/02/2017
   251                                  	;;mov	dx, [stats_cmd]
   252                                          ;or	dl, IO_ENA+BM_ENA               ; enable IO and bus master
   253                                  	;call	pciRegWrite16 ; pciRegWrite8
   254                                  
   255                                  	;; 06/11/2023
   256                                  	;;mov	eax, [bus_dev_fn]
   257                                  	;;mov	al, PCI_CMD_REG
   258                                  	;;call	pciRegRead8                     ; read PCI command register
   259                                  	;;or	dl, IO_ENA+BM_ENA               ; enable IO and bus master
   260                                  	;;call	pciRegWrite8
   261                                  
   262                                  ; setup the Codec (actually mixer registers) 
   263 00000133 E8E401                          call    codecConfig                     ; unmute codec, set rates.
   264                                  	; 11/11/2023
   265 00000136 721C                    	jc	short init_err
   266                                  ;
   267                                  ; position file pointer to start in actual wav data
   268                                  ; MUCH improvement should really be done here to check if sample size is
   269                                  ; supported, make sure there are 2 channels, etc.  
   270                                  ;
   271 00000138 B442                            mov     ah, 42h
   272 0000013A B000                            mov     al, 0                           ; from start of file
   273 0000013C 8B1E[0E1E]                      mov     bx, [filehandle]
   274 00000140 31C9                            xor     cx, cx
   275 00000142 BA2C00                          mov     dx, 44                          ; jump past .wav/riff header
   276 00000145 CD21                            int     21h
   277                                  
   278                                  ; play the .wav file. Most of the good stuff is in here.
   279                                  
   280 00000147 E88503                          call    playWav
   281                                  
   282                                  ; close the .wav file and exit.
   283                                  
   284                                  close_exit:			; 11/11/2023
   285 0000014A E85300                          call    closeFile
   286                                  
   287                                  exit:
   288 0000014D B8004C                          mov     ax, 4c00h
   289 00000150 CD21                    	int 	21h
   290                                  
   291                                  here:
   292 00000152 EBFE                    	jmp	short here
   293                                  
   294                                  	; 11/11/2023
   295                                  init_err:
   296 00000154 BA[871D]                	mov	dx, msg_init_err
   297                                  vra_err: ; 12/11/2023
   298 00000157 B409                            mov	ah, 9
   299 00000159 CD21                            int	21h
   300 0000015B EBED                    	jmp	short close_exit
   301                                  
   302                                  ; MEMALLOC.ASM
   303                                  ;-- SETFREE: Release memory not used  ----------------
   304                                  ;-- Input    : ES = address of PSP
   305                                  ;-- Output   : none
   306                                  ;-- Register : AX, BX, CL and FLAGS are changed 
   307                                  ;-- Info     : Since the stack-segment is always the last segment in an 
   308                                  ;              EXE-file, ES:0000 points to the beginning and SS:SP
   309                                  ;              to the end of the program in memory. Through this the
   310                                  ;              length of the program can be calculated 
   311                                  ; call this routine once at the beginning of the program to free up memory
   312                                  ; assigned to it by DOS.
   313                                  
   314                                  setFree:
   315 0000015D BB0010                  	  mov	bx, 65536/16	; 4K paragraphs ; 17/02/2017 (Erdogan Tan)		
   316                                  
   317 00000160 B44A                              mov	ah, 4ah		; pass new length to DOS
   318 00000162 CD21                              int	21h
   319                                  
   320 00000164 C3                                retn			; back to caller 
   321                                  				; new size (allocated memory) = 64KB
   322                                  
   323                                  memAlloc:
   324                                  ; input: AX = # of paragraphs required
   325                                  ; output: AX = segment of block to use
   326                                  
   327 00000165 53                      	push	bx
   328 00000166 89C3                    	mov	bx, ax
   329 00000168 B448                    	mov	ah, 48h
   330 0000016A CD21                    	int	21h
   331 0000016C 5B                      	pop	bx
   332 0000016D C3                      	retn
   333                                  
   334                                  ; CMDLINE.ASM
   335                                  ; parse the command line
   336                                  ; entry: none
   337                                  ; exit: DS:DX to the 1st supplied item on the command line 
   338                                  
   339                                  processCmdline:
   340 0000016E 53                              push    bx
   341 0000016F 56                              push    si
   342                                  
   343                                          ;mov    ah, 51h
   344                                          ;int    21h
   345                                          ;mov    ds, bx
   346                                  
   347 00000170 BE8000                          mov     si, 80h
   348 00000173 0FB61C                          movzx   bx, byte [si]
   349 00000176 01DE                            add     si, bx
   350 00000178 46                              inc     si
   351                                  
   352 00000179 C60400                          mov     byte [si], NULL         ; zero terminate
   353                                  
   354 0000017C BE8100                          mov     si, 81h
   355                                  
   356                                  cmdlineloop:
   357 0000017F AC                              lodsb
   358                                  
   359 00000180 3C00                            cmp     al, NULL                ; found end of line?
   360 00000182 7404                            je      short exitpc
   361 00000184 3C20                            cmp     al, ' '                 ; found a space?
   362 00000186 74F7                            je      short cmdlineloop
   363                                  
   364                                          ; must be the filename here.
   365                                  exitpc:
   366 00000188 4E                              dec     si                      ; point to start of filename
   367 00000189 89F2                            mov     dx, si
   368 0000018B 5E                              pop     si
   369 0000018C 5B                              pop     bx
   370 0000018D C3                      	retn
   371                                  
   372                                  ; FILE.ASM
   373                                  ;open or create file
   374                                  ;
   375                                  ;input: ds:dx-->filename (asciiz)
   376                                  ;       al=file Mode (create or open)
   377                                  ;output: none  cs:[filehandle] filled
   378                                  ;
   379                                  openFile:
   380 0000018E 50                      	push	ax
   381 0000018F 51                      	push	cx
   382 00000190 B43B                    	mov	ah, 3bh			; start with a mode
   383 00000192 00C4                    	add	ah, al			; add in create or open mode
   384 00000194 31C9                    	xor	cx, cx
   385 00000196 CD21                    	int	21h
   386 00000198 7203                    	jc	short _of1
   387                                  	;mov	[cs:filehandle], ax
   388 0000019A A3[0E1E]                	mov	[filehandle], ax
   389                                  _of1:
   390 0000019D 59                      	pop	cx
   391 0000019E 58                      	pop	ax
   392 0000019F C3                      	retn
   393                                  
   394                                  ; close the currently open file
   395                                  ; input: none, uses cs:[filehandle]
   396                                  closeFile:
   397 000001A0 50                      	push	ax
   398 000001A1 53                      	push	bx
   399 000001A2 833E[0E1E]FF            	cmp	word [filehandle], -1
   400 000001A7 7409                    	jz	short _cf1
   401 000001A9 8B1E[0E1E]              	mov     bx, [filehandle]  
   402 000001AD B8003E                  	mov     ax,3e00h
   403 000001B0 CD21                            int     21h              ;close file
   404                                  _cf1:
   405 000001B2 5B                      	pop	bx
   406 000001B3 58                      	pop	ax
   407 000001B4 C3                      	retn
   408                                  
   409                                  getSampleRate:
   410                                  	; 08/12/2016
   411                                  ; reads the sample rate from the .wav file.
   412                                  ; entry: none - assumes file is already open
   413                                  	; 19/11/2016 - Erdogan Tan
   414                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   415                                  ;	cx = number of channels (mono=1, stereo=2)
   416                                  ;	dx = bits per sample (8, 16)
   417                                  
   418 000001B5 53                      	push    bx
   419                                  
   420 000001B6 B442                            mov     ah, 42h
   421 000001B8 B000                            mov     al, 0				; from start of file
   422 000001BA 8B1E[0E1E]                      mov     bx, [filehandle]
   423 000001BE 31C9                            xor     cx, cx
   424 000001C0 BA0800                          mov     dx, 08h				; "WAVE"
   425 000001C3 CD21                            int     21h
   426                                  
   427 000001C5 BA[F21D]                        mov     dx, smpRBuff
   428 000001C8 B91C00                          mov     cx, 28				; 28 bytes
   429 000001CB B43F                    	mov	ah, 3fh
   430 000001CD CD21                            int     21h
   431                                  
   432 000001CF 813E[F21D]5741          	cmp	word [smpRBuff], 'WA'
   433 000001D5 751C                    	jne	short gsr_stc
   434                                  
   435 000001D7 813E[F41D]5645          	cmp	word [smpRBuff+2], 'VE'
   436 000001DD 7514                    	jne	short gsr_stc
   437                                  
   438 000001DF 833E[FE1D]01            	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   439 000001E4 750D                    	jne	short gsr_stc
   440                                  
   441                                  
   442 000001E6 8B0E[001E]              	mov	cx, [smpRBuff+14]	; return num of channels in CX
   443 000001EA A1[021E]                        mov     ax, [smpRBuff+16]	; return sample rate in AX
   444 000001ED 8B16[0C1E]              	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   445                                  gsr_retn:
   446 000001F1 5B                              pop     bx
   447 000001F2 C3                              retn
   448                                  
   449                                  gsr_stc:
   450 000001F3 F9                      	stc
   451 000001F4 EBFB                    	jmp	short gsr_retn
   452                                  
   453                                  ;%include 'ac97.asm' ; 29/11/2016 (AC97 codec configuration)
   454                                  %include 'ac97_vra.asm' ; 19/11/2023 (AC97 codec configuration)
     1                              <1> ; 19/05/2024
     2                              <1> ; 19/11/2023 
     3                              <1> ;	(ready status optimization -in order to prevent wrong init error- )
     4                              <1> ; 18/11/2023
     5                              <1> ; 15/11/2023
     6                              <1> ; 13/11/2023
     7                              <1> ; 12/11/2023
     8                              <1> ; 11/11/2023
     9                              <1> ; 03/11/2023 - 06/11/2023
    10                              <1> ; PCI and AC97 codec functions for wav player
    11                              <1> ; Erdogan Tan (17/02/2017)
    12                              <1> 
    13                              <1> ; ----------------------------------------------------------------------------
    14                              <1> ; PCI.ASM
    15                              <1> ; ----------------------------------------------------------------------------
    16                              <1> 
    17                              <1> ; PCI device register reader/writers.
    18                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    19                              <1> ; 		Last Update: 17/02/2017
    20                              <1> 
    21                              <1> ;===============================================================
    22                              <1> ; 8/16/32bit PCI reader
    23                              <1> ;
    24                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    25                              <1> ;           BIT30 set if 32 bit access requested
    26                              <1> ;           BIT29 set if 16 bit access requested
    27                              <1> ;           otherwise defaults to 8 bit read
    28                              <1> ;
    29                              <1> ; Exit:  DL,DX,EDX register data depending on requested read size
    30                              <1> ;
    31                              <1> ; Note: this routine is meant to be called via pciRegRead8, pciRegread16,
    32                              <1> ;	or pciRegRead32, listed below.
    33                              <1> ;
    34                              <1> ; Note2: don't attempt to read 32bits of data from a non dword aligned reg
    35                              <1> ;	 number. Likewise, don't do 16bit reads from non word aligned reg #
    36                              <1> ; 
    37                              <1> pciRegRead:
    38 000001F6 6653                <1> 	push	ebx
    39 000001F8 51                  <1> 	push	cx
    40 000001F9 6689C3              <1>         mov     ebx, eax                        ; save eax, dh
    41 000001FC 88F1                <1>         mov     cl, dh
    42 000001FE 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    43 00000204 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
    44 0000020A 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
    45                              <1> 
    46 0000020C BAF80C              <1>         mov     dx, PCI_INDEX_PORT
    47 0000020F 66EF                <1>         out     dx, eax                         ; write PCI selector
    48                              <1> 
    49 00000211 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
    50 00000214 88D8                <1>         mov     al, bl
    51 00000216 2403                <1>         and     al, 3                           ; figure out which port to
    52 00000218 00C2                <1>         add     dl, al                          ; read to
    53                              <1> 
    54 0000021A 66ED                <1> 	in      eax, dx                         ; do 32bit read
    55 0000021C 66F7C300000080      <1>         test    ebx, PCI32
    56 00000223 7403                <1>         jz      short _pregr1
    57                              <1> 
    58 00000225 6689C2              <1>         mov     edx, eax                        ; return 32bits of data
    59                              <1> _pregr1:
    60 00000228 89C2                <1> 	mov     dx, ax                          ; return 16bits of data
    61 0000022A 66F7C3000000C0      <1>         test    ebx, PCI32+PCI16
    62 00000231 7502                <1>         jnz     short _pregr2
    63 00000233 88CE                <1>         mov     dh, cl                          ; restore dh for 8 bit read
    64                              <1> _pregr2:
    65 00000235 6689D8              <1>         mov     eax, ebx                        ; restore eax
    66 00000238 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    67 0000023E 59                  <1> 	pop	cx
    68 0000023F 665B                <1> 	pop	ebx
    69 00000241 C3                  <1> 	retn
    70                              <1> 
    71                              <1> pciRegRead8:
    72 00000242 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32             ; set up 8 bit read size
    73 00000248 EBAC                <1>         jmp     short pciRegRead		; call generic PCI access
    74                              <1> 
    75                              <1> pciRegRead16:
    76 0000024A 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit read size
    77 00000250 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
    78 00000256 EB9E                <1>         jmp     short pciRegRead
    79                              <1> 
    80                              <1> pciRegRead32:
    81 00000258 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit read size
    82 0000025E 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
    83 00000264 EB90                <1>         jmp     short pciRegRead
    84                              <1> 
    85                              <1> ;===============================================================
    86                              <1> ; 8/16/32bit PCI writer
    87                              <1> ;
    88                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    89                              <1> ;           BIT31 set if 32 bit access requested
    90                              <1> ;           BIT30 set if 16 bit access requested
    91                              <1> ;           otherwise defaults to 8bit read
    92                              <1> ;        DL/DX/EDX data to write depending on size
    93                              <1> ;
    94                              <1> ;
    95                              <1> ; note: this routine is meant to be called via pciRegWrite8, pciRegWrite16,
    96                              <1> ; 	or pciRegWrite32 as detailed below.
    97                              <1> ;
    98                              <1> ; Note2: don't attempt to write 32bits of data from a non dword aligned reg
    99                              <1> ;	 number. Likewise, don't do 16bit writes from non word aligned reg #
   100                              <1> ;
   101                              <1> pciRegWrite:
   102 00000266 6653                <1> 	push	ebx
   103 00000268 51                  <1> 	push	cx
   104 00000269 6689C3              <1>         mov     ebx, eax                        ; save eax, dx
   105 0000026C 89D1                <1>         mov     cx, dx
   106 0000026E 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
   107 00000274 6625FFFFFFBF        <1>         and     eax, ~PCI16 ; NOT PCI16         ; clear out data size request
   108 0000027A 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
   109                              <1> 
   110 0000027C BAF80C              <1>         mov     dx, PCI_INDEX_PORT
   111 0000027F 66EF                <1>         out     dx, eax                         ; write PCI selector
   112                              <1> 
   113 00000281 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
   114 00000284 88D8                <1>         mov     al, bl
   115 00000286 2403                <1>         and     al, 3                           ; figure out which port to
   116 00000288 00C2                <1>         add     dl, al                          ; write to
   117                              <1> 
   118 0000028A 6689D0              <1>         mov     eax, edx                        ; put data into eax
   119 0000028D 89C8                <1>         mov     ax, cx
   120                              <1> 
   121 0000028F EE                  <1>         out     dx, al
   122 00000290 66F7C3000000C0      <1>         test    ebx, PCI16+PCI32                ; only 8bit access? bail
   123 00000297 740C                <1>         jz      short _pregw1
   124                              <1> 
   125 00000299 EF                  <1>         out     dx, ax                          ; write 16 bit value
   126 0000029A 66F7C300000040      <1>         test    ebx, PCI16                      ; 16bit requested?  bail
   127 000002A1 7502                <1>         jnz     short _pregw1
   128                              <1> 
   129 000002A3 66EF                <1>         out     dx, eax                         ; write full 32bit
   130                              <1> _pregw1:
   131 000002A5 6689D8              <1>         mov     eax, ebx                        ; restore eax
   132 000002A8 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
   133 000002AE 89CA                <1>         mov     dx, cx                          ; restore dx
   134 000002B0 59                  <1> 	pop	cx
   135 000002B1 665B                <1> 	pop	ebx
   136 000002B3 C3                  <1> 	ret
   137                              <1> 
   138                              <1> pciRegWrite8:
   139 000002B4 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 8 bit write size
   140 000002BA EBAA                <1>         jmp     short pciRegWrite		; call generic PCI access
   141                              <1> 
   142                              <1> pciRegWrite16:
   143 000002BC 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit write size
   144 000002C2 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
   145 000002C8 EB9C                <1>         jmp     short pciRegWrite
   146                              <1> 
   147                              <1> pciRegWrite32:
   148 000002CA 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit write size
   149 000002D0 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
   150 000002D6 EB8E                <1>         jmp     short pciRegWrite
   151                              <1> 
   152                              <1> ; 17/02/2017 (Modifed by Erdogan Tan for various ICH device IDs)
   153                              <1> ;===============================================================
   154                              <1> ; PCIFindDevice: scan through PCI space looking for a device+vendor ID
   155                              <1> ;
   156                              <1> ;  ENTRY: none
   157                              <1> ;; Entry: EAX=Device+Vendor ID
   158                              <1> ;
   159                              <1> ;  Exit: EAX=PCI address if device found
   160                              <1> ;	 EDX=Device+Vendor ID
   161                              <1> ;        CY clear if found, set if not found. EAX invalid if CY set.
   162                              <1> ;
   163                              <1> ; [old stackless] Destroys: ebx, esi, edi, cl
   164                              <1> ;
   165                              <1> pciFindDevice:
   166                              <1> 	;push	cx
   167                              <1> 	;push	eax ; *
   168                              <1> 	;push	esi
   169                              <1> 	;push	edi
   170                              <1> 
   171                              <1>  	;mov     esi, eax                ; save off vend+device ID
   172                              <1> 
   173                              <1> 	; 17/02/2017
   174 000002D8 BE[4C1C]            <1> 	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
   175 000002DB B91500              <1> 	mov	cx, valid_id_count
   176                              <1> pfd_0:
   177 000002DE 66BF00FFFF7F        <1>        	mov     edi, (80000000h - 100h) ; start with bus 0, dev 0 func 0
   178                              <1> nextPCIdevice:
   179 000002E4 6681C700010000      <1>         add     edi, 100h
   180 000002EB 6681FF00F8FF80      <1>         cmp     edi, 80FFF800h		; scanned all devices?
   181                              <1>         ;stc
   182                              <1>         ;je 	short PCIScanExit       ; not found
   183 000002F2 720D                <1> 	jb	short pfd_1
   184 000002F4 66BF00000080        <1> 	mov     edi, 80000000h
   185 000002FA 83C604              <1> 	add	si, 4 ; scan for next device ID
   186 000002FD E202                <1> 	loop	pfd_1	 
   187 000002FF F9                  <1> 	stc	
   188                              <1> 	;jmp 	short PCIScanExit
   189 00000300 C3                  <1> 	retn
   190                              <1> pfd_1:
   191 00000301 6689F8              <1>         mov     eax, edi                ; read PCI registers
   192 00000304 E851FF              <1>         call    pciRegRead32
   193                              <1>         ;cmp    edx, esi                ; found device?
   194 00000307 663B14              <1>         cmp	edx, dword [si]
   195 0000030A 75D8                <1> 	jne     short nextPCIdevice
   196                              <1>         ;clc
   197                              <1> PCIScanExit:
   198                              <1> 	;pushf
   199 0000030C 66B800000080        <1> 	mov	eax, BIT31
   200 00000312 66F7D0              <1> 	not	eax
   201 00000315 6621F8              <1> 	and	eax, edi		; return only bus/dev/fn #
   202                              <1> 	;popf
   203                              <1> 
   204                              <1> 	;pop	edi
   205                              <1> 	;pop	esi
   206                              <1> 	;pop	edx ; *
   207                              <1> 	;pop	cx
   208 00000318 C3                  <1> 	retn
   209                              <1> 
   210                              <1> ; ----------------------------------------------------------------------------
   211                              <1> ; CODEC.ASM
   212                              <1> ; ----------------------------------------------------------------------------
   213                              <1> 
   214                              <1> ; codec configuration code. Not much here really.
   215                              <1> ; NASM version: Erdogan Tan (29/11/2016)
   216                              <1> 
   217                              <1> ; enable codec, unmute stuff, set output rate to 44.1
   218                              <1> ; entry: ax = desired sample rate
   219                              <1> 
   220                              <1> ; 19/05/2024
   221                              <1> ; 19/11/2023
   222                              <1> ; 11/11/2023
   223                              <1> ; 06/11/2023
   224                              <1> %if 1
   225                              <1> 
   226                              <1> ;	; 11/11/2023
   227                              <1> ;init_ac97_codec_err1:
   228                              <1> ;	stc
   229                              <1> ;init_ac97_codec_err2:
   230                              <1> ;	retn
   231                              <1> 
   232                              <1> 	; 13/11/2023
   233 00000319 01                  <1> VRA:	db 1	
   234                              <1> 
   235                              <1> codecConfig:
   236                              <1> 	; 19/05/2024
   237                              <1> 	; 19/11/2023
   238                              <1> 	; 15/11/2023
   239                              <1> 	; 04/11/2023
   240                              <1> 	; 17/02/2017 
   241                              <1> 	; 07/11/2016 (Erdogan Tan)
   242                              <1> 	;PORT_NABM_GLB_CTRL_STAT equ 60h
   243                              <1> 
   244                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   245                              <1>  	; 'AC97_DEF.H'
   246                              <1> 	;AC97_EXTENDED_STATUS equ 002Ah
   247                              <1> 	AC97_EA_SPDIF	equ 0002h
   248                              <1> 	AC97_EA_VRA	equ 0001h
   249                              <1> 	; 04/11/2023
   250                              <1> 	ICH_PO_CR_RESET equ 0002h  ; reset codec
   251                              <1> 	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
   252                              <1> 	ICH_PCM_246_MASK equ 300000h ; 6 channels
   253                              <1> 
   254                              <1> 	; 04/11/2023
   255                              <1> init_ac97_controller:
   256 0000031A 66A1[241E]          <1> 	mov	eax, [bus_dev_fn]
   257 0000031E B004                <1> 	mov	al, PCI_CMD_REG
   258 00000320 E827FF              <1> 	call	pciRegRead16		; read PCI command register
   259 00000323 80CA05              <1> 	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
   260 00000326 E893FF              <1> 	call	pciRegWrite16
   261                              <1> 
   262 00000329 E89801              <1> 	call	delay_100ms
   263                              <1> 
   264                              <1> 	; 19/05/2024
   265                              <1> 	; ('PLAYMOD3.ASM', Erdogan Tan, 18/05/2024)
   266                              <1> 
   267                              <1> init_ac97_codec:
   268                              <1> 	; 18/11/2023
   269 0000032C BD2800              <1> 	mov	bp, 40
   270                              <1> _initc_1:
   271                              <1> 	; 11/11/2023
   272                              <1> 	; (TRDOS 386 v2.0.5, 'audio.s')
   273 0000032F BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   274 00000332 0316[1C1E]          <1> 	add	dx, [NABMBAR]
   275 00000336 66ED                <1> 	in	eax, dx
   276                              <1> 
   277                              <1> 	; 19/05/2024
   278 00000338 E8A916              <1> 	call	delay1_4ms
   279                              <1> 
   280                              <1> 	; ?
   281 0000033B BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   282 0000033E 0316[1C1E]          <1> 	add	dx, [NABMBAR]
   283 00000342 66ED                <1> 	in	eax, dx
   284                              <1> 
   285                              <1> 	; 19/05/2024
   286 00000344 E89D16              <1> 	call	delay1_4ms
   287                              <1> 
   288 00000347 6683F8FF            <1> 	cmp	eax, 0FFFFFFFFh ; -1
   289 0000034B 7508                <1> 	jne	short _initc_3
   290                              <1> _initc_2:
   291                              <1> 	;dec	cx
   292 0000034D 4D                  <1> 	dec	bp	; 18/11/2023
   293                              <1> 	;jz	short init_ac97_codec_err1
   294                              <1> 	; 19/11/2023
   295 0000034E 7412                <1> 	jz	short _ac97_codec_ready
   296                              <1> 
   297 00000350 E87101              <1> 	call	delay_100ms
   298 00000353 EBDA                <1> 	jmp	short _initc_1
   299                              <1> _initc_3:
   300 00000355 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   301 0000035B 7505                <1> 	jnz	short _ac97_codec_ready
   302                              <1> 
   303 0000035D E8E400              <1> 	call	reset_ac97_codec
   304                              <1> 	; 15/11/2023
   305                              <1> 	;jc	short _initc_2
   306                              <1> 	; 19/05/2024
   307 00000360 EBEB                <1> 	jmp	short _initc_2
   308                              <1> 
   309                              <1> _ac97_codec_ready:
   310 00000362 8B16[1A1E]          <1> 	mov	dx, [NAMBAR]
   311                              <1> 	;add	dx, 0 ; ac_reg_0 ; reset register
   312 00000366 EF                  <1> 	out	dx, ax
   313                              <1> 
   314 00000367 E85A01              <1> 	call	delay_100ms
   315                              <1> 
   316                              <1> 	; 19/11/2023
   317 0000036A 09ED                <1> 	or	bp, bp
   318 0000036C 751F                <1> 	jnz	short _ac97_codec_init_ok
   319                              <1> 
   320 0000036E 6631C0              <1> 	xor	eax, eax ; 0
   321 00000371 8B16[1A1E]          <1> 	mov	dx, [NAMBAR]
   322 00000375 83C226              <1> 	add	dx, CODEC_REG_POWERDOWN
   323 00000378 EF                  <1> 	out	dx, ax
   324                              <1> 	
   325                              <1> 	; 19/11/2023
   326                              <1> 	; wait for 1 second
   327                              <1> 	; 19/05/2024
   328                              <1> 	;mov	ecx, 1000 ; 1000*4*0.25ms = 1s
   329                              <1> 	;mov	cx, 10
   330 00000379 B92800              <1> 	mov	cx, 40
   331                              <1> _ac97_codec_rloop:
   332                              <1> 	;call	delay1_4ms
   333                              <1> 	;call	delay1_4ms
   334                              <1> 	;call	delay1_4ms
   335                              <1> 	;call	delay1_4ms
   336 0000037C E84501              <1> 	call	delay_100ms
   337                              <1> 
   338                              <1> 	;mov	dx, [NAMBAR]
   339                              <1> 	;add	dx, CODEC_REG_POWERDOWN
   340 0000037F ED                  <1> 	in	ax, dx
   341                              <1> 
   342 00000380 E86116              <1> 	call	delay1_4ms
   343                              <1> 	
   344 00000383 83E00F              <1> 	and	ax, 0Fh
   345 00000386 3C0F                <1> 	cmp	al, 0Fh
   346 00000388 7403                <1> 	je	short _ac97_codec_init_ok
   347 0000038A E2F0                <1> 	loop	_ac97_codec_rloop 
   348                              <1> 
   349                              <1> init_ac97_codec_err1:
   350                              <1> 	;stc	; cf = 1 ; 19/05/2024
   351                              <1> init_ac97_codec_err2:
   352 0000038C C3                  <1> 	retn
   353                              <1> 
   354                              <1> _ac97_codec_init_ok:
   355                              <1>         ; 11/11/2023
   356                              <1> 	;mov	al, 2 ; force set 16-bit 2-channel PCM
   357                              <1> 	;mov	dx, GLOB_CNT_REG ; 2Ch
   358                              <1> 	;add	dx, [NABMBAR]
   359                              <1> 	;out	dx, eax
   360                              <1> 
   361                              <1> 	;;call	delay1_4ms
   362                              <1> 
   363 0000038D E86D00              <1> 	call 	reset_ac97_controller
   364                              <1> 
   365                              <1> 	; 11/11/2023
   366                              <1> 	;call	delay1_4ms
   367                              <1> 	; 19/05/2024
   368 00000390 E83101              <1> 	call	delay_100ms
   369                              <1> 
   370                              <1> 	;call 	setup_ac97_codec
   371                              <1> 
   372                              <1> setup_ac97_codec:
   373                              <1> 	; 12/11/2023
   374 00000393 813E[2C1E]80BB      <1> 	cmp	word [sample_rate], 48000
   375 00000399 7435                <1> 	je	short skip_rate
   376                              <1> 
   377                              <1> ; 11/11/2023
   378                              <1> ; 05/11/2023
   379                              <1> ;%if 1
   380                              <1> 	AC97_EA_VRA equ BIT0 ; 11/11/2023
   381                              <1> 
   382                              <1> 	; 19/05/2024
   383 0000039B E84616              <1> 	call	delay1_4ms
   384                              <1> 
   385                              <1> 	;; 19/05/2024
   386                              <1> 	;;mov	dx, [NAMBAR]
   387                              <1> 	;;add	dx, CODEC_EXT_AUDIO_REG	; 28h
   388                              <1> 	;;in	ax, dx
   389                              <1> 	;
   390                              <1> 	;; 19/05/2024
   391                              <1> 	;;test	al, 1 ; BIT0 ; Variable Rate Audio bit
   392                              <1> 	;;jz	short vra_not_supported
   393                              <1> 	;
   394                              <1> 	;; 19/05/2024
   395                              <1> 	;;call	delay1_4ms
   396                              <1> 
   397                              <1> 	; 11/11/2023
   398 0000039E 8B16[1A1E]          <1> 	mov    	dx, [NAMBAR]
   399 000003A2 83C22A              <1> 	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
   400 000003A5 ED                  <1> 	in     	ax, dx
   401                              <1> 
   402                              <1> 	; 19/05/2024
   403 000003A6 E83B16              <1> 	call	delay1_4ms
   404                              <1> 	
   405 000003A9 24FD                <1> 	and	al, ~BIT1 ; Clear DRA
   406 000003AB 0C01                <1> 	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
   407 000003AD EF                  <1> 	out	dx, ax			; Enable variable rate audio
   408                              <1> 	
   409 000003AE B90A00              <1> 	mov	cx, 10
   410                              <1> check_vra:
   411 000003B1 E81001              <1> 	call	delay_100ms
   412                              <1> 
   413                              <1> 	; 11/11/2023
   414 000003B4 ED                  <1> 	in	ax, dx
   415 000003B5 A801                <1> 	test	al, AC97_EA_VRA ; 1
   416 000003B7 7509                <1> 	jnz	short set_rate
   417                              <1> 
   418                              <1> 	; 11/11/2023
   419 000003B9 E2F6                <1> 	loop	check_vra
   420                              <1> 
   421                              <1> ;vra_not_supported:	; 19/05/2024
   422                              <1> 	; 13/11/2023
   423 000003BB C606[1903]00        <1> 	mov	byte [VRA], 0
   424 000003C0 EB0E                <1> 	jmp	short skip_rate	
   425                              <1> 
   426                              <1> 	; 19/05/2024
   427                              <1> ;;vra_not_supported:
   428                              <1> 	; 12/11/2023
   429                              <1> 	;pop	ax ; discard return address to the caller
   430                              <1> 	;mov	dx, msg_no_vra
   431                              <1> 	;jmp	vra_err
   432                              <1> 
   433                              <1> set_rate:
   434 000003C2 A1[2C1E]            <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   435                              <1> 
   436 000003C5 8B16[1A1E]          <1> 	mov    	dx, [NAMBAR]               	
   437 000003C9 83C22C              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   438 000003CC EF                  <1> 	out	dx, ax 			; PCM Front/Center Output Sample Rate
   439                              <1> 
   440 000003CD E8F400              <1> 	call	delay_100ms
   441                              <1> 
   442                              <1> 	; 12/11/2023
   443                              <1> skip_rate:
   444                              <1> 	; 11/11/2023 (temporary)
   445                              <1> 
   446                              <1> 	;mov   	dx, [NAMBAR]               	
   447                              <1> 	;add   	dx, CODEC_PCM_SURND_DACRATE_REG	; 2Eh  	  
   448                              <1> 	;out	dx, ax 			; PCM Surround Output Sample Rate
   449                              <1> 
   450                              <1> 	;call	delay_100ms
   451                              <1> 
   452                              <1> 	;mov   	dx, [NAMBAR]               	
   453                              <1> 	;add   	dx, CODEC_PCM_LFE_DACRATE_REG	; 30h  	  
   454                              <1> 	;out	dx, ax 			; PCM LFE Output Sample Rate
   455                              <1> 
   456                              <1> 	;call	delay_100ms
   457                              <1> 
   458                              <1> 	; 05/11/2023 (temporary)
   459                              <1> 	;mov	dx, [NAMBAR]               	
   460                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   461                              <1> 	;out	dx, ax 			; PCM Input Sample Rate
   462                              <1> 	;
   463                              <1> 	;call	delay_100ms
   464                              <1> 
   465 000003D0 B80202              <1> 	mov	ax, 0202h
   466 000003D3 8B16[1A1E]          <1>   	mov     dx, [NAMBAR]
   467 000003D7 83C202              <1>   	add     dx, CODEC_MASTER_VOL_REG	;02h 
   468 000003DA EF                  <1> 	out     dx, ax
   469                              <1> 
   470                              <1> 	; 11/11/2023
   471                              <1>         ;call	delay1_4ms
   472                              <1>         ;call	delay1_4ms
   473                              <1>         ;call	delay1_4ms
   474                              <1>         ;call	delay1_4ms
   475                              <1>  	;
   476                              <1>   	;mov	dx, [NAMBAR]
   477                              <1>   	;add	dx, CODEC_MASTER_MONO_VOL_REG	;06h 
   478                              <1>   	;out	dx, ax
   479                              <1> 
   480                              <1> 	; 11/11/2023
   481                              <1>         ;call	delay1_4ms
   482                              <1>         ;call	delay1_4ms
   483                              <1>         ;call	delay1_4ms
   484                              <1>         ;call	delay1_4ms
   485                              <1> 	;
   486                              <1> 	;mov	ax, 02h
   487                              <1>   	;mov	dx, [NAMBAR]
   488                              <1>   	;add	dx, CODEC_PCBEEP_VOL_REG	;0Ah 
   489                              <1>   	;out	dx, ax
   490                              <1> 
   491 000003DB E80616              <1>         call    delay1_4ms
   492 000003DE E80316              <1>         call    delay1_4ms
   493 000003E1 E80016              <1>         call    delay1_4ms
   494 000003E4 E8FD15              <1>         call    delay1_4ms
   495                              <1> 
   496                              <1> 	;mov	ax, 0202h
   497 000003E7 8B16[1A1E]          <1>   	mov     dx, [NAMBAR]
   498 000003EB 83C218              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h 
   499 000003EE EF                  <1>   	out     dx, ax
   500                              <1> 
   501 000003EF E8F215              <1>         call    delay1_4ms
   502 000003F2 E8EF15              <1>         call    delay1_4ms
   503 000003F5 E8EC15              <1>         call    delay1_4ms
   504 000003F8 E8E915              <1>         call    delay1_4ms
   505                              <1> 
   506                              <1> 	; 11/11/2023
   507                              <1> 	;mov	ax, 8008h ; Mute
   508                              <1>   	;mov	dx, [NAMBAR]
   509                              <1> 	;add	dx, CODEC_PHONE_VOL_REG		;0Ch
   510                              <1> 	;			 ; AC97_PHONE_VOL ; TAD Input (Mono)
   511                              <1>   	;out	dx, ax
   512                              <1> 	;
   513                              <1>         ;call	delay1_4ms
   514                              <1>         ;call	delay1_4ms
   515                              <1>         ;call	delay1_4ms
   516                              <1> 	;call	delay1_4ms
   517                              <1> 
   518                              <1> 	;mov	ax, 0808h
   519                              <1> 	;mov	dx, [NAMBAR]
   520                              <1> 	;add	dx, CODEC_LINE_IN_VOL_REG ;10h ; Line Input (Stereo)
   521                              <1> 	;out	dx, ax
   522                              <1> 	;
   523                              <1>         ;call	delay1_4ms
   524                              <1>         ;call	delay1_4ms
   525                              <1>         ;call	delay1_4ms
   526                              <1> 	;call	delay1_4ms
   527                              <1> 
   528                              <1>   	;mov	dx, [NAMBAR]
   529                              <1>         ;add	dx, CODEC_CD_VOL_REG ;12h ; CD Input (Stereo)
   530                              <1>   	;out	dx, ax
   531                              <1> 	;
   532                              <1>   	;mov	dx, [NAMBAR]
   533                              <1>         ;add	dx, CODEC_AUX_VOL_REG ;16h ; Aux Input (Stereo)
   534                              <1>   	;out	dx, ax
   535                              <1> 	;
   536                              <1>         ;call	delay1_4ms
   537                              <1>         ;call	delay1_4ms
   538                              <1>         ;call	delay1_4ms
   539                              <1> 	;call	delay1_4ms
   540                              <1> 
   541                              <1> 	; 19/05/2024
   542 000003FB F8                  <1> 	clc
   543                              <1> 
   544                              <1> ;detect_ac97_codec:
   545 000003FC C3                  <1>         retn
   546                              <1> 
   547                              <1> reset_ac97_controller:
   548                              <1> 	; 19/05/2024
   549                              <1> 	; 11/11/2023
   550                              <1> 	; 10/06/2017
   551                              <1> 	; 29/05/2017
   552                              <1> 	; 28/05/2017
   553                              <1> 	; reset AC97 audio controller registers
   554 000003FD 31C0                <1> 	xor     ax, ax
   555 000003FF BA0B00              <1>         mov	dx, PI_CR_REG
   556 00000402 0316[1C1E]          <1> 	add	dx, [NABMBAR]
   557 00000406 EE                  <1> 	out     dx, al
   558                              <1> 
   559                              <1> 	; 19/05/2024
   560 00000407 E8DA15              <1> 	call	delay1_4ms
   561                              <1> 
   562 0000040A BA1B00              <1>         mov     dx, PO_CR_REG
   563 0000040D 0316[1C1E]          <1> 	add	dx, [NABMBAR]
   564 00000411 EE                  <1> 	out     dx, al
   565                              <1> 
   566                              <1> 	; 19/05/2024
   567 00000412 E8CF15              <1> 	call	delay1_4ms
   568                              <1> 
   569 00000415 BA2B00              <1>         mov     dx, MC_CR_REG
   570 00000418 0316[1C1E]          <1> 	add	dx, [NABMBAR]
   571 0000041C EE                  <1> 	out     dx, al
   572                              <1> 
   573                              <1> 	; 19/05/2024
   574 0000041D E8C415              <1> 	call	delay1_4ms
   575                              <1> 
   576 00000420 B002                <1>         mov     al, RR
   577 00000422 BA0B00              <1>         mov     dx, PI_CR_REG
   578 00000425 0316[1C1E]          <1> 	add	dx, [NABMBAR]
   579 00000429 EE                  <1> 	out     dx, al
   580                              <1> 
   581                              <1> 	; 19/05/2024
   582 0000042A E8B715              <1> 	call	delay1_4ms
   583                              <1> 
   584 0000042D BA1B00              <1>         mov     dx, PO_CR_REG
   585 00000430 0316[1C1E]          <1> 	add	dx, [NABMBAR]
   586 00000434 EE                  <1> 	out     dx, al
   587                              <1> 
   588                              <1> 	; 19/05/2024
   589 00000435 E8AC15              <1> 	call	delay1_4ms
   590                              <1> 
   591 00000438 BA2B00              <1>         mov     dx, MC_CR_REG
   592 0000043B 0316[1C1E]          <1> 	add	dx, [NABMBAR]
   593 0000043F EE                  <1> 	out     dx, al
   594                              <1> 
   595                              <1> 	; 19/05/2024
   596 00000440 E8A115              <1> 	call	delay1_4ms
   597                              <1> 
   598 00000443 C3                  <1> 	retn
   599                              <1> 
   600                              <1> reset_ac97_codec:
   601                              <1> 	; 11/11/2023
   602                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   603 00000444 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   604 00000447 0316[1C1E]          <1> 	add	dx, [NABMBAR]
   605 0000044B 66ED                <1> 	in	eax, dx
   606                              <1> 
   607                              <1> 	;test	eax, 2
   608                              <1> 	; 06/08/2022
   609 0000044D A802                <1> 	test	al, 2
   610 0000044F 7405                <1> 	jz	short _r_ac97codec_cold	
   611                              <1> 
   612 00000451 E80E00              <1> 	call	warm_ac97codec_reset
   613 00000454 7306                <1> 	jnc	short _r_ac97codec_ok
   614                              <1> _r_ac97codec_cold:
   615 00000456 E83400              <1>         call    cold_ac97codec_reset
   616 00000459 7301                <1>         jnc     short _r_ac97codec_ok
   617                              <1> 	
   618                              <1> 	; 16/04/2017
   619                              <1>         ;xor	eax, eax	; timeout error
   620                              <1>        	;stc
   621 0000045B C3                  <1> 	retn
   622                              <1> 
   623                              <1> _r_ac97codec_ok:
   624 0000045C 6631C0              <1>         xor     eax, eax
   625                              <1>         ;mov	al, VIA_ACLINK_C00_READY ; 1
   626 0000045F FEC0                <1>         inc	al
   627 00000461 C3                  <1> 	retn
   628                              <1> 
   629                              <1> warm_ac97codec_reset:
   630                              <1> 	; 11/11/2023
   631                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   632                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   633 00000462 66B806000000        <1> 	mov	eax, 6
   634 00000468 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   635 0000046B 0316[1C1E]          <1> 	add	dx, [NABMBAR]
   636 0000046F 66EF                <1> 	out	dx, eax
   637                              <1> 
   638 00000471 B90A00              <1> 	mov	cx, 10	; total 1s
   639                              <1> _warm_ac97c_rst_wait:
   640 00000474 E84D00              <1> 	call	delay_100ms
   641                              <1> 
   642 00000477 BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   643 0000047A 0316[1C1E]          <1> 	add	dx, [NABMBAR]
   644 0000047E 66ED                <1> 	in	eax, dx
   645                              <1> 
   646 00000480 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   647 00000486 7504                <1> 	jnz	short _warm_ac97c_rst_ok
   648                              <1> 
   649 00000488 49                  <1>         dec     cx
   650 00000489 75E9                <1>         jnz     short _warm_ac97c_rst_wait
   651                              <1> 
   652                              <1> _warm_ac97c_rst_fail:
   653 0000048B F9                  <1>         stc
   654                              <1> _warm_ac97c_rst_ok:
   655 0000048C C3                  <1> 	retn
   656                              <1> 
   657                              <1> cold_ac97codec_reset:
   658                              <1> 	; 11/11/2023
   659                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   660                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   661 0000048D 66B802000000        <1>         mov	eax, 2
   662 00000493 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   663 00000496 0316[1C1E]          <1> 	add	dx, [NABMBAR]
   664 0000049A 66EF                <1> 	out	dx, eax
   665                              <1> 
   666 0000049C E82500              <1> 	call	delay_100ms 	; wait 100 ms
   667 0000049F E82200              <1> 	call	delay_100ms 	; wait 100 ms
   668 000004A2 E81F00              <1> 	call	delay_100ms 	; wait 100 ms
   669 000004A5 E81C00              <1> 	call	delay_100ms 	; wait 100 ms
   670                              <1> 
   671 000004A8 B91000              <1> 	mov	cx, 16	; total 20*100 ms = 2s
   672                              <1> 
   673                              <1> _cold_ac97c_rst_wait:
   674 000004AB BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   675 000004AE 0316[1C1E]          <1> 	add	dx, [NABMBAR]
   676 000004B2 66ED                <1> 	in	eax, dx
   677                              <1> 
   678 000004B4 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   679 000004BA 7507                <1> 	jnz	short _cold_ac97c_rst_ok
   680                              <1> 
   681 000004BC E80500              <1> 	call	delay_100ms
   682                              <1> 
   683 000004BF 49                  <1>         dec     cx
   684 000004C0 75E9                <1>         jnz     short _cold_ac97c_rst_wait
   685                              <1> 
   686                              <1> _cold_ac97c_rst_fail:
   687 000004C2 F9                  <1>         stc
   688                              <1> _cold_ac97c_rst_ok:
   689 000004C3 C3                  <1> 	retn
   690                              <1> 
   691                              <1> delay_100ms:
   692                              <1> 	; 11/11/2023
   693                              <1> 	; 29/05/2017
   694                              <1> 	; 24/03/2017 ('codec.asm')
   695                              <1> 	; wait 100 ms
   696 000004C4 51                  <1> 	push	cx
   697 000004C5 B99001              <1> 	mov	cx, 400  ; 400*0.25ms
   698                              <1> _delay_x_ms:
   699 000004C8 E81915              <1> 	call	delay1_4ms
   700 000004CB E2FB                <1>         loop	_delay_x_ms
   701 000004CD 59                  <1> 	pop	cx
   702 000004CE C3                  <1> 	retn
   703                              <1> 
   704                              <1> %endif
   705                              <1> 
   706                              <1> ; 11/11/2023
   707                              <1> %if 0
   708                              <1> 
   709                              <1> codecConfig:
   710                              <1> 	; 06/11/2023
   711                              <1> 	; TUNELOOP version (playing without interrupt)
   712                              <1> 	; 04/11/2023
   713                              <1> 	; 17/02/2017 
   714                              <1> 	; 07/11/2016 (Erdogan Tan)
   715                              <1> 
   716                              <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   717                              <1> 
   718                              <1> 	mov    	dx, [NAMBAR]               	
   719                              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   720                              <1> 	out	dx, ax 				; out sample rate
   721                              <1> 		
   722                              <1> 	; 05/11/2023 temp
   723                              <1> 	;mov	dx, [NAMBAR]               	
   724                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   725                              <1> 	;out	dx, ax 
   726                              <1> 
   727                              <1>         call    delay1_4ms
   728                              <1>         call    delay1_4ms
   729                              <1>         call    delay1_4ms
   730                              <1>         call    delay1_4ms
   731                              <1> 
   732                              <1> 	mov	eax, [dev_vendor]
   733                              <1>         cmp	eax, (SI7012_DID<<16)+SIS_VID
   734                              <1>         jne	short cConfig1
   735                              <1> 
   736                              <1> 	; Unmute quirk specifically for the SiS7012
   737                              <1> 
   738                              <1> 	CUSTOM_SIS_7012_REG equ 4Ch ; SiS7012-specific register
   739                              <1> 	
   740                              <1>         mov     dx, [NABMBAR]
   741                              <1>         add     dx, CUSTOM_SIS_7012_REG
   742                              <1>         in      ax, dx
   743                              <1>         or	al, 1
   744                              <1>         out     dx, ax
   745                              <1> 
   746                              <1> cConfig1:
   747                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   748                              <1> 	; initial ac97 volumes (and clear mute flag)
   749                              <1> 		
   750                              <1>   	mov     dx, [NAMBAR]
   751                              <1>   	add     dx, CODEC_MASTER_VOL_REG        ;02h ; STEREO
   752                              <1>   	;xor	ax, ax ; volume attenuation = 0 (max. volume)
   753                              <1>   	; 03/11/2023
   754                              <1> 	mov	ax, 0202h
   755                              <1> 	out     dx, ax
   756                              <1> 
   757                              <1>         call    delay1_4ms	; delays because codecs are slow
   758                              <1>         call    delay1_4ms
   759                              <1>         call    delay1_4ms
   760                              <1>         call    delay1_4ms
   761                              <1>  
   762                              <1>   	mov     dx, [NAMBAR]
   763                              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h
   764                              <1>   	;;xor	ax, ax
   765                              <1> 	;mov	ax, 0202h
   766                              <1>   	out     dx, ax
   767                              <1> 
   768                              <1>         call    delay1_4ms
   769                              <1>         call    delay1_4ms
   770                              <1>         call    delay1_4ms
   771                              <1>         call    delay1_4ms
   772                              <1>  
   773                              <1> 	retn
   774                              <1> 
   775                              <1> %endif
   455                                  ;%include 'ich_wav.asm' ; 17/02/2017 (ICH AC97 wav playing functions)
   456                                  %include 'ich_wav3.asm' ; 13/11/2023 (ICH AC97 wav playing functions)
     1                              <1> ; 04/02/2025
     2                              <1> ; 19/05/2024
     3                              <1> ; 18/11/2023
     4                              <1> ; 17/11/2023
     5                              <1> ; 16/11/2023
     6                              <1> ; 15/11/2023
     7                              <1> ; 14/11/2023
     8                              <1> ; 13/11/2023
     9                              <1> ; 03/11/2023 - 11/11/2023
    10                              <1> ; DOS based .WAV player using AC'97 and codec interface.
    11                              <1> ; ---------------------------------------------------------------
    12                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    13                              <1> ; Last Update: 17/02/2017 (by Erdogan Tan)
    14                              <1> 
    15                              <1> ; AC97 interrupt version - 09/11/2023 - Erdogan Tan
    16                              <1> ; sample rate conversion version - 13/11/2023 - Erdogan Tan
    17                              <1> 
    18                              <1> ; ICHWAV.ASM
    19                              <1> 
    20                              <1> ; player internal variables and other equates.
    21                              <1> BUFFERSIZE      equ     64 * 1024       ; 64k file buffer size.
    22                              <1> ENDOFFILE       equ     BIT0            ; flag for knowing end of file
    23                              <1> 
    24                              <1> ;===========================================================================
    25                              <1> ; entry: none. File is already open and [filehandle] filled.
    26                              <1> ; exit:  not until the song is finished or the user aborts.
    27                              <1> ;
    28                              <1> playWav:
    29                              <1> 	; 13/11/2023
    30                              <1> 
    31 000004CF 803E[1903]01        <1> 	cmp	byte [VRA], 1
    32 000004D4 720F                <1> 	jb	short chk_sample_rate
    33                              <1> playwav_48_khz:	
    34 000004D6 C706[8506][B807]    <1> 	mov	word [loadfromwavfile], loadFromFile
    35                              <1> 	;mov	word [loadsize], 0 ; 65536
    36 000004DC C706[8906]0080      <1> 	mov	word [buffersize], 32768 ; samples
    37 000004E2 E9A801              <1> 	jmp	playWav_vra
    38                              <1> 
    39                              <1> chk_sample_rate:
    40                              <1> 	; set conversion parameters
    41                              <1> 	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
    42 000004E5 A1[2C1E]            <1> 	mov	ax, [sample_rate]
    43 000004E8 3D80BB              <1> 	cmp	ax, 48000
    44 000004EB 74E9                <1> 	je	short playwav_48_khz
    45                              <1> chk_22khz:
    46 000004ED 3D2256              <1> 	cmp	ax, 22050
    47 000004F0 752F                <1> 	jne	short chk_11khz
    48 000004F2 803E[301E]08        <1> 	cmp	byte [bps], 8
    49 000004F7 760F                <1> 	jna	short chk_22khz_1
    50 000004F9 BB[0112]            <1> 	mov	bx, load_22khz_stereo_16_bit
    51 000004FC 803E[2E1E]01        <1> 	cmp	byte [stmo], 1
    52 00000501 7512                <1> 	jne	short chk_22khz_2
    53 00000503 BB[9811]            <1> 	mov	bx, load_22khz_mono_16_bit
    54 00000506 EB0D                <1> 	jmp	short chk_22khz_2
    55                              <1> chk_22khz_1:
    56 00000508 BB[3311]            <1> 	mov	bx, load_22khz_stereo_8_bit
    57 0000050B 803E[2E1E]01        <1> 	cmp	byte [stmo], 1
    58 00000510 7503                <1> 	jne	short chk_22khz_2
    59 00000512 BB[CA10]            <1> 	mov	bx, load_22khz_mono_8_bit
    60                              <1> chk_22khz_2:
    61 00000515 B85A1D              <1> 	mov	ax, 7514  ; (442*17)
    62 00000518 BA2500              <1> 	mov	dx, 37
    63 0000051B B91100              <1> 	mov	cx, 17
    64 0000051E E93301              <1> 	jmp	set_sizes
    65                              <1> chk_11khz:
    66 00000521 3D112B              <1> 	cmp	ax, 11025
    67 00000524 752F                <1> 	jne	short chk_44khz
    68 00000526 803E[301E]08        <1> 	cmp	byte [bps], 8
    69 0000052B 760F                <1> 	jna	short chk_11khz_1
    70 0000052D BB[9513]            <1> 	mov	bx, load_11khz_stereo_16_bit
    71 00000530 803E[2E1E]01        <1> 	cmp	byte [stmo], 1
    72 00000535 7512                <1> 	jne	short chk_11khz_2
    73 00000537 BB[3A13]            <1> 	mov	bx, load_11khz_mono_16_bit
    74 0000053A EB0D                <1> 	jmp	short chk_11khz_2
    75                              <1> chk_11khz_1:
    76 0000053C BB[DF12]            <1> 	mov	bx, load_11khz_stereo_8_bit
    77 0000053F 803E[2E1E]01        <1> 	cmp	byte [stmo], 1
    78 00000544 7503                <1> 	jne	short chk_11khz_2
    79 00000546 BB[8112]            <1> 	mov	bx, load_11khz_mono_8_bit
    80                              <1> chk_11khz_2:
    81 00000549 B8AD0E              <1> 	mov	ax, 3757  ; (221*17)
    82 0000054C BA4A00              <1> 	mov	dx, 74
    83 0000054F B91100              <1> 	mov	cx, 17
    84 00000552 E9FF00              <1> 	jmp	set_sizes
    85                              <1> chk_44khz:
    86 00000555 3D44AC              <1> 	cmp	ax, 44100
    87 00000558 752F                <1> 	jne	short chk_16khz
    88 0000055A 803E[301E]08        <1> 	cmp	byte [bps], 8
    89 0000055F 760F                <1> 	jna	short chk_44khz_1
    90 00000561 BB[4615]            <1> 	mov	bx, load_44khz_stereo_16_bit
    91 00000564 803E[2E1E]01        <1> 	cmp	byte [stmo], 1
    92 00000569 7512                <1> 	jne	short chk_44khz_2
    93 0000056B BB[EE14]            <1> 	mov	bx, load_44khz_mono_16_bit
    94 0000056E EB0D                <1> 	jmp	short chk_44khz_2
    95                              <1> chk_44khz_1:
    96 00000570 BB[9014]            <1> 	mov	bx, load_44khz_stereo_8_bit
    97 00000573 803E[2E1E]01        <1> 	cmp	byte [stmo], 1
    98 00000578 7503                <1> 	jne	short chk_44khz_2
    99 0000057A BB[3314]            <1> 	mov	bx, load_44khz_mono_8_bit
   100                              <1> chk_44khz_2:
   101                              <1> 	; 18/11/2023 ((file size + bss + stack) <= 64KB)
   102 0000057D B8FC36              <1> 	mov	ax, 14076 ; (612*23)
   103 00000580 BA1900              <1> 	mov	dx, 25
   104 00000583 B91700              <1> 	mov	cx, 23
   105 00000586 E9CB00              <1> 	jmp	set_sizes
   106                              <1> chk_16khz:
   107 00000589 3D803E              <1> 	cmp	ax, 16000
   108 0000058C 752F                <1> 	jne	short chk_8khz
   109 0000058E 803E[301E]08        <1> 	cmp	byte [bps], 8
   110 00000593 760F                <1> 	jna	short chk_16khz_1
   111 00000595 BB[420D]            <1> 	mov	bx, load_16khz_stereo_16_bit
   112 00000598 803E[2E1E]01        <1> 	cmp	byte [stmo], 1
   113 0000059D 7512                <1> 	jne	short chk_16khz_2
   114 0000059F BB[E10C]            <1> 	mov	bx, load_16khz_mono_16_bit
   115 000005A2 EB0D                <1> 	jmp	short chk_16khz_2
   116                              <1> chk_16khz_1:
   117 000005A4 BB[510C]            <1> 	mov	bx, load_16khz_stereo_8_bit
   118 000005A7 803E[2E1E]01        <1> 	cmp	byte [stmo], 1
   119 000005AC 7503                <1> 	jne	short chk_16khz_2
   120 000005AE BB[ED0B]            <1> 	mov	bx, load_16khz_mono_8_bit
   121                              <1> chk_16khz_2:
   122 000005B1 B85515              <1> 	mov	ax, 5461
   123 000005B4 BA0300              <1> 	mov	dx, 3
   124 000005B7 B90100              <1> 	mov	cx, 1
   125 000005BA E99700              <1> 	jmp	set_sizes
   126                              <1> chk_8khz:
   127 000005BD 3D401F              <1> 	cmp	ax, 8000
   128 000005C0 752E                <1> 	jne	short chk_24khz
   129 000005C2 803E[301E]08        <1> 	cmp	byte [bps], 8
   130 000005C7 760F                <1> 	jna	short chk_8khz_1
   131 000005C9 BB[060B]            <1> 	mov	bx, load_8khz_stereo_16_bit
   132 000005CC 803E[2E1E]01        <1> 	cmp	byte [stmo], 1
   133 000005D1 7512                <1> 	jne	short chk_8khz_2
   134 000005D3 BB[750A]            <1> 	mov	bx, load_8khz_mono_16_bit
   135 000005D6 EB0D                <1> 	jmp	short chk_8khz_2
   136                              <1> chk_8khz_1:
   137 000005D8 BB[8509]            <1> 	mov	bx, load_8khz_stereo_8_bit
   138 000005DB 803E[2E1E]01        <1> 	cmp	byte [stmo], 1
   139 000005E0 7503                <1> 	jne	short chk_8khz_2
   140 000005E2 BB[D208]            <1> 	mov	bx, load_8khz_mono_8_bit
   141                              <1> chk_8khz_2:
   142 000005E5 B8AA0A              <1> 	mov	ax, 2730
   143 000005E8 BA0600              <1> 	mov	dx, 6
   144 000005EB B90100              <1> 	mov	cx, 1
   145 000005EE EB64                <1> 	jmp	short set_sizes
   146                              <1> chk_24khz:
   147 000005F0 3DC05D              <1> 	cmp	ax, 24000
   148 000005F3 752E                <1> 	jne	short chk_32khz
   149 000005F5 803E[301E]08        <1> 	cmp	byte [bps], 8
   150 000005FA 760F                <1> 	jna	short chk_24khz_1
   151 000005FC BB[DA0E]            <1> 	mov	bx, load_24khz_stereo_16_bit
   152 000005FF 803E[2E1E]01        <1> 	cmp	byte [stmo], 1
   153 00000604 7512                <1> 	jne	short chk_24khz_2
   154 00000606 BB[8E0E]            <1> 	mov	bx, load_24khz_mono_16_bit
   155 00000609 EB0D                <1> 	jmp	short chk_24khz_2
   156                              <1> chk_24khz_1:
   157 0000060B BB[260E]            <1> 	mov	bx, load_24khz_stereo_8_bit
   158 0000060E 803E[2E1E]01        <1> 	cmp	byte [stmo], 1
   159 00000613 7503                <1> 	jne	short chk_24khz_2
   160 00000615 BB[D70D]            <1> 	mov	bx, load_24khz_mono_8_bit
   161                              <1> chk_24khz_2:
   162                              <1> 	;mov	ax, 8192
   163                              <1> 	; 04/02/2025
   164 00000618 B8FE1F              <1> 	mov	ax, 8190
   165 0000061B BA0200              <1> 	mov	dx, 2
   166 0000061E B90100              <1> 	mov	cx, 1
   167 00000621 EB31                <1> 	jmp	short set_sizes
   168                              <1> chk_32khz:
   169 00000623 3D007D              <1> 	cmp	ax, 32000
   170 00000626 7556                <1> 	jne	short vra_needed
   171 00000628 803E[301E]08        <1> 	cmp	byte [bps], 8
   172 0000062D 760F                <1> 	jna	short chk_32khz_1
   173 0000062F BB[5F10]            <1> 	mov	bx, load_32khz_stereo_16_bit
   174 00000632 803E[2E1E]01        <1> 	cmp	byte [stmo], 1
   175 00000637 7512                <1> 	jne	short chk_32khz_2
   176 00000639 BB[0F10]            <1> 	mov	bx, load_32khz_mono_16_bit
   177 0000063C EB0D                <1> 	jmp	short chk_32khz_2
   178                              <1> chk_32khz_1:
   179 0000063E BB[980F]            <1> 	mov	bx, load_32khz_stereo_8_bit
   180 00000641 803E[2E1E]01        <1> 	cmp	byte [stmo], 1
   181 00000646 7503                <1> 	jne	short chk_32khz_2
   182 00000648 BB[400F]            <1> 	mov	bx, load_32khz_mono_8_bit
   183                              <1> chk_32khz_2:
   184 0000064B B8AA2A              <1> 	mov	ax, 10922
   185 0000064E BA0300              <1> 	mov	dx, 3
   186 00000651 B90200              <1> 	mov	cx, 2
   187                              <1> 	;jmp	short set_sizes
   188                              <1> set_sizes:
   189 00000654 803E[2E1E]01        <1> 	cmp	byte [stmo], 1
   190 00000659 7402                <1> 	je	short ss_1
   191 0000065B D1E0                <1> 	shl	ax, 1
   192                              <1> ss_1:
   193 0000065D 803E[301E]08        <1> 	cmp	byte [bps], 8
   194 00000662 7602                <1> 	jna	short ss_2
   195                              <1> 	; 16 bit samples
   196 00000664 D1E0                <1> 	shl	ax, 1
   197                              <1> ss_2:
   198 00000666 A3[8706]            <1> 	mov	[loadsize], ax
   199 00000669 F7E2                <1> 	mul	dx
   200                              <1> 	;cmp	cx, 1
   201                              <1> 	;je	short ss_3
   202                              <1> ;ss_3:
   203 0000066B F7F1                <1> 	div	cx
   204 0000066D 8A0E[321E]          <1> 	mov	cl, [fbs_shift]
   205 00000671 D3E0                <1> 	shl	ax, cl
   206 00000673 D1E8                <1> 	shr	ax, 1	; buffer size is 16 bit sample count
   207 00000675 A3[8906]            <1> 	mov	[buffersize], ax
   208 00000678 891E[8506]          <1> 	mov	[loadfromwavfile], bx
   209 0000067C EB0F                <1> 	jmp	short playWav_vra
   210                              <1> 
   211                              <1> vra_needed:
   212                              <1> 	; 13/11/2023
   213 0000067E 58                  <1> 	pop	ax ; discard return address to the caller
   214 0000067F BA[B81D]            <1> 	mov	dx, msg_no_vra
   215 00000682 E9D2FA              <1> 	jmp	vra_err
   216                              <1> 
   217                              <1> 	; 13/11/2023
   218                              <1> loadfromwavfile:
   219 00000685 [B807]              <1> 	dw	loadFromFile
   220                              <1> loadsize:	; read from wav file
   221 00000687 0000                <1> 	dw	0
   222                              <1> buffersize:	; write to DMA buffer
   223 00000689 00800000            <1> 	dd	32768 ; 16 bit samples (not bytes)
   224                              <1> 
   225                              <1> playWav_vra:
   226                              <1> 	; 07/11/2023
   227                              <1> 	; clear buffer 2
   228                              <1>         ;push	es
   229                              <1> 	;mov	ax, [WAV_BUFFER2]
   230                              <1> 	;mov	es, ax
   231                              <1> 	;sub	ax, ax
   232                              <1> 	;mov	di, ax ; 17/02/2017
   233                              <1> 	;mov	cx, (BUFFERSIZE/2)
   234                              <1> 	;rep	stosw
   235                              <1> 	;pop	es
   236                              <1> 	
   237                              <1> 	; load 64k into buffer 1
   238 0000068D A1[201E]            <1>         mov     ax, [WAV_BUFFER1]
   239                              <1>         ;call	loadFromFile
   240                              <1> 	; 13/11/2023
   241 00000690 FF16[8506]          <1> 	call	word [loadfromwavfile]
   242                              <1> 
   243                              <1> 	; and 64k into buffer 2
   244 00000694 A1[221E]            <1> 	mov     ax, [WAV_BUFFER2]
   245                              <1>        	;call	loadFromFile
   246                              <1> 	; 13/11/2023
   247 00000697 FF16[8506]          <1> 	call	word [loadfromwavfile]
   248                              <1> 
   249                              <1> ; register reset the DMA engine. This may cause a pop noise on the output
   250                              <1> ; lines when the device is reset. Prolly a better idea to mute output, then
   251                              <1> ; reset.
   252                              <1> 
   253                              <1> 	; 11/11/2023
   254                              <1>         ;mov	dx, [NABMBAR]
   255                              <1>         ;add	dx, PO_CR_REG		; set pointer to Ctrl reg
   256                              <1>         ;mov	al, RR			; set reset
   257                              <1> 	;out	dx, al			; self clearing bit
   258                              <1> 
   259                              <1> ; write last valid index to 31 to start with.
   260                              <1> ; The Last Valid Index register tells the DMA engine when to stop playing.
   261                              <1> ; 
   262                              <1> ; As we progress through the song we change the last valid index to always be
   263                              <1> ; something other than the index we're currently playing.
   264                              <1> ;
   265                              <1> 	; 08/11/2023
   266                              <1> 	;; 07/11/2023
   267                              <1> 	;mov	al, 1
   268                              <1>         ;;mov	al, 31
   269                              <1> 	;call	setLastValidIndex
   270                              <1> 
   271                              <1> ; create Buffer Descriptor List
   272                              <1> ;
   273                              <1> ; A buffer descriptor list is a list of pointers and control bits that the
   274                              <1> ; DMA engine uses to know where to get the .wav data and how to play it.
   275                              <1> ;
   276                              <1> ; I set it up to use only 2 buffers of .wav data, and whenever 1 buffer is
   277                              <1> ; playing, I refresh the other one with good data.
   278                              <1> ;
   279                              <1> ;
   280                              <1> ; For the control bits, you can specify that the DMA engine fire an interrupt
   281                              <1> ; after a buffer has been processed, but I poll the current index register
   282                              <1> ; to know when it's safe to update the other buffer.
   283                              <1> ;
   284                              <1> ; I set the BUP bit, which tells the DMA engine to just play 0's (silence)
   285                              <1> ; if it ever runs out of data to play. Good for safety.
   286                              <1> ;
   287 0000069B 06                  <1>         push    es
   288 0000069C A1[1E1E]            <1>         mov     ax, [BDL_BUFFER]		; get segment # for BDL
   289 0000069F 8EC0                <1>         mov     es, ax
   290                              <1> 
   291 000006A1 B91000              <1>         mov     cx, 32 / 2                      ; make 32 entries in BDL
   292 000006A4 31FF                <1>         xor     di, di
   293                              <1> _0:
   294                              <1> 
   295                              <1> ; set buffer descriptor 0 to start of data file in memory
   296 000006A6 660FB706[201E]      <1>         movzx   eax, word [WAV_BUFFER1]
   297 000006AC 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   298 000006B0 66AB                <1>         stosd                                   ; store pointer to wavbuffer1
   299                              <1> 
   300                              <1> ;
   301                              <1> ; set length to 32k samples. 1 sample is 16bits or 2bytes.
   302                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples.
   303                              <1> ; 
   304                              <1> 
   305                              <1> ; 17/02/2017 (Erdogan Tan)
   306                              <1> ; Intel 82801AA (ICH) & Intel 82801AB (ICH0) I/O Controller Hub AC97
   307                              <1> ; Programmers Reference Manual
   308                              <1> 
   309                              <1> ; 2.2.1 Buffer Descriptor List  (on Page 13)
   310                              <1> 	;
   311                              <1> 	;  Generic Form of Buffer Descriptor
   312                              <1> 	;  ---------------------------------
   313                              <1> 	;  63   62    61-48    47-32   31-0
   314                              <1> 	;  ---  ---  --------  ------- -----
   315                              <1> 	;  IOC  BUP -reserved- Buffer  Buffer
   316                              <1> 	;		      Length   Pointer
   317                              <1> 	;		      [15:0]   [31:0]
   318                              <1> 	;
   319                              <1> 	;  IOC:	Interrupt On Completion. 
   320                              <1> 	;	1 = Enabled. 
   321                              <1> 	;	    When this is set, it means that the controller should
   322                              <1> 	;	    issue an interrupt upon completion of this buffer.
   323                              <1> 	;	    It should also set the IOC bit in the status register
   324                              <1> 	;	0 = Disabled	
   325                              <1> 	;
   326                              <1> 	;  BUP: Buffer Underrun Policy.
   327                              <1> 	;       0 = When this buffer is complete,
   328                              <1> 	;	    if the next buffer is not yet ready 
   329                              <1> 	;	    (i.e., the last valid buffer has been processed),
   330                              <1> 	;	    then continue to transmit the last valid sample.
   331                              <1> 	;	1 = When this buffer is complete,
   332                              <1> 	;     	    if this is the last valid buffer, transmit zeros after
   333                              <1> 	;	    this buffer has been processed completely.
   334                              <1> 	;	    This bit typically is set only if this is the last
   335                              <1> 	;	    buffer in the current stream.
   336                              <1> 	;
   337                              <1> 	; [31:0]: Buffer pointer. This field points to the location of
   338                              <1> 	;	  the data buffer. Since samples can be as wide as one
   339                              <1> 	;	  word, the buffer must be aligned with word boundaries,
   340                              <1> 	;	  to prevent samples from straddling DWord boundaries.
   341                              <1> 	;
   342                              <1> 	; [15:0]: Buffer Length: This is the length of the data buffer,
   343                              <1> 	;	  in number of samples. The controller uses this data
   344                              <1> 	;	  to determine the length of the buffer, in bytes.
   345                              <1> 	;	  "0" indicates no sample to process.
   346                              <1> 
   347                              <1> ; ICH2AC97.INC
   348                              <1> 
   349                              <1> ;	IOC	equ     BIT31   ; Fire an interrupt whenever this
   350                              <1> 				; buffer is complete.
   351                              <1> 
   352                              <1> ;	BUP	equ     BIT30   ; Buffer Underrun Policy.
   353                              <1> 				; if this buffer is the last buffer
   354                              <1> 				; in a playback, fill the remaining
   355                              <1> 				; samples with 0 (silence) or not.
   356                              <1> 				; It's a good idea to set this to 1
   357                              <1> 				; for the last buffer in playback,
   358                              <1> 				; otherwise you're likely to get a lot
   359                              <1> 				; of noise at the end of the sound.
   360                              <1> ;
   361                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   362                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   363                              <1> ; Luckily for us, that's the same format as .wav files.
   364                              <1> ;
   365                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   366                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   367                              <1> ;
   368                              <1> ; A value of 0 in these bits means play no samples.
   369                              <1> ;
   370                              <1> 
   371                              <1> ; ICHWAV.ASM
   372                              <1> 				    ; 19/05/2024
   373                              <1> 	;mov	eax, BUFFERSIZE / 2 ; size of buffer (32K) in (16bit) words
   374                              <1> 	; 13/11/2023
   375 000006B2 66A1[8906]          <1> 	mov	eax, [buffersize]
   376                              <1> 
   377                              <1> 	; 09/11/2023
   378 000006B6 660D000000C0        <1> 	or	eax, IOC + BUP
   379                              <1> 	; 06/11/2023
   380                              <1> 	;or	eax, BUP
   381 000006BC 66AB                <1> 	stosd
   382                              <1> 
   383                              <1> ; 2nd buffer:
   384                              <1> 
   385 000006BE 660FB706[221E]      <1>         movzx   eax, word [WAV_BUFFER2]
   386 000006C4 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   387 000006C8 66AB                <1>         stosd                                   ; store pointer to wavbuffer2
   388                              <1> 
   389                              <1> ; set length to 64k (32k of two 16 bit samples)
   390                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples
   391                              <1> ; 
   392                              <1> 	;mov	eax, BUFFERSIZE / 2
   393                              <1> 	; 13/11/2023
   394 000006CA 66A1[8906]          <1> 	mov	eax, [buffersize]
   395                              <1> 
   396                              <1> 	; 09/11/2023
   397 000006CE 660D000000C0        <1> 	or	eax, IOC + BUP
   398                              <1> 	; 06/11/2023
   399                              <1> 	;or	eax, BUP
   400 000006D4 66AB                <1> 	stosd
   401                              <1> 
   402 000006D6 E2CE                <1>         loop    _0
   403 000006D8 07                  <1>         pop     es
   404                              <1> 
   405                              <1> ;
   406                              <1> ; tell the DMA engine where to find our list of Buffer Descriptors.
   407                              <1> ; this 32bit value is a flat mode memory offset (ie no segment:offset)
   408                              <1> ;
   409                              <1> ; write NABMBAR+10h with offset of buffer descriptor list
   410                              <1> ;
   411 000006D9 660FB706[1E1E]      <1>         movzx   eax, word [BDL_BUFFER]
   412 000006DF 66C1E004            <1> 	shl     eax, 4                          ; convert seg:off to 0:off
   413 000006E3 8B16[1C1E]          <1>         mov     dx, [NABMBAR]
   414 000006E7 83C210              <1>         add     dx, PO_BDBAR_REG                ; set pointer to BDL
   415 000006EA 66EF                <1>         out     dx, eax                         ; write to AC97 controller
   416                              <1> 
   417                              <1> 	; 19/05/2024
   418 000006EC E8F512              <1> 	call	delay1_4ms
   419                              <1> 
   420                              <1> ;
   421                              <1> ; All set. Let's play some music.
   422                              <1> ;
   423                              <1> 
   424                              <1> 	; 10/11/2023
   425                              <1> 	; 08/11/2023
   426                              <1> 	; 07/11/2023
   427                              <1> 	; 08/12/2016
   428                              <1> 	; 07/10/2016
   429                              <1> 	;mov	al, 1
   430 000006EF B01F                <1> 	mov	al, 31
   431 000006F1 A2[341E]            <1> 	mov	[LVI], al ; 10/11/2023
   432 000006F4 E88E01              <1> 	call	setLastValidIndex
   433                              <1> 
   434                              <1> 	; 06/11/2023 (not neccessary)
   435                              <1> 	;; 05/11/2023
   436                              <1> 	;; reset current index
   437                              <1> 	;mov	al, 0
   438                              <1> 	;call	setCurrentIndex
   439                              <1> 
   440                              <1> 	; 06/11/2023
   441                              <1> 	;mov	byte [tLoop], 1; 30/11/2016
   442                              <1> 
   443                              <1> 	; 19/05/2024
   444 000006F7 E8EA12              <1> 	call	delay1_4ms
   445                              <1> 
   446                              <1> 	; 17/02/2017
   447 000006FA 8B16[1C1E]          <1>         mov     dx, [NABMBAR]
   448 000006FE 83C21B              <1>         add     dx, PO_CR_REG                   ; PCM out Control Register
   449                              <1>         ; 09/11/2023
   450 00000701 B011                <1> 	mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
   451                              <1> 	;			; (LVBI interrupt will not be enabled)
   452                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   453                              <1> 	;mov	al, RPBM
   454 00000703 EE                  <1> 	out     dx, al                          ; Start bus master operation.
   455                              <1> 
   456                              <1> 	; 09/11/2023
   457 00000704 C606[331E]3F        <1> 	mov	byte [b_indicator], '?'
   458                              <1> 
   459                              <1> 	; 19/05/2024
   460                              <1> 	; 06/11/2023
   461 00000709 E8D812              <1> 	call	delay1_4ms
   462 0000070C E8D512              <1> 	call	delay1_4ms
   463 0000070F E8D212              <1> 	call	delay1_4ms
   464 00000712 E8CF12              <1> 	call	delay1_4ms
   465                              <1> 
   466                              <1> 	; 10/11/2023
   467                              <1> 	;mov	byte [tloop], 1
   468                              <1> 
   469                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   470                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   471                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   472                              <1> 
   473                              <1> ; 09/11/2023
   474                              <1> ; 06/11/2023
   475                              <1> %if 1
   476                              <1> 	; 08/12/2016
   477                              <1> 	; 28/11/2016
   478                              <1> p_loop:
   479 00000715 E87601              <1> 	call    check4keyboardstop ; keyboard halt?
   480 00000718 732A                <1>         jnc	short r_loop 	   ; no ; 09/11/2023
   481                              <1> 
   482                              <1> 	; 09/11/2023
   483                              <1> 	;or	byte [flags], ENDOFFILE
   484                              <1> 	;mov	byte [b_indicator], '0'
   485                              <1> q_loop:
   486                              <1> 	;mov	al, '0'
   487 0000071A E88D00              <1> 	call	tL0
   488                              <1> 
   489                              <1> 	; 04/11/2023
   490                              <1> 	; finished with song, stop everything
   491 0000071D E8B614              <1> 	call	ac97_stop
   492                              <1> 
   493                              <1> 	; 11/11/2023
   494                              <1> irq_restore:	
   495                              <1> 	; restore previous interrupt vector and interrupt_status
   496 00000720 FA                  <1> 	cli
   497 00000721 E4A1                <1> 	in	al, 0A1h ; irq 8-15
   498 00000723 A0[151E]            <1> 	mov	al, [IRQ_status+1]
   499 00000726 E6A1                <1> 	out	0A1h, al 
   500 00000728 E421                <1> 	in	al, 021h ; irq 0-7
   501 0000072A A0[141E]            <1> 	mov	al, [IRQ_status]
   502 0000072D E621                <1> 	out	21h, al
   503                              <1> 	; ...
   504 0000072F 06                  <1> 	push	es
   505 00000730 31C0                <1> 	xor	ax, ax
   506 00000732 8EC0                <1> 	mov	es, ax
   507 00000734 A1[161E]            <1> 	mov	ax, [IRQ_vector]
   508 00000737 268907              <1> 	mov	[es:bx], ax
   509 0000073A A1[181E]            <1> 	mov	ax, [IRQ_vector+2]
   510 0000073D 26894702            <1> 	mov	[es:bx+2], ax
   511 00000741 07                  <1> 	pop	es
   512 00000742 FB                  <1> 	sti
   513 00000743 C3                  <1> 	retn
   514                              <1> 
   515                              <1> r_loop:
   516                              <1> 	; 10/11/2023
   517                              <1> 	;nop
   518                              <1> 	;nop
   519                              <1> 	;nop
   520                              <1> 
   521                              <1> 	; 11/11/2023
   522 00000744 B030                <1> 	mov	al, '0'
   523 00000746 803E[131E]00        <1> 	cmp	byte [tloop], 0
   524 0000074B 74C8                <1> 	je	short p_loop
   525 0000074D 7CCB                <1> 	jl	short q_loop
   526                              <1> 
   527 0000074F FE0E[131E]          <1> 	dec	byte [tloop] ; 0
   528                              <1> 
   529 00000753 803E[331E]31        <1> 	cmp	byte [b_indicator], '1'
   530 00000758 7515                <1> 	jne	short s_loop
   531                              <1> 
   532                              <1> 	; load buffer 1
   533 0000075A A1[201E]            <1> 	mov	ax, [WAV_BUFFER1]
   534                              <1> u_loop:
   535                              <1> 	;call	loadFromFile
   536                              <1> 	; 13/11/2023
   537 0000075D FF16[8506]          <1> 	call	[loadfromwavfile]
   538 00000761 7304                <1> 	jnc	short v_loop
   539 00000763 B030                <1> 	mov	al, '0'
   540 00000765 EBB3                <1> 	jmp	short q_loop
   541                              <1> v_loop:
   542                              <1> 	; 09/11/2023 - Erdogan Tan
   543                              <1> 	; (print buffer number on top left of the screen)
   544 00000767 A0[331E]            <1> 	mov	al, [b_indicator]
   545 0000076A E83D00              <1> 	call	tL0
   546 0000076D EBA6                <1> 	jmp	short p_loop
   547                              <1> s_loop:
   548                              <1> 	; load buffer 2
   549 0000076F A1[221E]            <1> 	mov	ax, [WAV_BUFFER2]
   550 00000772 EBE9                <1> 	jmp	short u_loop
   551                              <1> 
   552                              <1> %endif
   553                              <1> 
   554                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   555                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   556                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   557                              <1> 
   558                              <1> ; 11/11/2023
   559                              <1> ; 10/11/2023
   560                              <1> ; 09/11/2023
   561                              <1> ; 08/11/2023
   562                              <1> ; 07/11/2023
   563                              <1> %if 1
   564                              <1> 
   565                              <1> tuneLoop:
   566                              <1> 	; 11/11/2023
   567                              <1> 	; 10/11/2023
   568                              <1> 	; 09/11/2023
   569                              <1> 	; 08/11/2023
   570                              <1> 	; 06/11/2023
   571                              <1> 	;mov	al, '1'
   572                              <1> 	;call	tL0
   573                              <1> tL1:
   574                              <1> 	; 10/11/2023
   575                              <1> 	;mov	byte [tloop], 1
   576                              <1> 
   577                              <1> 	; 11/11/2023
   578                              <1> 	;call    updateLVI	; set LVI != CIV
   579                              <1> 	;jz	short tL4
   580                              <1> 
   581                              <1> 	; 11/11/2023
   582 00000774 C606[131E]01        <1> 	mov	byte [tloop], 1
   583                              <1> 
   584 00000779 E80001              <1> 	call    getCurrentIndex
   585                              <1> 
   586                              <1> 	; 10/11/2023
   587 0000077C 3A06[341E]          <1> 	cmp	al, [LVI]
   588 00000780 7511                <1> 	jne	short tL2
   589                              <1> 
   590 00000782 F606[101E]01        <1> 	test	byte [flags], ENDOFFILE
   591                              <1> 	;jnz	short tL2
   592 00000787 751A                <1> 	jnz	short tL4
   593                              <1> 
   594 00000789 48                  <1> 	dec	ax
   595 0000078A 241F                <1> 	and	al, 1Fh 
   596 0000078C E8F600              <1> 	call	setLastValidIndex
   597 0000078F 8606[341E]          <1> 	xchg	al, [LVI]
   598                              <1> 
   599                              <1> tL2:
   600 00000793 A801                <1> 	test	al, BIT0
   601 00000795 7406                <1> 	jz	short tL3
   602                              <1> 
   603 00000797 C606[331E]31        <1> 	mov	byte [b_indicator], '1'
   604 0000079C C3                  <1> 	retn
   605                              <1> tL3:	
   606 0000079D C606[331E]32        <1> 	mov	byte [b_indicator], '2'
   607 000007A2 C3                  <1> 	retn
   608                              <1> tL4:
   609                              <1> 	; 11/11/2023
   610 000007A3 C606[131E]FF        <1> 	mov	byte [tloop], -1
   611 000007A8 F9                  <1> 	stc
   612 000007A9 C3                  <1> 	retn
   613                              <1> 
   614                              <1> 
   615                              <1> 	; 06/11/2023
   616                              <1> tL0:
   617                              <1> 	; 08/11/2023
   618                              <1> 	; 05/11/2023
   619                              <1> 	; 17/02/2017 - Buffer switch test (temporary)
   620                              <1> 	; 06/11/2023
   621                              <1> 	; al = buffer indicator ('1', '2' or '0' -stop- )
   622 000007AA 1E                  <1> 	push	ds
   623                              <1> 	;push	bx 
   624 000007AB BB00B8              <1> 	mov	bx, 0B800h ; video display page segment
   625 000007AE 8EDB                <1> 	mov	ds, bx
   626 000007B0 29DB                <1> 	sub	bx, bx ; 0
   627 000007B2 B44E                <1> 	mov	ah, 4Eh
   628 000007B4 8907                <1> 	mov	[bx], ax ; show current play buffer (1, 2)
   629                              <1> 	;pop	bx
   630 000007B6 1F                  <1> 	pop	ds
   631 000007B7 C3                  <1> 	retn
   632                              <1> 
   633                              <1> %endif
   634                              <1> 
   635                              <1> ; 08/11/2023
   636                              <1> ; 07/11/2023
   637                              <1> %if 0
   638                              <1> 
   639                              <1> tuneLoop:
   640                              <1> 	; 07/11/2023
   641                              <1> 	;mov	dx, NABMBAR
   642                              <1> 	;add	dx, PO_CIV_REG ; 14h
   643                              <1> tL1:
   644                              <1> 	call    updateLVI	; set LVI != CIV
   645                              <1> 	call    check4keyboardstop
   646                              <1> 	jc	short _exit_
   647                              <1> 	call    getCurrentIndex
   648                              <1> 	test	al, BIT0
   649                              <1> 	jz	short tL1	; loop if buffer 2 is not playing
   650                              <1> 
   651                              <1> 	; load buffer 1
   652                              <1> 	mov     ax, [WAV_BUFFER1]
   653                              <1> 	call	loadFromFile
   654                              <1> 	jc	short _exit_	; end of file
   655                              <1> tL2:
   656                              <1> 	call    updateLVI
   657                              <1> 	call    check4keyboardstop
   658                              <1> 	jc	short _exit_
   659                              <1> 	call    getCurrentIndex
   660                              <1> 	test	al, BIT0
   661                              <1> 	jnz	short tL2	; loop if buffer 1 is not playing
   662                              <1> 
   663                              <1> 	; load buffer 2
   664                              <1> 	mov     ax, [WAV_BUFFER2]
   665                              <1> 	call	loadFromFile
   666                              <1> 	jnc	short tuneLoop
   667                              <1> _exit_:
   668                              <1> 	mov	dx, [NABMBAR]
   669                              <1> 	add	dx, PO_CR_REG	; PCM out Control Register
   670                              <1> 	mov	al, 0
   671                              <1> 	out	dx, al		; stop player
   672                              <1> 	retn
   673                              <1> 
   674                              <1> %endif
   675                              <1> 
   676                              <1> ; load data from file in 32k chunks. Would be nice to load 1 64k chunk,
   677                              <1> ; but in DOS you can only load FFFF bytes at a time.
   678                              <1> ;
   679                              <1> ; entry: ax = segment to load data to
   680                              <1> ; exit: CY set if end of file reached.
   681                              <1> ; note: last file buffer is padded with 0's to avoid pops at the end of song.
   682                              <1> ; assumes file is already open. uses [filehandle]
   683                              <1> 
   684                              <1> ; 07/11/2023
   685                              <1> %if 0
   686                              <1> 
   687                              <1> loadFromFile:
   688                              <1> 	; 07/11/2023
   689                              <1> 	; 06/11/2023
   690                              <1> 	; 17/02/2017
   691                              <1> 	;push	ax
   692                              <1> 	;push	cx
   693                              <1> 	;push	dx
   694                              <1> 	;push	bx
   695                              <1> 
   696                              <1> 	;push	es
   697                              <1> 	;push	ds
   698                              <1> 	
   699                              <1>         test    byte [flags], ENDOFFILE	; have we already read the
   700                              <1> 	;stc				; last of the file?
   701                              <1> 	; 05/11/2023
   702                              <1> 	;jnz	endLFF
   703                              <1> 	jz	short lff_12	; 06/11/2023
   704                              <1> 	; 06/11/2023
   705                              <1> 	;;mov	byte [tLoop], 0
   706                              <1> 	;jmp	endLFF
   707                              <1> 	stc
   708                              <1> 	retn
   709                              <1> 
   710                              <1> lff_12:	; 06/11/2023    
   711                              <1> 	mov	[fbs_seg], ax ; save buffer segment
   712                              <1> 	xor	dx, dx
   713                              <1> lff_0:
   714                              <1> 	mov	[fbs_off], dx ; buffer offset
   715                              <1> 
   716                              <1> 	mov     bx, (BUFFERSIZE / 2)	; 32k chunk
   717                              <1> 	mov	cl, [fbs_shift]
   718                              <1> 	and	cl, cl
   719                              <1> 	jz	short lff_1 ; stereo, 16 bit
   720                              <1> 
   721                              <1> 	; fbs_shift =
   722                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   723                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   724                              <1> 	shr	bx, cl ; 32K / multiplier
   725                              <1> 
   726                              <1> 	mov	ax, cs
   727                              <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   728                              <1> lff_1:
   729                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   730                              <1> 	; load file into memory
   731                              <1>         mov	cx, bx
   732                              <1> 	mov	bx, [filehandle]
   733                              <1> 	mov     ds, ax
   734                              <1>        	mov	ah, 3fh
   735                              <1> 	int	21h
   736                              <1> 
   737                              <1> 	mov	bx, cs
   738                              <1> 	mov	ds, bx
   739                              <1> 
   740                              <1> 	jc	short lff_9 ; error !
   741                              <1> 
   742                              <1> 	and	ax, ax
   743                              <1> 	jz	short lff_10
   744                              <1> 	
   745                              <1> 	mov	bl, [fbs_shift] ; shift count
   746                              <1> 	or	bl, bl
   747                              <1> 	jz	short lff_7 ; 16 bit stereo samples
   748                              <1> 
   749                              <1> 	push	es
   750                              <1> 	; 06/11/2023
   751                              <1> 	;push	di
   752                              <1> 	;push	si
   753                              <1> 	mov	di, [fbs_off]
   754                              <1> 	mov	si, [fbs_seg] ; buffer segment
   755                              <1> 	mov	es, si
   756                              <1> 	mov	si, temp_buffer ; temporary buffer address
   757                              <1> 	mov	cl, [bps] ; bits per sample (8 or 16)
   758                              <1> 	cmp	cl, 8
   759                              <1> 	jne	short lff_4 ; 16 bit samples
   760                              <1> 	; 8 bit samples
   761                              <1> 	mov	cx, ax ; byte count
   762                              <1> 	dec	bl  ; shift count, 1= stereo, 2 = mono
   763                              <1> 	jz	short lff_3 ; 8 bit, stereo
   764                              <1> lff_2:
   765                              <1> 	; mono & 8 bit
   766                              <1> 	lodsb
   767                              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   768                              <1> 	stosw	; left channel
   769                              <1> 	stosw	; right channel
   770                              <1> 	loop	lff_2
   771                              <1> 	jmp	short lff_6
   772                              <1> lff_3:
   773                              <1> 	; stereo & 8 bit
   774                              <1> 	lodsb
   775                              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   776                              <1> 	stosw
   777                              <1> 	loop	lff_3
   778                              <1> 	jmp	short lff_6
   779                              <1> lff_4:
   780                              <1> 	; 16 bit mono samples
   781                              <1> 	mov	cx, ax ; word count
   782                              <1> lff_5:	
   783                              <1> 	lodsw
   784                              <1> 	stosw	; left channel
   785                              <1> 	stosw	; right channel
   786                              <1> 	loop	lff_5
   787                              <1> lff_6:
   788                              <1> 	mov	ax, di ; save next buffer offset/position
   789                              <1> 	; 06/11/2023
   790                              <1> 	;pop	si
   791                              <1> 	;pop	di
   792                              <1> 	pop	es
   793                              <1> ;lff_7:        
   794                              <1> 	; 06/11/2023
   795                              <1> 	and	ax, ax
   796                              <1> 	jz	short endLFF ; end of 2nd half
   797                              <1> 	mov	cx, (BUFFERSIZE / 2)
   798                              <1> lff_7:
   799                              <1> 	cmp	ax, cx
   800                              <1> 	je	short endLFF	 ; 06/11/2023
   801                              <1> 	;jb	short lff_11
   802                              <1> 	;xor	cx, cx
   803                              <1> 	;sub	cx, ax
   804                              <1> 	;neg	cx
   805                              <1> 	jmp	short lff_11
   806                              <1> lff_8:
   807                              <1> 	; 07/11/2023
   808                              <1> 	cmp	word [fbs_off], (BUFFERSIZE / 2) ; 32768
   809                              <1> 	jnb	short endLFF
   810                              <1> 	
   811                              <1> 	mov	dx, ax ; buffer offset
   812                              <1> 	mov	ax, [fbs_seg] ; buffer segment
   813                              <1> 	jmp	lff_0
   814                              <1> lff_9:  
   815                              <1> 	; 07/11/2023
   816                              <1> 	;; 06/11/2023 (temporary)
   817                              <1> 	;mov	al, '!'  ; error
   818                              <1> 	;call	tL0
   819                              <1> 
   820                              <1> 	xor	ax, ax
   821                              <1> lff_10:
   822                              <1> 	; 07/11/2023
   823                              <1> 	;mov	cx, (BUFFERSIZE / 2)
   824                              <1> lff_11:
   825                              <1> 	call    padfill				; blank pad the remainder
   826                              <1>         ;clc					; don't exit with CY yet.
   827                              <1>         or	byte [flags], ENDOFFILE		; end of file flag
   828                              <1> endLFF:
   829                              <1>         ;pop	ds
   830                              <1> 	;pop	es
   831                              <1> 	; 06/11/2023
   832                              <1> 	;pop	bx
   833                              <1> 	;pop	dx
   834                              <1>         ;pop	cx
   835                              <1>         ;pop	ax
   836                              <1>         retn
   837                              <1> 
   838                              <1> %endif
   839                              <1> 
   840                              <1> ; 08/11/2023
   841                              <1> ; 07/11/2023
   842                              <1> %if 1
   843                              <1> 
   844                              <1> loadFromFile:
   845                              <1> 	; 07/11/2023
   846                              <1> 
   847 000007B8 F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
   848                              <1> 					; last of the file?
   849 000007BD 7402                <1> 	jz	short lff_0		; no
   850 000007BF F9                  <1> 	stc
   851 000007C0 C3                  <1> 	retn
   852                              <1> 
   853                              <1> lff_0:
   854                              <1> 	; 08/11/2023
   855 000007C1 89C5                <1> 	mov	bp, ax ; save buffer segment
   856                              <1> 
   857 000007C3 8A0E[321E]          <1> 	mov	cl, [fbs_shift]   
   858 000007C7 20C9                <1> 	and	cl, cl
   859 000007C9 7470                <1> 	jz	short lff_1 ; stereo, 16 bit
   860                              <1> 
   861 000007CB BFFFFF              <1> 	mov	di, BUFFERSIZE - 1 ; 65535
   862                              <1> 
   863                              <1> 	; fbs_shift =
   864                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   865                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   866 000007CE D3EF                <1> 	shr	di, cl
   867 000007D0 47                  <1> 	inc	di ; 16384 for 8 bit and mono
   868                              <1> 		   ; 32768 for 8 bit or mono
   869                              <1> 
   870 000007D1 8CC8                <1> 	mov	ax, cs
   871 000007D3 BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   872                              <1> 
   873                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   874                              <1> 	; load file into memory
   875 000007D6 89F9                <1>         mov	cx, di
   876 000007D8 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
   877 000007DC 8ED8                <1> 	mov     ds, ax
   878 000007DE B43F                <1>        	mov	ah, 3Fh
   879 000007E0 CD21                <1> 	int	21h
   880                              <1> 
   881 000007E2 8CCB                <1> 	mov	bx, cs
   882 000007E4 8EDB                <1> 	mov	ds, bx
   883                              <1> 
   884 000007E6 724A                <1> 	jc	short lff_4 ; error !
   885                              <1> 
   886                              <1> 	; 08/11/2023
   887 000007E8 31D2                <1> 	xor	dx, dx ; 0
   888                              <1> 
   889 000007EA 21C0                <1> 	and	ax, ax
   890 000007EC 7476                <1> 	jz	short lff_3
   891                              <1> 
   892 000007EE 8A1E[321E]          <1> 	mov	bl, [fbs_shift]
   893                              <1> 
   894 000007F2 06                  <1> 	push	es
   895 000007F3 89D7                <1> 	mov	di, dx ; 0 ; [fbs_off]
   896                              <1> 	;mov	bp, [fbs_seg] ; buffer segment
   897 000007F5 8EC5                <1> 	mov	es, bp
   898 000007F7 BE[361E]            <1> 	mov	si, temp_buffer ; temporary buffer address
   899 000007FA 89C1                <1> 	mov	cx, ax ; byte count
   900 000007FC 803E[301E]08        <1> 	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   901 00000801 751B                <1> 	jne	short lff_7 ; 16 bit samples
   902                              <1> 	; 8 bit samples
   903 00000803 FECB                <1> 	dec	bl  ; shift count, 1= stereo, 2 = mono
   904 00000805 740C                <1> 	jz	short lff_6 ; 8 bit, stereo
   905                              <1> lff_5:
   906                              <1> 	; mono & 8 bit
   907 00000807 AC                  <1> 	lodsb
   908 00000808 2C80                <1> 	sub	al, 80h ; 08/11/2023
   909 0000080A C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   910 0000080D AB                  <1> 	stosw	; left channel
   911 0000080E AB                  <1> 	stosw	; right channel
   912 0000080F E2F6                <1> 	loop	lff_5
   913 00000811 EB12                <1> 	jmp	short lff_9
   914                              <1> lff_6:
   915                              <1> 	; stereo & 8 bit
   916 00000813 AC                  <1> 	lodsb
   917 00000814 2C80                <1> 	sub	al, 80h ; 08/11/2023
   918 00000816 C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   919 00000819 AB                  <1> 	stosw
   920 0000081A E2F7                <1> 	loop	lff_6
   921 0000081C EB07                <1> 	jmp	short lff_9
   922                              <1> lff_7:
   923 0000081E D1E9                <1> 	shr	cx, 1; word count
   924                              <1> lff_8:
   925 00000820 AD                  <1> 	lodsw
   926 00000821 AB                  <1> 	stosw	; left channel
   927 00000822 AB                  <1> 	stosw	; right channel
   928 00000823 E2FB                <1> 	loop	lff_8
   929                              <1> lff_9:
   930 00000825 07                  <1> 	pop	es
   931 00000826 09FF                <1> 	or	di, di
   932 00000828 7442                <1> 	jz	short endLFF ; 64KB ok 
   933                              <1> 	
   934 0000082A 89F8                <1> 	mov	ax, di ; [fbs_off]
   935 0000082C 48                  <1> 	dec	ax
   936 0000082D B9FFFF              <1> 	mov	cx, BUFFERSIZE - 1 ; 65535
   937 00000830 EB32                <1> 	jmp	short lff_3
   938                              <1> 
   939                              <1> lff_4:
   940                              <1> 	; 08/11/2023
   941 00000832 B021                <1> 	mov	al, '!'  ; error
   942 00000834 E873FF              <1> 	call	tL0
   943                              <1> 
   944 00000837 31C0                <1> 	xor	ax, ax
   945 00000839 EB29                <1> 	jmp	short lff_3
   946                              <1> 
   947                              <1> lff_1:
   948                              <1> 	;mov	bp, ax ; save buffer segment
   949 0000083B 31D2                <1> 	xor	dx, dx
   950                              <1> 	; load file into memory
   951 0000083D B90080              <1>         mov	cx, (BUFFERSIZE / 2)	; 32k chunk
   952 00000840 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
   953 00000844 8ED8                <1> 	mov     ds, ax
   954 00000846 B43F                <1>        	mov	ah, 3Fh
   955 00000848 CD21                <1> 	int	21h
   956                              <1> 
   957 0000084A 8CCF                <1> 	mov	di, cs
   958 0000084C 8EDF                <1> 	mov	ds, di
   959                              <1> 
   960                              <1> 	; 07/11/2023
   961 0000084E 72E2                <1> 	jc	short lff_4 ; error !
   962                              <1> 	
   963 00000850 39C8                <1> 	cmp	ax, cx
   964 00000852 7510                <1> 	jne	short lff_3
   965                              <1> lff_2:
   966                              <1> 	; 08/11/2023
   967 00000854 01C2                <1> 	add	dx, ax
   968                              <1> 	;mov	cx, (BUFFERSIZE / 2)	; 32k chunk
   969                              <1> 	;mov	bx, [filehandle]
   970 00000856 8EDD                <1> 	mov     ds, bp
   971 00000858 B43F                <1>        	mov	ah, 3Fh
   972 0000085A CD21                <1> 	int	21h
   973                              <1> 
   974                              <1> 	;mov	di, cs
   975 0000085C 8EDF                <1> 	mov	ds, di
   976                              <1> 
   977 0000085E 72D2                <1> 	jc	short lff_4 ; error !
   978                              <1> 
   979 00000860 39C8                <1> 	cmp	ax, cx
   980 00000862 7408                <1> 	je	short endLFF
   981                              <1> lff_3:
   982 00000864 E80600              <1> 	call    padfill			; blank pad the remainder
   983                              <1>         ;clc				; don't exit with CY yet.
   984 00000867 800E[101E]01        <1>         or	byte [flags], ENDOFFILE	; end of file flag
   985                              <1> endLFF:
   986 0000086C C3                  <1>         retn
   987                              <1> 
   988                              <1> %endif
   989                              <1> 
   990                              <1> ; entry ds:ax points to last byte in file
   991                              <1> ; cx=target size
   992                              <1> ; note: must do byte size fill
   993                              <1> ; destroys bx, cx
   994                              <1> ;
   995                              <1> padfill:
   996                              <1> 	; 07/11/2023
   997                              <1> 	; 06/11/2023
   998                              <1> 	; 17/02/2017
   999 0000086D 06                  <1> 	push	es
  1000                              <1>         ;push	di
  1001                              <1> 	;mov	di, [fbs_seg]
  1002                              <1> 	;mov	es, di
  1003 0000086E 8EC5                <1>         mov	es, bp
  1004 00000870 29C1                <1> 	sub	cx, ax
  1005                              <1> 	; 08/11/2023
  1006                              <1> 	;mov	di, ax ; (wrong)
  1007 00000872 89D7                <1> 	mov	di, dx ; buffer offset
  1008 00000874 01C7                <1> 	add	di, ax       	
  1009                              <1> 	; 07/11/2023
  1010                              <1> 	;add	di, [fbs_off]
  1011 00000876 30C0                <1>         xor	al, al
  1012 00000878 F3AA                <1> 	rep	stosb
  1013                              <1> 	;mov	[fbs_off], di
  1014                              <1> 	;pop	di
  1015 0000087A 07                  <1>         pop	es
  1016 0000087B C3                  <1> 	retn
  1017                              <1> 
  1018                              <1> ; returns AL = current index value
  1019                              <1> getCurrentIndex:
  1020                              <1> 	; 08/11/2023
  1021                              <1> 	;push	dx
  1022 0000087C 8B16[1C1E]          <1> 	mov	dx, [NABMBAR]
  1023 00000880 83C214              <1> 	add	dx, PO_CIV_REG
  1024 00000883 EC                  <1> 	in	al, dx
  1025                              <1> 	;pop	dx
  1026                              <1> uLVI2:	;	06/11/2023
  1027 00000884 C3                  <1> 	retn
  1028                              <1> 
  1029                              <1> ; examines the CIV and the LVI. When they're the same, we set LVI <> CIV
  1030                              <1> ; that way, we never run out of buffers to play
  1031                              <1> 
  1032                              <1> ; 08/11/2023
  1033                              <1> %if 0
  1034                              <1> 	; 07/11/2023
  1035                              <1> updateLVI:
  1036                              <1> 	push	ax
  1037                              <1> 	push	dx
  1038                              <1> 	; 06/11/2023
  1039                              <1> 	mov	dx, [NABMBAR]
  1040                              <1> 	add	dx, PO_CIV_REG
  1041                              <1> 	; (Current Index Value and Last Valid Index value)
  1042                              <1> 	in	ax, dx
  1043                              <1> 
  1044                              <1> 	cmp	al, ah ; is current index = last index ?
  1045                              <1> 	jne	short uLVI1
  1046                              <1> 
  1047                              <1> 	call	setNewIndex
  1048                              <1> uLVI1:
  1049                              <1> 	pop	dx
  1050                              <1> 	pop	ax
  1051                              <1> 	retn
  1052                              <1> 
  1053                              <1> setNewIndex:
  1054                              <1> 	; 07/11/2023
  1055                              <1> 	push	ax
  1056                              <1>         call    getCurrentIndex                 ; get CIV
  1057                              <1>         test    byte [flags], ENDOFFILE
  1058                              <1>         jnz     short sni_1
  1059                              <1>         ; not at the end of the file yet.
  1060                              <1>         dec     al                              ; make new index <> current
  1061                              <1>         and     al, INDEX_MASK                  ; make sure new value is 0-31
  1062                              <1> sni_1:
  1063                              <1>         call    setLastValidIndex               ; write new value
  1064                              <1>         clc
  1065                              <1>         pop	ax
  1066                              <1> 	retn
  1067                              <1> 
  1068                              <1> %endif	
  1069                              <1> 
  1070                              <1> ; 08/11/2023
  1071                              <1> ; 07/11/2023
  1072                              <1> %if 0
  1073                              <1> updateLVI:
  1074                              <1> 	; 06/11/2023
  1075                              <1> 	mov	dx, [NABMBAR]
  1076                              <1> 	add	dx, PO_CIV_REG
  1077                              <1> 	; (Current Index Value and Last Valid Index value)
  1078                              <1> 	in	ax, dx
  1079                              <1> 
  1080                              <1> 	cmp	al, ah ; is current index = last index ?
  1081                              <1> 	jne	short uLVI2
  1082                              <1> 
  1083                              <1> 	; 10/11/2023
  1084                              <1> 	; 08/11/2023	
  1085                              <1> 	call	getCurrentIndex
  1086                              <1>  
  1087                              <1> 	test	byte [flags], ENDOFFILE
  1088                              <1> 	;jnz	short uLVI1
  1089                              <1> 	jz	short uLVI0  ; 08/11/2023
  1090                              <1> 
  1091                              <1> 	; 08/11/2023
  1092                              <1> 	push	ax
  1093                              <1> 	mov	dx, [NABMBAR]
  1094                              <1> 	add	dx, PO_SR_REG  ; PCM out status register
  1095                              <1> 	in	ax, dx
  1096                              <1> 
  1097                              <1> 	;test	al, 2
  1098                              <1> 	test	al, 3 ; bit 1 = Current Equals Last Valid (CELV)
  1099                              <1> 		      ; (has been processed)
  1100                              <1> 		      ; bit 0 = 1 -> DMA Controller Halted (DCH)
  1101                              <1> 	pop	ax
  1102                              <1> 	jz	short uLVI1
  1103                              <1> uLVI3:
  1104                              <1> 	xor	ax, ax
  1105                              <1> 	; zf = 1
  1106                              <1> 	retn
  1107                              <1> uLVI0:
  1108                              <1>         ; not at the end of the file yet.
  1109                              <1> 	dec	al
  1110                              <1> 	and	al, 1Fh
  1111                              <1> uLVI1:
  1112                              <1> 	;call	setLastValidIndex
  1113                              <1> ;uLVI2:
  1114                              <1> 	;retn
  1115                              <1> 
  1116                              <1> %endif
  1117                              <1> 	
  1118                              <1> ;input AL = index # to stop on
  1119                              <1> setLastValidIndex:
  1120                              <1> 	; 08/11/2023
  1121                              <1> 	;push	dx
  1122 00000885 8B16[1C1E]          <1> 	mov	dx, [NABMBAR]
  1123 00000889 83C215              <1> 	add	dx, PO_LVI_REG
  1124 0000088C EE                  <1>         out     dx, al
  1125                              <1> 	;pop	dx
  1126 0000088D C3                  <1> 	retn
  1127                              <1> 
  1128                              <1> ; 06/11/2023
  1129                              <1> ;	; 05/11/2023
  1130                              <1> ;setCurrentIndex:
  1131                              <1> ;	;push	dx
  1132                              <1> ;	mov	dx, [NABMBAR]
  1133                              <1> ;	add	dx, PO_CIV_REG
  1134                              <1> ;	out	dx, al
  1135                              <1> ;	;pop	dx
  1136                              <1> ;	retn
  1137                              <1> 
  1138                              <1> ; checks if either shift key has been pressed. Exits with CY if so.
  1139                              <1> ; 
  1140                              <1> check4keyboardstop:
  1141                              <1> 
  1142                              <1> ; 06/11/2023
  1143                              <1> %if 1
  1144                              <1> 	; 19/05/2024
  1145                              <1> 	; 08/11/2023
  1146                              <1> 	; 04/11/2023
  1147 0000088E B401                <1> 	mov	ah, 1
  1148 00000890 CD16                <1> 	int	16h
  1149 00000892 743C                <1> 	jz	short _cksr
  1150                              <1> 
  1151 00000894 30E4                <1> 	xor	ah, ah
  1152 00000896 CD16                <1> 	int	16h
  1153                              <1> 
  1154                              <1> 	;;;
  1155                              <1> 	; 19/05/2024 (change PCM out volume)
  1156 00000898 3C2B                <1> 	cmp	al, '+'
  1157 0000089A 750B                <1> 	jne	short p_1
  1158                              <1> 	
  1159 0000089C A0[D108]            <1> 	mov	al, [volume]
  1160 0000089F 3C00                <1> 	cmp	al, 0
  1161 000008A1 762B                <1> 	jna	short p_3
  1162 000008A3 FEC8                <1> 	dec	al
  1163 000008A5 EB0D                <1> 	jmp	short p_2
  1164                              <1> p_1:
  1165 000008A7 3C2D                <1> 	cmp	al, '-'
  1166 000008A9 7524                <1> 	jne	short p_4
  1167                              <1> 
  1168 000008AB A0[D108]            <1> 	mov	al, [volume]
  1169 000008AE 3C1F                <1> 	cmp	al, 31
  1170 000008B0 731C                <1> 	jnb	short p_3
  1171 000008B2 FEC0                <1> 	inc	al
  1172                              <1> p_2:
  1173 000008B4 A2[D108]            <1> 	mov	[volume], al
  1174 000008B7 88C4                <1> 	mov	ah, al
  1175 000008B9 8B16[1A1E]          <1> 	mov     dx, [NAMBAR]
  1176                              <1>   	;add    dx, CODEC_MASTER_VOL_REG
  1177 000008BD 83C218              <1> 	add	dx, CODEC_PCM_OUT_REG
  1178 000008C0 EF                  <1> 	out     dx, ax
  1179                              <1> 
  1180 000008C1 E82011              <1> 	call    delay1_4ms
  1181 000008C4 E81D11              <1>         call    delay1_4ms
  1182 000008C7 E81A11              <1>         call    delay1_4ms
  1183 000008CA E81711              <1>         call    delay1_4ms
  1184                              <1> 
  1185 000008CD F8                  <1> 	clc
  1186                              <1> p_3:
  1187 000008CE C3                  <1> 	retn
  1188                              <1> p_4:
  1189                              <1> 	;;;
  1190                              <1> 
  1191 000008CF F9                  <1> 	stc
  1192                              <1> _cksr:
  1193 000008D0 C3                  <1> 	retn
  1194                              <1> 
  1195                              <1> ; 19/05/2024
  1196 000008D1 00                  <1> volume:	db 0
  1197                              <1> 
  1198                              <1> %endif
  1199                              <1> 
  1200                              <1> ; 04/02/2025
  1201                              <1> ; 15/11/2023
  1202                              <1> ; 14/11/2023
  1203                              <1> ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  1204                              <1> ; --------------------------------------------------------
  1205                              <1> 
  1206                              <1> ;;Note:	At the end of every buffer load,
  1207                              <1> ;;	during buffer switch/swap, there will be discontinuity
  1208                              <1> ;;	between the last converted sample and the 1st sample
  1209                              <1> ;;	of the next buffer.
  1210                              <1> ;;	(like as a dot noises vaguely between normal sound samples)
  1211                              <1> ;;	-To avoid this defect, the 1st sample of
  1212                              <1> ;;	the next buffer may be read from the wav file but
  1213                              <1> ;;	the file pointer would need to be set to 1 sample back
  1214                              <1> ;;	again via seek system call. Time comsumption problem! -
  1215                              <1> ;;
  1216                              <1> ;;	Erdogan Tan - 15/11/2023
  1217                              <1> ;;
  1218                              <1> ;;	((If entire wav data would be loaded at once.. conversion
  1219                              <1> ;;	defect/noise would disappear.. but for DOS, to keep
  1220                              <1> ;;	64KB buffer limit is important also it is important
  1221                              <1> ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  1222                              <1> ;;	I have tested this program by using 2-30MB wav files.))
  1223                              <1> ;;
  1224                              <1> ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  1225                              <1> ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  1226                              <1> ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  1227                              <1> ;;			Realtek ALC850 codec.
  1228                              <1> ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  1229                              <1> 
  1230                              <1> load_8khz_mono_8_bit:
  1231                              <1> 	; 15/11/2023
  1232                              <1> 	; 14/11/2023
  1233                              <1> 	; 13/11/2023
  1234 000008D2 F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1235                              <1> 					; last of the file?
  1236 000008D7 7402                <1> 	jz	short lff8m_0		; no
  1237 000008D9 F9                  <1> 	stc
  1238 000008DA C3                  <1> 	retn
  1239                              <1> 
  1240                              <1> lff8m_0:
  1241 000008DB 8EC0                <1> 	mov	es, ax ; buffer segment
  1242 000008DD 31FF                <1> 	xor	di, di
  1243 000008DF BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1244                              <1> 	; ds = cs
  1245                              <1> 
  1246                              <1> 	; load file into memory
  1247 000008E2 8B0E[8706]          <1>         mov	cx, [loadsize]
  1248 000008E6 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  1249 000008EA B43F                <1>        	mov	ah, 3Fh
  1250 000008EC CD21                <1> 	int	21h
  1251                              <1> 	;jc	short lff8m_5 ; error !
  1252                              <1> 	; 14/11/2023
  1253 000008EE 7303                <1> 	jnc	short lff8m_6
  1254 000008F0 E98B00              <1> 	jmp	lff8m_5
  1255                              <1> 
  1256                              <1> lff8m_6:
  1257 000008F3 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1258 000008F5 21C0                <1> 	and	ax, ax
  1259                              <1> 	;jz	short lff8m_3
  1260                              <1> 	; 15/11/2023
  1261 000008F7 747E                <1> 	jz	short lff8_eof
  1262                              <1> 
  1263 000008F9 89C1                <1> 	mov	cx, ax	; byte count
  1264                              <1> lff8m_1:
  1265 000008FB AC                  <1> 	lodsb
  1266 000008FC A2[DB19]            <1> 	mov	[previous_val], al
  1267 000008FF 2C80                <1> 	sub	al, 80h
  1268 00000901 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1269 00000904 AB                  <1> 	stosw		; original sample (left channel)
  1270 00000905 AB                  <1> 	stosw		; original sample (right channel)
  1271                              <1> 	;xor	ax, ax
  1272                              <1> 	; 14/11/2023
  1273 00000906 B080                <1> 	mov	al, 80h
  1274 00000908 49                  <1> 	dec	cx
  1275 00000909 7402                <1> 	jz	short lff8m_2
  1276 0000090B 8A04                <1> 	mov	al, [si]
  1277                              <1> lff8m_2:
  1278                              <1> 	;mov	[next_val], ax
  1279 0000090D 88C7                <1> 	mov	bh, al	; [next_val]
  1280 0000090F 8A26[DB19]          <1> 	mov	ah, [previous_val]
  1281 00000913 00E0                <1> 	add	al, ah	; [previous_val]
  1282 00000915 D0D8                <1> 	rcr	al, 1
  1283 00000917 88C2                <1> 	mov	dl, al	; this is interpolated middle (3th) sample
  1284 00000919 00E0                <1> 	add	al, ah	; [previous_val]
  1285 0000091B D0D8                <1> 	rcr	al, 1	
  1286 0000091D 88C3                <1> 	mov	bl, al 	; this is temporary interpolation value
  1287 0000091F 00E0                <1> 	add	al, ah	; [previous_val]
  1288 00000921 D0D8                <1> 	rcr	al, 1
  1289 00000923 2C80                <1> 	sub	al, 80h
  1290 00000925 C1E008              <1> 	shl	ax, 8
  1291 00000928 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1292 00000929 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1293 0000092A 88D8                <1> 	mov	al, bl
  1294 0000092C 00D0                <1> 	add	al, dl
  1295 0000092E D0D8                <1> 	rcr	al, 1
  1296 00000930 2C80                <1> 	sub	al, 80h
  1297 00000932 C1E008              <1> 	shl	ax, 8
  1298 00000935 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1299 00000936 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1300 00000937 88D0                <1> 	mov	al, dl
  1301 00000939 2C80                <1> 	sub	al, 80h
  1302 0000093B C1E008              <1> 	shl	ax, 8
  1303 0000093E AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1304 0000093F AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1305                              <1> 	;mov	al, [next_val]
  1306 00000940 88F8                <1> 	mov	al, bh
  1307 00000942 00D0                <1> 	add	al, dl
  1308 00000944 D0D8                <1> 	rcr	al, 1
  1309 00000946 88C3                <1> 	mov	bl, al	; this is temporary interpolation value
  1310 00000948 00D0                <1> 	add	al, dl
  1311 0000094A D0D8                <1> 	rcr	al, 1
  1312 0000094C 2C80                <1> 	sub	al, 80h
  1313 0000094E C1E008              <1> 	shl	ax, 8
  1314 00000951 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1315 00000952 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1316                              <1> 	;mov	al, [next_val]
  1317 00000953 88F8                <1> 	mov	al, bh
  1318 00000955 00D8                <1> 	add	al, bl
  1319 00000957 D0D8                <1> 	rcr	al, 1
  1320 00000959 2C80                <1> 	sub	al, 80h
  1321 0000095B C1E008              <1> 	shl	ax, 8
  1322 0000095E AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1323 0000095F AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1324                              <1> 	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1325 00000960 09C9                <1> 	or	cx, cx
  1326 00000962 7597                <1> 	jnz	short lff8m_1
  1327                              <1> 
  1328                              <1> 	; --------------
  1329                              <1> 
  1330                              <1> lff8s_3:
  1331                              <1> lff8m_3:
  1332                              <1> lff8s2_3:
  1333                              <1> lff8m2_3:
  1334                              <1> lff16s_3:
  1335                              <1> lff16m_3:
  1336                              <1> lff16s2_3:
  1337                              <1> lff16m2_3:
  1338                              <1> lff24_3:
  1339                              <1> lff32_3:
  1340                              <1> lff44_3:
  1341                              <1> lff22_3:
  1342                              <1> lff11_3:
  1343 00000964 8B0E[8906]          <1> 	mov	cx, [buffersize] ; 16 bit (48 kHZ, stereo) sample size
  1344 00000968 D1E1                <1> 	shl	cx, 1	; byte count
  1345 0000096A 29F9                <1> 	sub	cx, di
  1346 0000096C 7606                <1> 	jna	short lff8m_4
  1347                              <1> 	;inc	cx
  1348 0000096E D1E9                <1> 	shr	cx, 1
  1349 00000970 31C0                <1> 	xor	ax, ax	; fill (remain part of) buffer with zeros
  1350 00000972 F3AB                <1> 	rep	stosw
  1351                              <1> lff8m_4:
  1352 00000974 0E                  <1> 	push	cs
  1353 00000975 07                  <1> 	pop	es
  1354 00000976 C3                  <1> 	retn
  1355                              <1> 
  1356                              <1> lff8_eof:
  1357                              <1> lff16_eof:
  1358                              <1> lff24_eof:
  1359                              <1> lff32_eof:
  1360                              <1> lff44_eof:
  1361                              <1> lff22_eof:
  1362                              <1> lff11_eof:
  1363                              <1> 	; 15/11/2023
  1364 00000977 C606[101E]01        <1> 	mov	byte [flags], ENDOFFILE
  1365 0000097C EBE6                <1> 	jmp	short lff8m_3
  1366                              <1> 
  1367                              <1> lff8s_5:
  1368                              <1> lff8m_5:
  1369                              <1> lff8s2_5:
  1370                              <1> lff8m2_5:
  1371                              <1> lff16s_5:
  1372                              <1> lff16m_5:
  1373                              <1> lff16s2_5:
  1374                              <1> lff16m2_5:
  1375                              <1> lff24_5:
  1376                              <1> lff32_5:
  1377                              <1> lff44_5:
  1378                              <1> lff22_5:
  1379                              <1> lff11_5:
  1380 0000097E B021                <1> 	mov	al, '!'  ; error
  1381 00000980 E827FE              <1> 	call	tL0
  1382                              <1> 	
  1383                              <1> 	;jmp	short lff8m_3
  1384                              <1> 	; 15/11/2023
  1385 00000983 EBF2                <1> 	jmp	lff8_eof
  1386                              <1> 
  1387                              <1> 	; --------------
  1388                              <1> 
  1389                              <1> load_8khz_stereo_8_bit:
  1390                              <1> 	; 15/11/2023
  1391                              <1> 	; 14/11/2023
  1392                              <1> 	; 13/11/2023
  1393 00000985 F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1394                              <1> 					; last of the file?
  1395 0000098A 7402                <1> 	jz	short lff8s_0		; no
  1396 0000098C F9                  <1> 	stc
  1397 0000098D C3                  <1> 	retn
  1398                              <1> 
  1399                              <1> lff8s_0:
  1400 0000098E 8EC0                <1> 	mov	es, ax ; buffer segment	
  1401 00000990 31FF                <1> 	xor	di, di
  1402 00000992 BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1403                              <1> 	; ds = cs
  1404                              <1> 
  1405                              <1> 	; load file into memory
  1406 00000995 8B0E[8706]          <1>         mov	cx, [loadsize]
  1407 00000999 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  1408 0000099D B43F                <1>        	mov	ah, 3Fh
  1409 0000099F CD21                <1> 	int	21h
  1410 000009A1 72DB                <1> 	jc	short lff8s_5 ; error !
  1411                              <1> 
  1412 000009A3 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1413                              <1> 	
  1414 000009A5 D1E8                <1> 	shr	ax, 1
  1415                              <1> 	;;and	ax, ax
  1416                              <1> 	;jz	short lff8s_3
  1417                              <1> 	; 15/11/2023
  1418 000009A7 74CE                <1> 	jz	short lff8_eof
  1419                              <1> 
  1420 000009A9 89C1                <1> 	mov	cx, ax	; word count
  1421                              <1> lff8s_1:
  1422 000009AB AC                  <1> 	lodsb
  1423 000009AC A2[DB19]            <1> 	mov	[previous_val_l], al
  1424 000009AF 2C80                <1> 	sub	al, 80h
  1425 000009B1 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1426 000009B4 AB                  <1> 	stosw		; original sample (L)
  1427 000009B5 AC                  <1> 	lodsb
  1428 000009B6 A2[DD19]            <1> 	mov	[previous_val_r], al
  1429 000009B9 2C80                <1> 	sub	al, 80h
  1430 000009BB C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1431 000009BE AB                  <1> 	stosw		; original sample (R)
  1432                              <1> 
  1433                              <1> 	;xor	ax, ax
  1434                              <1> 	; 14/11/2023
  1435 000009BF B88080              <1> 	mov	ax, 8080h
  1436 000009C2 49                  <1> 	dec	cx
  1437 000009C3 7402                <1> 	jz	short lff8s_2
  1438                              <1> 		; convert 8 bit sample to 16 bit sample
  1439 000009C5 8B04                <1> 	mov	ax, [si]
  1440                              <1> lff8s_2:
  1441 000009C7 A2[DF19]            <1> 	mov	[next_val_l], al
  1442 000009CA 8826[E119]          <1> 	mov	[next_val_r], ah
  1443 000009CE 8A26[DB19]          <1> 	mov	ah, [previous_val_l]
  1444 000009D2 00E0                <1> 	add	al, ah
  1445 000009D4 D0D8                <1> 	rcr	al, 1
  1446 000009D6 88C2                <1> 	mov	dl, al	; this is interpolated middle (3th) sample (L)
  1447 000009D8 00E0                <1> 	add	al, ah
  1448 000009DA D0D8                <1> 	rcr	al, 1
  1449 000009DC 88C3                <1> 	mov	bl, al	; this is temporary interpolation value (L)
  1450 000009DE 00E0                <1> 	add	al, ah
  1451 000009E0 D0D8                <1> 	rcr	al, 1
  1452 000009E2 2C80                <1> 	sub	al, 80h
  1453 000009E4 C1E008              <1> 	shl	ax, 8
  1454 000009E7 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1455 000009E8 A0[E119]            <1> 	mov	al, [next_val_r]
  1456 000009EB 8A26[DD19]          <1> 	mov	ah, [previous_val_r]
  1457 000009EF 00E0                <1> 	add	al, ah
  1458 000009F1 D0D8                <1> 	rcr	al, 1
  1459 000009F3 88C6                <1> 	mov	dh, al	; this is interpolated middle (3th) sample (R)
  1460 000009F5 00E0                <1> 	add	al, ah
  1461 000009F7 D0D8                <1> 	rcr	al, 1
  1462 000009F9 88C7                <1> 	mov	bh, al	; this is temporary interpolation value (R)
  1463 000009FB 00E0                <1> 	add	al, ah
  1464 000009FD D0D8                <1> 	rcr	al, 1
  1465 000009FF 2C80                <1> 	sub	al, 80h
  1466 00000A01 C1E008              <1> 	shl	ax, 8
  1467 00000A04 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1468 00000A05 88D8                <1> 	mov	al, bl
  1469 00000A07 00D0                <1> 	add	al, dl
  1470 00000A09 D0D8                <1> 	rcr	al, 1
  1471 00000A0B 2C80                <1> 	sub	al, 80h
  1472 00000A0D C1E008              <1> 	shl	ax, 8
  1473 00000A10 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1474 00000A11 88F8                <1> 	mov	al, bh
  1475 00000A13 00F0                <1> 	add	al, dh
  1476 00000A15 D0D8                <1> 	rcr	al, 1
  1477 00000A17 2C80                <1> 	sub	al, 80h
  1478 00000A19 C1E008              <1> 	shl	ax, 8
  1479 00000A1C AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1480 00000A1D 88D0                <1> 	mov	al, dl
  1481 00000A1F 2C80                <1> 	sub	al, 80h
  1482 00000A21 C1E008              <1> 	shl	ax, 8
  1483 00000A24 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1484 00000A25 88F0                <1> 	mov	al, dh
  1485 00000A27 2C80                <1> 	sub	al, 80h
  1486 00000A29 C1E008              <1> 	shl	ax, 8
  1487 00000A2C AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1488 00000A2D A0[DF19]            <1> 	mov	al, [next_val_l]
  1489 00000A30 00D0                <1> 	add	al, dl
  1490 00000A32 D0D8                <1> 	rcr	al, 1
  1491 00000A34 88C3                <1> 	mov	bl, al	; this is temporary interpolation value (L)
  1492 00000A36 00D0                <1> 	add	al, dl
  1493 00000A38 D0D8                <1> 	rcr	al, 1
  1494 00000A3A 2C80                <1> 	sub	al, 80h
  1495 00000A3C C1E008              <1> 	shl	ax, 8
  1496 00000A3F AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1497 00000A40 A0[E119]            <1> 	mov	al, [next_val_r]
  1498 00000A43 00F0                <1> 	add	al, dh
  1499 00000A45 D0D8                <1> 	rcr	al, 1
  1500 00000A47 88C7                <1> 	mov	bh, al	; this is temporary interpolation value (R)
  1501 00000A49 00F0                <1> 	add	al, dh
  1502 00000A4B D0D8                <1> 	rcr	al, 1
  1503 00000A4D 2C80                <1> 	sub	al, 80h
  1504 00000A4F C1E008              <1> 	shl	ax, 8
  1505 00000A52 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1506 00000A53 A0[DF19]            <1> 	mov	al, [next_val_l]
  1507 00000A56 00D8                <1> 	add	al, bl
  1508 00000A58 D0D8                <1> 	rcr	al, 1
  1509 00000A5A 2C80                <1> 	sub	al, 80h
  1510 00000A5C C1E008              <1> 	shl	ax, 8
  1511 00000A5F AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1512 00000A60 A0[E119]            <1> 	mov	al, [next_val_r]
  1513 00000A63 00F8                <1> 	add	al, bh
  1514 00000A65 D0D8                <1> 	rcr	al, 1
  1515 00000A67 2C80                <1> 	sub	al, 80h
  1516 00000A69 C1E008              <1> 	shl	ax, 8
  1517 00000A6C AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1518                              <1> 	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1519 00000A6D E303                <1> 	jcxz	lff8s_6
  1520 00000A6F E939FF              <1> 	jmp	lff8s_1
  1521                              <1> lff8s_6:
  1522 00000A72 E9EFFE              <1> 	jmp	lff8s_3
  1523                              <1> 
  1524                              <1> load_8khz_mono_16_bit:
  1525                              <1> 	; 13/11/2023
  1526 00000A75 F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1527                              <1> 					; last of the file?
  1528 00000A7A 7402                <1> 	jz	short lff8m2_0		; no
  1529 00000A7C F9                  <1> 	stc
  1530 00000A7D C3                  <1> 	retn
  1531                              <1> 
  1532                              <1> lff8m2_0:
  1533 00000A7E 8EC0                <1> 	mov	es, ax ; buffer segment
  1534 00000A80 31FF                <1> 	xor	di, di
  1535 00000A82 BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1536                              <1> 	; ds = cs
  1537                              <1> 
  1538                              <1> 	; load file into memory
  1539 00000A85 8B0E[8706]          <1>         mov	cx, [loadsize]
  1540 00000A89 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  1541 00000A8D B43F                <1>        	mov	ah, 3Fh
  1542 00000A8F CD21                <1> 	int	21h
  1543 00000A91 7270                <1> 	jc	short lff8m2_7 ; error !
  1544                              <1> 
  1545 00000A93 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1546                              <1> 	
  1547 00000A95 D1E8                <1> 	shr	ax, 1
  1548                              <1> 	;and	ax, ax
  1549 00000A97 7503                <1> 	jnz	short lff8m2_8
  1550                              <1> 	;jmp	lff8m2_3
  1551                              <1> 	; 15/11/2023
  1552 00000A99 E9DBFE              <1> 	jmp	lff8_eof
  1553                              <1> 
  1554                              <1> lff8m2_8:
  1555 00000A9C 89C1                <1> 	mov	cx, ax	; word count
  1556                              <1> lff8m2_1:
  1557 00000A9E AD                  <1> 	lodsw
  1558 00000A9F AB                  <1> 	stosw		; original sample (left channel)
  1559 00000AA0 AB                  <1> 	stosw		; original sample (right channel)
  1560 00000AA1 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1561 00000AA4 A3[DB19]            <1> 	mov	[previous_val], ax
  1562 00000AA7 31C0                <1> 	xor	ax, ax
  1563 00000AA9 49                  <1> 	dec	cx
  1564 00000AAA 7402                <1> 	jz	short lff8m2_2
  1565 00000AAC 8B04                <1> 	mov	ax, [si]
  1566                              <1> lff8m2_2:
  1567 00000AAE 80C480              <1> 	add	ah, 80h ; convert sound level to 0-65535 format
  1568 00000AB1 89C5                <1> 	mov	bp, ax	; [next_val]
  1569 00000AB3 0306[DB19]          <1> 	add	ax, [previous_val]
  1570 00000AB7 D1D8                <1> 	rcr	ax, 1
  1571 00000AB9 89C2                <1> 	mov	dx, ax	; this is interpolated middle (3th) sample
  1572 00000ABB 0306[DB19]          <1> 	add	ax, [previous_val]
  1573 00000ABF D1D8                <1> 	rcr	ax, 1	; this is temporary interpolation value
  1574 00000AC1 89C3                <1> 	mov	bx, ax 		
  1575 00000AC3 0306[DB19]          <1> 	add	ax, [previous_val]
  1576 00000AC7 D1D8                <1> 	rcr	ax, 1
  1577 00000AC9 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1578 00000ACC AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1579 00000ACD AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1580 00000ACE 89D8                <1> 	mov	ax, bx
  1581 00000AD0 01D0                <1> 	add	ax, dx
  1582 00000AD2 D1D8                <1> 	rcr	ax, 1
  1583 00000AD4 80EC80              <1> 	sub	ah, 80h
  1584 00000AD7 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1585 00000AD8 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1586 00000AD9 89D0                <1> 	mov	ax, dx
  1587 00000ADB 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1588 00000ADE AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1589 00000ADF AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1590 00000AE0 89E8                <1> 	mov	ax, bp
  1591 00000AE2 01D0                <1> 	add	ax, dx
  1592 00000AE4 D1D8                <1> 	rcr	ax, 1
  1593 00000AE6 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value
  1594 00000AE8 01D0                <1> 	add	ax, dx
  1595 00000AEA D1D8                <1> 	rcr	ax, 1
  1596 00000AEC 80EC80              <1> 	sub	ah, 80h
  1597 00000AEF AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1598 00000AF0 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1599 00000AF1 89E8                <1> 	mov	ax, bp
  1600 00000AF3 01D8                <1> 	add	ax, bx
  1601 00000AF5 D1D8                <1> 	rcr	ax, 1
  1602 00000AF7 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1603 00000AFA AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1604 00000AFB AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1605                              <1> 	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1606 00000AFC 09C9                <1> 	or	cx, cx
  1607 00000AFE 759E                <1> 	jnz	short lff8m2_1
  1608 00000B00 E961FE              <1> 	jmp	lff8m2_3
  1609                              <1> 
  1610                              <1> lff8m2_7:
  1611                              <1> lff8s2_7:
  1612 00000B03 E978FE              <1> 	jmp	lff8m2_5  ; error
  1613                              <1> 
  1614                              <1> load_8khz_stereo_16_bit:
  1615                              <1> 	; 16/11/2023
  1616                              <1> 	; 15/11/2023
  1617                              <1> 	; 13/11/2023
  1618 00000B06 F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1619                              <1> 					; last of the file?
  1620 00000B0B 7402                <1> 	jz	short lff8s2_0		; no
  1621 00000B0D F9                  <1> 	stc
  1622 00000B0E C3                  <1> 	retn
  1623                              <1> 
  1624                              <1> lff8s2_0:
  1625 00000B0F 8EC0                <1> 	mov	es, ax ; buffer segment
  1626 00000B11 31FF                <1> 	xor	di, di
  1627 00000B13 BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1628                              <1> 	; ds = cs
  1629                              <1> 
  1630                              <1> 	; load file into memory
  1631 00000B16 8B0E[8706]          <1>         mov	cx, [loadsize]
  1632 00000B1A 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  1633 00000B1E B43F                <1>        	mov	ah, 3Fh
  1634 00000B20 CD21                <1> 	int	21h
  1635 00000B22 72DF                <1> 	jc	short lff8s2_7 ; error !
  1636                              <1> 
  1637 00000B24 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1638                              <1> 	
  1639 00000B26 C1E802              <1> 	shr	ax, 2	; 16/11/2023
  1640                              <1> 	;and	ax, ax
  1641 00000B29 7503                <1> 	jnz	short lff8s2_8
  1642                              <1> 	;jmp	lff8s2_3
  1643                              <1> 	; 15/11/2023
  1644 00000B2B E949FE              <1> 	jmp	lff8_eof
  1645                              <1> 
  1646                              <1> lff8s2_8:
  1647 00000B2E 89C1                <1> 	mov	cx, ax ; dword count
  1648                              <1> lff8s2_1:
  1649 00000B30 AD                  <1> 	lodsw
  1650 00000B31 AB                  <1> 	stosw		; original sample (L)
  1651                              <1> 	; 15/11/2023
  1652 00000B32 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1653 00000B35 A3[DB19]            <1> 	mov	[previous_val_l], ax
  1654 00000B38 AD                  <1> 	lodsw
  1655 00000B39 AB                  <1> 	stosw		; original sample (R)
  1656 00000B3A 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1657 00000B3D A3[DD19]            <1> 	mov	[previous_val_r], ax
  1658 00000B40 31D2                <1> 	xor	dx, dx
  1659 00000B42 31C0                <1> 	xor	ax, ax
  1660                              <1> 	; 16/11/2023
  1661 00000B44 49                  <1> 	dec	cx
  1662 00000B45 7405                <1> 	jz	short lff8s2_2
  1663 00000B47 8B04                <1> 	mov	ax, [si]
  1664 00000B49 8B5402              <1> 	mov	dx, [si+2]
  1665                              <1> lff8s2_2:
  1666 00000B4C 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1667 00000B4F A3[DF19]            <1> 	mov	[next_val_l], ax
  1668 00000B52 80C680              <1> 	add	dh, 80h	; convert sound level to 0-65535 format
  1669 00000B55 8916[E119]          <1> 	mov	[next_val_r], dx
  1670 00000B59 0306[DB19]          <1> 	add	ax, [previous_val_l]
  1671 00000B5D D1D8                <1> 	rcr	ax, 1
  1672 00000B5F 89C2                <1> 	mov	dx, ax	; this is interpolated middle (3th) sample (L)
  1673 00000B61 0306[DB19]          <1> 	add	ax, [previous_val_l]
  1674 00000B65 D1D8                <1> 	rcr	ax, 1
  1675 00000B67 89C3                <1> 	mov	bx, ax 	; this is temporary interpolation value (L)
  1676 00000B69 0306[DB19]          <1> 	add	ax, [previous_val_l]
  1677 00000B6D D1D8                <1> 	rcr	ax, 1
  1678 00000B6F 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1679 00000B72 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1680 00000B73 A1[E119]            <1> 	mov	ax, [next_val_r]
  1681 00000B76 0306[DD19]          <1> 	add	ax, [previous_val_r]
  1682 00000B7A D1D8                <1> 	rcr	ax, 1
  1683 00000B7C 89C5                <1> 	mov	bp, ax	; this is interpolated middle (3th) sample (R)
  1684 00000B7E 0306[DD19]          <1> 	add	ax, [previous_val_r]
  1685 00000B82 D1D8                <1> 	rcr	ax, 1
  1686 00000B84 50                  <1> 	push	ax ; *	; this is temporary interpolation value (R)
  1687 00000B85 0306[DD19]          <1> 	add	ax, [previous_val_r]
  1688 00000B89 D1D8                <1> 	rcr	ax, 1
  1689 00000B8B 80EC80              <1> 	sub	ah, 80h
  1690 00000B8E AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1691 00000B8F 89D8                <1> 	mov	ax, bx
  1692 00000B91 01D0                <1> 	add	ax, dx
  1693 00000B93 D1D8                <1> 	rcr	ax, 1
  1694 00000B95 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1695 00000B98 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1696 00000B99 58                  <1> 	pop	ax ; *
  1697 00000B9A 01E8                <1> 	add	ax, bp
  1698 00000B9C D1D8                <1> 	rcr	ax, 1
  1699 00000B9E 80EC80              <1> 	sub	ah, 80h
  1700 00000BA1 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1701 00000BA2 89D0                <1> 	mov	ax, dx
  1702 00000BA4 80EC80              <1> 	sub	ah, 80h
  1703 00000BA7 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1704 00000BA8 89E8                <1> 	mov	ax, bp
  1705 00000BAA 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1706 00000BAD AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1707 00000BAE A1[DF19]            <1> 	mov	ax, [next_val_l]
  1708 00000BB1 01D0                <1> 	add	ax, dx
  1709 00000BB3 D1D8                <1> 	rcr	ax, 1
  1710 00000BB5 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value (L)
  1711 00000BB7 01D0                <1> 	add	ax, dx
  1712 00000BB9 D1D8                <1> 	rcr	ax, 1
  1713 00000BBB 80EC80              <1> 	sub	ah, 80h
  1714 00000BBE AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1715 00000BBF A1[E119]            <1> 	mov	ax, [next_val_r]
  1716 00000BC2 01E8                <1> 	add	ax, bp
  1717 00000BC4 D1D8                <1> 	rcr	ax, 1
  1718 00000BC6 50                  <1> 	push	ax ; ** ; this is temporary interpolation value (R)
  1719 00000BC7 01E8                <1> 	add	ax, bp
  1720 00000BC9 D1D8                <1> 	rcr	ax, 1
  1721 00000BCB 80EC80              <1> 	sub	ah, 80h
  1722 00000BCE AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1723 00000BCF A1[DF19]            <1> 	mov	ax, [next_val_l]
  1724 00000BD2 01D8                <1> 	add	ax, bx
  1725 00000BD4 D1D8                <1> 	rcr	ax, 1
  1726 00000BD6 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1727 00000BD9 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1728 00000BDA 58                  <1> 	pop	ax ; **
  1729 00000BDB 0306[E119]          <1> 	add	ax, [next_val_r]
  1730 00000BDF D1D8                <1> 	rcr	ax, 1
  1731 00000BE1 80EC80              <1> 	sub	ah, 80h
  1732 00000BE4 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1733                              <1> 	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1734 00000BE5 E303                <1> 	jcxz	lff8_s2_9
  1735 00000BE7 E946FF              <1> 	jmp	lff8s2_1
  1736                              <1> lff8_s2_9:
  1737 00000BEA E977FD              <1> 	jmp	lff8s2_3
  1738                              <1> 
  1739                              <1> ; .....................
  1740                              <1> 
  1741                              <1> load_16khz_mono_8_bit:
  1742                              <1> 	; 14/11/2023
  1743                              <1> 	; 13/11/2023
  1744 00000BED F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1745                              <1> 					; last of the file?
  1746 00000BF2 7402                <1> 	jz	short lff16m_0		; no
  1747 00000BF4 F9                  <1> 	stc
  1748 00000BF5 C3                  <1> 	retn
  1749                              <1> 
  1750                              <1> lff16m_0:
  1751 00000BF6 8EC0                <1> 	mov	es, ax ; buffer segment	
  1752 00000BF8 31FF                <1> 	xor	di, di
  1753 00000BFA BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1754                              <1> 	; ds = cs
  1755                              <1> 
  1756                              <1> 	; load file into memory
  1757 00000BFD 8B0E[8706]          <1>         mov	cx, [loadsize]
  1758 00000C01 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  1759 00000C05 B43F                <1>        	mov	ah, 3Fh
  1760 00000C07 CD21                <1> 	int	21h
  1761 00000C09 7243                <1> 	jc	short lff16m_7 ; error !
  1762                              <1> 
  1763 00000C0B 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1764                              <1> 	
  1765 00000C0D 21C0                <1> 	and	ax, ax
  1766 00000C0F 7503                <1> 	jnz	short lff16m_8
  1767                              <1> 	;jmp	lff16m_3
  1768                              <1> 	; 15/11/2023
  1769 00000C11 E963FD              <1> 	jmp	lff16_eof
  1770                              <1> 
  1771                              <1> lff16m_8:
  1772 00000C14 89C1                <1> 	mov	cx, ax	; byte count
  1773                              <1> lff16m_1:
  1774 00000C16 AC                  <1> 	lodsb
  1775                              <1> 	;mov	[previous_val], al
  1776 00000C17 88C3                <1> 	mov	bl, al
  1777 00000C19 2C80                <1> 	sub	al, 80h
  1778 00000C1B C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1779 00000C1E AB                  <1> 	stosw		; original sample (left channel)
  1780 00000C1F AB                  <1> 	stosw		; original sample (right channel)
  1781                              <1> 	;xor	ax, ax
  1782                              <1> 	; 14/11/22023
  1783 00000C20 B080                <1> 	mov	al, 80h
  1784 00000C22 49                  <1> 	dec	cx
  1785 00000C23 7402                <1> 	jz	short lff16m_2
  1786 00000C25 8A04                <1> 	mov	al, [si]
  1787                              <1> lff16m_2:
  1788                              <1> 	;mov	[next_val], al
  1789 00000C27 88C7                <1> 	mov	bh, al
  1790                              <1> 	;add	al, [previous_val]
  1791 00000C29 00D8                <1> 	add	al, bl
  1792 00000C2B D0D8                <1> 	rcr	al, 1
  1793 00000C2D 88C2                <1> 	mov	dl, al	; this is interpolated middle (temp) sample
  1794                              <1> 	;add	al, [previous_val]
  1795 00000C2F 00D8                <1> 	add	al, bl
  1796 00000C31 D0D8                <1> 	rcr	al, 1
  1797 00000C33 2C80                <1> 	sub	al, 80h
  1798 00000C35 C1E008              <1> 	shl	ax, 8
  1799 00000C38 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1800 00000C39 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1801                              <1> 	;mov	al, [next_val]
  1802 00000C3A 88F8                <1> 	mov	al, bh
  1803 00000C3C 00D0                <1> 	add	al, dl
  1804 00000C3E D0D8                <1> 	rcr	al, 1
  1805 00000C40 2C80                <1> 	sub	al, 80h
  1806 00000C42 C1E008              <1> 	shl	ax, 8
  1807 00000C45 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1808 00000C46 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1809                              <1> 	
  1810                              <1> 	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1811 00000C47 09C9                <1> 	or	cx, cx
  1812 00000C49 75CB                <1> 	jnz	short lff16m_1
  1813 00000C4B E916FD              <1> 	jmp	lff16m_3
  1814                              <1> 
  1815                              <1> lff16m_7:
  1816                              <1> lff16s_7:
  1817 00000C4E E92DFD              <1> 	jmp	lff16m_5  ; error
  1818                              <1> 
  1819                              <1> load_16khz_stereo_8_bit:
  1820                              <1> 	; 14/11/2023
  1821                              <1> 	; 13/11/2023
  1822 00000C51 F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1823                              <1> 					; last of the file?
  1824 00000C56 7402                <1> 	jz	short lff16s_0		; no
  1825 00000C58 F9                  <1> 	stc
  1826 00000C59 C3                  <1> 	retn
  1827                              <1> 
  1828                              <1> lff16s_0:
  1829 00000C5A 8EC0                <1> 	mov	es, ax ; buffer segment
  1830 00000C5C 31FF                <1> 	xor	di, di
  1831 00000C5E BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1832                              <1> 	; ds = cs
  1833                              <1> 
  1834                              <1> 	; load file into memory
  1835 00000C61 8B0E[8706]          <1>         mov	cx, [loadsize]
  1836 00000C65 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  1837 00000C69 B43F                <1>        	mov	ah, 3Fh
  1838 00000C6B CD21                <1> 	int	21h
  1839 00000C6D 72DF                <1> 	jc	short lff16s_7 ; error !
  1840                              <1> 
  1841 00000C6F 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1842                              <1> 	
  1843 00000C71 D1E8                <1> 	shr	ax, 1
  1844                              <1> 	;and	ax, ax
  1845 00000C73 7503                <1> 	jnz	short lff16s_8
  1846                              <1> 	;jmp	lff16s_3
  1847                              <1> 	; 15/11/2023
  1848 00000C75 E9FFFC              <1> 	jmp	lff16_eof
  1849                              <1> 
  1850                              <1> lff16s_8:
  1851 00000C78 89C1                <1> 	mov	cx, ax	; word count
  1852                              <1> lff16s_1:
  1853 00000C7A AC                  <1> 	lodsb
  1854 00000C7B A2[DB19]            <1> 	mov	[previous_val_l], al
  1855 00000C7E 2C80                <1> 	sub	al, 80h
  1856 00000C80 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1857 00000C83 AB                  <1> 	stosw		; original sample (L)
  1858 00000C84 AC                  <1> 	lodsb
  1859 00000C85 A2[DD19]            <1> 	mov	[previous_val_r], al
  1860 00000C88 2C80                <1> 	sub	al, 80h
  1861 00000C8A C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1862 00000C8D AB                  <1> 	stosw		; original sample (R)
  1863                              <1> 
  1864                              <1> 	;xor	ax, ax
  1865                              <1> 	; 14/11/2023
  1866 00000C8E B88080              <1> 	mov	ax, 8080h
  1867 00000C91 49                  <1> 	dec	cx
  1868 00000C92 7402                <1> 	jz	short lff16s_2
  1869                              <1> 		; convert 8 bit sample to 16 bit sample
  1870 00000C94 8B04                <1> 	mov	ax, [si]
  1871                              <1> lff16s_2:
  1872                              <1> 	;mov	[next_val_l], al
  1873                              <1> 	;mov	[next_val_r], ah
  1874 00000C96 89C3                <1> 	mov	bx, ax
  1875 00000C98 0206[DB19]          <1> 	add	al, [previous_val_l]
  1876 00000C9C D0D8                <1> 	rcr	al, 1
  1877 00000C9E 88C2                <1> 	mov	dl, al	; this is temporary interpolation value (L)
  1878 00000CA0 0206[DB19]          <1> 	add	al, [previous_val_l]
  1879 00000CA4 D0D8                <1> 	rcr	al, 1
  1880 00000CA6 2C80                <1> 	sub	al, 80h
  1881 00000CA8 C1E008              <1> 	shl	ax, 8
  1882 00000CAB AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1883 00000CAC 88F8                <1> 	mov	al, bh	; [next_val_r]
  1884 00000CAE 0206[DD19]          <1> 	add	al, [previous_val_r]
  1885 00000CB2 D0D8                <1> 	rcr	al, 1
  1886 00000CB4 88C6                <1> 	mov	dh, al	; this is temporary interpolation value (R)
  1887 00000CB6 0206[DD19]          <1> 	add	al, [previous_val_r]
  1888 00000CBA D0D8                <1> 	rcr	al, 1
  1889 00000CBC 2C80                <1> 	sub	al, 80h
  1890 00000CBE C1E008              <1> 	shl	ax, 8
  1891 00000CC1 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1892 00000CC2 88D0                <1> 	mov	al, dl
  1893 00000CC4 00D8                <1> 	add	al, bl	; [next_val_l]
  1894 00000CC6 D0D8                <1> 	rcr	al, 1
  1895 00000CC8 2C80                <1> 	sub	al, 80h
  1896 00000CCA C1E008              <1> 	shl	ax, 8
  1897 00000CCD AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1898 00000CCE 88F0                <1> 	mov	al, dh
  1899 00000CD0 00F8                <1> 	add	al, bh	; [next_val_r]
  1900 00000CD2 D0D8                <1> 	rcr	al, 1
  1901 00000CD4 2C80                <1> 	sub	al, 80h
  1902 00000CD6 C1E008              <1> 	shl	ax, 8
  1903 00000CD9 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1904                              <1> 	
  1905                              <1> 	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1906 00000CDA 09C9                <1> 	or	cx, cx
  1907 00000CDC 759C                <1> 	jnz	short lff16s_1
  1908 00000CDE E983FC              <1> 	jmp	lff16s_3
  1909                              <1> 
  1910                              <1> load_16khz_mono_16_bit:
  1911                              <1> 	; 15/11/2023
  1912                              <1> 	; 13/11/2023
  1913 00000CE1 F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1914                              <1> 					; last of the file?
  1915 00000CE6 7402                <1> 	jz	short lff16m2_0		; no
  1916 00000CE8 F9                  <1> 	stc
  1917 00000CE9 C3                  <1> 	retn
  1918                              <1> 
  1919                              <1> lff16m2_0:
  1920 00000CEA 8EC0                <1> 	mov	es, ax ; buffer segment
  1921 00000CEC 31FF                <1> 	xor	di, di
  1922 00000CEE BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1923                              <1> 	; ds = cs
  1924                              <1> 
  1925                              <1> 	; load file into memory
  1926 00000CF1 8B0E[8706]          <1>         mov	cx, [loadsize]
  1927 00000CF5 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  1928 00000CF9 B43F                <1>        	mov	ah, 3Fh
  1929 00000CFB CD21                <1> 	int	21h
  1930 00000CFD 7240                <1> 	jc	short lff16m2_7 ; error !
  1931                              <1> 
  1932 00000CFF 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1933                              <1> 	
  1934 00000D01 D1E8                <1> 	shr	ax, 1
  1935                              <1> 	;and	ax, ax
  1936 00000D03 7503                <1> 	jnz	short lff16m2_8
  1937                              <1> 	;jmp	lff16m2_3
  1938                              <1> 	; 15/11/2023
  1939 00000D05 E96FFC              <1> 	jmp	lff16_eof
  1940                              <1> 
  1941                              <1> lff16m2_8:
  1942 00000D08 89C1                <1> 	mov	cx, ax	; word count
  1943                              <1> lff16m2_1:
  1944 00000D0A AD                  <1> 	lodsw
  1945 00000D0B AB                  <1> 	stosw		; original sample (left channel)
  1946 00000D0C AB                  <1> 	stosw		; original sample (right channel)
  1947 00000D0D 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  1948                              <1> 	;mov	[previous_val], ax
  1949 00000D10 89C3                <1> 	mov	bx, ax
  1950 00000D12 31C0                <1> 	xor	ax, ax
  1951 00000D14 49                  <1> 	dec	cx
  1952 00000D15 7402                <1> 	jz	short lff16m2_2
  1953 00000D17 8B04                <1> 	mov	ax, [si]
  1954                              <1> lff16m2_2:
  1955 00000D19 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  1956 00000D1C 89C5                <1> 	mov	bp, ax	; [next_val]
  1957                              <1> 	;add	ax, [previous_val]
  1958 00000D1E 01D8                <1> 	add	ax, bx
  1959 00000D20 D1D8                <1> 	rcr	ax, 1
  1960 00000D22 89C2                <1> 	mov	dx, ax	; this is temporary interpolation value
  1961                              <1> 	;add	ax, [previous_val]
  1962 00000D24 01D8                <1> 	add	ax, bx
  1963 00000D26 D1D8                <1> 	rcr	ax, 1
  1964 00000D28 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1965 00000D2B AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1966 00000D2C AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1967 00000D2D 89E8                <1> 	mov	ax, bp
  1968 00000D2F 01D0                <1> 	add	ax, dx
  1969 00000D31 D1D8                <1> 	rcr	ax, 1
  1970 00000D33 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1971 00000D36 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1972 00000D37 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1973                              <1> 	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1974 00000D38 09C9                <1> 	or	cx, cx
  1975 00000D3A 75CE                <1> 	jnz	short lff16m2_1
  1976 00000D3C E925FC              <1> 	jmp	lff16m2_3
  1977                              <1> 
  1978                              <1> lff16m2_7:
  1979                              <1> lff16s2_7:
  1980 00000D3F E93CFC              <1> 	jmp	lff16m2_5  ; error
  1981                              <1> 
  1982                              <1> load_16khz_stereo_16_bit:
  1983                              <1> 	; 16/11/2023
  1984                              <1> 	; 15/11/2023
  1985                              <1> 	; 13/11/2023
  1986 00000D42 F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1987                              <1> 					; last of the file?
  1988 00000D47 7402                <1> 	jz	short lff16s2_0		; no
  1989 00000D49 F9                  <1> 	stc
  1990 00000D4A C3                  <1> 	retn
  1991                              <1> 
  1992                              <1> lff16s2_0:
  1993 00000D4B 8EC0                <1> 	mov	es, ax ; buffer segment	
  1994 00000D4D 31FF                <1> 	xor	di, di
  1995 00000D4F BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1996                              <1> 	; ds = cs
  1997                              <1> 
  1998                              <1> 	; load file into memory
  1999 00000D52 8B0E[8706]          <1>         mov	cx, [loadsize]
  2000 00000D56 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  2001 00000D5A B43F                <1>        	mov	ah, 3Fh
  2002 00000D5C CD21                <1> 	int	21h
  2003 00000D5E 72DF                <1> 	jc	short lff16s2_7 ; error !
  2004                              <1> 
  2005 00000D60 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2006                              <1> 	
  2007                              <1> 	;shr	ax, 1
  2008 00000D62 C1E802              <1> 	shr	ax, 2	; 16/11/2023
  2009                              <1> 	;and	ax, ax
  2010 00000D65 7503                <1> 	jnz	short lff16s2_8
  2011                              <1> 	;jmp	lff16s2_3
  2012                              <1> 	; 15/11/2023
  2013 00000D67 E90DFC              <1> 	jmp	lff16_eof
  2014                              <1> 
  2015                              <1> lff16s2_8:
  2016 00000D6A 89C1                <1> 	mov	cx, ax	; dword count
  2017                              <1> lff16s2_1:
  2018 00000D6C AD                  <1> 	lodsw
  2019 00000D6D AB                  <1> 	stosw		; original sample (L)
  2020 00000D6E 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format
  2021 00000D71 A3[DB19]            <1> 	mov	[previous_val_l], ax
  2022 00000D74 AD                  <1> 	lodsw
  2023 00000D75 AB                  <1> 	stosw		; original sample (R)
  2024 00000D76 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format
  2025 00000D79 A3[DD19]            <1> 	mov	[previous_val_r], ax
  2026 00000D7C 31D2                <1> 	xor	dx, dx
  2027 00000D7E 31C0                <1> 	xor	ax, ax
  2028                              <1> 	; 16/11/2023
  2029 00000D80 49                  <1> 	dec	cx
  2030 00000D81 7405                <1> 	jz	short lff16s2_2
  2031 00000D83 8B04                <1> 	mov	ax, [si]
  2032 00000D85 8B5402              <1> 	mov	dx, [si+2]
  2033                              <1> lff16s2_2:
  2034 00000D88 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format
  2035                              <1> 	;mov	[next_val_l], ax
  2036 00000D8B 89C5                <1> 	mov	bp, ax
  2037 00000D8D 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format
  2038 00000D90 8916[E119]          <1> 	mov	[next_val_r], dx
  2039 00000D94 0306[DB19]          <1> 	add	ax, [previous_val_l]
  2040 00000D98 D1D8                <1> 	rcr	ax, 1
  2041 00000D9A 89C2                <1> 	mov	dx, ax	; this is temporary interpolation value (L)
  2042 00000D9C 0306[DB19]          <1> 	add	ax, [previous_val_l]
  2043 00000DA0 D1D8                <1> 	rcr	ax, 1
  2044 00000DA2 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  2045 00000DA5 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  2046 00000DA6 A1[E119]            <1> 	mov	ax, [next_val_r]
  2047 00000DA9 0306[DD19]          <1> 	add	ax, [previous_val_r]
  2048 00000DAD D1D8                <1> 	rcr	ax, 1
  2049 00000DAF 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value (R)
  2050 00000DB1 0306[DD19]          <1> 	add	ax, [previous_val_r]
  2051 00000DB5 D1D8                <1> 	rcr	ax, 1
  2052 00000DB7 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2053 00000DBA AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  2054                              <1> 	;mov	ax, [next_val_l]
  2055 00000DBB 89E8                <1> 	mov	ax, bp
  2056 00000DBD 01D0                <1> 	add	ax, dx
  2057 00000DBF D1D8                <1> 	rcr	ax, 1
  2058 00000DC1 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2059 00000DC4 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  2060 00000DC5 A1[E119]            <1> 	mov	ax, [next_val_r]
  2061 00000DC8 01D8                <1> 	add	ax, bx
  2062 00000DCA D1D8                <1> 	rcr	ax, 1
  2063 00000DCC 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2064 00000DCF AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  2065                              <1> 	
  2066                              <1> 	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2067 00000DD0 09C9                <1> 	or	cx, cx
  2068 00000DD2 7598                <1> 	jnz	short lff16s2_1
  2069 00000DD4 E98DFB              <1> 	jmp	lff16s2_3
  2070                              <1> 
  2071                              <1> ; .....................
  2072                              <1> 
  2073                              <1> load_24khz_mono_8_bit:
  2074                              <1> 	; 15/11/2023
  2075 00000DD7 F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2076                              <1> 					; last of the file?
  2077 00000DDC 7402                <1> 	jz	short lff24m_0		; no
  2078 00000DDE F9                  <1> 	stc
  2079 00000DDF C3                  <1> 	retn
  2080                              <1> 
  2081                              <1> lff24m_0:
  2082 00000DE0 8EC0                <1> 	mov	es, ax ; buffer segment
  2083 00000DE2 31FF                <1> 	xor	di, di
  2084 00000DE4 BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2085                              <1> 	; ds = cs
  2086                              <1> 
  2087                              <1> 	; load file into memory
  2088 00000DE7 8B0E[8706]          <1>         mov	cx, [loadsize]
  2089 00000DEB 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  2090 00000DEF B43F                <1>        	mov	ah, 3Fh
  2091 00000DF1 CD21                <1> 	int	21h
  2092 00000DF3 722E                <1> 	jc	short lff24m_7 ; error !
  2093                              <1> 
  2094 00000DF5 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2095                              <1> 	
  2096 00000DF7 21C0                <1> 	and	ax, ax
  2097 00000DF9 7503                <1> 	jnz	short lff24m_8
  2098 00000DFB E979FB              <1> 	jmp	lff24_eof
  2099                              <1> 
  2100                              <1> lff24m_8:
  2101 00000DFE 89C1                <1> 	mov	cx, ax	; byte count
  2102                              <1> lff24m_1:
  2103 00000E00 AC                  <1> 	lodsb
  2104                              <1> 	;mov	[previous_val], al
  2105 00000E01 88C3                <1> 	mov	bl, al
  2106 00000E03 2C80                <1> 	sub	al, 80h
  2107 00000E05 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2108 00000E08 AB                  <1> 	stosw		; original sample (left channel)
  2109 00000E09 AB                  <1> 	stosw		; original sample (right channel)
  2110                              <1> 	;xor	ax, ax
  2111 00000E0A B080                <1> 	mov	al, 80h
  2112 00000E0C 49                  <1> 	dec	cx
  2113 00000E0D 7402                <1> 	jz	short lff24m_2
  2114 00000E0F 8A04                <1> 	mov	al, [si]
  2115                              <1> lff24m_2:
  2116                              <1> 	;;mov	[next_val], al
  2117                              <1> 	;mov	bh, al
  2118                              <1> 	;add	al, [previous_val]
  2119 00000E11 00D8                <1> 	add	al, bl
  2120 00000E13 D0D8                <1> 	rcr	al, 1
  2121 00000E15 2C80                <1> 	sub	al, 80h
  2122 00000E17 C1E008              <1> 	shl	ax, 8
  2123 00000E1A AB                  <1> 	stosw		; this is interpolated sample (L)
  2124 00000E1B AB                  <1> 	stosw		; this is interpolated sample (R)
  2125                              <1> 	
  2126                              <1> 	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2127 00000E1C 09C9                <1> 	or	cx, cx
  2128 00000E1E 75E0                <1> 	jnz	short lff24m_1
  2129 00000E20 E941FB              <1> 	jmp	lff24_3
  2130                              <1> 
  2131                              <1> lff24m_7:
  2132                              <1> lff24s_7:
  2133 00000E23 E958FB              <1> 	jmp	lff24_5  ; error
  2134                              <1> 
  2135                              <1> load_24khz_stereo_8_bit:
  2136                              <1> 	; 15/11/2023
  2137 00000E26 F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2138                              <1> 					; last of the file?
  2139 00000E2B 7402                <1> 	jz	short lff24s_0		; no
  2140 00000E2D F9                  <1> 	stc
  2141 00000E2E C3                  <1> 	retn
  2142                              <1> 
  2143                              <1> lff24s_0:
  2144 00000E2F 8EC0                <1> 	mov	es, ax ; buffer segment	
  2145 00000E31 31FF                <1> 	xor	di, di
  2146 00000E33 BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2147                              <1> 	; ds = cs
  2148                              <1> 
  2149                              <1> 	; load file into memory
  2150 00000E36 8B0E[8706]          <1>         mov	cx, [loadsize]
  2151 00000E3A 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  2152 00000E3E B43F                <1>        	mov	ah, 3Fh
  2153 00000E40 CD21                <1> 	int	21h
  2154 00000E42 72DF                <1> 	jc	short lff24s_7 ; error !
  2155                              <1> 
  2156 00000E44 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2157                              <1> 	
  2158 00000E46 D1E8                <1> 	shr	ax, 1
  2159                              <1> 	;and	ax, ax
  2160 00000E48 7503                <1> 	jnz	short lff24s_8
  2161 00000E4A E92AFB              <1> 	jmp	lff24_eof
  2162                              <1> 
  2163                              <1> lff24s_8:
  2164 00000E4D 89C1                <1> 	mov	cx, ax	; word count
  2165                              <1> lff24s_1:
  2166 00000E4F AC                  <1> 	lodsb
  2167 00000E50 A2[DB19]            <1> 	mov	[previous_val_l], al
  2168 00000E53 2C80                <1> 	sub	al, 80h
  2169 00000E55 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2170 00000E58 AB                  <1> 	stosw		; original sample (L)
  2171 00000E59 AC                  <1> 	lodsb
  2172 00000E5A A2[DD19]            <1> 	mov	[previous_val_r], al
  2173 00000E5D 2C80                <1> 	sub	al, 80h
  2174 00000E5F C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2175 00000E62 AB                  <1> 	stosw		; original sample (R)
  2176                              <1> 
  2177                              <1> 	;xor	ax, ax
  2178 00000E63 B88080              <1> 	mov	ax, 8080h
  2179 00000E66 49                  <1> 	dec	cx
  2180 00000E67 7402                <1> 	jz	short lff24s_2
  2181                              <1> 		; convert 8 bit sample to 16 bit sample
  2182 00000E69 8B04                <1> 	mov	ax, [si]
  2183                              <1> lff24s_2:
  2184                              <1> 	;;mov	[next_val_l], al
  2185                              <1> 	;;mov	[next_val_r], ah
  2186                              <1> 	;mov	bx, ax
  2187 00000E6B 88E7                <1> 	mov	bh, ah
  2188 00000E6D 0206[DB19]          <1> 	add	al, [previous_val_l]
  2189 00000E71 D0D8                <1> 	rcr	al, 1
  2190                              <1> 	;mov	dl, al
  2191 00000E73 2C80                <1> 	sub	al, 80h
  2192 00000E75 C1E008              <1> 	shl	ax, 8
  2193 00000E78 AB                  <1> 	stosw		; this is interpolated sample (L)
  2194 00000E79 88F8                <1> 	mov	al, bh	; [next_val_r]
  2195 00000E7B 0206[DD19]          <1> 	add	al, [previous_val_r]
  2196 00000E7F D0D8                <1> 	rcr	al, 1
  2197                              <1> 	;mov	dh, al
  2198 00000E81 2C80                <1> 	sub	al, 80h
  2199 00000E83 C1E008              <1> 	shl	ax, 8
  2200 00000E86 AB                  <1> 	stosw		; this is interpolated sample (R)
  2201                              <1> 		
  2202                              <1> 	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2203 00000E87 09C9                <1> 	or	cx, cx
  2204 00000E89 75C4                <1> 	jnz	short lff24s_1
  2205 00000E8B E9D6FA              <1> 	jmp	lff24_3
  2206                              <1> 
  2207                              <1> load_24khz_mono_16_bit:
  2208                              <1> 	; 15/11/2023
  2209 00000E8E F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2210                              <1> 					; last of the file?
  2211 00000E93 7402                <1> 	jz	short lff24m2_0		; no
  2212 00000E95 F9                  <1> 	stc
  2213 00000E96 C3                  <1> 	retn
  2214                              <1> 
  2215                              <1> lff24m2_0:
  2216 00000E97 8EC0                <1> 	mov	es, ax ; buffer segment
  2217 00000E99 31FF                <1> 	xor	di, di
  2218 00000E9B BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2219                              <1> 	; ds = cs
  2220                              <1> 
  2221                              <1> 	; load file into memory
  2222 00000E9E 8B0E[8706]          <1>         mov	cx, [loadsize]
  2223 00000EA2 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  2224 00000EA6 B43F                <1>        	mov	ah, 3Fh
  2225 00000EA8 CD21                <1> 	int	21h
  2226 00000EAA 722B                <1> 	jc	short lff24m2_7 ; error !
  2227                              <1> 
  2228 00000EAC 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2229                              <1> 	
  2230 00000EAE D1E8                <1> 	shr	ax, 1
  2231                              <1> 	;and	ax, ax
  2232 00000EB0 7503                <1> 	jnz	short lff24m2_8
  2233 00000EB2 E9C2FA              <1> 	jmp	lff24_eof
  2234                              <1> 
  2235                              <1> lff24m2_8:
  2236 00000EB5 89C1                <1> 	mov	cx, ax	; word count
  2237                              <1> lff24m2_1:
  2238 00000EB7 AD                  <1> 	lodsw
  2239 00000EB8 AB                  <1> 	stosw		; original sample (left channel)
  2240 00000EB9 AB                  <1> 	stosw		; original sample (right channel)
  2241 00000EBA 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  2242                              <1> 	;mov	[previous_val], ax
  2243                              <1> 	;mov	bx, ax
  2244                              <1> 	;xor	ax, ax
  2245 00000EBD 31DB                <1> 	xor	bx, bx
  2246 00000EBF 49                  <1> 	dec	cx
  2247 00000EC0 7402                <1> 	jz	short lff24m2_2
  2248                              <1> 	;mov	ax, [si
  2249 00000EC2 8B1C                <1> 	mov	bx, [si]
  2250                              <1> lff24m2_2:
  2251                              <1> 	; 04/02/2025
  2252 00000EC4 80C780              <1> 	add	bh, 80h ; convert sound level 0 to 65535 format
  2253                              <1> 	;add	ah, 80h
  2254                              <1> 	;mov	bp, ax	; [next_val]
  2255                              <1> 	;add	ax, [previous_val]
  2256                              <1> 	; ax = [previous_val]
  2257                              <1> 	; bx = [next_val]
  2258 00000EC7 01D8                <1> 	add	ax, bx
  2259 00000EC9 D1D8                <1> 	rcr	ax, 1
  2260 00000ECB 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2261 00000ECE AB                  <1> 	stosw		; this is interpolated sample (L)
  2262 00000ECF AB                  <1> 	stosw		; this is interpolated sample (R)
  2263                              <1> 	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2264 00000ED0 09C9                <1> 	or	cx, cx
  2265 00000ED2 75E3                <1> 	jnz	short lff24m2_1
  2266 00000ED4 E98DFA              <1> 	jmp	lff24_3
  2267                              <1> 
  2268                              <1> lff24m2_7:
  2269                              <1> lff24s2_7:
  2270 00000ED7 E9A4FA              <1> 	jmp	lff24_5  ; error
  2271                              <1> 
  2272                              <1> load_24khz_stereo_16_bit:
  2273                              <1> 	; 16/11/2023
  2274                              <1> 	; 15/11/2023
  2275 00000EDA F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2276                              <1> 					; last of the file?
  2277 00000EDF 7402                <1> 	jz	short lff24s2_0		; no
  2278 00000EE1 F9                  <1> 	stc
  2279 00000EE2 C3                  <1> 	retn
  2280                              <1> 
  2281                              <1> lff24s2_0:
  2282 00000EE3 8EC0                <1> 	mov	es, ax ; buffer segment
  2283 00000EE5 31FF                <1> 	xor	di, di
  2284 00000EE7 BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2285                              <1> 	; ds = cs
  2286                              <1> 
  2287                              <1> 	; load file into memory
  2288 00000EEA 8B0E[8706]          <1>         mov	cx, [loadsize]
  2289 00000EEE 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  2290 00000EF2 B43F                <1>        	mov	ah, 3Fh
  2291 00000EF4 CD21                <1> 	int	21h
  2292 00000EF6 72DF                <1> 	jc	short lff24s2_7 ; error !
  2293                              <1> 
  2294 00000EF8 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2295                              <1> 	
  2296                              <1> 	;shr	ax, 1
  2297 00000EFA C1E802              <1> 	shr	ax, 2	; 16/11/2023
  2298                              <1> 	;and	ax, ax
  2299 00000EFD 7503                <1> 	jnz	short lff24s2_8
  2300 00000EFF E975FA              <1> 	jmp	lff24_eof
  2301                              <1> 
  2302                              <1> lff24s2_8:
  2303 00000F02 89C1                <1> 	mov	cx, ax	; dword count
  2304                              <1> lff24s2_1:
  2305 00000F04 AD                  <1> 	lodsw
  2306 00000F05 AB                  <1> 	stosw		; original sample (L)
  2307 00000F06 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format
  2308 00000F09 A3[DB19]            <1> 	mov	[previous_val_l], ax
  2309 00000F0C AD                  <1> 	lodsw
  2310 00000F0D AB                  <1> 	stosw		; original sample (R)
  2311 00000F0E 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format
  2312                              <1> 	;mov	[previous_val_r], ax
  2313 00000F11 89C3                <1> 	mov	bx, ax
  2314 00000F13 31D2                <1> 	xor	dx, dx
  2315 00000F15 31C0                <1> 	xor	ax, ax
  2316                              <1> 	; 16/11/2023
  2317 00000F17 49                  <1> 	dec	cx
  2318 00000F18 7405                <1> 	jz	short lff24s2_2
  2319 00000F1A 8B04                <1> 	mov	ax, [si]
  2320 00000F1C 8B5402              <1> 	mov	dx, [si+2]
  2321                              <1> lff24s2_2:
  2322 00000F1F 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format
  2323                              <1> 	;;mov	[next_val_l], ax
  2324                              <1> 	;mov	bp, ax
  2325 00000F22 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format
  2326                              <1> 	;mov	[next_val_r], dx
  2327 00000F25 0306[DB19]          <1> 	add	ax, [previous_val_l]
  2328 00000F29 D1D8                <1> 	rcr	ax, 1
  2329 00000F2B 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  2330 00000F2E AB                  <1> 	stosw		; this is interpolated sample (L)
  2331                              <1> 	;mov	ax, [next_val_r]
  2332 00000F2F 89D0                <1> 	mov	ax, dx
  2333                              <1> 	;add	ax, [previous_val_r]
  2334 00000F31 01D8                <1> 	add	ax, bx
  2335 00000F33 D1D8                <1> 	rcr	ax, 1
  2336 00000F35 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2337 00000F38 AB                  <1> 	stosw		; this is interpolated sample (R)
  2338                              <1> 	
  2339                              <1> 	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2340 00000F39 09C9                <1> 	or	cx, cx
  2341 00000F3B 75C7                <1> 	jnz	short lff24s2_1
  2342 00000F3D E924FA              <1> 	jmp	lff24_3
  2343                              <1> 
  2344                              <1> ; .....................
  2345                              <1> 
  2346                              <1> load_32khz_mono_8_bit:
  2347                              <1> 	; 15/11/2023
  2348 00000F40 F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2349                              <1> 					; last of the file?
  2350 00000F45 7402                <1> 	jz	short lff32m_0		; no
  2351 00000F47 F9                  <1> 	stc
  2352 00000F48 C3                  <1> 	retn
  2353                              <1> 
  2354                              <1> lff32m_0:
  2355 00000F49 8EC0                <1> 	mov	es, ax ; buffer segment
  2356 00000F4B 31FF                <1> 	xor	di, di
  2357 00000F4D BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2358                              <1> 	; ds = cs
  2359                              <1> 
  2360                              <1> 	; load file into memory
  2361 00000F50 8B0E[8706]          <1>         mov	cx, [loadsize]
  2362 00000F54 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  2363 00000F58 B43F                <1>        	mov	ah, 3Fh
  2364 00000F5A CD21                <1> 	int	21h
  2365 00000F5C 7237                <1> 	jc	short lff32m_7 ; error !
  2366                              <1> 
  2367 00000F5E 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2368                              <1> 	
  2369 00000F60 21C0                <1> 	and	ax, ax
  2370 00000F62 7503                <1> 	jnz	short lff32m_8
  2371 00000F64 E910FA              <1> 	jmp	lff32_eof
  2372                              <1> 
  2373                              <1> lff32m_8:
  2374 00000F67 89C1                <1> 	mov	cx, ax	; byte count
  2375                              <1> lff32m_1:
  2376 00000F69 AC                  <1> 	lodsb
  2377                              <1> 	;mov	[previous_val], al
  2378 00000F6A 88C3                <1> 	mov	bl, al
  2379 00000F6C 2C80                <1> 	sub	al, 80h
  2380 00000F6E C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2381 00000F71 AB                  <1> 	stosw		; original sample (left channel)
  2382 00000F72 AB                  <1> 	stosw		; original sample (right channel)
  2383                              <1> 	;xor	ax, ax
  2384 00000F73 B080                <1> 	mov	al, 80h
  2385 00000F75 49                  <1> 	dec	cx
  2386 00000F76 7402                <1> 	jz	short lff32m_2
  2387 00000F78 8A04                <1> 	mov	al, [si]
  2388                              <1> lff32m_2:
  2389                              <1> 	;;mov	[next_val], al
  2390                              <1> 	;mov	bh, al
  2391                              <1> 	;add	al, [previous_val]
  2392 00000F7A 00D8                <1> 	add	al, bl
  2393 00000F7C D0D8                <1> 	rcr	al, 1
  2394 00000F7E 2C80                <1> 	sub	al, 80h
  2395 00000F80 C1E008              <1> 	shl	ax, 8
  2396 00000F83 AB                  <1> 	stosw		; this is interpolated sample (L)
  2397 00000F84 AB                  <1> 	stosw		; this is interpolated sample (R)
  2398                              <1> 	
  2399                              <1> 	; different than 8-16-24 kHZ !
  2400                              <1> 	; 'original-interpolated-original' trio samples
  2401 00000F85 E30B                <1> 	jcxz	lff32m_3
  2402                              <1> 
  2403 00000F87 AC                  <1> 	lodsb
  2404 00000F88 2C80                <1> 	sub	al, 80h
  2405 00000F8A C1E008              <1> 	shl	ax, 8
  2406 00000F8D AB                  <1> 	stosw		; original sample (left channel)
  2407 00000F8E AB                  <1> 	stosw		; original sample (right channel)
  2408                              <1> 
  2409                              <1> 	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2410 00000F8F 49                  <1> 	dec	cx
  2411 00000F90 75D7                <1> 	jnz	short lff32m_1
  2412                              <1> lff32m_3:
  2413 00000F92 E9CFF9              <1> 	jmp	lff32_3
  2414                              <1> 
  2415                              <1> lff32m_7:
  2416                              <1> lff32s_7:
  2417 00000F95 E9E6F9              <1> 	jmp	lff32_5  ; error
  2418                              <1> 
  2419                              <1> load_32khz_stereo_8_bit:
  2420                              <1> 	; 15/11/2023
  2421 00000F98 F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2422                              <1> 					; last of the file?
  2423 00000F9D 7402                <1> 	jz	short lff32s_0		; no
  2424 00000F9F F9                  <1> 	stc
  2425 00000FA0 C3                  <1> 	retn
  2426                              <1> 
  2427                              <1> lff32s_0:
  2428 00000FA1 8EC0                <1> 	mov	es, ax ; buffer segment
  2429 00000FA3 31FF                <1> 	xor	di, di
  2430 00000FA5 BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2431                              <1> 	; ds = cs
  2432                              <1> 
  2433                              <1> 	; load file into memory
  2434 00000FA8 8B0E[8706]          <1>         mov	cx, [loadsize]
  2435 00000FAC 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  2436 00000FB0 B43F                <1>        	mov	ah, 3Fh
  2437 00000FB2 CD21                <1> 	int	21h
  2438 00000FB4 72DF                <1> 	jc	short lff32s_7 ; error !
  2439                              <1> 
  2440 00000FB6 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2441                              <1> 	
  2442 00000FB8 D1E8                <1> 	shr	ax, 1
  2443                              <1> 	;and	ax, ax
  2444 00000FBA 7503                <1> 	jnz	short lff32s_8
  2445 00000FBC E9B8F9              <1> 	jmp	lff32_eof
  2446                              <1> 
  2447                              <1> lff32s_8:
  2448 00000FBF 89C1                <1> 	mov	cx, ax	; word count
  2449                              <1> lff32s_1:
  2450 00000FC1 AC                  <1> 	lodsb
  2451 00000FC2 A2[DB19]            <1> 	mov	[previous_val_l], al
  2452 00000FC5 2C80                <1> 	sub	al, 80h
  2453 00000FC7 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2454 00000FCA AB                  <1> 	stosw		; original sample (L)
  2455 00000FCB AC                  <1> 	lodsb
  2456 00000FCC A2[DD19]            <1> 	mov	[previous_val_r], al
  2457 00000FCF 2C80                <1> 	sub	al, 80h
  2458 00000FD1 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2459 00000FD4 AB                  <1> 	stosw		; original sample (R)
  2460                              <1> 
  2461                              <1> 	;xor	ax, ax
  2462 00000FD5 B88080              <1> 	mov	ax, 8080h
  2463 00000FD8 49                  <1> 	dec	cx
  2464 00000FD9 7402                <1> 	jz	short lff32s_2
  2465                              <1> 		; convert 8 bit sample to 16 bit sample
  2466 00000FDB 8B04                <1> 	mov	ax, [si]
  2467                              <1> lff32s_2:
  2468                              <1> 	;;mov	[next_val_l], al
  2469                              <1> 	;;mov	[next_val_r], ah
  2470                              <1> 	;mov	bx, ax
  2471 00000FDD 88E7                <1> 	mov	bh, ah
  2472 00000FDF 0206[DB19]          <1> 	add	al, [previous_val_l]
  2473 00000FE3 D0D8                <1> 	rcr	al, 1
  2474                              <1> 	;mov	dl, al
  2475 00000FE5 2C80                <1> 	sub	al, 80h
  2476 00000FE7 C1E008              <1> 	shl	ax, 8
  2477 00000FEA AB                  <1> 	stosw		; this is interpolated sample (L)
  2478 00000FEB 88F8                <1> 	mov	al, bh	; [next_val_r]
  2479 00000FED 0206[DD19]          <1> 	add	al, [previous_val_r]
  2480 00000FF1 D0D8                <1> 	rcr	al, 1
  2481                              <1> 	;mov	dh, al
  2482 00000FF3 2C80                <1> 	sub	al, 80h
  2483 00000FF5 C1E008              <1> 	shl	ax, 8
  2484 00000FF8 AB                  <1> 	stosw		; this is interpolated sample (R)
  2485                              <1> 
  2486                              <1> 	; different than 8-16-24 kHZ !
  2487                              <1> 	; 'original-interpolated-original' trio samples 
  2488 00000FF9 E311                <1> 	jcxz	lff32s_3
  2489                              <1> 
  2490 00000FFB AC                  <1> 	lodsb
  2491 00000FFC 2C80                <1> 	sub	al, 80h
  2492 00000FFE C1E008              <1> 	shl	ax, 8
  2493 00001001 AB                  <1> 	stosw		; original sample (left channel)
  2494                              <1> 
  2495 00001002 AC                  <1> 	lodsb
  2496 00001003 2C80                <1> 	sub	al, 80h
  2497 00001005 C1E008              <1> 	shl	ax, 8
  2498 00001008 AB                  <1> 	stosw		; original sample (right channel)
  2499                              <1> 		
  2500                              <1> 	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2501 00001009 49                  <1> 	dec	cx
  2502 0000100A 75B5                <1> 	jnz	short lff32s_1
  2503                              <1> lff32s_3:
  2504 0000100C E955F9              <1> 	jmp	lff32_3
  2505                              <1> 
  2506                              <1> load_32khz_mono_16_bit:
  2507                              <1> 	; 15/11/2023
  2508 0000100F F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2509                              <1> 					; last of the file?
  2510 00001014 7402                <1> 	jz	short lff32m2_0		; no
  2511 00001016 F9                  <1> 	stc
  2512 00001017 C3                  <1> 	retn
  2513                              <1> 
  2514                              <1> lff32m2_0:
  2515 00001018 8EC0                <1> 	mov	es, ax ; buffer segment
  2516 0000101A 31FF                <1> 	xor	di, di
  2517 0000101C BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2518                              <1> 	; ds = cs
  2519                              <1> 
  2520                              <1> 	; load file into memory
  2521 0000101F 8B0E[8706]          <1>         mov	cx, [loadsize]
  2522 00001023 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  2523 00001027 B43F                <1>        	mov	ah, 3Fh
  2524 00001029 CD21                <1> 	int	21h
  2525 0000102B 722F                <1> 	jc	short lff32m2_7 ; error !
  2526                              <1> 
  2527 0000102D 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2528                              <1> 	
  2529 0000102F D1E8                <1> 	shr	ax, 1
  2530                              <1> 	;and	ax, ax
  2531 00001031 7503                <1> 	jnz	short lff32m2_8
  2532 00001033 E941F9              <1> 	jmp	lff32_eof
  2533                              <1> 
  2534                              <1> lff32m2_8:
  2535 00001036 89C1                <1> 	mov	cx, ax	; word count
  2536                              <1> lff32m2_1:
  2537 00001038 AD                  <1> 	lodsw
  2538 00001039 AB                  <1> 	stosw		; original sample (left channel)
  2539 0000103A AB                  <1> 	stosw		; original sample (right channel)
  2540 0000103B 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  2541                              <1> 	;mov	[previous_val], ax
  2542                              <1> 	;mov	bx, ax
  2543                              <1> 	;xor	ax, ax
  2544 0000103E 31DB                <1> 	xor	bx, bx
  2545 00001040 49                  <1> 	dec	cx
  2546 00001041 7402                <1> 	jz	short lff32m2_2
  2547                              <1> 	;mov	ax, [si
  2548 00001043 8B1C                <1> 	mov	bx, [si]
  2549                              <1> lff32m2_2:
  2550                              <1> 	; 04/02/2025
  2551 00001045 80C780              <1> 	add	bh, 80h ; convert sound level 0 to 65535 format
  2552                              <1> 	;add	ah, 80h
  2553                              <1> 	;mov	bp, ax	; [next_val]
  2554                              <1> 	;add	ax, [previous_val]
  2555                              <1> 	; ax = [previous_val]
  2556                              <1> 	; bx = [next_val]
  2557 00001048 01D8                <1> 	add	ax, bx
  2558 0000104A D1D8                <1> 	rcr	ax, 1
  2559 0000104C 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2560 0000104F AB                  <1> 	stosw		; this is interpolated sample (L)
  2561 00001050 AB                  <1> 	stosw		; this is interpolated sample (R)
  2562                              <1> 
  2563                              <1> 	; different than 8-16-24 kHZ !
  2564                              <1> 	; 'original-interpolated-original' trio samples
  2565 00001051 E306                <1> 	jcxz	lff32m2_3
  2566                              <1> 
  2567 00001053 AD                  <1> 	lodsw
  2568 00001054 AB                  <1> 	stosw		; original sample (left channel)
  2569 00001055 AB                  <1> 	stosw		; original sample (right channel)
  2570                              <1> 
  2571                              <1> 	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2572 00001056 49                  <1> 	dec	cx
  2573 00001057 75DF                <1> 	jnz	short lff32m2_1
  2574                              <1> lff32m2_3:
  2575 00001059 E908F9              <1> 	jmp	lff32_3
  2576                              <1> 
  2577                              <1> lff32m2_7:
  2578                              <1> lff32s2_7:
  2579 0000105C E91FF9              <1> 	jmp	lff32_5  ; error
  2580                              <1> 
  2581                              <1> load_32khz_stereo_16_bit:
  2582                              <1> 	 ;16/11/2023
  2583                              <1> 	; 15/11/2023
  2584 0000105F F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2585                              <1> 					; last of the file?
  2586 00001064 7402                <1> 	jz	short lff32s2_0		; no
  2587 00001066 F9                  <1> 	stc
  2588 00001067 C3                  <1> 	retn
  2589                              <1> 
  2590                              <1> lff32s2_0:
  2591 00001068 8EC0                <1> 	mov	es, ax ; buffer segment	
  2592 0000106A 31FF                <1> 	xor	di, di
  2593 0000106C BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2594                              <1> 	; ds = cs
  2595                              <1> 
  2596                              <1> 	; load file into memory
  2597 0000106F 8B0E[8706]          <1>         mov	cx, [loadsize]
  2598 00001073 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  2599 00001077 B43F                <1>        	mov	ah, 3Fh
  2600 00001079 CD21                <1> 	int	21h
  2601 0000107B 72DF                <1> 	jc	short lff32s2_7 ; error !
  2602                              <1> 
  2603 0000107D 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2604                              <1> 	
  2605 0000107F C1E802              <1> 	shr	ax, 2	; 16/11/2023 (word left ch + word right ch)
  2606                              <1> 	;and	ax, ax
  2607 00001082 7503                <1> 	jnz	short lff32s2_8
  2608 00001084 E9F0F8              <1> 	jmp	lff32_eof
  2609                              <1> 
  2610                              <1> lff32s2_8:
  2611 00001087 89C1                <1> 	mov	cx, ax	; dword count
  2612                              <1> lff32s2_1:
  2613 00001089 AD                  <1> 	lodsw
  2614 0000108A AB                  <1> 	stosw		; original sample (L)
  2615 0000108B 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format
  2616 0000108E A3[DB19]            <1> 	mov	[previous_val_l], ax
  2617 00001091 AD                  <1> 	lodsw
  2618 00001092 AB                  <1> 	stosw		; original sample (R)
  2619 00001093 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format
  2620                              <1> 	;mov	[previous_val_r], ax
  2621 00001096 89C3                <1> 	mov	bx, ax
  2622 00001098 31D2                <1> 	xor	dx, dx
  2623 0000109A 31C0                <1> 	xor	ax, ax
  2624                              <1> 	; 16/11/2023
  2625 0000109C 49                  <1> 	dec	cx
  2626 0000109D 7405                <1> 	jz	short lff32s2_2
  2627 0000109F 8B04                <1> 	mov	ax, [si]
  2628 000010A1 8B5402              <1> 	mov	dx, [si+2]
  2629                              <1> lff32s2_2:
  2630 000010A4 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format
  2631                              <1> 	;;mov	[next_val_l], ax
  2632                              <1> 	;mov	bp, ax
  2633 000010A7 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format
  2634                              <1> 	;mov	[next_val_r], dx
  2635 000010AA 0306[DB19]          <1> 	add	ax, [previous_val_l]
  2636 000010AE D1D8                <1> 	rcr	ax, 1
  2637 000010B0 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  2638 000010B3 AB                  <1> 	stosw		; this is interpolated sample (L)
  2639                              <1> 	;mov	ax, [next_val_r]
  2640 000010B4 89D0                <1> 	mov	ax, dx
  2641                              <1> 	;add	ax, [previous_val_r]
  2642 000010B6 01D8                <1> 	add	ax, bx
  2643 000010B8 D1D8                <1> 	rcr	ax, 1
  2644 000010BA 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2645 000010BD AB                  <1> 	stosw		; this is interpolated sample (R)
  2646                              <1> 
  2647                              <1> 	; different than 8-16-24 kHZ !
  2648                              <1> 	; 'original-interpolated-original' trio samples
  2649 000010BE E307                <1> 	jcxz	lff32s2_3
  2650                              <1> 
  2651 000010C0 AD                  <1> 	lodsw
  2652 000010C1 AB                  <1> 	stosw	; original sample (L)
  2653 000010C2 AD                  <1> 	lodsw
  2654 000010C3 AB                  <1> 	stosw	; original sample (R)
  2655                              <1> 	
  2656                              <1> 	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2657 000010C4 49                  <1> 	dec	cx
  2658 000010C5 75C2                <1> 	jnz	short lff32s2_1
  2659                              <1> lff32s2_3:
  2660 000010C7 E99AF8              <1> 	jmp	lff32_3
  2661                              <1> 
  2662                              <1> ; .....................
  2663                              <1> 
  2664                              <1> load_22khz_mono_8_bit:
  2665                              <1> 	; 16/11/2023
  2666 000010CA F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2667                              <1> 					; last of the file?
  2668 000010CF 7402                <1> 	jz	short lff22m_0		; no
  2669 000010D1 F9                  <1> 	stc
  2670 000010D2 C3                  <1> 	retn
  2671                              <1> 
  2672                              <1> lff22m_0:
  2673 000010D3 8EC0                <1> 	mov	es, ax ; buffer segment	
  2674 000010D5 31FF                <1> 	xor	di, di
  2675 000010D7 BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2676                              <1> 	; ds = cs
  2677                              <1> 
  2678                              <1> 	; load file into memory
  2679 000010DA 8B0E[8706]          <1>         mov	cx, [loadsize]
  2680 000010DE 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  2681 000010E2 B43F                <1>        	mov	ah, 3Fh
  2682 000010E4 CD21                <1> 	int	21h
  2683 000010E6 7248                <1> 	jc	short lff22m_7 ; error !
  2684                              <1> 
  2685 000010E8 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2686                              <1> 	
  2687 000010EA 21C0                <1> 	and	ax, ax
  2688 000010EC 7503                <1> 	jnz	short lff22m_8
  2689 000010EE E986F8              <1> 	jmp	lff22_eof
  2690                              <1> 
  2691                              <1> lff22m_8:
  2692 000010F1 89C1                <1> 	mov	cx, ax	; byte count
  2693                              <1> lff22m_9:
  2694 000010F3 BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2695 000010F6 C606[E319]03        <1> 	mov	byte [faz], 3  ; 3 steps/phases
  2696                              <1> lff22m_1:
  2697                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2698 000010FB AC                  <1> 	lodsb
  2699 000010FC B280                <1> 	mov	dl, 80h
  2700 000010FE 49                  <1> 	dec	cx
  2701 000010FF 7402                <1> 	jz	short lff22m_2_1
  2702 00001101 8A14                <1> 	mov	dl, [si]
  2703                              <1> lff22m_2_1:	
  2704                              <1> 	; al = [previous_val]
  2705                              <1> 	; dl = [next_val]
  2706 00001103 E8A004              <1> 	call	interpolating_3_8bit_mono ; 1 of 17
  2707 00001106 E325                <1> 	jcxz	lff22m_3
  2708                              <1> lff22m_2_2:
  2709 00001108 AC                  <1> 	lodsb
  2710 00001109 B280                <1> 	mov	dl, 80h
  2711 0000110B 49                  <1> 	dec	cx
  2712 0000110C 7402                <1> 	jz	short lff22m_2_3
  2713 0000110E 8A14                <1> 	mov	dl, [si]
  2714                              <1> lff22m_2_3:
  2715 00001110 E80805              <1>  	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  2716 00001113 E318                <1> 	jcxz	lff22m_3
  2717 00001115 4D                  <1> 	dec	bp
  2718 00001116 75F0                <1> 	jnz	short lff22m_2_2
  2719                              <1> 
  2720 00001118 A0[E319]            <1> 	mov	al, [faz]
  2721 0000111B FEC8                <1> 	dec	al
  2722 0000111D 74D4                <1> 	jz	short lff22m_9
  2723 0000111F FE0E[E319]          <1> 	dec	byte [faz]
  2724 00001123 BD0400              <1> 	mov	bp, 4
  2725 00001126 FEC8                <1> 	dec	al
  2726 00001128 75D1                <1> 	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  2727 0000112A 45                  <1> 	inc	bp ; 5
  2728 0000112B EBCE                <1> 	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2729                              <1> 
  2730                              <1> lff22m_3:
  2731                              <1> lff22s_3:
  2732 0000112D E934F8              <1> 	jmp	lff22_3	; padfill
  2733                              <1> 		; (put zeros in the remain words of the buffer)
  2734                              <1> lff22m_7:
  2735                              <1> lff22s_7:
  2736 00001130 E94BF8              <1> 	jmp	lff22_5  ; error
  2737                              <1> 
  2738                              <1> load_22khz_stereo_8_bit:
  2739                              <1> 	; 16/11/2023
  2740 00001133 F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2741                              <1> 					; last of the file?
  2742 00001138 7402                <1> 	jz	short lff22s_0		; no
  2743 0000113A F9                  <1> 	stc
  2744 0000113B C3                  <1> 	retn
  2745                              <1> 
  2746                              <1> lff22s_0:
  2747 0000113C 8EC0                <1> 	mov	es, ax ; buffer segment
  2748 0000113E 31FF                <1> 	xor	di, di
  2749 00001140 BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2750                              <1> 	; ds = cs
  2751                              <1> 
  2752                              <1> 	; load file into memory
  2753 00001143 8B0E[8706]          <1>         mov	cx, [loadsize]
  2754 00001147 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  2755 0000114B B43F                <1>        	mov	ah, 3Fh
  2756 0000114D CD21                <1> 	int	21h
  2757 0000114F 72DF                <1> 	jc	short lff22s_7 ; error !
  2758                              <1> 
  2759 00001151 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2760                              <1> 	
  2761 00001153 D1E8                <1> 	shr	ax, 1
  2762                              <1> 	;and	ax, ax
  2763 00001155 7503                <1> 	jnz	short lff22s_8
  2764 00001157 E91DF8              <1> 	jmp	lff22_eof
  2765                              <1> 
  2766                              <1> lff22s_8:
  2767 0000115A 89C1                <1> 	mov	cx, ax	; word count
  2768                              <1> lff22s_9:
  2769 0000115C BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2770 0000115F C606[E319]03        <1> 	mov	byte [faz], 3  ; 3 steps/phase
  2771                              <1> lff22s_1:
  2772                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2773 00001164 AD                  <1> 	lodsw
  2774 00001165 BA8080              <1> 	mov	dx, 8080h
  2775 00001168 49                  <1> 	dec	cx
  2776 00001169 7402                <1> 	jz	short lff22s_2_1
  2777 0000116B 8B14                <1> 	mov	dx, [si]
  2778                              <1> lff22s_2_1:	
  2779                              <1> 	; al = [previous_val_l]
  2780                              <1> 	; ah = [previous_val_r]
  2781                              <1> 	; dl = [next_val_l]
  2782                              <1> 	; dl = [next_val_r]
  2783 0000116D E86004              <1> 	call	interpolating_3_8bit_stereo ; 1 of 17 
  2784 00001170 E3BB                <1> 	jcxz	lff22s_3
  2785                              <1> lff22s_2_2:
  2786 00001172 AD                  <1> 	lodsw
  2787 00001173 BA8080              <1> 	mov	dx, 8080h
  2788 00001176 49                  <1> 	dec	cx
  2789 00001177 7402                <1> 	jz	short lff22s_2_3
  2790 00001179 8B14                <1> 	mov	dx, [si]
  2791                              <1> lff22s_2_3:
  2792 0000117B E8B404              <1>  	call	interpolating_2_8bit_stereo ; 2 of 17 .. 6 of 17
  2793 0000117E E3AD                <1> 	jcxz	lff22s_3
  2794 00001180 4D                  <1> 	dec	bp
  2795 00001181 75EF                <1> 	jnz	short lff22s_2_2
  2796                              <1> 
  2797 00001183 A0[E319]            <1> 	mov	al, [faz]
  2798 00001186 FEC8                <1> 	dec	al
  2799 00001188 74D2                <1> 	jz	short lff22s_9
  2800 0000118A FE0E[E319]          <1> 	dec	byte [faz]
  2801 0000118E BD0400              <1> 	mov	bp, 4
  2802 00001191 FEC8                <1> 	dec	al
  2803 00001193 75CF                <1> 	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  2804 00001195 45                  <1> 	inc	bp ; 5
  2805 00001196 EBCC                <1> 	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2806                              <1> 
  2807                              <1> load_22khz_mono_16_bit:
  2808                              <1> 	; 16/11/2023
  2809 00001198 F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2810                              <1> 					; last of the file?
  2811 0000119D 7402                <1> 	jz	short lff22m2_0		; no
  2812 0000119F F9                  <1> 	stc
  2813 000011A0 C3                  <1> 	retn
  2814                              <1> 
  2815                              <1> lff22m2_0:
  2816 000011A1 8EC0                <1> 	mov	es, ax ; buffer segment
  2817 000011A3 31FF                <1> 	xor	di, di
  2818 000011A5 BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2819                              <1> 	; ds = cs
  2820                              <1> 
  2821                              <1> 	; load file into memory
  2822 000011A8 8B0E[8706]          <1>         mov	cx, [loadsize]
  2823 000011AC 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  2824 000011B0 B43F                <1>        	mov	ah, 3Fh
  2825 000011B2 CD21                <1> 	int	21h
  2826 000011B4 7248                <1> 	jc	short lff22m2_7 ; error !
  2827                              <1> 
  2828 000011B6 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2829                              <1> 	
  2830 000011B8 D1E8                <1> 	shr	ax, 1
  2831                              <1> 	;and	ax, ax
  2832 000011BA 7503                <1> 	jnz	short lff22m2_8
  2833 000011BC E9B8F7              <1> 	jmp	lff22_eof
  2834                              <1> 
  2835                              <1> lff22m2_8:
  2836 000011BF 89C1                <1> 	mov	cx, ax	; word count
  2837                              <1> lff22m2_9:
  2838 000011C1 BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2839 000011C4 C606[E319]03        <1> 	mov	byte [faz], 3  ; 3 steps/phases
  2840                              <1> lff22m2_1:
  2841                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2842 000011C9 AD                  <1> 	lodsw
  2843 000011CA 31D2                <1> 	xor	dx, dx
  2844 000011CC 49                  <1> 	dec	cx
  2845 000011CD 7402                <1> 	jz	short lff22m2_2_1
  2846 000011CF 8B14                <1> 	mov	dx, [si]
  2847                              <1> lff22m2_2_1:	
  2848                              <1> 	; ax = [previous_val]
  2849                              <1> 	; dx = [next_val]
  2850 000011D1 E88704              <1> 	call	interpolating_3_16bit_mono ; 1 of 17
  2851 000011D4 E325                <1> 	jcxz	lff22m2_3
  2852                              <1> lff22m2_2_2:
  2853 000011D6 AD                  <1> 	lodsw
  2854 000011D7 31D2                <1> 	xor	dx, dx
  2855 000011D9 49                  <1> 	dec	cx
  2856 000011DA 7402                <1> 	jz	short lff22m2_2_3
  2857 000011DC 8B14                <1> 	mov	dx, [si]
  2858                              <1> lff22m2_2_3:
  2859 000011DE E8E704              <1>  	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  2860 000011E1 E318                <1> 	jcxz	lff22m2_3
  2861 000011E3 4D                  <1> 	dec	bp
  2862 000011E4 75F0                <1> 	jnz	short lff22m2_2_2
  2863                              <1> 
  2864 000011E6 A0[E319]            <1> 	mov	al, [faz]
  2865 000011E9 FEC8                <1> 	dec	al
  2866 000011EB 74D4                <1> 	jz	short lff22m2_9
  2867 000011ED FE0E[E319]          <1> 	dec	byte [faz]
  2868 000011F1 BD0400              <1> 	mov	bp, 4
  2869 000011F4 FEC8                <1> 	dec	al
  2870 000011F6 75D1                <1> 	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2871 000011F8 45                  <1> 	inc	bp ; 5
  2872 000011F9 EBCE                <1> 	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2873                              <1> 
  2874                              <1> lff22m2_3:
  2875                              <1> lff22s2_3:
  2876 000011FB E966F7              <1> 	jmp	lff22_3	; padfill
  2877                              <1> 		; (put zeros in the remain words of the buffer)
  2878                              <1> lff22m2_7:
  2879                              <1> lff22s2_7:
  2880 000011FE E97DF7              <1> 	jmp	lff22_5  ; error
  2881                              <1> 
  2882                              <1> load_22khz_stereo_16_bit:
  2883                              <1> 	; 16/11/2023
  2884 00001201 F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2885                              <1> 					; last of the file?
  2886 00001206 7402                <1> 	jz	short lff22s2_0		; no
  2887 00001208 F9                  <1> 	stc
  2888 00001209 C3                  <1> 	retn
  2889                              <1> 
  2890                              <1> lff22s2_0:
  2891 0000120A 8EC0                <1> 	mov	es, ax ; buffer segment
  2892 0000120C 31FF                <1> 	xor	di, di
  2893 0000120E BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2894                              <1> 	; ds = cs
  2895                              <1> 
  2896                              <1> 	; load file into memory
  2897 00001211 8B0E[8706]          <1>         mov	cx, [loadsize]
  2898 00001215 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  2899 00001219 B43F                <1>        	mov	ah, 3Fh
  2900 0000121B CD21                <1> 	int	21h
  2901 0000121D 72DF                <1> 	jc	short lff22s2_7 ; error !
  2902                              <1> 
  2903 0000121F 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2904                              <1> 	
  2905 00001221 C1E802              <1> 	shr	ax, 2	; dword (left chan word + right chan word)
  2906                              <1> 	;and	ax, ax
  2907 00001224 7503                <1> 	jnz	short lff22s2_8
  2908 00001226 E94EF7              <1> 	jmp	lff22_eof
  2909                              <1> 
  2910                              <1> lff22s2_8:
  2911 00001229 89C1                <1> 	mov	cx, ax	; dword count
  2912                              <1> lff22s2_9:
  2913 0000122B BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2914 0000122E C606[E319]03        <1> 	mov	byte [faz], 3  ; 3 steps/phase
  2915                              <1> lff22s2_1:
  2916                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2917 00001233 AD                  <1> 	lodsw
  2918 00001234 89C3                <1> 	mov	bx, ax
  2919 00001236 AD                  <1> 	lodsw
  2920 00001237 8B14                <1> 	mov	dx, [si]
  2921 00001239 8916[DF19]          <1> 	mov	[next_val_l], dx
  2922 0000123D 8B5402              <1> 	mov	dx, [si+2]
  2923 00001240 49                  <1> 	dec	cx
  2924 00001241 7506                <1> 	jnz	short lff22s2_2_1
  2925 00001243 31D2                <1> 	xor	dx, dx ; 0
  2926 00001245 8916[DF19]          <1> 	mov	[next_val_l], dx
  2927                              <1> lff22s2_2_1:
  2928                              <1> 	; bx = [previous_val_l]
  2929                              <1> 	; ax = [previous_val_r]
  2930                              <1> 	; [next_val_l]
  2931                              <1> 	; dx = [next_val_r]
  2932 00001249 E83304              <1> 	call	interpolating_3_16bit_stereo ; 1 of 17 
  2933 0000124C E3AD                <1> 	jcxz	lff22s2_3
  2934                              <1> lff22s2_2_2:
  2935 0000124E AD                  <1> 	lodsw
  2936 0000124F 89C3                <1> 	mov	bx, ax
  2937 00001251 AD                  <1> 	lodsw
  2938 00001252 8B14                <1> 	mov	dx, [si]
  2939 00001254 8916[DF19]          <1> 	mov	[next_val_l], dx
  2940 00001258 8B5402              <1> 	mov	dx, [si+2]
  2941 0000125B 49                  <1> 	dec	cx
  2942 0000125C 7506                <1> 	jnz	short lff22s2_2_3
  2943 0000125E 31D2                <1> 	xor	dx, dx ; 0
  2944 00001260 8916[DF19]          <1> 	mov	[next_val_l], dx
  2945                              <1> lff22s2_2_3:
  2946 00001264 E87304              <1>  	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  2947 00001267 E392                <1> 	jcxz	lff22s2_3
  2948 00001269 4D                  <1> 	dec	bp
  2949 0000126A 75E2                <1> 	jnz	short lff22s2_2_2
  2950                              <1> 
  2951 0000126C A0[E319]            <1> 	mov	al, [faz]
  2952 0000126F FEC8                <1> 	dec	al
  2953 00001271 74B8                <1> 	jz	short lff22s2_9
  2954 00001273 FE0E[E319]          <1> 	dec	byte [faz]
  2955 00001277 BD0400              <1> 	mov	bp, 4
  2956 0000127A FEC8                <1> 	dec	al
  2957 0000127C 75B5                <1> 	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2958 0000127E 45                  <1> 	inc	bp ; 5
  2959 0000127F EBB2                <1> 	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2960                              <1> 
  2961                              <1> ; .....................
  2962                              <1> 
  2963                              <1> load_11khz_mono_8_bit:
  2964                              <1> 	; 18/11/2023
  2965 00001281 F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2966                              <1> 					; last of the file?
  2967 00001286 7402                <1> 	jz	short lff11m_0		; no
  2968 00001288 F9                  <1> 	stc
  2969 00001289 C3                  <1> 	retn
  2970                              <1> 
  2971                              <1> lff11m_0:
  2972 0000128A 8EC0                <1> 	mov	es, ax ; buffer segment
  2973 0000128C 31FF                <1> 	xor	di, di
  2974 0000128E BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2975                              <1> 	; ds = cs
  2976                              <1> 
  2977                              <1> 	; load file into memory
  2978 00001291 8B0E[8706]          <1>         mov	cx, [loadsize]
  2979 00001295 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  2980 00001299 B43F                <1>        	mov	ah, 3Fh
  2981 0000129B CD21                <1> 	int	21h
  2982 0000129D 723D                <1> 	jc	short lff11m_7 ; error !
  2983                              <1> 
  2984 0000129F 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2985                              <1> 	
  2986 000012A1 21C0                <1> 	and	ax, ax
  2987 000012A3 7503                <1> 	jnz	short lff11m_8
  2988 000012A5 E9CFF6              <1> 	jmp	lff11_eof
  2989                              <1> 
  2990                              <1> lff11m_8:
  2991 000012A8 89C1                <1> 	mov	cx, ax	; byte count
  2992                              <1> lff11m_9:
  2993 000012AA BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  2994                              <1> lff11m_1:
  2995                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  2996 000012AD AC                  <1> 	lodsb
  2997 000012AE B280                <1> 	mov	dl, 80h
  2998 000012B0 49                  <1> 	dec	cx
  2999 000012B1 7402                <1> 	jz	short lff11m_2_1
  3000 000012B3 8A14                <1> 	mov	dl, [si]
  3001                              <1> lff11m_2_1:	
  3002                              <1> 	; al = [previous_val]
  3003                              <1> 	; dl = [next_val]
  3004 000012B5 E84804              <1> 	call	interpolating_5_8bit_mono
  3005 000012B8 E31F                <1> 	jcxz	lff11m_3
  3006                              <1> lff11m_2_2:
  3007 000012BA AC                  <1> 	lodsb
  3008 000012BB B280                <1> 	mov	dl, 80h
  3009 000012BD 49                  <1> 	dec	cx
  3010 000012BE 7402                <1> 	jz	short lff11m_2_3
  3011 000012C0 8A14                <1> 	mov	dl, [si]
  3012                              <1> lff11m_2_3:
  3013 000012C2 E82405              <1>  	call	interpolating_4_8bit_mono
  3014 000012C5 E312                <1> 	jcxz	lff11m_3
  3015                              <1> 
  3016 000012C7 4D                  <1> 	dec	bp
  3017 000012C8 74E0                <1> 	jz	short lff11m_9
  3018                              <1> 
  3019 000012CA AC                  <1> 	lodsb
  3020 000012CB B280                <1> 	mov	dl, 80h
  3021 000012CD 49                  <1> 	dec	cx
  3022 000012CE 7402                <1> 	jz	short lff11m_2_4
  3023 000012D0 8A14                <1> 	mov	dl, [si]
  3024                              <1> lff11m_2_4:
  3025 000012D2 E81405              <1> 	call	interpolating_4_8bit_mono
  3026 000012D5 E302                <1> 	jcxz	lff11m_3
  3027 000012D7 EBD4                <1> 	jmp	short lff11m_1
  3028                              <1> 
  3029                              <1> lff11m_3:
  3030                              <1> lff11s_3:
  3031 000012D9 E988F6              <1> 	jmp	lff11_3	; padfill
  3032                              <1> 		; (put zeros in the remain words of the buffer)
  3033                              <1> lff11m_7:
  3034                              <1> lff11s_7:
  3035 000012DC E99FF6              <1> 	jmp	lff11_5  ; error
  3036                              <1> 
  3037                              <1> load_11khz_stereo_8_bit:
  3038                              <1> 	; 18/11/2023
  3039 000012DF F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3040                              <1> 					; last of the file?
  3041 000012E4 7402                <1> 	jz	short lff11s_0		; no
  3042 000012E6 F9                  <1> 	stc
  3043 000012E7 C3                  <1> 	retn
  3044                              <1> 
  3045                              <1> lff11s_0:
  3046 000012E8 8EC0                <1> 	mov	es, ax ; buffer segment
  3047 000012EA 31FF                <1> 	xor	di, di
  3048 000012EC BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3049                              <1> 	; ds = cs
  3050                              <1> 
  3051                              <1> 	; load file into memory
  3052 000012EF 8B0E[8706]          <1>         mov	cx, [loadsize]
  3053 000012F3 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  3054 000012F7 B43F                <1>        	mov	ah, 3Fh
  3055 000012F9 CD21                <1> 	int	21h
  3056 000012FB 72DF                <1> 	jc	short lff11s_7 ; error !
  3057                              <1> 
  3058 000012FD 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3059                              <1> 	
  3060 000012FF D1E8                <1> 	shr	ax, 1
  3061                              <1> 	;and	ax, ax
  3062 00001301 7503                <1> 	jnz	short lff11s_8
  3063 00001303 E971F6              <1> 	jmp	lff11_eof
  3064                              <1> 
  3065                              <1> lff11s_8:
  3066 00001306 89C1                <1> 	mov	cx, ax	; word count
  3067                              <1> lff11s_9:
  3068 00001308 BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  3069                              <1> lff11s_1:
  3070                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3071 0000130B AD                  <1> 	lodsw
  3072 0000130C BA8080              <1> 	mov	dx, 8080h
  3073 0000130F 49                  <1> 	dec	cx
  3074 00001310 7402                <1> 	jz	short lff11s_2_1 
  3075 00001312 8B14                <1> 	mov	dx, [si]
  3076                              <1> lff11s_2_1:	
  3077                              <1> 	; al = [previous_val_l]
  3078                              <1> 	; ah = [previous_val_r]
  3079                              <1> 	; dl = [next_val_l]
  3080                              <1> 	; dl = [next_val_r]
  3081 00001314 E83904              <1> 	call	interpolating_5_8bit_stereo
  3082 00001317 E3C0                <1> 	jcxz	lff11s_3
  3083                              <1> lff11s_2_2:
  3084 00001319 AD                  <1> 	lodsw
  3085 0000131A BA8080              <1> 	mov	dx, 8080h
  3086 0000131D 49                  <1> 	dec	cx
  3087 0000131E 7402                <1> 	jz	short lff11s_2_3
  3088 00001320 8B14                <1> 	mov	dx, [si]
  3089                              <1> lff11s_2_3:
  3090 00001322 E8F704              <1>  	call	interpolating_4_8bit_stereo
  3091 00001325 E3B2                <1> 	jcxz	lff11s_3
  3092                              <1> 	
  3093 00001327 4D                  <1> 	dec	bp
  3094 00001328 74DE                <1> 	jz	short lff11s_9
  3095                              <1> 
  3096 0000132A AD                  <1> 	lodsw
  3097 0000132B BA8080              <1> 	mov	dx, 8080h
  3098 0000132E 49                  <1> 	dec	cx
  3099 0000132F 7402                <1> 	jz	short lff11s_2_4
  3100 00001331 8B14                <1> 	mov	dx, [si]
  3101                              <1> lff11s_2_4:
  3102 00001333 E8E604              <1> 	call	interpolating_4_8bit_stereo
  3103 00001336 E3A1                <1> 	jcxz	lff11s_3
  3104 00001338 EBD1                <1> 	jmp	short lff11s_1
  3105                              <1> 
  3106                              <1> load_11khz_mono_16_bit:
  3107                              <1> 	; 18/11/2023
  3108 0000133A F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3109                              <1> 					; last of the file?
  3110 0000133F 7402                <1> 	jz	short lff11m2_0		; no
  3111 00001341 F9                  <1> 	stc
  3112 00001342 C3                  <1> 	retn
  3113                              <1> 
  3114                              <1> lff11m2_0:
  3115 00001343 8EC0                <1> 	mov	es, ax ; buffer segment
  3116 00001345 31FF                <1> 	xor	di, di
  3117 00001347 BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3118                              <1> 	; ds = cs
  3119                              <1> 
  3120                              <1> 	; load file into memory
  3121 0000134A 8B0E[8706]          <1>         mov	cx, [loadsize]
  3122 0000134E 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  3123 00001352 B43F                <1>        	mov	ah, 3Fh
  3124 00001354 CD21                <1> 	int	21h
  3125 00001356 723A                <1> 	jc	short lff11m2_7 ; error !
  3126                              <1> 
  3127 00001358 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3128                              <1> 	
  3129 0000135A D1E8                <1> 	shr	ax, 1
  3130                              <1> 	;and	ax, ax
  3131 0000135C 7503                <1> 	jnz	short lff11m2_8
  3132 0000135E E916F6              <1> 	jmp	lff11_eof
  3133                              <1> 
  3134                              <1> lff11m2_8:
  3135 00001361 89C1                <1> 	mov	cx, ax	; word count
  3136                              <1> lff11m2_9:
  3137 00001363 BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  3138                              <1> lff11m2_1:
  3139                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3140 00001366 AD                  <1> 	lodsw
  3141 00001367 31D2                <1> 	xor	dx, dx
  3142 00001369 49                  <1> 	dec	cx
  3143 0000136A 7402                <1> 	jz	short lff11m2_2_1
  3144 0000136C 8B14                <1> 	mov	dx, [si]
  3145                              <1> lff11m2_2_1:	
  3146                              <1> 	; ax = [previous_val]
  3147                              <1> 	; dx = [next_val]
  3148 0000136E E80805              <1> 	call	interpolating_5_16bit_mono
  3149 00001371 E34A                <1> 	jcxz	lff11m2_3
  3150                              <1> lff11m2_2_2:
  3151 00001373 AD                  <1> 	lodsw
  3152 00001374 31D2                <1> 	xor	dx, dx
  3153 00001376 49                  <1> 	dec	cx
  3154 00001377 7402                <1> 	jz	short lff11m2_2_3
  3155 00001379 8B14                <1> 	mov	dx, [si]
  3156                              <1> lff11m2_2_3:
  3157 0000137B E8D605              <1>  	call	interpolating_4_16bit_mono
  3158 0000137E E33D                <1> 	jcxz	lff11m2_3
  3159                              <1> 
  3160 00001380 4D                  <1> 	dec	bp
  3161 00001381 74E0                <1> 	jz	short lff11m2_9
  3162                              <1> 
  3163 00001383 AD                  <1> 	lodsw
  3164 00001384 31D2                <1> 	xor	dx, dx
  3165 00001386 49                  <1> 	dec	cx
  3166 00001387 7402                <1> 	jz	short lff11m2_2_4
  3167 00001389 8B14                <1> 	mov	dx, [si]
  3168                              <1> lff11m2_2_4:
  3169 0000138B E8C605              <1>  	call	interpolating_4_16bit_mono
  3170 0000138E E32D                <1> 	jcxz	lff11m2_3
  3171 00001390 EBD4                <1> 	jmp	short lff11m2_1
  3172                              <1> 
  3173                              <1> lff11m2_7:
  3174                              <1> lff11s2_7:
  3175 00001392 E9E9F5              <1> 	jmp	lff11_5  ; error
  3176                              <1> 
  3177                              <1> load_11khz_stereo_16_bit:
  3178                              <1> 	; 18/11/2023
  3179 00001395 F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3180                              <1> 					; last of the file?
  3181 0000139A 7402                <1> 	jz	short lff11s2_0		; no
  3182 0000139C F9                  <1> 	stc
  3183 0000139D C3                  <1> 	retn
  3184                              <1> 
  3185                              <1> lff11s2_0:
  3186 0000139E 8EC0                <1> 	mov	es, ax ; buffer segment	
  3187 000013A0 31FF                <1> 	xor	di, di
  3188 000013A2 BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3189                              <1> 	; ds = cs
  3190                              <1> 
  3191                              <1> 	; load file into memory
  3192 000013A5 8B0E[8706]          <1>         mov	cx, [loadsize]
  3193 000013A9 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  3194 000013AD B43F                <1>        	mov	ah, 3Fh
  3195 000013AF CD21                <1> 	int	21h
  3196 000013B1 72DF                <1> 	jc	short lff11s2_7 ; error !
  3197                              <1> 
  3198 000013B3 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3199                              <1> 	
  3200 000013B5 C1E802              <1> 	shr	ax, 2	; dword (left chan word + right chan word)
  3201                              <1> 	;and	ax, ax
  3202 000013B8 7506                <1> 	jnz	short lff11s2_8
  3203 000013BA E9BAF5              <1> 	jmp	lff11_eof
  3204                              <1> 
  3205                              <1> lff11m2_3:
  3206                              <1> lff11s2_3:
  3207 000013BD E9A4F5              <1> 	jmp	lff11_3	; padfill
  3208                              <1> 		; (put zeros in the remain words of the buffer)
  3209                              <1> 
  3210                              <1> lff11s2_8:
  3211 000013C0 89C1                <1> 	mov	cx, ax	; dword count
  3212                              <1> lff11s2_9:
  3213 000013C2 BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  3214                              <1> lff11s2_1:
  3215                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3216 000013C5 AD                  <1> 	lodsw
  3217 000013C6 89C3                <1> 	mov	bx, ax
  3218 000013C8 AD                  <1> 	lodsw
  3219 000013C9 8B14                <1> 	mov	dx, [si]
  3220 000013CB 8916[DF19]          <1> 	mov	[next_val_l], dx
  3221 000013CF 8B5402              <1> 	mov	dx, [si+2]
  3222 000013D2 8916[E119]          <1> 	mov	[next_val_r], dx
  3223 000013D6 49                  <1> 	dec	cx
  3224 000013D7 750A                <1> 	jnz	short lff11s2_2_1
  3225 000013D9 31D2                <1> 	xor	dx, dx ; 0
  3226 000013DB 8916[DF19]          <1> 	mov	[next_val_l], dx
  3227 000013DF 8916[E119]          <1> 	mov	[next_val_r], dx
  3228                              <1> lff11s2_2_1:
  3229                              <1> 	; bx = [previous_val_l]
  3230                              <1> 	; ax = [previous_val_r]
  3231                              <1> 	; [next_val_l]
  3232                              <1> 	; dx = [next_val_r]
  3233 000013E3 E8D604              <1> 	call	interpolating_5_16bit_stereo
  3234 000013E6 E3D5                <1> 	jcxz	lff11s2_3
  3235                              <1> lff11s2_2_2:
  3236 000013E8 AD                  <1> 	lodsw
  3237 000013E9 89C3                <1> 	mov	bx, ax
  3238 000013EB AD                  <1> 	lodsw
  3239 000013EC 8B14                <1> 	mov	dx, [si]
  3240 000013EE 8916[DF19]          <1> 	mov	[next_val_l], dx
  3241 000013F2 8B5402              <1> 	mov	dx, [si+2]
  3242 000013F5 8916[E119]          <1> 	mov	[next_val_r], dx
  3243 000013F9 49                  <1> 	dec	cx
  3244 000013FA 750A                <1> 	jnz	short lff11s2_2_3
  3245 000013FC 31D2                <1> 	xor	dx, dx ; 0
  3246 000013FE 8916[DF19]          <1> 	mov	[next_val_l], dx
  3247 00001402 8916[E119]          <1> 	mov	[next_val_r], dx
  3248                              <1> lff11s2_2_3:
  3249 00001406 E87605              <1>  	call	interpolating_4_16bit_stereo
  3250 00001409 E3B2                <1> 	jcxz	lff11s2_3
  3251                              <1> 	
  3252 0000140B 4D                  <1> 	dec	bp
  3253 0000140C 74B4                <1> 	jz	short lff11s2_9
  3254                              <1> 
  3255 0000140E AD                  <1> 	lodsw
  3256 0000140F 89C3                <1> 	mov	bx, ax
  3257 00001411 AD                  <1> 	lodsw
  3258 00001412 8B14                <1> 	mov	dx, [si]
  3259 00001414 8916[DF19]          <1> 	mov	[next_val_l], dx
  3260 00001418 8B5402              <1> 	mov	dx, [si+2]
  3261 0000141B 8916[E119]          <1> 	mov	[next_val_r], dx
  3262 0000141F 49                  <1> 	dec	cx
  3263 00001420 750A                <1> 	jnz	short lff11s2_2_4
  3264 00001422 31D2                <1> 	xor	dx, dx ; 0
  3265 00001424 8916[DF19]          <1> 	mov	[next_val_l], dx
  3266 00001428 8916[E119]          <1> 	mov	[next_val_r], dx
  3267                              <1> lff11s2_2_4:
  3268 0000142C E85005              <1>  	call	interpolating_4_16bit_stereo
  3269 0000142F E38C                <1> 	jcxz	lff11s2_3
  3270 00001431 EB92                <1> 	jmp	short lff11s2_1
  3271                              <1> 
  3272                              <1> ; .....................
  3273                              <1> 
  3274                              <1> load_44khz_mono_8_bit:
  3275                              <1> 	; 18/11/2023
  3276 00001433 F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3277                              <1> 					; last of the file?
  3278 00001438 7402                <1> 	jz	short lff44m_0		; no
  3279 0000143A F9                  <1> 	stc
  3280 0000143B C3                  <1> 	retn
  3281                              <1> 
  3282                              <1> lff44m_0:
  3283 0000143C 8EC0                <1> 	mov	es, ax ; buffer segment
  3284 0000143E 31FF                <1> 	xor	di, di
  3285 00001440 BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3286                              <1> 	; ds = cs
  3287                              <1> 
  3288                              <1> 	; load file into memory
  3289 00001443 8B0E[8706]          <1>         mov	cx, [loadsize]
  3290 00001447 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  3291 0000144B B43F                <1>        	mov	ah, 3Fh
  3292 0000144D CD21                <1> 	int	21h
  3293 0000144F 723C                <1> 	jc	short lff44m_7 ; error !
  3294                              <1> 
  3295 00001451 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3296                              <1> 	
  3297 00001453 21C0                <1> 	and	ax, ax
  3298 00001455 7503                <1> 	jnz	short lff44m_8
  3299 00001457 E91DF5              <1> 	jmp	lff44_eof
  3300                              <1> 
  3301                              <1> lff44m_8:
  3302 0000145A 89C1                <1> 	mov	cx, ax	; byte count
  3303                              <1> lff44m_9:
  3304 0000145C BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3305 0000145F C606[E319]02        <1> 	mov	byte [faz], 2  ; 2 steps/phases
  3306                              <1> lff44m_1:
  3307                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3308                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3309 00001464 AC                  <1> 	lodsb
  3310 00001465 B280                <1> 	mov	dl, 80h
  3311 00001467 49                  <1> 	dec	cx
  3312 00001468 7402                <1> 	jz	short lff44m_2_1
  3313 0000146A 8A14                <1> 	mov	dl, [si]
  3314                              <1> lff44m_2_1:	
  3315                              <1> 	; al = [previous_val]
  3316                              <1> 	; dl = [next_val]
  3317 0000146C E8AC01              <1> 	call	interpolating_2_8bit_mono
  3318 0000146F E319                <1> 	jcxz	lff44m_3
  3319                              <1> lff44m_2_2:
  3320 00001471 AC                  <1> 	lodsb
  3321 00001472 2C80                <1> 	sub	al, 80h
  3322 00001474 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3323 00001477 AB                  <1> 	stosw		; (L)
  3324 00001478 AB                  <1> 	stosw		; (R)
  3325                              <1> 
  3326 00001479 49                  <1> 	dec	cx
  3327 0000147A 740E                <1> 	jz	short lff44m_3
  3328 0000147C 4D                  <1> 	dec	bp
  3329 0000147D 75F2                <1> 	jnz	short lff44m_2_2
  3330                              <1> 	
  3331 0000147F FE0E[E319]          <1> 	dec	byte [faz]
  3332 00001483 74D7                <1> 	jz	short lff44m_9 
  3333 00001485 BD0B00              <1> 	mov	bp, 11
  3334 00001488 EBDA                <1> 	jmp	short lff44m_1
  3335                              <1> 
  3336                              <1> lff44m_3:
  3337                              <1> lff44s_3:
  3338 0000148A E9D7F4              <1> 	jmp	lff44_3	; padfill
  3339                              <1> 		; (put zeros in the remain words of the buffer)
  3340                              <1> lff44m_7:
  3341                              <1> lff44s_7:
  3342 0000148D E9EEF4              <1> 	jmp	lff44_5  ; error
  3343                              <1> 
  3344                              <1> load_44khz_stereo_8_bit:
  3345                              <1> 	; 16/11/2023
  3346 00001490 F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3347                              <1> 					; last of the file?
  3348 00001495 7402                <1> 	jz	short lff44s_0		; no
  3349 00001497 F9                  <1> 	stc
  3350 00001498 C3                  <1> 	retn
  3351                              <1> 
  3352                              <1> lff44s_0:
  3353 00001499 8EC0                <1> 	mov	es, ax ; buffer segment
  3354 0000149B 31FF                <1> 	xor	di, di
  3355 0000149D BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3356                              <1> 	; ds = cs
  3357                              <1> 
  3358                              <1> 	; load file into memory
  3359 000014A0 8B0E[8706]          <1>         mov	cx, [loadsize]
  3360 000014A4 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  3361 000014A8 B43F                <1>        	mov	ah, 3Fh
  3362 000014AA CD21                <1> 	int	21h
  3363 000014AC 72DF                <1> 	jc	short lff44s_7 ; error !
  3364                              <1> 
  3365 000014AE 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3366                              <1> 	
  3367 000014B0 D1E8                <1> 	shr	ax, 1
  3368                              <1> 	;and	ax, ax
  3369 000014B2 7503                <1> 	jnz	short lff44s_8
  3370 000014B4 E9C0F4              <1> 	jmp	lff44_eof
  3371                              <1> 
  3372                              <1> lff44s_8:
  3373 000014B7 89C1                <1> 	mov	cx, ax	; word count
  3374                              <1> lff44s_9:
  3375 000014B9 BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3376 000014BC C606[E319]02        <1> 	mov	byte [faz], 2  ; 2 steps/phase
  3377                              <1> lff44s_1:
  3378                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3379                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3380 000014C1 AD                  <1> 	lodsw
  3381 000014C2 BA8080              <1> 	mov	dx, 8080h
  3382 000014C5 49                  <1> 	dec	cx
  3383 000014C6 7402                <1> 	jz	short lff44s_2_1 
  3384 000014C8 8B14                <1> 	mov	dx, [si]
  3385                              <1> lff44s_2_1:	
  3386                              <1> 	; al = [previous_val_l]
  3387                              <1> 	; ah = [previous_val_r]
  3388                              <1> 	; dl = [next_val_l]
  3389                              <1> 	; dl = [next_val_r]	
  3390 000014CA E86501              <1> 	call	interpolating_2_8bit_stereo
  3391 000014CD E3BB                <1> 	jcxz	lff44s_3
  3392                              <1> lff44s_2_2:
  3393 000014CF AC                  <1> 	lodsb
  3394 000014D0 2C80                <1> 	sub	al, 80h
  3395 000014D2 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3396 000014D5 AB                  <1> 	stosw		; (L)
  3397 000014D6 AC                  <1> 	lodsb
  3398 000014D7 2C80                <1> 	sub	al, 80h
  3399 000014D9 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3400 000014DC AB                  <1> 	stosw		; (R)
  3401                              <1> 
  3402 000014DD 49                  <1> 	dec	cx
  3403 000014DE 74AA                <1> 	jz	short lff44s_3
  3404 000014E0 4D                  <1> 	dec	bp
  3405 000014E1 75EC                <1> 	jnz	short lff44s_2_2
  3406                              <1> 	
  3407 000014E3 FE0E[E319]          <1> 	dec	byte [faz]
  3408 000014E7 74D0                <1> 	jz	short lff44s_9
  3409 000014E9 BD0B00              <1> 	mov	bp, 11
  3410 000014EC EBD3                <1> 	jmp	short lff44s_1
  3411                              <1> 
  3412                              <1> load_44khz_mono_16_bit:
  3413                              <1> 	; 18/11/2023
  3414 000014EE F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3415                              <1> 					; last of the file?
  3416 000014F3 7402                <1> 	jz	short lff44m2_0		; no
  3417 000014F5 F9                  <1> 	stc
  3418 000014F6 C3                  <1> 	retn
  3419                              <1> 
  3420                              <1> lff44m2_0:
  3421 000014F7 8EC0                <1> 	mov	es, ax ; buffer segment
  3422 000014F9 31FF                <1> 	xor	di, di
  3423 000014FB BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3424                              <1> 	; ds = cs
  3425                              <1> 
  3426                              <1> 	; load file into memory
  3427 000014FE 8B0E[8706]          <1>         mov	cx, [loadsize]
  3428 00001502 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  3429 00001506 B43F                <1>        	mov	ah, 3Fh
  3430 00001508 CD21                <1> 	int	21h
  3431 0000150A 7237                <1> 	jc	short lff44m2_7 ; error !
  3432                              <1> 
  3433 0000150C 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3434                              <1> 	
  3435 0000150E D1E8                <1> 	shr	ax, 1
  3436                              <1> 	;and	ax, ax
  3437 00001510 7503                <1> 	jnz	short lff44m2_8
  3438 00001512 E962F4              <1> 	jmp	lff44_eof
  3439                              <1> 
  3440                              <1> lff44m2_8:
  3441 00001515 89C1                <1> 	mov	cx, ax	; word count
  3442                              <1> lff44m2_9:
  3443 00001517 BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3444 0000151A C606[E319]02        <1> 	mov	byte [faz], 2  ; 2 steps/phases
  3445                              <1> lff44m2_1:
  3446                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3447                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3448 0000151F AD                  <1> 	lodsw
  3449 00001520 31D2                <1> 	xor	dx, dx
  3450 00001522 49                  <1> 	dec	cx
  3451 00001523 7402                <1> 	jz	short lff44m2_2_1
  3452 00001525 8B14                <1> 	mov	dx, [si]
  3453                              <1> lff44m2_2_1:	
  3454                              <1> 	; ax = [previous_val]
  3455                              <1> 	; dx = [next_val]
  3456 00001527 E89E01              <1> 	call	interpolating_2_16bit_mono
  3457 0000152A E314                <1> 	jcxz	lff44m2_3
  3458                              <1> lff44m2_2_2:
  3459 0000152C AD                  <1> 	lodsw
  3460 0000152D AB                  <1> 	stosw		; (L)eft Channel
  3461 0000152E AB                  <1> 	stosw		; (R)ight Channel
  3462                              <1> 
  3463 0000152F 49                  <1> 	dec	cx
  3464 00001530 740E                <1> 	jz	short lff44m2_3	
  3465 00001532 4D                  <1> 	dec	bp
  3466 00001533 75F7                <1> 	jnz	short lff44m2_2_2
  3467                              <1> 	
  3468 00001535 FE0E[E319]          <1> 	dec	byte [faz]
  3469 00001539 74DC                <1> 	jz	short lff44m2_9 
  3470 0000153B BD0B00              <1> 	mov	bp, 11
  3471 0000153E EBDF                <1> 	jmp	short lff44m2_1
  3472                              <1> 
  3473                              <1> lff44m2_3:
  3474                              <1> lff44s2_3:
  3475 00001540 E921F4              <1> 	jmp	lff44_3	; padfill
  3476                              <1> 		; (put zeros in the remain words of the buffer)
  3477                              <1> lff44m2_7:
  3478                              <1> lff44s2_7:
  3479 00001543 E938F4              <1> 	jmp	lff44_5  ; error
  3480                              <1> 
  3481                              <1> load_44khz_stereo_16_bit:
  3482                              <1> 	; 18/11/2023
  3483 00001546 F606[101E]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3484                              <1> 					; last of the file?
  3485 0000154B 7402                <1> 	jz	short lff44s2_0		; no
  3486 0000154D F9                  <1> 	stc
  3487 0000154E C3                  <1> 	retn
  3488                              <1> 
  3489                              <1> lff44s2_0:
  3490 0000154F 8EC0                <1> 	mov	es, ax ; buffer segment
  3491 00001551 31FF                <1> 	xor	di, di
  3492 00001553 BA[361E]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3493                              <1> 	; ds = cs
  3494                              <1> 
  3495                              <1> 	; load file into memory
  3496 00001556 8B0E[8706]          <1>         mov	cx, [loadsize]
  3497 0000155A 8B1E[0E1E]          <1> 	mov	bx, [filehandle]
  3498 0000155E B43F                <1>        	mov	ah, 3Fh
  3499 00001560 CD21                <1> 	int	21h
  3500 00001562 72DF                <1> 	jc	short lff44s2_7 ; error !
  3501                              <1> 
  3502 00001564 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3503                              <1> 	
  3504 00001566 C1E802              <1> 	shr	ax, 2	; dword (left chan word + right chan word)
  3505                              <1> 	;and	ax, ax
  3506 00001569 7503                <1> 	jnz	short lff44s2_8
  3507 0000156B E909F4              <1> 	jmp	lff44_eof
  3508                              <1> 
  3509                              <1> lff44s2_8:
  3510 0000156E 89C1                <1> 	mov	cx, ax	; dword count
  3511                              <1> lff44s2_9:
  3512 00001570 BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3513 00001573 C606[E319]02        <1> 	mov	byte [faz], 2  ; 2 steps/phase
  3514                              <1> lff44s2_1:
  3515                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3516                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3517 00001578 AD                  <1> 	lodsw
  3518 00001579 89C3                <1> 	mov	bx, ax
  3519 0000157B AD                  <1> 	lodsw
  3520 0000157C 8B14                <1> 	mov	dx, [si]
  3521 0000157E 8916[DF19]          <1> 	mov	[next_val_l], dx
  3522 00001582 8B5402              <1> 	mov	dx, [si+2]
  3523 00001585 49                  <1> 	dec	cx
  3524 00001586 7506                <1> 	jnz	short lff44s2_2_1
  3525 00001588 31D2                <1> 	xor	dx, dx ; 0
  3526 0000158A 8916[DF19]          <1> 	mov	[next_val_l], dx
  3527                              <1> lff44s2_2_1:
  3528                              <1> 	; bx = [previous_val_l]
  3529                              <1> 	; ax = [previous_val_r]
  3530                              <1> 	; [next_val_l]
  3531                              <1> 	; dx = [next_val_r]
  3532 0000158E E84901              <1> 	call	interpolating_2_16bit_stereo
  3533 00001591 E3AD                <1> 	jcxz	lff44s2_3
  3534                              <1> lff44s2_2_2:
  3535                              <1> 	;lodsw
  3536                              <1> 	;stosw		; (L)
  3537                              <1> 	;lodsw
  3538                              <1> 	;stosw		; (R)
  3539 00001593 A5                  <1> 	movsw		; (L)eft Channel
  3540 00001594 A5                  <1> 	movsw		; (R)ight Channel
  3541                              <1> 
  3542 00001595 49                  <1> 	dec	cx
  3543 00001596 74A8                <1> 	jz	short lff44s2_3
  3544 00001598 4D                  <1> 	dec	bp
  3545 00001599 75F8                <1> 	jnz	short lff44s2_2_2
  3546                              <1> 	
  3547 0000159B FE0E[E319]          <1> 	dec	byte [faz]
  3548 0000159F 74CF                <1> 	jz	short lff44s2_9
  3549 000015A1 BD0B00              <1> 	mov	bp, 11
  3550 000015A4 EBD2                <1> 	jmp	short lff44s2_1
  3551                              <1> 
  3552                              <1> ; .....................
  3553                              <1> 
  3554                              <1> interpolating_3_8bit_mono:
  3555                              <1> 	; 04/02/2025
  3556                              <1> 	; 16/11/2023
  3557                              <1> 	; al = [previous_val]
  3558                              <1> 	; dl = [next_val]
  3559                              <1> 	; original-interpolated-interpolated
  3560 000015A6 88C3                <1> 	mov	bl, al
  3561 000015A8 2C80                <1> 	sub	al, 80h
  3562 000015AA C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3563 000015AD AB                  <1> 	stosw		; original sample (L)
  3564 000015AE AB                  <1> 	stosw		; original sample (R)
  3565 000015AF 88D8                <1> 	mov	al, bl
  3566 000015B1 00D0                <1> 	add	al, dl
  3567 000015B3 D0D8                <1> 	rcr	al, 1
  3568 000015B5 88C7                <1> 	mov	bh, al	; interpolated middle (temporary)
  3569 000015B7 00D8                <1> 	add	al, bl
  3570 000015B9 D0D8                <1> 	rcr	al, 1
  3571 000015BB 2C80                <1> 	sub	al, 80h
  3572 000015BD C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3573 000015C0 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3574 000015C1 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3575 000015C2 88F8                <1> 	mov	al, bh
  3576 000015C4 00D0                <1> 	add	al, dl	; [next_val]
  3577 000015C6 D0D8                <1> 	rcr	al, 1
  3578                              <1> 	; 04/02/2025
  3579 000015C8 2C80                <1> 	sub	al, 80h
  3580 000015CA C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3581 000015CD AB                  <1> 	stosw		; interpolated sample 2 (L)
  3582 000015CE AB                  <1> 	stosw		; interpolated sample 2 (R)
  3583 000015CF C3                  <1> 	retn
  3584                              <1> 
  3585                              <1> interpolating_3_8bit_stereo:
  3586                              <1> 	; 04/02/2025
  3587                              <1> 	; 16/11/2023
  3588                              <1> 	; al = [previous_val_l]
  3589                              <1> 	; ah = [previous_val_r]
  3590                              <1> 	; dl = [next_val_l]
  3591                              <1> 	; dh = [next_val_r]
  3592                              <1> 	; original-interpolated-interpolated
  3593 000015D0 89C3                <1> 	mov	bx, ax
  3594 000015D2 2C80                <1> 	sub	al, 80h
  3595 000015D4 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3596 000015D7 AB                  <1> 	stosw		; original sample (L)
  3597 000015D8 88F8                <1> 	mov	al, bh
  3598 000015DA 2C80                <1> 	sub	al, 80h
  3599 000015DC C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3600 000015DF AB                  <1> 	stosw		; original sample (R)
  3601 000015E0 88D8                <1> 	mov	al, bl
  3602 000015E2 00D0                <1> 	add	al, dl	; [next_val_l]
  3603 000015E4 D0D8                <1> 	rcr	al, 1
  3604 000015E6 50                  <1> 	push	ax ; *	; al = interpolated middle (L) (temporary)
  3605 000015E7 00D8                <1> 	add	al, bl	; [previous_val_l]
  3606 000015E9 D0D8                <1> 	rcr	al, 1
  3607 000015EB 2C80                <1> 	sub	al, 80h
  3608 000015ED C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3609 000015F0 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3610 000015F1 88F8                <1> 	mov	al, bh
  3611 000015F3 00F0                <1> 	add	al, dh	; [next_val_r]
  3612 000015F5 D0D8                <1> 	rcr	al, 1
  3613 000015F7 50                  <1> 	push	ax ; ** ; al = interpolated middle (R) (temporary)
  3614 000015F8 00F8                <1> 	add	al, bh	; [previous_val_r]
  3615 000015FA D0D8                <1> 	rcr	al, 1
  3616 000015FC 2C80                <1> 	sub	al, 80h
  3617 000015FE C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3618 00001601 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3619 00001602 5B                  <1> 	pop	bx ; **
  3620 00001603 58                  <1> 	pop	ax ; *
  3621 00001604 00D0                <1> 	add	al, dl	; [next_val_l]
  3622 00001606 D0D8                <1> 	rcr	al, 1
  3623                              <1> 	; 04/02/2025
  3624 00001608 2C80                <1> 	sub	al, 80h
  3625 0000160A C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3626 0000160D AB                  <1> 	stosw		; interpolated sample 2 (L)
  3627 0000160E 88D8                <1> 	mov	al, bl
  3628 00001610 00F0                <1> 	add	al, dh	; [next_val_r]
  3629 00001612 D0D8                <1> 	rcr	al, 1
  3630                              <1> 	; 04/02/2025
  3631 00001614 2C80                <1> 	sub	al, 80h
  3632 00001616 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3633 00001619 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3634 0000161A C3                  <1> 	retn
  3635                              <1> 
  3636                              <1> interpolating_2_8bit_mono:
  3637                              <1> 	; 16/11/2023
  3638                              <1> 	; al = [previous_val]
  3639                              <1> 	; dl = [next_val]
  3640                              <1> 	; original-interpolated
  3641 0000161B 88C3                <1> 	mov	bl, al
  3642 0000161D 2C80                <1> 	sub	al, 80h
  3643 0000161F C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3644 00001622 AB                  <1> 	stosw		; original sample (L)
  3645 00001623 AB                  <1> 	stosw		; original sample (R)
  3646 00001624 88D8                <1> 	mov	al, bl
  3647 00001626 00D0                <1> 	add	al, dl
  3648 00001628 D0D8                <1> 	rcr	al, 1
  3649 0000162A 2C80                <1> 	sub	al, 80h
  3650 0000162C C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3651 0000162F AB                  <1> 	stosw		; interpolated sample (L)
  3652 00001630 AB                  <1> 	stosw		; interpolated sample (R)
  3653 00001631 C3                  <1> 	retn
  3654                              <1> 
  3655                              <1> interpolating_2_8bit_stereo:
  3656                              <1> 	; 16/11/2023
  3657                              <1> 	; al = [previous_val_l]
  3658                              <1> 	; ah = [previous_val_r]
  3659                              <1> 	; dl = [next_val_l]
  3660                              <1> 	; dh = [next_val_r]
  3661                              <1> 	; original-interpolated
  3662 00001632 89C3                <1> 	mov	bx, ax
  3663 00001634 2C80                <1> 	sub	al, 80h
  3664 00001636 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3665 00001639 AB                  <1> 	stosw		; original sample (L)
  3666 0000163A 88F8                <1> 	mov	al, bh
  3667 0000163C 2C80                <1> 	sub	al, 80h
  3668 0000163E C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3669 00001641 AB                  <1> 	stosw		; original sample (R)
  3670 00001642 88D8                <1> 	mov	al, bl	; [previous_val_l]
  3671 00001644 00D0                <1> 	add	al, dl	; [next_val_l]	
  3672 00001646 D0D8                <1> 	rcr	al, 1
  3673 00001648 2C80                <1> 	sub	al, 80h
  3674 0000164A C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3675 0000164D AB                  <1> 	stosw		; interpolated sample (L)
  3676 0000164E 88F8                <1> 	mov	al, bh
  3677 00001650 00F0                <1> 	add	al, dh	; [next_val_r]
  3678 00001652 D0D8                <1> 	rcr	al, 1
  3679 00001654 2C80                <1> 	sub	al, 80h
  3680 00001656 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3681 00001659 AB                  <1> 	stosw		; interpolated sample (R)
  3682 0000165A C3                  <1> 	retn
  3683                              <1> 
  3684                              <1> interpolating_3_16bit_mono:
  3685                              <1> 	; 16/11/2023
  3686                              <1> 	; ax = [previous_val]
  3687                              <1> 	; dx = [next_val]
  3688                              <1> 	; original-interpolated-interpolated
  3689                              <1> 
  3690 0000165B AB                  <1> 	stosw		; original sample (L)
  3691 0000165C AB                  <1> 	stosw		; original sample (R)
  3692 0000165D 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3693 00001660 50                  <1> 	push	ax ; *	; [previous_val]
  3694 00001661 80C680              <1> 	add	dh, 80h
  3695 00001664 01D0                <1> 	add	ax, dx
  3696 00001666 D1D8                <1> 	rcr	ax, 1
  3697 00001668 5B                  <1> 	pop	bx ; *
  3698 00001669 93                  <1> 	xchg	bx, ax	; bx  = interpolated middle (temporary)
  3699 0000166A 01D8                <1> 	add	ax, bx	; [previous_val] + interpolated middle
  3700 0000166C D1D8                <1> 	rcr	ax, 1
  3701 0000166E 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3702 00001671 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3703 00001672 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3704 00001673 89D8                <1> 	mov	ax, bx
  3705 00001675 01D0                <1> 	add	ax, dx	 ;interpolated middle + [next_val]
  3706 00001677 D1D8                <1> 	rcr	ax, 1
  3707 00001679 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3708 0000167C AB                  <1> 	stosw		; interpolated sample 2 (L)
  3709 0000167D AB                  <1> 	stosw		; interpolated sample 2 (R)
  3710 0000167E C3                  <1> 	retn
  3711                              <1> 
  3712                              <1> interpolating_3_16bit_stereo:
  3713                              <1> 	; 16/11/2023
  3714                              <1> 	; bx = [previous_val_l]
  3715                              <1> 	; ax = [previous_val_r]
  3716                              <1> 	; [next_val_l]
  3717                              <1> 	; dx = [next_val_r]
  3718                              <1> 	; original-interpolated-interpolated
  3719                              <1> 
  3720 0000167F 93                  <1> 	xchg	ax, bx
  3721 00001680 AB                  <1> 	stosw		; original sample (L)
  3722 00001681 93                  <1> 	xchg	ax, bx
  3723 00001682 AB                  <1> 	stosw		; original sample (R)
  3724 00001683 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3725 00001686 50                  <1> 	push	ax ; *	; [previous_val_r]
  3726 00001687 80C780              <1> 	add	bh, 80h
  3727 0000168A 8006[E019]80        <1> 	add	byte [next_val_l+1], 80h
  3728 0000168F A1[DF19]            <1> 	mov	ax, [next_val_l]
  3729 00001692 01D8                <1> 	add	ax, bx	; [previous_val_l]
  3730 00001694 D1D8                <1> 	rcr	ax, 1
  3731 00001696 93                  <1> 	xchg	ax, bx	; ax = [previous_val_l]	
  3732 00001697 01D8                <1> 	add	ax, bx	; bx = interpolated middle (L)
  3733 00001699 D1D8                <1> 	rcr	ax, 1
  3734 0000169B 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3735 0000169E AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3736 0000169F 58                  <1> 	pop	ax  ; *
  3737 000016A0 80C680              <1> 	add	dh, 80h ; convert sound level 0 to 65535 format
  3738 000016A3 52                  <1> 	push	dx  ; * ; [next_val_r]
  3739 000016A4 92                  <1> 	xchg	ax, dx
  3740 000016A5 01D0                <1> 	add	ax, dx	; [next_val_r] + [previous_val_r]
  3741 000016A7 D1D8                <1> 	rcr	ax, 1	; / 2
  3742 000016A9 50                  <1> 	push	ax ; ** ; interpolated middle (R)
  3743 000016AA 01D0                <1> 	add	ax, dx	; + [previous_val_r]
  3744 000016AC D1D8                <1> 	rcr	ax, 1
  3745 000016AE 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3746 000016B1 AB                  <1> 	stosw 		; interpolated sample 1 (R)
  3747 000016B2 A1[DF19]            <1> 	mov	ax, [next_val_l]
  3748 000016B5 01D8                <1> 	add	ax, bx	; + interpolated middle (L)
  3749 000016B7 D1D8                <1> 	rcr	ax, 1
  3750 000016B9 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3751 000016BC AB                  <1> 	stosw 		; interpolated sample 2 (L)
  3752 000016BD 58                  <1> 	pop	ax ; **
  3753 000016BE 5A                  <1> 	pop	dx ; *
  3754 000016BF 01D0                <1> 	add	ax, dx	; interpolated middle + [next_val_r]
  3755 000016C1 D1D8                <1> 	rcr	ax, 1	; / 2
  3756 000016C3 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3757 000016C6 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  3758 000016C7 C3                  <1> 	retn
  3759                              <1> 
  3760                              <1> interpolating_2_16bit_mono:
  3761                              <1> 	; 16/11/2023
  3762                              <1> 	; ax = [previous_val]
  3763                              <1> 	; dx = [next_val]
  3764                              <1> 	; original-interpolated
  3765                              <1> 
  3766 000016C8 AB                  <1> 	stosw		; original sample (L)
  3767 000016C9 AB                  <1> 	stosw		; original sample (R)
  3768 000016CA 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3769 000016CD 80C680              <1> 	add	dh, 80h
  3770 000016D0 01D0                <1> 	add	ax, dx
  3771 000016D2 D1D8                <1> 	rcr	ax, 1
  3772 000016D4 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3773 000016D7 AB                  <1> 	stosw		; interpolated sample (L)
  3774 000016D8 AB                  <1> 	stosw		; interpolated sample (R)
  3775 000016D9 C3                  <1> 	retn
  3776                              <1> 
  3777                              <1> interpolating_2_16bit_stereo:
  3778                              <1> 	; 16/11/2023
  3779                              <1> 	; bx = [previous_val_l]
  3780                              <1> 	; ax = [previous_val_r]
  3781                              <1> 	; [next_val_l]
  3782                              <1> 	; dx = [next_val_r]
  3783                              <1> 	; original-interpolated
  3784                              <1> 
  3785 000016DA 93                  <1> 	xchg	ax, bx
  3786 000016DB AB                  <1> 	stosw		; original sample (L)
  3787 000016DC 93                  <1> 	xchg	ax, bx
  3788 000016DD AB                  <1> 	stosw		; original sample (R)
  3789 000016DE 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3790 000016E1 80C680              <1> 	add	dh, 80h
  3791 000016E4 01D0                <1> 	add	ax, dx	; [previous_val_r] + [next_val_r]
  3792 000016E6 D1D8                <1> 	rcr	ax, 1	; / 2
  3793 000016E8 50                  <1> 	push	ax ; *	; interpolated sample (R)
  3794 000016E9 A1[DF19]            <1> 	mov	ax, [next_val_l]
  3795 000016EC 80C480              <1> 	add	ah, 80h
  3796 000016EF 80C780              <1> 	add	bh, 80h
  3797 000016F2 01D8                <1> 	add	ax, bx	; [next_val_l] + [previous_val_l]
  3798 000016F4 D1D8                <1> 	rcr	ax, 1	; / 2		
  3799 000016F6 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3800 000016F9 AB                  <1> 	stosw 		; interpolated sample (L)
  3801 000016FA 58                  <1> 	pop	ax ; *	
  3802 000016FB 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3803 000016FE AB                  <1> 	stosw 		; interpolated sample (R)
  3804 000016FF C3                  <1> 	retn
  3805                              <1> 
  3806                              <1> interpolating_5_8bit_mono:
  3807                              <1> 	; 17/11/2023
  3808                              <1> 	; al = [previous_val]
  3809                              <1> 	; dl = [next_val]
  3810                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  3811 00001700 88C3                <1> 	mov	bl, al
  3812 00001702 2C80                <1> 	sub	al, 80h
  3813 00001704 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3814 00001707 AB                  <1> 	stosw		; original sample (L)
  3815 00001708 AB                  <1> 	stosw		; original sample (R)
  3816 00001709 88D8                <1> 	mov	al, bl
  3817 0000170B 00D0                <1> 	add	al, dl
  3818 0000170D D0D8                <1> 	rcr	al, 1
  3819 0000170F 88C7                <1> 	mov	bh, al	; interpolated middle (temporary)
  3820 00001711 00D8                <1> 	add	al, bl  ; [previous_val]
  3821 00001713 D0D8                <1> 	rcr	al, 1	
  3822 00001715 88C6                <1> 	mov	dh, al	; interpolated 1st quarter (temporary)
  3823 00001717 00D8                <1> 	add	al, bl
  3824 00001719 D0D8                <1> 	rcr	al, 1
  3825 0000171B 2C80                <1> 	sub	al, 80h
  3826 0000171D C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3827 00001720 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3828 00001721 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3829 00001722 88F8                <1> 	mov	al, bh
  3830 00001724 00F0                <1> 	add	al, dh
  3831 00001726 D0D8                <1> 	rcr	al, 1
  3832 00001728 2C80                <1> 	sub	al, 80h
  3833 0000172A C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3834 0000172D AB                  <1> 	stosw		; interpolated sample 2 (L)
  3835 0000172E AB                  <1> 	stosw		; interpolated sample 2 (R)
  3836 0000172F 88F8                <1> 	mov	al, bh
  3837 00001731 00D0                <1> 	add	al, dl	; [next_val]
  3838 00001733 D0D8                <1> 	rcr	al, 1
  3839 00001735 88C6                <1> 	mov	dh, al	; interpolated 3rd quarter (temporary)
  3840 00001737 00F8                <1> 	add	al, bh
  3841 00001739 D0D8                <1> 	rcr	al, 1
  3842 0000173B 2C80                <1> 	sub	al, 80h
  3843 0000173D C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3844 00001740 AB                  <1> 	stosw		; interpolated sample 3 (L)
  3845 00001741 AB                  <1> 	stosw		; interpolated sample 3 (R)
  3846 00001742 88F0                <1> 	mov	al, dh
  3847 00001744 00D0                <1> 	add	al, dl
  3848 00001746 D0D8                <1> 	rcr	al, 1
  3849 00001748 2C80                <1> 	sub	al, 80h
  3850 0000174A C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3851 0000174D AB                  <1> 	stosw		; interpolated sample 4 (L)
  3852 0000174E AB                  <1> 	stosw		; interpolated sample 4 (R)
  3853 0000174F C3                  <1> 	retn
  3854                              <1> 
  3855                              <1> interpolating_5_8bit_stereo:
  3856                              <1> 	; 17/11/2023
  3857                              <1> 	; al = [previous_val_l]
  3858                              <1> 	; ah = [previous_val_r]
  3859                              <1> 	; dl = [next_val_l]
  3860                              <1> 	; dh = [next_val_r]
  3861                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  3862 00001750 89C3                <1> 	mov	bx, ax
  3863 00001752 2C80                <1> 	sub	al, 80h
  3864 00001754 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3865 00001757 AB                  <1> 	stosw		; original sample (L)
  3866 00001758 88F8                <1> 	mov	al, bh
  3867 0000175A 2C80                <1> 	sub	al, 80h
  3868 0000175C C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3869 0000175F AB                  <1> 	stosw		; original sample (R)
  3870 00001760 52                  <1> 	push	dx ; *
  3871 00001761 88D8                <1> 	mov	al, bl
  3872 00001763 00D0                <1> 	add	al, dl	; [next_val_l]
  3873 00001765 D0D8                <1> 	rcr	al, 1
  3874 00001767 50                  <1> 	push	ax ; **	; al = interpolated middle (L) (temporary)
  3875 00001768 00D8                <1> 	add	al, bl	; [previous_val_l]
  3876 0000176A D0D8                <1> 	rcr	al, 1
  3877 0000176C 86D8                <1> 	xchg	al, bl
  3878 0000176E 00D8                <1> 	add	al, bl	; bl = interpolated 1st quarter (L) (temp)
  3879 00001770 D0D8                <1> 	rcr	al, 1
  3880 00001772 2C80                <1> 	sub	al, 80h
  3881 00001774 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3882 00001777 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3883 00001778 88F8                <1> 	mov	al, bh
  3884 0000177A 00F0                <1> 	add	al, dh	; [next_val_r]
  3885 0000177C D0D8                <1> 	rcr	al, 1
  3886 0000177E 50                  <1> 	push	ax ; *** ; al = interpolated middle (R) (temporary)
  3887 0000177F 00F8                <1> 	add	al, bh	; [previous_val_r]
  3888 00001781 D0D8                <1> 	rcr	al, 1
  3889 00001783 86F8                <1> 	xchg	al, bh
  3890 00001785 00F8                <1> 	add	al, bh	; bh = interpolated 1st quarter (R) (temp)
  3891 00001787 D0D8                <1> 	rcr	al, 1
  3892 00001789 2C80                <1> 	sub	al, 80h
  3893 0000178B C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3894 0000178E AB                  <1> 	stosw		; interpolated sample 1 (R)
  3895 0000178F 5A                  <1> 	pop	dx ; ***
  3896 00001790 58                  <1> 	pop	ax ; **	; al = interpolated middle (L) (temporary)
  3897 00001791 86D8                <1> 	xchg	al, bl	; al = interpolated 1st quarter (L) (temp)
  3898 00001793 00D8                <1> 	add	al, bl	; bl = interpolated middle (L) (temporary)
  3899 00001795 D0D8                <1> 	rcr	al, 1
  3900 00001797 2C80                <1> 	sub	al, 80h
  3901 00001799 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3902 0000179C AB                  <1> 	stosw		; interpolated sample 2 (L)	
  3903 0000179D 88D0                <1> 	mov	al, dl 	; interpolated middle (R) (temporary)
  3904 0000179F 86F8                <1> 	xchg	al, bh	; al = interpolated 1st quarter (R) (temp)
  3905 000017A1 00F8                <1> 	add	al, bh	; bh = interpolated middle (R) (temporary)
  3906 000017A3 D0D8                <1> 	rcr	al, 1
  3907 000017A5 2C80                <1> 	sub	al, 80h
  3908 000017A7 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3909 000017AA AB                  <1> 	stosw		; interpolated sample 2 (R)
  3910 000017AB 5A                  <1> 	pop	dx ; *
  3911 000017AC 88D8                <1> 	mov	al, bl	; interpolated middle (L) (temporary)
  3912 000017AE 00D0                <1> 	add	al, dl	; [next_val_l]
  3913 000017B0 D0D8                <1> 	rcr	al, 1
  3914 000017B2 86D8                <1> 	xchg	al, bl	; al = interpolated middle (R) (temporary)
  3915 000017B4 00D8                <1> 	add	al, bl	; bl = interpolated 3rd quarter (L) (temp)
  3916 000017B6 D0D8                <1> 	rcr	al, 1
  3917 000017B8 2C80                <1> 	sub	al, 80h
  3918 000017BA C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3919 000017BD AB                  <1> 	stosw		; interpolated sample 3 (L)
  3920 000017BE 88F8                <1> 	mov	al, bh	
  3921 000017C0 00F0                <1> 	add	al, dh	; interpolated middle (R) + [next_val_r]
  3922 000017C2 D0D8                <1> 	rcr	al, 1
  3923 000017C4 86F8                <1> 	xchg	al, bh	; al = interpolated middle (R)
  3924 000017C6 00F8                <1> 	add	al, bh	; bh = interpolated 3rd quarter (R) (temp)
  3925 000017C8 D0D8                <1> 	rcr	al, 1
  3926 000017CA 2C80                <1> 	sub	al, 80h
  3927 000017CC C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3928 000017CF AB                  <1> 	stosw		; interpolated sample 3 (R)
  3929 000017D0 88D8                <1> 	mov	al, bl
  3930 000017D2 00D0                <1> 	add	al, dl	; [next_val_l]
  3931 000017D4 D0D8                <1> 	rcr	al, 1
  3932 000017D6 2C80                <1> 	sub	al, 80h
  3933 000017D8 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3934 000017DB AB                  <1> 	stosw		; interpolated sample 4 (L)
  3935 000017DC 88F8                <1> 	mov	al, bh
  3936 000017DE 00F0                <1> 	add	al, dh	; [next_val_r]
  3937 000017E0 D0D8                <1> 	rcr	al, 1
  3938 000017E2 2C80                <1> 	sub	al, 80h
  3939 000017E4 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3940 000017E7 AB                  <1> 	stosw		; interpolated sample 4 (R)
  3941 000017E8 C3                  <1> 	retn
  3942                              <1> 
  3943                              <1> interpolating_4_8bit_mono:
  3944                              <1> 	; 17/11/2023
  3945                              <1> 	; al = [previous_val]
  3946                              <1> 	; dl = [next_val]
  3947                              <1> 	; original-interpolated-interpolated-interpolated
  3948 000017E9 88C3                <1> 	mov	bl, al
  3949 000017EB 2C80                <1> 	sub	al, 80h
  3950 000017ED C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3951 000017F0 AB                  <1> 	stosw		; original sample (L)
  3952 000017F1 AB                  <1> 	stosw		; original sample (R)
  3953 000017F2 88D8                <1> 	mov	al, bl
  3954 000017F4 00D0                <1> 	add	al, dl	
  3955 000017F6 D0D8                <1> 	rcr	al, 1
  3956 000017F8 86D8                <1> 	xchg	al, bl  ; al = [previous_val]
  3957 000017FA 00D8                <1> 	add	al, bl	; bl = interpolated middle (sample 2)
  3958 000017FC D0D8                <1> 	rcr	al, 1	
  3959 000017FE 2C80                <1> 	sub	al, 80h
  3960 00001800 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3961 00001803 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3962 00001804 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3963 00001805 88D8                <1> 	mov	al, bl	; interpolated middle (sample 2)
  3964 00001807 2C80                <1> 	sub	al, 80h
  3965 00001809 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3966 0000180C AB                  <1> 	stosw		; interpolated sample 2 (L)
  3967 0000180D AB                  <1> 	stosw		; interpolated sample 2 (R)
  3968 0000180E 88D8                <1> 	mov	al, bl
  3969 00001810 00D0                <1> 	add	al, dl	; [next_val]
  3970 00001812 D0D8                <1> 	rcr	al, 1
  3971 00001814 2C80                <1> 	sub	al, 80h
  3972 00001816 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3973 00001819 AB                  <1> 	stosw		; interpolated sample 3 (L)
  3974 0000181A AB                  <1> 	stosw		; interpolated sample 3 (R)
  3975 0000181B C3                  <1> 	retn
  3976                              <1> 
  3977                              <1> interpolating_4_8bit_stereo:
  3978                              <1> 	; 17/11/2023
  3979                              <1> 	; al = [previous_val_l]
  3980                              <1> 	; ah = [previous_val_r]
  3981                              <1> 	; dl = [next_val_l]
  3982                              <1> 	; dh = [next_val_r]
  3983                              <1> 	; original-interpolated-interpolated-interpolated
  3984 0000181C 89C3                <1> 	mov	bx, ax
  3985 0000181E 2C80                <1> 	sub	al, 80h
  3986 00001820 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3987 00001823 AB                  <1> 	stosw		; original sample (L)
  3988 00001824 88F8                <1> 	mov	al, bh
  3989 00001826 2C80                <1> 	sub	al, 80h
  3990 00001828 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3991 0000182B AB                  <1> 	stosw		; original sample (R)
  3992 0000182C 88D8                <1> 	mov	al, bl
  3993 0000182E 00D0                <1> 	add	al, dl	; [next_val_l]
  3994 00001830 D0D8                <1> 	rcr	al, 1
  3995 00001832 86D8                <1> 	xchg	al, bl	; al = [previous_val_l]
  3996 00001834 00D8                <1> 	add	al, bl	; bl = interpolated middle (L) (sample 2)
  3997 00001836 D0D8                <1> 	rcr	al, 1
  3998 00001838 2C80                <1> 	sub	al, 80h
  3999 0000183A C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4000 0000183D AB                  <1> 	stosw		; interpolated sample 1 (L)
  4001 0000183E 88F8                <1> 	mov	al, bh
  4002 00001840 00F0                <1> 	add	al, dh	; [next_val_r]
  4003 00001842 D0D8                <1> 	rcr	al, 1
  4004 00001844 86F8                <1> 	xchg	al, bh	; al = [previous_val_h]
  4005 00001846 00F8                <1> 	add	al, bh	; bh = interpolated middle (R) (sample 2)
  4006 00001848 D0D8                <1> 	rcr	al, 1
  4007 0000184A 2C80                <1> 	sub	al, 80h
  4008 0000184C C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4009 0000184F AB                  <1> 	stosw		; interpolated sample 1 (R)
  4010 00001850 88D8                <1> 	mov	al, bl	; interpolated middle (L) (sample 2)
  4011 00001852 2C80                <1> 	sub	al, 80h
  4012 00001854 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4013 00001857 AB                  <1> 	stosw		; interpolated sample 2 (L)
  4014 00001858 88F8                <1> 	mov	al, bh	; interpolated middle (L) (sample 2)
  4015 0000185A 2C80                <1> 	sub	al, 80h
  4016 0000185C C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4017 0000185F AB                  <1> 	stosw		; interpolated sample 2 (L)
  4018 00001860 88D8                <1> 	mov	al, bl
  4019 00001862 00D0                <1> 	add	al, dl	; [next_val_l]
  4020 00001864 D0D8                <1> 	rcr	al, 1
  4021 00001866 2C80                <1> 	sub	al, 80h
  4022 00001868 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4023 0000186B AB                  <1> 	stosw		; interpolated sample 3 (L)
  4024 0000186C 88F8                <1> 	mov	al, bh
  4025 0000186E 00F0                <1> 	add	al, dh	; [next_val_r]
  4026 00001870 D0D8                <1> 	rcr	al, 1
  4027 00001872 2C80                <1> 	sub	al, 80h
  4028 00001874 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4029 00001877 AB                  <1> 	stosw		; interpolated sample 3 (R)
  4030 00001878 C3                  <1> 	retn
  4031                              <1> 
  4032                              <1> interpolating_5_16bit_mono:
  4033                              <1> 	; 18/11/2023
  4034                              <1> 	; ax = [previous_val]
  4035                              <1> 	; dx = [next_val]
  4036                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  4037 00001879 AB                  <1> 	stosw		; original sample (L)
  4038 0000187A AB                  <1> 	stosw		; original sample (R)
  4039 0000187B 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  4040 0000187E 89C3                <1> 	mov	bx, ax	; [previous_val]
  4041 00001880 80C680              <1> 	add	dh, 80h
  4042 00001883 01D0                <1> 	add	ax, dx
  4043 00001885 D1D8                <1> 	rcr	ax, 1
  4044 00001887 50                  <1> 	push	ax ; *	; interpolated middle (temporary)
  4045 00001888 01D8                <1> 	add	ax, bx	; interpolated middle + [previous_val]
  4046 0000188A D1D8                <1> 	rcr	ax, 1
  4047 0000188C 50                  <1> 	push	ax ; **	; interpolated 1st quarter (temporary)
  4048 0000188D 01D8                <1> 	add	ax, bx	; 1st quarter + [previous_val]
  4049 0000188F D1D8                <1> 	rcr	ax, 1	
  4050 00001891 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4051 00001894 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  4052 00001895 AB                  <1> 	stosw		; interpolated sample 1 (R)
  4053 00001896 58                  <1> 	pop	ax ; **
  4054 00001897 5B                  <1> 	pop	bx ; *
  4055 00001898 01D8                <1> 	add	ax, bx	; 1st quarter + middle
  4056 0000189A D1D8                <1> 	rcr	ax, 1	; / 2
  4057 0000189C 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again	
  4058 0000189F AB                  <1> 	stosw		; interpolated sample 2 (L)
  4059 000018A0 AB                  <1> 	stosw		; interpolated sample 2 (R)
  4060 000018A1 89D8                <1> 	mov	ax, bx
  4061 000018A3 01D0                <1> 	add	ax, dx	; interpolated middle + [next_val]
  4062 000018A5 D1D8                <1> 	rcr	ax, 1
  4063 000018A7 50                  <1> 	push	ax ; *	; interpolated 3rd quarter (temporary)
  4064 000018A8 01D8                <1> 	add	ax, bx	; + interpolated middle
  4065 000018AA D1D8                <1> 	rcr	ax, 1
  4066 000018AC 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4067 000018AF AB                  <1> 	stosw		; interpolated sample 3 (L)
  4068 000018B0 AB                  <1> 	stosw		; interpolated sample 3 (R)
  4069 000018B1 58                  <1> 	pop	ax ; *	
  4070 000018B2 01D0                <1> 	add	ax, dx	; 3rd quarter + [next_val]
  4071 000018B4 D1D8                <1> 	rcr	ax, 1	; / 2
  4072 000018B6 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4073 000018B9 AB                  <1> 	stosw		; interpolated sample 4 (L)
  4074 000018BA AB                  <1> 	stosw		; interpolated sample 4 (R)
  4075 000018BB C3                  <1> 	retn
  4076                              <1> 
  4077                              <1> interpolating_5_16bit_stereo:
  4078                              <1> 	; 18/11/2023
  4079                              <1> 	; bx = [previous_val_l]
  4080                              <1> 	; ax = [previous_val_r]
  4081                              <1> 	; [next_val_l]
  4082                              <1> 	; [next_val_r]
  4083                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  4084 000018BC 51                  <1> 	push	cx ; !
  4085 000018BD 93                  <1> 	xchg	ax, bx
  4086 000018BE AB                  <1> 	stosw		; original sample (L)
  4087 000018BF 93                  <1> 	xchg	ax, bx
  4088 000018C0 AB                  <1> 	stosw		; original sample (R)
  4089 000018C1 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  4090 000018C4 50                  <1> 	push	ax ; *	; [previous_val_r]
  4091 000018C5 80C780              <1> 	add	bh, 80h
  4092 000018C8 8006[E019]80        <1> 	add	byte [next_val_l+1], 80h
  4093 000018CD A1[DF19]            <1> 	mov	ax, [next_val_l]
  4094 000018D0 01D8                <1> 	add	ax, bx	; [previous_val_l]
  4095 000018D2 D1D8                <1> 	rcr	ax, 1
  4096 000018D4 89C1                <1> 	mov	cx, ax	; interpolated middle (L)
  4097 000018D6 01D8                <1> 	add	ax, bx	
  4098 000018D8 D1D8                <1> 	rcr	ax, 1
  4099 000018DA 89C2                <1> 	mov	dx, ax	; interpolated 1st quarter (L)
  4100 000018DC 01D8                <1> 	add	ax, bx	; [previous_val_l]
  4101 000018DE D1D8                <1> 	rcr	ax, 1
  4102 000018E0 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4103 000018E3 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  4104 000018E4 89C8                <1> 	mov	ax, cx
  4105 000018E6 01D0                <1> 	add	ax, dx	; middle (L) + 1st quarter (L)
  4106 000018E8 D1D8                <1> 	rcr	ax, 1	; / 2
  4107 000018EA 89C3                <1> 	mov	bx, ax  ; interpolated sample 2 (L)
  4108 000018EC 5A                  <1> 	pop	dx ; *	; [previous_val_r]
  4109 000018ED 89D0                <1> 	mov	ax, dx
  4110 000018EF 8006[E219]80        <1> 	add	byte [next_val_r+1], 80h
  4111 000018F4 0306[E119]          <1> 	add	ax, [next_val_r]
  4112 000018F8 D1D8                <1> 	rcr	ax, 1
  4113 000018FA 50                  <1> 	push	ax ; *	; interpolated middle (R)
  4114 000018FB 01D0                <1> 	add	ax, dx
  4115 000018FD D1D8                <1> 	rcr	ax, 1
  4116 000018FF 50                  <1> 	push	ax ; **	; interpolated 1st quarter (R)
  4117 00001900 01D0                <1> 	add	ax, dx	; [previous_val_r]
  4118 00001902 D1D8                <1> 	rcr	ax, 1
  4119 00001904 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4120 00001907 AB                  <1> 	stosw 		; interpolated sample 1 (R)
  4121 00001908 89D8                <1> 	mov	ax, bx
  4122 0000190A 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4123 0000190D AB                  <1> 	stosw 		; interpolated sample 2 (L)
  4124 0000190E 58                  <1> 	pop	ax ; **
  4125 0000190F 5A                  <1> 	pop	dx ; *
  4126 00001910 01D0                <1> 	add	ax, dx	; 1st quarter (R) + middle (R)
  4127 00001912 D1D8                <1> 	rcr	ax, 1	; / 2
  4128 00001914 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4129 00001917 AB                  <1> 	stosw 		; interpolated sample 2 (R)
  4130 00001918 89C8                <1> 	mov	ax, cx
  4131 0000191A 0306[DF19]          <1> 	add	ax, [next_val_l]
  4132 0000191E D1D8                <1> 	rcr	ax, 1
  4133 00001920 50                  <1> 	push	ax ; * 	; interpolated 3rd quarter (L)
  4134 00001921 01C8                <1> 	add	ax, cx	; interpolated middle (L)
  4135 00001923 D1D8                <1> 	rcr	ax, 1
  4136 00001925 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4137 00001928 AB                  <1> 	stosw 		; interpolated sample 3 (L)
  4138 00001929 89D0                <1> 	mov	ax, dx
  4139 0000192B 0306[E119]          <1> 	add	ax, [next_val_r]
  4140 0000192F D1D8                <1> 	rcr	ax, 1
  4141 00001931 50                  <1> 	push	ax ; ** ; interpolated 3rd quarter (R)
  4142 00001932 01D0                <1> 	add	ax, dx	; interpolated middle (R)
  4143 00001934 D1D8                <1> 	rcr	ax, 1
  4144 00001936 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4145 00001939 AB                  <1> 	stosw 		; interpolated sample 3 (R)
  4146 0000193A 5B                  <1> 	pop	bx ; **
  4147 0000193B 58                  <1> 	pop	ax ; *
  4148 0000193C 0306[DF19]          <1> 	add	ax, [next_val_l]
  4149 00001940 D1D8                <1> 	rcr	ax, 1
  4150 00001942 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4151 00001945 AB                  <1> 	stosw 		; interpolated sample 4 (L)
  4152 00001946 89D8                <1> 	mov	ax, bx	
  4153 00001948 0306[E119]          <1> 	add	ax, [next_val_r]
  4154 0000194C D1D8                <1> 	rcr	ax, 1
  4155 0000194E 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4156 00001951 AB                  <1> 	stosw 		; interpolated sample 4 (R)
  4157 00001952 59                  <1> 	pop	cx ; !
  4158 00001953 C3                  <1> 	retn
  4159                              <1> 
  4160                              <1> interpolating_4_16bit_mono:
  4161                              <1> 	; 18/11/2023
  4162                              <1> 	; ax = [previous_val]
  4163                              <1> 	; dx = [next_val]
  4164                              <1> 	; original-interpolated-interpolated-interpolated
  4165                              <1> 
  4166 00001954 AB                  <1> 	stosw		; original sample (L)
  4167 00001955 AB                  <1> 	stosw		; original sample (R)
  4168 00001956 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  4169 00001959 89C3                <1> 	mov	bx, ax	; [previous_val]
  4170 0000195B 80C680              <1> 	add	dh, 80h
  4171 0000195E 01D0                <1> 	add	ax, dx	; [previous_val] + [next_val]
  4172 00001960 D1D8                <1> 	rcr	ax, 1
  4173 00001962 93                  <1> 	xchg	ax, bx	
  4174 00001963 01D8                <1> 	add	ax, bx	; [previous_val] + interpolated middle
  4175 00001965 D1D8                <1> 	rcr	ax, 1
  4176 00001967 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4177 0000196A AB                  <1> 	stosw 		; interpolated sample 1 (L)
  4178 0000196B AB                  <1> 	stosw		; interpolated sample 1 (R)
  4179 0000196C 89D8                <1> 	mov	ax, bx	; interpolated middle
  4180 0000196E 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4181 00001971 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  4182 00001972 AB                  <1> 	stosw		; interpolated sample 2 (R)
  4183 00001973 89D8                <1> 	mov	ax, bx
  4184 00001975 01D0                <1> 	add	ax, dx	; interpolated middle + [next_val]
  4185 00001977 D1D8                <1> 	rcr	ax, 1
  4186 00001979 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4187 0000197C AB                  <1> 	stosw		; interpolated sample 3 (L)
  4188 0000197D AB                  <1> 	stosw		; interpolated sample 3 (R)
  4189 0000197E C3                  <1> 	retn
  4190                              <1> 
  4191                              <1> interpolating_4_16bit_stereo:
  4192                              <1> 	; 18/11/2023
  4193                              <1> 	; bx = [previous_val_l]
  4194                              <1> 	; ax = [previous_val_r]
  4195                              <1> 	; [next_val_l]
  4196                              <1> 	; [next_val_r]
  4197                              <1> 	; original-interpolated-interpolated-interpolated
  4198 0000197F 93                  <1> 	xchg	ax, bx
  4199 00001980 AB                  <1> 	stosw		; original sample (L)
  4200 00001981 93                  <1> 	xchg	ax, bx
  4201 00001982 AB                  <1> 	stosw		; original sample (R)
  4202 00001983 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  4203 00001986 89C2                <1> 	mov	dx, ax	; [previous_val_r]
  4204 00001988 80C780              <1> 	add	bh, 80h
  4205 0000198B 8006[E019]80        <1> 	add	byte [next_val_l+1], 80h
  4206 00001990 A1[DF19]            <1> 	mov	ax, [next_val_l]
  4207 00001993 01D8                <1> 	add	ax, bx	; [previous_val_l]
  4208 00001995 D1D8                <1> 	rcr	ax, 1
  4209 00001997 93                  <1> 	xchg	ax, bx
  4210 00001998 01D8                <1> 	add	ax, bx	; bx = interpolated middle (L)
  4211 0000199A D1D8                <1> 	rcr	ax, 1
  4212 0000199C 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4213 0000199F AB                  <1> 	stosw 		; interpolated sample 1 (L)
  4214 000019A0 8006[E219]80        <1> 	add	byte [next_val_r+1], 80h
  4215 000019A5 89D0                <1> 	mov	ax, dx	; [previous_val_r]
  4216 000019A7 0306[E119]          <1> 	add	ax, [next_val_r]
  4217 000019AB D1D8                <1> 	rcr	ax, 1
  4218 000019AD 92                  <1> 	xchg	ax, dx
  4219 000019AE 01D0                <1> 	add	ax, dx	; dx = interpolated middle (R)
  4220 000019B0 D1D8                <1> 	rcr	ax, 1
  4221 000019B2 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4222 000019B5 AB                  <1> 	stosw 		; interpolated sample 1 (R)
  4223 000019B6 89D8                <1> 	mov	ax, bx
  4224 000019B8 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4225 000019BB AB                  <1> 	stosw 		; interpolated sample 2 (L)
  4226 000019BC 89D0                <1> 	mov	ax, dx
  4227 000019BE 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4228 000019C1 AB                  <1> 	stosw 		; interpolated sample 2 (R)
  4229 000019C2 89D8                <1> 	mov	ax, bx
  4230 000019C4 0306[DF19]          <1> 	add	ax, [next_val_l]
  4231 000019C8 D1D8                <1> 	rcr	ax, 1
  4232 000019CA 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4233 000019CD AB                  <1> 	stosw 		; interpolated sample 3 (L)
  4234 000019CE 89D0                <1> 	mov	ax, dx
  4235 000019D0 0306[E119]          <1> 	add	ax, [next_val_r]
  4236 000019D4 D1D8                <1> 	rcr	ax, 1
  4237 000019D6 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4238 000019D9 AB                  <1> 	stosw 		; interpolated sample 3 (R)
  4239 000019DA C3                  <1> 	retn
  4240                              <1> 
  4241                              <1> ; 13/11/2023
  4242                              <1> previous_val:
  4243 000019DB 0000                <1> previous_val_l: dw 0
  4244 000019DD 0000                <1> previous_val_r: dw 0
  4245                              <1> next_val:
  4246 000019DF 0000                <1> next_val_l: dw 0
  4247 000019E1 0000                <1> next_val_r: dw 0
  4248                              <1> 
  4249                              <1> ; 16/11/2023
  4250 000019E3 00                  <1> faz:	db 0
  4251                              <1> 
  4252                              <1> ; --------------------------------------------------------
   457                                  
   458                                  ; UTILS.ASM
   459                                  ;----------------------------------------------------------------------------
   460                                  ;       delay1_4ms - Delay for 1/4 millisecond.
   461                                  ;		    1mS = 1000us
   462                                  ;       Entry:
   463                                  ;         None
   464                                  ;       Exit:
   465                                  ;	  None
   466                                  ;
   467                                  ;       Modified:
   468                                  ;         None
   469                                  ;
   470                                  PORTB			EQU	061h
   471                                    REFRESH_STATUS	EQU	010h		; Refresh signal status
   472                                  
   473                                  delay1_4ms:
   474 000019E4 50                              push    ax 
   475 000019E5 51                              push    cx
   476 000019E6 B91000                          mov     cx, 16			; close enough.
   477 000019E9 E461                    	in	al,PORTB
   478 000019EB 2410                    	and	al,REFRESH_STATUS
   479 000019ED 88C4                    	mov	ah,al			; Start toggle state
   480 000019EF 09C9                    	or	cx, cx
   481 000019F1 7401                    	jz	short _d4ms1
   482 000019F3 41                      	inc	cx			; Throwaway first toggle
   483                                  _d4ms1:	
   484 000019F4 E461                    	in	al,PORTB		; Read system control port
   485 000019F6 2410                    	and	al,REFRESH_STATUS	; Refresh toggles 15.085 microseconds
   486 000019F8 38C4                    	cmp	ah,al
   487 000019FA 74F8                    	je	short _d4ms1		; Wait for state change
   488                                  
   489 000019FC 88C4                    	mov	ah,al			; Update with new state
   490 000019FE 49                      	dec	cx
   491 000019FF 75F3                    	jnz	short _d4ms1
   492                                  
   493 00001A01 59                              pop     cx
   494 00001A02 58                              pop     ax
   495 00001A03 C3                              retn
   496                                  
   497                                  	; 13/11/2016 - Erdogan Tan
   498                                  write_ac97_dev_info:
   499                                  	; BUS/DEV/FN
   500                                  	;	00000000BBBBBBBBDDDDDFFF00000000
   501                                  	; DEV/VENDOR
   502                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
   503                                  
   504 00001A04 30FF                    	xor	bh, bh
   505 00001A06 668B36[281E]            	mov	esi, [dev_vendor]
   506 00001A0B 89F0                    	mov	ax, si
   507 00001A0D 88C3                    	mov	bl, al
   508 00001A0F 88DA                    	mov	dl, bl
   509 00001A11 80E30F                  	and	bl, 0Fh
   510 00001A14 8A87[A01C]              	mov	al, [bx+hex_chars]
   511 00001A18 A2[E31C]                	mov	[msgVendorId+3], al
   512 00001A1B 88D3                    	mov	bl, dl
   513 00001A1D C0EB04                  	shr	bl, 4
   514 00001A20 8A87[A01C]              	mov	al, [bx+hex_chars]
   515 00001A24 A2[E21C]                	mov	[msgVendorId+2], al
   516 00001A27 88E3                    	mov	bl, ah
   517 00001A29 88DA                    	mov	dl, bl
   518 00001A2B 80E30F                  	and	bl, 0Fh
   519 00001A2E 8A87[A01C]              	mov	al, [bx+hex_chars]
   520 00001A32 A2[E11C]                	mov	[msgVendorId+1], al
   521 00001A35 88D3                    	mov	bl, dl
   522 00001A37 C0EB04                  	shr	bl, 4
   523 00001A3A 8A87[A01C]              	mov	al, [bx+hex_chars]
   524 00001A3E A2[E01C]                	mov	[msgVendorId], al
   525 00001A41 66C1EE10                	shr	esi, 16
   526 00001A45 89F0                    	mov	ax, si
   527 00001A47 88C3                    	mov	bl, al
   528 00001A49 88DA                    	mov	dl, bl
   529 00001A4B 80E30F                  	and	bl, 0Fh
   530 00001A4E 8A87[A01C]              	mov	al, [bx+hex_chars]
   531 00001A52 A2[F41C]                	mov	[msgDevId+3], al
   532 00001A55 88D3                    	mov	bl, dl
   533 00001A57 C0EB04                  	shr	bl, 4
   534 00001A5A 8A87[A01C]              	mov	al, [bx+hex_chars]
   535 00001A5E A2[F31C]                	mov	[msgDevId+2], al
   536 00001A61 88E3                    	mov	bl, ah
   537 00001A63 88DA                    	mov	dl, bl
   538 00001A65 80E30F                  	and	bl, 0Fh
   539 00001A68 8A87[A01C]              	mov	al, [bx+hex_chars]
   540 00001A6C A2[F21C]                	mov	[msgDevId+1], al
   541 00001A6F 88D3                    	mov	bl, dl
   542 00001A71 C0EB04                  	shr	bl, 4
   543 00001A74 8A87[A01C]              	mov	al, [bx+hex_chars]
   544 00001A78 A2[F11C]                	mov	[msgDevId], al
   545                                  
   546 00001A7B 668B36[241E]            	mov	esi, [bus_dev_fn]
   547 00001A80 66C1EE08                	shr	esi, 8
   548 00001A84 89F0                    	mov	ax, si
   549 00001A86 88C3                    	mov	bl, al
   550 00001A88 88DA                    	mov	dl, bl
   551 00001A8A 80E307                  	and	bl, 7 ; bit 0,1,2
   552 00001A8D 8A87[A01C]              	mov	al, [bx+hex_chars]
   553 00001A91 A2[181D]                	mov	[msgFncNo+1], al
   554 00001A94 88D3                    	mov	bl, dl
   555 00001A96 C0EB03                  	shr	bl, 3
   556 00001A99 88DA                    	mov	dl, bl
   557 00001A9B 80E30F                  	and	bl, 0Fh
   558 00001A9E 8A87[A01C]              	mov	al, [bx+hex_chars]
   559 00001AA2 A2[0A1D]                	mov	[msgDevNo+1], al
   560 00001AA5 88D3                    	mov	bl, dl
   561 00001AA7 C0EB04                  	shr	bl, 4
   562 00001AAA 8A87[A01C]              	mov	al, [bx+hex_chars]
   563 00001AAE A2[091D]                	mov	[msgDevNo], al
   564 00001AB1 88E3                    	mov	bl, ah
   565 00001AB3 88DA                    	mov	dl, bl
   566 00001AB5 80E30F                  	and	bl, 0Fh
   567 00001AB8 8A87[A01C]              	mov	al, [bx+hex_chars]
   568 00001ABC A2[FE1C]                	mov	[msgBusNo+1], al
   569 00001ABF 88D3                    	mov	bl, dl
   570 00001AC1 C0EB04                  	shr	bl, 4
   571 00001AC4 8A87[A01C]              	mov	al, [bx+hex_chars]
   572 00001AC8 A2[FD1C]                	mov	[msgBusNo], al
   573                                  
   574 00001ACB A1[1A1E]                	mov	ax, [NAMBAR]
   575 00001ACE 88C3                    	mov	bl, al
   576 00001AD0 88DA                    	mov	dl, bl
   577 00001AD2 80E30F                  	and	bl, 0Fh
   578 00001AD5 8A87[A01C]              	mov	al, [bx+hex_chars]
   579 00001AD9 A2[271D]                	mov	[msgNamBar+3], al
   580 00001ADC 88D3                    	mov	bl, dl
   581 00001ADE C0EB04                  	shr	bl, 4
   582 00001AE1 8A87[A01C]              	mov	al, [bx+hex_chars]
   583 00001AE5 A2[261D]                	mov	[msgNamBar+2], al
   584 00001AE8 88E3                    	mov	bl, ah
   585 00001AEA 88DA                    	mov	dl, bl
   586 00001AEC 80E30F                  	and	bl, 0Fh
   587 00001AEF 8A87[A01C]              	mov	al, [bx+hex_chars]
   588 00001AF3 A2[251D]                	mov	[msgNamBar+1], al
   589 00001AF6 88D3                    	mov	bl, dl
   590 00001AF8 C0EB04                  	shr	bl, 4
   591 00001AFB 8A87[A01C]              	mov	al, [bx+hex_chars]
   592 00001AFF A2[241D]                	mov	[msgNamBar], al
   593                                  
   594                                  	; 08/05/2024 (ebx->bx)
   595                                  	; 05/11/2023
   596 00001B02 A1[1C1E]                	mov	ax, [NABMBAR]
   597 00001B05 88C3                    	mov	bl, al
   598 00001B07 88DA                    	mov	dl, bl
   599 00001B09 80E30F                  	and	bl, 0Fh
   600 00001B0C 8A87[A01C]              	mov	al, [bx+hex_chars]
   601 00001B10 A2[361D]                	mov	[msgNabmBar+3], al
   602 00001B13 88D3                    	mov	bl, dl
   603 00001B15 C0EB04                  	shr	bl, 4
   604 00001B18 8A87[A01C]              	mov	al, [bx+hex_chars]
   605 00001B1C A2[351D]                	mov	[msgNabmBar+2], al
   606 00001B1F 88E3                    	mov	bl, ah
   607 00001B21 88DA                    	mov	dl, bl
   608 00001B23 80E30F                  	and	bl, 0Fh
   609 00001B26 8A87[A01C]              	mov	al, [bx+hex_chars]
   610 00001B2A A2[341D]                	mov	[msgNabmBar+1], al
   611 00001B2D 88D3                    	mov	bl, dl
   612 00001B2F C0EB04                  	shr	bl, 4
   613 00001B32 8A87[A01C]              	mov	al, [bx+hex_chars]
   614 00001B36 A2[331D]                	mov	[msgNabmBar], al
   615                                  
   616                                  	; 24/11/2016
   617 00001B39 30E4                    	xor	ah, ah
   618 00001B3B A0[111E]                	mov	al, [ac97_int_ln_reg]
   619 00001B3E B10A                    	mov	cl, 10
   620 00001B40 F6F1                    	div	cl
   621 00001B42 0106[3E1D]              	add	[msgIRQ], ax
   622 00001B46 20C0                    	and	al, al
   623 00001B48 7508                    	jnz	short _pmi
   624 00001B4A A0[3F1D]                	mov	al, [msgIRQ+1]
   625 00001B4D B420                    	mov	ah, ' '
   626 00001B4F A3[3E1D]                	mov	[msgIRQ], ax
   627                                  _pmi:
   628 00001B52 BA[B11C]                        mov	dx, msgAC97Info
   629 00001B55 B409                            mov     ah, 9
   630 00001B57 CD21                            int     21h
   631 00001B59 C3                              retn
   632                                  
   633                                  write_sample_rate:
   634                                  	; ax = sample rate (hertz)
   635                                  
   636 00001B5A 31D2                    	xor	dx, dx
   637 00001B5C B90A00                  	mov	cx, 10
   638 00001B5F F7F1                    	div	cx
   639 00001B61 0016[541D]              	add	[msgHertz+4], dl
   640 00001B65 29D2                    	sub	dx, dx
   641 00001B67 F7F1                    	div	cx
   642 00001B69 0016[531D]              	add	[msgHertz+3], dl
   643 00001B6D 29D2                    	sub	dx, dx
   644 00001B6F F7F1                    	div	cx
   645 00001B71 0016[521D]              	add	[msgHertz+2], dl
   646 00001B75 29D2                    	sub	dx, dx
   647 00001B77 F7F1                    	div	cx
   648 00001B79 0016[511D]              	add	[msgHertz+1], dl
   649 00001B7D 0006[501D]              	add	[msgHertz], al
   650                                  	
   651 00001B81 BA[431D]                        mov     dx, msgSampleRate
   652 00001B84 B409                            mov     ah, 9
   653 00001B86 CD21                            int     21h
   654                                  
   655                                  	; 19/11/2016
   656 00001B88 BA[691D]                	mov	dx, msg16Bits
   657 00001B8B 803E[301E]10            	cmp	byte [bps], 16
   658 00001B90 7403                    	je	short wsr_1
   659 00001B92 BA[5A1D]                	mov	dx, msg8Bits
   660                                  wsr_1:
   661 00001B95 B409                            mov     ah, 9
   662 00001B97 CD21                            int     21h
   663                                  
   664 00001B99 BA[621D]                	mov	dx, msgMono
   665 00001B9C 803E[2E1E]01            	cmp	byte [stmo], 1
   666 00001BA1 7403                    	je	short wsr_2
   667 00001BA3 BA[721D]                	mov	dx, msgStereo		
   668                                  wsr_2:
   669 00001BA6 B409                            mov     ah, 9
   670 00001BA8 CD21                            int     21h
   671                                  
   672 00001BAA C3                              retn
   673                                  
   674                                  ;detect_codec:
   675                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   676                                  ;	mov	eax, 7Ch
   677                                  ;	call	codec_read
   678                                  ;       shl     eax, 16
   679                                  ;       mov     [codec_id], eax
   680                                  ;
   681                                  ;	mov	eax, 7Eh
   682                                  ;       call	codec_read
   683                                  ;       or      eax, [codec_id]
   684                                  ;       mov     [codec_chip_id], eax
   685                                  ;       and     eax, 0FFFFFF00h
   686                                  ;
   687                                  ;       mov     edi, codecs
   688                                  ;_dcb:
   689                                  ;       mov     ebx, [di]
   690                                  ;       test    ebx, ebx
   691                                  ;       jz      short _dco_unknown
   692                                  ;
   693                                  ;       cmp     eax, ebx
   694                                  ;       jne     short _dco_next
   695                                  ;       mov     ax, [di+4]
   696                                  ;       mov     [codec_vendor_ids], ax
   697                                  ;       movzx   esi, ax
   698                                  ;       call	print_msg
   699                                  ;       
   700                                  ;	mov	ax, [di+6]
   701                                  ;	call	detect_chip
   702                                  ;       retn
   703                                  ;
   704                                  ;_dco_next:
   705                                  ;       add     di, 8
   706                                  ;       jmp     short _dcb
   707                                  ;
   708                                  ;_dco_unknown:
   709                                  ;       mov    word [codec_vendor_ids], ac_unknown
   710                                  ;       mov    word [codec_chip_ids], chip_unknown
   711                                  ;       mov     esi, chip_unknown
   712                                  ;	call	print_msg
   713                                  ;       mov     eax, [codec_chip_id]
   714                                  ;       call    dword2str
   715                                  ;       call	print_msg
   716                                  ;       retn
   717                                  
   718                                  ;detect_chip:
   719                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   720                                  ;	mov	di, ax ; chip_tab
   721                                  ;       mov     eax, [codec_chip_id]
   722                                  ;       and     ax, 0FFh
   723                                  ;_dch1:
   724                                  ;       mov     bx, [di]
   725                                  ;       cmp     bx, 0FFh
   726                                  ;       je      short _dch_unknown
   727                                  ;
   728                                  ;       cmp     ax, bx
   729                                  ;       jne     short _dch_next
   730                                  ;       mov     ax, [di+2]
   731                                  ;       mov     [codec_chip_ids], ax
   732                                  ;       mov     si, ax
   733                                  ;       call	print_msg
   734                                  ;       retn
   735                                  
   736                                  ;_dch_next:
   737                                  ;       add     di, 4
   738                                  ;       jmp     short _dch1
   739                                  ;
   740                                  ;_dch_unknown:
   741                                  ;       mov    word [codec_chip_ids], chip_unknown
   742                                  ;       mov     si, chip_unknown
   743                                  ;       call	print_msg
   744                                  ;       mov     eax, [codec_chip_id]
   745                                  ;       call    dword2str
   746                                  ;       call	print_msg
   747                                  ;       retn
   748                                  
   749                                  ; 19/05/2024
   750                                  ; 10/11/2023
   751                                  ; 09/11/2023
   752                                  ; 06/11/2023
   753                                  %if 1
   754                                  
   755                                  ac97_int_handler:
   756                                  	; 19/05/2024
   757                                  	; 16/05/2024 ('PLAYMOD3.ASM', 18/05/2024, Erdogan Tan)
   758                                  	; 11/11/2023
   759                                  	; 10/11/2023
   760                                  	; 17/02/2016
   761 00001BAB 50                      	push	ax ; +	; 16/05/2024
   762                                  	;push	eax ; *	; 11/11/2023
   763 00001BAC 52                      	push	dx ; **
   764                                  	; 05/11/2023
   765                                  	;push	cx
   766                                  	;push	bx
   767                                  	;push	si
   768                                  	;push	di
   769                                  
   770                                  	; 10/11/2023
   771                                  	; EOI at first
   772 00001BAD B020                    	mov	al, 20h
   773 00001BAF F606[111E]08            	test	byte [ac97_int_ln_reg], 8
   774 00001BB4 7402                    	jz	short _ih_0
   775 00001BB6 E6A0                    	out 	0A0h, al ; 20h	; EOI
   776                                  _ih_0:
   777 00001BB8 E620                    	out	20h, al  ; 20h	; EOI
   778                                  
   779                                  	; 16/05/2024
   780                                  ;	mov	dx, GLOB_STS_REG
   781                                  ;	add	dx, [NABMBAR]
   782                                  ;	in	eax, dx
   783                                  ;
   784                                  ;	inc	eax	; 0FFFFFFFFh
   785                                  ;	jz	short _ih_3
   786                                  ;	dec	eax	; 0
   787                                  ;	;jz	short _ih_3
   788                                  ;_ih_3:
   789                                  ;	; 16/05/2024
   790                                  ;	push	eax ; ***
   791                                  
   792                                  	; 16/05/2024
   793                                  	; 24/11/2023 (TRDOS386 'audio.s')
   794 00001BBA 8B16[1C1E]                      mov	dx, [NABMBAR]
   795 00001BBE 83C216                  	add	dx, PO_SR_REG
   796 00001BC1 ED                      	in	ax, dx
   797                                  
   798 00001BC2 A808                    	test	al, BCIS ; bit 3, 8
   799 00001BC4 7405                    	jz	short _ih_2
   800                                  
   801                                  	; 19/05/2024
   802                                  	; 15/05/2024
   803                                  	;cmp	byte [tLoop], 1
   804                                  	;jb	short _ih_2
   805                                  
   806                                  _ih_1:
   807                                  	; 19/05/2024
   808 00001BC6 50                      	push	ax ; ****
   809                                  
   810                                  	; 10/11/2023
   811                                  	; 28/11/2016 - Erdogan Tan
   812 00001BC7 E8AAEB                  	call	tuneLoop
   813                                  
   814                                  	; 19/05/2024
   815 00001BCA 58                      	pop	ax ; ****
   816                                  
   817                                  	; 16/05/2024
   818                                  _ih_2:
   819                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   820 00001BCB 8B16[1C1E]              	mov	dx, [NABMBAR]
   821 00001BCF 83C216                  	add	dx, PO_SR_REG
   822 00001BD2 EF                      	out	dx, ax
   823                                  
   824                                  ;	; 16/05/2024
   825                                  ;	pop	eax ; ***
   826                                  ;	
   827                                  ;	or	eax, eax
   828                                  ;	jz	short _ih_4
   829                                  ;	
   830                                  ;	mov	dx, GLOB_STS_REG
   831                                  ;	add	dx, [NABMBAR]
   832                                  ;	out	dx, eax
   833                                  
   834                                  	; 16/05/2024
   835                                  _ih_4:
   836                                  	; 10/11/2023
   837                                  	;mov	al, 20h
   838                                  	;test	byte [ac97_int_ln_reg], 8
   839                                  	;jz	short _ih_5
   840                                  	;out 	0A0h, al ; 20h	; EOI
   841                                  ;_ih_5:
   842                                  	;out	20h, al  ; 20h	; EOI
   843                                  ;_ih_6:
   844                                  	;pop	di
   845                                  	;pop	si
   846                                  	;pop	bx
   847                                  	;pop	cx
   848 00001BD3 5A                      	pop	dx ; **
   849                                  	;pop	eax ; *	; 11/11/2023
   850 00001BD4 58                      	pop	ax ; + ; 16/05/2024
   851 00001BD5 CF                      	iret
   852                                  
   853                                  %else
   854                                  
   855                                  ac97_int_handler:
   856                                  	; 11/11/2023
   857                                  	; 10/11/2023
   858                                  	; 17/02/2016
   859                                  	push	eax	; 11/11/2023
   860                                  	push	dx
   861                                  	; 05/11/2023
   862                                  	;push	cx
   863                                  	;push	bx
   864                                  	;push	si
   865                                  	;push	di
   866                                  
   867                                  	; 10/11/2023
   868                                  	; EOI at first
   869                                  	mov	al, 20h
   870                                  	test	byte [ac97_int_ln_reg], 8
   871                                  	jz	short _ih_0
   872                                  	out 	0A0h, al ; 20h	; EOI
   873                                  _ih_0:
   874                                  	out	20h, al  ; 20h	; EOI
   875                                  
   876                                  	; 11/11/2023
   877                                  	; 09/11/2023
   878                                  	mov	dx, GLOB_STS_REG
   879                                          add	dx, [NABMBAR]
   880                                  	in	eax, dx
   881                                  	
   882                                  	; 09/11/2023,
   883                                          cmp	eax, 0FFFFFFFFh ; -1
   884                                  	je	short _ih_2
   885                                  	
   886                                  	test	al, 40h		; PCM Out Interrupt
   887                                  	jnz	short _ih_1
   888                                  
   889                                  	test	eax, eax
   890                                  	jz	short _ih_2
   891                                  
   892                                   	;mov	dx, GLOB_STS_REG
   893                                          ;add	dx, [NABMBAR]
   894                                  	out	dx, eax
   895                                  	jmp	short _ih_2
   896                                  
   897                                  	; .....
   898                                  	;mov	al, 1
   899                                  	; 10/11/2023
   900                                  	;mov	[tloop], al  ; 1
   901                                  
   902                                  	;cmp	[inside], al ; 1
   903                                  	;jnb	short _ih_3	; busy
   904                                  
   905                                  	;mov	[inside], al ; 1
   906                                  	;
   907                                  	;; 09/11/2023
   908                                          ;mov	dx, [NABMBAR]
   909                                          ;add	dx, PO_SR_REG	; set pointer to Status reg
   910                                  	;in	al, dx
   911                                  	;; 10/11/2023
   912                                  	;;;out	dx, eax
   913                                  	;;out	dx, al		; clear interrupt event
   914                                  	;			; (by writing 1 to same bits)
   915                                  	;
   916                                  	;;mov	[pcm_irq_status], al ; 05/11/2023
   917                                  	;test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
   918                                  	;jz	short _ih_2
   919                                  	; .....
   920                                  
   921                                  _ih_1:
   922                                  	; 11/11/2023
   923                                  	push	eax
   924                                  
   925                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   926                                  	;mov	dx, PO_SR_REG
   927                                          ;add	dx, [NABMBAR]
   928                                  	;out	dx, ax
   929                                  
   930                                  	; 10/11/2023
   931                                  	; 28/11/2016 - Erdogan Tan
   932                                  	call	tuneLoop
   933                                  
   934                                  	; 11/11/2023
   935                                  	pop	eax
   936                                  	mov	dx, GLOB_STS_REG
   937                                          add	dx, [NABMBAR]
   938                                  	out	dx, eax
   939                                  _ih_2:
   940                                  	; 11/11/2023
   941                                  	mov	dx, [NABMBAR]
   942                                  	add	dx, PO_SR_REG	; set pointer to Status reg
   943                                  	mov	ax, 1Ch
   944                                  	out	dx, ax
   945                                  
   946                                  ;	; 10/11/2023
   947                                  ;	mov	al, 20h
   948                                  ;	test	byte [ac97_int_ln_reg], 8
   949                                  ;	jz	short _ih_3
   950                                  ;	out 	0A0h, al ; 20h	; EOI
   951                                  ;_ih_3:
   952                                  ;	out	20h, al  ; 20h	; EOI
   953                                  ;_ih_4:
   954                                  	;mov	byte [inside], 0
   955                                  	;pop	di
   956                                  	;pop	si
   957                                  	;pop	bx
   958                                  	;pop	cx
   959                                  	pop	dx
   960                                  	pop	eax ; 11/11/2023
   961                                  	iret
   962                                  
   963                                  %endif
   964                                  
   965                                  ; 10/11/2023
   966                                  ; 09/11/2023
   967                                  ; 06/11/2023
   968                                  %if 0
   969                                  
   970                                  ac97_int_handler:
   971                                  	; 10/11/2023
   972                                  	; 17/02/2016
   973                                  	push	ax	; 09/11/2023
   974                                  	push	dx
   975                                  	; 05/11/2023
   976                                  	;push	cx
   977                                  	;push	bx
   978                                  	;push	si
   979                                  	;push	di
   980                                  
   981                                  	; 10/11/2023
   982                                  	; EOI at first
   983                                  	mov	al, 20h
   984                                  	test	byte [ac97_int_ln_reg], 8
   985                                  	jz	short _ih_0
   986                                  	out 	0A0h, al ; 20h	; EOI
   987                                  _ih_0:
   988                                  	out	20h, al  ; 20h	; EOI
   989                                  
   990                                  	mov	al, 1
   991                                  
   992                                  	; 10/11/2023
   993                                  	;mov	[tloop], al  ; 1
   994                                  
   995                                  	cmp	[inside], al ; 1
   996                                  	jnb	short _ih_3	; busy
   997                                  
   998                                  	mov	[inside], al ; 1
   999                                  
  1000                                  	; 09/11/2023
  1001                                          mov	dx, [NABMBAR]
  1002                                          add	dx, PO_SR_REG	; set pointer to Status reg
  1003                                  	in	al, dx
  1004                                  	; 10/11/2023
  1005                                  	;out	dx, eax
  1006                                  	out	dx, al		; clear interrupt event
  1007                                  				; (by writing 1 to same bits)
  1008                                  
  1009                                  	;mov	[pcm_irq_status], al ; 05/11/2023
  1010                                  	test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
  1011                                  	jz	short _ih_2
  1012                                  	
  1013                                  	; 09/11/2023
  1014                                  	;mov	dx, GLOB_STS_REG
  1015                                          ;add	dx, [NABMBAR]
  1016                                  	;in	eax, dx
  1017                                  	
  1018                                  	; 09/11/2023,
  1019                                          ;cmp	eax, 0FFFFFFFFh ; -1
  1020                                  	;je	short _ih_2
  1021                                  	
  1022                                  	;test	al, 40h		; PCM Out Interrupt
  1023                                  	;jz	short _ih_2
  1024                                  _ih_1:
  1025                                  	; 10/11/2023
  1026                                  	; 28/11/2016 - Erdogan Tan
  1027                                  	call	tuneLoop
  1028                                  	;jnc	short _ih_2
  1029                                  	;dec	byte [tloop] ; [tloop] = 0
  1030                                  _ih_2:
  1031                                  	mov	byte [inside], 0
  1032                                  _ih_3:
  1033                                  	;pop	di
  1034                                  	;pop	si
  1035                                  	;pop	bx
  1036                                  	;pop	cx
  1037                                  	pop	dx
  1038                                  	pop	ax ; 09/11/2023
  1039                                  	iret
  1040                                  
  1041                                  %endif
  1042                                  
  1043                                  ac97_stop:
  1044                                  	; 11/11/2023
  1045                                  	; 09/11/2023
  1046                                  	; 05/11/2023
  1047                                  	; 04/11/2023 
  1048                                  	; 28/05/2017 (TRDOS 386 v2, 'audio.s')
  1049                                  	;mov	byte [tLoop], 0 ; stop ! ; 05/11/2023
  1050                                  ;_ac97_stop:
  1051                                  
  1052                                  	; 11/11/2023
  1053 00001BD6 8B16[1A1E]              	mov	dx, [NAMBAR]
  1054                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  1055 00001BDA EF                      	out	dx, ax
  1056                                  
  1057                                  	; 04/11/2023
  1058                                  	; 09/10/2017 (TRDOS 386 v2, 'audio.s')
  1059                                  	; 11/06/2017
  1060 00001BDB 30C0                    	xor	al, al ; 0
  1061 00001BDD E80D00                  	call	ac97_po_cmd
  1062                                  
  1063                                  	; (Ref: KolibriOS, intelac97.asm, 'stop:')
  1064                                  	; Clear FIFOE, BCIS, LVBCI (Ref: Intel ICH hub manual)
  1065 00001BE0 B81C00                  	mov     ax, 1Ch
  1066 00001BE3 8B16[1C1E]              	mov     dx, [NABMBAR]
  1067 00001BE7 83C216                  	add     dx, PO_SR_REG
  1068 00001BEA EF                      	out     dx, ax
  1069                                  
  1070                                  	; 11/06/2017
  1071 00001BEB B002                    	mov     al, RR
  1072                                  ac97_po_cmd:
  1073                                  	; 11/06/2017
  1074                                  	; 29/05/2017
  1075 00001BED 8B16[1C1E]              	mov     dx, [NABMBAR]
  1076 00001BF1 83C21B                          add     dx, PO_CR_REG		; PCM out control register
  1077 00001BF4 EE                      	out	dx, al
  1078 00001BF5 C3                      	retn
  1079                                  
  1080                                  print_msg:
  1081                                  	; 13/11/2016 - Erdogan Tan 
  1082                                  	; esi = ASCIIZ text address
  1083                                  	;
  1084 00001BF6 BB0700                  	mov	bx, 7h
  1085 00001BF9 B40E                    	mov	ah, 0Eh 
  1086                                  pm_next_char:
  1087 00001BFB AC                      	lodsb
  1088 00001BFC 20C0                    	and	al, al
  1089 00001BFE 7404                    	jz	short pm_retn
  1090 00001C00 CD10                    	int	10h
  1091 00001C02 EBF7                    	jmp	short pm_next_char
  1092                                  pm_retn:
  1093 00001C04 C3                      	retn
  1094                                  
  1095                                  ; 06/11/2023
  1096                                  ;dword2str:
  1097                                  ;	; 13/11/2016 - Erdogan Tan 
  1098                                  ;	; eax = dword value
  1099                                  ;	;
  1100                                  ;	call	dwordtohex
  1101                                  ;	mov	[dword_str], edx
  1102                                  ;	mov	[dword_str+4], eax
  1103                                  ;	mov	si, dword_str
  1104                                  ;	retn
  1105                                  
  1106                                  	; trdos386.s (unix386.s) - 10/05/2015
  1107                                  	; Convert binary number to hexadecimal string
  1108                                  
  1109                                  bytetohex:
  1110                                  	; INPUT ->
  1111                                  	; 	AL = byte (binary number)
  1112                                  	; OUTPUT ->
  1113                                  	;	AX = hexadecimal string
  1114                                  	;
  1115 00001C05 53                      	push	bx
  1116 00001C06 30FF                    	xor	bh, bh
  1117 00001C08 88C3                    	mov	bl, al
  1118 00001C0A C0EB04                  	shr	bl, 4
  1119 00001C0D 8A9F[A01C]              	mov	bl, [bx+hex_chars] 	 	
  1120 00001C11 86C3                    	xchg	bl, al
  1121 00001C13 80E30F                  	and	bl, 0Fh
  1122 00001C16 8AA7[A01C]              	mov	ah, [bx+hex_chars] 
  1123 00001C1A 5B                      	pop	bx	
  1124 00001C1B C3                      	retn
  1125                                  
  1126                                  wordtohex:
  1127                                  	; INPUT ->
  1128                                  	; 	AX = word (binary number)
  1129                                  	; OUTPUT ->
  1130                                  	;	EAX = hexadecimal string
  1131                                  	;
  1132 00001C1C 53                      	push	bx
  1133 00001C1D 30FF                    	xor	bh, bh
  1134 00001C1F 86C4                    	xchg	ah, al
  1135 00001C21 50                      	push	ax
  1136 00001C22 88E3                    	mov	bl, ah
  1137 00001C24 C0EB04                  	shr	bl, 4
  1138 00001C27 8A87[A01C]              	mov	al, [bx+hex_chars] 	 	
  1139 00001C2B 88E3                    	mov	bl, ah
  1140 00001C2D 80E30F                  	and	bl, 0Fh
  1141 00001C30 8AA7[A01C]              	mov	ah, [bx+hex_chars]
  1142 00001C34 66C1E010                	shl	eax, 16
  1143 00001C38 58                      	pop	ax
  1144 00001C39 5B                      	pop	bx
  1145 00001C3A EBC9                    	jmp	short bytetohex
  1146                                  
  1147                                  ; 06/11/2023
  1148                                  ;dwordtohex:
  1149                                  ;	; INPUT ->
  1150                                  ;	; 	EAX = dword (binary number)
  1151                                  ;	; OUTPUT ->
  1152                                  ;	;	EDX:EAX = hexadecimal string
  1153                                  ;	;
  1154                                  ;	push	eax
  1155                                  ;	shr	eax, 16
  1156                                  ;	call	wordtohex
  1157                                  ;	mov	edx, eax
  1158                                  ;	pop	eax
  1159                                  ;	call	wordtohex
  1160                                  ;	retn
  1161                                  
  1162                                  _DATA:
  1163                                  
  1164                                  ; 24/11/2016
  1165                                  ;	IRQ  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 
  1166 00001C3C 08090A0B0C0D0E0F70-     irq_int	 db 08h,09h,0Ah,0Bh,0Ch,0Dh,0Eh,0Fh,70h,71h,72h,73h,74h,75h,76h,77h
  1166 00001C45 71727374757677     
  1167                                  
  1168                                  ; 17/02/2017
  1169                                  ; Valid ICH device IDs
  1170                                  
  1171                                  valid_ids:
  1172 00001C4C 86801524                dd	(ICH_DID << 16) + INTEL_VID  	 ; 8086h:2415h 
  1173 00001C50 86802524                dd	(ICH0_DID << 16) + INTEL_VID 	 ; 8086h:2425h 
  1174 00001C54 86804524                dd	(ICH2_DID << 16) + INTEL_VID 	 ; 8086h:2445h 
  1175 00001C58 86808524                dd	(ICH3_DID << 16) + INTEL_VID 	 ; 8086h:2485h 
  1176 00001C5C 8680C524                dd	(ICH4_DID << 16) + INTEL_VID 	 ; 8086h:24C5h
  1177 00001C60 8680D524                dd	(ICH5_DID << 16) + INTEL_VID 	 ; 8086h:24D5h
  1178 00001C64 86806E26                dd	(ICH6_DID << 16) + INTEL_VID 	 ; 8086h:266Eh
  1179 00001C68 8680A625                dd	(ESB6300_DID << 16) + INTEL_VID  ; 8086h:25A6h
  1180 00001C6C 86809826                dd	(ESB631X_DID << 16) + INTEL_VID  ; 8086h:2698h
  1181 00001C70 8680DE27                dd	(ICH7_DID << 16) + INTEL_VID 	 ; 8086h:27DEh
  1182                                  ; 03/11/2023 - Erdogan Tan
  1183 00001C74 86809571                dd	(MX82440_DID << 16) + INTEL_VID  ; 8086h:7195h
  1184 00001C78 39101270                dd	(SI7012_DID << 16)  + SIS_VID	 ; 1039h:7012h
  1185 00001C7C DE10B101                dd 	(NFORCE_DID << 16)  + NVIDIA_VID ; 10DEh:01B1h
  1186 00001C80 DE106A00                dd 	(NFORCE2_DID << 16) + NVIDIA_VID ; 10DEh:006Ah
  1187 00001C84 22106D74                dd 	(AMD8111_DID << 16) + AMD_VID 	 ; 1022h:746Dh
  1188 00001C88 22104574                dd 	(AMD768_DID << 16)  + AMD_VID 	 ; 1022h:7445h
  1189 00001C8C DE105900                dd 	(CK804_DID << 16) + NVIDIA_VID	 ; 10DEh:0059h
  1190 00001C90 DE103A00                dd 	(MCP04_DID << 16) + NVIDIA_VID	 ; 10DEh:003Ah
  1191 00001C94 DE108A00                dd 	(CK8_DID << 16) + NVIDIA_VID	 ; 1022h:008Ah
  1192 00001C98 DE10DA00                dd 	(NFORCE3_DID << 16) + NVIDIA_VID ; 10DEh:00DAh
  1193 00001C9C DE10EA00                dd 	(CK8S_DID << 16) + NVIDIA_VID	 ; 10DEh:00EAh
  1194                                  
  1195                                  valid_id_count:	equ ($ - valid_ids)>>2 ; 05/11/2023
  1196                                  
  1197                                  ; 13/11/2016
  1198 00001CA0 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  1198 00001CA9 3941424344454600   
  1199 00001CB1 414339372041756469-     msgAC97Info	db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  1199 00001CBA 6F20436F6E74726F6C-
  1199 00001CC3 6C6572202620436F64-
  1199 00001CCC 656320496E666F0D0A 
  1200 00001CD5 56656E646F72204944-     		db "Vendor ID: "
  1200 00001CDE 3A20               
  1201 00001CE0 303030306820446576-     msgVendorId	db "0000h Device ID: "
  1201 00001CE9 6963652049443A20   
  1202 00001CF1 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  1203 00001CF8 4275733A20              		db "Bus: "
  1204 00001CFD 303068204465766963-     msgBusNo	db "00h Device: "
  1204 00001D06 653A20             
  1205 00001D09 3030682046756E6374-     msgDevNo	db "00h Function: "
  1205 00001D12 696F6E3A20         
  1206 00001D17 303068                  msgFncNo	db "00h"
  1207 00001D1A 0D0A                    		db 0Dh, 0Ah
  1208                                  ; 05/11/2023	
  1209 00001D1C 4E414D4241523A20        		db "NAMBAR: "
  1210 00001D24 303030306820            msgNamBar	db "0000h "
  1211 00001D2A 4E41424D4241523A20      		db "NABMBAR: "
  1212 00001D33 303030306820495251-     msgNabmBar	db "0000h IRQ: "
  1212 00001D3C 3A20               
  1213 00001D3E 3030                    msgIRQ		dw 3030h
  1214 00001D40 0D0A24                  		db 0Dh, 0Ah, "$"
  1215 00001D43 53616D706C65205261-     msgSampleRate	db "Sample Rate: "
  1215 00001D4C 74653A20           
  1216 00001D50 303030303020487A20-     msgHertz	db "00000 Hz ", "$" 
  1216 00001D59 24                 
  1217 00001D5A 3820626974732024        msg8Bits	db "8 bits ", "$" 
  1218 00001D62 4D6F6E6F0D0A24          msgMono		db "Mono", 0Dh, 0Ah, "$"
  1219 00001D69 313620626974732024      msg16Bits	db "16 bits ", "$" 
  1220 00001D72 53746572656F0D0A24      msgStereo	db "Stereo", 0Dh, 0Ah, "$"
  1221                                  
  1222                                  ;; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
  1223                                  ;codec_id	dd 0
  1224                                  ;codec_chip_id	dd 0
  1225                                  ;codec_vendor_ids dw 0
  1226                                  ;codec_chip_ids	dw 0
  1227                                  
  1228 00001D7B 3030303030303030        dword_str	 dd 30303030h, 30303030h
  1229 00001D83 680D0A00                		 db 'h', 0Dh, 0Ah, 0
  1230                                  
  1231                                  ;ac_unknown     db 'unknown manufacturer',13,10,0
  1232                                  ;ac_Realtek     db 'Realtek Semiconductor',13,10,0
  1233                                  ;ac_Analog      db 'Analog Devices',13,10,0
  1234                                  ;ac_CMedia      db 'C-Media Electronics',13,10,0
  1235                                  ;ac_Cirrus      db 'Cirrus Logic',13,10,0
  1236                                  ;ac_Wolfson     db 'Wolfson Microelectronics',13,10,0
  1237                                  ;ac_VIA         db 'VIA Technologies',13,10,0
  1238                                  ;ac_SigmaTel    db 'SigmaTel',13,10,0
  1239                                  ;ac_eMicro      db 'eMicro',13,10,0
  1240                                  ;
  1241                                  ;chip_unknown   db 'unknown codec id ', 0
  1242                                  
  1243                                  ;CHIP_REALTEK   equ 414C4700h
  1244                                  ;CHIP_CMEDIA    equ 434D4900h
  1245                                  ;CHIP_VIA       equ 56494100h
  1246                                  
  1247                                  ;codecs        dd CHIP_CMEDIA
  1248                                  ;	       dw ac_CMedia, chips_CMedia
  1249                                  ;              dd CHIP_REALTEK
  1250                                  ;	       dw ac_Realtek, chips_Realtek
  1251                                  ;              dd CHIP_VIA
  1252                                  ;	       dw ac_VIA, chips_VIA
  1253                                  ;              dd 0
  1254                                  
  1255                                  ;chips_Realtek dw 10h, chip_ALC201a
  1256                                  ;              dw 20h, chip_ALC650
  1257                                  ;              dw 21h, chip_ALC650D
  1258                                  ;              dw 22h, chip_ALC650E
  1259                                  ;              dw 23h, chip_ALC650F
  1260                                  ;              dw 60h, chip_ALC655
  1261                                  ;              dw 80h, chip_ALC658
  1262                                  ;              dw 81h, chip_ALC658D
  1263                                  ;              dw 90h, chip_ALC850
  1264                                  ;              dw 0FFh
  1265                                  
  1266                                  ;chips_CMedia  dw 41h, chip_CM9738
  1267                                  ;              dw 61h, chip_CM9739
  1268                                  ;              dw 69h, chip_CM9780
  1269                                  ;              dw 78h, chip_CM9761
  1270                                  ;              dw 82h, chip_CM9761
  1271                                  ;              dw 83h, chip_CM9761
  1272                                  ;              dw 0FFh
  1273                                  
  1274                                  ;chips_VIA     dw 61h, chip_VIA1612A
  1275                                  ;              dw 0FFh
  1276                                  
  1277                                  ;Realtek
  1278                                  ;chip_ALC201a    db 'ALC201a',0dh,0ah,00h
  1279                                  ;chip_ALC650     db 'ALC650 ',0dh,0ah,00h
  1280                                  ;chip_ALC650D    db 'ALC650D',0dh,0ah,00h
  1281                                  ;chip_ALC650E    db 'ALC650E',0dh,0ah,00h
  1282                                  ;chip_ALC650F    db 'ALC650F',0dh,0ah,00h
  1283                                  ;chip_ALC655     db 'ALC655 ',0dh,0ah,00h
  1284                                  ;chip_ALC658     db 'ALC658 ',0dh,0ah,00h
  1285                                  ;chip_ALC658D    db 'ALC658D',0dh,0ah,00h
  1286                                  ;chip_ALC850     db 'ALC850 ',0dh,0ah,00h
  1287                                  
  1288                                  ;CMedia
  1289                                  ;chip_CM9738     db 'CMI9738', 0dh,0ah,0
  1290                                  ;chip_CM9739     db 'CMI9739', 0dh,0ah,0
  1291                                  ;chip_CM9780     db 'CMI9780', 0dh,0ah,0
  1292                                  ;chip_CM9761     db 'CMI9761', 0dh,0ah,0
  1293                                  
  1294                                  ;VIA
  1295                                  ;chip_VIA1612A   db 'VIA1612A',13,10,0
  1296                                  
  1297                                  ; 11/11/2023
  1298                                  msg_init_err:
  1299 00001D87 0D0A                    	db	CR, LF
  1300 00001D89 4143393720436F6E74-     	db	"AC97 Controller/Codec initialization error !"
  1300 00001D92 726F6C6C65722F436F-
  1300 00001D9B 64656320696E697469-
  1300 00001DA4 616C697A6174696F6E-
  1300 00001DAD 206572726F722021   
  1301 00001DB5 0D0A24                  	db	CR, LF, "$"
  1302                                  
  1303                                  ; 12/11/2023
  1304                                  msg_no_vra:
  1305 00001DB8 0D0A                    	db	CR, LF
  1306 00001DBA 4E6F20565241207375-     	db	"No VRA support ! Only 48 kHZ sample rate supported !"
  1306 00001DC3 70706F72742021204F-
  1306 00001DCC 6E6C79203438206B48-
  1306 00001DD5 5A2073616D706C6520-
  1306 00001DDE 726174652073757070-
  1306 00001DE7 6F727465642021     
  1307 00001DEE 0D0A24                  	db	CR, LF, "$"
  1308                                  
  1309                                  ; 17/02/2017
  1310                                  bss_start:
  1311                                  
  1312                                  ABSOLUTE bss_start
  1313                                  
  1314 00001DF1 ??                      alignb 2
  1315                                  
  1316                                  ; 28/11/2016
  1317                                  
  1318 00001DF2 <res 1Ch>               smpRBuff:	resw 14 ; 19/11/2016 - Erdogan Tan
  1319                                  
  1320 00001E0E ????                    filehandle:	resw 1
  1321                                  
  1322 00001E10 ??                      flags:		resb 1
  1323                                  ; 06/11/2023
  1324 00001E11 ??                      ac97_int_ln_reg: resb 1
  1325                                  
  1326                                  ; 09/11/2023
  1327                                  ; 06/11/2023
  1328                                  ;pcm_irq_status: resb 1	; 05/11/2023
  1329 00001E12 ??                      inside:		resb 1
  1330 00001E13 ??                      tloop:		resb 1	; 10/11/2023
  1331                                  
  1332                                  ; 09/11/2023
  1333                                  ; 04/11/2023 - 06/11/2023
  1334 00001E14 ????                    IRQ_status:	resw 1	; IRQ status before enabling audio interrupt
  1335 00001E16 ????????                IRQ_vector:	resd 1  ; Previous interrupt handler address	
  1336                                  
  1337                                  ; 17/02/2017
  1338                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  1339                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  1340                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  1341                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  1342 00001E1A ????                    NAMBAR:		resw 1			; BAR for mixer
  1343 00001E1C ????                    NABMBAR:	resw 1			; BAR for bus master regs
  1344                                  
  1345                                  ; 256 byte buffer for descriptor list
  1346 00001E1E ????                    BDL_BUFFER:	resw 1			; segment of our 256byte BDL buffer
  1347 00001E20 ????                    WAV_BUFFER1:	resw 1			; segment of our WAV storage
  1348                                  ; 64k buffers for wav file storage
  1349 00001E22 ????                    WAV_BUFFER2:	resw 1			; segment of 2nd wav buffer
  1350                                  
  1351                                  ; 06/11/2023
  1352                                  ;tBuff:		resb 1
  1353                                  ;ac97_int_ln_reg: resb 1
  1354                                  
  1355                                  ; 12/11/2016 - Erdogan Tan
  1356                                  
  1357 00001E24 ????????                bus_dev_fn:	resd 1
  1358 00001E28 ????????                dev_vendor:	resd 1
  1359                                  ; 06/11/2023
  1360                                  ;stats_cmd:	resw 1 ; 17/02/2017
  1361                                  ; 05/11/2023
  1362                                  ;ac97_io_base:	resw 1
  1363 00001E2C ????                    sample_rate:	resw 1
  1364                                  
  1365                                  ; 19/11/2016
  1366 00001E2E ????                    stmo:		resw 1 
  1367 00001E30 ????                    bps:		resw 1
  1368                                  
  1369                                  ; 08/11/2023
  1370                                  ; 07/11/2023
  1371 00001E32 ??                      fbs_shift:	resb 1
  1372                                  ; 09/11/2023
  1373 00001E33 ??                      b_indicator:	resb 1
  1374                                  ; 10/11/2023
  1375 00001E34 ??                      LVI:		resb 1
  1376 00001E35 ??                      		resb 1 ; 10/11/2023 
  1377                                  
  1378                                  ;fbs_seg:	resw 1
  1379                                  ;fbs_off:	resw 1
  1380                                  
  1381                                  ;alignb 2
  1382                                  
  1383                                  ; 32 kilo bytes for temporay buffer
  1384                                  ; (for stereo-mono, 8bit/16bit corrections)
  1385                                  ;temp_buffer:	resb 32768
  1386                                  ; 18/11/2023
  1387 00001E36 <res DBF0h>             temp_buffer:	resb 56304  ; (44.1 kHZ stereo 14076 samples)	
  1388                                  
  1389                                  ;alignb 16
  1390                                  EOF:
