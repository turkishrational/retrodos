     1                                  ; ****************************************************************************
     2                                  ; PLAYWAV.ASM - ICH AC97 .wav player for DOS.			   PLAYWAV.COM
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; Last Update: 19/11/2023 (Previous: 18/11/2023)
     5                                  ; ----------------------------------------------------------------------------
     6                                  ; Beginning: 17/02/2017
     7                                  ; ----------------------------------------------------------------------------
     8                                  ; Assembler: NASM version 2.11 (2.15)
     9                                  ;	     nasm playwav.asm -l playwav.lst -o PLAYWAV.COM	
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Derived from '.wav file player for DOS' Jeff Leyda, Sep 02, 2002 
    12                                  ; ****************************************************************************
    13                                  ; Modidified from 'PLAYER.COM' for VIA VT8233 wav player source code by
    14                                  ; (PLAYER.ASM) by Erdogan Tan (07/11/2016 - 08/12/2016)
    15                                  
    16                                  ; AC97 interrupt version - 09/11/2023 - Erdogan Tan
    17                                  ; sample rate conversion version - 13/11/2023 - Erdogan Tan
    18                                  
    19                                  [BITS 16]
    20                                  
    21                                  [ORG 100h] 
    22                                  
    23                                  	%include 'ac97.inc' ; 17/02/2017
     1                              <1> ; 11/11/2023
     2                              <1> ; 05/11/2023
     3                              <1> ; 03/11/2023
     4                              <1> ; 17/02/2017 (Erdogan Tan, PLAYWAV.ASM)
     5                              <1> ; constant.inc & codec.inc (for ICH AC97 wav player, 'PLAYWAV.COM') 
     6                              <1> 
     7                              <1> ; ----------------------------------------------------------------------------
     8                              <1> ; CONSTANT.INC
     9                              <1> ; ----------------------------------------------------------------------------
    10                              <1> 
    11                              <1> ;constants of stuff that seem hard to remember at times.
    12                              <1> 
    13                              <1> TRUE  EQU 1
    14                              <1> FALSE EQU 0
    15                              <1> 
    16                              <1> ENABLED  EQU 1
    17                              <1> DISABLED EQU 0
    18                              <1> 
    19                              <1> BIT0  EQU 1
    20                              <1> BIT1  EQU 2
    21                              <1> BIT2  EQU 4
    22                              <1> BIT3  EQU 8
    23                              <1> BIT4  EQU 10h
    24                              <1> BIT5  EQU 20h
    25                              <1> BIT6  EQU 40h
    26                              <1> BIT7  EQU 80h
    27                              <1> BIT8  EQU 100h
    28                              <1> BIT9  EQU 200h
    29                              <1> BIT10 EQU 400h
    30                              <1> BIT11 EQU 800h
    31                              <1> BIT12 EQU 1000h
    32                              <1> BIT13 EQU 2000h
    33                              <1> BIT14 EQU 4000h
    34                              <1> BIT15 EQU 8000h
    35                              <1> BIT16 EQU 10000h
    36                              <1> BIT17 EQU 20000h
    37                              <1> BIT18 EQU 40000h
    38                              <1> BIT19 EQU 80000h
    39                              <1> BIT20 EQU 100000h
    40                              <1> BIT21 EQU 200000h
    41                              <1> BIT22 EQU 400000h
    42                              <1> BIT23 EQU 800000h
    43                              <1> BIT24 EQU 1000000h
    44                              <1> BIT25 EQU 2000000h
    45                              <1> BIT26 EQU 4000000h
    46                              <1> BIT27 EQU 8000000h
    47                              <1> BIT28 EQU 10000000h
    48                              <1> BIT29 EQU 20000000h
    49                              <1> BIT30 EQU 40000000h
    50                              <1> BIT31 EQU 80000000h
    51                              <1> 
    52                              <1> ;special characters
    53                              <1> NUL     EQU 0
    54                              <1> NULL    EQU 0
    55                              <1> BELL    EQU 07
    56                              <1> BS      EQU 08
    57                              <1> TAB     EQU 09
    58                              <1> LF      EQU 10
    59                              <1> CR      EQU 13
    60                              <1> ESCAPE  EQU 27           ;ESC is a reserved word....
    61                              <1> 
    62                              <1> 
    63                              <1> ;file stuff
    64                              <1> READONLY  EQU   BIT0
    65                              <1> HIDDEN    EQU   BIT1
    66                              <1> SYSTEM    EQU   BIT2
    67                              <1> VOLUME    EQU   BIT3         ;ignored for file access
    68                              <1> DIRECTORY EQU   BIT4         ;must be 0 for file access
    69                              <1> ARCHIVE   EQU   BIT5
    70                              <1> SHAREABLE EQU   BIT7         ;for novell networks
    71                              <1> OPEN	EQU	2		; open existing file
    72                              <1> CREATE	EQU	1		; create new file
    73                              <1> 
    74                              <1> 
    75                              <1> ; PCI equates
    76                              <1> ; PCI function address (PFA)
    77                              <1> ; bit 31 = 1
    78                              <1> ; bit 23:16 = bus number     (0-255)
    79                              <1> ; bit 15:11 = device number  (0-31)
    80                              <1> ; bit 10:8 = function number (0-7)
    81                              <1> ; bit 7:0 = register number  (0-255)
    82                              <1> 
    83                              <1> IO_ADDR_MASK    EQU     0FFFEh          ; mask off bit 0 for reading BARs
    84                              <1> PCI_INDEX_PORT  EQU     0CF8h
    85                              <1> PCI_DATA_PORT   EQU     0CFCh
    86                              <1> PCI32           EQU     BIT31           ; bitflag to signal 32bit access
    87                              <1> PCI16           EQU     BIT30           ; bitflag for 16bit access
    88                              <1> 
    89                              <1> PCI_FN0         EQU     0 << 8
    90                              <1> PCI_FN1         EQU     1 << 8
    91                              <1> PCI_FN2         EQU     2 << 8
    92                              <1> PCI_FN3         EQU     3 << 8
    93                              <1> PCI_FN4         EQU     4 << 8
    94                              <1> PCI_FN5         EQU     5 << 8
    95                              <1> PCI_FN6         EQU     6 << 8
    96                              <1> PCI_FN7         EQU     7 << 8
    97                              <1> 
    98                              <1> PCI_CMD_REG		EQU	04h		; reg 04, command reg
    99                              <1>  IO_ENA			EQU	BIT0		; i/o decode enable
   100                              <1>  MEM_ENA		EQU	BIT1		; memory decode enable
   101                              <1>  BM_ENA                 EQU     BIT2		; bus master enable
   102                              <1> 
   103                              <1> ; ----------------------------------------------------------------------------
   104                              <1> ; CODEC.INC
   105                              <1> ; ----------------------------------------------------------------------------
   106                              <1> 
   107                              <1> ;Codec registers.
   108                              <1> ;
   109                              <1> ;Not all codecs are created equal. Refer to the spec for your specific codec.
   110                              <1> ;
   111                              <1> ;All registers are 16bits wide.  Access to codec registers over the AC97 link
   112                              <1> ;is defined by the OEM.  
   113                              <1> ;
   114                              <1> ;Secondary codec's are accessed by ORing in BIT7 of all register accesses.
   115                              <1> ;
   116                              <1> 
   117                              <1> ; each codec/mixer register is 16bits
   118                              <1> 
   119                              <1> CODEC_RESET_REG                 equ     00      ; reset codec
   120                              <1> CODEC_MASTER_VOL_REG            equ     02      ; master volume
   121                              <1> CODEC_HP_VOL_REG                equ     04      ; headphone volume
   122                              <1> CODEC_MASTER_MONO_VOL_REG       equ     06      ; master mono volume
   123                              <1> CODEC_MASTER_TONE_REG           equ     08      ; master tone (R+L)
   124                              <1> CODEC_PCBEEP_VOL_REG            equ     0ah     ; PC beep volume
   125                              <1> CODEC_PHONE_VOL_REG             equ     0bh     ; phone volume
   126                              <1> CODEC_MIC_VOL_REG               equ     0eh     ; MIC volume
   127                              <1> CODEC_LINE_IN_VOL_REG           equ     10h     ; line input volume
   128                              <1> CODEC_CD_VOL_REG                equ     12h     ; CD volume
   129                              <1> CODEC_VID_VOL_REG               equ     14h     ; video volume
   130                              <1> CODEC_AUX_VOL_REG               equ     16h     ; aux volume
   131                              <1> CODEC_PCM_OUT_REG               equ     18h     ; PCM output volume
   132                              <1> CODEC_RECORD_SELECT_REG         equ     1ah     ; record select input
   133                              <1> CODEC_RECORD_VOL_REG            equ     1ch     ; record volume
   134                              <1> CODEC_RECORD_MIC_VOL_REG        equ     1eh     ; record mic volume
   135                              <1> CODEC_GP_REG                    equ     20h     ; general purpose
   136                              <1> CODEC_3D_CONTROL_REG            equ     22h     ; 3D control
   137                              <1> ; 24h is reserved
   138                              <1> CODEC_POWER_CTRL_REG            equ     26h     ; powerdown control
   139                              <1> CODEC_EXT_AUDIO_REG             equ     28h     ; extended audio
   140                              <1> CODEC_EXT_AUDIO_CTRL_REG        equ     2ah     ; extended audio control
   141                              <1> CODEC_PCM_FRONT_DACRATE_REG     equ     2ch     ; PCM out sample rate
   142                              <1> CODEC_PCM_SURND_DACRATE_REG     equ     2eh     ; surround sound sample rate
   143                              <1> CODEC_PCM_LFE_DACRATE_REG       equ     30h     ; LFE sample rate
   144                              <1> CODEC_LR_ADCRATE_REG            equ     32h     ; PCM in sample rate
   145                              <1> CODEC_MIC_ADCRATE_REG           equ     34h     ; mic in sample rate
   146                              <1> 
   147                              <1> ; registers 36-7a are reserved on the ICH
   148                              <1> 
   149                              <1> CODEC_VENDORID1_REG             equ     7ch     ; codec vendor ID 1
   150                              <1> CODEC_VENDORID2_REG             equ     7eh     ; codec vendor ID 2
   151                              <1> 
   152                              <1> ; Mixer registers 0 through 51h reside in the ICH and are not forwarded over
   153                              <1> ; the AC97 link to the codec, which I think is a little weird.  Looks like
   154                              <1> ; the ICH makes it so you don't need a fully functional codec to play audio?
   155                              <1> ;
   156                              <1> ; whenever 2 codecs are present in the system, use BIT7 to access the 2nd
   157                              <1> ; set of registers, ie 80h-feh
   158                              <1> 
   159                              <1> PRIMARY_CODEC                   equ     0       ; 0-7F for primary codec
   160                              <1> SECONDARY_CODEC                 equ     BIT7    ; 80-8f registers for 2ndary
   161                              <1> 
   162                              <1> SAMPLE_RATE_441khz	equ     44100   ; 44.1Khz (cd quality) rate
   163                              <1> 
   164                              <1> ; ----------------------------------------------------------------------------
   165                              <1> ; 17/02/2017
   166                              <1> PCI_IO_BASE	equ 10h			; = NAMBAR register offset
   167                              <1> AC97_INT_LINE   equ 3Ch			; AC97 Interrupt Line register offset
   168                              <1> 
   169                              <1> ; ----------------------------------------------------------------------------
   170                              <1> ; ICH2AC97.INC
   171                              <1> ; ----------------------------------------------------------------------------
   172                              <1> 
   173                              <1> ; PCI stuff
   174                              <1> 
   175                              <1> ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
   176                              <1> 
   177                              <1> INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
   178                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   179                              <1> SIS_VID		equ	1039h
   180                              <1> NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
   181                              <1> AMD_VID		equ	1022h
   182                              <1> 
   183                              <1> ICH_DID         equ     2415h           ; ICH device ID
   184                              <1> ICH0_DID        equ     2425h           ; ICH0
   185                              <1> ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
   186                              <1>                                         ; they all should be compatible.
   187                              <1> 
   188                              <1> ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
   189                              <1> ICH3_DID	equ     2485h           ; ICH3
   190                              <1> ICH4_DID        equ     24C5h           ; ICH4
   191                              <1> ICH5_DID	equ     24D5h           ; ICH5 
   192                              <1> ICH6_DID	equ     266Eh           ; ICH6
   193                              <1> ESB6300_DID	equ     25A6h           ; 6300ESB
   194                              <1> ESB631X_DID	equ     2698h           ; 631XESB
   195                              <1> ICH7_DID	equ	27DEh		; ICH7
   196                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   197                              <1> MX82440_DID	equ	7195h
   198                              <1> SI7012_DID	equ	7012h
   199                              <1> NFORCE_DID	equ	01B1h
   200                              <1> NFORCE2_DID	equ	006Ah
   201                              <1> AMD8111_DID	equ	746Dh
   202                              <1> AMD768_DID	equ	7445h
   203                              <1> ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
   204                              <1> CK804_DID	equ	0059h
   205                              <1> MCP04_DID	equ	003Ah
   206                              <1> CK8_DID		equ	008Ah
   207                              <1> NFORCE3_DID	equ	00DAh
   208                              <1> CK8S_DID	equ	00EAh
   209                              <1> 
   210                              <1> NAMBAR_REG      equ     10h             ; native audio mixer BAR
   211                              <1>  NAM_SIZE       equ     256             ; 256 bytes required.
   212                              <1> 
   213                              <1> NABMBAR_REG     equ     14h             ; native audio bus mastering BAR
   214                              <1>  NABM_SIZE      equ     64              ; 64 bytes
   215                              <1> 
   216                              <1> ; BUS master registers, accessed via NABMBAR+offset
   217                              <1> 
   218                              <1> ; ICH supports 3 different types of register sets for three types of things
   219                              <1> ; it can do, thus:
   220                              <1> ;
   221                              <1> ; PCM in (for recording) aka PI
   222                              <1> ; PCM out (for playback) aka PO
   223                              <1> ; MIC in (for recording) aka MC
   224                              <1> 
   225                              <1> PI_BDBAR_REG            equ     0       ; PCM in buffer descriptor BAR
   226                              <1> PO_BDBAR_REG            equ     10h     ; PCM out buffer descriptor BAR
   227                              <1> MC_BDBAR_REG            equ     20h     ; MIC in buffer descriptor BAR
   228                              <1> 
   229                              <1> ; each buffer descriptor BAR holds a pointer which has entries to the buffer
   230                              <1> ; contents of the .WAV file we're going to play. Each entry is 8 bytes long
   231                              <1> ; (more on that later) and can contain 32 entries total, so each BAR is
   232                              <1> ; 256 bytes in length, thus:
   233                              <1> 
   234                              <1> BDL_SIZE                equ     32*8    ; Buffer Descriptor List size
   235                              <1> INDEX_MASK              equ     31      ; indexes must be 0-31
   236                              <1> 
   237                              <1> 
   238                              <1> 
   239                              <1> PI_CIV_REG              equ     4       ; PCM in current Index value (RO)
   240                              <1> PO_CIV_REG              equ     14h     ; PCM out current Index value (RO)
   241                              <1> MC_CIV_REG              equ     24h     ; MIC in current Index value (RO)
   242                              <1> ;8bit read only
   243                              <1> ; each current index value is simply a pointer showing us which buffer
   244                              <1> ; (0-31) the codec is currently processing. Once this counter hits 31, it
   245                              <1> ; wraps back to 0.
   246                              <1> ; this can be handy to know, as once it hits 31, we're almost out of data to
   247                              <1> ; play back or room to record!
   248                              <1> 
   249                              <1> 
   250                              <1> PI_LVI_REG              equ     5       ; PCM in Last Valid Index
   251                              <1> PO_LVI_REG              equ     15h     ; PCM out Last Valid Index
   252                              <1> MC_LVI_REG              equ     25h     ; MIC in Last Valid Index
   253                              <1> ;8bit read/write
   254                              <1> ; The Last Valid Index is a number (0-31) to let the codec know what buffer
   255                              <1> ; number to stop on after processing. It could be very nasty to play audio
   256                              <1> ; from buffers that aren't filled with the audio we want to play.
   257                              <1> 
   258                              <1> 
   259                              <1> PI_SR_REG               equ     6       ; PCM in Status register
   260                              <1> PO_SR_REG               equ     16h     ; PCM out Status register
   261                              <1> MC_SR_REG               equ     26h     ; MIC in Status register
   262                              <1> ;16bit read/write
   263                              <1> ; status registers.  Bitfields follow:
   264                              <1> 
   265                              <1> FIFO_ERR                equ     BIT4    ; FIFO Over/Underrun W1TC.
   266                              <1> 
   267                              <1> BCIS                    equ     BIT3    ; buffer completion interrupt status.
   268                              <1>                                         ; Set whenever the last sample in ANY
   269                              <1>                                         ; buffer is finished.  Bit is only
   270                              <1>                                         ; set when the Interrupt on Complete
   271                              <1>                                         ; (BIT4 of control reg) is set.
   272                              <1> 
   273                              <1> LVBCI                   equ     BIT2    ; Set whenever the codec has processed
   274                              <1>                                         ; the last buffer in the buffer list.
   275                              <1>                                         ; Will fire an interrupt if IOC bit is
   276                              <1>                                         ; set. Probably set after the last
   277                              <1>                                         ; sample in the last buffer is
   278                              <1>                                         ; processed.  W1TC
   279                              <1> 
   280                              <1>                                         ; 
   281                              <1> CELV                    equ     BIT1    ; Current buffer == last valid.
   282                              <1>                                         ; Bit is RO and remains set until LVI is
   283                              <1>                                         ; cleared.  Probably set up the start
   284                              <1>                                         ; of processing for the last buffer.
   285                              <1> 
   286                              <1> 
   287                              <1> DCH                     equ     BIT0    ; DMA controller halted.
   288                              <1>                                         ; set whenever audio stream is stopped
   289                              <1>                                         ; or something else goes wrong.
   290                              <1> 
   291                              <1> 
   292                              <1> PI_PICB_REG             equ     8       ; PCM in position in current buffer(RO)
   293                              <1> PO_PICB_REG             equ     18h     ; PCM out position in current buffer(RO)
   294                              <1> MC_PICB_REG             equ     28h     ; MIC in position in current buffer (RO)
   295                              <1> ;16bit read only
   296                              <1> ; position in current buffer regs show the number of dwords left to be
   297                              <1> ; processed in the current buffer.
   298                              <1> ; 
   299                              <1> 
   300                              <1> PI_PIV_REG              equ     0ah     ; PCM in Prefected index value
   301                              <1> PO_PIV_REG              equ     1ah     ; PCM out Prefected index value
   302                              <1> MC_PIV_REG              equ     2ah     ; MIC in Prefected index value
   303                              <1> ;8bit, read only
   304                              <1> ; Prefetched index value register.
   305                              <1> ; tells which buffer number (0-31) has be prefetched. I'd imagine this
   306                              <1> ; value follows the current index value fairly closely. (CIV+1)
   307                              <1> ;
   308                              <1> 
   309                              <1> 
   310                              <1> PI_CR_REG               equ     0bh     ; PCM in Control Register
   311                              <1> PO_CR_REG               equ     1bh     ; PCM out Control Register
   312                              <1> MC_CR_REG               equ     2bh     ; MIC in Control Register
   313                              <1> ; 8bit
   314                              <1> ; Control register *MUST* only be accessed as an 8bit value.
   315                              <1> ; Control register. See bitfields below.
   316                              <1> ;
   317                              <1> 
   318                              <1> 
   319                              <1> IOCE                    equ     BIT4    ; interrupt on complete enable.
   320                              <1>                                         ; set this bit if you want an intrtpt
   321                              <1>                                         ; to fire whenever LVBCI is set.
   322                              <1> FEIFE                   equ     BIT3    ; set if you want an interrupt to fire
   323                              <1>                                         ; whenever there is a FIFO (over or
   324                              <1>                                         ; under) error.
   325                              <1> LVBIE                   equ     BIT2    ; last valid buffer interrupt enable.
   326                              <1>                                         ; set if you want an interrupt to fire
   327                              <1>                                         ; whenever the completion of the last
   328                              <1>                                         ; valid buffer.
   329                              <1> RR                      equ     BIT1    ; reset registers.  Nukes all regs
   330                              <1>                                         ; except bits 4:2 of this register.
   331                              <1>                                         ; Only set this bit if BIT 0 is 0
   332                              <1> RPBM                    equ     BIT0    ; Run/Pause
   333                              <1>                                         ; set this bit to start the codec!
   334                              <1> 
   335                              <1> 
   336                              <1> GLOB_CNT_REG            equ     2ch     ; Global control register
   337                              <1> SEC_RES_EN              equ     BIT5    ; secondary codec resume event 
   338                              <1>                                         ; interrupt enable.  Not used here.
   339                              <1> PRI_RES_EN              equ     BIT4    ; ditto for primary. Not used here.
   340                              <1> ACLINK_OFF              equ     BIT3    ; Turn off the AC97 link
   341                              <1> ACWARM_RESET            equ     BIT2    ; Awaken the AC97 link from sleep.
   342                              <1>                                         ; registers preserved, bit self clears
   343                              <1> ACCOLD_RESET            equ     BIT1    ; Reset everything in the AC97 and
   344                              <1>                                         ; reset all registers.  Not self clearing
   345                              <1> 
   346                              <1> GPIIE                   equ     BIT0    ; GPI Interrupt enable.
   347                              <1>                                         ; set if you want an interrupt to
   348                              <1>                                         ; fire upon ANY of the bits in the
   349                              <1>                                         ; GPI (general pursose inputs?) not used.
   350                              <1> 
   351                              <1> GLOB_STS_REG            equ     30h     ; Global Status register (RO)
   352                              <1> 
   353                              <1> MD3                     equ     BIT17   ; modem powerdown status (yawn)
   354                              <1> AD3                     equ     BIT16   ; Audio powerdown status (yawn)
   355                              <1> RD_COMPLETE_STS         equ     BIT15   ; Codec read timed out. 0=normal
   356                              <1> BIT3SLOT12              equ     BIT14   ; shadowed status of bit 3 in slot 12
   357                              <1> BIT2SLOT12              equ     BIT13   ; shadowed status of bit 2 in slot 12
   358                              <1> BIT1SLOT12              equ     BIT12   ; shadowed status of bit 1 in slot 12
   359                              <1> SEC_RESUME_STS          equ     BIT11   ; secondary codec has resumed (and irqed)
   360                              <1> PRI_RESUME_STS          equ     BIT10   ; primary codec has resumed (and irqed)
   361                              <1> SEC_CODEC_RDY           equ     BIT9    ; secondary codec is ready for action
   362                              <1> PRI_CODEC_RDY           equ     BIT8    ; Primary codec is ready for action
   363                              <1>                                         ; software must check these bits before
   364                              <1>                                         ; starting the codec!
   365                              <1> MIC_IN_IRQ              equ     BIT7    ; MIC in caused an interrupt
   366                              <1> PCM_OUT_IRQ             equ     BIT6    ; One of the PCM out channels IRQed
   367                              <1> PCM_IN_IRQ              equ     BIT5    ; One of the PCM in channels IRQed
   368                              <1> MODEM_OUT_IRQ           equ     BIT2    ; modem out channel IRQed
   369                              <1> MODEM_IN_IRQ            equ     BIT1    ; modem in channel IRQed
   370                              <1> GPI_STS_CHANGE          equ     BIT0    ; set whenever GPI's have changed.
   371                              <1>                                         ; BIT0 of slot 12 also reflects this.
   372                              <1> 
   373                              <1> ACC_SEMA_REG            equ     34h     ; Codec write semiphore register
   374                              <1> CODEC_BUSY              equ     BIT0    ; codec register I/O is happening
   375                              <1>                                         ; self clearing
   376                              <1> ;
   377                              <1> ; Buffer Descriptors List
   378                              <1> ; As stated earlier, each buffer descriptor list is a set of (up to) 32 
   379                              <1> ; descriptors, each 8 bytes in length. Bytes 0-3 of a descriptor entry point
   380                              <1> ; to a chunk of memory to either play from or record to. Bytes 4-7 of an
   381                              <1> ; entry describe various control things detailed below.
   382                              <1> ; 
   383                              <1> ; Buffer pointers must always be aligned on a Dword boundry.
   384                              <1> ;
   385                              <1> 
   386                              <1> IOC                     equ     BIT31   ; Fire an interrupt whenever this
   387                              <1>                                         ; buffer is complete.
   388                              <1> 
   389                              <1> BUP                     equ     BIT30   ; Buffer Underrun Policy.
   390                              <1>                                         ; if this buffer is the last buffer
   391                              <1>                                         ; in a playback, fill the remaining
   392                              <1>                                         ; samples with 0 (silence) or not.
   393                              <1>                                         ; It's a good idea to set this to 1
   394                              <1>                                         ; for the last buffer in playback,
   395                              <1>                                         ; otherwise you're likely to get a lot
   396                              <1>                                         ; of noise at the end of the sound.
   397                              <1> 
   398                              <1> ;
   399                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   400                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   401                              <1> ; Luckily for us, that's the same format as .wav files.
   402                              <1> ;
   403                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   404                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   405                              <1> ;
   406                              <1> ; A value of 0 in these bits means play no samples.
   407                              <1> ;
   408                              <1> 
   409                              <1> ; 11/11/2023
   410                              <1> CTRL_ST_CREADY		equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
   411                              <1> CODEC_REG_POWERDOWN	equ	26h
    24                                  
    25                                  _STARTUP:
    26                                  
    27                                  ; memory allocation
    28                                  
    29 00000000 E85D01                          call    setFree				; deallocate unused DOS mem
    30                                  
    31                                  	; 17/02/2017
    32                                  	; Clear BSS (uninitialized data) area
    33 00000003 31C0                    	xor	ax, ax ; 0
    34 00000005 B91A6E                  	mov	cx, (EOF - bss_start)/2
    35 00000008 BF[AA1D]                	mov	di, bss_start
    36 0000000B F3AB                    	rep	stosw
    37                                  
    38                                  ; allocate 256 bytes of data for DCM_OUT Buffer Descriptor List. (BDL)
    39                                  
    40 0000000D B81000                          mov     ax, BDL_SIZE / 16
    41 00000010 E85501                          call    memAlloc
    42 00000013 A3[D61D]                        mov     [BDL_BUFFER], ax		; segment 
    43                                  
    44                                  ; allocate 2 buffers, 64k each for now.
    45                                  
    46 00000016 B80010                          mov     ax, BUFFERSIZE / 16		; 64k for .WAV file
    47 00000019 E84C01                          call    memAlloc
    48 0000001C A3[D81D]                        mov     [WAV_BUFFER1], ax		; segment
    49                                  
    50 0000001F B80010                  	mov	ax, BUFFERSIZE / 16
    51 00000022 E84301                  	call	memAlloc
    52 00000025 A3[DA1D]                	mov	[WAV_BUFFER2], ax
    53                                  
    54                                  ; Detect/reset AC97 
    55                                  
    56 00000028 E8B002                          call    pciFindDevice
    57 0000002B 7342                            jnc     short _1
    58                                  
    59                                  ; couldn't find the audio device!
    60                                  
    61 0000002D 0E                      	push	cs
    62 0000002E 1F                      	pop	ds
    63 0000002F BA[3900]                        mov     dx, noDevMsg
    64 00000032 B409                            mov     ah, 9
    65 00000034 CD21                            int     21h
    66 00000036 E91701                          jmp     exit
    67                                  
    68                                  ; 17/02/2017
    69 00000039 4572726F723A20556E-     noDevMsg: db "Error: Unable to find intel ICH based audio device!",CR,LF,"$"
    69 00000042 61626C6520746F2066-
    69 0000004B 696E6420696E74656C-
    69 00000054 204943482062617365-
    69 0000005D 6420617564696F2064-
    69 00000066 6576696365210D0A24 
    70                                  
    71                                  _1:
    72                                  	; eax = BUS/DEV/FN
    73                                  	;	00000000BBBBBBBBDDDDDFFF00000000
    74                                  	; edx = DEV/VENDOR
    75                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
    76                                  
    77 0000006F 66A3[DC1D]              	mov	[bus_dev_fn], eax
    78 00000073 668916[E01D]            	mov	[dev_vendor], edx
    79                                  
    80                                  	; get ICH base address regs for mixer and bus master
    81                                  
    82 00000078 B010                            mov     al, NAMBAR_REG
    83 0000007A E8D001                          call    pciRegRead16			; read PCI registers 10-11
    84 0000007D 83E2FE                          and     dx, IO_ADDR_MASK 		; mask off BIT0
    85                                  
    86 00000080 8916[D21D]                      mov     [NAMBAR], dx			; save audio mixer base addy
    87                                  
    88 00000084 B014                    	mov     al, NABMBAR_REG
    89 00000086 E8C401                          call    pciRegRead16
    90 00000089 83E2FE                          and     dx, IO_ADDR_MASK
    91                                  
    92 0000008C 8916[D41D]                      mov     [NABMBAR], dx			; save bus master base addy
    93                                  
    94                                  	; 06/11/2023
    95                                  	;; init controller
    96                                  	;; 17/02/2017
    97                                  	;mov	al, PCI_CMD_REG ; command register (04h)
    98                                  	;call	pciRegRead16 ; pciRegRead8
    99                                  	;
   100                                  	;; eax = BUS/DEV/FN/REG
   101                                  	;;  dx = PCI Command Register Content ; 17/02/2017
   102                                  	;; 	00000000CCCCCCCC
   103                                  	;mov	[stats_cmd], dx
   104                                  	;
   105                                  	; 06/11/2023
   106                                  	;mov	al, PCI_IO_BASE ; IO base address register (10h)
   107                                  	;call	pciRegRead32
   108                                  	;
   109                                  	;and	dx, 0FFC0h	; IO_ADDR_MASK (0FFFE) ?
   110                                          ;mov	[ac97_io_base], dx
   111                                  
   112 00000090 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
   113 00000092 E8B001                  	call	pciRegRead8 ; 17/02/2017
   114                                  
   115 00000095 8816[C91D]              	mov     [ac97_int_ln_reg], dl
   116                                  
   117                                  ; 09/11/2023
   118                                  ; 05/11/2023
   119                                  %if 1
   120                                  	; 28/11/2016
   121 00000099 BB0100                  	mov	bx, 1
   122 0000009C 30F6                    	xor	dh, dh 	 ; 17/02/2017
   123                                  	; 10/11/2023
   124                                  	;mov	cx, dx
   125                                  	;shl	bx, cl
   126                                  
   127                                  	; 04/11/2023
   128 0000009E FA                      	cli
   129                                  
   130                                  	;not	bx
   131 0000009F E4A1                    	in	al, 0A1h ; irq 8-15
   132 000000A1 88C4                            mov	ah, al
   133 000000A3 E421                            in	al, 21h  ; irq 0-7 
   134                                  
   135                                  	; 04/11/2023
   136                                  	; save IRQ status
   137 000000A5 A3[CC1D]                	mov	[IRQ_status], ax
   138                                  
   139                                  	;and	ax, bx   ; unmask
   140 000000A8 0FB3D0                   	btr	ax, dx	 ; unmask
   141 000000AB E621                    	out	21h, al  ; enable interrupt (if irq <= 7)
   142 000000AD 88E0                    	mov	al, ah
   143 000000AF E6A1                    	out	0A1h, al ; enable interrupt (if irq > 7)
   144                                  	;not	bx
   145                                  
   146                                  	; 04/11/2023
   147                                  	;mov	dx, 4D1h			;8259 ELCR1
   148                                          ;in	al, dx
   149                                  	;mov	ah, al
   150                                  	;mov	dx, 4D0h 
   151                                          ;in	al, dx
   152                                  	;;or	ax, bx        
   153                                  	;bts	ax, cx
   154                                  	;mov	dx, 4D0h
   155                                  	;out	dx, al                          ;set level-triggered mode
   156                                  	;mov	al, ah
   157                                  	;mov	dx, 4D1h
   158                                  	;out	dx, al                          ;set level-triggered mode
   159                                  
   160                                  	; 24/11/2016 - Erdogan Tan
   161                                  	;mov	bx, cx
   162                                  	; 10/11/2023
   163 000000B1 89D3                    	mov	bx, dx
   164 000000B3 8A9F[F51B]              	mov	bl, [bx+irq_int]
   165 000000B7 C1E302                  	shl	bx, 2 ; * 4
   166                                  
   167                                  	; set up interrupt vector
   168                                  	; 30/11/2016
   169 000000BA 06                      	push	es
   170 000000BB 31C0                    	xor	ax, ax
   171 000000BD 8EC0                    	mov	es, ax
   172                                  	; 04/11/2023
   173                                  	; save interrupt vector
   174 000000BF 268B07                  	mov	ax, [es:bx]
   175 000000C2 A3[CE1D]                	mov	[IRQ_vector], ax
   176 000000C5 268B4702                	mov	ax, [es:bx+2]
   177 000000C9 A3[D01D]                	mov	[IRQ_vector+2], ax
   178                                  
   179 000000CC 26C707[441B]            	mov	word [es:bx], ac97_int_handler
   180 000000D1 8CC8                    	mov	ax, cs
   181 000000D3 26894702                	mov	[es:bx+2], ax
   182 000000D7 07                      	pop	es
   183                                  
   184                                  	; 04/11/2023
   185 000000D8 FB                      	sti
   186                                  
   187                                  %endif
   188 000000D9 E8B518                  	call	write_ac97_dev_info 
   189                                  
   190                                  ; check the command line for a file to play
   191                                  
   192                                          ;push	ds
   193 000000DC E89200                          call    processCmdline			; get the filename
   194                                  
   195                                  ; open the file
   196 000000DF B002                            mov     al, OPEN                        ; open existing file
   197 000000E1 E8AD00                          call    openFile                        ; no error? ok.
   198                                          ;pop	ds
   199 000000E4 7322                            jnc     short _gsr
   200                                  
   201                                  ; file not found!
   202                                  
   203                                          ;push   cs
   204                                          ;pop    ds
   205 000000E6 BA[EF00]                        mov	dx, noFileErrMsg
   206 000000E9 B409                            mov     ah, 9
   207 000000EB CD21                            int     21h
   208 000000ED EB61                            jmp     exit
   209                                  
   210                                  noFileErrMsg:
   211 000000EF 4572726F723A206669-     	db "Error: file not found.",CR,LF,"$"
   211 000000F8 6C65206E6F7420666F-
   211 00000101 756E642E0D0A24     
   212                                  
   213                                  _gsr:
   214 00000108 E8AD00                          call    getSampleRate                   ; read the sample rate
   215                                                                                  ; pass it onto codec.
   216 0000010B 7243                    	jc	short exit ; 19/11/2016 - nothing to do
   217                                  
   218 0000010D A3[E41D]                	mov	[sample_rate], ax
   219                                  	
   220                                  	; 19/11/2016
   221 00000110 880E[E61D]              	mov	[stmo], cl
   222 00000114 8816[E81D]              	mov	[bps], dl
   223                                  	
   224                                  	; 17/02/2017
   225 00000118 C606[EA1D]00            	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit 
   226 0000011D FEC9                    	dec	cl
   227 0000011F 7504                    	jnz	short _gsr_1 ; stereo
   228 00000121 FE06[EA1D]              	inc	byte [fbs_shift] ; 1 = mono or 8 bit		
   229                                  _gsr_1:	
   230 00000125 80FA08                  	cmp	dl, 8 
   231 00000128 7704                    	ja	short _gsr_2 ; 16 bit samples
   232 0000012A FE06[EA1D]              	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   233                                  _gsr_2:	
   234 0000012E E8C219                  	call	write_sample_rate
   235                                  
   236                                  	; 05/11/2023
   237                                  _2:
   238 00000131 E82A07                  	call	check4keyboardstop  ; flush keyboard buffer
   239 00000134 72FB                    	jc	short _2 	; 07/11/2023
   240                                  
   241                                  	; 09/11/2023
   242                                  	;; 05/11/2023
   243                                  	;mov	eax, [bus_dev_fn]
   244                                  	;mov	al, PCI_CMD_REG
   245                                  	;call	pciRegRead16			; read PCI command register
   246                                  	;; 17/02/2017
   247                                  	;;mov	dx, [stats_cmd]
   248                                          ;or	dl, IO_ENA+BM_ENA               ; enable IO and bus master
   249                                  	;call	pciRegWrite16 ; pciRegWrite8
   250                                  
   251                                  	;; 06/11/2023
   252                                  	;;mov	eax, [bus_dev_fn]
   253                                  	;;mov	al, PCI_CMD_REG
   254                                  	;;call	pciRegRead8                     ; read PCI command register
   255                                  	;;or	dl, IO_ENA+BM_ENA               ; enable IO and bus master
   256                                  	;;call	pciRegWrite8
   257                                  
   258                                  ; setup the Codec (actually mixer registers) 
   259 00000136 E8E401                          call    codecConfig                     ; unmute codec, set rates.
   260                                  	; 11/11/2023
   261 00000139 721C                    	jc	short init_err
   262                                  ;
   263                                  ; position file pointer to start in actual wav data
   264                                  ; MUCH improvement should really be done here to check if sample size is
   265                                  ; supported, make sure there are 2 channels, etc.  
   266                                  ;
   267 0000013B B442                            mov     ah, 42h
   268 0000013D B000                            mov     al, 0                           ; from start of file
   269 0000013F 8B1E[C61D]                      mov     bx, [filehandle]
   270 00000143 31C9                            xor     cx, cx
   271 00000145 BA2C00                          mov     dx, 44                          ; jump past .wav/riff header
   272 00000148 CD21                            int     21h
   273                                  
   274                                  ; play the .wav file. Most of the good stuff is in here.
   275                                  
   276 0000014A E86403                          call    playWav
   277                                  
   278                                  ; close the .wav file and exit.
   279                                  
   280                                  close_exit:			; 11/11/2023
   281 0000014D E85300                          call    closeFile
   282                                  
   283                                  exit:
   284 00000150 B8004C                          mov     ax, 4c00h
   285 00000153 CD21                    	int 	21h
   286                                  
   287                                  here:
   288 00000155 EBFE                    	jmp	short here
   289                                  
   290                                  	; 11/11/2023
   291                                  init_err:
   292 00000157 BA[401D]                	mov	dx, msg_init_err
   293                                  vra_err: ; 12/11/2023
   294 0000015A B409                            mov	ah, 9
   295 0000015C CD21                            int	21h
   296 0000015E EBED                    	jmp	short close_exit
   297                                  
   298                                  ; MEMALLOC.ASM
   299                                  ;-- SETFREE: Release memory not used  ----------------
   300                                  ;-- Input    : ES = address of PSP
   301                                  ;-- Output   : none
   302                                  ;-- Register : AX, BX, CL and FLAGS are changed 
   303                                  ;-- Info     : Since the stack-segment is always the last segment in an 
   304                                  ;              EXE-file, ES:0000 points to the beginning and SS:SP
   305                                  ;              to the end of the program in memory. Through this the
   306                                  ;              length of the program can be calculated 
   307                                  ; call this routine once at the beginning of the program to free up memory
   308                                  ; assigned to it by DOS.
   309                                  
   310                                  setFree:
   311 00000160 BB0010                  	  mov	bx, 65536/16	; 4K paragraphs ; 17/02/2017 (Erdogan Tan)		
   312                                  
   313 00000163 B44A                              mov	ah, 4ah		; pass new length to DOS
   314 00000165 CD21                              int	21h
   315                                  
   316 00000167 C3                                retn			; back to caller 
   317                                  				; new size (allocated memory) = 64KB
   318                                  
   319                                  memAlloc:
   320                                  ; input: AX = # of paragraphs required
   321                                  ; output: AX = segment of block to use
   322                                  
   323 00000168 53                      	push	bx
   324 00000169 89C3                    	mov	bx, ax
   325 0000016B B448                    	mov	ah, 48h
   326 0000016D CD21                    	int	21h
   327 0000016F 5B                      	pop	bx
   328 00000170 C3                      	retn
   329                                  
   330                                  ; CMDLINE.ASM
   331                                  ; parse the command line
   332                                  ; entry: none
   333                                  ; exit: DS:DX to the 1st supplied item on the command line 
   334                                  
   335                                  processCmdline:
   336 00000171 53                              push    bx
   337 00000172 56                              push    si
   338                                  
   339                                          ;mov    ah, 51h
   340                                          ;int    21h
   341                                          ;mov    ds, bx
   342                                  
   343 00000173 BE8000                          mov     si, 80h
   344 00000176 0FB61C                          movzx   bx, byte [si]
   345 00000179 01DE                            add     si, bx
   346 0000017B 46                              inc     si
   347                                  
   348 0000017C C60400                          mov     byte [si], NULL         ; zero terminate
   349                                  
   350 0000017F BE8100                          mov     si, 81h
   351                                  
   352                                  cmdlineloop:
   353 00000182 AC                              lodsb
   354                                  
   355 00000183 3C00                            cmp     al, NULL                ; found end of line?
   356 00000185 7404                            je      short exitpc
   357 00000187 3C20                            cmp     al, ' '                 ; found a space?
   358 00000189 74F7                            je      short cmdlineloop
   359                                  
   360                                          ; must be the filename here.
   361                                  exitpc:
   362 0000018B 4E                              dec     si                      ; point to start of filename
   363 0000018C 89F2                            mov     dx, si
   364 0000018E 5E                              pop     si
   365 0000018F 5B                              pop     bx
   366 00000190 C3                      	retn
   367                                  
   368                                  ; FILE.ASM
   369                                  ;open or create file
   370                                  ;
   371                                  ;input: ds:dx-->filename (asciiz)
   372                                  ;       al=file Mode (create or open)
   373                                  ;output: none  cs:[filehandle] filled
   374                                  ;
   375                                  openFile:
   376 00000191 50                      	push	ax
   377 00000192 51                      	push	cx
   378 00000193 B43B                    	mov	ah, 3bh			; start with a mode
   379 00000195 00C4                    	add	ah, al			; add in create or open mode
   380 00000197 31C9                    	xor	cx, cx
   381 00000199 CD21                    	int	21h
   382 0000019B 7203                    	jc	short _of1
   383                                  	;mov	[cs:filehandle], ax
   384 0000019D A3[C61D]                	mov	[filehandle], ax
   385                                  _of1:
   386 000001A0 59                      	pop	cx
   387 000001A1 58                      	pop	ax
   388 000001A2 C3                      	retn
   389                                  
   390                                  ; close the currently open file
   391                                  ; input: none, uses cs:[filehandle]
   392                                  closeFile:
   393 000001A3 50                      	push	ax
   394 000001A4 53                      	push	bx
   395 000001A5 833E[C61D]FF            	cmp	word [filehandle], -1
   396 000001AA 7409                    	jz	short _cf1
   397 000001AC 8B1E[C61D]              	mov     bx, [filehandle]  
   398 000001B0 B8003E                  	mov     ax,3e00h
   399 000001B3 CD21                            int     21h              ;close file
   400                                  _cf1:
   401 000001B5 5B                      	pop	bx
   402 000001B6 58                      	pop	ax
   403 000001B7 C3                      	retn
   404                                  
   405                                  getSampleRate:
   406                                  	; 08/12/2016
   407                                  ; reads the sample rate from the .wav file.
   408                                  ; entry: none - assumes file is already open
   409                                  	; 19/11/2016 - Erdogan Tan
   410                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   411                                  ;	cx = number of channels (mono=1, stereo=2)
   412                                  ;	dx = bits per sample (8, 16)
   413                                  
   414 000001B8 53                      	push    bx
   415                                  
   416 000001B9 B442                            mov     ah, 42h
   417 000001BB B000                            mov     al, 0				; from start of file
   418 000001BD 8B1E[C61D]                      mov     bx, [filehandle]
   419 000001C1 31C9                            xor     cx, cx
   420 000001C3 BA0800                          mov     dx, 08h				; "WAVE"
   421 000001C6 CD21                            int     21h
   422                                  
   423 000001C8 BA[AA1D]                        mov     dx, smpRBuff
   424 000001CB B91C00                          mov     cx, 28				; 28 bytes
   425 000001CE B43F                    	mov	ah, 3fh
   426 000001D0 CD21                            int     21h
   427                                  
   428 000001D2 813E[AA1D]5741          	cmp	word [smpRBuff], 'WA'
   429 000001D8 751C                    	jne	short gsr_stc
   430                                  
   431 000001DA 813E[AC1D]5645          	cmp	word [smpRBuff+2], 'VE'
   432 000001E0 7514                    	jne	short gsr_stc
   433                                  
   434 000001E2 833E[B61D]01            	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   435 000001E7 750D                    	jne	short gsr_stc
   436                                  
   437                                  
   438 000001E9 8B0E[B81D]              	mov	cx, [smpRBuff+14]	; return num of channels in CX
   439 000001ED A1[BA1D]                        mov     ax, [smpRBuff+16]	; return sample rate in AX
   440 000001F0 8B16[C41D]              	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   441                                  gsr_retn:
   442 000001F4 5B                              pop     bx
   443 000001F5 C3                              retn
   444                                  
   445                                  gsr_stc:
   446 000001F6 F9                      	stc
   447 000001F7 EBFB                    	jmp	short gsr_retn
   448                                  
   449                                  ;%include 'ac97.asm' ; 29/11/2016 (AC97 codec configuration)
   450                                  %include 'ac97_vra.asm' ; 19/11/2023 (AC97 codec configuration)
     1                              <1> ; 19/11/2023 
     2                              <1> ;	(ready status optimization -in order to prevent wrong init error- )
     3                              <1> ; 18/11/2023
     4                              <1> ; 15/11/2023
     5                              <1> ; 13/11/2023
     6                              <1> ; 12/11/2023
     7                              <1> ; 11/11/2023
     8                              <1> ; 03/11/2023 - 06/11/2023
     9                              <1> ; PCI and AC97 codec functions for wav player
    10                              <1> ; Erdogan Tan (17/02/2017)
    11                              <1> 
    12                              <1> ; ----------------------------------------------------------------------------
    13                              <1> ; PCI.ASM
    14                              <1> ; ----------------------------------------------------------------------------
    15                              <1> 
    16                              <1> ; PCI device register reader/writers.
    17                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    18                              <1> ; 		Last Update: 17/02/2017
    19                              <1> 
    20                              <1> ;===============================================================
    21                              <1> ; 8/16/32bit PCI reader
    22                              <1> ;
    23                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    24                              <1> ;           BIT30 set if 32 bit access requested
    25                              <1> ;           BIT29 set if 16 bit access requested
    26                              <1> ;           otherwise defaults to 8 bit read
    27                              <1> ;
    28                              <1> ; Exit:  DL,DX,EDX register data depending on requested read size
    29                              <1> ;
    30                              <1> ; Note: this routine is meant to be called via pciRegRead8, pciRegread16,
    31                              <1> ;	or pciRegRead32, listed below.
    32                              <1> ;
    33                              <1> ; Note2: don't attempt to read 32bits of data from a non dword aligned reg
    34                              <1> ;	 number. Likewise, don't do 16bit reads from non word aligned reg #
    35                              <1> ; 
    36                              <1> pciRegRead:
    37 000001F9 6653                <1> 	push	ebx
    38 000001FB 51                  <1> 	push	cx
    39 000001FC 6689C3              <1>         mov     ebx, eax                        ; save eax, dh
    40 000001FF 88F1                <1>         mov     cl, dh
    41 00000201 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    42 00000207 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
    43 0000020D 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
    44                              <1> 
    45 0000020F BAF80C              <1>         mov     dx, PCI_INDEX_PORT
    46 00000212 66EF                <1>         out     dx, eax                         ; write PCI selector
    47                              <1> 
    48 00000214 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
    49 00000217 88D8                <1>         mov     al, bl
    50 00000219 2403                <1>         and     al, 3                           ; figure out which port to
    51 0000021B 00C2                <1>         add     dl, al                          ; read to
    52                              <1> 
    53 0000021D 66ED                <1> 	in      eax, dx                         ; do 32bit read
    54 0000021F 66F7C300000080      <1>         test    ebx, PCI32
    55 00000226 7403                <1>         jz      short _pregr1
    56                              <1> 
    57 00000228 6689C2              <1>         mov     edx, eax                        ; return 32bits of data
    58                              <1> _pregr1:
    59 0000022B 89C2                <1> 	mov     dx, ax                          ; return 16bits of data
    60 0000022D 66F7C3000000C0      <1>         test    ebx, PCI32+PCI16
    61 00000234 7502                <1>         jnz     short _pregr2
    62 00000236 88CE                <1>         mov     dh, cl                          ; restore dh for 8 bit read
    63                              <1> _pregr2:
    64 00000238 6689D8              <1>         mov     eax, ebx                        ; restore eax
    65 0000023B 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    66 00000241 59                  <1> 	pop	cx
    67 00000242 665B                <1> 	pop	ebx
    68 00000244 C3                  <1> 	retn
    69                              <1> 
    70                              <1> pciRegRead8:
    71 00000245 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32             ; set up 8 bit read size
    72 0000024B EBAC                <1>         jmp     short pciRegRead		; call generic PCI access
    73                              <1> 
    74                              <1> pciRegRead16:
    75 0000024D 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit read size
    76 00000253 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
    77 00000259 EB9E                <1>         jmp     short pciRegRead
    78                              <1> 
    79                              <1> pciRegRead32:
    80 0000025B 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit read size
    81 00000261 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
    82 00000267 EB90                <1>         jmp     short pciRegRead
    83                              <1> 
    84                              <1> ;===============================================================
    85                              <1> ; 8/16/32bit PCI writer
    86                              <1> ;
    87                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    88                              <1> ;           BIT31 set if 32 bit access requested
    89                              <1> ;           BIT30 set if 16 bit access requested
    90                              <1> ;           otherwise defaults to 8bit read
    91                              <1> ;        DL/DX/EDX data to write depending on size
    92                              <1> ;
    93                              <1> ;
    94                              <1> ; note: this routine is meant to be called via pciRegWrite8, pciRegWrite16,
    95                              <1> ; 	or pciRegWrite32 as detailed below.
    96                              <1> ;
    97                              <1> ; Note2: don't attempt to write 32bits of data from a non dword aligned reg
    98                              <1> ;	 number. Likewise, don't do 16bit writes from non word aligned reg #
    99                              <1> ;
   100                              <1> pciRegWrite:
   101 00000269 6653                <1> 	push	ebx
   102 0000026B 51                  <1> 	push	cx
   103 0000026C 6689C3              <1>         mov     ebx, eax                        ; save eax, dx
   104 0000026F 89D1                <1>         mov     cx, dx
   105 00000271 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
   106 00000277 6625FFFFFFBF        <1>         and     eax, ~PCI16 ; NOT PCI16         ; clear out data size request
   107 0000027D 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
   108                              <1> 
   109 0000027F BAF80C              <1>         mov     dx, PCI_INDEX_PORT
   110 00000282 66EF                <1>         out     dx, eax                         ; write PCI selector
   111                              <1> 
   112 00000284 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
   113 00000287 88D8                <1>         mov     al, bl
   114 00000289 2403                <1>         and     al, 3                           ; figure out which port to
   115 0000028B 00C2                <1>         add     dl, al                          ; write to
   116                              <1> 
   117 0000028D 6689D0              <1>         mov     eax, edx                        ; put data into eax
   118 00000290 89C8                <1>         mov     ax, cx
   119                              <1> 
   120 00000292 EE                  <1>         out     dx, al
   121 00000293 66F7C3000000C0      <1>         test    ebx, PCI16+PCI32                ; only 8bit access? bail
   122 0000029A 740C                <1>         jz      short _pregw1
   123                              <1> 
   124 0000029C EF                  <1>         out     dx, ax                          ; write 16 bit value
   125 0000029D 66F7C300000040      <1>         test    ebx, PCI16                      ; 16bit requested?  bail
   126 000002A4 7502                <1>         jnz     short _pregw1
   127                              <1> 
   128 000002A6 66EF                <1>         out     dx, eax                         ; write full 32bit
   129                              <1> _pregw1:
   130 000002A8 6689D8              <1>         mov     eax, ebx                        ; restore eax
   131 000002AB 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
   132 000002B1 89CA                <1>         mov     dx, cx                          ; restore dx
   133 000002B3 59                  <1> 	pop	cx
   134 000002B4 665B                <1> 	pop	ebx
   135 000002B6 C3                  <1> 	ret
   136                              <1> 
   137                              <1> pciRegWrite8:
   138 000002B7 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 8 bit write size
   139 000002BD EBAA                <1>         jmp     short pciRegWrite		; call generic PCI access
   140                              <1> 
   141                              <1> pciRegWrite16:
   142 000002BF 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit write size
   143 000002C5 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
   144 000002CB EB9C                <1>         jmp     short pciRegWrite
   145                              <1> 
   146                              <1> pciRegWrite32:
   147 000002CD 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit write size
   148 000002D3 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
   149 000002D9 EB8E                <1>         jmp     short pciRegWrite
   150                              <1> 
   151                              <1> ; 17/02/2017 (Modifed by Erdogan Tan for various ICH device IDs)
   152                              <1> ;===============================================================
   153                              <1> ; PCIFindDevice: scan through PCI space looking for a device+vendor ID
   154                              <1> ;
   155                              <1> ;  ENTRY: none
   156                              <1> ;; Entry: EAX=Device+Vendor ID
   157                              <1> ;
   158                              <1> ;  Exit: EAX=PCI address if device found
   159                              <1> ;	 EDX=Device+Vendor ID
   160                              <1> ;        CY clear if found, set if not found. EAX invalid if CY set.
   161                              <1> ;
   162                              <1> ; [old stackless] Destroys: ebx, esi, edi, cl
   163                              <1> ;
   164                              <1> pciFindDevice:
   165                              <1> 	;push	cx
   166                              <1> 	;push	eax ; *
   167                              <1> 	;push	esi
   168                              <1> 	;push	edi
   169                              <1> 
   170                              <1>  	;mov     esi, eax                ; save off vend+device ID
   171                              <1> 
   172                              <1> 	; 17/02/2017
   173 000002DB BE[051C]            <1> 	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
   174 000002DE B91500              <1> 	mov	cx, valid_id_count
   175                              <1> pfd_0:
   176 000002E1 66BF00FFFF7F        <1>        	mov     edi, (80000000h - 100h) ; start with bus 0, dev 0 func 0
   177                              <1> nextPCIdevice:
   178 000002E7 6681C700010000      <1>         add     edi, 100h
   179 000002EE 6681FF00F8FF80      <1>         cmp     edi, 80FFF800h		; scanned all devices?
   180                              <1>         ;stc
   181                              <1>         ;je 	short PCIScanExit       ; not found
   182 000002F5 720D                <1> 	jb	short pfd_1
   183 000002F7 66BF00000080        <1> 	mov     edi, 80000000h
   184 000002FD 83C604              <1> 	add	si, 4 ; scan for next device ID
   185 00000300 E202                <1> 	loop	pfd_1	 
   186 00000302 F9                  <1> 	stc	
   187                              <1> 	;jmp 	short PCIScanExit
   188 00000303 C3                  <1> 	retn
   189                              <1> pfd_1:
   190 00000304 6689F8              <1>         mov     eax, edi                ; read PCI registers
   191 00000307 E851FF              <1>         call    pciRegRead32
   192                              <1>         ;cmp    edx, esi                ; found device?
   193 0000030A 663B14              <1>         cmp	edx, dword [si]
   194 0000030D 75D8                <1> 	jne     short nextPCIdevice
   195                              <1>         ;clc
   196                              <1> PCIScanExit:
   197                              <1> 	;pushf
   198 0000030F 66B800000080        <1> 	mov	eax, BIT31
   199 00000315 66F7D0              <1> 	not	eax
   200 00000318 6621F8              <1> 	and	eax, edi		; return only bus/dev/fn #
   201                              <1> 	;popf
   202                              <1> 
   203                              <1> 	;pop	edi
   204                              <1> 	;pop	esi
   205                              <1> 	;pop	edx ; *
   206                              <1> 	;pop	cx
   207 0000031B C3                  <1> 	retn
   208                              <1> 
   209                              <1> ; ----------------------------------------------------------------------------
   210                              <1> ; CODEC.ASM
   211                              <1> ; ----------------------------------------------------------------------------
   212                              <1> 
   213                              <1> ; codec configuration code. Not much here really.
   214                              <1> ; NASM version: Erdogan Tan (29/11/2016)
   215                              <1> 
   216                              <1> ; enable codec, unmute stuff, set output rate to 44.1
   217                              <1> ; entry: ax = desired sample rate
   218                              <1> 
   219                              <1> ; 19/11/2023
   220                              <1> ; 11/11/2023
   221                              <1> ; 06/11/2023
   222                              <1> %if 1
   223                              <1> 
   224                              <1> ;	; 11/11/2023
   225                              <1> ;init_ac97_codec_err1:
   226                              <1> ;	stc
   227                              <1> ;init_ac97_codec_err2:
   228                              <1> ;	retn
   229                              <1> 
   230                              <1> 	; 13/11/2023
   231 0000031C 01                  <1> VRA:	db 1	
   232                              <1> 
   233                              <1> codecConfig:
   234                              <1> 	; 19/11/2023
   235                              <1> 	; 15/11/2023
   236                              <1> 	; 04/11/2023
   237                              <1> 	; 17/02/2017 
   238                              <1> 	; 07/11/2016 (Erdogan Tan)
   239                              <1> 	;PORT_NABM_GLB_CTRL_STAT equ 60h
   240                              <1> 
   241                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   242                              <1>  	; 'AC97_DEF.H'
   243                              <1> 	;AC97_EXTENDED_STATUS equ 002Ah
   244                              <1> 	AC97_EA_SPDIF	equ 0002h
   245                              <1> 	AC97_EA_VRA	equ 0001h
   246                              <1> 	; 04/11/2023
   247                              <1> 	ICH_PO_CR_RESET equ 0002h  ; reset codec
   248                              <1> 	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
   249                              <1> 	ICH_PCM_246_MASK equ 300000h ; 6 channels
   250                              <1> 
   251                              <1> 	; 04/11/2023
   252                              <1> init_ac97_controller:
   253 0000031D 66A1[DC1D]          <1> 	mov	eax, [bus_dev_fn]
   254 00000321 B004                <1> 	mov	al, PCI_CMD_REG
   255 00000323 E827FF              <1> 	call	pciRegRead16		; read PCI command register
   256 00000326 80CA05              <1> 	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
   257 00000329 E893FF              <1> 	call	pciRegWrite16
   258                              <1> 
   259 0000032C E87701              <1> 	call	delay_100ms
   260                              <1> 
   261                              <1> init_ac97_codec:
   262                              <1> 	; 18/11/2023
   263 0000032F BD2800              <1> 	mov	bp, 40
   264                              <1> _initc_1:
   265                              <1> 	; 11/11/2023
   266                              <1> 	; (TRDOS 386 v2.0.5, 'audio.s')
   267 00000332 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   268 00000335 0316[D41D]          <1> 	add	dx, [NABMBAR]
   269 00000339 66ED                <1> 	in	eax, dx
   270                              <1> 	; ?
   271                              <1> 	;; 15/11/2023
   272                              <1> 	;;mov	cx, 40
   273                              <1> 	;mov	bp, 40 ; 18/11/2023
   274                              <1> ;_initc_1:
   275 0000033B BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   276 0000033E 0316[D41D]          <1> 	add	dx, [NABMBAR]
   277 00000342 66ED                <1> 	in	eax, dx
   278                              <1> 
   279 00000344 6683F8FF            <1> 	cmp	eax, 0FFFFFFFFh ; -1
   280                              <1> 	;je	short init_ac97_codec_err1
   281                              <1> 	; 15/11/2023
   282 00000348 7508                <1> 	jne	short _initc_3
   283                              <1> _initc_2:
   284                              <1> 	;dec	cx
   285 0000034A 4D                  <1> 	dec	bp	; 18/11/2023
   286                              <1> 	;jz	short init_ac97_codec_err1
   287                              <1> 	; 19/11/2023
   288 0000034B 7412                <1> 	jz	short _ac97_codec_ready
   289                              <1> 
   290 0000034D E85601              <1> 	call	delay_100ms
   291 00000350 EBE0                <1> 	jmp	short _initc_1
   292                              <1> _initc_3:
   293 00000352 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   294 00000358 7505                <1> 	jnz	short _ac97_codec_ready
   295                              <1> 
   296 0000035A E8C900              <1> 	call	reset_ac97_codec
   297                              <1> 	; 11/11/2023
   298                              <1> 	;jc	short init_ac97_codec_err2
   299                              <1> 	; 15/11/2023
   300 0000035D 72EB                <1> 	jc	short _initc_2
   301                              <1> 
   302                              <1> _ac97_codec_ready:
   303 0000035F 8B16[D21D]          <1> 	mov	dx, [NAMBAR]
   304                              <1> 	;add	dx, 0 ; ac_reg_0 ; reset register
   305 00000363 EF                  <1> 	out	dx, ax
   306                              <1> 
   307 00000364 E83F01              <1> 	call	delay_100ms
   308                              <1> 
   309                              <1> 	; 19/11/2023
   310 00000367 09ED                <1> 	or	bp, bp
   311 00000369 751D                <1> 	jnz	short _ac97_codec_init_ok
   312                              <1> 
   313 0000036B 6631C0              <1> 	xor	eax, eax ; 0
   314 0000036E 8B16[D21D]          <1> 	mov	dx, [NAMBAR]
   315 00000372 83C226              <1> 	add	dx, CODEC_REG_POWERDOWN
   316 00000375 EF                  <1> 	out	dx, ax
   317                              <1> 	
   318                              <1> 	; 19/11/2023
   319                              <1> 	; wait for 1 second
   320                              <1> 	;mov	ecx, 1000 ; 1000*4*0.25ms = 1s
   321 00000376 B90A00              <1> 	mov	cx, 10
   322                              <1> _ac97_codec_rloop:
   323                              <1> 	;call	delay1_4ms
   324                              <1> 	;call	delay1_4ms
   325                              <1> 	;call	delay1_4ms
   326                              <1> 	;call	delay1_4ms
   327 00000379 E82A01              <1> 	call	delay_100ms
   328                              <1> 	;mov	dx, [NAMBAR]
   329                              <1> 	;add	dx, CODEC_REG_POWERDOWN
   330 0000037C ED                  <1> 	in	ax, dx	
   331 0000037D 83E00F              <1> 	and	ax, 0Fh
   332 00000380 3C0F                <1> 	cmp	al, 0Fh
   333 00000382 7404                <1> 	je	short _ac97_codec_init_ok
   334 00000384 E2F3                <1> 	loop	_ac97_codec_rloop 
   335                              <1> 
   336                              <1> init_ac97_codec_err1:
   337 00000386 F9                  <1> 	stc
   338                              <1> init_ac97_codec_err2:
   339 00000387 C3                  <1> 	retn
   340                              <1> 
   341                              <1> _ac97_codec_init_ok:
   342                              <1>         ; 11/11/2023
   343                              <1> 	;mov	al, 2 ; force set 16-bit 2-channel PCM
   344                              <1> 	;mov	dx, GLOB_CNT_REG ; 2Ch
   345                              <1> 	;add	dx, [NABMBAR]
   346                              <1> 	;out	dx, eax
   347                              <1> 
   348                              <1> 	;;call	delay1_4ms
   349                              <1> 
   350 00000388 E86600              <1> 	call 	reset_ac97_controller
   351                              <1> 
   352                              <1> 	; 11/11/2023
   353 0000038B E8E315              <1> 	call	delay1_4ms
   354                              <1> 
   355                              <1> 	;call 	setup_ac97_codec
   356                              <1> 
   357                              <1> setup_ac97_codec:
   358                              <1> 	; 12/11/2023
   359 0000038E 813E[E41D]80BB      <1> 	cmp	word [sample_rate], 48000
   360 00000394 742F                <1> 	je	short skip_rate
   361                              <1> 
   362                              <1> ; 11/11/2023
   363                              <1> ; 05/11/2023
   364                              <1> ;%if 1
   365                              <1> 	AC97_EA_VRA equ BIT0 ; 11/11/2023
   366                              <1> 
   367                              <1> 	; 11/11/2023
   368 00000396 8B16[D21D]          <1> 	mov    	dx, [NAMBAR]               	
   369 0000039A 83C22A              <1> 	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah  	  
   370 0000039D ED                  <1> 	in     	ax, dx
   371 0000039E 24FD                <1> 	and	al, ~BIT1 ; Clear DRA
   372 000003A0 0C01                <1> 	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
   373 000003A2 EF                  <1> 	out	dx, ax			; Enable variable rate audio
   374                              <1> 	
   375 000003A3 B90A00              <1> 	mov	cx, 10
   376                              <1> check_vra:
   377 000003A6 E8FD00              <1> 	call	delay_100ms
   378                              <1> 
   379                              <1> 	; 11/11/2023
   380 000003A9 ED                  <1> 	in	ax, dx
   381 000003AA A801                <1> 	test	al, AC97_EA_VRA ; 1
   382 000003AC 7509                <1> 	jnz	short set_rate
   383                              <1> 
   384                              <1> 	; 11/11/2023
   385 000003AE E2F6                <1> 	loop	check_vra
   386                              <1> 
   387                              <1> 	; 13/11/2023
   388 000003B0 C606[1C03]00        <1> 	mov	byte [VRA], 0
   389 000003B5 EB0E                <1> 	jmp	short skip_rate	
   390                              <1> 
   391                              <1> 	; 12/11/2023
   392                              <1> 	;pop	ax ; discard return address to the caller
   393                              <1> 	;mov	dx, msg_no_vra
   394                              <1> 	;jmp	vra_err
   395                              <1> 
   396                              <1> set_rate:
   397 000003B7 A1[E41D]            <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   398                              <1> 
   399 000003BA 8B16[D21D]          <1> 	mov    	dx, [NAMBAR]               	
   400 000003BE 83C22C              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   401 000003C1 EF                  <1> 	out	dx, ax 			; PCM Front/Center Output Sample Rate
   402                              <1> 
   403 000003C2 E8E100              <1> 	call	delay_100ms
   404                              <1> 
   405                              <1> 	; 12/11/2023
   406                              <1> skip_rate:
   407                              <1> 	; 11/11/2023 (temporary)
   408                              <1> 
   409                              <1> 	;mov   	dx, [NAMBAR]               	
   410                              <1> 	;add   	dx, CODEC_PCM_SURND_DACRATE_REG	; 2Eh  	  
   411                              <1> 	;out	dx, ax 			; PCM Surround Output Sample Rate
   412                              <1> 
   413                              <1> 	;call	delay_100ms
   414                              <1> 
   415                              <1> 	;mov   	dx, [NAMBAR]               	
   416                              <1> 	;add   	dx, CODEC_PCM_LFE_DACRATE_REG	; 30h  	  
   417                              <1> 	;out	dx, ax 			; PCM LFE Output Sample Rate
   418                              <1> 
   419                              <1> 	;call	delay_100ms
   420                              <1> 
   421                              <1> 	; 05/11/2023 (temporary)
   422                              <1> 	;mov	dx, [NAMBAR]               	
   423                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   424                              <1> 	;out	dx, ax 			; PCM Input Sample Rate
   425                              <1> 	;
   426                              <1> 	;call	delay_100ms
   427                              <1> 
   428 000003C5 B80202              <1> 	mov	ax, 0202h
   429 000003C8 8B16[D21D]          <1>   	mov     dx, [NAMBAR]
   430 000003CC 83C202              <1>   	add     dx, CODEC_MASTER_VOL_REG	;02h 
   431 000003CF EF                  <1> 	out     dx, ax
   432                              <1> 
   433                              <1> 	; 11/11/2023
   434                              <1>         ;call	delay1_4ms
   435                              <1>         ;call	delay1_4ms
   436                              <1>         ;call	delay1_4ms
   437                              <1>         ;call	delay1_4ms
   438                              <1>  	;
   439                              <1>   	;mov	dx, [NAMBAR]
   440                              <1>   	;add	dx, CODEC_MASTER_MONO_VOL_REG	;06h 
   441                              <1>   	;out	dx, ax
   442                              <1> 
   443                              <1> 	; 11/11/2023
   444                              <1>         ;call	delay1_4ms
   445                              <1>         ;call	delay1_4ms
   446                              <1>         ;call	delay1_4ms
   447                              <1>         ;call	delay1_4ms
   448                              <1> 	;
   449                              <1> 	;mov	ax, 02h
   450                              <1>   	;mov	dx, [NAMBAR]
   451                              <1>   	;add	dx, CODEC_PCBEEP_VOL_REG	;0Ah 
   452                              <1>   	;out	dx, ax
   453                              <1> 
   454 000003D0 E89E15              <1>         call    delay1_4ms
   455 000003D3 E89B15              <1>         call    delay1_4ms
   456 000003D6 E89815              <1>         call    delay1_4ms
   457 000003D9 E89515              <1>         call    delay1_4ms
   458                              <1> 
   459                              <1> 	;mov	ax, 0202h
   460 000003DC 8B16[D21D]          <1>   	mov     dx, [NAMBAR]
   461 000003E0 83C218              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h 
   462 000003E3 EF                  <1>   	out     dx, ax
   463                              <1> 
   464 000003E4 E88A15              <1>         call    delay1_4ms
   465 000003E7 E88715              <1>         call    delay1_4ms
   466 000003EA E88415              <1>         call    delay1_4ms
   467 000003ED E88115              <1>         call    delay1_4ms
   468                              <1> 
   469                              <1> 	; 11/11/2023
   470                              <1> 	;mov	ax, 8008h ; Mute
   471                              <1>   	;mov	dx, [NAMBAR]
   472                              <1> 	;add	dx, CODEC_PHONE_VOL_REG		;0Ch
   473                              <1> 	;			 ; AC97_PHONE_VOL ; TAD Input (Mono)
   474                              <1>   	;out	dx, ax
   475                              <1> 	;
   476                              <1>         ;call	delay1_4ms
   477                              <1>         ;call	delay1_4ms
   478                              <1>         ;call	delay1_4ms
   479                              <1> 	;call	delay1_4ms
   480                              <1> 
   481                              <1> 	;mov	ax, 0808h
   482                              <1> 	;mov	dx, [NAMBAR]
   483                              <1> 	;add	dx, CODEC_LINE_IN_VOL_REG ;10h ; Line Input (Stereo)
   484                              <1> 	;out	dx, ax
   485                              <1> 	;
   486                              <1>         ;call	delay1_4ms
   487                              <1>         ;call	delay1_4ms
   488                              <1>         ;call	delay1_4ms
   489                              <1> 	;call	delay1_4ms
   490                              <1> 
   491                              <1>   	;mov	dx, [NAMBAR]
   492                              <1>         ;add	dx, CODEC_CD_VOL_REG ;12h ; CD Input (Stereo)
   493                              <1>   	;out	dx, ax
   494                              <1> 	;
   495                              <1>   	;mov	dx, [NAMBAR]
   496                              <1>         ;add	dx, CODEC_AUX_VOL_REG ;16h ; Aux Input (Stereo)
   497                              <1>   	;out	dx, ax
   498                              <1> 	;
   499                              <1>         ;call	delay1_4ms
   500                              <1>         ;call	delay1_4ms
   501                              <1>         ;call	delay1_4ms
   502                              <1> 	;call	delay1_4ms
   503                              <1> 
   504                              <1> ;detect_ac97_codec:
   505 000003F0 C3                  <1>         retn
   506                              <1> 
   507                              <1> reset_ac97_controller:
   508                              <1> 	; 11/11/2023
   509                              <1> 	; 10/06/2017
   510                              <1> 	; 29/05/2017
   511                              <1> 	; 28/05/2017
   512                              <1> 	; reset AC97 audio controller registers
   513 000003F1 31C0                <1> 	xor     ax, ax
   514 000003F3 BA0B00              <1>         mov	dx, PI_CR_REG
   515 000003F6 0316[D41D]          <1> 	add	dx, [NABMBAR]
   516 000003FA EE                  <1> 	out     dx, al
   517                              <1> 
   518 000003FB BA1B00              <1>         mov     dx, PO_CR_REG
   519 000003FE 0316[D41D]          <1> 	add	dx, [NABMBAR]
   520 00000402 EE                  <1> 	out     dx, al
   521                              <1> 
   522 00000403 BA2B00              <1>         mov     dx, MC_CR_REG
   523 00000406 0316[D41D]          <1> 	add	dx, [NABMBAR]
   524 0000040A EE                  <1> 	out     dx, al
   525                              <1> 
   526 0000040B B002                <1>         mov     al, RR
   527 0000040D BA0B00              <1>         mov     dx, PI_CR_REG
   528 00000410 0316[D41D]          <1> 	add	dx, [NABMBAR]
   529 00000414 EE                  <1> 	out     dx, al
   530                              <1> 
   531 00000415 BA1B00              <1>         mov     dx, PO_CR_REG
   532 00000418 0316[D41D]          <1> 	add	dx, [NABMBAR]
   533 0000041C EE                  <1> 	out     dx, al
   534                              <1> 
   535 0000041D BA2B00              <1>         mov     dx, MC_CR_REG
   536 00000420 0316[D41D]          <1> 	add	dx, [NABMBAR]
   537 00000424 EE                  <1> 	out     dx, al
   538                              <1> 
   539 00000425 C3                  <1> 	retn
   540                              <1> 
   541                              <1> reset_ac97_codec:
   542                              <1> 	; 11/11/2023
   543                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   544 00000426 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   545 00000429 0316[D41D]          <1> 	add	dx, [NABMBAR]
   546 0000042D 66ED                <1> 	in	eax, dx
   547                              <1> 
   548                              <1> 	;test	eax, 2
   549                              <1> 	; 06/08/2022
   550 0000042F A802                <1> 	test	al, 2
   551 00000431 7405                <1> 	jz	short _r_ac97codec_cold	
   552                              <1> 
   553 00000433 E80E00              <1> 	call	warm_ac97codec_reset
   554 00000436 7306                <1> 	jnc	short _r_ac97codec_ok
   555                              <1> _r_ac97codec_cold:
   556 00000438 E83400              <1>         call    cold_ac97codec_reset
   557 0000043B 7301                <1>         jnc     short _r_ac97codec_ok
   558                              <1> 	
   559                              <1> 	; 16/04/2017
   560                              <1>         ;xor	eax, eax	; timeout error
   561                              <1>        	;stc
   562 0000043D C3                  <1> 	retn
   563                              <1> 
   564                              <1> _r_ac97codec_ok:
   565 0000043E 6631C0              <1>         xor     eax, eax
   566                              <1>         ;mov	al, VIA_ACLINK_C00_READY ; 1
   567 00000441 FEC0                <1>         inc	al
   568 00000443 C3                  <1> 	retn
   569                              <1> 
   570                              <1> warm_ac97codec_reset:
   571                              <1> 	; 11/11/2023
   572                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   573                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   574 00000444 66B806000000        <1> 	mov	eax, 6
   575 0000044A BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   576 0000044D 0316[D41D]          <1> 	add	dx, [NABMBAR]
   577 00000451 66EF                <1> 	out	dx, eax
   578                              <1> 
   579 00000453 B90A00              <1> 	mov	cx, 10	; total 1s
   580                              <1> _warm_ac97c_rst_wait:
   581 00000456 E84D00              <1> 	call	delay_100ms
   582                              <1> 
   583 00000459 BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   584 0000045C 0316[D41D]          <1> 	add	dx, [NABMBAR]
   585 00000460 66ED                <1> 	in	eax, dx
   586                              <1> 
   587 00000462 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   588 00000468 7504                <1> 	jnz	short _warm_ac97c_rst_ok
   589                              <1> 
   590 0000046A 49                  <1>         dec     cx
   591 0000046B 75E9                <1>         jnz     short _warm_ac97c_rst_wait
   592                              <1> 
   593                              <1> _warm_ac97c_rst_fail:
   594 0000046D F9                  <1>         stc
   595                              <1> _warm_ac97c_rst_ok:
   596 0000046E C3                  <1> 	retn
   597                              <1> 
   598                              <1> cold_ac97codec_reset:
   599                              <1> 	; 11/11/2023
   600                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   601                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   602 0000046F 66B802000000        <1>         mov	eax, 2
   603 00000475 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   604 00000478 0316[D41D]          <1> 	add	dx, [NABMBAR]
   605 0000047C 66EF                <1> 	out	dx, eax
   606                              <1> 
   607 0000047E E82500              <1> 	call	delay_100ms 	; wait 100 ms
   608 00000481 E82200              <1> 	call	delay_100ms 	; wait 100 ms
   609 00000484 E81F00              <1> 	call	delay_100ms 	; wait 100 ms
   610 00000487 E81C00              <1> 	call	delay_100ms 	; wait 100 ms
   611                              <1> 
   612 0000048A B91000              <1> 	mov	cx, 16	; total 20*100 ms = 2s
   613                              <1> 
   614                              <1> _cold_ac97c_rst_wait:
   615 0000048D BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   616 00000490 0316[D41D]          <1> 	add	dx, [NABMBAR]
   617 00000494 66ED                <1> 	in	eax, dx
   618                              <1> 
   619 00000496 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   620 0000049C 7507                <1> 	jnz	short _cold_ac97c_rst_ok
   621                              <1> 
   622 0000049E E80500              <1> 	call	delay_100ms
   623                              <1> 
   624 000004A1 49                  <1>         dec     cx
   625 000004A2 75E9                <1>         jnz     short _cold_ac97c_rst_wait
   626                              <1> 
   627                              <1> _cold_ac97c_rst_fail:
   628 000004A4 F9                  <1>         stc
   629                              <1> _cold_ac97c_rst_ok:
   630 000004A5 C3                  <1> 	retn
   631                              <1> 
   632                              <1> delay_100ms:
   633                              <1> 	; 11/11/2023
   634                              <1> 	; 29/05/2017
   635                              <1> 	; 24/03/2017 ('codec.asm')
   636                              <1> 	; wait 100 ms
   637 000004A6 51                  <1> 	push	cx
   638 000004A7 B99001              <1> 	mov	cx, 400  ; 400*0.25ms
   639                              <1> _delay_x_ms:
   640 000004AA E8C414              <1> 	call	delay1_4ms
   641 000004AD E2FB                <1>         loop	_delay_x_ms
   642 000004AF 59                  <1> 	pop	cx
   643 000004B0 C3                  <1> 	retn
   644                              <1> 
   645                              <1> %endif
   646                              <1> 
   647                              <1> ; 11/11/2023
   648                              <1> %if 0
   649                              <1> 
   650                              <1> codecConfig:
   651                              <1> 	; 06/11/2023
   652                              <1> 	; TUNELOOP version (playing without interrupt)
   653                              <1> 	; 04/11/2023
   654                              <1> 	; 17/02/2017 
   655                              <1> 	; 07/11/2016 (Erdogan Tan)
   656                              <1> 
   657                              <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   658                              <1> 
   659                              <1> 	mov    	dx, [NAMBAR]               	
   660                              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   661                              <1> 	out	dx, ax 				; out sample rate
   662                              <1> 		
   663                              <1> 	; 05/11/2023 temp
   664                              <1> 	;mov	dx, [NAMBAR]               	
   665                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   666                              <1> 	;out	dx, ax 
   667                              <1> 
   668                              <1>         call    delay1_4ms
   669                              <1>         call    delay1_4ms
   670                              <1>         call    delay1_4ms
   671                              <1>         call    delay1_4ms
   672                              <1> 
   673                              <1> 	mov	eax, [dev_vendor]
   674                              <1>         cmp	eax, (SI7012_DID<<16)+SIS_VID
   675                              <1>         jne	short cConfig1
   676                              <1> 
   677                              <1> 	; Unmute quirk specifically for the SiS7012
   678                              <1> 
   679                              <1> 	CUSTOM_SIS_7012_REG equ 4Ch ; SiS7012-specific register
   680                              <1> 	
   681                              <1>         mov     dx, [NABMBAR]
   682                              <1>         add     dx, CUSTOM_SIS_7012_REG
   683                              <1>         in      ax, dx
   684                              <1>         or	al, 1
   685                              <1>         out     dx, ax
   686                              <1> 
   687                              <1> cConfig1:
   688                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   689                              <1> 	; initial ac97 volumes (and clear mute flag)
   690                              <1> 		
   691                              <1>   	mov     dx, [NAMBAR]
   692                              <1>   	add     dx, CODEC_MASTER_VOL_REG        ;02h ; STEREO
   693                              <1>   	;xor	ax, ax ; volume attenuation = 0 (max. volume)
   694                              <1>   	; 03/11/2023
   695                              <1> 	mov	ax, 0202h
   696                              <1> 	out     dx, ax
   697                              <1> 
   698                              <1>         call    delay1_4ms	; delays because codecs are slow
   699                              <1>         call    delay1_4ms
   700                              <1>         call    delay1_4ms
   701                              <1>         call    delay1_4ms
   702                              <1>  
   703                              <1>   	mov     dx, [NAMBAR]
   704                              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h
   705                              <1>   	;;xor	ax, ax
   706                              <1> 	;mov	ax, 0202h
   707                              <1>   	out     dx, ax
   708                              <1> 
   709                              <1>         call    delay1_4ms
   710                              <1>         call    delay1_4ms
   711                              <1>         call    delay1_4ms
   712                              <1>         call    delay1_4ms
   713                              <1>  
   714                              <1> 	retn
   715                              <1> 
   716                              <1> %endif
   451                                  ;%include 'ich_wav.asm' ; 17/02/2017 (ICH AC97 wav playing functions)
   452                                  %include 'ich_wav3.asm' ; 13/11/2023 (ICH AC97 wav playing functions)
     1                              <1> ; 18/11/2023
     2                              <1> ; 17/11/2023
     3                              <1> ; 16/11/2023
     4                              <1> ; 15/11/2023
     5                              <1> ; 14/11/2023
     6                              <1> ; 13/11/2023
     7                              <1> ; 03/11/2023 - 11/11/2023
     8                              <1> ; DOS based .WAV player using AC'97 and codec interface.
     9                              <1> ; ---------------------------------------------------------------
    10                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    11                              <1> ; Last Update: 17/02/2017 (by Erdogan Tan)
    12                              <1> 
    13                              <1> ; AC97 interrupt version - 09/11/2023 - Erdogan Tan
    14                              <1> ; sample rate conversion version - 13/11/2023 - Erdogan Tan
    15                              <1> 
    16                              <1> ; ICHWAV.ASM
    17                              <1> 
    18                              <1> ; player internal variables and other equates.
    19                              <1> BUFFERSIZE      equ     64 * 1024       ; 64k file buffer size.
    20                              <1> ENDOFFILE       equ     BIT0            ; flag for knowing end of file
    21                              <1> 
    22                              <1> ;===========================================================================
    23                              <1> ; entry: none. File is already open and [filehandle] filled.
    24                              <1> ; exit:  not until the song is finished or the user aborts.
    25                              <1> ;
    26                              <1> playWav:
    27                              <1> 	; 13/11/2023
    28                              <1> 
    29 000004B1 803E[1C03]01        <1> 	cmp	byte [VRA], 1
    30 000004B6 720F                <1> 	jb	short chk_sample_rate
    31                              <1> playwav_48_khz:	
    32 000004B8 C706[6706][8807]    <1> 	mov	word [loadfromwavfile], loadFromFile
    33                              <1> 	;mov	word [loadsize], 0 ; 65536
    34 000004BE C706[6B06]0080      <1> 	mov	word [buffersize], 32768 ; samples
    35 000004C4 E9A801              <1> 	jmp	playWav_vra
    36                              <1> 
    37                              <1> chk_sample_rate:
    38                              <1> 	; set conversion parameters
    39                              <1> 	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
    40 000004C7 A1[E41D]            <1> 	mov	ax, [sample_rate]
    41 000004CA 3D80BB              <1> 	cmp	ax, 48000
    42 000004CD 74E9                <1> 	je	short playwav_48_khz
    43                              <1> chk_22khz:
    44 000004CF 3D2256              <1> 	cmp	ax, 22050
    45 000004D2 752F                <1> 	jne	short chk_11khz
    46 000004D4 803E[E81D]08        <1> 	cmp	byte [bps], 8
    47 000004D9 760F                <1> 	jna	short chk_22khz_1
    48 000004DB BB[9411]            <1> 	mov	bx, load_22khz_stereo_16_bit
    49 000004DE 803E[E61D]01        <1> 	cmp	byte [stmo], 1 
    50 000004E3 7512                <1> 	jne	short chk_22khz_2
    51 000004E5 BB[2B11]            <1> 	mov	bx, load_22khz_mono_16_bit
    52 000004E8 EB0D                <1> 	jmp	short chk_22khz_2
    53                              <1> chk_22khz_1:
    54 000004EA BB[C610]            <1> 	mov	bx, load_22khz_stereo_8_bit
    55 000004ED 803E[E61D]01        <1> 	cmp	byte [stmo], 1 
    56 000004F2 7503                <1> 	jne	short chk_22khz_2
    57 000004F4 BB[5D10]            <1> 	mov	bx, load_22khz_mono_8_bit
    58                              <1> chk_22khz_2:
    59 000004F7 B85A1D              <1> 	mov	ax, 7514  ; (442*17)
    60 000004FA BA2500              <1> 	mov	dx, 37
    61 000004FD B91100              <1> 	mov	cx, 17 
    62 00000500 E93301              <1> 	jmp	set_sizes	
    63                              <1> chk_11khz:
    64 00000503 3D112B              <1> 	cmp	ax, 11025
    65 00000506 752F                <1> 	jne	short chk_44khz
    66 00000508 803E[E81D]08        <1> 	cmp	byte [bps], 8
    67 0000050D 760F                <1> 	jna	short chk_11khz_1
    68 0000050F BB[2813]            <1> 	mov	bx, load_11khz_stereo_16_bit
    69 00000512 803E[E61D]01        <1> 	cmp	byte [stmo], 1 
    70 00000517 7512                <1> 	jne	short chk_11khz_2
    71 00000519 BB[CD12]            <1> 	mov	bx, load_11khz_mono_16_bit
    72 0000051C EB0D                <1> 	jmp	short chk_11khz_2
    73                              <1> chk_11khz_1:
    74 0000051E BB[7212]            <1> 	mov	bx, load_11khz_stereo_8_bit
    75 00000521 803E[E61D]01        <1> 	cmp	byte [stmo], 1 
    76 00000526 7503                <1> 	jne	short chk_11khz_2
    77 00000528 BB[1412]            <1> 	mov	bx, load_11khz_mono_8_bit
    78                              <1> chk_11khz_2:
    79 0000052B B8AD0E              <1> 	mov	ax, 3757  ; (221*17)
    80 0000052E BA4A00              <1> 	mov	dx, 74
    81 00000531 B91100              <1> 	mov	cx, 17
    82 00000534 E9FF00              <1> 	jmp	set_sizes 
    83                              <1> chk_44khz:
    84 00000537 3D44AC              <1> 	cmp	ax, 44100
    85 0000053A 752F                <1> 	jne	short chk_16khz
    86 0000053C 803E[E81D]08        <1> 	cmp	byte [bps], 8
    87 00000541 760F                <1> 	jna	short chk_44khz_1
    88 00000543 BB[D914]            <1> 	mov	bx, load_44khz_stereo_16_bit
    89 00000546 803E[E61D]01        <1> 	cmp	byte [stmo], 1 
    90 0000054B 7512                <1> 	jne	short chk_44khz_2
    91 0000054D BB[8114]            <1> 	mov	bx, load_44khz_mono_16_bit
    92 00000550 EB0D                <1> 	jmp	short chk_44khz_2
    93                              <1> chk_44khz_1:
    94 00000552 BB[2314]            <1> 	mov	bx, load_44khz_stereo_8_bit
    95 00000555 803E[E61D]01        <1> 	cmp	byte [stmo], 1 
    96 0000055A 7503                <1> 	jne	short chk_44khz_2
    97 0000055C BB[C613]            <1> 	mov	bx, load_44khz_mono_8_bit
    98                              <1> chk_44khz_2:
    99                              <1> 	;mov	ax, 15065 ; (655*23)
   100                              <1> 	; 18/11/2023 ((file size + bss + stack) <= 64KB)
   101 0000055F B8FC36              <1> 	mov	ax, 14076 ; (612 *23)
   102 00000562 BA1900              <1> 	mov	dx, 25
   103 00000565 B91700              <1> 	mov	cx, 23
   104 00000568 E9CB00              <1> 	jmp	set_sizes 
   105                              <1> chk_16khz:
   106 0000056B 3D803E              <1> 	cmp	ax, 16000
   107 0000056E 752F                <1> 	jne	short chk_8khz
   108 00000570 803E[E81D]08        <1> 	cmp	byte [bps], 8
   109 00000575 760F                <1> 	jna	short chk_16khz_1
   110 00000577 BB[DB0C]            <1> 	mov	bx, load_16khz_stereo_16_bit
   111 0000057A 803E[E61D]01        <1> 	cmp	byte [stmo], 1 
   112 0000057F 7512                <1> 	jne	short chk_16khz_2
   113 00000581 BB[7A0C]            <1> 	mov	bx, load_16khz_mono_16_bit
   114 00000584 EB0D                <1> 	jmp	short chk_16khz_2
   115                              <1> chk_16khz_1:
   116 00000586 BB[EA0B]            <1> 	mov	bx, load_16khz_stereo_8_bit
   117 00000589 803E[E61D]01        <1> 	cmp	byte [stmo], 1 
   118 0000058E 7503                <1> 	jne	short chk_16khz_2
   119 00000590 BB[860B]            <1> 	mov	bx, load_16khz_mono_8_bit
   120                              <1> chk_16khz_2:
   121 00000593 B85515              <1> 	mov	ax, 5461
   122 00000596 BA0300              <1> 	mov	dx, 3
   123 00000599 B90100              <1> 	mov	cx, 1
   124 0000059C E99700              <1> 	jmp	set_sizes 
   125                              <1> chk_8khz:
   126 0000059F 3D401F              <1> 	cmp	ax, 8000
   127 000005A2 752E                <1> 	jne	short chk_24khz
   128 000005A4 803E[E81D]08        <1> 	cmp	byte [bps], 8
   129 000005A9 760F                <1> 	jna	short chk_8khz_1
   130 000005AB BB[9F0A]            <1> 	mov	bx, load_8khz_stereo_16_bit
   131 000005AE 803E[E61D]01        <1> 	cmp	byte [stmo], 1 
   132 000005B3 7512                <1> 	jne	short chk_8khz_2
   133 000005B5 BB[0E0A]            <1> 	mov	bx, load_8khz_mono_16_bit
   134 000005B8 EB0D                <1> 	jmp	short chk_8khz_2
   135                              <1> chk_8khz_1:
   136 000005BA BB[1E09]            <1> 	mov	bx, load_8khz_stereo_8_bit
   137 000005BD 803E[E61D]01        <1> 	cmp	byte [stmo], 1 
   138 000005C2 7503                <1> 	jne	short chk_8khz_2
   139 000005C4 BB[6B08]            <1> 	mov	bx, load_8khz_mono_8_bit
   140                              <1> chk_8khz_2:
   141 000005C7 B8AA0A              <1> 	mov	ax, 2730
   142 000005CA BA0600              <1> 	mov	dx, 6
   143 000005CD B90100              <1> 	mov	cx, 1
   144 000005D0 EB64                <1> 	jmp	short set_sizes 
   145                              <1> chk_24khz:
   146 000005D2 3DC05D              <1> 	cmp	ax, 24000
   147 000005D5 752E                <1> 	jne	short chk_32khz
   148 000005D7 803E[E81D]08        <1> 	cmp	byte [bps], 8
   149 000005DC 760F                <1> 	jna	short chk_24khz_1
   150 000005DE BB[700E]            <1> 	mov	bx, load_24khz_stereo_16_bit
   151 000005E1 803E[E61D]01        <1> 	cmp	byte [stmo], 1 
   152 000005E6 7512                <1> 	jne	short chk_24khz_2
   153 000005E8 BB[270E]            <1> 	mov	bx, load_24khz_mono_16_bit
   154 000005EB EB0D                <1> 	jmp	short chk_24khz_2
   155                              <1> chk_24khz_1:
   156 000005ED BB[BF0D]            <1> 	mov	bx, load_24khz_stereo_8_bit
   157 000005F0 803E[E61D]01        <1> 	cmp	byte [stmo], 1 
   158 000005F5 7503                <1> 	jne	short chk_24khz_2
   159 000005F7 BB[700D]            <1> 	mov	bx, load_24khz_mono_8_bit
   160                              <1> chk_24khz_2:
   161 000005FA B80020              <1> 	mov	ax, 8192
   162 000005FD BA0200              <1> 	mov	dx, 2
   163 00000600 B90100              <1> 	mov	cx, 1
   164 00000603 EB31                <1> 	jmp	short set_sizes 
   165                              <1> chk_32khz:
   166 00000605 3D007D              <1> 	cmp	ax, 32000
   167 00000608 7556                <1> 	jne	short vra_needed
   168 0000060A 803E[E81D]08        <1> 	cmp	byte [bps], 8
   169 0000060F 760F                <1> 	jna	short chk_32khz_1
   170 00000611 BB[F20F]            <1> 	mov	bx, load_32khz_stereo_16_bit
   171 00000614 803E[E61D]01        <1> 	cmp	byte [stmo], 1 
   172 00000619 7512                <1> 	jne	short chk_32khz_2
   173 0000061B BB[A50F]            <1> 	mov	bx, load_32khz_mono_16_bit
   174 0000061E EB0D                <1> 	jmp	short chk_32khz_2
   175                              <1> chk_32khz_1:
   176 00000620 BB[2E0F]            <1> 	mov	bx, load_32khz_stereo_8_bit
   177 00000623 803E[E61D]01        <1> 	cmp	byte [stmo], 1 
   178 00000628 7503                <1> 	jne	short chk_32khz_2
   179 0000062A BB[D60E]            <1> 	mov	bx, load_32khz_mono_8_bit
   180                              <1> chk_32khz_2:
   181 0000062D B8AA2A              <1> 	mov	ax, 10922
   182 00000630 BA0300              <1> 	mov	dx, 3
   183 00000633 B90200              <1> 	mov	cx, 2
   184                              <1> 	;jmp	short set_sizes 
   185                              <1> set_sizes:
   186 00000636 803E[E61D]01        <1> 	cmp	byte [stmo], 1
   187 0000063B 7402                <1> 	je	short ss_1
   188 0000063D D1E0                <1> 	shl	ax, 1
   189                              <1> ss_1:
   190 0000063F 803E[E81D]08        <1> 	cmp	byte [bps], 8
   191 00000644 7602                <1> 	jna	short ss_2
   192                              <1> 	; 16 bit samples
   193 00000646 D1E0                <1> 	shl	ax, 1
   194                              <1> ss_2:
   195 00000648 A3[6906]            <1> 	mov	[loadsize], ax
   196 0000064B F7E2                <1> 	mul	dx
   197                              <1> 	;cmp	cx, 1
   198                              <1> 	;je	short ss_3
   199                              <1> ;ss_3:
   200 0000064D F7F1                <1> 	div	cx
   201 0000064F 8A0E[EA1D]          <1> 	mov	cl, [fbs_shift]
   202 00000653 D3E0                <1> 	shl	ax, cl
   203 00000655 D1E8                <1> 	shr	ax, 1	; buffer size is 16 bit sample count
   204 00000657 A3[6B06]            <1> 	mov	[buffersize], ax 
   205 0000065A 891E[6706]          <1> 	mov	[loadfromwavfile], bx
   206 0000065E EB0F                <1> 	jmp	short playWav_vra
   207                              <1> 
   208                              <1> vra_needed:
   209                              <1> 	; 13/11/2023
   210 00000660 58                  <1> 	pop	ax ; discard return address to the caller
   211 00000661 BA[711D]            <1> 	mov	dx, msg_no_vra
   212 00000664 E9F3FA              <1> 	jmp	vra_err
   213                              <1> 
   214                              <1> 	; 13/11/2023
   215                              <1> loadfromwavfile:
   216 00000667 [8807]              <1> 	dw	loadFromFile
   217                              <1> loadsize:	; read from wav file
   218 00000669 0000                <1> 	dw	0
   219                              <1> buffersize:	; write to DMA buffer
   220 0000066B 00800000            <1> 	dd	32768 ; 16 bit samples (not bytes)
   221                              <1> 
   222                              <1> playWav_vra:
   223                              <1> 	; 07/11/2023
   224                              <1> 	; clear buffer 2
   225                              <1>         ;push	es
   226                              <1> 	;mov	ax, [WAV_BUFFER2]
   227                              <1> 	;mov	es, ax
   228                              <1> 	;sub	ax, ax
   229                              <1> 	;mov	di, ax ; 17/02/2017
   230                              <1> 	;mov	cx, (BUFFERSIZE/2)
   231                              <1> 	;rep	stosw
   232                              <1> 	;pop	es	     
   233                              <1> 	
   234                              <1> 	; load 64k into buffer 1
   235 0000066F A1[D81D]            <1>         mov     ax, [WAV_BUFFER1]
   236                              <1>         ;call	loadFromFile
   237                              <1> 	; 13/11/2023
   238 00000672 FF16[6706]          <1> 	call	word [loadfromwavfile]
   239                              <1> 
   240                              <1> 	; and 64k into buffer 2
   241 00000676 A1[DA1D]            <1> 	mov     ax, [WAV_BUFFER2]
   242                              <1>        	;call	loadFromFile
   243                              <1> 	; 13/11/2023
   244 00000679 FF16[6706]          <1> 	call	word [loadfromwavfile]
   245                              <1> 
   246                              <1> ; register reset the DMA engine. This may cause a pop noise on the output
   247                              <1> ; lines when the device is reset. Prolly a better idea to mute output, then
   248                              <1> ; reset.
   249                              <1> 
   250                              <1> 	; 11/11/2023
   251                              <1>         ;mov	dx, [NABMBAR]
   252                              <1>         ;add	dx, PO_CR_REG		; set pointer to Ctrl reg
   253                              <1>         ;mov	al, RR			; set reset
   254                              <1> 	;out	dx, al			; self clearing bit
   255                              <1> 
   256                              <1> ; write last valid index to 31 to start with.
   257                              <1> ; The Last Valid Index register tells the DMA engine when to stop playing.
   258                              <1> ; 
   259                              <1> ; As we progress through the song we change the last valid index to always be
   260                              <1> ; something other than the index we're currently playing.  
   261                              <1> ;
   262                              <1> 	; 08/11/2023
   263                              <1> 	;; 07/11/2023
   264                              <1> 	;mov	al, 1
   265                              <1>         ;;mov	al, 31
   266                              <1> 	;call	setLastValidIndex
   267                              <1> 
   268                              <1> ; create Buffer Descriptor List
   269                              <1> ;
   270                              <1> ; A buffer descriptor list is a list of pointers and control bits that the
   271                              <1> ; DMA engine uses to know where to get the .wav data and how to play it.
   272                              <1> ;
   273                              <1> ; I set it up to use only 2 buffers of .wav data, and whenever 1 buffer is
   274                              <1> ; playing, I refresh the other one with good data.
   275                              <1> ;
   276                              <1> ;
   277                              <1> ; For the control bits, you can specify that the DMA engine fire an interrupt
   278                              <1> ; after a buffer has been processed, but I poll the current index register
   279                              <1> ; to know when it's safe to update the other buffer.
   280                              <1> ;
   281                              <1> ; I set the BUP bit, which tells the DMA engine to just play 0's (silence)
   282                              <1> ; if it ever runs out of data to play. Good for safety.
   283                              <1> ;
   284 0000067D 06                  <1>         push    es
   285 0000067E A1[D61D]            <1>         mov     ax, [BDL_BUFFER]		; get segment # for BDL
   286 00000681 8EC0                <1>         mov     es, ax
   287                              <1> 
   288 00000683 B91000              <1>         mov     cx, 32 / 2                      ; make 32 entries in BDL
   289 00000686 31FF                <1>         xor     di, di                          
   290                              <1> _0:
   291                              <1> 
   292                              <1> ; set buffer descriptor 0 to start of data file in memory
   293 00000688 660FB706[D81D]      <1>         movzx   eax, word [WAV_BUFFER1]
   294 0000068E 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   295 00000692 66AB                <1>         stosd                                   ; store pointer to wavbuffer1
   296                              <1> 
   297                              <1> ;
   298                              <1> ; set length to 32k samples. 1 sample is 16bits or 2bytes.
   299                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples.
   300                              <1> ; 
   301                              <1> 
   302                              <1> ; 17/02/2017 (Erdogan Tan)
   303                              <1> ; Intel 82801AA (ICH) & Intel 82801AB (ICH0) I/O Controller Hub AC97
   304                              <1> ; Programmers Reference Manual
   305                              <1> 
   306                              <1> ; 2.2.1 Buffer Descriptor List  (on Page 13)
   307                              <1> 	;
   308                              <1> 	;  Generic Form of Buffer Descriptor
   309                              <1> 	;  ---------------------------------
   310                              <1> 	;  63   62    61-48    47-32   31-0
   311                              <1> 	;  ---  ---  --------  ------- -----
   312                              <1> 	;  IOC  BUP -reserved- Buffer  Buffer
   313                              <1> 	;		      Length   Pointer
   314                              <1> 	;		      [15:0]   [31:0]
   315                              <1> 	;
   316                              <1> 	;  IOC:	Interrupt On Completion. 
   317                              <1> 	;	1 = Enabled. 
   318                              <1> 	;	    When this is set, it means that the controller should
   319                              <1> 	;	    issue an interrupt upon completion of this buffer.
   320                              <1> 	;	    It should also set the IOC bit in the status register
   321                              <1> 	;	0 = Disabled	
   322                              <1> 	;
   323                              <1> 	;  BUP: Buffer Underrun Policy.
   324                              <1> 	;       0 = When this buffer is complete,
   325                              <1> 	;	    if the next buffer is not yet ready 
   326                              <1> 	;	    (i.e., the last valid buffer has been processed),
   327                              <1> 	;	    then continue to transmit the last valid sample.
   328                              <1> 	;	1 = When this buffer is complete,
   329                              <1> 	;     	    if this is the last valid buffer, transmit zeros after
   330                              <1> 	;	    this buffer has been processed completely.
   331                              <1> 	;	    This bit typically is set only if this is the last 
   332                              <1> 	;	    buffer in the current stream.
   333                              <1> 	;
   334                              <1> 	; [31:0]: Buffer pointer. This field points to the location of
   335                              <1> 	;	  the data buffer. Since samples can be as wide as one
   336                              <1> 	;	  word, the buffer must be aligned with word boundaries,
   337                              <1> 	;	  to prevent samples from straddling DWord boundaries.
   338                              <1> 	;
   339                              <1> 	; [15:0]: Buffer Length: This is the length of the data buffer,
   340                              <1> 	;	  in number of samples. The controller uses this data
   341                              <1> 	;	  to determine the length of the buffer, in bytes.
   342                              <1> 	;	  "0" indicates no sample to process.
   343                              <1> 
   344                              <1> ; ICH2AC97.INC
   345                              <1> 
   346                              <1> ;	IOC	equ     BIT31   ; Fire an interrupt whenever this
   347                              <1> 				; buffer is complete.
   348                              <1> 
   349                              <1> ;	BUP	equ     BIT30   ; Buffer Underrun Policy.
   350                              <1> 				; if this buffer is the last buffer
   351                              <1> 				; in a playback, fill the remaining
   352                              <1> 				; samples with 0 (silence) or not.
   353                              <1> 				; It's a good idea to set this to 1
   354                              <1> 				; for the last buffer in playback,
   355                              <1> 				; otherwise you're likely to get a lot
   356                              <1> 				; of noise at the end of the sound.
   357                              <1> ;
   358                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   359                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   360                              <1> ; Luckily for us, that's the same format as .wav files.
   361                              <1> ;
   362                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   363                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   364                              <1> ;
   365                              <1> ; A value of 0 in these bits means play no samples.
   366                              <1> ;
   367                              <1> 
   368                              <1> ; ICHWAV.ASM
   369                              <1> 
   370                              <1> 	;mov	eax, BUFFERSIZE / 2 ; size of half buffer (32K)
   371                              <1> 	; 13/11/2023
   372 00000694 66A1[6B06]          <1> 	mov	eax, [buffersize]
   373                              <1> 
   374                              <1> 	; 09/11/2023
   375 00000698 660D000000C0        <1> 	or	eax, IOC + BUP
   376                              <1> 	; 06/11/2023
   377                              <1> 	;or	eax, BUP
   378 0000069E 66AB                <1> 	stosd
   379                              <1> 
   380                              <1> ; 2nd buffer:
   381                              <1> 
   382 000006A0 660FB706[DA1D]      <1>         movzx   eax, word [WAV_BUFFER2]
   383 000006A6 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   384 000006AA 66AB                <1>         stosd                                   ; store pointer to wavbuffer2
   385                              <1> 
   386                              <1> ; set length to 64k (32k of two 16 bit samples)
   387                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples
   388                              <1> ; 
   389                              <1> 	;mov	eax, BUFFERSIZE / 2
   390                              <1> 	; 13/11/2023
   391 000006AC 66A1[6B06]          <1> 	mov	eax, [buffersize]
   392                              <1> 
   393                              <1> 	; 09/11/2023
   394 000006B0 660D000000C0        <1> 	or	eax, IOC + BUP
   395                              <1> 	; 06/11/2023
   396                              <1> 	;or	eax, BUP
   397 000006B6 66AB                <1> 	stosd
   398                              <1> 
   399 000006B8 E2CE                <1>         loop    _0
   400 000006BA 07                  <1>         pop     es
   401                              <1> 
   402                              <1> ;
   403                              <1> ; tell the DMA engine where to find our list of Buffer Descriptors.
   404                              <1> ; this 32bit value is a flat mode memory offset (ie no segment:offset)
   405                              <1> ;
   406                              <1> ; write NABMBAR+10h with offset of buffer descriptor list
   407                              <1> ;
   408 000006BB 660FB706[D61D]      <1>         movzx   eax, word [BDL_BUFFER]
   409 000006C1 66C1E004            <1> 	shl     eax, 4                          ; convert seg:off to 0:off
   410 000006C5 8B16[D41D]          <1>         mov     dx, [NABMBAR]
   411 000006C9 83C210              <1>         add     dx, PO_BDBAR_REG                ; set pointer to BDL
   412 000006CC 66EF                <1>         out     dx, eax                         ; write to AC97 controller
   413                              <1> 
   414                              <1> ;
   415                              <1> ; All set. Let's play some music.
   416                              <1> ;
   417                              <1> 
   418                              <1> 	; 10/11/2023
   419                              <1> 	; 08/11/2023
   420                              <1> 	; 07/11/2023
   421                              <1> 	; 08/12/2016
   422                              <1> 	; 07/10/2016
   423                              <1> 	;mov	al, 1
   424 000006CE B01F                <1> 	mov	al, 31
   425 000006D0 A2[EC1D]            <1> 	mov	[LVI], al ; 10/11/2023
   426 000006D3 E87F01              <1> 	call	setLastValidIndex
   427                              <1> 
   428                              <1> 	; 06/11/2023 (not neccessary)
   429                              <1> 	;; 05/11/2023
   430                              <1> 	;; reset current index
   431                              <1> 	;mov	al, 0
   432                              <1> 	;call	setCurrentIndex
   433                              <1> 
   434                              <1> 	; 06/11/2023
   435                              <1> 	;mov	byte [tLoop], 1 ; 30/11/2016
   436                              <1> 
   437                              <1> 	; 17/02/2017
   438 000006D6 8B16[D41D]          <1>         mov     dx, [NABMBAR]
   439 000006DA 83C21B              <1>         add     dx, PO_CR_REG                   ; PCM out Control Register
   440                              <1>         ; 09/11/2023
   441 000006DD B011                <1> 	mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
   442                              <1> 	;			; (LVBI interrupt will not be enabled)
   443                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   444                              <1> 	;mov	al, RPBM
   445 000006DF EE                  <1> 	out     dx, al                          ; Start bus master operation.
   446                              <1> 
   447                              <1> 	; 09/11/2023
   448 000006E0 C606[EB1D]3F        <1> 	mov	byte [b_indicator], '?'	
   449                              <1> 
   450                              <1> 	; 06/11/2023
   451                              <1> 	;call	delay1_4ms
   452                              <1> 	;call	delay1_4ms
   453                              <1> 	;call	delay1_4ms
   454                              <1> 	;call	delay1_4ms
   455                              <1> 
   456                              <1> 	; 10/11/2023
   457                              <1> 	;mov	byte [tloop], 1
   458                              <1> 
   459                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   460                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   461                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   462                              <1> 
   463                              <1> ; 09/11/2023   
   464                              <1> ; 06/11/2023
   465                              <1> %if 1
   466                              <1> 	; 08/12/2016
   467                              <1> 	; 28/11/2016
   468                              <1> p_loop:
   469 000006E5 E87601              <1> 	call    check4keyboardstop ; keyboard halt?
   470 000006E8 732A                <1>         jnc	short r_loop 	   ; no ; 09/11/2023
   471                              <1> 
   472                              <1> 	; 09/11/2023
   473                              <1> 	;or	byte [flags], ENDOFFILE
   474                              <1> 	;mov	byte [b_indicator], '0'
   475                              <1> q_loop:
   476                              <1> 	;mov	al, '0'
   477 000006EA E88D00              <1> 	call	tL0
   478                              <1> 
   479                              <1> 	; 04/11/2023
   480                              <1> 	; finished with song, stop everything
   481 000006ED E89F14              <1> 	call	ac97_stop
   482                              <1> 
   483                              <1> 	; 11/11/2023
   484                              <1> irq_restore:	
   485                              <1> 	; restore previous interrupt vector and interrupt_status
   486 000006F0 FA                  <1> 	cli
   487 000006F1 E4A1                <1> 	in	al, 0A1h ; irq 8-15
   488 000006F3 A0[CD1D]            <1> 	mov	al, [IRQ_status+1]
   489 000006F6 E6A1                <1> 	out	0A1h, al 
   490 000006F8 E421                <1> 	in	al, 021h ; irq 0-7
   491 000006FA A0[CC1D]            <1> 	mov	al, [IRQ_status]
   492 000006FD E621                <1> 	out	21h, al 
   493                              <1> 	; ...
   494 000006FF 06                  <1> 	push	es
   495 00000700 31C0                <1> 	xor	ax, ax
   496 00000702 8EC0                <1> 	mov	es, ax
   497 00000704 A1[CE1D]            <1> 	mov	ax, [IRQ_vector]
   498 00000707 268907              <1> 	mov	[es:bx], ax
   499 0000070A A1[D01D]            <1> 	mov	ax, [IRQ_vector+2]
   500 0000070D 26894702            <1> 	mov	[es:bx+2], ax
   501 00000711 07                  <1> 	pop	es
   502 00000712 FB                  <1> 	sti
   503 00000713 C3                  <1> 	retn
   504                              <1> 
   505                              <1> r_loop:
   506                              <1> 	; 10/11/2023
   507                              <1> 	;nop
   508                              <1> 	;nop
   509                              <1> 	;nop
   510                              <1> 
   511                              <1> 	; 11/11/2023	
   512 00000714 B030                <1> 	mov	al, '0'
   513 00000716 803E[CB1D]00        <1> 	cmp	byte [tloop], 0
   514 0000071B 74C8                <1> 	je	short p_loop
   515 0000071D 7CCB                <1> 	jl	short q_loop
   516                              <1> 
   517 0000071F FE0E[CB1D]          <1> 	dec	byte [tloop] ; 0
   518                              <1> 
   519 00000723 803E[EB1D]31        <1> 	cmp	byte [b_indicator], '1'
   520 00000728 7515                <1> 	jne	short s_loop
   521                              <1> 
   522                              <1> 	; load buffer 1
   523 0000072A A1[D81D]            <1> 	mov	ax, [WAV_BUFFER1]
   524                              <1> u_loop:
   525                              <1> 	;call	loadFromFile
   526                              <1> 	; 13/11/2023
   527 0000072D FF16[6706]          <1> 	call	[loadfromwavfile]
   528 00000731 7304                <1> 	jnc	short v_loop
   529 00000733 B030                <1> 	mov	al, '0'
   530 00000735 EBB3                <1> 	jmp	short q_loop
   531                              <1> v_loop:
   532                              <1> 	; 09/11/2023 - Erdogan Tan
   533                              <1> 	; (print buffer number on top left of the screen)
   534 00000737 A0[EB1D]            <1> 	mov	al, [b_indicator]
   535 0000073A E83D00              <1> 	call	tL0
   536 0000073D EBA6                <1> 	jmp	short p_loop
   537                              <1> s_loop:
   538                              <1> 	; load buffer 2
   539 0000073F A1[DA1D]            <1> 	mov	ax, [WAV_BUFFER2]
   540 00000742 EBE9                <1> 	jmp	short u_loop
   541                              <1> 
   542                              <1> %endif
   543                              <1> 
   544                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   545                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   546                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   547                              <1> 
   548                              <1> ; 11/11/2023
   549                              <1> ; 10/11/2023
   550                              <1> ; 09/11/2023
   551                              <1> ; 08/11/2023
   552                              <1> ; 07/11/2023
   553                              <1> %if 1
   554                              <1> 
   555                              <1> tuneLoop:
   556                              <1> 	; 11/11/2023
   557                              <1> 	; 10/11/2023
   558                              <1> 	; 09/11/2023
   559                              <1> 	; 08/11/2023
   560                              <1> 	; 06/11/2023
   561                              <1> 	;mov	al, '1'
   562                              <1> 	;call	tL0
   563                              <1> tL1:
   564                              <1> 	; 10/11/2023
   565                              <1> 	;mov	byte [tloop], 1
   566                              <1> 
   567                              <1> 	; 11/11/2023
   568                              <1> 	;call    updateLVI	; set LVI != CIV
   569                              <1> 	;jz	short tL4	
   570                              <1> 
   571                              <1> 	; 11/11/2023
   572 00000744 C606[CB1D]01        <1> 	mov	byte [tloop], 1
   573                              <1> 
   574 00000749 E80001              <1> 	call    getCurrentIndex
   575                              <1> 
   576                              <1> 	; 10/11/2023
   577 0000074C 3A06[EC1D]          <1> 	cmp	al, [LVI]
   578 00000750 7511                <1> 	jne	short tL2
   579                              <1> 
   580 00000752 F606[C81D]01        <1> 	test	byte [flags], ENDOFFILE
   581                              <1> 	;jnz	short tL2
   582 00000757 751A                <1> 	jnz	short tL4
   583                              <1> 
   584 00000759 48                  <1> 	dec	ax
   585 0000075A 241F                <1> 	and	al, 1Fh 
   586 0000075C E8F600              <1> 	call	setLastValidIndex	
   587 0000075F 8606[EC1D]          <1> 	xchg	al, [LVI]
   588                              <1> 
   589                              <1> tL2:
   590 00000763 A801                <1> 	test	al, BIT0
   591 00000765 7406                <1> 	jz	short tL3
   592                              <1> 
   593 00000767 C606[EB1D]31        <1> 	mov	byte [b_indicator], '1'
   594 0000076C C3                  <1> 	retn
   595                              <1> tL3:	
   596 0000076D C606[EB1D]32        <1> 	mov	byte [b_indicator], '2'
   597 00000772 C3                  <1> 	retn
   598                              <1> tL4:
   599                              <1> 	; 11/11/2023
   600 00000773 C606[CB1D]FF        <1> 	mov	byte [tloop], -1
   601 00000778 F9                  <1> 	stc
   602 00000779 C3                  <1> 	retn
   603                              <1> 
   604                              <1> 
   605                              <1> 	; 06/11/2023
   606                              <1> tL0:
   607                              <1> 	; 08/11/2023
   608                              <1> 	; 05/11/2023
   609                              <1> 	; 17/02/2017 - Buffer switch test (temporary)
   610                              <1> 	; 06/11/2023
   611                              <1> 	; al = buffer indicator ('1', '2' or '0' -stop- )
   612 0000077A 1E                  <1> 	push	ds
   613                              <1> 	;push	bx 
   614 0000077B BB00B8              <1> 	mov	bx, 0B800h ; video display page segment
   615 0000077E 8EDB                <1> 	mov	ds, bx
   616 00000780 29DB                <1> 	sub	bx, bx ; 0
   617 00000782 B44E                <1> 	mov	ah, 4Eh
   618 00000784 8907                <1> 	mov	[bx], ax ; show current play buffer (1, 2)
   619                              <1> 	;pop	bx
   620 00000786 1F                  <1> 	pop	ds
   621 00000787 C3                  <1> 	retn
   622                              <1> 
   623                              <1> %endif
   624                              <1> 
   625                              <1> ; 08/11/2023
   626                              <1> ; 07/11/2023
   627                              <1> %if 0
   628                              <1> 
   629                              <1> tuneLoop:
   630                              <1> 	; 07/11/2023
   631                              <1> 	;mov	dx, NABMBAR
   632                              <1> 	;add	dx, PO_CIV_REG ; 14h
   633                              <1> tL1:
   634                              <1> 	call    updateLVI	; set LVI != CIV
   635                              <1> 	call    check4keyboardstop
   636                              <1> 	jc	short _exit_
   637                              <1> 	call    getCurrentIndex
   638                              <1> 	test	al, BIT0
   639                              <1> 	jz	short tL1	; loop if buffer 2 is not playing
   640                              <1> 
   641                              <1> 	; load buffer 1
   642                              <1> 	mov     ax, [WAV_BUFFER1]
   643                              <1> 	call	loadFromFile
   644                              <1> 	jc	short _exit_	; end of file
   645                              <1> tL2:
   646                              <1> 	call    updateLVI
   647                              <1> 	call    check4keyboardstop
   648                              <1> 	jc	short _exit_
   649                              <1> 	call    getCurrentIndex
   650                              <1> 	test	al, BIT0
   651                              <1> 	jnz	short tL2	; loop if buffer 1 is not playing
   652                              <1> 
   653                              <1> 	; load buffer 2
   654                              <1> 	mov     ax, [WAV_BUFFER2]
   655                              <1> 	call	loadFromFile
   656                              <1> 	jnc	short tuneLoop
   657                              <1> _exit_:
   658                              <1> 	mov	dx, [NABMBAR]		
   659                              <1> 	add	dx, PO_CR_REG	; PCM out Control Register
   660                              <1> 	mov	al, 0
   661                              <1> 	out	dx, al		; stop player
   662                              <1> 	retn
   663                              <1> 
   664                              <1> %endif
   665                              <1> 
   666                              <1> ; load data from file in 32k chunks. Would be nice to load 1 64k chunk,
   667                              <1> ; but in DOS you can only load FFFF bytes at a time.
   668                              <1> ;
   669                              <1> ; entry: ax = segment to load data to
   670                              <1> ; exit: CY set if end of file reached.
   671                              <1> ; note: last file buffer is padded with 0's to avoid pops at the end of song.
   672                              <1> ; assumes file is already open. uses [filehandle]
   673                              <1> 
   674                              <1> ; 07/11/2023
   675                              <1> %if 0
   676                              <1> 
   677                              <1> loadFromFile:
   678                              <1> 	; 07/11/2023
   679                              <1> 	; 06/11/2023
   680                              <1> 	; 17/02/2017
   681                              <1> 	;push	ax
   682                              <1> 	;push	cx
   683                              <1> 	;push	dx
   684                              <1> 	;push	bx
   685                              <1> 
   686                              <1> 	;push	es
   687                              <1> 	;push	ds
   688                              <1> 	
   689                              <1>         test    byte [flags], ENDOFFILE	; have we already read the
   690                              <1> 	;stc				; last of the file?
   691                              <1> 	; 05/11/2023
   692                              <1> 	;jnz	endLFF
   693                              <1> 	jz	short lff_12	; 06/11/2023
   694                              <1> 	; 06/11/2023
   695                              <1> 	;;mov	byte [tLoop], 0
   696                              <1> 	;jmp	endLFF
   697                              <1> 	stc
   698                              <1> 	retn
   699                              <1> 
   700                              <1> lff_12:	; 06/11/2023    
   701                              <1> 	mov	[fbs_seg], ax ; save buffer segment
   702                              <1> 	xor	dx, dx
   703                              <1> lff_0:
   704                              <1> 	mov	[fbs_off], dx ; buffer offset
   705                              <1> 
   706                              <1> 	mov     bx, (BUFFERSIZE / 2)	; 32k chunk
   707                              <1> 	mov	cl, [fbs_shift]   
   708                              <1> 	and	cl, cl
   709                              <1> 	jz	short lff_1 ; stereo, 16 bit	
   710                              <1> 
   711                              <1> 	; fbs_shift =
   712                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   713                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   714                              <1> 	shr	bx, cl ; 32K / multiplier
   715                              <1> 
   716                              <1> 	mov	ax, cs
   717                              <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   718                              <1> lff_1:
   719                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   720                              <1> 	; load file into memory
   721                              <1>         mov	cx, bx                         
   722                              <1> 	mov	bx, [filehandle]
   723                              <1> 	mov     ds, ax
   724                              <1>        	mov	ah, 3fh
   725                              <1> 	int	21h
   726                              <1> 
   727                              <1> 	mov	bx, cs
   728                              <1> 	mov	ds, bx
   729                              <1> 
   730                              <1> 	jc	short lff_9 ; error !
   731                              <1> 
   732                              <1> 	and	ax, ax
   733                              <1> 	jz	short lff_10
   734                              <1> 	
   735                              <1> 	mov	bl, [fbs_shift] ; shift count  
   736                              <1> 	or	bl, bl
   737                              <1> 	jz	short lff_7 ; 16 bit stereo samples
   738                              <1> 
   739                              <1> 	push	es
   740                              <1> 	; 06/11/2023
   741                              <1> 	;push	di
   742                              <1> 	;push	si
   743                              <1> 	mov	di, [fbs_off]
   744                              <1> 	mov	si, [fbs_seg] ; buffer segment
   745                              <1> 	mov	es, si
   746                              <1> 	mov	si, temp_buffer ; temporary buffer address
   747                              <1> 	mov	cl, [bps] ; bits per sample (8 or 16)
   748                              <1> 	cmp	cl, 8
   749                              <1> 	jne	short lff_4 ; 16 bit samples
   750                              <1> 	; 8 bit samples
   751                              <1> 	mov	cx, ax ; byte count
   752                              <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   753                              <1> 	jz	short lff_3 ; 8 bit, stereo
   754                              <1> lff_2:
   755                              <1> 	; mono & 8 bit
   756                              <1> 	lodsb
   757                              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   758                              <1> 	stosw	; left channel
   759                              <1> 	stosw	; right channel
   760                              <1> 	loop	lff_2
   761                              <1> 	jmp	short lff_6	
   762                              <1> lff_3:
   763                              <1> 	; stereo & 8 bit
   764                              <1> 	lodsb
   765                              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   766                              <1> 	stosw
   767                              <1> 	loop	lff_3			
   768                              <1> 	jmp	short lff_6
   769                              <1> lff_4:
   770                              <1> 	; 16 bit mono samples
   771                              <1> 	mov	cx, ax ; word count
   772                              <1> lff_5:	
   773                              <1> 	lodsw
   774                              <1> 	stosw	; left channel
   775                              <1> 	stosw	; right channel
   776                              <1> 	loop	lff_5
   777                              <1> lff_6:
   778                              <1> 	mov	ax, di ; save next buffer offset/position
   779                              <1> 	; 06/11/2023
   780                              <1> 	;pop	si
   781                              <1> 	;pop	di
   782                              <1> 	pop	es
   783                              <1> ;lff_7:        
   784                              <1> 	; 06/11/2023
   785                              <1> 	and	ax, ax
   786                              <1> 	jz	short endLFF ; end of 2nd half
   787                              <1> 	mov	cx, (BUFFERSIZE / 2)
   788                              <1> lff_7:
   789                              <1> 	cmp	ax, cx
   790                              <1> 	je	short endLFF	 ; 06/11/2023
   791                              <1> 	;jb	short lff_11
   792                              <1> 	;xor	cx, cx
   793                              <1> 	;sub	cx, ax
   794                              <1> 	;neg	cx
   795                              <1> 	jmp	short lff_11
   796                              <1> lff_8:
   797                              <1> 	; 07/11/2023
   798                              <1> 	cmp	word [fbs_off], (BUFFERSIZE / 2) ; 32768
   799                              <1> 	jnb	short endLFF
   800                              <1> 	
   801                              <1> 	mov	dx, ax ; buffer offset
   802                              <1> 	mov	ax, [fbs_seg] ; buffer segment
   803                              <1> 	jmp	lff_0
   804                              <1> lff_9:  
   805                              <1> 	; 07/11/2023
   806                              <1> 	;; 06/11/2023 (temporary)
   807                              <1> 	;mov	al, '!'  ; error
   808                              <1> 	;call	tL0
   809                              <1> 
   810                              <1> 	xor	ax, ax
   811                              <1> lff_10:
   812                              <1> 	; 07/11/2023
   813                              <1> 	;mov	cx, (BUFFERSIZE / 2)  
   814                              <1> lff_11:
   815                              <1> 	call    padfill				; blank pad the remainder
   816                              <1>         ;clc					; don't exit with CY yet.
   817                              <1>         or	byte [flags], ENDOFFILE		; end of file flag
   818                              <1> endLFF:
   819                              <1>         ;pop	ds
   820                              <1> 	;pop	es
   821                              <1> 	; 06/11/2023
   822                              <1> 	;pop	bx
   823                              <1> 	;pop	dx
   824                              <1>         ;pop	cx
   825                              <1>         ;pop	ax
   826                              <1>         retn
   827                              <1> 
   828                              <1> %endif
   829                              <1> 
   830                              <1> ; 08/11/2023
   831                              <1> ; 07/11/2023
   832                              <1> %if 1
   833                              <1> 
   834                              <1> loadFromFile:
   835                              <1> 	; 07/11/2023
   836                              <1> 
   837 00000788 F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
   838                              <1> 					; last of the file?
   839 0000078D 7402                <1> 	jz	short lff_0		; no
   840 0000078F F9                  <1> 	stc
   841 00000790 C3                  <1> 	retn
   842                              <1> 
   843                              <1> lff_0:
   844                              <1> 	; 08/11/2023
   845 00000791 89C5                <1> 	mov	bp, ax ; save buffer segment	
   846                              <1> 
   847 00000793 8A0E[EA1D]          <1> 	mov	cl, [fbs_shift]   
   848 00000797 20C9                <1> 	and	cl, cl
   849 00000799 7470                <1> 	jz	short lff_1 ; stereo, 16 bit	
   850                              <1> 
   851 0000079B BFFFFF              <1> 	mov	di, BUFFERSIZE - 1 ; 65535
   852                              <1> 
   853                              <1> 	; fbs_shift =
   854                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   855                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   856 0000079E D3EF                <1> 	shr	di, cl
   857 000007A0 47                  <1> 	inc	di ; 16384 for 8 bit and mono	
   858                              <1> 		   ; 32768 for 8 bit or mono	
   859                              <1> 
   860 000007A1 8CC8                <1> 	mov	ax, cs
   861 000007A3 BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   862                              <1> 
   863                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   864                              <1> 	; load file into memory
   865 000007A6 89F9                <1>         mov	cx, di                       
   866 000007A8 8B1E[C61D]          <1> 	mov	bx, [filehandle]
   867 000007AC 8ED8                <1> 	mov     ds, ax
   868 000007AE B43F                <1>        	mov	ah, 3Fh
   869 000007B0 CD21                <1> 	int	21h
   870                              <1> 
   871 000007B2 8CCB                <1> 	mov	bx, cs
   872 000007B4 8EDB                <1> 	mov	ds, bx
   873                              <1> 
   874 000007B6 724A                <1> 	jc	short lff_4 ; error !
   875                              <1> 
   876                              <1> 	; 08/11/2023
   877 000007B8 31D2                <1> 	xor	dx, dx ; 0
   878                              <1> 
   879 000007BA 21C0                <1> 	and	ax, ax
   880 000007BC 7476                <1> 	jz	short lff_3
   881                              <1> 
   882 000007BE 8A1E[EA1D]          <1> 	mov	bl, [fbs_shift]
   883                              <1> 
   884 000007C2 06                  <1> 	push	es
   885 000007C3 89D7                <1> 	mov	di, dx ; 0 ; [fbs_off]
   886                              <1> 	;mov	bp, [fbs_seg] ; buffer segment
   887 000007C5 8EC5                <1> 	mov	es, bp
   888 000007C7 BE[EE1D]            <1> 	mov	si, temp_buffer ; temporary buffer address
   889 000007CA 89C1                <1> 	mov	cx, ax ; byte count
   890 000007CC 803E[E81D]08        <1> 	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   891 000007D1 751B                <1> 	jne	short lff_7 ; 16 bit samples
   892                              <1> 	; 8 bit samples
   893 000007D3 FECB                <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   894 000007D5 740C                <1> 	jz	short lff_6 ; 8 bit, stereo
   895                              <1> lff_5:
   896                              <1> 	; mono & 8 bit
   897 000007D7 AC                  <1> 	lodsb
   898 000007D8 2C80                <1> 	sub	al, 80h ; 08/11/2023
   899 000007DA C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   900 000007DD AB                  <1> 	stosw	; left channel
   901 000007DE AB                  <1> 	stosw	; right channel
   902 000007DF E2F6                <1> 	loop	lff_5
   903 000007E1 EB12                <1> 	jmp	short lff_9	
   904                              <1> lff_6:
   905                              <1> 	; stereo & 8 bit
   906 000007E3 AC                  <1> 	lodsb
   907 000007E4 2C80                <1> 	sub	al, 80h ; 08/11/2023
   908 000007E6 C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   909 000007E9 AB                  <1> 	stosw
   910 000007EA E2F7                <1> 	loop	lff_6			
   911 000007EC EB07                <1> 	jmp	short lff_9
   912                              <1> lff_7:
   913 000007EE D1E9                <1> 	shr	cx, 1 ; word count
   914                              <1> lff_8:
   915 000007F0 AD                  <1> 	lodsw
   916 000007F1 AB                  <1> 	stosw	; left channel
   917 000007F2 AB                  <1> 	stosw	; right channel
   918 000007F3 E2FB                <1> 	loop	lff_8
   919                              <1> lff_9:
   920 000007F5 07                  <1> 	pop	es
   921 000007F6 09FF                <1> 	or	di, di
   922 000007F8 7442                <1> 	jz	short endLFF ; 64KB ok 
   923                              <1> 	
   924 000007FA 89F8                <1> 	mov	ax, di ; [fbs_off]
   925 000007FC 48                  <1> 	dec	ax
   926 000007FD B9FFFF              <1> 	mov	cx, BUFFERSIZE - 1 ; 65535
   927 00000800 EB32                <1> 	jmp	short lff_3
   928                              <1> 
   929                              <1> lff_4:
   930                              <1> 	; 08/11/2023
   931 00000802 B021                <1> 	mov	al, '!'  ; error
   932 00000804 E873FF              <1> 	call	tL0
   933                              <1> 
   934 00000807 31C0                <1> 	xor	ax, ax
   935 00000809 EB29                <1> 	jmp	short lff_3
   936                              <1> 	
   937                              <1> lff_1:  
   938                              <1> 	;mov	bp, ax ; save buffer segment
   939 0000080B 31D2                <1> 	xor	dx, dx
   940                              <1> 	; load file into memory
   941 0000080D B90080              <1>         mov	cx, (BUFFERSIZE / 2)	; 32k chunk
   942 00000810 8B1E[C61D]          <1> 	mov	bx, [filehandle]
   943 00000814 8ED8                <1> 	mov     ds, ax
   944 00000816 B43F                <1>        	mov	ah, 3Fh
   945 00000818 CD21                <1> 	int	21h
   946                              <1> 
   947 0000081A 8CCF                <1> 	mov	di, cs
   948 0000081C 8EDF                <1> 	mov	ds, di
   949                              <1> 
   950                              <1> 	; 07/11/2023
   951 0000081E 72E2                <1> 	jc	short lff_4 ; error !
   952                              <1> 	
   953 00000820 39C8                <1> 	cmp	ax, cx
   954 00000822 7510                <1> 	jne	short lff_3
   955                              <1> lff_2:
   956                              <1> 	; 08/11/2023
   957 00000824 01C2                <1> 	add	dx, ax
   958                              <1> 	;mov	cx, (BUFFERSIZE / 2)	; 32k chunk
   959                              <1> 	;mov	bx, [filehandle]
   960 00000826 8EDD                <1> 	mov     ds, bp
   961 00000828 B43F                <1>        	mov	ah, 3Fh
   962 0000082A CD21                <1> 	int	21h
   963                              <1> 
   964                              <1> 	;mov	di, cs
   965 0000082C 8EDF                <1> 	mov	ds, di
   966                              <1> 
   967 0000082E 72D2                <1> 	jc	short lff_4 ; error !
   968                              <1> 
   969 00000830 39C8                <1> 	cmp	ax, cx
   970 00000832 7408                <1> 	je	short endLFF
   971                              <1> lff_3:
   972 00000834 E80600              <1> 	call    padfill			; blank pad the remainder
   973                              <1>         ;clc				; don't exit with CY yet.
   974 00000837 800E[C81D]01        <1>         or	byte [flags], ENDOFFILE	; end of file flag
   975                              <1> endLFF:
   976 0000083C C3                  <1>         retn
   977                              <1> 
   978                              <1> %endif
   979                              <1> 
   980                              <1> ; entry ds:ax points to last byte in file
   981                              <1> ; cx=target size
   982                              <1> ; note: must do byte size fill
   983                              <1> ; destroys bx, cx
   984                              <1> ;
   985                              <1> padfill:
   986                              <1> 	; 07/11/2023
   987                              <1> 	; 06/11/2023
   988                              <1> 	; 17/02/2017
   989 0000083D 06                  <1> 	push	es
   990                              <1>         ;push	di
   991                              <1> 	;mov	di, [fbs_seg]
   992                              <1> 	;mov	es, di
   993 0000083E 8EC5                <1>         mov	es, bp
   994 00000840 29C1                <1> 	sub	cx, ax
   995                              <1> 	; 08/11/2023
   996                              <1> 	;mov	di, ax ; (wrong)
   997 00000842 89D7                <1> 	mov	di, dx ; buffer offset
   998 00000844 01C7                <1> 	add	di, ax       	
   999                              <1> 	; 07/11/2023
  1000                              <1> 	;add	di, [fbs_off]
  1001 00000846 30C0                <1>         xor	al, al
  1002 00000848 F3AA                <1> 	rep	stosb
  1003                              <1> 	;mov	[fbs_off], di
  1004                              <1> 	;pop	di
  1005 0000084A 07                  <1>         pop	es
  1006 0000084B C3                  <1> 	retn
  1007                              <1> 
  1008                              <1> ; returns AL = current index value
  1009                              <1> getCurrentIndex:
  1010                              <1> 	; 08/11/2023
  1011                              <1> 	;push	dx
  1012 0000084C 8B16[D41D]          <1> 	mov	dx, [NABMBAR]      		
  1013 00000850 83C214              <1> 	add	dx, PO_CIV_REG
  1014 00000853 EC                  <1> 	in	al, dx
  1015                              <1> 	;pop	dx
  1016                              <1> uLVI2:	;	06/11/2023
  1017 00000854 C3                  <1> 	retn
  1018                              <1> 
  1019                              <1> ; examines the CIV and the LVI. When they're the same, we set LVI <> CIV
  1020                              <1> ; that way, we never run out of buffers to play
  1021                              <1> 
  1022                              <1> ; 08/11/2023
  1023                              <1> %if 0
  1024                              <1> 	; 07/11/2023
  1025                              <1> updateLVI:
  1026                              <1> 	push	ax
  1027                              <1> 	push	dx
  1028                              <1> 	; 06/11/2023
  1029                              <1> 	mov	dx, [NABMBAR]
  1030                              <1> 	add	dx, PO_CIV_REG
  1031                              <1> 	; (Current Index Value and Last Valid Index value)
  1032                              <1> 	in	ax, dx
  1033                              <1> 
  1034                              <1> 	cmp	al, ah ; is current index = last index ?
  1035                              <1> 	jne	short uLVI1
  1036                              <1> 
  1037                              <1> 	call	setNewIndex
  1038                              <1> uLVI1:
  1039                              <1> 	pop	dx
  1040                              <1> 	pop	ax
  1041                              <1> 	retn
  1042                              <1> 
  1043                              <1> setNewIndex:
  1044                              <1> 	; 07/11/2023
  1045                              <1> 	push	ax
  1046                              <1>         call    getCurrentIndex                 ; get CIV
  1047                              <1>         test    byte [flags], ENDOFFILE
  1048                              <1>         jnz     short sni_1
  1049                              <1>         ; not at the end of the file yet.
  1050                              <1>         dec     al                              ; make new index <> current
  1051                              <1>         and     al, INDEX_MASK                  ; make sure new value is 0-31
  1052                              <1> sni_1:
  1053                              <1>         call    setLastValidIndex               ; write new value
  1054                              <1>         clc
  1055                              <1>         pop	ax
  1056                              <1> 	retn
  1057                              <1> 
  1058                              <1> %endif	
  1059                              <1> 
  1060                              <1> ; 08/11/2023
  1061                              <1> ; 07/11/2023
  1062                              <1> %if 0
  1063                              <1> updateLVI:
  1064                              <1> 	; 06/11/2023
  1065                              <1> 	mov	dx, [NABMBAR]      		
  1066                              <1> 	add	dx, PO_CIV_REG
  1067                              <1> 	; (Current Index Value and Last Valid Index value)
  1068                              <1> 	in	ax, dx
  1069                              <1> 
  1070                              <1> 	cmp	al, ah ; is current index = last index ?
  1071                              <1> 	jne	short uLVI2
  1072                              <1> 
  1073                              <1> 	; 10/11/2023
  1074                              <1> 	; 08/11/2023	
  1075                              <1> 	call	getCurrentIndex
  1076                              <1>  
  1077                              <1> 	test	byte [flags], ENDOFFILE
  1078                              <1> 	;jnz	short uLVI1
  1079                              <1> 	jz	short uLVI0  ; 08/11/2023
  1080                              <1> 
  1081                              <1> 	; 08/11/2023
  1082                              <1> 	push	ax
  1083                              <1> 	mov	dx, [NABMBAR]
  1084                              <1> 	add	dx, PO_SR_REG  ; PCM out status register
  1085                              <1> 	in	ax, dx
  1086                              <1> 
  1087                              <1> 	;test	al, 2
  1088                              <1> 	test	al, 3 ; bit 1 = Current Equals Last Valid (CELV)
  1089                              <1> 		      ; (has been processed)
  1090                              <1> 		      ; bit 0 = 1 -> DMA Controller Halted (DCH)
  1091                              <1> 	pop	ax
  1092                              <1> 	jz	short uLVI1
  1093                              <1> uLVI3:
  1094                              <1> 	xor	ax, ax
  1095                              <1> 	; zf = 1
  1096                              <1> 	retn
  1097                              <1> uLVI0:
  1098                              <1>         ; not at the end of the file yet.
  1099                              <1> 	dec	al
  1100                              <1> 	and	al, 1Fh
  1101                              <1> uLVI1:
  1102                              <1> 	;call	setLastValidIndex
  1103                              <1> ;uLVI2:
  1104                              <1> 	;retn
  1105                              <1> 
  1106                              <1> %endif
  1107                              <1> 	
  1108                              <1> ;input AL = index # to stop on
  1109                              <1> setLastValidIndex:
  1110                              <1> 	; 08/11/2023
  1111                              <1> 	;push	dx
  1112 00000855 8B16[D41D]          <1> 	mov	dx, [NABMBAR]
  1113 00000859 83C215              <1> 	add	dx, PO_LVI_REG
  1114 0000085C EE                  <1>         out     dx, al
  1115                              <1> 	;pop	dx
  1116 0000085D C3                  <1> 	retn
  1117                              <1> 
  1118                              <1> ; 06/11/2023
  1119                              <1> ;	; 05/11/2023
  1120                              <1> ;setCurrentIndex:
  1121                              <1> ;	;push	dx
  1122                              <1> ;	mov	dx, [NABMBAR]
  1123                              <1> ;	add	dx, PO_CIV_REG
  1124                              <1> ;	out	dx, al
  1125                              <1> ;	;pop	dx
  1126                              <1> ;	retn
  1127                              <1> 
  1128                              <1> ; checks if either shift key has been pressed. Exits with CY if so.
  1129                              <1> ; 
  1130                              <1> check4keyboardstop:
  1131                              <1> 
  1132                              <1> ; 06/11/2023
  1133                              <1> %if 1
  1134                              <1> 	; 08/11/2023
  1135                              <1> 	; 04/11/2023
  1136 0000085E B401                <1> 	mov	ah, 1
  1137 00000860 CD16                <1> 	int	16h
  1138 00000862 F8                  <1> 	clc
  1139 00000863 7405                <1> 	jz	short _cksr
  1140 00000865 30E4                <1> 	xor	ah, ah
  1141 00000867 CD16                <1> 	int	16h
  1142 00000869 F9                  <1> 	stc
  1143                              <1> _cksr:
  1144 0000086A C3                  <1> 	retn
  1145                              <1> %endif
  1146                              <1> 
  1147                              <1> ; 06/11/2023
  1148                              <1> ; 04/11/2023
  1149                              <1> %if 0	
  1150                              <1>         push    ds
  1151                              <1>         push    0
  1152                              <1>         pop     ds		       ; examine BDA for keyboard flags
  1153                              <1>         test    byte [417h], (BIT0 | BIT1)
  1154                              <1>         pop     ds
  1155                              <1>         stc
  1156                              <1>         jnz	short _cksr ; 07/11/2023
  1157                              <1> 	;jz	short _cksr ; 06/11/2023
  1158                              <1>         clc
  1159                              <1> _cksr:
  1160                              <1>         retn
  1161                              <1> %endif
  1162                              <1> 
  1163                              <1> ; 15/11/2023
  1164                              <1> ; 14/11/2023
  1165                              <1> ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  1166                              <1> ; --------------------------------------------------------
  1167                              <1> 
  1168                              <1> ;;Note:	At the end of every buffer load,
  1169                              <1> ;;	during buffer switch/swap, there will be discontinuity
  1170                              <1> ;;	between the last converted sample and the 1st sample
  1171                              <1> ;;	of the next buffer.
  1172                              <1> ;;	(like as a dot noises vaguely between normal sound samples)
  1173                              <1> ;;	-To avoid this defect, the 1st sample of
  1174                              <1> ;;	the next buffer may be read from the wav file but
  1175                              <1> ;;	the file pointer would need to be set to 1 sample back
  1176                              <1> ;;	again via seek system call. Time comsumption problem! -
  1177                              <1> ;;
  1178                              <1> ;;	Erdogan Tan - 15/11/2023
  1179                              <1> ;;
  1180                              <1> ;;	((If entire wav data would be loaded at once.. conversion
  1181                              <1> ;;	defect/noise would disappear.. but for DOS, to keep
  1182                              <1> ;;	64KB buffer limit is important also it is important
  1183                              <1> ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  1184                              <1> ;;	I have tested this program by using 2-30MB wav files.))
  1185                              <1> ;;
  1186                              <1> ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  1187                              <1> ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  1188                              <1> ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  1189                              <1> ;;			Realtek ALC850 codec.
  1190                              <1> ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  1191                              <1> 
  1192                              <1> load_8khz_mono_8_bit:
  1193                              <1> 	; 15/11/2023
  1194                              <1> 	; 14/11/2023
  1195                              <1> 	; 13/11/2023
  1196 0000086B F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1197                              <1> 					; last of the file?
  1198 00000870 7402                <1> 	jz	short lff8m_0		; no
  1199 00000872 F9                  <1> 	stc
  1200 00000873 C3                  <1> 	retn
  1201                              <1> 
  1202                              <1> lff8m_0:
  1203 00000874 8EC0                <1> 	mov	es, ax ; buffer segment	
  1204 00000876 31FF                <1> 	xor	di, di
  1205 00000878 BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1206                              <1> 	; ds = cs
  1207                              <1> 
  1208                              <1> 	; load file into memory
  1209 0000087B 8B0E[6906]          <1>         mov	cx, [loadsize]
  1210 0000087F 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  1211 00000883 B43F                <1>        	mov	ah, 3Fh
  1212 00000885 CD21                <1> 	int	21h
  1213                              <1> 	;jc	short lff8m_5 ; error !
  1214                              <1> 	; 14/11/2023
  1215 00000887 7303                <1> 	jnc	short lff8m_6
  1216 00000889 E98B00              <1> 	jmp	lff8m_5
  1217                              <1> 
  1218                              <1> lff8m_6:
  1219 0000088C 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1220 0000088E 21C0                <1> 	and	ax, ax
  1221                              <1> 	;jz	short lff8m_3
  1222                              <1> 	; 15/11/2023
  1223 00000890 747E                <1> 	jz	short lff8_eof
  1224                              <1> 
  1225 00000892 89C1                <1> 	mov	cx, ax		; byte count
  1226                              <1> lff8m_1:
  1227 00000894 AC                  <1> 	lodsb
  1228 00000895 A2[6819]            <1> 	mov	[previous_val], al
  1229 00000898 2C80                <1> 	sub	al, 80h
  1230 0000089A C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1231 0000089D AB                  <1> 	stosw		; original sample (left channel)
  1232 0000089E AB                  <1> 	stosw		; original sample (right channel)
  1233                              <1> 	;xor	ax, ax
  1234                              <1> 	; 14/11/2023
  1235 0000089F B080                <1> 	mov	al, 80h
  1236 000008A1 49                  <1> 	dec	cx
  1237 000008A2 7402                <1> 	jz	short lff8m_2
  1238 000008A4 8A04                <1> 	mov	al, [si]
  1239                              <1> lff8m_2:
  1240                              <1> 	;mov	[next_val], ax
  1241 000008A6 88C7                <1> 	mov	bh, al	; [next_val]
  1242 000008A8 8A26[6819]          <1> 	mov	ah, [previous_val]
  1243 000008AC 00E0                <1> 	add	al, ah	; [previous_val]
  1244 000008AE D0D8                <1> 	rcr	al, 1
  1245 000008B0 88C2                <1> 	mov	dl, al	; this is interpolated middle (3th) sample
  1246 000008B2 00E0                <1> 	add	al, ah	; [previous_val]
  1247 000008B4 D0D8                <1> 	rcr	al, 1	
  1248 000008B6 88C3                <1> 	mov	bl, al 	; this is temporary interpolation value	
  1249 000008B8 00E0                <1> 	add	al, ah	; [previous_val]
  1250 000008BA D0D8                <1> 	rcr	al, 1
  1251 000008BC 2C80                <1> 	sub	al, 80h
  1252 000008BE C1E008              <1> 	shl	ax, 8	
  1253 000008C1 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1254 000008C2 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1255 000008C3 88D8                <1> 	mov	al, bl
  1256 000008C5 00D0                <1> 	add	al, dl
  1257 000008C7 D0D8                <1> 	rcr	al, 1
  1258 000008C9 2C80                <1> 	sub	al, 80h
  1259 000008CB C1E008              <1> 	shl	ax, 8
  1260 000008CE AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1261 000008CF AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1262 000008D0 88D0                <1> 	mov	al, dl
  1263 000008D2 2C80                <1> 	sub	al, 80h
  1264 000008D4 C1E008              <1> 	shl	ax, 8
  1265 000008D7 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1266 000008D8 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1267                              <1> 	;mov	al, [next_val]
  1268 000008D9 88F8                <1> 	mov	al, bh
  1269 000008DB 00D0                <1> 	add	al, dl
  1270 000008DD D0D8                <1> 	rcr	al, 1
  1271 000008DF 88C3                <1> 	mov	bl, al	; this is temporary interpolation value
  1272 000008E1 00D0                <1> 	add	al, dl
  1273 000008E3 D0D8                <1> 	rcr	al, 1
  1274 000008E5 2C80                <1> 	sub	al, 80h
  1275 000008E7 C1E008              <1> 	shl	ax, 8
  1276 000008EA AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1277 000008EB AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1278                              <1> 	;mov	al, [next_val]
  1279 000008EC 88F8                <1> 	mov	al, bh
  1280 000008EE 00D8                <1> 	add	al, bl
  1281 000008F0 D0D8                <1> 	rcr	al, 1
  1282 000008F2 2C80                <1> 	sub	al, 80h
  1283 000008F4 C1E008              <1> 	shl	ax, 8
  1284 000008F7 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1285 000008F8 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1286                              <1> 	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1287 000008F9 09C9                <1> 	or	cx, cx
  1288 000008FB 7597                <1> 	jnz	short lff8m_1
  1289                              <1> 
  1290                              <1> 	; --------------
  1291                              <1> 
  1292                              <1> lff8s_3:
  1293                              <1> lff8m_3:
  1294                              <1> lff8s2_3:
  1295                              <1> lff8m2_3:
  1296                              <1> lff16s_3:
  1297                              <1> lff16m_3:
  1298                              <1> lff16s2_3:
  1299                              <1> lff16m2_3:
  1300                              <1> lff24_3:
  1301                              <1> lff32_3:
  1302                              <1> lff44_3:
  1303                              <1> lff22_3:
  1304                              <1> lff11_3:
  1305 000008FD 8B0E[6B06]          <1> 	mov	cx, [buffersize] ; 16 bit (48 kHZ, stereo) sample size
  1306 00000901 D1E1                <1> 	shl	cx, 1	; byte count
  1307 00000903 29F9                <1> 	sub	cx, di
  1308 00000905 7606                <1> 	jna	short lff8m_4
  1309                              <1> 	;inc	cx
  1310 00000907 D1E9                <1> 	shr	cx, 1
  1311 00000909 31C0                <1> 	xor	ax, ax	; fill (remain part of) buffer with zeros	
  1312 0000090B F3AB                <1> 	rep	stosw
  1313                              <1> lff8m_4:
  1314 0000090D 0E                  <1> 	push	cs
  1315 0000090E 07                  <1> 	pop	es
  1316 0000090F C3                  <1> 	retn
  1317                              <1> 
  1318                              <1> lff8_eof:
  1319                              <1> lff16_eof:
  1320                              <1> lff24_eof:
  1321                              <1> lff32_eof:
  1322                              <1> lff44_eof:
  1323                              <1> lff22_eof:
  1324                              <1> lff11_eof:
  1325                              <1> 	; 15/11/2023
  1326 00000910 C606[C81D]01        <1> 	mov	byte [flags], ENDOFFILE
  1327 00000915 EBE6                <1> 	jmp	short lff8m_3
  1328                              <1> 
  1329                              <1> lff8s_5:
  1330                              <1> lff8m_5:
  1331                              <1> lff8s2_5:
  1332                              <1> lff8m2_5:
  1333                              <1> lff16s_5:
  1334                              <1> lff16m_5:
  1335                              <1> lff16s2_5:
  1336                              <1> lff16m2_5:
  1337                              <1> lff24_5:
  1338                              <1> lff32_5:
  1339                              <1> lff44_5:
  1340                              <1> lff22_5:
  1341                              <1> lff11_5:
  1342 00000917 B021                <1> 	mov	al, '!'  ; error
  1343 00000919 E85EFE              <1> 	call	tL0
  1344                              <1> 	
  1345                              <1> 	;jmp	short lff8m_3
  1346                              <1> 	; 15/11/2023
  1347 0000091C EBF2                <1> 	jmp	lff8_eof
  1348                              <1> 
  1349                              <1> 	; --------------
  1350                              <1> 
  1351                              <1> load_8khz_stereo_8_bit:
  1352                              <1> 	; 15/11/2023
  1353                              <1> 	; 14/11/2023
  1354                              <1> 	; 13/11/2023
  1355 0000091E F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1356                              <1> 					; last of the file?
  1357 00000923 7402                <1> 	jz	short lff8s_0		; no
  1358 00000925 F9                  <1> 	stc
  1359 00000926 C3                  <1> 	retn
  1360                              <1> 
  1361                              <1> lff8s_0:
  1362 00000927 8EC0                <1> 	mov	es, ax ; buffer segment	
  1363 00000929 31FF                <1> 	xor	di, di
  1364 0000092B BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1365                              <1> 	; ds = cs
  1366                              <1> 
  1367                              <1> 	; load file into memory
  1368 0000092E 8B0E[6906]          <1>         mov	cx, [loadsize]
  1369 00000932 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  1370 00000936 B43F                <1>        	mov	ah, 3Fh
  1371 00000938 CD21                <1> 	int	21h
  1372 0000093A 72DB                <1> 	jc	short lff8s_5 ; error !
  1373                              <1> 
  1374 0000093C 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1375                              <1> 	
  1376 0000093E D1E8                <1> 	shr	ax, 1
  1377                              <1> 	;;and	ax, ax
  1378                              <1> 	;jz	short lff8s_3
  1379                              <1> 	; 15/11/2023
  1380 00000940 74CE                <1> 	jz	short lff8_eof
  1381                              <1> 
  1382 00000942 89C1                <1> 	mov	cx, ax		; word count
  1383                              <1> lff8s_1:
  1384 00000944 AC                  <1> 	lodsb
  1385 00000945 A2[6819]            <1> 	mov	[previous_val_l], al
  1386 00000948 2C80                <1> 	sub	al, 80h
  1387 0000094A C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1388 0000094D AB                  <1> 	stosw		; original sample (L)
  1389 0000094E AC                  <1> 	lodsb
  1390 0000094F A2[6A19]            <1> 	mov	[previous_val_r], al
  1391 00000952 2C80                <1> 	sub	al, 80h
  1392 00000954 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1393 00000957 AB                  <1> 	stosw		; original sample (R)
  1394                              <1> 
  1395                              <1> 	;xor	ax, ax
  1396                              <1> 	; 14/11/2023
  1397 00000958 B88080              <1> 	mov	ax, 8080h
  1398 0000095B 49                  <1> 	dec	cx
  1399 0000095C 7402                <1> 	jz	short lff8s_2
  1400                              <1> 		; convert 8 bit sample to 16 bit sample
  1401 0000095E 8B04                <1> 	mov	ax, [si]
  1402                              <1> lff8s_2:
  1403 00000960 A2[6C19]            <1> 	mov	[next_val_l], al
  1404 00000963 8826[6E19]          <1> 	mov	[next_val_r], ah
  1405 00000967 8A26[6819]          <1> 	mov	ah, [previous_val_l]
  1406 0000096B 00E0                <1> 	add	al, ah
  1407 0000096D D0D8                <1> 	rcr	al, 1
  1408 0000096F 88C2                <1> 	mov	dl, al	; this is interpolated middle (3th) sample (L)
  1409 00000971 00E0                <1> 	add	al, ah
  1410 00000973 D0D8                <1> 	rcr	al, 1	
  1411 00000975 88C3                <1> 	mov	bl, al	; this is temporary interpolation value (L)
  1412 00000977 00E0                <1> 	add	al, ah
  1413 00000979 D0D8                <1> 	rcr	al, 1
  1414 0000097B 2C80                <1> 	sub	al, 80h
  1415 0000097D C1E008              <1> 	shl	ax, 8
  1416 00000980 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1417 00000981 A0[6E19]            <1> 	mov	al, [next_val_r]
  1418 00000984 8A26[6A19]          <1> 	mov	ah, [previous_val_r]
  1419 00000988 00E0                <1> 	add	al, ah
  1420 0000098A D0D8                <1> 	rcr	al, 1
  1421 0000098C 88C6                <1> 	mov	dh, al	; this is interpolated middle (3th) sample (R)
  1422 0000098E 00E0                <1> 	add	al, ah
  1423 00000990 D0D8                <1> 	rcr	al, 1
  1424 00000992 88C7                <1> 	mov	bh, al	; this is temporary interpolation value (R)
  1425 00000994 00E0                <1> 	add	al, ah
  1426 00000996 D0D8                <1> 	rcr	al, 1
  1427 00000998 2C80                <1> 	sub	al, 80h
  1428 0000099A C1E008              <1> 	shl	ax, 8
  1429 0000099D AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1430 0000099E 88D8                <1> 	mov	al, bl
  1431 000009A0 00D0                <1> 	add	al, dl
  1432 000009A2 D0D8                <1> 	rcr	al, 1
  1433 000009A4 2C80                <1> 	sub	al, 80h
  1434 000009A6 C1E008              <1> 	shl	ax, 8
  1435 000009A9 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1436 000009AA 88F8                <1> 	mov	al, bh
  1437 000009AC 00F0                <1> 	add	al, dh
  1438 000009AE D0D8                <1> 	rcr	al, 1
  1439 000009B0 2C80                <1> 	sub	al, 80h
  1440 000009B2 C1E008              <1> 	shl	ax, 8
  1441 000009B5 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1442 000009B6 88D0                <1> 	mov	al, dl
  1443 000009B8 2C80                <1> 	sub	al, 80h
  1444 000009BA C1E008              <1> 	shl	ax, 8
  1445 000009BD AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1446 000009BE 88F0                <1> 	mov	al, dh
  1447 000009C0 2C80                <1> 	sub	al, 80h
  1448 000009C2 C1E008              <1> 	shl	ax, 8
  1449 000009C5 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1450 000009C6 A0[6C19]            <1> 	mov	al, [next_val_l]
  1451 000009C9 00D0                <1> 	add	al, dl
  1452 000009CB D0D8                <1> 	rcr	al, 1
  1453 000009CD 88C3                <1> 	mov	bl, al	; this is temporary interpolation value (L)
  1454 000009CF 00D0                <1> 	add	al, dl
  1455 000009D1 D0D8                <1> 	rcr	al, 1
  1456 000009D3 2C80                <1> 	sub	al, 80h
  1457 000009D5 C1E008              <1> 	shl	ax, 8
  1458 000009D8 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1459 000009D9 A0[6E19]            <1> 	mov	al, [next_val_r]
  1460 000009DC 00F0                <1> 	add	al, dh
  1461 000009DE D0D8                <1> 	rcr	al, 1
  1462 000009E0 88C7                <1> 	mov	bh, al	; this is temporary interpolation value (R)
  1463 000009E2 00F0                <1> 	add	al, dh
  1464 000009E4 D0D8                <1> 	rcr	al, 1
  1465 000009E6 2C80                <1> 	sub	al, 80h
  1466 000009E8 C1E008              <1> 	shl	ax, 8
  1467 000009EB AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1468 000009EC A0[6C19]            <1> 	mov	al, [next_val_l]
  1469 000009EF 00D8                <1> 	add	al, bl
  1470 000009F1 D0D8                <1> 	rcr	al, 1
  1471 000009F3 2C80                <1> 	sub	al, 80h
  1472 000009F5 C1E008              <1> 	shl	ax, 8
  1473 000009F8 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1474 000009F9 A0[6E19]            <1> 	mov	al, [next_val_r]
  1475 000009FC 00F8                <1> 	add	al, bh
  1476 000009FE D0D8                <1> 	rcr	al, 1
  1477 00000A00 2C80                <1> 	sub	al, 80h
  1478 00000A02 C1E008              <1> 	shl	ax, 8
  1479 00000A05 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1480                              <1> 	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1481 00000A06 E303                <1> 	jcxz	lff8s_6
  1482 00000A08 E939FF              <1> 	jmp	lff8s_1
  1483                              <1> lff8s_6:
  1484 00000A0B E9EFFE              <1> 	jmp	lff8s_3
  1485                              <1> 
  1486                              <1> load_8khz_mono_16_bit:
  1487                              <1> 	; 13/11/2023
  1488 00000A0E F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1489                              <1> 					; last of the file?
  1490 00000A13 7402                <1> 	jz	short lff8m2_0		; no
  1491 00000A15 F9                  <1> 	stc
  1492 00000A16 C3                  <1> 	retn
  1493                              <1> 
  1494                              <1> lff8m2_0:
  1495 00000A17 8EC0                <1> 	mov	es, ax ; buffer segment	
  1496 00000A19 31FF                <1> 	xor	di, di
  1497 00000A1B BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1498                              <1> 	; ds = cs
  1499                              <1> 
  1500                              <1> 	; load file into memory
  1501 00000A1E 8B0E[6906]          <1>         mov	cx, [loadsize]
  1502 00000A22 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  1503 00000A26 B43F                <1>        	mov	ah, 3Fh
  1504 00000A28 CD21                <1> 	int	21h
  1505 00000A2A 7270                <1> 	jc	short lff8m2_7 ; error !
  1506                              <1> 
  1507 00000A2C 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1508                              <1> 	
  1509 00000A2E D1E8                <1> 	shr	ax, 1
  1510                              <1> 	;and	ax, ax
  1511 00000A30 7503                <1> 	jnz	short lff8m2_8
  1512                              <1> 	;jmp	lff8m2_3
  1513                              <1> 	; 15/11/2023
  1514 00000A32 E9DBFE              <1> 	jmp	lff8_eof
  1515                              <1> 
  1516                              <1> lff8m2_8:
  1517 00000A35 89C1                <1> 	mov	cx, ax		; word count
  1518                              <1> lff8m2_1:
  1519 00000A37 AD                  <1> 	lodsw
  1520 00000A38 AB                  <1> 	stosw		; original sample (left channel)
  1521 00000A39 AB                  <1> 	stosw		; original sample (right channel)
  1522 00000A3A 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1523 00000A3D A3[6819]            <1> 	mov	[previous_val], ax
  1524 00000A40 31C0                <1> 	xor	ax, ax
  1525 00000A42 49                  <1> 	dec	cx
  1526 00000A43 7402                <1> 	jz	short lff8m2_2
  1527 00000A45 8B04                <1> 	mov	ax, [si]
  1528                              <1> lff8m2_2:
  1529 00000A47 80C480              <1> 	add	ah, 80h ; convert sound level to 0-65535 format
  1530 00000A4A 89C5                <1> 	mov	bp, ax	; [next_val]
  1531 00000A4C 0306[6819]          <1> 	add	ax, [previous_val]
  1532 00000A50 D1D8                <1> 	rcr	ax, 1
  1533 00000A52 89C2                <1> 	mov	dx, ax	; this is interpolated middle (3th) sample
  1534 00000A54 0306[6819]          <1> 	add	ax, [previous_val]
  1535 00000A58 D1D8                <1> 	rcr	ax, 1	; this is temporary interpolation value
  1536 00000A5A 89C3                <1> 	mov	bx, ax 		
  1537 00000A5C 0306[6819]          <1> 	add	ax, [previous_val]
  1538 00000A60 D1D8                <1> 	rcr	ax, 1
  1539 00000A62 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1540 00000A65 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1541 00000A66 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1542 00000A67 89D8                <1> 	mov	ax, bx
  1543 00000A69 01D0                <1> 	add	ax, dx
  1544 00000A6B D1D8                <1> 	rcr	ax, 1
  1545 00000A6D 80EC80              <1> 	sub	ah, 80h
  1546 00000A70 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1547 00000A71 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1548 00000A72 89D0                <1> 	mov	ax, dx
  1549 00000A74 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1550 00000A77 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1551 00000A78 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1552 00000A79 89E8                <1> 	mov	ax, bp
  1553 00000A7B 01D0                <1> 	add	ax, dx
  1554 00000A7D D1D8                <1> 	rcr	ax, 1
  1555 00000A7F 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value
  1556 00000A81 01D0                <1> 	add	ax, dx
  1557 00000A83 D1D8                <1> 	rcr	ax, 1
  1558 00000A85 80EC80              <1> 	sub	ah, 80h
  1559 00000A88 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1560 00000A89 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1561 00000A8A 89E8                <1> 	mov	ax, bp
  1562 00000A8C 01D8                <1> 	add	ax, bx
  1563 00000A8E D1D8                <1> 	rcr	ax, 1
  1564 00000A90 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1565 00000A93 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1566 00000A94 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1567                              <1> 	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1568 00000A95 09C9                <1> 	or	cx, cx
  1569 00000A97 759E                <1> 	jnz	short lff8m2_1
  1570 00000A99 E961FE              <1> 	jmp	lff8m2_3
  1571                              <1> 
  1572                              <1> lff8m2_7:
  1573                              <1> lff8s2_7:
  1574 00000A9C E978FE              <1> 	jmp	lff8m2_5  ; error
  1575                              <1> 
  1576                              <1> load_8khz_stereo_16_bit:
  1577                              <1> 	; 16/11/2023
  1578                              <1> 	; 15/11/2023
  1579                              <1> 	; 13/11/2023
  1580 00000A9F F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1581                              <1> 					; last of the file?
  1582 00000AA4 7402                <1> 	jz	short lff8s2_0		; no
  1583 00000AA6 F9                  <1> 	stc
  1584 00000AA7 C3                  <1> 	retn
  1585                              <1> 
  1586                              <1> lff8s2_0:
  1587 00000AA8 8EC0                <1> 	mov	es, ax ; buffer segment	
  1588 00000AAA 31FF                <1> 	xor	di, di
  1589 00000AAC BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1590                              <1> 	; ds = cs
  1591                              <1> 
  1592                              <1> 	; load file into memory
  1593 00000AAF 8B0E[6906]          <1>         mov	cx, [loadsize]
  1594 00000AB3 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  1595 00000AB7 B43F                <1>        	mov	ah, 3Fh
  1596 00000AB9 CD21                <1> 	int	21h
  1597 00000ABB 72DF                <1> 	jc	short lff8s2_7 ; error !
  1598                              <1> 
  1599 00000ABD 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1600                              <1> 	
  1601 00000ABF C1E802              <1> 	shr	ax, 2	; 16/11/2023
  1602                              <1> 	;and	ax, ax
  1603 00000AC2 7503                <1> 	jnz	short lff8s2_8
  1604                              <1> 	;jmp	lff8s2_3
  1605                              <1> 	; 15/11/2023
  1606 00000AC4 E949FE              <1> 	jmp	lff8_eof
  1607                              <1> 
  1608                              <1> lff8s2_8:
  1609 00000AC7 89C1                <1> 	mov	cx, ax ; dword count
  1610                              <1> lff8s2_1:
  1611 00000AC9 AD                  <1> 	lodsw
  1612 00000ACA AB                  <1> 	stosw		; original sample (L)
  1613                              <1> 	; 15/11/2023
  1614 00000ACB 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1615 00000ACE A3[6819]            <1> 	mov	[previous_val_l], ax
  1616 00000AD1 AD                  <1> 	lodsw
  1617 00000AD2 AB                  <1> 	stosw		; original sample (R)
  1618 00000AD3 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1619 00000AD6 A3[6A19]            <1> 	mov	[previous_val_r], ax
  1620 00000AD9 31D2                <1> 	xor	dx, dx
  1621 00000ADB 31C0                <1> 	xor	ax, ax
  1622                              <1> 	; 16/11/2023
  1623 00000ADD 49                  <1> 	dec	cx
  1624 00000ADE 7405                <1> 	jz	short lff8s2_2
  1625 00000AE0 8B04                <1> 	mov	ax, [si]
  1626 00000AE2 8B5402              <1> 	mov	dx, [si+2]
  1627                              <1> lff8s2_2:
  1628 00000AE5 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1629 00000AE8 A3[6C19]            <1> 	mov	[next_val_l], ax
  1630 00000AEB 80C680              <1> 	add	dh, 80h	; convert sound level to 0-65535 format
  1631 00000AEE 8916[6E19]          <1> 	mov	[next_val_r], dx
  1632 00000AF2 0306[6819]          <1> 	add	ax, [previous_val_l]
  1633 00000AF6 D1D8                <1> 	rcr	ax, 1
  1634 00000AF8 89C2                <1> 	mov	dx, ax	; this is interpolated middle (3th) sample (L)
  1635 00000AFA 0306[6819]          <1> 	add	ax, [previous_val_l]
  1636 00000AFE D1D8                <1> 	rcr	ax, 1	
  1637 00000B00 89C3                <1> 	mov	bx, ax 	; this is temporary interpolation value (L)
  1638 00000B02 0306[6819]          <1> 	add	ax, [previous_val_l]
  1639 00000B06 D1D8                <1> 	rcr	ax, 1
  1640 00000B08 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1641 00000B0B AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1642 00000B0C A1[6E19]            <1> 	mov	ax, [next_val_r]
  1643 00000B0F 0306[6A19]          <1> 	add	ax, [previous_val_r]
  1644 00000B13 D1D8                <1> 	rcr	ax, 1
  1645 00000B15 89C5                <1> 	mov	bp, ax	; this is interpolated middle (3th) sample (R)
  1646 00000B17 0306[6A19]          <1> 	add	ax, [previous_val_r]
  1647 00000B1B D1D8                <1> 	rcr	ax, 1
  1648 00000B1D 50                  <1> 	push	ax ; *	; this is temporary interpolation value (R)
  1649 00000B1E 0306[6A19]          <1> 	add	ax, [previous_val_r]
  1650 00000B22 D1D8                <1> 	rcr	ax, 1
  1651 00000B24 80EC80              <1> 	sub	ah, 80h
  1652 00000B27 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1653 00000B28 89D8                <1> 	mov	ax, bx
  1654 00000B2A 01D0                <1> 	add	ax, dx
  1655 00000B2C D1D8                <1> 	rcr	ax, 1
  1656 00000B2E 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1657 00000B31 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1658 00000B32 58                  <1> 	pop	ax ; *
  1659 00000B33 01E8                <1> 	add	ax, bp
  1660 00000B35 D1D8                <1> 	rcr	ax, 1
  1661 00000B37 80EC80              <1> 	sub	ah, 80h
  1662 00000B3A AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1663 00000B3B 89D0                <1> 	mov	ax, dx
  1664 00000B3D 80EC80              <1> 	sub	ah, 80h
  1665 00000B40 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1666 00000B41 89E8                <1> 	mov	ax, bp
  1667 00000B43 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1668 00000B46 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1669 00000B47 A1[6C19]            <1> 	mov	ax, [next_val_l]
  1670 00000B4A 01D0                <1> 	add	ax, dx
  1671 00000B4C D1D8                <1> 	rcr	ax, 1
  1672 00000B4E 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value (L)
  1673 00000B50 01D0                <1> 	add	ax, dx
  1674 00000B52 D1D8                <1> 	rcr	ax, 1
  1675 00000B54 80EC80              <1> 	sub	ah, 80h
  1676 00000B57 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1677 00000B58 A1[6E19]            <1> 	mov	ax, [next_val_r]
  1678 00000B5B 01E8                <1> 	add	ax, bp
  1679 00000B5D D1D8                <1> 	rcr	ax, 1
  1680 00000B5F 50                  <1> 	push	ax ; ** ; this is temporary interpolation value (R)
  1681 00000B60 01E8                <1> 	add	ax, bp
  1682 00000B62 D1D8                <1> 	rcr	ax, 1
  1683 00000B64 80EC80              <1> 	sub	ah, 80h
  1684 00000B67 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1685 00000B68 A1[6C19]            <1> 	mov	ax, [next_val_l]
  1686 00000B6B 01D8                <1> 	add	ax, bx
  1687 00000B6D D1D8                <1> 	rcr	ax, 1
  1688 00000B6F 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1689 00000B72 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1690 00000B73 58                  <1> 	pop	ax ; **
  1691 00000B74 0306[6E19]          <1> 	add	ax, [next_val_r]
  1692 00000B78 D1D8                <1> 	rcr	ax, 1
  1693 00000B7A 80EC80              <1> 	sub	ah, 80h
  1694 00000B7D AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1695                              <1> 	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1696 00000B7E E303                <1> 	jcxz	lff8_s2_9
  1697 00000B80 E946FF              <1> 	jmp	lff8s2_1
  1698                              <1> lff8_s2_9:
  1699 00000B83 E977FD              <1> 	jmp	lff8s2_3
  1700                              <1> 
  1701                              <1> ; .....................
  1702                              <1> 
  1703                              <1> load_16khz_mono_8_bit:
  1704                              <1> 	; 14/11/2023
  1705                              <1> 	; 13/11/2023
  1706 00000B86 F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1707                              <1> 					; last of the file?
  1708 00000B8B 7402                <1> 	jz	short lff16m_0		; no
  1709 00000B8D F9                  <1> 	stc
  1710 00000B8E C3                  <1> 	retn
  1711                              <1> 
  1712                              <1> lff16m_0:
  1713 00000B8F 8EC0                <1> 	mov	es, ax ; buffer segment	
  1714 00000B91 31FF                <1> 	xor	di, di
  1715 00000B93 BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1716                              <1> 	; ds = cs
  1717                              <1> 
  1718                              <1> 	; load file into memory
  1719 00000B96 8B0E[6906]          <1>         mov	cx, [loadsize]
  1720 00000B9A 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  1721 00000B9E B43F                <1>        	mov	ah, 3Fh
  1722 00000BA0 CD21                <1> 	int	21h
  1723 00000BA2 7243                <1> 	jc	short lff16m_7 ; error !
  1724                              <1> 
  1725 00000BA4 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1726                              <1> 	
  1727 00000BA6 21C0                <1> 	and	ax, ax
  1728 00000BA8 7503                <1> 	jnz	short lff16m_8
  1729                              <1> 	;jmp	lff16m_3
  1730                              <1> 	; 15/11/2023
  1731 00000BAA E963FD              <1> 	jmp	lff16_eof
  1732                              <1> 
  1733                              <1> lff16m_8:
  1734 00000BAD 89C1                <1> 	mov	cx, ax		; byte count
  1735                              <1> lff16m_1:
  1736 00000BAF AC                  <1> 	lodsb
  1737                              <1> 	;mov	[previous_val], al
  1738 00000BB0 88C3                <1> 	mov	bl, al
  1739 00000BB2 2C80                <1> 	sub	al, 80h
  1740 00000BB4 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1741 00000BB7 AB                  <1> 	stosw		; original sample (left channel)
  1742 00000BB8 AB                  <1> 	stosw		; original sample (right channel)
  1743                              <1> 	;xor	ax, ax
  1744                              <1> 	; 14/11/22023
  1745 00000BB9 B080                <1> 	mov	al, 80h
  1746 00000BBB 49                  <1> 	dec	cx
  1747 00000BBC 7402                <1> 	jz	short lff16m_2
  1748 00000BBE 8A04                <1> 	mov	al, [si]
  1749                              <1> lff16m_2:
  1750                              <1> 	;mov	[next_val], al
  1751 00000BC0 88C7                <1> 	mov	bh, al
  1752                              <1> 	;add	al, [previous_val]
  1753 00000BC2 00D8                <1> 	add	al, bl
  1754 00000BC4 D0D8                <1> 	rcr	al, 1
  1755 00000BC6 88C2                <1> 	mov	dl, al	; this is interpolated middle (temp) sample
  1756                              <1> 	;add	al, [previous_val]
  1757 00000BC8 00D8                <1> 	add	al, bl
  1758 00000BCA D0D8                <1> 	rcr	al, 1
  1759 00000BCC 2C80                <1> 	sub	al, 80h
  1760 00000BCE C1E008              <1> 	shl	ax, 8
  1761 00000BD1 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1762 00000BD2 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1763                              <1> 	;mov	al, [next_val]
  1764 00000BD3 88F8                <1> 	mov	al, bh
  1765 00000BD5 00D0                <1> 	add	al, dl
  1766 00000BD7 D0D8                <1> 	rcr	al, 1
  1767 00000BD9 2C80                <1> 	sub	al, 80h
  1768 00000BDB C1E008              <1> 	shl	ax, 8
  1769 00000BDE AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1770 00000BDF AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1771                              <1> 	
  1772                              <1> 	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1773 00000BE0 09C9                <1> 	or	cx, cx
  1774 00000BE2 75CB                <1> 	jnz	short lff16m_1
  1775 00000BE4 E916FD              <1> 	jmp	lff16m_3
  1776                              <1> 
  1777                              <1> lff16m_7:
  1778                              <1> lff16s_7:
  1779 00000BE7 E92DFD              <1> 	jmp	lff16m_5  ; error
  1780                              <1> 
  1781                              <1> load_16khz_stereo_8_bit:
  1782                              <1> 	; 14/11/2023
  1783                              <1> 	; 13/11/2023
  1784 00000BEA F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1785                              <1> 					; last of the file?
  1786 00000BEF 7402                <1> 	jz	short lff16s_0		; no
  1787 00000BF1 F9                  <1> 	stc
  1788 00000BF2 C3                  <1> 	retn
  1789                              <1> 
  1790                              <1> lff16s_0:
  1791 00000BF3 8EC0                <1> 	mov	es, ax ; buffer segment	
  1792 00000BF5 31FF                <1> 	xor	di, di
  1793 00000BF7 BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1794                              <1> 	; ds = cs
  1795                              <1> 
  1796                              <1> 	; load file into memory
  1797 00000BFA 8B0E[6906]          <1>         mov	cx, [loadsize]
  1798 00000BFE 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  1799 00000C02 B43F                <1>        	mov	ah, 3Fh
  1800 00000C04 CD21                <1> 	int	21h
  1801 00000C06 72DF                <1> 	jc	short lff16s_7 ; error !
  1802                              <1> 
  1803 00000C08 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1804                              <1> 	
  1805 00000C0A D1E8                <1> 	shr	ax, 1
  1806                              <1> 	;and	ax, ax
  1807 00000C0C 7503                <1> 	jnz	short lff16s_8
  1808                              <1> 	;jmp	lff16s_3
  1809                              <1> 	; 15/11/2023
  1810 00000C0E E9FFFC              <1> 	jmp	lff16_eof
  1811                              <1> 
  1812                              <1> lff16s_8:
  1813 00000C11 89C1                <1> 	mov	cx, ax		; word count
  1814                              <1> lff16s_1:
  1815 00000C13 AC                  <1> 	lodsb
  1816 00000C14 A2[6819]            <1> 	mov	[previous_val_l], al
  1817 00000C17 2C80                <1> 	sub	al, 80h
  1818 00000C19 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1819 00000C1C AB                  <1> 	stosw		; original sample (L)
  1820 00000C1D AC                  <1> 	lodsb
  1821 00000C1E A2[6A19]            <1> 	mov	[previous_val_r], al
  1822 00000C21 2C80                <1> 	sub	al, 80h
  1823 00000C23 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1824 00000C26 AB                  <1> 	stosw		; original sample (R)
  1825                              <1> 
  1826                              <1> 	;xor	ax, ax
  1827                              <1> 	; 14/11/2023
  1828 00000C27 B88080              <1> 	mov	ax, 8080h
  1829 00000C2A 49                  <1> 	dec	cx
  1830 00000C2B 7402                <1> 	jz	short lff16s_2
  1831                              <1> 		; convert 8 bit sample to 16 bit sample
  1832 00000C2D 8B04                <1> 	mov	ax, [si]
  1833                              <1> lff16s_2:
  1834                              <1> 	;mov	[next_val_l], al
  1835                              <1> 	;mov	[next_val_r], ah
  1836 00000C2F 89C3                <1> 	mov	bx, ax
  1837 00000C31 0206[6819]          <1> 	add	al, [previous_val_l]
  1838 00000C35 D0D8                <1> 	rcr	al, 1
  1839 00000C37 88C2                <1> 	mov	dl, al	; this is temporary interpolation value (L)
  1840 00000C39 0206[6819]          <1> 	add	al, [previous_val_l]
  1841 00000C3D D0D8                <1> 	rcr	al, 1
  1842 00000C3F 2C80                <1> 	sub	al, 80h
  1843 00000C41 C1E008              <1> 	shl	ax, 8
  1844 00000C44 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1845 00000C45 88F8                <1> 	mov	al, bh	; [next_val_r]
  1846 00000C47 0206[6A19]          <1> 	add	al, [previous_val_r]
  1847 00000C4B D0D8                <1> 	rcr	al, 1
  1848 00000C4D 88C6                <1> 	mov	dh, al	; this is temporary interpolation value (R)
  1849 00000C4F 0206[6A19]          <1> 	add	al, [previous_val_r]
  1850 00000C53 D0D8                <1> 	rcr	al, 1
  1851 00000C55 2C80                <1> 	sub	al, 80h
  1852 00000C57 C1E008              <1> 	shl	ax, 8
  1853 00000C5A AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1854 00000C5B 88D0                <1> 	mov	al, dl
  1855 00000C5D 00D8                <1> 	add	al, bl	; [next_val_l]
  1856 00000C5F D0D8                <1> 	rcr	al, 1
  1857 00000C61 2C80                <1> 	sub	al, 80h
  1858 00000C63 C1E008              <1> 	shl	ax, 8
  1859 00000C66 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1860 00000C67 88F0                <1> 	mov	al, dh
  1861 00000C69 00F8                <1> 	add	al, bh	; [next_val_r]
  1862 00000C6B D0D8                <1> 	rcr	al, 1
  1863 00000C6D 2C80                <1> 	sub	al, 80h
  1864 00000C6F C1E008              <1> 	shl	ax, 8
  1865 00000C72 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1866                              <1> 	
  1867                              <1> 	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1868 00000C73 09C9                <1> 	or	cx, cx
  1869 00000C75 759C                <1> 	jnz	short lff16s_1
  1870 00000C77 E983FC              <1> 	jmp	lff16s_3
  1871                              <1> 
  1872                              <1> load_16khz_mono_16_bit:
  1873                              <1> 	; 15/11/2023
  1874                              <1> 	; 13/11/2023
  1875 00000C7A F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1876                              <1> 					; last of the file?
  1877 00000C7F 7402                <1> 	jz	short lff16m2_0		; no
  1878 00000C81 F9                  <1> 	stc
  1879 00000C82 C3                  <1> 	retn
  1880                              <1> 
  1881                              <1> lff16m2_0:
  1882 00000C83 8EC0                <1> 	mov	es, ax ; buffer segment	
  1883 00000C85 31FF                <1> 	xor	di, di
  1884 00000C87 BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1885                              <1> 	; ds = cs
  1886                              <1> 
  1887                              <1> 	; load file into memory
  1888 00000C8A 8B0E[6906]          <1>         mov	cx, [loadsize]
  1889 00000C8E 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  1890 00000C92 B43F                <1>        	mov	ah, 3Fh
  1891 00000C94 CD21                <1> 	int	21h
  1892 00000C96 7240                <1> 	jc	short lff16m2_7 ; error !
  1893                              <1> 
  1894 00000C98 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1895                              <1> 	
  1896 00000C9A D1E8                <1> 	shr	ax, 1
  1897                              <1> 	;and	ax, ax
  1898 00000C9C 7503                <1> 	jnz	short lff16m2_8
  1899                              <1> 	;jmp	lff16m2_3
  1900                              <1> 	; 15/11/2023
  1901 00000C9E E96FFC              <1> 	jmp	lff16_eof
  1902                              <1> 
  1903                              <1> lff16m2_8:
  1904 00000CA1 89C1                <1> 	mov	cx, ax	; word count
  1905                              <1> lff16m2_1:
  1906 00000CA3 AD                  <1> 	lodsw
  1907 00000CA4 AB                  <1> 	stosw		; original sample (left channel)
  1908 00000CA5 AB                  <1> 	stosw		; original sample (right channel)
  1909 00000CA6 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  1910                              <1> 	;mov	[previous_val], ax
  1911 00000CA9 89C3                <1> 	mov	bx, ax	
  1912 00000CAB 31C0                <1> 	xor	ax, ax
  1913 00000CAD 49                  <1> 	dec	cx
  1914 00000CAE 7402                <1> 	jz	short lff16m2_2
  1915 00000CB0 8B04                <1> 	mov	ax, [si]
  1916                              <1> lff16m2_2:
  1917 00000CB2 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  1918 00000CB5 89C5                <1> 	mov	bp, ax	; [next_val]
  1919                              <1> 	;add	ax, [previous_val]
  1920 00000CB7 01D8                <1> 	add	ax, bx
  1921 00000CB9 D1D8                <1> 	rcr	ax, 1
  1922 00000CBB 89C2                <1> 	mov	dx, ax	; this is temporary interpolation value
  1923                              <1> 	;add	ax, [previous_val]
  1924 00000CBD 01D8                <1> 	add	ax, bx
  1925 00000CBF D1D8                <1> 	rcr	ax, 1
  1926 00000CC1 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1927 00000CC4 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1928 00000CC5 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1929 00000CC6 89E8                <1> 	mov	ax, bp 
  1930 00000CC8 01D0                <1> 	add	ax, dx
  1931 00000CCA D1D8                <1> 	rcr	ax, 1
  1932 00000CCC 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1933 00000CCF AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1934 00000CD0 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1935                              <1> 	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1936 00000CD1 09C9                <1> 	or	cx, cx
  1937 00000CD3 75CE                <1> 	jnz	short lff16m2_1
  1938 00000CD5 E925FC              <1> 	jmp	lff16m2_3
  1939                              <1> 
  1940                              <1> lff16m2_7:
  1941                              <1> lff16s2_7:
  1942 00000CD8 E93CFC              <1> 	jmp	lff16m2_5  ; error
  1943                              <1> 
  1944                              <1> load_16khz_stereo_16_bit:
  1945                              <1> 	; 16/11/2023
  1946                              <1> 	; 15/11/2023
  1947                              <1> 	; 13/11/2023
  1948 00000CDB F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1949                              <1> 					; last of the file?
  1950 00000CE0 7402                <1> 	jz	short lff16s2_0		; no
  1951 00000CE2 F9                  <1> 	stc
  1952 00000CE3 C3                  <1> 	retn
  1953                              <1> 
  1954                              <1> lff16s2_0:
  1955 00000CE4 8EC0                <1> 	mov	es, ax ; buffer segment	
  1956 00000CE6 31FF                <1> 	xor	di, di
  1957 00000CE8 BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1958                              <1> 	; ds = cs
  1959                              <1> 
  1960                              <1> 	; load file into memory
  1961 00000CEB 8B0E[6906]          <1>         mov	cx, [loadsize]
  1962 00000CEF 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  1963 00000CF3 B43F                <1>        	mov	ah, 3Fh
  1964 00000CF5 CD21                <1> 	int	21h
  1965 00000CF7 72DF                <1> 	jc	short lff16s2_7 ; error !
  1966                              <1> 
  1967 00000CF9 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1968                              <1> 	
  1969                              <1> 	;shr	ax, 1
  1970 00000CFB C1E802              <1> 	shr	ax, 2	; 16/11/2023
  1971                              <1> 	;and	ax, ax
  1972 00000CFE 7503                <1> 	jnz	short lff16s2_8
  1973                              <1> 	;jmp	lff16s2_3
  1974                              <1> 	; 15/11/2023
  1975 00000D00 E90DFC              <1> 	jmp	lff16_eof
  1976                              <1> 
  1977                              <1> lff16s2_8:
  1978 00000D03 89C1                <1> 	mov	cx, ax		; dword count
  1979                              <1> lff16s2_1:
  1980 00000D05 AD                  <1> 	lodsw
  1981 00000D06 AB                  <1> 	stosw		; original sample (L)
  1982 00000D07 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  1983 00000D0A A3[6819]            <1> 	mov	[previous_val_l], ax
  1984 00000D0D AD                  <1> 	lodsw
  1985 00000D0E AB                  <1> 	stosw		; original sample (R)
  1986 00000D0F 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  1987 00000D12 A3[6A19]            <1> 	mov	[previous_val_r], ax
  1988 00000D15 31D2                <1> 	xor	dx, dx
  1989 00000D17 31C0                <1> 	xor	ax, ax
  1990                              <1> 	; 16/11/2023
  1991 00000D19 49                  <1> 	dec	cx
  1992 00000D1A 7405                <1> 	jz	short lff16s2_2
  1993 00000D1C 8B04                <1> 	mov	ax, [si]
  1994 00000D1E 8B5402              <1> 	mov	dx, [si+2]
  1995                              <1> lff16s2_2:
  1996 00000D21 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  1997                              <1> 	;mov	[next_val_l], ax
  1998 00000D24 89C5                <1> 	mov	bp, ax
  1999 00000D26 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format 
  2000 00000D29 8916[6E19]          <1> 	mov	[next_val_r], dx
  2001 00000D2D 0306[6819]          <1> 	add	ax, [previous_val_l]
  2002 00000D31 D1D8                <1> 	rcr	ax, 1
  2003 00000D33 89C2                <1> 	mov	dx, ax	; this is temporary interpolation value (L)
  2004 00000D35 0306[6819]          <1> 	add	ax, [previous_val_l]
  2005 00000D39 D1D8                <1> 	rcr	ax, 1
  2006 00000D3B 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  2007 00000D3E AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  2008 00000D3F A1[6E19]            <1> 	mov	ax, [next_val_r]
  2009 00000D42 0306[6A19]          <1> 	add	ax, [previous_val_r]
  2010 00000D46 D1D8                <1> 	rcr	ax, 1
  2011 00000D48 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value (R)
  2012 00000D4A 0306[6A19]          <1> 	add	ax, [previous_val_r]
  2013 00000D4E D1D8                <1> 	rcr	ax, 1
  2014 00000D50 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2015 00000D53 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  2016                              <1> 	;mov	ax, [next_val_l]
  2017 00000D54 89E8                <1> 	mov	ax, bp
  2018 00000D56 01D0                <1> 	add	ax, dx
  2019 00000D58 D1D8                <1> 	rcr	ax, 1
  2020 00000D5A 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2021 00000D5D AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  2022 00000D5E A1[6E19]            <1> 	mov	ax, [next_val_r]
  2023 00000D61 01D8                <1> 	add	ax, bx
  2024 00000D63 D1D8                <1> 	rcr	ax, 1
  2025 00000D65 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2026 00000D68 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  2027                              <1> 	
  2028                              <1> 	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2029 00000D69 09C9                <1> 	or	cx, cx
  2030 00000D6B 7598                <1> 	jnz	short lff16s2_1
  2031 00000D6D E98DFB              <1> 	jmp	lff16s2_3
  2032                              <1> 
  2033                              <1> ; .....................
  2034                              <1> 
  2035                              <1> load_24khz_mono_8_bit:
  2036                              <1> 	; 15/11/2023
  2037 00000D70 F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2038                              <1> 					; last of the file?
  2039 00000D75 7402                <1> 	jz	short lff24m_0		; no
  2040 00000D77 F9                  <1> 	stc
  2041 00000D78 C3                  <1> 	retn
  2042                              <1> 
  2043                              <1> lff24m_0:
  2044 00000D79 8EC0                <1> 	mov	es, ax ; buffer segment	
  2045 00000D7B 31FF                <1> 	xor	di, di
  2046 00000D7D BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2047                              <1> 	; ds = cs
  2048                              <1> 
  2049                              <1> 	; load file into memory
  2050 00000D80 8B0E[6906]          <1>         mov	cx, [loadsize]
  2051 00000D84 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  2052 00000D88 B43F                <1>        	mov	ah, 3Fh
  2053 00000D8A CD21                <1> 	int	21h
  2054 00000D8C 722E                <1> 	jc	short lff24m_7 ; error !
  2055                              <1> 
  2056 00000D8E 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2057                              <1> 	
  2058 00000D90 21C0                <1> 	and	ax, ax
  2059 00000D92 7503                <1> 	jnz	short lff24m_8
  2060 00000D94 E979FB              <1> 	jmp	lff24_eof
  2061                              <1> 
  2062                              <1> lff24m_8:
  2063 00000D97 89C1                <1> 	mov	cx, ax		; byte count
  2064                              <1> lff24m_1:
  2065 00000D99 AC                  <1> 	lodsb
  2066                              <1> 	;mov	[previous_val], al
  2067 00000D9A 88C3                <1> 	mov	bl, al
  2068 00000D9C 2C80                <1> 	sub	al, 80h
  2069 00000D9E C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2070 00000DA1 AB                  <1> 	stosw		; original sample (left channel)
  2071 00000DA2 AB                  <1> 	stosw		; original sample (right channel)
  2072                              <1> 	;xor	ax, ax
  2073 00000DA3 B080                <1> 	mov	al, 80h
  2074 00000DA5 49                  <1> 	dec	cx
  2075 00000DA6 7402                <1> 	jz	short lff24m_2
  2076 00000DA8 8A04                <1> 	mov	al, [si]
  2077                              <1> lff24m_2:
  2078                              <1> 	;;mov	[next_val], al
  2079                              <1> 	;mov	bh, al
  2080                              <1> 	;add	al, [previous_val]
  2081 00000DAA 00D8                <1> 	add	al, bl
  2082 00000DAC D0D8                <1> 	rcr	al, 1
  2083 00000DAE 2C80                <1> 	sub	al, 80h
  2084 00000DB0 C1E008              <1> 	shl	ax, 8
  2085 00000DB3 AB                  <1> 	stosw		; this is interpolated sample (L)
  2086 00000DB4 AB                  <1> 	stosw		; this is interpolated sample (R)
  2087                              <1> 	
  2088                              <1> 	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2089 00000DB5 09C9                <1> 	or	cx, cx
  2090 00000DB7 75E0                <1> 	jnz	short lff24m_1
  2091 00000DB9 E941FB              <1> 	jmp	lff24_3
  2092                              <1> 
  2093                              <1> lff24m_7:
  2094                              <1> lff24s_7:
  2095 00000DBC E958FB              <1> 	jmp	lff24_5  ; error
  2096                              <1> 
  2097                              <1> load_24khz_stereo_8_bit:
  2098                              <1> 	; 15/11/2023
  2099 00000DBF F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2100                              <1> 					; last of the file?
  2101 00000DC4 7402                <1> 	jz	short lff24s_0		; no
  2102 00000DC6 F9                  <1> 	stc
  2103 00000DC7 C3                  <1> 	retn
  2104                              <1> 
  2105                              <1> lff24s_0:
  2106 00000DC8 8EC0                <1> 	mov	es, ax ; buffer segment	
  2107 00000DCA 31FF                <1> 	xor	di, di
  2108 00000DCC BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2109                              <1> 	; ds = cs
  2110                              <1> 
  2111                              <1> 	; load file into memory
  2112 00000DCF 8B0E[6906]          <1>         mov	cx, [loadsize]
  2113 00000DD3 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  2114 00000DD7 B43F                <1>        	mov	ah, 3Fh
  2115 00000DD9 CD21                <1> 	int	21h
  2116 00000DDB 72DF                <1> 	jc	short lff24s_7 ; error !
  2117                              <1> 
  2118 00000DDD 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2119                              <1> 	
  2120 00000DDF D1E8                <1> 	shr	ax, 1
  2121                              <1> 	;and	ax, ax
  2122 00000DE1 7503                <1> 	jnz	short lff24s_8
  2123 00000DE3 E92AFB              <1> 	jmp	lff24_eof
  2124                              <1> 
  2125                              <1> lff24s_8:
  2126 00000DE6 89C1                <1> 	mov	cx, ax		; word count
  2127                              <1> lff24s_1:
  2128 00000DE8 AC                  <1> 	lodsb
  2129 00000DE9 A2[6819]            <1> 	mov	[previous_val_l], al
  2130 00000DEC 2C80                <1> 	sub	al, 80h
  2131 00000DEE C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2132 00000DF1 AB                  <1> 	stosw		; original sample (L)
  2133 00000DF2 AC                  <1> 	lodsb
  2134 00000DF3 A2[6A19]            <1> 	mov	[previous_val_r], al
  2135 00000DF6 2C80                <1> 	sub	al, 80h
  2136 00000DF8 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2137 00000DFB AB                  <1> 	stosw		; original sample (R)
  2138                              <1> 
  2139                              <1> 	;xor	ax, ax
  2140 00000DFC B88080              <1> 	mov	ax, 8080h
  2141 00000DFF 49                  <1> 	dec	cx
  2142 00000E00 7402                <1> 	jz	short lff24s_2
  2143                              <1> 		; convert 8 bit sample to 16 bit sample
  2144 00000E02 8B04                <1> 	mov	ax, [si]
  2145                              <1> lff24s_2:
  2146                              <1> 	;;mov	[next_val_l], al
  2147                              <1> 	;;mov	[next_val_r], ah
  2148                              <1> 	;mov	bx, ax
  2149 00000E04 88E7                <1> 	mov	bh, ah
  2150 00000E06 0206[6819]          <1> 	add	al, [previous_val_l]
  2151 00000E0A D0D8                <1> 	rcr	al, 1
  2152                              <1> 	;mov	dl, al
  2153 00000E0C 2C80                <1> 	sub	al, 80h
  2154 00000E0E C1E008              <1> 	shl	ax, 8
  2155 00000E11 AB                  <1> 	stosw		; this is interpolated sample (L)
  2156 00000E12 88F8                <1> 	mov	al, bh	; [next_val_r]
  2157 00000E14 0206[6A19]          <1> 	add	al, [previous_val_r]
  2158 00000E18 D0D8                <1> 	rcr	al, 1
  2159                              <1> 	;mov	dh, al
  2160 00000E1A 2C80                <1> 	sub	al, 80h
  2161 00000E1C C1E008              <1> 	shl	ax, 8
  2162 00000E1F AB                  <1> 	stosw		; this is interpolated sample (R)
  2163                              <1> 		
  2164                              <1> 	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2165 00000E20 09C9                <1> 	or	cx, cx
  2166 00000E22 75C4                <1> 	jnz	short lff24s_1
  2167 00000E24 E9D6FA              <1> 	jmp	lff24_3
  2168                              <1> 
  2169                              <1> load_24khz_mono_16_bit:
  2170                              <1> 	; 15/11/2023
  2171 00000E27 F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2172                              <1> 					; last of the file?
  2173 00000E2C 7402                <1> 	jz	short lff24m2_0		; no
  2174 00000E2E F9                  <1> 	stc
  2175 00000E2F C3                  <1> 	retn
  2176                              <1> 
  2177                              <1> lff24m2_0:
  2178 00000E30 8EC0                <1> 	mov	es, ax ; buffer segment	
  2179 00000E32 31FF                <1> 	xor	di, di
  2180 00000E34 BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2181                              <1> 	; ds = cs
  2182                              <1> 
  2183                              <1> 	; load file into memory
  2184 00000E37 8B0E[6906]          <1>         mov	cx, [loadsize]
  2185 00000E3B 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  2186 00000E3F B43F                <1>        	mov	ah, 3Fh
  2187 00000E41 CD21                <1> 	int	21h
  2188 00000E43 7228                <1> 	jc	short lff24m2_7 ; error !
  2189                              <1> 
  2190 00000E45 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2191                              <1> 	
  2192 00000E47 D1E8                <1> 	shr	ax, 1
  2193                              <1> 	;and	ax, ax
  2194 00000E49 7503                <1> 	jnz	short lff24m2_8
  2195 00000E4B E9C2FA              <1> 	jmp	lff24_eof
  2196                              <1> 
  2197                              <1> lff24m2_8:
  2198 00000E4E 89C1                <1> 	mov	cx, ax	; word count
  2199                              <1> lff24m2_1:
  2200 00000E50 AD                  <1> 	lodsw
  2201 00000E51 AB                  <1> 	stosw		; original sample (left channel)
  2202 00000E52 AB                  <1> 	stosw		; original sample (right channel)
  2203 00000E53 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  2204                              <1> 	;mov	[previous_val], ax
  2205                              <1> 	;mov	bx, ax	
  2206                              <1> 	;xor	ax, ax
  2207 00000E56 31DB                <1> 	xor	bx, bx
  2208 00000E58 49                  <1> 	dec	cx
  2209 00000E59 7402                <1> 	jz	short lff24m2_2
  2210                              <1> 	;mov	ax, [si
  2211 00000E5B 8B1C                <1> 	mov	bx, [si]
  2212                              <1> lff24m2_2:
  2213                              <1> 	;add	ah, 80h ; convert sound level 0 to 65535 format
  2214                              <1> 	;mov	bp, ax	; [next_val]
  2215                              <1> 	;add	ax, [previous_val]
  2216                              <1> 	; ax = [previous_val]
  2217                              <1> 	; bx = [next_val]
  2218 00000E5D 01D8                <1> 	add	ax, bx
  2219 00000E5F D1D8                <1> 	rcr	ax, 1
  2220 00000E61 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2221 00000E64 AB                  <1> 	stosw		; this is interpolated sample (L)
  2222 00000E65 AB                  <1> 	stosw		; this is interpolated sample (R)
  2223                              <1> 	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2224 00000E66 09C9                <1> 	or	cx, cx
  2225 00000E68 75E6                <1> 	jnz	short lff24m2_1
  2226 00000E6A E990FA              <1> 	jmp	lff24_3
  2227                              <1> 
  2228                              <1> lff24m2_7:
  2229                              <1> lff24s2_7:
  2230 00000E6D E9A7FA              <1> 	jmp	lff24_5  ; error
  2231                              <1> 
  2232                              <1> load_24khz_stereo_16_bit:
  2233                              <1> 	; 16/11/2023
  2234                              <1> 	; 15/11/2023
  2235 00000E70 F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2236                              <1> 					; last of the file?
  2237 00000E75 7402                <1> 	jz	short lff24s2_0		; no
  2238 00000E77 F9                  <1> 	stc
  2239 00000E78 C3                  <1> 	retn
  2240                              <1> 
  2241                              <1> lff24s2_0:
  2242 00000E79 8EC0                <1> 	mov	es, ax ; buffer segment	
  2243 00000E7B 31FF                <1> 	xor	di, di
  2244 00000E7D BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2245                              <1> 	; ds = cs
  2246                              <1> 
  2247                              <1> 	; load file into memory
  2248 00000E80 8B0E[6906]          <1>         mov	cx, [loadsize]
  2249 00000E84 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  2250 00000E88 B43F                <1>        	mov	ah, 3Fh
  2251 00000E8A CD21                <1> 	int	21h
  2252 00000E8C 72DF                <1> 	jc	short lff24s2_7 ; error !
  2253                              <1> 
  2254 00000E8E 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2255                              <1> 	
  2256                              <1> 	;shr	ax, 1
  2257 00000E90 C1E802              <1> 	shr	ax, 2	; 16/11/2023
  2258                              <1> 	;and	ax, ax
  2259 00000E93 7503                <1> 	jnz	short lff24s2_8
  2260 00000E95 E978FA              <1> 	jmp	lff24_eof
  2261                              <1> 
  2262                              <1> lff24s2_8:
  2263 00000E98 89C1                <1> 	mov	cx, ax		; dword count
  2264                              <1> lff24s2_1:
  2265 00000E9A AD                  <1> 	lodsw
  2266 00000E9B AB                  <1> 	stosw		; original sample (L)
  2267 00000E9C 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2268 00000E9F A3[6819]            <1> 	mov	[previous_val_l], ax
  2269 00000EA2 AD                  <1> 	lodsw
  2270 00000EA3 AB                  <1> 	stosw		; original sample (R)
  2271 00000EA4 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2272                              <1> 	;mov	[previous_val_r], ax
  2273 00000EA7 89C3                <1> 	mov	bx, ax
  2274 00000EA9 31D2                <1> 	xor	dx, dx
  2275 00000EAB 31C0                <1> 	xor	ax, ax
  2276                              <1> 	; 16/11/2023
  2277 00000EAD 49                  <1> 	dec	cx
  2278 00000EAE 7405                <1> 	jz	short lff24s2_2
  2279 00000EB0 8B04                <1> 	mov	ax, [si]
  2280 00000EB2 8B5402              <1> 	mov	dx, [si+2]
  2281                              <1> lff24s2_2:
  2282 00000EB5 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2283                              <1> 	;;mov	[next_val_l], ax
  2284                              <1> 	;mov	bp, ax
  2285 00000EB8 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format 
  2286                              <1> 	;mov	[next_val_r], dx
  2287 00000EBB 0306[6819]          <1> 	add	ax, [previous_val_l]
  2288 00000EBF D1D8                <1> 	rcr	ax, 1
  2289 00000EC1 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  2290 00000EC4 AB                  <1> 	stosw		; this is interpolated sample (L)
  2291                              <1> 	;mov	ax, [next_val_r]
  2292 00000EC5 89D0                <1> 	mov	ax, dx
  2293                              <1> 	;add	ax, [previous_val_r]
  2294 00000EC7 01D8                <1> 	add	ax, bx
  2295 00000EC9 D1D8                <1> 	rcr	ax, 1
  2296 00000ECB 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2297 00000ECE AB                  <1> 	stosw		; this is interpolated sample (R)
  2298                              <1> 	
  2299                              <1> 	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2300 00000ECF 09C9                <1> 	or	cx, cx
  2301 00000ED1 75C7                <1> 	jnz	short lff24s2_1
  2302 00000ED3 E927FA              <1> 	jmp	lff24_3
  2303                              <1> 
  2304                              <1> ; .....................
  2305                              <1> 
  2306                              <1> load_32khz_mono_8_bit:
  2307                              <1> 	; 15/11/2023
  2308 00000ED6 F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2309                              <1> 					; last of the file?
  2310 00000EDB 7402                <1> 	jz	short lff32m_0		; no
  2311 00000EDD F9                  <1> 	stc
  2312 00000EDE C3                  <1> 	retn
  2313                              <1> 
  2314                              <1> lff32m_0:
  2315 00000EDF 8EC0                <1> 	mov	es, ax ; buffer segment	
  2316 00000EE1 31FF                <1> 	xor	di, di
  2317 00000EE3 BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2318                              <1> 	; ds = cs
  2319                              <1> 
  2320                              <1> 	; load file into memory
  2321 00000EE6 8B0E[6906]          <1>         mov	cx, [loadsize]
  2322 00000EEA 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  2323 00000EEE B43F                <1>        	mov	ah, 3Fh
  2324 00000EF0 CD21                <1> 	int	21h
  2325 00000EF2 7237                <1> 	jc	short lff32m_7 ; error !
  2326                              <1> 
  2327 00000EF4 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2328                              <1> 	
  2329 00000EF6 21C0                <1> 	and	ax, ax
  2330 00000EF8 7503                <1> 	jnz	short lff32m_8
  2331 00000EFA E913FA              <1> 	jmp	lff32_eof
  2332                              <1> 
  2333                              <1> lff32m_8:
  2334 00000EFD 89C1                <1> 	mov	cx, ax		; byte count
  2335                              <1> lff32m_1:
  2336 00000EFF AC                  <1> 	lodsb
  2337                              <1> 	;mov	[previous_val], al
  2338 00000F00 88C3                <1> 	mov	bl, al
  2339 00000F02 2C80                <1> 	sub	al, 80h
  2340 00000F04 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2341 00000F07 AB                  <1> 	stosw		; original sample (left channel)
  2342 00000F08 AB                  <1> 	stosw		; original sample (right channel)
  2343                              <1> 	;xor	ax, ax
  2344 00000F09 B080                <1> 	mov	al, 80h
  2345 00000F0B 49                  <1> 	dec	cx
  2346 00000F0C 7402                <1> 	jz	short lff32m_2
  2347 00000F0E 8A04                <1> 	mov	al, [si]
  2348                              <1> lff32m_2:
  2349                              <1> 	;;mov	[next_val], al
  2350                              <1> 	;mov	bh, al
  2351                              <1> 	;add	al, [previous_val]
  2352 00000F10 00D8                <1> 	add	al, bl
  2353 00000F12 D0D8                <1> 	rcr	al, 1
  2354 00000F14 2C80                <1> 	sub	al, 80h
  2355 00000F16 C1E008              <1> 	shl	ax, 8
  2356 00000F19 AB                  <1> 	stosw		; this is interpolated sample (L)
  2357 00000F1A AB                  <1> 	stosw		; this is interpolated sample (R)
  2358                              <1> 	
  2359                              <1> 	; different than 8-16-24 kHZ !
  2360                              <1> 	; 'original-interpolated-original' trio samples 
  2361 00000F1B E30B                <1> 	jcxz	lff32m_3
  2362                              <1> 
  2363 00000F1D AC                  <1> 	lodsb
  2364 00000F1E 2C80                <1> 	sub	al, 80h
  2365 00000F20 C1E008              <1> 	shl	ax, 8
  2366 00000F23 AB                  <1> 	stosw		; original sample (left channel)
  2367 00000F24 AB                  <1> 	stosw		; original sample (right channel)
  2368                              <1> 
  2369                              <1> 	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2370 00000F25 49                  <1> 	dec	cx
  2371 00000F26 75D7                <1> 	jnz	short lff32m_1
  2372                              <1> lff32m_3:
  2373 00000F28 E9D2F9              <1> 	jmp	lff32_3
  2374                              <1> 
  2375                              <1> lff32m_7:
  2376                              <1> lff32s_7:
  2377 00000F2B E9E9F9              <1> 	jmp	lff32_5  ; error
  2378                              <1> 
  2379                              <1> load_32khz_stereo_8_bit:
  2380                              <1> 	; 15/11/2023
  2381 00000F2E F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2382                              <1> 					; last of the file?
  2383 00000F33 7402                <1> 	jz	short lff32s_0		; no
  2384 00000F35 F9                  <1> 	stc
  2385 00000F36 C3                  <1> 	retn
  2386                              <1> 
  2387                              <1> lff32s_0:
  2388 00000F37 8EC0                <1> 	mov	es, ax ; buffer segment	
  2389 00000F39 31FF                <1> 	xor	di, di
  2390 00000F3B BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2391                              <1> 	; ds = cs
  2392                              <1> 
  2393                              <1> 	; load file into memory
  2394 00000F3E 8B0E[6906]          <1>         mov	cx, [loadsize]
  2395 00000F42 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  2396 00000F46 B43F                <1>        	mov	ah, 3Fh
  2397 00000F48 CD21                <1> 	int	21h
  2398 00000F4A 72DF                <1> 	jc	short lff32s_7 ; error !
  2399                              <1> 
  2400 00000F4C 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2401                              <1> 	
  2402 00000F4E D1E8                <1> 	shr	ax, 1
  2403                              <1> 	;and	ax, ax
  2404 00000F50 7503                <1> 	jnz	short lff32s_8
  2405 00000F52 E9BBF9              <1> 	jmp	lff32_eof
  2406                              <1> 
  2407                              <1> lff32s_8:
  2408 00000F55 89C1                <1> 	mov	cx, ax		; word count
  2409                              <1> lff32s_1:
  2410 00000F57 AC                  <1> 	lodsb
  2411 00000F58 A2[6819]            <1> 	mov	[previous_val_l], al
  2412 00000F5B 2C80                <1> 	sub	al, 80h
  2413 00000F5D C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2414 00000F60 AB                  <1> 	stosw		; original sample (L)
  2415 00000F61 AC                  <1> 	lodsb
  2416 00000F62 A2[6A19]            <1> 	mov	[previous_val_r], al
  2417 00000F65 2C80                <1> 	sub	al, 80h
  2418 00000F67 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2419 00000F6A AB                  <1> 	stosw		; original sample (R)
  2420                              <1> 
  2421                              <1> 	;xor	ax, ax
  2422 00000F6B B88080              <1> 	mov	ax, 8080h
  2423 00000F6E 49                  <1> 	dec	cx
  2424 00000F6F 7402                <1> 	jz	short lff32s_2
  2425                              <1> 		; convert 8 bit sample to 16 bit sample
  2426 00000F71 8B04                <1> 	mov	ax, [si]
  2427                              <1> lff32s_2:
  2428                              <1> 	;;mov	[next_val_l], al
  2429                              <1> 	;;mov	[next_val_r], ah
  2430                              <1> 	;mov	bx, ax
  2431 00000F73 88E7                <1> 	mov	bh, ah
  2432 00000F75 0206[6819]          <1> 	add	al, [previous_val_l]
  2433 00000F79 D0D8                <1> 	rcr	al, 1
  2434                              <1> 	;mov	dl, al
  2435 00000F7B 2C80                <1> 	sub	al, 80h
  2436 00000F7D C1E008              <1> 	shl	ax, 8
  2437 00000F80 AB                  <1> 	stosw		; this is interpolated sample (L)
  2438 00000F81 88F8                <1> 	mov	al, bh	; [next_val_r]
  2439 00000F83 0206[6A19]          <1> 	add	al, [previous_val_r]
  2440 00000F87 D0D8                <1> 	rcr	al, 1
  2441                              <1> 	;mov	dh, al
  2442 00000F89 2C80                <1> 	sub	al, 80h
  2443 00000F8B C1E008              <1> 	shl	ax, 8
  2444 00000F8E AB                  <1> 	stosw		; this is interpolated sample (R)
  2445                              <1> 
  2446                              <1> 	; different than 8-16-24 kHZ !
  2447                              <1> 	; 'original-interpolated-original' trio samples 
  2448 00000F8F E311                <1> 	jcxz	lff32s_3
  2449                              <1> 
  2450 00000F91 AC                  <1> 	lodsb
  2451 00000F92 2C80                <1> 	sub	al, 80h
  2452 00000F94 C1E008              <1> 	shl	ax, 8
  2453 00000F97 AB                  <1> 	stosw		; original sample (left channel)
  2454                              <1> 
  2455 00000F98 AC                  <1> 	lodsb
  2456 00000F99 2C80                <1> 	sub	al, 80h
  2457 00000F9B C1E008              <1> 	shl	ax, 8
  2458 00000F9E AB                  <1> 	stosw		; original sample (right channel)
  2459                              <1> 		
  2460                              <1> 	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2461 00000F9F 49                  <1> 	dec	cx
  2462 00000FA0 75B5                <1> 	jnz	short lff32s_1
  2463                              <1> lff32s_3:
  2464 00000FA2 E958F9              <1> 	jmp	lff32_3
  2465                              <1> 
  2466                              <1> load_32khz_mono_16_bit:
  2467                              <1> 	; 15/11/2023
  2468 00000FA5 F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2469                              <1> 					; last of the file?
  2470 00000FAA 7402                <1> 	jz	short lff32m2_0		; no
  2471 00000FAC F9                  <1> 	stc
  2472 00000FAD C3                  <1> 	retn
  2473                              <1> 
  2474                              <1> lff32m2_0:
  2475 00000FAE 8EC0                <1> 	mov	es, ax ; buffer segment	
  2476 00000FB0 31FF                <1> 	xor	di, di
  2477 00000FB2 BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2478                              <1> 	; ds = cs
  2479                              <1> 
  2480                              <1> 	; load file into memory
  2481 00000FB5 8B0E[6906]          <1>         mov	cx, [loadsize]
  2482 00000FB9 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  2483 00000FBD B43F                <1>        	mov	ah, 3Fh
  2484 00000FBF CD21                <1> 	int	21h
  2485 00000FC1 722C                <1> 	jc	short lff32m2_7 ; error !
  2486                              <1> 
  2487 00000FC3 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2488                              <1> 	
  2489 00000FC5 D1E8                <1> 	shr	ax, 1
  2490                              <1> 	;and	ax, ax
  2491 00000FC7 7503                <1> 	jnz	short lff32m2_8
  2492 00000FC9 E944F9              <1> 	jmp	lff32_eof
  2493                              <1> 
  2494                              <1> lff32m2_8:
  2495 00000FCC 89C1                <1> 	mov	cx, ax	; word count
  2496                              <1> lff32m2_1:
  2497 00000FCE AD                  <1> 	lodsw
  2498 00000FCF AB                  <1> 	stosw		; original sample (left channel)
  2499 00000FD0 AB                  <1> 	stosw		; original sample (right channel)
  2500 00000FD1 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  2501                              <1> 	;mov	[previous_val], ax
  2502                              <1> 	;mov	bx, ax	
  2503                              <1> 	;xor	ax, ax
  2504 00000FD4 31DB                <1> 	xor	bx, bx
  2505 00000FD6 49                  <1> 	dec	cx
  2506 00000FD7 7402                <1> 	jz	short lff32m2_2
  2507                              <1> 	;mov	ax, [si
  2508 00000FD9 8B1C                <1> 	mov	bx, [si]
  2509                              <1> lff32m2_2:
  2510                              <1> 	;add	ah, 80h ; convert sound level 0 to 65535 format
  2511                              <1> 	;mov	bp, ax	; [next_val]
  2512                              <1> 	;add	ax, [previous_val]
  2513                              <1> 	; ax = [previous_val]
  2514                              <1> 	; bx = [next_val]
  2515 00000FDB 01D8                <1> 	add	ax, bx
  2516 00000FDD D1D8                <1> 	rcr	ax, 1
  2517 00000FDF 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2518 00000FE2 AB                  <1> 	stosw		; this is interpolated sample (L)
  2519 00000FE3 AB                  <1> 	stosw		; this is interpolated sample (R)
  2520                              <1> 
  2521                              <1> 	; different than 8-16-24 kHZ !
  2522                              <1> 	; 'original-interpolated-original' trio samples 
  2523 00000FE4 E306                <1> 	jcxz	lff32m2_3
  2524                              <1> 
  2525 00000FE6 AD                  <1> 	lodsw
  2526 00000FE7 AB                  <1> 	stosw		; original sample (left channel)
  2527 00000FE8 AB                  <1> 	stosw		; original sample (right channel)
  2528                              <1> 
  2529                              <1> 	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2530 00000FE9 49                  <1> 	dec	cx
  2531 00000FEA 75E2                <1> 	jnz	short lff32m2_1
  2532                              <1> lff32m2_3:
  2533 00000FEC E90EF9              <1> 	jmp	lff32_3
  2534                              <1> 
  2535                              <1> lff32m2_7:
  2536                              <1> lff32s2_7:
  2537 00000FEF E925F9              <1> 	jmp	lff32_5  ; error
  2538                              <1> 
  2539                              <1> load_32khz_stereo_16_bit:
  2540                              <1> 	 ;16/11/2023
  2541                              <1> 	; 15/11/2023
  2542 00000FF2 F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2543                              <1> 					; last of the file?
  2544 00000FF7 7402                <1> 	jz	short lff32s2_0		; no
  2545 00000FF9 F9                  <1> 	stc
  2546 00000FFA C3                  <1> 	retn
  2547                              <1> 
  2548                              <1> lff32s2_0:
  2549 00000FFB 8EC0                <1> 	mov	es, ax ; buffer segment	
  2550 00000FFD 31FF                <1> 	xor	di, di
  2551 00000FFF BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2552                              <1> 	; ds = cs
  2553                              <1> 
  2554                              <1> 	; load file into memory
  2555 00001002 8B0E[6906]          <1>         mov	cx, [loadsize]
  2556 00001006 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  2557 0000100A B43F                <1>        	mov	ah, 3Fh
  2558 0000100C CD21                <1> 	int	21h
  2559 0000100E 72DF                <1> 	jc	short lff32s2_7 ; error !
  2560                              <1> 
  2561 00001010 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2562                              <1> 	
  2563 00001012 C1E802              <1> 	shr	ax, 2	; 16/11/2023 (word left ch + word right ch) 
  2564                              <1> 	;and	ax, ax
  2565 00001015 7503                <1> 	jnz	short lff32s2_8
  2566 00001017 E9F6F8              <1> 	jmp	lff32_eof
  2567                              <1> 
  2568                              <1> lff32s2_8:
  2569 0000101A 89C1                <1> 	mov	cx, ax		; dword count
  2570                              <1> lff32s2_1:
  2571 0000101C AD                  <1> 	lodsw
  2572 0000101D AB                  <1> 	stosw		; original sample (L)
  2573 0000101E 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2574 00001021 A3[6819]            <1> 	mov	[previous_val_l], ax
  2575 00001024 AD                  <1> 	lodsw
  2576 00001025 AB                  <1> 	stosw		; original sample (R)
  2577 00001026 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2578                              <1> 	;mov	[previous_val_r], ax
  2579 00001029 89C3                <1> 	mov	bx, ax
  2580 0000102B 31D2                <1> 	xor	dx, dx
  2581 0000102D 31C0                <1> 	xor	ax, ax
  2582                              <1> 	; 16/11/2023
  2583 0000102F 49                  <1> 	dec	cx
  2584 00001030 7405                <1> 	jz	short lff32s2_2
  2585 00001032 8B04                <1> 	mov	ax, [si]
  2586 00001034 8B5402              <1> 	mov	dx, [si+2]
  2587                              <1> lff32s2_2:
  2588 00001037 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2589                              <1> 	;;mov	[next_val_l], ax
  2590                              <1> 	;mov	bp, ax
  2591 0000103A 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format 
  2592                              <1> 	;mov	[next_val_r], dx
  2593 0000103D 0306[6819]          <1> 	add	ax, [previous_val_l]
  2594 00001041 D1D8                <1> 	rcr	ax, 1
  2595 00001043 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  2596 00001046 AB                  <1> 	stosw		; this is interpolated sample (L)
  2597                              <1> 	;mov	ax, [next_val_r]
  2598 00001047 89D0                <1> 	mov	ax, dx
  2599                              <1> 	;add	ax, [previous_val_r]
  2600 00001049 01D8                <1> 	add	ax, bx
  2601 0000104B D1D8                <1> 	rcr	ax, 1
  2602 0000104D 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2603 00001050 AB                  <1> 	stosw		; this is interpolated sample (R)
  2604                              <1> 
  2605                              <1> 	; different than 8-16-24 kHZ !
  2606                              <1> 	; 'original-interpolated-original' trio samples 
  2607 00001051 E307                <1> 	jcxz	lff32s2_3
  2608                              <1> 
  2609 00001053 AD                  <1> 	lodsw
  2610 00001054 AB                  <1> 	stosw	; original sample (L)
  2611 00001055 AD                  <1> 	lodsw
  2612 00001056 AB                  <1> 	stosw	; original sample (R)
  2613                              <1> 	
  2614                              <1> 	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2615 00001057 49                  <1> 	dec	cx
  2616 00001058 75C2                <1> 	jnz	short lff32s2_1
  2617                              <1> lff32s2_3:
  2618 0000105A E9A0F8              <1> 	jmp	lff32_3
  2619                              <1> 
  2620                              <1> ; .....................
  2621                              <1> 
  2622                              <1> load_22khz_mono_8_bit:
  2623                              <1> 	; 16/11/2023
  2624 0000105D F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2625                              <1> 					; last of the file?
  2626 00001062 7402                <1> 	jz	short lff22m_0		; no
  2627 00001064 F9                  <1> 	stc
  2628 00001065 C3                  <1> 	retn
  2629                              <1> 
  2630                              <1> lff22m_0:
  2631 00001066 8EC0                <1> 	mov	es, ax ; buffer segment	
  2632 00001068 31FF                <1> 	xor	di, di
  2633 0000106A BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2634                              <1> 	; ds = cs
  2635                              <1> 
  2636                              <1> 	; load file into memory
  2637 0000106D 8B0E[6906]          <1>         mov	cx, [loadsize]
  2638 00001071 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  2639 00001075 B43F                <1>        	mov	ah, 3Fh
  2640 00001077 CD21                <1> 	int	21h
  2641 00001079 7248                <1> 	jc	short lff22m_7 ; error !
  2642                              <1> 
  2643 0000107B 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2644                              <1> 	
  2645 0000107D 21C0                <1> 	and	ax, ax
  2646 0000107F 7503                <1> 	jnz	short lff22m_8
  2647 00001081 E98CF8              <1> 	jmp	lff22_eof
  2648                              <1> 
  2649                              <1> lff22m_8:
  2650 00001084 89C1                <1> 	mov	cx, ax		; byte count
  2651                              <1> lff22m_9:
  2652 00001086 BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2653 00001089 C606[7019]03        <1> 	mov	byte [faz], 3  ; 3 steps/phases
  2654                              <1> lff22m_1:
  2655                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2656 0000108E AC                  <1> 	lodsb
  2657 0000108F B280                <1> 	mov	dl, 80h
  2658 00001091 49                  <1> 	dec	cx
  2659 00001092 7402                <1> 	jz	short lff22m_2_1
  2660 00001094 8A14                <1> 	mov	dl, [si]
  2661                              <1> lff22m_2_1:	
  2662                              <1> 	; al = [previous_val]
  2663                              <1> 	; dl = [next_val]
  2664 00001096 E8A004              <1> 	call	interpolating_3_8bit_mono ; 1 of 17
  2665 00001099 E325                <1> 	jcxz	lff22m_3
  2666                              <1> lff22m_2_2:
  2667 0000109B AC                  <1> 	lodsb
  2668 0000109C B280                <1> 	mov	dl, 80h
  2669 0000109E 49                  <1> 	dec	cx
  2670 0000109F 7402                <1> 	jz	short lff22m_2_3
  2671 000010A1 8A14                <1> 	mov	dl, [si]
  2672                              <1> lff22m_2_3:
  2673 000010A3 E80205              <1>  	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  2674 000010A6 E318                <1> 	jcxz	lff22m_3
  2675 000010A8 4D                  <1> 	dec	bp
  2676 000010A9 75F0                <1> 	jnz	short lff22m_2_2
  2677                              <1> 
  2678 000010AB A0[7019]            <1> 	mov	al, [faz]
  2679 000010AE FEC8                <1> 	dec	al
  2680 000010B0 74D4                <1> 	jz	short lff22m_9
  2681 000010B2 FE0E[7019]          <1> 	dec	byte [faz]
  2682 000010B6 BD0400              <1> 	mov	bp, 4
  2683 000010B9 FEC8                <1> 	dec	al
  2684 000010BB 75D1                <1> 	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  2685 000010BD 45                  <1> 	inc	bp ; 5
  2686 000010BE EBCE                <1> 	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2687                              <1> 
  2688                              <1> lff22m_3:
  2689                              <1> lff22s_3:
  2690 000010C0 E93AF8              <1> 	jmp	lff22_3	; padfill
  2691                              <1> 		; (put zeros in the remain words of the buffer)
  2692                              <1> lff22m_7:
  2693                              <1> lff22s_7:
  2694 000010C3 E951F8              <1> 	jmp	lff22_5  ; error
  2695                              <1> 
  2696                              <1> load_22khz_stereo_8_bit:
  2697                              <1> 	; 16/11/2023
  2698 000010C6 F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2699                              <1> 					; last of the file?
  2700 000010CB 7402                <1> 	jz	short lff22s_0		; no
  2701 000010CD F9                  <1> 	stc
  2702 000010CE C3                  <1> 	retn
  2703                              <1> 
  2704                              <1> lff22s_0:
  2705 000010CF 8EC0                <1> 	mov	es, ax ; buffer segment	
  2706 000010D1 31FF                <1> 	xor	di, di
  2707 000010D3 BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2708                              <1> 	; ds = cs
  2709                              <1> 
  2710                              <1> 	; load file into memory
  2711 000010D6 8B0E[6906]          <1>         mov	cx, [loadsize]
  2712 000010DA 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  2713 000010DE B43F                <1>        	mov	ah, 3Fh
  2714 000010E0 CD21                <1> 	int	21h
  2715 000010E2 72DF                <1> 	jc	short lff22s_7 ; error !
  2716                              <1> 
  2717 000010E4 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2718                              <1> 	
  2719 000010E6 D1E8                <1> 	shr	ax, 1
  2720                              <1> 	;and	ax, ax
  2721 000010E8 7503                <1> 	jnz	short lff22s_8
  2722 000010EA E923F8              <1> 	jmp	lff22_eof
  2723                              <1> 
  2724                              <1> lff22s_8:
  2725 000010ED 89C1                <1> 	mov	cx, ax		; word count
  2726                              <1> lff22s_9:
  2727 000010EF BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2728 000010F2 C606[7019]03        <1> 	mov	byte [faz], 3  ; 3 steps/phase
  2729                              <1> lff22s_1:
  2730                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2731 000010F7 AD                  <1> 	lodsw
  2732 000010F8 BA8080              <1> 	mov	dx, 8080h
  2733 000010FB 49                  <1> 	dec	cx
  2734 000010FC 7402                <1> 	jz	short lff22s_2_1 
  2735 000010FE 8B14                <1> 	mov	dx, [si]
  2736                              <1> lff22s_2_1:	
  2737                              <1> 	; al = [previous_val_l]
  2738                              <1> 	; ah = [previous_val_r]
  2739                              <1> 	; dl = [next_val_l]
  2740                              <1> 	; dl = [next_val_r]	
  2741 00001100 E85E04              <1> 	call	interpolating_3_8bit_stereo ; 1 of 17 
  2742 00001103 E3BB                <1> 	jcxz	lff22s_3
  2743                              <1> lff22s_2_2:
  2744 00001105 AD                  <1> 	lodsw
  2745 00001106 BA8080              <1> 	mov	dx, 8080h
  2746 00001109 49                  <1> 	dec	cx
  2747 0000110A 7402                <1> 	jz	short lff22s_2_3
  2748 0000110C 8B14                <1> 	mov	dx, [si]
  2749                              <1> lff22s_2_3:
  2750 0000110E E8AE04              <1>  	call	interpolating_2_8bit_stereo ; 2 of 17 .. 6 of 17
  2751 00001111 E3AD                <1> 	jcxz	lff22s_3
  2752 00001113 4D                  <1> 	dec	bp
  2753 00001114 75EF                <1> 	jnz	short lff22s_2_2
  2754                              <1> 
  2755 00001116 A0[7019]            <1> 	mov	al, [faz]
  2756 00001119 FEC8                <1> 	dec	al
  2757 0000111B 74D2                <1> 	jz	short lff22s_9
  2758 0000111D FE0E[7019]          <1> 	dec	byte [faz]
  2759 00001121 BD0400              <1> 	mov	bp, 4
  2760 00001124 FEC8                <1> 	dec	al
  2761 00001126 75CF                <1> 	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  2762 00001128 45                  <1> 	inc	bp ; 5
  2763 00001129 EBCC                <1> 	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2764                              <1> 
  2765                              <1> load_22khz_mono_16_bit:
  2766                              <1> 	; 16/11/2023
  2767 0000112B F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2768                              <1> 					; last of the file?
  2769 00001130 7402                <1> 	jz	short lff22m2_0		; no
  2770 00001132 F9                  <1> 	stc
  2771 00001133 C3                  <1> 	retn
  2772                              <1> 
  2773                              <1> lff22m2_0:
  2774 00001134 8EC0                <1> 	mov	es, ax ; buffer segment	
  2775 00001136 31FF                <1> 	xor	di, di
  2776 00001138 BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2777                              <1> 	; ds = cs
  2778                              <1> 
  2779                              <1> 	; load file into memory
  2780 0000113B 8B0E[6906]          <1>         mov	cx, [loadsize]
  2781 0000113F 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  2782 00001143 B43F                <1>        	mov	ah, 3Fh
  2783 00001145 CD21                <1> 	int	21h
  2784 00001147 7248                <1> 	jc	short lff22m2_7 ; error !
  2785                              <1> 
  2786 00001149 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2787                              <1> 	
  2788 0000114B D1E8                <1> 	shr	ax, 1
  2789                              <1> 	;and	ax, ax
  2790 0000114D 7503                <1> 	jnz	short lff22m2_8
  2791 0000114F E9BEF7              <1> 	jmp	lff22_eof
  2792                              <1> 
  2793                              <1> lff22m2_8:
  2794 00001152 89C1                <1> 	mov	cx, ax		; word count
  2795                              <1> lff22m2_9:
  2796 00001154 BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2797 00001157 C606[7019]03        <1> 	mov	byte [faz], 3  ; 3 steps/phases
  2798                              <1> lff22m2_1:
  2799                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2800 0000115C AD                  <1> 	lodsw
  2801 0000115D 31D2                <1> 	xor	dx, dx
  2802 0000115F 49                  <1> 	dec	cx
  2803 00001160 7402                <1> 	jz	short lff22m2_2_1
  2804 00001162 8B14                <1> 	mov	dx, [si]
  2805                              <1> lff22m2_2_1:	
  2806                              <1> 	; ax = [previous_val]
  2807                              <1> 	; dx = [next_val]
  2808 00001164 E88104              <1> 	call	interpolating_3_16bit_mono ; 1 of 17
  2809 00001167 E325                <1> 	jcxz	lff22m2_3
  2810                              <1> lff22m2_2_2:
  2811 00001169 AD                  <1> 	lodsw
  2812 0000116A 31D2                <1> 	xor	dx, dx
  2813 0000116C 49                  <1> 	dec	cx
  2814 0000116D 7402                <1> 	jz	short lff22m2_2_3
  2815 0000116F 8B14                <1> 	mov	dx, [si]
  2816                              <1> lff22m2_2_3:
  2817 00001171 E8E104              <1>  	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  2818 00001174 E318                <1> 	jcxz	lff22m2_3
  2819 00001176 4D                  <1> 	dec	bp
  2820 00001177 75F0                <1> 	jnz	short lff22m2_2_2
  2821                              <1> 
  2822 00001179 A0[7019]            <1> 	mov	al, [faz]
  2823 0000117C FEC8                <1> 	dec	al
  2824 0000117E 74D4                <1> 	jz	short lff22m2_9
  2825 00001180 FE0E[7019]          <1> 	dec	byte [faz]
  2826 00001184 BD0400              <1> 	mov	bp, 4
  2827 00001187 FEC8                <1> 	dec	al
  2828 00001189 75D1                <1> 	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2829 0000118B 45                  <1> 	inc	bp ; 5
  2830 0000118C EBCE                <1> 	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2831                              <1> 
  2832                              <1> lff22m2_3:
  2833                              <1> lff22s2_3:
  2834 0000118E E96CF7              <1> 	jmp	lff22_3	; padfill
  2835                              <1> 		; (put zeros in the remain words of the buffer)
  2836                              <1> lff22m2_7:
  2837                              <1> lff22s2_7:
  2838 00001191 E983F7              <1> 	jmp	lff22_5  ; error
  2839                              <1> 
  2840                              <1> load_22khz_stereo_16_bit:
  2841                              <1> 	; 16/11/2023
  2842 00001194 F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2843                              <1> 					; last of the file?
  2844 00001199 7402                <1> 	jz	short lff22s2_0		; no
  2845 0000119B F9                  <1> 	stc
  2846 0000119C C3                  <1> 	retn
  2847                              <1> 
  2848                              <1> lff22s2_0:
  2849 0000119D 8EC0                <1> 	mov	es, ax ; buffer segment	
  2850 0000119F 31FF                <1> 	xor	di, di
  2851 000011A1 BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2852                              <1> 	; ds = cs
  2853                              <1> 
  2854                              <1> 	; load file into memory
  2855 000011A4 8B0E[6906]          <1>         mov	cx, [loadsize]
  2856 000011A8 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  2857 000011AC B43F                <1>        	mov	ah, 3Fh
  2858 000011AE CD21                <1> 	int	21h
  2859 000011B0 72DF                <1> 	jc	short lff22s2_7 ; error !
  2860                              <1> 
  2861 000011B2 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2862                              <1> 	
  2863 000011B4 C1E802              <1> 	shr	ax, 2	; dword (left chan word + right chan word)
  2864                              <1> 	;and	ax, ax
  2865 000011B7 7503                <1> 	jnz	short lff22s2_8
  2866 000011B9 E954F7              <1> 	jmp	lff22_eof
  2867                              <1> 
  2868                              <1> lff22s2_8:
  2869 000011BC 89C1                <1> 	mov	cx, ax		; dword count
  2870                              <1> lff22s2_9:
  2871 000011BE BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2872 000011C1 C606[7019]03        <1> 	mov	byte [faz], 3  ; 3 steps/phase
  2873                              <1> lff22s2_1:
  2874                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2875 000011C6 AD                  <1> 	lodsw
  2876 000011C7 89C3                <1> 	mov	bx, ax
  2877 000011C9 AD                  <1> 	lodsw
  2878 000011CA 8B14                <1> 	mov	dx, [si]
  2879 000011CC 8916[6C19]          <1> 	mov	[next_val_l], dx
  2880 000011D0 8B5402              <1> 	mov	dx, [si+2]
  2881 000011D3 49                  <1> 	dec	cx
  2882 000011D4 7506                <1> 	jnz	short lff22s2_2_1
  2883 000011D6 31D2                <1> 	xor	dx, dx ; 0
  2884 000011D8 8916[6C19]          <1> 	mov	[next_val_l], dx
  2885                              <1> lff22s2_2_1:
  2886                              <1> 	; bx = [previous_val_l]
  2887                              <1> 	; ax = [previous_val_r]
  2888                              <1> 	; [next_val_l]
  2889                              <1> 	; dx = [next_val_r]
  2890 000011DC E82D04              <1> 	call	interpolating_3_16bit_stereo ; 1 of 17 
  2891 000011DF E3AD                <1> 	jcxz	lff22s2_3
  2892                              <1> lff22s2_2_2:
  2893 000011E1 AD                  <1> 	lodsw
  2894 000011E2 89C3                <1> 	mov	bx, ax
  2895 000011E4 AD                  <1> 	lodsw
  2896 000011E5 8B14                <1> 	mov	dx, [si]
  2897 000011E7 8916[6C19]          <1> 	mov	[next_val_l], dx
  2898 000011EB 8B5402              <1> 	mov	dx, [si+2]
  2899 000011EE 49                  <1> 	dec	cx
  2900 000011EF 7506                <1> 	jnz	short lff22s2_2_3
  2901 000011F1 31D2                <1> 	xor	dx, dx ; 0
  2902 000011F3 8916[6C19]          <1> 	mov	[next_val_l], dx
  2903                              <1> lff22s2_2_3:
  2904 000011F7 E86D04              <1>  	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  2905 000011FA E392                <1> 	jcxz	lff22s2_3
  2906 000011FC 4D                  <1> 	dec	bp
  2907 000011FD 75E2                <1> 	jnz	short lff22s2_2_2
  2908                              <1> 
  2909 000011FF A0[7019]            <1> 	mov	al, [faz]
  2910 00001202 FEC8                <1> 	dec	al
  2911 00001204 74B8                <1> 	jz	short lff22s2_9
  2912 00001206 FE0E[7019]          <1> 	dec	byte [faz]
  2913 0000120A BD0400              <1> 	mov	bp, 4
  2914 0000120D FEC8                <1> 	dec	al
  2915 0000120F 75B5                <1> 	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2916 00001211 45                  <1> 	inc	bp ; 5
  2917 00001212 EBB2                <1> 	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2918                              <1> 
  2919                              <1> ; .....................
  2920                              <1> 
  2921                              <1> load_11khz_mono_8_bit:
  2922                              <1> 	; 18/11/2023
  2923 00001214 F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2924                              <1> 					; last of the file?
  2925 00001219 7402                <1> 	jz	short lff11m_0		; no
  2926 0000121B F9                  <1> 	stc
  2927 0000121C C3                  <1> 	retn
  2928                              <1> 
  2929                              <1> lff11m_0:
  2930 0000121D 8EC0                <1> 	mov	es, ax ; buffer segment	
  2931 0000121F 31FF                <1> 	xor	di, di
  2932 00001221 BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2933                              <1> 	; ds = cs
  2934                              <1> 
  2935                              <1> 	; load file into memory
  2936 00001224 8B0E[6906]          <1>         mov	cx, [loadsize]
  2937 00001228 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  2938 0000122C B43F                <1>        	mov	ah, 3Fh
  2939 0000122E CD21                <1> 	int	21h
  2940 00001230 723D                <1> 	jc	short lff11m_7 ; error !
  2941                              <1> 
  2942 00001232 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2943                              <1> 	
  2944 00001234 21C0                <1> 	and	ax, ax
  2945 00001236 7503                <1> 	jnz	short lff11m_8
  2946 00001238 E9D5F6              <1> 	jmp	lff11_eof
  2947                              <1> 
  2948                              <1> lff11m_8:
  2949 0000123B 89C1                <1> 	mov	cx, ax		; byte count
  2950                              <1> lff11m_9:
  2951 0000123D BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  2952                              <1> lff11m_1:
  2953                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  2954 00001240 AC                  <1> 	lodsb
  2955 00001241 B280                <1> 	mov	dl, 80h
  2956 00001243 49                  <1> 	dec	cx
  2957 00001244 7402                <1> 	jz	short lff11m_2_1
  2958 00001246 8A14                <1> 	mov	dl, [si]
  2959                              <1> lff11m_2_1:	
  2960                              <1> 	; al = [previous_val]
  2961                              <1> 	; dl = [next_val]
  2962 00001248 E84204              <1> 	call	interpolating_5_8bit_mono
  2963 0000124B E31F                <1> 	jcxz	lff11m_3
  2964                              <1> lff11m_2_2:
  2965 0000124D AC                  <1> 	lodsb
  2966 0000124E B280                <1> 	mov	dl, 80h
  2967 00001250 49                  <1> 	dec	cx
  2968 00001251 7402                <1> 	jz	short lff11m_2_3
  2969 00001253 8A14                <1> 	mov	dl, [si]
  2970                              <1> lff11m_2_3:
  2971 00001255 E81E05              <1>  	call	interpolating_4_8bit_mono
  2972 00001258 E312                <1> 	jcxz	lff11m_3
  2973                              <1> 
  2974 0000125A 4D                  <1> 	dec	bp
  2975 0000125B 74E0                <1> 	jz	short lff11m_9
  2976                              <1> 
  2977 0000125D AC                  <1> 	lodsb
  2978 0000125E B280                <1> 	mov	dl, 80h
  2979 00001260 49                  <1> 	dec	cx
  2980 00001261 7402                <1> 	jz	short lff11m_2_4
  2981 00001263 8A14                <1> 	mov	dl, [si]
  2982                              <1> lff11m_2_4:
  2983 00001265 E80E05              <1> 	call	interpolating_4_8bit_mono
  2984 00001268 E302                <1> 	jcxz	lff11m_3
  2985 0000126A EBD4                <1> 	jmp	short lff11m_1
  2986                              <1> 
  2987                              <1> lff11m_3:
  2988                              <1> lff11s_3:
  2989 0000126C E98EF6              <1> 	jmp	lff11_3	; padfill
  2990                              <1> 		; (put zeros in the remain words of the buffer)
  2991                              <1> lff11m_7:
  2992                              <1> lff11s_7:
  2993 0000126F E9A5F6              <1> 	jmp	lff11_5  ; error
  2994                              <1> 
  2995                              <1> load_11khz_stereo_8_bit:
  2996                              <1> 	; 18/11/2023
  2997 00001272 F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2998                              <1> 					; last of the file?
  2999 00001277 7402                <1> 	jz	short lff11s_0		; no
  3000 00001279 F9                  <1> 	stc
  3001 0000127A C3                  <1> 	retn
  3002                              <1> 
  3003                              <1> lff11s_0:
  3004 0000127B 8EC0                <1> 	mov	es, ax ; buffer segment	
  3005 0000127D 31FF                <1> 	xor	di, di
  3006 0000127F BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3007                              <1> 	; ds = cs
  3008                              <1> 
  3009                              <1> 	; load file into memory
  3010 00001282 8B0E[6906]          <1>         mov	cx, [loadsize]
  3011 00001286 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  3012 0000128A B43F                <1>        	mov	ah, 3Fh
  3013 0000128C CD21                <1> 	int	21h
  3014 0000128E 72DF                <1> 	jc	short lff11s_7 ; error !
  3015                              <1> 
  3016 00001290 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3017                              <1> 	
  3018 00001292 D1E8                <1> 	shr	ax, 1
  3019                              <1> 	;and	ax, ax
  3020 00001294 7503                <1> 	jnz	short lff11s_8
  3021 00001296 E977F6              <1> 	jmp	lff11_eof
  3022                              <1> 
  3023                              <1> lff11s_8:
  3024 00001299 89C1                <1> 	mov	cx, ax		; word count
  3025                              <1> lff11s_9:
  3026 0000129B BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  3027                              <1> lff11s_1:
  3028                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3029 0000129E AD                  <1> 	lodsw
  3030 0000129F BA8080              <1> 	mov	dx, 8080h
  3031 000012A2 49                  <1> 	dec	cx
  3032 000012A3 7402                <1> 	jz	short lff11s_2_1 
  3033 000012A5 8B14                <1> 	mov	dx, [si]
  3034                              <1> lff11s_2_1:	
  3035                              <1> 	; al = [previous_val_l]
  3036                              <1> 	; ah = [previous_val_r]
  3037                              <1> 	; dl = [next_val_l]
  3038                              <1> 	; dl = [next_val_r]	
  3039 000012A7 E83304              <1> 	call	interpolating_5_8bit_stereo
  3040 000012AA E3C0                <1> 	jcxz	lff11s_3
  3041                              <1> lff11s_2_2:
  3042 000012AC AD                  <1> 	lodsw
  3043 000012AD BA8080              <1> 	mov	dx, 8080h
  3044 000012B0 49                  <1> 	dec	cx
  3045 000012B1 7402                <1> 	jz	short lff11s_2_3
  3046 000012B3 8B14                <1> 	mov	dx, [si]
  3047                              <1> lff11s_2_3:
  3048 000012B5 E8F104              <1>  	call	interpolating_4_8bit_stereo
  3049 000012B8 E3B2                <1> 	jcxz	lff11s_3
  3050                              <1> 	
  3051 000012BA 4D                  <1> 	dec	bp
  3052 000012BB 74DE                <1> 	jz	short lff11s_9
  3053                              <1> 
  3054 000012BD AD                  <1> 	lodsw
  3055 000012BE BA8080              <1> 	mov	dx, 8080h
  3056 000012C1 49                  <1> 	dec	cx
  3057 000012C2 7402                <1> 	jz	short lff11s_2_4
  3058 000012C4 8B14                <1> 	mov	dx, [si]
  3059                              <1> lff11s_2_4:
  3060 000012C6 E8E004              <1> 	call	interpolating_4_8bit_stereo
  3061 000012C9 E3A1                <1> 	jcxz	lff11s_3
  3062 000012CB EBD1                <1> 	jmp	short lff11s_1
  3063                              <1> 
  3064                              <1> load_11khz_mono_16_bit:
  3065                              <1> 	; 18/11/2023
  3066 000012CD F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3067                              <1> 					; last of the file?
  3068 000012D2 7402                <1> 	jz	short lff11m2_0		; no
  3069 000012D4 F9                  <1> 	stc
  3070 000012D5 C3                  <1> 	retn
  3071                              <1> 
  3072                              <1> lff11m2_0:
  3073 000012D6 8EC0                <1> 	mov	es, ax ; buffer segment	
  3074 000012D8 31FF                <1> 	xor	di, di
  3075 000012DA BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3076                              <1> 	; ds = cs
  3077                              <1> 
  3078                              <1> 	; load file into memory
  3079 000012DD 8B0E[6906]          <1>         mov	cx, [loadsize]
  3080 000012E1 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  3081 000012E5 B43F                <1>        	mov	ah, 3Fh
  3082 000012E7 CD21                <1> 	int	21h
  3083 000012E9 723A                <1> 	jc	short lff11m2_7 ; error !
  3084                              <1> 
  3085 000012EB 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3086                              <1> 	
  3087 000012ED D1E8                <1> 	shr	ax, 1
  3088                              <1> 	;and	ax, ax
  3089 000012EF 7503                <1> 	jnz	short lff11m2_8
  3090 000012F1 E91CF6              <1> 	jmp	lff11_eof
  3091                              <1> 
  3092                              <1> lff11m2_8:
  3093 000012F4 89C1                <1> 	mov	cx, ax		; word count
  3094                              <1> lff11m2_9:
  3095 000012F6 BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  3096                              <1> lff11m2_1:
  3097                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3098 000012F9 AD                  <1> 	lodsw
  3099 000012FA 31D2                <1> 	xor	dx, dx
  3100 000012FC 49                  <1> 	dec	cx
  3101 000012FD 7402                <1> 	jz	short lff11m2_2_1
  3102 000012FF 8B14                <1> 	mov	dx, [si]
  3103                              <1> lff11m2_2_1:	
  3104                              <1> 	; ax = [previous_val]
  3105                              <1> 	; dx = [next_val]
  3106 00001301 E80205              <1> 	call	interpolating_5_16bit_mono
  3107 00001304 E34A                <1> 	jcxz	lff11m2_3
  3108                              <1> lff11m2_2_2:
  3109 00001306 AD                  <1> 	lodsw
  3110 00001307 31D2                <1> 	xor	dx, dx
  3111 00001309 49                  <1> 	dec	cx
  3112 0000130A 7402                <1> 	jz	short lff11m2_2_3
  3113 0000130C 8B14                <1> 	mov	dx, [si]
  3114                              <1> lff11m2_2_3:
  3115 0000130E E8D005              <1>  	call	interpolating_4_16bit_mono
  3116 00001311 E33D                <1> 	jcxz	lff11m2_3
  3117                              <1> 
  3118 00001313 4D                  <1> 	dec	bp
  3119 00001314 74E0                <1> 	jz	short lff11m2_9
  3120                              <1> 
  3121 00001316 AD                  <1> 	lodsw
  3122 00001317 31D2                <1> 	xor	dx, dx
  3123 00001319 49                  <1> 	dec	cx
  3124 0000131A 7402                <1> 	jz	short lff11m2_2_4
  3125 0000131C 8B14                <1> 	mov	dx, [si]
  3126                              <1> lff11m2_2_4:
  3127 0000131E E8C005              <1>  	call	interpolating_4_16bit_mono
  3128 00001321 E32D                <1> 	jcxz	lff11m2_3
  3129 00001323 EBD4                <1> 	jmp	short lff11m2_1
  3130                              <1> 
  3131                              <1> lff11m2_7:
  3132                              <1> lff11s2_7:
  3133 00001325 E9EFF5              <1> 	jmp	lff11_5  ; error
  3134                              <1> 
  3135                              <1> load_11khz_stereo_16_bit:
  3136                              <1> 	; 18/11/2023
  3137 00001328 F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3138                              <1> 					; last of the file?
  3139 0000132D 7402                <1> 	jz	short lff11s2_0		; no
  3140 0000132F F9                  <1> 	stc
  3141 00001330 C3                  <1> 	retn
  3142                              <1> 
  3143                              <1> lff11s2_0:
  3144 00001331 8EC0                <1> 	mov	es, ax ; buffer segment	
  3145 00001333 31FF                <1> 	xor	di, di
  3146 00001335 BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3147                              <1> 	; ds = cs
  3148                              <1> 
  3149                              <1> 	; load file into memory
  3150 00001338 8B0E[6906]          <1>         mov	cx, [loadsize]
  3151 0000133C 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  3152 00001340 B43F                <1>        	mov	ah, 3Fh
  3153 00001342 CD21                <1> 	int	21h
  3154 00001344 72DF                <1> 	jc	short lff11s2_7 ; error !
  3155                              <1> 
  3156 00001346 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3157                              <1> 	
  3158 00001348 C1E802              <1> 	shr	ax, 2	; dword (left chan word + right chan word)
  3159                              <1> 	;and	ax, ax
  3160 0000134B 7506                <1> 	jnz	short lff11s2_8
  3161 0000134D E9C0F5              <1> 	jmp	lff11_eof
  3162                              <1> 
  3163                              <1> lff11m2_3:
  3164                              <1> lff11s2_3:
  3165 00001350 E9AAF5              <1> 	jmp	lff11_3	; padfill
  3166                              <1> 		; (put zeros in the remain words of the buffer)
  3167                              <1> 
  3168                              <1> lff11s2_8:
  3169 00001353 89C1                <1> 	mov	cx, ax		; dword count
  3170                              <1> lff11s2_9:
  3171 00001355 BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  3172                              <1> lff11s2_1:
  3173                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3174 00001358 AD                  <1> 	lodsw
  3175 00001359 89C3                <1> 	mov	bx, ax
  3176 0000135B AD                  <1> 	lodsw
  3177 0000135C 8B14                <1> 	mov	dx, [si]
  3178 0000135E 8916[6C19]          <1> 	mov	[next_val_l], dx
  3179 00001362 8B5402              <1> 	mov	dx, [si+2]
  3180 00001365 8916[6E19]          <1> 	mov	[next_val_r], dx
  3181 00001369 49                  <1> 	dec	cx
  3182 0000136A 750A                <1> 	jnz	short lff11s2_2_1
  3183 0000136C 31D2                <1> 	xor	dx, dx ; 0
  3184 0000136E 8916[6C19]          <1> 	mov	[next_val_l], dx
  3185 00001372 8916[6E19]          <1> 	mov	[next_val_r], dx
  3186                              <1> lff11s2_2_1:
  3187                              <1> 	; bx = [previous_val_l]
  3188                              <1> 	; ax = [previous_val_r]
  3189                              <1> 	; [next_val_l]
  3190                              <1> 	; dx = [next_val_r]
  3191 00001376 E8D004              <1> 	call	interpolating_5_16bit_stereo
  3192 00001379 E3D5                <1> 	jcxz	lff11s2_3
  3193                              <1> lff11s2_2_2:
  3194 0000137B AD                  <1> 	lodsw
  3195 0000137C 89C3                <1> 	mov	bx, ax
  3196 0000137E AD                  <1> 	lodsw
  3197 0000137F 8B14                <1> 	mov	dx, [si]
  3198 00001381 8916[6C19]          <1> 	mov	[next_val_l], dx
  3199 00001385 8B5402              <1> 	mov	dx, [si+2]
  3200 00001388 8916[6E19]          <1> 	mov	[next_val_r], dx
  3201 0000138C 49                  <1> 	dec	cx
  3202 0000138D 750A                <1> 	jnz	short lff11s2_2_3
  3203 0000138F 31D2                <1> 	xor	dx, dx ; 0
  3204 00001391 8916[6C19]          <1> 	mov	[next_val_l], dx
  3205 00001395 8916[6E19]          <1> 	mov	[next_val_r], dx
  3206                              <1> lff11s2_2_3:
  3207 00001399 E87005              <1>  	call	interpolating_4_16bit_stereo
  3208 0000139C E3B2                <1> 	jcxz	lff11s2_3
  3209                              <1> 	
  3210 0000139E 4D                  <1> 	dec	bp
  3211 0000139F 74B4                <1> 	jz	short lff11s2_9
  3212                              <1> 
  3213 000013A1 AD                  <1> 	lodsw
  3214 000013A2 89C3                <1> 	mov	bx, ax
  3215 000013A4 AD                  <1> 	lodsw
  3216 000013A5 8B14                <1> 	mov	dx, [si]
  3217 000013A7 8916[6C19]          <1> 	mov	[next_val_l], dx
  3218 000013AB 8B5402              <1> 	mov	dx, [si+2]
  3219 000013AE 8916[6E19]          <1> 	mov	[next_val_r], dx
  3220 000013B2 49                  <1> 	dec	cx
  3221 000013B3 750A                <1> 	jnz	short lff11s2_2_4
  3222 000013B5 31D2                <1> 	xor	dx, dx ; 0
  3223 000013B7 8916[6C19]          <1> 	mov	[next_val_l], dx
  3224 000013BB 8916[6E19]          <1> 	mov	[next_val_r], dx
  3225                              <1> lff11s2_2_4:
  3226 000013BF E84A05              <1>  	call	interpolating_4_16bit_stereo
  3227 000013C2 E38C                <1> 	jcxz	lff11s2_3
  3228 000013C4 EB92                <1> 	jmp	short lff11s2_1
  3229                              <1> 
  3230                              <1> ; .....................
  3231                              <1> 
  3232                              <1> load_44khz_mono_8_bit:
  3233                              <1> 	; 18/11/2023
  3234 000013C6 F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3235                              <1> 					; last of the file?
  3236 000013CB 7402                <1> 	jz	short lff44m_0		; no
  3237 000013CD F9                  <1> 	stc
  3238 000013CE C3                  <1> 	retn
  3239                              <1> 
  3240                              <1> lff44m_0:
  3241 000013CF 8EC0                <1> 	mov	es, ax ; buffer segment	
  3242 000013D1 31FF                <1> 	xor	di, di
  3243 000013D3 BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3244                              <1> 	; ds = cs
  3245                              <1> 
  3246                              <1> 	; load file into memory
  3247 000013D6 8B0E[6906]          <1>         mov	cx, [loadsize]
  3248 000013DA 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  3249 000013DE B43F                <1>        	mov	ah, 3Fh
  3250 000013E0 CD21                <1> 	int	21h
  3251 000013E2 723C                <1> 	jc	short lff44m_7 ; error !
  3252                              <1> 
  3253 000013E4 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3254                              <1> 	
  3255 000013E6 21C0                <1> 	and	ax, ax
  3256 000013E8 7503                <1> 	jnz	short lff44m_8
  3257 000013EA E923F5              <1> 	jmp	lff44_eof
  3258                              <1> 
  3259                              <1> lff44m_8:
  3260 000013ED 89C1                <1> 	mov	cx, ax		; byte count
  3261                              <1> lff44m_9:
  3262 000013EF BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3263 000013F2 C606[7019]02        <1> 	mov	byte [faz], 2  ; 2 steps/phases
  3264                              <1> lff44m_1:
  3265                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3266                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3267 000013F7 AC                  <1> 	lodsb
  3268 000013F8 B280                <1> 	mov	dl, 80h
  3269 000013FA 49                  <1> 	dec	cx
  3270 000013FB 7402                <1> 	jz	short lff44m_2_1
  3271 000013FD 8A14                <1> 	mov	dl, [si]
  3272                              <1> lff44m_2_1:	
  3273                              <1> 	; al = [previous_val]
  3274                              <1> 	; dl = [next_val]
  3275 000013FF E8A601              <1> 	call	interpolating_2_8bit_mono
  3276 00001402 E319                <1> 	jcxz	lff44m_3
  3277                              <1> lff44m_2_2:
  3278 00001404 AC                  <1> 	lodsb
  3279 00001405 2C80                <1> 	sub	al, 80h
  3280 00001407 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3281 0000140A AB                  <1> 	stosw		; (L)
  3282 0000140B AB                  <1> 	stosw		; (R)	
  3283                              <1> 
  3284 0000140C 49                  <1> 	dec	cx
  3285 0000140D 740E                <1> 	jz	short lff44m_3	
  3286 0000140F 4D                  <1> 	dec	bp
  3287 00001410 75F2                <1> 	jnz	short lff44m_2_2
  3288                              <1> 	
  3289 00001412 FE0E[7019]          <1> 	dec	byte [faz]
  3290 00001416 74D7                <1> 	jz	short lff44m_9 
  3291 00001418 BD0B00              <1> 	mov	bp, 11
  3292 0000141B EBDA                <1> 	jmp	short lff44m_1
  3293                              <1> 
  3294                              <1> lff44m_3:
  3295                              <1> lff44s_3:
  3296 0000141D E9DDF4              <1> 	jmp	lff44_3	; padfill
  3297                              <1> 		; (put zeros in the remain words of the buffer)
  3298                              <1> lff44m_7:
  3299                              <1> lff44s_7:
  3300 00001420 E9F4F4              <1> 	jmp	lff44_5  ; error
  3301                              <1> 
  3302                              <1> load_44khz_stereo_8_bit:
  3303                              <1> 	; 16/11/2023
  3304 00001423 F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3305                              <1> 					; last of the file?
  3306 00001428 7402                <1> 	jz	short lff44s_0		; no
  3307 0000142A F9                  <1> 	stc
  3308 0000142B C3                  <1> 	retn
  3309                              <1> 
  3310                              <1> lff44s_0:
  3311 0000142C 8EC0                <1> 	mov	es, ax ; buffer segment	
  3312 0000142E 31FF                <1> 	xor	di, di
  3313 00001430 BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3314                              <1> 	; ds = cs
  3315                              <1> 
  3316                              <1> 	; load file into memory
  3317 00001433 8B0E[6906]          <1>         mov	cx, [loadsize]
  3318 00001437 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  3319 0000143B B43F                <1>        	mov	ah, 3Fh
  3320 0000143D CD21                <1> 	int	21h
  3321 0000143F 72DF                <1> 	jc	short lff44s_7 ; error !
  3322                              <1> 
  3323 00001441 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3324                              <1> 	
  3325 00001443 D1E8                <1> 	shr	ax, 1
  3326                              <1> 	;and	ax, ax
  3327 00001445 7503                <1> 	jnz	short lff44s_8
  3328 00001447 E9C6F4              <1> 	jmp	lff44_eof
  3329                              <1> 
  3330                              <1> lff44s_8:
  3331 0000144A 89C1                <1> 	mov	cx, ax		; word count
  3332                              <1> lff44s_9:
  3333 0000144C BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3334 0000144F C606[7019]02        <1> 	mov	byte [faz], 2  ; 2 steps/phase
  3335                              <1> lff44s_1:
  3336                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3337                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3338 00001454 AD                  <1> 	lodsw
  3339 00001455 BA8080              <1> 	mov	dx, 8080h
  3340 00001458 49                  <1> 	dec	cx
  3341 00001459 7402                <1> 	jz	short lff44s_2_1 
  3342 0000145B 8B14                <1> 	mov	dx, [si]
  3343                              <1> lff44s_2_1:	
  3344                              <1> 	; al = [previous_val_l]
  3345                              <1> 	; ah = [previous_val_r]
  3346                              <1> 	; dl = [next_val_l]
  3347                              <1> 	; dl = [next_val_r]	
  3348 0000145D E85F01              <1> 	call	interpolating_2_8bit_stereo
  3349 00001460 E3BB                <1> 	jcxz	lff44s_3
  3350                              <1> lff44s_2_2:
  3351 00001462 AC                  <1> 	lodsb
  3352 00001463 2C80                <1> 	sub	al, 80h
  3353 00001465 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3354 00001468 AB                  <1> 	stosw		; (L)
  3355 00001469 AC                  <1> 	lodsb
  3356 0000146A 2C80                <1> 	sub	al, 80h
  3357 0000146C C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3358 0000146F AB                  <1> 	stosw		; (R)
  3359                              <1> 
  3360 00001470 49                  <1> 	dec	cx
  3361 00001471 74AA                <1> 	jz	short lff44s_3	
  3362 00001473 4D                  <1> 	dec	bp
  3363 00001474 75EC                <1> 	jnz	short lff44s_2_2
  3364                              <1> 	
  3365 00001476 FE0E[7019]          <1> 	dec	byte [faz]
  3366 0000147A 74D0                <1> 	jz	short lff44s_9 
  3367 0000147C BD0B00              <1> 	mov	bp, 11
  3368 0000147F EBD3                <1> 	jmp	short lff44s_1
  3369                              <1> 
  3370                              <1> load_44khz_mono_16_bit:
  3371                              <1> 	; 18/11/2023
  3372 00001481 F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3373                              <1> 					; last of the file?
  3374 00001486 7402                <1> 	jz	short lff44m2_0		; no
  3375 00001488 F9                  <1> 	stc
  3376 00001489 C3                  <1> 	retn
  3377                              <1> 
  3378                              <1> lff44m2_0:
  3379 0000148A 8EC0                <1> 	mov	es, ax ; buffer segment	
  3380 0000148C 31FF                <1> 	xor	di, di
  3381 0000148E BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3382                              <1> 	; ds = cs
  3383                              <1> 
  3384                              <1> 	; load file into memory
  3385 00001491 8B0E[6906]          <1>         mov	cx, [loadsize]
  3386 00001495 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  3387 00001499 B43F                <1>        	mov	ah, 3Fh
  3388 0000149B CD21                <1> 	int	21h
  3389 0000149D 7237                <1> 	jc	short lff44m2_7 ; error !
  3390                              <1> 
  3391 0000149F 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3392                              <1> 	
  3393 000014A1 D1E8                <1> 	shr	ax, 1
  3394                              <1> 	;and	ax, ax
  3395 000014A3 7503                <1> 	jnz	short lff44m2_8
  3396 000014A5 E968F4              <1> 	jmp	lff44_eof
  3397                              <1> 
  3398                              <1> lff44m2_8:
  3399 000014A8 89C1                <1> 	mov	cx, ax		; word count
  3400                              <1> lff44m2_9:
  3401 000014AA BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3402 000014AD C606[7019]02        <1> 	mov	byte [faz], 2  ; 2 steps/phases
  3403                              <1> lff44m2_1:
  3404                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3405                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3406 000014B2 AD                  <1> 	lodsw
  3407 000014B3 31D2                <1> 	xor	dx, dx
  3408 000014B5 49                  <1> 	dec	cx
  3409 000014B6 7402                <1> 	jz	short lff44m2_2_1
  3410 000014B8 8B14                <1> 	mov	dx, [si]
  3411                              <1> lff44m2_2_1:	
  3412                              <1> 	; ax = [previous_val]
  3413                              <1> 	; dx = [next_val]
  3414 000014BA E89801              <1> 	call	interpolating_2_16bit_mono
  3415 000014BD E314                <1> 	jcxz	lff44m2_3
  3416                              <1> lff44m2_2_2:
  3417 000014BF AD                  <1> 	lodsw
  3418 000014C0 AB                  <1> 	stosw		; (L)eft Channel
  3419 000014C1 AB                  <1> 	stosw		; (R)ight Channel
  3420                              <1> 
  3421 000014C2 49                  <1> 	dec	cx
  3422 000014C3 740E                <1> 	jz	short lff44m2_3	
  3423 000014C5 4D                  <1> 	dec	bp
  3424 000014C6 75F7                <1> 	jnz	short lff44m2_2_2
  3425                              <1> 	
  3426 000014C8 FE0E[7019]          <1> 	dec	byte [faz]
  3427 000014CC 74DC                <1> 	jz	short lff44m2_9 
  3428 000014CE BD0B00              <1> 	mov	bp, 11
  3429 000014D1 EBDF                <1> 	jmp	short lff44m2_1
  3430                              <1> 
  3431                              <1> lff44m2_3:
  3432                              <1> lff44s2_3:
  3433 000014D3 E927F4              <1> 	jmp	lff44_3	; padfill
  3434                              <1> 		; (put zeros in the remain words of the buffer)
  3435                              <1> lff44m2_7:
  3436                              <1> lff44s2_7:
  3437 000014D6 E93EF4              <1> 	jmp	lff44_5  ; error
  3438                              <1> 
  3439                              <1> load_44khz_stereo_16_bit:
  3440                              <1> 	; 18/11/2023
  3441 000014D9 F606[C81D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3442                              <1> 					; last of the file?
  3443 000014DE 7402                <1> 	jz	short lff44s2_0		; no
  3444 000014E0 F9                  <1> 	stc
  3445 000014E1 C3                  <1> 	retn
  3446                              <1> 
  3447                              <1> lff44s2_0:
  3448 000014E2 8EC0                <1> 	mov	es, ax ; buffer segment	
  3449 000014E4 31FF                <1> 	xor	di, di
  3450 000014E6 BA[EE1D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3451                              <1> 	; ds = cs
  3452                              <1> 
  3453                              <1> 	; load file into memory
  3454 000014E9 8B0E[6906]          <1>         mov	cx, [loadsize]
  3455 000014ED 8B1E[C61D]          <1> 	mov	bx, [filehandle]
  3456 000014F1 B43F                <1>        	mov	ah, 3Fh
  3457 000014F3 CD21                <1> 	int	21h
  3458 000014F5 72DF                <1> 	jc	short lff44s2_7 ; error !
  3459                              <1> 
  3460 000014F7 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3461                              <1> 	
  3462 000014F9 C1E802              <1> 	shr	ax, 2	; dword (left chan word + right chan word)
  3463                              <1> 	;and	ax, ax
  3464 000014FC 7503                <1> 	jnz	short lff44s2_8
  3465 000014FE E90FF4              <1> 	jmp	lff44_eof
  3466                              <1> 
  3467                              <1> lff44s2_8:
  3468 00001501 89C1                <1> 	mov	cx, ax		; dword count
  3469                              <1> lff44s2_9:
  3470 00001503 BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3471 00001506 C606[7019]02        <1> 	mov	byte [faz], 2  ; 2 steps/phase
  3472                              <1> lff44s2_1:
  3473                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3474                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3475 0000150B AD                  <1> 	lodsw
  3476 0000150C 89C3                <1> 	mov	bx, ax
  3477 0000150E AD                  <1> 	lodsw
  3478 0000150F 8B14                <1> 	mov	dx, [si]
  3479 00001511 8916[6C19]          <1> 	mov	[next_val_l], dx
  3480 00001515 8B5402              <1> 	mov	dx, [si+2]
  3481 00001518 49                  <1> 	dec	cx
  3482 00001519 7506                <1> 	jnz	short lff44s2_2_1
  3483 0000151B 31D2                <1> 	xor	dx, dx ; 0
  3484 0000151D 8916[6C19]          <1> 	mov	[next_val_l], dx
  3485                              <1> lff44s2_2_1:
  3486                              <1> 	; bx = [previous_val_l]
  3487                              <1> 	; ax = [previous_val_r]
  3488                              <1> 	; [next_val_l]
  3489                              <1> 	; dx = [next_val_r]
  3490 00001521 E84301              <1> 	call	interpolating_2_16bit_stereo
  3491 00001524 E3AD                <1> 	jcxz	lff44s2_3
  3492                              <1> lff44s2_2_2:
  3493                              <1> 	;lodsw
  3494                              <1> 	;stosw		; (L)
  3495                              <1> 	;lodsw
  3496                              <1> 	;stosw		; (R)
  3497 00001526 A5                  <1> 	movsw		; (L)eft Channel
  3498 00001527 A5                  <1> 	movsw		; (R)ight Channel
  3499                              <1> 
  3500 00001528 49                  <1> 	dec	cx
  3501 00001529 74A8                <1> 	jz	short lff44s2_3	
  3502 0000152B 4D                  <1> 	dec	bp
  3503 0000152C 75F8                <1> 	jnz	short lff44s2_2_2
  3504                              <1> 	
  3505 0000152E FE0E[7019]          <1> 	dec	byte [faz]
  3506 00001532 74CF                <1> 	jz	short lff44s2_9 
  3507 00001534 BD0B00              <1> 	mov	bp, 11
  3508 00001537 EBD2                <1> 	jmp	short lff44s2_1
  3509                              <1> 
  3510                              <1> ; .....................
  3511                              <1> 
  3512                              <1> interpolating_3_8bit_mono:
  3513                              <1> 	; 16/11/2023
  3514                              <1> 	; al = [previous_val]
  3515                              <1> 	; dl = [next_val]
  3516                              <1> 	; original-interpolated-interpolated
  3517 00001539 88C3                <1> 	mov	bl, al
  3518 0000153B 2C80                <1> 	sub	al, 80h
  3519 0000153D C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3520 00001540 AB                  <1> 	stosw		; original sample (L)
  3521 00001541 AB                  <1> 	stosw		; original sample (R)
  3522 00001542 88D8                <1> 	mov	al, bl
  3523 00001544 00D0                <1> 	add	al, dl	
  3524 00001546 D0D8                <1> 	rcr	al, 1
  3525 00001548 88C7                <1> 	mov	bh, al	; interpolated middle (temporary)
  3526 0000154A 00D8                <1> 	add	al, bl
  3527 0000154C D0D8                <1> 	rcr	al, 1
  3528 0000154E 2C80                <1> 	sub	al, 80h
  3529 00001550 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3530 00001553 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3531 00001554 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3532 00001555 88F8                <1> 	mov	al, bh
  3533 00001557 00D0                <1> 	add	al, dl	; [next_val]
  3534 00001559 D0D8                <1> 	rcr	al, 1
  3535 0000155B C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3536 0000155E AB                  <1> 	stosw		; interpolated sample 2 (L)
  3537 0000155F AB                  <1> 	stosw		; interpolated sample 2 (R)
  3538 00001560 C3                  <1> 	retn
  3539                              <1> 
  3540                              <1> interpolating_3_8bit_stereo:
  3541                              <1> 	; 16/11/2023
  3542                              <1> 	; al = [previous_val_l]
  3543                              <1> 	; ah = [previous_val_r]
  3544                              <1> 	; dl = [next_val_l]
  3545                              <1> 	; dh = [next_val_r]	
  3546                              <1> 	; original-interpolated-interpolated
  3547 00001561 89C3                <1> 	mov	bx, ax
  3548 00001563 2C80                <1> 	sub	al, 80h
  3549 00001565 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3550 00001568 AB                  <1> 	stosw		; original sample (L)
  3551 00001569 88F8                <1> 	mov	al, bh
  3552 0000156B 2C80                <1> 	sub	al, 80h
  3553 0000156D C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3554 00001570 AB                  <1> 	stosw		; original sample (R)
  3555 00001571 88D8                <1> 	mov	al, bl
  3556 00001573 00D0                <1> 	add	al, dl	; [next_val_l]	
  3557 00001575 D0D8                <1> 	rcr	al, 1
  3558 00001577 50                  <1> 	push	ax ; *	; al = interpolated middle (L) (temporary)
  3559 00001578 00D8                <1> 	add	al, bl	; [previous_val_l]
  3560 0000157A D0D8                <1> 	rcr	al, 1
  3561 0000157C 2C80                <1> 	sub	al, 80h
  3562 0000157E C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3563 00001581 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3564 00001582 88F8                <1> 	mov	al, bh
  3565 00001584 00F0                <1> 	add	al, dh	; [next_val_r]
  3566 00001586 D0D8                <1> 	rcr	al, 1
  3567 00001588 50                  <1> 	push	ax ; ** ; al = interpolated middle (R) (temporary)
  3568 00001589 00F8                <1> 	add	al, bh	; [previous_val_r]
  3569 0000158B D0D8                <1> 	rcr	al, 1
  3570 0000158D 2C80                <1> 	sub	al, 80h
  3571 0000158F C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3572 00001592 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3573 00001593 5B                  <1> 	pop	bx ; **
  3574 00001594 58                  <1> 	pop	ax ; *
  3575 00001595 00D0                <1> 	add	al, dl	; [next_val_l]
  3576 00001597 D0D8                <1> 	rcr	al, 1
  3577 00001599 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3578 0000159C AB                  <1> 	stosw		; interpolated sample 2 (L)
  3579 0000159D 88D8                <1> 	mov	al, bl
  3580 0000159F 00F0                <1> 	add	al, dh	; [next_val_r]
  3581 000015A1 D0D8                <1> 	rcr	al, 1
  3582 000015A3 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3583 000015A6 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3584 000015A7 C3                  <1> 	retn
  3585                              <1> 
  3586                              <1> interpolating_2_8bit_mono:
  3587                              <1> 	; 16/11/2023
  3588                              <1> 	; al = [previous_val]
  3589                              <1> 	; dl = [next_val]
  3590                              <1> 	; original-interpolated
  3591 000015A8 88C3                <1> 	mov	bl, al
  3592 000015AA 2C80                <1> 	sub	al, 80h
  3593 000015AC C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3594 000015AF AB                  <1> 	stosw		; original sample (L)
  3595 000015B0 AB                  <1> 	stosw		; original sample (R)
  3596 000015B1 88D8                <1> 	mov	al, bl
  3597 000015B3 00D0                <1> 	add	al, dl	
  3598 000015B5 D0D8                <1> 	rcr	al, 1
  3599 000015B7 2C80                <1> 	sub	al, 80h
  3600 000015B9 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3601 000015BC AB                  <1> 	stosw		; interpolated sample (L)
  3602 000015BD AB                  <1> 	stosw		; interpolated sample (R)
  3603 000015BE C3                  <1> 	retn
  3604                              <1> 
  3605                              <1> interpolating_2_8bit_stereo:
  3606                              <1> 	; 16/11/2023
  3607                              <1> 	; al = [previous_val_l]
  3608                              <1> 	; ah = [previous_val_r]
  3609                              <1> 	; dl = [next_val_l]
  3610                              <1> 	; dh = [next_val_r]	
  3611                              <1> 	; original-interpolated
  3612 000015BF 89C3                <1> 	mov	bx, ax
  3613 000015C1 2C80                <1> 	sub	al, 80h
  3614 000015C3 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3615 000015C6 AB                  <1> 	stosw		; original sample (L)
  3616 000015C7 88F8                <1> 	mov	al, bh
  3617 000015C9 2C80                <1> 	sub	al, 80h
  3618 000015CB C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3619 000015CE AB                  <1> 	stosw		; original sample (R)
  3620 000015CF 88D8                <1> 	mov	al, bl	; [previous_val_l]
  3621 000015D1 00D0                <1> 	add	al, dl	; [next_val_l]	
  3622 000015D3 D0D8                <1> 	rcr	al, 1
  3623 000015D5 2C80                <1> 	sub	al, 80h
  3624 000015D7 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3625 000015DA AB                  <1> 	stosw		; interpolated sample (L)
  3626 000015DB 88F8                <1> 	mov	al, bh
  3627 000015DD 00F0                <1> 	add	al, dh	; [next_val_r]
  3628 000015DF D0D8                <1> 	rcr	al, 1
  3629 000015E1 2C80                <1> 	sub	al, 80h
  3630 000015E3 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3631 000015E6 AB                  <1> 	stosw		; interpolated sample (R)
  3632 000015E7 C3                  <1> 	retn
  3633                              <1> 
  3634                              <1> interpolating_3_16bit_mono:
  3635                              <1> 	; 16/11/2023
  3636                              <1> 	; ax = [previous_val]
  3637                              <1> 	; dx = [next_val]
  3638                              <1> 	; original-interpolated-interpolated
  3639                              <1> 
  3640 000015E8 AB                  <1> 	stosw		; original sample (L)
  3641 000015E9 AB                  <1> 	stosw		; original sample (R)
  3642 000015EA 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3643 000015ED 50                  <1> 	push	ax ; *	; [previous_val]
  3644 000015EE 80C680              <1> 	add	dh, 80h
  3645 000015F1 01D0                <1> 	add	ax, dx
  3646 000015F3 D1D8                <1> 	rcr	ax, 1
  3647 000015F5 5B                  <1> 	pop	bx ; *		
  3648 000015F6 93                  <1> 	xchg	bx, ax	; bx  = interpolated middle (temporary)
  3649 000015F7 01D8                <1> 	add	ax, bx	; [previous_val] + interpolated middle
  3650 000015F9 D1D8                <1> 	rcr	ax, 1
  3651 000015FB 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3652 000015FE AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3653 000015FF AB                  <1> 	stosw		; interpolated sample 1 (R)
  3654 00001600 89D8                <1> 	mov	ax, bx
  3655 00001602 01D0                <1> 	add	ax, dx	 ;interpolated middle + [next_val]
  3656 00001604 D1D8                <1> 	rcr	ax, 1
  3657 00001606 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3658 00001609 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3659 0000160A AB                  <1> 	stosw		; interpolated sample 2 (R)
  3660 0000160B C3                  <1> 	retn
  3661                              <1> 
  3662                              <1> interpolating_3_16bit_stereo:
  3663                              <1> 	; 16/11/2023
  3664                              <1> 	; bx = [previous_val_l]
  3665                              <1> 	; ax = [previous_val_r]
  3666                              <1> 	; [next_val_l]
  3667                              <1> 	; dx = [next_val_r]
  3668                              <1> 	; original-interpolated-interpolated
  3669                              <1> 
  3670 0000160C 93                  <1> 	xchg	ax, bx
  3671 0000160D AB                  <1> 	stosw		; original sample (L)
  3672 0000160E 93                  <1> 	xchg	ax, bx
  3673 0000160F AB                  <1> 	stosw		; original sample (R)
  3674 00001610 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3675 00001613 50                  <1> 	push	ax ; *	; [previous_val_r]
  3676 00001614 80C780              <1> 	add	bh, 80h
  3677 00001617 8006[6D19]80        <1> 	add	byte [next_val_l+1], 80h
  3678 0000161C A1[6C19]            <1> 	mov	ax, [next_val_l]
  3679 0000161F 01D8                <1> 	add	ax, bx	; [previous_val_l]
  3680 00001621 D1D8                <1> 	rcr	ax, 1
  3681 00001623 93                  <1> 	xchg	ax, bx	; ax = [previous_val_l]	
  3682 00001624 01D8                <1> 	add	ax, bx	; bx = interpolated middle (L)
  3683 00001626 D1D8                <1> 	rcr	ax, 1
  3684 00001628 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3685 0000162B AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3686 0000162C 58                  <1> 	pop	ax  ; *
  3687 0000162D 80C680              <1> 	add	dh, 80h ; convert sound level 0 to 65535 format
  3688 00001630 52                  <1> 	push	dx  ; * ; [next_val_r]
  3689 00001631 92                  <1> 	xchg	ax, dx
  3690 00001632 01D0                <1> 	add	ax, dx	; [next_val_r] + [previous_val_r]
  3691 00001634 D1D8                <1> 	rcr	ax, 1	; / 2
  3692 00001636 50                  <1> 	push	ax ; ** ; interpolated middle (R)
  3693 00001637 01D0                <1> 	add	ax, dx	; + [previous_val_r]
  3694 00001639 D1D8                <1> 	rcr	ax, 1
  3695 0000163B 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3696 0000163E AB                  <1> 	stosw 		; interpolated sample 1 (R)
  3697 0000163F A1[6C19]            <1> 	mov	ax, [next_val_l]
  3698 00001642 01D8                <1> 	add	ax, bx	; + interpolated middle (L)
  3699 00001644 D1D8                <1> 	rcr	ax, 1
  3700 00001646 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3701 00001649 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  3702 0000164A 58                  <1> 	pop	ax ; **
  3703 0000164B 5A                  <1> 	pop	dx ; *	
  3704 0000164C 01D0                <1> 	add	ax, dx	; interpolated middle + [next_val_r]
  3705 0000164E D1D8                <1> 	rcr	ax, 1	; / 2
  3706 00001650 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3707 00001653 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  3708 00001654 C3                  <1> 	retn
  3709                              <1> 
  3710                              <1> interpolating_2_16bit_mono:
  3711                              <1> 	; 16/11/2023
  3712                              <1> 	; ax = [previous_val]
  3713                              <1> 	; dx = [next_val]
  3714                              <1> 	; original-interpolated
  3715                              <1> 
  3716 00001655 AB                  <1> 	stosw		; original sample (L)
  3717 00001656 AB                  <1> 	stosw		; original sample (R)
  3718 00001657 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3719 0000165A 80C680              <1> 	add	dh, 80h
  3720 0000165D 01D0                <1> 	add	ax, dx
  3721 0000165F D1D8                <1> 	rcr	ax, 1
  3722 00001661 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3723 00001664 AB                  <1> 	stosw		; interpolated sample (L)
  3724 00001665 AB                  <1> 	stosw		; interpolated sample (R)
  3725 00001666 C3                  <1> 	retn
  3726                              <1> 
  3727                              <1> interpolating_2_16bit_stereo:
  3728                              <1> 	; 16/11/2023
  3729                              <1> 	; bx = [previous_val_l]
  3730                              <1> 	; ax = [previous_val_r]
  3731                              <1> 	; [next_val_l]
  3732                              <1> 	; dx = [next_val_r]
  3733                              <1> 	; original-interpolated
  3734                              <1> 
  3735 00001667 93                  <1> 	xchg	ax, bx
  3736 00001668 AB                  <1> 	stosw		; original sample (L)
  3737 00001669 93                  <1> 	xchg	ax, bx
  3738 0000166A AB                  <1> 	stosw		; original sample (R)
  3739 0000166B 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3740 0000166E 80C680              <1> 	add	dh, 80h
  3741 00001671 01D0                <1> 	add	ax, dx	; [previous_val_r] + [next_val_r]
  3742 00001673 D1D8                <1> 	rcr	ax, 1	; / 2
  3743 00001675 50                  <1> 	push	ax ; *	; interpolated sample (R)
  3744 00001676 A1[6C19]            <1> 	mov	ax, [next_val_l]
  3745 00001679 80C480              <1> 	add	ah, 80h
  3746 0000167C 80C780              <1> 	add	bh, 80h
  3747 0000167F 01D8                <1> 	add	ax, bx	; [next_val_l] + [previous_val_l]
  3748 00001681 D1D8                <1> 	rcr	ax, 1	; / 2		
  3749 00001683 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3750 00001686 AB                  <1> 	stosw 		; interpolated sample (L)
  3751 00001687 58                  <1> 	pop	ax ; *	
  3752 00001688 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3753 0000168B AB                  <1> 	stosw 		; interpolated sample (R)
  3754 0000168C C3                  <1> 	retn
  3755                              <1> 
  3756                              <1> interpolating_5_8bit_mono:
  3757                              <1> 	; 17/11/2023
  3758                              <1> 	; al = [previous_val]
  3759                              <1> 	; dl = [next_val]
  3760                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  3761 0000168D 88C3                <1> 	mov	bl, al
  3762 0000168F 2C80                <1> 	sub	al, 80h
  3763 00001691 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3764 00001694 AB                  <1> 	stosw		; original sample (L)
  3765 00001695 AB                  <1> 	stosw		; original sample (R)
  3766 00001696 88D8                <1> 	mov	al, bl
  3767 00001698 00D0                <1> 	add	al, dl	
  3768 0000169A D0D8                <1> 	rcr	al, 1
  3769 0000169C 88C7                <1> 	mov	bh, al	; interpolated middle (temporary)
  3770 0000169E 00D8                <1> 	add	al, bl  ; [previous_val]
  3771 000016A0 D0D8                <1> 	rcr	al, 1 	
  3772 000016A2 88C6                <1> 	mov	dh, al	; interpolated 1st quarter (temporary)
  3773 000016A4 00D8                <1> 	add	al, bl
  3774 000016A6 D0D8                <1> 	rcr	al, 1
  3775 000016A8 2C80                <1> 	sub	al, 80h
  3776 000016AA C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3777 000016AD AB                  <1> 	stosw		; interpolated sample 1 (L)
  3778 000016AE AB                  <1> 	stosw		; interpolated sample 1 (R)
  3779 000016AF 88F8                <1> 	mov	al, bh
  3780 000016B1 00F0                <1> 	add	al, dh
  3781 000016B3 D0D8                <1> 	rcr	al, 1
  3782 000016B5 2C80                <1> 	sub	al, 80h
  3783 000016B7 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3784 000016BA AB                  <1> 	stosw		; interpolated sample 2 (L)
  3785 000016BB AB                  <1> 	stosw		; interpolated sample 2 (R)
  3786 000016BC 88F8                <1> 	mov	al, bh
  3787 000016BE 00D0                <1> 	add	al, dl	; [next_val]
  3788 000016C0 D0D8                <1> 	rcr	al, 1
  3789 000016C2 88C6                <1> 	mov	dh, al	; interpolated 3rd quarter (temporary)
  3790 000016C4 00F8                <1> 	add	al, bh
  3791 000016C6 D0D8                <1> 	rcr	al, 1
  3792 000016C8 2C80                <1> 	sub	al, 80h
  3793 000016CA C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3794 000016CD AB                  <1> 	stosw		; interpolated sample 3 (L)
  3795 000016CE AB                  <1> 	stosw		; interpolated sample 3 (R)
  3796 000016CF 88F0                <1> 	mov	al, dh
  3797 000016D1 00D0                <1> 	add	al, dl
  3798 000016D3 D0D8                <1> 	rcr	al, 1
  3799 000016D5 2C80                <1> 	sub	al, 80h
  3800 000016D7 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3801 000016DA AB                  <1> 	stosw		; interpolated sample 4 (L)
  3802 000016DB AB                  <1> 	stosw		; interpolated sample 4 (R)
  3803 000016DC C3                  <1> 	retn
  3804                              <1> 
  3805                              <1> interpolating_5_8bit_stereo:
  3806                              <1> 	; 17/11/2023
  3807                              <1> 	; al = [previous_val_l]
  3808                              <1> 	; ah = [previous_val_r]
  3809                              <1> 	; dl = [next_val_l]
  3810                              <1> 	; dh = [next_val_r]	
  3811                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  3812 000016DD 89C3                <1> 	mov	bx, ax
  3813 000016DF 2C80                <1> 	sub	al, 80h
  3814 000016E1 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3815 000016E4 AB                  <1> 	stosw		; original sample (L)
  3816 000016E5 88F8                <1> 	mov	al, bh
  3817 000016E7 2C80                <1> 	sub	al, 80h
  3818 000016E9 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3819 000016EC AB                  <1> 	stosw		; original sample (R)
  3820 000016ED 52                  <1> 	push	dx ; *
  3821 000016EE 88D8                <1> 	mov	al, bl
  3822 000016F0 00D0                <1> 	add	al, dl	; [next_val_l]
  3823 000016F2 D0D8                <1> 	rcr	al, 1
  3824 000016F4 50                  <1> 	push	ax ; **	; al = interpolated middle (L) (temporary)
  3825 000016F5 00D8                <1> 	add	al, bl	; [previous_val_l]
  3826 000016F7 D0D8                <1> 	rcr	al, 1
  3827 000016F9 86C3                <1> 	xchg	al, bl	
  3828 000016FB 00D8                <1> 	add	al, bl	; bl = interpolated 1st quarter (L) (temp)
  3829 000016FD D0D8                <1> 	rcr	al, 1
  3830 000016FF 2C80                <1> 	sub	al, 80h
  3831 00001701 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3832 00001704 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3833 00001705 88F8                <1> 	mov	al, bh
  3834 00001707 00F0                <1> 	add	al, dh	; [next_val_r]
  3835 00001709 D0D8                <1> 	rcr	al, 1
  3836 0000170B 50                  <1> 	push	ax ; *** ; al = interpolated middle (R) (temporary)
  3837 0000170C 00F8                <1> 	add	al, bh	; [previous_val_r]
  3838 0000170E D0D8                <1> 	rcr	al, 1
  3839 00001710 86C7                <1> 	xchg	al, bh	
  3840 00001712 00F8                <1> 	add	al, bh	; bh = interpolated 1st quarter (R) (temp)
  3841 00001714 D0D8                <1> 	rcr	al, 1
  3842 00001716 2C80                <1> 	sub	al, 80h
  3843 00001718 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3844 0000171B AB                  <1> 	stosw		; interpolated sample 1 (R)
  3845 0000171C 5A                  <1> 	pop	dx ; ***
  3846 0000171D 58                  <1> 	pop	ax ; **	; al = interpolated middle (L) (temporary)
  3847 0000171E 86C3                <1> 	xchg	al, bl	; al = interpolated 1st quarter (L) (temp)
  3848 00001720 00D8                <1> 	add	al, bl	; bl = interpolated middle (L) (temporary)
  3849 00001722 D0D8                <1> 	rcr	al, 1
  3850 00001724 2C80                <1> 	sub	al, 80h
  3851 00001726 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3852 00001729 AB                  <1> 	stosw		; interpolated sample 2 (L)	
  3853 0000172A 88D0                <1> 	mov	al, dl 	; interpolated middle (R) (temporary)
  3854 0000172C 86C7                <1> 	xchg	al, bh	; al = interpolated 1st quarter (R) (temp)
  3855 0000172E 00F8                <1> 	add	al, bh	; bh = interpolated middle (R) (temporary)
  3856 00001730 D0D8                <1> 	rcr	al, 1
  3857 00001732 2C80                <1> 	sub	al, 80h
  3858 00001734 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3859 00001737 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3860 00001738 5A                  <1> 	pop	dx ; *
  3861 00001739 88D8                <1> 	mov	al, bl	; interpolated middle (L) (temporary)
  3862 0000173B 00D0                <1> 	add	al, dl	; [next_val_l]
  3863 0000173D D0D8                <1> 	rcr	al, 1
  3864 0000173F 86C3                <1> 	xchg	al, bl	; al = interpolated middle (R) (temporary)	
  3865 00001741 00D8                <1> 	add	al, bl	; bl = interpolated 3rd quarter (L) (temp) 
  3866 00001743 D0D8                <1> 	rcr	al, 1
  3867 00001745 2C80                <1> 	sub	al, 80h
  3868 00001747 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3869 0000174A AB                  <1> 	stosw		; interpolated sample 3 (L)
  3870 0000174B 88F8                <1> 	mov	al, bh	
  3871 0000174D 00F0                <1> 	add	al, dh	; interpolated middle (R) + [next_val_r]
  3872 0000174F D0D8                <1> 	rcr	al, 1
  3873 00001751 86C7                <1> 	xchg	al, bh	; al = interpolated middle (R)
  3874 00001753 00F8                <1> 	add	al, bh	; bh = interpolated 3rd quarter (R) (temp)
  3875 00001755 D0D8                <1> 	rcr	al, 1
  3876 00001757 2C80                <1> 	sub	al, 80h
  3877 00001759 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3878 0000175C AB                  <1> 	stosw		; interpolated sample 3 (R)
  3879 0000175D 88D8                <1> 	mov	al, bl
  3880 0000175F 00D0                <1> 	add	al, dl	; [next_val_l]
  3881 00001761 D0D8                <1> 	rcr	al, 1
  3882 00001763 2C80                <1> 	sub	al, 80h
  3883 00001765 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3884 00001768 AB                  <1> 	stosw		; interpolated sample 4 (L)
  3885 00001769 88F8                <1> 	mov	al, bh
  3886 0000176B 00F0                <1> 	add	al, dh	; [next_val_r]
  3887 0000176D D0D8                <1> 	rcr	al, 1
  3888 0000176F 2C80                <1> 	sub	al, 80h
  3889 00001771 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3890 00001774 AB                  <1> 	stosw		; interpolated sample 4 (R)
  3891 00001775 C3                  <1> 	retn
  3892                              <1> 
  3893                              <1> interpolating_4_8bit_mono:
  3894                              <1> 	; 17/11/2023
  3895                              <1> 	; al = [previous_val]
  3896                              <1> 	; dl = [next_val]
  3897                              <1> 	; original-interpolated-interpolated-interpolated
  3898 00001776 88C3                <1> 	mov	bl, al
  3899 00001778 2C80                <1> 	sub	al, 80h
  3900 0000177A C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3901 0000177D AB                  <1> 	stosw		; original sample (L)
  3902 0000177E AB                  <1> 	stosw		; original sample (R)
  3903 0000177F 88D8                <1> 	mov	al, bl
  3904 00001781 00D0                <1> 	add	al, dl	
  3905 00001783 D0D8                <1> 	rcr	al, 1
  3906 00001785 86C3                <1> 	xchg	al, bl  ; al = [previous_val]
  3907 00001787 00D8                <1> 	add	al, bl	; bl = interpolated middle (sample 2)
  3908 00001789 D0D8                <1> 	rcr	al, 1 	
  3909 0000178B 2C80                <1> 	sub	al, 80h
  3910 0000178D C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3911 00001790 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3912 00001791 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3913 00001792 88D8                <1> 	mov	al, bl	; interpolated middle (sample 2)
  3914 00001794 2C80                <1> 	sub	al, 80h
  3915 00001796 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3916 00001799 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3917 0000179A AB                  <1> 	stosw		; interpolated sample 2 (R)
  3918 0000179B 88D8                <1> 	mov	al, bl
  3919 0000179D 00D0                <1> 	add	al, dl	; [next_val]
  3920 0000179F D0D8                <1> 	rcr	al, 1
  3921 000017A1 2C80                <1> 	sub	al, 80h
  3922 000017A3 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3923 000017A6 AB                  <1> 	stosw		; interpolated sample 3 (L)
  3924 000017A7 AB                  <1> 	stosw		; interpolated sample 3 (R)
  3925 000017A8 C3                  <1> 	retn
  3926                              <1> 
  3927                              <1> interpolating_4_8bit_stereo:
  3928                              <1> 	; 17/11/2023
  3929                              <1> 	; al = [previous_val_l]
  3930                              <1> 	; ah = [previous_val_r]
  3931                              <1> 	; dl = [next_val_l]
  3932                              <1> 	; dh = [next_val_r]	
  3933                              <1> 	; original-interpolated-interpolated-interpolated
  3934 000017A9 89C3                <1> 	mov	bx, ax
  3935 000017AB 2C80                <1> 	sub	al, 80h
  3936 000017AD C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3937 000017B0 AB                  <1> 	stosw		; original sample (L)
  3938 000017B1 88F8                <1> 	mov	al, bh
  3939 000017B3 2C80                <1> 	sub	al, 80h
  3940 000017B5 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3941 000017B8 AB                  <1> 	stosw		; original sample (R)
  3942 000017B9 88D8                <1> 	mov	al, bl
  3943 000017BB 00D0                <1> 	add	al, dl	; [next_val_l]
  3944 000017BD D0D8                <1> 	rcr	al, 1
  3945 000017BF 86C3                <1> 	xchg	al, bl	; al = [previous_val_l]
  3946 000017C1 00D8                <1> 	add	al, bl	; bl = interpolated middle (L) (sample 2)
  3947 000017C3 D0D8                <1> 	rcr	al, 1
  3948 000017C5 2C80                <1> 	sub	al, 80h
  3949 000017C7 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3950 000017CA AB                  <1> 	stosw		; interpolated sample 1 (L)
  3951 000017CB 88F8                <1> 	mov	al, bh
  3952 000017CD 00F0                <1> 	add	al, dh	; [next_val_r]
  3953 000017CF D0D8                <1> 	rcr	al, 1
  3954 000017D1 86C7                <1> 	xchg	al, bh	; al = [previous_val_h]
  3955 000017D3 00F8                <1> 	add	al, bh	; bh = interpolated middle (R) (sample 2)
  3956 000017D5 D0D8                <1> 	rcr	al, 1
  3957 000017D7 2C80                <1> 	sub	al, 80h
  3958 000017D9 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3959 000017DC AB                  <1> 	stosw		; interpolated sample 1 (R)
  3960 000017DD 88D8                <1> 	mov	al, bl	; interpolated middle (L) (sample 2)
  3961 000017DF 2C80                <1> 	sub	al, 80h
  3962 000017E1 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3963 000017E4 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3964 000017E5 88F8                <1> 	mov	al, bh	; interpolated middle (L) (sample 2)
  3965 000017E7 2C80                <1> 	sub	al, 80h
  3966 000017E9 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3967 000017EC AB                  <1> 	stosw		; interpolated sample 2 (L)
  3968 000017ED 88D8                <1> 	mov	al, bl
  3969 000017EF 00D0                <1> 	add	al, dl	; [next_val_l]
  3970 000017F1 D0D8                <1> 	rcr	al, 1
  3971 000017F3 2C80                <1> 	sub	al, 80h
  3972 000017F5 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3973 000017F8 AB                  <1> 	stosw		; interpolated sample 3 (L)
  3974 000017F9 88F8                <1> 	mov	al, bh
  3975 000017FB 00F0                <1> 	add	al, dh	; [next_val_r]
  3976 000017FD D0D8                <1> 	rcr	al, 1
  3977 000017FF 2C80                <1> 	sub	al, 80h
  3978 00001801 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3979 00001804 AB                  <1> 	stosw		; interpolated sample 3 (R)
  3980 00001805 C3                  <1> 	retn
  3981                              <1> 
  3982                              <1> interpolating_5_16bit_mono:
  3983                              <1> 	; 18/11/2023
  3984                              <1> 	; ax = [previous_val]
  3985                              <1> 	; dx = [next_val]
  3986                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  3987 00001806 AB                  <1> 	stosw		; original sample (L)
  3988 00001807 AB                  <1> 	stosw		; original sample (R)
  3989 00001808 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3990 0000180B 89C3                <1> 	mov	bx, ax	; [previous_val]
  3991 0000180D 80C680              <1> 	add	dh, 80h
  3992 00001810 01D0                <1> 	add	ax, dx
  3993 00001812 D1D8                <1> 	rcr	ax, 1
  3994 00001814 50                  <1> 	push	ax ; *	; interpolated middle (temporary)
  3995 00001815 01D8                <1> 	add	ax, bx	; interpolated middle + [previous_val] 
  3996 00001817 D1D8                <1> 	rcr	ax, 1
  3997 00001819 50                  <1> 	push	ax ; **	; interpolated 1st quarter (temporary)
  3998 0000181A 01D8                <1> 	add	ax, bx	; 1st quarter + [previous_val]
  3999 0000181C D1D8                <1> 	rcr	ax, 1	
  4000 0000181E 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4001 00001821 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  4002 00001822 AB                  <1> 	stosw		; interpolated sample 1 (R)
  4003 00001823 58                  <1> 	pop	ax ; **	
  4004 00001824 5B                  <1> 	pop	bx ; *
  4005 00001825 01D8                <1> 	add	ax, bx	; 1st quarter + middle
  4006 00001827 D1D8                <1> 	rcr	ax, 1	; / 2
  4007 00001829 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again	
  4008 0000182C AB                  <1> 	stosw		; interpolated sample 2 (L)
  4009 0000182D AB                  <1> 	stosw		; interpolated sample 2 (R)		
  4010 0000182E 89D8                <1> 	mov	ax, bx
  4011 00001830 01D0                <1> 	add	ax, dx	; interpolated middle + [next_val]
  4012 00001832 D1D8                <1> 	rcr	ax, 1
  4013 00001834 50                  <1> 	push	ax ; *	; interpolated 3rd quarter (temporary)
  4014 00001835 01D8                <1> 	add	ax, bx	; + interpolated middle
  4015 00001837 D1D8                <1> 	rcr	ax, 1
  4016 00001839 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4017 0000183C AB                  <1> 	stosw		; interpolated sample 3 (L)
  4018 0000183D AB                  <1> 	stosw		; interpolated sample 3 (R)
  4019 0000183E 58                  <1> 	pop	ax ; *	
  4020 0000183F 01D0                <1> 	add	ax, dx	; 3rd quarter + [next_val]
  4021 00001841 D1D8                <1> 	rcr	ax, 1	; / 2
  4022 00001843 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4023 00001846 AB                  <1> 	stosw		; interpolated sample 4 (L)
  4024 00001847 AB                  <1> 	stosw		; interpolated sample 4 (R)
  4025 00001848 C3                  <1> 	retn
  4026                              <1> 
  4027                              <1> interpolating_5_16bit_stereo:
  4028                              <1> 	; 18/11/2023
  4029                              <1> 	; bx = [previous_val_l]
  4030                              <1> 	; ax = [previous_val_r]
  4031                              <1> 	; [next_val_l]
  4032                              <1> 	; [next_val_r]
  4033                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  4034 00001849 51                  <1> 	push	cx ; !
  4035 0000184A 93                  <1> 	xchg	ax, bx
  4036 0000184B AB                  <1> 	stosw		; original sample (L)
  4037 0000184C 93                  <1> 	xchg	ax, bx
  4038 0000184D AB                  <1> 	stosw		; original sample (R)
  4039 0000184E 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  4040 00001851 50                  <1> 	push	ax ; *	; [previous_val_r]
  4041 00001852 80C780              <1> 	add	bh, 80h
  4042 00001855 8006[6D19]80        <1> 	add	byte [next_val_l+1], 80h
  4043 0000185A A1[6C19]            <1> 	mov	ax, [next_val_l]
  4044 0000185D 01D8                <1> 	add	ax, bx	; [previous_val_l]
  4045 0000185F D1D8                <1> 	rcr	ax, 1
  4046 00001861 89C1                <1> 	mov	cx, ax	; interpolated middle (L)
  4047 00001863 01D8                <1> 	add	ax, bx	
  4048 00001865 D1D8                <1> 	rcr	ax, 1
  4049 00001867 89C2                <1> 	mov	dx, ax	; interpolated 1st quarter (L)	
  4050 00001869 01D8                <1> 	add	ax, bx	; [previous_val_l]
  4051 0000186B D1D8                <1> 	rcr	ax, 1
  4052 0000186D 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4053 00001870 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  4054 00001871 89C8                <1> 	mov	ax, cx
  4055 00001873 01D0                <1> 	add	ax, dx	; middle (L) + 1st quarter (L) 
  4056 00001875 D1D8                <1> 	rcr	ax, 1	; / 2
  4057 00001877 89C3                <1> 	mov	bx, ax  ; interpolated sample 2 (L)
  4058 00001879 5A                  <1> 	pop	dx ; *	; [previous_val_r]
  4059 0000187A 89D0                <1> 	mov	ax, dx
  4060 0000187C 8006[6F19]80        <1> 	add	byte [next_val_r+1], 80h
  4061 00001881 0306[6E19]          <1> 	add	ax, [next_val_r]
  4062 00001885 D1D8                <1> 	rcr	ax, 1
  4063 00001887 50                  <1> 	push	ax ; *	; interpolated middle (R)
  4064 00001888 01D0                <1> 	add	ax, dx
  4065 0000188A D1D8                <1> 	rcr	ax, 1
  4066 0000188C 50                  <1> 	push	ax ; **	; interpolated 1st quarter (R)
  4067 0000188D 01D0                <1> 	add	ax, dx	; [previous_val_r]
  4068 0000188F D1D8                <1> 	rcr	ax, 1
  4069 00001891 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4070 00001894 AB                  <1> 	stosw 		; interpolated sample 1 (R)
  4071 00001895 89D8                <1> 	mov	ax, bx
  4072 00001897 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4073 0000189A AB                  <1> 	stosw 		; interpolated sample 2 (L)
  4074 0000189B 58                  <1> 	pop	ax ; **
  4075 0000189C 5A                  <1> 	pop	dx ; *
  4076 0000189D 01D0                <1> 	add	ax, dx	; 1st quarter (R) + middle (R)
  4077 0000189F D1D8                <1> 	rcr	ax, 1	; / 2
  4078 000018A1 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4079 000018A4 AB                  <1> 	stosw 		; interpolated sample 2 (R)
  4080 000018A5 89C8                <1> 	mov	ax, cx
  4081 000018A7 0306[6C19]          <1> 	add	ax, [next_val_l]
  4082 000018AB D1D8                <1> 	rcr	ax, 1
  4083 000018AD 50                  <1> 	push	ax ; * 	; interpolated 3rd quarter (L)
  4084 000018AE 01C8                <1> 	add	ax, cx	; interpolated middle (L)
  4085 000018B0 D1D8                <1> 	rcr	ax, 1
  4086 000018B2 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4087 000018B5 AB                  <1> 	stosw 		; interpolated sample 3 (L)
  4088 000018B6 89D0                <1> 	mov	ax, dx
  4089 000018B8 0306[6E19]          <1> 	add	ax, [next_val_r]
  4090 000018BC D1D8                <1> 	rcr	ax, 1
  4091 000018BE 50                  <1> 	push	ax ; ** ; interpolated 3rd quarter (R)
  4092 000018BF 01D0                <1> 	add	ax, dx	; interpolated middle (R)
  4093 000018C1 D1D8                <1> 	rcr	ax, 1
  4094 000018C3 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4095 000018C6 AB                  <1> 	stosw 		; interpolated sample 3 (R)
  4096 000018C7 5B                  <1> 	pop	bx ; **
  4097 000018C8 58                  <1> 	pop	ax ; *
  4098 000018C9 0306[6C19]          <1> 	add	ax, [next_val_l]
  4099 000018CD D1D8                <1> 	rcr	ax, 1
  4100 000018CF 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4101 000018D2 AB                  <1> 	stosw 		; interpolated sample 4 (L)
  4102 000018D3 89D8                <1> 	mov	ax, bx	
  4103 000018D5 0306[6E19]          <1> 	add	ax, [next_val_r]
  4104 000018D9 D1D8                <1> 	rcr	ax, 1
  4105 000018DB 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4106 000018DE AB                  <1> 	stosw 		; interpolated sample 4 (R)
  4107 000018DF 59                  <1> 	pop	cx ; !
  4108 000018E0 C3                  <1> 	retn
  4109                              <1> 
  4110                              <1> interpolating_4_16bit_mono:
  4111                              <1> 	; 18/11/2023
  4112                              <1> 	; ax = [previous_val]
  4113                              <1> 	; dx = [next_val]
  4114                              <1> 	; original-interpolated
  4115                              <1> 
  4116 000018E1 AB                  <1> 	stosw		; original sample (L)
  4117 000018E2 AB                  <1> 	stosw		; original sample (R)
  4118 000018E3 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  4119 000018E6 89C3                <1> 	mov	bx, ax	; [previous_val]
  4120 000018E8 80C680              <1> 	add	dh, 80h
  4121 000018EB 01D0                <1> 	add	ax, dx	; [previous_val] + [next_val]
  4122 000018ED D1D8                <1> 	rcr	ax, 1
  4123 000018EF 93                  <1> 	xchg	ax, bx	
  4124 000018F0 01D8                <1> 	add	ax, bx	; [previous_val] + interpolated middle
  4125 000018F2 D1D8                <1> 	rcr	ax, 1
  4126 000018F4 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4127 000018F7 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  4128 000018F8 AB                  <1> 	stosw		; interpolated sample 1 (R)
  4129 000018F9 89D8                <1> 	mov	ax, bx	; interpolated middle
  4130 000018FB 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4131 000018FE AB                  <1> 	stosw 		; interpolated sample 2 (L)
  4132 000018FF AB                  <1> 	stosw		; interpolated sample 2 (R)
  4133 00001900 89D8                <1> 	mov	ax, bx
  4134 00001902 01D0                <1> 	add	ax, dx	; interpolated middle + [next_val]
  4135 00001904 D1D8                <1> 	rcr	ax, 1
  4136 00001906 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4137 00001909 AB                  <1> 	stosw		; interpolated sample 3 (L)
  4138 0000190A AB                  <1> 	stosw		; interpolated sample 3 (R)
  4139 0000190B C3                  <1> 	retn
  4140                              <1> 
  4141                              <1> interpolating_4_16bit_stereo:
  4142                              <1> 	; 18/11/2023
  4143                              <1> 	; bx = [previous_val_l]
  4144                              <1> 	; ax = [previous_val_r]
  4145                              <1> 	; [next_val_l]
  4146                              <1> 	; [next_val_r]
  4147                              <1> 	; original-interpolated-interpolated-interpolated
  4148 0000190C 93                  <1> 	xchg	ax, bx
  4149 0000190D AB                  <1> 	stosw		; original sample (L)
  4150 0000190E 93                  <1> 	xchg	ax, bx
  4151 0000190F AB                  <1> 	stosw		; original sample (R)
  4152 00001910 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  4153 00001913 89C2                <1> 	mov	dx, ax	; [previous_val_r]
  4154 00001915 80C780              <1> 	add	bh, 80h
  4155 00001918 8006[6D19]80        <1> 	add	byte [next_val_l+1], 80h
  4156 0000191D A1[6C19]            <1> 	mov	ax, [next_val_l]
  4157 00001920 01D8                <1> 	add	ax, bx	; [previous_val_l]
  4158 00001922 D1D8                <1> 	rcr	ax, 1
  4159 00001924 93                  <1> 	xchg	ax, bx	
  4160 00001925 01D8                <1> 	add	ax, bx	; bx = interpolated middle (L)
  4161 00001927 D1D8                <1> 	rcr	ax, 1
  4162 00001929 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4163 0000192C AB                  <1> 	stosw 		; interpolated sample 1 (L)
  4164 0000192D 8006[6F19]80        <1> 	add	byte [next_val_r+1], 80h
  4165 00001932 89D0                <1> 	mov	ax, dx	; [previous_val_r]
  4166 00001934 0306[6E19]          <1> 	add	ax, [next_val_r]
  4167 00001938 D1D8                <1> 	rcr	ax, 1
  4168 0000193A 92                  <1> 	xchg	ax, dx	
  4169 0000193B 01D0                <1> 	add	ax, dx	; dx = interpolated middle (R)
  4170 0000193D D1D8                <1> 	rcr	ax, 1
  4171 0000193F 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4172 00001942 AB                  <1> 	stosw 		; interpolated sample 1 (R)
  4173 00001943 89D8                <1> 	mov	ax, bx
  4174 00001945 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4175 00001948 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  4176 00001949 89D0                <1> 	mov	ax, dx
  4177 0000194B 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4178 0000194E AB                  <1> 	stosw 		; interpolated sample 2 (R)
  4179 0000194F 89D8                <1> 	mov	ax, bx
  4180 00001951 0306[6C19]          <1> 	add	ax, [next_val_l]
  4181 00001955 D1D8                <1> 	rcr	ax, 1
  4182 00001957 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4183 0000195A AB                  <1> 	stosw 		; interpolated sample 3 (L)
  4184 0000195B 89D0                <1> 	mov	ax, dx
  4185 0000195D 0306[6E19]          <1> 	add	ax, [next_val_r]
  4186 00001961 D1D8                <1> 	rcr	ax, 1
  4187 00001963 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4188 00001966 AB                  <1> 	stosw 		; interpolated sample 3 (R)
  4189 00001967 C3                  <1> 	retn
  4190                              <1> 
  4191                              <1> ; 13/11/2023
  4192                              <1> previous_val:
  4193 00001968 0000                <1> previous_val_l: dw 0
  4194 0000196A 0000                <1> previous_val_r: dw 0
  4195                              <1> next_val:
  4196 0000196C 0000                <1> next_val_l: dw 0
  4197 0000196E 0000                <1> next_val_r: dw 0
  4198                              <1> 
  4199                              <1> ; 16/11/2023
  4200 00001970 00                  <1> faz:	db 0	
  4201                              <1> 	
  4202                              <1> ; --------------------------------------------------------
   453                                  
   454                                  ; UTILS.ASM
   455                                  ;----------------------------------------------------------------------------
   456                                  ;       delay1_4ms - Delay for 1/4 millisecond.
   457                                  ;		    1mS = 1000us
   458                                  ;       Entry:
   459                                  ;         None
   460                                  ;       Exit:
   461                                  ;	  None
   462                                  ;
   463                                  ;       Modified:
   464                                  ;         None
   465                                  ;
   466                                  PORTB			EQU	061h
   467                                    REFRESH_STATUS	EQU	010h		; Refresh signal status
   468                                  
   469                                  delay1_4ms:
   470 00001971 50                              push    ax 
   471 00001972 51                              push    cx
   472 00001973 B91000                          mov     cx, 16			; close enough.
   473 00001976 E461                    	in	al,PORTB
   474 00001978 2410                    	and	al,REFRESH_STATUS
   475 0000197A 88C4                    	mov	ah,al			; Start toggle state
   476 0000197C 09C9                    	or	cx, cx
   477 0000197E 7401                    	jz	short _d4ms1
   478 00001980 41                      	inc	cx			; Throwaway first toggle
   479                                  _d4ms1:	
   480 00001981 E461                    	in	al,PORTB		; Read system control port
   481 00001983 2410                    	and	al,REFRESH_STATUS	; Refresh toggles 15.085 microseconds
   482 00001985 38C4                    	cmp	ah,al
   483 00001987 74F8                    	je	short _d4ms1		; Wait for state change
   484                                  
   485 00001989 88C4                    	mov	ah,al			; Update with new state
   486 0000198B 49                      	dec	cx
   487 0000198C 75F3                    	jnz	short _d4ms1
   488                                  
   489 0000198E 59                              pop     cx
   490 0000198F 58                              pop     ax
   491 00001990 C3                              retn
   492                                  
   493                                  	; 13/11/2016 - Erdogan Tan
   494                                  write_ac97_dev_info:
   495                                  	; BUS/DEV/FN
   496                                  	;	00000000BBBBBBBBDDDDDFFF00000000
   497                                  	; DEV/VENDOR
   498                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
   499                                  
   500 00001991 30FF                    	xor	bh, bh
   501 00001993 668B36[E01D]            	mov	esi, [dev_vendor]
   502 00001998 89F0                    	mov	ax, si
   503 0000199A 88C3                    	mov	bl, al
   504 0000199C 88DA                    	mov	dl, bl
   505 0000199E 80E30F                  	and	bl, 0Fh
   506 000019A1 8A87[591C]              	mov	al, [bx+hex_chars]
   507 000019A5 A2[9C1C]                	mov	[msgVendorId+3], al
   508 000019A8 88D3                    	mov	bl, dl
   509 000019AA C0EB04                  	shr	bl, 4
   510 000019AD 8A87[591C]              	mov	al, [bx+hex_chars]
   511 000019B1 A2[9B1C]                	mov	[msgVendorId+2], al
   512 000019B4 88E3                    	mov	bl, ah
   513 000019B6 88DA                    	mov	dl, bl
   514 000019B8 80E30F                  	and	bl, 0Fh
   515 000019BB 8A87[591C]              	mov	al, [bx+hex_chars]
   516 000019BF A2[9A1C]                	mov	[msgVendorId+1], al
   517 000019C2 88D3                    	mov	bl, dl
   518 000019C4 C0EB04                  	shr	bl, 4
   519 000019C7 8A87[591C]              	mov	al, [bx+hex_chars]
   520 000019CB A2[991C]                	mov	[msgVendorId], al
   521 000019CE 66C1EE10                	shr	esi, 16
   522 000019D2 89F0                    	mov	ax, si
   523 000019D4 88C3                    	mov	bl, al
   524 000019D6 88DA                    	mov	dl, bl
   525 000019D8 80E30F                  	and	bl, 0Fh
   526 000019DB 8A87[591C]              	mov	al, [bx+hex_chars]
   527 000019DF A2[AD1C]                	mov	[msgDevId+3], al
   528 000019E2 88D3                    	mov	bl, dl
   529 000019E4 C0EB04                  	shr	bl, 4
   530 000019E7 8A87[591C]              	mov	al, [bx+hex_chars]
   531 000019EB A2[AC1C]                	mov	[msgDevId+2], al
   532 000019EE 88E3                    	mov	bl, ah
   533 000019F0 88DA                    	mov	dl, bl
   534 000019F2 80E30F                  	and	bl, 0Fh
   535 000019F5 8A87[591C]              	mov	al, [bx+hex_chars]
   536 000019F9 A2[AB1C]                	mov	[msgDevId+1], al
   537 000019FC 88D3                    	mov	bl, dl
   538 000019FE C0EB04                  	shr	bl, 4
   539 00001A01 8A87[591C]              	mov	al, [bx+hex_chars]
   540 00001A05 A2[AA1C]                	mov	[msgDevId], al
   541                                  
   542 00001A08 668B36[DC1D]            	mov	esi, [bus_dev_fn]
   543 00001A0D 66C1EE08                	shr	esi, 8
   544 00001A11 89F0                    	mov	ax, si
   545 00001A13 88C3                    	mov	bl, al
   546 00001A15 88DA                    	mov	dl, bl
   547 00001A17 80E307                  	and	bl, 7 ; bit 0,1,2
   548 00001A1A 8A87[591C]              	mov	al, [bx+hex_chars]
   549 00001A1E A2[D11C]                	mov	[msgFncNo+1], al
   550 00001A21 88D3                    	mov	bl, dl
   551 00001A23 C0EB03                  	shr	bl, 3
   552 00001A26 88DA                    	mov	dl, bl
   553 00001A28 80E30F                  	and	bl, 0Fh
   554 00001A2B 8A87[591C]              	mov	al, [bx+hex_chars]
   555 00001A2F A2[C31C]                	mov	[msgDevNo+1], al
   556 00001A32 88D3                    	mov	bl, dl
   557 00001A34 C0EB04                  	shr	bl, 4
   558 00001A37 8A87[591C]              	mov	al, [bx+hex_chars]
   559 00001A3B A2[C21C]                	mov	[msgDevNo], al
   560 00001A3E 88E3                    	mov	bl, ah
   561 00001A40 88DA                    	mov	dl, bl
   562 00001A42 80E30F                  	and	bl, 0Fh
   563 00001A45 8A87[591C]              	mov	al, [bx+hex_chars]
   564 00001A49 A2[B71C]                	mov	[msgBusNo+1], al
   565 00001A4C 88D3                    	mov	bl, dl
   566 00001A4E C0EB04                  	shr	bl, 4
   567 00001A51 8A87[591C]              	mov	al, [bx+hex_chars]
   568 00001A55 A2[B61C]                	mov	[msgBusNo], al
   569                                  
   570 00001A58 A1[D21D]                	mov	ax, [NAMBAR]
   571 00001A5B 88C3                    	mov	bl, al
   572 00001A5D 88DA                    	mov	dl, bl
   573 00001A5F 80E30F                  	and	bl, 0Fh
   574 00001A62 8A87[591C]              	mov	al, [bx+hex_chars]
   575 00001A66 A2[E01C]                	mov	[msgNamBar+3], al
   576 00001A69 88D3                    	mov	bl, dl
   577 00001A6B C0EB04                  	shr	bl, 4
   578 00001A6E 8A87[591C]              	mov	al, [bx+hex_chars]
   579 00001A72 A2[DF1C]                	mov	[msgNamBar+2], al
   580 00001A75 88E3                    	mov	bl, ah
   581 00001A77 88DA                    	mov	dl, bl
   582 00001A79 80E30F                  	and	bl, 0Fh
   583 00001A7C 8A87[591C]              	mov	al, [bx+hex_chars]
   584 00001A80 A2[DE1C]                	mov	[msgNamBar+1], al
   585 00001A83 88D3                    	mov	bl, dl
   586 00001A85 C0EB04                  	shr	bl, 4
   587 00001A88 8A87[591C]              	mov	al, [bx+hex_chars]
   588 00001A8C A2[DD1C]                	mov	[msgNamBar], al
   589                                  
   590                                  	; 05/11/2023
   591 00001A8F A1[D41D]                	mov	ax, [NABMBAR]
   592 00001A92 88C3                    	mov	bl, al
   593 00001A94 88DA                    	mov	dl, bl
   594 00001A96 80E30F                  	and	bl, 0Fh
   595 00001A99 678A83[591C0000]        	mov	al, [ebx+hex_chars]
   596 00001AA0 A2[EF1C]                	mov	[msgNabmBar+3], al
   597 00001AA3 88D3                    	mov	bl, dl
   598 00001AA5 C0EB04                  	shr	bl, 4
   599 00001AA8 678A83[591C0000]        	mov	al, [ebx+hex_chars]
   600 00001AAF A2[EE1C]                	mov	[msgNabmBar+2], al
   601 00001AB2 88E3                    	mov	bl, ah
   602 00001AB4 88DA                    	mov	dl, bl
   603 00001AB6 80E30F                  	and	bl, 0Fh
   604 00001AB9 678A83[591C0000]        	mov	al, [ebx+hex_chars]
   605 00001AC0 A2[ED1C]                	mov	[msgNabmBar+1], al
   606 00001AC3 88D3                    	mov	bl, dl
   607 00001AC5 C0EB04                  	shr	bl, 4
   608 00001AC8 678A83[591C0000]        	mov	al, [ebx+hex_chars]
   609 00001ACF A2[EC1C]                	mov	[msgNabmBar], al
   610                                  
   611                                  	; 24/11/2016
   612 00001AD2 30E4                    	xor	ah, ah
   613 00001AD4 A0[C91D]                	mov	al, [ac97_int_ln_reg]
   614 00001AD7 B10A                    	mov	cl, 10
   615 00001AD9 F6F1                    	div	cl
   616 00001ADB 0106[F71C]              	add	[msgIRQ], ax
   617 00001ADF 20C0                    	and	al, al
   618 00001AE1 7508                    	jnz	short _pmi
   619 00001AE3 A0[F81C]                	mov	al, [msgIRQ+1]
   620 00001AE6 B420                    	mov	ah, ' '
   621 00001AE8 A3[F71C]                	mov	[msgIRQ], ax
   622                                  _pmi:
   623 00001AEB BA[6A1C]                        mov	dx, msgAC97Info
   624 00001AEE B409                            mov     ah, 9
   625 00001AF0 CD21                            int     21h
   626 00001AF2 C3                              retn
   627                                  
   628                                  write_sample_rate:
   629                                  	; ax = sample rate (hertz)
   630                                  
   631 00001AF3 31D2                    	xor	dx, dx
   632 00001AF5 B90A00                  	mov	cx, 10
   633 00001AF8 F7F1                    	div	cx
   634 00001AFA 0016[0D1D]              	add	[msgHertz+4], dl
   635 00001AFE 29D2                    	sub	dx, dx
   636 00001B00 F7F1                    	div	cx
   637 00001B02 0016[0C1D]              	add	[msgHertz+3], dl
   638 00001B06 29D2                    	sub	dx, dx
   639 00001B08 F7F1                    	div	cx
   640 00001B0A 0016[0B1D]              	add	[msgHertz+2], dl
   641 00001B0E 29D2                    	sub	dx, dx
   642 00001B10 F7F1                    	div	cx
   643 00001B12 0016[0A1D]              	add	[msgHertz+1], dl
   644 00001B16 0006[091D]              	add	[msgHertz], al
   645                                  	
   646 00001B1A BA[FC1C]                        mov     dx, msgSampleRate
   647 00001B1D B409                            mov     ah, 9
   648 00001B1F CD21                            int     21h
   649                                  
   650                                  	; 19/11/2016
   651 00001B21 BA[221D]                	mov	dx, msg16Bits
   652 00001B24 803E[E81D]10            	cmp	byte [bps], 16
   653 00001B29 7403                    	je	short wsr_1
   654 00001B2B BA[131D]                	mov	dx, msg8Bits
   655                                  wsr_1:
   656 00001B2E B409                            mov     ah, 9
   657 00001B30 CD21                            int     21h
   658                                  
   659 00001B32 BA[1B1D]                	mov	dx, msgMono
   660 00001B35 803E[E61D]01            	cmp	byte [stmo], 1
   661 00001B3A 7403                    	je	short wsr_2
   662 00001B3C BA[2B1D]                	mov	dx, msgStereo		
   663                                  wsr_2:
   664 00001B3F B409                            mov     ah, 9
   665 00001B41 CD21                            int     21h
   666                                  
   667 00001B43 C3                              retn
   668                                  
   669                                  ;detect_codec:
   670                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   671                                  ;	mov	eax, 7Ch
   672                                  ;	call	codec_read
   673                                  ;       shl     eax, 16
   674                                  ;       mov     [codec_id], eax
   675                                  ;
   676                                  ;	mov	eax, 7Eh
   677                                  ;       call	codec_read
   678                                  ;       or      eax, [codec_id]
   679                                  ;       mov     [codec_chip_id], eax
   680                                  ;       and     eax, 0FFFFFF00h
   681                                  ;
   682                                  ;       mov     edi, codecs
   683                                  ;_dcb:
   684                                  ;       mov     ebx, [di]
   685                                  ;       test    ebx, ebx
   686                                  ;       jz      short _dco_unknown
   687                                  ;
   688                                  ;       cmp     eax, ebx
   689                                  ;       jne     short _dco_next
   690                                  ;       mov     ax, [di+4]
   691                                  ;       mov     [codec_vendor_ids], ax
   692                                  ;       movzx   esi, ax
   693                                  ;       call	print_msg
   694                                  ;       
   695                                  ;	mov	ax, [di+6]
   696                                  ;	call	detect_chip
   697                                  ;       retn
   698                                  ;
   699                                  ;_dco_next:
   700                                  ;       add     di, 8
   701                                  ;       jmp     short _dcb
   702                                  ;
   703                                  ;_dco_unknown:
   704                                  ;       mov    word [codec_vendor_ids], ac_unknown
   705                                  ;       mov    word [codec_chip_ids], chip_unknown
   706                                  ;       mov     esi, chip_unknown
   707                                  ;	call	print_msg
   708                                  ;       mov     eax, [codec_chip_id]
   709                                  ;       call    dword2str
   710                                  ;       call	print_msg
   711                                  ;       retn
   712                                  
   713                                  ;detect_chip:
   714                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   715                                  ;	mov	di, ax ; chip_tab
   716                                  ;       mov     eax, [codec_chip_id]
   717                                  ;       and     ax, 0FFh
   718                                  ;_dch1:
   719                                  ;       mov     bx, [di]
   720                                  ;       cmp     bx, 0FFh
   721                                  ;       je      short _dch_unknown
   722                                  ;
   723                                  ;       cmp     ax, bx
   724                                  ;       jne     short _dch_next
   725                                  ;       mov     ax, [di+2]
   726                                  ;       mov     [codec_chip_ids], ax
   727                                  ;       mov     si, ax
   728                                  ;       call	print_msg
   729                                  ;       retn
   730                                  
   731                                  ;_dch_next:
   732                                  ;       add     di, 4
   733                                  ;       jmp     short _dch1
   734                                  ;
   735                                  ;_dch_unknown:
   736                                  ;       mov    word [codec_chip_ids], chip_unknown
   737                                  ;       mov     si, chip_unknown
   738                                  ;       call	print_msg
   739                                  ;       mov     eax, [codec_chip_id]
   740                                  ;       call    dword2str
   741                                  ;       call	print_msg
   742                                  ;       retn
   743                                  
   744                                  ; 10/11/2023
   745                                  ; 09/11/2023
   746                                  ; 06/11/2023
   747                                  %if 1
   748                                  
   749                                  ac97_int_handler:
   750                                  	; 11/11/2023
   751                                  	; 10/11/2023
   752                                  	; 17/02/2016
   753 00001B44 6650                    	push	eax	; 11/11/2023
   754 00001B46 52                      	push	dx
   755                                  	; 05/11/2023	
   756                                  	;push	cx
   757                                  	;push	bx
   758                                  	;push	si
   759                                  	;push	di
   760                                  
   761                                  	; 10/11/2023
   762                                  	; EOI at first
   763 00001B47 B020                    	mov	al, 20h
   764 00001B49 F606[C91D]08            	test	byte [ac97_int_ln_reg], 8
   765 00001B4E 7402                    	jz	short _ih_0
   766 00001B50 E6A0                    	out 	0A0h, al ; 20h	; EOI
   767                                  _ih_0:
   768 00001B52 E620                    	out	20h, al  ; 20h	; EOI
   769                                  
   770                                  	; 11/11/2023
   771                                  	; 09/11/2023
   772 00001B54 BA3000                  	mov	dx, GLOB_STS_REG
   773 00001B57 0316[D41D]                      add	dx, [NABMBAR]
   774 00001B5B 66ED                    	in	eax, dx
   775                                  	
   776                                  	; 09/11/2023,
   777 00001B5D 6683F8FF                        cmp	eax, 0FFFFFFFFh ; -1
   778 00001B61 741D                    	je	short _ih_2
   779                                  	
   780 00001B63 A840                    	test	al, 40h		; PCM Out Interrupt
   781 00001B65 7509                    	jnz	short _ih_1
   782                                  
   783 00001B67 6685C0                  	test	eax, eax
   784 00001B6A 7414                    	jz	short _ih_2
   785                                  
   786                                   	;mov	dx, GLOB_STS_REG
   787                                          ;add	dx, [NABMBAR]
   788 00001B6C 66EF                    	out	dx, eax
   789 00001B6E EB10                    	jmp	short _ih_2
   790                                  
   791                                  	; .....
   792                                  	;mov	al, 1
   793                                  	; 10/11/2023
   794                                  	;mov	[tloop], al  ; 1
   795                                  
   796                                  	;cmp	[inside], al ; 1
   797                                  	;jnb	short _ih_3	; busy
   798                                  
   799                                  	;mov	[inside], al ; 1
   800                                  	;
   801                                  	;; 09/11/2023
   802                                          ;mov	dx, [NABMBAR]
   803                                          ;add	dx, PO_SR_REG	; set pointer to Status reg
   804                                  	;in	al, dx
   805                                  	;; 10/11/2023
   806                                  	;;;out	dx, eax
   807                                  	;;out	dx, al		; clear interrupt event
   808                                  	;			; (by writing 1 to same bits)
   809                                  	;
   810                                  	;;mov	[pcm_irq_status], al ; 05/11/2023
   811                                  	;test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
   812                                  	;jz	short _ih_2
   813                                  	; .....
   814                                  
   815                                  _ih_1:
   816                                  	; 11/11/2023
   817 00001B70 6650                    	push	eax
   818                                  
   819                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   820                                  	;mov	dx, PO_SR_REG
   821                                          ;add	dx, [NABMBAR]
   822                                  	;out	dx, ax
   823                                  
   824                                  	; 10/11/2023
   825                                  	; 28/11/2016 - Erdogan Tan
   826 00001B72 E8CFEB                  	call	tuneLoop
   827                                  
   828                                  	; 11/11/2023
   829 00001B75 6658                    	pop	eax
   830 00001B77 BA3000                  	mov	dx, GLOB_STS_REG
   831 00001B7A 0316[D41D]                      add	dx, [NABMBAR]
   832 00001B7E 66EF                    	out	dx, eax
   833                                  _ih_2:
   834                                  	; 11/11/2023
   835 00001B80 8B16[D41D]              	mov	dx, [NABMBAR]
   836 00001B84 83C216                  	add	dx, PO_SR_REG	; set pointer to Status reg
   837 00001B87 B81C00                  	mov	ax, 1Ch
   838 00001B8A EF                      	out	dx, ax
   839                                  
   840                                  ;	; 10/11/2023
   841                                  ;	mov	al, 20h
   842                                  ;	test	byte [ac97_int_ln_reg], 8
   843                                  ;	jz	short _ih_3
   844                                  ;	out 	0A0h, al ; 20h	; EOI
   845                                  ;_ih_3:
   846                                  ;	out	20h, al  ; 20h	; EOI
   847                                  ;_ih_4:
   848                                  	;mov	byte [inside], 0
   849                                  	;pop	di
   850                                  	;pop	si
   851                                  	;pop	bx
   852                                  	;pop	cx
   853 00001B8B 5A                      	pop	dx
   854 00001B8C 6658                    	pop	eax ; 11/11/2023
   855 00001B8E CF                      	iret
   856                                  
   857                                  %endif
   858                                  
   859                                  ; 10/11/2023
   860                                  ; 09/11/2023
   861                                  ; 06/11/2023
   862                                  %if 0
   863                                  
   864                                  ac97_int_handler:
   865                                  	; 10/11/2023
   866                                  	; 17/02/2016
   867                                  	push	ax	; 09/11/2023
   868                                  	push	dx
   869                                  	; 05/11/2023
   870                                  	;push	cx
   871                                  	;push	bx
   872                                  	;push	si
   873                                  	;push	di
   874                                  
   875                                  	; 10/11/2023
   876                                  	; EOI at first
   877                                  	mov	al, 20h
   878                                  	test	byte [ac97_int_ln_reg], 8
   879                                  	jz	short _ih_0
   880                                  	out 	0A0h, al ; 20h	; EOI
   881                                  _ih_0:
   882                                  	out	20h, al  ; 20h	; EOI
   883                                  
   884                                  	mov	al, 1
   885                                  
   886                                  	; 10/11/2023
   887                                  	;mov	[tloop], al  ; 1
   888                                  
   889                                  	cmp	[inside], al ; 1
   890                                  	jnb	short _ih_3	; busy
   891                                  
   892                                  	mov	[inside], al ; 1
   893                                  
   894                                  	; 09/11/2023
   895                                          mov	dx, [NABMBAR]
   896                                          add	dx, PO_SR_REG	; set pointer to Status reg
   897                                  	in	al, dx
   898                                  	; 10/11/2023
   899                                  	;out	dx, eax
   900                                  	out	dx, al		; clear interrupt event
   901                                  				; (by writing 1 to same bits)
   902                                  
   903                                  	;mov	[pcm_irq_status], al ; 05/11/2023
   904                                  	test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
   905                                  	jz	short _ih_2
   906                                  	
   907                                  	; 09/11/2023
   908                                  	;mov	dx, GLOB_STS_REG
   909                                          ;add	dx, [NABMBAR]
   910                                  	;in	eax, dx
   911                                  	
   912                                  	; 09/11/2023,
   913                                          ;cmp	eax, 0FFFFFFFFh ; -1
   914                                  	;je	short _ih_2
   915                                  	
   916                                  	;test	al, 40h		; PCM Out Interrupt
   917                                  	;jz	short _ih_2
   918                                  _ih_1:
   919                                  	; 10/11/2023
   920                                  	; 28/11/2016 - Erdogan Tan
   921                                  	call	tuneLoop
   922                                  	;jnc	short _ih_2
   923                                  	;dec	byte [tloop] ; [tloop] = 0
   924                                  _ih_2:
   925                                  	mov	byte [inside], 0
   926                                  _ih_3:
   927                                  	;pop	di
   928                                  	;pop	si
   929                                  	;pop	bx
   930                                  	;pop	cx
   931                                  	pop	dx
   932                                  	pop	ax ; 09/11/2023
   933                                  	iret
   934                                  
   935                                  %endif
   936                                  
   937                                  ac97_stop:
   938                                  	; 11/11/2023
   939                                  	; 09/11/2023
   940                                  	; 05/11/2023
   941                                  	; 04/11/2023 
   942                                  	; 28/05/2017 (TRDOS 386 v2, 'audio.s')
   943                                  	;mov	byte [tLoop], 0 ; stop ! ; 05/11/2023
   944                                  ;_ac97_stop:
   945                                  
   946                                  	; 11/11/2023
   947 00001B8F 8B16[D21D]              	mov	dx, [NAMBAR]
   948                                  	;add	dx, 0 ; ac_reg_0 ; reset register
   949 00001B93 EF                      	out	dx, ax
   950                                  
   951                                  	; 04/11/2023
   952                                  	; 09/10/2017 (TRDOS 386 v2, 'audio.s')
   953                                  	; 11/06/2017
   954 00001B94 30C0                    	xor	al, al ; 0
   955 00001B96 E80D00                  	call	ac97_po_cmd
   956                                  
   957                                  	; (Ref: KolibriOS, intelac97.asm, 'stop:')
   958                                  	; Clear FIFOE, BCIS, LVBCI (Ref: Intel ICH hub manual)
   959 00001B99 B81C00                  	mov     ax, 1Ch
   960 00001B9C 8B16[D41D]              	mov     dx, [NABMBAR]
   961 00001BA0 83C216                  	add     dx, PO_SR_REG
   962 00001BA3 EF                      	out     dx, ax
   963                                  
   964                                  	; 11/06/2017
   965 00001BA4 B002                    	mov     al, RR
   966                                  ac97_po_cmd:
   967                                  	; 11/06/2017
   968                                  	; 29/05/2017
   969 00001BA6 8B16[D41D]              	mov     dx, [NABMBAR]
   970 00001BAA 83C21B                          add     dx, PO_CR_REG		; PCM out control register
   971 00001BAD EE                      	out	dx, al
   972 00001BAE C3                      	retn
   973                                  
   974                                  print_msg:
   975                                  	; 13/11/2016 - Erdogan Tan 
   976                                  	; esi = ASCIIZ text address
   977                                  	;
   978 00001BAF BB0700                  	mov	bx, 7h
   979 00001BB2 B40E                    	mov	ah, 0Eh 
   980                                  pm_next_char:
   981 00001BB4 AC                      	lodsb
   982 00001BB5 20C0                    	and	al, al
   983 00001BB7 7404                    	jz	short pm_retn
   984 00001BB9 CD10                    	int	10h
   985 00001BBB EBF7                    	jmp	short pm_next_char
   986                                  pm_retn:
   987 00001BBD C3                      	retn
   988                                  
   989                                  ; 06/11/2023
   990                                  ;dword2str:
   991                                  ;	; 13/11/2016 - Erdogan Tan 
   992                                  ;	; eax = dword value
   993                                  ;	;
   994                                  ;	call	dwordtohex
   995                                  ;	mov	[dword_str], edx
   996                                  ;	mov	[dword_str+4], eax
   997                                  ;	mov	si, dword_str
   998                                  ;	retn
   999                                  
  1000                                  	; trdos386.s (unix386.s) - 10/05/2015
  1001                                  	; Convert binary number to hexadecimal string
  1002                                  
  1003                                  bytetohex:
  1004                                  	; INPUT ->
  1005                                  	; 	AL = byte (binary number)
  1006                                  	; OUTPUT ->
  1007                                  	;	AX = hexadecimal string
  1008                                  	;
  1009 00001BBE 53                      	push	bx
  1010 00001BBF 30FF                    	xor	bh, bh
  1011 00001BC1 88C3                    	mov	bl, al
  1012 00001BC3 C0EB04                  	shr	bl, 4
  1013 00001BC6 8A9F[591C]              	mov	bl, [bx+hex_chars] 	 	
  1014 00001BCA 86D8                    	xchg	bl, al
  1015 00001BCC 80E30F                  	and	bl, 0Fh
  1016 00001BCF 8AA7[591C]              	mov	ah, [bx+hex_chars] 
  1017 00001BD3 5B                      	pop	bx	
  1018 00001BD4 C3                      	retn
  1019                                  
  1020                                  wordtohex:
  1021                                  	; INPUT ->
  1022                                  	; 	AX = word (binary number)
  1023                                  	; OUTPUT ->
  1024                                  	;	EAX = hexadecimal string
  1025                                  	;
  1026 00001BD5 53                      	push	bx
  1027 00001BD6 30FF                    	xor	bh, bh
  1028 00001BD8 86E0                    	xchg	ah, al
  1029 00001BDA 50                      	push	ax
  1030 00001BDB 88E3                    	mov	bl, ah
  1031 00001BDD C0EB04                  	shr	bl, 4
  1032 00001BE0 8A87[591C]              	mov	al, [bx+hex_chars] 	 	
  1033 00001BE4 88E3                    	mov	bl, ah
  1034 00001BE6 80E30F                  	and	bl, 0Fh
  1035 00001BE9 8AA7[591C]              	mov	ah, [bx+hex_chars]
  1036 00001BED 66C1E010                	shl	eax, 16
  1037 00001BF1 58                      	pop	ax
  1038 00001BF2 5B                      	pop	bx
  1039 00001BF3 EBC9                    	jmp	short bytetohex
  1040                                  
  1041                                  ; 06/11/2023
  1042                                  ;dwordtohex:
  1043                                  ;	; INPUT ->
  1044                                  ;	; 	EAX = dword (binary number)
  1045                                  ;	; OUTPUT ->
  1046                                  ;	;	EDX:EAX = hexadecimal string
  1047                                  ;	;
  1048                                  ;	push	eax
  1049                                  ;	shr	eax, 16
  1050                                  ;	call	wordtohex
  1051                                  ;	mov	edx, eax
  1052                                  ;	pop	eax
  1053                                  ;	call	wordtohex
  1054                                  ;	retn
  1055                                  
  1056                                  _DATA:
  1057                                  
  1058                                  ; 24/11/2016
  1059                                  ;	IRQ  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 
  1060 00001BF5 08090A0B0C0D0E0F70-     irq_int	 db 08h,09h,0Ah,0Bh,0Ch,0Dh,0Eh,0Fh,70h,71h,72h,73h,74h,75h,76h,77h
  1060 00001BFE 71727374757677     
  1061                                  
  1062                                  ; 17/02/2017
  1063                                  ; Valid ICH device IDs
  1064                                  
  1065                                  valid_ids:
  1066 00001C05 86801524                dd	(ICH_DID << 16) + INTEL_VID  	 ; 8086h:2415h 
  1067 00001C09 86802524                dd	(ICH0_DID << 16) + INTEL_VID 	 ; 8086h:2425h 
  1068 00001C0D 86804524                dd	(ICH2_DID << 16) + INTEL_VID 	 ; 8086h:2445h 
  1069 00001C11 86808524                dd	(ICH3_DID << 16) + INTEL_VID 	 ; 8086h:2485h 
  1070 00001C15 8680C524                dd	(ICH4_DID << 16) + INTEL_VID 	 ; 8086h:24C5h
  1071 00001C19 8680D524                dd	(ICH5_DID << 16) + INTEL_VID 	 ; 8086h:24D5h
  1072 00001C1D 86806E26                dd	(ICH6_DID << 16) + INTEL_VID 	 ; 8086h:266Eh
  1073 00001C21 8680A625                dd	(ESB6300_DID << 16) + INTEL_VID  ; 8086h:25A6h
  1074 00001C25 86809826                dd	(ESB631X_DID << 16) + INTEL_VID  ; 8086h:2698h
  1075 00001C29 8680DE27                dd	(ICH7_DID << 16) + INTEL_VID 	 ; 8086h:27DEh
  1076                                  ; 03/11/2023 - Erdogan Tan
  1077 00001C2D 86809571                dd	(MX82440_DID << 16) + INTEL_VID  ; 8086h:7195h
  1078 00001C31 39101270                dd	(SI7012_DID << 16)  + SIS_VID	 ; 1039h:7012h
  1079 00001C35 DE10B101                dd 	(NFORCE_DID << 16)  + NVIDIA_VID ; 10DEh:01B1h
  1080 00001C39 DE106A00                dd 	(NFORCE2_DID << 16) + NVIDIA_VID ; 10DEh:006Ah
  1081 00001C3D 22106D74                dd 	(AMD8111_DID << 16) + AMD_VID 	 ; 1022h:746Dh
  1082 00001C41 22104574                dd 	(AMD768_DID << 16)  + AMD_VID 	 ; 1022h:7445h
  1083 00001C45 DE105900                dd 	(CK804_DID << 16) + NVIDIA_VID	 ; 10DEh:0059h
  1084 00001C49 DE103A00                dd 	(MCP04_DID << 16) + NVIDIA_VID	 ; 10DEh:003Ah
  1085 00001C4D DE108A00                dd 	(CK8_DID << 16) + NVIDIA_VID	 ; 1022h:008Ah
  1086 00001C51 DE10DA00                dd 	(NFORCE3_DID << 16) + NVIDIA_VID ; 10DEh:00DAh
  1087 00001C55 DE10EA00                dd 	(CK8S_DID << 16) + NVIDIA_VID	 ; 10DEh:00EAh
  1088                                  
  1089                                  valid_id_count:	equ ($ - valid_ids)>>2 ; 05/11/2023
  1090                                  
  1091                                  ; 13/11/2016
  1092 00001C59 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  1092 00001C62 3941424344454600   
  1093 00001C6A 414339372041756469-     msgAC97Info	db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  1093 00001C73 6F20436F6E74726F6C-
  1093 00001C7C 6C6572202620436F64-
  1093 00001C85 656320496E666F0D0A 
  1094 00001C8E 56656E646F72204944-     		db "Vendor ID: "
  1094 00001C97 3A20               
  1095 00001C99 303030306820446576-     msgVendorId	db "0000h Device ID: "
  1095 00001CA2 6963652049443A20   
  1096 00001CAA 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  1097 00001CB1 4275733A20              		db "Bus: "
  1098 00001CB6 303068204465766963-     msgBusNo	db "00h Device: "
  1098 00001CBF 653A20             
  1099 00001CC2 3030682046756E6374-     msgDevNo	db "00h Function: "
  1099 00001CCB 696F6E3A20         
  1100 00001CD0 303068                  msgFncNo	db "00h"
  1101 00001CD3 0D0A                    		db 0Dh, 0Ah
  1102                                  ; 05/11/2023	
  1103 00001CD5 4E414D4241523A20        		db "NAMBAR: "
  1104 00001CDD 303030306820            msgNamBar	db "0000h "
  1105 00001CE3 4E41424D4241523A20      		db "NABMBAR: "
  1106 00001CEC 303030306820495251-     msgNabmBar	db "0000h IRQ: "
  1106 00001CF5 3A20               
  1107 00001CF7 3030                    msgIRQ		dw 3030h
  1108 00001CF9 0D0A24                  		db 0Dh, 0Ah, "$"
  1109 00001CFC 53616D706C65205261-     msgSampleRate	db "Sample Rate: "
  1109 00001D05 74653A20           
  1110 00001D09 303030303020487A20-     msgHertz	db "00000 Hz ", "$" 
  1110 00001D12 24                 
  1111 00001D13 3820626974732024        msg8Bits	db "8 bits ", "$" 
  1112 00001D1B 4D6F6E6F0D0A24          msgMono		db "Mono", 0Dh, 0Ah, "$"
  1113 00001D22 313620626974732024      msg16Bits	db "16 bits ", "$" 
  1114 00001D2B 53746572656F0D0A24      msgStereo	db "Stereo", 0Dh, 0Ah, "$"
  1115                                  
  1116                                  ;; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
  1117                                  ;codec_id	dd 0
  1118                                  ;codec_chip_id	dd 0
  1119                                  ;codec_vendor_ids dw 0
  1120                                  ;codec_chip_ids	dw 0
  1121                                  
  1122 00001D34 3030303030303030        dword_str	 dd 30303030h, 30303030h
  1123 00001D3C 680D0A00                		 db 'h', 0Dh, 0Ah, 0
  1124                                  
  1125                                  ;ac_unknown     db 'unknown manufacturer',13,10,0
  1126                                  ;ac_Realtek     db 'Realtek Semiconductor',13,10,0
  1127                                  ;ac_Analog      db 'Analog Devices',13,10,0
  1128                                  ;ac_CMedia      db 'C-Media Electronics',13,10,0
  1129                                  ;ac_Cirrus      db 'Cirrus Logic',13,10,0
  1130                                  ;ac_Wolfson     db 'Wolfson Microelectronics',13,10,0
  1131                                  ;ac_VIA         db 'VIA Technologies',13,10,0
  1132                                  ;ac_SigmaTel    db 'SigmaTel',13,10,0
  1133                                  ;ac_eMicro      db 'eMicro',13,10,0
  1134                                  ;
  1135                                  ;chip_unknown   db 'unknown codec id ', 0
  1136                                  
  1137                                  ;CHIP_REALTEK   equ 414C4700h
  1138                                  ;CHIP_CMEDIA    equ 434D4900h
  1139                                  ;CHIP_VIA       equ 56494100h
  1140                                  
  1141                                  ;codecs        dd CHIP_CMEDIA
  1142                                  ;	       dw ac_CMedia, chips_CMedia
  1143                                  ;              dd CHIP_REALTEK
  1144                                  ;	       dw ac_Realtek, chips_Realtek
  1145                                  ;              dd CHIP_VIA
  1146                                  ;	       dw ac_VIA, chips_VIA
  1147                                  ;              dd 0
  1148                                  
  1149                                  ;chips_Realtek dw 10h, chip_ALC201a
  1150                                  ;              dw 20h, chip_ALC650
  1151                                  ;              dw 21h, chip_ALC650D
  1152                                  ;              dw 22h, chip_ALC650E
  1153                                  ;              dw 23h, chip_ALC650F
  1154                                  ;              dw 60h, chip_ALC655
  1155                                  ;              dw 80h, chip_ALC658
  1156                                  ;              dw 81h, chip_ALC658D
  1157                                  ;              dw 90h, chip_ALC850
  1158                                  ;              dw 0FFh
  1159                                  
  1160                                  ;chips_CMedia  dw 41h, chip_CM9738
  1161                                  ;              dw 61h, chip_CM9739
  1162                                  ;              dw 69h, chip_CM9780
  1163                                  ;              dw 78h, chip_CM9761
  1164                                  ;              dw 82h, chip_CM9761
  1165                                  ;              dw 83h, chip_CM9761
  1166                                  ;              dw 0FFh
  1167                                  
  1168                                  ;chips_VIA     dw 61h, chip_VIA1612A
  1169                                  ;              dw 0FFh
  1170                                  
  1171                                  ;Realtek
  1172                                  ;chip_ALC201a    db 'ALC201a',0dh,0ah,00h
  1173                                  ;chip_ALC650     db 'ALC650 ',0dh,0ah,00h
  1174                                  ;chip_ALC650D    db 'ALC650D',0dh,0ah,00h
  1175                                  ;chip_ALC650E    db 'ALC650E',0dh,0ah,00h
  1176                                  ;chip_ALC650F    db 'ALC650F',0dh,0ah,00h
  1177                                  ;chip_ALC655     db 'ALC655 ',0dh,0ah,00h
  1178                                  ;chip_ALC658     db 'ALC658 ',0dh,0ah,00h
  1179                                  ;chip_ALC658D    db 'ALC658D',0dh,0ah,00h
  1180                                  ;chip_ALC850     db 'ALC850 ',0dh,0ah,00h
  1181                                  
  1182                                  ;CMedia
  1183                                  ;chip_CM9738     db 'CMI9738', 0dh,0ah,0
  1184                                  ;chip_CM9739     db 'CMI9739', 0dh,0ah,0
  1185                                  ;chip_CM9780     db 'CMI9780', 0dh,0ah,0
  1186                                  ;chip_CM9761     db 'CMI9761', 0dh,0ah,0
  1187                                  
  1188                                  ;VIA
  1189                                  ;chip_VIA1612A   db 'VIA1612A',13,10,0
  1190                                  
  1191                                  ; 11/11/2023
  1192                                  msg_init_err:
  1193 00001D40 0D0A                    	db	CR, LF
  1194 00001D42 4143393720436F6E74-     	db	"AC97 Controller/Codec initialization error !"
  1194 00001D4B 726F6C6C65722F436F-
  1194 00001D54 64656320696E697469-
  1194 00001D5D 616C697A6174696F6E-
  1194 00001D66 206572726F722021   
  1195 00001D6E 0D0A24                  	db	CR, LF, "$"
  1196                                  
  1197                                  ; 12/11/2023
  1198                                  msg_no_vra:
  1199 00001D71 0D0A                    	db	CR, LF
  1200 00001D73 4E6F20565241207375-     	db	"No VRA support ! Only 48 kHZ sample rate supported !"
  1200 00001D7C 70706F72742021204F-
  1200 00001D85 6E6C79203438206B48-
  1200 00001D8E 5A2073616D706C6520-
  1200 00001D97 726174652073757070-
  1200 00001DA0 6F727465642021     
  1201 00001DA7 0D0A24                  	db	CR, LF, "$"
  1202                                  
  1203                                  ; 17/02/2017
  1204                                  bss_start:
  1205                                  
  1206                                  ABSOLUTE bss_start
  1207                                  
  1208                                  alignb 2
  1209                                  
  1210                                  ; 28/11/2016
  1211                                  
  1212 00001DAA <res 1Ch>               smpRBuff:	resw 14 ; 19/11/2016 - Erdogan Tan
  1213                                  
  1214 00001DC6 ????                    filehandle:	resw 1
  1215                                  
  1216 00001DC8 ??                      flags:		resb 1
  1217                                  ; 06/11/2023
  1218 00001DC9 ??                      ac97_int_ln_reg: resb 1
  1219                                  
  1220                                  ; 09/11/2023
  1221                                  ; 06/11/2023
  1222                                  ;pcm_irq_status: resb 1	; 05/11/2023
  1223 00001DCA ??                      inside:		resb 1
  1224 00001DCB ??                      tloop:		resb 1	; 10/11/2023
  1225                                  
  1226                                  ; 09/11/2023
  1227                                  ; 04/11/2023 - 06/11/2023
  1228 00001DCC ????                    IRQ_status:	resw 1	; IRQ status before enabling audio interrupt
  1229 00001DCE ????????                IRQ_vector:	resd 1  ; Previous interrupt handler address	
  1230                                  
  1231                                  ; 17/02/2017
  1232                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  1233                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  1234                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  1235                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  1236 00001DD2 ????                    NAMBAR:		resw 1			; BAR for mixer
  1237 00001DD4 ????                    NABMBAR:	resw 1			; BAR for bus master regs
  1238                                  
  1239                                  ; 256 byte buffer for descriptor list
  1240 00001DD6 ????                    BDL_BUFFER:	resw 1			; segment of our 256byte BDL buffer
  1241 00001DD8 ????                    WAV_BUFFER1:	resw 1			; segment of our WAV storage
  1242                                  ; 64k buffers for wav file storage
  1243 00001DDA ????                    WAV_BUFFER2:	resw 1			; segment of 2nd wav buffer
  1244                                  
  1245                                  ; 06/11/2023
  1246                                  ;tBuff:		resb 1
  1247                                  ;ac97_int_ln_reg: resb 1
  1248                                  
  1249                                  ; 12/11/2016 - Erdogan Tan
  1250                                  
  1251 00001DDC ????????                bus_dev_fn:	resd 1
  1252 00001DE0 ????????                dev_vendor:	resd 1
  1253                                  ; 06/11/2023
  1254                                  ;stats_cmd:	resw 1 ; 17/02/2017
  1255                                  ; 05/11/2023
  1256                                  ;ac97_io_base:	resw 1
  1257 00001DE4 ????                    sample_rate:	resw 1
  1258                                  
  1259                                  ; 19/11/2016
  1260 00001DE6 ????                    stmo:		resw 1 
  1261 00001DE8 ????                    bps:		resw 1
  1262                                  
  1263                                  ; 08/11/2023
  1264                                  ; 07/11/2023
  1265 00001DEA ??                      fbs_shift:	resb 1
  1266                                  ; 09/11/2023
  1267 00001DEB ??                      b_indicator:	resb 1
  1268                                  ; 10/11/2023
  1269 00001DEC ??                      LVI:		resb 1
  1270 00001DED ??                      		resb 1 ; 10/11/2023 
  1271                                  
  1272                                  ;fbs_seg:	resw 1
  1273                                  ;fbs_off:	resw 1
  1274                                  
  1275                                  ;alignb 2
  1276                                  
  1277                                  ; 32 kilo bytes for temporay buffer
  1278                                  ; (for stereo-mono, 8bit/16bit corrections)
  1279                                  ;temp_buffer:	resb 32768
  1280                                  ; 18/11/2023
  1281 00001DEE <res DBF0h>             temp_buffer:	resb 56304  ; (44.1 kHZ stereo 14076 samples)	
  1282                                  
  1283                                  ;alignb 16
  1284                                  EOF:
