     1                                  ; ****************************************************************************
     2                                  ; PLAYWAV.ASM - ICH AC97 .wav player for DOS.			   PLAYWAV.COM
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; Last Update: 19/05/2024 (Previous: 08/05/2024)
     5                                  ; ----------------------------------------------------------------------------
     6                                  ; Beginning: 17/02/2017
     7                                  ; ----------------------------------------------------------------------------
     8                                  ; Assembler: NASM version 2.15
     9                                  ;	     nasm playwav.asm -l playwav.lst -o PLAYWAV.COM	
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Derived from '.wav file player for DOS' Jeff Leyda, Sep 02, 2002 
    12                                  ; ****************************************************************************
    13                                  ; Modidified from 'PLAYER.COM' for VIA VT8233 wav player source code by
    14                                  ; (PLAYER.ASM) by Erdogan Tan (07/11/2016 - 08/12/2016)
    15                                  
    16                                  ; TUNELOOP version (playing without AC97 interrupt) - 06/11/2023 - Erdogan Tan
    17                                  ; sample rate conversion version - 18/11/2023 - Erdogan Tan
    18                                  
    19                                  [BITS 16]
    20                                  
    21                                  [ORG 100h] 
    22                                  
    23                                  	%include 'ac97.inc' ; 17/02/2017
     1                              <1> ; 11/11/2023
     2                              <1> ; 05/11/2023
     3                              <1> ; 03/11/2023
     4                              <1> ; 17/02/2017 (Erdogan Tan, PLAYWAV.ASM)
     5                              <1> ; constant.inc & codec.inc (for ICH AC97 wav player, 'PLAYWAV.COM') 
     6                              <1> 
     7                              <1> ; ----------------------------------------------------------------------------
     8                              <1> ; CONSTANT.INC
     9                              <1> ; ----------------------------------------------------------------------------
    10                              <1> 
    11                              <1> ;constants of stuff that seem hard to remember at times.
    12                              <1> 
    13                              <1> TRUE  EQU 1
    14                              <1> FALSE EQU 0
    15                              <1> 
    16                              <1> ENABLED  EQU 1
    17                              <1> DISABLED EQU 0
    18                              <1> 
    19                              <1> BIT0  EQU 1
    20                              <1> BIT1  EQU 2
    21                              <1> BIT2  EQU 4
    22                              <1> BIT3  EQU 8
    23                              <1> BIT4  EQU 10h
    24                              <1> BIT5  EQU 20h
    25                              <1> BIT6  EQU 40h
    26                              <1> BIT7  EQU 80h
    27                              <1> BIT8  EQU 100h
    28                              <1> BIT9  EQU 200h
    29                              <1> BIT10 EQU 400h
    30                              <1> BIT11 EQU 800h
    31                              <1> BIT12 EQU 1000h
    32                              <1> BIT13 EQU 2000h
    33                              <1> BIT14 EQU 4000h
    34                              <1> BIT15 EQU 8000h
    35                              <1> BIT16 EQU 10000h
    36                              <1> BIT17 EQU 20000h
    37                              <1> BIT18 EQU 40000h
    38                              <1> BIT19 EQU 80000h
    39                              <1> BIT20 EQU 100000h
    40                              <1> BIT21 EQU 200000h
    41                              <1> BIT22 EQU 400000h
    42                              <1> BIT23 EQU 800000h
    43                              <1> BIT24 EQU 1000000h
    44                              <1> BIT25 EQU 2000000h
    45                              <1> BIT26 EQU 4000000h
    46                              <1> BIT27 EQU 8000000h
    47                              <1> BIT28 EQU 10000000h
    48                              <1> BIT29 EQU 20000000h
    49                              <1> BIT30 EQU 40000000h
    50                              <1> BIT31 EQU 80000000h
    51                              <1> 
    52                              <1> ;special characters
    53                              <1> NUL     EQU 0
    54                              <1> NULL    EQU 0
    55                              <1> BELL    EQU 07
    56                              <1> BS      EQU 08
    57                              <1> TAB     EQU 09
    58                              <1> LF      EQU 10
    59                              <1> CR      EQU 13
    60                              <1> ESCAPE  EQU 27           ;ESC is a reserved word....
    61                              <1> 
    62                              <1> 
    63                              <1> ;file stuff
    64                              <1> READONLY  EQU   BIT0
    65                              <1> HIDDEN    EQU   BIT1
    66                              <1> SYSTEM    EQU   BIT2
    67                              <1> VOLUME    EQU   BIT3         ;ignored for file access
    68                              <1> DIRECTORY EQU   BIT4         ;must be 0 for file access
    69                              <1> ARCHIVE   EQU   BIT5
    70                              <1> SHAREABLE EQU   BIT7         ;for novell networks
    71                              <1> OPEN	EQU	2		; open existing file
    72                              <1> CREATE	EQU	1		; create new file
    73                              <1> 
    74                              <1> 
    75                              <1> ; PCI equates
    76                              <1> ; PCI function address (PFA)
    77                              <1> ; bit 31 = 1
    78                              <1> ; bit 23:16 = bus number     (0-255)
    79                              <1> ; bit 15:11 = device number  (0-31)
    80                              <1> ; bit 10:8 = function number (0-7)
    81                              <1> ; bit 7:0 = register number  (0-255)
    82                              <1> 
    83                              <1> IO_ADDR_MASK    EQU     0FFFEh          ; mask off bit 0 for reading BARs
    84                              <1> PCI_INDEX_PORT  EQU     0CF8h
    85                              <1> PCI_DATA_PORT   EQU     0CFCh
    86                              <1> PCI32           EQU     BIT31           ; bitflag to signal 32bit access
    87                              <1> PCI16           EQU     BIT30           ; bitflag for 16bit access
    88                              <1> 
    89                              <1> PCI_FN0         EQU     0 << 8
    90                              <1> PCI_FN1         EQU     1 << 8
    91                              <1> PCI_FN2         EQU     2 << 8
    92                              <1> PCI_FN3         EQU     3 << 8
    93                              <1> PCI_FN4         EQU     4 << 8
    94                              <1> PCI_FN5         EQU     5 << 8
    95                              <1> PCI_FN6         EQU     6 << 8
    96                              <1> PCI_FN7         EQU     7 << 8
    97                              <1> 
    98                              <1> PCI_CMD_REG		EQU	04h		; reg 04, command reg
    99                              <1>  IO_ENA			EQU	BIT0		; i/o decode enable
   100                              <1>  MEM_ENA		EQU	BIT1		; memory decode enable
   101                              <1>  BM_ENA                 EQU     BIT2		; bus master enable
   102                              <1> 
   103                              <1> ; ----------------------------------------------------------------------------
   104                              <1> ; CODEC.INC
   105                              <1> ; ----------------------------------------------------------------------------
   106                              <1> 
   107                              <1> ;Codec registers.
   108                              <1> ;
   109                              <1> ;Not all codecs are created equal. Refer to the spec for your specific codec.
   110                              <1> ;
   111                              <1> ;All registers are 16bits wide.  Access to codec registers over the AC97 link
   112                              <1> ;is defined by the OEM.  
   113                              <1> ;
   114                              <1> ;Secondary codec's are accessed by ORing in BIT7 of all register accesses.
   115                              <1> ;
   116                              <1> 
   117                              <1> ; each codec/mixer register is 16bits
   118                              <1> 
   119                              <1> CODEC_RESET_REG                 equ     00      ; reset codec
   120                              <1> CODEC_MASTER_VOL_REG            equ     02      ; master volume
   121                              <1> CODEC_HP_VOL_REG                equ     04      ; headphone volume
   122                              <1> CODEC_MASTER_MONO_VOL_REG       equ     06      ; master mono volume
   123                              <1> CODEC_MASTER_TONE_REG           equ     08      ; master tone (R+L)
   124                              <1> CODEC_PCBEEP_VOL_REG            equ     0ah     ; PC beep volume
   125                              <1> CODEC_PHONE_VOL_REG             equ     0bh     ; phone volume
   126                              <1> CODEC_MIC_VOL_REG               equ     0eh     ; MIC volume
   127                              <1> CODEC_LINE_IN_VOL_REG           equ     10h     ; line input volume
   128                              <1> CODEC_CD_VOL_REG                equ     12h     ; CD volume
   129                              <1> CODEC_VID_VOL_REG               equ     14h     ; video volume
   130                              <1> CODEC_AUX_VOL_REG               equ     16h     ; aux volume
   131                              <1> CODEC_PCM_OUT_REG               equ     18h     ; PCM output volume
   132                              <1> CODEC_RECORD_SELECT_REG         equ     1ah     ; record select input
   133                              <1> CODEC_RECORD_VOL_REG            equ     1ch     ; record volume
   134                              <1> CODEC_RECORD_MIC_VOL_REG        equ     1eh     ; record mic volume
   135                              <1> CODEC_GP_REG                    equ     20h     ; general purpose
   136                              <1> CODEC_3D_CONTROL_REG            equ     22h     ; 3D control
   137                              <1> ; 24h is reserved
   138                              <1> CODEC_POWER_CTRL_REG            equ     26h     ; powerdown control
   139                              <1> CODEC_EXT_AUDIO_REG             equ     28h     ; extended audio
   140                              <1> CODEC_EXT_AUDIO_CTRL_REG        equ     2ah     ; extended audio control
   141                              <1> CODEC_PCM_FRONT_DACRATE_REG     equ     2ch     ; PCM out sample rate
   142                              <1> CODEC_PCM_SURND_DACRATE_REG     equ     2eh     ; surround sound sample rate
   143                              <1> CODEC_PCM_LFE_DACRATE_REG       equ     30h     ; LFE sample rate
   144                              <1> CODEC_LR_ADCRATE_REG            equ     32h     ; PCM in sample rate
   145                              <1> CODEC_MIC_ADCRATE_REG           equ     34h     ; mic in sample rate
   146                              <1> 
   147                              <1> ; registers 36-7a are reserved on the ICH
   148                              <1> 
   149                              <1> CODEC_VENDORID1_REG             equ     7ch     ; codec vendor ID 1
   150                              <1> CODEC_VENDORID2_REG             equ     7eh     ; codec vendor ID 2
   151                              <1> 
   152                              <1> ; Mixer registers 0 through 51h reside in the ICH and are not forwarded over
   153                              <1> ; the AC97 link to the codec, which I think is a little weird.  Looks like
   154                              <1> ; the ICH makes it so you don't need a fully functional codec to play audio?
   155                              <1> ;
   156                              <1> ; whenever 2 codecs are present in the system, use BIT7 to access the 2nd
   157                              <1> ; set of registers, ie 80h-feh
   158                              <1> 
   159                              <1> PRIMARY_CODEC                   equ     0       ; 0-7F for primary codec
   160                              <1> SECONDARY_CODEC                 equ     BIT7    ; 80-8f registers for 2ndary
   161                              <1> 
   162                              <1> SAMPLE_RATE_441khz	equ     44100   ; 44.1Khz (cd quality) rate
   163                              <1> 
   164                              <1> ; ----------------------------------------------------------------------------
   165                              <1> ; 17/02/2017
   166                              <1> PCI_IO_BASE	equ 10h			; = NAMBAR register offset
   167                              <1> AC97_INT_LINE   equ 3Ch			; AC97 Interrupt Line register offset
   168                              <1> 
   169                              <1> ; ----------------------------------------------------------------------------
   170                              <1> ; ICH2AC97.INC
   171                              <1> ; ----------------------------------------------------------------------------
   172                              <1> 
   173                              <1> ; PCI stuff
   174                              <1> 
   175                              <1> ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
   176                              <1> 
   177                              <1> INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
   178                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   179                              <1> SIS_VID		equ	1039h
   180                              <1> NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
   181                              <1> AMD_VID		equ	1022h
   182                              <1> 
   183                              <1> ICH_DID         equ     2415h           ; ICH device ID
   184                              <1> ICH0_DID        equ     2425h           ; ICH0
   185                              <1> ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
   186                              <1>                                         ; they all should be compatible.
   187                              <1> 
   188                              <1> ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
   189                              <1> ICH3_DID	equ     2485h           ; ICH3
   190                              <1> ICH4_DID        equ     24C5h           ; ICH4
   191                              <1> ICH5_DID	equ     24D5h           ; ICH5 
   192                              <1> ICH6_DID	equ     266Eh           ; ICH6
   193                              <1> ESB6300_DID	equ     25A6h           ; 6300ESB
   194                              <1> ESB631X_DID	equ     2698h           ; 631XESB
   195                              <1> ICH7_DID	equ	27DEh		; ICH7
   196                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   197                              <1> MX82440_DID	equ	7195h
   198                              <1> SI7012_DID	equ	7012h
   199                              <1> NFORCE_DID	equ	01B1h
   200                              <1> NFORCE2_DID	equ	006Ah
   201                              <1> AMD8111_DID	equ	746Dh
   202                              <1> AMD768_DID	equ	7445h
   203                              <1> ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
   204                              <1> CK804_DID	equ	0059h
   205                              <1> MCP04_DID	equ	003Ah
   206                              <1> CK8_DID		equ	008Ah
   207                              <1> NFORCE3_DID	equ	00DAh
   208                              <1> CK8S_DID	equ	00EAh
   209                              <1> 
   210                              <1> NAMBAR_REG      equ     10h             ; native audio mixer BAR
   211                              <1>  NAM_SIZE       equ     256             ; 256 bytes required.
   212                              <1> 
   213                              <1> NABMBAR_REG     equ     14h             ; native audio bus mastering BAR
   214                              <1>  NABM_SIZE      equ     64              ; 64 bytes
   215                              <1> 
   216                              <1> ; BUS master registers, accessed via NABMBAR+offset
   217                              <1> 
   218                              <1> ; ICH supports 3 different types of register sets for three types of things
   219                              <1> ; it can do, thus:
   220                              <1> ;
   221                              <1> ; PCM in (for recording) aka PI
   222                              <1> ; PCM out (for playback) aka PO
   223                              <1> ; MIC in (for recording) aka MC
   224                              <1> 
   225                              <1> PI_BDBAR_REG            equ     0       ; PCM in buffer descriptor BAR
   226                              <1> PO_BDBAR_REG            equ     10h     ; PCM out buffer descriptor BAR
   227                              <1> MC_BDBAR_REG            equ     20h     ; MIC in buffer descriptor BAR
   228                              <1> 
   229                              <1> ; each buffer descriptor BAR holds a pointer which has entries to the buffer
   230                              <1> ; contents of the .WAV file we're going to play. Each entry is 8 bytes long
   231                              <1> ; (more on that later) and can contain 32 entries total, so each BAR is
   232                              <1> ; 256 bytes in length, thus:
   233                              <1> 
   234                              <1> BDL_SIZE                equ     32*8    ; Buffer Descriptor List size
   235                              <1> INDEX_MASK              equ     31      ; indexes must be 0-31
   236                              <1> 
   237                              <1> 
   238                              <1> 
   239                              <1> PI_CIV_REG              equ     4       ; PCM in current Index value (RO)
   240                              <1> PO_CIV_REG              equ     14h     ; PCM out current Index value (RO)
   241                              <1> MC_CIV_REG              equ     24h     ; MIC in current Index value (RO)
   242                              <1> ;8bit read only
   243                              <1> ; each current index value is simply a pointer showing us which buffer
   244                              <1> ; (0-31) the codec is currently processing. Once this counter hits 31, it
   245                              <1> ; wraps back to 0.
   246                              <1> ; this can be handy to know, as once it hits 31, we're almost out of data to
   247                              <1> ; play back or room to record!
   248                              <1> 
   249                              <1> 
   250                              <1> PI_LVI_REG              equ     5       ; PCM in Last Valid Index
   251                              <1> PO_LVI_REG              equ     15h     ; PCM out Last Valid Index
   252                              <1> MC_LVI_REG              equ     25h     ; MIC in Last Valid Index
   253                              <1> ;8bit read/write
   254                              <1> ; The Last Valid Index is a number (0-31) to let the codec know what buffer
   255                              <1> ; number to stop on after processing. It could be very nasty to play audio
   256                              <1> ; from buffers that aren't filled with the audio we want to play.
   257                              <1> 
   258                              <1> 
   259                              <1> PI_SR_REG               equ     6       ; PCM in Status register
   260                              <1> PO_SR_REG               equ     16h     ; PCM out Status register
   261                              <1> MC_SR_REG               equ     26h     ; MIC in Status register
   262                              <1> ;16bit read/write
   263                              <1> ; status registers.  Bitfields follow:
   264                              <1> 
   265                              <1> FIFO_ERR                equ     BIT4    ; FIFO Over/Underrun W1TC.
   266                              <1> 
   267                              <1> BCIS                    equ     BIT3    ; buffer completion interrupt status.
   268                              <1>                                         ; Set whenever the last sample in ANY
   269                              <1>                                         ; buffer is finished.  Bit is only
   270                              <1>                                         ; set when the Interrupt on Complete
   271                              <1>                                         ; (BIT4 of control reg) is set.
   272                              <1> 
   273                              <1> LVBCI                   equ     BIT2    ; Set whenever the codec has processed
   274                              <1>                                         ; the last buffer in the buffer list.
   275                              <1>                                         ; Will fire an interrupt if IOC bit is
   276                              <1>                                         ; set. Probably set after the last
   277                              <1>                                         ; sample in the last buffer is
   278                              <1>                                         ; processed.  W1TC
   279                              <1> 
   280                              <1>                                         ; 
   281                              <1> CELV                    equ     BIT1    ; Current buffer == last valid.
   282                              <1>                                         ; Bit is RO and remains set until LVI is
   283                              <1>                                         ; cleared.  Probably set up the start
   284                              <1>                                         ; of processing for the last buffer.
   285                              <1> 
   286                              <1> 
   287                              <1> DCH                     equ     BIT0    ; DMA controller halted.
   288                              <1>                                         ; set whenever audio stream is stopped
   289                              <1>                                         ; or something else goes wrong.
   290                              <1> 
   291                              <1> 
   292                              <1> PI_PICB_REG             equ     8       ; PCM in position in current buffer(RO)
   293                              <1> PO_PICB_REG             equ     18h     ; PCM out position in current buffer(RO)
   294                              <1> MC_PICB_REG             equ     28h     ; MIC in position in current buffer (RO)
   295                              <1> ;16bit read only
   296                              <1> ; position in current buffer regs show the number of dwords left to be
   297                              <1> ; processed in the current buffer.
   298                              <1> ; 
   299                              <1> 
   300                              <1> PI_PIV_REG              equ     0ah     ; PCM in Prefected index value
   301                              <1> PO_PIV_REG              equ     1ah     ; PCM out Prefected index value
   302                              <1> MC_PIV_REG              equ     2ah     ; MIC in Prefected index value
   303                              <1> ;8bit, read only
   304                              <1> ; Prefetched index value register.
   305                              <1> ; tells which buffer number (0-31) has be prefetched. I'd imagine this
   306                              <1> ; value follows the current index value fairly closely. (CIV+1)
   307                              <1> ;
   308                              <1> 
   309                              <1> 
   310                              <1> PI_CR_REG               equ     0bh     ; PCM in Control Register
   311                              <1> PO_CR_REG               equ     1bh     ; PCM out Control Register
   312                              <1> MC_CR_REG               equ     2bh     ; MIC in Control Register
   313                              <1> ; 8bit
   314                              <1> ; Control register *MUST* only be accessed as an 8bit value.
   315                              <1> ; Control register. See bitfields below.
   316                              <1> ;
   317                              <1> 
   318                              <1> 
   319                              <1> IOCE                    equ     BIT4    ; interrupt on complete enable.
   320                              <1>                                         ; set this bit if you want an intrtpt
   321                              <1>                                         ; to fire whenever LVBCI is set.
   322                              <1> FEIFE                   equ     BIT3    ; set if you want an interrupt to fire
   323                              <1>                                         ; whenever there is a FIFO (over or
   324                              <1>                                         ; under) error.
   325                              <1> LVBIE                   equ     BIT2    ; last valid buffer interrupt enable.
   326                              <1>                                         ; set if you want an interrupt to fire
   327                              <1>                                         ; whenever the completion of the last
   328                              <1>                                         ; valid buffer.
   329                              <1> RR                      equ     BIT1    ; reset registers.  Nukes all regs
   330                              <1>                                         ; except bits 4:2 of this register.
   331                              <1>                                         ; Only set this bit if BIT 0 is 0
   332                              <1> RPBM                    equ     BIT0    ; Run/Pause
   333                              <1>                                         ; set this bit to start the codec!
   334                              <1> 
   335                              <1> 
   336                              <1> GLOB_CNT_REG            equ     2ch     ; Global control register
   337                              <1> SEC_RES_EN              equ     BIT5    ; secondary codec resume event 
   338                              <1>                                         ; interrupt enable.  Not used here.
   339                              <1> PRI_RES_EN              equ     BIT4    ; ditto for primary. Not used here.
   340                              <1> ACLINK_OFF              equ     BIT3    ; Turn off the AC97 link
   341                              <1> ACWARM_RESET            equ     BIT2    ; Awaken the AC97 link from sleep.
   342                              <1>                                         ; registers preserved, bit self clears
   343                              <1> ACCOLD_RESET            equ     BIT1    ; Reset everything in the AC97 and
   344                              <1>                                         ; reset all registers.  Not self clearing
   345                              <1> 
   346                              <1> GPIIE                   equ     BIT0    ; GPI Interrupt enable.
   347                              <1>                                         ; set if you want an interrupt to
   348                              <1>                                         ; fire upon ANY of the bits in the
   349                              <1>                                         ; GPI (general pursose inputs?) not used.
   350                              <1> 
   351                              <1> GLOB_STS_REG            equ     30h     ; Global Status register (RO)
   352                              <1> 
   353                              <1> MD3                     equ     BIT17   ; modem powerdown status (yawn)
   354                              <1> AD3                     equ     BIT16   ; Audio powerdown status (yawn)
   355                              <1> RD_COMPLETE_STS         equ     BIT15   ; Codec read timed out. 0=normal
   356                              <1> BIT3SLOT12              equ     BIT14   ; shadowed status of bit 3 in slot 12
   357                              <1> BIT2SLOT12              equ     BIT13   ; shadowed status of bit 2 in slot 12
   358                              <1> BIT1SLOT12              equ     BIT12   ; shadowed status of bit 1 in slot 12
   359                              <1> SEC_RESUME_STS          equ     BIT11   ; secondary codec has resumed (and irqed)
   360                              <1> PRI_RESUME_STS          equ     BIT10   ; primary codec has resumed (and irqed)
   361                              <1> SEC_CODEC_RDY           equ     BIT9    ; secondary codec is ready for action
   362                              <1> PRI_CODEC_RDY           equ     BIT8    ; Primary codec is ready for action
   363                              <1>                                         ; software must check these bits before
   364                              <1>                                         ; starting the codec!
   365                              <1> MIC_IN_IRQ              equ     BIT7    ; MIC in caused an interrupt
   366                              <1> PCM_OUT_IRQ             equ     BIT6    ; One of the PCM out channels IRQed
   367                              <1> PCM_IN_IRQ              equ     BIT5    ; One of the PCM in channels IRQed
   368                              <1> MODEM_OUT_IRQ           equ     BIT2    ; modem out channel IRQed
   369                              <1> MODEM_IN_IRQ            equ     BIT1    ; modem in channel IRQed
   370                              <1> GPI_STS_CHANGE          equ     BIT0    ; set whenever GPI's have changed.
   371                              <1>                                         ; BIT0 of slot 12 also reflects this.
   372                              <1> 
   373                              <1> ACC_SEMA_REG            equ     34h     ; Codec write semiphore register
   374                              <1> CODEC_BUSY              equ     BIT0    ; codec register I/O is happening
   375                              <1>                                         ; self clearing
   376                              <1> ;
   377                              <1> ; Buffer Descriptors List
   378                              <1> ; As stated earlier, each buffer descriptor list is a set of (up to) 32 
   379                              <1> ; descriptors, each 8 bytes in length. Bytes 0-3 of a descriptor entry point
   380                              <1> ; to a chunk of memory to either play from or record to. Bytes 4-7 of an
   381                              <1> ; entry describe various control things detailed below.
   382                              <1> ; 
   383                              <1> ; Buffer pointers must always be aligned on a Dword boundry.
   384                              <1> ;
   385                              <1> 
   386                              <1> IOC                     equ     BIT31   ; Fire an interrupt whenever this
   387                              <1>                                         ; buffer is complete.
   388                              <1> 
   389                              <1> BUP                     equ     BIT30   ; Buffer Underrun Policy.
   390                              <1>                                         ; if this buffer is the last buffer
   391                              <1>                                         ; in a playback, fill the remaining
   392                              <1>                                         ; samples with 0 (silence) or not.
   393                              <1>                                         ; It's a good idea to set this to 1
   394                              <1>                                         ; for the last buffer in playback,
   395                              <1>                                         ; otherwise you're likely to get a lot
   396                              <1>                                         ; of noise at the end of the sound.
   397                              <1> 
   398                              <1> ;
   399                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   400                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   401                              <1> ; Luckily for us, that's the same format as .wav files.
   402                              <1> ;
   403                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   404                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   405                              <1> ;
   406                              <1> ; A value of 0 in these bits means play no samples.
   407                              <1> ;
   408                              <1> 
   409                              <1> ; 11/11/2023
   410                              <1> CTRL_ST_CREADY		equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
   411                              <1> CODEC_REG_POWERDOWN	equ	26h
    24                                  
    25                                  _STARTUP:
    26                                  
    27                                  ; memory allocation
    28                                  
    29 00000000 E81D01                          call    setFree				; deallocate unused DOS mem
    30                                  
    31                                  	; 17/02/2017
    32                                  	; Clear BSS (uninitialized data) area
    33 00000003 31C0                    	xor	ax, ax ; 0
    34 00000005 B9156E                  	mov	cx, (EOF - bss_start)/2
    35 00000008 BF[381D]                	mov	di, bss_start
    36 0000000B F3AB                    	rep	stosw
    37                                  
    38                                  ; allocate 256 bytes of data for DCM_OUT Buffer Descriptor List. (BDL)
    39                                  
    40 0000000D B81000                          mov     ax, BDL_SIZE / 16
    41 00000010 E81501                          call    memAlloc
    42 00000013 A3[5C1D]                        mov     [BDL_BUFFER], ax		; segment 
    43                                  
    44                                  ; allocate 2 buffers, 64k each for now.
    45                                  
    46 00000016 B80010                          mov     ax, BUFFERSIZE / 16		; 64k for .WAV file
    47 00000019 E80C01                          call    memAlloc
    48 0000001C A3[5E1D]                        mov     [WAV_BUFFER1], ax		; segment
    49                                  
    50 0000001F B80010                  	mov	ax, BUFFERSIZE / 16
    51 00000022 E80301                  	call	memAlloc
    52 00000025 A3[601D]                	mov	[WAV_BUFFER2], ax
    53                                  
    54                                  ; Detect/reset AC97 
    55                                  
    56 00000028 E87002                          call    pciFindDevice
    57 0000002B 7342                            jnc     short _1
    58                                  
    59                                  ; couldn't find the audio device!
    60                                  
    61 0000002D 0E                      	push	cs
    62 0000002E 1F                      	pop	ds
    63 0000002F BA[3900]                        mov     dx, noDevMsg
    64 00000032 B409                            mov     ah, 9
    65 00000034 CD21                            int     21h
    66 00000036 E9D700                          jmp     exit
    67                                  
    68                                  ; 17/02/2017
    69 00000039 4572726F723A20556E-     noDevMsg db "Error: Unable to find intel ICH based audio device!",CR,LF,"$"
    69 00000042 61626C6520746F2066-
    69 0000004B 696E6420696E74656C-
    69 00000054 204943482062617365-
    69 0000005D 6420617564696F2064-
    69 00000066 6576696365210D0A24 
    70                                  
    71                                  _1:
    72                                  	; eax = BUS/DEV/FN
    73                                  	;	00000000BBBBBBBBDDDDDFFF00000000
    74                                  	; edx = DEV/VENDOR
    75                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
    76                                  
    77 0000006F 66A3[621D]              	mov	[bus_dev_fn], eax
    78 00000073 668916[661D]            	mov	[dev_vendor], edx
    79                                  
    80                                  	; get ICH base address regs for mixer and bus master
    81                                  
    82 00000078 B010                            mov     al, NAMBAR_REG
    83 0000007A E89001                          call    pciRegRead16			; read PCI registers 10-11
    84                                          ;and    dx, IO_ADDR_MASK 		; mask off BIT0
    85                                  	; 19/05/2024
    86 0000007D 80E2FE                  	and	dl, 0FEh
    87                                  
    88 00000080 8916[581D]                      mov     [NAMBAR], dx			; save audio mixer base addr
    89                                  
    90 00000084 B014                    	mov     al, NABMBAR_REG
    91 00000086 E88401                          call    pciRegRead16
    92                                          ;and    dx, IO_ADDR_MASK
    93                                  	; 19/05/2024
    94 00000089 80E2C0                  	and	dl, 0C0h
    95                                  
    96 0000008C 8916[5A1D]                      mov     [NABMBAR], dx			; save bus master base addr
    97                                  
    98                                  	; 06/11/2023
    99                                  	;; init controller
   100                                  	;; 17/02/2017
   101                                  	;mov	al, PCI_CMD_REG ; command register (04h)
   102                                  	;call	pciRegRead16 ; pciRegRead8
   103                                  	;
   104                                  	;; eax = BUS/DEV/FN/REG
   105                                  	;;  dx = PCI Command Register Content ; 17/02/2017
   106                                  	;; 	00000000CCCCCCCC
   107                                  	;mov	[stats_cmd], dx
   108                                  	;
   109                                  	; 06/11/2023
   110                                  	;mov	al, PCI_IO_BASE ; IO base address register (10h)
   111                                  	;call	pciRegRead32
   112                                  	;
   113                                  	;and	dx, 0FFC0h	; IO_ADDR_MASK (0FFFE) ?
   114                                          ;mov	[ac97_io_base], dx
   115                                  
   116 00000090 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
   117 00000092 E87001                  	call	pciRegRead8 ; 17/02/2017
   118                                  
   119 00000095 8816[571D]              	mov     [ac97_int_ln_reg], dl
   120                                  
   121                                  ; 05/11/2023
   122                                  %if 0
   123                                  	; 28/11/2016
   124                                  	mov	bx, 1
   125                                  	xor	dh, dh 	 ; 17/02/2017
   126                                  	mov	cx, dx
   127                                  	shl	bx, cl
   128                                  
   129                                  	; 04/11/2023
   130                                  	cli
   131                                  
   132                                  	;not	bx
   133                                  	in	al, 0A1h ; irq 8-15
   134                                          mov	ah, al
   135                                          in	al, 21h  ; irq 0-7 
   136                                  
   137                                  	; 04/11/2023
   138                                  	; save IRQ status
   139                                  	mov	[IRQ_status], ax
   140                                  
   141                                  	;and	ax, bx   ; unmask
   142                                   	btr	ax, dx	 ; unmask
   143                                  	out	21h, al  ; enable interrupt (if irq <= 7)
   144                                  	mov	al, ah
   145                                  	out	0A1h, al ; enable interrupt (if irq > 7)
   146                                  	;not	bx
   147                                  
   148                                  	; 04/11/2023
   149                                  	;mov	dx, 4D1h			;8259 ELCR1
   150                                          ;in	al, dx
   151                                  	;mov	ah, al
   152                                  	;mov	dx, 4D0h 
   153                                          ;in	al, dx
   154                                  	;;or	ax, bx        
   155                                  	;bts	ax, cx
   156                                  	;mov	dx, 4D0h
   157                                  	;out	dx, al                          ;set level-triggered mode
   158                                  	;mov	al, ah
   159                                  	;mov	dx, 4D1h
   160                                  	;out	dx, al                          ;set level-triggered mode
   161                                  
   162                                  	; 24/11/2016 - Erdogan Tan
   163                                  	mov	bx, cx
   164                                  	;mov	bx, dx
   165                                  	mov	bl, [bx+irq_int]
   166                                  	shl	bx, 2 ; * 4
   167                                  
   168                                  	; set up interrupt vector
   169                                  	; 30/11/2016
   170                                  	push	es
   171                                  	xor	ax, ax
   172                                  	mov	es, ax
   173                                  	; 04/11/2023
   174                                  	; save interrupt vector
   175                                  	mov	ax, [es:bx]
   176                                  	mov	[IRQ_vector], ax
   177                                  	mov	ax, [es:bx+2]
   178                                  	mov	[IRQ_vector+2], ax
   179                                  
   180                                  	mov	word [es:bx], ac97_int_handler
   181                                  	mov	ax, cs
   182                                  	mov	[es:bx+2], ax
   183                                  	pop	es
   184                                  
   185                                  	; 04/11/2023
   186                                  	sti
   187                                  
   188                                  %endif
   189 00000099 E8FA18                  	call	write_ac97_dev_info 
   190                                  
   191                                  ; check the command line for a file to play
   192                                  
   193                                          ;push	ds
   194 0000009C E89200                          call    processCmdline			; get the filename
   195                                  
   196                                  ; open the file
   197 0000009F B002                            mov     al, OPEN                        ; open existing file
   198 000000A1 E8AD00                          call    openFile                        ; no error? ok.
   199                                          ;pop	ds
   200 000000A4 7322                            jnc     short _gsr
   201                                  
   202                                  ; file not found!
   203                                  
   204                                          ;push   cs
   205                                          ;pop    ds
   206 000000A6 BA[AF00]                        mov	dx, noFileErrMsg
   207 000000A9 B409                            mov     ah, 9
   208 000000AB CD21                            int     21h
   209 000000AD EB61                            jmp     exit
   210                                  
   211                                  noFileErrMsg:
   212 000000AF 4572726F723A206669-     	db "Error: file not found.",CR,LF,"$"
   212 000000B8 6C65206E6F7420666F-
   212 000000C1 756E642E0D0A24     
   213                                  
   214                                  _gsr:
   215 000000C8 E8AD00                          call    getSampleRate                   ; read the sample rate
   216                                                                                  ; pass it onto codec.
   217 000000CB 7243                    	jc	short exit ; 19/11/2016 - nothing to do
   218                                  
   219 000000CD A3[6A1D]                	mov	[sample_rate], ax
   220                                  	
   221                                  	; 19/11/2016
   222 000000D0 880E[6C1D]              	mov	[stmo], cl
   223 000000D4 8816[6E1D]              	mov	[bps], dl
   224                                  	
   225                                  	; 17/02/2017
   226 000000D8 C606[701D]00            	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit 
   227 000000DD FEC9                    	dec	cl
   228 000000DF 7504                    	jnz	short _gsr_1 ; stereo
   229 000000E1 FE06[701D]              	inc	byte [fbs_shift] ; 1 = mono or 8 bit		
   230                                  _gsr_1:	
   231 000000E5 80FA08                  	cmp	dl, 8 
   232 000000E8 7704                    	ja	short _gsr_2 ; 16 bit samples
   233 000000EA FE06[701D]              	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   234                                  _gsr_2:	
   235 000000EE E8FB19                  	call	write_sample_rate
   236                                  
   237                                  	; 05/11/2023
   238                                  _2:
   239 000000F1 E83807                  	call	check4keyboardstop  ; flush keyboard buffer
   240 000000F4 72FB                    	jc	short _2 	; 07/11/2023
   241                                  
   242                                  	; 05/11/2023
   243                                  	;mov	eax, [bus_dev_fn]
   244                                  	;mov	al, PCI_CMD_REG
   245                                  	;call	pciRegRead16			; read PCI command register
   246                                  	; 17/02/2017
   247                                  	;mov	dx, [stats_cmd]
   248                                          ;or	dl, IO_ENA+BM_ENA               ; enable IO and bus master
   249                                  	;call	pciRegWrite16 ; pciRegWrite8
   250                                  
   251                                  	; 19/05/2024
   252                                  	; 06/11/2023
   253                                  	;mov	eax, [bus_dev_fn]
   254                                  	;mov	al, PCI_CMD_REG
   255                                  	;call	pciRegRead8			; read PCI command register
   256                                  	;or	dl, IO_ENA+BM_ENA		; enable IO and bus master
   257                                  	;call	pciRegWrite8
   258                                  
   259                                  ; setup the Codec (actually mixer registers) 
   260 000000F6 E8E401                          call    codecConfig                     ; unmute codec, set rates.
   261                                  	; 11/11/2023
   262 000000F9 721C                    	jc	short init_err
   263                                  ;
   264                                  ; position file pointer to start in actual wav data
   265                                  ; MUCH improvement should really be done here to check if sample size is
   266                                  ; supported, make sure there are 2 channels, etc.  
   267                                  ;
   268 000000FB B442                            mov     ah, 42h
   269 000000FD B000                            mov     al, 0                           ; from start of file
   270 000000FF 8B1E[541D]                      mov     bx, [filehandle]
   271 00000103 31C9                            xor     cx, cx
   272 00000105 BA2C00                          mov     dx, 44                          ; jump past .wav/riff header
   273 00000108 CD21                            int     21h
   274                                  
   275                                  ; play the .wav file. Most of the good stuff is in here.
   276                                  
   277 0000010A E88803                          call    playWav
   278                                  
   279                                  ; close the .wav file and exit.
   280                                  
   281                                  close_exit:			; 11/11/2023
   282 0000010D E85300                          call    closeFile
   283                                  
   284                                  exit:
   285 00000110 B8004C                          mov     ax, 4c00h
   286 00000113 CD21                    	int 	21h
   287                                  
   288                                  here:
   289 00000115 EBFE                    	jmp	short here
   290                                  
   291                                  	; 11/11/2023
   292                                  init_err:
   293 00000117 BA[CE1C]                	mov	dx, msg_init_err
   294                                  vra_err: ; 12/11/2023
   295 0000011A B409                            mov	ah, 9
   296 0000011C CD21                            int	21h
   297 0000011E EBED                    	jmp	short close_exit
   298                                  
   299                                  ; MEMALLOC.ASM
   300                                  ;-- SETFREE: Release memory not used  ----------------
   301                                  ;-- Input    : ES = address of PSP
   302                                  ;-- Output   : none
   303                                  ;-- Register : AX, BX, CL and FLAGS are changed 
   304                                  ;-- Info     : Since the stack-segment is always the last segment in an 
   305                                  ;              EXE-file, ES:0000 points to the beginning and SS:SP
   306                                  ;              to the end of the program in memory. Through this the
   307                                  ;              length of the program can be calculated 
   308                                  ; call this routine once at the beginning of the program to free up memory
   309                                  ; assigned to it by DOS.
   310                                  
   311                                  setFree:
   312 00000120 BB0010                  	  mov	bx, 65536/16	; 4K paragraphs ; 17/02/2017 (Erdogan Tan)		
   313                                  
   314 00000123 B44A                              mov	ah, 4ah		;pass new length to DOS
   315 00000125 CD21                              int	21h
   316                                  
   317 00000127 C3                                retn			; back to caller 
   318                                  				; new size (allocated memory) = 64KB
   319                                  
   320                                  memAlloc:
   321                                  ; input: AX = # of paragraphs required
   322                                  ; output: AX = segment of block to use
   323                                  
   324 00000128 53                      	push	bx
   325 00000129 89C3                    	mov	bx, ax
   326 0000012B B448                    	mov	ah, 48h
   327 0000012D CD21                    	int	21h
   328 0000012F 5B                      	pop	bx
   329 00000130 C3                      	retn
   330                                  
   331                                  ; CMDLINE.ASM
   332                                  ; parse the command line
   333                                  ; entry: none
   334                                  ; exit: DS:DX to the 1st supplied item on the command line 
   335                                  
   336                                  processCmdline:
   337 00000131 53                              push    bx
   338 00000132 56                              push    si
   339                                  
   340                                          ;mov    ah, 51h
   341                                          ;int    21h
   342                                          ;mov    ds, bx
   343                                  
   344 00000133 BE8000                          mov     si, 80h
   345 00000136 0FB61C                          movzx   bx, byte [si]
   346 00000139 01DE                            add     si, bx
   347 0000013B 46                              inc     si
   348                                  
   349 0000013C C60400                          mov     byte [si], NULL         ; zero terminate
   350                                  
   351 0000013F BE8100                          mov     si, 81h
   352                                  
   353                                  cmdlineloop:
   354 00000142 AC                              lodsb
   355                                  
   356 00000143 3C00                            cmp     al, NULL                ; found end of line?
   357 00000145 7404                            je      short exitpc
   358 00000147 3C20                            cmp     al, ' '                 ; found a space?
   359 00000149 74F7                            je      short cmdlineloop
   360                                  
   361                                          ; must be the filename here.
   362                                  exitpc:
   363 0000014B 4E                              dec     si                      ; point to start of filename
   364 0000014C 89F2                            mov     dx, si
   365 0000014E 5E                              pop     si
   366 0000014F 5B                              pop     bx
   367 00000150 C3                      	retn
   368                                  
   369                                  ; FILE.ASM
   370                                  ;open or create file
   371                                  ;
   372                                  ;input: ds:dx-->filename (asciiz)
   373                                  ;       al=file Mode (create or open)
   374                                  ;output: none  cs:[filehandle] filled
   375                                  ;
   376                                  openFile:
   377 00000151 50                      	push	ax
   378 00000152 51                      	push	cx
   379 00000153 B43B                    	mov	ah, 3bh			; start with a mode
   380 00000155 00C4                    	add	ah, al			; add in create or open mode
   381 00000157 31C9                    	xor	cx, cx
   382 00000159 CD21                    	int	21h
   383 0000015B 7203                    	jc	short _of1
   384                                  	;mov	[cs:filehandle], ax
   385 0000015D A3[541D]                	mov	[filehandle], ax
   386                                  _of1:
   387 00000160 59                      	pop	cx
   388 00000161 58                      	pop	ax
   389 00000162 C3                      	retn
   390                                  
   391                                  ; close the currently open file
   392                                  ; input: none, uses cs:[filehandle]
   393                                  closeFile:
   394 00000163 50                      	push	ax
   395 00000164 53                      	push	bx
   396 00000165 833E[541D]FF            	cmp	word [filehandle], -1
   397 0000016A 7409                    	jz	short _cf1
   398 0000016C 8B1E[541D]              	mov     bx, [filehandle]  
   399 00000170 B8003E                  	mov     ax,3e00h
   400 00000173 CD21                            int     21h              ;close file
   401                                  _cf1:
   402 00000175 5B                      	pop	bx
   403 00000176 58                      	pop	ax
   404 00000177 C3                      	retn
   405                                  
   406                                  getSampleRate:
   407                                  	; 08/12/2016
   408                                  ; reads the sample rate from the .wav file.
   409                                  ; entry: none - assumes file is already open
   410                                  	; 19/11/2016 - Erdogan Tan
   411                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   412                                  ;	cx = number of channels (mono=1, stereo=2)
   413                                  ;	dx = bits per sample (8, 16)
   414                                  
   415 00000178 53                      	push    bx
   416                                  
   417 00000179 B442                            mov     ah, 42h
   418 0000017B B000                            mov     al, 0				; from start of file
   419 0000017D 8B1E[541D]                      mov     bx, [filehandle]
   420 00000181 31C9                            xor     cx, cx
   421 00000183 BA0800                          mov     dx, 08h				; "WAVE"
   422 00000186 CD21                            int     21h
   423                                  
   424 00000188 BA[381D]                        mov     dx, smpRBuff
   425 0000018B B91C00                          mov     cx, 28				; 28 bytes
   426 0000018E B43F                    	mov	ah, 3fh
   427 00000190 CD21                            int     21h
   428                                  
   429 00000192 813E[381D]5741          	cmp	word [smpRBuff], 'WA'
   430 00000198 751C                    	jne	short gsr_stc
   431                                  
   432 0000019A 813E[3A1D]5645          	cmp	word [smpRBuff+2], 'VE'
   433 000001A0 7514                    	jne	short gsr_stc
   434                                  
   435 000001A2 833E[441D]01            	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   436 000001A7 750D                    	jne	short gsr_stc
   437                                  
   438                                  
   439 000001A9 8B0E[461D]              	mov	cx, [smpRBuff+14]	; return num of channels in CX
   440 000001AD A1[481D]                        mov     ax, [smpRBuff+16]	; return sample rate in AX
   441 000001B0 8B16[521D]              	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   442                                  gsr_retn:
   443 000001B4 5B                              pop     bx
   444 000001B5 C3                              retn
   445                                  
   446                                  gsr_stc:
   447 000001B6 F9                      	stc
   448 000001B7 EBFB                    	jmp	short gsr_retn
   449                                  
   450                                  ;%include 'ac97.asm' ; 29/11/2016 (AC97 codec configuration)
   451                                  %include 'ac97_vra.asm' ; 19/11/2023 (AC97 codec configuration)
     1                              <1> ; 19/05/2024
     2                              <1> ; 19/11/2023 
     3                              <1> ;	(ready status optimization -in order to prevent wrong init error- )
     4                              <1> ; 18/11/2023
     5                              <1> ; 15/11/2023
     6                              <1> ; 13/11/2023
     7                              <1> ; 12/11/2023
     8                              <1> ; 11/11/2023
     9                              <1> ; 03/11/2023 - 06/11/2023
    10                              <1> ; PCI and AC97 codec functions for wav player
    11                              <1> ; Erdogan Tan (17/02/2017)
    12                              <1> 
    13                              <1> ; ----------------------------------------------------------------------------
    14                              <1> ; PCI.ASM
    15                              <1> ; ----------------------------------------------------------------------------
    16                              <1> 
    17                              <1> ; PCI device register reader/writers.
    18                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    19                              <1> ; 		Last Update: 17/02/2017
    20                              <1> 
    21                              <1> ;===============================================================
    22                              <1> ; 8/16/32bit PCI reader
    23                              <1> ;
    24                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    25                              <1> ;           BIT30 set if 32 bit access requested
    26                              <1> ;           BIT29 set if 16 bit access requested
    27                              <1> ;           otherwise defaults to 8 bit read
    28                              <1> ;
    29                              <1> ; Exit:  DL,DX,EDX register data depending on requested read size
    30                              <1> ;
    31                              <1> ; Note: this routine is meant to be called via pciRegRead8, pciRegread16,
    32                              <1> ;	or pciRegRead32, listed below.
    33                              <1> ;
    34                              <1> ; Note2: don't attempt to read 32bits of data from a non dword aligned reg
    35                              <1> ;	 number. Likewise, don't do 16bit reads from non word aligned reg #
    36                              <1> ; 
    37                              <1> pciRegRead:
    38 000001B9 6653                <1> 	push	ebx
    39 000001BB 51                  <1> 	push	cx
    40 000001BC 6689C3              <1>         mov     ebx, eax                        ; save eax, dh
    41 000001BF 88F1                <1>         mov     cl, dh
    42 000001C1 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    43 000001C7 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
    44 000001CD 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
    45                              <1> 
    46 000001CF BAF80C              <1>         mov     dx, PCI_INDEX_PORT
    47 000001D2 66EF                <1>         out     dx, eax                         ; write PCI selector
    48                              <1> 
    49 000001D4 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
    50 000001D7 88D8                <1>         mov     al, bl
    51 000001D9 2403                <1>         and     al, 3                           ; figure out which port to
    52 000001DB 00C2                <1>         add     dl, al                          ; read to
    53                              <1> 
    54 000001DD 66ED                <1> 	in      eax, dx                         ; do 32bit read
    55 000001DF 66F7C300000080      <1>         test    ebx, PCI32
    56 000001E6 7403                <1>         jz      short _pregr1
    57                              <1> 
    58 000001E8 6689C2              <1>         mov     edx, eax                        ; return 32bits of data
    59                              <1> _pregr1:
    60 000001EB 89C2                <1> 	mov     dx, ax                          ; return 16bits of data
    61 000001ED 66F7C3000000C0      <1>         test    ebx, PCI32+PCI16
    62 000001F4 7502                <1>         jnz     short _pregr2
    63 000001F6 88CE                <1>         mov     dh, cl                          ; restore dh for 8 bit read
    64                              <1> _pregr2:
    65 000001F8 6689D8              <1>         mov     eax, ebx                        ; restore eax
    66 000001FB 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    67 00000201 59                  <1> 	pop	cx
    68 00000202 665B                <1> 	pop	ebx
    69 00000204 C3                  <1> 	retn
    70                              <1> 
    71                              <1> pciRegRead8:
    72 00000205 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32             ; set up 8 bit read size
    73 0000020B EBAC                <1>         jmp     short pciRegRead		; call generic PCI access
    74                              <1> 
    75                              <1> pciRegRead16:
    76 0000020D 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit read size
    77 00000213 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
    78 00000219 EB9E                <1>         jmp     short pciRegRead
    79                              <1> 
    80                              <1> pciRegRead32:
    81 0000021B 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit read size
    82 00000221 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
    83 00000227 EB90                <1>         jmp     short pciRegRead
    84                              <1> 
    85                              <1> ;===============================================================
    86                              <1> ; 8/16/32bit PCI writer
    87                              <1> ;
    88                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    89                              <1> ;           BIT31 set if 32 bit access requested
    90                              <1> ;           BIT30 set if 16 bit access requested
    91                              <1> ;           otherwise defaults to 8bit read
    92                              <1> ;        DL/DX/EDX data to write depending on size
    93                              <1> ;
    94                              <1> ;
    95                              <1> ; note: this routine is meant to be called via pciRegWrite8, pciRegWrite16,
    96                              <1> ; 	or pciRegWrite32 as detailed below.
    97                              <1> ;
    98                              <1> ; Note2: don't attempt to write 32bits of data from a non dword aligned reg
    99                              <1> ;	 number. Likewise, don't do 16bit writes from non word aligned reg #
   100                              <1> ;
   101                              <1> pciRegWrite:
   102 00000229 6653                <1> 	push	ebx
   103 0000022B 51                  <1> 	push	cx
   104 0000022C 6689C3              <1>         mov     ebx, eax                        ; save eax, dx
   105 0000022F 89D1                <1>         mov     cx, dx
   106 00000231 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
   107 00000237 6625FFFFFFBF        <1>         and     eax, ~PCI16 ; NOT PCI16         ; clear out data size request
   108 0000023D 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
   109                              <1> 
   110 0000023F BAF80C              <1>         mov     dx, PCI_INDEX_PORT
   111 00000242 66EF                <1>         out     dx, eax                         ; write PCI selector
   112                              <1> 
   113 00000244 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
   114 00000247 88D8                <1>         mov     al, bl
   115 00000249 2403                <1>         and     al, 3                           ; figure out which port to
   116 0000024B 00C2                <1>         add     dl, al                          ; write to
   117                              <1> 
   118 0000024D 6689D0              <1>         mov     eax, edx                        ; put data into eax
   119 00000250 89C8                <1>         mov     ax, cx
   120                              <1> 
   121 00000252 EE                  <1>         out     dx, al
   122 00000253 66F7C3000000C0      <1>         test    ebx, PCI16+PCI32                ; only 8bit access? bail
   123 0000025A 740C                <1>         jz      short _pregw1
   124                              <1> 
   125 0000025C EF                  <1>         out     dx, ax                          ; write 16 bit value
   126 0000025D 66F7C300000040      <1>         test    ebx, PCI16                      ; 16bit requested?  bail
   127 00000264 7502                <1>         jnz     short _pregw1
   128                              <1> 
   129 00000266 66EF                <1>         out     dx, eax                         ; write full 32bit
   130                              <1> _pregw1:
   131 00000268 6689D8              <1>         mov     eax, ebx                        ; restore eax
   132 0000026B 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
   133 00000271 89CA                <1>         mov     dx, cx                          ; restore dx
   134 00000273 59                  <1> 	pop	cx
   135 00000274 665B                <1> 	pop	ebx
   136 00000276 C3                  <1> 	ret
   137                              <1> 
   138                              <1> pciRegWrite8:
   139 00000277 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 8 bit write size
   140 0000027D EBAA                <1>         jmp     short pciRegWrite		; call generic PCI access
   141                              <1> 
   142                              <1> pciRegWrite16:
   143 0000027F 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit write size
   144 00000285 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
   145 0000028B EB9C                <1>         jmp     short pciRegWrite
   146                              <1> 
   147                              <1> pciRegWrite32:
   148 0000028D 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit write size
   149 00000293 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
   150 00000299 EB8E                <1>         jmp     short pciRegWrite
   151                              <1> 
   152                              <1> ; 17/02/2017 (Modifed by Erdogan Tan for various ICH device IDs)
   153                              <1> ;===============================================================
   154                              <1> ; PCIFindDevice: scan through PCI space looking for a device+vendor ID
   155                              <1> ;
   156                              <1> ;  ENTRY: none
   157                              <1> ;; Entry: EAX=Device+Vendor ID
   158                              <1> ;
   159                              <1> ;  Exit: EAX=PCI address if device found
   160                              <1> ;	 EDX=Device+Vendor ID
   161                              <1> ;        CY clear if found, set if not found. EAX invalid if CY set.
   162                              <1> ;
   163                              <1> ; [old stackless] Destroys: ebx, esi, edi, cl
   164                              <1> ;
   165                              <1> pciFindDevice:
   166                              <1> 	;push	cx
   167                              <1> 	;push	eax ; *
   168                              <1> 	;push	esi
   169                              <1> 	;push	edi
   170                              <1> 
   171                              <1>  	;mov     esi, eax                ; save off vend+device ID
   172                              <1> 
   173                              <1> 	; 17/02/2017
   174 0000029B BE[931B]            <1> 	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
   175 0000029E B91500              <1> 	mov	cx, valid_id_count
   176                              <1> pfd_0:
   177 000002A1 66BF00FFFF7F        <1>        	mov     edi, (80000000h - 100h) ; start with bus 0, dev 0 func 0
   178                              <1> nextPCIdevice:
   179 000002A7 6681C700010000      <1>         add     edi, 100h
   180 000002AE 6681FF00F8FF80      <1>         cmp     edi, 80FFF800h		; scanned all devices?
   181                              <1>         ;stc
   182                              <1>         ;je 	short PCIScanExit       ; not found
   183 000002B5 720D                <1> 	jb	short pfd_1
   184 000002B7 66BF00000080        <1> 	mov     edi, 80000000h
   185 000002BD 83C604              <1> 	add	si, 4 ; scan for next device ID
   186 000002C0 E202                <1> 	loop	pfd_1	 
   187 000002C2 F9                  <1> 	stc	
   188                              <1> 	;jmp 	short PCIScanExit
   189 000002C3 C3                  <1> 	retn
   190                              <1> pfd_1:
   191 000002C4 6689F8              <1>         mov     eax, edi                ; read PCI registers
   192 000002C7 E851FF              <1>         call    pciRegRead32
   193                              <1>         ;cmp    edx, esi                ; found device?
   194 000002CA 663B14              <1>         cmp	edx, dword [si]
   195 000002CD 75D8                <1> 	jne     short nextPCIdevice
   196                              <1>         ;clc
   197                              <1> PCIScanExit:
   198                              <1> 	;pushf
   199 000002CF 66B800000080        <1> 	mov	eax, BIT31
   200 000002D5 66F7D0              <1> 	not	eax
   201 000002D8 6621F8              <1> 	and	eax, edi		; return only bus/dev/fn #
   202                              <1> 	;popf
   203                              <1> 
   204                              <1> 	;pop	edi
   205                              <1> 	;pop	esi
   206                              <1> 	;pop	edx ; *
   207                              <1> 	;pop	cx
   208 000002DB C3                  <1> 	retn
   209                              <1> 
   210                              <1> ; ----------------------------------------------------------------------------
   211                              <1> ; CODEC.ASM
   212                              <1> ; ----------------------------------------------------------------------------
   213                              <1> 
   214                              <1> ; codec configuration code. Not much here really.
   215                              <1> ; NASM version: Erdogan Tan (29/11/2016)
   216                              <1> 
   217                              <1> ; enable codec, unmute stuff, set output rate to 44.1
   218                              <1> ; entry: ax = desired sample rate
   219                              <1> 
   220                              <1> ; 19/05/2024
   221                              <1> ; 19/11/2023
   222                              <1> ; 11/11/2023
   223                              <1> ; 06/11/2023
   224                              <1> %if 1
   225                              <1> 
   226                              <1> ;	; 11/11/2023
   227                              <1> ;init_ac97_codec_err1:
   228                              <1> ;	stc
   229                              <1> ;init_ac97_codec_err2:
   230                              <1> ;	retn
   231                              <1> 
   232                              <1> 	; 13/11/2023
   233 000002DC 01                  <1> VRA:	db 1	
   234                              <1> 
   235                              <1> codecConfig:
   236                              <1> 	; 19/05/2024
   237                              <1> 	; 19/11/2023
   238                              <1> 	; 15/11/2023
   239                              <1> 	; 04/11/2023
   240                              <1> 	; 17/02/2017 
   241                              <1> 	; 07/11/2016 (Erdogan Tan)
   242                              <1> 	;PORT_NABM_GLB_CTRL_STAT equ 60h
   243                              <1> 
   244                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   245                              <1>  	; 'AC97_DEF.H'
   246                              <1> 	;AC97_EXTENDED_STATUS equ 002Ah
   247                              <1> 	AC97_EA_SPDIF	equ 0002h
   248                              <1> 	AC97_EA_VRA	equ 0001h
   249                              <1> 	; 04/11/2023
   250                              <1> 	ICH_PO_CR_RESET equ 0002h  ; reset codec
   251                              <1> 	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
   252                              <1> 	ICH_PCM_246_MASK equ 300000h ; 6 channels
   253                              <1> 
   254                              <1> 	; 04/11/2023
   255                              <1> init_ac97_controller:
   256 000002DD 66A1[621D]          <1> 	mov	eax, [bus_dev_fn]
   257 000002E1 B004                <1> 	mov	al, PCI_CMD_REG
   258 000002E3 E827FF              <1> 	call	pciRegRead16		; read PCI command register
   259 000002E6 80CA05              <1> 	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
   260 000002E9 E893FF              <1> 	call	pciRegWrite16
   261                              <1> 
   262 000002EC E89B01              <1> 	call	delay_100ms
   263                              <1> 
   264                              <1> 	; 19/05/2024
   265                              <1> 	; ('PLAYMOD3.ASM', Erdogan Tan, 18/05/2024)
   266                              <1> 
   267                              <1> init_ac97_codec:
   268                              <1> 	; 18/11/2023
   269 000002EF BD2800              <1> 	mov	bp, 40
   270                              <1> _initc_1:
   271                              <1> 	; 11/11/2023
   272                              <1> 	; (TRDOS 386 v2.0.5, 'audio.s')
   273 000002F2 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   274 000002F5 0316[5A1D]          <1> 	add	dx, [NABMBAR]
   275 000002F9 66ED                <1> 	in	eax, dx
   276                              <1> 
   277                              <1> 	; 19/05/2024
   278 000002FB E87816              <1> 	call	delay1_4ms
   279                              <1> 
   280                              <1> 	; ?
   281 000002FE BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   282 00000301 0316[5A1D]          <1> 	add	dx, [NABMBAR]
   283 00000305 66ED                <1> 	in	eax, dx
   284                              <1> 
   285                              <1> 	; 19/05/2024
   286 00000307 E86C16              <1> 	call	delay1_4ms
   287                              <1> 
   288 0000030A 6683F8FF            <1> 	cmp	eax, 0FFFFFFFFh ; -1
   289 0000030E 7508                <1> 	jne	short _initc_3
   290                              <1> _initc_2:
   291                              <1> 	;dec	cx
   292 00000310 4D                  <1> 	dec	bp	; 18/11/2023
   293                              <1> 	;jz	short init_ac97_codec_err1
   294                              <1> 	; 19/11/2023
   295 00000311 7412                <1> 	jz	short _ac97_codec_ready
   296                              <1> 
   297 00000313 E87401              <1> 	call	delay_100ms
   298 00000316 EBDA                <1> 	jmp	short _initc_1
   299                              <1> _initc_3:
   300 00000318 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   301 0000031E 7505                <1> 	jnz	short _ac97_codec_ready
   302                              <1> 
   303 00000320 E8E700              <1> 	call	reset_ac97_codec
   304                              <1> 	; 15/11/2023
   305                              <1> 	;jc	short _initc_2
   306                              <1> 	; 19/05/2024
   307 00000323 EBEB                <1> 	jmp	short _initc_2
   308                              <1> 
   309                              <1> _ac97_codec_ready:
   310 00000325 8B16[581D]          <1> 	mov	dx, [NAMBAR]
   311                              <1> 	;add	dx, 0 ; ac_reg_0 ; reset register
   312 00000329 EF                  <1> 	out	dx, ax
   313                              <1> 
   314 0000032A E85D01              <1> 	call	delay_100ms
   315                              <1> 
   316                              <1> 	; 19/11/2023
   317 0000032D 09ED                <1> 	or	bp, bp
   318 0000032F 7522                <1> 	jnz	short _ac97_codec_init_ok
   319                              <1> 
   320 00000331 6631C0              <1> 	xor	eax, eax ; 0
   321 00000334 8B16[581D]          <1> 	mov	dx, [NAMBAR]
   322 00000338 83C226              <1> 	add	dx, CODEC_REG_POWERDOWN
   323 0000033B EF                  <1> 	out	dx, ax
   324                              <1> 	
   325                              <1> 	; 19/11/2023
   326                              <1> 	; wait for 1 second
   327                              <1> 	; 19/05/2024
   328 0000033C 66B9E8030000        <1> 	mov	ecx, 1000 ; 1000*4*0.25ms = 1s
   329                              <1> 	;mov	cx, 10
   330                              <1> _ac97_codec_rloop:
   331                              <1> 	;call	delay1_4ms
   332                              <1> 	;call	delay1_4ms
   333                              <1> 	;call	delay1_4ms
   334                              <1> 	;call	delay1_4ms
   335 00000342 E84501              <1> 	call	delay_100ms
   336                              <1> 
   337                              <1> 	;mov	dx, [NAMBAR]
   338                              <1> 	;add	dx, CODEC_REG_POWERDOWN
   339 00000345 ED                  <1> 	in	ax, dx
   340                              <1> 
   341 00000346 E82D16              <1> 	call	delay1_4ms
   342                              <1> 	
   343 00000349 83E00F              <1> 	and	ax, 0Fh
   344 0000034C 3C0F                <1> 	cmp	al, 0Fh
   345 0000034E 7403                <1> 	je	short _ac97_codec_init_ok
   346 00000350 E2F0                <1> 	loop	_ac97_codec_rloop 
   347                              <1> 
   348                              <1> init_ac97_codec_err1:
   349                              <1> 	;stc	; cf = 1 ; 19/05/2024
   350                              <1> init_ac97_codec_err2:
   351 00000352 C3                  <1> 	retn
   352                              <1> 
   353                              <1> _ac97_codec_init_ok:
   354                              <1>         ; 11/11/2023
   355                              <1> 	;mov	al, 2 ; force set 16-bit 2-channel PCM
   356                              <1> 	;mov	dx, GLOB_CNT_REG ; 2Ch
   357                              <1> 	;add	dx, [NABMBAR]
   358                              <1> 	;out	dx, eax
   359                              <1> 
   360                              <1> 	;;call	delay1_4ms
   361                              <1> 
   362 00000353 E86D00              <1> 	call 	reset_ac97_controller
   363                              <1> 
   364                              <1> 	; 11/11/2023
   365                              <1> 	;call	delay1_4ms
   366                              <1> 	; 19/05/2024
   367 00000356 E83101              <1> 	call	delay_100ms
   368                              <1> 
   369                              <1> 	;call 	setup_ac97_codec
   370                              <1> 
   371                              <1> setup_ac97_codec:
   372                              <1> 	; 12/11/2023
   373 00000359 813E[6A1D]80BB      <1> 	cmp	word [sample_rate], 48000
   374 0000035F 7435                <1> 	je	short skip_rate
   375                              <1> 
   376                              <1> ; 11/11/2023
   377                              <1> ; 05/11/2023
   378                              <1> ;%if 1
   379                              <1> 	AC97_EA_VRA equ BIT0 ; 11/11/2023
   380                              <1> 
   381                              <1> 	; 19/05/2024
   382 00000361 E81216              <1> 	call	delay1_4ms
   383                              <1> 
   384                              <1> 	;; 19/05/2024
   385                              <1> 	;;mov	dx, [NAMBAR]
   386                              <1> 	;;add	dx, CODEC_EXT_AUDIO_REG	; 28h
   387                              <1> 	;;in	ax, dx
   388                              <1> 	;
   389                              <1> 	;; 19/05/2024
   390                              <1> 	;;test	al, 1 ; BIT0 ; Variable Rate Audio bit
   391                              <1> 	;;jz	short vra_not_supported
   392                              <1> 	;
   393                              <1> 	;; 19/05/2024
   394                              <1> 	;;call	delay1_4ms
   395                              <1> 
   396                              <1> 	; 11/11/2023
   397 00000364 8B16[581D]          <1> 	mov    	dx, [NAMBAR]
   398 00000368 83C22A              <1> 	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
   399 0000036B ED                  <1> 	in     	ax, dx
   400                              <1> 
   401                              <1> 	; 19/05/2024
   402 0000036C E80716              <1> 	call	delay1_4ms
   403                              <1> 	
   404 0000036F 24FD                <1> 	and	al, ~BIT1 ; Clear DRA
   405 00000371 0C01                <1> 	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
   406 00000373 EF                  <1> 	out	dx, ax			; Enable variable rate audio
   407                              <1> 	
   408 00000374 B90A00              <1> 	mov	cx, 10
   409                              <1> check_vra:
   410 00000377 E81001              <1> 	call	delay_100ms
   411                              <1> 
   412                              <1> 	; 11/11/2023
   413 0000037A ED                  <1> 	in	ax, dx
   414 0000037B A801                <1> 	test	al, AC97_EA_VRA ; 1
   415 0000037D 7509                <1> 	jnz	short set_rate
   416                              <1> 
   417                              <1> 	; 11/11/2023
   418 0000037F E2F6                <1> 	loop	check_vra
   419                              <1> 
   420                              <1> ;vra_not_supported:	; 19/05/2024
   421                              <1> 	; 13/11/2023
   422 00000381 C606[DC02]00        <1> 	mov	byte [VRA], 0
   423 00000386 EB0E                <1> 	jmp	short skip_rate	
   424                              <1> 
   425                              <1> 	; 19/05/2024
   426                              <1> ;;vra_not_supported:
   427                              <1> 	; 12/11/2023
   428                              <1> 	;pop	ax ; discard return address to the caller
   429                              <1> 	;mov	dx, msg_no_vra
   430                              <1> 	;jmp	vra_err
   431                              <1> 
   432                              <1> set_rate:
   433 00000388 A1[6A1D]            <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   434                              <1> 
   435 0000038B 8B16[581D]          <1> 	mov    	dx, [NAMBAR]               	
   436 0000038F 83C22C              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   437 00000392 EF                  <1> 	out	dx, ax 			; PCM Front/Center Output Sample Rate
   438                              <1> 
   439 00000393 E8F400              <1> 	call	delay_100ms
   440                              <1> 
   441                              <1> 	; 12/11/2023
   442                              <1> skip_rate:
   443                              <1> 	; 11/11/2023 (temporary)
   444                              <1> 
   445                              <1> 	;mov   	dx, [NAMBAR]               	
   446                              <1> 	;add   	dx, CODEC_PCM_SURND_DACRATE_REG	; 2Eh  	  
   447                              <1> 	;out	dx, ax 			; PCM Surround Output Sample Rate
   448                              <1> 
   449                              <1> 	;call	delay_100ms
   450                              <1> 
   451                              <1> 	;mov   	dx, [NAMBAR]               	
   452                              <1> 	;add   	dx, CODEC_PCM_LFE_DACRATE_REG	; 30h  	  
   453                              <1> 	;out	dx, ax 			; PCM LFE Output Sample Rate
   454                              <1> 
   455                              <1> 	;call	delay_100ms
   456                              <1> 
   457                              <1> 	; 05/11/2023 (temporary)
   458                              <1> 	;mov	dx, [NAMBAR]               	
   459                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   460                              <1> 	;out	dx, ax 			; PCM Input Sample Rate
   461                              <1> 	;
   462                              <1> 	;call	delay_100ms
   463                              <1> 
   464 00000396 B80202              <1> 	mov	ax, 0202h
   465 00000399 8B16[581D]          <1>   	mov     dx, [NAMBAR]
   466 0000039D 83C202              <1>   	add     dx, CODEC_MASTER_VOL_REG	;02h 
   467 000003A0 EF                  <1> 	out     dx, ax
   468                              <1> 
   469                              <1> 	; 11/11/2023
   470                              <1>         ;call	delay1_4ms
   471                              <1>         ;call	delay1_4ms
   472                              <1>         ;call	delay1_4ms
   473                              <1>         ;call	delay1_4ms
   474                              <1>  	;
   475                              <1>   	;mov	dx, [NAMBAR]
   476                              <1>   	;add	dx, CODEC_MASTER_MONO_VOL_REG	;06h 
   477                              <1>   	;out	dx, ax
   478                              <1> 
   479                              <1> 	; 11/11/2023
   480                              <1>         ;call	delay1_4ms
   481                              <1>         ;call	delay1_4ms
   482                              <1>         ;call	delay1_4ms
   483                              <1>         ;call	delay1_4ms
   484                              <1> 	;
   485                              <1> 	;mov	ax, 02h
   486                              <1>   	;mov	dx, [NAMBAR]
   487                              <1>   	;add	dx, CODEC_PCBEEP_VOL_REG	;0Ah 
   488                              <1>   	;out	dx, ax
   489                              <1> 
   490 000003A1 E8D215              <1>         call    delay1_4ms
   491 000003A4 E8CF15              <1>         call    delay1_4ms
   492 000003A7 E8CC15              <1>         call    delay1_4ms
   493 000003AA E8C915              <1>         call    delay1_4ms
   494                              <1> 
   495                              <1> 	;mov	ax, 0202h
   496 000003AD 8B16[581D]          <1>   	mov     dx, [NAMBAR]
   497 000003B1 83C218              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h 
   498 000003B4 EF                  <1>   	out     dx, ax
   499                              <1> 
   500 000003B5 E8BE15              <1>         call    delay1_4ms
   501 000003B8 E8BB15              <1>         call    delay1_4ms
   502 000003BB E8B815              <1>         call    delay1_4ms
   503 000003BE E8B515              <1>         call    delay1_4ms
   504                              <1> 
   505                              <1> 	; 11/11/2023
   506                              <1> 	;mov	ax, 8008h ; Mute
   507                              <1>   	;mov	dx, [NAMBAR]
   508                              <1> 	;add	dx, CODEC_PHONE_VOL_REG		;0Ch
   509                              <1> 	;			 ; AC97_PHONE_VOL ; TAD Input (Mono)
   510                              <1>   	;out	dx, ax
   511                              <1> 	;
   512                              <1>         ;call	delay1_4ms
   513                              <1>         ;call	delay1_4ms
   514                              <1>         ;call	delay1_4ms
   515                              <1> 	;call	delay1_4ms
   516                              <1> 
   517                              <1> 	;mov	ax, 0808h
   518                              <1> 	;mov	dx, [NAMBAR]
   519                              <1> 	;add	dx, CODEC_LINE_IN_VOL_REG ;10h ; Line Input (Stereo)
   520                              <1> 	;out	dx, ax
   521                              <1> 	;
   522                              <1>         ;call	delay1_4ms
   523                              <1>         ;call	delay1_4ms
   524                              <1>         ;call	delay1_4ms
   525                              <1> 	;call	delay1_4ms
   526                              <1> 
   527                              <1>   	;mov	dx, [NAMBAR]
   528                              <1>         ;add	dx, CODEC_CD_VOL_REG ;12h ; CD Input (Stereo)
   529                              <1>   	;out	dx, ax
   530                              <1> 	;
   531                              <1>   	;mov	dx, [NAMBAR]
   532                              <1>         ;add	dx, CODEC_AUX_VOL_REG ;16h ; Aux Input (Stereo)
   533                              <1>   	;out	dx, ax
   534                              <1> 	;
   535                              <1>         ;call	delay1_4ms
   536                              <1>         ;call	delay1_4ms
   537                              <1>         ;call	delay1_4ms
   538                              <1> 	;call	delay1_4ms
   539                              <1> 
   540                              <1> 	; 19/05/2024
   541 000003C1 F8                  <1> 	clc
   542                              <1> 
   543                              <1> ;detect_ac97_codec:
   544 000003C2 C3                  <1>         retn
   545                              <1> 
   546                              <1> reset_ac97_controller:
   547                              <1> 	; 19/05/2024
   548                              <1> 	; 11/11/2023
   549                              <1> 	; 10/06/2017
   550                              <1> 	; 29/05/2017
   551                              <1> 	; 28/05/2017
   552                              <1> 	; reset AC97 audio controller registers
   553 000003C3 31C0                <1> 	xor     ax, ax
   554 000003C5 BA0B00              <1>         mov	dx, PI_CR_REG
   555 000003C8 0316[5A1D]          <1> 	add	dx, [NABMBAR]
   556 000003CC EE                  <1> 	out     dx, al
   557                              <1> 
   558                              <1> 	; 19/05/2024
   559 000003CD E8A615              <1> 	call	delay1_4ms
   560                              <1> 
   561 000003D0 BA1B00              <1>         mov     dx, PO_CR_REG
   562 000003D3 0316[5A1D]          <1> 	add	dx, [NABMBAR]
   563 000003D7 EE                  <1> 	out     dx, al
   564                              <1> 
   565                              <1> 	; 19/05/2024
   566 000003D8 E89B15              <1> 	call	delay1_4ms
   567                              <1> 
   568 000003DB BA2B00              <1>         mov     dx, MC_CR_REG
   569 000003DE 0316[5A1D]          <1> 	add	dx, [NABMBAR]
   570 000003E2 EE                  <1> 	out     dx, al
   571                              <1> 
   572                              <1> 	; 19/05/2024
   573 000003E3 E89015              <1> 	call	delay1_4ms
   574                              <1> 
   575 000003E6 B002                <1>         mov     al, RR
   576 000003E8 BA0B00              <1>         mov     dx, PI_CR_REG
   577 000003EB 0316[5A1D]          <1> 	add	dx, [NABMBAR]
   578 000003EF EE                  <1> 	out     dx, al
   579                              <1> 
   580                              <1> 	; 19/05/2024
   581 000003F0 E88315              <1> 	call	delay1_4ms
   582                              <1> 
   583 000003F3 BA1B00              <1>         mov     dx, PO_CR_REG
   584 000003F6 0316[5A1D]          <1> 	add	dx, [NABMBAR]
   585 000003FA EE                  <1> 	out     dx, al
   586                              <1> 
   587                              <1> 	; 19/05/2024
   588 000003FB E87815              <1> 	call	delay1_4ms
   589                              <1> 
   590 000003FE BA2B00              <1>         mov     dx, MC_CR_REG
   591 00000401 0316[5A1D]          <1> 	add	dx, [NABMBAR]
   592 00000405 EE                  <1> 	out     dx, al
   593                              <1> 
   594                              <1> 	; 19/05/2024
   595 00000406 E86D15              <1> 	call	delay1_4ms
   596                              <1> 
   597 00000409 C3                  <1> 	retn
   598                              <1> 
   599                              <1> reset_ac97_codec:
   600                              <1> 	; 11/11/2023
   601                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   602 0000040A BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   603 0000040D 0316[5A1D]          <1> 	add	dx, [NABMBAR]
   604 00000411 66ED                <1> 	in	eax, dx
   605                              <1> 
   606                              <1> 	;test	eax, 2
   607                              <1> 	; 06/08/2022
   608 00000413 A802                <1> 	test	al, 2
   609 00000415 7405                <1> 	jz	short _r_ac97codec_cold	
   610                              <1> 
   611 00000417 E80E00              <1> 	call	warm_ac97codec_reset
   612 0000041A 7306                <1> 	jnc	short _r_ac97codec_ok
   613                              <1> _r_ac97codec_cold:
   614 0000041C E83400              <1>         call    cold_ac97codec_reset
   615 0000041F 7301                <1>         jnc     short _r_ac97codec_ok
   616                              <1> 	
   617                              <1> 	; 16/04/2017
   618                              <1>         ;xor	eax, eax	; timeout error
   619                              <1>        	;stc
   620 00000421 C3                  <1> 	retn
   621                              <1> 
   622                              <1> _r_ac97codec_ok:
   623 00000422 6631C0              <1>         xor     eax, eax
   624                              <1>         ;mov	al, VIA_ACLINK_C00_READY ; 1
   625 00000425 FEC0                <1>         inc	al
   626 00000427 C3                  <1> 	retn
   627                              <1> 
   628                              <1> warm_ac97codec_reset:
   629                              <1> 	; 11/11/2023
   630                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   631                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   632 00000428 66B806000000        <1> 	mov	eax, 6
   633 0000042E BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   634 00000431 0316[5A1D]          <1> 	add	dx, [NABMBAR]
   635 00000435 66EF                <1> 	out	dx, eax
   636                              <1> 
   637 00000437 B90A00              <1> 	mov	cx, 10	; total 1s
   638                              <1> _warm_ac97c_rst_wait:
   639 0000043A E84D00              <1> 	call	delay_100ms
   640                              <1> 
   641 0000043D BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   642 00000440 0316[5A1D]          <1> 	add	dx, [NABMBAR]
   643 00000444 66ED                <1> 	in	eax, dx
   644                              <1> 
   645 00000446 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   646 0000044C 7504                <1> 	jnz	short _warm_ac97c_rst_ok
   647                              <1> 
   648 0000044E 49                  <1>         dec     cx
   649 0000044F 75E9                <1>         jnz     short _warm_ac97c_rst_wait
   650                              <1> 
   651                              <1> _warm_ac97c_rst_fail:
   652 00000451 F9                  <1>         stc
   653                              <1> _warm_ac97c_rst_ok:
   654 00000452 C3                  <1> 	retn
   655                              <1> 
   656                              <1> cold_ac97codec_reset:
   657                              <1> 	; 11/11/2023
   658                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   659                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   660 00000453 66B802000000        <1>         mov	eax, 2
   661 00000459 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   662 0000045C 0316[5A1D]          <1> 	add	dx, [NABMBAR]
   663 00000460 66EF                <1> 	out	dx, eax
   664                              <1> 
   665 00000462 E82500              <1> 	call	delay_100ms 	; wait 100 ms
   666 00000465 E82200              <1> 	call	delay_100ms 	; wait 100 ms
   667 00000468 E81F00              <1> 	call	delay_100ms 	; wait 100 ms
   668 0000046B E81C00              <1> 	call	delay_100ms 	; wait 100 ms
   669                              <1> 
   670 0000046E B91000              <1> 	mov	cx, 16	; total 20*100 ms = 2s
   671                              <1> 
   672                              <1> _cold_ac97c_rst_wait:
   673 00000471 BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   674 00000474 0316[5A1D]          <1> 	add	dx, [NABMBAR]
   675 00000478 66ED                <1> 	in	eax, dx
   676                              <1> 
   677 0000047A 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   678 00000480 7507                <1> 	jnz	short _cold_ac97c_rst_ok
   679                              <1> 
   680 00000482 E80500              <1> 	call	delay_100ms
   681                              <1> 
   682 00000485 49                  <1>         dec     cx
   683 00000486 75E9                <1>         jnz     short _cold_ac97c_rst_wait
   684                              <1> 
   685                              <1> _cold_ac97c_rst_fail:
   686 00000488 F9                  <1>         stc
   687                              <1> _cold_ac97c_rst_ok:
   688 00000489 C3                  <1> 	retn
   689                              <1> 
   690                              <1> delay_100ms:
   691                              <1> 	; 11/11/2023
   692                              <1> 	; 29/05/2017
   693                              <1> 	; 24/03/2017 ('codec.asm')
   694                              <1> 	; wait 100 ms
   695 0000048A 51                  <1> 	push	cx
   696 0000048B B99001              <1> 	mov	cx, 400  ; 400*0.25ms
   697                              <1> _delay_x_ms:
   698 0000048E E8E514              <1> 	call	delay1_4ms
   699 00000491 E2FB                <1>         loop	_delay_x_ms
   700 00000493 59                  <1> 	pop	cx
   701 00000494 C3                  <1> 	retn
   702                              <1> 
   703                              <1> %endif
   704                              <1> 
   705                              <1> ; 11/11/2023
   706                              <1> %if 0
   707                              <1> 
   708                              <1> codecConfig:
   709                              <1> 	; 06/11/2023
   710                              <1> 	; TUNELOOP version (playing without interrupt)
   711                              <1> 	; 04/11/2023
   712                              <1> 	; 17/02/2017 
   713                              <1> 	; 07/11/2016 (Erdogan Tan)
   714                              <1> 
   715                              <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   716                              <1> 
   717                              <1> 	mov    	dx, [NAMBAR]               	
   718                              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   719                              <1> 	out	dx, ax 				; out sample rate
   720                              <1> 		
   721                              <1> 	; 05/11/2023 temp
   722                              <1> 	;mov	dx, [NAMBAR]               	
   723                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   724                              <1> 	;out	dx, ax 
   725                              <1> 
   726                              <1>         call    delay1_4ms
   727                              <1>         call    delay1_4ms
   728                              <1>         call    delay1_4ms
   729                              <1>         call    delay1_4ms
   730                              <1> 
   731                              <1> 	mov	eax, [dev_vendor]
   732                              <1>         cmp	eax, (SI7012_DID<<16)+SIS_VID
   733                              <1>         jne	short cConfig1
   734                              <1> 
   735                              <1> 	; Unmute quirk specifically for the SiS7012
   736                              <1> 
   737                              <1> 	CUSTOM_SIS_7012_REG equ 4Ch ; SiS7012-specific register
   738                              <1> 	
   739                              <1>         mov     dx, [NABMBAR]
   740                              <1>         add     dx, CUSTOM_SIS_7012_REG
   741                              <1>         in      ax, dx
   742                              <1>         or	al, 1
   743                              <1>         out     dx, ax
   744                              <1> 
   745                              <1> cConfig1:
   746                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   747                              <1> 	; initial ac97 volumes (and clear mute flag)
   748                              <1> 		
   749                              <1>   	mov     dx, [NAMBAR]
   750                              <1>   	add     dx, CODEC_MASTER_VOL_REG        ;02h ; STEREO
   751                              <1>   	;xor	ax, ax ; volume attenuation = 0 (max. volume)
   752                              <1>   	; 03/11/2023
   753                              <1> 	mov	ax, 0202h
   754                              <1> 	out     dx, ax
   755                              <1> 
   756                              <1>         call    delay1_4ms	; delays because codecs are slow
   757                              <1>         call    delay1_4ms
   758                              <1>         call    delay1_4ms
   759                              <1>         call    delay1_4ms
   760                              <1>  
   761                              <1>   	mov     dx, [NAMBAR]
   762                              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h
   763                              <1>   	;;xor	ax, ax
   764                              <1> 	;mov	ax, 0202h
   765                              <1>   	out     dx, ax
   766                              <1> 
   767                              <1>         call    delay1_4ms
   768                              <1>         call    delay1_4ms
   769                              <1>         call    delay1_4ms
   770                              <1>         call    delay1_4ms
   771                              <1>  
   772                              <1> 	retn
   773                              <1> 
   774                              <1> %endif
   452                                  ;%include 'ich_wav.asm' ; 17/02/2017 (ICH AC97 wav playing functions)
   453                                  %include 'ich_wav4.asm' ; 18/11/2023 (ICH AC97 wav playing functions)
     1                              <1> ; 19/05/2024
     2                              <1> ; 18/11/2023
     3                              <1> ; 17/11/2023
     4                              <1> ; 16/11/2023
     5                              <1> ; 15/11/2023
     6                              <1> ; 14/11/2023
     7                              <1> ; 13/11/2023
     8                              <1> ; 03/11/2023 - 11/11/2023
     9                              <1> ; DOS based .WAV player using AC'97 and codec interface.
    10                              <1> ; ---------------------------------------------------------------
    11                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    12                              <1> ; Last Update: 17/02/2017 (by Erdogan Tan)
    13                              <1> 
    14                              <1> ; TUNELOOP version (playing without interrupt) - 06/11/2023 - Erdogan Tan
    15                              <1> ; sample rate conversion version - 18/11/2023 - Erdogan Tan
    16                              <1> 
    17                              <1> ; ICHWAV.ASM
    18                              <1> 
    19                              <1> ; player internal variables and other equates.
    20                              <1> BUFFERSIZE      equ     64 * 1024       ; 64k file buffer size.
    21                              <1> ENDOFFILE       equ     BIT0            ; flag for knowing end of file
    22                              <1> 
    23                              <1> ;===========================================================================
    24                              <1> ; entry: none. File is already open and [filehandle] filled.
    25                              <1> ; exit:  not until the song is finished or the user aborts.
    26                              <1> ;
    27                              <1> playWav:
    28                              <1> 	; 18/11/2023 (ich_wav4.asm)
    29                              <1> 	; 13/11/2023 (ich_wav3.asm)
    30                              <1> 
    31 00000495 803E[DC02]01        <1> 	cmp	byte [VRA], 1
    32 0000049A 720F                <1> 	jb	short chk_sample_rate
    33                              <1> playwav_48_khz:	
    34 0000049C C706[4B06][2B07]    <1> 	mov	word [loadfromwavfile], loadFromFile
    35                              <1> 	;mov	word [loadsize], 0 ; 65536
    36 000004A2 C706[4F06]0080      <1> 	mov	word [buffersize], 32768 ; samples
    37 000004A8 E9A801              <1> 	jmp	playWav_vra
    38                              <1> 
    39                              <1> chk_sample_rate:
    40                              <1> 	; set conversion parameters
    41                              <1> 	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
    42 000004AB A1[6A1D]            <1> 	mov	ax, [sample_rate]
    43 000004AE 3D80BB              <1> 	cmp	ax, 48000
    44 000004B1 74E9                <1> 	je	short playwav_48_khz
    45                              <1> chk_22khz:
    46 000004B3 3D2256              <1> 	cmp	ax, 22050
    47 000004B6 752F                <1> 	jne	short chk_11khz
    48 000004B8 803E[6E1D]08        <1> 	cmp	byte [bps], 8
    49 000004BD 760F                <1> 	jna	short chk_22khz_1
    50 000004BF BB[9911]            <1> 	mov	bx, load_22khz_stereo_16_bit
    51 000004C2 803E[6C1D]01        <1> 	cmp	byte [stmo], 1 
    52 000004C7 7512                <1> 	jne	short chk_22khz_2
    53 000004C9 BB[3011]            <1> 	mov	bx, load_22khz_mono_16_bit
    54 000004CC EB0D                <1> 	jmp	short chk_22khz_2
    55                              <1> chk_22khz_1:
    56 000004CE BB[CB10]            <1> 	mov	bx, load_22khz_stereo_8_bit
    57 000004D1 803E[6C1D]01        <1> 	cmp	byte [stmo], 1 
    58 000004D6 7503                <1> 	jne	short chk_22khz_2
    59 000004D8 BB[6210]            <1> 	mov	bx, load_22khz_mono_8_bit
    60                              <1> chk_22khz_2:
    61 000004DB B85A1D              <1> 	mov	ax, 7514  ; (442*17)
    62 000004DE BA2500              <1> 	mov	dx, 37
    63 000004E1 B91100              <1> 	mov	cx, 17 
    64 000004E4 E93301              <1> 	jmp	set_sizes	
    65                              <1> chk_11khz:
    66 000004E7 3D112B              <1> 	cmp	ax, 11025
    67 000004EA 752F                <1> 	jne	short chk_44khz
    68 000004EC 803E[6E1D]08        <1> 	cmp	byte [bps], 8
    69 000004F1 760F                <1> 	jna	short chk_11khz_1
    70 000004F3 BB[2D13]            <1> 	mov	bx, load_11khz_stereo_16_bit
    71 000004F6 803E[6C1D]01        <1> 	cmp	byte [stmo], 1 
    72 000004FB 7512                <1> 	jne	short chk_11khz_2
    73 000004FD BB[D212]            <1> 	mov	bx, load_11khz_mono_16_bit
    74 00000500 EB0D                <1> 	jmp	short chk_11khz_2
    75                              <1> chk_11khz_1:
    76 00000502 BB[7712]            <1> 	mov	bx, load_11khz_stereo_8_bit
    77 00000505 803E[6C1D]01        <1> 	cmp	byte [stmo], 1 
    78 0000050A 7503                <1> 	jne	short chk_11khz_2
    79 0000050C BB[1912]            <1> 	mov	bx, load_11khz_mono_8_bit
    80                              <1> chk_11khz_2:
    81 0000050F B8AD0E              <1> 	mov	ax, 3757  ; (221*17)
    82 00000512 BA4A00              <1> 	mov	dx, 74
    83 00000515 B91100              <1> 	mov	cx, 17
    84 00000518 E9FF00              <1> 	jmp	set_sizes 
    85                              <1> chk_44khz:
    86 0000051B 3D44AC              <1> 	cmp	ax, 44100
    87 0000051E 752F                <1> 	jne	short chk_16khz
    88 00000520 803E[6E1D]08        <1> 	cmp	byte [bps], 8
    89 00000525 760F                <1> 	jna	short chk_44khz_1
    90 00000527 BB[DE14]            <1> 	mov	bx, load_44khz_stereo_16_bit
    91 0000052A 803E[6C1D]01        <1> 	cmp	byte [stmo], 1 
    92 0000052F 7512                <1> 	jne	short chk_44khz_2
    93 00000531 BB[8614]            <1> 	mov	bx, load_44khz_mono_16_bit
    94 00000534 EB0D                <1> 	jmp	short chk_44khz_2
    95                              <1> chk_44khz_1:
    96 00000536 BB[2814]            <1> 	mov	bx, load_44khz_stereo_8_bit
    97 00000539 803E[6C1D]01        <1> 	cmp	byte [stmo], 1 
    98 0000053E 7503                <1> 	jne	short chk_44khz_2
    99 00000540 BB[CB13]            <1> 	mov	bx, load_44khz_mono_8_bit
   100                              <1> chk_44khz_2:
   101                              <1> 	;mov	ax, 15065 ; (655*23)
   102                              <1> 	; 18/11/2023 ((file size + bss + stack) <= 64KB)
   103 00000543 B8FC36              <1> 	mov	ax, 14076 ; (612 *23)
   104 00000546 BA1900              <1> 	mov	dx, 25
   105 00000549 B91700              <1> 	mov	cx, 23
   106 0000054C E9CB00              <1> 	jmp	set_sizes 
   107                              <1> chk_16khz:
   108 0000054F 3D803E              <1> 	cmp	ax, 16000
   109 00000552 752F                <1> 	jne	short chk_8khz
   110 00000554 803E[6E1D]08        <1> 	cmp	byte [bps], 8
   111 00000559 760F                <1> 	jna	short chk_16khz_1
   112 0000055B BB[E00C]            <1> 	mov	bx, load_16khz_stereo_16_bit
   113 0000055E 803E[6C1D]01        <1> 	cmp	byte [stmo], 1 
   114 00000563 7512                <1> 	jne	short chk_16khz_2
   115 00000565 BB[7F0C]            <1> 	mov	bx, load_16khz_mono_16_bit
   116 00000568 EB0D                <1> 	jmp	short chk_16khz_2
   117                              <1> chk_16khz_1:
   118 0000056A BB[EF0B]            <1> 	mov	bx, load_16khz_stereo_8_bit
   119 0000056D 803E[6C1D]01        <1> 	cmp	byte [stmo], 1 
   120 00000572 7503                <1> 	jne	short chk_16khz_2
   121 00000574 BB[8B0B]            <1> 	mov	bx, load_16khz_mono_8_bit
   122                              <1> chk_16khz_2:
   123 00000577 B85515              <1> 	mov	ax, 5461
   124 0000057A BA0300              <1> 	mov	dx, 3
   125 0000057D B90100              <1> 	mov	cx, 1
   126 00000580 E99700              <1> 	jmp	set_sizes 
   127                              <1> chk_8khz:
   128 00000583 3D401F              <1> 	cmp	ax, 8000
   129 00000586 752E                <1> 	jne	short chk_24khz
   130 00000588 803E[6E1D]08        <1> 	cmp	byte [bps], 8
   131 0000058D 760F                <1> 	jna	short chk_8khz_1
   132 0000058F BB[A40A]            <1> 	mov	bx, load_8khz_stereo_16_bit
   133 00000592 803E[6C1D]01        <1> 	cmp	byte [stmo], 1 
   134 00000597 7512                <1> 	jne	short chk_8khz_2
   135 00000599 BB[130A]            <1> 	mov	bx, load_8khz_mono_16_bit
   136 0000059C EB0D                <1> 	jmp	short chk_8khz_2
   137                              <1> chk_8khz_1:
   138 0000059E BB[2309]            <1> 	mov	bx, load_8khz_stereo_8_bit
   139 000005A1 803E[6C1D]01        <1> 	cmp	byte [stmo], 1 
   140 000005A6 7503                <1> 	jne	short chk_8khz_2
   141 000005A8 BB[7008]            <1> 	mov	bx, load_8khz_mono_8_bit
   142                              <1> chk_8khz_2:
   143 000005AB B8AA0A              <1> 	mov	ax, 2730
   144 000005AE BA0600              <1> 	mov	dx, 6
   145 000005B1 B90100              <1> 	mov	cx, 1
   146 000005B4 EB64                <1> 	jmp	short set_sizes 
   147                              <1> chk_24khz:
   148 000005B6 3DC05D              <1> 	cmp	ax, 24000
   149 000005B9 752E                <1> 	jne	short chk_32khz
   150 000005BB 803E[6E1D]08        <1> 	cmp	byte [bps], 8
   151 000005C0 760F                <1> 	jna	short chk_24khz_1
   152 000005C2 BB[750E]            <1> 	mov	bx, load_24khz_stereo_16_bit
   153 000005C5 803E[6C1D]01        <1> 	cmp	byte [stmo], 1 
   154 000005CA 7512                <1> 	jne	short chk_24khz_2
   155 000005CC BB[2C0E]            <1> 	mov	bx, load_24khz_mono_16_bit
   156 000005CF EB0D                <1> 	jmp	short chk_24khz_2
   157                              <1> chk_24khz_1:
   158 000005D1 BB[C40D]            <1> 	mov	bx, load_24khz_stereo_8_bit
   159 000005D4 803E[6C1D]01        <1> 	cmp	byte [stmo], 1 
   160 000005D9 7503                <1> 	jne	short chk_24khz_2
   161 000005DB BB[750D]            <1> 	mov	bx, load_24khz_mono_8_bit
   162                              <1> chk_24khz_2:
   163 000005DE B80020              <1> 	mov	ax, 8192
   164 000005E1 BA0200              <1> 	mov	dx, 2
   165 000005E4 B90100              <1> 	mov	cx, 1
   166 000005E7 EB31                <1> 	jmp	short set_sizes 
   167                              <1> chk_32khz:
   168 000005E9 3D007D              <1> 	cmp	ax, 32000
   169 000005EC 7556                <1> 	jne	short vra_needed
   170 000005EE 803E[6E1D]08        <1> 	cmp	byte [bps], 8
   171 000005F3 760F                <1> 	jna	short chk_32khz_1
   172 000005F5 BB[F70F]            <1> 	mov	bx, load_32khz_stereo_16_bit
   173 000005F8 803E[6C1D]01        <1> 	cmp	byte [stmo], 1 
   174 000005FD 7512                <1> 	jne	short chk_32khz_2
   175 000005FF BB[AA0F]            <1> 	mov	bx, load_32khz_mono_16_bit
   176 00000602 EB0D                <1> 	jmp	short chk_32khz_2
   177                              <1> chk_32khz_1:
   178 00000604 BB[330F]            <1> 	mov	bx, load_32khz_stereo_8_bit
   179 00000607 803E[6C1D]01        <1> 	cmp	byte [stmo], 1 
   180 0000060C 7503                <1> 	jne	short chk_32khz_2
   181 0000060E BB[DB0E]            <1> 	mov	bx, load_32khz_mono_8_bit
   182                              <1> chk_32khz_2:
   183 00000611 B8AA2A              <1> 	mov	ax, 10922
   184 00000614 BA0300              <1> 	mov	dx, 3
   185 00000617 B90200              <1> 	mov	cx, 2
   186                              <1> 	;jmp	short set_sizes 
   187                              <1> set_sizes:
   188 0000061A 803E[6C1D]01        <1> 	cmp	byte [stmo], 1
   189 0000061F 7402                <1> 	je	short ss_1
   190 00000621 D1E0                <1> 	shl	ax, 1
   191                              <1> ss_1:
   192 00000623 803E[6E1D]08        <1> 	cmp	byte [bps], 8
   193 00000628 7602                <1> 	jna	short ss_2
   194                              <1> 	; 16 bit samples
   195 0000062A D1E0                <1> 	shl	ax, 1
   196                              <1> ss_2:
   197 0000062C A3[4D06]            <1> 	mov	[loadsize], ax
   198 0000062F F7E2                <1> 	mul	dx
   199                              <1> 	;cmp	cx, 1
   200                              <1> 	;je	short ss_3
   201                              <1> ;ss_3:
   202 00000631 F7F1                <1> 	div	cx
   203 00000633 8A0E[701D]          <1> 	mov	cl, [fbs_shift]
   204 00000637 D3E0                <1> 	shl	ax, cl
   205 00000639 D1E8                <1> 	shr	ax, 1	; buffer size is 16 bit sample count
   206 0000063B A3[4F06]            <1> 	mov	[buffersize], ax 
   207 0000063E 891E[4B06]          <1> 	mov	[loadfromwavfile], bx
   208 00000642 EB0F                <1> 	jmp	short playWav_vra
   209                              <1> 
   210                              <1> vra_needed:
   211                              <1> 	; 13/11/2023
   212 00000644 58                  <1> 	pop	ax ; discard return address to the caller
   213 00000645 BA[FF1C]            <1> 	mov	dx, msg_no_vra
   214 00000648 E9CFFA              <1> 	jmp	vra_err
   215                              <1> 
   216                              <1> 	; 13/11/2023
   217                              <1> loadfromwavfile:
   218 0000064B [2B07]              <1> 	dw	loadFromFile
   219                              <1> loadsize:	; read from wav file
   220 0000064D 0000                <1> 	dw	0
   221                              <1> buffersize:	; write to DMA buffer
   222 0000064F 00800000            <1> 	dd	32768 ; 16 bit samples (not bytes)
   223                              <1> 
   224                              <1> playWav_vra:
   225                              <1> 	; 07/11/2023
   226                              <1> 	; clear buffer 2
   227                              <1>         ;push	es
   228                              <1> 	;mov	ax, [WAV_BUFFER2]
   229                              <1> 	;mov	es, ax
   230                              <1> 	;sub	ax, ax
   231                              <1> 	;mov	di, ax ; 17/02/2017
   232                              <1> 	;mov	cx, (BUFFERSIZE/2)
   233                              <1> 	;rep	stosw
   234                              <1> 	;pop	es	     
   235                              <1> 	
   236                              <1> 	; load 64k into buffer 1
   237 00000653 A1[5E1D]            <1>         mov     ax, [WAV_BUFFER1]
   238                              <1>         ;call	loadFromFile
   239                              <1> 	; 13/11/2023
   240 00000656 FF16[4B06]          <1> 	call	word [loadfromwavfile]
   241                              <1> 
   242                              <1> 	; and 64k into buffer 2
   243 0000065A A1[601D]            <1> 	mov     ax, [WAV_BUFFER2]
   244                              <1>        	;call	loadFromFile
   245                              <1> 	; 13/11/2023
   246 0000065D FF16[4B06]          <1> 	call	word [loadfromwavfile]
   247                              <1> 
   248                              <1> ; register reset the DMA engine. This may cause a pop noise on the output
   249                              <1> ; lines when the device is reset. Prolly a better idea to mute output, then
   250                              <1> ; reset.
   251                              <1> ;
   252                              <1> 	; 11/11/2023
   253                              <1>         ;mov	dx, [NABMBAR]
   254                              <1>         ;add	dx, PO_CR_REG		; set pointer to Ctrl reg
   255                              <1>         ;mov	al, RR			; set reset
   256                              <1> 	;out	dx, al			; self clearing bit
   257                              <1> 
   258                              <1> ; write last valid index to 31 to start with.
   259                              <1> ; The Last Valid Index register tells the DMA engine when to stop playing.
   260                              <1> ; 
   261                              <1> ; As we progress through the song we change the last valid index to always be
   262                              <1> ; something other than the index we're currently playing.  
   263                              <1> ;
   264                              <1> 	; 08/11/2023
   265                              <1> 	;; 07/11/2023
   266                              <1> 	;mov	al, 1
   267                              <1>         ;;mov	al, 31
   268                              <1> 	;call	setLastValidIndex
   269                              <1> 
   270                              <1> ; create Buffer Descriptor List
   271                              <1> ;
   272                              <1> ; A buffer descriptor list is a list of pointers and control bits that the
   273                              <1> ; DMA engine uses to know where to get the .wav data and how to play it.
   274                              <1> ;
   275                              <1> ; I set it up to use only 2 buffers of .wav data, and whenever 1 buffer is
   276                              <1> ; playing, I refresh the other one with good data.
   277                              <1> ;
   278                              <1> ;
   279                              <1> ; For the control bits, you can specify that the DMA engine fire an interrupt
   280                              <1> ; after a buffer has been processed, but I poll the current index register
   281                              <1> ; to know when it's safe to update the other buffer.
   282                              <1> ;
   283                              <1> ; I set the BUP bit, which tells the DMA engine to just play 0's (silence)
   284                              <1> ; if it ever runs out of data to play. Good for safety.
   285                              <1> ;
   286 00000661 06                  <1>         push    es
   287 00000662 A1[5C1D]            <1>         mov     ax, [BDL_BUFFER]		; get segment # for BDL
   288 00000665 8EC0                <1>         mov     es, ax
   289                              <1> 
   290 00000667 B91000              <1>         mov     cx, 32 / 2                      ; make 32 entries in BDL
   291 0000066A 31FF                <1>         xor     di, di                          
   292                              <1> _0:
   293                              <1> 
   294                              <1> ; set buffer descriptor 0 to start of data file in memory
   295 0000066C 660FB706[5E1D]      <1>         movzx   eax, word [WAV_BUFFER1]
   296 00000672 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   297 00000676 66AB                <1>         stosd                                   ; store pointer to wavbuffer1
   298                              <1> 
   299                              <1> ;
   300                              <1> ; set length to 32k samples. 1 sample is 16bits or 2bytes.
   301                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples.
   302                              <1> ; 
   303                              <1> 
   304                              <1> ; 17/02/2017 (Erdogan Tan)
   305                              <1> ; Intel 82801AA (ICH) & Intel 82801AB (ICH0) I/O Controller Hub AC97
   306                              <1> ; Programmers Reference Manual
   307                              <1> 
   308                              <1> ; 2.2.1 Buffer Descriptor List  (on Page 13)
   309                              <1> 	;
   310                              <1> 	;  Generic Form of Buffer Descriptor
   311                              <1> 	;  ---------------------------------
   312                              <1> 	;  63   62    61-48    47-32   31-0
   313                              <1> 	;  ---  ---  --------  ------- -----
   314                              <1> 	;  IOC  BUP -reserved- Buffer  Buffer
   315                              <1> 	;		      Length   Pointer
   316                              <1> 	;		      [15:0]   [31:0]
   317                              <1> 	;
   318                              <1> 	;  IOC:	Interrupt On Completion. 
   319                              <1> 	;	1 = Enabled. 
   320                              <1> 	;	    When this is set, it means that the controller should
   321                              <1> 	;	    issue an interrupt upon completion of this buffer.
   322                              <1> 	;	    It should also set the IOC bit in the status register
   323                              <1> 	;	0 = Disabled	
   324                              <1> 	;
   325                              <1> 	;  BUP: Buffer Underrun Policy.
   326                              <1> 	;       0 = When this buffer is complete,
   327                              <1> 	;	    if the next buffer is not yet ready 
   328                              <1> 	;	    (i.e., the last valid buffer has been processed),
   329                              <1> 	;	    then continue to transmit the last valid sample.
   330                              <1> 	;	1 = When this buffer is complete,
   331                              <1> 	;     	    if this is the last valid buffer, transmit zeros after
   332                              <1> 	;	    this buffer has been processed completely.
   333                              <1> 	;	    This bit typically is set only if this is the last 
   334                              <1> 	;	    buffer in the current stream.
   335                              <1> 	;
   336                              <1> 	; [31:0]: Buffer pointer. This field points to the location of
   337                              <1> 	;	  the data buffer. Since samples can be as wide as one
   338                              <1> 	;	  word, the buffer must be aligned with word boundaries,
   339                              <1> 	;	  to prevent samples from straddling DWord boundaries.
   340                              <1> 	;
   341                              <1> 	; [15:0]: Buffer Length: This is the length of the data buffer,
   342                              <1> 	;	  in number of samples. The controller uses this data
   343                              <1> 	;	  to determine the length of the buffer, in bytes.
   344                              <1> 	;	  "0" indicates no sample to process.
   345                              <1> 
   346                              <1> ; ICH2AC97.INC
   347                              <1> 
   348                              <1> ;	IOC	equ     BIT31   ; Fire an interrupt whenever this
   349                              <1> 				; buffer is complete.
   350                              <1> 
   351                              <1> ;	BUP	equ     BIT30   ; Buffer Underrun Policy.
   352                              <1> 				; if this buffer is the last buffer
   353                              <1> 				; in a playback, fill the remaining
   354                              <1> 				; samples with 0 (silence) or not.
   355                              <1> 				; It's a good idea to set this to 1
   356                              <1> 				; for the last buffer in playback,
   357                              <1> 				; otherwise you're likely to get a lot
   358                              <1> 				; of noise at the end of the sound.
   359                              <1> ;
   360                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   361                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   362                              <1> ; Luckily for us, that's the same format as .wav files.
   363                              <1> ;
   364                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   365                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   366                              <1> ;
   367                              <1> ; A value of 0 in these bits means play no samples.
   368                              <1> ;
   369                              <1> 
   370                              <1> ; ICHWAV.ASM
   371                              <1> 				    ; 19/05/2024
   372                              <1> 	;mov	eax, BUFFERSIZE / 2 ; size of buffer (32K) in (16bit) words
   373                              <1> 	; 13/11/2023 (ich_wav3.asm) - 18/11/2023 (ich_wav4.asm)
   374 00000678 66A1[4F06]          <1> 	mov	eax, [buffersize]
   375                              <1> 
   376                              <1> 	;or	eax, IOC + BUP
   377                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   378 0000067C 660D00000040        <1> 	or	eax, BUP
   379 00000682 66AB                <1> 	stosd
   380                              <1> 
   381                              <1> ; 2nd buffer:
   382                              <1> 
   383 00000684 660FB706[601D]      <1>         movzx   eax, word [WAV_BUFFER2]
   384 0000068A 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   385 0000068E 66AB                <1>         stosd                                   ; store pointer to wavbuffer2
   386                              <1> 
   387                              <1> ; set length to 64k (32k of two 16 bit samples)
   388                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples
   389                              <1> ; 
   390                              <1> 	;mov	eax, BUFFERSIZE / 2 ; size of half buffer (32K)
   391                              <1> 	; 13/11/2023 (ich_wav3.asm) - 18/11/2023 (ich_wav4.asm)
   392 00000690 66A1[4F06]          <1> 	mov	eax, [buffersize]
   393                              <1> 
   394                              <1> 	;or	eax, IOC + BUP
   395                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   396 00000694 660D00000040        <1> 	or	eax, BUP
   397 0000069A 66AB                <1> 	stosd
   398                              <1> 
   399 0000069C E2CE                <1>         loop    _0
   400 0000069E 07                  <1>         pop     es
   401                              <1> 
   402                              <1> ;
   403                              <1> ; tell the DMA engine where to find our list of Buffer Descriptors.
   404                              <1> ; this 32bit value is a flat mode memory offset (ie no segment:offset)
   405                              <1> ;
   406                              <1> ; write NABMBAR+10h with offset of buffer descriptor list
   407                              <1> ;
   408 0000069F 660FB706[5C1D]      <1>         movzx   eax, word [BDL_BUFFER]
   409 000006A5 66C1E004            <1> 	shl     eax, 4                          ; convert seg:off to 0:off
   410 000006A9 8B16[5A1D]          <1>         mov     dx, [NABMBAR]
   411 000006AD 83C210              <1>         add     dx, PO_BDBAR_REG                ; set pointer to BDL
   412 000006B0 66EF                <1>         out     dx, eax                         ; write to AC97 controller
   413                              <1> 
   414                              <1> 	; 19/05/2024
   415 000006B2 E8C112              <1> 	call	delay1_4ms
   416                              <1> 
   417                              <1> ;
   418                              <1> ; All set. Let's play some music.
   419                              <1> ;
   420                              <1> 
   421                              <1> 	; 08/11/2023
   422                              <1> 	; 07/11/2023
   423                              <1> 	; 08/12/2016
   424                              <1> 	; 07/10/2016
   425                              <1>         ;mov	al, 1
   426 000006B5 B01F                <1>         mov	al, 31
   427 000006B7 E86901              <1> 	call	setLastValidIndex
   428                              <1> 
   429                              <1> 	; 06/11/2023 (not neccessary)
   430                              <1> 	;; 05/11/2023
   431                              <1> 	;; reset current index
   432                              <1> 	;mov	al, 0
   433                              <1> 	;call	setCurrentIndex
   434                              <1> 
   435                              <1> 	; 06/11/2023
   436                              <1> 	;mov	byte [tLoop], 1 ; 30/11/2016
   437                              <1> 
   438                              <1> 	; 19/05/2024
   439 000006BA E8B912              <1> 	call	delay1_4ms
   440                              <1> 
   441                              <1> 	; 17/02/2017
   442 000006BD 8B16[5A1D]          <1>         mov     dx, [NABMBAR]
   443 000006C1 83C21B              <1>         add     dx, PO_CR_REG                   ; PCM out Control Register
   444                              <1>         ;mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
   445                              <1> 	;			; (LVBI interrupt will not be enabled)
   446                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   447 000006C4 B001                <1> 	mov	al, RPBM
   448 000006C6 EE                  <1> 	out     dx, al                          ; Start bus master operation.
   449                              <1> 
   450                              <1> 	; 19/05/2024
   451                              <1> 	; 06/11/2023
   452 000006C7 E8AC12              <1> 	call	delay1_4ms
   453 000006CA E8A912              <1> 	call	delay1_4ms
   454 000006CD E8A612              <1> 	call	delay1_4ms
   455 000006D0 E8A312              <1> 	call	delay1_4ms
   456                              <1> 
   457                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   458                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   459                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   460                              <1>    
   461                              <1> ; 06/11/2023 (TUNELOOP version, without interrupt)
   462                              <1> %if 0
   463                              <1> 	; 08/12/2016
   464                              <1> 	; 28/11/2016
   465                              <1> p_loop:
   466                              <1> 	call    check4keyboardstop      ; keyboard halt?
   467                              <1>         jc	short r_loop 	; no ; 05/11/2023
   468                              <1> 
   469                              <1> 	;mov	byte [tLoop], 0
   470                              <1> 	; 04/11/2023
   471                              <1> 	;mov	byte [audio_play_cmd], 0
   472                              <1> 	;call	ac97_stop
   473                              <1> 	;retn
   474                              <1> _exit_:
   475                              <1> 	; 04/11/2023
   476                              <1> 	; finished with song, stop everything
   477                              <1> 	call	ac97_stop
   478                              <1> 	
   479                              <1> 	; restore previous interrupt vector and interrupt_status
   480                              <1> 	cli
   481                              <1> 	in	al, 0A1h ; irq 8-15
   482                              <1> 	mov	al, [IRQ_status+1]
   483                              <1> 	out	0A1h, al 
   484                              <1> 	in	al, 021h ; irq 0-7
   485                              <1> 	mov	al, [IRQ_status]
   486                              <1> 	out	21h, al 
   487                              <1> 	; ...
   488                              <1> 	push	es
   489                              <1> 	xor	ax, ax
   490                              <1> 	mov	es, ax
   491                              <1> 	mov	ax, [IRQ_vector]
   492                              <1> 	mov	[es:bx], ax
   493                              <1> 	mov	ax, [IRQ_vector+2]
   494                              <1> 	mov	[es:bx+2], ax
   495                              <1> 	pop	es
   496                              <1> 	sti
   497                              <1> 	retn
   498                              <1> 
   499                              <1> r_loop:
   500                              <1> 	; 07/12/2016 - Erdogan Tan
   501                              <1> 	nop
   502                              <1> 	nop
   503                              <1> 	nop
   504                              <1> 	; 17/02/2017
   505                              <1> 	mov	al, [tBuff]
   506                              <1> 	dec	al ; 1-32 -> 0-31 or 0 -> 0FFh
   507                              <1> 	js	short  p_loop
   508                              <1> 	mov	byte [tBuff], 0 ; reset
   509                              <1> 	and	al, 1
   510                              <1> 	jnz	short q_loop
   511                              <1>         mov     ax, [WAV_BUFFER2] ; [tBuff]=2 (from tuneLoop)
   512                              <1> s_loop:
   513                              <1> 	;call	loadFromFile
   514                              <1> 	; 13/11/2023 - 18/11/2023
   515                              <1> 	call	[loadfromwavfile]
   516                              <1> 	;jc	short _exit_
   517                              <1> 	; 05/11/2023
   518                              <1> 	jc	short exit_loop
   519                              <1> 	jmp	short r_loop
   520                              <1> q_loop:
   521                              <1>      	mov     ax, [WAV_BUFFER1] ; [tBuff]=1 (from tuneLoop)
   522                              <1>         ;call	loadFromFile
   523                              <1> 	;jc	short _exit_
   524                              <1> 	;jmp	short r_loop
   525                              <1> 	; 05/11/2023
   526                              <1> 	jmp	short s_loop
   527                              <1> 
   528                              <1> exit_loop: 
   529                              <1> 	mov	byte [tLoop], 0
   530                              <1> 	retn
   531                              <1> 		
   532                              <1> tuneLoop:
   533                              <1> 	; 05/11/2023
   534                              <1> 	; 08/12/2016
   535                              <1> 	; 28/11/2016 - Erdogan Tan
   536                              <1> 	
   537                              <1> 	cmp	byte [tLoop], 1
   538                              <1> 	jb	short _exit_ ; 05/11/2023
   539                              <1> _tlp_1:	
   540                              <1> 	; 17/02/2017
   541                              <1> 	call	getCurrentIndex
   542                              <1> 	inc	al ; 0-31 -> 1-32
   543                              <1> 	mov	[tBuff], al
   544                              <1> 
   545                              <1> 	; 05/11/2023
   546                              <1> 	dec	ax
   547                              <1> 	dec	ax
   548                              <1> 	and	al, 1Fh
   549                              <1> 	call	setLastValidIndex
   550                              <1> 
   551                              <1> 	; 05/11/2023
   552                              <1> 	; 17/02/2017 - Buffer switch test (temporary)
   553                              <1> 	push	ds
   554                              <1> 	push	si 
   555                              <1> 	mov	si, 0B800h ; video display page segment
   556                              <1> 	mov	ds, si
   557                              <1> 	sub	si, si ; 0
   558                              <1> 	mov	ah, 4Eh
   559                              <1> 	and	al, 1
   560                              <1> 	add	al, '1'
   561                              <1> 	mov	[si], ax ; show current play buffer (1, 2)
   562                              <1> 	pop	si
   563                              <1> 	pop	ds
   564                              <1> 
   565                              <1> 	; 17/02/2017
   566                              <1> 
   567                              <1> 	;test	byte [irq_status], LVBCI ; last buff completion intr.
   568                              <1> 	;jz	short _tlp2 ; BCIS ; Buffer completion interrupt
   569                              <1> 
   570                              <1> 	; Last Valid Buffer Completion Interrupt (LVBCI).
   571                              <1> 	;   1 = Last valid buffer has been processed. 
   572                              <1> 	;	It remains active until cleared by software. 
   573                              <1> 	;	This bit indicates the occurrence of the event 
   574                              <1> 	;	signified by the last valid buffer being processed.
   575                              <1> 	;	Thus, this is an event status bit that can be cleared
   576                              <1> 	;	by software once this event has been recognized.
   577                              <1> 	;	This event causes an interrupt if the enable bit
   578                              <1> 	;	in the Control Register is set. The interrupt is
   579                              <1> 	;	cleared when the software clears this bit.
   580                              <1> 	;	In the case of Transmits (PCM out, Modem out) this bit
   581                              <1> 	;	is set, after the last valid buffer has been
   582                              <1> 	;	fetched (not after transmitting it).
   583                              <1> 	;	While in the case of Receives, this bit is set after
   584                              <1> 	;	the data for the last buffer has been written to memory.
   585                              <1> 	;   0 = Cleared by writing a "1" to this bit position.
   586                              <1> 
   587                              <1> 	; Note: We are not using LVBCI 
   588                              <1> 	;     Last Buffer Completion Interrupt !!!
   589                              <1> 
   590                              <1> 	; 17/02/2017
   591                              <1>         ;mov     dx, [NABMBAR]
   592                              <1>         ;add     dx, PO_SR_REG	; PCM out Status register
   593                              <1>         ;mov     al, [irq_status]
   594                              <1>         ;out     dx, al		; Clear (LVBCI) interrupt status
   595                              <1> 	;retn
   596                              <1> 
   597                              <1> ;_tlp2:
   598                              <1> 	; Buffer Completion Interrupt Status (BCIS).
   599                              <1> 	;   1 =	Set by the hardware after the last sample 
   600                              <1> 	; 	of a buffer has been processed, AND if the Interrupt
   601                              <1> 	; 	on Completion (IOC) bit is set in the command byte of 
   602                              <1> 	; 	the buffer descriptor. It remains active
   603                              <1> 	; 	until cleared by software.
   604                              <1> 	;   0 =	Cleared by writing a "1" to this bit position.
   605                              <1> 
   606                              <1> 	; 17/02/2017
   607                              <1>         mov     dx, [NABMBAR]
   608                              <1>         add     dx, PO_SR_REG	; PCM out Status register
   609                              <1>         mov     al, [pcm_irq_status] ; 05/11/2023
   610                              <1>         out     dx, al		; Clear (BCI) interrupt status
   611                              <1> 	retn
   612                              <1> 
   613                              <1> ;_exit_:
   614                              <1> ;	mov	byte [tLoop], 0
   615                              <1> ;_exit:
   616                              <1> ;       ; finished with song, stop everything
   617                              <1> ;	mov     dx, [NABMBAR]		
   618                              <1> ;       add     dx, PO_CR_REG           ; PCM out Control Register
   619                              <1> ;       mov     al, 0
   620                              <1> ;       out     dx, al                  ; stop player
   621                              <1> ;_return:
   622                              <1> ;	retn
   623                              <1> 
   624                              <1> %endif
   625                              <1> 
   626                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   627                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   628                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   629                              <1> 
   630                              <1> ; 18/11/2023
   631                              <1> ; 08/11/2023
   632                              <1> ; 07/11/2023
   633                              <1> %if 1
   634                              <1> 
   635                              <1> tuneLoop:
   636                              <1> 	; 18/11/2023 (ich_wav4.asm)
   637                              <1> 	; 08/11/2023
   638                              <1> 	; 06/11/2023
   639 000006D3 B031                <1> 	mov	al, '1'
   640 000006D5 E84500              <1> 	call	tL0
   641                              <1> tL1:
   642 000006D8 E81D01              <1> 	call    updateLVI	; /set LVI != CIV/
   643 000006DB 7434                <1> 	jz	short _exit_	; 08/11/2023
   644 000006DD E84C01              <1> 	call    check4keyboardstop
   645 000006E0 722F                <1> 	jc	short _exit_
   646 000006E2 E80A01              <1> 	call    getCurrentIndex
   647 000006E5 A801                <1> 	test	al, BIT0
   648 000006E7 74EF                <1> 	jz	short tL1	; loop if buffer 2 is not playing
   649                              <1> 
   650                              <1> 	; load buffer 1
   651 000006E9 A1[5E1D]            <1> 	mov     ax, [WAV_BUFFER1]
   652                              <1> 	;call	loadFromFile
   653                              <1> 	; 18/11/2023
   654 000006EC FF16[4B06]          <1> 	call	word [loadfromwavfile]
   655 000006F0 721F                <1> 	jc	short _exit_	; end of file
   656                              <1> 
   657 000006F2 B032                <1> 	mov	al, '2'
   658 000006F4 E82600              <1> 	call	tL0
   659                              <1> tL2:
   660 000006F7 E8FE00              <1> 	call    updateLVI
   661 000006FA 7415                <1> 	jz	short _exit_	; 08/11/2023
   662 000006FC E82D01              <1> 	call    check4keyboardstop
   663 000006FF 7210                <1> 	jc	short _exit_
   664 00000701 E8EB00              <1> 	call    getCurrentIndex
   665 00000704 A801                <1> 	test	al, BIT0
   666 00000706 75EF                <1> 	jnz	short tL2	; loop if buffer 1 is not playing
   667                              <1> 
   668                              <1> 	; load buffer 2
   669 00000708 A1[601D]            <1> 	mov     ax, [WAV_BUFFER2]
   670                              <1> 	;call	loadFromFile
   671                              <1> 	; 18/11/2023
   672 0000070B FF16[4B06]          <1> 	call	word [loadfromwavfile]
   673 0000070F 73C2                <1> 	jnc	short tuneLoop
   674                              <1> _exit_:
   675 00000711 8B16[5A1D]          <1> 	mov	dx, [NABMBAR]		
   676 00000715 83C21B              <1> 	add	dx, PO_CR_REG	; PCM out Control Register
   677 00000718 B000                <1> 	mov	al, 0
   678 0000071A EE                  <1> 	out	dx, al		; stop player
   679                              <1> 
   680 0000071B 0430                <1> 	add	al, '0'
   681                              <1> 	;call	tL0
   682                              <1> 	;
   683                              <1> 	;retn
   684                              <1> 	; 06/11/2023
   685                              <1> 	;jmp	short tL0
   686                              <1> 	;retn
   687                              <1> 
   688                              <1> 	; 06/11/2023
   689                              <1> tL0:
   690                              <1> 	; 08/11/2023
   691                              <1> 	; 05/11/2023
   692                              <1> 	; 17/02/2017 - Buffer switch test (temporary)
   693                              <1> 	; 06/11/2023
   694                              <1> 	; al = buffer indicator ('1', '2' or '0' -stop- )
   695 0000071D 1E                  <1> 	push	ds
   696                              <1> 	;push	bx 
   697 0000071E BB00B8              <1> 	mov	bx, 0B800h ; video display page segment
   698 00000721 8EDB                <1> 	mov	ds, bx
   699 00000723 29DB                <1> 	sub	bx, bx ; 0
   700 00000725 B44E                <1> 	mov	ah, 4Eh
   701 00000727 8907                <1> 	mov	[bx], ax ; show current play buffer (1, 2)
   702                              <1> 	;pop	bx
   703 00000729 1F                  <1> 	pop	ds
   704 0000072A C3                  <1> 	retn
   705                              <1> 
   706                              <1> %endif
   707                              <1> 
   708                              <1> ; 08/11/2023
   709                              <1> ; 07/11/2023
   710                              <1> %if 0
   711                              <1> 
   712                              <1> tuneLoop:
   713                              <1> 	; 07/11/2023
   714                              <1> 	;mov	dx, NABMBAR
   715                              <1> 	;add	dx, PO_CIV_REG ; 14h
   716                              <1> tL1:
   717                              <1> 	call    updateLVI	; set LVI != CIV
   718                              <1> 	call    check4keyboardstop
   719                              <1> 	jc	short _exit_
   720                              <1> 	call    getCurrentIndex
   721                              <1> 	test	al, BIT0
   722                              <1> 	jz	short tL1	; loop if buffer 2 is not playing
   723                              <1> 
   724                              <1> 	; load buffer 1
   725                              <1> 	mov     ax, [WAV_BUFFER1]
   726                              <1> 	call	loadFromFile
   727                              <1> 	jc	short _exit_	; end of file
   728                              <1> tL2:
   729                              <1> 	call    updateLVI
   730                              <1> 	call    check4keyboardstop
   731                              <1> 	jc	short _exit_
   732                              <1> 	call    getCurrentIndex
   733                              <1> 	test	al, BIT0
   734                              <1> 	jnz	short tL2	; loop if buffer 1 is not playing
   735                              <1> 
   736                              <1> 	; load buffer 2
   737                              <1> 	mov     ax, [WAV_BUFFER2]
   738                              <1> 	call	loadFromFile
   739                              <1> 	jnc	short tuneLoop
   740                              <1> _exit_:
   741                              <1> 	mov	dx, [NABMBAR]		
   742                              <1> 	add	dx, PO_CR_REG	; PCM out Control Register
   743                              <1> 	mov	al, 0
   744                              <1> 	out	dx, al		; stop player
   745                              <1> 	retn
   746                              <1> 
   747                              <1> %endif
   748                              <1> 
   749                              <1> ; load data from file in 32k chunks. Would be nice to load 1 64k chunk,
   750                              <1> ; but in DOS you can only load FFFF bytes at a time.
   751                              <1> ;
   752                              <1> ; entry: ax = segment to load data to
   753                              <1> ; exit: CY set if end of file reached.
   754                              <1> ; note: last file buffer is padded with 0's to avoid pops at the end of song.
   755                              <1> ; assumes file is already open. uses [filehandle]
   756                              <1> 
   757                              <1> ; 07/11/2023
   758                              <1> %if 0
   759                              <1> 
   760                              <1> loadFromFile:
   761                              <1> 	; 07/11/2023
   762                              <1> 	; 06/11/2023
   763                              <1> 	; 17/02/2017
   764                              <1> 	;push	ax
   765                              <1> 	;push	cx
   766                              <1> 	;push	dx
   767                              <1> 	;push	bx
   768                              <1> 
   769                              <1> 	;push	es
   770                              <1> 	;push	ds
   771                              <1> 	
   772                              <1>         test    byte [flags], ENDOFFILE	; have we already read the
   773                              <1> 	;stc				; last of the file?
   774                              <1> 	; 05/11/2023
   775                              <1> 	;jnz	endLFF
   776                              <1> 	jz	short lff_12	; 06/11/2023
   777                              <1> 	; 06/11/2023
   778                              <1> 	;;mov	byte [tLoop], 0
   779                              <1> 	;jmp	endLFF
   780                              <1> 	stc
   781                              <1> 	retn
   782                              <1> 
   783                              <1> lff_12:	; 06/11/2023    
   784                              <1> 	mov	[fbs_seg], ax ; save buffer segment
   785                              <1> 	xor	dx, dx
   786                              <1> lff_0:
   787                              <1> 	mov	[fbs_off], dx ; buffer offset
   788                              <1> 
   789                              <1> 	mov     bx, (BUFFERSIZE / 2)	; 32k chunk
   790                              <1> 	mov	cl, [fbs_shift]   
   791                              <1> 	and	cl, cl
   792                              <1> 	jz	short lff_1 ; stereo, 16 bit	
   793                              <1> 
   794                              <1> 	; fbs_shift =
   795                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   796                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   797                              <1> 	shr	bx, cl ; 32K / multiplier
   798                              <1> 
   799                              <1> 	mov	ax, cs
   800                              <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   801                              <1> lff_1:
   802                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   803                              <1> 	; load file into memory
   804                              <1>         mov	cx, bx                         
   805                              <1> 	mov	bx, [filehandle]
   806                              <1> 	mov     ds, ax
   807                              <1>        	mov	ah, 3fh
   808                              <1> 	int	21h
   809                              <1> 
   810                              <1> 	mov	bx, cs
   811                              <1> 	mov	ds, bx
   812                              <1> 
   813                              <1> 	jc	short lff_9 ; error !
   814                              <1> 
   815                              <1> 	and	ax, ax
   816                              <1> 	jz	short lff_10
   817                              <1> 	
   818                              <1> 	mov	bl, [fbs_shift] ; shift count  
   819                              <1> 	or	bl, bl
   820                              <1> 	jz	short lff_7 ; 16 bit stereo samples
   821                              <1> 
   822                              <1> 	push	es
   823                              <1> 	; 06/11/2023
   824                              <1> 	;push	di
   825                              <1> 	;push	si
   826                              <1> 	mov	di, [fbs_off]
   827                              <1> 	mov	si, [fbs_seg] ; buffer segment
   828                              <1> 	mov	es, si
   829                              <1> 	mov	si, temp_buffer ; temporary buffer address
   830                              <1> 	mov	cl, [bps] ; bits per sample (8 or 16)
   831                              <1> 	cmp	cl, 8
   832                              <1> 	jne	short lff_4 ; 16 bit samples
   833                              <1> 	; 8 bit samples
   834                              <1> 	mov	cx, ax ; byte count
   835                              <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   836                              <1> 	jz	short lff_3 ; 8 bit, stereo
   837                              <1> lff_2:
   838                              <1> 	; mono & 8 bit
   839                              <1> 	lodsb
   840                              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   841                              <1> 	stosw	; left channel
   842                              <1> 	stosw	; right channel
   843                              <1> 	loop	lff_2
   844                              <1> 	jmp	short lff_6	
   845                              <1> lff_3:
   846                              <1> 	; stereo & 8 bit
   847                              <1> 	lodsb
   848                              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   849                              <1> 	stosw
   850                              <1> 	loop	lff_3			
   851                              <1> 	jmp	short lff_6
   852                              <1> lff_4:
   853                              <1> 	; 16 bit mono samples
   854                              <1> 	mov	cx, ax ; word count
   855                              <1> lff_5:	
   856                              <1> 	lodsw
   857                              <1> 	stosw	; left channel
   858                              <1> 	stosw	; right channel
   859                              <1> 	loop	lff_5
   860                              <1> lff_6:
   861                              <1> 	mov	ax, di ; save next buffer offset/position
   862                              <1> 	; 06/11/2023
   863                              <1> 	;pop	si
   864                              <1> 	;pop	di
   865                              <1> 	pop	es
   866                              <1> ;lff_7:        
   867                              <1> 	; 06/11/2023
   868                              <1> 	and	ax, ax
   869                              <1> 	jz	short endLFF ; end of 2nd half
   870                              <1> 	mov	cx, (BUFFERSIZE / 2)
   871                              <1> lff_7:
   872                              <1> 	cmp	ax, cx
   873                              <1> 	je	short endLFF	 ; 06/11/2023
   874                              <1> 	;jb	short lff_11
   875                              <1> 	;xor	cx, cx
   876                              <1> 	;sub	cx, ax
   877                              <1> 	;neg	cx
   878                              <1> 	jmp	short lff_11
   879                              <1> lff_8:
   880                              <1> 	; 07/11/2023
   881                              <1> 	cmp	word [fbs_off], (BUFFERSIZE / 2) ; 32768
   882                              <1> 	jnb	short endLFF
   883                              <1> 	
   884                              <1> 	mov	dx, ax ; buffer offset
   885                              <1> 	mov	ax, [fbs_seg] ; buffer segment
   886                              <1> 	jmp	lff_0
   887                              <1> lff_9:  
   888                              <1> 	; 07/11/2023
   889                              <1> 	;; 06/11/2023 (temporary)
   890                              <1> 	;mov	al, '!'  ; error
   891                              <1> 	;call	tL0
   892                              <1> 
   893                              <1> 	xor	ax, ax
   894                              <1> lff_10:
   895                              <1> 	; 07/11/2023
   896                              <1> 	;mov	cx, (BUFFERSIZE / 2)  
   897                              <1> lff_11:
   898                              <1> 	call    padfill				; blank pad the remainder
   899                              <1>         ;clc					; don't exit with CY yet.
   900                              <1>         or	byte [flags], ENDOFFILE		; end of file flag
   901                              <1> endLFF:
   902                              <1>         ;pop	ds
   903                              <1> 	;pop	es
   904                              <1> 	; 06/11/2023
   905                              <1> 	;pop	bx
   906                              <1> 	;pop	dx
   907                              <1>         ;pop	cx
   908                              <1>         ;pop	ax
   909                              <1>         retn
   910                              <1> 
   911                              <1> %endif
   912                              <1> 
   913                              <1> ; 08/11/2023
   914                              <1> ; 07/11/2023
   915                              <1> %if 1
   916                              <1> 
   917                              <1> loadFromFile:
   918                              <1> 	; 07/11/2023
   919                              <1> 
   920 0000072B F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
   921                              <1> 					; last of the file?
   922 00000730 7402                <1> 	jz	short lff_0		; no
   923 00000732 F9                  <1> 	stc
   924 00000733 C3                  <1> 	retn
   925                              <1> 
   926                              <1> lff_0:
   927                              <1> 	; 08/11/2023
   928 00000734 89C5                <1> 	mov	bp, ax ; save buffer segment	
   929                              <1> 
   930 00000736 8A0E[701D]          <1> 	mov	cl, [fbs_shift]   
   931 0000073A 20C9                <1> 	and	cl, cl
   932 0000073C 7467                <1> 	jz	short lff_1 ; stereo, 16 bit	
   933                              <1> 
   934 0000073E BFFFFF              <1> 	mov	di, BUFFERSIZE - 1 ; 65535
   935                              <1> 
   936                              <1> 	; fbs_shift =
   937                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   938                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   939 00000741 D3EF                <1> 	shr	di, cl
   940 00000743 47                  <1> 	inc	di ; 16384 for 8 bit and mono	
   941                              <1> 		   ; 32768 for 8 bit or mono	
   942                              <1> 
   943 00000744 8CC8                <1> 	mov	ax, cs
   944 00000746 BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   945                              <1> 
   946                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   947                              <1> 	; load file into memory
   948 00000749 89F9                <1>         mov	cx, di                       
   949 0000074B 8B1E[541D]          <1> 	mov	bx, [filehandle]
   950 0000074F 8ED8                <1> 	mov     ds, ax
   951 00000751 B43F                <1>        	mov	ah, 3Fh
   952 00000753 CD21                <1> 	int	21h
   953                              <1> 
   954 00000755 8CCB                <1> 	mov	bx, cs
   955 00000757 8EDB                <1> 	mov	ds, bx
   956                              <1> 
   957 00000759 727C                <1> 	jc	short lff_4 ; error !
   958                              <1> 
   959                              <1> 	; 08/11/2023
   960 0000075B 31D2                <1> 	xor	dx, dx ; 0
   961                              <1> 
   962 0000075D 21C0                <1> 	and	ax, ax
   963 0000075F 746D                <1> 	jz	short lff_3
   964                              <1> 
   965 00000761 8A1E[701D]          <1> 	mov	bl, [fbs_shift]
   966                              <1> 
   967 00000765 06                  <1> 	push	es
   968 00000766 89D7                <1> 	mov	di, dx ; 0 ; [fbs_off]
   969                              <1> 	;mov	bp, [fbs_seg] ; buffer segment
   970 00000768 8EC5                <1> 	mov	es, bp
   971 0000076A BE[721D]            <1> 	mov	si, temp_buffer ; temporary buffer address
   972 0000076D 89C1                <1> 	mov	cx, ax ; byte count
   973 0000076F 803E[6E1D]08        <1> 	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   974 00000774 751B                <1> 	jne	short lff_7 ; 16 bit samples
   975                              <1> 	; 8 bit samples
   976 00000776 FECB                <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   977 00000778 740C                <1> 	jz	short lff_6 ; 8 bit, stereo
   978                              <1> lff_5:
   979                              <1> 	; mono & 8 bit
   980 0000077A AC                  <1> 	lodsb
   981 0000077B 2C80                <1> 	sub	al, 80h ; 08/11/2023
   982 0000077D C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   983 00000780 AB                  <1> 	stosw	; left channel
   984 00000781 AB                  <1> 	stosw	; right channel
   985 00000782 E2F6                <1> 	loop	lff_5
   986 00000784 EB12                <1> 	jmp	short lff_9	
   987                              <1> lff_6:
   988                              <1> 	; stereo & 8 bit
   989 00000786 AC                  <1> 	lodsb
   990 00000787 2C80                <1> 	sub	al, 80h ; 08/11/2023
   991 00000789 C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   992 0000078C AB                  <1> 	stosw
   993 0000078D E2F7                <1> 	loop	lff_6			
   994 0000078F EB07                <1> 	jmp	short lff_9
   995                              <1> lff_7:
   996 00000791 D1E9                <1> 	shr	cx, 1 ; word count
   997                              <1> lff_8:
   998 00000793 AD                  <1> 	lodsw
   999 00000794 AB                  <1> 	stosw	; left channel
  1000 00000795 AB                  <1> 	stosw	; right channel
  1001 00000796 E2FB                <1> 	loop	lff_8
  1002                              <1> lff_9:
  1003 00000798 07                  <1> 	pop	es
  1004 00000799 09FF                <1> 	or	di, di
  1005 0000079B 7439                <1> 	jz	short endLFF ; 64KB ok 
  1006                              <1> 	
  1007 0000079D 89F8                <1> 	mov	ax, di ; [fbs_off]
  1008 0000079F 48                  <1> 	dec	ax
  1009 000007A0 B9FFFF              <1> 	mov	cx, BUFFERSIZE - 1 ; 65535
  1010 000007A3 EB29                <1> 	jmp	short lff_3
  1011                              <1> 	
  1012                              <1> lff_1:  
  1013                              <1> 	;mov	bp, ax ; save buffer segment
  1014 000007A5 31D2                <1> 	xor	dx, dx
  1015                              <1> 	; load file into memory
  1016 000007A7 B90080              <1>         mov	cx, (BUFFERSIZE / 2)	; 32k chunk
  1017 000007AA 8B1E[541D]          <1> 	mov	bx, [filehandle]
  1018 000007AE 8ED8                <1> 	mov     ds, ax
  1019 000007B0 B43F                <1>        	mov	ah, 3Fh
  1020 000007B2 CD21                <1> 	int	21h
  1021                              <1> 
  1022 000007B4 8CCF                <1> 	mov	di, cs
  1023 000007B6 8EDF                <1> 	mov	ds, di
  1024                              <1> 
  1025                              <1> 	; 07/11/2023
  1026 000007B8 721D                <1> 	jc	short lff_4 ; error !
  1027                              <1> 	
  1028 000007BA 39C8                <1> 	cmp	ax, cx
  1029 000007BC 7510                <1> 	jne	short lff_3
  1030                              <1> lff_2:
  1031                              <1> 	; 08/11/2023
  1032 000007BE 01C2                <1> 	add	dx, ax
  1033                              <1> 	;mov	cx, (BUFFERSIZE / 2)	; 32k chunk
  1034                              <1> 	;mov	bx, [filehandle]
  1035 000007C0 8EDD                <1> 	mov     ds, bp
  1036 000007C2 B43F                <1>        	mov	ah, 3Fh
  1037 000007C4 CD21                <1> 	int	21h
  1038                              <1> 
  1039                              <1> 	;mov	di, cs
  1040 000007C6 8EDF                <1> 	mov	ds, di
  1041                              <1> 
  1042 000007C8 720D                <1> 	jc	short lff_4 ; error !
  1043                              <1> 
  1044 000007CA 39C8                <1> 	cmp	ax, cx
  1045 000007CC 7408                <1> 	je	short endLFF
  1046                              <1> lff_3:
  1047 000007CE E80F00              <1> 	call    padfill			; blank pad the remainder
  1048                              <1>         ;clc				; don't exit with CY yet.
  1049 000007D1 800E[561D]01        <1>         or	byte [flags], ENDOFFILE	; end of file flag
  1050                              <1> endLFF:
  1051 000007D6 C3                  <1>         retn
  1052                              <1> lff_4:
  1053                              <1> 	; 08/11/2023
  1054 000007D7 B021                <1> 	mov	al, '!'  ; error
  1055 000007D9 E841FF              <1> 	call	tL0
  1056                              <1> 
  1057 000007DC 31C0                <1> 	xor	ax, ax
  1058 000007DE EBEE                <1> 	jmp	short lff_3
  1059                              <1> 
  1060                              <1> %endif
  1061                              <1> 
  1062                              <1> ; entry ds:ax points to last byte in file
  1063                              <1> ; cx=target size
  1064                              <1> ; note: must do byte size fill
  1065                              <1> ; destroys bx, cx
  1066                              <1> ;
  1067                              <1> padfill:
  1068                              <1> 	; 07/11/2023
  1069                              <1> 	; 06/11/2023
  1070                              <1> 	; 17/02/2017
  1071 000007E0 06                  <1> 	push	es
  1072                              <1>         ;push	di
  1073                              <1> 	;mov	di, [fbs_seg]
  1074                              <1> 	;mov	es, di
  1075 000007E1 8EC5                <1>         mov	es, bp
  1076 000007E3 29C1                <1> 	sub	cx, ax
  1077                              <1> 	; 08/11/2023
  1078                              <1> 	;mov	di, ax ; (wrong)
  1079 000007E5 89D7                <1> 	mov	di, dx ; buffer offset
  1080 000007E7 01C7                <1> 	add	di, ax       	
  1081                              <1> 	; 07/11/2023
  1082                              <1> 	;add	di, [fbs_off]
  1083 000007E9 30C0                <1>         xor	al, al
  1084 000007EB F3AA                <1> 	rep	stosb
  1085                              <1> 	;mov	[fbs_off], di
  1086                              <1> 	;pop	di
  1087 000007ED 07                  <1>         pop	es
  1088 000007EE C3                  <1> 	retn
  1089                              <1> 
  1090                              <1> ; returns AL = current index value
  1091                              <1> getCurrentIndex:
  1092                              <1> 	; 08/11/2023
  1093                              <1> 	;push	dx
  1094 000007EF 8B16[5A1D]          <1> 	mov	dx, [NABMBAR]      		
  1095 000007F3 83C214              <1> 	add	dx, PO_CIV_REG
  1096 000007F6 EC                  <1> 	in	al, dx
  1097                              <1> 	;pop	dx
  1098                              <1> uLVI2:	;	06/11/2023
  1099 000007F7 C3                  <1> 	retn
  1100                              <1> 
  1101                              <1> ; examines the CIV and the LVI. When they're the same, we set LVI <> CIV
  1102                              <1> ; that way, we never run out of buffers to play
  1103                              <1> 
  1104                              <1> ; 08/11/2023
  1105                              <1> %if 0
  1106                              <1> 	; 07/11/2023
  1107                              <1> updateLVI:
  1108                              <1> 	push	ax
  1109                              <1> 	push	dx
  1110                              <1> 	; 06/11/2023
  1111                              <1> 	mov	dx, [NABMBAR]
  1112                              <1> 	add	dx, PO_CIV_REG
  1113                              <1> 	; (Current Index Value and Last Valid Index value)
  1114                              <1> 	in	ax, dx
  1115                              <1> 
  1116                              <1> 	cmp	al, ah ; is current index = last index ?
  1117                              <1> 	jne	short uLVI1
  1118                              <1> 
  1119                              <1> 	call	setNewIndex
  1120                              <1> uLVI1:
  1121                              <1> 	pop	dx
  1122                              <1> 	pop	ax
  1123                              <1> 	retn
  1124                              <1> 
  1125                              <1> setNewIndex:
  1126                              <1> 	; 07/11/2023
  1127                              <1> 	push	ax
  1128                              <1>         call    getCurrentIndex                 ; get CIV
  1129                              <1>         test    byte [flags], ENDOFFILE
  1130                              <1>         jnz     short sni_1
  1131                              <1>         ; not at the end of the file yet.
  1132                              <1>         dec     al                              ; make new index <> current
  1133                              <1>         and     al, INDEX_MASK                  ; make sure new value is 0-31
  1134                              <1> sni_1:
  1135                              <1>         call    setLastValidIndex               ; write new value
  1136                              <1>         clc
  1137                              <1>         pop	ax
  1138                              <1> 	retn
  1139                              <1> 
  1140                              <1> %endif	
  1141                              <1> 
  1142                              <1> ; 08/11/2023
  1143                              <1> ; 07/11/2023
  1144                              <1> ;%if 1
  1145                              <1> updateLVI:
  1146                              <1> 	; 06/11/2023
  1147 000007F8 8B16[5A1D]          <1> 	mov	dx, [NABMBAR]      		
  1148 000007FC 83C214              <1> 	add	dx, PO_CIV_REG
  1149                              <1> 	; (Current Index Value and Last Valid Index value)
  1150 000007FF ED                  <1> 	in	ax, dx
  1151                              <1> 
  1152 00000800 38E0                <1> 	cmp	al, ah ; is current index = last index ?
  1153 00000802 75F3                <1> 	jne	short uLVI2
  1154                              <1> 
  1155                              <1> 	; 08/11/2023	
  1156 00000804 E8E8FF              <1> 	call	getCurrentIndex
  1157                              <1>  
  1158 00000807 F606[561D]01        <1> 	test	byte [flags], ENDOFFILE
  1159                              <1> 	;jnz	short uLVI1
  1160 0000080C 7411                <1> 	jz	short uLVI0  ; 08/11/2023
  1161                              <1> 
  1162                              <1> 	; 08/11/2023
  1163 0000080E 50                  <1> 	push	ax
  1164 0000080F 8B16[5A1D]          <1> 	mov	dx, [NABMBAR]
  1165 00000813 83C216              <1> 	add	dx, PO_SR_REG  ; PCM out status register
  1166 00000816 ED                  <1> 	in	ax, dx
  1167                              <1> 
  1168 00000817 A803                <1> 	test	al, 3 ; bit 1 = Current Equals Last Valid (CELV)
  1169                              <1> 		      ; (has been processed)
  1170                              <1> 		      ; bit 0 = 1 -> DMA Controller Halted (DCH)
  1171 00000819 58                  <1> 	pop	ax
  1172 0000081A 7407                <1> 	jz	short uLVI1
  1173                              <1> uLVI3:
  1174 0000081C 31C0                <1> 	xor	ax, ax
  1175                              <1> 	; zf = 1
  1176 0000081E C3                  <1> 	retn
  1177                              <1> uLVI0:
  1178                              <1>         ; not at the end of the file yet.
  1179 0000081F FEC8                <1> 	dec	al
  1180 00000821 241F                <1> 	and	al, 1Fh
  1181                              <1> uLVI1:
  1182                              <1> 	;call	setLastValidIndex
  1183                              <1> ;uLVI2:
  1184                              <1> 	;retn
  1185                              <1> 
  1186                              <1> ;%endif
  1187                              <1> 	
  1188                              <1> ;input AL = index # to stop on
  1189                              <1> setLastValidIndex:
  1190                              <1> 	; 08/11/2023
  1191                              <1> 	;push	dx
  1192 00000823 8B16[5A1D]          <1> 	mov	dx, [NABMBAR]
  1193 00000827 83C215              <1> 	add	dx, PO_LVI_REG
  1194 0000082A EE                  <1>         out     dx, al
  1195                              <1> 	;pop	dx
  1196 0000082B C3                  <1> 	retn
  1197                              <1> 
  1198                              <1> ; 06/11/2023
  1199                              <1> ;	; 05/11/2023
  1200                              <1> ;setCurrentIndex:
  1201                              <1> ;	;push	dx
  1202                              <1> ;	mov	dx, [NABMBAR]
  1203                              <1> ;	add	dx, PO_CIV_REG
  1204                              <1> ;	out	dx, al
  1205                              <1> ;	;pop	dx
  1206                              <1> ;	retn
  1207                              <1> 
  1208                              <1> ; checks if either shift key has been pressed. Exits with CY if so.
  1209                              <1> ; 
  1210                              <1> check4keyboardstop:
  1211                              <1> 
  1212                              <1> ; 06/11/2023
  1213                              <1> %if 1
  1214                              <1> 	; 19/05/2024
  1215                              <1> 	; 08/11/2023
  1216                              <1> 	; 04/11/2023
  1217 0000082C B401                <1> 	mov	ah, 1
  1218 0000082E CD16                <1> 	int	16h
  1219 00000830 743C                <1> 	jz	short _cksr
  1220                              <1> 
  1221 00000832 30E4                <1> 	xor	ah, ah
  1222 00000834 CD16                <1> 	int	16h
  1223                              <1> 
  1224                              <1> 	;;;
  1225                              <1> 	; 19/05/2024 (change PCM out volume)
  1226 00000836 3C2B                <1> 	cmp	al, '+'
  1227 00000838 750B                <1> 	jne	short p_1
  1228                              <1> 	
  1229 0000083A A0[6F08]            <1> 	mov	al, [volume]
  1230 0000083D 3C00                <1> 	cmp	al, 0
  1231 0000083F 762B                <1> 	jna	short p_3
  1232 00000841 FEC8                <1> 	dec	al
  1233 00000843 EB0D                <1> 	jmp	short p_2
  1234                              <1> p_1:
  1235 00000845 3C2D                <1> 	cmp	al, '-'
  1236 00000847 7524                <1> 	jne	short p_4
  1237                              <1> 
  1238 00000849 A0[6F08]            <1> 	mov	al, [volume]
  1239 0000084C 3C1F                <1> 	cmp	al, 31
  1240 0000084E 731C                <1> 	jnb	short p_3
  1241 00000850 FEC0                <1> 	inc	al
  1242                              <1> p_2:
  1243 00000852 A2[6F08]            <1> 	mov	[volume], al
  1244 00000855 88C4                <1> 	mov	ah, al
  1245 00000857 8B16[581D]          <1> 	mov     dx, [NAMBAR]
  1246                              <1>   	;add    dx, CODEC_MASTER_VOL_REG
  1247 0000085B 83C218              <1> 	add	dx, CODEC_PCM_OUT_REG
  1248 0000085E EF                  <1> 	out     dx, ax
  1249                              <1> 
  1250 0000085F E81411              <1> 	call    delay1_4ms
  1251 00000862 E81111              <1>         call    delay1_4ms
  1252 00000865 E80E11              <1>         call    delay1_4ms
  1253 00000868 E80B11              <1>         call    delay1_4ms
  1254                              <1> 
  1255 0000086B F8                  <1> 	clc
  1256                              <1> p_3:
  1257 0000086C C3                  <1> 	retn
  1258                              <1> p_4:
  1259                              <1> 	;;;
  1260                              <1> 	
  1261 0000086D F9                  <1> 	stc
  1262                              <1> _cksr:
  1263 0000086E C3                  <1> 	retn
  1264                              <1> 
  1265                              <1> ; 19/05/2024
  1266 0000086F 00                  <1> volume:	db 0
  1267                              <1> 
  1268                              <1> %endif
  1269                              <1> 
  1270                              <1> ; 18/11/2023 (ich_wav3.asm & ich_wav4.asm)
  1271                              <1> ; 15/11/2023 (ich_wav3.asm)	
  1272                              <1> ; 14/11/2023
  1273                              <1> ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  1274                              <1> ; --------------------------------------------------------
  1275                              <1> 
  1276                              <1> ;;Note:	At the end of every buffer load,
  1277                              <1> ;;	during buffer switch/swap, there will be discontinuity
  1278                              <1> ;;	between the last converted sample and the 1st sample
  1279                              <1> ;;	of the next buffer.
  1280                              <1> ;;	(like as a dot noises vaguely between normal sound samples)
  1281                              <1> ;;	-To avoid this defect, the 1st sample of
  1282                              <1> ;;	the next buffer may be read from the wav file but
  1283                              <1> ;;	the file pointer would need to be set to 1 sample back
  1284                              <1> ;;	again via seek system call. Time comsumption problem! -
  1285                              <1> ;;
  1286                              <1> ;;	Erdogan Tan - 15/11/2023
  1287                              <1> ;;
  1288                              <1> ;;	((If entire wav data would be loaded at once.. conversion
  1289                              <1> ;;	defect/noise would disappear.. but for DOS, to keep
  1290                              <1> ;;	64KB buffer limit is important also it is important
  1291                              <1> ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  1292                              <1> ;;	I have tested this program by using 2-30MB wav files.))
  1293                              <1> ;;
  1294                              <1> ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  1295                              <1> ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  1296                              <1> ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  1297                              <1> ;;			Realtek ALC850 codec.
  1298                              <1> ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  1299                              <1> 
  1300                              <1> load_8khz_mono_8_bit:
  1301                              <1> 	; 15/11/2023
  1302                              <1> 	; 14/11/2023
  1303                              <1> 	; 13/11/2023
  1304 00000870 F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1305                              <1> 					; last of the file?
  1306 00000875 7402                <1> 	jz	short lff8m_0		; no
  1307 00000877 F9                  <1> 	stc
  1308 00000878 C3                  <1> 	retn
  1309                              <1> 
  1310                              <1> lff8m_0:
  1311 00000879 8EC0                <1> 	mov	es, ax ; buffer segment	
  1312 0000087B 31FF                <1> 	xor	di, di
  1313 0000087D BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1314                              <1> 	; ds = cs
  1315                              <1> 
  1316                              <1> 	; load file into memory
  1317 00000880 8B0E[4D06]          <1>         mov	cx, [loadsize]
  1318 00000884 8B1E[541D]          <1> 	mov	bx, [filehandle]
  1319 00000888 B43F                <1>        	mov	ah, 3Fh
  1320 0000088A CD21                <1> 	int	21h
  1321                              <1> 	;jc	short lff8m_5 ; error !
  1322                              <1> 	; 14/11/2023
  1323 0000088C 7303                <1> 	jnc	short lff8m_6
  1324 0000088E E98B00              <1> 	jmp	lff8m_5
  1325                              <1> 
  1326                              <1> lff8m_6:
  1327 00000891 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1328 00000893 21C0                <1> 	and	ax, ax
  1329                              <1> 	;jz	short lff8m_3
  1330                              <1> 	; 15/11/2023
  1331 00000895 747E                <1> 	jz	short lff8_eof
  1332                              <1> 
  1333 00000897 89C1                <1> 	mov	cx, ax		; byte count
  1334                              <1> lff8m_1:
  1335 00000899 AC                  <1> 	lodsb
  1336 0000089A A2[6D19]            <1> 	mov	[previous_val], al
  1337 0000089D 2C80                <1> 	sub	al, 80h
  1338 0000089F C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1339 000008A2 AB                  <1> 	stosw		; original sample (left channel)
  1340 000008A3 AB                  <1> 	stosw		; original sample (right channel)
  1341                              <1> 	;xor	ax, ax
  1342                              <1> 	; 14/11/2023
  1343 000008A4 B080                <1> 	mov	al, 80h
  1344 000008A6 49                  <1> 	dec	cx
  1345 000008A7 7402                <1> 	jz	short lff8m_2
  1346 000008A9 8A04                <1> 	mov	al, [si]
  1347                              <1> lff8m_2:
  1348                              <1> 	;mov	[next_val], ax
  1349 000008AB 88C7                <1> 	mov	bh, al	; [next_val]
  1350 000008AD 8A26[6D19]          <1> 	mov	ah, [previous_val]
  1351 000008B1 00E0                <1> 	add	al, ah	; [previous_val]
  1352 000008B3 D0D8                <1> 	rcr	al, 1
  1353 000008B5 88C2                <1> 	mov	dl, al	; this is interpolated middle (3th) sample
  1354 000008B7 00E0                <1> 	add	al, ah	; [previous_val]
  1355 000008B9 D0D8                <1> 	rcr	al, 1	
  1356 000008BB 88C3                <1> 	mov	bl, al 	; this is temporary interpolation value	
  1357 000008BD 00E0                <1> 	add	al, ah	; [previous_val]
  1358 000008BF D0D8                <1> 	rcr	al, 1
  1359 000008C1 2C80                <1> 	sub	al, 80h
  1360 000008C3 C1E008              <1> 	shl	ax, 8	
  1361 000008C6 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1362 000008C7 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1363 000008C8 88D8                <1> 	mov	al, bl
  1364 000008CA 00D0                <1> 	add	al, dl
  1365 000008CC D0D8                <1> 	rcr	al, 1
  1366 000008CE 2C80                <1> 	sub	al, 80h
  1367 000008D0 C1E008              <1> 	shl	ax, 8
  1368 000008D3 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1369 000008D4 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1370 000008D5 88D0                <1> 	mov	al, dl
  1371 000008D7 2C80                <1> 	sub	al, 80h
  1372 000008D9 C1E008              <1> 	shl	ax, 8
  1373 000008DC AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1374 000008DD AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1375                              <1> 	;mov	al, [next_val]
  1376 000008DE 88F8                <1> 	mov	al, bh
  1377 000008E0 00D0                <1> 	add	al, dl
  1378 000008E2 D0D8                <1> 	rcr	al, 1
  1379 000008E4 88C3                <1> 	mov	bl, al	; this is temporary interpolation value
  1380 000008E6 00D0                <1> 	add	al, dl
  1381 000008E8 D0D8                <1> 	rcr	al, 1
  1382 000008EA 2C80                <1> 	sub	al, 80h
  1383 000008EC C1E008              <1> 	shl	ax, 8
  1384 000008EF AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1385 000008F0 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1386                              <1> 	;mov	al, [next_val]
  1387 000008F1 88F8                <1> 	mov	al, bh
  1388 000008F3 00D8                <1> 	add	al, bl
  1389 000008F5 D0D8                <1> 	rcr	al, 1
  1390 000008F7 2C80                <1> 	sub	al, 80h
  1391 000008F9 C1E008              <1> 	shl	ax, 8
  1392 000008FC AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1393 000008FD AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1394                              <1> 	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1395 000008FE 09C9                <1> 	or	cx, cx
  1396 00000900 7597                <1> 	jnz	short lff8m_1
  1397                              <1> 
  1398                              <1> 	; --------------
  1399                              <1> 
  1400                              <1> lff8s_3:
  1401                              <1> lff8m_3:
  1402                              <1> lff8s2_3:
  1403                              <1> lff8m2_3:
  1404                              <1> lff16s_3:
  1405                              <1> lff16m_3:
  1406                              <1> lff16s2_3:
  1407                              <1> lff16m2_3:
  1408                              <1> lff24_3:
  1409                              <1> lff32_3:
  1410                              <1> lff44_3:
  1411                              <1> lff22_3:
  1412                              <1> lff11_3:
  1413 00000902 8B0E[4F06]          <1> 	mov	cx, [buffersize] ; 16 bit (48 kHZ, stereo) sample size
  1414 00000906 D1E1                <1> 	shl	cx, 1	; byte count
  1415 00000908 29F9                <1> 	sub	cx, di
  1416 0000090A 7606                <1> 	jna	short lff8m_4
  1417                              <1> 	;inc	cx
  1418 0000090C D1E9                <1> 	shr	cx, 1
  1419 0000090E 31C0                <1> 	xor	ax, ax	; fill (remain part of) buffer with zeros	
  1420 00000910 F3AB                <1> 	rep	stosw
  1421                              <1> lff8m_4:
  1422 00000912 0E                  <1> 	push	cs
  1423 00000913 07                  <1> 	pop	es
  1424 00000914 C3                  <1> 	retn
  1425                              <1> 
  1426                              <1> lff8_eof:
  1427                              <1> lff16_eof:
  1428                              <1> lff24_eof:
  1429                              <1> lff32_eof:
  1430                              <1> lff44_eof:
  1431                              <1> lff22_eof:
  1432                              <1> lff11_eof:
  1433                              <1> 	; 15/11/2023
  1434 00000915 C606[561D]01        <1> 	mov	byte [flags], ENDOFFILE
  1435 0000091A EBE6                <1> 	jmp	short lff8m_3
  1436                              <1> 
  1437                              <1> lff8s_5:
  1438                              <1> lff8m_5:
  1439                              <1> lff8s2_5:
  1440                              <1> lff8m2_5:
  1441                              <1> lff16s_5:
  1442                              <1> lff16m_5:
  1443                              <1> lff16s2_5:
  1444                              <1> lff16m2_5:
  1445                              <1> lff24_5:
  1446                              <1> lff32_5:
  1447                              <1> lff44_5:
  1448                              <1> lff22_5:
  1449                              <1> lff11_5:
  1450 0000091C B021                <1> 	mov	al, '!'  ; error
  1451 0000091E E8FCFD              <1> 	call	tL0
  1452                              <1> 	
  1453                              <1> 	;jmp	short lff8m_3
  1454                              <1> 	; 15/11/2023
  1455 00000921 EBF2                <1> 	jmp	lff8_eof
  1456                              <1> 
  1457                              <1> 	; --------------
  1458                              <1> 
  1459                              <1> load_8khz_stereo_8_bit:
  1460                              <1> 	; 15/11/2023
  1461                              <1> 	; 14/11/2023
  1462                              <1> 	; 13/11/2023
  1463 00000923 F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1464                              <1> 					; last of the file?
  1465 00000928 7402                <1> 	jz	short lff8s_0		; no
  1466 0000092A F9                  <1> 	stc
  1467 0000092B C3                  <1> 	retn
  1468                              <1> 
  1469                              <1> lff8s_0:
  1470 0000092C 8EC0                <1> 	mov	es, ax ; buffer segment	
  1471 0000092E 31FF                <1> 	xor	di, di
  1472 00000930 BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1473                              <1> 	; ds = cs
  1474                              <1> 
  1475                              <1> 	; load file into memory
  1476 00000933 8B0E[4D06]          <1>         mov	cx, [loadsize]
  1477 00000937 8B1E[541D]          <1> 	mov	bx, [filehandle]
  1478 0000093B B43F                <1>        	mov	ah, 3Fh
  1479 0000093D CD21                <1> 	int	21h
  1480 0000093F 72DB                <1> 	jc	short lff8s_5 ; error !
  1481                              <1> 
  1482 00000941 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1483                              <1> 	
  1484 00000943 D1E8                <1> 	shr	ax, 1
  1485                              <1> 	;;and	ax, ax
  1486                              <1> 	;jz	short lff8s_3
  1487                              <1> 	; 15/11/2023
  1488 00000945 74CE                <1> 	jz	short lff8_eof
  1489                              <1> 
  1490 00000947 89C1                <1> 	mov	cx, ax		; word count
  1491                              <1> lff8s_1:
  1492 00000949 AC                  <1> 	lodsb
  1493 0000094A A2[6D19]            <1> 	mov	[previous_val_l], al
  1494 0000094D 2C80                <1> 	sub	al, 80h
  1495 0000094F C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1496 00000952 AB                  <1> 	stosw		; original sample (L)
  1497 00000953 AC                  <1> 	lodsb
  1498 00000954 A2[6F19]            <1> 	mov	[previous_val_r], al
  1499 00000957 2C80                <1> 	sub	al, 80h
  1500 00000959 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1501 0000095C AB                  <1> 	stosw		; original sample (R)
  1502                              <1> 
  1503                              <1> 	;xor	ax, ax
  1504                              <1> 	; 14/11/2023
  1505 0000095D B88080              <1> 	mov	ax, 8080h
  1506 00000960 49                  <1> 	dec	cx
  1507 00000961 7402                <1> 	jz	short lff8s_2
  1508                              <1> 		; convert 8 bit sample to 16 bit sample
  1509 00000963 8B04                <1> 	mov	ax, [si]
  1510                              <1> lff8s_2:
  1511 00000965 A2[7119]            <1> 	mov	[next_val_l], al
  1512 00000968 8826[7319]          <1> 	mov	[next_val_r], ah
  1513 0000096C 8A26[6D19]          <1> 	mov	ah, [previous_val_l]
  1514 00000970 00E0                <1> 	add	al, ah
  1515 00000972 D0D8                <1> 	rcr	al, 1
  1516 00000974 88C2                <1> 	mov	dl, al	; this is interpolated middle (3th) sample (L)
  1517 00000976 00E0                <1> 	add	al, ah
  1518 00000978 D0D8                <1> 	rcr	al, 1	
  1519 0000097A 88C3                <1> 	mov	bl, al	; this is temporary interpolation value (L)
  1520 0000097C 00E0                <1> 	add	al, ah
  1521 0000097E D0D8                <1> 	rcr	al, 1
  1522 00000980 2C80                <1> 	sub	al, 80h
  1523 00000982 C1E008              <1> 	shl	ax, 8
  1524 00000985 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1525 00000986 A0[7319]            <1> 	mov	al, [next_val_r]
  1526 00000989 8A26[6F19]          <1> 	mov	ah, [previous_val_r]
  1527 0000098D 00E0                <1> 	add	al, ah
  1528 0000098F D0D8                <1> 	rcr	al, 1
  1529 00000991 88C6                <1> 	mov	dh, al	; this is interpolated middle (3th) sample (R)
  1530 00000993 00E0                <1> 	add	al, ah
  1531 00000995 D0D8                <1> 	rcr	al, 1
  1532 00000997 88C7                <1> 	mov	bh, al	; this is temporary interpolation value (R)
  1533 00000999 00E0                <1> 	add	al, ah
  1534 0000099B D0D8                <1> 	rcr	al, 1
  1535 0000099D 2C80                <1> 	sub	al, 80h
  1536 0000099F C1E008              <1> 	shl	ax, 8
  1537 000009A2 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1538 000009A3 88D8                <1> 	mov	al, bl
  1539 000009A5 00D0                <1> 	add	al, dl
  1540 000009A7 D0D8                <1> 	rcr	al, 1
  1541 000009A9 2C80                <1> 	sub	al, 80h
  1542 000009AB C1E008              <1> 	shl	ax, 8
  1543 000009AE AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1544 000009AF 88F8                <1> 	mov	al, bh
  1545 000009B1 00F0                <1> 	add	al, dh
  1546 000009B3 D0D8                <1> 	rcr	al, 1
  1547 000009B5 2C80                <1> 	sub	al, 80h
  1548 000009B7 C1E008              <1> 	shl	ax, 8
  1549 000009BA AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1550 000009BB 88D0                <1> 	mov	al, dl
  1551 000009BD 2C80                <1> 	sub	al, 80h
  1552 000009BF C1E008              <1> 	shl	ax, 8
  1553 000009C2 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1554 000009C3 88F0                <1> 	mov	al, dh
  1555 000009C5 2C80                <1> 	sub	al, 80h
  1556 000009C7 C1E008              <1> 	shl	ax, 8
  1557 000009CA AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1558 000009CB A0[7119]            <1> 	mov	al, [next_val_l]
  1559 000009CE 00D0                <1> 	add	al, dl
  1560 000009D0 D0D8                <1> 	rcr	al, 1
  1561 000009D2 88C3                <1> 	mov	bl, al	; this is temporary interpolation value (L)
  1562 000009D4 00D0                <1> 	add	al, dl
  1563 000009D6 D0D8                <1> 	rcr	al, 1
  1564 000009D8 2C80                <1> 	sub	al, 80h
  1565 000009DA C1E008              <1> 	shl	ax, 8
  1566 000009DD AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1567 000009DE A0[7319]            <1> 	mov	al, [next_val_r]
  1568 000009E1 00F0                <1> 	add	al, dh
  1569 000009E3 D0D8                <1> 	rcr	al, 1
  1570 000009E5 88C7                <1> 	mov	bh, al	; this is temporary interpolation value (R)
  1571 000009E7 00F0                <1> 	add	al, dh
  1572 000009E9 D0D8                <1> 	rcr	al, 1
  1573 000009EB 2C80                <1> 	sub	al, 80h
  1574 000009ED C1E008              <1> 	shl	ax, 8
  1575 000009F0 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1576 000009F1 A0[7119]            <1> 	mov	al, [next_val_l]
  1577 000009F4 00D8                <1> 	add	al, bl
  1578 000009F6 D0D8                <1> 	rcr	al, 1
  1579 000009F8 2C80                <1> 	sub	al, 80h
  1580 000009FA C1E008              <1> 	shl	ax, 8
  1581 000009FD AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1582 000009FE A0[7319]            <1> 	mov	al, [next_val_r]
  1583 00000A01 00F8                <1> 	add	al, bh
  1584 00000A03 D0D8                <1> 	rcr	al, 1
  1585 00000A05 2C80                <1> 	sub	al, 80h
  1586 00000A07 C1E008              <1> 	shl	ax, 8
  1587 00000A0A AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1588                              <1> 	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1589 00000A0B E303                <1> 	jcxz	lff8s_6
  1590 00000A0D E939FF              <1> 	jmp	lff8s_1
  1591                              <1> lff8s_6:
  1592 00000A10 E9EFFE              <1> 	jmp	lff8s_3
  1593                              <1> 
  1594                              <1> load_8khz_mono_16_bit:
  1595                              <1> 	; 13/11/2023
  1596 00000A13 F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1597                              <1> 					; last of the file?
  1598 00000A18 7402                <1> 	jz	short lff8m2_0		; no
  1599 00000A1A F9                  <1> 	stc
  1600 00000A1B C3                  <1> 	retn
  1601                              <1> 
  1602                              <1> lff8m2_0:
  1603 00000A1C 8EC0                <1> 	mov	es, ax ; buffer segment	
  1604 00000A1E 31FF                <1> 	xor	di, di
  1605 00000A20 BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1606                              <1> 	; ds = cs
  1607                              <1> 
  1608                              <1> 	; load file into memory
  1609 00000A23 8B0E[4D06]          <1>         mov	cx, [loadsize]
  1610 00000A27 8B1E[541D]          <1> 	mov	bx, [filehandle]
  1611 00000A2B B43F                <1>        	mov	ah, 3Fh
  1612 00000A2D CD21                <1> 	int	21h
  1613 00000A2F 7270                <1> 	jc	short lff8m2_7 ; error !
  1614                              <1> 
  1615 00000A31 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1616                              <1> 	
  1617 00000A33 D1E8                <1> 	shr	ax, 1
  1618                              <1> 	;and	ax, ax
  1619 00000A35 7503                <1> 	jnz	short lff8m2_8
  1620                              <1> 	;jmp	lff8m2_3
  1621                              <1> 	; 15/11/2023
  1622 00000A37 E9DBFE              <1> 	jmp	lff8_eof
  1623                              <1> 
  1624                              <1> lff8m2_8:
  1625 00000A3A 89C1                <1> 	mov	cx, ax		; word count
  1626                              <1> lff8m2_1:
  1627 00000A3C AD                  <1> 	lodsw
  1628 00000A3D AB                  <1> 	stosw		; original sample (left channel)
  1629 00000A3E AB                  <1> 	stosw		; original sample (right channel)
  1630 00000A3F 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1631 00000A42 A3[6D19]            <1> 	mov	[previous_val], ax
  1632 00000A45 31C0                <1> 	xor	ax, ax
  1633 00000A47 49                  <1> 	dec	cx
  1634 00000A48 7402                <1> 	jz	short lff8m2_2
  1635 00000A4A 8B04                <1> 	mov	ax, [si]
  1636                              <1> lff8m2_2:
  1637 00000A4C 80C480              <1> 	add	ah, 80h ; convert sound level to 0-65535 format
  1638 00000A4F 89C5                <1> 	mov	bp, ax	; [next_val]
  1639 00000A51 0306[6D19]          <1> 	add	ax, [previous_val]
  1640 00000A55 D1D8                <1> 	rcr	ax, 1
  1641 00000A57 89C2                <1> 	mov	dx, ax	; this is interpolated middle (3th) sample
  1642 00000A59 0306[6D19]          <1> 	add	ax, [previous_val]
  1643 00000A5D D1D8                <1> 	rcr	ax, 1	; this is temporary interpolation value
  1644 00000A5F 89C3                <1> 	mov	bx, ax 		
  1645 00000A61 0306[6D19]          <1> 	add	ax, [previous_val]
  1646 00000A65 D1D8                <1> 	rcr	ax, 1
  1647 00000A67 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1648 00000A6A AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1649 00000A6B AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1650 00000A6C 89D8                <1> 	mov	ax, bx
  1651 00000A6E 01D0                <1> 	add	ax, dx
  1652 00000A70 D1D8                <1> 	rcr	ax, 1
  1653 00000A72 80EC80              <1> 	sub	ah, 80h
  1654 00000A75 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1655 00000A76 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1656 00000A77 89D0                <1> 	mov	ax, dx
  1657 00000A79 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1658 00000A7C AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1659 00000A7D AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1660 00000A7E 89E8                <1> 	mov	ax, bp
  1661 00000A80 01D0                <1> 	add	ax, dx
  1662 00000A82 D1D8                <1> 	rcr	ax, 1
  1663 00000A84 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value
  1664 00000A86 01D0                <1> 	add	ax, dx
  1665 00000A88 D1D8                <1> 	rcr	ax, 1
  1666 00000A8A 80EC80              <1> 	sub	ah, 80h
  1667 00000A8D AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1668 00000A8E AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1669 00000A8F 89E8                <1> 	mov	ax, bp
  1670 00000A91 01D8                <1> 	add	ax, bx
  1671 00000A93 D1D8                <1> 	rcr	ax, 1
  1672 00000A95 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1673 00000A98 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1674 00000A99 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1675                              <1> 	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1676 00000A9A 09C9                <1> 	or	cx, cx
  1677 00000A9C 759E                <1> 	jnz	short lff8m2_1
  1678 00000A9E E961FE              <1> 	jmp	lff8m2_3
  1679                              <1> 
  1680                              <1> lff8m2_7:
  1681                              <1> lff8s2_7:
  1682 00000AA1 E978FE              <1> 	jmp	lff8m2_5  ; error
  1683                              <1> 
  1684                              <1> load_8khz_stereo_16_bit:
  1685                              <1> 	; 16/11/2023
  1686                              <1> 	; 15/11/2023
  1687                              <1> 	; 13/11/2023
  1688 00000AA4 F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1689                              <1> 					; last of the file?
  1690 00000AA9 7402                <1> 	jz	short lff8s2_0		; no
  1691 00000AAB F9                  <1> 	stc
  1692 00000AAC C3                  <1> 	retn
  1693                              <1> 
  1694                              <1> lff8s2_0:
  1695 00000AAD 8EC0                <1> 	mov	es, ax ; buffer segment	
  1696 00000AAF 31FF                <1> 	xor	di, di
  1697 00000AB1 BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1698                              <1> 	; ds = cs
  1699                              <1> 
  1700                              <1> 	; load file into memory
  1701 00000AB4 8B0E[4D06]          <1>         mov	cx, [loadsize]
  1702 00000AB8 8B1E[541D]          <1> 	mov	bx, [filehandle]
  1703 00000ABC B43F                <1>        	mov	ah, 3Fh
  1704 00000ABE CD21                <1> 	int	21h
  1705 00000AC0 72DF                <1> 	jc	short lff8s2_7 ; error !
  1706                              <1> 
  1707 00000AC2 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1708                              <1> 	
  1709 00000AC4 C1E802              <1> 	shr	ax, 2	; 16/11/2023
  1710                              <1> 	;and	ax, ax
  1711 00000AC7 7503                <1> 	jnz	short lff8s2_8
  1712                              <1> 	;jmp	lff8s2_3
  1713                              <1> 	; 15/11/2023
  1714 00000AC9 E949FE              <1> 	jmp	lff8_eof
  1715                              <1> 
  1716                              <1> lff8s2_8:
  1717 00000ACC 89C1                <1> 	mov	cx, ax ; dword count
  1718                              <1> lff8s2_1:
  1719 00000ACE AD                  <1> 	lodsw
  1720 00000ACF AB                  <1> 	stosw		; original sample (L)
  1721                              <1> 	; 15/11/2023
  1722 00000AD0 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1723 00000AD3 A3[6D19]            <1> 	mov	[previous_val_l], ax
  1724 00000AD6 AD                  <1> 	lodsw
  1725 00000AD7 AB                  <1> 	stosw		; original sample (R)
  1726 00000AD8 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1727 00000ADB A3[6F19]            <1> 	mov	[previous_val_r], ax
  1728 00000ADE 31D2                <1> 	xor	dx, dx
  1729 00000AE0 31C0                <1> 	xor	ax, ax
  1730                              <1> 	; 16/11/2023
  1731 00000AE2 49                  <1> 	dec	cx
  1732 00000AE3 7405                <1> 	jz	short lff8s2_2
  1733 00000AE5 8B04                <1> 	mov	ax, [si]
  1734 00000AE7 8B5402              <1> 	mov	dx, [si+2]
  1735                              <1> lff8s2_2:
  1736 00000AEA 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1737 00000AED A3[7119]            <1> 	mov	[next_val_l], ax
  1738 00000AF0 80C680              <1> 	add	dh, 80h	; convert sound level to 0-65535 format
  1739 00000AF3 8916[7319]          <1> 	mov	[next_val_r], dx
  1740 00000AF7 0306[6D19]          <1> 	add	ax, [previous_val_l]
  1741 00000AFB D1D8                <1> 	rcr	ax, 1
  1742 00000AFD 89C2                <1> 	mov	dx, ax	; this is interpolated middle (3th) sample (L)
  1743 00000AFF 0306[6D19]          <1> 	add	ax, [previous_val_l]
  1744 00000B03 D1D8                <1> 	rcr	ax, 1	
  1745 00000B05 89C3                <1> 	mov	bx, ax 	; this is temporary interpolation value (L)
  1746 00000B07 0306[6D19]          <1> 	add	ax, [previous_val_l]
  1747 00000B0B D1D8                <1> 	rcr	ax, 1
  1748 00000B0D 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1749 00000B10 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1750 00000B11 A1[7319]            <1> 	mov	ax, [next_val_r]
  1751 00000B14 0306[6F19]          <1> 	add	ax, [previous_val_r]
  1752 00000B18 D1D8                <1> 	rcr	ax, 1
  1753 00000B1A 89C5                <1> 	mov	bp, ax	; this is interpolated middle (3th) sample (R)
  1754 00000B1C 0306[6F19]          <1> 	add	ax, [previous_val_r]
  1755 00000B20 D1D8                <1> 	rcr	ax, 1
  1756 00000B22 50                  <1> 	push	ax ; *	; this is temporary interpolation value (R)
  1757 00000B23 0306[6F19]          <1> 	add	ax, [previous_val_r]
  1758 00000B27 D1D8                <1> 	rcr	ax, 1
  1759 00000B29 80EC80              <1> 	sub	ah, 80h
  1760 00000B2C AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1761 00000B2D 89D8                <1> 	mov	ax, bx
  1762 00000B2F 01D0                <1> 	add	ax, dx
  1763 00000B31 D1D8                <1> 	rcr	ax, 1
  1764 00000B33 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1765 00000B36 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1766 00000B37 58                  <1> 	pop	ax ; *
  1767 00000B38 01E8                <1> 	add	ax, bp
  1768 00000B3A D1D8                <1> 	rcr	ax, 1
  1769 00000B3C 80EC80              <1> 	sub	ah, 80h
  1770 00000B3F AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1771 00000B40 89D0                <1> 	mov	ax, dx
  1772 00000B42 80EC80              <1> 	sub	ah, 80h
  1773 00000B45 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1774 00000B46 89E8                <1> 	mov	ax, bp
  1775 00000B48 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1776 00000B4B AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1777 00000B4C A1[7119]            <1> 	mov	ax, [next_val_l]
  1778 00000B4F 01D0                <1> 	add	ax, dx
  1779 00000B51 D1D8                <1> 	rcr	ax, 1
  1780 00000B53 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value (L)
  1781 00000B55 01D0                <1> 	add	ax, dx
  1782 00000B57 D1D8                <1> 	rcr	ax, 1
  1783 00000B59 80EC80              <1> 	sub	ah, 80h
  1784 00000B5C AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1785 00000B5D A1[7319]            <1> 	mov	ax, [next_val_r]
  1786 00000B60 01E8                <1> 	add	ax, bp
  1787 00000B62 D1D8                <1> 	rcr	ax, 1
  1788 00000B64 50                  <1> 	push	ax ; ** ; this is temporary interpolation value (R)
  1789 00000B65 01E8                <1> 	add	ax, bp
  1790 00000B67 D1D8                <1> 	rcr	ax, 1
  1791 00000B69 80EC80              <1> 	sub	ah, 80h
  1792 00000B6C AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1793 00000B6D A1[7119]            <1> 	mov	ax, [next_val_l]
  1794 00000B70 01D8                <1> 	add	ax, bx
  1795 00000B72 D1D8                <1> 	rcr	ax, 1
  1796 00000B74 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1797 00000B77 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1798 00000B78 58                  <1> 	pop	ax ; **
  1799 00000B79 0306[7319]          <1> 	add	ax, [next_val_r]
  1800 00000B7D D1D8                <1> 	rcr	ax, 1
  1801 00000B7F 80EC80              <1> 	sub	ah, 80h
  1802 00000B82 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1803                              <1> 	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1804 00000B83 E303                <1> 	jcxz	lff8_s2_9
  1805 00000B85 E946FF              <1> 	jmp	lff8s2_1
  1806                              <1> lff8_s2_9:
  1807 00000B88 E977FD              <1> 	jmp	lff8s2_3
  1808                              <1> 
  1809                              <1> ; .....................
  1810                              <1> 
  1811                              <1> load_16khz_mono_8_bit:
  1812                              <1> 	; 14/11/2023
  1813                              <1> 	; 13/11/2023
  1814 00000B8B F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1815                              <1> 					; last of the file?
  1816 00000B90 7402                <1> 	jz	short lff16m_0		; no
  1817 00000B92 F9                  <1> 	stc
  1818 00000B93 C3                  <1> 	retn
  1819                              <1> 
  1820                              <1> lff16m_0:
  1821 00000B94 8EC0                <1> 	mov	es, ax ; buffer segment	
  1822 00000B96 31FF                <1> 	xor	di, di
  1823 00000B98 BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1824                              <1> 	; ds = cs
  1825                              <1> 
  1826                              <1> 	; load file into memory
  1827 00000B9B 8B0E[4D06]          <1>         mov	cx, [loadsize]
  1828 00000B9F 8B1E[541D]          <1> 	mov	bx, [filehandle]
  1829 00000BA3 B43F                <1>        	mov	ah, 3Fh
  1830 00000BA5 CD21                <1> 	int	21h
  1831 00000BA7 7243                <1> 	jc	short lff16m_7 ; error !
  1832                              <1> 
  1833 00000BA9 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1834                              <1> 	
  1835 00000BAB 21C0                <1> 	and	ax, ax
  1836 00000BAD 7503                <1> 	jnz	short lff16m_8
  1837                              <1> 	;jmp	lff16m_3
  1838                              <1> 	; 15/11/2023
  1839 00000BAF E963FD              <1> 	jmp	lff16_eof
  1840                              <1> 
  1841                              <1> lff16m_8:
  1842 00000BB2 89C1                <1> 	mov	cx, ax		; byte count
  1843                              <1> lff16m_1:
  1844 00000BB4 AC                  <1> 	lodsb
  1845                              <1> 	;mov	[previous_val], al
  1846 00000BB5 88C3                <1> 	mov	bl, al
  1847 00000BB7 2C80                <1> 	sub	al, 80h
  1848 00000BB9 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1849 00000BBC AB                  <1> 	stosw		; original sample (left channel)
  1850 00000BBD AB                  <1> 	stosw		; original sample (right channel)
  1851                              <1> 	;xor	ax, ax
  1852                              <1> 	; 14/11/22023
  1853 00000BBE B080                <1> 	mov	al, 80h
  1854 00000BC0 49                  <1> 	dec	cx
  1855 00000BC1 7402                <1> 	jz	short lff16m_2
  1856 00000BC3 8A04                <1> 	mov	al, [si]
  1857                              <1> lff16m_2:
  1858                              <1> 	;mov	[next_val], al
  1859 00000BC5 88C7                <1> 	mov	bh, al
  1860                              <1> 	;add	al, [previous_val]
  1861 00000BC7 00D8                <1> 	add	al, bl
  1862 00000BC9 D0D8                <1> 	rcr	al, 1
  1863 00000BCB 88C2                <1> 	mov	dl, al	; this is interpolated middle (temp) sample
  1864                              <1> 	;add	al, [previous_val]
  1865 00000BCD 00D8                <1> 	add	al, bl
  1866 00000BCF D0D8                <1> 	rcr	al, 1
  1867 00000BD1 2C80                <1> 	sub	al, 80h
  1868 00000BD3 C1E008              <1> 	shl	ax, 8
  1869 00000BD6 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1870 00000BD7 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1871                              <1> 	;mov	al, [next_val]
  1872 00000BD8 88F8                <1> 	mov	al, bh
  1873 00000BDA 00D0                <1> 	add	al, dl
  1874 00000BDC D0D8                <1> 	rcr	al, 1
  1875 00000BDE 2C80                <1> 	sub	al, 80h
  1876 00000BE0 C1E008              <1> 	shl	ax, 8
  1877 00000BE3 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1878 00000BE4 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1879                              <1> 	
  1880                              <1> 	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1881 00000BE5 09C9                <1> 	or	cx, cx
  1882 00000BE7 75CB                <1> 	jnz	short lff16m_1
  1883 00000BE9 E916FD              <1> 	jmp	lff16m_3
  1884                              <1> 
  1885                              <1> lff16m_7:
  1886                              <1> lff16s_7:
  1887 00000BEC E92DFD              <1> 	jmp	lff16m_5  ; error
  1888                              <1> 
  1889                              <1> load_16khz_stereo_8_bit:
  1890                              <1> 	; 14/11/2023
  1891                              <1> 	; 13/11/2023
  1892 00000BEF F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1893                              <1> 					; last of the file?
  1894 00000BF4 7402                <1> 	jz	short lff16s_0		; no
  1895 00000BF6 F9                  <1> 	stc
  1896 00000BF7 C3                  <1> 	retn
  1897                              <1> 
  1898                              <1> lff16s_0:
  1899 00000BF8 8EC0                <1> 	mov	es, ax ; buffer segment	
  1900 00000BFA 31FF                <1> 	xor	di, di
  1901 00000BFC BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1902                              <1> 	; ds = cs
  1903                              <1> 
  1904                              <1> 	; load file into memory
  1905 00000BFF 8B0E[4D06]          <1>         mov	cx, [loadsize]
  1906 00000C03 8B1E[541D]          <1> 	mov	bx, [filehandle]
  1907 00000C07 B43F                <1>        	mov	ah, 3Fh
  1908 00000C09 CD21                <1> 	int	21h
  1909 00000C0B 72DF                <1> 	jc	short lff16s_7 ; error !
  1910                              <1> 
  1911 00000C0D 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1912                              <1> 	
  1913 00000C0F D1E8                <1> 	shr	ax, 1
  1914                              <1> 	;and	ax, ax
  1915 00000C11 7503                <1> 	jnz	short lff16s_8
  1916                              <1> 	;jmp	lff16s_3
  1917                              <1> 	; 15/11/2023
  1918 00000C13 E9FFFC              <1> 	jmp	lff16_eof
  1919                              <1> 
  1920                              <1> lff16s_8:
  1921 00000C16 89C1                <1> 	mov	cx, ax		; word count
  1922                              <1> lff16s_1:
  1923 00000C18 AC                  <1> 	lodsb
  1924 00000C19 A2[6D19]            <1> 	mov	[previous_val_l], al
  1925 00000C1C 2C80                <1> 	sub	al, 80h
  1926 00000C1E C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1927 00000C21 AB                  <1> 	stosw		; original sample (L)
  1928 00000C22 AC                  <1> 	lodsb
  1929 00000C23 A2[6F19]            <1> 	mov	[previous_val_r], al
  1930 00000C26 2C80                <1> 	sub	al, 80h
  1931 00000C28 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1932 00000C2B AB                  <1> 	stosw		; original sample (R)
  1933                              <1> 
  1934                              <1> 	;xor	ax, ax
  1935                              <1> 	; 14/11/2023
  1936 00000C2C B88080              <1> 	mov	ax, 8080h
  1937 00000C2F 49                  <1> 	dec	cx
  1938 00000C30 7402                <1> 	jz	short lff16s_2
  1939                              <1> 		; convert 8 bit sample to 16 bit sample
  1940 00000C32 8B04                <1> 	mov	ax, [si]
  1941                              <1> lff16s_2:
  1942                              <1> 	;mov	[next_val_l], al
  1943                              <1> 	;mov	[next_val_r], ah
  1944 00000C34 89C3                <1> 	mov	bx, ax
  1945 00000C36 0206[6D19]          <1> 	add	al, [previous_val_l]
  1946 00000C3A D0D8                <1> 	rcr	al, 1
  1947 00000C3C 88C2                <1> 	mov	dl, al	; this is temporary interpolation value (L)
  1948 00000C3E 0206[6D19]          <1> 	add	al, [previous_val_l]
  1949 00000C42 D0D8                <1> 	rcr	al, 1
  1950 00000C44 2C80                <1> 	sub	al, 80h
  1951 00000C46 C1E008              <1> 	shl	ax, 8
  1952 00000C49 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1953 00000C4A 88F8                <1> 	mov	al, bh	; [next_val_r]
  1954 00000C4C 0206[6F19]          <1> 	add	al, [previous_val_r]
  1955 00000C50 D0D8                <1> 	rcr	al, 1
  1956 00000C52 88C6                <1> 	mov	dh, al	; this is temporary interpolation value (R)
  1957 00000C54 0206[6F19]          <1> 	add	al, [previous_val_r]
  1958 00000C58 D0D8                <1> 	rcr	al, 1
  1959 00000C5A 2C80                <1> 	sub	al, 80h
  1960 00000C5C C1E008              <1> 	shl	ax, 8
  1961 00000C5F AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1962 00000C60 88D0                <1> 	mov	al, dl
  1963 00000C62 00D8                <1> 	add	al, bl	; [next_val_l]
  1964 00000C64 D0D8                <1> 	rcr	al, 1
  1965 00000C66 2C80                <1> 	sub	al, 80h
  1966 00000C68 C1E008              <1> 	shl	ax, 8
  1967 00000C6B AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1968 00000C6C 88F0                <1> 	mov	al, dh
  1969 00000C6E 00F8                <1> 	add	al, bh	; [next_val_r]
  1970 00000C70 D0D8                <1> 	rcr	al, 1
  1971 00000C72 2C80                <1> 	sub	al, 80h
  1972 00000C74 C1E008              <1> 	shl	ax, 8
  1973 00000C77 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1974                              <1> 	
  1975                              <1> 	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1976 00000C78 09C9                <1> 	or	cx, cx
  1977 00000C7A 759C                <1> 	jnz	short lff16s_1
  1978 00000C7C E983FC              <1> 	jmp	lff16s_3
  1979                              <1> 
  1980                              <1> load_16khz_mono_16_bit:
  1981                              <1> 	; 15/11/2023
  1982                              <1> 	; 13/11/2023
  1983 00000C7F F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1984                              <1> 					; last of the file?
  1985 00000C84 7402                <1> 	jz	short lff16m2_0		; no
  1986 00000C86 F9                  <1> 	stc
  1987 00000C87 C3                  <1> 	retn
  1988                              <1> 
  1989                              <1> lff16m2_0:
  1990 00000C88 8EC0                <1> 	mov	es, ax ; buffer segment	
  1991 00000C8A 31FF                <1> 	xor	di, di
  1992 00000C8C BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1993                              <1> 	; ds = cs
  1994                              <1> 
  1995                              <1> 	; load file into memory
  1996 00000C8F 8B0E[4D06]          <1>         mov	cx, [loadsize]
  1997 00000C93 8B1E[541D]          <1> 	mov	bx, [filehandle]
  1998 00000C97 B43F                <1>        	mov	ah, 3Fh
  1999 00000C99 CD21                <1> 	int	21h
  2000 00000C9B 7240                <1> 	jc	short lff16m2_7 ; error !
  2001                              <1> 
  2002 00000C9D 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2003                              <1> 	
  2004 00000C9F D1E8                <1> 	shr	ax, 1
  2005                              <1> 	;and	ax, ax
  2006 00000CA1 7503                <1> 	jnz	short lff16m2_8
  2007                              <1> 	;jmp	lff16m2_3
  2008                              <1> 	; 15/11/2023
  2009 00000CA3 E96FFC              <1> 	jmp	lff16_eof
  2010                              <1> 
  2011                              <1> lff16m2_8:
  2012 00000CA6 89C1                <1> 	mov	cx, ax	; word count
  2013                              <1> lff16m2_1:
  2014 00000CA8 AD                  <1> 	lodsw
  2015 00000CA9 AB                  <1> 	stosw		; original sample (left channel)
  2016 00000CAA AB                  <1> 	stosw		; original sample (right channel)
  2017 00000CAB 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  2018                              <1> 	;mov	[previous_val], ax
  2019 00000CAE 89C3                <1> 	mov	bx, ax	
  2020 00000CB0 31C0                <1> 	xor	ax, ax
  2021 00000CB2 49                  <1> 	dec	cx
  2022 00000CB3 7402                <1> 	jz	short lff16m2_2
  2023 00000CB5 8B04                <1> 	mov	ax, [si]
  2024                              <1> lff16m2_2:
  2025 00000CB7 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  2026 00000CBA 89C5                <1> 	mov	bp, ax	; [next_val]
  2027                              <1> 	;add	ax, [previous_val]
  2028 00000CBC 01D8                <1> 	add	ax, bx
  2029 00000CBE D1D8                <1> 	rcr	ax, 1
  2030 00000CC0 89C2                <1> 	mov	dx, ax	; this is temporary interpolation value
  2031                              <1> 	;add	ax, [previous_val]
  2032 00000CC2 01D8                <1> 	add	ax, bx
  2033 00000CC4 D1D8                <1> 	rcr	ax, 1
  2034 00000CC6 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2035 00000CC9 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  2036 00000CCA AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  2037 00000CCB 89E8                <1> 	mov	ax, bp 
  2038 00000CCD 01D0                <1> 	add	ax, dx
  2039 00000CCF D1D8                <1> 	rcr	ax, 1
  2040 00000CD1 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2041 00000CD4 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  2042 00000CD5 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  2043                              <1> 	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2044 00000CD6 09C9                <1> 	or	cx, cx
  2045 00000CD8 75CE                <1> 	jnz	short lff16m2_1
  2046 00000CDA E925FC              <1> 	jmp	lff16m2_3
  2047                              <1> 
  2048                              <1> lff16m2_7:
  2049                              <1> lff16s2_7:
  2050 00000CDD E93CFC              <1> 	jmp	lff16m2_5  ; error
  2051                              <1> 
  2052                              <1> load_16khz_stereo_16_bit:
  2053                              <1> 	; 16/11/2023
  2054                              <1> 	; 15/11/2023
  2055                              <1> 	; 13/11/2023
  2056 00000CE0 F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2057                              <1> 					; last of the file?
  2058 00000CE5 7402                <1> 	jz	short lff16s2_0		; no
  2059 00000CE7 F9                  <1> 	stc
  2060 00000CE8 C3                  <1> 	retn
  2061                              <1> 
  2062                              <1> lff16s2_0:
  2063 00000CE9 8EC0                <1> 	mov	es, ax ; buffer segment	
  2064 00000CEB 31FF                <1> 	xor	di, di
  2065 00000CED BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2066                              <1> 	; ds = cs
  2067                              <1> 
  2068                              <1> 	; load file into memory
  2069 00000CF0 8B0E[4D06]          <1>         mov	cx, [loadsize]
  2070 00000CF4 8B1E[541D]          <1> 	mov	bx, [filehandle]
  2071 00000CF8 B43F                <1>        	mov	ah, 3Fh
  2072 00000CFA CD21                <1> 	int	21h
  2073 00000CFC 72DF                <1> 	jc	short lff16s2_7 ; error !
  2074                              <1> 
  2075 00000CFE 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2076                              <1> 	
  2077                              <1> 	;shr	ax, 1
  2078 00000D00 C1E802              <1> 	shr	ax, 2	; 16/11/2023
  2079                              <1> 	;and	ax, ax
  2080 00000D03 7503                <1> 	jnz	short lff16s2_8
  2081                              <1> 	;jmp	lff16s2_3
  2082                              <1> 	; 15/11/2023
  2083 00000D05 E90DFC              <1> 	jmp	lff16_eof
  2084                              <1> 
  2085                              <1> lff16s2_8:
  2086 00000D08 89C1                <1> 	mov	cx, ax		; dword count
  2087                              <1> lff16s2_1:
  2088 00000D0A AD                  <1> 	lodsw
  2089 00000D0B AB                  <1> 	stosw		; original sample (L)
  2090 00000D0C 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2091 00000D0F A3[6D19]            <1> 	mov	[previous_val_l], ax
  2092 00000D12 AD                  <1> 	lodsw
  2093 00000D13 AB                  <1> 	stosw		; original sample (R)
  2094 00000D14 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2095 00000D17 A3[6F19]            <1> 	mov	[previous_val_r], ax
  2096 00000D1A 31D2                <1> 	xor	dx, dx
  2097 00000D1C 31C0                <1> 	xor	ax, ax
  2098                              <1> 	; 16/11/2023
  2099 00000D1E 49                  <1> 	dec	cx
  2100 00000D1F 7405                <1> 	jz	short lff16s2_2
  2101 00000D21 8B04                <1> 	mov	ax, [si]
  2102 00000D23 8B5402              <1> 	mov	dx, [si+2]
  2103                              <1> lff16s2_2:
  2104 00000D26 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2105                              <1> 	;mov	[next_val_l], ax
  2106 00000D29 89C5                <1> 	mov	bp, ax
  2107 00000D2B 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format 
  2108 00000D2E 8916[7319]          <1> 	mov	[next_val_r], dx
  2109 00000D32 0306[6D19]          <1> 	add	ax, [previous_val_l]
  2110 00000D36 D1D8                <1> 	rcr	ax, 1
  2111 00000D38 89C2                <1> 	mov	dx, ax	; this is temporary interpolation value (L)
  2112 00000D3A 0306[6D19]          <1> 	add	ax, [previous_val_l]
  2113 00000D3E D1D8                <1> 	rcr	ax, 1
  2114 00000D40 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  2115 00000D43 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  2116 00000D44 A1[7319]            <1> 	mov	ax, [next_val_r]
  2117 00000D47 0306[6F19]          <1> 	add	ax, [previous_val_r]
  2118 00000D4B D1D8                <1> 	rcr	ax, 1
  2119 00000D4D 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value (R)
  2120 00000D4F 0306[6F19]          <1> 	add	ax, [previous_val_r]
  2121 00000D53 D1D8                <1> 	rcr	ax, 1
  2122 00000D55 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2123 00000D58 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  2124                              <1> 	;mov	ax, [next_val_l]
  2125 00000D59 89E8                <1> 	mov	ax, bp
  2126 00000D5B 01D0                <1> 	add	ax, dx
  2127 00000D5D D1D8                <1> 	rcr	ax, 1
  2128 00000D5F 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2129 00000D62 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  2130 00000D63 A1[7319]            <1> 	mov	ax, [next_val_r]
  2131 00000D66 01D8                <1> 	add	ax, bx
  2132 00000D68 D1D8                <1> 	rcr	ax, 1
  2133 00000D6A 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2134 00000D6D AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  2135                              <1> 	
  2136                              <1> 	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2137 00000D6E 09C9                <1> 	or	cx, cx
  2138 00000D70 7598                <1> 	jnz	short lff16s2_1
  2139 00000D72 E98DFB              <1> 	jmp	lff16s2_3
  2140                              <1> 
  2141                              <1> ; .....................
  2142                              <1> 
  2143                              <1> load_24khz_mono_8_bit:
  2144                              <1> 	; 15/11/2023
  2145 00000D75 F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2146                              <1> 					; last of the file?
  2147 00000D7A 7402                <1> 	jz	short lff24m_0		; no
  2148 00000D7C F9                  <1> 	stc
  2149 00000D7D C3                  <1> 	retn
  2150                              <1> 
  2151                              <1> lff24m_0:
  2152 00000D7E 8EC0                <1> 	mov	es, ax ; buffer segment	
  2153 00000D80 31FF                <1> 	xor	di, di
  2154 00000D82 BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2155                              <1> 	; ds = cs
  2156                              <1> 
  2157                              <1> 	; load file into memory
  2158 00000D85 8B0E[4D06]          <1>         mov	cx, [loadsize]
  2159 00000D89 8B1E[541D]          <1> 	mov	bx, [filehandle]
  2160 00000D8D B43F                <1>        	mov	ah, 3Fh
  2161 00000D8F CD21                <1> 	int	21h
  2162 00000D91 722E                <1> 	jc	short lff24m_7 ; error !
  2163                              <1> 
  2164 00000D93 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2165                              <1> 	
  2166 00000D95 21C0                <1> 	and	ax, ax
  2167 00000D97 7503                <1> 	jnz	short lff24m_8
  2168 00000D99 E979FB              <1> 	jmp	lff24_eof
  2169                              <1> 
  2170                              <1> lff24m_8:
  2171 00000D9C 89C1                <1> 	mov	cx, ax		; byte count
  2172                              <1> lff24m_1:
  2173 00000D9E AC                  <1> 	lodsb
  2174                              <1> 	;mov	[previous_val], al
  2175 00000D9F 88C3                <1> 	mov	bl, al
  2176 00000DA1 2C80                <1> 	sub	al, 80h
  2177 00000DA3 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2178 00000DA6 AB                  <1> 	stosw		; original sample (left channel)
  2179 00000DA7 AB                  <1> 	stosw		; original sample (right channel)
  2180                              <1> 	;xor	ax, ax
  2181 00000DA8 B080                <1> 	mov	al, 80h
  2182 00000DAA 49                  <1> 	dec	cx
  2183 00000DAB 7402                <1> 	jz	short lff24m_2
  2184 00000DAD 8A04                <1> 	mov	al, [si]
  2185                              <1> lff24m_2:
  2186                              <1> 	;;mov	[next_val], al
  2187                              <1> 	;mov	bh, al
  2188                              <1> 	;add	al, [previous_val]
  2189 00000DAF 00D8                <1> 	add	al, bl
  2190 00000DB1 D0D8                <1> 	rcr	al, 1
  2191 00000DB3 2C80                <1> 	sub	al, 80h
  2192 00000DB5 C1E008              <1> 	shl	ax, 8
  2193 00000DB8 AB                  <1> 	stosw		; this is interpolated sample (L)
  2194 00000DB9 AB                  <1> 	stosw		; this is interpolated sample (R)
  2195                              <1> 	
  2196                              <1> 	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2197 00000DBA 09C9                <1> 	or	cx, cx
  2198 00000DBC 75E0                <1> 	jnz	short lff24m_1
  2199 00000DBE E941FB              <1> 	jmp	lff24_3
  2200                              <1> 
  2201                              <1> lff24m_7:
  2202                              <1> lff24s_7:
  2203 00000DC1 E958FB              <1> 	jmp	lff24_5  ; error
  2204                              <1> 
  2205                              <1> load_24khz_stereo_8_bit:
  2206                              <1> 	; 15/11/2023
  2207 00000DC4 F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2208                              <1> 					; last of the file?
  2209 00000DC9 7402                <1> 	jz	short lff24s_0		; no
  2210 00000DCB F9                  <1> 	stc
  2211 00000DCC C3                  <1> 	retn
  2212                              <1> 
  2213                              <1> lff24s_0:
  2214 00000DCD 8EC0                <1> 	mov	es, ax ; buffer segment	
  2215 00000DCF 31FF                <1> 	xor	di, di
  2216 00000DD1 BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2217                              <1> 	; ds = cs
  2218                              <1> 
  2219                              <1> 	; load file into memory
  2220 00000DD4 8B0E[4D06]          <1>         mov	cx, [loadsize]
  2221 00000DD8 8B1E[541D]          <1> 	mov	bx, [filehandle]
  2222 00000DDC B43F                <1>        	mov	ah, 3Fh
  2223 00000DDE CD21                <1> 	int	21h
  2224 00000DE0 72DF                <1> 	jc	short lff24s_7 ; error !
  2225                              <1> 
  2226 00000DE2 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2227                              <1> 	
  2228 00000DE4 D1E8                <1> 	shr	ax, 1
  2229                              <1> 	;and	ax, ax
  2230 00000DE6 7503                <1> 	jnz	short lff24s_8
  2231 00000DE8 E92AFB              <1> 	jmp	lff24_eof
  2232                              <1> 
  2233                              <1> lff24s_8:
  2234 00000DEB 89C1                <1> 	mov	cx, ax		; word count
  2235                              <1> lff24s_1:
  2236 00000DED AC                  <1> 	lodsb
  2237 00000DEE A2[6D19]            <1> 	mov	[previous_val_l], al
  2238 00000DF1 2C80                <1> 	sub	al, 80h
  2239 00000DF3 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2240 00000DF6 AB                  <1> 	stosw		; original sample (L)
  2241 00000DF7 AC                  <1> 	lodsb
  2242 00000DF8 A2[6F19]            <1> 	mov	[previous_val_r], al
  2243 00000DFB 2C80                <1> 	sub	al, 80h
  2244 00000DFD C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2245 00000E00 AB                  <1> 	stosw		; original sample (R)
  2246                              <1> 
  2247                              <1> 	;xor	ax, ax
  2248 00000E01 B88080              <1> 	mov	ax, 8080h
  2249 00000E04 49                  <1> 	dec	cx
  2250 00000E05 7402                <1> 	jz	short lff24s_2
  2251                              <1> 		; convert 8 bit sample to 16 bit sample
  2252 00000E07 8B04                <1> 	mov	ax, [si]
  2253                              <1> lff24s_2:
  2254                              <1> 	;;mov	[next_val_l], al
  2255                              <1> 	;;mov	[next_val_r], ah
  2256                              <1> 	;mov	bx, ax
  2257 00000E09 88E7                <1> 	mov	bh, ah
  2258 00000E0B 0206[6D19]          <1> 	add	al, [previous_val_l]
  2259 00000E0F D0D8                <1> 	rcr	al, 1
  2260                              <1> 	;mov	dl, al
  2261 00000E11 2C80                <1> 	sub	al, 80h
  2262 00000E13 C1E008              <1> 	shl	ax, 8
  2263 00000E16 AB                  <1> 	stosw		; this is interpolated sample (L)
  2264 00000E17 88F8                <1> 	mov	al, bh	; [next_val_r]
  2265 00000E19 0206[6F19]          <1> 	add	al, [previous_val_r]
  2266 00000E1D D0D8                <1> 	rcr	al, 1
  2267                              <1> 	;mov	dh, al
  2268 00000E1F 2C80                <1> 	sub	al, 80h
  2269 00000E21 C1E008              <1> 	shl	ax, 8
  2270 00000E24 AB                  <1> 	stosw		; this is interpolated sample (R)
  2271                              <1> 		
  2272                              <1> 	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2273 00000E25 09C9                <1> 	or	cx, cx
  2274 00000E27 75C4                <1> 	jnz	short lff24s_1
  2275 00000E29 E9D6FA              <1> 	jmp	lff24_3
  2276                              <1> 
  2277                              <1> load_24khz_mono_16_bit:
  2278                              <1> 	; 15/11/2023
  2279 00000E2C F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2280                              <1> 					; last of the file?
  2281 00000E31 7402                <1> 	jz	short lff24m2_0		; no
  2282 00000E33 F9                  <1> 	stc
  2283 00000E34 C3                  <1> 	retn
  2284                              <1> 
  2285                              <1> lff24m2_0:
  2286 00000E35 8EC0                <1> 	mov	es, ax ; buffer segment	
  2287 00000E37 31FF                <1> 	xor	di, di
  2288 00000E39 BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2289                              <1> 	; ds = cs
  2290                              <1> 
  2291                              <1> 	; load file into memory
  2292 00000E3C 8B0E[4D06]          <1>         mov	cx, [loadsize]
  2293 00000E40 8B1E[541D]          <1> 	mov	bx, [filehandle]
  2294 00000E44 B43F                <1>        	mov	ah, 3Fh
  2295 00000E46 CD21                <1> 	int	21h
  2296 00000E48 7228                <1> 	jc	short lff24m2_7 ; error !
  2297                              <1> 
  2298 00000E4A 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2299                              <1> 	
  2300 00000E4C D1E8                <1> 	shr	ax, 1
  2301                              <1> 	;and	ax, ax
  2302 00000E4E 7503                <1> 	jnz	short lff24m2_8
  2303 00000E50 E9C2FA              <1> 	jmp	lff24_eof
  2304                              <1> 
  2305                              <1> lff24m2_8:
  2306 00000E53 89C1                <1> 	mov	cx, ax	; word count
  2307                              <1> lff24m2_1:
  2308 00000E55 AD                  <1> 	lodsw
  2309 00000E56 AB                  <1> 	stosw		; original sample (left channel)
  2310 00000E57 AB                  <1> 	stosw		; original sample (right channel)
  2311 00000E58 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  2312                              <1> 	;mov	[previous_val], ax
  2313                              <1> 	;mov	bx, ax	
  2314                              <1> 	;xor	ax, ax
  2315 00000E5B 31DB                <1> 	xor	bx, bx
  2316 00000E5D 49                  <1> 	dec	cx
  2317 00000E5E 7402                <1> 	jz	short lff24m2_2
  2318                              <1> 	;mov	ax, [si
  2319 00000E60 8B1C                <1> 	mov	bx, [si]
  2320                              <1> lff24m2_2:
  2321                              <1> 	;add	ah, 80h ; convert sound level 0 to 65535 format
  2322                              <1> 	;mov	bp, ax	; [next_val]
  2323                              <1> 	;add	ax, [previous_val]
  2324                              <1> 	; ax = [previous_val]
  2325                              <1> 	; bx = [next_val]
  2326 00000E62 01D8                <1> 	add	ax, bx
  2327 00000E64 D1D8                <1> 	rcr	ax, 1
  2328 00000E66 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2329 00000E69 AB                  <1> 	stosw		; this is interpolated sample (L)
  2330 00000E6A AB                  <1> 	stosw		; this is interpolated sample (R)
  2331                              <1> 	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2332 00000E6B 09C9                <1> 	or	cx, cx
  2333 00000E6D 75E6                <1> 	jnz	short lff24m2_1
  2334 00000E6F E990FA              <1> 	jmp	lff24_3
  2335                              <1> 
  2336                              <1> lff24m2_7:
  2337                              <1> lff24s2_7:
  2338 00000E72 E9A7FA              <1> 	jmp	lff24_5  ; error
  2339                              <1> 
  2340                              <1> load_24khz_stereo_16_bit:
  2341                              <1> 	; 16/11/2023
  2342                              <1> 	; 15/11/2023
  2343 00000E75 F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2344                              <1> 					; last of the file?
  2345 00000E7A 7402                <1> 	jz	short lff24s2_0		; no
  2346 00000E7C F9                  <1> 	stc
  2347 00000E7D C3                  <1> 	retn
  2348                              <1> 
  2349                              <1> lff24s2_0:
  2350 00000E7E 8EC0                <1> 	mov	es, ax ; buffer segment	
  2351 00000E80 31FF                <1> 	xor	di, di
  2352 00000E82 BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2353                              <1> 	; ds = cs
  2354                              <1> 
  2355                              <1> 	; load file into memory
  2356 00000E85 8B0E[4D06]          <1>         mov	cx, [loadsize]
  2357 00000E89 8B1E[541D]          <1> 	mov	bx, [filehandle]
  2358 00000E8D B43F                <1>        	mov	ah, 3Fh
  2359 00000E8F CD21                <1> 	int	21h
  2360 00000E91 72DF                <1> 	jc	short lff24s2_7 ; error !
  2361                              <1> 
  2362 00000E93 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2363                              <1> 	
  2364                              <1> 	;shr	ax, 1
  2365 00000E95 C1E802              <1> 	shr	ax, 2	; 16/11/2023
  2366                              <1> 	;and	ax, ax
  2367 00000E98 7503                <1> 	jnz	short lff24s2_8
  2368 00000E9A E978FA              <1> 	jmp	lff24_eof
  2369                              <1> 
  2370                              <1> lff24s2_8:
  2371 00000E9D 89C1                <1> 	mov	cx, ax		; dword count
  2372                              <1> lff24s2_1:
  2373 00000E9F AD                  <1> 	lodsw
  2374 00000EA0 AB                  <1> 	stosw		; original sample (L)
  2375 00000EA1 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2376 00000EA4 A3[6D19]            <1> 	mov	[previous_val_l], ax
  2377 00000EA7 AD                  <1> 	lodsw
  2378 00000EA8 AB                  <1> 	stosw		; original sample (R)
  2379 00000EA9 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2380                              <1> 	;mov	[previous_val_r], ax
  2381 00000EAC 89C3                <1> 	mov	bx, ax
  2382 00000EAE 31D2                <1> 	xor	dx, dx
  2383 00000EB0 31C0                <1> 	xor	ax, ax
  2384                              <1> 	; 16/11/2023
  2385 00000EB2 49                  <1> 	dec	cx
  2386 00000EB3 7405                <1> 	jz	short lff24s2_2
  2387 00000EB5 8B04                <1> 	mov	ax, [si]
  2388 00000EB7 8B5402              <1> 	mov	dx, [si+2]
  2389                              <1> lff24s2_2:
  2390 00000EBA 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2391                              <1> 	;;mov	[next_val_l], ax
  2392                              <1> 	;mov	bp, ax
  2393 00000EBD 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format 
  2394                              <1> 	;mov	[next_val_r], dx
  2395 00000EC0 0306[6D19]          <1> 	add	ax, [previous_val_l]
  2396 00000EC4 D1D8                <1> 	rcr	ax, 1
  2397 00000EC6 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  2398 00000EC9 AB                  <1> 	stosw		; this is interpolated sample (L)
  2399                              <1> 	;mov	ax, [next_val_r]
  2400 00000ECA 89D0                <1> 	mov	ax, dx
  2401                              <1> 	;add	ax, [previous_val_r]
  2402 00000ECC 01D8                <1> 	add	ax, bx
  2403 00000ECE D1D8                <1> 	rcr	ax, 1
  2404 00000ED0 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2405 00000ED3 AB                  <1> 	stosw		; this is interpolated sample (R)
  2406                              <1> 	
  2407                              <1> 	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2408 00000ED4 09C9                <1> 	or	cx, cx
  2409 00000ED6 75C7                <1> 	jnz	short lff24s2_1
  2410 00000ED8 E927FA              <1> 	jmp	lff24_3
  2411                              <1> 
  2412                              <1> ; .....................
  2413                              <1> 
  2414                              <1> load_32khz_mono_8_bit:
  2415                              <1> 	; 15/11/2023
  2416 00000EDB F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2417                              <1> 					; last of the file?
  2418 00000EE0 7402                <1> 	jz	short lff32m_0		; no
  2419 00000EE2 F9                  <1> 	stc
  2420 00000EE3 C3                  <1> 	retn
  2421                              <1> 
  2422                              <1> lff32m_0:
  2423 00000EE4 8EC0                <1> 	mov	es, ax ; buffer segment	
  2424 00000EE6 31FF                <1> 	xor	di, di
  2425 00000EE8 BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2426                              <1> 	; ds = cs
  2427                              <1> 
  2428                              <1> 	; load file into memory
  2429 00000EEB 8B0E[4D06]          <1>         mov	cx, [loadsize]
  2430 00000EEF 8B1E[541D]          <1> 	mov	bx, [filehandle]
  2431 00000EF3 B43F                <1>        	mov	ah, 3Fh
  2432 00000EF5 CD21                <1> 	int	21h
  2433 00000EF7 7237                <1> 	jc	short lff32m_7 ; error !
  2434                              <1> 
  2435 00000EF9 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2436                              <1> 	
  2437 00000EFB 21C0                <1> 	and	ax, ax
  2438 00000EFD 7503                <1> 	jnz	short lff32m_8
  2439 00000EFF E913FA              <1> 	jmp	lff32_eof
  2440                              <1> 
  2441                              <1> lff32m_8:
  2442 00000F02 89C1                <1> 	mov	cx, ax		; byte count
  2443                              <1> lff32m_1:
  2444 00000F04 AC                  <1> 	lodsb
  2445                              <1> 	;mov	[previous_val], al
  2446 00000F05 88C3                <1> 	mov	bl, al
  2447 00000F07 2C80                <1> 	sub	al, 80h
  2448 00000F09 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2449 00000F0C AB                  <1> 	stosw		; original sample (left channel)
  2450 00000F0D AB                  <1> 	stosw		; original sample (right channel)
  2451                              <1> 	;xor	ax, ax
  2452 00000F0E B080                <1> 	mov	al, 80h
  2453 00000F10 49                  <1> 	dec	cx
  2454 00000F11 7402                <1> 	jz	short lff32m_2
  2455 00000F13 8A04                <1> 	mov	al, [si]
  2456                              <1> lff32m_2:
  2457                              <1> 	;;mov	[next_val], al
  2458                              <1> 	;mov	bh, al
  2459                              <1> 	;add	al, [previous_val]
  2460 00000F15 00D8                <1> 	add	al, bl
  2461 00000F17 D0D8                <1> 	rcr	al, 1
  2462 00000F19 2C80                <1> 	sub	al, 80h
  2463 00000F1B C1E008              <1> 	shl	ax, 8
  2464 00000F1E AB                  <1> 	stosw		; this is interpolated sample (L)
  2465 00000F1F AB                  <1> 	stosw		; this is interpolated sample (R)
  2466                              <1> 	
  2467                              <1> 	; different than 8-16-24 kHZ !
  2468                              <1> 	; 'original-interpolated-original' trio samples 
  2469 00000F20 E30B                <1> 	jcxz	lff32m_3
  2470                              <1> 
  2471 00000F22 AC                  <1> 	lodsb
  2472 00000F23 2C80                <1> 	sub	al, 80h
  2473 00000F25 C1E008              <1> 	shl	ax, 8
  2474 00000F28 AB                  <1> 	stosw		; original sample (left channel)
  2475 00000F29 AB                  <1> 	stosw		; original sample (right channel)
  2476                              <1> 
  2477                              <1> 	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2478 00000F2A 49                  <1> 	dec	cx
  2479 00000F2B 75D7                <1> 	jnz	short lff32m_1
  2480                              <1> lff32m_3:
  2481 00000F2D E9D2F9              <1> 	jmp	lff32_3
  2482                              <1> 
  2483                              <1> lff32m_7:
  2484                              <1> lff32s_7:
  2485 00000F30 E9E9F9              <1> 	jmp	lff32_5  ; error
  2486                              <1> 
  2487                              <1> load_32khz_stereo_8_bit:
  2488                              <1> 	; 15/11/2023
  2489 00000F33 F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2490                              <1> 					; last of the file?
  2491 00000F38 7402                <1> 	jz	short lff32s_0		; no
  2492 00000F3A F9                  <1> 	stc
  2493 00000F3B C3                  <1> 	retn
  2494                              <1> 
  2495                              <1> lff32s_0:
  2496 00000F3C 8EC0                <1> 	mov	es, ax ; buffer segment	
  2497 00000F3E 31FF                <1> 	xor	di, di
  2498 00000F40 BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2499                              <1> 	; ds = cs
  2500                              <1> 
  2501                              <1> 	; load file into memory
  2502 00000F43 8B0E[4D06]          <1>         mov	cx, [loadsize]
  2503 00000F47 8B1E[541D]          <1> 	mov	bx, [filehandle]
  2504 00000F4B B43F                <1>        	mov	ah, 3Fh
  2505 00000F4D CD21                <1> 	int	21h
  2506 00000F4F 72DF                <1> 	jc	short lff32s_7 ; error !
  2507                              <1> 
  2508 00000F51 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2509                              <1> 	
  2510 00000F53 D1E8                <1> 	shr	ax, 1
  2511                              <1> 	;and	ax, ax
  2512 00000F55 7503                <1> 	jnz	short lff32s_8
  2513 00000F57 E9BBF9              <1> 	jmp	lff32_eof
  2514                              <1> 
  2515                              <1> lff32s_8:
  2516 00000F5A 89C1                <1> 	mov	cx, ax		; word count
  2517                              <1> lff32s_1:
  2518 00000F5C AC                  <1> 	lodsb
  2519 00000F5D A2[6D19]            <1> 	mov	[previous_val_l], al
  2520 00000F60 2C80                <1> 	sub	al, 80h
  2521 00000F62 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2522 00000F65 AB                  <1> 	stosw		; original sample (L)
  2523 00000F66 AC                  <1> 	lodsb
  2524 00000F67 A2[6F19]            <1> 	mov	[previous_val_r], al
  2525 00000F6A 2C80                <1> 	sub	al, 80h
  2526 00000F6C C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2527 00000F6F AB                  <1> 	stosw		; original sample (R)
  2528                              <1> 
  2529                              <1> 	;xor	ax, ax
  2530 00000F70 B88080              <1> 	mov	ax, 8080h
  2531 00000F73 49                  <1> 	dec	cx
  2532 00000F74 7402                <1> 	jz	short lff32s_2
  2533                              <1> 		; convert 8 bit sample to 16 bit sample
  2534 00000F76 8B04                <1> 	mov	ax, [si]
  2535                              <1> lff32s_2:
  2536                              <1> 	;;mov	[next_val_l], al
  2537                              <1> 	;;mov	[next_val_r], ah
  2538                              <1> 	;mov	bx, ax
  2539 00000F78 88E7                <1> 	mov	bh, ah
  2540 00000F7A 0206[6D19]          <1> 	add	al, [previous_val_l]
  2541 00000F7E D0D8                <1> 	rcr	al, 1
  2542                              <1> 	;mov	dl, al
  2543 00000F80 2C80                <1> 	sub	al, 80h
  2544 00000F82 C1E008              <1> 	shl	ax, 8
  2545 00000F85 AB                  <1> 	stosw		; this is interpolated sample (L)
  2546 00000F86 88F8                <1> 	mov	al, bh	; [next_val_r]
  2547 00000F88 0206[6F19]          <1> 	add	al, [previous_val_r]
  2548 00000F8C D0D8                <1> 	rcr	al, 1
  2549                              <1> 	;mov	dh, al
  2550 00000F8E 2C80                <1> 	sub	al, 80h
  2551 00000F90 C1E008              <1> 	shl	ax, 8
  2552 00000F93 AB                  <1> 	stosw		; this is interpolated sample (R)
  2553                              <1> 
  2554                              <1> 	; different than 8-16-24 kHZ !
  2555                              <1> 	; 'original-interpolated-original' trio samples 
  2556 00000F94 E311                <1> 	jcxz	lff32s_3
  2557                              <1> 
  2558 00000F96 AC                  <1> 	lodsb
  2559 00000F97 2C80                <1> 	sub	al, 80h
  2560 00000F99 C1E008              <1> 	shl	ax, 8
  2561 00000F9C AB                  <1> 	stosw		; original sample (left channel)
  2562                              <1> 
  2563 00000F9D AC                  <1> 	lodsb
  2564 00000F9E 2C80                <1> 	sub	al, 80h
  2565 00000FA0 C1E008              <1> 	shl	ax, 8
  2566 00000FA3 AB                  <1> 	stosw		; original sample (right channel)
  2567                              <1> 		
  2568                              <1> 	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2569 00000FA4 49                  <1> 	dec	cx
  2570 00000FA5 75B5                <1> 	jnz	short lff32s_1
  2571                              <1> lff32s_3:
  2572 00000FA7 E958F9              <1> 	jmp	lff32_3
  2573                              <1> 
  2574                              <1> load_32khz_mono_16_bit:
  2575                              <1> 	; 15/11/2023
  2576 00000FAA F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2577                              <1> 					; last of the file?
  2578 00000FAF 7402                <1> 	jz	short lff32m2_0		; no
  2579 00000FB1 F9                  <1> 	stc
  2580 00000FB2 C3                  <1> 	retn
  2581                              <1> 
  2582                              <1> lff32m2_0:
  2583 00000FB3 8EC0                <1> 	mov	es, ax ; buffer segment	
  2584 00000FB5 31FF                <1> 	xor	di, di
  2585 00000FB7 BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2586                              <1> 	; ds = cs
  2587                              <1> 
  2588                              <1> 	; load file into memory
  2589 00000FBA 8B0E[4D06]          <1>         mov	cx, [loadsize]
  2590 00000FBE 8B1E[541D]          <1> 	mov	bx, [filehandle]
  2591 00000FC2 B43F                <1>        	mov	ah, 3Fh
  2592 00000FC4 CD21                <1> 	int	21h
  2593 00000FC6 722C                <1> 	jc	short lff32m2_7 ; error !
  2594                              <1> 
  2595 00000FC8 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2596                              <1> 	
  2597 00000FCA D1E8                <1> 	shr	ax, 1
  2598                              <1> 	;and	ax, ax
  2599 00000FCC 7503                <1> 	jnz	short lff32m2_8
  2600 00000FCE E944F9              <1> 	jmp	lff32_eof
  2601                              <1> 
  2602                              <1> lff32m2_8:
  2603 00000FD1 89C1                <1> 	mov	cx, ax	; word count
  2604                              <1> lff32m2_1:
  2605 00000FD3 AD                  <1> 	lodsw
  2606 00000FD4 AB                  <1> 	stosw		; original sample (left channel)
  2607 00000FD5 AB                  <1> 	stosw		; original sample (right channel)
  2608 00000FD6 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  2609                              <1> 	;mov	[previous_val], ax
  2610                              <1> 	;mov	bx, ax	
  2611                              <1> 	;xor	ax, ax
  2612 00000FD9 31DB                <1> 	xor	bx, bx
  2613 00000FDB 49                  <1> 	dec	cx
  2614 00000FDC 7402                <1> 	jz	short lff32m2_2
  2615                              <1> 	;mov	ax, [si
  2616 00000FDE 8B1C                <1> 	mov	bx, [si]
  2617                              <1> lff32m2_2:
  2618                              <1> 	;add	ah, 80h ; convert sound level 0 to 65535 format
  2619                              <1> 	;mov	bp, ax	; [next_val]
  2620                              <1> 	;add	ax, [previous_val]
  2621                              <1> 	; ax = [previous_val]
  2622                              <1> 	; bx = [next_val]
  2623 00000FE0 01D8                <1> 	add	ax, bx
  2624 00000FE2 D1D8                <1> 	rcr	ax, 1
  2625 00000FE4 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2626 00000FE7 AB                  <1> 	stosw		; this is interpolated sample (L)
  2627 00000FE8 AB                  <1> 	stosw		; this is interpolated sample (R)
  2628                              <1> 
  2629                              <1> 	; different than 8-16-24 kHZ !
  2630                              <1> 	; 'original-interpolated-original' trio samples 
  2631 00000FE9 E306                <1> 	jcxz	lff32m2_3
  2632                              <1> 
  2633 00000FEB AD                  <1> 	lodsw
  2634 00000FEC AB                  <1> 	stosw		; original sample (left channel)
  2635 00000FED AB                  <1> 	stosw		; original sample (right channel)
  2636                              <1> 
  2637                              <1> 	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2638 00000FEE 49                  <1> 	dec	cx
  2639 00000FEF 75E2                <1> 	jnz	short lff32m2_1
  2640                              <1> lff32m2_3:
  2641 00000FF1 E90EF9              <1> 	jmp	lff32_3
  2642                              <1> 
  2643                              <1> lff32m2_7:
  2644                              <1> lff32s2_7:
  2645 00000FF4 E925F9              <1> 	jmp	lff32_5  ; error
  2646                              <1> 
  2647                              <1> load_32khz_stereo_16_bit:
  2648                              <1> 	 ;16/11/2023
  2649                              <1> 	; 15/11/2023
  2650 00000FF7 F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2651                              <1> 					; last of the file?
  2652 00000FFC 7402                <1> 	jz	short lff32s2_0		; no
  2653 00000FFE F9                  <1> 	stc
  2654 00000FFF C3                  <1> 	retn
  2655                              <1> 
  2656                              <1> lff32s2_0:
  2657 00001000 8EC0                <1> 	mov	es, ax ; buffer segment	
  2658 00001002 31FF                <1> 	xor	di, di
  2659 00001004 BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2660                              <1> 	; ds = cs
  2661                              <1> 
  2662                              <1> 	; load file into memory
  2663 00001007 8B0E[4D06]          <1>         mov	cx, [loadsize]
  2664 0000100B 8B1E[541D]          <1> 	mov	bx, [filehandle]
  2665 0000100F B43F                <1>        	mov	ah, 3Fh
  2666 00001011 CD21                <1> 	int	21h
  2667 00001013 72DF                <1> 	jc	short lff32s2_7 ; error !
  2668                              <1> 
  2669 00001015 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2670                              <1> 	
  2671 00001017 C1E802              <1> 	shr	ax, 2	; 16/11/2023 (word left ch + word right ch) 
  2672                              <1> 	;and	ax, ax
  2673 0000101A 7503                <1> 	jnz	short lff32s2_8
  2674 0000101C E9F6F8              <1> 	jmp	lff32_eof
  2675                              <1> 
  2676                              <1> lff32s2_8:
  2677 0000101F 89C1                <1> 	mov	cx, ax		; dword count
  2678                              <1> lff32s2_1:
  2679 00001021 AD                  <1> 	lodsw
  2680 00001022 AB                  <1> 	stosw		; original sample (L)
  2681 00001023 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2682 00001026 A3[6D19]            <1> 	mov	[previous_val_l], ax
  2683 00001029 AD                  <1> 	lodsw
  2684 0000102A AB                  <1> 	stosw		; original sample (R)
  2685 0000102B 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2686                              <1> 	;mov	[previous_val_r], ax
  2687 0000102E 89C3                <1> 	mov	bx, ax
  2688 00001030 31D2                <1> 	xor	dx, dx
  2689 00001032 31C0                <1> 	xor	ax, ax
  2690                              <1> 	; 16/11/2023
  2691 00001034 49                  <1> 	dec	cx
  2692 00001035 7405                <1> 	jz	short lff32s2_2
  2693 00001037 8B04                <1> 	mov	ax, [si]
  2694 00001039 8B5402              <1> 	mov	dx, [si+2]
  2695                              <1> lff32s2_2:
  2696 0000103C 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2697                              <1> 	;;mov	[next_val_l], ax
  2698                              <1> 	;mov	bp, ax
  2699 0000103F 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format 
  2700                              <1> 	;mov	[next_val_r], dx
  2701 00001042 0306[6D19]          <1> 	add	ax, [previous_val_l]
  2702 00001046 D1D8                <1> 	rcr	ax, 1
  2703 00001048 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  2704 0000104B AB                  <1> 	stosw		; this is interpolated sample (L)
  2705                              <1> 	;mov	ax, [next_val_r]
  2706 0000104C 89D0                <1> 	mov	ax, dx
  2707                              <1> 	;add	ax, [previous_val_r]
  2708 0000104E 01D8                <1> 	add	ax, bx
  2709 00001050 D1D8                <1> 	rcr	ax, 1
  2710 00001052 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2711 00001055 AB                  <1> 	stosw		; this is interpolated sample (R)
  2712                              <1> 
  2713                              <1> 	; different than 8-16-24 kHZ !
  2714                              <1> 	; 'original-interpolated-original' trio samples 
  2715 00001056 E307                <1> 	jcxz	lff32s2_3
  2716                              <1> 
  2717 00001058 AD                  <1> 	lodsw
  2718 00001059 AB                  <1> 	stosw	; original sample (L)
  2719 0000105A AD                  <1> 	lodsw
  2720 0000105B AB                  <1> 	stosw	; original sample (R)
  2721                              <1> 	
  2722                              <1> 	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2723 0000105C 49                  <1> 	dec	cx
  2724 0000105D 75C2                <1> 	jnz	short lff32s2_1
  2725                              <1> lff32s2_3:
  2726 0000105F E9A0F8              <1> 	jmp	lff32_3
  2727                              <1> 
  2728                              <1> ; .....................
  2729                              <1> 
  2730                              <1> load_22khz_mono_8_bit:
  2731                              <1> 	; 16/11/2023
  2732 00001062 F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2733                              <1> 					; last of the file?
  2734 00001067 7402                <1> 	jz	short lff22m_0		; no
  2735 00001069 F9                  <1> 	stc
  2736 0000106A C3                  <1> 	retn
  2737                              <1> 
  2738                              <1> lff22m_0:
  2739 0000106B 8EC0                <1> 	mov	es, ax ; buffer segment	
  2740 0000106D 31FF                <1> 	xor	di, di
  2741 0000106F BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2742                              <1> 	; ds = cs
  2743                              <1> 
  2744                              <1> 	; load file into memory
  2745 00001072 8B0E[4D06]          <1>         mov	cx, [loadsize]
  2746 00001076 8B1E[541D]          <1> 	mov	bx, [filehandle]
  2747 0000107A B43F                <1>        	mov	ah, 3Fh
  2748 0000107C CD21                <1> 	int	21h
  2749 0000107E 7248                <1> 	jc	short lff22m_7 ; error !
  2750                              <1> 
  2751 00001080 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2752                              <1> 	
  2753 00001082 21C0                <1> 	and	ax, ax
  2754 00001084 7503                <1> 	jnz	short lff22m_8
  2755 00001086 E98CF8              <1> 	jmp	lff22_eof
  2756                              <1> 
  2757                              <1> lff22m_8:
  2758 00001089 89C1                <1> 	mov	cx, ax		; byte count
  2759                              <1> lff22m_9:
  2760 0000108B BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2761 0000108E C606[7519]03        <1> 	mov	byte [faz], 3  ; 3 steps/phases
  2762                              <1> lff22m_1:
  2763                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2764 00001093 AC                  <1> 	lodsb
  2765 00001094 B280                <1> 	mov	dl, 80h
  2766 00001096 49                  <1> 	dec	cx
  2767 00001097 7402                <1> 	jz	short lff22m_2_1
  2768 00001099 8A14                <1> 	mov	dl, [si]
  2769                              <1> lff22m_2_1:	
  2770                              <1> 	; al = [previous_val]
  2771                              <1> 	; dl = [next_val]
  2772 0000109B E8A004              <1> 	call	interpolating_3_8bit_mono ; 1 of 17
  2773 0000109E E325                <1> 	jcxz	lff22m_3
  2774                              <1> lff22m_2_2:
  2775 000010A0 AC                  <1> 	lodsb
  2776 000010A1 B280                <1> 	mov	dl, 80h
  2777 000010A3 49                  <1> 	dec	cx
  2778 000010A4 7402                <1> 	jz	short lff22m_2_3
  2779 000010A6 8A14                <1> 	mov	dl, [si]
  2780                              <1> lff22m_2_3:
  2781 000010A8 E80205              <1>  	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  2782 000010AB E318                <1> 	jcxz	lff22m_3
  2783 000010AD 4D                  <1> 	dec	bp
  2784 000010AE 75F0                <1> 	jnz	short lff22m_2_2
  2785                              <1> 
  2786 000010B0 A0[7519]            <1> 	mov	al, [faz]
  2787 000010B3 FEC8                <1> 	dec	al
  2788 000010B5 74D4                <1> 	jz	short lff22m_9
  2789 000010B7 FE0E[7519]          <1> 	dec	byte [faz]
  2790 000010BB BD0400              <1> 	mov	bp, 4
  2791 000010BE FEC8                <1> 	dec	al
  2792 000010C0 75D1                <1> 	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  2793 000010C2 45                  <1> 	inc	bp ; 5
  2794 000010C3 EBCE                <1> 	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2795                              <1> 
  2796                              <1> lff22m_3:
  2797                              <1> lff22s_3:
  2798 000010C5 E93AF8              <1> 	jmp	lff22_3	; padfill
  2799                              <1> 		; (put zeros in the remain words of the buffer)
  2800                              <1> lff22m_7:
  2801                              <1> lff22s_7:
  2802 000010C8 E951F8              <1> 	jmp	lff22_5  ; error
  2803                              <1> 
  2804                              <1> load_22khz_stereo_8_bit:
  2805                              <1> 	; 16/11/2023
  2806 000010CB F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2807                              <1> 					; last of the file?
  2808 000010D0 7402                <1> 	jz	short lff22s_0		; no
  2809 000010D2 F9                  <1> 	stc
  2810 000010D3 C3                  <1> 	retn
  2811                              <1> 
  2812                              <1> lff22s_0:
  2813 000010D4 8EC0                <1> 	mov	es, ax ; buffer segment	
  2814 000010D6 31FF                <1> 	xor	di, di
  2815 000010D8 BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2816                              <1> 	; ds = cs
  2817                              <1> 
  2818                              <1> 	; load file into memory
  2819 000010DB 8B0E[4D06]          <1>         mov	cx, [loadsize]
  2820 000010DF 8B1E[541D]          <1> 	mov	bx, [filehandle]
  2821 000010E3 B43F                <1>        	mov	ah, 3Fh
  2822 000010E5 CD21                <1> 	int	21h
  2823 000010E7 72DF                <1> 	jc	short lff22s_7 ; error !
  2824                              <1> 
  2825 000010E9 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2826                              <1> 	
  2827 000010EB D1E8                <1> 	shr	ax, 1
  2828                              <1> 	;and	ax, ax
  2829 000010ED 7503                <1> 	jnz	short lff22s_8
  2830 000010EF E923F8              <1> 	jmp	lff22_eof
  2831                              <1> 
  2832                              <1> lff22s_8:
  2833 000010F2 89C1                <1> 	mov	cx, ax		; word count
  2834                              <1> lff22s_9:
  2835 000010F4 BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2836 000010F7 C606[7519]03        <1> 	mov	byte [faz], 3  ; 3 steps/phase
  2837                              <1> lff22s_1:
  2838                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2839 000010FC AD                  <1> 	lodsw
  2840 000010FD BA8080              <1> 	mov	dx, 8080h
  2841 00001100 49                  <1> 	dec	cx
  2842 00001101 7402                <1> 	jz	short lff22s_2_1 
  2843 00001103 8B14                <1> 	mov	dx, [si]
  2844                              <1> lff22s_2_1:	
  2845                              <1> 	; al = [previous_val_l]
  2846                              <1> 	; ah = [previous_val_r]
  2847                              <1> 	; dl = [next_val_l]
  2848                              <1> 	; dl = [next_val_r]	
  2849 00001105 E85E04              <1> 	call	interpolating_3_8bit_stereo ; 1 of 17 
  2850 00001108 E3BB                <1> 	jcxz	lff22s_3
  2851                              <1> lff22s_2_2:
  2852 0000110A AD                  <1> 	lodsw
  2853 0000110B BA8080              <1> 	mov	dx, 8080h
  2854 0000110E 49                  <1> 	dec	cx
  2855 0000110F 7402                <1> 	jz	short lff22s_2_3
  2856 00001111 8B14                <1> 	mov	dx, [si]
  2857                              <1> lff22s_2_3:
  2858 00001113 E8AE04              <1>  	call	interpolating_2_8bit_stereo ; 2 of 17 .. 6 of 17
  2859 00001116 E3AD                <1> 	jcxz	lff22s_3
  2860 00001118 4D                  <1> 	dec	bp
  2861 00001119 75EF                <1> 	jnz	short lff22s_2_2
  2862                              <1> 
  2863 0000111B A0[7519]            <1> 	mov	al, [faz]
  2864 0000111E FEC8                <1> 	dec	al
  2865 00001120 74D2                <1> 	jz	short lff22s_9
  2866 00001122 FE0E[7519]          <1> 	dec	byte [faz]
  2867 00001126 BD0400              <1> 	mov	bp, 4
  2868 00001129 FEC8                <1> 	dec	al
  2869 0000112B 75CF                <1> 	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  2870 0000112D 45                  <1> 	inc	bp ; 5
  2871 0000112E EBCC                <1> 	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2872                              <1> 
  2873                              <1> load_22khz_mono_16_bit:
  2874                              <1> 	; 16/11/2023
  2875 00001130 F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2876                              <1> 					; last of the file?
  2877 00001135 7402                <1> 	jz	short lff22m2_0		; no
  2878 00001137 F9                  <1> 	stc
  2879 00001138 C3                  <1> 	retn
  2880                              <1> 
  2881                              <1> lff22m2_0:
  2882 00001139 8EC0                <1> 	mov	es, ax ; buffer segment	
  2883 0000113B 31FF                <1> 	xor	di, di
  2884 0000113D BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2885                              <1> 	; ds = cs
  2886                              <1> 
  2887                              <1> 	; load file into memory
  2888 00001140 8B0E[4D06]          <1>         mov	cx, [loadsize]
  2889 00001144 8B1E[541D]          <1> 	mov	bx, [filehandle]
  2890 00001148 B43F                <1>        	mov	ah, 3Fh
  2891 0000114A CD21                <1> 	int	21h
  2892 0000114C 7248                <1> 	jc	short lff22m2_7 ; error !
  2893                              <1> 
  2894 0000114E 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2895                              <1> 	
  2896 00001150 D1E8                <1> 	shr	ax, 1
  2897                              <1> 	;and	ax, ax
  2898 00001152 7503                <1> 	jnz	short lff22m2_8
  2899 00001154 E9BEF7              <1> 	jmp	lff22_eof
  2900                              <1> 
  2901                              <1> lff22m2_8:
  2902 00001157 89C1                <1> 	mov	cx, ax		; word count
  2903                              <1> lff22m2_9:
  2904 00001159 BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2905 0000115C C606[7519]03        <1> 	mov	byte [faz], 3  ; 3 steps/phases
  2906                              <1> lff22m2_1:
  2907                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2908 00001161 AD                  <1> 	lodsw
  2909 00001162 31D2                <1> 	xor	dx, dx
  2910 00001164 49                  <1> 	dec	cx
  2911 00001165 7402                <1> 	jz	short lff22m2_2_1
  2912 00001167 8B14                <1> 	mov	dx, [si]
  2913                              <1> lff22m2_2_1:	
  2914                              <1> 	; ax = [previous_val]
  2915                              <1> 	; dx = [next_val]
  2916 00001169 E88104              <1> 	call	interpolating_3_16bit_mono ; 1 of 17
  2917 0000116C E325                <1> 	jcxz	lff22m2_3
  2918                              <1> lff22m2_2_2:
  2919 0000116E AD                  <1> 	lodsw
  2920 0000116F 31D2                <1> 	xor	dx, dx
  2921 00001171 49                  <1> 	dec	cx
  2922 00001172 7402                <1> 	jz	short lff22m2_2_3
  2923 00001174 8B14                <1> 	mov	dx, [si]
  2924                              <1> lff22m2_2_3:
  2925 00001176 E8E104              <1>  	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  2926 00001179 E318                <1> 	jcxz	lff22m2_3
  2927 0000117B 4D                  <1> 	dec	bp
  2928 0000117C 75F0                <1> 	jnz	short lff22m2_2_2
  2929                              <1> 
  2930 0000117E A0[7519]            <1> 	mov	al, [faz]
  2931 00001181 FEC8                <1> 	dec	al
  2932 00001183 74D4                <1> 	jz	short lff22m2_9
  2933 00001185 FE0E[7519]          <1> 	dec	byte [faz]
  2934 00001189 BD0400              <1> 	mov	bp, 4
  2935 0000118C FEC8                <1> 	dec	al
  2936 0000118E 75D1                <1> 	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2937 00001190 45                  <1> 	inc	bp ; 5
  2938 00001191 EBCE                <1> 	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2939                              <1> 
  2940                              <1> lff22m2_3:
  2941                              <1> lff22s2_3:
  2942 00001193 E96CF7              <1> 	jmp	lff22_3	; padfill
  2943                              <1> 		; (put zeros in the remain words of the buffer)
  2944                              <1> lff22m2_7:
  2945                              <1> lff22s2_7:
  2946 00001196 E983F7              <1> 	jmp	lff22_5  ; error
  2947                              <1> 
  2948                              <1> load_22khz_stereo_16_bit:
  2949                              <1> 	; 16/11/2023
  2950 00001199 F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2951                              <1> 					; last of the file?
  2952 0000119E 7402                <1> 	jz	short lff22s2_0		; no
  2953 000011A0 F9                  <1> 	stc
  2954 000011A1 C3                  <1> 	retn
  2955                              <1> 
  2956                              <1> lff22s2_0:
  2957 000011A2 8EC0                <1> 	mov	es, ax ; buffer segment	
  2958 000011A4 31FF                <1> 	xor	di, di
  2959 000011A6 BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2960                              <1> 	; ds = cs
  2961                              <1> 
  2962                              <1> 	; load file into memory
  2963 000011A9 8B0E[4D06]          <1>         mov	cx, [loadsize]
  2964 000011AD 8B1E[541D]          <1> 	mov	bx, [filehandle]
  2965 000011B1 B43F                <1>        	mov	ah, 3Fh
  2966 000011B3 CD21                <1> 	int	21h
  2967 000011B5 72DF                <1> 	jc	short lff22s2_7 ; error !
  2968                              <1> 
  2969 000011B7 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2970                              <1> 	
  2971 000011B9 C1E802              <1> 	shr	ax, 2	; dword (left chan word + right chan word)
  2972                              <1> 	;and	ax, ax
  2973 000011BC 7503                <1> 	jnz	short lff22s2_8
  2974 000011BE E954F7              <1> 	jmp	lff22_eof
  2975                              <1> 
  2976                              <1> lff22s2_8:
  2977 000011C1 89C1                <1> 	mov	cx, ax		; dword count
  2978                              <1> lff22s2_9:
  2979 000011C3 BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2980 000011C6 C606[7519]03        <1> 	mov	byte [faz], 3  ; 3 steps/phase
  2981                              <1> lff22s2_1:
  2982                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2983 000011CB AD                  <1> 	lodsw
  2984 000011CC 89C3                <1> 	mov	bx, ax
  2985 000011CE AD                  <1> 	lodsw
  2986 000011CF 8B14                <1> 	mov	dx, [si]
  2987 000011D1 8916[7119]          <1> 	mov	[next_val_l], dx
  2988 000011D5 8B5402              <1> 	mov	dx, [si+2]
  2989 000011D8 49                  <1> 	dec	cx
  2990 000011D9 7506                <1> 	jnz	short lff22s2_2_1
  2991 000011DB 31D2                <1> 	xor	dx, dx ; 0
  2992 000011DD 8916[7119]          <1> 	mov	[next_val_l], dx
  2993                              <1> lff22s2_2_1:
  2994                              <1> 	; bx = [previous_val_l]
  2995                              <1> 	; ax = [previous_val_r]
  2996                              <1> 	; [next_val_l]
  2997                              <1> 	; dx = [next_val_r]
  2998 000011E1 E82D04              <1> 	call	interpolating_3_16bit_stereo ; 1 of 17 
  2999 000011E4 E3AD                <1> 	jcxz	lff22s2_3
  3000                              <1> lff22s2_2_2:
  3001 000011E6 AD                  <1> 	lodsw
  3002 000011E7 89C3                <1> 	mov	bx, ax
  3003 000011E9 AD                  <1> 	lodsw
  3004 000011EA 8B14                <1> 	mov	dx, [si]
  3005 000011EC 8916[7119]          <1> 	mov	[next_val_l], dx
  3006 000011F0 8B5402              <1> 	mov	dx, [si+2]
  3007 000011F3 49                  <1> 	dec	cx
  3008 000011F4 7506                <1> 	jnz	short lff22s2_2_3
  3009 000011F6 31D2                <1> 	xor	dx, dx ; 0
  3010 000011F8 8916[7119]          <1> 	mov	[next_val_l], dx
  3011                              <1> lff22s2_2_3:
  3012 000011FC E86D04              <1>  	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  3013 000011FF E392                <1> 	jcxz	lff22s2_3
  3014 00001201 4D                  <1> 	dec	bp
  3015 00001202 75E2                <1> 	jnz	short lff22s2_2_2
  3016                              <1> 
  3017 00001204 A0[7519]            <1> 	mov	al, [faz]
  3018 00001207 FEC8                <1> 	dec	al
  3019 00001209 74B8                <1> 	jz	short lff22s2_9
  3020 0000120B FE0E[7519]          <1> 	dec	byte [faz]
  3021 0000120F BD0400              <1> 	mov	bp, 4
  3022 00001212 FEC8                <1> 	dec	al
  3023 00001214 75B5                <1> 	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  3024 00001216 45                  <1> 	inc	bp ; 5
  3025 00001217 EBB2                <1> 	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  3026                              <1> 
  3027                              <1> ; .....................
  3028                              <1> 
  3029                              <1> load_11khz_mono_8_bit:
  3030                              <1> 	; 18/11/2023
  3031 00001219 F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3032                              <1> 					; last of the file?
  3033 0000121E 7402                <1> 	jz	short lff11m_0		; no
  3034 00001220 F9                  <1> 	stc
  3035 00001221 C3                  <1> 	retn
  3036                              <1> 
  3037                              <1> lff11m_0:
  3038 00001222 8EC0                <1> 	mov	es, ax ; buffer segment	
  3039 00001224 31FF                <1> 	xor	di, di
  3040 00001226 BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3041                              <1> 	; ds = cs
  3042                              <1> 
  3043                              <1> 	; load file into memory
  3044 00001229 8B0E[4D06]          <1>         mov	cx, [loadsize]
  3045 0000122D 8B1E[541D]          <1> 	mov	bx, [filehandle]
  3046 00001231 B43F                <1>        	mov	ah, 3Fh
  3047 00001233 CD21                <1> 	int	21h
  3048 00001235 723D                <1> 	jc	short lff11m_7 ; error !
  3049                              <1> 
  3050 00001237 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3051                              <1> 	
  3052 00001239 21C0                <1> 	and	ax, ax
  3053 0000123B 7503                <1> 	jnz	short lff11m_8
  3054 0000123D E9D5F6              <1> 	jmp	lff11_eof
  3055                              <1> 
  3056                              <1> lff11m_8:
  3057 00001240 89C1                <1> 	mov	cx, ax		; byte count
  3058                              <1> lff11m_9:
  3059 00001242 BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  3060                              <1> lff11m_1:
  3061                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3062 00001245 AC                  <1> 	lodsb
  3063 00001246 B280                <1> 	mov	dl, 80h
  3064 00001248 49                  <1> 	dec	cx
  3065 00001249 7402                <1> 	jz	short lff11m_2_1
  3066 0000124B 8A14                <1> 	mov	dl, [si]
  3067                              <1> lff11m_2_1:	
  3068                              <1> 	; al = [previous_val]
  3069                              <1> 	; dl = [next_val]
  3070 0000124D E84204              <1> 	call	interpolating_5_8bit_mono
  3071 00001250 E31F                <1> 	jcxz	lff11m_3
  3072                              <1> lff11m_2_2:
  3073 00001252 AC                  <1> 	lodsb
  3074 00001253 B280                <1> 	mov	dl, 80h
  3075 00001255 49                  <1> 	dec	cx
  3076 00001256 7402                <1> 	jz	short lff11m_2_3
  3077 00001258 8A14                <1> 	mov	dl, [si]
  3078                              <1> lff11m_2_3:
  3079 0000125A E81E05              <1>  	call	interpolating_4_8bit_mono
  3080 0000125D E312                <1> 	jcxz	lff11m_3
  3081                              <1> 
  3082 0000125F 4D                  <1> 	dec	bp
  3083 00001260 74E0                <1> 	jz	short lff11m_9
  3084                              <1> 
  3085 00001262 AC                  <1> 	lodsb
  3086 00001263 B280                <1> 	mov	dl, 80h
  3087 00001265 49                  <1> 	dec	cx
  3088 00001266 7402                <1> 	jz	short lff11m_2_4
  3089 00001268 8A14                <1> 	mov	dl, [si]
  3090                              <1> lff11m_2_4:
  3091 0000126A E80E05              <1> 	call	interpolating_4_8bit_mono
  3092 0000126D E302                <1> 	jcxz	lff11m_3
  3093 0000126F EBD4                <1> 	jmp	short lff11m_1
  3094                              <1> 
  3095                              <1> lff11m_3:
  3096                              <1> lff11s_3:
  3097 00001271 E98EF6              <1> 	jmp	lff11_3	; padfill
  3098                              <1> 		; (put zeros in the remain words of the buffer)
  3099                              <1> lff11m_7:
  3100                              <1> lff11s_7:
  3101 00001274 E9A5F6              <1> 	jmp	lff11_5  ; error
  3102                              <1> 
  3103                              <1> load_11khz_stereo_8_bit:
  3104                              <1> 	; 18/11/2023
  3105 00001277 F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3106                              <1> 					; last of the file?
  3107 0000127C 7402                <1> 	jz	short lff11s_0		; no
  3108 0000127E F9                  <1> 	stc
  3109 0000127F C3                  <1> 	retn
  3110                              <1> 
  3111                              <1> lff11s_0:
  3112 00001280 8EC0                <1> 	mov	es, ax ; buffer segment	
  3113 00001282 31FF                <1> 	xor	di, di
  3114 00001284 BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3115                              <1> 	; ds = cs
  3116                              <1> 
  3117                              <1> 	; load file into memory
  3118 00001287 8B0E[4D06]          <1>         mov	cx, [loadsize]
  3119 0000128B 8B1E[541D]          <1> 	mov	bx, [filehandle]
  3120 0000128F B43F                <1>        	mov	ah, 3Fh
  3121 00001291 CD21                <1> 	int	21h
  3122 00001293 72DF                <1> 	jc	short lff11s_7 ; error !
  3123                              <1> 
  3124 00001295 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3125                              <1> 	
  3126 00001297 D1E8                <1> 	shr	ax, 1
  3127                              <1> 	;and	ax, ax
  3128 00001299 7503                <1> 	jnz	short lff11s_8
  3129 0000129B E977F6              <1> 	jmp	lff11_eof
  3130                              <1> 
  3131                              <1> lff11s_8:
  3132 0000129E 89C1                <1> 	mov	cx, ax		; word count
  3133                              <1> lff11s_9:
  3134 000012A0 BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  3135                              <1> lff11s_1:
  3136                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3137 000012A3 AD                  <1> 	lodsw
  3138 000012A4 BA8080              <1> 	mov	dx, 8080h
  3139 000012A7 49                  <1> 	dec	cx
  3140 000012A8 7402                <1> 	jz	short lff11s_2_1 
  3141 000012AA 8B14                <1> 	mov	dx, [si]
  3142                              <1> lff11s_2_1:	
  3143                              <1> 	; al = [previous_val_l]
  3144                              <1> 	; ah = [previous_val_r]
  3145                              <1> 	; dl = [next_val_l]
  3146                              <1> 	; dl = [next_val_r]	
  3147 000012AC E83304              <1> 	call	interpolating_5_8bit_stereo
  3148 000012AF E3C0                <1> 	jcxz	lff11s_3
  3149                              <1> lff11s_2_2:
  3150 000012B1 AD                  <1> 	lodsw
  3151 000012B2 BA8080              <1> 	mov	dx, 8080h
  3152 000012B5 49                  <1> 	dec	cx
  3153 000012B6 7402                <1> 	jz	short lff11s_2_3
  3154 000012B8 8B14                <1> 	mov	dx, [si]
  3155                              <1> lff11s_2_3:
  3156 000012BA E8F104              <1>  	call	interpolating_4_8bit_stereo
  3157 000012BD E3B2                <1> 	jcxz	lff11s_3
  3158                              <1> 	
  3159 000012BF 4D                  <1> 	dec	bp
  3160 000012C0 74DE                <1> 	jz	short lff11s_9
  3161                              <1> 
  3162 000012C2 AD                  <1> 	lodsw
  3163 000012C3 BA8080              <1> 	mov	dx, 8080h
  3164 000012C6 49                  <1> 	dec	cx
  3165 000012C7 7402                <1> 	jz	short lff11s_2_4
  3166 000012C9 8B14                <1> 	mov	dx, [si]
  3167                              <1> lff11s_2_4:
  3168 000012CB E8E004              <1> 	call	interpolating_4_8bit_stereo
  3169 000012CE E3A1                <1> 	jcxz	lff11s_3
  3170 000012D0 EBD1                <1> 	jmp	short lff11s_1
  3171                              <1> 
  3172                              <1> load_11khz_mono_16_bit:
  3173                              <1> 	; 18/11/2023
  3174 000012D2 F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3175                              <1> 					; last of the file?
  3176 000012D7 7402                <1> 	jz	short lff11m2_0		; no
  3177 000012D9 F9                  <1> 	stc
  3178 000012DA C3                  <1> 	retn
  3179                              <1> 
  3180                              <1> lff11m2_0:
  3181 000012DB 8EC0                <1> 	mov	es, ax ; buffer segment	
  3182 000012DD 31FF                <1> 	xor	di, di
  3183 000012DF BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3184                              <1> 	; ds = cs
  3185                              <1> 
  3186                              <1> 	; load file into memory
  3187 000012E2 8B0E[4D06]          <1>         mov	cx, [loadsize]
  3188 000012E6 8B1E[541D]          <1> 	mov	bx, [filehandle]
  3189 000012EA B43F                <1>        	mov	ah, 3Fh
  3190 000012EC CD21                <1> 	int	21h
  3191 000012EE 723A                <1> 	jc	short lff11m2_7 ; error !
  3192                              <1> 
  3193 000012F0 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3194                              <1> 	
  3195 000012F2 D1E8                <1> 	shr	ax, 1
  3196                              <1> 	;and	ax, ax
  3197 000012F4 7503                <1> 	jnz	short lff11m2_8
  3198 000012F6 E91CF6              <1> 	jmp	lff11_eof
  3199                              <1> 
  3200                              <1> lff11m2_8:
  3201 000012F9 89C1                <1> 	mov	cx, ax		; word count
  3202                              <1> lff11m2_9:
  3203 000012FB BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  3204                              <1> lff11m2_1:
  3205                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3206 000012FE AD                  <1> 	lodsw
  3207 000012FF 31D2                <1> 	xor	dx, dx
  3208 00001301 49                  <1> 	dec	cx
  3209 00001302 7402                <1> 	jz	short lff11m2_2_1
  3210 00001304 8B14                <1> 	mov	dx, [si]
  3211                              <1> lff11m2_2_1:	
  3212                              <1> 	; ax = [previous_val]
  3213                              <1> 	; dx = [next_val]
  3214 00001306 E80205              <1> 	call	interpolating_5_16bit_mono
  3215 00001309 E34A                <1> 	jcxz	lff11m2_3
  3216                              <1> lff11m2_2_2:
  3217 0000130B AD                  <1> 	lodsw
  3218 0000130C 31D2                <1> 	xor	dx, dx
  3219 0000130E 49                  <1> 	dec	cx
  3220 0000130F 7402                <1> 	jz	short lff11m2_2_3
  3221 00001311 8B14                <1> 	mov	dx, [si]
  3222                              <1> lff11m2_2_3:
  3223 00001313 E8D005              <1>  	call	interpolating_4_16bit_mono
  3224 00001316 E33D                <1> 	jcxz	lff11m2_3
  3225                              <1> 
  3226 00001318 4D                  <1> 	dec	bp
  3227 00001319 74E0                <1> 	jz	short lff11m2_9
  3228                              <1> 
  3229 0000131B AD                  <1> 	lodsw
  3230 0000131C 31D2                <1> 	xor	dx, dx
  3231 0000131E 49                  <1> 	dec	cx
  3232 0000131F 7402                <1> 	jz	short lff11m2_2_4
  3233 00001321 8B14                <1> 	mov	dx, [si]
  3234                              <1> lff11m2_2_4:
  3235 00001323 E8C005              <1>  	call	interpolating_4_16bit_mono
  3236 00001326 E32D                <1> 	jcxz	lff11m2_3
  3237 00001328 EBD4                <1> 	jmp	short lff11m2_1
  3238                              <1> 
  3239                              <1> lff11m2_7:
  3240                              <1> lff11s2_7:
  3241 0000132A E9EFF5              <1> 	jmp	lff11_5  ; error
  3242                              <1> 
  3243                              <1> load_11khz_stereo_16_bit:
  3244                              <1> 	; 18/11/2023
  3245 0000132D F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3246                              <1> 					; last of the file?
  3247 00001332 7402                <1> 	jz	short lff11s2_0		; no
  3248 00001334 F9                  <1> 	stc
  3249 00001335 C3                  <1> 	retn
  3250                              <1> 
  3251                              <1> lff11s2_0:
  3252 00001336 8EC0                <1> 	mov	es, ax ; buffer segment	
  3253 00001338 31FF                <1> 	xor	di, di
  3254 0000133A BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3255                              <1> 	; ds = cs
  3256                              <1> 
  3257                              <1> 	; load file into memory
  3258 0000133D 8B0E[4D06]          <1>         mov	cx, [loadsize]
  3259 00001341 8B1E[541D]          <1> 	mov	bx, [filehandle]
  3260 00001345 B43F                <1>        	mov	ah, 3Fh
  3261 00001347 CD21                <1> 	int	21h
  3262 00001349 72DF                <1> 	jc	short lff11s2_7 ; error !
  3263                              <1> 
  3264 0000134B 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3265                              <1> 	
  3266 0000134D C1E802              <1> 	shr	ax, 2	; dword (left chan word + right chan word)
  3267                              <1> 	;and	ax, ax
  3268 00001350 7506                <1> 	jnz	short lff11s2_8
  3269 00001352 E9C0F5              <1> 	jmp	lff11_eof
  3270                              <1> 
  3271                              <1> lff11m2_3:
  3272                              <1> lff11s2_3:
  3273 00001355 E9AAF5              <1> 	jmp	lff11_3	; padfill
  3274                              <1> 		; (put zeros in the remain words of the buffer)
  3275                              <1> 
  3276                              <1> lff11s2_8:
  3277 00001358 89C1                <1> 	mov	cx, ax		; dword count
  3278                              <1> lff11s2_9:
  3279 0000135A BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  3280                              <1> lff11s2_1:
  3281                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3282 0000135D AD                  <1> 	lodsw
  3283 0000135E 89C3                <1> 	mov	bx, ax
  3284 00001360 AD                  <1> 	lodsw
  3285 00001361 8B14                <1> 	mov	dx, [si]
  3286 00001363 8916[7119]          <1> 	mov	[next_val_l], dx
  3287 00001367 8B5402              <1> 	mov	dx, [si+2]
  3288 0000136A 8916[7319]          <1> 	mov	[next_val_r], dx
  3289 0000136E 49                  <1> 	dec	cx
  3290 0000136F 750A                <1> 	jnz	short lff11s2_2_1
  3291 00001371 31D2                <1> 	xor	dx, dx ; 0
  3292 00001373 8916[7119]          <1> 	mov	[next_val_l], dx
  3293 00001377 8916[7319]          <1> 	mov	[next_val_r], dx
  3294                              <1> lff11s2_2_1:
  3295                              <1> 	; bx = [previous_val_l]
  3296                              <1> 	; ax = [previous_val_r]
  3297                              <1> 	; [next_val_l]
  3298                              <1> 	; dx = [next_val_r]
  3299 0000137B E8D004              <1> 	call	interpolating_5_16bit_stereo
  3300 0000137E E3D5                <1> 	jcxz	lff11s2_3
  3301                              <1> lff11s2_2_2:
  3302 00001380 AD                  <1> 	lodsw
  3303 00001381 89C3                <1> 	mov	bx, ax
  3304 00001383 AD                  <1> 	lodsw
  3305 00001384 8B14                <1> 	mov	dx, [si]
  3306 00001386 8916[7119]          <1> 	mov	[next_val_l], dx
  3307 0000138A 8B5402              <1> 	mov	dx, [si+2]
  3308 0000138D 8916[7319]          <1> 	mov	[next_val_r], dx
  3309 00001391 49                  <1> 	dec	cx
  3310 00001392 750A                <1> 	jnz	short lff11s2_2_3
  3311 00001394 31D2                <1> 	xor	dx, dx ; 0
  3312 00001396 8916[7119]          <1> 	mov	[next_val_l], dx
  3313 0000139A 8916[7319]          <1> 	mov	[next_val_r], dx
  3314                              <1> lff11s2_2_3:
  3315 0000139E E87005              <1>  	call	interpolating_4_16bit_stereo
  3316 000013A1 E3B2                <1> 	jcxz	lff11s2_3
  3317                              <1> 	
  3318 000013A3 4D                  <1> 	dec	bp
  3319 000013A4 74B4                <1> 	jz	short lff11s2_9
  3320                              <1> 
  3321 000013A6 AD                  <1> 	lodsw
  3322 000013A7 89C3                <1> 	mov	bx, ax
  3323 000013A9 AD                  <1> 	lodsw
  3324 000013AA 8B14                <1> 	mov	dx, [si]
  3325 000013AC 8916[7119]          <1> 	mov	[next_val_l], dx
  3326 000013B0 8B5402              <1> 	mov	dx, [si+2]
  3327 000013B3 8916[7319]          <1> 	mov	[next_val_r], dx
  3328 000013B7 49                  <1> 	dec	cx
  3329 000013B8 750A                <1> 	jnz	short lff11s2_2_4
  3330 000013BA 31D2                <1> 	xor	dx, dx ; 0
  3331 000013BC 8916[7119]          <1> 	mov	[next_val_l], dx
  3332 000013C0 8916[7319]          <1> 	mov	[next_val_r], dx
  3333                              <1> lff11s2_2_4:
  3334 000013C4 E84A05              <1>  	call	interpolating_4_16bit_stereo
  3335 000013C7 E38C                <1> 	jcxz	lff11s2_3
  3336 000013C9 EB92                <1> 	jmp	short lff11s2_1
  3337                              <1> 
  3338                              <1> ; .....................
  3339                              <1> 
  3340                              <1> load_44khz_mono_8_bit:
  3341                              <1> 	; 18/11/2023
  3342 000013CB F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3343                              <1> 					; last of the file?
  3344 000013D0 7402                <1> 	jz	short lff44m_0		; no
  3345 000013D2 F9                  <1> 	stc
  3346 000013D3 C3                  <1> 	retn
  3347                              <1> 
  3348                              <1> lff44m_0:
  3349 000013D4 8EC0                <1> 	mov	es, ax ; buffer segment	
  3350 000013D6 31FF                <1> 	xor	di, di
  3351 000013D8 BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3352                              <1> 	; ds = cs
  3353                              <1> 
  3354                              <1> 	; load file into memory
  3355 000013DB 8B0E[4D06]          <1>         mov	cx, [loadsize]
  3356 000013DF 8B1E[541D]          <1> 	mov	bx, [filehandle]
  3357 000013E3 B43F                <1>        	mov	ah, 3Fh
  3358 000013E5 CD21                <1> 	int	21h
  3359 000013E7 723C                <1> 	jc	short lff44m_7 ; error !
  3360                              <1> 
  3361 000013E9 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3362                              <1> 	
  3363 000013EB 21C0                <1> 	and	ax, ax
  3364 000013ED 7503                <1> 	jnz	short lff44m_8
  3365 000013EF E923F5              <1> 	jmp	lff44_eof
  3366                              <1> 
  3367                              <1> lff44m_8:
  3368 000013F2 89C1                <1> 	mov	cx, ax		; byte count
  3369                              <1> lff44m_9:
  3370 000013F4 BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3371 000013F7 C606[7519]02        <1> 	mov	byte [faz], 2  ; 2 steps/phases
  3372                              <1> lff44m_1:
  3373                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3374                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3375 000013FC AC                  <1> 	lodsb
  3376 000013FD B280                <1> 	mov	dl, 80h
  3377 000013FF 49                  <1> 	dec	cx
  3378 00001400 7402                <1> 	jz	short lff44m_2_1
  3379 00001402 8A14                <1> 	mov	dl, [si]
  3380                              <1> lff44m_2_1:	
  3381                              <1> 	; al = [previous_val]
  3382                              <1> 	; dl = [next_val]
  3383 00001404 E8A601              <1> 	call	interpolating_2_8bit_mono
  3384 00001407 E319                <1> 	jcxz	lff44m_3
  3385                              <1> lff44m_2_2:
  3386 00001409 AC                  <1> 	lodsb
  3387 0000140A 2C80                <1> 	sub	al, 80h
  3388 0000140C C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3389 0000140F AB                  <1> 	stosw		; (L)
  3390 00001410 AB                  <1> 	stosw		; (R)	
  3391                              <1> 
  3392 00001411 49                  <1> 	dec	cx
  3393 00001412 740E                <1> 	jz	short lff44m_3	
  3394 00001414 4D                  <1> 	dec	bp
  3395 00001415 75F2                <1> 	jnz	short lff44m_2_2
  3396                              <1> 	
  3397 00001417 FE0E[7519]          <1> 	dec	byte [faz]
  3398 0000141B 74D7                <1> 	jz	short lff44m_9 
  3399 0000141D BD0B00              <1> 	mov	bp, 11
  3400 00001420 EBDA                <1> 	jmp	short lff44m_1
  3401                              <1> 
  3402                              <1> lff44m_3:
  3403                              <1> lff44s_3:
  3404 00001422 E9DDF4              <1> 	jmp	lff44_3	; padfill
  3405                              <1> 		; (put zeros in the remain words of the buffer)
  3406                              <1> lff44m_7:
  3407                              <1> lff44s_7:
  3408 00001425 E9F4F4              <1> 	jmp	lff44_5  ; error
  3409                              <1> 
  3410                              <1> load_44khz_stereo_8_bit:
  3411                              <1> 	; 16/11/2023
  3412 00001428 F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3413                              <1> 					; last of the file?
  3414 0000142D 7402                <1> 	jz	short lff44s_0		; no
  3415 0000142F F9                  <1> 	stc
  3416 00001430 C3                  <1> 	retn
  3417                              <1> 
  3418                              <1> lff44s_0:
  3419 00001431 8EC0                <1> 	mov	es, ax ; buffer segment	
  3420 00001433 31FF                <1> 	xor	di, di
  3421 00001435 BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3422                              <1> 	; ds = cs
  3423                              <1> 
  3424                              <1> 	; load file into memory
  3425 00001438 8B0E[4D06]          <1>         mov	cx, [loadsize]
  3426 0000143C 8B1E[541D]          <1> 	mov	bx, [filehandle]
  3427 00001440 B43F                <1>        	mov	ah, 3Fh
  3428 00001442 CD21                <1> 	int	21h
  3429 00001444 72DF                <1> 	jc	short lff44s_7 ; error !
  3430                              <1> 
  3431 00001446 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3432                              <1> 	
  3433 00001448 D1E8                <1> 	shr	ax, 1
  3434                              <1> 	;and	ax, ax
  3435 0000144A 7503                <1> 	jnz	short lff44s_8
  3436 0000144C E9C6F4              <1> 	jmp	lff44_eof
  3437                              <1> 
  3438                              <1> lff44s_8:
  3439 0000144F 89C1                <1> 	mov	cx, ax		; word count
  3440                              <1> lff44s_9:
  3441 00001451 BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3442 00001454 C606[7519]02        <1> 	mov	byte [faz], 2  ; 2 steps/phase
  3443                              <1> lff44s_1:
  3444                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3445                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3446 00001459 AD                  <1> 	lodsw
  3447 0000145A BA8080              <1> 	mov	dx, 8080h
  3448 0000145D 49                  <1> 	dec	cx
  3449 0000145E 7402                <1> 	jz	short lff44s_2_1 
  3450 00001460 8B14                <1> 	mov	dx, [si]
  3451                              <1> lff44s_2_1:	
  3452                              <1> 	; al = [previous_val_l]
  3453                              <1> 	; ah = [previous_val_r]
  3454                              <1> 	; dl = [next_val_l]
  3455                              <1> 	; dl = [next_val_r]	
  3456 00001462 E85F01              <1> 	call	interpolating_2_8bit_stereo
  3457 00001465 E3BB                <1> 	jcxz	lff44s_3
  3458                              <1> lff44s_2_2:
  3459 00001467 AC                  <1> 	lodsb
  3460 00001468 2C80                <1> 	sub	al, 80h
  3461 0000146A C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3462 0000146D AB                  <1> 	stosw		; (L)
  3463 0000146E AC                  <1> 	lodsb
  3464 0000146F 2C80                <1> 	sub	al, 80h
  3465 00001471 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3466 00001474 AB                  <1> 	stosw		; (R)
  3467                              <1> 
  3468 00001475 49                  <1> 	dec	cx
  3469 00001476 74AA                <1> 	jz	short lff44s_3	
  3470 00001478 4D                  <1> 	dec	bp
  3471 00001479 75EC                <1> 	jnz	short lff44s_2_2
  3472                              <1> 	
  3473 0000147B FE0E[7519]          <1> 	dec	byte [faz]
  3474 0000147F 74D0                <1> 	jz	short lff44s_9 
  3475 00001481 BD0B00              <1> 	mov	bp, 11
  3476 00001484 EBD3                <1> 	jmp	short lff44s_1
  3477                              <1> 
  3478                              <1> load_44khz_mono_16_bit:
  3479                              <1> 	; 18/11/2023
  3480 00001486 F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3481                              <1> 					; last of the file?
  3482 0000148B 7402                <1> 	jz	short lff44m2_0		; no
  3483 0000148D F9                  <1> 	stc
  3484 0000148E C3                  <1> 	retn
  3485                              <1> 
  3486                              <1> lff44m2_0:
  3487 0000148F 8EC0                <1> 	mov	es, ax ; buffer segment	
  3488 00001491 31FF                <1> 	xor	di, di
  3489 00001493 BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3490                              <1> 	; ds = cs
  3491                              <1> 
  3492                              <1> 	; load file into memory
  3493 00001496 8B0E[4D06]          <1>         mov	cx, [loadsize]
  3494 0000149A 8B1E[541D]          <1> 	mov	bx, [filehandle]
  3495 0000149E B43F                <1>        	mov	ah, 3Fh
  3496 000014A0 CD21                <1> 	int	21h
  3497 000014A2 7237                <1> 	jc	short lff44m2_7 ; error !
  3498                              <1> 
  3499 000014A4 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3500                              <1> 	
  3501 000014A6 D1E8                <1> 	shr	ax, 1
  3502                              <1> 	;and	ax, ax
  3503 000014A8 7503                <1> 	jnz	short lff44m2_8
  3504 000014AA E968F4              <1> 	jmp	lff44_eof
  3505                              <1> 
  3506                              <1> lff44m2_8:
  3507 000014AD 89C1                <1> 	mov	cx, ax		; word count
  3508                              <1> lff44m2_9:
  3509 000014AF BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3510 000014B2 C606[7519]02        <1> 	mov	byte [faz], 2  ; 2 steps/phases
  3511                              <1> lff44m2_1:
  3512                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3513                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3514 000014B7 AD                  <1> 	lodsw
  3515 000014B8 31D2                <1> 	xor	dx, dx
  3516 000014BA 49                  <1> 	dec	cx
  3517 000014BB 7402                <1> 	jz	short lff44m2_2_1
  3518 000014BD 8B14                <1> 	mov	dx, [si]
  3519                              <1> lff44m2_2_1:	
  3520                              <1> 	; ax = [previous_val]
  3521                              <1> 	; dx = [next_val]
  3522 000014BF E89801              <1> 	call	interpolating_2_16bit_mono
  3523 000014C2 E314                <1> 	jcxz	lff44m2_3
  3524                              <1> lff44m2_2_2:
  3525 000014C4 AD                  <1> 	lodsw
  3526 000014C5 AB                  <1> 	stosw		; (L)eft Channel
  3527 000014C6 AB                  <1> 	stosw		; (R)ight Channel
  3528                              <1> 
  3529 000014C7 49                  <1> 	dec	cx
  3530 000014C8 740E                <1> 	jz	short lff44m2_3	
  3531 000014CA 4D                  <1> 	dec	bp
  3532 000014CB 75F7                <1> 	jnz	short lff44m2_2_2
  3533                              <1> 	
  3534 000014CD FE0E[7519]          <1> 	dec	byte [faz]
  3535 000014D1 74DC                <1> 	jz	short lff44m2_9 
  3536 000014D3 BD0B00              <1> 	mov	bp, 11
  3537 000014D6 EBDF                <1> 	jmp	short lff44m2_1
  3538                              <1> 
  3539                              <1> lff44m2_3:
  3540                              <1> lff44s2_3:
  3541 000014D8 E927F4              <1> 	jmp	lff44_3	; padfill
  3542                              <1> 		; (put zeros in the remain words of the buffer)
  3543                              <1> lff44m2_7:
  3544                              <1> lff44s2_7:
  3545 000014DB E93EF4              <1> 	jmp	lff44_5  ; error
  3546                              <1> 
  3547                              <1> load_44khz_stereo_16_bit:
  3548                              <1> 	; 18/11/2023
  3549 000014DE F606[561D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3550                              <1> 					; last of the file?
  3551 000014E3 7402                <1> 	jz	short lff44s2_0		; no
  3552 000014E5 F9                  <1> 	stc
  3553 000014E6 C3                  <1> 	retn
  3554                              <1> 
  3555                              <1> lff44s2_0:
  3556 000014E7 8EC0                <1> 	mov	es, ax ; buffer segment	
  3557 000014E9 31FF                <1> 	xor	di, di
  3558 000014EB BA[721D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3559                              <1> 	; ds = cs
  3560                              <1> 
  3561                              <1> 	; load file into memory
  3562 000014EE 8B0E[4D06]          <1>         mov	cx, [loadsize]
  3563 000014F2 8B1E[541D]          <1> 	mov	bx, [filehandle]
  3564 000014F6 B43F                <1>        	mov	ah, 3Fh
  3565 000014F8 CD21                <1> 	int	21h
  3566 000014FA 72DF                <1> 	jc	short lff44s2_7 ; error !
  3567                              <1> 
  3568 000014FC 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3569                              <1> 	
  3570 000014FE C1E802              <1> 	shr	ax, 2	; dword (left chan word + right chan word)
  3571                              <1> 	;and	ax, ax
  3572 00001501 7503                <1> 	jnz	short lff44s2_8
  3573 00001503 E90FF4              <1> 	jmp	lff44_eof
  3574                              <1> 
  3575                              <1> lff44s2_8:
  3576 00001506 89C1                <1> 	mov	cx, ax		; dword count
  3577                              <1> lff44s2_9:
  3578 00001508 BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3579 0000150B C606[7519]02        <1> 	mov	byte [faz], 2  ; 2 steps/phase
  3580                              <1> lff44s2_1:
  3581                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3582                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3583 00001510 AD                  <1> 	lodsw
  3584 00001511 89C3                <1> 	mov	bx, ax
  3585 00001513 AD                  <1> 	lodsw
  3586 00001514 8B14                <1> 	mov	dx, [si]
  3587 00001516 8916[7119]          <1> 	mov	[next_val_l], dx
  3588 0000151A 8B5402              <1> 	mov	dx, [si+2]
  3589 0000151D 49                  <1> 	dec	cx
  3590 0000151E 7506                <1> 	jnz	short lff44s2_2_1
  3591 00001520 31D2                <1> 	xor	dx, dx ; 0
  3592 00001522 8916[7119]          <1> 	mov	[next_val_l], dx
  3593                              <1> lff44s2_2_1:
  3594                              <1> 	; bx = [previous_val_l]
  3595                              <1> 	; ax = [previous_val_r]
  3596                              <1> 	; [next_val_l]
  3597                              <1> 	; dx = [next_val_r]
  3598 00001526 E84301              <1> 	call	interpolating_2_16bit_stereo
  3599 00001529 E3AD                <1> 	jcxz	lff44s2_3
  3600                              <1> lff44s2_2_2:
  3601                              <1> 	;lodsw
  3602                              <1> 	;stosw		; (L)
  3603                              <1> 	;lodsw
  3604                              <1> 	;stosw		; (R)
  3605 0000152B A5                  <1> 	movsw		; (L)eft Channel
  3606 0000152C A5                  <1> 	movsw		; (R)ight Channel
  3607                              <1> 
  3608 0000152D 49                  <1> 	dec	cx
  3609 0000152E 74A8                <1> 	jz	short lff44s2_3	
  3610 00001530 4D                  <1> 	dec	bp
  3611 00001531 75F8                <1> 	jnz	short lff44s2_2_2
  3612                              <1> 	
  3613 00001533 FE0E[7519]          <1> 	dec	byte [faz]
  3614 00001537 74CF                <1> 	jz	short lff44s2_9 
  3615 00001539 BD0B00              <1> 	mov	bp, 11
  3616 0000153C EBD2                <1> 	jmp	short lff44s2_1
  3617                              <1> 
  3618                              <1> ; .....................
  3619                              <1> 
  3620                              <1> interpolating_3_8bit_mono:
  3621                              <1> 	; 16/11/2023
  3622                              <1> 	; al = [previous_val]
  3623                              <1> 	; dl = [next_val]
  3624                              <1> 	; original-interpolated-interpolated
  3625 0000153E 88C3                <1> 	mov	bl, al
  3626 00001540 2C80                <1> 	sub	al, 80h
  3627 00001542 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3628 00001545 AB                  <1> 	stosw		; original sample (L)
  3629 00001546 AB                  <1> 	stosw		; original sample (R)
  3630 00001547 88D8                <1> 	mov	al, bl
  3631 00001549 00D0                <1> 	add	al, dl	
  3632 0000154B D0D8                <1> 	rcr	al, 1
  3633 0000154D 88C7                <1> 	mov	bh, al	; interpolated middle (temporary)
  3634 0000154F 00D8                <1> 	add	al, bl
  3635 00001551 D0D8                <1> 	rcr	al, 1
  3636 00001553 2C80                <1> 	sub	al, 80h
  3637 00001555 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3638 00001558 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3639 00001559 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3640 0000155A 88F8                <1> 	mov	al, bh
  3641 0000155C 00D0                <1> 	add	al, dl	; [next_val]
  3642 0000155E D0D8                <1> 	rcr	al, 1
  3643 00001560 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3644 00001563 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3645 00001564 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3646 00001565 C3                  <1> 	retn
  3647                              <1> 
  3648                              <1> interpolating_3_8bit_stereo:
  3649                              <1> 	; 16/11/2023
  3650                              <1> 	; al = [previous_val_l]
  3651                              <1> 	; ah = [previous_val_r]
  3652                              <1> 	; dl = [next_val_l]
  3653                              <1> 	; dh = [next_val_r]	
  3654                              <1> 	; original-interpolated-interpolated
  3655 00001566 89C3                <1> 	mov	bx, ax
  3656 00001568 2C80                <1> 	sub	al, 80h
  3657 0000156A C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3658 0000156D AB                  <1> 	stosw		; original sample (L)
  3659 0000156E 88F8                <1> 	mov	al, bh
  3660 00001570 2C80                <1> 	sub	al, 80h
  3661 00001572 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3662 00001575 AB                  <1> 	stosw		; original sample (R)
  3663 00001576 88D8                <1> 	mov	al, bl
  3664 00001578 00D0                <1> 	add	al, dl	; [next_val_l]	
  3665 0000157A D0D8                <1> 	rcr	al, 1
  3666 0000157C 50                  <1> 	push	ax ; *	; al = interpolated middle (L) (temporary)
  3667 0000157D 00D8                <1> 	add	al, bl	; [previous_val_l]
  3668 0000157F D0D8                <1> 	rcr	al, 1
  3669 00001581 2C80                <1> 	sub	al, 80h
  3670 00001583 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3671 00001586 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3672 00001587 88F8                <1> 	mov	al, bh
  3673 00001589 00F0                <1> 	add	al, dh	; [next_val_r]
  3674 0000158B D0D8                <1> 	rcr	al, 1
  3675 0000158D 50                  <1> 	push	ax ; ** ; al = interpolated middle (R) (temporary)
  3676 0000158E 00F8                <1> 	add	al, bh	; [previous_val_r]
  3677 00001590 D0D8                <1> 	rcr	al, 1
  3678 00001592 2C80                <1> 	sub	al, 80h
  3679 00001594 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3680 00001597 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3681 00001598 5B                  <1> 	pop	bx ; **
  3682 00001599 58                  <1> 	pop	ax ; *
  3683 0000159A 00D0                <1> 	add	al, dl	; [next_val_l]
  3684 0000159C D0D8                <1> 	rcr	al, 1
  3685 0000159E C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3686 000015A1 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3687 000015A2 88D8                <1> 	mov	al, bl
  3688 000015A4 00F0                <1> 	add	al, dh	; [next_val_r]
  3689 000015A6 D0D8                <1> 	rcr	al, 1
  3690 000015A8 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3691 000015AB AB                  <1> 	stosw		; interpolated sample 2 (R)
  3692 000015AC C3                  <1> 	retn
  3693                              <1> 
  3694                              <1> interpolating_2_8bit_mono:
  3695                              <1> 	; 16/11/2023
  3696                              <1> 	; al = [previous_val]
  3697                              <1> 	; dl = [next_val]
  3698                              <1> 	; original-interpolated
  3699 000015AD 88C3                <1> 	mov	bl, al
  3700 000015AF 2C80                <1> 	sub	al, 80h
  3701 000015B1 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3702 000015B4 AB                  <1> 	stosw		; original sample (L)
  3703 000015B5 AB                  <1> 	stosw		; original sample (R)
  3704 000015B6 88D8                <1> 	mov	al, bl
  3705 000015B8 00D0                <1> 	add	al, dl	
  3706 000015BA D0D8                <1> 	rcr	al, 1
  3707 000015BC 2C80                <1> 	sub	al, 80h
  3708 000015BE C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3709 000015C1 AB                  <1> 	stosw		; interpolated sample (L)
  3710 000015C2 AB                  <1> 	stosw		; interpolated sample (R)
  3711 000015C3 C3                  <1> 	retn
  3712                              <1> 
  3713                              <1> interpolating_2_8bit_stereo:
  3714                              <1> 	; 16/11/2023
  3715                              <1> 	; al = [previous_val_l]
  3716                              <1> 	; ah = [previous_val_r]
  3717                              <1> 	; dl = [next_val_l]
  3718                              <1> 	; dh = [next_val_r]	
  3719                              <1> 	; original-interpolated
  3720 000015C4 89C3                <1> 	mov	bx, ax
  3721 000015C6 2C80                <1> 	sub	al, 80h
  3722 000015C8 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3723 000015CB AB                  <1> 	stosw		; original sample (L)
  3724 000015CC 88F8                <1> 	mov	al, bh
  3725 000015CE 2C80                <1> 	sub	al, 80h
  3726 000015D0 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3727 000015D3 AB                  <1> 	stosw		; original sample (R)
  3728 000015D4 88D8                <1> 	mov	al, bl	; [previous_val_l]
  3729 000015D6 00D0                <1> 	add	al, dl	; [next_val_l]	
  3730 000015D8 D0D8                <1> 	rcr	al, 1
  3731 000015DA 2C80                <1> 	sub	al, 80h
  3732 000015DC C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3733 000015DF AB                  <1> 	stosw		; interpolated sample (L)
  3734 000015E0 88F8                <1> 	mov	al, bh
  3735 000015E2 00F0                <1> 	add	al, dh	; [next_val_r]
  3736 000015E4 D0D8                <1> 	rcr	al, 1
  3737 000015E6 2C80                <1> 	sub	al, 80h
  3738 000015E8 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3739 000015EB AB                  <1> 	stosw		; interpolated sample (R)
  3740 000015EC C3                  <1> 	retn
  3741                              <1> 
  3742                              <1> interpolating_3_16bit_mono:
  3743                              <1> 	; 16/11/2023
  3744                              <1> 	; ax = [previous_val]
  3745                              <1> 	; dx = [next_val]
  3746                              <1> 	; original-interpolated-interpolated
  3747                              <1> 
  3748 000015ED AB                  <1> 	stosw		; original sample (L)
  3749 000015EE AB                  <1> 	stosw		; original sample (R)
  3750 000015EF 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3751 000015F2 50                  <1> 	push	ax ; *	; [previous_val]
  3752 000015F3 80C680              <1> 	add	dh, 80h
  3753 000015F6 01D0                <1> 	add	ax, dx
  3754 000015F8 D1D8                <1> 	rcr	ax, 1
  3755 000015FA 5B                  <1> 	pop	bx ; *		
  3756 000015FB 93                  <1> 	xchg	bx, ax	; bx  = interpolated middle (temporary)
  3757 000015FC 01D8                <1> 	add	ax, bx	; [previous_val] + interpolated middle
  3758 000015FE D1D8                <1> 	rcr	ax, 1
  3759 00001600 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3760 00001603 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3761 00001604 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3762 00001605 89D8                <1> 	mov	ax, bx
  3763 00001607 01D0                <1> 	add	ax, dx	 ;interpolated middle + [next_val]
  3764 00001609 D1D8                <1> 	rcr	ax, 1
  3765 0000160B 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3766 0000160E AB                  <1> 	stosw		; interpolated sample 2 (L)
  3767 0000160F AB                  <1> 	stosw		; interpolated sample 2 (R)
  3768 00001610 C3                  <1> 	retn
  3769                              <1> 
  3770                              <1> interpolating_3_16bit_stereo:
  3771                              <1> 	; 16/11/2023
  3772                              <1> 	; bx = [previous_val_l]
  3773                              <1> 	; ax = [previous_val_r]
  3774                              <1> 	; [next_val_l]
  3775                              <1> 	; dx = [next_val_r]
  3776                              <1> 	; original-interpolated-interpolated
  3777                              <1> 
  3778 00001611 93                  <1> 	xchg	ax, bx
  3779 00001612 AB                  <1> 	stosw		; original sample (L)
  3780 00001613 93                  <1> 	xchg	ax, bx
  3781 00001614 AB                  <1> 	stosw		; original sample (R)
  3782 00001615 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3783 00001618 50                  <1> 	push	ax ; *	; [previous_val_r]
  3784 00001619 80C780              <1> 	add	bh, 80h
  3785 0000161C 8006[7219]80        <1> 	add	byte [next_val_l+1], 80h
  3786 00001621 A1[7119]            <1> 	mov	ax, [next_val_l]
  3787 00001624 01D8                <1> 	add	ax, bx	; [previous_val_l]
  3788 00001626 D1D8                <1> 	rcr	ax, 1
  3789 00001628 93                  <1> 	xchg	ax, bx	; ax = [previous_val_l]	
  3790 00001629 01D8                <1> 	add	ax, bx	; bx = interpolated middle (L)
  3791 0000162B D1D8                <1> 	rcr	ax, 1
  3792 0000162D 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3793 00001630 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3794 00001631 58                  <1> 	pop	ax  ; *
  3795 00001632 80C680              <1> 	add	dh, 80h ; convert sound level 0 to 65535 format
  3796 00001635 52                  <1> 	push	dx  ; * ; [next_val_r]
  3797 00001636 92                  <1> 	xchg	ax, dx
  3798 00001637 01D0                <1> 	add	ax, dx	; [next_val_r] + [previous_val_r]
  3799 00001639 D1D8                <1> 	rcr	ax, 1	; / 2
  3800 0000163B 50                  <1> 	push	ax ; ** ; interpolated middle (R)
  3801 0000163C 01D0                <1> 	add	ax, dx	; + [previous_val_r]
  3802 0000163E D1D8                <1> 	rcr	ax, 1
  3803 00001640 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3804 00001643 AB                  <1> 	stosw 		; interpolated sample 1 (R)
  3805 00001644 A1[7119]            <1> 	mov	ax, [next_val_l]
  3806 00001647 01D8                <1> 	add	ax, bx	; + interpolated middle (L)
  3807 00001649 D1D8                <1> 	rcr	ax, 1
  3808 0000164B 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3809 0000164E AB                  <1> 	stosw 		; interpolated sample 2 (L)
  3810 0000164F 58                  <1> 	pop	ax ; **
  3811 00001650 5A                  <1> 	pop	dx ; *	
  3812 00001651 01D0                <1> 	add	ax, dx	; interpolated middle + [next_val_r]
  3813 00001653 D1D8                <1> 	rcr	ax, 1	; / 2
  3814 00001655 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3815 00001658 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  3816 00001659 C3                  <1> 	retn
  3817                              <1> 
  3818                              <1> interpolating_2_16bit_mono:
  3819                              <1> 	; 16/11/2023
  3820                              <1> 	; ax = [previous_val]
  3821                              <1> 	; dx = [next_val]
  3822                              <1> 	; original-interpolated
  3823                              <1> 
  3824 0000165A AB                  <1> 	stosw		; original sample (L)
  3825 0000165B AB                  <1> 	stosw		; original sample (R)
  3826 0000165C 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3827 0000165F 80C680              <1> 	add	dh, 80h
  3828 00001662 01D0                <1> 	add	ax, dx
  3829 00001664 D1D8                <1> 	rcr	ax, 1
  3830 00001666 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3831 00001669 AB                  <1> 	stosw		; interpolated sample (L)
  3832 0000166A AB                  <1> 	stosw		; interpolated sample (R)
  3833 0000166B C3                  <1> 	retn
  3834                              <1> 
  3835                              <1> interpolating_2_16bit_stereo:
  3836                              <1> 	; 16/11/2023
  3837                              <1> 	; bx = [previous_val_l]
  3838                              <1> 	; ax = [previous_val_r]
  3839                              <1> 	; [next_val_l]
  3840                              <1> 	; dx = [next_val_r]
  3841                              <1> 	; original-interpolated
  3842                              <1> 
  3843 0000166C 93                  <1> 	xchg	ax, bx
  3844 0000166D AB                  <1> 	stosw		; original sample (L)
  3845 0000166E 93                  <1> 	xchg	ax, bx
  3846 0000166F AB                  <1> 	stosw		; original sample (R)
  3847 00001670 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3848 00001673 80C680              <1> 	add	dh, 80h
  3849 00001676 01D0                <1> 	add	ax, dx	; [previous_val_r] + [next_val_r]
  3850 00001678 D1D8                <1> 	rcr	ax, 1	; / 2
  3851 0000167A 50                  <1> 	push	ax ; *	; interpolated sample (R)
  3852 0000167B A1[7119]            <1> 	mov	ax, [next_val_l]
  3853 0000167E 80C480              <1> 	add	ah, 80h
  3854 00001681 80C780              <1> 	add	bh, 80h
  3855 00001684 01D8                <1> 	add	ax, bx	; [next_val_l] + [previous_val_l]
  3856 00001686 D1D8                <1> 	rcr	ax, 1	; / 2		
  3857 00001688 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3858 0000168B AB                  <1> 	stosw 		; interpolated sample (L)
  3859 0000168C 58                  <1> 	pop	ax ; *	
  3860 0000168D 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3861 00001690 AB                  <1> 	stosw 		; interpolated sample (R)
  3862 00001691 C3                  <1> 	retn
  3863                              <1> 
  3864                              <1> interpolating_5_8bit_mono:
  3865                              <1> 	; 17/11/2023
  3866                              <1> 	; al = [previous_val]
  3867                              <1> 	; dl = [next_val]
  3868                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  3869 00001692 88C3                <1> 	mov	bl, al
  3870 00001694 2C80                <1> 	sub	al, 80h
  3871 00001696 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3872 00001699 AB                  <1> 	stosw		; original sample (L)
  3873 0000169A AB                  <1> 	stosw		; original sample (R)
  3874 0000169B 88D8                <1> 	mov	al, bl
  3875 0000169D 00D0                <1> 	add	al, dl	
  3876 0000169F D0D8                <1> 	rcr	al, 1
  3877 000016A1 88C7                <1> 	mov	bh, al	; interpolated middle (temporary)
  3878 000016A3 00D8                <1> 	add	al, bl  ; [previous_val]
  3879 000016A5 D0D8                <1> 	rcr	al, 1 	
  3880 000016A7 88C6                <1> 	mov	dh, al	; interpolated 1st quarter (temporary)
  3881 000016A9 00D8                <1> 	add	al, bl
  3882 000016AB D0D8                <1> 	rcr	al, 1
  3883 000016AD 2C80                <1> 	sub	al, 80h
  3884 000016AF C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3885 000016B2 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3886 000016B3 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3887 000016B4 88F8                <1> 	mov	al, bh
  3888 000016B6 00F0                <1> 	add	al, dh
  3889 000016B8 D0D8                <1> 	rcr	al, 1
  3890 000016BA 2C80                <1> 	sub	al, 80h
  3891 000016BC C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3892 000016BF AB                  <1> 	stosw		; interpolated sample 2 (L)
  3893 000016C0 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3894 000016C1 88F8                <1> 	mov	al, bh
  3895 000016C3 00D0                <1> 	add	al, dl	; [next_val]
  3896 000016C5 D0D8                <1> 	rcr	al, 1
  3897 000016C7 88C6                <1> 	mov	dh, al	; interpolated 3rd quarter (temporary)
  3898 000016C9 00F8                <1> 	add	al, bh
  3899 000016CB D0D8                <1> 	rcr	al, 1
  3900 000016CD 2C80                <1> 	sub	al, 80h
  3901 000016CF C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3902 000016D2 AB                  <1> 	stosw		; interpolated sample 3 (L)
  3903 000016D3 AB                  <1> 	stosw		; interpolated sample 3 (R)
  3904 000016D4 88F0                <1> 	mov	al, dh
  3905 000016D6 00D0                <1> 	add	al, dl
  3906 000016D8 D0D8                <1> 	rcr	al, 1
  3907 000016DA 2C80                <1> 	sub	al, 80h
  3908 000016DC C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3909 000016DF AB                  <1> 	stosw		; interpolated sample 4 (L)
  3910 000016E0 AB                  <1> 	stosw		; interpolated sample 4 (R)
  3911 000016E1 C3                  <1> 	retn
  3912                              <1> 
  3913                              <1> interpolating_5_8bit_stereo:
  3914                              <1> 	; 17/11/2023
  3915                              <1> 	; al = [previous_val_l]
  3916                              <1> 	; ah = [previous_val_r]
  3917                              <1> 	; dl = [next_val_l]
  3918                              <1> 	; dh = [next_val_r]	
  3919                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  3920 000016E2 89C3                <1> 	mov	bx, ax
  3921 000016E4 2C80                <1> 	sub	al, 80h
  3922 000016E6 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3923 000016E9 AB                  <1> 	stosw		; original sample (L)
  3924 000016EA 88F8                <1> 	mov	al, bh
  3925 000016EC 2C80                <1> 	sub	al, 80h
  3926 000016EE C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3927 000016F1 AB                  <1> 	stosw		; original sample (R)
  3928 000016F2 52                  <1> 	push	dx ; *
  3929 000016F3 88D8                <1> 	mov	al, bl
  3930 000016F5 00D0                <1> 	add	al, dl	; [next_val_l]
  3931 000016F7 D0D8                <1> 	rcr	al, 1
  3932 000016F9 50                  <1> 	push	ax ; **	; al = interpolated middle (L) (temporary)
  3933 000016FA 00D8                <1> 	add	al, bl	; [previous_val_l]
  3934 000016FC D0D8                <1> 	rcr	al, 1
  3935 000016FE 86C3                <1> 	xchg	al, bl	
  3936 00001700 00D8                <1> 	add	al, bl	; bl = interpolated 1st quarter (L) (temp)
  3937 00001702 D0D8                <1> 	rcr	al, 1
  3938 00001704 2C80                <1> 	sub	al, 80h
  3939 00001706 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3940 00001709 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3941 0000170A 88F8                <1> 	mov	al, bh
  3942 0000170C 00F0                <1> 	add	al, dh	; [next_val_r]
  3943 0000170E D0D8                <1> 	rcr	al, 1
  3944 00001710 50                  <1> 	push	ax ; *** ; al = interpolated middle (R) (temporary)
  3945 00001711 00F8                <1> 	add	al, bh	; [previous_val_r]
  3946 00001713 D0D8                <1> 	rcr	al, 1
  3947 00001715 86C7                <1> 	xchg	al, bh	
  3948 00001717 00F8                <1> 	add	al, bh	; bh = interpolated 1st quarter (R) (temp)
  3949 00001719 D0D8                <1> 	rcr	al, 1
  3950 0000171B 2C80                <1> 	sub	al, 80h
  3951 0000171D C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3952 00001720 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3953 00001721 5A                  <1> 	pop	dx ; ***
  3954 00001722 58                  <1> 	pop	ax ; **	; al = interpolated middle (L) (temporary)
  3955 00001723 86C3                <1> 	xchg	al, bl	; al = interpolated 1st quarter (L) (temp)
  3956 00001725 00D8                <1> 	add	al, bl	; bl = interpolated middle (L) (temporary)
  3957 00001727 D0D8                <1> 	rcr	al, 1
  3958 00001729 2C80                <1> 	sub	al, 80h
  3959 0000172B C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3960 0000172E AB                  <1> 	stosw		; interpolated sample 2 (L)	
  3961 0000172F 88D0                <1> 	mov	al, dl 	; interpolated middle (R) (temporary)
  3962 00001731 86C7                <1> 	xchg	al, bh	; al = interpolated 1st quarter (R) (temp)
  3963 00001733 00F8                <1> 	add	al, bh	; bh = interpolated middle (R) (temporary)
  3964 00001735 D0D8                <1> 	rcr	al, 1
  3965 00001737 2C80                <1> 	sub	al, 80h
  3966 00001739 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3967 0000173C AB                  <1> 	stosw		; interpolated sample 2 (R)
  3968 0000173D 5A                  <1> 	pop	dx ; *
  3969 0000173E 88D8                <1> 	mov	al, bl	; interpolated middle (L) (temporary)
  3970 00001740 00D0                <1> 	add	al, dl	; [next_val_l]
  3971 00001742 D0D8                <1> 	rcr	al, 1
  3972 00001744 86C3                <1> 	xchg	al, bl	; al = interpolated middle (R) (temporary)	
  3973 00001746 00D8                <1> 	add	al, bl	; bl = interpolated 3rd quarter (L) (temp) 
  3974 00001748 D0D8                <1> 	rcr	al, 1
  3975 0000174A 2C80                <1> 	sub	al, 80h
  3976 0000174C C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3977 0000174F AB                  <1> 	stosw		; interpolated sample 3 (L)
  3978 00001750 88F8                <1> 	mov	al, bh	
  3979 00001752 00F0                <1> 	add	al, dh	; interpolated middle (R) + [next_val_r]
  3980 00001754 D0D8                <1> 	rcr	al, 1
  3981 00001756 86C7                <1> 	xchg	al, bh	; al = interpolated middle (R)
  3982 00001758 00F8                <1> 	add	al, bh	; bh = interpolated 3rd quarter (R) (temp)
  3983 0000175A D0D8                <1> 	rcr	al, 1
  3984 0000175C 2C80                <1> 	sub	al, 80h
  3985 0000175E C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3986 00001761 AB                  <1> 	stosw		; interpolated sample 3 (R)
  3987 00001762 88D8                <1> 	mov	al, bl
  3988 00001764 00D0                <1> 	add	al, dl	; [next_val_l]
  3989 00001766 D0D8                <1> 	rcr	al, 1
  3990 00001768 2C80                <1> 	sub	al, 80h
  3991 0000176A C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3992 0000176D AB                  <1> 	stosw		; interpolated sample 4 (L)
  3993 0000176E 88F8                <1> 	mov	al, bh
  3994 00001770 00F0                <1> 	add	al, dh	; [next_val_r]
  3995 00001772 D0D8                <1> 	rcr	al, 1
  3996 00001774 2C80                <1> 	sub	al, 80h
  3997 00001776 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3998 00001779 AB                  <1> 	stosw		; interpolated sample 4 (R)
  3999 0000177A C3                  <1> 	retn
  4000                              <1> 
  4001                              <1> interpolating_4_8bit_mono:
  4002                              <1> 	; 17/11/2023
  4003                              <1> 	; al = [previous_val]
  4004                              <1> 	; dl = [next_val]
  4005                              <1> 	; original-interpolated-interpolated-interpolated
  4006 0000177B 88C3                <1> 	mov	bl, al
  4007 0000177D 2C80                <1> 	sub	al, 80h
  4008 0000177F C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4009 00001782 AB                  <1> 	stosw		; original sample (L)
  4010 00001783 AB                  <1> 	stosw		; original sample (R)
  4011 00001784 88D8                <1> 	mov	al, bl
  4012 00001786 00D0                <1> 	add	al, dl	
  4013 00001788 D0D8                <1> 	rcr	al, 1
  4014 0000178A 86C3                <1> 	xchg	al, bl  ; al = [previous_val]
  4015 0000178C 00D8                <1> 	add	al, bl	; bl = interpolated middle (sample 2)
  4016 0000178E D0D8                <1> 	rcr	al, 1 	
  4017 00001790 2C80                <1> 	sub	al, 80h
  4018 00001792 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4019 00001795 AB                  <1> 	stosw		; interpolated sample 1 (L)
  4020 00001796 AB                  <1> 	stosw		; interpolated sample 1 (R)
  4021 00001797 88D8                <1> 	mov	al, bl	; interpolated middle (sample 2)
  4022 00001799 2C80                <1> 	sub	al, 80h
  4023 0000179B C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4024 0000179E AB                  <1> 	stosw		; interpolated sample 2 (L)
  4025 0000179F AB                  <1> 	stosw		; interpolated sample 2 (R)
  4026 000017A0 88D8                <1> 	mov	al, bl
  4027 000017A2 00D0                <1> 	add	al, dl	; [next_val]
  4028 000017A4 D0D8                <1> 	rcr	al, 1
  4029 000017A6 2C80                <1> 	sub	al, 80h
  4030 000017A8 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4031 000017AB AB                  <1> 	stosw		; interpolated sample 3 (L)
  4032 000017AC AB                  <1> 	stosw		; interpolated sample 3 (R)
  4033 000017AD C3                  <1> 	retn
  4034                              <1> 
  4035                              <1> interpolating_4_8bit_stereo:
  4036                              <1> 	; 17/11/2023
  4037                              <1> 	; al = [previous_val_l]
  4038                              <1> 	; ah = [previous_val_r]
  4039                              <1> 	; dl = [next_val_l]
  4040                              <1> 	; dh = [next_val_r]	
  4041                              <1> 	; original-interpolated-interpolated-interpolated
  4042 000017AE 89C3                <1> 	mov	bx, ax
  4043 000017B0 2C80                <1> 	sub	al, 80h
  4044 000017B2 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4045 000017B5 AB                  <1> 	stosw		; original sample (L)
  4046 000017B6 88F8                <1> 	mov	al, bh
  4047 000017B8 2C80                <1> 	sub	al, 80h
  4048 000017BA C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4049 000017BD AB                  <1> 	stosw		; original sample (R)
  4050 000017BE 88D8                <1> 	mov	al, bl
  4051 000017C0 00D0                <1> 	add	al, dl	; [next_val_l]
  4052 000017C2 D0D8                <1> 	rcr	al, 1
  4053 000017C4 86C3                <1> 	xchg	al, bl	; al = [previous_val_l]
  4054 000017C6 00D8                <1> 	add	al, bl	; bl = interpolated middle (L) (sample 2)
  4055 000017C8 D0D8                <1> 	rcr	al, 1
  4056 000017CA 2C80                <1> 	sub	al, 80h
  4057 000017CC C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4058 000017CF AB                  <1> 	stosw		; interpolated sample 1 (L)
  4059 000017D0 88F8                <1> 	mov	al, bh
  4060 000017D2 00F0                <1> 	add	al, dh	; [next_val_r]
  4061 000017D4 D0D8                <1> 	rcr	al, 1
  4062 000017D6 86C7                <1> 	xchg	al, bh	; al = [previous_val_h]
  4063 000017D8 00F8                <1> 	add	al, bh	; bh = interpolated middle (R) (sample 2)
  4064 000017DA D0D8                <1> 	rcr	al, 1
  4065 000017DC 2C80                <1> 	sub	al, 80h
  4066 000017DE C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4067 000017E1 AB                  <1> 	stosw		; interpolated sample 1 (R)
  4068 000017E2 88D8                <1> 	mov	al, bl	; interpolated middle (L) (sample 2)
  4069 000017E4 2C80                <1> 	sub	al, 80h
  4070 000017E6 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4071 000017E9 AB                  <1> 	stosw		; interpolated sample 2 (L)
  4072 000017EA 88F8                <1> 	mov	al, bh	; interpolated middle (L) (sample 2)
  4073 000017EC 2C80                <1> 	sub	al, 80h
  4074 000017EE C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4075 000017F1 AB                  <1> 	stosw		; interpolated sample 2 (L)
  4076 000017F2 88D8                <1> 	mov	al, bl
  4077 000017F4 00D0                <1> 	add	al, dl	; [next_val_l]
  4078 000017F6 D0D8                <1> 	rcr	al, 1
  4079 000017F8 2C80                <1> 	sub	al, 80h
  4080 000017FA C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4081 000017FD AB                  <1> 	stosw		; interpolated sample 3 (L)
  4082 000017FE 88F8                <1> 	mov	al, bh
  4083 00001800 00F0                <1> 	add	al, dh	; [next_val_r]
  4084 00001802 D0D8                <1> 	rcr	al, 1
  4085 00001804 2C80                <1> 	sub	al, 80h
  4086 00001806 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4087 00001809 AB                  <1> 	stosw		; interpolated sample 3 (R)
  4088 0000180A C3                  <1> 	retn
  4089                              <1> 
  4090                              <1> interpolating_5_16bit_mono:
  4091                              <1> 	; 18/11/2023
  4092                              <1> 	; ax = [previous_val]
  4093                              <1> 	; dx = [next_val]
  4094                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  4095 0000180B AB                  <1> 	stosw		; original sample (L)
  4096 0000180C AB                  <1> 	stosw		; original sample (R)
  4097 0000180D 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  4098 00001810 89C3                <1> 	mov	bx, ax	; [previous_val]
  4099 00001812 80C680              <1> 	add	dh, 80h
  4100 00001815 01D0                <1> 	add	ax, dx
  4101 00001817 D1D8                <1> 	rcr	ax, 1
  4102 00001819 50                  <1> 	push	ax ; *	; interpolated middle (temporary)
  4103 0000181A 01D8                <1> 	add	ax, bx	; interpolated middle + [previous_val] 
  4104 0000181C D1D8                <1> 	rcr	ax, 1
  4105 0000181E 50                  <1> 	push	ax ; **	; interpolated 1st quarter (temporary)
  4106 0000181F 01D8                <1> 	add	ax, bx	; 1st quarter + [previous_val]
  4107 00001821 D1D8                <1> 	rcr	ax, 1	
  4108 00001823 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4109 00001826 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  4110 00001827 AB                  <1> 	stosw		; interpolated sample 1 (R)
  4111 00001828 58                  <1> 	pop	ax ; **	
  4112 00001829 5B                  <1> 	pop	bx ; *
  4113 0000182A 01D8                <1> 	add	ax, bx	; 1st quarter + middle
  4114 0000182C D1D8                <1> 	rcr	ax, 1	; / 2
  4115 0000182E 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again	
  4116 00001831 AB                  <1> 	stosw		; interpolated sample 2 (L)
  4117 00001832 AB                  <1> 	stosw		; interpolated sample 2 (R)		
  4118 00001833 89D8                <1> 	mov	ax, bx
  4119 00001835 01D0                <1> 	add	ax, dx	; interpolated middle + [next_val]
  4120 00001837 D1D8                <1> 	rcr	ax, 1
  4121 00001839 50                  <1> 	push	ax ; *	; interpolated 3rd quarter (temporary)
  4122 0000183A 01D8                <1> 	add	ax, bx	; + interpolated middle
  4123 0000183C D1D8                <1> 	rcr	ax, 1
  4124 0000183E 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4125 00001841 AB                  <1> 	stosw		; interpolated sample 3 (L)
  4126 00001842 AB                  <1> 	stosw		; interpolated sample 3 (R)
  4127 00001843 58                  <1> 	pop	ax ; *	
  4128 00001844 01D0                <1> 	add	ax, dx	; 3rd quarter + [next_val]
  4129 00001846 D1D8                <1> 	rcr	ax, 1	; / 2
  4130 00001848 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4131 0000184B AB                  <1> 	stosw		; interpolated sample 4 (L)
  4132 0000184C AB                  <1> 	stosw		; interpolated sample 4 (R)
  4133 0000184D C3                  <1> 	retn
  4134                              <1> 
  4135                              <1> interpolating_5_16bit_stereo:
  4136                              <1> 	; 18/11/2023
  4137                              <1> 	; bx = [previous_val_l]
  4138                              <1> 	; ax = [previous_val_r]
  4139                              <1> 	; [next_val_l]
  4140                              <1> 	; [next_val_r]
  4141                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  4142 0000184E 51                  <1> 	push	cx ; !
  4143 0000184F 93                  <1> 	xchg	ax, bx
  4144 00001850 AB                  <1> 	stosw		; original sample (L)
  4145 00001851 93                  <1> 	xchg	ax, bx
  4146 00001852 AB                  <1> 	stosw		; original sample (R)
  4147 00001853 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  4148 00001856 50                  <1> 	push	ax ; *	; [previous_val_r]
  4149 00001857 80C780              <1> 	add	bh, 80h
  4150 0000185A 8006[7219]80        <1> 	add	byte [next_val_l+1], 80h
  4151 0000185F A1[7119]            <1> 	mov	ax, [next_val_l]
  4152 00001862 01D8                <1> 	add	ax, bx	; [previous_val_l]
  4153 00001864 D1D8                <1> 	rcr	ax, 1
  4154 00001866 89C1                <1> 	mov	cx, ax	; interpolated middle (L)
  4155 00001868 01D8                <1> 	add	ax, bx	
  4156 0000186A D1D8                <1> 	rcr	ax, 1
  4157 0000186C 89C2                <1> 	mov	dx, ax	; interpolated 1st quarter (L)	
  4158 0000186E 01D8                <1> 	add	ax, bx	; [previous_val_l]
  4159 00001870 D1D8                <1> 	rcr	ax, 1
  4160 00001872 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4161 00001875 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  4162 00001876 89C8                <1> 	mov	ax, cx
  4163 00001878 01D0                <1> 	add	ax, dx	; middle (L) + 1st quarter (L) 
  4164 0000187A D1D8                <1> 	rcr	ax, 1	; / 2
  4165 0000187C 89C3                <1> 	mov	bx, ax  ; interpolated sample 2 (L)
  4166 0000187E 5A                  <1> 	pop	dx ; *	; [previous_val_r]
  4167 0000187F 89D0                <1> 	mov	ax, dx
  4168 00001881 8006[7419]80        <1> 	add	byte [next_val_r+1], 80h
  4169 00001886 0306[7319]          <1> 	add	ax, [next_val_r]
  4170 0000188A D1D8                <1> 	rcr	ax, 1
  4171 0000188C 50                  <1> 	push	ax ; *	; interpolated middle (R)
  4172 0000188D 01D0                <1> 	add	ax, dx
  4173 0000188F D1D8                <1> 	rcr	ax, 1
  4174 00001891 50                  <1> 	push	ax ; **	; interpolated 1st quarter (R)
  4175 00001892 01D0                <1> 	add	ax, dx	; [previous_val_r]
  4176 00001894 D1D8                <1> 	rcr	ax, 1
  4177 00001896 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4178 00001899 AB                  <1> 	stosw 		; interpolated sample 1 (R)
  4179 0000189A 89D8                <1> 	mov	ax, bx
  4180 0000189C 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4181 0000189F AB                  <1> 	stosw 		; interpolated sample 2 (L)
  4182 000018A0 58                  <1> 	pop	ax ; **
  4183 000018A1 5A                  <1> 	pop	dx ; *
  4184 000018A2 01D0                <1> 	add	ax, dx	; 1st quarter (R) + middle (R)
  4185 000018A4 D1D8                <1> 	rcr	ax, 1	; / 2
  4186 000018A6 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4187 000018A9 AB                  <1> 	stosw 		; interpolated sample 2 (R)
  4188 000018AA 89C8                <1> 	mov	ax, cx
  4189 000018AC 0306[7119]          <1> 	add	ax, [next_val_l]
  4190 000018B0 D1D8                <1> 	rcr	ax, 1
  4191 000018B2 50                  <1> 	push	ax ; * 	; interpolated 3rd quarter (L)
  4192 000018B3 01C8                <1> 	add	ax, cx	; interpolated middle (L)
  4193 000018B5 D1D8                <1> 	rcr	ax, 1
  4194 000018B7 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4195 000018BA AB                  <1> 	stosw 		; interpolated sample 3 (L)
  4196 000018BB 89D0                <1> 	mov	ax, dx
  4197 000018BD 0306[7319]          <1> 	add	ax, [next_val_r]
  4198 000018C1 D1D8                <1> 	rcr	ax, 1
  4199 000018C3 50                  <1> 	push	ax ; ** ; interpolated 3rd quarter (R)
  4200 000018C4 01D0                <1> 	add	ax, dx	; interpolated middle (R)
  4201 000018C6 D1D8                <1> 	rcr	ax, 1
  4202 000018C8 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4203 000018CB AB                  <1> 	stosw 		; interpolated sample 3 (R)
  4204 000018CC 5B                  <1> 	pop	bx ; **
  4205 000018CD 58                  <1> 	pop	ax ; *
  4206 000018CE 0306[7119]          <1> 	add	ax, [next_val_l]
  4207 000018D2 D1D8                <1> 	rcr	ax, 1
  4208 000018D4 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4209 000018D7 AB                  <1> 	stosw 		; interpolated sample 4 (L)
  4210 000018D8 89D8                <1> 	mov	ax, bx	
  4211 000018DA 0306[7319]          <1> 	add	ax, [next_val_r]
  4212 000018DE D1D8                <1> 	rcr	ax, 1
  4213 000018E0 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4214 000018E3 AB                  <1> 	stosw 		; interpolated sample 4 (R)
  4215 000018E4 59                  <1> 	pop	cx ; !
  4216 000018E5 C3                  <1> 	retn
  4217                              <1> 
  4218                              <1> interpolating_4_16bit_mono:
  4219                              <1> 	; 18/11/2023
  4220                              <1> 	; ax = [previous_val]
  4221                              <1> 	; dx = [next_val]
  4222                              <1> 	; original-interpolated
  4223                              <1> 
  4224 000018E6 AB                  <1> 	stosw		; original sample (L)
  4225 000018E7 AB                  <1> 	stosw		; original sample (R)
  4226 000018E8 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  4227 000018EB 89C3                <1> 	mov	bx, ax	; [previous_val]
  4228 000018ED 80C680              <1> 	add	dh, 80h
  4229 000018F0 01D0                <1> 	add	ax, dx	; [previous_val] + [next_val]
  4230 000018F2 D1D8                <1> 	rcr	ax, 1
  4231 000018F4 93                  <1> 	xchg	ax, bx	
  4232 000018F5 01D8                <1> 	add	ax, bx	; [previous_val] + interpolated middle
  4233 000018F7 D1D8                <1> 	rcr	ax, 1
  4234 000018F9 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4235 000018FC AB                  <1> 	stosw 		; interpolated sample 1 (L)
  4236 000018FD AB                  <1> 	stosw		; interpolated sample 1 (R)
  4237 000018FE 89D8                <1> 	mov	ax, bx	; interpolated middle
  4238 00001900 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4239 00001903 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  4240 00001904 AB                  <1> 	stosw		; interpolated sample 2 (R)
  4241 00001905 89D8                <1> 	mov	ax, bx
  4242 00001907 01D0                <1> 	add	ax, dx	; interpolated middle + [next_val]
  4243 00001909 D1D8                <1> 	rcr	ax, 1
  4244 0000190B 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4245 0000190E AB                  <1> 	stosw		; interpolated sample 3 (L)
  4246 0000190F AB                  <1> 	stosw		; interpolated sample 3 (R)
  4247 00001910 C3                  <1> 	retn
  4248                              <1> 
  4249                              <1> interpolating_4_16bit_stereo:
  4250                              <1> 	; 18/11/2023
  4251                              <1> 	; bx = [previous_val_l]
  4252                              <1> 	; ax = [previous_val_r]
  4253                              <1> 	; [next_val_l]
  4254                              <1> 	; [next_val_r]
  4255                              <1> 	; original-interpolated-interpolated-interpolated
  4256 00001911 93                  <1> 	xchg	ax, bx
  4257 00001912 AB                  <1> 	stosw		; original sample (L)
  4258 00001913 93                  <1> 	xchg	ax, bx
  4259 00001914 AB                  <1> 	stosw		; original sample (R)
  4260 00001915 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  4261 00001918 89C2                <1> 	mov	dx, ax	; [previous_val_r]
  4262 0000191A 80C780              <1> 	add	bh, 80h
  4263 0000191D 8006[7219]80        <1> 	add	byte [next_val_l+1], 80h
  4264 00001922 A1[7119]            <1> 	mov	ax, [next_val_l]
  4265 00001925 01D8                <1> 	add	ax, bx	; [previous_val_l]
  4266 00001927 D1D8                <1> 	rcr	ax, 1
  4267 00001929 93                  <1> 	xchg	ax, bx	
  4268 0000192A 01D8                <1> 	add	ax, bx	; bx = interpolated middle (L)
  4269 0000192C D1D8                <1> 	rcr	ax, 1
  4270 0000192E 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4271 00001931 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  4272 00001932 8006[7419]80        <1> 	add	byte [next_val_r+1], 80h
  4273 00001937 89D0                <1> 	mov	ax, dx	; [previous_val_r]
  4274 00001939 0306[7319]          <1> 	add	ax, [next_val_r]
  4275 0000193D D1D8                <1> 	rcr	ax, 1
  4276 0000193F 92                  <1> 	xchg	ax, dx	
  4277 00001940 01D0                <1> 	add	ax, dx	; dx = interpolated middle (R)
  4278 00001942 D1D8                <1> 	rcr	ax, 1
  4279 00001944 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4280 00001947 AB                  <1> 	stosw 		; interpolated sample 1 (R)
  4281 00001948 89D8                <1> 	mov	ax, bx
  4282 0000194A 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4283 0000194D AB                  <1> 	stosw 		; interpolated sample 2 (L)
  4284 0000194E 89D0                <1> 	mov	ax, dx
  4285 00001950 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4286 00001953 AB                  <1> 	stosw 		; interpolated sample 2 (R)
  4287 00001954 89D8                <1> 	mov	ax, bx
  4288 00001956 0306[7119]          <1> 	add	ax, [next_val_l]
  4289 0000195A D1D8                <1> 	rcr	ax, 1
  4290 0000195C 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4291 0000195F AB                  <1> 	stosw 		; interpolated sample 3 (L)
  4292 00001960 89D0                <1> 	mov	ax, dx
  4293 00001962 0306[7319]          <1> 	add	ax, [next_val_r]
  4294 00001966 D1D8                <1> 	rcr	ax, 1
  4295 00001968 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4296 0000196B AB                  <1> 	stosw 		; interpolated sample 3 (R)
  4297 0000196C C3                  <1> 	retn
  4298                              <1> 
  4299                              <1> ; 13/11/2023
  4300                              <1> previous_val:
  4301 0000196D 0000                <1> previous_val_l: dw 0
  4302 0000196F 0000                <1> previous_val_r: dw 0
  4303                              <1> next_val:
  4304 00001971 0000                <1> next_val_l: dw 0
  4305 00001973 0000                <1> next_val_r: dw 0
  4306                              <1> 
  4307                              <1> ; 16/11/2023
  4308 00001975 00                  <1> faz:	db 0	
  4309                              <1> 	
  4310                              <1> ; --------------------------------------------------------
   454                                  
   455                                  ; UTILS.ASM
   456                                  ;----------------------------------------------------------------------------
   457                                  ;       delay1_4ms - Delay for 1/4 millisecond.
   458                                  ;		    1mS = 1000us
   459                                  ;       Entry:
   460                                  ;         None
   461                                  ;       Exit:
   462                                  ;	  None
   463                                  ;
   464                                  ;       Modified:
   465                                  ;         None
   466                                  ;
   467                                  PORTB			EQU	061h
   468                                    REFRESH_STATUS	EQU	010h		; Refresh signal status
   469                                  
   470                                  delay1_4ms:
   471 00001976 50                              push    ax 
   472 00001977 51                              push    cx
   473 00001978 B91000                          mov     cx, 16			; close enough.
   474 0000197B E461                    	in	al,PORTB
   475 0000197D 2410                    	and	al,REFRESH_STATUS
   476 0000197F 88C4                    	mov	ah,al			; Start toggle state
   477 00001981 09C9                    	or	cx, cx
   478 00001983 7401                    	jz	short _d4ms1
   479 00001985 41                      	inc	cx			; Throwaway first toggle
   480                                  _d4ms1:	
   481 00001986 E461                    	in	al,PORTB		; Read system control port
   482 00001988 2410                    	and	al,REFRESH_STATUS	; Refresh toggles 15.085 microseconds
   483 0000198A 38C4                    	cmp	ah,al
   484 0000198C 74F8                    	je	short _d4ms1		; Wait for state change
   485                                  
   486 0000198E 88C4                    	mov	ah,al			; Update with new state
   487 00001990 49                      	dec	cx
   488 00001991 75F3                    	jnz	short _d4ms1
   489                                  
   490 00001993 59                              pop     cx
   491 00001994 58                              pop     ax
   492 00001995 C3                              retn
   493                                  
   494                                  	; 13/11/2016 - Erdogan Tan
   495                                  write_ac97_dev_info:
   496                                  	; BUS/DEV/FN
   497                                  	;	00000000BBBBBBBBDDDDDFFF00000000
   498                                  	; DEV/VENDOR
   499                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
   500                                  
   501 00001996 30FF                    	xor	bh, bh
   502 00001998 668B36[661D]            	mov	esi, [dev_vendor]
   503 0000199D 89F0                    	mov	ax, si
   504 0000199F 88C3                    	mov	bl, al
   505 000019A1 88DA                    	mov	dl, bl
   506 000019A3 80E30F                  	and	bl, 0Fh
   507 000019A6 8A87[E71B]              	mov	al, [bx+hex_chars]
   508 000019AA A2[2A1C]                	mov	[msgVendorId+3], al
   509 000019AD 88D3                    	mov	bl, dl
   510 000019AF C0EB04                  	shr	bl, 4
   511 000019B2 8A87[E71B]              	mov	al, [bx+hex_chars]
   512 000019B6 A2[291C]                	mov	[msgVendorId+2], al
   513 000019B9 88E3                    	mov	bl, ah
   514 000019BB 88DA                    	mov	dl, bl
   515 000019BD 80E30F                  	and	bl, 0Fh
   516 000019C0 8A87[E71B]              	mov	al, [bx+hex_chars]
   517 000019C4 A2[281C]                	mov	[msgVendorId+1], al
   518 000019C7 88D3                    	mov	bl, dl
   519 000019C9 C0EB04                  	shr	bl, 4
   520 000019CC 8A87[E71B]              	mov	al, [bx+hex_chars]
   521 000019D0 A2[271C]                	mov	[msgVendorId], al
   522 000019D3 66C1EE10                	shr	esi, 16
   523 000019D7 89F0                    	mov	ax, si
   524 000019D9 88C3                    	mov	bl, al
   525 000019DB 88DA                    	mov	dl, bl
   526 000019DD 80E30F                  	and	bl, 0Fh
   527 000019E0 8A87[E71B]              	mov	al, [bx+hex_chars]
   528 000019E4 A2[3B1C]                	mov	[msgDevId+3], al
   529 000019E7 88D3                    	mov	bl, dl
   530 000019E9 C0EB04                  	shr	bl, 4
   531 000019EC 8A87[E71B]              	mov	al, [bx+hex_chars]
   532 000019F0 A2[3A1C]                	mov	[msgDevId+2], al
   533 000019F3 88E3                    	mov	bl, ah
   534 000019F5 88DA                    	mov	dl, bl
   535 000019F7 80E30F                  	and	bl, 0Fh
   536 000019FA 8A87[E71B]              	mov	al, [bx+hex_chars]
   537 000019FE A2[391C]                	mov	[msgDevId+1], al
   538 00001A01 88D3                    	mov	bl, dl
   539 00001A03 C0EB04                  	shr	bl, 4
   540 00001A06 8A87[E71B]              	mov	al, [bx+hex_chars]
   541 00001A0A A2[381C]                	mov	[msgDevId], al
   542                                  
   543 00001A0D 668B36[621D]            	mov	esi, [bus_dev_fn]
   544 00001A12 66C1EE08                	shr	esi, 8
   545 00001A16 89F0                    	mov	ax, si
   546 00001A18 88C3                    	mov	bl, al
   547 00001A1A 88DA                    	mov	dl, bl
   548 00001A1C 80E307                  	and	bl, 7 ; bit 0,1,2
   549 00001A1F 8A87[E71B]              	mov	al, [bx+hex_chars]
   550 00001A23 A2[5F1C]                	mov	[msgFncNo+1], al
   551 00001A26 88D3                    	mov	bl, dl
   552 00001A28 C0EB03                  	shr	bl, 3
   553 00001A2B 88DA                    	mov	dl, bl
   554 00001A2D 80E30F                  	and	bl, 0Fh
   555 00001A30 8A87[E71B]              	mov	al, [bx+hex_chars]
   556 00001A34 A2[511C]                	mov	[msgDevNo+1], al
   557 00001A37 88D3                    	mov	bl, dl
   558 00001A39 C0EB04                  	shr	bl, 4
   559 00001A3C 8A87[E71B]              	mov	al, [bx+hex_chars]
   560 00001A40 A2[501C]                	mov	[msgDevNo], al
   561 00001A43 88E3                    	mov	bl, ah
   562 00001A45 88DA                    	mov	dl, bl
   563 00001A47 80E30F                  	and	bl, 0Fh
   564 00001A4A 8A87[E71B]              	mov	al, [bx+hex_chars]
   565 00001A4E A2[451C]                	mov	[msgBusNo+1], al
   566 00001A51 88D3                    	mov	bl, dl
   567 00001A53 C0EB04                  	shr	bl, 4
   568 00001A56 8A87[E71B]              	mov	al, [bx+hex_chars]
   569 00001A5A A2[441C]                	mov	[msgBusNo], al
   570                                  
   571 00001A5D A1[581D]                	mov	ax, [NAMBAR]
   572 00001A60 88C3                    	mov	bl, al
   573 00001A62 88DA                    	mov	dl, bl
   574 00001A64 80E30F                  	and	bl, 0Fh
   575 00001A67 8A87[E71B]              	mov	al, [bx+hex_chars]
   576 00001A6B A2[6E1C]                	mov	[msgNamBar+3], al
   577 00001A6E 88D3                    	mov	bl, dl
   578 00001A70 C0EB04                  	shr	bl, 4
   579 00001A73 8A87[E71B]              	mov	al, [bx+hex_chars]
   580 00001A77 A2[6D1C]                	mov	[msgNamBar+2], al
   581 00001A7A 88E3                    	mov	bl, ah
   582 00001A7C 88DA                    	mov	dl, bl
   583 00001A7E 80E30F                  	and	bl, 0Fh
   584 00001A81 8A87[E71B]              	mov	al, [bx+hex_chars]
   585 00001A85 A2[6C1C]                	mov	[msgNamBar+1], al
   586 00001A88 88D3                    	mov	bl, dl
   587 00001A8A C0EB04                  	shr	bl, 4
   588 00001A8D 8A87[E71B]              	mov	al, [bx+hex_chars]
   589 00001A91 A2[6B1C]                	mov	[msgNamBar], al
   590                                  
   591                                  	; 08/05/2024 (ebx->bx)
   592                                  	; 05/11/2023
   593 00001A94 A1[5A1D]                	mov	ax, [NABMBAR]
   594 00001A97 88C3                    	mov	bl, al
   595 00001A99 88DA                    	mov	dl, bl
   596 00001A9B 80E30F                  	and	bl, 0Fh
   597 00001A9E 8A87[E71B]              	mov	al, [bx+hex_chars]
   598 00001AA2 A2[7D1C]                	mov	[msgNabmBar+3], al
   599 00001AA5 88D3                    	mov	bl, dl
   600 00001AA7 C0EB04                  	shr	bl, 4
   601 00001AAA 8A87[E71B]              	mov	al, [bx+hex_chars]
   602 00001AAE A2[7C1C]                	mov	[msgNabmBar+2], al
   603 00001AB1 88E3                    	mov	bl, ah
   604 00001AB3 88DA                    	mov	dl, bl
   605 00001AB5 80E30F                  	and	bl, 0Fh
   606 00001AB8 8A87[E71B]              	mov	al, [bx+hex_chars]
   607 00001ABC A2[7B1C]                	mov	[msgNabmBar+1], al
   608 00001ABF 88D3                    	mov	bl, dl
   609 00001AC1 C0EB04                  	shr	bl, 4
   610 00001AC4 8A87[E71B]              	mov	al, [bx+hex_chars]
   611 00001AC8 A2[7A1C]                	mov	[msgNabmBar], al
   612                                  
   613                                  	; 24/11/2016
   614 00001ACB 30E4                    	xor	ah, ah
   615 00001ACD A0[571D]                	mov	al, [ac97_int_ln_reg]
   616 00001AD0 B10A                    	mov	cl, 10
   617 00001AD2 F6F1                    	div	cl
   618 00001AD4 0106[851C]              	add	[msgIRQ], ax
   619 00001AD8 20C0                    	and	al, al
   620 00001ADA 7508                    	jnz	short _pmi
   621 00001ADC A0[861C]                	mov	al, [msgIRQ+1]
   622 00001ADF B420                    	mov	ah, ' '
   623 00001AE1 A3[851C]                	mov	[msgIRQ], ax
   624                                  _pmi:
   625 00001AE4 BA[F81B]                        mov	dx, msgAC97Info
   626 00001AE7 B409                            mov     ah, 9
   627 00001AE9 CD21                            int     21h
   628 00001AEB C3                              retn
   629                                  
   630                                  write_sample_rate:
   631                                  	; ax = sample rate (hertz)
   632                                  
   633 00001AEC 31D2                    	xor	dx, dx
   634 00001AEE B90A00                  	mov	cx, 10
   635 00001AF1 F7F1                    	div	cx
   636 00001AF3 0016[9B1C]              	add	[msgHertz+4], dl
   637 00001AF7 29D2                    	sub	dx, dx
   638 00001AF9 F7F1                    	div	cx
   639 00001AFB 0016[9A1C]              	add	[msgHertz+3], dl
   640 00001AFF 29D2                    	sub	dx, dx
   641 00001B01 F7F1                    	div	cx
   642 00001B03 0016[991C]              	add	[msgHertz+2], dl
   643 00001B07 29D2                    	sub	dx, dx
   644 00001B09 F7F1                    	div	cx
   645 00001B0B 0016[981C]              	add	[msgHertz+1], dl
   646 00001B0F 0006[971C]              	add	[msgHertz], al
   647                                  	
   648 00001B13 BA[8A1C]                        mov     dx, msgSampleRate
   649 00001B16 B409                            mov     ah, 9
   650 00001B18 CD21                            int     21h
   651                                  
   652                                  	; 19/11/2016
   653 00001B1A BA[B01C]                	mov	dx, msg16Bits
   654 00001B1D 803E[6E1D]10            	cmp	byte [bps], 16
   655 00001B22 7403                    	je	short wsr_1
   656 00001B24 BA[A11C]                	mov	dx, msg8Bits
   657                                  wsr_1:
   658 00001B27 B409                            mov     ah, 9
   659 00001B29 CD21                            int     21h
   660                                  
   661 00001B2B BA[A91C]                	mov	dx, msgMono
   662 00001B2E 803E[6C1D]01            	cmp	byte [stmo], 1
   663 00001B33 7403                    	je	short wsr_2
   664 00001B35 BA[B91C]                	mov	dx, msgStereo		
   665                                  wsr_2:
   666 00001B38 B409                            mov     ah, 9
   667 00001B3A CD21                            int     21h
   668                                  
   669 00001B3C C3                              retn
   670                                  
   671                                  ;detect_codec:
   672                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   673                                  ;	mov	eax, 7Ch
   674                                  ;	call	codec_read
   675                                  ;       shl     eax, 16
   676                                  ;       mov     [codec_id], eax
   677                                  ;
   678                                  ;	mov	eax, 7Eh
   679                                  ;       call	codec_read
   680                                  ;       or      eax, [codec_id]
   681                                  ;       mov     [codec_chip_id], eax
   682                                  ;       and     eax, 0FFFFFF00h
   683                                  ;
   684                                  ;       mov     edi, codecs
   685                                  ;_dcb:
   686                                  ;       mov     ebx, [di]
   687                                  ;       test    ebx, ebx
   688                                  ;       jz      short _dco_unknown
   689                                  ;
   690                                  ;       cmp     eax, ebx
   691                                  ;       jne     short _dco_next
   692                                  ;       mov     ax, [di+4]
   693                                  ;       mov     [codec_vendor_ids], ax
   694                                  ;       movzx   esi, ax
   695                                  ;       call	print_msg
   696                                  ;       
   697                                  ;	mov	ax, [di+6]
   698                                  ;	call	detect_chip
   699                                  ;       retn
   700                                  ;
   701                                  ;_dco_next:
   702                                  ;       add     di, 8
   703                                  ;       jmp     short _dcb
   704                                  ;
   705                                  ;_dco_unknown:
   706                                  ;       mov    word [codec_vendor_ids], ac_unknown
   707                                  ;       mov    word [codec_chip_ids], chip_unknown
   708                                  ;       mov     esi, chip_unknown
   709                                  ;	call	print_msg
   710                                  ;       mov     eax, [codec_chip_id]
   711                                  ;       call    dword2str
   712                                  ;       call	print_msg
   713                                  ;       retn
   714                                  
   715                                  ;detect_chip:
   716                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   717                                  ;	mov	di, ax ; chip_tab
   718                                  ;       mov     eax, [codec_chip_id]
   719                                  ;       and     ax, 0FFh
   720                                  ;_dch1:
   721                                  ;       mov     bx, [di]
   722                                  ;       cmp     bx, 0FFh
   723                                  ;       je      short _dch_unknown
   724                                  ;
   725                                  ;       cmp     ax, bx
   726                                  ;       jne     short _dch_next
   727                                  ;       mov     ax, [di+2]
   728                                  ;       mov     [codec_chip_ids], ax
   729                                  ;       mov     si, ax
   730                                  ;       call	print_msg
   731                                  ;       retn
   732                                  
   733                                  ;_dch_next:
   734                                  ;       add     di, 4
   735                                  ;       jmp     short _dch1
   736                                  ;
   737                                  ;_dch_unknown:
   738                                  ;       mov    word [codec_chip_ids], chip_unknown
   739                                  ;       mov     si, chip_unknown
   740                                  ;       call	print_msg
   741                                  ;       mov     eax, [codec_chip_id]
   742                                  ;       call    dword2str
   743                                  ;       call	print_msg
   744                                  ;       retn
   745                                  
   746                                  ; 19/05/2024
   747                                  ; 16/05/2024
   748                                  %if 0
   749                                  	; 16/05/2024
   750                                  	; 15/05/2024
   751                                  ac97_int_handler:
   752                                  	; 13/05/2024
   753                                  	; 12/05/2024
   754                                  	; 11/05/2024
   755                                  	; 11/11/2023
   756                                  	; 10/11/2023
   757                                  	; 17/02/2016
   758                                  	push	ax ; +	; 16/05/2024
   759                                  	;push	eax ; *	; 11/11/2023
   760                                  	push	dx ; **
   761                                  	; 05/11/2023
   762                                  	;push	cx
   763                                  	;push	bx
   764                                  	;push	si
   765                                  	;push	di
   766                                  
   767                                  	; 16/05/2024
   768                                  	; 10/11/2023
   769                                  	; EOI at first
   770                                  	mov	al, 20h
   771                                  	test	byte [ac97_int_ln_reg], 8
   772                                  	jz	short _ih_0
   773                                  	out 	0A0h, al ; 20h	; EOI
   774                                  _ih_0:
   775                                  	out	20h, al  ; 20h	; EOI
   776                                  
   777                                  	; 16/05/2024
   778                                  ;	mov	dx, GLOB_STS_REG
   779                                  ;	add	dx, [NABMBAR]
   780                                  ;	in	eax, dx
   781                                  ;
   782                                  ;	inc	eax	; 0FFFFFFFFh
   783                                  ;	jz	short _ih_3
   784                                  ;	dec	eax	; 0
   785                                  ;	;jz	short _ih_3
   786                                  ;_ih_3:
   787                                  ;	; 16/05/2024
   788                                  ;	push	eax ; ***
   789                                  
   790                                  	; 16/05/2024
   791                                  	; 24/11/2023 (TRDOS386 'audio.s')
   792                                          mov	dx, [NABMBAR]
   793                                  	add	dx, PO_SR_REG
   794                                  	in	ax, dx
   795                                  
   796                                  	test	al, BCIS ; bit 3, 8
   797                                  	jz	short _ih_2
   798                                  
   799                                  	; 15/05/2024
   800                                  	cmp	byte [tLoop], 1
   801                                  	jb	short _ih_2
   802                                  _ih_1:
   803                                  	; 16/05/2024
   804                                  	; 13/05/2024
   805                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   806                                  	;add	dx, PO_SR_REG
   807                                          ;add	dx, [NABMBAR]
   808                                  	;out	dx, ax
   809                                  
   810                                  	; 16/05/2024
   811                                  	push	ax ; ****
   812                                  
   813                                  	; 13/05/2024
   814                                  	mov	dx, PO_CIV_REG
   815                                          add	dx, [NABMBAR]
   816                                  	in	al, dx
   817                                  	mov	ah, al
   818                                  	dec	al
   819                                  	and	al, 1Fh
   820                                          mov     dx, PO_LVI_REG
   821                                          add	dx, [NABMBAR]
   822                                          out	dx, al
   823                                  	and	ah, 1
   824                                  	; 13/05/2024
   825                                  	inc	ah
   826                                  	mov	[tBuff], ah ; 1 = Buffer 1, 2 = Buffer 2
   827                                  
   828                                  	; 13/05/2024
   829                                  	; 10/11/2023
   830                                  	; 28/11/2016 - Erdogan Tan
   831                                  	;call	tuneLoop
   832                                  
   833                                  	; 16/05/2024
   834                                  	pop	ax ; ****
   835                                  
   836                                  	; 16/05/2024
   837                                  _ih_2:
   838                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   839                                  	mov	dx, [NABMBAR]
   840                                  	add	dx, PO_SR_REG
   841                                  	out	dx, ax
   842                                  
   843                                  ;	; 16/05/2024
   844                                  ;	pop	eax ; ***
   845                                  ;	
   846                                  ;	or	eax, eax
   847                                  ;	jz	short _ih_4
   848                                  ;	
   849                                  ;	mov	dx, GLOB_STS_REG
   850                                  ;	add	dx, [NABMBAR]
   851                                  ;	out	dx, eax
   852                                  
   853                                  	; 16/05/2024
   854                                  _ih_4:
   855                                  	; 10/11/2023
   856                                  	;mov	al, 20h
   857                                  	;test	byte [ac97_int_ln_reg], 8
   858                                  	;jz	short _ih_5
   859                                  	;out 	0A0h, al ; 20h	; EOI
   860                                  ;_ih_5:
   861                                  	;out	20h, al  ; 20h	; EOI
   862                                  ;_ih_6:
   863                                  	;pop	di
   864                                  	;pop	si
   865                                  	;pop	bx
   866                                  	;pop	cx
   867                                  	pop	dx ; **
   868                                  	;pop	eax ; *	; 11/11/2023
   869                                  	pop	ax ; + ; 16/05/2024
   870                                  	iret
   871                                  %endif
   872                                  
   873                                  print_msg:
   874                                  	; 13/11/2016 - Erdogan Tan 
   875                                  	; esi = ASCIIZ text address
   876                                  	;
   877 00001B3D BB0700                  	mov	bx, 7h
   878 00001B40 B40E                    	mov	ah, 0Eh 
   879                                  pm_next_char:
   880 00001B42 AC                      	lodsb
   881 00001B43 20C0                    	and	al, al
   882 00001B45 7404                    	jz	short pm_retn
   883 00001B47 CD10                    	int	10h
   884 00001B49 EBF7                    	jmp	short pm_next_char
   885                                  pm_retn:
   886 00001B4B C3                      	retn
   887                                  
   888                                  ; 06/11/2023
   889                                  ;dword2str:
   890                                  ;	; 13/11/2016 - Erdogan Tan 
   891                                  ;	; eax = dword value
   892                                  ;	;
   893                                  ;	call	dwordtohex
   894                                  ;	mov	[dword_str], edx
   895                                  ;	mov	[dword_str+4], eax
   896                                  ;	mov	si, dword_str
   897                                  ;	retn
   898                                  
   899                                  	; trdos386.s (unix386.s) - 10/05/2015
   900                                  	; Convert binary number to hexadecimal string
   901                                  
   902                                  bytetohex:
   903                                  	; INPUT ->
   904                                  	; 	AL = byte (binary number)
   905                                  	; OUTPUT ->
   906                                  	;	AX = hexadecimal string
   907                                  	;
   908 00001B4C 53                      	push	bx
   909 00001B4D 30FF                    	xor	bh, bh
   910 00001B4F 88C3                    	mov	bl, al
   911 00001B51 C0EB04                  	shr	bl, 4
   912 00001B54 8A9F[E71B]              	mov	bl, [bx+hex_chars] 	 	
   913 00001B58 86D8                    	xchg	bl, al
   914 00001B5A 80E30F                  	and	bl, 0Fh
   915 00001B5D 8AA7[E71B]              	mov	ah, [bx+hex_chars] 
   916 00001B61 5B                      	pop	bx	
   917 00001B62 C3                      	retn
   918                                  
   919                                  wordtohex:
   920                                  	; INPUT ->
   921                                  	; 	AX = word (binary number)
   922                                  	; OUTPUT ->
   923                                  	;	EAX = hexadecimal string
   924                                  	;
   925 00001B63 53                      	push	bx
   926 00001B64 30FF                    	xor	bh, bh
   927 00001B66 86E0                    	xchg	ah, al
   928 00001B68 50                      	push	ax
   929 00001B69 88E3                    	mov	bl, ah
   930 00001B6B C0EB04                  	shr	bl, 4
   931 00001B6E 8A87[E71B]              	mov	al, [bx+hex_chars] 	 	
   932 00001B72 88E3                    	mov	bl, ah
   933 00001B74 80E30F                  	and	bl, 0Fh
   934 00001B77 8AA7[E71B]              	mov	ah, [bx+hex_chars]
   935 00001B7B 66C1E010                	shl	eax, 16
   936 00001B7F 58                      	pop	ax
   937 00001B80 5B                      	pop	bx
   938 00001B81 EBC9                    	jmp	short bytetohex
   939                                  
   940                                  ; 06/11/2023
   941                                  ;dwordtohex:
   942                                  ;	; INPUT ->
   943                                  ;	; 	EAX = dword (binary number)
   944                                  ;	; OUTPUT ->
   945                                  ;	;	EDX:EAX = hexadecimal string
   946                                  ;	;
   947                                  ;	push	eax
   948                                  ;	shr	eax, 16
   949                                  ;	call	wordtohex
   950                                  ;	mov	edx, eax
   951                                  ;	pop	eax
   952                                  ;	call	wordtohex
   953                                  ;	retn
   954                                  
   955                                  _DATA:
   956                                  
   957                                  ; 24/11/2016
   958                                  ;	IRQ  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 
   959 00001B83 08090A0B0C0D0E0F70-     irq_int	 db 08h,09h,0Ah,0Bh,0Ch,0Dh,0Eh,0Fh,70h,71h,72h,73h,74h,75h,76h,77h
   959 00001B8C 71727374757677     
   960                                  
   961                                  ; 17/02/2017
   962                                  ; Valid ICH device IDs
   963                                  
   964                                  valid_ids:
   965 00001B93 86801524                dd	(ICH_DID << 16) + INTEL_VID  	 ; 8086h:2415h 
   966 00001B97 86802524                dd	(ICH0_DID << 16) + INTEL_VID 	 ; 8086h:2425h 
   967 00001B9B 86804524                dd	(ICH2_DID << 16) + INTEL_VID 	 ; 8086h:2445h 
   968 00001B9F 86808524                dd	(ICH3_DID << 16) + INTEL_VID 	 ; 8086h:2485h 
   969 00001BA3 8680C524                dd	(ICH4_DID << 16) + INTEL_VID 	 ; 8086h:24C5h
   970 00001BA7 8680D524                dd	(ICH5_DID << 16) + INTEL_VID 	 ; 8086h:24D5h
   971 00001BAB 86806E26                dd	(ICH6_DID << 16) + INTEL_VID 	 ; 8086h:266Eh
   972 00001BAF 8680A625                dd	(ESB6300_DID << 16) + INTEL_VID  ; 8086h:25A6h
   973 00001BB3 86809826                dd	(ESB631X_DID << 16) + INTEL_VID  ; 8086h:2698h
   974 00001BB7 8680DE27                dd	(ICH7_DID << 16) + INTEL_VID 	 ; 8086h:27DEh
   975                                  ; 03/11/2023 - Erdogan Tan
   976 00001BBB 86809571                dd	(MX82440_DID << 16) + INTEL_VID  ; 8086h:7195h
   977 00001BBF 39101270                dd	(SI7012_DID << 16)  + SIS_VID	 ; 1039h:7012h
   978 00001BC3 DE10B101                dd 	(NFORCE_DID << 16)  + NVIDIA_VID ; 10DEh:01B1h
   979 00001BC7 DE106A00                dd 	(NFORCE2_DID << 16) + NVIDIA_VID ; 10DEh:006Ah
   980 00001BCB 22106D74                dd 	(AMD8111_DID << 16) + AMD_VID 	 ; 1022h:746Dh
   981 00001BCF 22104574                dd 	(AMD768_DID << 16)  + AMD_VID 	 ; 1022h:7445h
   982 00001BD3 DE105900                dd 	(CK804_DID << 16) + NVIDIA_VID	 ; 10DEh:0059h
   983 00001BD7 DE103A00                dd 	(MCP04_DID << 16) + NVIDIA_VID	 ; 10DEh:003Ah
   984 00001BDB DE108A00                dd 	(CK8_DID << 16) + NVIDIA_VID	 ; 1022h:008Ah
   985 00001BDF DE10DA00                dd 	(NFORCE3_DID << 16) + NVIDIA_VID ; 10DEh:00DAh
   986 00001BE3 DE10EA00                dd 	(CK8S_DID << 16) + NVIDIA_VID	 ; 10DEh:00EAh
   987                                  
   988                                  valid_id_count:	equ ($ - valid_ids)>>2 ; 05/11/2023
   989                                  
   990                                  ; 13/11/2016
   991 00001BE7 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
   991 00001BF0 3941424344454600   
   992 00001BF8 414339372041756469-     msgAC97Info	db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
   992 00001C01 6F20436F6E74726F6C-
   992 00001C0A 6C6572202620436F64-
   992 00001C13 656320496E666F0D0A 
   993 00001C1C 56656E646F72204944-     		db "Vendor ID: "
   993 00001C25 3A20               
   994 00001C27 303030306820446576-     msgVendorId	db "0000h Device ID: "
   994 00001C30 6963652049443A20   
   995 00001C38 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
   996 00001C3F 4275733A20              		db "Bus: "
   997 00001C44 303068204465766963-     msgBusNo	db "00h Device: "
   997 00001C4D 653A20             
   998 00001C50 3030682046756E6374-     msgDevNo	db "00h Function: "
   998 00001C59 696F6E3A20         
   999 00001C5E 303068                  msgFncNo	db "00h"
  1000 00001C61 0D0A                    		db 0Dh, 0Ah
  1001                                  ; 05/11/2023	
  1002 00001C63 4E414D4241523A20        		db "NAMBAR: "
  1003 00001C6B 303030306820            msgNamBar	db "0000h "
  1004 00001C71 4E41424D4241523A20      		db "NABMBAR: "
  1005 00001C7A 303030306820495251-     msgNabmBar	db "0000h IRQ: "
  1005 00001C83 3A20               
  1006 00001C85 3030                    msgIRQ		dw 3030h
  1007 00001C87 0D0A24                  		db 0Dh, 0Ah, "$"
  1008 00001C8A 53616D706C65205261-     msgSampleRate	db "Sample Rate: "
  1008 00001C93 74653A20           
  1009 00001C97 303030303020487A20-     msgHertz	db "00000 Hz ", "$" 
  1009 00001CA0 24                 
  1010 00001CA1 3820626974732024        msg8Bits	db "8 bits ", "$" 
  1011 00001CA9 4D6F6E6F0D0A24          msgMono		db "Mono", 0Dh, 0Ah, "$"
  1012 00001CB0 313620626974732024      msg16Bits	db "16 bits ", "$" 
  1013 00001CB9 53746572656F0D0A24      msgStereo	db "Stereo", 0Dh, 0Ah, "$"
  1014                                  
  1015                                  ;; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
  1016                                  ;codec_id	dd 0
  1017                                  ;codec_chip_id	dd 0
  1018                                  ;codec_vendor_ids dw 0
  1019                                  ;codec_chip_ids	dw 0
  1020                                  
  1021 00001CC2 3030303030303030        dword_str	 dd 30303030h, 30303030h
  1022 00001CCA 680D0A00                		 db 'h', 0Dh, 0Ah, 0
  1023                                  
  1024                                  ;ac_unknown     db 'unknown manufacturer',13,10,0
  1025                                  ;ac_Realtek     db 'Realtek Semiconductor',13,10,0
  1026                                  ;ac_Analog      db 'Analog Devices',13,10,0
  1027                                  ;ac_CMedia      db 'C-Media Electronics',13,10,0
  1028                                  ;ac_Cirrus      db 'Cirrus Logic',13,10,0
  1029                                  ;ac_Wolfson     db 'Wolfson Microelectronics',13,10,0
  1030                                  ;ac_VIA         db 'VIA Technologies',13,10,0
  1031                                  ;ac_SigmaTel    db 'SigmaTel',13,10,0
  1032                                  ;ac_eMicro      db 'eMicro',13,10,0
  1033                                  ;
  1034                                  ;chip_unknown   db 'unknown codec id ', 0
  1035                                  
  1036                                  ;CHIP_REALTEK   equ 414C4700h
  1037                                  ;CHIP_CMEDIA    equ 434D4900h
  1038                                  ;CHIP_VIA       equ 56494100h
  1039                                  
  1040                                  ;codecs        dd CHIP_CMEDIA
  1041                                  ;	       dw ac_CMedia, chips_CMedia
  1042                                  ;              dd CHIP_REALTEK
  1043                                  ;	       dw ac_Realtek, chips_Realtek
  1044                                  ;              dd CHIP_VIA
  1045                                  ;	       dw ac_VIA, chips_VIA
  1046                                  ;              dd 0
  1047                                  
  1048                                  ;chips_Realtek dw 10h, chip_ALC201a
  1049                                  ;              dw 20h, chip_ALC650
  1050                                  ;              dw 21h, chip_ALC650D
  1051                                  ;              dw 22h, chip_ALC650E
  1052                                  ;              dw 23h, chip_ALC650F
  1053                                  ;              dw 60h, chip_ALC655
  1054                                  ;              dw 80h, chip_ALC658
  1055                                  ;              dw 81h, chip_ALC658D
  1056                                  ;              dw 90h, chip_ALC850
  1057                                  ;              dw 0FFh
  1058                                  
  1059                                  ;chips_CMedia  dw 41h, chip_CM9738
  1060                                  ;              dw 61h, chip_CM9739
  1061                                  ;              dw 69h, chip_CM9780
  1062                                  ;              dw 78h, chip_CM9761
  1063                                  ;              dw 82h, chip_CM9761
  1064                                  ;              dw 83h, chip_CM9761
  1065                                  ;              dw 0FFh
  1066                                  
  1067                                  ;chips_VIA     dw 61h, chip_VIA1612A
  1068                                  ;              dw 0FFh
  1069                                  
  1070                                  ;Realtek
  1071                                  ;chip_ALC201a    db 'ALC201a',0dh,0ah,00h
  1072                                  ;chip_ALC650     db 'ALC650 ',0dh,0ah,00h
  1073                                  ;chip_ALC650D    db 'ALC650D',0dh,0ah,00h
  1074                                  ;chip_ALC650E    db 'ALC650E',0dh,0ah,00h
  1075                                  ;chip_ALC650F    db 'ALC650F',0dh,0ah,00h
  1076                                  ;chip_ALC655     db 'ALC655 ',0dh,0ah,00h
  1077                                  ;chip_ALC658     db 'ALC658 ',0dh,0ah,00h
  1078                                  ;chip_ALC658D    db 'ALC658D',0dh,0ah,00h
  1079                                  ;chip_ALC850     db 'ALC850 ',0dh,0ah,00h
  1080                                  
  1081                                  ;CMedia
  1082                                  ;chip_CM9738     db 'CMI9738', 0dh,0ah,0
  1083                                  ;chip_CM9739     db 'CMI9739', 0dh,0ah,0
  1084                                  ;chip_CM9780     db 'CMI9780', 0dh,0ah,0
  1085                                  ;chip_CM9761     db 'CMI9761', 0dh,0ah,0
  1086                                  
  1087                                  ;VIA
  1088                                  ;chip_VIA1612A   db 'VIA1612A',13,10,0
  1089                                  
  1090                                  ; 11/11/2023
  1091                                  msg_init_err:
  1092 00001CCE 0D0A                    	db	CR, LF
  1093 00001CD0 4143393720436F6E74-     	db	"AC97 Controller/Codec initialization error !"
  1093 00001CD9 726F6C6C65722F436F-
  1093 00001CE2 64656320696E697469-
  1093 00001CEB 616C697A6174696F6E-
  1093 00001CF4 206572726F722021   
  1094 00001CFC 0D0A24                  	db	CR, LF, "$"
  1095                                  
  1096                                  ; 12/11/2023
  1097                                  msg_no_vra:
  1098 00001CFF 0D0A                    	db	CR, LF
  1099 00001D01 4E6F20565241207375-     	db	"No VRA support ! Only 48 kHZ sample rate supported !"
  1099 00001D0A 70706F72742021204F-
  1099 00001D13 6E6C79203438206B48-
  1099 00001D1C 5A2073616D706C6520-
  1099 00001D25 726174652073757070-
  1099 00001D2E 6F727465642021     
  1100 00001D35 0D0A24                  	db	CR, LF, "$"
  1101                                  
  1102                                  ; 17/02/2017
  1103                                  bss_start:
  1104                                  
  1105                                  ABSOLUTE bss_start
  1106                                  
  1107                                  alignb 2
  1108                                  
  1109                                  ; 28/11/2016
  1110                                  
  1111 00001D38 <res 1Ch>               smpRBuff:	resw 14 ; 19/11/2016 - Erdogan Tan
  1112                                  
  1113 00001D54 ????                    filehandle:	resw 1
  1114                                  
  1115 00001D56 ??                      flags:		resb 1
  1116                                  ; 06/11/2023
  1117 00001D57 ??                      ac97_int_ln_reg: resb 1
  1118                                  
  1119                                  ; 06/11/2023
  1120                                  ;pcm_irq_status: resb 1	; 05/11/2023
  1121                                  ;
  1122                                  ;inside:	resb 1
  1123                                  ;tLoop:		resb 1
  1124                                  
  1125                                  ; 06/11/2023
  1126                                  ; 05/11/2023
  1127                                  ; 04/11/2023
  1128                                  ;IRQ_status:	resw 1	; IRQ status before enabling audio interrupt
  1129                                  ;IRQ_vector:	resd 1  ; Previous interrupt handler address	
  1130                                  
  1131                                  ; 17/02/2017
  1132                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  1133                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  1134                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  1135                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  1136 00001D58 ????                    NAMBAR:		resw 1			; BAR for mixer
  1137 00001D5A ????                    NABMBAR:	resw 1			; BAR for bus master regs
  1138                                  
  1139                                  ; 256 byte buffer for descriptor list
  1140 00001D5C ????                    BDL_BUFFER:	resw 1			; segment of our 256byte BDL buffer
  1141 00001D5E ????                    WAV_BUFFER1:	resw 1			; segment of our WAV storage
  1142                                  ; 64k buffers for wav file storage
  1143 00001D60 ????                    WAV_BUFFER2:	resw 1			; segment of 2nd wav buffer
  1144                                  
  1145                                  ; 06/11/2023
  1146                                  ;tBuff:		resb 1
  1147                                  ;ac97_int_ln_reg: resb 1
  1148                                  
  1149                                  ; 12/11/2016 - Erdogan Tan
  1150                                  
  1151 00001D62 ????????                bus_dev_fn:	resd 1
  1152 00001D66 ????????                dev_vendor:	resd 1
  1153                                  ; 06/11/2023
  1154                                  ;stats_cmd:	resw 1 ; 17/02/2017
  1155                                  ; 05/11/2023
  1156                                  ;ac97_io_base:	resw 1
  1157 00001D6A ????                    sample_rate:	resw 1
  1158                                  
  1159                                  ; 19/11/2016
  1160 00001D6C ????                    stmo:		resw 1 
  1161 00001D6E ????                    bps:		resw 1
  1162                                  
  1163                                  ; 08/11/2023
  1164                                  ; 07/11/2023
  1165 00001D70 ??                      fbs_shift:	resb 1
  1166 00001D71 ??                      		resb 1 ; 08/11/2023
  1167                                  
  1168                                  ;fbs_seg:	resw 1
  1169                                  ;fbs_off:	resw 1
  1170                                  
  1171                                  ;alignb 2
  1172                                  
  1173                                  ; 32 kilo bytes for temporay buffer
  1174                                  ; (for stereo-mono, 8bit/16bit corrections)
  1175                                  ;temp_buffer:	resb 32768
  1176                                  ; 18/11/2023
  1177 00001D72 <res DBF0h>             temp_buffer:	resb 56304  ; (44.1 kHZ stereo 14076 samples)	
  1178                                  
  1179                                  ;alignb 16
  1180                                  EOF:
