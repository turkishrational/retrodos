     1                                  ; ****************************************************************************
     2                                  ; PLAYWAV.ASM - ICH AC97 .wav player for DOS.			   PLAYWAV.COM
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; Last Update: 19/11/2023 (Previous: 18/11/2023)
     5                                  ; ----------------------------------------------------------------------------
     6                                  ; Beginning: 17/02/2017
     7                                  ; ----------------------------------------------------------------------------
     8                                  ; Assembler: NASM version 2.11 (2.15)
     9                                  ;	     nasm playwav.asm -l playwav.lst -o PLAYWAV.COM	
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Derived from '.wav file player for DOS' Jeff Leyda, Sep 02, 2002 
    12                                  ; ****************************************************************************
    13                                  ; Modidified from 'PLAYER.COM' for VIA VT8233 wav player source code by
    14                                  ; (PLAYER.ASM) by Erdogan Tan (07/11/2016 - 08/12/2016)
    15                                  
    16                                  ; TUNELOOP version (playing without AC97 interrupt) - 06/11/2023 - Erdogan Tan
    17                                  ; sample rate conversion version - 18/11/2023 - Erdogan Tan
    18                                  
    19                                  [BITS 16]
    20                                  
    21                                  [ORG 100h] 
    22                                  
    23                                  	%include 'ac97.inc' ; 17/02/2017
     1                              <1> ; 11/11/2023
     2                              <1> ; 05/11/2023
     3                              <1> ; 03/11/2023
     4                              <1> ; 17/02/2017 (Erdogan Tan, PLAYWAV.ASM)
     5                              <1> ; constant.inc & codec.inc (for ICH AC97 wav player, 'PLAYWAV.COM') 
     6                              <1> 
     7                              <1> ; ----------------------------------------------------------------------------
     8                              <1> ; CONSTANT.INC
     9                              <1> ; ----------------------------------------------------------------------------
    10                              <1> 
    11                              <1> ;constants of stuff that seem hard to remember at times.
    12                              <1> 
    13                              <1> TRUE  EQU 1
    14                              <1> FALSE EQU 0
    15                              <1> 
    16                              <1> ENABLED  EQU 1
    17                              <1> DISABLED EQU 0
    18                              <1> 
    19                              <1> BIT0  EQU 1
    20                              <1> BIT1  EQU 2
    21                              <1> BIT2  EQU 4
    22                              <1> BIT3  EQU 8
    23                              <1> BIT4  EQU 10h
    24                              <1> BIT5  EQU 20h
    25                              <1> BIT6  EQU 40h
    26                              <1> BIT7  EQU 80h
    27                              <1> BIT8  EQU 100h
    28                              <1> BIT9  EQU 200h
    29                              <1> BIT10 EQU 400h
    30                              <1> BIT11 EQU 800h
    31                              <1> BIT12 EQU 1000h
    32                              <1> BIT13 EQU 2000h
    33                              <1> BIT14 EQU 4000h
    34                              <1> BIT15 EQU 8000h
    35                              <1> BIT16 EQU 10000h
    36                              <1> BIT17 EQU 20000h
    37                              <1> BIT18 EQU 40000h
    38                              <1> BIT19 EQU 80000h
    39                              <1> BIT20 EQU 100000h
    40                              <1> BIT21 EQU 200000h
    41                              <1> BIT22 EQU 400000h
    42                              <1> BIT23 EQU 800000h
    43                              <1> BIT24 EQU 1000000h
    44                              <1> BIT25 EQU 2000000h
    45                              <1> BIT26 EQU 4000000h
    46                              <1> BIT27 EQU 8000000h
    47                              <1> BIT28 EQU 10000000h
    48                              <1> BIT29 EQU 20000000h
    49                              <1> BIT30 EQU 40000000h
    50                              <1> BIT31 EQU 80000000h
    51                              <1> 
    52                              <1> ;special characters
    53                              <1> NUL     EQU 0
    54                              <1> NULL    EQU 0
    55                              <1> BELL    EQU 07
    56                              <1> BS      EQU 08
    57                              <1> TAB     EQU 09
    58                              <1> LF      EQU 10
    59                              <1> CR      EQU 13
    60                              <1> ESCAPE  EQU 27           ;ESC is a reserved word....
    61                              <1> 
    62                              <1> 
    63                              <1> ;file stuff
    64                              <1> READONLY  EQU   BIT0
    65                              <1> HIDDEN    EQU   BIT1
    66                              <1> SYSTEM    EQU   BIT2
    67                              <1> VOLUME    EQU   BIT3         ;ignored for file access
    68                              <1> DIRECTORY EQU   BIT4         ;must be 0 for file access
    69                              <1> ARCHIVE   EQU   BIT5
    70                              <1> SHAREABLE EQU   BIT7         ;for novell networks
    71                              <1> OPEN	EQU	2		; open existing file
    72                              <1> CREATE	EQU	1		; create new file
    73                              <1> 
    74                              <1> 
    75                              <1> ; PCI equates
    76                              <1> ; PCI function address (PFA)
    77                              <1> ; bit 31 = 1
    78                              <1> ; bit 23:16 = bus number     (0-255)
    79                              <1> ; bit 15:11 = device number  (0-31)
    80                              <1> ; bit 10:8 = function number (0-7)
    81                              <1> ; bit 7:0 = register number  (0-255)
    82                              <1> 
    83                              <1> IO_ADDR_MASK    EQU     0FFFEh          ; mask off bit 0 for reading BARs
    84                              <1> PCI_INDEX_PORT  EQU     0CF8h
    85                              <1> PCI_DATA_PORT   EQU     0CFCh
    86                              <1> PCI32           EQU     BIT31           ; bitflag to signal 32bit access
    87                              <1> PCI16           EQU     BIT30           ; bitflag for 16bit access
    88                              <1> 
    89                              <1> PCI_FN0         EQU     0 << 8
    90                              <1> PCI_FN1         EQU     1 << 8
    91                              <1> PCI_FN2         EQU     2 << 8
    92                              <1> PCI_FN3         EQU     3 << 8
    93                              <1> PCI_FN4         EQU     4 << 8
    94                              <1> PCI_FN5         EQU     5 << 8
    95                              <1> PCI_FN6         EQU     6 << 8
    96                              <1> PCI_FN7         EQU     7 << 8
    97                              <1> 
    98                              <1> PCI_CMD_REG		EQU	04h		; reg 04, command reg
    99                              <1>  IO_ENA			EQU	BIT0		; i/o decode enable
   100                              <1>  MEM_ENA		EQU	BIT1		; memory decode enable
   101                              <1>  BM_ENA                 EQU     BIT2		; bus master enable
   102                              <1> 
   103                              <1> ; ----------------------------------------------------------------------------
   104                              <1> ; CODEC.INC
   105                              <1> ; ----------------------------------------------------------------------------
   106                              <1> 
   107                              <1> ;Codec registers.
   108                              <1> ;
   109                              <1> ;Not all codecs are created equal. Refer to the spec for your specific codec.
   110                              <1> ;
   111                              <1> ;All registers are 16bits wide.  Access to codec registers over the AC97 link
   112                              <1> ;is defined by the OEM.  
   113                              <1> ;
   114                              <1> ;Secondary codec's are accessed by ORing in BIT7 of all register accesses.
   115                              <1> ;
   116                              <1> 
   117                              <1> ; each codec/mixer register is 16bits
   118                              <1> 
   119                              <1> CODEC_RESET_REG                 equ     00      ; reset codec
   120                              <1> CODEC_MASTER_VOL_REG            equ     02      ; master volume
   121                              <1> CODEC_HP_VOL_REG                equ     04      ; headphone volume
   122                              <1> CODEC_MASTER_MONO_VOL_REG       equ     06      ; master mono volume
   123                              <1> CODEC_MASTER_TONE_REG           equ     08      ; master tone (R+L)
   124                              <1> CODEC_PCBEEP_VOL_REG            equ     0ah     ; PC beep volume
   125                              <1> CODEC_PHONE_VOL_REG             equ     0bh     ; phone volume
   126                              <1> CODEC_MIC_VOL_REG               equ     0eh     ; MIC volume
   127                              <1> CODEC_LINE_IN_VOL_REG           equ     10h     ; line input volume
   128                              <1> CODEC_CD_VOL_REG                equ     12h     ; CD volume
   129                              <1> CODEC_VID_VOL_REG               equ     14h     ; video volume
   130                              <1> CODEC_AUX_VOL_REG               equ     16h     ; aux volume
   131                              <1> CODEC_PCM_OUT_REG               equ     18h     ; PCM output volume
   132                              <1> CODEC_RECORD_SELECT_REG         equ     1ah     ; record select input
   133                              <1> CODEC_RECORD_VOL_REG            equ     1ch     ; record volume
   134                              <1> CODEC_RECORD_MIC_VOL_REG        equ     1eh     ; record mic volume
   135                              <1> CODEC_GP_REG                    equ     20h     ; general purpose
   136                              <1> CODEC_3D_CONTROL_REG            equ     22h     ; 3D control
   137                              <1> ; 24h is reserved
   138                              <1> CODEC_POWER_CTRL_REG            equ     26h     ; powerdown control
   139                              <1> CODEC_EXT_AUDIO_REG             equ     28h     ; extended audio
   140                              <1> CODEC_EXT_AUDIO_CTRL_REG        equ     2ah     ; extended audio control
   141                              <1> CODEC_PCM_FRONT_DACRATE_REG     equ     2ch     ; PCM out sample rate
   142                              <1> CODEC_PCM_SURND_DACRATE_REG     equ     2eh     ; surround sound sample rate
   143                              <1> CODEC_PCM_LFE_DACRATE_REG       equ     30h     ; LFE sample rate
   144                              <1> CODEC_LR_ADCRATE_REG            equ     32h     ; PCM in sample rate
   145                              <1> CODEC_MIC_ADCRATE_REG           equ     34h     ; mic in sample rate
   146                              <1> 
   147                              <1> ; registers 36-7a are reserved on the ICH
   148                              <1> 
   149                              <1> CODEC_VENDORID1_REG             equ     7ch     ; codec vendor ID 1
   150                              <1> CODEC_VENDORID2_REG             equ     7eh     ; codec vendor ID 2
   151                              <1> 
   152                              <1> ; Mixer registers 0 through 51h reside in the ICH and are not forwarded over
   153                              <1> ; the AC97 link to the codec, which I think is a little weird.  Looks like
   154                              <1> ; the ICH makes it so you don't need a fully functional codec to play audio?
   155                              <1> ;
   156                              <1> ; whenever 2 codecs are present in the system, use BIT7 to access the 2nd
   157                              <1> ; set of registers, ie 80h-feh
   158                              <1> 
   159                              <1> PRIMARY_CODEC                   equ     0       ; 0-7F for primary codec
   160                              <1> SECONDARY_CODEC                 equ     BIT7    ; 80-8f registers for 2ndary
   161                              <1> 
   162                              <1> SAMPLE_RATE_441khz	equ     44100   ; 44.1Khz (cd quality) rate
   163                              <1> 
   164                              <1> ; ----------------------------------------------------------------------------
   165                              <1> ; 17/02/2017
   166                              <1> PCI_IO_BASE	equ 10h			; = NAMBAR register offset
   167                              <1> AC97_INT_LINE   equ 3Ch			; AC97 Interrupt Line register offset
   168                              <1> 
   169                              <1> ; ----------------------------------------------------------------------------
   170                              <1> ; ICH2AC97.INC
   171                              <1> ; ----------------------------------------------------------------------------
   172                              <1> 
   173                              <1> ; PCI stuff
   174                              <1> 
   175                              <1> ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
   176                              <1> 
   177                              <1> INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
   178                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   179                              <1> SIS_VID		equ	1039h
   180                              <1> NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
   181                              <1> AMD_VID		equ	1022h
   182                              <1> 
   183                              <1> ICH_DID         equ     2415h           ; ICH device ID
   184                              <1> ICH0_DID        equ     2425h           ; ICH0
   185                              <1> ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
   186                              <1>                                         ; they all should be compatible.
   187                              <1> 
   188                              <1> ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
   189                              <1> ICH3_DID	equ     2485h           ; ICH3
   190                              <1> ICH4_DID        equ     24C5h           ; ICH4
   191                              <1> ICH5_DID	equ     24D5h           ; ICH5 
   192                              <1> ICH6_DID	equ     266Eh           ; ICH6
   193                              <1> ESB6300_DID	equ     25A6h           ; 6300ESB
   194                              <1> ESB631X_DID	equ     2698h           ; 631XESB
   195                              <1> ICH7_DID	equ	27DEh		; ICH7
   196                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   197                              <1> MX82440_DID	equ	7195h
   198                              <1> SI7012_DID	equ	7012h
   199                              <1> NFORCE_DID	equ	01B1h
   200                              <1> NFORCE2_DID	equ	006Ah
   201                              <1> AMD8111_DID	equ	746Dh
   202                              <1> AMD768_DID	equ	7445h
   203                              <1> ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
   204                              <1> CK804_DID	equ	0059h
   205                              <1> MCP04_DID	equ	003Ah
   206                              <1> CK8_DID		equ	008Ah
   207                              <1> NFORCE3_DID	equ	00DAh
   208                              <1> CK8S_DID	equ	00EAh
   209                              <1> 
   210                              <1> NAMBAR_REG      equ     10h             ; native audio mixer BAR
   211                              <1>  NAM_SIZE       equ     256             ; 256 bytes required.
   212                              <1> 
   213                              <1> NABMBAR_REG     equ     14h             ; native audio bus mastering BAR
   214                              <1>  NABM_SIZE      equ     64              ; 64 bytes
   215                              <1> 
   216                              <1> ; BUS master registers, accessed via NABMBAR+offset
   217                              <1> 
   218                              <1> ; ICH supports 3 different types of register sets for three types of things
   219                              <1> ; it can do, thus:
   220                              <1> ;
   221                              <1> ; PCM in (for recording) aka PI
   222                              <1> ; PCM out (for playback) aka PO
   223                              <1> ; MIC in (for recording) aka MC
   224                              <1> 
   225                              <1> PI_BDBAR_REG            equ     0       ; PCM in buffer descriptor BAR
   226                              <1> PO_BDBAR_REG            equ     10h     ; PCM out buffer descriptor BAR
   227                              <1> MC_BDBAR_REG            equ     20h     ; MIC in buffer descriptor BAR
   228                              <1> 
   229                              <1> ; each buffer descriptor BAR holds a pointer which has entries to the buffer
   230                              <1> ; contents of the .WAV file we're going to play. Each entry is 8 bytes long
   231                              <1> ; (more on that later) and can contain 32 entries total, so each BAR is
   232                              <1> ; 256 bytes in length, thus:
   233                              <1> 
   234                              <1> BDL_SIZE                equ     32*8    ; Buffer Descriptor List size
   235                              <1> INDEX_MASK              equ     31      ; indexes must be 0-31
   236                              <1> 
   237                              <1> 
   238                              <1> 
   239                              <1> PI_CIV_REG              equ     4       ; PCM in current Index value (RO)
   240                              <1> PO_CIV_REG              equ     14h     ; PCM out current Index value (RO)
   241                              <1> MC_CIV_REG              equ     24h     ; MIC in current Index value (RO)
   242                              <1> ;8bit read only
   243                              <1> ; each current index value is simply a pointer showing us which buffer
   244                              <1> ; (0-31) the codec is currently processing. Once this counter hits 31, it
   245                              <1> ; wraps back to 0.
   246                              <1> ; this can be handy to know, as once it hits 31, we're almost out of data to
   247                              <1> ; play back or room to record!
   248                              <1> 
   249                              <1> 
   250                              <1> PI_LVI_REG              equ     5       ; PCM in Last Valid Index
   251                              <1> PO_LVI_REG              equ     15h     ; PCM out Last Valid Index
   252                              <1> MC_LVI_REG              equ     25h     ; MIC in Last Valid Index
   253                              <1> ;8bit read/write
   254                              <1> ; The Last Valid Index is a number (0-31) to let the codec know what buffer
   255                              <1> ; number to stop on after processing. It could be very nasty to play audio
   256                              <1> ; from buffers that aren't filled with the audio we want to play.
   257                              <1> 
   258                              <1> 
   259                              <1> PI_SR_REG               equ     6       ; PCM in Status register
   260                              <1> PO_SR_REG               equ     16h     ; PCM out Status register
   261                              <1> MC_SR_REG               equ     26h     ; MIC in Status register
   262                              <1> ;16bit read/write
   263                              <1> ; status registers.  Bitfields follow:
   264                              <1> 
   265                              <1> FIFO_ERR                equ     BIT4    ; FIFO Over/Underrun W1TC.
   266                              <1> 
   267                              <1> BCIS                    equ     BIT3    ; buffer completion interrupt status.
   268                              <1>                                         ; Set whenever the last sample in ANY
   269                              <1>                                         ; buffer is finished.  Bit is only
   270                              <1>                                         ; set when the Interrupt on Complete
   271                              <1>                                         ; (BIT4 of control reg) is set.
   272                              <1> 
   273                              <1> LVBCI                   equ     BIT2    ; Set whenever the codec has processed
   274                              <1>                                         ; the last buffer in the buffer list.
   275                              <1>                                         ; Will fire an interrupt if IOC bit is
   276                              <1>                                         ; set. Probably set after the last
   277                              <1>                                         ; sample in the last buffer is
   278                              <1>                                         ; processed.  W1TC
   279                              <1> 
   280                              <1>                                         ; 
   281                              <1> CELV                    equ     BIT1    ; Current buffer == last valid.
   282                              <1>                                         ; Bit is RO and remains set until LVI is
   283                              <1>                                         ; cleared.  Probably set up the start
   284                              <1>                                         ; of processing for the last buffer.
   285                              <1> 
   286                              <1> 
   287                              <1> DCH                     equ     BIT0    ; DMA controller halted.
   288                              <1>                                         ; set whenever audio stream is stopped
   289                              <1>                                         ; or something else goes wrong.
   290                              <1> 
   291                              <1> 
   292                              <1> PI_PICB_REG             equ     8       ; PCM in position in current buffer(RO)
   293                              <1> PO_PICB_REG             equ     18h     ; PCM out position in current buffer(RO)
   294                              <1> MC_PICB_REG             equ     28h     ; MIC in position in current buffer (RO)
   295                              <1> ;16bit read only
   296                              <1> ; position in current buffer regs show the number of dwords left to be
   297                              <1> ; processed in the current buffer.
   298                              <1> ; 
   299                              <1> 
   300                              <1> PI_PIV_REG              equ     0ah     ; PCM in Prefected index value
   301                              <1> PO_PIV_REG              equ     1ah     ; PCM out Prefected index value
   302                              <1> MC_PIV_REG              equ     2ah     ; MIC in Prefected index value
   303                              <1> ;8bit, read only
   304                              <1> ; Prefetched index value register.
   305                              <1> ; tells which buffer number (0-31) has be prefetched. I'd imagine this
   306                              <1> ; value follows the current index value fairly closely. (CIV+1)
   307                              <1> ;
   308                              <1> 
   309                              <1> 
   310                              <1> PI_CR_REG               equ     0bh     ; PCM in Control Register
   311                              <1> PO_CR_REG               equ     1bh     ; PCM out Control Register
   312                              <1> MC_CR_REG               equ     2bh     ; MIC in Control Register
   313                              <1> ; 8bit
   314                              <1> ; Control register *MUST* only be accessed as an 8bit value.
   315                              <1> ; Control register. See bitfields below.
   316                              <1> ;
   317                              <1> 
   318                              <1> 
   319                              <1> IOCE                    equ     BIT4    ; interrupt on complete enable.
   320                              <1>                                         ; set this bit if you want an intrtpt
   321                              <1>                                         ; to fire whenever LVBCI is set.
   322                              <1> FEIFE                   equ     BIT3    ; set if you want an interrupt to fire
   323                              <1>                                         ; whenever there is a FIFO (over or
   324                              <1>                                         ; under) error.
   325                              <1> LVBIE                   equ     BIT2    ; last valid buffer interrupt enable.
   326                              <1>                                         ; set if you want an interrupt to fire
   327                              <1>                                         ; whenever the completion of the last
   328                              <1>                                         ; valid buffer.
   329                              <1> RR                      equ     BIT1    ; reset registers.  Nukes all regs
   330                              <1>                                         ; except bits 4:2 of this register.
   331                              <1>                                         ; Only set this bit if BIT 0 is 0
   332                              <1> RPBM                    equ     BIT0    ; Run/Pause
   333                              <1>                                         ; set this bit to start the codec!
   334                              <1> 
   335                              <1> 
   336                              <1> GLOB_CNT_REG            equ     2ch     ; Global control register
   337                              <1> SEC_RES_EN              equ     BIT5    ; secondary codec resume event 
   338                              <1>                                         ; interrupt enable.  Not used here.
   339                              <1> PRI_RES_EN              equ     BIT4    ; ditto for primary. Not used here.
   340                              <1> ACLINK_OFF              equ     BIT3    ; Turn off the AC97 link
   341                              <1> ACWARM_RESET            equ     BIT2    ; Awaken the AC97 link from sleep.
   342                              <1>                                         ; registers preserved, bit self clears
   343                              <1> ACCOLD_RESET            equ     BIT1    ; Reset everything in the AC97 and
   344                              <1>                                         ; reset all registers.  Not self clearing
   345                              <1> 
   346                              <1> GPIIE                   equ     BIT0    ; GPI Interrupt enable.
   347                              <1>                                         ; set if you want an interrupt to
   348                              <1>                                         ; fire upon ANY of the bits in the
   349                              <1>                                         ; GPI (general pursose inputs?) not used.
   350                              <1> 
   351                              <1> GLOB_STS_REG            equ     30h     ; Global Status register (RO)
   352                              <1> 
   353                              <1> MD3                     equ     BIT17   ; modem powerdown status (yawn)
   354                              <1> AD3                     equ     BIT16   ; Audio powerdown status (yawn)
   355                              <1> RD_COMPLETE_STS         equ     BIT15   ; Codec read timed out. 0=normal
   356                              <1> BIT3SLOT12              equ     BIT14   ; shadowed status of bit 3 in slot 12
   357                              <1> BIT2SLOT12              equ     BIT13   ; shadowed status of bit 2 in slot 12
   358                              <1> BIT1SLOT12              equ     BIT12   ; shadowed status of bit 1 in slot 12
   359                              <1> SEC_RESUME_STS          equ     BIT11   ; secondary codec has resumed (and irqed)
   360                              <1> PRI_RESUME_STS          equ     BIT10   ; primary codec has resumed (and irqed)
   361                              <1> SEC_CODEC_RDY           equ     BIT9    ; secondary codec is ready for action
   362                              <1> PRI_CODEC_RDY           equ     BIT8    ; Primary codec is ready for action
   363                              <1>                                         ; software must check these bits before
   364                              <1>                                         ; starting the codec!
   365                              <1> MIC_IN_IRQ              equ     BIT7    ; MIC in caused an interrupt
   366                              <1> PCM_OUT_IRQ             equ     BIT6    ; One of the PCM out channels IRQed
   367                              <1> PCM_IN_IRQ              equ     BIT5    ; One of the PCM in channels IRQed
   368                              <1> MODEM_OUT_IRQ           equ     BIT2    ; modem out channel IRQed
   369                              <1> MODEM_IN_IRQ            equ     BIT1    ; modem in channel IRQed
   370                              <1> GPI_STS_CHANGE          equ     BIT0    ; set whenever GPI's have changed.
   371                              <1>                                         ; BIT0 of slot 12 also reflects this.
   372                              <1> 
   373                              <1> ACC_SEMA_REG            equ     34h     ; Codec write semiphore register
   374                              <1> CODEC_BUSY              equ     BIT0    ; codec register I/O is happening
   375                              <1>                                         ; self clearing
   376                              <1> ;
   377                              <1> ; Buffer Descriptors List
   378                              <1> ; As stated earlier, each buffer descriptor list is a set of (up to) 32 
   379                              <1> ; descriptors, each 8 bytes in length. Bytes 0-3 of a descriptor entry point
   380                              <1> ; to a chunk of memory to either play from or record to. Bytes 4-7 of an
   381                              <1> ; entry describe various control things detailed below.
   382                              <1> ; 
   383                              <1> ; Buffer pointers must always be aligned on a Dword boundry.
   384                              <1> ;
   385                              <1> 
   386                              <1> IOC                     equ     BIT31   ; Fire an interrupt whenever this
   387                              <1>                                         ; buffer is complete.
   388                              <1> 
   389                              <1> BUP                     equ     BIT30   ; Buffer Underrun Policy.
   390                              <1>                                         ; if this buffer is the last buffer
   391                              <1>                                         ; in a playback, fill the remaining
   392                              <1>                                         ; samples with 0 (silence) or not.
   393                              <1>                                         ; It's a good idea to set this to 1
   394                              <1>                                         ; for the last buffer in playback,
   395                              <1>                                         ; otherwise you're likely to get a lot
   396                              <1>                                         ; of noise at the end of the sound.
   397                              <1> 
   398                              <1> ;
   399                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   400                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   401                              <1> ; Luckily for us, that's the same format as .wav files.
   402                              <1> ;
   403                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   404                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   405                              <1> ;
   406                              <1> ; A value of 0 in these bits means play no samples.
   407                              <1> ;
   408                              <1> 
   409                              <1> ; 11/11/2023
   410                              <1> CTRL_ST_CREADY		equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
   411                              <1> CODEC_REG_POWERDOWN	equ	26h
    24                                  
    25                                  _STARTUP:
    26                                  
    27                                  ; memory allocation
    28                                  
    29 00000000 E82C01                          call    setFree				; deallocate unused DOS mem
    30                                  
    31                                  	; 17/02/2017
    32                                  	; Clear BSS (uninitialized data) area
    33 00000003 31C0                    	xor	ax, ax ; 0
    34 00000005 B9156E                  	mov	cx, (EOF - bss_start)/2
    35 00000008 BF[E51C]                	mov	di, bss_start
    36 0000000B F3AB                    	rep	stosw
    37                                  
    38                                  ; allocate 256 bytes of data for DCM_OUT Buffer Descriptor List. (BDL)
    39                                  
    40 0000000D B81000                          mov     ax, BDL_SIZE / 16
    41 00000010 E82401                          call    memAlloc
    42 00000013 A3[0A1D]                        mov     [BDL_BUFFER], ax		; segment 
    43                                  
    44                                  ; allocate 2 buffers, 64k each for now.
    45                                  
    46 00000016 B80010                          mov     ax, BUFFERSIZE / 16		; 64k for .WAV file
    47 00000019 E81B01                          call    memAlloc
    48 0000001C A3[0C1D]                        mov     [WAV_BUFFER1], ax		; segment
    49                                  
    50 0000001F B80010                  	mov	ax, BUFFERSIZE / 16
    51 00000022 E81201                  	call	memAlloc
    52 00000025 A3[0E1D]                	mov	[WAV_BUFFER2], ax
    53                                  
    54                                  ; Detect/reset AC97 
    55                                  
    56 00000028 E87F02                          call    pciFindDevice
    57 0000002B 7342                            jnc     short _1
    58                                  
    59                                  ; couldn't find the audio device!
    60                                  
    61 0000002D 0E                      	push	cs
    62 0000002E 1F                      	pop	ds
    63 0000002F BA[3900]                        mov     dx, noDevMsg
    64 00000032 B409                            mov     ah, 9
    65 00000034 CD21                            int     21h
    66 00000036 E9E600                          jmp     exit
    67                                  
    68                                  ; 17/02/2017
    69 00000039 4572726F723A20556E-     noDevMsg db "Error: Unable to find intel ICH based audio device!",CR,LF,"$"
    69 00000042 61626C6520746F2066-
    69 0000004B 696E6420696E74656C-
    69 00000054 204943482062617365-
    69 0000005D 6420617564696F2064-
    69 00000066 6576696365210D0A24 
    70                                  
    71                                  _1:
    72                                  	; eax = BUS/DEV/FN
    73                                  	;	00000000BBBBBBBBDDDDDFFF00000000
    74                                  	; edx = DEV/VENDOR
    75                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
    76                                  
    77 0000006F 66A3[101D]              	mov	[bus_dev_fn], eax
    78 00000073 668916[141D]            	mov	[dev_vendor], edx
    79                                  
    80                                  	; get ICH base address regs for mixer and bus master
    81                                  
    82 00000078 B010                            mov     al, NAMBAR_REG
    83 0000007A E89F01                          call    pciRegRead16			; read PCI registers 10-11
    84 0000007D 83E2FE                          and     dx, IO_ADDR_MASK 		; mask off BIT0
    85                                  
    86 00000080 8916[061D]                      mov     [NAMBAR], dx			; save audio mixer base addy
    87                                  
    88 00000084 B014                    	mov     al, NABMBAR_REG
    89 00000086 E89301                          call    pciRegRead16
    90 00000089 83E2FE                          and     dx, IO_ADDR_MASK
    91                                  
    92 0000008C 8916[081D]                      mov     [NABMBAR], dx			; save bus master base addy
    93                                  
    94                                  	; 06/11/2023
    95                                  	;; init controller
    96                                  	;; 17/02/2017
    97                                  	;mov	al, PCI_CMD_REG ; command register (04h)
    98                                  	;call	pciRegRead16 ; pciRegRead8
    99                                  	;
   100                                  	;; eax = BUS/DEV/FN/REG
   101                                  	;;  dx = PCI Command Register Content ; 17/02/2017
   102                                  	;; 	00000000CCCCCCCC
   103                                  	;mov	[stats_cmd], dx
   104                                  	;
   105                                  	; 06/11/2023
   106                                  	;mov	al, PCI_IO_BASE ; IO base address register (10h)
   107                                  	;call	pciRegRead32
   108                                  	;
   109                                  	;and	dx, 0FFC0h	; IO_ADDR_MASK (0FFFE) ?
   110                                          ;mov	[ac97_io_base], dx
   111                                  
   112 00000090 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
   113 00000092 E87F01                  	call	pciRegRead8 ; 17/02/2017
   114                                  
   115 00000095 8816[051D]              	mov     [ac97_int_ln_reg], dl
   116                                  
   117                                  ; 05/11/2023
   118                                  %if 0
   119                                  	; 28/11/2016
   120                                  	mov	bx, 1
   121                                  	xor	dh, dh 	 ; 17/02/2017
   122                                  	mov	cx, dx
   123                                  	shl	bx, cl
   124                                  
   125                                  	; 04/11/2023
   126                                  	cli
   127                                  
   128                                  	;not	bx
   129                                  	in	al, 0A1h ; irq 8-15
   130                                          mov	ah, al
   131                                          in	al, 21h  ; irq 0-7 
   132                                  
   133                                  	; 04/11/2023
   134                                  	; save IRQ status
   135                                  	mov	[IRQ_status], ax
   136                                  
   137                                  	;and	ax, bx   ; unmask
   138                                   	btr	ax, dx	 ; unmask
   139                                  	out	21h, al  ; enable interrupt (if irq <= 7)
   140                                  	mov	al, ah
   141                                  	out	0A1h, al ; enable interrupt (if irq > 7)
   142                                  	;not	bx
   143                                  
   144                                  	; 04/11/2023
   145                                  	;mov	dx, 4D1h			;8259 ELCR1
   146                                          ;in	al, dx
   147                                  	;mov	ah, al
   148                                  	;mov	dx, 4D0h 
   149                                          ;in	al, dx
   150                                  	;;or	ax, bx        
   151                                  	;bts	ax, cx
   152                                  	;mov	dx, 4D0h
   153                                  	;out	dx, al                          ;set level-triggered mode
   154                                  	;mov	al, ah
   155                                  	;mov	dx, 4D1h
   156                                  	;out	dx, al                          ;set level-triggered mode
   157                                  
   158                                  	; 24/11/2016 - Erdogan Tan
   159                                  	mov	bx, cx
   160                                  	;mov	bx, dx
   161                                  	mov	bl, [bx+irq_int]
   162                                  	shl	bx, 2 ; * 4
   163                                  
   164                                  	; set up interrupt vector
   165                                  	; 30/11/2016
   166                                  	push	es
   167                                  	xor	ax, ax
   168                                  	mov	es, ax
   169                                  	; 04/11/2023
   170                                  	; save interrupt vector
   171                                  	mov	ax, [es:bx]
   172                                  	mov	[IRQ_vector], ax
   173                                  	mov	ax, [es:bx+2]
   174                                  	mov	[IRQ_vector+2], ax
   175                                  
   176                                  	mov	word [es:bx], ac97_int_handler
   177                                  	mov	ax, cs
   178                                  	mov	[es:bx+2], ax
   179                                  	pop	es
   180                                  
   181                                  	; 04/11/2023
   182                                  	sti
   183                                  
   184                                  %endif
   185 00000099 E89B18                  	call	write_ac97_dev_info 
   186                                  
   187                                  ; check the command line for a file to play
   188                                  
   189                                          ;push	ds
   190 0000009C E8A100                          call    processCmdline			; get the filename
   191                                  
   192                                  ; open the file
   193 0000009F B002                            mov     al, OPEN                        ; open existing file
   194 000000A1 E8BC00                          call    openFile                        ; no error? ok.
   195                                          ;pop	ds
   196 000000A4 7322                            jnc     short _gsr
   197                                  
   198                                  ; file not found!
   199                                  
   200                                          ;push   cs
   201                                          ;pop    ds
   202 000000A6 BA[AF00]                        mov	dx, noFileErrMsg
   203 000000A9 B409                            mov     ah, 9
   204 000000AB CD21                            int     21h
   205 000000AD EB70                            jmp     exit
   206                                  
   207                                  noFileErrMsg:
   208 000000AF 4572726F723A206669-     	db "Error: file not found.",CR,LF,"$"
   208 000000B8 6C65206E6F7420666F-
   208 000000C1 756E642E0D0A24     
   209                                  
   210                                  _gsr:
   211 000000C8 E8BC00                          call    getSampleRate                   ; read the sample rate
   212                                                                                  ; pass it onto codec.
   213 000000CB 7252                    	jc	short exit ; 19/11/2016 - nothing to do
   214                                  
   215 000000CD A3[181D]                	mov	[sample_rate], ax
   216                                  	
   217                                  	; 19/11/2016
   218 000000D0 880E[1A1D]              	mov	[stmo], cl
   219 000000D4 8816[1C1D]              	mov	[bps], dl
   220                                  	
   221                                  	; 17/02/2017
   222 000000D8 C606[1E1D]00            	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit 
   223 000000DD FEC9                    	dec	cl
   224 000000DF 7504                    	jnz	short _gsr_1 ; stereo
   225 000000E1 FE06[1E1D]              	inc	byte [fbs_shift] ; 1 = mono or 8 bit		
   226                                  _gsr_1:	
   227 000000E5 80FA08                  	cmp	dl, 8 
   228 000000E8 7704                    	ja	short _gsr_2 ; 16 bit samples
   229 000000EA FE06[1E1D]              	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   230                                  _gsr_2:	
   231 000000EE E8A819                  	call	write_sample_rate
   232                                  
   233                                  	; 05/11/2023
   234                                  _2:
   235 000000F1 E81107                  	call	check4keyboardstop  ; flush keyboard buffer
   236 000000F4 72FB                    	jc	short _2 	; 07/11/2023
   237                                  
   238                                  	; 05/11/2023
   239                                  	;mov	eax, [bus_dev_fn]
   240                                  	;mov	al, PCI_CMD_REG
   241                                  	;call	pciRegRead16			; read PCI command register
   242                                  	; 17/02/2017
   243                                  	;mov	dx, [stats_cmd]
   244                                          ;or	dl, IO_ENA+BM_ENA               ; enable IO and bus master
   245                                  	;call	pciRegWrite16 ; pciRegWrite8
   246                                  
   247                                  	; 06/11/2023
   248 000000F6 66A1[101D]              	mov	eax, [bus_dev_fn]
   249 000000FA B004                            mov     al, PCI_CMD_REG
   250 000000FC E81501                          call    pciRegRead8                     ; read PCI command register
   251 000000FF 80CA05                          or      dl, IO_ENA+BM_ENA               ; enable IO and bus master
   252 00000102 E88101                          call    pciRegWrite8
   253                                  
   254                                  ; setup the Codec (actually mixer registers) 
   255 00000105 E8E401                          call    codecConfig                     ; unmute codec, set rates.
   256                                  	; 11/11/2023
   257 00000108 721C                    	jc	short init_err
   258                                  ;
   259                                  ; position file pointer to start in actual wav data
   260                                  ; MUCH improvement should really be done here to check if sample size is
   261                                  ; supported, make sure there are 2 channels, etc.  
   262                                  ;
   263 0000010A B442                            mov     ah, 42h
   264 0000010C B000                            mov     al, 0                           ; from start of file
   265 0000010E 8B1E[021D]                      mov     bx, [filehandle]
   266 00000112 31C9                            xor     cx, cx
   267 00000114 BA2C00                          mov     dx, 44                          ; jump past .wav/riff header
   268 00000117 CD21                            int     21h
   269                                  
   270                                  ; play the .wav file. Most of the good stuff is in here.
   271                                  
   272 00000119 E86403                          call    playWav
   273                                  
   274                                  ; close the .wav file and exit.
   275                                  
   276                                  close_exit:			; 11/11/2023
   277 0000011C E85300                          call    closeFile
   278                                  
   279                                  exit:
   280 0000011F B8004C                          mov     ax, 4c00h
   281 00000122 CD21                    	int 	21h
   282                                  
   283                                  here:
   284 00000124 EBFE                    	jmp	short here
   285                                  
   286                                  	; 11/11/2023
   287                                  init_err:
   288 00000126 BA[7B1C]                	mov	dx, msg_init_err
   289                                  vra_err: ; 12/11/2023
   290 00000129 B409                            mov	ah, 9
   291 0000012B CD21                            int	21h
   292 0000012D EBED                    	jmp	short close_exit
   293                                  
   294                                  ; MEMALLOC.ASM
   295                                  ;-- SETFREE: Release memory not used  ----------------
   296                                  ;-- Input    : ES = address of PSP
   297                                  ;-- Output   : none
   298                                  ;-- Register : AX, BX, CL and FLAGS are changed 
   299                                  ;-- Info     : Since the stack-segment is always the last segment in an 
   300                                  ;              EXE-file, ES:0000 points to the beginning and SS:SP
   301                                  ;              to the end of the program in memory. Through this the
   302                                  ;              length of the program can be calculated 
   303                                  ; call this routine once at the beginning of the program to free up memory
   304                                  ; assigned to it by DOS.
   305                                  
   306                                  setFree:
   307 0000012F BB0010                  	  mov	bx, 65536/16	; 4K paragraphs ; 17/02/2017 (Erdogan Tan)		
   308                                  
   309 00000132 B44A                              mov	ah, 4ah		;pass new length to DOS
   310 00000134 CD21                              int	21h
   311                                  
   312 00000136 C3                                retn			; back to caller 
   313                                  				; new size (allocated memory) = 64KB
   314                                  
   315                                  memAlloc:
   316                                  ; input: AX = # of paragraphs required
   317                                  ; output: AX = segment of block to use
   318                                  
   319 00000137 53                      	push	bx
   320 00000138 89C3                    	mov	bx, ax
   321 0000013A B448                    	mov	ah, 48h
   322 0000013C CD21                    	int	21h
   323 0000013E 5B                      	pop	bx
   324 0000013F C3                      	retn
   325                                  
   326                                  ; CMDLINE.ASM
   327                                  ; parse the command line
   328                                  ; entry: none
   329                                  ; exit: DS:DX to the 1st supplied item on the command line 
   330                                  
   331                                  processCmdline:
   332 00000140 53                              push    bx
   333 00000141 56                              push    si
   334                                  
   335                                          ;mov    ah, 51h
   336                                          ;int    21h
   337                                          ;mov    ds, bx
   338                                  
   339 00000142 BE8000                          mov     si, 80h
   340 00000145 0FB61C                          movzx   bx, byte [si]
   341 00000148 01DE                            add     si, bx
   342 0000014A 46                              inc     si
   343                                  
   344 0000014B C60400                          mov     byte [si], NULL         ; zero terminate
   345                                  
   346 0000014E BE8100                          mov     si, 81h
   347                                  
   348                                  cmdlineloop:
   349 00000151 AC                              lodsb
   350                                  
   351 00000152 3C00                            cmp     al, NULL                ; found end of line?
   352 00000154 7404                            je      short exitpc
   353 00000156 3C20                            cmp     al, ' '                 ; found a space?
   354 00000158 74F7                            je      short cmdlineloop
   355                                  
   356                                          ; must be the filename here.
   357                                  exitpc:
   358 0000015A 4E                              dec     si                      ; point to start of filename
   359 0000015B 89F2                            mov     dx, si
   360 0000015D 5E                              pop     si
   361 0000015E 5B                              pop     bx
   362 0000015F C3                      	retn
   363                                  
   364                                  ; FILE.ASM
   365                                  ;open or create file
   366                                  ;
   367                                  ;input: ds:dx-->filename (asciiz)
   368                                  ;       al=file Mode (create or open)
   369                                  ;output: none  cs:[filehandle] filled
   370                                  ;
   371                                  openFile:
   372 00000160 50                      	push	ax
   373 00000161 51                      	push	cx
   374 00000162 B43B                    	mov	ah, 3bh			; start with a mode
   375 00000164 00C4                    	add	ah, al			; add in create or open mode
   376 00000166 31C9                    	xor	cx, cx
   377 00000168 CD21                    	int	21h
   378 0000016A 7203                    	jc	short _of1
   379                                  	;mov	[cs:filehandle], ax
   380 0000016C A3[021D]                	mov	[filehandle], ax
   381                                  _of1:
   382 0000016F 59                      	pop	cx
   383 00000170 58                      	pop	ax
   384 00000171 C3                      	retn
   385                                  
   386                                  ; close the currently open file
   387                                  ; input: none, uses cs:[filehandle]
   388                                  closeFile:
   389 00000172 50                      	push	ax
   390 00000173 53                      	push	bx
   391 00000174 833E[021D]FF            	cmp	word [filehandle], -1
   392 00000179 7409                    	jz	short _cf1
   393 0000017B 8B1E[021D]              	mov     bx, [filehandle]  
   394 0000017F B8003E                  	mov     ax,3e00h
   395 00000182 CD21                            int     21h              ;close file
   396                                  _cf1:
   397 00000184 5B                      	pop	bx
   398 00000185 58                      	pop	ax
   399 00000186 C3                      	retn
   400                                  
   401                                  getSampleRate:
   402                                  	; 08/12/2016
   403                                  ; reads the sample rate from the .wav file.
   404                                  ; entry: none - assumes file is already open
   405                                  	; 19/11/2016 - Erdogan Tan
   406                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   407                                  ;	cx = number of channels (mono=1, stereo=2)
   408                                  ;	dx = bits per sample (8, 16)
   409                                  
   410 00000187 53                      	push    bx
   411                                  
   412 00000188 B442                            mov     ah, 42h
   413 0000018A B000                            mov     al, 0				; from start of file
   414 0000018C 8B1E[021D]                      mov     bx, [filehandle]
   415 00000190 31C9                            xor     cx, cx
   416 00000192 BA0800                          mov     dx, 08h				; "WAVE"
   417 00000195 CD21                            int     21h
   418                                  
   419 00000197 BA[E61C]                        mov     dx, smpRBuff
   420 0000019A B91C00                          mov     cx, 28				; 28 bytes
   421 0000019D B43F                    	mov	ah, 3fh
   422 0000019F CD21                            int     21h
   423                                  
   424 000001A1 813E[E61C]5741          	cmp	word [smpRBuff], 'WA'
   425 000001A7 751C                    	jne	short gsr_stc
   426                                  
   427 000001A9 813E[E81C]5645          	cmp	word [smpRBuff+2], 'VE'
   428 000001AF 7514                    	jne	short gsr_stc
   429                                  
   430 000001B1 833E[F21C]01            	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   431 000001B6 750D                    	jne	short gsr_stc
   432                                  
   433                                  
   434 000001B8 8B0E[F41C]              	mov	cx, [smpRBuff+14]	; return num of channels in CX
   435 000001BC A1[F61C]                        mov     ax, [smpRBuff+16]	; return sample rate in AX
   436 000001BF 8B16[001D]              	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   437                                  gsr_retn:
   438 000001C3 5B                              pop     bx
   439 000001C4 C3                              retn
   440                                  
   441                                  gsr_stc:
   442 000001C5 F9                      	stc
   443 000001C6 EBFB                    	jmp	short gsr_retn
   444                                  
   445                                  ;%include 'ac97.asm' ; 29/11/2016 (AC97 codec configuration)
   446                                  %include 'ac97_vra.asm' ; 19/11/2023 (AC97 codec configuration)
     1                              <1> ; 19/11/2023 
     2                              <1> ;	(ready status optimization -in order to prevent wrong init error- )
     3                              <1> ; 18/11/2023
     4                              <1> ; 15/11/2023
     5                              <1> ; 13/11/2023
     6                              <1> ; 12/11/2023
     7                              <1> ; 11/11/2023
     8                              <1> ; 03/11/2023 - 06/11/2023
     9                              <1> ; PCI and AC97 codec functions for wav player
    10                              <1> ; Erdogan Tan (17/02/2017)
    11                              <1> 
    12                              <1> ; ----------------------------------------------------------------------------
    13                              <1> ; PCI.ASM
    14                              <1> ; ----------------------------------------------------------------------------
    15                              <1> 
    16                              <1> ; PCI device register reader/writers.
    17                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    18                              <1> ; 		Last Update: 17/02/2017
    19                              <1> 
    20                              <1> ;===============================================================
    21                              <1> ; 8/16/32bit PCI reader
    22                              <1> ;
    23                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    24                              <1> ;           BIT30 set if 32 bit access requested
    25                              <1> ;           BIT29 set if 16 bit access requested
    26                              <1> ;           otherwise defaults to 8 bit read
    27                              <1> ;
    28                              <1> ; Exit:  DL,DX,EDX register data depending on requested read size
    29                              <1> ;
    30                              <1> ; Note: this routine is meant to be called via pciRegRead8, pciRegread16,
    31                              <1> ;	or pciRegRead32, listed below.
    32                              <1> ;
    33                              <1> ; Note2: don't attempt to read 32bits of data from a non dword aligned reg
    34                              <1> ;	 number. Likewise, don't do 16bit reads from non word aligned reg #
    35                              <1> ; 
    36                              <1> pciRegRead:
    37 000001C8 6653                <1> 	push	ebx
    38 000001CA 51                  <1> 	push	cx
    39 000001CB 6689C3              <1>         mov     ebx, eax                        ; save eax, dh
    40 000001CE 88F1                <1>         mov     cl, dh
    41 000001D0 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    42 000001D6 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
    43 000001DC 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
    44                              <1> 
    45 000001DE BAF80C              <1>         mov     dx, PCI_INDEX_PORT
    46 000001E1 66EF                <1>         out     dx, eax                         ; write PCI selector
    47                              <1> 
    48 000001E3 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
    49 000001E6 88D8                <1>         mov     al, bl
    50 000001E8 2403                <1>         and     al, 3                           ; figure out which port to
    51 000001EA 00C2                <1>         add     dl, al                          ; read to
    52                              <1> 
    53 000001EC 66ED                <1> 	in      eax, dx                         ; do 32bit read
    54 000001EE 66F7C300000080      <1>         test    ebx, PCI32
    55 000001F5 7403                <1>         jz      short _pregr1
    56                              <1> 
    57 000001F7 6689C2              <1>         mov     edx, eax                        ; return 32bits of data
    58                              <1> _pregr1:
    59 000001FA 89C2                <1> 	mov     dx, ax                          ; return 16bits of data
    60 000001FC 66F7C3000000C0      <1>         test    ebx, PCI32+PCI16
    61 00000203 7502                <1>         jnz     short _pregr2
    62 00000205 88CE                <1>         mov     dh, cl                          ; restore dh for 8 bit read
    63                              <1> _pregr2:
    64 00000207 6689D8              <1>         mov     eax, ebx                        ; restore eax
    65 0000020A 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    66 00000210 59                  <1> 	pop	cx
    67 00000211 665B                <1> 	pop	ebx
    68 00000213 C3                  <1> 	retn
    69                              <1> 
    70                              <1> pciRegRead8:
    71 00000214 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32             ; set up 8 bit read size
    72 0000021A EBAC                <1>         jmp     short pciRegRead		; call generic PCI access
    73                              <1> 
    74                              <1> pciRegRead16:
    75 0000021C 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit read size
    76 00000222 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
    77 00000228 EB9E                <1>         jmp     short pciRegRead
    78                              <1> 
    79                              <1> pciRegRead32:
    80 0000022A 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit read size
    81 00000230 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
    82 00000236 EB90                <1>         jmp     short pciRegRead
    83                              <1> 
    84                              <1> ;===============================================================
    85                              <1> ; 8/16/32bit PCI writer
    86                              <1> ;
    87                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    88                              <1> ;           BIT31 set if 32 bit access requested
    89                              <1> ;           BIT30 set if 16 bit access requested
    90                              <1> ;           otherwise defaults to 8bit read
    91                              <1> ;        DL/DX/EDX data to write depending on size
    92                              <1> ;
    93                              <1> ;
    94                              <1> ; note: this routine is meant to be called via pciRegWrite8, pciRegWrite16,
    95                              <1> ; 	or pciRegWrite32 as detailed below.
    96                              <1> ;
    97                              <1> ; Note2: don't attempt to write 32bits of data from a non dword aligned reg
    98                              <1> ;	 number. Likewise, don't do 16bit writes from non word aligned reg #
    99                              <1> ;
   100                              <1> pciRegWrite:
   101 00000238 6653                <1> 	push	ebx
   102 0000023A 51                  <1> 	push	cx
   103 0000023B 6689C3              <1>         mov     ebx, eax                        ; save eax, dx
   104 0000023E 89D1                <1>         mov     cx, dx
   105 00000240 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
   106 00000246 6625FFFFFFBF        <1>         and     eax, ~PCI16 ; NOT PCI16         ; clear out data size request
   107 0000024C 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
   108                              <1> 
   109 0000024E BAF80C              <1>         mov     dx, PCI_INDEX_PORT
   110 00000251 66EF                <1>         out     dx, eax                         ; write PCI selector
   111                              <1> 
   112 00000253 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
   113 00000256 88D8                <1>         mov     al, bl
   114 00000258 2403                <1>         and     al, 3                           ; figure out which port to
   115 0000025A 00C2                <1>         add     dl, al                          ; write to
   116                              <1> 
   117 0000025C 6689D0              <1>         mov     eax, edx                        ; put data into eax
   118 0000025F 89C8                <1>         mov     ax, cx
   119                              <1> 
   120 00000261 EE                  <1>         out     dx, al
   121 00000262 66F7C3000000C0      <1>         test    ebx, PCI16+PCI32                ; only 8bit access? bail
   122 00000269 740C                <1>         jz      short _pregw1
   123                              <1> 
   124 0000026B EF                  <1>         out     dx, ax                          ; write 16 bit value
   125 0000026C 66F7C300000040      <1>         test    ebx, PCI16                      ; 16bit requested?  bail
   126 00000273 7502                <1>         jnz     short _pregw1
   127                              <1> 
   128 00000275 66EF                <1>         out     dx, eax                         ; write full 32bit
   129                              <1> _pregw1:
   130 00000277 6689D8              <1>         mov     eax, ebx                        ; restore eax
   131 0000027A 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
   132 00000280 89CA                <1>         mov     dx, cx                          ; restore dx
   133 00000282 59                  <1> 	pop	cx
   134 00000283 665B                <1> 	pop	ebx
   135 00000285 C3                  <1> 	ret
   136                              <1> 
   137                              <1> pciRegWrite8:
   138 00000286 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 8 bit write size
   139 0000028C EBAA                <1>         jmp     short pciRegWrite		; call generic PCI access
   140                              <1> 
   141                              <1> pciRegWrite16:
   142 0000028E 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit write size
   143 00000294 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
   144 0000029A EB9C                <1>         jmp     short pciRegWrite
   145                              <1> 
   146                              <1> pciRegWrite32:
   147 0000029C 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit write size
   148 000002A2 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
   149 000002A8 EB8E                <1>         jmp     short pciRegWrite
   150                              <1> 
   151                              <1> ; 17/02/2017 (Modifed by Erdogan Tan for various ICH device IDs)
   152                              <1> ;===============================================================
   153                              <1> ; PCIFindDevice: scan through PCI space looking for a device+vendor ID
   154                              <1> ;
   155                              <1> ;  ENTRY: none
   156                              <1> ;; Entry: EAX=Device+Vendor ID
   157                              <1> ;
   158                              <1> ;  Exit: EAX=PCI address if device found
   159                              <1> ;	 EDX=Device+Vendor ID
   160                              <1> ;        CY clear if found, set if not found. EAX invalid if CY set.
   161                              <1> ;
   162                              <1> ; [old stackless] Destroys: ebx, esi, edi, cl
   163                              <1> ;
   164                              <1> pciFindDevice:
   165                              <1> 	;push	cx
   166                              <1> 	;push	eax ; *
   167                              <1> 	;push	esi
   168                              <1> 	;push	edi
   169                              <1> 
   170                              <1>  	;mov     esi, eax                ; save off vend+device ID
   171                              <1> 
   172                              <1> 	; 17/02/2017
   173 000002AA BE[401B]            <1> 	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
   174 000002AD B91500              <1> 	mov	cx, valid_id_count
   175                              <1> pfd_0:
   176 000002B0 66BF00FFFF7F        <1>        	mov     edi, (80000000h - 100h) ; start with bus 0, dev 0 func 0
   177                              <1> nextPCIdevice:
   178 000002B6 6681C700010000      <1>         add     edi, 100h
   179 000002BD 6681FF00F8FF80      <1>         cmp     edi, 80FFF800h		; scanned all devices?
   180                              <1>         ;stc
   181                              <1>         ;je 	short PCIScanExit       ; not found
   182 000002C4 720D                <1> 	jb	short pfd_1
   183 000002C6 66BF00000080        <1> 	mov     edi, 80000000h
   184 000002CC 83C604              <1> 	add	si, 4 ; scan for next device ID
   185 000002CF E202                <1> 	loop	pfd_1	 
   186 000002D1 F9                  <1> 	stc	
   187                              <1> 	;jmp 	short PCIScanExit
   188 000002D2 C3                  <1> 	retn
   189                              <1> pfd_1:
   190 000002D3 6689F8              <1>         mov     eax, edi                ; read PCI registers
   191 000002D6 E851FF              <1>         call    pciRegRead32
   192                              <1>         ;cmp    edx, esi                ; found device?
   193 000002D9 663B14              <1>         cmp	edx, dword [si]
   194 000002DC 75D8                <1> 	jne     short nextPCIdevice
   195                              <1>         ;clc
   196                              <1> PCIScanExit:
   197                              <1> 	;pushf
   198 000002DE 66B800000080        <1> 	mov	eax, BIT31
   199 000002E4 66F7D0              <1> 	not	eax
   200 000002E7 6621F8              <1> 	and	eax, edi		; return only bus/dev/fn #
   201                              <1> 	;popf
   202                              <1> 
   203                              <1> 	;pop	edi
   204                              <1> 	;pop	esi
   205                              <1> 	;pop	edx ; *
   206                              <1> 	;pop	cx
   207 000002EA C3                  <1> 	retn
   208                              <1> 
   209                              <1> ; ----------------------------------------------------------------------------
   210                              <1> ; CODEC.ASM
   211                              <1> ; ----------------------------------------------------------------------------
   212                              <1> 
   213                              <1> ; codec configuration code. Not much here really.
   214                              <1> ; NASM version: Erdogan Tan (29/11/2016)
   215                              <1> 
   216                              <1> ; enable codec, unmute stuff, set output rate to 44.1
   217                              <1> ; entry: ax = desired sample rate
   218                              <1> 
   219                              <1> ; 19/11/2023
   220                              <1> ; 11/11/2023
   221                              <1> ; 06/11/2023
   222                              <1> %if 1
   223                              <1> 
   224                              <1> ;	; 11/11/2023
   225                              <1> ;init_ac97_codec_err1:
   226                              <1> ;	stc
   227                              <1> ;init_ac97_codec_err2:
   228                              <1> ;	retn
   229                              <1> 
   230                              <1> 	; 13/11/2023
   231 000002EB 01                  <1> VRA:	db 1	
   232                              <1> 
   233                              <1> codecConfig:
   234                              <1> 	; 19/11/2023
   235                              <1> 	; 15/11/2023
   236                              <1> 	; 04/11/2023
   237                              <1> 	; 17/02/2017 
   238                              <1> 	; 07/11/2016 (Erdogan Tan)
   239                              <1> 	;PORT_NABM_GLB_CTRL_STAT equ 60h
   240                              <1> 
   241                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   242                              <1>  	; 'AC97_DEF.H'
   243                              <1> 	;AC97_EXTENDED_STATUS equ 002Ah
   244                              <1> 	AC97_EA_SPDIF	equ 0002h
   245                              <1> 	AC97_EA_VRA	equ 0001h
   246                              <1> 	; 04/11/2023
   247                              <1> 	ICH_PO_CR_RESET equ 0002h  ; reset codec
   248                              <1> 	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
   249                              <1> 	ICH_PCM_246_MASK equ 300000h ; 6 channels
   250                              <1> 
   251                              <1> 	; 04/11/2023
   252                              <1> init_ac97_controller:
   253 000002EC 66A1[101D]          <1> 	mov	eax, [bus_dev_fn]
   254 000002F0 B004                <1> 	mov	al, PCI_CMD_REG
   255 000002F2 E827FF              <1> 	call	pciRegRead16		; read PCI command register
   256 000002F5 80CA05              <1> 	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
   257 000002F8 E893FF              <1> 	call	pciRegWrite16
   258                              <1> 
   259 000002FB E87701              <1> 	call	delay_100ms
   260                              <1> 
   261                              <1> init_ac97_codec:
   262                              <1> 	; 18/11/2023
   263 000002FE BD2800              <1> 	mov	bp, 40
   264                              <1> _initc_1:
   265                              <1> 	; 11/11/2023
   266                              <1> 	; (TRDOS 386 v2.0.5, 'audio.s')
   267 00000301 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   268 00000304 0316[081D]          <1> 	add	dx, [NABMBAR]
   269 00000308 66ED                <1> 	in	eax, dx
   270                              <1> 	; ?
   271                              <1> 	;; 15/11/2023
   272                              <1> 	;;mov	cx, 40
   273                              <1> 	;mov	bp, 40 ; 18/11/2023
   274                              <1> ;_initc_1:
   275 0000030A BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   276 0000030D 0316[081D]          <1> 	add	dx, [NABMBAR]
   277 00000311 66ED                <1> 	in	eax, dx
   278                              <1> 
   279 00000313 6683F8FF            <1> 	cmp	eax, 0FFFFFFFFh ; -1
   280                              <1> 	;je	short init_ac97_codec_err1
   281                              <1> 	; 15/11/2023
   282 00000317 7508                <1> 	jne	short _initc_3
   283                              <1> _initc_2:
   284                              <1> 	;dec	cx
   285 00000319 4D                  <1> 	dec	bp	; 18/11/2023
   286                              <1> 	;jz	short init_ac97_codec_err1
   287                              <1> 	; 19/11/2023
   288 0000031A 7412                <1> 	jz	short _ac97_codec_ready
   289                              <1> 
   290 0000031C E85601              <1> 	call	delay_100ms
   291 0000031F EBE0                <1> 	jmp	short _initc_1
   292                              <1> _initc_3:
   293 00000321 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   294 00000327 7505                <1> 	jnz	short _ac97_codec_ready
   295                              <1> 
   296 00000329 E8C900              <1> 	call	reset_ac97_codec
   297                              <1> 	; 11/11/2023
   298                              <1> 	;jc	short init_ac97_codec_err2
   299                              <1> 	; 15/11/2023
   300 0000032C 72EB                <1> 	jc	short _initc_2
   301                              <1> 
   302                              <1> _ac97_codec_ready:
   303 0000032E 8B16[061D]          <1> 	mov	dx, [NAMBAR]
   304                              <1> 	;add	dx, 0 ; ac_reg_0 ; reset register
   305 00000332 EF                  <1> 	out	dx, ax
   306                              <1> 
   307 00000333 E83F01              <1> 	call	delay_100ms
   308                              <1> 
   309                              <1> 	; 19/11/2023
   310 00000336 09ED                <1> 	or	bp, bp
   311 00000338 751D                <1> 	jnz	short _ac97_codec_init_ok
   312                              <1> 
   313 0000033A 6631C0              <1> 	xor	eax, eax ; 0
   314 0000033D 8B16[061D]          <1> 	mov	dx, [NAMBAR]
   315 00000341 83C226              <1> 	add	dx, CODEC_REG_POWERDOWN
   316 00000344 EF                  <1> 	out	dx, ax
   317                              <1> 	
   318                              <1> 	; 19/11/2023
   319                              <1> 	; wait for 1 second
   320                              <1> 	;mov	ecx, 1000 ; 1000*4*0.25ms = 1s
   321 00000345 B90A00              <1> 	mov	cx, 10
   322                              <1> _ac97_codec_rloop:
   323                              <1> 	;call	delay1_4ms
   324                              <1> 	;call	delay1_4ms
   325                              <1> 	;call	delay1_4ms
   326                              <1> 	;call	delay1_4ms
   327 00000348 E82A01              <1> 	call	delay_100ms
   328                              <1> 	;mov	dx, [NAMBAR]
   329                              <1> 	;add	dx, CODEC_REG_POWERDOWN
   330 0000034B ED                  <1> 	in	ax, dx	
   331 0000034C 83E00F              <1> 	and	ax, 0Fh
   332 0000034F 3C0F                <1> 	cmp	al, 0Fh
   333 00000351 7404                <1> 	je	short _ac97_codec_init_ok
   334 00000353 E2F3                <1> 	loop	_ac97_codec_rloop 
   335                              <1> 
   336                              <1> init_ac97_codec_err1:
   337 00000355 F9                  <1> 	stc
   338                              <1> init_ac97_codec_err2:
   339 00000356 C3                  <1> 	retn
   340                              <1> 
   341                              <1> _ac97_codec_init_ok:
   342                              <1>         ; 11/11/2023
   343                              <1> 	;mov	al, 2 ; force set 16-bit 2-channel PCM
   344                              <1> 	;mov	dx, GLOB_CNT_REG ; 2Ch
   345                              <1> 	;add	dx, [NABMBAR]
   346                              <1> 	;out	dx, eax
   347                              <1> 
   348                              <1> 	;;call	delay1_4ms
   349                              <1> 
   350 00000357 E86600              <1> 	call 	reset_ac97_controller
   351                              <1> 
   352                              <1> 	; 11/11/2023
   353 0000035A E8BA15              <1> 	call	delay1_4ms
   354                              <1> 
   355                              <1> 	;call 	setup_ac97_codec
   356                              <1> 
   357                              <1> setup_ac97_codec:
   358                              <1> 	; 12/11/2023
   359 0000035D 813E[181D]80BB      <1> 	cmp	word [sample_rate], 48000
   360 00000363 742F                <1> 	je	short skip_rate
   361                              <1> 
   362                              <1> ; 11/11/2023
   363                              <1> ; 05/11/2023
   364                              <1> ;%if 1
   365                              <1> 	AC97_EA_VRA equ BIT0 ; 11/11/2023
   366                              <1> 
   367                              <1> 	; 11/11/2023
   368 00000365 8B16[061D]          <1> 	mov    	dx, [NAMBAR]               	
   369 00000369 83C22A              <1> 	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah  	  
   370 0000036C ED                  <1> 	in     	ax, dx
   371 0000036D 24FD                <1> 	and	al, ~BIT1 ; Clear DRA
   372 0000036F 0C01                <1> 	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
   373 00000371 EF                  <1> 	out	dx, ax			; Enable variable rate audio
   374                              <1> 	
   375 00000372 B90A00              <1> 	mov	cx, 10
   376                              <1> check_vra:
   377 00000375 E8FD00              <1> 	call	delay_100ms
   378                              <1> 
   379                              <1> 	; 11/11/2023
   380 00000378 ED                  <1> 	in	ax, dx
   381 00000379 A801                <1> 	test	al, AC97_EA_VRA ; 1
   382 0000037B 7509                <1> 	jnz	short set_rate
   383                              <1> 
   384                              <1> 	; 11/11/2023
   385 0000037D E2F6                <1> 	loop	check_vra
   386                              <1> 
   387                              <1> 	; 13/11/2023
   388 0000037F C606[EB02]00        <1> 	mov	byte [VRA], 0
   389 00000384 EB0E                <1> 	jmp	short skip_rate	
   390                              <1> 
   391                              <1> 	; 12/11/2023
   392                              <1> 	;pop	ax ; discard return address to the caller
   393                              <1> 	;mov	dx, msg_no_vra
   394                              <1> 	;jmp	vra_err
   395                              <1> 
   396                              <1> set_rate:
   397 00000386 A1[181D]            <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   398                              <1> 
   399 00000389 8B16[061D]          <1> 	mov    	dx, [NAMBAR]               	
   400 0000038D 83C22C              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   401 00000390 EF                  <1> 	out	dx, ax 			; PCM Front/Center Output Sample Rate
   402                              <1> 
   403 00000391 E8E100              <1> 	call	delay_100ms
   404                              <1> 
   405                              <1> 	; 12/11/2023
   406                              <1> skip_rate:
   407                              <1> 	; 11/11/2023 (temporary)
   408                              <1> 
   409                              <1> 	;mov   	dx, [NAMBAR]               	
   410                              <1> 	;add   	dx, CODEC_PCM_SURND_DACRATE_REG	; 2Eh  	  
   411                              <1> 	;out	dx, ax 			; PCM Surround Output Sample Rate
   412                              <1> 
   413                              <1> 	;call	delay_100ms
   414                              <1> 
   415                              <1> 	;mov   	dx, [NAMBAR]               	
   416                              <1> 	;add   	dx, CODEC_PCM_LFE_DACRATE_REG	; 30h  	  
   417                              <1> 	;out	dx, ax 			; PCM LFE Output Sample Rate
   418                              <1> 
   419                              <1> 	;call	delay_100ms
   420                              <1> 
   421                              <1> 	; 05/11/2023 (temporary)
   422                              <1> 	;mov	dx, [NAMBAR]               	
   423                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   424                              <1> 	;out	dx, ax 			; PCM Input Sample Rate
   425                              <1> 	;
   426                              <1> 	;call	delay_100ms
   427                              <1> 
   428 00000394 B80202              <1> 	mov	ax, 0202h
   429 00000397 8B16[061D]          <1>   	mov     dx, [NAMBAR]
   430 0000039B 83C202              <1>   	add     dx, CODEC_MASTER_VOL_REG	;02h 
   431 0000039E EF                  <1> 	out     dx, ax
   432                              <1> 
   433                              <1> 	; 11/11/2023
   434                              <1>         ;call	delay1_4ms
   435                              <1>         ;call	delay1_4ms
   436                              <1>         ;call	delay1_4ms
   437                              <1>         ;call	delay1_4ms
   438                              <1>  	;
   439                              <1>   	;mov	dx, [NAMBAR]
   440                              <1>   	;add	dx, CODEC_MASTER_MONO_VOL_REG	;06h 
   441                              <1>   	;out	dx, ax
   442                              <1> 
   443                              <1> 	; 11/11/2023
   444                              <1>         ;call	delay1_4ms
   445                              <1>         ;call	delay1_4ms
   446                              <1>         ;call	delay1_4ms
   447                              <1>         ;call	delay1_4ms
   448                              <1> 	;
   449                              <1> 	;mov	ax, 02h
   450                              <1>   	;mov	dx, [NAMBAR]
   451                              <1>   	;add	dx, CODEC_PCBEEP_VOL_REG	;0Ah 
   452                              <1>   	;out	dx, ax
   453                              <1> 
   454 0000039F E87515              <1>         call    delay1_4ms
   455 000003A2 E87215              <1>         call    delay1_4ms
   456 000003A5 E86F15              <1>         call    delay1_4ms
   457 000003A8 E86C15              <1>         call    delay1_4ms
   458                              <1> 
   459                              <1> 	;mov	ax, 0202h
   460 000003AB 8B16[061D]          <1>   	mov     dx, [NAMBAR]
   461 000003AF 83C218              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h 
   462 000003B2 EF                  <1>   	out     dx, ax
   463                              <1> 
   464 000003B3 E86115              <1>         call    delay1_4ms
   465 000003B6 E85E15              <1>         call    delay1_4ms
   466 000003B9 E85B15              <1>         call    delay1_4ms
   467 000003BC E85815              <1>         call    delay1_4ms
   468                              <1> 
   469                              <1> 	; 11/11/2023
   470                              <1> 	;mov	ax, 8008h ; Mute
   471                              <1>   	;mov	dx, [NAMBAR]
   472                              <1> 	;add	dx, CODEC_PHONE_VOL_REG		;0Ch
   473                              <1> 	;			 ; AC97_PHONE_VOL ; TAD Input (Mono)
   474                              <1>   	;out	dx, ax
   475                              <1> 	;
   476                              <1>         ;call	delay1_4ms
   477                              <1>         ;call	delay1_4ms
   478                              <1>         ;call	delay1_4ms
   479                              <1> 	;call	delay1_4ms
   480                              <1> 
   481                              <1> 	;mov	ax, 0808h
   482                              <1> 	;mov	dx, [NAMBAR]
   483                              <1> 	;add	dx, CODEC_LINE_IN_VOL_REG ;10h ; Line Input (Stereo)
   484                              <1> 	;out	dx, ax
   485                              <1> 	;
   486                              <1>         ;call	delay1_4ms
   487                              <1>         ;call	delay1_4ms
   488                              <1>         ;call	delay1_4ms
   489                              <1> 	;call	delay1_4ms
   490                              <1> 
   491                              <1>   	;mov	dx, [NAMBAR]
   492                              <1>         ;add	dx, CODEC_CD_VOL_REG ;12h ; CD Input (Stereo)
   493                              <1>   	;out	dx, ax
   494                              <1> 	;
   495                              <1>   	;mov	dx, [NAMBAR]
   496                              <1>         ;add	dx, CODEC_AUX_VOL_REG ;16h ; Aux Input (Stereo)
   497                              <1>   	;out	dx, ax
   498                              <1> 	;
   499                              <1>         ;call	delay1_4ms
   500                              <1>         ;call	delay1_4ms
   501                              <1>         ;call	delay1_4ms
   502                              <1> 	;call	delay1_4ms
   503                              <1> 
   504                              <1> ;detect_ac97_codec:
   505 000003BF C3                  <1>         retn
   506                              <1> 
   507                              <1> reset_ac97_controller:
   508                              <1> 	; 11/11/2023
   509                              <1> 	; 10/06/2017
   510                              <1> 	; 29/05/2017
   511                              <1> 	; 28/05/2017
   512                              <1> 	; reset AC97 audio controller registers
   513 000003C0 31C0                <1> 	xor     ax, ax
   514 000003C2 BA0B00              <1>         mov	dx, PI_CR_REG
   515 000003C5 0316[081D]          <1> 	add	dx, [NABMBAR]
   516 000003C9 EE                  <1> 	out     dx, al
   517                              <1> 
   518 000003CA BA1B00              <1>         mov     dx, PO_CR_REG
   519 000003CD 0316[081D]          <1> 	add	dx, [NABMBAR]
   520 000003D1 EE                  <1> 	out     dx, al
   521                              <1> 
   522 000003D2 BA2B00              <1>         mov     dx, MC_CR_REG
   523 000003D5 0316[081D]          <1> 	add	dx, [NABMBAR]
   524 000003D9 EE                  <1> 	out     dx, al
   525                              <1> 
   526 000003DA B002                <1>         mov     al, RR
   527 000003DC BA0B00              <1>         mov     dx, PI_CR_REG
   528 000003DF 0316[081D]          <1> 	add	dx, [NABMBAR]
   529 000003E3 EE                  <1> 	out     dx, al
   530                              <1> 
   531 000003E4 BA1B00              <1>         mov     dx, PO_CR_REG
   532 000003E7 0316[081D]          <1> 	add	dx, [NABMBAR]
   533 000003EB EE                  <1> 	out     dx, al
   534                              <1> 
   535 000003EC BA2B00              <1>         mov     dx, MC_CR_REG
   536 000003EF 0316[081D]          <1> 	add	dx, [NABMBAR]
   537 000003F3 EE                  <1> 	out     dx, al
   538                              <1> 
   539 000003F4 C3                  <1> 	retn
   540                              <1> 
   541                              <1> reset_ac97_codec:
   542                              <1> 	; 11/11/2023
   543                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   544 000003F5 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   545 000003F8 0316[081D]          <1> 	add	dx, [NABMBAR]
   546 000003FC 66ED                <1> 	in	eax, dx
   547                              <1> 
   548                              <1> 	;test	eax, 2
   549                              <1> 	; 06/08/2022
   550 000003FE A802                <1> 	test	al, 2
   551 00000400 7405                <1> 	jz	short _r_ac97codec_cold	
   552                              <1> 
   553 00000402 E80E00              <1> 	call	warm_ac97codec_reset
   554 00000405 7306                <1> 	jnc	short _r_ac97codec_ok
   555                              <1> _r_ac97codec_cold:
   556 00000407 E83400              <1>         call    cold_ac97codec_reset
   557 0000040A 7301                <1>         jnc     short _r_ac97codec_ok
   558                              <1> 	
   559                              <1> 	; 16/04/2017
   560                              <1>         ;xor	eax, eax	; timeout error
   561                              <1>        	;stc
   562 0000040C C3                  <1> 	retn
   563                              <1> 
   564                              <1> _r_ac97codec_ok:
   565 0000040D 6631C0              <1>         xor     eax, eax
   566                              <1>         ;mov	al, VIA_ACLINK_C00_READY ; 1
   567 00000410 FEC0                <1>         inc	al
   568 00000412 C3                  <1> 	retn
   569                              <1> 
   570                              <1> warm_ac97codec_reset:
   571                              <1> 	; 11/11/2023
   572                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   573                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   574 00000413 66B806000000        <1> 	mov	eax, 6
   575 00000419 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   576 0000041C 0316[081D]          <1> 	add	dx, [NABMBAR]
   577 00000420 66EF                <1> 	out	dx, eax
   578                              <1> 
   579 00000422 B90A00              <1> 	mov	cx, 10	; total 1s
   580                              <1> _warm_ac97c_rst_wait:
   581 00000425 E84D00              <1> 	call	delay_100ms
   582                              <1> 
   583 00000428 BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   584 0000042B 0316[081D]          <1> 	add	dx, [NABMBAR]
   585 0000042F 66ED                <1> 	in	eax, dx
   586                              <1> 
   587 00000431 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   588 00000437 7504                <1> 	jnz	short _warm_ac97c_rst_ok
   589                              <1> 
   590 00000439 49                  <1>         dec     cx
   591 0000043A 75E9                <1>         jnz     short _warm_ac97c_rst_wait
   592                              <1> 
   593                              <1> _warm_ac97c_rst_fail:
   594 0000043C F9                  <1>         stc
   595                              <1> _warm_ac97c_rst_ok:
   596 0000043D C3                  <1> 	retn
   597                              <1> 
   598                              <1> cold_ac97codec_reset:
   599                              <1> 	; 11/11/2023
   600                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   601                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   602 0000043E 66B802000000        <1>         mov	eax, 2
   603 00000444 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   604 00000447 0316[081D]          <1> 	add	dx, [NABMBAR]
   605 0000044B 66EF                <1> 	out	dx, eax
   606                              <1> 
   607 0000044D E82500              <1> 	call	delay_100ms 	; wait 100 ms
   608 00000450 E82200              <1> 	call	delay_100ms 	; wait 100 ms
   609 00000453 E81F00              <1> 	call	delay_100ms 	; wait 100 ms
   610 00000456 E81C00              <1> 	call	delay_100ms 	; wait 100 ms
   611                              <1> 
   612 00000459 B91000              <1> 	mov	cx, 16	; total 20*100 ms = 2s
   613                              <1> 
   614                              <1> _cold_ac97c_rst_wait:
   615 0000045C BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   616 0000045F 0316[081D]          <1> 	add	dx, [NABMBAR]
   617 00000463 66ED                <1> 	in	eax, dx
   618                              <1> 
   619 00000465 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   620 0000046B 7507                <1> 	jnz	short _cold_ac97c_rst_ok
   621                              <1> 
   622 0000046D E80500              <1> 	call	delay_100ms
   623                              <1> 
   624 00000470 49                  <1>         dec     cx
   625 00000471 75E9                <1>         jnz     short _cold_ac97c_rst_wait
   626                              <1> 
   627                              <1> _cold_ac97c_rst_fail:
   628 00000473 F9                  <1>         stc
   629                              <1> _cold_ac97c_rst_ok:
   630 00000474 C3                  <1> 	retn
   631                              <1> 
   632                              <1> delay_100ms:
   633                              <1> 	; 11/11/2023
   634                              <1> 	; 29/05/2017
   635                              <1> 	; 24/03/2017 ('codec.asm')
   636                              <1> 	; wait 100 ms
   637 00000475 51                  <1> 	push	cx
   638 00000476 B99001              <1> 	mov	cx, 400  ; 400*0.25ms
   639                              <1> _delay_x_ms:
   640 00000479 E89B14              <1> 	call	delay1_4ms
   641 0000047C E2FB                <1>         loop	_delay_x_ms
   642 0000047E 59                  <1> 	pop	cx
   643 0000047F C3                  <1> 	retn
   644                              <1> 
   645                              <1> %endif
   646                              <1> 
   647                              <1> ; 11/11/2023
   648                              <1> %if 0
   649                              <1> 
   650                              <1> codecConfig:
   651                              <1> 	; 06/11/2023
   652                              <1> 	; TUNELOOP version (playing without interrupt)
   653                              <1> 	; 04/11/2023
   654                              <1> 	; 17/02/2017 
   655                              <1> 	; 07/11/2016 (Erdogan Tan)
   656                              <1> 
   657                              <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   658                              <1> 
   659                              <1> 	mov    	dx, [NAMBAR]               	
   660                              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   661                              <1> 	out	dx, ax 				; out sample rate
   662                              <1> 		
   663                              <1> 	; 05/11/2023 temp
   664                              <1> 	;mov	dx, [NAMBAR]               	
   665                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   666                              <1> 	;out	dx, ax 
   667                              <1> 
   668                              <1>         call    delay1_4ms
   669                              <1>         call    delay1_4ms
   670                              <1>         call    delay1_4ms
   671                              <1>         call    delay1_4ms
   672                              <1> 
   673                              <1> 	mov	eax, [dev_vendor]
   674                              <1>         cmp	eax, (SI7012_DID<<16)+SIS_VID
   675                              <1>         jne	short cConfig1
   676                              <1> 
   677                              <1> 	; Unmute quirk specifically for the SiS7012
   678                              <1> 
   679                              <1> 	CUSTOM_SIS_7012_REG equ 4Ch ; SiS7012-specific register
   680                              <1> 	
   681                              <1>         mov     dx, [NABMBAR]
   682                              <1>         add     dx, CUSTOM_SIS_7012_REG
   683                              <1>         in      ax, dx
   684                              <1>         or	al, 1
   685                              <1>         out     dx, ax
   686                              <1> 
   687                              <1> cConfig1:
   688                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   689                              <1> 	; initial ac97 volumes (and clear mute flag)
   690                              <1> 		
   691                              <1>   	mov     dx, [NAMBAR]
   692                              <1>   	add     dx, CODEC_MASTER_VOL_REG        ;02h ; STEREO
   693                              <1>   	;xor	ax, ax ; volume attenuation = 0 (max. volume)
   694                              <1>   	; 03/11/2023
   695                              <1> 	mov	ax, 0202h
   696                              <1> 	out     dx, ax
   697                              <1> 
   698                              <1>         call    delay1_4ms	; delays because codecs are slow
   699                              <1>         call    delay1_4ms
   700                              <1>         call    delay1_4ms
   701                              <1>         call    delay1_4ms
   702                              <1>  
   703                              <1>   	mov     dx, [NAMBAR]
   704                              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h
   705                              <1>   	;;xor	ax, ax
   706                              <1> 	;mov	ax, 0202h
   707                              <1>   	out     dx, ax
   708                              <1> 
   709                              <1>         call    delay1_4ms
   710                              <1>         call    delay1_4ms
   711                              <1>         call    delay1_4ms
   712                              <1>         call    delay1_4ms
   713                              <1>  
   714                              <1> 	retn
   715                              <1> 
   716                              <1> %endif
   447                                  ;%include 'ich_wav.asm' ; 17/02/2017 (ICH AC97 wav playing functions)
   448                                  %include 'ich_wav4.asm' ; 18/11/2023 (ICH AC97 wav playing functions)
     1                              <1> ; 18/11/2023
     2                              <1> ; 17/11/2023
     3                              <1> ; 16/11/2023
     4                              <1> ; 15/11/2023
     5                              <1> ; 14/11/2023
     6                              <1> ; 13/11/2023
     7                              <1> ; 03/11/2023 - 11/11/2023
     8                              <1> ; DOS based .WAV player using AC'97 and codec interface.
     9                              <1> ; ---------------------------------------------------------------
    10                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    11                              <1> ; Last Update: 17/02/2017 (by Erdogan Tan)
    12                              <1> 
    13                              <1> ; TUNELOOP version (playing without interrupt) - 06/11/2023 - Erdogan Tan
    14                              <1> ; sample rate conversion version - 18/11/2023 - Erdogan Tan
    15                              <1> 
    16                              <1> ; ICHWAV.ASM
    17                              <1> 
    18                              <1> ; player internal variables and other equates.
    19                              <1> BUFFERSIZE      equ     64 * 1024       ; 64k file buffer size.
    20                              <1> ENDOFFILE       equ     BIT0            ; flag for knowing end of file
    21                              <1> 
    22                              <1> ;===========================================================================
    23                              <1> ; entry: none. File is already open and [filehandle] filled.
    24                              <1> ; exit:  not until the song is finished or the user aborts.
    25                              <1> ;
    26                              <1> playWav:
    27                              <1> 	; 18/11/2023 (ich_wav4.asm)
    28                              <1> 	; 13/11/2023 (ich_wav3.asm)
    29                              <1> 
    30 00000480 803E[EB02]01        <1> 	cmp	byte [VRA], 1
    31 00000485 720F                <1> 	jb	short chk_sample_rate
    32                              <1> playwav_48_khz:	
    33 00000487 C706[3606][0407]    <1> 	mov	word [loadfromwavfile], loadFromFile
    34                              <1> 	;mov	word [loadsize], 0 ; 65536
    35 0000048D C706[3A06]0080      <1> 	mov	word [buffersize], 32768 ; samples
    36 00000493 E9A801              <1> 	jmp	playWav_vra
    37                              <1> 
    38                              <1> chk_sample_rate:
    39                              <1> 	; set conversion parameters
    40                              <1> 	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
    41 00000496 A1[181D]            <1> 	mov	ax, [sample_rate]
    42 00000499 3D80BB              <1> 	cmp	ax, 48000
    43 0000049C 74E9                <1> 	je	short playwav_48_khz
    44                              <1> chk_22khz:
    45 0000049E 3D2256              <1> 	cmp	ax, 22050
    46 000004A1 752F                <1> 	jne	short chk_11khz
    47 000004A3 803E[1C1D]08        <1> 	cmp	byte [bps], 8
    48 000004A8 760F                <1> 	jna	short chk_22khz_1
    49 000004AA BB[3A11]            <1> 	mov	bx, load_22khz_stereo_16_bit
    50 000004AD 803E[1A1D]01        <1> 	cmp	byte [stmo], 1 
    51 000004B2 7512                <1> 	jne	short chk_22khz_2
    52 000004B4 BB[D110]            <1> 	mov	bx, load_22khz_mono_16_bit
    53 000004B7 EB0D                <1> 	jmp	short chk_22khz_2
    54                              <1> chk_22khz_1:
    55 000004B9 BB[6C10]            <1> 	mov	bx, load_22khz_stereo_8_bit
    56 000004BC 803E[1A1D]01        <1> 	cmp	byte [stmo], 1 
    57 000004C1 7503                <1> 	jne	short chk_22khz_2
    58 000004C3 BB[0310]            <1> 	mov	bx, load_22khz_mono_8_bit
    59                              <1> chk_22khz_2:
    60 000004C6 B85A1D              <1> 	mov	ax, 7514  ; (442*17)
    61 000004C9 BA2500              <1> 	mov	dx, 37
    62 000004CC B91100              <1> 	mov	cx, 17 
    63 000004CF E93301              <1> 	jmp	set_sizes	
    64                              <1> chk_11khz:
    65 000004D2 3D112B              <1> 	cmp	ax, 11025
    66 000004D5 752F                <1> 	jne	short chk_44khz
    67 000004D7 803E[1C1D]08        <1> 	cmp	byte [bps], 8
    68 000004DC 760F                <1> 	jna	short chk_11khz_1
    69 000004DE BB[CE12]            <1> 	mov	bx, load_11khz_stereo_16_bit
    70 000004E1 803E[1A1D]01        <1> 	cmp	byte [stmo], 1 
    71 000004E6 7512                <1> 	jne	short chk_11khz_2
    72 000004E8 BB[7312]            <1> 	mov	bx, load_11khz_mono_16_bit
    73 000004EB EB0D                <1> 	jmp	short chk_11khz_2
    74                              <1> chk_11khz_1:
    75 000004ED BB[1812]            <1> 	mov	bx, load_11khz_stereo_8_bit
    76 000004F0 803E[1A1D]01        <1> 	cmp	byte [stmo], 1 
    77 000004F5 7503                <1> 	jne	short chk_11khz_2
    78 000004F7 BB[BA11]            <1> 	mov	bx, load_11khz_mono_8_bit
    79                              <1> chk_11khz_2:
    80 000004FA B8AD0E              <1> 	mov	ax, 3757  ; (221*17)
    81 000004FD BA4A00              <1> 	mov	dx, 74
    82 00000500 B91100              <1> 	mov	cx, 17
    83 00000503 E9FF00              <1> 	jmp	set_sizes 
    84                              <1> chk_44khz:
    85 00000506 3D44AC              <1> 	cmp	ax, 44100
    86 00000509 752F                <1> 	jne	short chk_16khz
    87 0000050B 803E[1C1D]08        <1> 	cmp	byte [bps], 8
    88 00000510 760F                <1> 	jna	short chk_44khz_1
    89 00000512 BB[7F14]            <1> 	mov	bx, load_44khz_stereo_16_bit
    90 00000515 803E[1A1D]01        <1> 	cmp	byte [stmo], 1 
    91 0000051A 7512                <1> 	jne	short chk_44khz_2
    92 0000051C BB[2714]            <1> 	mov	bx, load_44khz_mono_16_bit
    93 0000051F EB0D                <1> 	jmp	short chk_44khz_2
    94                              <1> chk_44khz_1:
    95 00000521 BB[C913]            <1> 	mov	bx, load_44khz_stereo_8_bit
    96 00000524 803E[1A1D]01        <1> 	cmp	byte [stmo], 1 
    97 00000529 7503                <1> 	jne	short chk_44khz_2
    98 0000052B BB[6C13]            <1> 	mov	bx, load_44khz_mono_8_bit
    99                              <1> chk_44khz_2:
   100                              <1> 	;mov	ax, 15065 ; (655*23)
   101                              <1> 	; 18/11/2023 ((file size + bss + stack) <= 64KB)
   102 0000052E B8FC36              <1> 	mov	ax, 14076 ; (612 *23)
   103 00000531 BA1900              <1> 	mov	dx, 25
   104 00000534 B91700              <1> 	mov	cx, 23
   105 00000537 E9CB00              <1> 	jmp	set_sizes 
   106                              <1> chk_16khz:
   107 0000053A 3D803E              <1> 	cmp	ax, 16000
   108 0000053D 752F                <1> 	jne	short chk_8khz
   109 0000053F 803E[1C1D]08        <1> 	cmp	byte [bps], 8
   110 00000544 760F                <1> 	jna	short chk_16khz_1
   111 00000546 BB[810C]            <1> 	mov	bx, load_16khz_stereo_16_bit
   112 00000549 803E[1A1D]01        <1> 	cmp	byte [stmo], 1 
   113 0000054E 7512                <1> 	jne	short chk_16khz_2
   114 00000550 BB[200C]            <1> 	mov	bx, load_16khz_mono_16_bit
   115 00000553 EB0D                <1> 	jmp	short chk_16khz_2
   116                              <1> chk_16khz_1:
   117 00000555 BB[900B]            <1> 	mov	bx, load_16khz_stereo_8_bit
   118 00000558 803E[1A1D]01        <1> 	cmp	byte [stmo], 1 
   119 0000055D 7503                <1> 	jne	short chk_16khz_2
   120 0000055F BB[2C0B]            <1> 	mov	bx, load_16khz_mono_8_bit
   121                              <1> chk_16khz_2:
   122 00000562 B85515              <1> 	mov	ax, 5461
   123 00000565 BA0300              <1> 	mov	dx, 3
   124 00000568 B90100              <1> 	mov	cx, 1
   125 0000056B E99700              <1> 	jmp	set_sizes 
   126                              <1> chk_8khz:
   127 0000056E 3D401F              <1> 	cmp	ax, 8000
   128 00000571 752E                <1> 	jne	short chk_24khz
   129 00000573 803E[1C1D]08        <1> 	cmp	byte [bps], 8
   130 00000578 760F                <1> 	jna	short chk_8khz_1
   131 0000057A BB[450A]            <1> 	mov	bx, load_8khz_stereo_16_bit
   132 0000057D 803E[1A1D]01        <1> 	cmp	byte [stmo], 1 
   133 00000582 7512                <1> 	jne	short chk_8khz_2
   134 00000584 BB[B409]            <1> 	mov	bx, load_8khz_mono_16_bit
   135 00000587 EB0D                <1> 	jmp	short chk_8khz_2
   136                              <1> chk_8khz_1:
   137 00000589 BB[C408]            <1> 	mov	bx, load_8khz_stereo_8_bit
   138 0000058C 803E[1A1D]01        <1> 	cmp	byte [stmo], 1 
   139 00000591 7503                <1> 	jne	short chk_8khz_2
   140 00000593 BB[1108]            <1> 	mov	bx, load_8khz_mono_8_bit
   141                              <1> chk_8khz_2:
   142 00000596 B8AA0A              <1> 	mov	ax, 2730
   143 00000599 BA0600              <1> 	mov	dx, 6
   144 0000059C B90100              <1> 	mov	cx, 1
   145 0000059F EB64                <1> 	jmp	short set_sizes 
   146                              <1> chk_24khz:
   147 000005A1 3DC05D              <1> 	cmp	ax, 24000
   148 000005A4 752E                <1> 	jne	short chk_32khz
   149 000005A6 803E[1C1D]08        <1> 	cmp	byte [bps], 8
   150 000005AB 760F                <1> 	jna	short chk_24khz_1
   151 000005AD BB[160E]            <1> 	mov	bx, load_24khz_stereo_16_bit
   152 000005B0 803E[1A1D]01        <1> 	cmp	byte [stmo], 1 
   153 000005B5 7512                <1> 	jne	short chk_24khz_2
   154 000005B7 BB[CD0D]            <1> 	mov	bx, load_24khz_mono_16_bit
   155 000005BA EB0D                <1> 	jmp	short chk_24khz_2
   156                              <1> chk_24khz_1:
   157 000005BC BB[650D]            <1> 	mov	bx, load_24khz_stereo_8_bit
   158 000005BF 803E[1A1D]01        <1> 	cmp	byte [stmo], 1 
   159 000005C4 7503                <1> 	jne	short chk_24khz_2
   160 000005C6 BB[160D]            <1> 	mov	bx, load_24khz_mono_8_bit
   161                              <1> chk_24khz_2:
   162 000005C9 B80020              <1> 	mov	ax, 8192
   163 000005CC BA0200              <1> 	mov	dx, 2
   164 000005CF B90100              <1> 	mov	cx, 1
   165 000005D2 EB31                <1> 	jmp	short set_sizes 
   166                              <1> chk_32khz:
   167 000005D4 3D007D              <1> 	cmp	ax, 32000
   168 000005D7 7556                <1> 	jne	short vra_needed
   169 000005D9 803E[1C1D]08        <1> 	cmp	byte [bps], 8
   170 000005DE 760F                <1> 	jna	short chk_32khz_1
   171 000005E0 BB[980F]            <1> 	mov	bx, load_32khz_stereo_16_bit
   172 000005E3 803E[1A1D]01        <1> 	cmp	byte [stmo], 1 
   173 000005E8 7512                <1> 	jne	short chk_32khz_2
   174 000005EA BB[4B0F]            <1> 	mov	bx, load_32khz_mono_16_bit
   175 000005ED EB0D                <1> 	jmp	short chk_32khz_2
   176                              <1> chk_32khz_1:
   177 000005EF BB[D40E]            <1> 	mov	bx, load_32khz_stereo_8_bit
   178 000005F2 803E[1A1D]01        <1> 	cmp	byte [stmo], 1 
   179 000005F7 7503                <1> 	jne	short chk_32khz_2
   180 000005F9 BB[7C0E]            <1> 	mov	bx, load_32khz_mono_8_bit
   181                              <1> chk_32khz_2:
   182 000005FC B8AA2A              <1> 	mov	ax, 10922
   183 000005FF BA0300              <1> 	mov	dx, 3
   184 00000602 B90200              <1> 	mov	cx, 2
   185                              <1> 	;jmp	short set_sizes 
   186                              <1> set_sizes:
   187 00000605 803E[1A1D]01        <1> 	cmp	byte [stmo], 1
   188 0000060A 7402                <1> 	je	short ss_1
   189 0000060C D1E0                <1> 	shl	ax, 1
   190                              <1> ss_1:
   191 0000060E 803E[1C1D]08        <1> 	cmp	byte [bps], 8
   192 00000613 7602                <1> 	jna	short ss_2
   193                              <1> 	; 16 bit samples
   194 00000615 D1E0                <1> 	shl	ax, 1
   195                              <1> ss_2:
   196 00000617 A3[3806]            <1> 	mov	[loadsize], ax
   197 0000061A F7E2                <1> 	mul	dx
   198                              <1> 	;cmp	cx, 1
   199                              <1> 	;je	short ss_3
   200                              <1> ;ss_3:
   201 0000061C F7F1                <1> 	div	cx
   202 0000061E 8A0E[1E1D]          <1> 	mov	cl, [fbs_shift]
   203 00000622 D3E0                <1> 	shl	ax, cl
   204 00000624 D1E8                <1> 	shr	ax, 1	; buffer size is 16 bit sample count
   205 00000626 A3[3A06]            <1> 	mov	[buffersize], ax 
   206 00000629 891E[3606]          <1> 	mov	[loadfromwavfile], bx
   207 0000062D EB0F                <1> 	jmp	short playWav_vra
   208                              <1> 
   209                              <1> vra_needed:
   210                              <1> 	; 13/11/2023
   211 0000062F 58                  <1> 	pop	ax ; discard return address to the caller
   212 00000630 BA[AC1C]            <1> 	mov	dx, msg_no_vra
   213 00000633 E9F3FA              <1> 	jmp	vra_err
   214                              <1> 
   215                              <1> 	; 13/11/2023
   216                              <1> loadfromwavfile:
   217 00000636 [0407]              <1> 	dw	loadFromFile
   218                              <1> loadsize:	; read from wav file
   219 00000638 0000                <1> 	dw	0
   220                              <1> buffersize:	; write to DMA buffer
   221 0000063A 00800000            <1> 	dd	32768 ; 16 bit samples (not bytes)
   222                              <1> 
   223                              <1> playWav_vra:
   224                              <1> 	; 07/11/2023
   225                              <1> 	; clear buffer 2
   226                              <1>         ;push	es
   227                              <1> 	;mov	ax, [WAV_BUFFER2]
   228                              <1> 	;mov	es, ax
   229                              <1> 	;sub	ax, ax
   230                              <1> 	;mov	di, ax ; 17/02/2017
   231                              <1> 	;mov	cx, (BUFFERSIZE/2)
   232                              <1> 	;rep	stosw
   233                              <1> 	;pop	es	     
   234                              <1> 	
   235                              <1> 	; load 64k into buffer 1
   236 0000063E A1[0C1D]            <1>         mov     ax, [WAV_BUFFER1]
   237                              <1>         ;call	loadFromFile
   238                              <1> 	; 13/11/2023
   239 00000641 FF16[3606]          <1> 	call	word [loadfromwavfile]
   240                              <1> 
   241                              <1> 	; and 64k into buffer 2
   242 00000645 A1[0E1D]            <1> 	mov     ax, [WAV_BUFFER2]
   243                              <1>        	;call	loadFromFile
   244                              <1> 	; 13/11/2023
   245 00000648 FF16[3606]          <1> 	call	word [loadfromwavfile]
   246                              <1> 
   247                              <1> ; register reset the DMA engine. This may cause a pop noise on the output
   248                              <1> ; lines when the device is reset. Prolly a better idea to mute output, then
   249                              <1> ; reset.
   250                              <1> ;
   251                              <1> 	; 11/11/2023
   252                              <1>         ;mov	dx, [NABMBAR]
   253                              <1>         ;add	dx, PO_CR_REG		; set pointer to Ctrl reg
   254                              <1>         ;mov	al, RR			; set reset
   255                              <1> 	;out	dx, al			; self clearing bit
   256                              <1> 
   257                              <1> ; write last valid index to 31 to start with.
   258                              <1> ; The Last Valid Index register tells the DMA engine when to stop playing.
   259                              <1> ; 
   260                              <1> ; As we progress through the song we change the last valid index to always be
   261                              <1> ; something other than the index we're currently playing.  
   262                              <1> ;
   263                              <1> 	; 08/11/2023
   264                              <1> 	;; 07/11/2023
   265                              <1> 	;mov	al, 1
   266                              <1>         ;;mov	al, 31
   267                              <1> 	;call	setLastValidIndex
   268                              <1> 
   269                              <1> ; create Buffer Descriptor List
   270                              <1> ;
   271                              <1> ; A buffer descriptor list is a list of pointers and control bits that the
   272                              <1> ; DMA engine uses to know where to get the .wav data and how to play it.
   273                              <1> ;
   274                              <1> ; I set it up to use only 2 buffers of .wav data, and whenever 1 buffer is
   275                              <1> ; playing, I refresh the other one with good data.
   276                              <1> ;
   277                              <1> ;
   278                              <1> ; For the control bits, you can specify that the DMA engine fire an interrupt
   279                              <1> ; after a buffer has been processed, but I poll the current index register
   280                              <1> ; to know when it's safe to update the other buffer.
   281                              <1> ;
   282                              <1> ; I set the BUP bit, which tells the DMA engine to just play 0's (silence)
   283                              <1> ; if it ever runs out of data to play. Good for safety.
   284                              <1> ;
   285 0000064C 06                  <1>         push    es
   286 0000064D A1[0A1D]            <1>         mov     ax, [BDL_BUFFER]		; get segment # for BDL
   287 00000650 8EC0                <1>         mov     es, ax
   288                              <1> 
   289 00000652 B91000              <1>         mov     cx, 32 / 2                      ; make 32 entries in BDL
   290 00000655 31FF                <1>         xor     di, di                          
   291                              <1> _0:
   292                              <1> 
   293                              <1> ; set buffer descriptor 0 to start of data file in memory
   294 00000657 660FB706[0C1D]      <1>         movzx   eax, word [WAV_BUFFER1]
   295 0000065D 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   296 00000661 66AB                <1>         stosd                                   ; store pointer to wavbuffer1
   297                              <1> 
   298                              <1> ;
   299                              <1> ; set length to 32k samples. 1 sample is 16bits or 2bytes.
   300                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples.
   301                              <1> ; 
   302                              <1> 
   303                              <1> ; 17/02/2017 (Erdogan Tan)
   304                              <1> ; Intel 82801AA (ICH) & Intel 82801AB (ICH0) I/O Controller Hub AC97
   305                              <1> ; Programmers Reference Manual
   306                              <1> 
   307                              <1> ; 2.2.1 Buffer Descriptor List  (on Page 13)
   308                              <1> 	;
   309                              <1> 	;  Generic Form of Buffer Descriptor
   310                              <1> 	;  ---------------------------------
   311                              <1> 	;  63   62    61-48    47-32   31-0
   312                              <1> 	;  ---  ---  --------  ------- -----
   313                              <1> 	;  IOC  BUP -reserved- Buffer  Buffer
   314                              <1> 	;		      Length   Pointer
   315                              <1> 	;		      [15:0]   [31:0]
   316                              <1> 	;
   317                              <1> 	;  IOC:	Interrupt On Completion. 
   318                              <1> 	;	1 = Enabled. 
   319                              <1> 	;	    When this is set, it means that the controller should
   320                              <1> 	;	    issue an interrupt upon completion of this buffer.
   321                              <1> 	;	    It should also set the IOC bit in the status register
   322                              <1> 	;	0 = Disabled	
   323                              <1> 	;
   324                              <1> 	;  BUP: Buffer Underrun Policy.
   325                              <1> 	;       0 = When this buffer is complete,
   326                              <1> 	;	    if the next buffer is not yet ready 
   327                              <1> 	;	    (i.e., the last valid buffer has been processed),
   328                              <1> 	;	    then continue to transmit the last valid sample.
   329                              <1> 	;	1 = When this buffer is complete,
   330                              <1> 	;     	    if this is the last valid buffer, transmit zeros after
   331                              <1> 	;	    this buffer has been processed completely.
   332                              <1> 	;	    This bit typically is set only if this is the last 
   333                              <1> 	;	    buffer in the current stream.
   334                              <1> 	;
   335                              <1> 	; [31:0]: Buffer pointer. This field points to the location of
   336                              <1> 	;	  the data buffer. Since samples can be as wide as one
   337                              <1> 	;	  word, the buffer must be aligned with word boundaries,
   338                              <1> 	;	  to prevent samples from straddling DWord boundaries.
   339                              <1> 	;
   340                              <1> 	; [15:0]: Buffer Length: This is the length of the data buffer,
   341                              <1> 	;	  in number of samples. The controller uses this data
   342                              <1> 	;	  to determine the length of the buffer, in bytes.
   343                              <1> 	;	  "0" indicates no sample to process.
   344                              <1> 
   345                              <1> ; ICH2AC97.INC
   346                              <1> 
   347                              <1> ;	IOC	equ     BIT31   ; Fire an interrupt whenever this
   348                              <1> 				; buffer is complete.
   349                              <1> 
   350                              <1> ;	BUP	equ     BIT30   ; Buffer Underrun Policy.
   351                              <1> 				; if this buffer is the last buffer
   352                              <1> 				; in a playback, fill the remaining
   353                              <1> 				; samples with 0 (silence) or not.
   354                              <1> 				; It's a good idea to set this to 1
   355                              <1> 				; for the last buffer in playback,
   356                              <1> 				; otherwise you're likely to get a lot
   357                              <1> 				; of noise at the end of the sound.
   358                              <1> ;
   359                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   360                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   361                              <1> ; Luckily for us, that's the same format as .wav files.
   362                              <1> ;
   363                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   364                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   365                              <1> ;
   366                              <1> ; A value of 0 in these bits means play no samples.
   367                              <1> ;
   368                              <1> 
   369                              <1> ; ICHWAV.ASM
   370                              <1> 
   371                              <1> 	;mov	eax, BUFFERSIZE / 2 ; size of half buffer (32K)
   372                              <1> 	; 13/11/2023 (ich_wav3.asm) - 18/11/2023 (ich_wav4.asm)
   373 00000663 66A1[3A06]          <1> 	mov	eax, [buffersize]
   374                              <1> 
   375                              <1> 	;or	eax, IOC + BUP
   376                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   377 00000667 660D00000040        <1> 	or	eax, BUP
   378 0000066D 66AB                <1> 	stosd
   379                              <1> 
   380                              <1> ; 2nd buffer:
   381                              <1> 
   382 0000066F 660FB706[0E1D]      <1>         movzx   eax, word [WAV_BUFFER2]
   383 00000675 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   384 00000679 66AB                <1>         stosd                                   ; store pointer to wavbuffer2
   385                              <1> 
   386                              <1> ; set length to 64k (32k of two 16 bit samples)
   387                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples
   388                              <1> ; 
   389                              <1> 	;mov	eax, BUFFERSIZE / 2 ; size of half buffer (32K)
   390                              <1> 	; 13/11/2023 (ich_wav3.asm) - 18/11/2023 (ich_wav4.asm)
   391 0000067B 66A1[3A06]          <1> 	mov	eax, [buffersize]
   392                              <1> 
   393                              <1> 	;or	eax, IOC + BUP
   394                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   395 0000067F 660D00000040        <1> 	or	eax, BUP
   396 00000685 66AB                <1> 	stosd
   397                              <1> 
   398 00000687 E2CE                <1>         loop    _0
   399 00000689 07                  <1>         pop     es
   400                              <1> 
   401                              <1> ;
   402                              <1> ; tell the DMA engine where to find our list of Buffer Descriptors.
   403                              <1> ; this 32bit value is a flat mode memory offset (ie no segment:offset)
   404                              <1> ;
   405                              <1> ; write NABMBAR+10h with offset of buffer descriptor list
   406                              <1> ;
   407 0000068A 660FB706[0A1D]      <1>         movzx   eax, word [BDL_BUFFER]
   408 00000690 66C1E004            <1> 	shl     eax, 4                          ; convert seg:off to 0:off
   409 00000694 8B16[081D]          <1>         mov     dx, [NABMBAR]
   410 00000698 83C210              <1>         add     dx, PO_BDBAR_REG                ; set pointer to BDL
   411 0000069B 66EF                <1>         out     dx, eax                         ; write to AC97 controller
   412                              <1> 
   413                              <1> ;
   414                              <1> ; All set. Let's play some music.
   415                              <1> ;
   416                              <1> 
   417                              <1> 	; 08/11/2023
   418                              <1> 	; 07/11/2023
   419                              <1> 	; 08/12/2016
   420                              <1> 	; 07/10/2016
   421                              <1>         ;mov	al, 1
   422 0000069D B01F                <1>         mov	al, 31
   423 0000069F E85A01              <1> 	call	setLastValidIndex
   424                              <1> 
   425                              <1> 	; 06/11/2023 (not neccessary)
   426                              <1> 	;; 05/11/2023
   427                              <1> 	;; reset current index
   428                              <1> 	;mov	al, 0
   429                              <1> 	;call	setCurrentIndex
   430                              <1> 
   431                              <1> 	; 06/11/2023
   432                              <1> 	;mov	byte [tLoop], 1 ; 30/11/2016
   433                              <1> 
   434                              <1> 	; 17/02/2017
   435 000006A2 8B16[081D]          <1>         mov     dx, [NABMBAR]
   436 000006A6 83C21B              <1>         add     dx, PO_CR_REG                   ; PCM out Control Register
   437                              <1>         ;mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
   438                              <1> 	;			; (LVBI interrupt will not be enabled)
   439                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   440 000006A9 B001                <1> 	mov	al, RPBM
   441 000006AB EE                  <1> 	out     dx, al                          ; Start bus master operation.
   442                              <1> 
   443                              <1> 	; 06/11/2023
   444                              <1> 	;call	delay1_4ms
   445                              <1> 	;call	delay1_4ms
   446                              <1> 	;call	delay1_4ms
   447                              <1> 	;call	delay1_4ms
   448                              <1> 
   449                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   450                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   451                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   452                              <1>    
   453                              <1> ; 06/11/2023 (TUNELOOP version, without interrupt)
   454                              <1> %if 0
   455                              <1> 	; 08/12/2016
   456                              <1> 	; 28/11/2016
   457                              <1> p_loop:
   458                              <1> 	call    check4keyboardstop      ; keyboard halt?
   459                              <1>         jc	short r_loop 	; no ; 05/11/2023
   460                              <1> 
   461                              <1> 	;mov	byte [tLoop], 0
   462                              <1> 	; 04/11/2023
   463                              <1> 	;mov	byte [audio_play_cmd], 0
   464                              <1> 	;call	ac97_stop
   465                              <1> 	;retn
   466                              <1> _exit_:
   467                              <1> 	; 04/11/2023
   468                              <1> 	; finished with song, stop everything
   469                              <1> 	call	ac97_stop
   470                              <1> 	
   471                              <1> 	; restore previous interrupt vector and interrupt_status
   472                              <1> 	cli
   473                              <1> 	in	al, 0A1h ; irq 8-15
   474                              <1> 	mov	al, [IRQ_status+1]
   475                              <1> 	out	0A1h, al 
   476                              <1> 	in	al, 021h ; irq 0-7
   477                              <1> 	mov	al, [IRQ_status]
   478                              <1> 	out	21h, al 
   479                              <1> 	; ...
   480                              <1> 	push	es
   481                              <1> 	xor	ax, ax
   482                              <1> 	mov	es, ax
   483                              <1> 	mov	ax, [IRQ_vector]
   484                              <1> 	mov	[es:bx], ax
   485                              <1> 	mov	ax, [IRQ_vector+2]
   486                              <1> 	mov	[es:bx+2], ax
   487                              <1> 	pop	es
   488                              <1> 	sti
   489                              <1> 	retn
   490                              <1> 
   491                              <1> r_loop:
   492                              <1> 	; 07/12/2016 - Erdogan Tan
   493                              <1> 	nop
   494                              <1> 	nop
   495                              <1> 	nop
   496                              <1> 	; 17/02/2017
   497                              <1> 	mov	al, [tBuff]
   498                              <1> 	dec	al ; 1-32 -> 0-31 or 0 -> 0FFh
   499                              <1> 	js	short  p_loop
   500                              <1> 	mov	byte [tBuff], 0 ; reset
   501                              <1> 	and	al, 1
   502                              <1> 	jnz	short q_loop
   503                              <1>         mov     ax, [WAV_BUFFER2] ; [tBuff]=2 (from tuneLoop)
   504                              <1> s_loop:
   505                              <1> 	;call	loadFromFile
   506                              <1> 	; 13/11/2023 - 18/11/2023
   507                              <1> 	call	[loadfromwavfile]
   508                              <1> 	;jc	short _exit_
   509                              <1> 	; 05/11/2023
   510                              <1> 	jc	short exit_loop
   511                              <1> 	jmp	short r_loop
   512                              <1> q_loop:
   513                              <1>      	mov     ax, [WAV_BUFFER1] ; [tBuff]=1 (from tuneLoop)
   514                              <1>         ;call	loadFromFile
   515                              <1> 	;jc	short _exit_
   516                              <1> 	;jmp	short r_loop
   517                              <1> 	; 05/11/2023
   518                              <1> 	jmp	short s_loop
   519                              <1> 
   520                              <1> exit_loop: 
   521                              <1> 	mov	byte [tLoop], 0
   522                              <1> 	retn
   523                              <1> 		
   524                              <1> tuneLoop:
   525                              <1> 	; 05/11/2023
   526                              <1> 	; 08/12/2016
   527                              <1> 	; 28/11/2016 - Erdogan Tan
   528                              <1> 	
   529                              <1> 	cmp	byte [tLoop], 1
   530                              <1> 	jb	short _exit_ ; 05/11/2023
   531                              <1> _tlp_1:	
   532                              <1> 	; 17/02/2017
   533                              <1> 	call	getCurrentIndex
   534                              <1> 	inc	al ; 0-31 -> 1-32
   535                              <1> 	mov	[tBuff], al
   536                              <1> 
   537                              <1> 	; 05/11/2023
   538                              <1> 	dec	ax
   539                              <1> 	dec	ax
   540                              <1> 	and	al, 1Fh
   541                              <1> 	call	setLastValidIndex
   542                              <1> 
   543                              <1> 	; 05/11/2023
   544                              <1> 	; 17/02/2017 - Buffer switch test (temporary)
   545                              <1> 	push	ds
   546                              <1> 	push	si 
   547                              <1> 	mov	si, 0B800h ; video display page segment
   548                              <1> 	mov	ds, si
   549                              <1> 	sub	si, si ; 0
   550                              <1> 	mov	ah, 4Eh
   551                              <1> 	and	al, 1
   552                              <1> 	add	al, '1'
   553                              <1> 	mov	[si], ax ; show current play buffer (1, 2)
   554                              <1> 	pop	si
   555                              <1> 	pop	ds
   556                              <1> 
   557                              <1> 	; 17/02/2017
   558                              <1> 
   559                              <1> 	;test	byte [irq_status], LVBCI ; last buff completion intr.
   560                              <1> 	;jz	short _tlp2 ; BCIS ; Buffer completion interrupt
   561                              <1> 
   562                              <1> 	; Last Valid Buffer Completion Interrupt (LVBCI).
   563                              <1> 	;   1 = Last valid buffer has been processed. 
   564                              <1> 	;	It remains active until cleared by software. 
   565                              <1> 	;	This bit indicates the occurrence of the event 
   566                              <1> 	;	signified by the last valid buffer being processed.
   567                              <1> 	;	Thus, this is an event status bit that can be cleared
   568                              <1> 	;	by software once this event has been recognized.
   569                              <1> 	;	This event causes an interrupt if the enable bit
   570                              <1> 	;	in the Control Register is set. The interrupt is
   571                              <1> 	;	cleared when the software clears this bit.
   572                              <1> 	;	In the case of Transmits (PCM out, Modem out) this bit
   573                              <1> 	;	is set, after the last valid buffer has been
   574                              <1> 	;	fetched (not after transmitting it).
   575                              <1> 	;	While in the case of Receives, this bit is set after
   576                              <1> 	;	the data for the last buffer has been written to memory.
   577                              <1> 	;   0 = Cleared by writing a "1" to this bit position.
   578                              <1> 
   579                              <1> 	; Note: We are not using LVBCI 
   580                              <1> 	;     Last Buffer Completion Interrupt !!!
   581                              <1> 
   582                              <1> 	; 17/02/2017
   583                              <1>         ;mov     dx, [NABMBAR]
   584                              <1>         ;add     dx, PO_SR_REG	; PCM out Status register
   585                              <1>         ;mov     al, [irq_status]
   586                              <1>         ;out     dx, al		; Clear (LVBCI) interrupt status
   587                              <1> 	;retn
   588                              <1> 
   589                              <1> ;_tlp2:
   590                              <1> 	; Buffer Completion Interrupt Status (BCIS).
   591                              <1> 	;   1 =	Set by the hardware after the last sample 
   592                              <1> 	; 	of a buffer has been processed, AND if the Interrupt
   593                              <1> 	; 	on Completion (IOC) bit is set in the command byte of 
   594                              <1> 	; 	the buffer descriptor. It remains active
   595                              <1> 	; 	until cleared by software.
   596                              <1> 	;   0 =	Cleared by writing a "1" to this bit position.
   597                              <1> 
   598                              <1> 	; 17/02/2017
   599                              <1>         mov     dx, [NABMBAR]
   600                              <1>         add     dx, PO_SR_REG	; PCM out Status register
   601                              <1>         mov     al, [pcm_irq_status] ; 05/11/2023
   602                              <1>         out     dx, al		; Clear (BCI) interrupt status
   603                              <1> 	retn
   604                              <1> 
   605                              <1> ;_exit_:
   606                              <1> ;	mov	byte [tLoop], 0
   607                              <1> ;_exit:
   608                              <1> ;       ; finished with song, stop everything
   609                              <1> ;	mov     dx, [NABMBAR]		
   610                              <1> ;       add     dx, PO_CR_REG           ; PCM out Control Register
   611                              <1> ;       mov     al, 0
   612                              <1> ;       out     dx, al                  ; stop player
   613                              <1> ;_return:
   614                              <1> ;	retn
   615                              <1> 
   616                              <1> %endif
   617                              <1> 
   618                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   619                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   620                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   621                              <1> 
   622                              <1> ; 18/11/2023
   623                              <1> ; 08/11/2023
   624                              <1> ; 07/11/2023
   625                              <1> %if 1
   626                              <1> 
   627                              <1> tuneLoop:
   628                              <1> 	; 18/11/2023 (ich_wav4.asm)
   629                              <1> 	; 08/11/2023
   630                              <1> 	; 06/11/2023
   631 000006AC B031                <1> 	mov	al, '1'
   632 000006AE E84500              <1> 	call	tL0
   633                              <1> tL1:
   634 000006B1 E81D01              <1> 	call    updateLVI	; /set LVI != CIV/
   635 000006B4 7434                <1> 	jz	short _exit_	; 08/11/2023
   636 000006B6 E84C01              <1> 	call    check4keyboardstop
   637 000006B9 722F                <1> 	jc	short _exit_
   638 000006BB E80A01              <1> 	call    getCurrentIndex
   639 000006BE A801                <1> 	test	al, BIT0
   640 000006C0 74EF                <1> 	jz	short tL1	; loop if buffer 2 is not playing
   641                              <1> 
   642                              <1> 	; load buffer 1
   643 000006C2 A1[0C1D]            <1> 	mov     ax, [WAV_BUFFER1]
   644                              <1> 	;call	loadFromFile
   645                              <1> 	; 18/11/2023
   646 000006C5 FF16[3606]          <1> 	call	word [loadfromwavfile]
   647 000006C9 721F                <1> 	jc	short _exit_	; end of file
   648                              <1> 
   649 000006CB B032                <1> 	mov	al, '2'
   650 000006CD E82600              <1> 	call	tL0
   651                              <1> tL2:
   652 000006D0 E8FE00              <1> 	call    updateLVI
   653 000006D3 7415                <1> 	jz	short _exit_	; 08/11/2023
   654 000006D5 E82D01              <1> 	call    check4keyboardstop
   655 000006D8 7210                <1> 	jc	short _exit_
   656 000006DA E8EB00              <1> 	call    getCurrentIndex
   657 000006DD A801                <1> 	test	al, BIT0
   658 000006DF 75EF                <1> 	jnz	short tL2	; loop if buffer 1 is not playing
   659                              <1> 
   660                              <1> 	; load buffer 2
   661 000006E1 A1[0E1D]            <1> 	mov     ax, [WAV_BUFFER2]
   662                              <1> 	;call	loadFromFile
   663                              <1> 	; 18/11/2023
   664 000006E4 FF16[3606]          <1> 	call	word [loadfromwavfile]
   665 000006E8 73C2                <1> 	jnc	short tuneLoop
   666                              <1> _exit_:
   667 000006EA 8B16[081D]          <1> 	mov	dx, [NABMBAR]		
   668 000006EE 83C21B              <1> 	add	dx, PO_CR_REG	; PCM out Control Register
   669 000006F1 B000                <1> 	mov	al, 0
   670 000006F3 EE                  <1> 	out	dx, al		; stop player
   671                              <1> 
   672 000006F4 0430                <1> 	add	al, '0'
   673                              <1> 	;call	tL0
   674                              <1> 	;
   675                              <1> 	;retn
   676                              <1> 	; 06/11/2023
   677                              <1> 	;jmp	short tL0
   678                              <1> 	;retn
   679                              <1> 
   680                              <1> 	; 06/11/2023
   681                              <1> tL0:
   682                              <1> 	; 08/11/2023
   683                              <1> 	; 05/11/2023
   684                              <1> 	; 17/02/2017 - Buffer switch test (temporary)
   685                              <1> 	; 06/11/2023
   686                              <1> 	; al = buffer indicator ('1', '2' or '0' -stop- )
   687 000006F6 1E                  <1> 	push	ds
   688                              <1> 	;push	bx 
   689 000006F7 BB00B8              <1> 	mov	bx, 0B800h ; video display page segment
   690 000006FA 8EDB                <1> 	mov	ds, bx
   691 000006FC 29DB                <1> 	sub	bx, bx ; 0
   692 000006FE B44E                <1> 	mov	ah, 4Eh
   693 00000700 8907                <1> 	mov	[bx], ax ; show current play buffer (1, 2)
   694                              <1> 	;pop	bx
   695 00000702 1F                  <1> 	pop	ds
   696 00000703 C3                  <1> 	retn
   697                              <1> 
   698                              <1> %endif
   699                              <1> 
   700                              <1> ; 08/11/2023
   701                              <1> ; 07/11/2023
   702                              <1> %if 0
   703                              <1> 
   704                              <1> tuneLoop:
   705                              <1> 	; 07/11/2023
   706                              <1> 	;mov	dx, NABMBAR
   707                              <1> 	;add	dx, PO_CIV_REG ; 14h
   708                              <1> tL1:
   709                              <1> 	call    updateLVI	; set LVI != CIV
   710                              <1> 	call    check4keyboardstop
   711                              <1> 	jc	short _exit_
   712                              <1> 	call    getCurrentIndex
   713                              <1> 	test	al, BIT0
   714                              <1> 	jz	short tL1	; loop if buffer 2 is not playing
   715                              <1> 
   716                              <1> 	; load buffer 1
   717                              <1> 	mov     ax, [WAV_BUFFER1]
   718                              <1> 	call	loadFromFile
   719                              <1> 	jc	short _exit_	; end of file
   720                              <1> tL2:
   721                              <1> 	call    updateLVI
   722                              <1> 	call    check4keyboardstop
   723                              <1> 	jc	short _exit_
   724                              <1> 	call    getCurrentIndex
   725                              <1> 	test	al, BIT0
   726                              <1> 	jnz	short tL2	; loop if buffer 1 is not playing
   727                              <1> 
   728                              <1> 	; load buffer 2
   729                              <1> 	mov     ax, [WAV_BUFFER2]
   730                              <1> 	call	loadFromFile
   731                              <1> 	jnc	short tuneLoop
   732                              <1> _exit_:
   733                              <1> 	mov	dx, [NABMBAR]		
   734                              <1> 	add	dx, PO_CR_REG	; PCM out Control Register
   735                              <1> 	mov	al, 0
   736                              <1> 	out	dx, al		; stop player
   737                              <1> 	retn
   738                              <1> 
   739                              <1> %endif
   740                              <1> 
   741                              <1> ; load data from file in 32k chunks. Would be nice to load 1 64k chunk,
   742                              <1> ; but in DOS you can only load FFFF bytes at a time.
   743                              <1> ;
   744                              <1> ; entry: ax = segment to load data to
   745                              <1> ; exit: CY set if end of file reached.
   746                              <1> ; note: last file buffer is padded with 0's to avoid pops at the end of song.
   747                              <1> ; assumes file is already open. uses [filehandle]
   748                              <1> 
   749                              <1> ; 07/11/2023
   750                              <1> %if 0
   751                              <1> 
   752                              <1> loadFromFile:
   753                              <1> 	; 07/11/2023
   754                              <1> 	; 06/11/2023
   755                              <1> 	; 17/02/2017
   756                              <1> 	;push	ax
   757                              <1> 	;push	cx
   758                              <1> 	;push	dx
   759                              <1> 	;push	bx
   760                              <1> 
   761                              <1> 	;push	es
   762                              <1> 	;push	ds
   763                              <1> 	
   764                              <1>         test    byte [flags], ENDOFFILE	; have we already read the
   765                              <1> 	;stc				; last of the file?
   766                              <1> 	; 05/11/2023
   767                              <1> 	;jnz	endLFF
   768                              <1> 	jz	short lff_12	; 06/11/2023
   769                              <1> 	; 06/11/2023
   770                              <1> 	;;mov	byte [tLoop], 0
   771                              <1> 	;jmp	endLFF
   772                              <1> 	stc
   773                              <1> 	retn
   774                              <1> 
   775                              <1> lff_12:	; 06/11/2023    
   776                              <1> 	mov	[fbs_seg], ax ; save buffer segment
   777                              <1> 	xor	dx, dx
   778                              <1> lff_0:
   779                              <1> 	mov	[fbs_off], dx ; buffer offset
   780                              <1> 
   781                              <1> 	mov     bx, (BUFFERSIZE / 2)	; 32k chunk
   782                              <1> 	mov	cl, [fbs_shift]   
   783                              <1> 	and	cl, cl
   784                              <1> 	jz	short lff_1 ; stereo, 16 bit	
   785                              <1> 
   786                              <1> 	; fbs_shift =
   787                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   788                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   789                              <1> 	shr	bx, cl ; 32K / multiplier
   790                              <1> 
   791                              <1> 	mov	ax, cs
   792                              <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   793                              <1> lff_1:
   794                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   795                              <1> 	; load file into memory
   796                              <1>         mov	cx, bx                         
   797                              <1> 	mov	bx, [filehandle]
   798                              <1> 	mov     ds, ax
   799                              <1>        	mov	ah, 3fh
   800                              <1> 	int	21h
   801                              <1> 
   802                              <1> 	mov	bx, cs
   803                              <1> 	mov	ds, bx
   804                              <1> 
   805                              <1> 	jc	short lff_9 ; error !
   806                              <1> 
   807                              <1> 	and	ax, ax
   808                              <1> 	jz	short lff_10
   809                              <1> 	
   810                              <1> 	mov	bl, [fbs_shift] ; shift count  
   811                              <1> 	or	bl, bl
   812                              <1> 	jz	short lff_7 ; 16 bit stereo samples
   813                              <1> 
   814                              <1> 	push	es
   815                              <1> 	; 06/11/2023
   816                              <1> 	;push	di
   817                              <1> 	;push	si
   818                              <1> 	mov	di, [fbs_off]
   819                              <1> 	mov	si, [fbs_seg] ; buffer segment
   820                              <1> 	mov	es, si
   821                              <1> 	mov	si, temp_buffer ; temporary buffer address
   822                              <1> 	mov	cl, [bps] ; bits per sample (8 or 16)
   823                              <1> 	cmp	cl, 8
   824                              <1> 	jne	short lff_4 ; 16 bit samples
   825                              <1> 	; 8 bit samples
   826                              <1> 	mov	cx, ax ; byte count
   827                              <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   828                              <1> 	jz	short lff_3 ; 8 bit, stereo
   829                              <1> lff_2:
   830                              <1> 	; mono & 8 bit
   831                              <1> 	lodsb
   832                              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   833                              <1> 	stosw	; left channel
   834                              <1> 	stosw	; right channel
   835                              <1> 	loop	lff_2
   836                              <1> 	jmp	short lff_6	
   837                              <1> lff_3:
   838                              <1> 	; stereo & 8 bit
   839                              <1> 	lodsb
   840                              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   841                              <1> 	stosw
   842                              <1> 	loop	lff_3			
   843                              <1> 	jmp	short lff_6
   844                              <1> lff_4:
   845                              <1> 	; 16 bit mono samples
   846                              <1> 	mov	cx, ax ; word count
   847                              <1> lff_5:	
   848                              <1> 	lodsw
   849                              <1> 	stosw	; left channel
   850                              <1> 	stosw	; right channel
   851                              <1> 	loop	lff_5
   852                              <1> lff_6:
   853                              <1> 	mov	ax, di ; save next buffer offset/position
   854                              <1> 	; 06/11/2023
   855                              <1> 	;pop	si
   856                              <1> 	;pop	di
   857                              <1> 	pop	es
   858                              <1> ;lff_7:        
   859                              <1> 	; 06/11/2023
   860                              <1> 	and	ax, ax
   861                              <1> 	jz	short endLFF ; end of 2nd half
   862                              <1> 	mov	cx, (BUFFERSIZE / 2)
   863                              <1> lff_7:
   864                              <1> 	cmp	ax, cx
   865                              <1> 	je	short endLFF	 ; 06/11/2023
   866                              <1> 	;jb	short lff_11
   867                              <1> 	;xor	cx, cx
   868                              <1> 	;sub	cx, ax
   869                              <1> 	;neg	cx
   870                              <1> 	jmp	short lff_11
   871                              <1> lff_8:
   872                              <1> 	; 07/11/2023
   873                              <1> 	cmp	word [fbs_off], (BUFFERSIZE / 2) ; 32768
   874                              <1> 	jnb	short endLFF
   875                              <1> 	
   876                              <1> 	mov	dx, ax ; buffer offset
   877                              <1> 	mov	ax, [fbs_seg] ; buffer segment
   878                              <1> 	jmp	lff_0
   879                              <1> lff_9:  
   880                              <1> 	; 07/11/2023
   881                              <1> 	;; 06/11/2023 (temporary)
   882                              <1> 	;mov	al, '!'  ; error
   883                              <1> 	;call	tL0
   884                              <1> 
   885                              <1> 	xor	ax, ax
   886                              <1> lff_10:
   887                              <1> 	; 07/11/2023
   888                              <1> 	;mov	cx, (BUFFERSIZE / 2)  
   889                              <1> lff_11:
   890                              <1> 	call    padfill				; blank pad the remainder
   891                              <1>         ;clc					; don't exit with CY yet.
   892                              <1>         or	byte [flags], ENDOFFILE		; end of file flag
   893                              <1> endLFF:
   894                              <1>         ;pop	ds
   895                              <1> 	;pop	es
   896                              <1> 	; 06/11/2023
   897                              <1> 	;pop	bx
   898                              <1> 	;pop	dx
   899                              <1>         ;pop	cx
   900                              <1>         ;pop	ax
   901                              <1>         retn
   902                              <1> 
   903                              <1> %endif
   904                              <1> 
   905                              <1> ; 08/11/2023
   906                              <1> ; 07/11/2023
   907                              <1> %if 1
   908                              <1> 
   909                              <1> loadFromFile:
   910                              <1> 	; 07/11/2023
   911                              <1> 
   912 00000704 F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
   913                              <1> 					; last of the file?
   914 00000709 7402                <1> 	jz	short lff_0		; no
   915 0000070B F9                  <1> 	stc
   916 0000070C C3                  <1> 	retn
   917                              <1> 
   918                              <1> lff_0:
   919                              <1> 	; 08/11/2023
   920 0000070D 89C5                <1> 	mov	bp, ax ; save buffer segment	
   921                              <1> 
   922 0000070F 8A0E[1E1D]          <1> 	mov	cl, [fbs_shift]   
   923 00000713 20C9                <1> 	and	cl, cl
   924 00000715 7467                <1> 	jz	short lff_1 ; stereo, 16 bit	
   925                              <1> 
   926 00000717 BFFFFF              <1> 	mov	di, BUFFERSIZE - 1 ; 65535
   927                              <1> 
   928                              <1> 	; fbs_shift =
   929                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   930                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   931 0000071A D3EF                <1> 	shr	di, cl
   932 0000071C 47                  <1> 	inc	di ; 16384 for 8 bit and mono	
   933                              <1> 		   ; 32768 for 8 bit or mono	
   934                              <1> 
   935 0000071D 8CC8                <1> 	mov	ax, cs
   936 0000071F BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   937                              <1> 
   938                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   939                              <1> 	; load file into memory
   940 00000722 89F9                <1>         mov	cx, di                       
   941 00000724 8B1E[021D]          <1> 	mov	bx, [filehandle]
   942 00000728 8ED8                <1> 	mov     ds, ax
   943 0000072A B43F                <1>        	mov	ah, 3Fh
   944 0000072C CD21                <1> 	int	21h
   945                              <1> 
   946 0000072E 8CCB                <1> 	mov	bx, cs
   947 00000730 8EDB                <1> 	mov	ds, bx
   948                              <1> 
   949 00000732 727C                <1> 	jc	short lff_4 ; error !
   950                              <1> 
   951                              <1> 	; 08/11/2023
   952 00000734 31D2                <1> 	xor	dx, dx ; 0
   953                              <1> 
   954 00000736 21C0                <1> 	and	ax, ax
   955 00000738 746D                <1> 	jz	short lff_3
   956                              <1> 
   957 0000073A 8A1E[1E1D]          <1> 	mov	bl, [fbs_shift]
   958                              <1> 
   959 0000073E 06                  <1> 	push	es
   960 0000073F 89D7                <1> 	mov	di, dx ; 0 ; [fbs_off]
   961                              <1> 	;mov	bp, [fbs_seg] ; buffer segment
   962 00000741 8EC5                <1> 	mov	es, bp
   963 00000743 BE[201D]            <1> 	mov	si, temp_buffer ; temporary buffer address
   964 00000746 89C1                <1> 	mov	cx, ax ; byte count
   965 00000748 803E[1C1D]08        <1> 	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   966 0000074D 751B                <1> 	jne	short lff_7 ; 16 bit samples
   967                              <1> 	; 8 bit samples
   968 0000074F FECB                <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   969 00000751 740C                <1> 	jz	short lff_6 ; 8 bit, stereo
   970                              <1> lff_5:
   971                              <1> 	; mono & 8 bit
   972 00000753 AC                  <1> 	lodsb
   973 00000754 2C80                <1> 	sub	al, 80h ; 08/11/2023
   974 00000756 C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   975 00000759 AB                  <1> 	stosw	; left channel
   976 0000075A AB                  <1> 	stosw	; right channel
   977 0000075B E2F6                <1> 	loop	lff_5
   978 0000075D EB12                <1> 	jmp	short lff_9	
   979                              <1> lff_6:
   980                              <1> 	; stereo & 8 bit
   981 0000075F AC                  <1> 	lodsb
   982 00000760 2C80                <1> 	sub	al, 80h ; 08/11/2023
   983 00000762 C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   984 00000765 AB                  <1> 	stosw
   985 00000766 E2F7                <1> 	loop	lff_6			
   986 00000768 EB07                <1> 	jmp	short lff_9
   987                              <1> lff_7:
   988 0000076A D1E9                <1> 	shr	cx, 1 ; word count
   989                              <1> lff_8:
   990 0000076C AD                  <1> 	lodsw
   991 0000076D AB                  <1> 	stosw	; left channel
   992 0000076E AB                  <1> 	stosw	; right channel
   993 0000076F E2FB                <1> 	loop	lff_8
   994                              <1> lff_9:
   995 00000771 07                  <1> 	pop	es
   996 00000772 09FF                <1> 	or	di, di
   997 00000774 7439                <1> 	jz	short endLFF ; 64KB ok 
   998                              <1> 	
   999 00000776 89F8                <1> 	mov	ax, di ; [fbs_off]
  1000 00000778 48                  <1> 	dec	ax
  1001 00000779 B9FFFF              <1> 	mov	cx, BUFFERSIZE - 1 ; 65535
  1002 0000077C EB29                <1> 	jmp	short lff_3
  1003                              <1> 	
  1004                              <1> lff_1:  
  1005                              <1> 	;mov	bp, ax ; save buffer segment
  1006 0000077E 31D2                <1> 	xor	dx, dx
  1007                              <1> 	; load file into memory
  1008 00000780 B90080              <1>         mov	cx, (BUFFERSIZE / 2)	; 32k chunk
  1009 00000783 8B1E[021D]          <1> 	mov	bx, [filehandle]
  1010 00000787 8ED8                <1> 	mov     ds, ax
  1011 00000789 B43F                <1>        	mov	ah, 3Fh
  1012 0000078B CD21                <1> 	int	21h
  1013                              <1> 
  1014 0000078D 8CCF                <1> 	mov	di, cs
  1015 0000078F 8EDF                <1> 	mov	ds, di
  1016                              <1> 
  1017                              <1> 	; 07/11/2023
  1018 00000791 721D                <1> 	jc	short lff_4 ; error !
  1019                              <1> 	
  1020 00000793 39C8                <1> 	cmp	ax, cx
  1021 00000795 7510                <1> 	jne	short lff_3
  1022                              <1> lff_2:
  1023                              <1> 	; 08/11/2023
  1024 00000797 01C2                <1> 	add	dx, ax
  1025                              <1> 	;mov	cx, (BUFFERSIZE / 2)	; 32k chunk
  1026                              <1> 	;mov	bx, [filehandle]
  1027 00000799 8EDD                <1> 	mov     ds, bp
  1028 0000079B B43F                <1>        	mov	ah, 3Fh
  1029 0000079D CD21                <1> 	int	21h
  1030                              <1> 
  1031                              <1> 	;mov	di, cs
  1032 0000079F 8EDF                <1> 	mov	ds, di
  1033                              <1> 
  1034 000007A1 720D                <1> 	jc	short lff_4 ; error !
  1035                              <1> 
  1036 000007A3 39C8                <1> 	cmp	ax, cx
  1037 000007A5 7408                <1> 	je	short endLFF
  1038                              <1> lff_3:
  1039 000007A7 E80F00              <1> 	call    padfill			; blank pad the remainder
  1040                              <1>         ;clc				; don't exit with CY yet.
  1041 000007AA 800E[041D]01        <1>         or	byte [flags], ENDOFFILE	; end of file flag
  1042                              <1> endLFF:
  1043 000007AF C3                  <1>         retn
  1044                              <1> lff_4:
  1045                              <1> 	; 08/11/2023
  1046 000007B0 B021                <1> 	mov	al, '!'  ; error
  1047 000007B2 E841FF              <1> 	call	tL0
  1048                              <1> 
  1049 000007B5 31C0                <1> 	xor	ax, ax
  1050 000007B7 EBEE                <1> 	jmp	short lff_3
  1051                              <1> 
  1052                              <1> %endif
  1053                              <1> 
  1054                              <1> ; entry ds:ax points to last byte in file
  1055                              <1> ; cx=target size
  1056                              <1> ; note: must do byte size fill
  1057                              <1> ; destroys bx, cx
  1058                              <1> ;
  1059                              <1> padfill:
  1060                              <1> 	; 07/11/2023
  1061                              <1> 	; 06/11/2023
  1062                              <1> 	; 17/02/2017
  1063 000007B9 06                  <1> 	push	es
  1064                              <1>         ;push	di
  1065                              <1> 	;mov	di, [fbs_seg]
  1066                              <1> 	;mov	es, di
  1067 000007BA 8EC5                <1>         mov	es, bp
  1068 000007BC 29C1                <1> 	sub	cx, ax
  1069                              <1> 	; 08/11/2023
  1070                              <1> 	;mov	di, ax ; (wrong)
  1071 000007BE 89D7                <1> 	mov	di, dx ; buffer offset
  1072 000007C0 01C7                <1> 	add	di, ax       	
  1073                              <1> 	; 07/11/2023
  1074                              <1> 	;add	di, [fbs_off]
  1075 000007C2 30C0                <1>         xor	al, al
  1076 000007C4 F3AA                <1> 	rep	stosb
  1077                              <1> 	;mov	[fbs_off], di
  1078                              <1> 	;pop	di
  1079 000007C6 07                  <1>         pop	es
  1080 000007C7 C3                  <1> 	retn
  1081                              <1> 
  1082                              <1> ; returns AL = current index value
  1083                              <1> getCurrentIndex:
  1084                              <1> 	; 08/11/2023
  1085                              <1> 	;push	dx
  1086 000007C8 8B16[081D]          <1> 	mov	dx, [NABMBAR]      		
  1087 000007CC 83C214              <1> 	add	dx, PO_CIV_REG
  1088 000007CF EC                  <1> 	in	al, dx
  1089                              <1> 	;pop	dx
  1090                              <1> uLVI2:	;	06/11/2023
  1091 000007D0 C3                  <1> 	retn
  1092                              <1> 
  1093                              <1> ; examines the CIV and the LVI. When they're the same, we set LVI <> CIV
  1094                              <1> ; that way, we never run out of buffers to play
  1095                              <1> 
  1096                              <1> ; 08/11/2023
  1097                              <1> %if 0
  1098                              <1> 	; 07/11/2023
  1099                              <1> updateLVI:
  1100                              <1> 	push	ax
  1101                              <1> 	push	dx
  1102                              <1> 	; 06/11/2023
  1103                              <1> 	mov	dx, [NABMBAR]
  1104                              <1> 	add	dx, PO_CIV_REG
  1105                              <1> 	; (Current Index Value and Last Valid Index value)
  1106                              <1> 	in	ax, dx
  1107                              <1> 
  1108                              <1> 	cmp	al, ah ; is current index = last index ?
  1109                              <1> 	jne	short uLVI1
  1110                              <1> 
  1111                              <1> 	call	setNewIndex
  1112                              <1> uLVI1:
  1113                              <1> 	pop	dx
  1114                              <1> 	pop	ax
  1115                              <1> 	retn
  1116                              <1> 
  1117                              <1> setNewIndex:
  1118                              <1> 	; 07/11/2023
  1119                              <1> 	push	ax
  1120                              <1>         call    getCurrentIndex                 ; get CIV
  1121                              <1>         test    byte [flags], ENDOFFILE
  1122                              <1>         jnz     short sni_1
  1123                              <1>         ; not at the end of the file yet.
  1124                              <1>         dec     al                              ; make new index <> current
  1125                              <1>         and     al, INDEX_MASK                  ; make sure new value is 0-31
  1126                              <1> sni_1:
  1127                              <1>         call    setLastValidIndex               ; write new value
  1128                              <1>         clc
  1129                              <1>         pop	ax
  1130                              <1> 	retn
  1131                              <1> 
  1132                              <1> %endif	
  1133                              <1> 
  1134                              <1> ; 08/11/2023
  1135                              <1> ; 07/11/2023
  1136                              <1> ;%if 1
  1137                              <1> updateLVI:
  1138                              <1> 	; 06/11/2023
  1139 000007D1 8B16[081D]          <1> 	mov	dx, [NABMBAR]      		
  1140 000007D5 83C214              <1> 	add	dx, PO_CIV_REG
  1141                              <1> 	; (Current Index Value and Last Valid Index value)
  1142 000007D8 ED                  <1> 	in	ax, dx
  1143                              <1> 
  1144 000007D9 38E0                <1> 	cmp	al, ah ; is current index = last index ?
  1145 000007DB 75F3                <1> 	jne	short uLVI2
  1146                              <1> 
  1147                              <1> 	; 08/11/2023	
  1148 000007DD E8E8FF              <1> 	call	getCurrentIndex
  1149                              <1>  
  1150 000007E0 F606[041D]01        <1> 	test	byte [flags], ENDOFFILE
  1151                              <1> 	;jnz	short uLVI1
  1152 000007E5 7411                <1> 	jz	short uLVI0  ; 08/11/2023
  1153                              <1> 
  1154                              <1> 	; 08/11/2023
  1155 000007E7 50                  <1> 	push	ax
  1156 000007E8 8B16[081D]          <1> 	mov	dx, [NABMBAR]
  1157 000007EC 83C216              <1> 	add	dx, PO_SR_REG  ; PCM out status register
  1158 000007EF ED                  <1> 	in	ax, dx
  1159                              <1> 
  1160 000007F0 A803                <1> 	test	al, 3 ; bit 1 = Current Equals Last Valid (CELV)
  1161                              <1> 		      ; (has been processed)
  1162                              <1> 		      ; bit 0 = 1 -> DMA Controller Halted (DCH)
  1163 000007F2 58                  <1> 	pop	ax
  1164 000007F3 7407                <1> 	jz	short uLVI1
  1165                              <1> uLVI3:
  1166 000007F5 31C0                <1> 	xor	ax, ax
  1167                              <1> 	; zf = 1
  1168 000007F7 C3                  <1> 	retn
  1169                              <1> uLVI0:
  1170                              <1>         ; not at the end of the file yet.
  1171 000007F8 FEC8                <1> 	dec	al
  1172 000007FA 241F                <1> 	and	al, 1Fh
  1173                              <1> uLVI1:
  1174                              <1> 	;call	setLastValidIndex
  1175                              <1> ;uLVI2:
  1176                              <1> 	;retn
  1177                              <1> 
  1178                              <1> ;%endif
  1179                              <1> 	
  1180                              <1> ;input AL = index # to stop on
  1181                              <1> setLastValidIndex:
  1182                              <1> 	; 08/11/2023
  1183                              <1> 	;push	dx
  1184 000007FC 8B16[081D]          <1> 	mov	dx, [NABMBAR]
  1185 00000800 83C215              <1> 	add	dx, PO_LVI_REG
  1186 00000803 EE                  <1>         out     dx, al
  1187                              <1> 	;pop	dx
  1188 00000804 C3                  <1> 	retn
  1189                              <1> 
  1190                              <1> ; 06/11/2023
  1191                              <1> ;	; 05/11/2023
  1192                              <1> ;setCurrentIndex:
  1193                              <1> ;	;push	dx
  1194                              <1> ;	mov	dx, [NABMBAR]
  1195                              <1> ;	add	dx, PO_CIV_REG
  1196                              <1> ;	out	dx, al
  1197                              <1> ;	;pop	dx
  1198                              <1> ;	retn
  1199                              <1> 
  1200                              <1> ; checks if either shift key has been pressed. Exits with CY if so.
  1201                              <1> ; 
  1202                              <1> check4keyboardstop:
  1203                              <1> 
  1204                              <1> ; 06/11/2023
  1205                              <1> %if 1
  1206                              <1> 	; 08/11/2023
  1207                              <1> 	; 04/11/2023
  1208 00000805 B401                <1> 	mov	ah, 1
  1209 00000807 CD16                <1> 	int	16h
  1210 00000809 7405                <1> 	jz	short _cksr
  1211 0000080B 30E4                <1> 	xor	ah, ah
  1212 0000080D CD16                <1> 	int	16h
  1213 0000080F F9                  <1> 	stc
  1214                              <1> _cksr:
  1215 00000810 C3                  <1> 	retn
  1216                              <1> %endif
  1217                              <1> 
  1218                              <1> ; 06/11/2023
  1219                              <1> ; 04/11/2023
  1220                              <1> %if 0	
  1221                              <1>         push    ds
  1222                              <1>         push    0
  1223                              <1>         pop     ds		       ; examine BDA for keyboard flags
  1224                              <1>         test    byte [417h], (BIT0 | BIT1)
  1225                              <1>         pop     ds
  1226                              <1>         stc
  1227                              <1>         jnz	short _cksr ; 07/11/2023
  1228                              <1> 	;jz	short _cksr ; 06/11/2023
  1229                              <1>         clc
  1230                              <1> _cksr:
  1231                              <1>         retn
  1232                              <1> %endif
  1233                              <1> 
  1234                              <1> ; 18/11/2023 (ich_wav3.asm & ich_wav4.asm)
  1235                              <1> ; 15/11/2023 (ich_wav3.asm)	
  1236                              <1> ; 14/11/2023
  1237                              <1> ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  1238                              <1> ; --------------------------------------------------------
  1239                              <1> 
  1240                              <1> ;;Note:	At the end of every buffer load,
  1241                              <1> ;;	during buffer switch/swap, there will be discontinuity
  1242                              <1> ;;	between the last converted sample and the 1st sample
  1243                              <1> ;;	of the next buffer.
  1244                              <1> ;;	(like as a dot noises vaguely between normal sound samples)
  1245                              <1> ;;	-To avoid this defect, the 1st sample of
  1246                              <1> ;;	the next buffer may be read from the wav file but
  1247                              <1> ;;	the file pointer would need to be set to 1 sample back
  1248                              <1> ;;	again via seek system call. Time comsumption problem! -
  1249                              <1> ;;
  1250                              <1> ;;	Erdogan Tan - 15/11/2023
  1251                              <1> ;;
  1252                              <1> ;;	((If entire wav data would be loaded at once.. conversion
  1253                              <1> ;;	defect/noise would disappear.. but for DOS, to keep
  1254                              <1> ;;	64KB buffer limit is important also it is important
  1255                              <1> ;;	for running under 1MB barrier without HIMEM.SYS or DPMI.
  1256                              <1> ;;	I have tested this program by using 2-30MB wav files.))
  1257                              <1> ;;
  1258                              <1> ;;	Test Computer:	ASUS desktop/mainboard, M2N4-SLI, 2010.
  1259                              <1> ;;			AMD Athlon 64 X2 2200 MHZ CPU.
  1260                              <1> ;;		       	NFORCE4 (CK804) AC97 audio hardware.
  1261                              <1> ;;			Realtek ALC850 codec.
  1262                              <1> ;;		       	Retro DOS v4.2 (MSDOS 6.22) operating system.
  1263                              <1> 
  1264                              <1> load_8khz_mono_8_bit:
  1265                              <1> 	; 15/11/2023
  1266                              <1> 	; 14/11/2023
  1267                              <1> 	; 13/11/2023
  1268 00000811 F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1269                              <1> 					; last of the file?
  1270 00000816 7402                <1> 	jz	short lff8m_0		; no
  1271 00000818 F9                  <1> 	stc
  1272 00000819 C3                  <1> 	retn
  1273                              <1> 
  1274                              <1> lff8m_0:
  1275 0000081A 8EC0                <1> 	mov	es, ax ; buffer segment	
  1276 0000081C 31FF                <1> 	xor	di, di
  1277 0000081E BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1278                              <1> 	; ds = cs
  1279                              <1> 
  1280                              <1> 	; load file into memory
  1281 00000821 8B0E[3806]          <1>         mov	cx, [loadsize]
  1282 00000825 8B1E[021D]          <1> 	mov	bx, [filehandle]
  1283 00000829 B43F                <1>        	mov	ah, 3Fh
  1284 0000082B CD21                <1> 	int	21h
  1285                              <1> 	;jc	short lff8m_5 ; error !
  1286                              <1> 	; 14/11/2023
  1287 0000082D 7303                <1> 	jnc	short lff8m_6
  1288 0000082F E98B00              <1> 	jmp	lff8m_5
  1289                              <1> 
  1290                              <1> lff8m_6:
  1291 00000832 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1292 00000834 21C0                <1> 	and	ax, ax
  1293                              <1> 	;jz	short lff8m_3
  1294                              <1> 	; 15/11/2023
  1295 00000836 747E                <1> 	jz	short lff8_eof
  1296                              <1> 
  1297 00000838 89C1                <1> 	mov	cx, ax		; byte count
  1298                              <1> lff8m_1:
  1299 0000083A AC                  <1> 	lodsb
  1300 0000083B A2[0E19]            <1> 	mov	[previous_val], al
  1301 0000083E 2C80                <1> 	sub	al, 80h
  1302 00000840 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1303 00000843 AB                  <1> 	stosw		; original sample (left channel)
  1304 00000844 AB                  <1> 	stosw		; original sample (right channel)
  1305                              <1> 	;xor	ax, ax
  1306                              <1> 	; 14/11/2023
  1307 00000845 B080                <1> 	mov	al, 80h
  1308 00000847 49                  <1> 	dec	cx
  1309 00000848 7402                <1> 	jz	short lff8m_2
  1310 0000084A 8A04                <1> 	mov	al, [si]
  1311                              <1> lff8m_2:
  1312                              <1> 	;mov	[next_val], ax
  1313 0000084C 88C7                <1> 	mov	bh, al	; [next_val]
  1314 0000084E 8A26[0E19]          <1> 	mov	ah, [previous_val]
  1315 00000852 00E0                <1> 	add	al, ah	; [previous_val]
  1316 00000854 D0D8                <1> 	rcr	al, 1
  1317 00000856 88C2                <1> 	mov	dl, al	; this is interpolated middle (3th) sample
  1318 00000858 00E0                <1> 	add	al, ah	; [previous_val]
  1319 0000085A D0D8                <1> 	rcr	al, 1	
  1320 0000085C 88C3                <1> 	mov	bl, al 	; this is temporary interpolation value	
  1321 0000085E 00E0                <1> 	add	al, ah	; [previous_val]
  1322 00000860 D0D8                <1> 	rcr	al, 1
  1323 00000862 2C80                <1> 	sub	al, 80h
  1324 00000864 C1E008              <1> 	shl	ax, 8	
  1325 00000867 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1326 00000868 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1327 00000869 88D8                <1> 	mov	al, bl
  1328 0000086B 00D0                <1> 	add	al, dl
  1329 0000086D D0D8                <1> 	rcr	al, 1
  1330 0000086F 2C80                <1> 	sub	al, 80h
  1331 00000871 C1E008              <1> 	shl	ax, 8
  1332 00000874 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1333 00000875 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1334 00000876 88D0                <1> 	mov	al, dl
  1335 00000878 2C80                <1> 	sub	al, 80h
  1336 0000087A C1E008              <1> 	shl	ax, 8
  1337 0000087D AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1338 0000087E AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1339                              <1> 	;mov	al, [next_val]
  1340 0000087F 88F8                <1> 	mov	al, bh
  1341 00000881 00D0                <1> 	add	al, dl
  1342 00000883 D0D8                <1> 	rcr	al, 1
  1343 00000885 88C3                <1> 	mov	bl, al	; this is temporary interpolation value
  1344 00000887 00D0                <1> 	add	al, dl
  1345 00000889 D0D8                <1> 	rcr	al, 1
  1346 0000088B 2C80                <1> 	sub	al, 80h
  1347 0000088D C1E008              <1> 	shl	ax, 8
  1348 00000890 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1349 00000891 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1350                              <1> 	;mov	al, [next_val]
  1351 00000892 88F8                <1> 	mov	al, bh
  1352 00000894 00D8                <1> 	add	al, bl
  1353 00000896 D0D8                <1> 	rcr	al, 1
  1354 00000898 2C80                <1> 	sub	al, 80h
  1355 0000089A C1E008              <1> 	shl	ax, 8
  1356 0000089D AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1357 0000089E AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1358                              <1> 	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1359 0000089F 09C9                <1> 	or	cx, cx
  1360 000008A1 7597                <1> 	jnz	short lff8m_1
  1361                              <1> 
  1362                              <1> 	; --------------
  1363                              <1> 
  1364                              <1> lff8s_3:
  1365                              <1> lff8m_3:
  1366                              <1> lff8s2_3:
  1367                              <1> lff8m2_3:
  1368                              <1> lff16s_3:
  1369                              <1> lff16m_3:
  1370                              <1> lff16s2_3:
  1371                              <1> lff16m2_3:
  1372                              <1> lff24_3:
  1373                              <1> lff32_3:
  1374                              <1> lff44_3:
  1375                              <1> lff22_3:
  1376                              <1> lff11_3:
  1377 000008A3 8B0E[3A06]          <1> 	mov	cx, [buffersize] ; 16 bit (48 kHZ, stereo) sample size
  1378 000008A7 D1E1                <1> 	shl	cx, 1	; byte count
  1379 000008A9 29F9                <1> 	sub	cx, di
  1380 000008AB 7606                <1> 	jna	short lff8m_4
  1381                              <1> 	;inc	cx
  1382 000008AD D1E9                <1> 	shr	cx, 1
  1383 000008AF 31C0                <1> 	xor	ax, ax	; fill (remain part of) buffer with zeros	
  1384 000008B1 F3AB                <1> 	rep	stosw
  1385                              <1> lff8m_4:
  1386 000008B3 0E                  <1> 	push	cs
  1387 000008B4 07                  <1> 	pop	es
  1388 000008B5 C3                  <1> 	retn
  1389                              <1> 
  1390                              <1> lff8_eof:
  1391                              <1> lff16_eof:
  1392                              <1> lff24_eof:
  1393                              <1> lff32_eof:
  1394                              <1> lff44_eof:
  1395                              <1> lff22_eof:
  1396                              <1> lff11_eof:
  1397                              <1> 	; 15/11/2023
  1398 000008B6 C606[041D]01        <1> 	mov	byte [flags], ENDOFFILE
  1399 000008BB EBE6                <1> 	jmp	short lff8m_3
  1400                              <1> 
  1401                              <1> lff8s_5:
  1402                              <1> lff8m_5:
  1403                              <1> lff8s2_5:
  1404                              <1> lff8m2_5:
  1405                              <1> lff16s_5:
  1406                              <1> lff16m_5:
  1407                              <1> lff16s2_5:
  1408                              <1> lff16m2_5:
  1409                              <1> lff24_5:
  1410                              <1> lff32_5:
  1411                              <1> lff44_5:
  1412                              <1> lff22_5:
  1413                              <1> lff11_5:
  1414 000008BD B021                <1> 	mov	al, '!'  ; error
  1415 000008BF E834FE              <1> 	call	tL0
  1416                              <1> 	
  1417                              <1> 	;jmp	short lff8m_3
  1418                              <1> 	; 15/11/2023
  1419 000008C2 EBF2                <1> 	jmp	lff8_eof
  1420                              <1> 
  1421                              <1> 	; --------------
  1422                              <1> 
  1423                              <1> load_8khz_stereo_8_bit:
  1424                              <1> 	; 15/11/2023
  1425                              <1> 	; 14/11/2023
  1426                              <1> 	; 13/11/2023
  1427 000008C4 F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1428                              <1> 					; last of the file?
  1429 000008C9 7402                <1> 	jz	short lff8s_0		; no
  1430 000008CB F9                  <1> 	stc
  1431 000008CC C3                  <1> 	retn
  1432                              <1> 
  1433                              <1> lff8s_0:
  1434 000008CD 8EC0                <1> 	mov	es, ax ; buffer segment	
  1435 000008CF 31FF                <1> 	xor	di, di
  1436 000008D1 BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1437                              <1> 	; ds = cs
  1438                              <1> 
  1439                              <1> 	; load file into memory
  1440 000008D4 8B0E[3806]          <1>         mov	cx, [loadsize]
  1441 000008D8 8B1E[021D]          <1> 	mov	bx, [filehandle]
  1442 000008DC B43F                <1>        	mov	ah, 3Fh
  1443 000008DE CD21                <1> 	int	21h
  1444 000008E0 72DB                <1> 	jc	short lff8s_5 ; error !
  1445                              <1> 
  1446 000008E2 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1447                              <1> 	
  1448 000008E4 D1E8                <1> 	shr	ax, 1
  1449                              <1> 	;;and	ax, ax
  1450                              <1> 	;jz	short lff8s_3
  1451                              <1> 	; 15/11/2023
  1452 000008E6 74CE                <1> 	jz	short lff8_eof
  1453                              <1> 
  1454 000008E8 89C1                <1> 	mov	cx, ax		; word count
  1455                              <1> lff8s_1:
  1456 000008EA AC                  <1> 	lodsb
  1457 000008EB A2[0E19]            <1> 	mov	[previous_val_l], al
  1458 000008EE 2C80                <1> 	sub	al, 80h
  1459 000008F0 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1460 000008F3 AB                  <1> 	stosw		; original sample (L)
  1461 000008F4 AC                  <1> 	lodsb
  1462 000008F5 A2[1019]            <1> 	mov	[previous_val_r], al
  1463 000008F8 2C80                <1> 	sub	al, 80h
  1464 000008FA C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1465 000008FD AB                  <1> 	stosw		; original sample (R)
  1466                              <1> 
  1467                              <1> 	;xor	ax, ax
  1468                              <1> 	; 14/11/2023
  1469 000008FE B88080              <1> 	mov	ax, 8080h
  1470 00000901 49                  <1> 	dec	cx
  1471 00000902 7402                <1> 	jz	short lff8s_2
  1472                              <1> 		; convert 8 bit sample to 16 bit sample
  1473 00000904 8B04                <1> 	mov	ax, [si]
  1474                              <1> lff8s_2:
  1475 00000906 A2[1219]            <1> 	mov	[next_val_l], al
  1476 00000909 8826[1419]          <1> 	mov	[next_val_r], ah
  1477 0000090D 8A26[0E19]          <1> 	mov	ah, [previous_val_l]
  1478 00000911 00E0                <1> 	add	al, ah
  1479 00000913 D0D8                <1> 	rcr	al, 1
  1480 00000915 88C2                <1> 	mov	dl, al	; this is interpolated middle (3th) sample (L)
  1481 00000917 00E0                <1> 	add	al, ah
  1482 00000919 D0D8                <1> 	rcr	al, 1	
  1483 0000091B 88C3                <1> 	mov	bl, al	; this is temporary interpolation value (L)
  1484 0000091D 00E0                <1> 	add	al, ah
  1485 0000091F D0D8                <1> 	rcr	al, 1
  1486 00000921 2C80                <1> 	sub	al, 80h
  1487 00000923 C1E008              <1> 	shl	ax, 8
  1488 00000926 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1489 00000927 A0[1419]            <1> 	mov	al, [next_val_r]
  1490 0000092A 8A26[1019]          <1> 	mov	ah, [previous_val_r]
  1491 0000092E 00E0                <1> 	add	al, ah
  1492 00000930 D0D8                <1> 	rcr	al, 1
  1493 00000932 88C6                <1> 	mov	dh, al	; this is interpolated middle (3th) sample (R)
  1494 00000934 00E0                <1> 	add	al, ah
  1495 00000936 D0D8                <1> 	rcr	al, 1
  1496 00000938 88C7                <1> 	mov	bh, al	; this is temporary interpolation value (R)
  1497 0000093A 00E0                <1> 	add	al, ah
  1498 0000093C D0D8                <1> 	rcr	al, 1
  1499 0000093E 2C80                <1> 	sub	al, 80h
  1500 00000940 C1E008              <1> 	shl	ax, 8
  1501 00000943 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1502 00000944 88D8                <1> 	mov	al, bl
  1503 00000946 00D0                <1> 	add	al, dl
  1504 00000948 D0D8                <1> 	rcr	al, 1
  1505 0000094A 2C80                <1> 	sub	al, 80h
  1506 0000094C C1E008              <1> 	shl	ax, 8
  1507 0000094F AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1508 00000950 88F8                <1> 	mov	al, bh
  1509 00000952 00F0                <1> 	add	al, dh
  1510 00000954 D0D8                <1> 	rcr	al, 1
  1511 00000956 2C80                <1> 	sub	al, 80h
  1512 00000958 C1E008              <1> 	shl	ax, 8
  1513 0000095B AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1514 0000095C 88D0                <1> 	mov	al, dl
  1515 0000095E 2C80                <1> 	sub	al, 80h
  1516 00000960 C1E008              <1> 	shl	ax, 8
  1517 00000963 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1518 00000964 88F0                <1> 	mov	al, dh
  1519 00000966 2C80                <1> 	sub	al, 80h
  1520 00000968 C1E008              <1> 	shl	ax, 8
  1521 0000096B AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1522 0000096C A0[1219]            <1> 	mov	al, [next_val_l]
  1523 0000096F 00D0                <1> 	add	al, dl
  1524 00000971 D0D8                <1> 	rcr	al, 1
  1525 00000973 88C3                <1> 	mov	bl, al	; this is temporary interpolation value (L)
  1526 00000975 00D0                <1> 	add	al, dl
  1527 00000977 D0D8                <1> 	rcr	al, 1
  1528 00000979 2C80                <1> 	sub	al, 80h
  1529 0000097B C1E008              <1> 	shl	ax, 8
  1530 0000097E AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1531 0000097F A0[1419]            <1> 	mov	al, [next_val_r]
  1532 00000982 00F0                <1> 	add	al, dh
  1533 00000984 D0D8                <1> 	rcr	al, 1
  1534 00000986 88C7                <1> 	mov	bh, al	; this is temporary interpolation value (R)
  1535 00000988 00F0                <1> 	add	al, dh
  1536 0000098A D0D8                <1> 	rcr	al, 1
  1537 0000098C 2C80                <1> 	sub	al, 80h
  1538 0000098E C1E008              <1> 	shl	ax, 8
  1539 00000991 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1540 00000992 A0[1219]            <1> 	mov	al, [next_val_l]
  1541 00000995 00D8                <1> 	add	al, bl
  1542 00000997 D0D8                <1> 	rcr	al, 1
  1543 00000999 2C80                <1> 	sub	al, 80h
  1544 0000099B C1E008              <1> 	shl	ax, 8
  1545 0000099E AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1546 0000099F A0[1419]            <1> 	mov	al, [next_val_r]
  1547 000009A2 00F8                <1> 	add	al, bh
  1548 000009A4 D0D8                <1> 	rcr	al, 1
  1549 000009A6 2C80                <1> 	sub	al, 80h
  1550 000009A8 C1E008              <1> 	shl	ax, 8
  1551 000009AB AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1552                              <1> 	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1553 000009AC E303                <1> 	jcxz	lff8s_6
  1554 000009AE E939FF              <1> 	jmp	lff8s_1
  1555                              <1> lff8s_6:
  1556 000009B1 E9EFFE              <1> 	jmp	lff8s_3
  1557                              <1> 
  1558                              <1> load_8khz_mono_16_bit:
  1559                              <1> 	; 13/11/2023
  1560 000009B4 F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1561                              <1> 					; last of the file?
  1562 000009B9 7402                <1> 	jz	short lff8m2_0		; no
  1563 000009BB F9                  <1> 	stc
  1564 000009BC C3                  <1> 	retn
  1565                              <1> 
  1566                              <1> lff8m2_0:
  1567 000009BD 8EC0                <1> 	mov	es, ax ; buffer segment	
  1568 000009BF 31FF                <1> 	xor	di, di
  1569 000009C1 BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1570                              <1> 	; ds = cs
  1571                              <1> 
  1572                              <1> 	; load file into memory
  1573 000009C4 8B0E[3806]          <1>         mov	cx, [loadsize]
  1574 000009C8 8B1E[021D]          <1> 	mov	bx, [filehandle]
  1575 000009CC B43F                <1>        	mov	ah, 3Fh
  1576 000009CE CD21                <1> 	int	21h
  1577 000009D0 7270                <1> 	jc	short lff8m2_7 ; error !
  1578                              <1> 
  1579 000009D2 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1580                              <1> 	
  1581 000009D4 D1E8                <1> 	shr	ax, 1
  1582                              <1> 	;and	ax, ax
  1583 000009D6 7503                <1> 	jnz	short lff8m2_8
  1584                              <1> 	;jmp	lff8m2_3
  1585                              <1> 	; 15/11/2023
  1586 000009D8 E9DBFE              <1> 	jmp	lff8_eof
  1587                              <1> 
  1588                              <1> lff8m2_8:
  1589 000009DB 89C1                <1> 	mov	cx, ax		; word count
  1590                              <1> lff8m2_1:
  1591 000009DD AD                  <1> 	lodsw
  1592 000009DE AB                  <1> 	stosw		; original sample (left channel)
  1593 000009DF AB                  <1> 	stosw		; original sample (right channel)
  1594 000009E0 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1595 000009E3 A3[0E19]            <1> 	mov	[previous_val], ax
  1596 000009E6 31C0                <1> 	xor	ax, ax
  1597 000009E8 49                  <1> 	dec	cx
  1598 000009E9 7402                <1> 	jz	short lff8m2_2
  1599 000009EB 8B04                <1> 	mov	ax, [si]
  1600                              <1> lff8m2_2:
  1601 000009ED 80C480              <1> 	add	ah, 80h ; convert sound level to 0-65535 format
  1602 000009F0 89C5                <1> 	mov	bp, ax	; [next_val]
  1603 000009F2 0306[0E19]          <1> 	add	ax, [previous_val]
  1604 000009F6 D1D8                <1> 	rcr	ax, 1
  1605 000009F8 89C2                <1> 	mov	dx, ax	; this is interpolated middle (3th) sample
  1606 000009FA 0306[0E19]          <1> 	add	ax, [previous_val]
  1607 000009FE D1D8                <1> 	rcr	ax, 1	; this is temporary interpolation value
  1608 00000A00 89C3                <1> 	mov	bx, ax 		
  1609 00000A02 0306[0E19]          <1> 	add	ax, [previous_val]
  1610 00000A06 D1D8                <1> 	rcr	ax, 1
  1611 00000A08 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1612 00000A0B AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1613 00000A0C AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1614 00000A0D 89D8                <1> 	mov	ax, bx
  1615 00000A0F 01D0                <1> 	add	ax, dx
  1616 00000A11 D1D8                <1> 	rcr	ax, 1
  1617 00000A13 80EC80              <1> 	sub	ah, 80h
  1618 00000A16 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1619 00000A17 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1620 00000A18 89D0                <1> 	mov	ax, dx
  1621 00000A1A 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1622 00000A1D AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1623 00000A1E AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1624 00000A1F 89E8                <1> 	mov	ax, bp
  1625 00000A21 01D0                <1> 	add	ax, dx
  1626 00000A23 D1D8                <1> 	rcr	ax, 1
  1627 00000A25 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value
  1628 00000A27 01D0                <1> 	add	ax, dx
  1629 00000A29 D1D8                <1> 	rcr	ax, 1
  1630 00000A2B 80EC80              <1> 	sub	ah, 80h
  1631 00000A2E AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1632 00000A2F AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1633 00000A30 89E8                <1> 	mov	ax, bp
  1634 00000A32 01D8                <1> 	add	ax, bx
  1635 00000A34 D1D8                <1> 	rcr	ax, 1
  1636 00000A36 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1637 00000A39 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1638 00000A3A AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1639                              <1> 	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1640 00000A3B 09C9                <1> 	or	cx, cx
  1641 00000A3D 759E                <1> 	jnz	short lff8m2_1
  1642 00000A3F E961FE              <1> 	jmp	lff8m2_3
  1643                              <1> 
  1644                              <1> lff8m2_7:
  1645                              <1> lff8s2_7:
  1646 00000A42 E978FE              <1> 	jmp	lff8m2_5  ; error
  1647                              <1> 
  1648                              <1> load_8khz_stereo_16_bit:
  1649                              <1> 	; 16/11/2023
  1650                              <1> 	; 15/11/2023
  1651                              <1> 	; 13/11/2023
  1652 00000A45 F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1653                              <1> 					; last of the file?
  1654 00000A4A 7402                <1> 	jz	short lff8s2_0		; no
  1655 00000A4C F9                  <1> 	stc
  1656 00000A4D C3                  <1> 	retn
  1657                              <1> 
  1658                              <1> lff8s2_0:
  1659 00000A4E 8EC0                <1> 	mov	es, ax ; buffer segment	
  1660 00000A50 31FF                <1> 	xor	di, di
  1661 00000A52 BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1662                              <1> 	; ds = cs
  1663                              <1> 
  1664                              <1> 	; load file into memory
  1665 00000A55 8B0E[3806]          <1>         mov	cx, [loadsize]
  1666 00000A59 8B1E[021D]          <1> 	mov	bx, [filehandle]
  1667 00000A5D B43F                <1>        	mov	ah, 3Fh
  1668 00000A5F CD21                <1> 	int	21h
  1669 00000A61 72DF                <1> 	jc	short lff8s2_7 ; error !
  1670                              <1> 
  1671 00000A63 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1672                              <1> 	
  1673 00000A65 C1E802              <1> 	shr	ax, 2	; 16/11/2023
  1674                              <1> 	;and	ax, ax
  1675 00000A68 7503                <1> 	jnz	short lff8s2_8
  1676                              <1> 	;jmp	lff8s2_3
  1677                              <1> 	; 15/11/2023
  1678 00000A6A E949FE              <1> 	jmp	lff8_eof
  1679                              <1> 
  1680                              <1> lff8s2_8:
  1681 00000A6D 89C1                <1> 	mov	cx, ax ; dword count
  1682                              <1> lff8s2_1:
  1683 00000A6F AD                  <1> 	lodsw
  1684 00000A70 AB                  <1> 	stosw		; original sample (L)
  1685                              <1> 	; 15/11/2023
  1686 00000A71 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1687 00000A74 A3[0E19]            <1> 	mov	[previous_val_l], ax
  1688 00000A77 AD                  <1> 	lodsw
  1689 00000A78 AB                  <1> 	stosw		; original sample (R)
  1690 00000A79 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1691 00000A7C A3[1019]            <1> 	mov	[previous_val_r], ax
  1692 00000A7F 31D2                <1> 	xor	dx, dx
  1693 00000A81 31C0                <1> 	xor	ax, ax
  1694                              <1> 	; 16/11/2023
  1695 00000A83 49                  <1> 	dec	cx
  1696 00000A84 7405                <1> 	jz	short lff8s2_2
  1697 00000A86 8B04                <1> 	mov	ax, [si]
  1698 00000A88 8B5402              <1> 	mov	dx, [si+2]
  1699                              <1> lff8s2_2:
  1700 00000A8B 80C480              <1> 	add	ah, 80h	; convert sound level to 0-65535 format
  1701 00000A8E A3[1219]            <1> 	mov	[next_val_l], ax
  1702 00000A91 80C680              <1> 	add	dh, 80h	; convert sound level to 0-65535 format
  1703 00000A94 8916[1419]          <1> 	mov	[next_val_r], dx
  1704 00000A98 0306[0E19]          <1> 	add	ax, [previous_val_l]
  1705 00000A9C D1D8                <1> 	rcr	ax, 1
  1706 00000A9E 89C2                <1> 	mov	dx, ax	; this is interpolated middle (3th) sample (L)
  1707 00000AA0 0306[0E19]          <1> 	add	ax, [previous_val_l]
  1708 00000AA4 D1D8                <1> 	rcr	ax, 1	
  1709 00000AA6 89C3                <1> 	mov	bx, ax 	; this is temporary interpolation value (L)
  1710 00000AA8 0306[0E19]          <1> 	add	ax, [previous_val_l]
  1711 00000AAC D1D8                <1> 	rcr	ax, 1
  1712 00000AAE 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1713 00000AB1 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1714 00000AB2 A1[1419]            <1> 	mov	ax, [next_val_r]
  1715 00000AB5 0306[1019]          <1> 	add	ax, [previous_val_r]
  1716 00000AB9 D1D8                <1> 	rcr	ax, 1
  1717 00000ABB 89C5                <1> 	mov	bp, ax	; this is interpolated middle (3th) sample (R)
  1718 00000ABD 0306[1019]          <1> 	add	ax, [previous_val_r]
  1719 00000AC1 D1D8                <1> 	rcr	ax, 1
  1720 00000AC3 50                  <1> 	push	ax ; *	; this is temporary interpolation value (R)
  1721 00000AC4 0306[1019]          <1> 	add	ax, [previous_val_r]
  1722 00000AC8 D1D8                <1> 	rcr	ax, 1
  1723 00000ACA 80EC80              <1> 	sub	ah, 80h
  1724 00000ACD AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1725 00000ACE 89D8                <1> 	mov	ax, bx
  1726 00000AD0 01D0                <1> 	add	ax, dx
  1727 00000AD2 D1D8                <1> 	rcr	ax, 1
  1728 00000AD4 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1729 00000AD7 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1730 00000AD8 58                  <1> 	pop	ax ; *
  1731 00000AD9 01E8                <1> 	add	ax, bp
  1732 00000ADB D1D8                <1> 	rcr	ax, 1
  1733 00000ADD 80EC80              <1> 	sub	ah, 80h
  1734 00000AE0 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1735 00000AE1 89D0                <1> 	mov	ax, dx
  1736 00000AE3 80EC80              <1> 	sub	ah, 80h
  1737 00000AE6 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1738 00000AE7 89E8                <1> 	mov	ax, bp
  1739 00000AE9 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1740 00000AEC AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1741 00000AED A1[1219]            <1> 	mov	ax, [next_val_l]
  1742 00000AF0 01D0                <1> 	add	ax, dx
  1743 00000AF2 D1D8                <1> 	rcr	ax, 1
  1744 00000AF4 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value (L)
  1745 00000AF6 01D0                <1> 	add	ax, dx
  1746 00000AF8 D1D8                <1> 	rcr	ax, 1
  1747 00000AFA 80EC80              <1> 	sub	ah, 80h
  1748 00000AFD AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1749 00000AFE A1[1419]            <1> 	mov	ax, [next_val_r]
  1750 00000B01 01E8                <1> 	add	ax, bp
  1751 00000B03 D1D8                <1> 	rcr	ax, 1
  1752 00000B05 50                  <1> 	push	ax ; ** ; this is temporary interpolation value (R)
  1753 00000B06 01E8                <1> 	add	ax, bp
  1754 00000B08 D1D8                <1> 	rcr	ax, 1
  1755 00000B0A 80EC80              <1> 	sub	ah, 80h
  1756 00000B0D AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1757 00000B0E A1[1219]            <1> 	mov	ax, [next_val_l]
  1758 00000B11 01D8                <1> 	add	ax, bx
  1759 00000B13 D1D8                <1> 	rcr	ax, 1
  1760 00000B15 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1761 00000B18 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1762 00000B19 58                  <1> 	pop	ax ; **
  1763 00000B1A 0306[1419]          <1> 	add	ax, [next_val_r]
  1764 00000B1E D1D8                <1> 	rcr	ax, 1
  1765 00000B20 80EC80              <1> 	sub	ah, 80h
  1766 00000B23 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1767                              <1> 	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1768 00000B24 E303                <1> 	jcxz	lff8_s2_9
  1769 00000B26 E946FF              <1> 	jmp	lff8s2_1
  1770                              <1> lff8_s2_9:
  1771 00000B29 E977FD              <1> 	jmp	lff8s2_3
  1772                              <1> 
  1773                              <1> ; .....................
  1774                              <1> 
  1775                              <1> load_16khz_mono_8_bit:
  1776                              <1> 	; 14/11/2023
  1777                              <1> 	; 13/11/2023
  1778 00000B2C F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1779                              <1> 					; last of the file?
  1780 00000B31 7402                <1> 	jz	short lff16m_0		; no
  1781 00000B33 F9                  <1> 	stc
  1782 00000B34 C3                  <1> 	retn
  1783                              <1> 
  1784                              <1> lff16m_0:
  1785 00000B35 8EC0                <1> 	mov	es, ax ; buffer segment	
  1786 00000B37 31FF                <1> 	xor	di, di
  1787 00000B39 BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1788                              <1> 	; ds = cs
  1789                              <1> 
  1790                              <1> 	; load file into memory
  1791 00000B3C 8B0E[3806]          <1>         mov	cx, [loadsize]
  1792 00000B40 8B1E[021D]          <1> 	mov	bx, [filehandle]
  1793 00000B44 B43F                <1>        	mov	ah, 3Fh
  1794 00000B46 CD21                <1> 	int	21h
  1795 00000B48 7243                <1> 	jc	short lff16m_7 ; error !
  1796                              <1> 
  1797 00000B4A 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1798                              <1> 	
  1799 00000B4C 21C0                <1> 	and	ax, ax
  1800 00000B4E 7503                <1> 	jnz	short lff16m_8
  1801                              <1> 	;jmp	lff16m_3
  1802                              <1> 	; 15/11/2023
  1803 00000B50 E963FD              <1> 	jmp	lff16_eof
  1804                              <1> 
  1805                              <1> lff16m_8:
  1806 00000B53 89C1                <1> 	mov	cx, ax		; byte count
  1807                              <1> lff16m_1:
  1808 00000B55 AC                  <1> 	lodsb
  1809                              <1> 	;mov	[previous_val], al
  1810 00000B56 88C3                <1> 	mov	bl, al
  1811 00000B58 2C80                <1> 	sub	al, 80h
  1812 00000B5A C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1813 00000B5D AB                  <1> 	stosw		; original sample (left channel)
  1814 00000B5E AB                  <1> 	stosw		; original sample (right channel)
  1815                              <1> 	;xor	ax, ax
  1816                              <1> 	; 14/11/22023
  1817 00000B5F B080                <1> 	mov	al, 80h
  1818 00000B61 49                  <1> 	dec	cx
  1819 00000B62 7402                <1> 	jz	short lff16m_2
  1820 00000B64 8A04                <1> 	mov	al, [si]
  1821                              <1> lff16m_2:
  1822                              <1> 	;mov	[next_val], al
  1823 00000B66 88C7                <1> 	mov	bh, al
  1824                              <1> 	;add	al, [previous_val]
  1825 00000B68 00D8                <1> 	add	al, bl
  1826 00000B6A D0D8                <1> 	rcr	al, 1
  1827 00000B6C 88C2                <1> 	mov	dl, al	; this is interpolated middle (temp) sample
  1828                              <1> 	;add	al, [previous_val]
  1829 00000B6E 00D8                <1> 	add	al, bl
  1830 00000B70 D0D8                <1> 	rcr	al, 1
  1831 00000B72 2C80                <1> 	sub	al, 80h
  1832 00000B74 C1E008              <1> 	shl	ax, 8
  1833 00000B77 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1834 00000B78 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1835                              <1> 	;mov	al, [next_val]
  1836 00000B79 88F8                <1> 	mov	al, bh
  1837 00000B7B 00D0                <1> 	add	al, dl
  1838 00000B7D D0D8                <1> 	rcr	al, 1
  1839 00000B7F 2C80                <1> 	sub	al, 80h
  1840 00000B81 C1E008              <1> 	shl	ax, 8
  1841 00000B84 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1842 00000B85 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1843                              <1> 	
  1844                              <1> 	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1845 00000B86 09C9                <1> 	or	cx, cx
  1846 00000B88 75CB                <1> 	jnz	short lff16m_1
  1847 00000B8A E916FD              <1> 	jmp	lff16m_3
  1848                              <1> 
  1849                              <1> lff16m_7:
  1850                              <1> lff16s_7:
  1851 00000B8D E92DFD              <1> 	jmp	lff16m_5  ; error
  1852                              <1> 
  1853                              <1> load_16khz_stereo_8_bit:
  1854                              <1> 	; 14/11/2023
  1855                              <1> 	; 13/11/2023
  1856 00000B90 F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1857                              <1> 					; last of the file?
  1858 00000B95 7402                <1> 	jz	short lff16s_0		; no
  1859 00000B97 F9                  <1> 	stc
  1860 00000B98 C3                  <1> 	retn
  1861                              <1> 
  1862                              <1> lff16s_0:
  1863 00000B99 8EC0                <1> 	mov	es, ax ; buffer segment	
  1864 00000B9B 31FF                <1> 	xor	di, di
  1865 00000B9D BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1866                              <1> 	; ds = cs
  1867                              <1> 
  1868                              <1> 	; load file into memory
  1869 00000BA0 8B0E[3806]          <1>         mov	cx, [loadsize]
  1870 00000BA4 8B1E[021D]          <1> 	mov	bx, [filehandle]
  1871 00000BA8 B43F                <1>        	mov	ah, 3Fh
  1872 00000BAA CD21                <1> 	int	21h
  1873 00000BAC 72DF                <1> 	jc	short lff16s_7 ; error !
  1874                              <1> 
  1875 00000BAE 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1876                              <1> 	
  1877 00000BB0 D1E8                <1> 	shr	ax, 1
  1878                              <1> 	;and	ax, ax
  1879 00000BB2 7503                <1> 	jnz	short lff16s_8
  1880                              <1> 	;jmp	lff16s_3
  1881                              <1> 	; 15/11/2023
  1882 00000BB4 E9FFFC              <1> 	jmp	lff16_eof
  1883                              <1> 
  1884                              <1> lff16s_8:
  1885 00000BB7 89C1                <1> 	mov	cx, ax		; word count
  1886                              <1> lff16s_1:
  1887 00000BB9 AC                  <1> 	lodsb
  1888 00000BBA A2[0E19]            <1> 	mov	[previous_val_l], al
  1889 00000BBD 2C80                <1> 	sub	al, 80h
  1890 00000BBF C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1891 00000BC2 AB                  <1> 	stosw		; original sample (L)
  1892 00000BC3 AC                  <1> 	lodsb
  1893 00000BC4 A2[1019]            <1> 	mov	[previous_val_r], al
  1894 00000BC7 2C80                <1> 	sub	al, 80h
  1895 00000BC9 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1896 00000BCC AB                  <1> 	stosw		; original sample (R)
  1897                              <1> 
  1898                              <1> 	;xor	ax, ax
  1899                              <1> 	; 14/11/2023
  1900 00000BCD B88080              <1> 	mov	ax, 8080h
  1901 00000BD0 49                  <1> 	dec	cx
  1902 00000BD1 7402                <1> 	jz	short lff16s_2
  1903                              <1> 		; convert 8 bit sample to 16 bit sample
  1904 00000BD3 8B04                <1> 	mov	ax, [si]
  1905                              <1> lff16s_2:
  1906                              <1> 	;mov	[next_val_l], al
  1907                              <1> 	;mov	[next_val_r], ah
  1908 00000BD5 89C3                <1> 	mov	bx, ax
  1909 00000BD7 0206[0E19]          <1> 	add	al, [previous_val_l]
  1910 00000BDB D0D8                <1> 	rcr	al, 1
  1911 00000BDD 88C2                <1> 	mov	dl, al	; this is temporary interpolation value (L)
  1912 00000BDF 0206[0E19]          <1> 	add	al, [previous_val_l]
  1913 00000BE3 D0D8                <1> 	rcr	al, 1
  1914 00000BE5 2C80                <1> 	sub	al, 80h
  1915 00000BE7 C1E008              <1> 	shl	ax, 8
  1916 00000BEA AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1917 00000BEB 88F8                <1> 	mov	al, bh	; [next_val_r]
  1918 00000BED 0206[1019]          <1> 	add	al, [previous_val_r]
  1919 00000BF1 D0D8                <1> 	rcr	al, 1
  1920 00000BF3 88C6                <1> 	mov	dh, al	; this is temporary interpolation value (R)
  1921 00000BF5 0206[1019]          <1> 	add	al, [previous_val_r]
  1922 00000BF9 D0D8                <1> 	rcr	al, 1
  1923 00000BFB 2C80                <1> 	sub	al, 80h
  1924 00000BFD C1E008              <1> 	shl	ax, 8
  1925 00000C00 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1926 00000C01 88D0                <1> 	mov	al, dl
  1927 00000C03 00D8                <1> 	add	al, bl	; [next_val_l]
  1928 00000C05 D0D8                <1> 	rcr	al, 1
  1929 00000C07 2C80                <1> 	sub	al, 80h
  1930 00000C09 C1E008              <1> 	shl	ax, 8
  1931 00000C0C AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1932 00000C0D 88F0                <1> 	mov	al, dh
  1933 00000C0F 00F8                <1> 	add	al, bh	; [next_val_r]
  1934 00000C11 D0D8                <1> 	rcr	al, 1
  1935 00000C13 2C80                <1> 	sub	al, 80h
  1936 00000C15 C1E008              <1> 	shl	ax, 8
  1937 00000C18 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1938                              <1> 	
  1939                              <1> 	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1940 00000C19 09C9                <1> 	or	cx, cx
  1941 00000C1B 759C                <1> 	jnz	short lff16s_1
  1942 00000C1D E983FC              <1> 	jmp	lff16s_3
  1943                              <1> 
  1944                              <1> load_16khz_mono_16_bit:
  1945                              <1> 	; 15/11/2023
  1946                              <1> 	; 13/11/2023
  1947 00000C20 F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1948                              <1> 					; last of the file?
  1949 00000C25 7402                <1> 	jz	short lff16m2_0		; no
  1950 00000C27 F9                  <1> 	stc
  1951 00000C28 C3                  <1> 	retn
  1952                              <1> 
  1953                              <1> lff16m2_0:
  1954 00000C29 8EC0                <1> 	mov	es, ax ; buffer segment	
  1955 00000C2B 31FF                <1> 	xor	di, di
  1956 00000C2D BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1957                              <1> 	; ds = cs
  1958                              <1> 
  1959                              <1> 	; load file into memory
  1960 00000C30 8B0E[3806]          <1>         mov	cx, [loadsize]
  1961 00000C34 8B1E[021D]          <1> 	mov	bx, [filehandle]
  1962 00000C38 B43F                <1>        	mov	ah, 3Fh
  1963 00000C3A CD21                <1> 	int	21h
  1964 00000C3C 7240                <1> 	jc	short lff16m2_7 ; error !
  1965                              <1> 
  1966 00000C3E 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1967                              <1> 	
  1968 00000C40 D1E8                <1> 	shr	ax, 1
  1969                              <1> 	;and	ax, ax
  1970 00000C42 7503                <1> 	jnz	short lff16m2_8
  1971                              <1> 	;jmp	lff16m2_3
  1972                              <1> 	; 15/11/2023
  1973 00000C44 E96FFC              <1> 	jmp	lff16_eof
  1974                              <1> 
  1975                              <1> lff16m2_8:
  1976 00000C47 89C1                <1> 	mov	cx, ax	; word count
  1977                              <1> lff16m2_1:
  1978 00000C49 AD                  <1> 	lodsw
  1979 00000C4A AB                  <1> 	stosw		; original sample (left channel)
  1980 00000C4B AB                  <1> 	stosw		; original sample (right channel)
  1981 00000C4C 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  1982                              <1> 	;mov	[previous_val], ax
  1983 00000C4F 89C3                <1> 	mov	bx, ax	
  1984 00000C51 31C0                <1> 	xor	ax, ax
  1985 00000C53 49                  <1> 	dec	cx
  1986 00000C54 7402                <1> 	jz	short lff16m2_2
  1987 00000C56 8B04                <1> 	mov	ax, [si]
  1988                              <1> lff16m2_2:
  1989 00000C58 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  1990 00000C5B 89C5                <1> 	mov	bp, ax	; [next_val]
  1991                              <1> 	;add	ax, [previous_val]
  1992 00000C5D 01D8                <1> 	add	ax, bx
  1993 00000C5F D1D8                <1> 	rcr	ax, 1
  1994 00000C61 89C2                <1> 	mov	dx, ax	; this is temporary interpolation value
  1995                              <1> 	;add	ax, [previous_val]
  1996 00000C63 01D8                <1> 	add	ax, bx
  1997 00000C65 D1D8                <1> 	rcr	ax, 1
  1998 00000C67 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  1999 00000C6A AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  2000 00000C6B AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  2001 00000C6C 89E8                <1> 	mov	ax, bp 
  2002 00000C6E 01D0                <1> 	add	ax, dx
  2003 00000C70 D1D8                <1> 	rcr	ax, 1
  2004 00000C72 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2005 00000C75 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  2006 00000C76 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  2007                              <1> 	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2008 00000C77 09C9                <1> 	or	cx, cx
  2009 00000C79 75CE                <1> 	jnz	short lff16m2_1
  2010 00000C7B E925FC              <1> 	jmp	lff16m2_3
  2011                              <1> 
  2012                              <1> lff16m2_7:
  2013                              <1> lff16s2_7:
  2014 00000C7E E93CFC              <1> 	jmp	lff16m2_5  ; error
  2015                              <1> 
  2016                              <1> load_16khz_stereo_16_bit:
  2017                              <1> 	; 16/11/2023
  2018                              <1> 	; 15/11/2023
  2019                              <1> 	; 13/11/2023
  2020 00000C81 F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2021                              <1> 					; last of the file?
  2022 00000C86 7402                <1> 	jz	short lff16s2_0		; no
  2023 00000C88 F9                  <1> 	stc
  2024 00000C89 C3                  <1> 	retn
  2025                              <1> 
  2026                              <1> lff16s2_0:
  2027 00000C8A 8EC0                <1> 	mov	es, ax ; buffer segment	
  2028 00000C8C 31FF                <1> 	xor	di, di
  2029 00000C8E BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2030                              <1> 	; ds = cs
  2031                              <1> 
  2032                              <1> 	; load file into memory
  2033 00000C91 8B0E[3806]          <1>         mov	cx, [loadsize]
  2034 00000C95 8B1E[021D]          <1> 	mov	bx, [filehandle]
  2035 00000C99 B43F                <1>        	mov	ah, 3Fh
  2036 00000C9B CD21                <1> 	int	21h
  2037 00000C9D 72DF                <1> 	jc	short lff16s2_7 ; error !
  2038                              <1> 
  2039 00000C9F 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2040                              <1> 	
  2041                              <1> 	;shr	ax, 1
  2042 00000CA1 C1E802              <1> 	shr	ax, 2	; 16/11/2023
  2043                              <1> 	;and	ax, ax
  2044 00000CA4 7503                <1> 	jnz	short lff16s2_8
  2045                              <1> 	;jmp	lff16s2_3
  2046                              <1> 	; 15/11/2023
  2047 00000CA6 E90DFC              <1> 	jmp	lff16_eof
  2048                              <1> 
  2049                              <1> lff16s2_8:
  2050 00000CA9 89C1                <1> 	mov	cx, ax		; dword count
  2051                              <1> lff16s2_1:
  2052 00000CAB AD                  <1> 	lodsw
  2053 00000CAC AB                  <1> 	stosw		; original sample (L)
  2054 00000CAD 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2055 00000CB0 A3[0E19]            <1> 	mov	[previous_val_l], ax
  2056 00000CB3 AD                  <1> 	lodsw
  2057 00000CB4 AB                  <1> 	stosw		; original sample (R)
  2058 00000CB5 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2059 00000CB8 A3[1019]            <1> 	mov	[previous_val_r], ax
  2060 00000CBB 31D2                <1> 	xor	dx, dx
  2061 00000CBD 31C0                <1> 	xor	ax, ax
  2062                              <1> 	; 16/11/2023
  2063 00000CBF 49                  <1> 	dec	cx
  2064 00000CC0 7405                <1> 	jz	short lff16s2_2
  2065 00000CC2 8B04                <1> 	mov	ax, [si]
  2066 00000CC4 8B5402              <1> 	mov	dx, [si+2]
  2067                              <1> lff16s2_2:
  2068 00000CC7 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2069                              <1> 	;mov	[next_val_l], ax
  2070 00000CCA 89C5                <1> 	mov	bp, ax
  2071 00000CCC 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format 
  2072 00000CCF 8916[1419]          <1> 	mov	[next_val_r], dx
  2073 00000CD3 0306[0E19]          <1> 	add	ax, [previous_val_l]
  2074 00000CD7 D1D8                <1> 	rcr	ax, 1
  2075 00000CD9 89C2                <1> 	mov	dx, ax	; this is temporary interpolation value (L)
  2076 00000CDB 0306[0E19]          <1> 	add	ax, [previous_val_l]
  2077 00000CDF D1D8                <1> 	rcr	ax, 1
  2078 00000CE1 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  2079 00000CE4 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  2080 00000CE5 A1[1419]            <1> 	mov	ax, [next_val_r]
  2081 00000CE8 0306[1019]          <1> 	add	ax, [previous_val_r]
  2082 00000CEC D1D8                <1> 	rcr	ax, 1
  2083 00000CEE 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value (R)
  2084 00000CF0 0306[1019]          <1> 	add	ax, [previous_val_r]
  2085 00000CF4 D1D8                <1> 	rcr	ax, 1
  2086 00000CF6 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2087 00000CF9 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  2088                              <1> 	;mov	ax, [next_val_l]
  2089 00000CFA 89E8                <1> 	mov	ax, bp
  2090 00000CFC 01D0                <1> 	add	ax, dx
  2091 00000CFE D1D8                <1> 	rcr	ax, 1
  2092 00000D00 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2093 00000D03 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  2094 00000D04 A1[1419]            <1> 	mov	ax, [next_val_r]
  2095 00000D07 01D8                <1> 	add	ax, bx
  2096 00000D09 D1D8                <1> 	rcr	ax, 1
  2097 00000D0B 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2098 00000D0E AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  2099                              <1> 	
  2100                              <1> 	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2101 00000D0F 09C9                <1> 	or	cx, cx
  2102 00000D11 7598                <1> 	jnz	short lff16s2_1
  2103 00000D13 E98DFB              <1> 	jmp	lff16s2_3
  2104                              <1> 
  2105                              <1> ; .....................
  2106                              <1> 
  2107                              <1> load_24khz_mono_8_bit:
  2108                              <1> 	; 15/11/2023
  2109 00000D16 F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2110                              <1> 					; last of the file?
  2111 00000D1B 7402                <1> 	jz	short lff24m_0		; no
  2112 00000D1D F9                  <1> 	stc
  2113 00000D1E C3                  <1> 	retn
  2114                              <1> 
  2115                              <1> lff24m_0:
  2116 00000D1F 8EC0                <1> 	mov	es, ax ; buffer segment	
  2117 00000D21 31FF                <1> 	xor	di, di
  2118 00000D23 BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2119                              <1> 	; ds = cs
  2120                              <1> 
  2121                              <1> 	; load file into memory
  2122 00000D26 8B0E[3806]          <1>         mov	cx, [loadsize]
  2123 00000D2A 8B1E[021D]          <1> 	mov	bx, [filehandle]
  2124 00000D2E B43F                <1>        	mov	ah, 3Fh
  2125 00000D30 CD21                <1> 	int	21h
  2126 00000D32 722E                <1> 	jc	short lff24m_7 ; error !
  2127                              <1> 
  2128 00000D34 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2129                              <1> 	
  2130 00000D36 21C0                <1> 	and	ax, ax
  2131 00000D38 7503                <1> 	jnz	short lff24m_8
  2132 00000D3A E979FB              <1> 	jmp	lff24_eof
  2133                              <1> 
  2134                              <1> lff24m_8:
  2135 00000D3D 89C1                <1> 	mov	cx, ax		; byte count
  2136                              <1> lff24m_1:
  2137 00000D3F AC                  <1> 	lodsb
  2138                              <1> 	;mov	[previous_val], al
  2139 00000D40 88C3                <1> 	mov	bl, al
  2140 00000D42 2C80                <1> 	sub	al, 80h
  2141 00000D44 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2142 00000D47 AB                  <1> 	stosw		; original sample (left channel)
  2143 00000D48 AB                  <1> 	stosw		; original sample (right channel)
  2144                              <1> 	;xor	ax, ax
  2145 00000D49 B080                <1> 	mov	al, 80h
  2146 00000D4B 49                  <1> 	dec	cx
  2147 00000D4C 7402                <1> 	jz	short lff24m_2
  2148 00000D4E 8A04                <1> 	mov	al, [si]
  2149                              <1> lff24m_2:
  2150                              <1> 	;;mov	[next_val], al
  2151                              <1> 	;mov	bh, al
  2152                              <1> 	;add	al, [previous_val]
  2153 00000D50 00D8                <1> 	add	al, bl
  2154 00000D52 D0D8                <1> 	rcr	al, 1
  2155 00000D54 2C80                <1> 	sub	al, 80h
  2156 00000D56 C1E008              <1> 	shl	ax, 8
  2157 00000D59 AB                  <1> 	stosw		; this is interpolated sample (L)
  2158 00000D5A AB                  <1> 	stosw		; this is interpolated sample (R)
  2159                              <1> 	
  2160                              <1> 	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2161 00000D5B 09C9                <1> 	or	cx, cx
  2162 00000D5D 75E0                <1> 	jnz	short lff24m_1
  2163 00000D5F E941FB              <1> 	jmp	lff24_3
  2164                              <1> 
  2165                              <1> lff24m_7:
  2166                              <1> lff24s_7:
  2167 00000D62 E958FB              <1> 	jmp	lff24_5  ; error
  2168                              <1> 
  2169                              <1> load_24khz_stereo_8_bit:
  2170                              <1> 	; 15/11/2023
  2171 00000D65 F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2172                              <1> 					; last of the file?
  2173 00000D6A 7402                <1> 	jz	short lff24s_0		; no
  2174 00000D6C F9                  <1> 	stc
  2175 00000D6D C3                  <1> 	retn
  2176                              <1> 
  2177                              <1> lff24s_0:
  2178 00000D6E 8EC0                <1> 	mov	es, ax ; buffer segment	
  2179 00000D70 31FF                <1> 	xor	di, di
  2180 00000D72 BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2181                              <1> 	; ds = cs
  2182                              <1> 
  2183                              <1> 	; load file into memory
  2184 00000D75 8B0E[3806]          <1>         mov	cx, [loadsize]
  2185 00000D79 8B1E[021D]          <1> 	mov	bx, [filehandle]
  2186 00000D7D B43F                <1>        	mov	ah, 3Fh
  2187 00000D7F CD21                <1> 	int	21h
  2188 00000D81 72DF                <1> 	jc	short lff24s_7 ; error !
  2189                              <1> 
  2190 00000D83 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2191                              <1> 	
  2192 00000D85 D1E8                <1> 	shr	ax, 1
  2193                              <1> 	;and	ax, ax
  2194 00000D87 7503                <1> 	jnz	short lff24s_8
  2195 00000D89 E92AFB              <1> 	jmp	lff24_eof
  2196                              <1> 
  2197                              <1> lff24s_8:
  2198 00000D8C 89C1                <1> 	mov	cx, ax		; word count
  2199                              <1> lff24s_1:
  2200 00000D8E AC                  <1> 	lodsb
  2201 00000D8F A2[0E19]            <1> 	mov	[previous_val_l], al
  2202 00000D92 2C80                <1> 	sub	al, 80h
  2203 00000D94 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2204 00000D97 AB                  <1> 	stosw		; original sample (L)
  2205 00000D98 AC                  <1> 	lodsb
  2206 00000D99 A2[1019]            <1> 	mov	[previous_val_r], al
  2207 00000D9C 2C80                <1> 	sub	al, 80h
  2208 00000D9E C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2209 00000DA1 AB                  <1> 	stosw		; original sample (R)
  2210                              <1> 
  2211                              <1> 	;xor	ax, ax
  2212 00000DA2 B88080              <1> 	mov	ax, 8080h
  2213 00000DA5 49                  <1> 	dec	cx
  2214 00000DA6 7402                <1> 	jz	short lff24s_2
  2215                              <1> 		; convert 8 bit sample to 16 bit sample
  2216 00000DA8 8B04                <1> 	mov	ax, [si]
  2217                              <1> lff24s_2:
  2218                              <1> 	;;mov	[next_val_l], al
  2219                              <1> 	;;mov	[next_val_r], ah
  2220                              <1> 	;mov	bx, ax
  2221 00000DAA 88E7                <1> 	mov	bh, ah
  2222 00000DAC 0206[0E19]          <1> 	add	al, [previous_val_l]
  2223 00000DB0 D0D8                <1> 	rcr	al, 1
  2224                              <1> 	;mov	dl, al
  2225 00000DB2 2C80                <1> 	sub	al, 80h
  2226 00000DB4 C1E008              <1> 	shl	ax, 8
  2227 00000DB7 AB                  <1> 	stosw		; this is interpolated sample (L)
  2228 00000DB8 88F8                <1> 	mov	al, bh	; [next_val_r]
  2229 00000DBA 0206[1019]          <1> 	add	al, [previous_val_r]
  2230 00000DBE D0D8                <1> 	rcr	al, 1
  2231                              <1> 	;mov	dh, al
  2232 00000DC0 2C80                <1> 	sub	al, 80h
  2233 00000DC2 C1E008              <1> 	shl	ax, 8
  2234 00000DC5 AB                  <1> 	stosw		; this is interpolated sample (R)
  2235                              <1> 		
  2236                              <1> 	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2237 00000DC6 09C9                <1> 	or	cx, cx
  2238 00000DC8 75C4                <1> 	jnz	short lff24s_1
  2239 00000DCA E9D6FA              <1> 	jmp	lff24_3
  2240                              <1> 
  2241                              <1> load_24khz_mono_16_bit:
  2242                              <1> 	; 15/11/2023
  2243 00000DCD F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2244                              <1> 					; last of the file?
  2245 00000DD2 7402                <1> 	jz	short lff24m2_0		; no
  2246 00000DD4 F9                  <1> 	stc
  2247 00000DD5 C3                  <1> 	retn
  2248                              <1> 
  2249                              <1> lff24m2_0:
  2250 00000DD6 8EC0                <1> 	mov	es, ax ; buffer segment	
  2251 00000DD8 31FF                <1> 	xor	di, di
  2252 00000DDA BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2253                              <1> 	; ds = cs
  2254                              <1> 
  2255                              <1> 	; load file into memory
  2256 00000DDD 8B0E[3806]          <1>         mov	cx, [loadsize]
  2257 00000DE1 8B1E[021D]          <1> 	mov	bx, [filehandle]
  2258 00000DE5 B43F                <1>        	mov	ah, 3Fh
  2259 00000DE7 CD21                <1> 	int	21h
  2260 00000DE9 7228                <1> 	jc	short lff24m2_7 ; error !
  2261                              <1> 
  2262 00000DEB 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2263                              <1> 	
  2264 00000DED D1E8                <1> 	shr	ax, 1
  2265                              <1> 	;and	ax, ax
  2266 00000DEF 7503                <1> 	jnz	short lff24m2_8
  2267 00000DF1 E9C2FA              <1> 	jmp	lff24_eof
  2268                              <1> 
  2269                              <1> lff24m2_8:
  2270 00000DF4 89C1                <1> 	mov	cx, ax	; word count
  2271                              <1> lff24m2_1:
  2272 00000DF6 AD                  <1> 	lodsw
  2273 00000DF7 AB                  <1> 	stosw		; original sample (left channel)
  2274 00000DF8 AB                  <1> 	stosw		; original sample (right channel)
  2275 00000DF9 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  2276                              <1> 	;mov	[previous_val], ax
  2277                              <1> 	;mov	bx, ax	
  2278                              <1> 	;xor	ax, ax
  2279 00000DFC 31DB                <1> 	xor	bx, bx
  2280 00000DFE 49                  <1> 	dec	cx
  2281 00000DFF 7402                <1> 	jz	short lff24m2_2
  2282                              <1> 	;mov	ax, [si
  2283 00000E01 8B1C                <1> 	mov	bx, [si]
  2284                              <1> lff24m2_2:
  2285                              <1> 	;add	ah, 80h ; convert sound level 0 to 65535 format
  2286                              <1> 	;mov	bp, ax	; [next_val]
  2287                              <1> 	;add	ax, [previous_val]
  2288                              <1> 	; ax = [previous_val]
  2289                              <1> 	; bx = [next_val]
  2290 00000E03 01D8                <1> 	add	ax, bx
  2291 00000E05 D1D8                <1> 	rcr	ax, 1
  2292 00000E07 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2293 00000E0A AB                  <1> 	stosw		; this is interpolated sample (L)
  2294 00000E0B AB                  <1> 	stosw		; this is interpolated sample (R)
  2295                              <1> 	; 24 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2296 00000E0C 09C9                <1> 	or	cx, cx
  2297 00000E0E 75E6                <1> 	jnz	short lff24m2_1
  2298 00000E10 E990FA              <1> 	jmp	lff24_3
  2299                              <1> 
  2300                              <1> lff24m2_7:
  2301                              <1> lff24s2_7:
  2302 00000E13 E9A7FA              <1> 	jmp	lff24_5  ; error
  2303                              <1> 
  2304                              <1> load_24khz_stereo_16_bit:
  2305                              <1> 	; 16/11/2023
  2306                              <1> 	; 15/11/2023
  2307 00000E16 F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2308                              <1> 					; last of the file?
  2309 00000E1B 7402                <1> 	jz	short lff24s2_0		; no
  2310 00000E1D F9                  <1> 	stc
  2311 00000E1E C3                  <1> 	retn
  2312                              <1> 
  2313                              <1> lff24s2_0:
  2314 00000E1F 8EC0                <1> 	mov	es, ax ; buffer segment	
  2315 00000E21 31FF                <1> 	xor	di, di
  2316 00000E23 BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2317                              <1> 	; ds = cs
  2318                              <1> 
  2319                              <1> 	; load file into memory
  2320 00000E26 8B0E[3806]          <1>         mov	cx, [loadsize]
  2321 00000E2A 8B1E[021D]          <1> 	mov	bx, [filehandle]
  2322 00000E2E B43F                <1>        	mov	ah, 3Fh
  2323 00000E30 CD21                <1> 	int	21h
  2324 00000E32 72DF                <1> 	jc	short lff24s2_7 ; error !
  2325                              <1> 
  2326 00000E34 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2327                              <1> 	
  2328                              <1> 	;shr	ax, 1
  2329 00000E36 C1E802              <1> 	shr	ax, 2	; 16/11/2023
  2330                              <1> 	;and	ax, ax
  2331 00000E39 7503                <1> 	jnz	short lff24s2_8
  2332 00000E3B E978FA              <1> 	jmp	lff24_eof
  2333                              <1> 
  2334                              <1> lff24s2_8:
  2335 00000E3E 89C1                <1> 	mov	cx, ax		; dword count
  2336                              <1> lff24s2_1:
  2337 00000E40 AD                  <1> 	lodsw
  2338 00000E41 AB                  <1> 	stosw		; original sample (L)
  2339 00000E42 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2340 00000E45 A3[0E19]            <1> 	mov	[previous_val_l], ax
  2341 00000E48 AD                  <1> 	lodsw
  2342 00000E49 AB                  <1> 	stosw		; original sample (R)
  2343 00000E4A 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2344                              <1> 	;mov	[previous_val_r], ax
  2345 00000E4D 89C3                <1> 	mov	bx, ax
  2346 00000E4F 31D2                <1> 	xor	dx, dx
  2347 00000E51 31C0                <1> 	xor	ax, ax
  2348                              <1> 	; 16/11/2023
  2349 00000E53 49                  <1> 	dec	cx
  2350 00000E54 7405                <1> 	jz	short lff24s2_2
  2351 00000E56 8B04                <1> 	mov	ax, [si]
  2352 00000E58 8B5402              <1> 	mov	dx, [si+2]
  2353                              <1> lff24s2_2:
  2354 00000E5B 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2355                              <1> 	;;mov	[next_val_l], ax
  2356                              <1> 	;mov	bp, ax
  2357 00000E5E 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format 
  2358                              <1> 	;mov	[next_val_r], dx
  2359 00000E61 0306[0E19]          <1> 	add	ax, [previous_val_l]
  2360 00000E65 D1D8                <1> 	rcr	ax, 1
  2361 00000E67 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  2362 00000E6A AB                  <1> 	stosw		; this is interpolated sample (L)
  2363                              <1> 	;mov	ax, [next_val_r]
  2364 00000E6B 89D0                <1> 	mov	ax, dx
  2365                              <1> 	;add	ax, [previous_val_r]
  2366 00000E6D 01D8                <1> 	add	ax, bx
  2367 00000E6F D1D8                <1> 	rcr	ax, 1
  2368 00000E71 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2369 00000E74 AB                  <1> 	stosw		; this is interpolated sample (R)
  2370                              <1> 	
  2371                              <1> 	; 24 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2372 00000E75 09C9                <1> 	or	cx, cx
  2373 00000E77 75C7                <1> 	jnz	short lff24s2_1
  2374 00000E79 E927FA              <1> 	jmp	lff24_3
  2375                              <1> 
  2376                              <1> ; .....................
  2377                              <1> 
  2378                              <1> load_32khz_mono_8_bit:
  2379                              <1> 	; 15/11/2023
  2380 00000E7C F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2381                              <1> 					; last of the file?
  2382 00000E81 7402                <1> 	jz	short lff32m_0		; no
  2383 00000E83 F9                  <1> 	stc
  2384 00000E84 C3                  <1> 	retn
  2385                              <1> 
  2386                              <1> lff32m_0:
  2387 00000E85 8EC0                <1> 	mov	es, ax ; buffer segment	
  2388 00000E87 31FF                <1> 	xor	di, di
  2389 00000E89 BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2390                              <1> 	; ds = cs
  2391                              <1> 
  2392                              <1> 	; load file into memory
  2393 00000E8C 8B0E[3806]          <1>         mov	cx, [loadsize]
  2394 00000E90 8B1E[021D]          <1> 	mov	bx, [filehandle]
  2395 00000E94 B43F                <1>        	mov	ah, 3Fh
  2396 00000E96 CD21                <1> 	int	21h
  2397 00000E98 7237                <1> 	jc	short lff32m_7 ; error !
  2398                              <1> 
  2399 00000E9A 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2400                              <1> 	
  2401 00000E9C 21C0                <1> 	and	ax, ax
  2402 00000E9E 7503                <1> 	jnz	short lff32m_8
  2403 00000EA0 E913FA              <1> 	jmp	lff32_eof
  2404                              <1> 
  2405                              <1> lff32m_8:
  2406 00000EA3 89C1                <1> 	mov	cx, ax		; byte count
  2407                              <1> lff32m_1:
  2408 00000EA5 AC                  <1> 	lodsb
  2409                              <1> 	;mov	[previous_val], al
  2410 00000EA6 88C3                <1> 	mov	bl, al
  2411 00000EA8 2C80                <1> 	sub	al, 80h
  2412 00000EAA C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2413 00000EAD AB                  <1> 	stosw		; original sample (left channel)
  2414 00000EAE AB                  <1> 	stosw		; original sample (right channel)
  2415                              <1> 	;xor	ax, ax
  2416 00000EAF B080                <1> 	mov	al, 80h
  2417 00000EB1 49                  <1> 	dec	cx
  2418 00000EB2 7402                <1> 	jz	short lff32m_2
  2419 00000EB4 8A04                <1> 	mov	al, [si]
  2420                              <1> lff32m_2:
  2421                              <1> 	;;mov	[next_val], al
  2422                              <1> 	;mov	bh, al
  2423                              <1> 	;add	al, [previous_val]
  2424 00000EB6 00D8                <1> 	add	al, bl
  2425 00000EB8 D0D8                <1> 	rcr	al, 1
  2426 00000EBA 2C80                <1> 	sub	al, 80h
  2427 00000EBC C1E008              <1> 	shl	ax, 8
  2428 00000EBF AB                  <1> 	stosw		; this is interpolated sample (L)
  2429 00000EC0 AB                  <1> 	stosw		; this is interpolated sample (R)
  2430                              <1> 	
  2431                              <1> 	; different than 8-16-24 kHZ !
  2432                              <1> 	; 'original-interpolated-original' trio samples 
  2433 00000EC1 E30B                <1> 	jcxz	lff32m_3
  2434                              <1> 
  2435 00000EC3 AC                  <1> 	lodsb
  2436 00000EC4 2C80                <1> 	sub	al, 80h
  2437 00000EC6 C1E008              <1> 	shl	ax, 8
  2438 00000EC9 AB                  <1> 	stosw		; original sample (left channel)
  2439 00000ECA AB                  <1> 	stosw		; original sample (right channel)
  2440                              <1> 
  2441                              <1> 	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2442 00000ECB 49                  <1> 	dec	cx
  2443 00000ECC 75D7                <1> 	jnz	short lff32m_1
  2444                              <1> lff32m_3:
  2445 00000ECE E9D2F9              <1> 	jmp	lff32_3
  2446                              <1> 
  2447                              <1> lff32m_7:
  2448                              <1> lff32s_7:
  2449 00000ED1 E9E9F9              <1> 	jmp	lff32_5  ; error
  2450                              <1> 
  2451                              <1> load_32khz_stereo_8_bit:
  2452                              <1> 	; 15/11/2023
  2453 00000ED4 F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2454                              <1> 					; last of the file?
  2455 00000ED9 7402                <1> 	jz	short lff32s_0		; no
  2456 00000EDB F9                  <1> 	stc
  2457 00000EDC C3                  <1> 	retn
  2458                              <1> 
  2459                              <1> lff32s_0:
  2460 00000EDD 8EC0                <1> 	mov	es, ax ; buffer segment	
  2461 00000EDF 31FF                <1> 	xor	di, di
  2462 00000EE1 BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2463                              <1> 	; ds = cs
  2464                              <1> 
  2465                              <1> 	; load file into memory
  2466 00000EE4 8B0E[3806]          <1>         mov	cx, [loadsize]
  2467 00000EE8 8B1E[021D]          <1> 	mov	bx, [filehandle]
  2468 00000EEC B43F                <1>        	mov	ah, 3Fh
  2469 00000EEE CD21                <1> 	int	21h
  2470 00000EF0 72DF                <1> 	jc	short lff32s_7 ; error !
  2471                              <1> 
  2472 00000EF2 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2473                              <1> 	
  2474 00000EF4 D1E8                <1> 	shr	ax, 1
  2475                              <1> 	;and	ax, ax
  2476 00000EF6 7503                <1> 	jnz	short lff32s_8
  2477 00000EF8 E9BBF9              <1> 	jmp	lff32_eof
  2478                              <1> 
  2479                              <1> lff32s_8:
  2480 00000EFB 89C1                <1> 	mov	cx, ax		; word count
  2481                              <1> lff32s_1:
  2482 00000EFD AC                  <1> 	lodsb
  2483 00000EFE A2[0E19]            <1> 	mov	[previous_val_l], al
  2484 00000F01 2C80                <1> 	sub	al, 80h
  2485 00000F03 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2486 00000F06 AB                  <1> 	stosw		; original sample (L)
  2487 00000F07 AC                  <1> 	lodsb
  2488 00000F08 A2[1019]            <1> 	mov	[previous_val_r], al
  2489 00000F0B 2C80                <1> 	sub	al, 80h
  2490 00000F0D C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  2491 00000F10 AB                  <1> 	stosw		; original sample (R)
  2492                              <1> 
  2493                              <1> 	;xor	ax, ax
  2494 00000F11 B88080              <1> 	mov	ax, 8080h
  2495 00000F14 49                  <1> 	dec	cx
  2496 00000F15 7402                <1> 	jz	short lff32s_2
  2497                              <1> 		; convert 8 bit sample to 16 bit sample
  2498 00000F17 8B04                <1> 	mov	ax, [si]
  2499                              <1> lff32s_2:
  2500                              <1> 	;;mov	[next_val_l], al
  2501                              <1> 	;;mov	[next_val_r], ah
  2502                              <1> 	;mov	bx, ax
  2503 00000F19 88E7                <1> 	mov	bh, ah
  2504 00000F1B 0206[0E19]          <1> 	add	al, [previous_val_l]
  2505 00000F1F D0D8                <1> 	rcr	al, 1
  2506                              <1> 	;mov	dl, al
  2507 00000F21 2C80                <1> 	sub	al, 80h
  2508 00000F23 C1E008              <1> 	shl	ax, 8
  2509 00000F26 AB                  <1> 	stosw		; this is interpolated sample (L)
  2510 00000F27 88F8                <1> 	mov	al, bh	; [next_val_r]
  2511 00000F29 0206[1019]          <1> 	add	al, [previous_val_r]
  2512 00000F2D D0D8                <1> 	rcr	al, 1
  2513                              <1> 	;mov	dh, al
  2514 00000F2F 2C80                <1> 	sub	al, 80h
  2515 00000F31 C1E008              <1> 	shl	ax, 8
  2516 00000F34 AB                  <1> 	stosw		; this is interpolated sample (R)
  2517                              <1> 
  2518                              <1> 	; different than 8-16-24 kHZ !
  2519                              <1> 	; 'original-interpolated-original' trio samples 
  2520 00000F35 E311                <1> 	jcxz	lff32s_3
  2521                              <1> 
  2522 00000F37 AC                  <1> 	lodsb
  2523 00000F38 2C80                <1> 	sub	al, 80h
  2524 00000F3A C1E008              <1> 	shl	ax, 8
  2525 00000F3D AB                  <1> 	stosw		; original sample (left channel)
  2526                              <1> 
  2527 00000F3E AC                  <1> 	lodsb
  2528 00000F3F 2C80                <1> 	sub	al, 80h
  2529 00000F41 C1E008              <1> 	shl	ax, 8
  2530 00000F44 AB                  <1> 	stosw		; original sample (right channel)
  2531                              <1> 		
  2532                              <1> 	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2533 00000F45 49                  <1> 	dec	cx
  2534 00000F46 75B5                <1> 	jnz	short lff32s_1
  2535                              <1> lff32s_3:
  2536 00000F48 E958F9              <1> 	jmp	lff32_3
  2537                              <1> 
  2538                              <1> load_32khz_mono_16_bit:
  2539                              <1> 	; 15/11/2023
  2540 00000F4B F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2541                              <1> 					; last of the file?
  2542 00000F50 7402                <1> 	jz	short lff32m2_0		; no
  2543 00000F52 F9                  <1> 	stc
  2544 00000F53 C3                  <1> 	retn
  2545                              <1> 
  2546                              <1> lff32m2_0:
  2547 00000F54 8EC0                <1> 	mov	es, ax ; buffer segment	
  2548 00000F56 31FF                <1> 	xor	di, di
  2549 00000F58 BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2550                              <1> 	; ds = cs
  2551                              <1> 
  2552                              <1> 	; load file into memory
  2553 00000F5B 8B0E[3806]          <1>         mov	cx, [loadsize]
  2554 00000F5F 8B1E[021D]          <1> 	mov	bx, [filehandle]
  2555 00000F63 B43F                <1>        	mov	ah, 3Fh
  2556 00000F65 CD21                <1> 	int	21h
  2557 00000F67 722C                <1> 	jc	short lff32m2_7 ; error !
  2558                              <1> 
  2559 00000F69 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2560                              <1> 	
  2561 00000F6B D1E8                <1> 	shr	ax, 1
  2562                              <1> 	;and	ax, ax
  2563 00000F6D 7503                <1> 	jnz	short lff32m2_8
  2564 00000F6F E944F9              <1> 	jmp	lff32_eof
  2565                              <1> 
  2566                              <1> lff32m2_8:
  2567 00000F72 89C1                <1> 	mov	cx, ax	; word count
  2568                              <1> lff32m2_1:
  2569 00000F74 AD                  <1> 	lodsw
  2570 00000F75 AB                  <1> 	stosw		; original sample (left channel)
  2571 00000F76 AB                  <1> 	stosw		; original sample (right channel)
  2572 00000F77 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  2573                              <1> 	;mov	[previous_val], ax
  2574                              <1> 	;mov	bx, ax	
  2575                              <1> 	;xor	ax, ax
  2576 00000F7A 31DB                <1> 	xor	bx, bx
  2577 00000F7C 49                  <1> 	dec	cx
  2578 00000F7D 7402                <1> 	jz	short lff32m2_2
  2579                              <1> 	;mov	ax, [si
  2580 00000F7F 8B1C                <1> 	mov	bx, [si]
  2581                              <1> lff32m2_2:
  2582                              <1> 	;add	ah, 80h ; convert sound level 0 to 65535 format
  2583                              <1> 	;mov	bp, ax	; [next_val]
  2584                              <1> 	;add	ax, [previous_val]
  2585                              <1> 	; ax = [previous_val]
  2586                              <1> 	; bx = [next_val]
  2587 00000F81 01D8                <1> 	add	ax, bx
  2588 00000F83 D1D8                <1> 	rcr	ax, 1
  2589 00000F85 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2590 00000F88 AB                  <1> 	stosw		; this is interpolated sample (L)
  2591 00000F89 AB                  <1> 	stosw		; this is interpolated sample (R)
  2592                              <1> 
  2593                              <1> 	; different than 8-16-24 kHZ !
  2594                              <1> 	; 'original-interpolated-original' trio samples 
  2595 00000F8A E306                <1> 	jcxz	lff32m2_3
  2596                              <1> 
  2597 00000F8C AD                  <1> 	lodsw
  2598 00000F8D AB                  <1> 	stosw		; original sample (left channel)
  2599 00000F8E AB                  <1> 	stosw		; original sample (right channel)
  2600                              <1> 
  2601                              <1> 	; 32 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  2602 00000F8F 49                  <1> 	dec	cx
  2603 00000F90 75E2                <1> 	jnz	short lff32m2_1
  2604                              <1> lff32m2_3:
  2605 00000F92 E90EF9              <1> 	jmp	lff32_3
  2606                              <1> 
  2607                              <1> lff32m2_7:
  2608                              <1> lff32s2_7:
  2609 00000F95 E925F9              <1> 	jmp	lff32_5  ; error
  2610                              <1> 
  2611                              <1> load_32khz_stereo_16_bit:
  2612                              <1> 	 ;16/11/2023
  2613                              <1> 	; 15/11/2023
  2614 00000F98 F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2615                              <1> 					; last of the file?
  2616 00000F9D 7402                <1> 	jz	short lff32s2_0		; no
  2617 00000F9F F9                  <1> 	stc
  2618 00000FA0 C3                  <1> 	retn
  2619                              <1> 
  2620                              <1> lff32s2_0:
  2621 00000FA1 8EC0                <1> 	mov	es, ax ; buffer segment	
  2622 00000FA3 31FF                <1> 	xor	di, di
  2623 00000FA5 BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2624                              <1> 	; ds = cs
  2625                              <1> 
  2626                              <1> 	; load file into memory
  2627 00000FA8 8B0E[3806]          <1>         mov	cx, [loadsize]
  2628 00000FAC 8B1E[021D]          <1> 	mov	bx, [filehandle]
  2629 00000FB0 B43F                <1>        	mov	ah, 3Fh
  2630 00000FB2 CD21                <1> 	int	21h
  2631 00000FB4 72DF                <1> 	jc	short lff32s2_7 ; error !
  2632                              <1> 
  2633 00000FB6 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2634                              <1> 	
  2635 00000FB8 C1E802              <1> 	shr	ax, 2	; 16/11/2023 (word left ch + word right ch) 
  2636                              <1> 	;and	ax, ax
  2637 00000FBB 7503                <1> 	jnz	short lff32s2_8
  2638 00000FBD E9F6F8              <1> 	jmp	lff32_eof
  2639                              <1> 
  2640                              <1> lff32s2_8:
  2641 00000FC0 89C1                <1> 	mov	cx, ax		; dword count
  2642                              <1> lff32s2_1:
  2643 00000FC2 AD                  <1> 	lodsw
  2644 00000FC3 AB                  <1> 	stosw		; original sample (L)
  2645 00000FC4 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2646 00000FC7 A3[0E19]            <1> 	mov	[previous_val_l], ax
  2647 00000FCA AD                  <1> 	lodsw
  2648 00000FCB AB                  <1> 	stosw		; original sample (R)
  2649 00000FCC 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2650                              <1> 	;mov	[previous_val_r], ax
  2651 00000FCF 89C3                <1> 	mov	bx, ax
  2652 00000FD1 31D2                <1> 	xor	dx, dx
  2653 00000FD3 31C0                <1> 	xor	ax, ax
  2654                              <1> 	; 16/11/2023
  2655 00000FD5 49                  <1> 	dec	cx
  2656 00000FD6 7405                <1> 	jz	short lff32s2_2
  2657 00000FD8 8B04                <1> 	mov	ax, [si]
  2658 00000FDA 8B5402              <1> 	mov	dx, [si+2]
  2659                              <1> lff32s2_2:
  2660 00000FDD 80C480              <1> 	add	ah, 80h	; convert sound level 0 to 65535 format 
  2661                              <1> 	;;mov	[next_val_l], ax
  2662                              <1> 	;mov	bp, ax
  2663 00000FE0 80C680              <1> 	add	dh, 80h	; convert sound level 0 to 65535 format 
  2664                              <1> 	;mov	[next_val_r], dx
  2665 00000FE3 0306[0E19]          <1> 	add	ax, [previous_val_l]
  2666 00000FE7 D1D8                <1> 	rcr	ax, 1
  2667 00000FE9 80EC80              <1> 	sub	ah, 80h ; -32768 to +32767 format again
  2668 00000FEC AB                  <1> 	stosw		; this is interpolated sample (L)
  2669                              <1> 	;mov	ax, [next_val_r]
  2670 00000FED 89D0                <1> 	mov	ax, dx
  2671                              <1> 	;add	ax, [previous_val_r]
  2672 00000FEF 01D8                <1> 	add	ax, bx
  2673 00000FF1 D1D8                <1> 	rcr	ax, 1
  2674 00000FF3 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  2675 00000FF6 AB                  <1> 	stosw		; this is interpolated sample (R)
  2676                              <1> 
  2677                              <1> 	; different than 8-16-24 kHZ !
  2678                              <1> 	; 'original-interpolated-original' trio samples 
  2679 00000FF7 E307                <1> 	jcxz	lff32s2_3
  2680                              <1> 
  2681 00000FF9 AD                  <1> 	lodsw
  2682 00000FFA AB                  <1> 	stosw	; original sample (L)
  2683 00000FFB AD                  <1> 	lodsw
  2684 00000FFC AB                  <1> 	stosw	; original sample (R)
  2685                              <1> 	
  2686                              <1> 	; 32 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  2687 00000FFD 49                  <1> 	dec	cx
  2688 00000FFE 75C2                <1> 	jnz	short lff32s2_1
  2689                              <1> lff32s2_3:
  2690 00001000 E9A0F8              <1> 	jmp	lff32_3
  2691                              <1> 
  2692                              <1> ; .....................
  2693                              <1> 
  2694                              <1> load_22khz_mono_8_bit:
  2695                              <1> 	; 16/11/2023
  2696 00001003 F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2697                              <1> 					; last of the file?
  2698 00001008 7402                <1> 	jz	short lff22m_0		; no
  2699 0000100A F9                  <1> 	stc
  2700 0000100B C3                  <1> 	retn
  2701                              <1> 
  2702                              <1> lff22m_0:
  2703 0000100C 8EC0                <1> 	mov	es, ax ; buffer segment	
  2704 0000100E 31FF                <1> 	xor	di, di
  2705 00001010 BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2706                              <1> 	; ds = cs
  2707                              <1> 
  2708                              <1> 	; load file into memory
  2709 00001013 8B0E[3806]          <1>         mov	cx, [loadsize]
  2710 00001017 8B1E[021D]          <1> 	mov	bx, [filehandle]
  2711 0000101B B43F                <1>        	mov	ah, 3Fh
  2712 0000101D CD21                <1> 	int	21h
  2713 0000101F 7248                <1> 	jc	short lff22m_7 ; error !
  2714                              <1> 
  2715 00001021 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2716                              <1> 	
  2717 00001023 21C0                <1> 	and	ax, ax
  2718 00001025 7503                <1> 	jnz	short lff22m_8
  2719 00001027 E98CF8              <1> 	jmp	lff22_eof
  2720                              <1> 
  2721                              <1> lff22m_8:
  2722 0000102A 89C1                <1> 	mov	cx, ax		; byte count
  2723                              <1> lff22m_9:
  2724 0000102C BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2725 0000102F C606[1619]03        <1> 	mov	byte [faz], 3  ; 3 steps/phases
  2726                              <1> lff22m_1:
  2727                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2728 00001034 AC                  <1> 	lodsb
  2729 00001035 B280                <1> 	mov	dl, 80h
  2730 00001037 49                  <1> 	dec	cx
  2731 00001038 7402                <1> 	jz	short lff22m_2_1
  2732 0000103A 8A14                <1> 	mov	dl, [si]
  2733                              <1> lff22m_2_1:	
  2734                              <1> 	; al = [previous_val]
  2735                              <1> 	; dl = [next_val]
  2736 0000103C E8A004              <1> 	call	interpolating_3_8bit_mono ; 1 of 17
  2737 0000103F E325                <1> 	jcxz	lff22m_3
  2738                              <1> lff22m_2_2:
  2739 00001041 AC                  <1> 	lodsb
  2740 00001042 B280                <1> 	mov	dl, 80h
  2741 00001044 49                  <1> 	dec	cx
  2742 00001045 7402                <1> 	jz	short lff22m_2_3
  2743 00001047 8A14                <1> 	mov	dl, [si]
  2744                              <1> lff22m_2_3:
  2745 00001049 E80205              <1>  	call	interpolating_2_8bit_mono ; 2 of 17 .. 6 of 17
  2746 0000104C E318                <1> 	jcxz	lff22m_3
  2747 0000104E 4D                  <1> 	dec	bp
  2748 0000104F 75F0                <1> 	jnz	short lff22m_2_2
  2749                              <1> 
  2750 00001051 A0[1619]            <1> 	mov	al, [faz]
  2751 00001054 FEC8                <1> 	dec	al
  2752 00001056 74D4                <1> 	jz	short lff22m_9
  2753 00001058 FE0E[1619]          <1> 	dec	byte [faz]
  2754 0000105C BD0400              <1> 	mov	bp, 4
  2755 0000105F FEC8                <1> 	dec	al
  2756 00001061 75D1                <1> 	jnz	short lff22m_1 ; 3:2:2:2:2 ; 7-11 of 17
  2757 00001063 45                  <1> 	inc	bp ; 5
  2758 00001064 EBCE                <1> 	jmp	short lff22m_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2759                              <1> 
  2760                              <1> lff22m_3:
  2761                              <1> lff22s_3:
  2762 00001066 E93AF8              <1> 	jmp	lff22_3	; padfill
  2763                              <1> 		; (put zeros in the remain words of the buffer)
  2764                              <1> lff22m_7:
  2765                              <1> lff22s_7:
  2766 00001069 E951F8              <1> 	jmp	lff22_5  ; error
  2767                              <1> 
  2768                              <1> load_22khz_stereo_8_bit:
  2769                              <1> 	; 16/11/2023
  2770 0000106C F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2771                              <1> 					; last of the file?
  2772 00001071 7402                <1> 	jz	short lff22s_0		; no
  2773 00001073 F9                  <1> 	stc
  2774 00001074 C3                  <1> 	retn
  2775                              <1> 
  2776                              <1> lff22s_0:
  2777 00001075 8EC0                <1> 	mov	es, ax ; buffer segment	
  2778 00001077 31FF                <1> 	xor	di, di
  2779 00001079 BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2780                              <1> 	; ds = cs
  2781                              <1> 
  2782                              <1> 	; load file into memory
  2783 0000107C 8B0E[3806]          <1>         mov	cx, [loadsize]
  2784 00001080 8B1E[021D]          <1> 	mov	bx, [filehandle]
  2785 00001084 B43F                <1>        	mov	ah, 3Fh
  2786 00001086 CD21                <1> 	int	21h
  2787 00001088 72DF                <1> 	jc	short lff22s_7 ; error !
  2788                              <1> 
  2789 0000108A 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2790                              <1> 	
  2791 0000108C D1E8                <1> 	shr	ax, 1
  2792                              <1> 	;and	ax, ax
  2793 0000108E 7503                <1> 	jnz	short lff22s_8
  2794 00001090 E923F8              <1> 	jmp	lff22_eof
  2795                              <1> 
  2796                              <1> lff22s_8:
  2797 00001093 89C1                <1> 	mov	cx, ax		; word count
  2798                              <1> lff22s_9:
  2799 00001095 BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2800 00001098 C606[1619]03        <1> 	mov	byte [faz], 3  ; 3 steps/phase
  2801                              <1> lff22s_1:
  2802                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2803 0000109D AD                  <1> 	lodsw
  2804 0000109E BA8080              <1> 	mov	dx, 8080h
  2805 000010A1 49                  <1> 	dec	cx
  2806 000010A2 7402                <1> 	jz	short lff22s_2_1 
  2807 000010A4 8B14                <1> 	mov	dx, [si]
  2808                              <1> lff22s_2_1:	
  2809                              <1> 	; al = [previous_val_l]
  2810                              <1> 	; ah = [previous_val_r]
  2811                              <1> 	; dl = [next_val_l]
  2812                              <1> 	; dl = [next_val_r]	
  2813 000010A6 E85E04              <1> 	call	interpolating_3_8bit_stereo ; 1 of 17 
  2814 000010A9 E3BB                <1> 	jcxz	lff22s_3
  2815                              <1> lff22s_2_2:
  2816 000010AB AD                  <1> 	lodsw
  2817 000010AC BA8080              <1> 	mov	dx, 8080h
  2818 000010AF 49                  <1> 	dec	cx
  2819 000010B0 7402                <1> 	jz	short lff22s_2_3
  2820 000010B2 8B14                <1> 	mov	dx, [si]
  2821                              <1> lff22s_2_3:
  2822 000010B4 E8AE04              <1>  	call	interpolating_2_8bit_stereo ; 2 of 17 .. 6 of 17
  2823 000010B7 E3AD                <1> 	jcxz	lff22s_3
  2824 000010B9 4D                  <1> 	dec	bp
  2825 000010BA 75EF                <1> 	jnz	short lff22s_2_2
  2826                              <1> 
  2827 000010BC A0[1619]            <1> 	mov	al, [faz]
  2828 000010BF FEC8                <1> 	dec	al
  2829 000010C1 74D2                <1> 	jz	short lff22s_9
  2830 000010C3 FE0E[1619]          <1> 	dec	byte [faz]
  2831 000010C7 BD0400              <1> 	mov	bp, 4
  2832 000010CA FEC8                <1> 	dec	al
  2833 000010CC 75CF                <1> 	jnz	short lff22s_1 ; 3:2:2:2:2 ; 7-11 of 17
  2834 000010CE 45                  <1> 	inc	bp ; 5
  2835 000010CF EBCC                <1> 	jmp	short lff22s_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2836                              <1> 
  2837                              <1> load_22khz_mono_16_bit:
  2838                              <1> 	; 16/11/2023
  2839 000010D1 F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2840                              <1> 					; last of the file?
  2841 000010D6 7402                <1> 	jz	short lff22m2_0		; no
  2842 000010D8 F9                  <1> 	stc
  2843 000010D9 C3                  <1> 	retn
  2844                              <1> 
  2845                              <1> lff22m2_0:
  2846 000010DA 8EC0                <1> 	mov	es, ax ; buffer segment	
  2847 000010DC 31FF                <1> 	xor	di, di
  2848 000010DE BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2849                              <1> 	; ds = cs
  2850                              <1> 
  2851                              <1> 	; load file into memory
  2852 000010E1 8B0E[3806]          <1>         mov	cx, [loadsize]
  2853 000010E5 8B1E[021D]          <1> 	mov	bx, [filehandle]
  2854 000010E9 B43F                <1>        	mov	ah, 3Fh
  2855 000010EB CD21                <1> 	int	21h
  2856 000010ED 7248                <1> 	jc	short lff22m2_7 ; error !
  2857                              <1> 
  2858 000010EF 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2859                              <1> 	
  2860 000010F1 D1E8                <1> 	shr	ax, 1
  2861                              <1> 	;and	ax, ax
  2862 000010F3 7503                <1> 	jnz	short lff22m2_8
  2863 000010F5 E9BEF7              <1> 	jmp	lff22_eof
  2864                              <1> 
  2865                              <1> lff22m2_8:
  2866 000010F8 89C1                <1> 	mov	cx, ax		; word count
  2867                              <1> lff22m2_9:
  2868 000010FA BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2869 000010FD C606[1619]03        <1> 	mov	byte [faz], 3  ; 3 steps/phases
  2870                              <1> lff22m2_1:
  2871                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2872 00001102 AD                  <1> 	lodsw
  2873 00001103 31D2                <1> 	xor	dx, dx
  2874 00001105 49                  <1> 	dec	cx
  2875 00001106 7402                <1> 	jz	short lff22m2_2_1
  2876 00001108 8B14                <1> 	mov	dx, [si]
  2877                              <1> lff22m2_2_1:	
  2878                              <1> 	; ax = [previous_val]
  2879                              <1> 	; dx = [next_val]
  2880 0000110A E88104              <1> 	call	interpolating_3_16bit_mono ; 1 of 17
  2881 0000110D E325                <1> 	jcxz	lff22m2_3
  2882                              <1> lff22m2_2_2:
  2883 0000110F AD                  <1> 	lodsw
  2884 00001110 31D2                <1> 	xor	dx, dx
  2885 00001112 49                  <1> 	dec	cx
  2886 00001113 7402                <1> 	jz	short lff22m2_2_3
  2887 00001115 8B14                <1> 	mov	dx, [si]
  2888                              <1> lff22m2_2_3:
  2889 00001117 E8E104              <1>  	call	interpolating_2_16bit_mono ; 2 of 17 .. 6 of 17
  2890 0000111A E318                <1> 	jcxz	lff22m2_3
  2891 0000111C 4D                  <1> 	dec	bp
  2892 0000111D 75F0                <1> 	jnz	short lff22m2_2_2
  2893                              <1> 
  2894 0000111F A0[1619]            <1> 	mov	al, [faz]
  2895 00001122 FEC8                <1> 	dec	al
  2896 00001124 74D4                <1> 	jz	short lff22m2_9
  2897 00001126 FE0E[1619]          <1> 	dec	byte [faz]
  2898 0000112A BD0400              <1> 	mov	bp, 4
  2899 0000112D FEC8                <1> 	dec	al
  2900 0000112F 75D1                <1> 	jnz	short lff22m2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2901 00001131 45                  <1> 	inc	bp ; 5
  2902 00001132 EBCE                <1> 	jmp	short lff22m2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2903                              <1> 
  2904                              <1> lff22m2_3:
  2905                              <1> lff22s2_3:
  2906 00001134 E96CF7              <1> 	jmp	lff22_3	; padfill
  2907                              <1> 		; (put zeros in the remain words of the buffer)
  2908                              <1> lff22m2_7:
  2909                              <1> lff22s2_7:
  2910 00001137 E983F7              <1> 	jmp	lff22_5  ; error
  2911                              <1> 
  2912                              <1> load_22khz_stereo_16_bit:
  2913                              <1> 	; 16/11/2023
  2914 0000113A F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2915                              <1> 					; last of the file?
  2916 0000113F 7402                <1> 	jz	short lff22s2_0		; no
  2917 00001141 F9                  <1> 	stc
  2918 00001142 C3                  <1> 	retn
  2919                              <1> 
  2920                              <1> lff22s2_0:
  2921 00001143 8EC0                <1> 	mov	es, ax ; buffer segment	
  2922 00001145 31FF                <1> 	xor	di, di
  2923 00001147 BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  2924                              <1> 	; ds = cs
  2925                              <1> 
  2926                              <1> 	; load file into memory
  2927 0000114A 8B0E[3806]          <1>         mov	cx, [loadsize]
  2928 0000114E 8B1E[021D]          <1> 	mov	bx, [filehandle]
  2929 00001152 B43F                <1>        	mov	ah, 3Fh
  2930 00001154 CD21                <1> 	int	21h
  2931 00001156 72DF                <1> 	jc	short lff22s2_7 ; error !
  2932                              <1> 
  2933 00001158 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  2934                              <1> 	
  2935 0000115A C1E802              <1> 	shr	ax, 2	; dword (left chan word + right chan word)
  2936                              <1> 	;and	ax, ax
  2937 0000115D 7503                <1> 	jnz	short lff22s2_8
  2938 0000115F E954F7              <1> 	jmp	lff22_eof
  2939                              <1> 
  2940                              <1> lff22s2_8:
  2941 00001162 89C1                <1> 	mov	cx, ax		; dword count
  2942                              <1> lff22s2_9:
  2943 00001164 BD0500              <1> 	mov	bp, 5 ; interpolation (one step) loop count
  2944 00001167 C606[1619]03        <1> 	mov	byte [faz], 3  ; 3 steps/phase
  2945                              <1> lff22s2_1:
  2946                              <1> 	; 3:2:2:2:2:2::3:2:2:2:2::3:2:2:2:2:2  ; 37/17
  2947 0000116C AD                  <1> 	lodsw
  2948 0000116D 89C3                <1> 	mov	bx, ax
  2949 0000116F AD                  <1> 	lodsw
  2950 00001170 8B14                <1> 	mov	dx, [si]
  2951 00001172 8916[1219]          <1> 	mov	[next_val_l], dx
  2952 00001176 8B5402              <1> 	mov	dx, [si+2]
  2953 00001179 49                  <1> 	dec	cx
  2954 0000117A 7506                <1> 	jnz	short lff22s2_2_1
  2955 0000117C 31D2                <1> 	xor	dx, dx ; 0
  2956 0000117E 8916[1219]          <1> 	mov	[next_val_l], dx
  2957                              <1> lff22s2_2_1:
  2958                              <1> 	; bx = [previous_val_l]
  2959                              <1> 	; ax = [previous_val_r]
  2960                              <1> 	; [next_val_l]
  2961                              <1> 	; dx = [next_val_r]
  2962 00001182 E82D04              <1> 	call	interpolating_3_16bit_stereo ; 1 of 17 
  2963 00001185 E3AD                <1> 	jcxz	lff22s2_3
  2964                              <1> lff22s2_2_2:
  2965 00001187 AD                  <1> 	lodsw
  2966 00001188 89C3                <1> 	mov	bx, ax
  2967 0000118A AD                  <1> 	lodsw
  2968 0000118B 8B14                <1> 	mov	dx, [si]
  2969 0000118D 8916[1219]          <1> 	mov	[next_val_l], dx
  2970 00001191 8B5402              <1> 	mov	dx, [si+2]
  2971 00001194 49                  <1> 	dec	cx
  2972 00001195 7506                <1> 	jnz	short lff22s2_2_3
  2973 00001197 31D2                <1> 	xor	dx, dx ; 0
  2974 00001199 8916[1219]          <1> 	mov	[next_val_l], dx
  2975                              <1> lff22s2_2_3:
  2976 0000119D E86D04              <1>  	call	interpolating_2_16bit_stereo ; 2 of 17 .. 6 of 17
  2977 000011A0 E392                <1> 	jcxz	lff22s2_3
  2978 000011A2 4D                  <1> 	dec	bp
  2979 000011A3 75E2                <1> 	jnz	short lff22s2_2_2
  2980                              <1> 
  2981 000011A5 A0[1619]            <1> 	mov	al, [faz]
  2982 000011A8 FEC8                <1> 	dec	al
  2983 000011AA 74B8                <1> 	jz	short lff22s2_9
  2984 000011AC FE0E[1619]          <1> 	dec	byte [faz]
  2985 000011B0 BD0400              <1> 	mov	bp, 4
  2986 000011B3 FEC8                <1> 	dec	al
  2987 000011B5 75B5                <1> 	jnz	short lff22s2_1 ; 3:2:2:2:2 ; 7-11 of 17
  2988 000011B7 45                  <1> 	inc	bp ; 5
  2989 000011B8 EBB2                <1> 	jmp	short lff22s2_1 ; 3:2:2:2:2:2 ; 12-17 of 17
  2990                              <1> 
  2991                              <1> ; .....................
  2992                              <1> 
  2993                              <1> load_11khz_mono_8_bit:
  2994                              <1> 	; 18/11/2023
  2995 000011BA F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  2996                              <1> 					; last of the file?
  2997 000011BF 7402                <1> 	jz	short lff11m_0		; no
  2998 000011C1 F9                  <1> 	stc
  2999 000011C2 C3                  <1> 	retn
  3000                              <1> 
  3001                              <1> lff11m_0:
  3002 000011C3 8EC0                <1> 	mov	es, ax ; buffer segment	
  3003 000011C5 31FF                <1> 	xor	di, di
  3004 000011C7 BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3005                              <1> 	; ds = cs
  3006                              <1> 
  3007                              <1> 	; load file into memory
  3008 000011CA 8B0E[3806]          <1>         mov	cx, [loadsize]
  3009 000011CE 8B1E[021D]          <1> 	mov	bx, [filehandle]
  3010 000011D2 B43F                <1>        	mov	ah, 3Fh
  3011 000011D4 CD21                <1> 	int	21h
  3012 000011D6 723D                <1> 	jc	short lff11m_7 ; error !
  3013                              <1> 
  3014 000011D8 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3015                              <1> 	
  3016 000011DA 21C0                <1> 	and	ax, ax
  3017 000011DC 7503                <1> 	jnz	short lff11m_8
  3018 000011DE E9D5F6              <1> 	jmp	lff11_eof
  3019                              <1> 
  3020                              <1> lff11m_8:
  3021 000011E1 89C1                <1> 	mov	cx, ax		; byte count
  3022                              <1> lff11m_9:
  3023 000011E3 BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  3024                              <1> lff11m_1:
  3025                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3026 000011E6 AC                  <1> 	lodsb
  3027 000011E7 B280                <1> 	mov	dl, 80h
  3028 000011E9 49                  <1> 	dec	cx
  3029 000011EA 7402                <1> 	jz	short lff11m_2_1
  3030 000011EC 8A14                <1> 	mov	dl, [si]
  3031                              <1> lff11m_2_1:	
  3032                              <1> 	; al = [previous_val]
  3033                              <1> 	; dl = [next_val]
  3034 000011EE E84204              <1> 	call	interpolating_5_8bit_mono
  3035 000011F1 E31F                <1> 	jcxz	lff11m_3
  3036                              <1> lff11m_2_2:
  3037 000011F3 AC                  <1> 	lodsb
  3038 000011F4 B280                <1> 	mov	dl, 80h
  3039 000011F6 49                  <1> 	dec	cx
  3040 000011F7 7402                <1> 	jz	short lff11m_2_3
  3041 000011F9 8A14                <1> 	mov	dl, [si]
  3042                              <1> lff11m_2_3:
  3043 000011FB E81E05              <1>  	call	interpolating_4_8bit_mono
  3044 000011FE E312                <1> 	jcxz	lff11m_3
  3045                              <1> 
  3046 00001200 4D                  <1> 	dec	bp
  3047 00001201 74E0                <1> 	jz	short lff11m_9
  3048                              <1> 
  3049 00001203 AC                  <1> 	lodsb
  3050 00001204 B280                <1> 	mov	dl, 80h
  3051 00001206 49                  <1> 	dec	cx
  3052 00001207 7402                <1> 	jz	short lff11m_2_4
  3053 00001209 8A14                <1> 	mov	dl, [si]
  3054                              <1> lff11m_2_4:
  3055 0000120B E80E05              <1> 	call	interpolating_4_8bit_mono
  3056 0000120E E302                <1> 	jcxz	lff11m_3
  3057 00001210 EBD4                <1> 	jmp	short lff11m_1
  3058                              <1> 
  3059                              <1> lff11m_3:
  3060                              <1> lff11s_3:
  3061 00001212 E98EF6              <1> 	jmp	lff11_3	; padfill
  3062                              <1> 		; (put zeros in the remain words of the buffer)
  3063                              <1> lff11m_7:
  3064                              <1> lff11s_7:
  3065 00001215 E9A5F6              <1> 	jmp	lff11_5  ; error
  3066                              <1> 
  3067                              <1> load_11khz_stereo_8_bit:
  3068                              <1> 	; 18/11/2023
  3069 00001218 F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3070                              <1> 					; last of the file?
  3071 0000121D 7402                <1> 	jz	short lff11s_0		; no
  3072 0000121F F9                  <1> 	stc
  3073 00001220 C3                  <1> 	retn
  3074                              <1> 
  3075                              <1> lff11s_0:
  3076 00001221 8EC0                <1> 	mov	es, ax ; buffer segment	
  3077 00001223 31FF                <1> 	xor	di, di
  3078 00001225 BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3079                              <1> 	; ds = cs
  3080                              <1> 
  3081                              <1> 	; load file into memory
  3082 00001228 8B0E[3806]          <1>         mov	cx, [loadsize]
  3083 0000122C 8B1E[021D]          <1> 	mov	bx, [filehandle]
  3084 00001230 B43F                <1>        	mov	ah, 3Fh
  3085 00001232 CD21                <1> 	int	21h
  3086 00001234 72DF                <1> 	jc	short lff11s_7 ; error !
  3087                              <1> 
  3088 00001236 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3089                              <1> 	
  3090 00001238 D1E8                <1> 	shr	ax, 1
  3091                              <1> 	;and	ax, ax
  3092 0000123A 7503                <1> 	jnz	short lff11s_8
  3093 0000123C E977F6              <1> 	jmp	lff11_eof
  3094                              <1> 
  3095                              <1> lff11s_8:
  3096 0000123F 89C1                <1> 	mov	cx, ax		; word count
  3097                              <1> lff11s_9:
  3098 00001241 BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  3099                              <1> lff11s_1:
  3100                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3101 00001244 AD                  <1> 	lodsw
  3102 00001245 BA8080              <1> 	mov	dx, 8080h
  3103 00001248 49                  <1> 	dec	cx
  3104 00001249 7402                <1> 	jz	short lff11s_2_1 
  3105 0000124B 8B14                <1> 	mov	dx, [si]
  3106                              <1> lff11s_2_1:	
  3107                              <1> 	; al = [previous_val_l]
  3108                              <1> 	; ah = [previous_val_r]
  3109                              <1> 	; dl = [next_val_l]
  3110                              <1> 	; dl = [next_val_r]	
  3111 0000124D E83304              <1> 	call	interpolating_5_8bit_stereo
  3112 00001250 E3C0                <1> 	jcxz	lff11s_3
  3113                              <1> lff11s_2_2:
  3114 00001252 AD                  <1> 	lodsw
  3115 00001253 BA8080              <1> 	mov	dx, 8080h
  3116 00001256 49                  <1> 	dec	cx
  3117 00001257 7402                <1> 	jz	short lff11s_2_3
  3118 00001259 8B14                <1> 	mov	dx, [si]
  3119                              <1> lff11s_2_3:
  3120 0000125B E8F104              <1>  	call	interpolating_4_8bit_stereo
  3121 0000125E E3B2                <1> 	jcxz	lff11s_3
  3122                              <1> 	
  3123 00001260 4D                  <1> 	dec	bp
  3124 00001261 74DE                <1> 	jz	short lff11s_9
  3125                              <1> 
  3126 00001263 AD                  <1> 	lodsw
  3127 00001264 BA8080              <1> 	mov	dx, 8080h
  3128 00001267 49                  <1> 	dec	cx
  3129 00001268 7402                <1> 	jz	short lff11s_2_4
  3130 0000126A 8B14                <1> 	mov	dx, [si]
  3131                              <1> lff11s_2_4:
  3132 0000126C E8E004              <1> 	call	interpolating_4_8bit_stereo
  3133 0000126F E3A1                <1> 	jcxz	lff11s_3
  3134 00001271 EBD1                <1> 	jmp	short lff11s_1
  3135                              <1> 
  3136                              <1> load_11khz_mono_16_bit:
  3137                              <1> 	; 18/11/2023
  3138 00001273 F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3139                              <1> 					; last of the file?
  3140 00001278 7402                <1> 	jz	short lff11m2_0		; no
  3141 0000127A F9                  <1> 	stc
  3142 0000127B C3                  <1> 	retn
  3143                              <1> 
  3144                              <1> lff11m2_0:
  3145 0000127C 8EC0                <1> 	mov	es, ax ; buffer segment	
  3146 0000127E 31FF                <1> 	xor	di, di
  3147 00001280 BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3148                              <1> 	; ds = cs
  3149                              <1> 
  3150                              <1> 	; load file into memory
  3151 00001283 8B0E[3806]          <1>         mov	cx, [loadsize]
  3152 00001287 8B1E[021D]          <1> 	mov	bx, [filehandle]
  3153 0000128B B43F                <1>        	mov	ah, 3Fh
  3154 0000128D CD21                <1> 	int	21h
  3155 0000128F 723A                <1> 	jc	short lff11m2_7 ; error !
  3156                              <1> 
  3157 00001291 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3158                              <1> 	
  3159 00001293 D1E8                <1> 	shr	ax, 1
  3160                              <1> 	;and	ax, ax
  3161 00001295 7503                <1> 	jnz	short lff11m2_8
  3162 00001297 E91CF6              <1> 	jmp	lff11_eof
  3163                              <1> 
  3164                              <1> lff11m2_8:
  3165 0000129A 89C1                <1> 	mov	cx, ax		; word count
  3166                              <1> lff11m2_9:
  3167 0000129C BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  3168                              <1> lff11m2_1:
  3169                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3170 0000129F AD                  <1> 	lodsw
  3171 000012A0 31D2                <1> 	xor	dx, dx
  3172 000012A2 49                  <1> 	dec	cx
  3173 000012A3 7402                <1> 	jz	short lff11m2_2_1
  3174 000012A5 8B14                <1> 	mov	dx, [si]
  3175                              <1> lff11m2_2_1:	
  3176                              <1> 	; ax = [previous_val]
  3177                              <1> 	; dx = [next_val]
  3178 000012A7 E80205              <1> 	call	interpolating_5_16bit_mono
  3179 000012AA E34A                <1> 	jcxz	lff11m2_3
  3180                              <1> lff11m2_2_2:
  3181 000012AC AD                  <1> 	lodsw
  3182 000012AD 31D2                <1> 	xor	dx, dx
  3183 000012AF 49                  <1> 	dec	cx
  3184 000012B0 7402                <1> 	jz	short lff11m2_2_3
  3185 000012B2 8B14                <1> 	mov	dx, [si]
  3186                              <1> lff11m2_2_3:
  3187 000012B4 E8D005              <1>  	call	interpolating_4_16bit_mono
  3188 000012B7 E33D                <1> 	jcxz	lff11m2_3
  3189                              <1> 
  3190 000012B9 4D                  <1> 	dec	bp
  3191 000012BA 74E0                <1> 	jz	short lff11m2_9
  3192                              <1> 
  3193 000012BC AD                  <1> 	lodsw
  3194 000012BD 31D2                <1> 	xor	dx, dx
  3195 000012BF 49                  <1> 	dec	cx
  3196 000012C0 7402                <1> 	jz	short lff11m2_2_4
  3197 000012C2 8B14                <1> 	mov	dx, [si]
  3198                              <1> lff11m2_2_4:
  3199 000012C4 E8C005              <1>  	call	interpolating_4_16bit_mono
  3200 000012C7 E32D                <1> 	jcxz	lff11m2_3
  3201 000012C9 EBD4                <1> 	jmp	short lff11m2_1
  3202                              <1> 
  3203                              <1> lff11m2_7:
  3204                              <1> lff11s2_7:
  3205 000012CB E9EFF5              <1> 	jmp	lff11_5  ; error
  3206                              <1> 
  3207                              <1> load_11khz_stereo_16_bit:
  3208                              <1> 	; 18/11/2023
  3209 000012CE F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3210                              <1> 					; last of the file?
  3211 000012D3 7402                <1> 	jz	short lff11s2_0		; no
  3212 000012D5 F9                  <1> 	stc
  3213 000012D6 C3                  <1> 	retn
  3214                              <1> 
  3215                              <1> lff11s2_0:
  3216 000012D7 8EC0                <1> 	mov	es, ax ; buffer segment	
  3217 000012D9 31FF                <1> 	xor	di, di
  3218 000012DB BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3219                              <1> 	; ds = cs
  3220                              <1> 
  3221                              <1> 	; load file into memory
  3222 000012DE 8B0E[3806]          <1>         mov	cx, [loadsize]
  3223 000012E2 8B1E[021D]          <1> 	mov	bx, [filehandle]
  3224 000012E6 B43F                <1>        	mov	ah, 3Fh
  3225 000012E8 CD21                <1> 	int	21h
  3226 000012EA 72DF                <1> 	jc	short lff11s2_7 ; error !
  3227                              <1> 
  3228 000012EC 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3229                              <1> 	
  3230 000012EE C1E802              <1> 	shr	ax, 2	; dword (left chan word + right chan word)
  3231                              <1> 	;and	ax, ax
  3232 000012F1 7506                <1> 	jnz	short lff11s2_8
  3233 000012F3 E9C0F5              <1> 	jmp	lff11_eof
  3234                              <1> 
  3235                              <1> lff11m2_3:
  3236                              <1> lff11s2_3:
  3237 000012F6 E9AAF5              <1> 	jmp	lff11_3	; padfill
  3238                              <1> 		; (put zeros in the remain words of the buffer)
  3239                              <1> 
  3240                              <1> lff11s2_8:
  3241 000012F9 89C1                <1> 	mov	cx, ax		; dword count
  3242                              <1> lff11s2_9:
  3243 000012FB BD0600              <1> 	mov	bp, 6 ; interpolation (one step) loop count
  3244                              <1> lff11s2_1:
  3245                              <1> 	; 5:4:4::5:4:4::5:4:4::5:4:4::5:4:4::5:4  ; 74/17
  3246 000012FE AD                  <1> 	lodsw
  3247 000012FF 89C3                <1> 	mov	bx, ax
  3248 00001301 AD                  <1> 	lodsw
  3249 00001302 8B14                <1> 	mov	dx, [si]
  3250 00001304 8916[1219]          <1> 	mov	[next_val_l], dx
  3251 00001308 8B5402              <1> 	mov	dx, [si+2]
  3252 0000130B 8916[1419]          <1> 	mov	[next_val_r], dx
  3253 0000130F 49                  <1> 	dec	cx
  3254 00001310 750A                <1> 	jnz	short lff11s2_2_1
  3255 00001312 31D2                <1> 	xor	dx, dx ; 0
  3256 00001314 8916[1219]          <1> 	mov	[next_val_l], dx
  3257 00001318 8916[1419]          <1> 	mov	[next_val_r], dx
  3258                              <1> lff11s2_2_1:
  3259                              <1> 	; bx = [previous_val_l]
  3260                              <1> 	; ax = [previous_val_r]
  3261                              <1> 	; [next_val_l]
  3262                              <1> 	; dx = [next_val_r]
  3263 0000131C E8D004              <1> 	call	interpolating_5_16bit_stereo
  3264 0000131F E3D5                <1> 	jcxz	lff11s2_3
  3265                              <1> lff11s2_2_2:
  3266 00001321 AD                  <1> 	lodsw
  3267 00001322 89C3                <1> 	mov	bx, ax
  3268 00001324 AD                  <1> 	lodsw
  3269 00001325 8B14                <1> 	mov	dx, [si]
  3270 00001327 8916[1219]          <1> 	mov	[next_val_l], dx
  3271 0000132B 8B5402              <1> 	mov	dx, [si+2]
  3272 0000132E 8916[1419]          <1> 	mov	[next_val_r], dx
  3273 00001332 49                  <1> 	dec	cx
  3274 00001333 750A                <1> 	jnz	short lff11s2_2_3
  3275 00001335 31D2                <1> 	xor	dx, dx ; 0
  3276 00001337 8916[1219]          <1> 	mov	[next_val_l], dx
  3277 0000133B 8916[1419]          <1> 	mov	[next_val_r], dx
  3278                              <1> lff11s2_2_3:
  3279 0000133F E87005              <1>  	call	interpolating_4_16bit_stereo
  3280 00001342 E3B2                <1> 	jcxz	lff11s2_3
  3281                              <1> 	
  3282 00001344 4D                  <1> 	dec	bp
  3283 00001345 74B4                <1> 	jz	short lff11s2_9
  3284                              <1> 
  3285 00001347 AD                  <1> 	lodsw
  3286 00001348 89C3                <1> 	mov	bx, ax
  3287 0000134A AD                  <1> 	lodsw
  3288 0000134B 8B14                <1> 	mov	dx, [si]
  3289 0000134D 8916[1219]          <1> 	mov	[next_val_l], dx
  3290 00001351 8B5402              <1> 	mov	dx, [si+2]
  3291 00001354 8916[1419]          <1> 	mov	[next_val_r], dx
  3292 00001358 49                  <1> 	dec	cx
  3293 00001359 750A                <1> 	jnz	short lff11s2_2_4
  3294 0000135B 31D2                <1> 	xor	dx, dx ; 0
  3295 0000135D 8916[1219]          <1> 	mov	[next_val_l], dx
  3296 00001361 8916[1419]          <1> 	mov	[next_val_r], dx
  3297                              <1> lff11s2_2_4:
  3298 00001365 E84A05              <1>  	call	interpolating_4_16bit_stereo
  3299 00001368 E38C                <1> 	jcxz	lff11s2_3
  3300 0000136A EB92                <1> 	jmp	short lff11s2_1
  3301                              <1> 
  3302                              <1> ; .....................
  3303                              <1> 
  3304                              <1> load_44khz_mono_8_bit:
  3305                              <1> 	; 18/11/2023
  3306 0000136C F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3307                              <1> 					; last of the file?
  3308 00001371 7402                <1> 	jz	short lff44m_0		; no
  3309 00001373 F9                  <1> 	stc
  3310 00001374 C3                  <1> 	retn
  3311                              <1> 
  3312                              <1> lff44m_0:
  3313 00001375 8EC0                <1> 	mov	es, ax ; buffer segment	
  3314 00001377 31FF                <1> 	xor	di, di
  3315 00001379 BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3316                              <1> 	; ds = cs
  3317                              <1> 
  3318                              <1> 	; load file into memory
  3319 0000137C 8B0E[3806]          <1>         mov	cx, [loadsize]
  3320 00001380 8B1E[021D]          <1> 	mov	bx, [filehandle]
  3321 00001384 B43F                <1>        	mov	ah, 3Fh
  3322 00001386 CD21                <1> 	int	21h
  3323 00001388 723C                <1> 	jc	short lff44m_7 ; error !
  3324                              <1> 
  3325 0000138A 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3326                              <1> 	
  3327 0000138C 21C0                <1> 	and	ax, ax
  3328 0000138E 7503                <1> 	jnz	short lff44m_8
  3329 00001390 E923F5              <1> 	jmp	lff44_eof
  3330                              <1> 
  3331                              <1> lff44m_8:
  3332 00001393 89C1                <1> 	mov	cx, ax		; byte count
  3333                              <1> lff44m_9:
  3334 00001395 BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3335 00001398 C606[1619]02        <1> 	mov	byte [faz], 2  ; 2 steps/phases
  3336                              <1> lff44m_1:
  3337                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3338                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3339 0000139D AC                  <1> 	lodsb
  3340 0000139E B280                <1> 	mov	dl, 80h
  3341 000013A0 49                  <1> 	dec	cx
  3342 000013A1 7402                <1> 	jz	short lff44m_2_1
  3343 000013A3 8A14                <1> 	mov	dl, [si]
  3344                              <1> lff44m_2_1:	
  3345                              <1> 	; al = [previous_val]
  3346                              <1> 	; dl = [next_val]
  3347 000013A5 E8A601              <1> 	call	interpolating_2_8bit_mono
  3348 000013A8 E319                <1> 	jcxz	lff44m_3
  3349                              <1> lff44m_2_2:
  3350 000013AA AC                  <1> 	lodsb
  3351 000013AB 2C80                <1> 	sub	al, 80h
  3352 000013AD C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3353 000013B0 AB                  <1> 	stosw		; (L)
  3354 000013B1 AB                  <1> 	stosw		; (R)	
  3355                              <1> 
  3356 000013B2 49                  <1> 	dec	cx
  3357 000013B3 740E                <1> 	jz	short lff44m_3	
  3358 000013B5 4D                  <1> 	dec	bp
  3359 000013B6 75F2                <1> 	jnz	short lff44m_2_2
  3360                              <1> 	
  3361 000013B8 FE0E[1619]          <1> 	dec	byte [faz]
  3362 000013BC 74D7                <1> 	jz	short lff44m_9 
  3363 000013BE BD0B00              <1> 	mov	bp, 11
  3364 000013C1 EBDA                <1> 	jmp	short lff44m_1
  3365                              <1> 
  3366                              <1> lff44m_3:
  3367                              <1> lff44s_3:
  3368 000013C3 E9DDF4              <1> 	jmp	lff44_3	; padfill
  3369                              <1> 		; (put zeros in the remain words of the buffer)
  3370                              <1> lff44m_7:
  3371                              <1> lff44s_7:
  3372 000013C6 E9F4F4              <1> 	jmp	lff44_5  ; error
  3373                              <1> 
  3374                              <1> load_44khz_stereo_8_bit:
  3375                              <1> 	; 16/11/2023
  3376 000013C9 F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3377                              <1> 					; last of the file?
  3378 000013CE 7402                <1> 	jz	short lff44s_0		; no
  3379 000013D0 F9                  <1> 	stc
  3380 000013D1 C3                  <1> 	retn
  3381                              <1> 
  3382                              <1> lff44s_0:
  3383 000013D2 8EC0                <1> 	mov	es, ax ; buffer segment	
  3384 000013D4 31FF                <1> 	xor	di, di
  3385 000013D6 BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3386                              <1> 	; ds = cs
  3387                              <1> 
  3388                              <1> 	; load file into memory
  3389 000013D9 8B0E[3806]          <1>         mov	cx, [loadsize]
  3390 000013DD 8B1E[021D]          <1> 	mov	bx, [filehandle]
  3391 000013E1 B43F                <1>        	mov	ah, 3Fh
  3392 000013E3 CD21                <1> 	int	21h
  3393 000013E5 72DF                <1> 	jc	short lff44s_7 ; error !
  3394                              <1> 
  3395 000013E7 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3396                              <1> 	
  3397 000013E9 D1E8                <1> 	shr	ax, 1
  3398                              <1> 	;and	ax, ax
  3399 000013EB 7503                <1> 	jnz	short lff44s_8
  3400 000013ED E9C6F4              <1> 	jmp	lff44_eof
  3401                              <1> 
  3402                              <1> lff44s_8:
  3403 000013F0 89C1                <1> 	mov	cx, ax		; word count
  3404                              <1> lff44s_9:
  3405 000013F2 BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3406 000013F5 C606[1619]02        <1> 	mov	byte [faz], 2  ; 2 steps/phase
  3407                              <1> lff44s_1:
  3408                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3409                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3410 000013FA AD                  <1> 	lodsw
  3411 000013FB BA8080              <1> 	mov	dx, 8080h
  3412 000013FE 49                  <1> 	dec	cx
  3413 000013FF 7402                <1> 	jz	short lff44s_2_1 
  3414 00001401 8B14                <1> 	mov	dx, [si]
  3415                              <1> lff44s_2_1:	
  3416                              <1> 	; al = [previous_val_l]
  3417                              <1> 	; ah = [previous_val_r]
  3418                              <1> 	; dl = [next_val_l]
  3419                              <1> 	; dl = [next_val_r]	
  3420 00001403 E85F01              <1> 	call	interpolating_2_8bit_stereo
  3421 00001406 E3BB                <1> 	jcxz	lff44s_3
  3422                              <1> lff44s_2_2:
  3423 00001408 AC                  <1> 	lodsb
  3424 00001409 2C80                <1> 	sub	al, 80h
  3425 0000140B C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3426 0000140E AB                  <1> 	stosw		; (L)
  3427 0000140F AC                  <1> 	lodsb
  3428 00001410 2C80                <1> 	sub	al, 80h
  3429 00001412 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3430 00001415 AB                  <1> 	stosw		; (R)
  3431                              <1> 
  3432 00001416 49                  <1> 	dec	cx
  3433 00001417 74AA                <1> 	jz	short lff44s_3	
  3434 00001419 4D                  <1> 	dec	bp
  3435 0000141A 75EC                <1> 	jnz	short lff44s_2_2
  3436                              <1> 	
  3437 0000141C FE0E[1619]          <1> 	dec	byte [faz]
  3438 00001420 74D0                <1> 	jz	short lff44s_9 
  3439 00001422 BD0B00              <1> 	mov	bp, 11
  3440 00001425 EBD3                <1> 	jmp	short lff44s_1
  3441                              <1> 
  3442                              <1> load_44khz_mono_16_bit:
  3443                              <1> 	; 18/11/2023
  3444 00001427 F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3445                              <1> 					; last of the file?
  3446 0000142C 7402                <1> 	jz	short lff44m2_0		; no
  3447 0000142E F9                  <1> 	stc
  3448 0000142F C3                  <1> 	retn
  3449                              <1> 
  3450                              <1> lff44m2_0:
  3451 00001430 8EC0                <1> 	mov	es, ax ; buffer segment	
  3452 00001432 31FF                <1> 	xor	di, di
  3453 00001434 BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3454                              <1> 	; ds = cs
  3455                              <1> 
  3456                              <1> 	; load file into memory
  3457 00001437 8B0E[3806]          <1>         mov	cx, [loadsize]
  3458 0000143B 8B1E[021D]          <1> 	mov	bx, [filehandle]
  3459 0000143F B43F                <1>        	mov	ah, 3Fh
  3460 00001441 CD21                <1> 	int	21h
  3461 00001443 7237                <1> 	jc	short lff44m2_7 ; error !
  3462                              <1> 
  3463 00001445 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3464                              <1> 	
  3465 00001447 D1E8                <1> 	shr	ax, 1
  3466                              <1> 	;and	ax, ax
  3467 00001449 7503                <1> 	jnz	short lff44m2_8
  3468 0000144B E968F4              <1> 	jmp	lff44_eof
  3469                              <1> 
  3470                              <1> lff44m2_8:
  3471 0000144E 89C1                <1> 	mov	cx, ax		; word count
  3472                              <1> lff44m2_9:
  3473 00001450 BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3474 00001453 C606[1619]02        <1> 	mov	byte [faz], 2  ; 2 steps/phases
  3475                              <1> lff44m2_1:
  3476                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3477                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3478 00001458 AD                  <1> 	lodsw
  3479 00001459 31D2                <1> 	xor	dx, dx
  3480 0000145B 49                  <1> 	dec	cx
  3481 0000145C 7402                <1> 	jz	short lff44m2_2_1
  3482 0000145E 8B14                <1> 	mov	dx, [si]
  3483                              <1> lff44m2_2_1:	
  3484                              <1> 	; ax = [previous_val]
  3485                              <1> 	; dx = [next_val]
  3486 00001460 E89801              <1> 	call	interpolating_2_16bit_mono
  3487 00001463 E314                <1> 	jcxz	lff44m2_3
  3488                              <1> lff44m2_2_2:
  3489 00001465 AD                  <1> 	lodsw
  3490 00001466 AB                  <1> 	stosw		; (L)eft Channel
  3491 00001467 AB                  <1> 	stosw		; (R)ight Channel
  3492                              <1> 
  3493 00001468 49                  <1> 	dec	cx
  3494 00001469 740E                <1> 	jz	short lff44m2_3	
  3495 0000146B 4D                  <1> 	dec	bp
  3496 0000146C 75F7                <1> 	jnz	short lff44m2_2_2
  3497                              <1> 	
  3498 0000146E FE0E[1619]          <1> 	dec	byte [faz]
  3499 00001472 74DC                <1> 	jz	short lff44m2_9 
  3500 00001474 BD0B00              <1> 	mov	bp, 11
  3501 00001477 EBDF                <1> 	jmp	short lff44m2_1
  3502                              <1> 
  3503                              <1> lff44m2_3:
  3504                              <1> lff44s2_3:
  3505 00001479 E927F4              <1> 	jmp	lff44_3	; padfill
  3506                              <1> 		; (put zeros in the remain words of the buffer)
  3507                              <1> lff44m2_7:
  3508                              <1> lff44s2_7:
  3509 0000147C E93EF4              <1> 	jmp	lff44_5  ; error
  3510                              <1> 
  3511                              <1> load_44khz_stereo_16_bit:
  3512                              <1> 	; 18/11/2023
  3513 0000147F F606[041D]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  3514                              <1> 					; last of the file?
  3515 00001484 7402                <1> 	jz	short lff44s2_0		; no
  3516 00001486 F9                  <1> 	stc
  3517 00001487 C3                  <1> 	retn
  3518                              <1> 
  3519                              <1> lff44s2_0:
  3520 00001488 8EC0                <1> 	mov	es, ax ; buffer segment	
  3521 0000148A 31FF                <1> 	xor	di, di
  3522 0000148C BA[201D]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  3523                              <1> 	; ds = cs
  3524                              <1> 
  3525                              <1> 	; load file into memory
  3526 0000148F 8B0E[3806]          <1>         mov	cx, [loadsize]
  3527 00001493 8B1E[021D]          <1> 	mov	bx, [filehandle]
  3528 00001497 B43F                <1>        	mov	ah, 3Fh
  3529 00001499 CD21                <1> 	int	21h
  3530 0000149B 72DF                <1> 	jc	short lff44s2_7 ; error !
  3531                              <1> 
  3532 0000149D 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  3533                              <1> 	
  3534 0000149F C1E802              <1> 	shr	ax, 2	; dword (left chan word + right chan word)
  3535                              <1> 	;and	ax, ax
  3536 000014A2 7503                <1> 	jnz	short lff44s2_8
  3537 000014A4 E90FF4              <1> 	jmp	lff44_eof
  3538                              <1> 
  3539                              <1> lff44s2_8:
  3540 000014A7 89C1                <1> 	mov	cx, ax		; dword count
  3541                              <1> lff44s2_9:
  3542 000014A9 BD0A00              <1> 	mov	bp, 10 ; interpolation (one step) loop count
  3543 000014AC C606[1619]02        <1> 	mov	byte [faz], 2  ; 2 steps/phase
  3544                              <1> lff44s2_1:
  3545                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1::	; 25/23
  3546                              <1> 	; 2:1:1:1:1:1:1:1:1:1:1:1
  3547 000014B1 AD                  <1> 	lodsw
  3548 000014B2 89C3                <1> 	mov	bx, ax
  3549 000014B4 AD                  <1> 	lodsw
  3550 000014B5 8B14                <1> 	mov	dx, [si]
  3551 000014B7 8916[1219]          <1> 	mov	[next_val_l], dx
  3552 000014BB 8B5402              <1> 	mov	dx, [si+2]
  3553 000014BE 49                  <1> 	dec	cx
  3554 000014BF 7506                <1> 	jnz	short lff44s2_2_1
  3555 000014C1 31D2                <1> 	xor	dx, dx ; 0
  3556 000014C3 8916[1219]          <1> 	mov	[next_val_l], dx
  3557                              <1> lff44s2_2_1:
  3558                              <1> 	; bx = [previous_val_l]
  3559                              <1> 	; ax = [previous_val_r]
  3560                              <1> 	; [next_val_l]
  3561                              <1> 	; dx = [next_val_r]
  3562 000014C7 E84301              <1> 	call	interpolating_2_16bit_stereo
  3563 000014CA E3AD                <1> 	jcxz	lff44s2_3
  3564                              <1> lff44s2_2_2:
  3565                              <1> 	;lodsw
  3566                              <1> 	;stosw		; (L)
  3567                              <1> 	;lodsw
  3568                              <1> 	;stosw		; (R)
  3569 000014CC A5                  <1> 	movsw		; (L)eft Channel
  3570 000014CD A5                  <1> 	movsw		; (R)ight Channel
  3571                              <1> 
  3572 000014CE 49                  <1> 	dec	cx
  3573 000014CF 74A8                <1> 	jz	short lff44s2_3	
  3574 000014D1 4D                  <1> 	dec	bp
  3575 000014D2 75F8                <1> 	jnz	short lff44s2_2_2
  3576                              <1> 	
  3577 000014D4 FE0E[1619]          <1> 	dec	byte [faz]
  3578 000014D8 74CF                <1> 	jz	short lff44s2_9 
  3579 000014DA BD0B00              <1> 	mov	bp, 11
  3580 000014DD EBD2                <1> 	jmp	short lff44s2_1
  3581                              <1> 
  3582                              <1> ; .....................
  3583                              <1> 
  3584                              <1> interpolating_3_8bit_mono:
  3585                              <1> 	; 16/11/2023
  3586                              <1> 	; al = [previous_val]
  3587                              <1> 	; dl = [next_val]
  3588                              <1> 	; original-interpolated-interpolated
  3589 000014DF 88C3                <1> 	mov	bl, al
  3590 000014E1 2C80                <1> 	sub	al, 80h
  3591 000014E3 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3592 000014E6 AB                  <1> 	stosw		; original sample (L)
  3593 000014E7 AB                  <1> 	stosw		; original sample (R)
  3594 000014E8 88D8                <1> 	mov	al, bl
  3595 000014EA 00D0                <1> 	add	al, dl	
  3596 000014EC D0D8                <1> 	rcr	al, 1
  3597 000014EE 88C7                <1> 	mov	bh, al	; interpolated middle (temporary)
  3598 000014F0 00D8                <1> 	add	al, bl
  3599 000014F2 D0D8                <1> 	rcr	al, 1
  3600 000014F4 2C80                <1> 	sub	al, 80h
  3601 000014F6 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3602 000014F9 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3603 000014FA AB                  <1> 	stosw		; interpolated sample 1 (R)
  3604 000014FB 88F8                <1> 	mov	al, bh
  3605 000014FD 00D0                <1> 	add	al, dl	; [next_val]
  3606 000014FF D0D8                <1> 	rcr	al, 1
  3607 00001501 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3608 00001504 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3609 00001505 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3610 00001506 C3                  <1> 	retn
  3611                              <1> 
  3612                              <1> interpolating_3_8bit_stereo:
  3613                              <1> 	; 16/11/2023
  3614                              <1> 	; al = [previous_val_l]
  3615                              <1> 	; ah = [previous_val_r]
  3616                              <1> 	; dl = [next_val_l]
  3617                              <1> 	; dh = [next_val_r]	
  3618                              <1> 	; original-interpolated-interpolated
  3619 00001507 89C3                <1> 	mov	bx, ax
  3620 00001509 2C80                <1> 	sub	al, 80h
  3621 0000150B C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3622 0000150E AB                  <1> 	stosw		; original sample (L)
  3623 0000150F 88F8                <1> 	mov	al, bh
  3624 00001511 2C80                <1> 	sub	al, 80h
  3625 00001513 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3626 00001516 AB                  <1> 	stosw		; original sample (R)
  3627 00001517 88D8                <1> 	mov	al, bl
  3628 00001519 00D0                <1> 	add	al, dl	; [next_val_l]	
  3629 0000151B D0D8                <1> 	rcr	al, 1
  3630 0000151D 50                  <1> 	push	ax ; *	; al = interpolated middle (L) (temporary)
  3631 0000151E 00D8                <1> 	add	al, bl	; [previous_val_l]
  3632 00001520 D0D8                <1> 	rcr	al, 1
  3633 00001522 2C80                <1> 	sub	al, 80h
  3634 00001524 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3635 00001527 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3636 00001528 88F8                <1> 	mov	al, bh
  3637 0000152A 00F0                <1> 	add	al, dh	; [next_val_r]
  3638 0000152C D0D8                <1> 	rcr	al, 1
  3639 0000152E 50                  <1> 	push	ax ; ** ; al = interpolated middle (R) (temporary)
  3640 0000152F 00F8                <1> 	add	al, bh	; [previous_val_r]
  3641 00001531 D0D8                <1> 	rcr	al, 1
  3642 00001533 2C80                <1> 	sub	al, 80h
  3643 00001535 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3644 00001538 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3645 00001539 5B                  <1> 	pop	bx ; **
  3646 0000153A 58                  <1> 	pop	ax ; *
  3647 0000153B 00D0                <1> 	add	al, dl	; [next_val_l]
  3648 0000153D D0D8                <1> 	rcr	al, 1
  3649 0000153F C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3650 00001542 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3651 00001543 88D8                <1> 	mov	al, bl
  3652 00001545 00F0                <1> 	add	al, dh	; [next_val_r]
  3653 00001547 D0D8                <1> 	rcr	al, 1
  3654 00001549 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3655 0000154C AB                  <1> 	stosw		; interpolated sample 2 (R)
  3656 0000154D C3                  <1> 	retn
  3657                              <1> 
  3658                              <1> interpolating_2_8bit_mono:
  3659                              <1> 	; 16/11/2023
  3660                              <1> 	; al = [previous_val]
  3661                              <1> 	; dl = [next_val]
  3662                              <1> 	; original-interpolated
  3663 0000154E 88C3                <1> 	mov	bl, al
  3664 00001550 2C80                <1> 	sub	al, 80h
  3665 00001552 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3666 00001555 AB                  <1> 	stosw		; original sample (L)
  3667 00001556 AB                  <1> 	stosw		; original sample (R)
  3668 00001557 88D8                <1> 	mov	al, bl
  3669 00001559 00D0                <1> 	add	al, dl	
  3670 0000155B D0D8                <1> 	rcr	al, 1
  3671 0000155D 2C80                <1> 	sub	al, 80h
  3672 0000155F C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3673 00001562 AB                  <1> 	stosw		; interpolated sample (L)
  3674 00001563 AB                  <1> 	stosw		; interpolated sample (R)
  3675 00001564 C3                  <1> 	retn
  3676                              <1> 
  3677                              <1> interpolating_2_8bit_stereo:
  3678                              <1> 	; 16/11/2023
  3679                              <1> 	; al = [previous_val_l]
  3680                              <1> 	; ah = [previous_val_r]
  3681                              <1> 	; dl = [next_val_l]
  3682                              <1> 	; dh = [next_val_r]	
  3683                              <1> 	; original-interpolated
  3684 00001565 89C3                <1> 	mov	bx, ax
  3685 00001567 2C80                <1> 	sub	al, 80h
  3686 00001569 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3687 0000156C AB                  <1> 	stosw		; original sample (L)
  3688 0000156D 88F8                <1> 	mov	al, bh
  3689 0000156F 2C80                <1> 	sub	al, 80h
  3690 00001571 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3691 00001574 AB                  <1> 	stosw		; original sample (R)
  3692 00001575 88D8                <1> 	mov	al, bl	; [previous_val_l]
  3693 00001577 00D0                <1> 	add	al, dl	; [next_val_l]	
  3694 00001579 D0D8                <1> 	rcr	al, 1
  3695 0000157B 2C80                <1> 	sub	al, 80h
  3696 0000157D C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3697 00001580 AB                  <1> 	stosw		; interpolated sample (L)
  3698 00001581 88F8                <1> 	mov	al, bh
  3699 00001583 00F0                <1> 	add	al, dh	; [next_val_r]
  3700 00001585 D0D8                <1> 	rcr	al, 1
  3701 00001587 2C80                <1> 	sub	al, 80h
  3702 00001589 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3703 0000158C AB                  <1> 	stosw		; interpolated sample (R)
  3704 0000158D C3                  <1> 	retn
  3705                              <1> 
  3706                              <1> interpolating_3_16bit_mono:
  3707                              <1> 	; 16/11/2023
  3708                              <1> 	; ax = [previous_val]
  3709                              <1> 	; dx = [next_val]
  3710                              <1> 	; original-interpolated-interpolated
  3711                              <1> 
  3712 0000158E AB                  <1> 	stosw		; original sample (L)
  3713 0000158F AB                  <1> 	stosw		; original sample (R)
  3714 00001590 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3715 00001593 50                  <1> 	push	ax ; *	; [previous_val]
  3716 00001594 80C680              <1> 	add	dh, 80h
  3717 00001597 01D0                <1> 	add	ax, dx
  3718 00001599 D1D8                <1> 	rcr	ax, 1
  3719 0000159B 5B                  <1> 	pop	bx ; *		
  3720 0000159C 93                  <1> 	xchg	bx, ax	; bx  = interpolated middle (temporary)
  3721 0000159D 01D8                <1> 	add	ax, bx	; [previous_val] + interpolated middle
  3722 0000159F D1D8                <1> 	rcr	ax, 1
  3723 000015A1 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3724 000015A4 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3725 000015A5 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3726 000015A6 89D8                <1> 	mov	ax, bx
  3727 000015A8 01D0                <1> 	add	ax, dx	 ;interpolated middle + [next_val]
  3728 000015AA D1D8                <1> 	rcr	ax, 1
  3729 000015AC 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3730 000015AF AB                  <1> 	stosw		; interpolated sample 2 (L)
  3731 000015B0 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3732 000015B1 C3                  <1> 	retn
  3733                              <1> 
  3734                              <1> interpolating_3_16bit_stereo:
  3735                              <1> 	; 16/11/2023
  3736                              <1> 	; bx = [previous_val_l]
  3737                              <1> 	; ax = [previous_val_r]
  3738                              <1> 	; [next_val_l]
  3739                              <1> 	; dx = [next_val_r]
  3740                              <1> 	; original-interpolated-interpolated
  3741                              <1> 
  3742 000015B2 93                  <1> 	xchg	ax, bx
  3743 000015B3 AB                  <1> 	stosw		; original sample (L)
  3744 000015B4 93                  <1> 	xchg	ax, bx
  3745 000015B5 AB                  <1> 	stosw		; original sample (R)
  3746 000015B6 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3747 000015B9 50                  <1> 	push	ax ; *	; [previous_val_r]
  3748 000015BA 80C780              <1> 	add	bh, 80h
  3749 000015BD 8006[1319]80        <1> 	add	byte [next_val_l+1], 80h
  3750 000015C2 A1[1219]            <1> 	mov	ax, [next_val_l]
  3751 000015C5 01D8                <1> 	add	ax, bx	; [previous_val_l]
  3752 000015C7 D1D8                <1> 	rcr	ax, 1
  3753 000015C9 93                  <1> 	xchg	ax, bx	; ax = [previous_val_l]	
  3754 000015CA 01D8                <1> 	add	ax, bx	; bx = interpolated middle (L)
  3755 000015CC D1D8                <1> 	rcr	ax, 1
  3756 000015CE 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3757 000015D1 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  3758 000015D2 58                  <1> 	pop	ax  ; *
  3759 000015D3 80C680              <1> 	add	dh, 80h ; convert sound level 0 to 65535 format
  3760 000015D6 52                  <1> 	push	dx  ; * ; [next_val_r]
  3761 000015D7 92                  <1> 	xchg	ax, dx
  3762 000015D8 01D0                <1> 	add	ax, dx	; [next_val_r] + [previous_val_r]
  3763 000015DA D1D8                <1> 	rcr	ax, 1	; / 2
  3764 000015DC 50                  <1> 	push	ax ; ** ; interpolated middle (R)
  3765 000015DD 01D0                <1> 	add	ax, dx	; + [previous_val_r]
  3766 000015DF D1D8                <1> 	rcr	ax, 1
  3767 000015E1 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3768 000015E4 AB                  <1> 	stosw 		; interpolated sample 1 (R)
  3769 000015E5 A1[1219]            <1> 	mov	ax, [next_val_l]
  3770 000015E8 01D8                <1> 	add	ax, bx	; + interpolated middle (L)
  3771 000015EA D1D8                <1> 	rcr	ax, 1
  3772 000015EC 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3773 000015EF AB                  <1> 	stosw 		; interpolated sample 2 (L)
  3774 000015F0 58                  <1> 	pop	ax ; **
  3775 000015F1 5A                  <1> 	pop	dx ; *	
  3776 000015F2 01D0                <1> 	add	ax, dx	; interpolated middle + [next_val_r]
  3777 000015F4 D1D8                <1> 	rcr	ax, 1	; / 2
  3778 000015F6 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3779 000015F9 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  3780 000015FA C3                  <1> 	retn
  3781                              <1> 
  3782                              <1> interpolating_2_16bit_mono:
  3783                              <1> 	; 16/11/2023
  3784                              <1> 	; ax = [previous_val]
  3785                              <1> 	; dx = [next_val]
  3786                              <1> 	; original-interpolated
  3787                              <1> 
  3788 000015FB AB                  <1> 	stosw		; original sample (L)
  3789 000015FC AB                  <1> 	stosw		; original sample (R)
  3790 000015FD 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3791 00001600 80C680              <1> 	add	dh, 80h
  3792 00001603 01D0                <1> 	add	ax, dx
  3793 00001605 D1D8                <1> 	rcr	ax, 1
  3794 00001607 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3795 0000160A AB                  <1> 	stosw		; interpolated sample (L)
  3796 0000160B AB                  <1> 	stosw		; interpolated sample (R)
  3797 0000160C C3                  <1> 	retn
  3798                              <1> 
  3799                              <1> interpolating_2_16bit_stereo:
  3800                              <1> 	; 16/11/2023
  3801                              <1> 	; bx = [previous_val_l]
  3802                              <1> 	; ax = [previous_val_r]
  3803                              <1> 	; [next_val_l]
  3804                              <1> 	; dx = [next_val_r]
  3805                              <1> 	; original-interpolated
  3806                              <1> 
  3807 0000160D 93                  <1> 	xchg	ax, bx
  3808 0000160E AB                  <1> 	stosw		; original sample (L)
  3809 0000160F 93                  <1> 	xchg	ax, bx
  3810 00001610 AB                  <1> 	stosw		; original sample (R)
  3811 00001611 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  3812 00001614 80C680              <1> 	add	dh, 80h
  3813 00001617 01D0                <1> 	add	ax, dx	; [previous_val_r] + [next_val_r]
  3814 00001619 D1D8                <1> 	rcr	ax, 1	; / 2
  3815 0000161B 50                  <1> 	push	ax ; *	; interpolated sample (R)
  3816 0000161C A1[1219]            <1> 	mov	ax, [next_val_l]
  3817 0000161F 80C480              <1> 	add	ah, 80h
  3818 00001622 80C780              <1> 	add	bh, 80h
  3819 00001625 01D8                <1> 	add	ax, bx	; [next_val_l] + [previous_val_l]
  3820 00001627 D1D8                <1> 	rcr	ax, 1	; / 2		
  3821 00001629 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3822 0000162C AB                  <1> 	stosw 		; interpolated sample (L)
  3823 0000162D 58                  <1> 	pop	ax ; *	
  3824 0000162E 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  3825 00001631 AB                  <1> 	stosw 		; interpolated sample (R)
  3826 00001632 C3                  <1> 	retn
  3827                              <1> 
  3828                              <1> interpolating_5_8bit_mono:
  3829                              <1> 	; 17/11/2023
  3830                              <1> 	; al = [previous_val]
  3831                              <1> 	; dl = [next_val]
  3832                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  3833 00001633 88C3                <1> 	mov	bl, al
  3834 00001635 2C80                <1> 	sub	al, 80h
  3835 00001637 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3836 0000163A AB                  <1> 	stosw		; original sample (L)
  3837 0000163B AB                  <1> 	stosw		; original sample (R)
  3838 0000163C 88D8                <1> 	mov	al, bl
  3839 0000163E 00D0                <1> 	add	al, dl	
  3840 00001640 D0D8                <1> 	rcr	al, 1
  3841 00001642 88C7                <1> 	mov	bh, al	; interpolated middle (temporary)
  3842 00001644 00D8                <1> 	add	al, bl  ; [previous_val]
  3843 00001646 D0D8                <1> 	rcr	al, 1 	
  3844 00001648 88C6                <1> 	mov	dh, al	; interpolated 1st quarter (temporary)
  3845 0000164A 00D8                <1> 	add	al, bl
  3846 0000164C D0D8                <1> 	rcr	al, 1
  3847 0000164E 2C80                <1> 	sub	al, 80h
  3848 00001650 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3849 00001653 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3850 00001654 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3851 00001655 88F8                <1> 	mov	al, bh
  3852 00001657 00F0                <1> 	add	al, dh
  3853 00001659 D0D8                <1> 	rcr	al, 1
  3854 0000165B 2C80                <1> 	sub	al, 80h
  3855 0000165D C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3856 00001660 AB                  <1> 	stosw		; interpolated sample 2 (L)
  3857 00001661 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3858 00001662 88F8                <1> 	mov	al, bh
  3859 00001664 00D0                <1> 	add	al, dl	; [next_val]
  3860 00001666 D0D8                <1> 	rcr	al, 1
  3861 00001668 88C6                <1> 	mov	dh, al	; interpolated 3rd quarter (temporary)
  3862 0000166A 00F8                <1> 	add	al, bh
  3863 0000166C D0D8                <1> 	rcr	al, 1
  3864 0000166E 2C80                <1> 	sub	al, 80h
  3865 00001670 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3866 00001673 AB                  <1> 	stosw		; interpolated sample 3 (L)
  3867 00001674 AB                  <1> 	stosw		; interpolated sample 3 (R)
  3868 00001675 88F0                <1> 	mov	al, dh
  3869 00001677 00D0                <1> 	add	al, dl
  3870 00001679 D0D8                <1> 	rcr	al, 1
  3871 0000167B 2C80                <1> 	sub	al, 80h
  3872 0000167D C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3873 00001680 AB                  <1> 	stosw		; interpolated sample 4 (L)
  3874 00001681 AB                  <1> 	stosw		; interpolated sample 4 (R)
  3875 00001682 C3                  <1> 	retn
  3876                              <1> 
  3877                              <1> interpolating_5_8bit_stereo:
  3878                              <1> 	; 17/11/2023
  3879                              <1> 	; al = [previous_val_l]
  3880                              <1> 	; ah = [previous_val_r]
  3881                              <1> 	; dl = [next_val_l]
  3882                              <1> 	; dh = [next_val_r]	
  3883                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  3884 00001683 89C3                <1> 	mov	bx, ax
  3885 00001685 2C80                <1> 	sub	al, 80h
  3886 00001687 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3887 0000168A AB                  <1> 	stosw		; original sample (L)
  3888 0000168B 88F8                <1> 	mov	al, bh
  3889 0000168D 2C80                <1> 	sub	al, 80h
  3890 0000168F C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3891 00001692 AB                  <1> 	stosw		; original sample (R)
  3892 00001693 52                  <1> 	push	dx ; *
  3893 00001694 88D8                <1> 	mov	al, bl
  3894 00001696 00D0                <1> 	add	al, dl	; [next_val_l]
  3895 00001698 D0D8                <1> 	rcr	al, 1
  3896 0000169A 50                  <1> 	push	ax ; **	; al = interpolated middle (L) (temporary)
  3897 0000169B 00D8                <1> 	add	al, bl	; [previous_val_l]
  3898 0000169D D0D8                <1> 	rcr	al, 1
  3899 0000169F 86C3                <1> 	xchg	al, bl	
  3900 000016A1 00D8                <1> 	add	al, bl	; bl = interpolated 1st quarter (L) (temp)
  3901 000016A3 D0D8                <1> 	rcr	al, 1
  3902 000016A5 2C80                <1> 	sub	al, 80h
  3903 000016A7 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3904 000016AA AB                  <1> 	stosw		; interpolated sample 1 (L)
  3905 000016AB 88F8                <1> 	mov	al, bh
  3906 000016AD 00F0                <1> 	add	al, dh	; [next_val_r]
  3907 000016AF D0D8                <1> 	rcr	al, 1
  3908 000016B1 50                  <1> 	push	ax ; *** ; al = interpolated middle (R) (temporary)
  3909 000016B2 00F8                <1> 	add	al, bh	; [previous_val_r]
  3910 000016B4 D0D8                <1> 	rcr	al, 1
  3911 000016B6 86C7                <1> 	xchg	al, bh	
  3912 000016B8 00F8                <1> 	add	al, bh	; bh = interpolated 1st quarter (R) (temp)
  3913 000016BA D0D8                <1> 	rcr	al, 1
  3914 000016BC 2C80                <1> 	sub	al, 80h
  3915 000016BE C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3916 000016C1 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3917 000016C2 5A                  <1> 	pop	dx ; ***
  3918 000016C3 58                  <1> 	pop	ax ; **	; al = interpolated middle (L) (temporary)
  3919 000016C4 86C3                <1> 	xchg	al, bl	; al = interpolated 1st quarter (L) (temp)
  3920 000016C6 00D8                <1> 	add	al, bl	; bl = interpolated middle (L) (temporary)
  3921 000016C8 D0D8                <1> 	rcr	al, 1
  3922 000016CA 2C80                <1> 	sub	al, 80h
  3923 000016CC C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3924 000016CF AB                  <1> 	stosw		; interpolated sample 2 (L)	
  3925 000016D0 88D0                <1> 	mov	al, dl 	; interpolated middle (R) (temporary)
  3926 000016D2 86C7                <1> 	xchg	al, bh	; al = interpolated 1st quarter (R) (temp)
  3927 000016D4 00F8                <1> 	add	al, bh	; bh = interpolated middle (R) (temporary)
  3928 000016D6 D0D8                <1> 	rcr	al, 1
  3929 000016D8 2C80                <1> 	sub	al, 80h
  3930 000016DA C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3931 000016DD AB                  <1> 	stosw		; interpolated sample 2 (R)
  3932 000016DE 5A                  <1> 	pop	dx ; *
  3933 000016DF 88D8                <1> 	mov	al, bl	; interpolated middle (L) (temporary)
  3934 000016E1 00D0                <1> 	add	al, dl	; [next_val_l]
  3935 000016E3 D0D8                <1> 	rcr	al, 1
  3936 000016E5 86C3                <1> 	xchg	al, bl	; al = interpolated middle (R) (temporary)	
  3937 000016E7 00D8                <1> 	add	al, bl	; bl = interpolated 3rd quarter (L) (temp) 
  3938 000016E9 D0D8                <1> 	rcr	al, 1
  3939 000016EB 2C80                <1> 	sub	al, 80h
  3940 000016ED C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3941 000016F0 AB                  <1> 	stosw		; interpolated sample 3 (L)
  3942 000016F1 88F8                <1> 	mov	al, bh	
  3943 000016F3 00F0                <1> 	add	al, dh	; interpolated middle (R) + [next_val_r]
  3944 000016F5 D0D8                <1> 	rcr	al, 1
  3945 000016F7 86C7                <1> 	xchg	al, bh	; al = interpolated middle (R)
  3946 000016F9 00F8                <1> 	add	al, bh	; bh = interpolated 3rd quarter (R) (temp)
  3947 000016FB D0D8                <1> 	rcr	al, 1
  3948 000016FD 2C80                <1> 	sub	al, 80h
  3949 000016FF C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3950 00001702 AB                  <1> 	stosw		; interpolated sample 3 (R)
  3951 00001703 88D8                <1> 	mov	al, bl
  3952 00001705 00D0                <1> 	add	al, dl	; [next_val_l]
  3953 00001707 D0D8                <1> 	rcr	al, 1
  3954 00001709 2C80                <1> 	sub	al, 80h
  3955 0000170B C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3956 0000170E AB                  <1> 	stosw		; interpolated sample 4 (L)
  3957 0000170F 88F8                <1> 	mov	al, bh
  3958 00001711 00F0                <1> 	add	al, dh	; [next_val_r]
  3959 00001713 D0D8                <1> 	rcr	al, 1
  3960 00001715 2C80                <1> 	sub	al, 80h
  3961 00001717 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3962 0000171A AB                  <1> 	stosw		; interpolated sample 4 (R)
  3963 0000171B C3                  <1> 	retn
  3964                              <1> 
  3965                              <1> interpolating_4_8bit_mono:
  3966                              <1> 	; 17/11/2023
  3967                              <1> 	; al = [previous_val]
  3968                              <1> 	; dl = [next_val]
  3969                              <1> 	; original-interpolated-interpolated-interpolated
  3970 0000171C 88C3                <1> 	mov	bl, al
  3971 0000171E 2C80                <1> 	sub	al, 80h
  3972 00001720 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3973 00001723 AB                  <1> 	stosw		; original sample (L)
  3974 00001724 AB                  <1> 	stosw		; original sample (R)
  3975 00001725 88D8                <1> 	mov	al, bl
  3976 00001727 00D0                <1> 	add	al, dl	
  3977 00001729 D0D8                <1> 	rcr	al, 1
  3978 0000172B 86C3                <1> 	xchg	al, bl  ; al = [previous_val]
  3979 0000172D 00D8                <1> 	add	al, bl	; bl = interpolated middle (sample 2)
  3980 0000172F D0D8                <1> 	rcr	al, 1 	
  3981 00001731 2C80                <1> 	sub	al, 80h
  3982 00001733 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3983 00001736 AB                  <1> 	stosw		; interpolated sample 1 (L)
  3984 00001737 AB                  <1> 	stosw		; interpolated sample 1 (R)
  3985 00001738 88D8                <1> 	mov	al, bl	; interpolated middle (sample 2)
  3986 0000173A 2C80                <1> 	sub	al, 80h
  3987 0000173C C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3988 0000173F AB                  <1> 	stosw		; interpolated sample 2 (L)
  3989 00001740 AB                  <1> 	stosw		; interpolated sample 2 (R)
  3990 00001741 88D8                <1> 	mov	al, bl
  3991 00001743 00D0                <1> 	add	al, dl	; [next_val]
  3992 00001745 D0D8                <1> 	rcr	al, 1
  3993 00001747 2C80                <1> 	sub	al, 80h
  3994 00001749 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  3995 0000174C AB                  <1> 	stosw		; interpolated sample 3 (L)
  3996 0000174D AB                  <1> 	stosw		; interpolated sample 3 (R)
  3997 0000174E C3                  <1> 	retn
  3998                              <1> 
  3999                              <1> interpolating_4_8bit_stereo:
  4000                              <1> 	; 17/11/2023
  4001                              <1> 	; al = [previous_val_l]
  4002                              <1> 	; ah = [previous_val_r]
  4003                              <1> 	; dl = [next_val_l]
  4004                              <1> 	; dh = [next_val_r]	
  4005                              <1> 	; original-interpolated-interpolated-interpolated
  4006 0000174F 89C3                <1> 	mov	bx, ax
  4007 00001751 2C80                <1> 	sub	al, 80h
  4008 00001753 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4009 00001756 AB                  <1> 	stosw		; original sample (L)
  4010 00001757 88F8                <1> 	mov	al, bh
  4011 00001759 2C80                <1> 	sub	al, 80h
  4012 0000175B C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4013 0000175E AB                  <1> 	stosw		; original sample (R)
  4014 0000175F 88D8                <1> 	mov	al, bl
  4015 00001761 00D0                <1> 	add	al, dl	; [next_val_l]
  4016 00001763 D0D8                <1> 	rcr	al, 1
  4017 00001765 86C3                <1> 	xchg	al, bl	; al = [previous_val_l]
  4018 00001767 00D8                <1> 	add	al, bl	; bl = interpolated middle (L) (sample 2)
  4019 00001769 D0D8                <1> 	rcr	al, 1
  4020 0000176B 2C80                <1> 	sub	al, 80h
  4021 0000176D C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4022 00001770 AB                  <1> 	stosw		; interpolated sample 1 (L)
  4023 00001771 88F8                <1> 	mov	al, bh
  4024 00001773 00F0                <1> 	add	al, dh	; [next_val_r]
  4025 00001775 D0D8                <1> 	rcr	al, 1
  4026 00001777 86C7                <1> 	xchg	al, bh	; al = [previous_val_h]
  4027 00001779 00F8                <1> 	add	al, bh	; bh = interpolated middle (R) (sample 2)
  4028 0000177B D0D8                <1> 	rcr	al, 1
  4029 0000177D 2C80                <1> 	sub	al, 80h
  4030 0000177F C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4031 00001782 AB                  <1> 	stosw		; interpolated sample 1 (R)
  4032 00001783 88D8                <1> 	mov	al, bl	; interpolated middle (L) (sample 2)
  4033 00001785 2C80                <1> 	sub	al, 80h
  4034 00001787 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4035 0000178A AB                  <1> 	stosw		; interpolated sample 2 (L)
  4036 0000178B 88F8                <1> 	mov	al, bh	; interpolated middle (L) (sample 2)
  4037 0000178D 2C80                <1> 	sub	al, 80h
  4038 0000178F C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4039 00001792 AB                  <1> 	stosw		; interpolated sample 2 (L)
  4040 00001793 88D8                <1> 	mov	al, bl
  4041 00001795 00D0                <1> 	add	al, dl	; [next_val_l]
  4042 00001797 D0D8                <1> 	rcr	al, 1
  4043 00001799 2C80                <1> 	sub	al, 80h
  4044 0000179B C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4045 0000179E AB                  <1> 	stosw		; interpolated sample 3 (L)
  4046 0000179F 88F8                <1> 	mov	al, bh
  4047 000017A1 00F0                <1> 	add	al, dh	; [next_val_r]
  4048 000017A3 D0D8                <1> 	rcr	al, 1
  4049 000017A5 2C80                <1> 	sub	al, 80h
  4050 000017A7 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  4051 000017AA AB                  <1> 	stosw		; interpolated sample 3 (R)
  4052 000017AB C3                  <1> 	retn
  4053                              <1> 
  4054                              <1> interpolating_5_16bit_mono:
  4055                              <1> 	; 18/11/2023
  4056                              <1> 	; ax = [previous_val]
  4057                              <1> 	; dx = [next_val]
  4058                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  4059 000017AC AB                  <1> 	stosw		; original sample (L)
  4060 000017AD AB                  <1> 	stosw		; original sample (R)
  4061 000017AE 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  4062 000017B1 89C3                <1> 	mov	bx, ax	; [previous_val]
  4063 000017B3 80C680              <1> 	add	dh, 80h
  4064 000017B6 01D0                <1> 	add	ax, dx
  4065 000017B8 D1D8                <1> 	rcr	ax, 1
  4066 000017BA 50                  <1> 	push	ax ; *	; interpolated middle (temporary)
  4067 000017BB 01D8                <1> 	add	ax, bx	; interpolated middle + [previous_val] 
  4068 000017BD D1D8                <1> 	rcr	ax, 1
  4069 000017BF 50                  <1> 	push	ax ; **	; interpolated 1st quarter (temporary)
  4070 000017C0 01D8                <1> 	add	ax, bx	; 1st quarter + [previous_val]
  4071 000017C2 D1D8                <1> 	rcr	ax, 1	
  4072 000017C4 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4073 000017C7 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  4074 000017C8 AB                  <1> 	stosw		; interpolated sample 1 (R)
  4075 000017C9 58                  <1> 	pop	ax ; **	
  4076 000017CA 5B                  <1> 	pop	bx ; *
  4077 000017CB 01D8                <1> 	add	ax, bx	; 1st quarter + middle
  4078 000017CD D1D8                <1> 	rcr	ax, 1	; / 2
  4079 000017CF 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again	
  4080 000017D2 AB                  <1> 	stosw		; interpolated sample 2 (L)
  4081 000017D3 AB                  <1> 	stosw		; interpolated sample 2 (R)		
  4082 000017D4 89D8                <1> 	mov	ax, bx
  4083 000017D6 01D0                <1> 	add	ax, dx	; interpolated middle + [next_val]
  4084 000017D8 D1D8                <1> 	rcr	ax, 1
  4085 000017DA 50                  <1> 	push	ax ; *	; interpolated 3rd quarter (temporary)
  4086 000017DB 01D8                <1> 	add	ax, bx	; + interpolated middle
  4087 000017DD D1D8                <1> 	rcr	ax, 1
  4088 000017DF 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4089 000017E2 AB                  <1> 	stosw		; interpolated sample 3 (L)
  4090 000017E3 AB                  <1> 	stosw		; interpolated sample 3 (R)
  4091 000017E4 58                  <1> 	pop	ax ; *	
  4092 000017E5 01D0                <1> 	add	ax, dx	; 3rd quarter + [next_val]
  4093 000017E7 D1D8                <1> 	rcr	ax, 1	; / 2
  4094 000017E9 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4095 000017EC AB                  <1> 	stosw		; interpolated sample 4 (L)
  4096 000017ED AB                  <1> 	stosw		; interpolated sample 4 (R)
  4097 000017EE C3                  <1> 	retn
  4098                              <1> 
  4099                              <1> interpolating_5_16bit_stereo:
  4100                              <1> 	; 18/11/2023
  4101                              <1> 	; bx = [previous_val_l]
  4102                              <1> 	; ax = [previous_val_r]
  4103                              <1> 	; [next_val_l]
  4104                              <1> 	; [next_val_r]
  4105                              <1> 	; original-interpltd-interpltd-interpltd-interpltd
  4106 000017EF 51                  <1> 	push	cx ; !
  4107 000017F0 93                  <1> 	xchg	ax, bx
  4108 000017F1 AB                  <1> 	stosw		; original sample (L)
  4109 000017F2 93                  <1> 	xchg	ax, bx
  4110 000017F3 AB                  <1> 	stosw		; original sample (R)
  4111 000017F4 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  4112 000017F7 50                  <1> 	push	ax ; *	; [previous_val_r]
  4113 000017F8 80C780              <1> 	add	bh, 80h
  4114 000017FB 8006[1319]80        <1> 	add	byte [next_val_l+1], 80h
  4115 00001800 A1[1219]            <1> 	mov	ax, [next_val_l]
  4116 00001803 01D8                <1> 	add	ax, bx	; [previous_val_l]
  4117 00001805 D1D8                <1> 	rcr	ax, 1
  4118 00001807 89C1                <1> 	mov	cx, ax	; interpolated middle (L)
  4119 00001809 01D8                <1> 	add	ax, bx	
  4120 0000180B D1D8                <1> 	rcr	ax, 1
  4121 0000180D 89C2                <1> 	mov	dx, ax	; interpolated 1st quarter (L)	
  4122 0000180F 01D8                <1> 	add	ax, bx	; [previous_val_l]
  4123 00001811 D1D8                <1> 	rcr	ax, 1
  4124 00001813 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4125 00001816 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  4126 00001817 89C8                <1> 	mov	ax, cx
  4127 00001819 01D0                <1> 	add	ax, dx	; middle (L) + 1st quarter (L) 
  4128 0000181B D1D8                <1> 	rcr	ax, 1	; / 2
  4129 0000181D 89C3                <1> 	mov	bx, ax  ; interpolated sample 2 (L)
  4130 0000181F 5A                  <1> 	pop	dx ; *	; [previous_val_r]
  4131 00001820 89D0                <1> 	mov	ax, dx
  4132 00001822 8006[1519]80        <1> 	add	byte [next_val_r+1], 80h
  4133 00001827 0306[1419]          <1> 	add	ax, [next_val_r]
  4134 0000182B D1D8                <1> 	rcr	ax, 1
  4135 0000182D 50                  <1> 	push	ax ; *	; interpolated middle (R)
  4136 0000182E 01D0                <1> 	add	ax, dx
  4137 00001830 D1D8                <1> 	rcr	ax, 1
  4138 00001832 50                  <1> 	push	ax ; **	; interpolated 1st quarter (R)
  4139 00001833 01D0                <1> 	add	ax, dx	; [previous_val_r]
  4140 00001835 D1D8                <1> 	rcr	ax, 1
  4141 00001837 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4142 0000183A AB                  <1> 	stosw 		; interpolated sample 1 (R)
  4143 0000183B 89D8                <1> 	mov	ax, bx
  4144 0000183D 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4145 00001840 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  4146 00001841 58                  <1> 	pop	ax ; **
  4147 00001842 5A                  <1> 	pop	dx ; *
  4148 00001843 01D0                <1> 	add	ax, dx	; 1st quarter (R) + middle (R)
  4149 00001845 D1D8                <1> 	rcr	ax, 1	; / 2
  4150 00001847 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4151 0000184A AB                  <1> 	stosw 		; interpolated sample 2 (R)
  4152 0000184B 89C8                <1> 	mov	ax, cx
  4153 0000184D 0306[1219]          <1> 	add	ax, [next_val_l]
  4154 00001851 D1D8                <1> 	rcr	ax, 1
  4155 00001853 50                  <1> 	push	ax ; * 	; interpolated 3rd quarter (L)
  4156 00001854 01C8                <1> 	add	ax, cx	; interpolated middle (L)
  4157 00001856 D1D8                <1> 	rcr	ax, 1
  4158 00001858 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4159 0000185B AB                  <1> 	stosw 		; interpolated sample 3 (L)
  4160 0000185C 89D0                <1> 	mov	ax, dx
  4161 0000185E 0306[1419]          <1> 	add	ax, [next_val_r]
  4162 00001862 D1D8                <1> 	rcr	ax, 1
  4163 00001864 50                  <1> 	push	ax ; ** ; interpolated 3rd quarter (R)
  4164 00001865 01D0                <1> 	add	ax, dx	; interpolated middle (R)
  4165 00001867 D1D8                <1> 	rcr	ax, 1
  4166 00001869 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4167 0000186C AB                  <1> 	stosw 		; interpolated sample 3 (R)
  4168 0000186D 5B                  <1> 	pop	bx ; **
  4169 0000186E 58                  <1> 	pop	ax ; *
  4170 0000186F 0306[1219]          <1> 	add	ax, [next_val_l]
  4171 00001873 D1D8                <1> 	rcr	ax, 1
  4172 00001875 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4173 00001878 AB                  <1> 	stosw 		; interpolated sample 4 (L)
  4174 00001879 89D8                <1> 	mov	ax, bx	
  4175 0000187B 0306[1419]          <1> 	add	ax, [next_val_r]
  4176 0000187F D1D8                <1> 	rcr	ax, 1
  4177 00001881 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4178 00001884 AB                  <1> 	stosw 		; interpolated sample 4 (R)
  4179 00001885 59                  <1> 	pop	cx ; !
  4180 00001886 C3                  <1> 	retn
  4181                              <1> 
  4182                              <1> interpolating_4_16bit_mono:
  4183                              <1> 	; 18/11/2023
  4184                              <1> 	; ax = [previous_val]
  4185                              <1> 	; dx = [next_val]
  4186                              <1> 	; original-interpolated
  4187                              <1> 
  4188 00001887 AB                  <1> 	stosw		; original sample (L)
  4189 00001888 AB                  <1> 	stosw		; original sample (R)
  4190 00001889 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  4191 0000188C 89C3                <1> 	mov	bx, ax	; [previous_val]
  4192 0000188E 80C680              <1> 	add	dh, 80h
  4193 00001891 01D0                <1> 	add	ax, dx	; [previous_val] + [next_val]
  4194 00001893 D1D8                <1> 	rcr	ax, 1
  4195 00001895 93                  <1> 	xchg	ax, bx	
  4196 00001896 01D8                <1> 	add	ax, bx	; [previous_val] + interpolated middle
  4197 00001898 D1D8                <1> 	rcr	ax, 1
  4198 0000189A 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4199 0000189D AB                  <1> 	stosw 		; interpolated sample 1 (L)
  4200 0000189E AB                  <1> 	stosw		; interpolated sample 1 (R)
  4201 0000189F 89D8                <1> 	mov	ax, bx	; interpolated middle
  4202 000018A1 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4203 000018A4 AB                  <1> 	stosw 		; interpolated sample 2 (L)
  4204 000018A5 AB                  <1> 	stosw		; interpolated sample 2 (R)
  4205 000018A6 89D8                <1> 	mov	ax, bx
  4206 000018A8 01D0                <1> 	add	ax, dx	; interpolated middle + [next_val]
  4207 000018AA D1D8                <1> 	rcr	ax, 1
  4208 000018AC 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4209 000018AF AB                  <1> 	stosw		; interpolated sample 3 (L)
  4210 000018B0 AB                  <1> 	stosw		; interpolated sample 3 (R)
  4211 000018B1 C3                  <1> 	retn
  4212                              <1> 
  4213                              <1> interpolating_4_16bit_stereo:
  4214                              <1> 	; 18/11/2023
  4215                              <1> 	; bx = [previous_val_l]
  4216                              <1> 	; ax = [previous_val_r]
  4217                              <1> 	; [next_val_l]
  4218                              <1> 	; [next_val_r]
  4219                              <1> 	; original-interpolated-interpolated-interpolated
  4220 000018B2 93                  <1> 	xchg	ax, bx
  4221 000018B3 AB                  <1> 	stosw		; original sample (L)
  4222 000018B4 93                  <1> 	xchg	ax, bx
  4223 000018B5 AB                  <1> 	stosw		; original sample (R)
  4224 000018B6 80C480              <1> 	add	ah, 80h ; convert sound level 0 to 65535 format
  4225 000018B9 89C2                <1> 	mov	dx, ax	; [previous_val_r]
  4226 000018BB 80C780              <1> 	add	bh, 80h
  4227 000018BE 8006[1319]80        <1> 	add	byte [next_val_l+1], 80h
  4228 000018C3 A1[1219]            <1> 	mov	ax, [next_val_l]
  4229 000018C6 01D8                <1> 	add	ax, bx	; [previous_val_l]
  4230 000018C8 D1D8                <1> 	rcr	ax, 1
  4231 000018CA 93                  <1> 	xchg	ax, bx	
  4232 000018CB 01D8                <1> 	add	ax, bx	; bx = interpolated middle (L)
  4233 000018CD D1D8                <1> 	rcr	ax, 1
  4234 000018CF 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4235 000018D2 AB                  <1> 	stosw 		; interpolated sample 1 (L)
  4236 000018D3 8006[1519]80        <1> 	add	byte [next_val_r+1], 80h
  4237 000018D8 89D0                <1> 	mov	ax, dx	; [previous_val_r]
  4238 000018DA 0306[1419]          <1> 	add	ax, [next_val_r]
  4239 000018DE D1D8                <1> 	rcr	ax, 1
  4240 000018E0 92                  <1> 	xchg	ax, dx	
  4241 000018E1 01D0                <1> 	add	ax, dx	; dx = interpolated middle (R)
  4242 000018E3 D1D8                <1> 	rcr	ax, 1
  4243 000018E5 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4244 000018E8 AB                  <1> 	stosw 		; interpolated sample 1 (R)
  4245 000018E9 89D8                <1> 	mov	ax, bx
  4246 000018EB 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4247 000018EE AB                  <1> 	stosw 		; interpolated sample 2 (L)
  4248 000018EF 89D0                <1> 	mov	ax, dx
  4249 000018F1 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4250 000018F4 AB                  <1> 	stosw 		; interpolated sample 2 (R)
  4251 000018F5 89D8                <1> 	mov	ax, bx
  4252 000018F7 0306[1219]          <1> 	add	ax, [next_val_l]
  4253 000018FB D1D8                <1> 	rcr	ax, 1
  4254 000018FD 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4255 00001900 AB                  <1> 	stosw 		; interpolated sample 3 (L)
  4256 00001901 89D0                <1> 	mov	ax, dx
  4257 00001903 0306[1419]          <1> 	add	ax, [next_val_r]
  4258 00001907 D1D8                <1> 	rcr	ax, 1
  4259 00001909 80EC80              <1> 	sub	ah, 80h	; -32768 to +32767 format again
  4260 0000190C AB                  <1> 	stosw 		; interpolated sample 3 (R)
  4261 0000190D C3                  <1> 	retn
  4262                              <1> 
  4263                              <1> ; 13/11/2023
  4264                              <1> previous_val:
  4265 0000190E 0000                <1> previous_val_l: dw 0
  4266 00001910 0000                <1> previous_val_r: dw 0
  4267                              <1> next_val:
  4268 00001912 0000                <1> next_val_l: dw 0
  4269 00001914 0000                <1> next_val_r: dw 0
  4270                              <1> 
  4271                              <1> ; 16/11/2023
  4272 00001916 00                  <1> faz:	db 0	
  4273                              <1> 	
  4274                              <1> ; --------------------------------------------------------
   449                                  
   450                                  ; UTILS.ASM
   451                                  ;----------------------------------------------------------------------------
   452                                  ;       delay1_4ms - Delay for 1/4 millisecond.
   453                                  ;		    1mS = 1000us
   454                                  ;       Entry:
   455                                  ;         None
   456                                  ;       Exit:
   457                                  ;	  None
   458                                  ;
   459                                  ;       Modified:
   460                                  ;         None
   461                                  ;
   462                                  PORTB			EQU	061h
   463                                    REFRESH_STATUS	EQU	010h		; Refresh signal status
   464                                  
   465                                  delay1_4ms:
   466 00001917 50                              push    ax 
   467 00001918 51                              push    cx
   468 00001919 B91000                          mov     cx, 16			; close enough.
   469 0000191C E461                    	in	al,PORTB
   470 0000191E 2410                    	and	al,REFRESH_STATUS
   471 00001920 88C4                    	mov	ah,al			; Start toggle state
   472 00001922 09C9                    	or	cx, cx
   473 00001924 7401                    	jz	short _d4ms1
   474 00001926 41                      	inc	cx			; Throwaway first toggle
   475                                  _d4ms1:	
   476 00001927 E461                    	in	al,PORTB		; Read system control port
   477 00001929 2410                    	and	al,REFRESH_STATUS	; Refresh toggles 15.085 microseconds
   478 0000192B 38C4                    	cmp	ah,al
   479 0000192D 74F8                    	je	short _d4ms1		; Wait for state change
   480                                  
   481 0000192F 88C4                    	mov	ah,al			; Update with new state
   482 00001931 49                      	dec	cx
   483 00001932 75F3                    	jnz	short _d4ms1
   484                                  
   485 00001934 59                              pop     cx
   486 00001935 58                              pop     ax
   487 00001936 C3                              retn
   488                                  
   489                                  	; 13/11/2016 - Erdogan Tan
   490                                  write_ac97_dev_info:
   491                                  	; BUS/DEV/FN
   492                                  	;	00000000BBBBBBBBDDDDDFFF00000000
   493                                  	; DEV/VENDOR
   494                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
   495                                  
   496 00001937 30FF                    	xor	bh, bh
   497 00001939 668B36[141D]            	mov	esi, [dev_vendor]
   498 0000193E 89F0                    	mov	ax, si
   499 00001940 88C3                    	mov	bl, al
   500 00001942 88DA                    	mov	dl, bl
   501 00001944 80E30F                  	and	bl, 0Fh
   502 00001947 8A87[941B]              	mov	al, [bx+hex_chars]
   503 0000194B A2[D71B]                	mov	[msgVendorId+3], al
   504 0000194E 88D3                    	mov	bl, dl
   505 00001950 C0EB04                  	shr	bl, 4
   506 00001953 8A87[941B]              	mov	al, [bx+hex_chars]
   507 00001957 A2[D61B]                	mov	[msgVendorId+2], al
   508 0000195A 88E3                    	mov	bl, ah
   509 0000195C 88DA                    	mov	dl, bl
   510 0000195E 80E30F                  	and	bl, 0Fh
   511 00001961 8A87[941B]              	mov	al, [bx+hex_chars]
   512 00001965 A2[D51B]                	mov	[msgVendorId+1], al
   513 00001968 88D3                    	mov	bl, dl
   514 0000196A C0EB04                  	shr	bl, 4
   515 0000196D 8A87[941B]              	mov	al, [bx+hex_chars]
   516 00001971 A2[D41B]                	mov	[msgVendorId], al
   517 00001974 66C1EE10                	shr	esi, 16
   518 00001978 89F0                    	mov	ax, si
   519 0000197A 88C3                    	mov	bl, al
   520 0000197C 88DA                    	mov	dl, bl
   521 0000197E 80E30F                  	and	bl, 0Fh
   522 00001981 8A87[941B]              	mov	al, [bx+hex_chars]
   523 00001985 A2[E81B]                	mov	[msgDevId+3], al
   524 00001988 88D3                    	mov	bl, dl
   525 0000198A C0EB04                  	shr	bl, 4
   526 0000198D 8A87[941B]              	mov	al, [bx+hex_chars]
   527 00001991 A2[E71B]                	mov	[msgDevId+2], al
   528 00001994 88E3                    	mov	bl, ah
   529 00001996 88DA                    	mov	dl, bl
   530 00001998 80E30F                  	and	bl, 0Fh
   531 0000199B 8A87[941B]              	mov	al, [bx+hex_chars]
   532 0000199F A2[E61B]                	mov	[msgDevId+1], al
   533 000019A2 88D3                    	mov	bl, dl
   534 000019A4 C0EB04                  	shr	bl, 4
   535 000019A7 8A87[941B]              	mov	al, [bx+hex_chars]
   536 000019AB A2[E51B]                	mov	[msgDevId], al
   537                                  
   538 000019AE 668B36[101D]            	mov	esi, [bus_dev_fn]
   539 000019B3 66C1EE08                	shr	esi, 8
   540 000019B7 89F0                    	mov	ax, si
   541 000019B9 88C3                    	mov	bl, al
   542 000019BB 88DA                    	mov	dl, bl
   543 000019BD 80E307                  	and	bl, 7 ; bit 0,1,2
   544 000019C0 8A87[941B]              	mov	al, [bx+hex_chars]
   545 000019C4 A2[0C1C]                	mov	[msgFncNo+1], al
   546 000019C7 88D3                    	mov	bl, dl
   547 000019C9 C0EB03                  	shr	bl, 3
   548 000019CC 88DA                    	mov	dl, bl
   549 000019CE 80E30F                  	and	bl, 0Fh
   550 000019D1 8A87[941B]              	mov	al, [bx+hex_chars]
   551 000019D5 A2[FE1B]                	mov	[msgDevNo+1], al
   552 000019D8 88D3                    	mov	bl, dl
   553 000019DA C0EB04                  	shr	bl, 4
   554 000019DD 8A87[941B]              	mov	al, [bx+hex_chars]
   555 000019E1 A2[FD1B]                	mov	[msgDevNo], al
   556 000019E4 88E3                    	mov	bl, ah
   557 000019E6 88DA                    	mov	dl, bl
   558 000019E8 80E30F                  	and	bl, 0Fh
   559 000019EB 8A87[941B]              	mov	al, [bx+hex_chars]
   560 000019EF A2[F21B]                	mov	[msgBusNo+1], al
   561 000019F2 88D3                    	mov	bl, dl
   562 000019F4 C0EB04                  	shr	bl, 4
   563 000019F7 8A87[941B]              	mov	al, [bx+hex_chars]
   564 000019FB A2[F11B]                	mov	[msgBusNo], al
   565                                  
   566 000019FE A1[061D]                	mov	ax, [NAMBAR]
   567 00001A01 88C3                    	mov	bl, al
   568 00001A03 88DA                    	mov	dl, bl
   569 00001A05 80E30F                  	and	bl, 0Fh
   570 00001A08 8A87[941B]              	mov	al, [bx+hex_chars]
   571 00001A0C A2[1B1C]                	mov	[msgNamBar+3], al
   572 00001A0F 88D3                    	mov	bl, dl
   573 00001A11 C0EB04                  	shr	bl, 4
   574 00001A14 8A87[941B]              	mov	al, [bx+hex_chars]
   575 00001A18 A2[1A1C]                	mov	[msgNamBar+2], al
   576 00001A1B 88E3                    	mov	bl, ah
   577 00001A1D 88DA                    	mov	dl, bl
   578 00001A1F 80E30F                  	and	bl, 0Fh
   579 00001A22 8A87[941B]              	mov	al, [bx+hex_chars]
   580 00001A26 A2[191C]                	mov	[msgNamBar+1], al
   581 00001A29 88D3                    	mov	bl, dl
   582 00001A2B C0EB04                  	shr	bl, 4
   583 00001A2E 8A87[941B]              	mov	al, [bx+hex_chars]
   584 00001A32 A2[181C]                	mov	[msgNamBar], al
   585                                  
   586                                  	; 05/11/2023
   587 00001A35 A1[081D]                	mov	ax, [NABMBAR]
   588 00001A38 88C3                    	mov	bl, al
   589 00001A3A 88DA                    	mov	dl, bl
   590 00001A3C 80E30F                  	and	bl, 0Fh
   591 00001A3F 678A83[941B0000]        	mov	al, [ebx+hex_chars]
   592 00001A46 A2[2A1C]                	mov	[msgNabmBar+3], al
   593 00001A49 88D3                    	mov	bl, dl
   594 00001A4B C0EB04                  	shr	bl, 4
   595 00001A4E 678A83[941B0000]        	mov	al, [ebx+hex_chars]
   596 00001A55 A2[291C]                	mov	[msgNabmBar+2], al
   597 00001A58 88E3                    	mov	bl, ah
   598 00001A5A 88DA                    	mov	dl, bl
   599 00001A5C 80E30F                  	and	bl, 0Fh
   600 00001A5F 678A83[941B0000]        	mov	al, [ebx+hex_chars]
   601 00001A66 A2[281C]                	mov	[msgNabmBar+1], al
   602 00001A69 88D3                    	mov	bl, dl
   603 00001A6B C0EB04                  	shr	bl, 4
   604 00001A6E 678A83[941B0000]        	mov	al, [ebx+hex_chars]
   605 00001A75 A2[271C]                	mov	[msgNabmBar], al
   606                                  
   607                                  	; 24/11/2016
   608 00001A78 30E4                    	xor	ah, ah
   609 00001A7A A0[051D]                	mov	al, [ac97_int_ln_reg]
   610 00001A7D B10A                    	mov	cl, 10
   611 00001A7F F6F1                    	div	cl
   612 00001A81 0106[321C]              	add	[msgIRQ], ax
   613 00001A85 20C0                    	and	al, al
   614 00001A87 7508                    	jnz	short _pmi
   615 00001A89 A0[331C]                	mov	al, [msgIRQ+1]
   616 00001A8C B420                    	mov	ah, ' '
   617 00001A8E A3[321C]                	mov	[msgIRQ], ax
   618                                  _pmi:
   619 00001A91 BA[A51B]                        mov	dx, msgAC97Info
   620 00001A94 B409                            mov     ah, 9
   621 00001A96 CD21                            int     21h
   622 00001A98 C3                              retn
   623                                  
   624                                  write_sample_rate:
   625                                  	; ax = sample rate (hertz)
   626                                  
   627 00001A99 31D2                    	xor	dx, dx
   628 00001A9B B90A00                  	mov	cx, 10
   629 00001A9E F7F1                    	div	cx
   630 00001AA0 0016[481C]              	add	[msgHertz+4], dl
   631 00001AA4 29D2                    	sub	dx, dx
   632 00001AA6 F7F1                    	div	cx
   633 00001AA8 0016[471C]              	add	[msgHertz+3], dl
   634 00001AAC 29D2                    	sub	dx, dx
   635 00001AAE F7F1                    	div	cx
   636 00001AB0 0016[461C]              	add	[msgHertz+2], dl
   637 00001AB4 29D2                    	sub	dx, dx
   638 00001AB6 F7F1                    	div	cx
   639 00001AB8 0016[451C]              	add	[msgHertz+1], dl
   640 00001ABC 0006[441C]              	add	[msgHertz], al
   641                                  	
   642 00001AC0 BA[371C]                        mov     dx, msgSampleRate
   643 00001AC3 B409                            mov     ah, 9
   644 00001AC5 CD21                            int     21h
   645                                  
   646                                  	; 19/11/2016
   647 00001AC7 BA[5D1C]                	mov	dx, msg16Bits
   648 00001ACA 803E[1C1D]10            	cmp	byte [bps], 16
   649 00001ACF 7403                    	je	short wsr_1
   650 00001AD1 BA[4E1C]                	mov	dx, msg8Bits
   651                                  wsr_1:
   652 00001AD4 B409                            mov     ah, 9
   653 00001AD6 CD21                            int     21h
   654                                  
   655 00001AD8 BA[561C]                	mov	dx, msgMono
   656 00001ADB 803E[1A1D]01            	cmp	byte [stmo], 1
   657 00001AE0 7403                    	je	short wsr_2
   658 00001AE2 BA[661C]                	mov	dx, msgStereo		
   659                                  wsr_2:
   660 00001AE5 B409                            mov     ah, 9
   661 00001AE7 CD21                            int     21h
   662                                  
   663 00001AE9 C3                              retn
   664                                  
   665                                  ;detect_codec:
   666                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   667                                  ;	mov	eax, 7Ch
   668                                  ;	call	codec_read
   669                                  ;       shl     eax, 16
   670                                  ;       mov     [codec_id], eax
   671                                  ;
   672                                  ;	mov	eax, 7Eh
   673                                  ;       call	codec_read
   674                                  ;       or      eax, [codec_id]
   675                                  ;       mov     [codec_chip_id], eax
   676                                  ;       and     eax, 0FFFFFF00h
   677                                  ;
   678                                  ;       mov     edi, codecs
   679                                  ;_dcb:
   680                                  ;       mov     ebx, [di]
   681                                  ;       test    ebx, ebx
   682                                  ;       jz      short _dco_unknown
   683                                  ;
   684                                  ;       cmp     eax, ebx
   685                                  ;       jne     short _dco_next
   686                                  ;       mov     ax, [di+4]
   687                                  ;       mov     [codec_vendor_ids], ax
   688                                  ;       movzx   esi, ax
   689                                  ;       call	print_msg
   690                                  ;       
   691                                  ;	mov	ax, [di+6]
   692                                  ;	call	detect_chip
   693                                  ;       retn
   694                                  ;
   695                                  ;_dco_next:
   696                                  ;       add     di, 8
   697                                  ;       jmp     short _dcb
   698                                  ;
   699                                  ;_dco_unknown:
   700                                  ;       mov    word [codec_vendor_ids], ac_unknown
   701                                  ;       mov    word [codec_chip_ids], chip_unknown
   702                                  ;       mov     esi, chip_unknown
   703                                  ;	call	print_msg
   704                                  ;       mov     eax, [codec_chip_id]
   705                                  ;       call    dword2str
   706                                  ;       call	print_msg
   707                                  ;       retn
   708                                  
   709                                  ;detect_chip:
   710                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   711                                  ;	mov	di, ax ; chip_tab
   712                                  ;       mov     eax, [codec_chip_id]
   713                                  ;       and     ax, 0FFh
   714                                  ;_dch1:
   715                                  ;       mov     bx, [di]
   716                                  ;       cmp     bx, 0FFh
   717                                  ;       je      short _dch_unknown
   718                                  ;
   719                                  ;       cmp     ax, bx
   720                                  ;       jne     short _dch_next
   721                                  ;       mov     ax, [di+2]
   722                                  ;       mov     [codec_chip_ids], ax
   723                                  ;       mov     si, ax
   724                                  ;       call	print_msg
   725                                  ;       retn
   726                                  
   727                                  ;_dch_next:
   728                                  ;       add     di, 4
   729                                  ;       jmp     short _dch1
   730                                  ;
   731                                  ;_dch_unknown:
   732                                  ;       mov    word [codec_chip_ids], chip_unknown
   733                                  ;       mov     si, chip_unknown
   734                                  ;       call	print_msg
   735                                  ;       mov     eax, [codec_chip_id]
   736                                  ;       call    dword2str
   737                                  ;       call	print_msg
   738                                  ;       retn
   739                                  
   740                                  ; 06/11/2023
   741                                  %if 0
   742                                  
   743                                  ac97_int_handler:
   744                                  	; 17/02/2016
   745                                  	push	ax
   746                                  	push	dx
   747                                  	; 05/11/2023	
   748                                  	;push	cx
   749                                  	;push	bx
   750                                  	;push	si
   751                                  	;push	di
   752                                  
   753                                  	cmp	byte [inside], 1
   754                                  	jnb	short _busy
   755                                  
   756                                  	mov	byte [inside], 1
   757                                  
   758                                          mov     dx, [NABMBAR]
   759                                          add     dx, PO_SR_REG	; set pointer to Status reg
   760                                  	in	al, dx
   761                                  	mov	[pcm_irq_status], al ; 05/11/2023
   762                                  	test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
   763                                  	jz	short _ih_3
   764                                  
   765                                  	; 28/11/2016 - Erdogan Tan
   766                                  	call	tuneLoop
   767                                  _ih0:
   768                                  	mov	byte [inside], 0
   769                                  _busy:
   770                                  	mov	al, 20h
   771                                  	test	byte [ac97_int_ln_reg], 8
   772                                  	jz	short _ih_1
   773                                  	out 	0A0h, al ; 20h ; EOI
   774                                  _ih_1:
   775                                  	out	20h, al  ; 20h ; EOI
   776                                  _ih_2:
   777                                  	;pop	di
   778                                  	;pop	si
   779                                  	;pop	bx
   780                                  	;pop	cx
   781                                  	pop	dx
   782                                  	pop	ax
   783                                  	iret
   784                                  _ih_3:
   785                                  	; 17/02/2017
   786                                  	out	dx, al ; clear interrupt event (by writing 1 to same bits)
   787                                  	jmp	short _ih0
   788                                  
   789                                  ac97_stop:
   790                                  	; 11/11/2023
   791                                  	; 05/11/2023
   792                                  	; 04/11/2023 
   793                                  	; 28/05/2017 (TRDOS 386 v2, 'audio.s')
   794                                  	mov	byte [tLoop], 0 ; stop ! ; 05/11/2023
   795                                  ;_ac97_stop:
   796                                  	; 11/11/2023
   797                                  	mov	dx, [NAMBAR]
   798                                  	;add	dx, 0 ; ac_reg_0 ; reset register
   799                                  	out	dx, ax
   800                                  
   801                                  	; 04/11/2023
   802                                  	; 09/10/2017 (TRDOS 386 v2, 'audio.s')
   803                                  	; 11/06/2017
   804                                  	xor	al, al ; 0
   805                                  	call	ac97_po_cmd
   806                                  
   807                                  	; (Ref: KolibriOS, intelac97.asm, 'stop:')
   808                                  	; Clear FIFOE, BCIS, LVBCI (Ref: Intel ICH hub manual)
   809                                  	mov     ax, 1Ch
   810                                  	mov     dx, [NABMBAR]
   811                                  	add     dx, PO_SR_REG
   812                                  	out     dx, ax
   813                                  
   814                                  	; 11/06/2017
   815                                  	mov     al, RR
   816                                  ac97_po_cmd:
   817                                  	 ;11/06/2017
   818                                  	; 29/05/2017
   819                                  	mov     dx, [NABMBAR]
   820                                          add     dx, PO_CR_REG		; PCM out control register
   821                                  	out	dx, al
   822                                  	retn
   823                                  
   824                                  %endif
   825                                  
   826                                  print_msg:
   827                                  	; 13/11/2016 - Erdogan Tan 
   828                                  	; esi = ASCIIZ text address
   829                                  	;
   830 00001AEA BB0700                  	mov	bx, 7h
   831 00001AED B40E                    	mov	ah, 0Eh 
   832                                  pm_next_char:
   833 00001AEF AC                      	lodsb
   834 00001AF0 20C0                    	and	al, al
   835 00001AF2 7404                    	jz	short pm_retn
   836 00001AF4 CD10                    	int	10h
   837 00001AF6 EBF7                    	jmp	short pm_next_char
   838                                  pm_retn:
   839 00001AF8 C3                      	retn
   840                                  
   841                                  ; 06/11/2023
   842                                  ;dword2str:
   843                                  ;	; 13/11/2016 - Erdogan Tan 
   844                                  ;	; eax = dword value
   845                                  ;	;
   846                                  ;	call	dwordtohex
   847                                  ;	mov	[dword_str], edx
   848                                  ;	mov	[dword_str+4], eax
   849                                  ;	mov	si, dword_str
   850                                  ;	retn
   851                                  
   852                                  	; trdos386.s (unix386.s) - 10/05/2015
   853                                  	; Convert binary number to hexadecimal string
   854                                  
   855                                  bytetohex:
   856                                  	; INPUT ->
   857                                  	; 	AL = byte (binary number)
   858                                  	; OUTPUT ->
   859                                  	;	AX = hexadecimal string
   860                                  	;
   861 00001AF9 53                      	push	bx
   862 00001AFA 30FF                    	xor	bh, bh
   863 00001AFC 88C3                    	mov	bl, al
   864 00001AFE C0EB04                  	shr	bl, 4
   865 00001B01 8A9F[941B]              	mov	bl, [bx+hex_chars] 	 	
   866 00001B05 86D8                    	xchg	bl, al
   867 00001B07 80E30F                  	and	bl, 0Fh
   868 00001B0A 8AA7[941B]              	mov	ah, [bx+hex_chars] 
   869 00001B0E 5B                      	pop	bx	
   870 00001B0F C3                      	retn
   871                                  
   872                                  wordtohex:
   873                                  	; INPUT ->
   874                                  	; 	AX = word (binary number)
   875                                  	; OUTPUT ->
   876                                  	;	EAX = hexadecimal string
   877                                  	;
   878 00001B10 53                      	push	bx
   879 00001B11 30FF                    	xor	bh, bh
   880 00001B13 86E0                    	xchg	ah, al
   881 00001B15 50                      	push	ax
   882 00001B16 88E3                    	mov	bl, ah
   883 00001B18 C0EB04                  	shr	bl, 4
   884 00001B1B 8A87[941B]              	mov	al, [bx+hex_chars] 	 	
   885 00001B1F 88E3                    	mov	bl, ah
   886 00001B21 80E30F                  	and	bl, 0Fh
   887 00001B24 8AA7[941B]              	mov	ah, [bx+hex_chars]
   888 00001B28 66C1E010                	shl	eax, 16
   889 00001B2C 58                      	pop	ax
   890 00001B2D 5B                      	pop	bx
   891 00001B2E EBC9                    	jmp	short bytetohex
   892                                  
   893                                  ; 06/11/2023
   894                                  ;dwordtohex:
   895                                  ;	; INPUT ->
   896                                  ;	; 	EAX = dword (binary number)
   897                                  ;	; OUTPUT ->
   898                                  ;	;	EDX:EAX = hexadecimal string
   899                                  ;	;
   900                                  ;	push	eax
   901                                  ;	shr	eax, 16
   902                                  ;	call	wordtohex
   903                                  ;	mov	edx, eax
   904                                  ;	pop	eax
   905                                  ;	call	wordtohex
   906                                  ;	retn
   907                                  
   908                                  _DATA:
   909                                  
   910                                  ; 24/11/2016
   911                                  ;	IRQ  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 
   912 00001B30 08090A0B0C0D0E0F70-     irq_int	 db 08h,09h,0Ah,0Bh,0Ch,0Dh,0Eh,0Fh,70h,71h,72h,73h,74h,75h,76h,77h
   912 00001B39 71727374757677     
   913                                  
   914                                  ; 17/02/2017
   915                                  ; Valid ICH device IDs
   916                                  
   917                                  valid_ids:
   918 00001B40 86801524                dd	(ICH_DID << 16) + INTEL_VID  	 ; 8086h:2415h 
   919 00001B44 86802524                dd	(ICH0_DID << 16) + INTEL_VID 	 ; 8086h:2425h 
   920 00001B48 86804524                dd	(ICH2_DID << 16) + INTEL_VID 	 ; 8086h:2445h 
   921 00001B4C 86808524                dd	(ICH3_DID << 16) + INTEL_VID 	 ; 8086h:2485h 
   922 00001B50 8680C524                dd	(ICH4_DID << 16) + INTEL_VID 	 ; 8086h:24C5h
   923 00001B54 8680D524                dd	(ICH5_DID << 16) + INTEL_VID 	 ; 8086h:24D5h
   924 00001B58 86806E26                dd	(ICH6_DID << 16) + INTEL_VID 	 ; 8086h:266Eh
   925 00001B5C 8680A625                dd	(ESB6300_DID << 16) + INTEL_VID  ; 8086h:25A6h
   926 00001B60 86809826                dd	(ESB631X_DID << 16) + INTEL_VID  ; 8086h:2698h
   927 00001B64 8680DE27                dd	(ICH7_DID << 16) + INTEL_VID 	 ; 8086h:27DEh
   928                                  ; 03/11/2023 - Erdogan Tan
   929 00001B68 86809571                dd	(MX82440_DID << 16) + INTEL_VID  ; 8086h:7195h
   930 00001B6C 39101270                dd	(SI7012_DID << 16)  + SIS_VID	 ; 1039h:7012h
   931 00001B70 DE10B101                dd 	(NFORCE_DID << 16)  + NVIDIA_VID ; 10DEh:01B1h
   932 00001B74 DE106A00                dd 	(NFORCE2_DID << 16) + NVIDIA_VID ; 10DEh:006Ah
   933 00001B78 22106D74                dd 	(AMD8111_DID << 16) + AMD_VID 	 ; 1022h:746Dh
   934 00001B7C 22104574                dd 	(AMD768_DID << 16)  + AMD_VID 	 ; 1022h:7445h
   935 00001B80 DE105900                dd 	(CK804_DID << 16) + NVIDIA_VID	 ; 10DEh:0059h
   936 00001B84 DE103A00                dd 	(MCP04_DID << 16) + NVIDIA_VID	 ; 10DEh:003Ah
   937 00001B88 DE108A00                dd 	(CK8_DID << 16) + NVIDIA_VID	 ; 1022h:008Ah
   938 00001B8C DE10DA00                dd 	(NFORCE3_DID << 16) + NVIDIA_VID ; 10DEh:00DAh
   939 00001B90 DE10EA00                dd 	(CK8S_DID << 16) + NVIDIA_VID	 ; 10DEh:00EAh
   940                                  
   941                                  valid_id_count:	equ ($ - valid_ids)>>2 ; 05/11/2023
   942                                  
   943                                  ; 13/11/2016
   944 00001B94 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
   944 00001B9D 3941424344454600   
   945 00001BA5 414339372041756469-     msgAC97Info	db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
   945 00001BAE 6F20436F6E74726F6C-
   945 00001BB7 6C6572202620436F64-
   945 00001BC0 656320496E666F0D0A 
   946 00001BC9 56656E646F72204944-     		db "Vendor ID: "
   946 00001BD2 3A20               
   947 00001BD4 303030306820446576-     msgVendorId	db "0000h Device ID: "
   947 00001BDD 6963652049443A20   
   948 00001BE5 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
   949 00001BEC 4275733A20              		db "Bus: "
   950 00001BF1 303068204465766963-     msgBusNo	db "00h Device: "
   950 00001BFA 653A20             
   951 00001BFD 3030682046756E6374-     msgDevNo	db "00h Function: "
   951 00001C06 696F6E3A20         
   952 00001C0B 303068                  msgFncNo	db "00h"
   953 00001C0E 0D0A                    		db 0Dh, 0Ah
   954                                  ; 05/11/2023	
   955 00001C10 4E414D4241523A20        		db "NAMBAR: "
   956 00001C18 303030306820            msgNamBar	db "0000h "
   957 00001C1E 4E41424D4241523A20      		db "NABMBAR: "
   958 00001C27 303030306820495251-     msgNabmBar	db "0000h IRQ: "
   958 00001C30 3A20               
   959 00001C32 3030                    msgIRQ		dw 3030h
   960 00001C34 0D0A24                  		db 0Dh, 0Ah, "$"
   961 00001C37 53616D706C65205261-     msgSampleRate	db "Sample Rate: "
   961 00001C40 74653A20           
   962 00001C44 303030303020487A20-     msgHertz	db "00000 Hz ", "$" 
   962 00001C4D 24                 
   963 00001C4E 3820626974732024        msg8Bits	db "8 bits ", "$" 
   964 00001C56 4D6F6E6F0D0A24          msgMono		db "Mono", 0Dh, 0Ah, "$"
   965 00001C5D 313620626974732024      msg16Bits	db "16 bits ", "$" 
   966 00001C66 53746572656F0D0A24      msgStereo	db "Stereo", 0Dh, 0Ah, "$"
   967                                  
   968                                  ;; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   969                                  ;codec_id	dd 0
   970                                  ;codec_chip_id	dd 0
   971                                  ;codec_vendor_ids dw 0
   972                                  ;codec_chip_ids	dw 0
   973                                  
   974 00001C6F 3030303030303030        dword_str	 dd 30303030h, 30303030h
   975 00001C77 680D0A00                		 db 'h', 0Dh, 0Ah, 0
   976                                  
   977                                  ;ac_unknown     db 'unknown manufacturer',13,10,0
   978                                  ;ac_Realtek     db 'Realtek Semiconductor',13,10,0
   979                                  ;ac_Analog      db 'Analog Devices',13,10,0
   980                                  ;ac_CMedia      db 'C-Media Electronics',13,10,0
   981                                  ;ac_Cirrus      db 'Cirrus Logic',13,10,0
   982                                  ;ac_Wolfson     db 'Wolfson Microelectronics',13,10,0
   983                                  ;ac_VIA         db 'VIA Technologies',13,10,0
   984                                  ;ac_SigmaTel    db 'SigmaTel',13,10,0
   985                                  ;ac_eMicro      db 'eMicro',13,10,0
   986                                  ;
   987                                  ;chip_unknown   db 'unknown codec id ', 0
   988                                  
   989                                  ;CHIP_REALTEK   equ 414C4700h
   990                                  ;CHIP_CMEDIA    equ 434D4900h
   991                                  ;CHIP_VIA       equ 56494100h
   992                                  
   993                                  ;codecs        dd CHIP_CMEDIA
   994                                  ;	       dw ac_CMedia, chips_CMedia
   995                                  ;              dd CHIP_REALTEK
   996                                  ;	       dw ac_Realtek, chips_Realtek
   997                                  ;              dd CHIP_VIA
   998                                  ;	       dw ac_VIA, chips_VIA
   999                                  ;              dd 0
  1000                                  
  1001                                  ;chips_Realtek dw 10h, chip_ALC201a
  1002                                  ;              dw 20h, chip_ALC650
  1003                                  ;              dw 21h, chip_ALC650D
  1004                                  ;              dw 22h, chip_ALC650E
  1005                                  ;              dw 23h, chip_ALC650F
  1006                                  ;              dw 60h, chip_ALC655
  1007                                  ;              dw 80h, chip_ALC658
  1008                                  ;              dw 81h, chip_ALC658D
  1009                                  ;              dw 90h, chip_ALC850
  1010                                  ;              dw 0FFh
  1011                                  
  1012                                  ;chips_CMedia  dw 41h, chip_CM9738
  1013                                  ;              dw 61h, chip_CM9739
  1014                                  ;              dw 69h, chip_CM9780
  1015                                  ;              dw 78h, chip_CM9761
  1016                                  ;              dw 82h, chip_CM9761
  1017                                  ;              dw 83h, chip_CM9761
  1018                                  ;              dw 0FFh
  1019                                  
  1020                                  ;chips_VIA     dw 61h, chip_VIA1612A
  1021                                  ;              dw 0FFh
  1022                                  
  1023                                  ;Realtek
  1024                                  ;chip_ALC201a    db 'ALC201a',0dh,0ah,00h
  1025                                  ;chip_ALC650     db 'ALC650 ',0dh,0ah,00h
  1026                                  ;chip_ALC650D    db 'ALC650D',0dh,0ah,00h
  1027                                  ;chip_ALC650E    db 'ALC650E',0dh,0ah,00h
  1028                                  ;chip_ALC650F    db 'ALC650F',0dh,0ah,00h
  1029                                  ;chip_ALC655     db 'ALC655 ',0dh,0ah,00h
  1030                                  ;chip_ALC658     db 'ALC658 ',0dh,0ah,00h
  1031                                  ;chip_ALC658D    db 'ALC658D',0dh,0ah,00h
  1032                                  ;chip_ALC850     db 'ALC850 ',0dh,0ah,00h
  1033                                  
  1034                                  ;CMedia
  1035                                  ;chip_CM9738     db 'CMI9738', 0dh,0ah,0
  1036                                  ;chip_CM9739     db 'CMI9739', 0dh,0ah,0
  1037                                  ;chip_CM9780     db 'CMI9780', 0dh,0ah,0
  1038                                  ;chip_CM9761     db 'CMI9761', 0dh,0ah,0
  1039                                  
  1040                                  ;VIA
  1041                                  ;chip_VIA1612A   db 'VIA1612A',13,10,0
  1042                                  
  1043                                  ; 11/11/2023
  1044                                  msg_init_err:
  1045 00001C7B 0D0A                    	db	CR, LF
  1046 00001C7D 4143393720436F6E74-     	db	"AC97 Controller/Codec initialization error !"
  1046 00001C86 726F6C6C65722F436F-
  1046 00001C8F 64656320696E697469-
  1046 00001C98 616C697A6174696F6E-
  1046 00001CA1 206572726F722021   
  1047 00001CA9 0D0A24                  	db	CR, LF, "$"
  1048                                  
  1049                                  ; 12/11/2023
  1050                                  msg_no_vra:
  1051 00001CAC 0D0A                    	db	CR, LF
  1052 00001CAE 4E6F20565241207375-     	db	"No VRA support ! Only 48 kHZ sample rate supported !"
  1052 00001CB7 70706F72742021204F-
  1052 00001CC0 6E6C79203438206B48-
  1052 00001CC9 5A2073616D706C6520-
  1052 00001CD2 726174652073757070-
  1052 00001CDB 6F727465642021     
  1053 00001CE2 0D0A24                  	db	CR, LF, "$"
  1054                                  
  1055                                  ; 17/02/2017
  1056                                  bss_start:
  1057                                  
  1058                                  ABSOLUTE bss_start
  1059                                  
  1060 00001CE5 ??                      alignb 2
  1061                                  
  1062                                  ; 28/11/2016
  1063                                  
  1064 00001CE6 <res 1Ch>               smpRBuff:	resw 14 ; 19/11/2016 - Erdogan Tan
  1065                                  
  1066 00001D02 ????                    filehandle:	resw 1
  1067                                  
  1068 00001D04 ??                      flags:		resb 1
  1069                                  ; 06/11/2023
  1070 00001D05 ??                      ac97_int_ln_reg: resb 1
  1071                                  
  1072                                  ; 06/11/2023
  1073                                  ;pcm_irq_status: resb 1	; 05/11/2023
  1074                                  ;
  1075                                  ;inside:	resb 1
  1076                                  ;tLoop:		resb 1
  1077                                  
  1078                                  ; 06/11/2023
  1079                                  ; 05/11/2023
  1080                                  ; 04/11/2023
  1081                                  ;IRQ_status:	resw 1	; IRQ status before enabling audio interrupt
  1082                                  ;IRQ_vector:	resd 1  ; Previous interrupt handler address	
  1083                                  
  1084                                  ; 17/02/2017
  1085                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  1086                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  1087                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  1088                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  1089 00001D06 ????                    NAMBAR:		resw 1			; BAR for mixer
  1090 00001D08 ????                    NABMBAR:	resw 1			; BAR for bus master regs
  1091                                  
  1092                                  ; 256 byte buffer for descriptor list
  1093 00001D0A ????                    BDL_BUFFER:	resw 1			; segment of our 256byte BDL buffer
  1094 00001D0C ????                    WAV_BUFFER1:	resw 1			; segment of our WAV storage
  1095                                  ; 64k buffers for wav file storage
  1096 00001D0E ????                    WAV_BUFFER2:	resw 1			; segment of 2nd wav buffer
  1097                                  
  1098                                  ; 06/11/2023
  1099                                  ;tBuff:		resb 1
  1100                                  ;ac97_int_ln_reg: resb 1
  1101                                  
  1102                                  ; 12/11/2016 - Erdogan Tan
  1103                                  
  1104 00001D10 ????????                bus_dev_fn:	resd 1
  1105 00001D14 ????????                dev_vendor:	resd 1
  1106                                  ; 06/11/2023
  1107                                  ;stats_cmd:	resw 1 ; 17/02/2017
  1108                                  ; 05/11/2023
  1109                                  ;ac97_io_base:	resw 1
  1110 00001D18 ????                    sample_rate:	resw 1
  1111                                  
  1112                                  ; 19/11/2016
  1113 00001D1A ????                    stmo:		resw 1 
  1114 00001D1C ????                    bps:		resw 1
  1115                                  
  1116                                  ; 08/11/2023
  1117                                  ; 07/11/2023
  1118 00001D1E ??                      fbs_shift:	resb 1
  1119 00001D1F ??                      		resb 1 ; 08/11/2023
  1120                                  
  1121                                  ;fbs_seg:	resw 1
  1122                                  ;fbs_off:	resw 1
  1123                                  
  1124                                  ;alignb 2
  1125                                  
  1126                                  ; 32 kilo bytes for temporay buffer
  1127                                  ; (for stereo-mono, 8bit/16bit corrections)
  1128                                  ;temp_buffer:	resb 32768
  1129                                  ; 18/11/2023
  1130 00001D20 <res DBF0h>             temp_buffer:	resb 56304  ; (44.1 kHZ stereo 14076 samples)	
  1131                                  
  1132                                  ;alignb 16
  1133                                  EOF:
