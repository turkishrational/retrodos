     1                                  ; ****************************************************************************
     2                                  ; PLAYWAV.ASM - ICH AC97 .wav player for DOS.			   PLAYWAV.COM
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; Last Update: 13/11/2023 (Previous: 08/11/2023)
     5                                  ; ----------------------------------------------------------------------------
     6                                  ; Beginning: 17/02/2017
     7                                  ; ----------------------------------------------------------------------------
     8                                  ; Assembler: NASM version 2.11 (2.15)
     9                                  ;	     nasm playwav.asm -l playwav.lst -o PLAYWAV.COM	
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Derived from '.wav file player for DOS' Jeff Leyda, Sep 02, 2002 
    12                                  ; ****************************************************************************
    13                                  ; Modidified from 'PLAYER.COM' for VIA VT8233 wav player source code by
    14                                  ; (PLAYER.ASM) by Erdogan Tan (07/11/2016 - 08/12/2016)
    15                                  
    16                                  ; AC97 interrupt version - 09/11/2023 - Erdogan Tan
    17                                  
    18                                  [BITS 16]
    19                                  
    20                                  [ORG 100h] 
    21                                  
    22                                  	%include 'ac97.inc' ; 17/02/2017
     1                              <1> ; 11/11/2023
     2                              <1> ; 05/11/2023
     3                              <1> ; 03/11/2023
     4                              <1> ; 17/02/2017 (Erdogan Tan, PLAYWAV.ASM)
     5                              <1> ; constant.inc & codec.inc (for ICH AC97 wav player, 'PLAYWAV.COM') 
     6                              <1> 
     7                              <1> ; ----------------------------------------------------------------------------
     8                              <1> ; CONSTANT.INC
     9                              <1> ; ----------------------------------------------------------------------------
    10                              <1> 
    11                              <1> ;constants of stuff that seem hard to remember at times.
    12                              <1> 
    13                              <1> TRUE  EQU 1
    14                              <1> FALSE EQU 0
    15                              <1> 
    16                              <1> ENABLED  EQU 1
    17                              <1> DISABLED EQU 0
    18                              <1> 
    19                              <1> BIT0  EQU 1
    20                              <1> BIT1  EQU 2
    21                              <1> BIT2  EQU 4
    22                              <1> BIT3  EQU 8
    23                              <1> BIT4  EQU 10h
    24                              <1> BIT5  EQU 20h
    25                              <1> BIT6  EQU 40h
    26                              <1> BIT7  EQU 80h
    27                              <1> BIT8  EQU 100h
    28                              <1> BIT9  EQU 200h
    29                              <1> BIT10 EQU 400h
    30                              <1> BIT11 EQU 800h
    31                              <1> BIT12 EQU 1000h
    32                              <1> BIT13 EQU 2000h
    33                              <1> BIT14 EQU 4000h
    34                              <1> BIT15 EQU 8000h
    35                              <1> BIT16 EQU 10000h
    36                              <1> BIT17 EQU 20000h
    37                              <1> BIT18 EQU 40000h
    38                              <1> BIT19 EQU 80000h
    39                              <1> BIT20 EQU 100000h
    40                              <1> BIT21 EQU 200000h
    41                              <1> BIT22 EQU 400000h
    42                              <1> BIT23 EQU 800000h
    43                              <1> BIT24 EQU 1000000h
    44                              <1> BIT25 EQU 2000000h
    45                              <1> BIT26 EQU 4000000h
    46                              <1> BIT27 EQU 8000000h
    47                              <1> BIT28 EQU 10000000h
    48                              <1> BIT29 EQU 20000000h
    49                              <1> BIT30 EQU 40000000h
    50                              <1> BIT31 EQU 80000000h
    51                              <1> 
    52                              <1> ;special characters
    53                              <1> NUL     EQU 0
    54                              <1> NULL    EQU 0
    55                              <1> BELL    EQU 07
    56                              <1> BS      EQU 08
    57                              <1> TAB     EQU 09
    58                              <1> LF      EQU 10
    59                              <1> CR      EQU 13
    60                              <1> ESCAPE  EQU 27           ;ESC is a reserved word....
    61                              <1> 
    62                              <1> 
    63                              <1> ;file stuff
    64                              <1> READONLY  EQU   BIT0
    65                              <1> HIDDEN    EQU   BIT1
    66                              <1> SYSTEM    EQU   BIT2
    67                              <1> VOLUME    EQU   BIT3         ;ignored for file access
    68                              <1> DIRECTORY EQU   BIT4         ;must be 0 for file access
    69                              <1> ARCHIVE   EQU   BIT5
    70                              <1> SHAREABLE EQU   BIT7         ;for novell networks
    71                              <1> OPEN	EQU	2		; open existing file
    72                              <1> CREATE	EQU	1		; create new file
    73                              <1> 
    74                              <1> 
    75                              <1> ; PCI equates
    76                              <1> ; PCI function address (PFA)
    77                              <1> ; bit 31 = 1
    78                              <1> ; bit 23:16 = bus number     (0-255)
    79                              <1> ; bit 15:11 = device number  (0-31)
    80                              <1> ; bit 10:8 = function number (0-7)
    81                              <1> ; bit 7:0 = register number  (0-255)
    82                              <1> 
    83                              <1> IO_ADDR_MASK    EQU     0FFFEh          ; mask off bit 0 for reading BARs
    84                              <1> PCI_INDEX_PORT  EQU     0CF8h
    85                              <1> PCI_DATA_PORT   EQU     0CFCh
    86                              <1> PCI32           EQU     BIT31           ; bitflag to signal 32bit access
    87                              <1> PCI16           EQU     BIT30           ; bitflag for 16bit access
    88                              <1> 
    89                              <1> PCI_FN0         EQU     0 << 8
    90                              <1> PCI_FN1         EQU     1 << 8
    91                              <1> PCI_FN2         EQU     2 << 8
    92                              <1> PCI_FN3         EQU     3 << 8
    93                              <1> PCI_FN4         EQU     4 << 8
    94                              <1> PCI_FN5         EQU     5 << 8
    95                              <1> PCI_FN6         EQU     6 << 8
    96                              <1> PCI_FN7         EQU     7 << 8
    97                              <1> 
    98                              <1> PCI_CMD_REG		EQU	04h		; reg 04, command reg
    99                              <1>  IO_ENA			EQU	BIT0		; i/o decode enable
   100                              <1>  MEM_ENA		EQU	BIT1		; memory decode enable
   101                              <1>  BM_ENA                 EQU     BIT2		; bus master enable
   102                              <1> 
   103                              <1> ; ----------------------------------------------------------------------------
   104                              <1> ; CODEC.INC
   105                              <1> ; ----------------------------------------------------------------------------
   106                              <1> 
   107                              <1> ;Codec registers.
   108                              <1> ;
   109                              <1> ;Not all codecs are created equal. Refer to the spec for your specific codec.
   110                              <1> ;
   111                              <1> ;All registers are 16bits wide.  Access to codec registers over the AC97 link
   112                              <1> ;is defined by the OEM.  
   113                              <1> ;
   114                              <1> ;Secondary codec's are accessed by ORing in BIT7 of all register accesses.
   115                              <1> ;
   116                              <1> 
   117                              <1> ; each codec/mixer register is 16bits
   118                              <1> 
   119                              <1> CODEC_RESET_REG                 equ     00      ; reset codec
   120                              <1> CODEC_MASTER_VOL_REG            equ     02      ; master volume
   121                              <1> CODEC_HP_VOL_REG                equ     04      ; headphone volume
   122                              <1> CODEC_MASTER_MONO_VOL_REG       equ     06      ; master mono volume
   123                              <1> CODEC_MASTER_TONE_REG           equ     08      ; master tone (R+L)
   124                              <1> CODEC_PCBEEP_VOL_REG            equ     0ah     ; PC beep volume
   125                              <1> CODEC_PHONE_VOL_REG             equ     0bh     ; phone volume
   126                              <1> CODEC_MIC_VOL_REG               equ     0eh     ; MIC volume
   127                              <1> CODEC_LINE_IN_VOL_REG           equ     10h     ; line input volume
   128                              <1> CODEC_CD_VOL_REG                equ     12h     ; CD volume
   129                              <1> CODEC_VID_VOL_REG               equ     14h     ; video volume
   130                              <1> CODEC_AUX_VOL_REG               equ     16h     ; aux volume
   131                              <1> CODEC_PCM_OUT_REG               equ     18h     ; PCM output volume
   132                              <1> CODEC_RECORD_SELECT_REG         equ     1ah     ; record select input
   133                              <1> CODEC_RECORD_VOL_REG            equ     1ch     ; record volume
   134                              <1> CODEC_RECORD_MIC_VOL_REG        equ     1eh     ; record mic volume
   135                              <1> CODEC_GP_REG                    equ     20h     ; general purpose
   136                              <1> CODEC_3D_CONTROL_REG            equ     22h     ; 3D control
   137                              <1> ; 24h is reserved
   138                              <1> CODEC_POWER_CTRL_REG            equ     26h     ; powerdown control
   139                              <1> CODEC_EXT_AUDIO_REG             equ     28h     ; extended audio
   140                              <1> CODEC_EXT_AUDIO_CTRL_REG        equ     2ah     ; extended audio control
   141                              <1> CODEC_PCM_FRONT_DACRATE_REG     equ     2ch     ; PCM out sample rate
   142                              <1> CODEC_PCM_SURND_DACRATE_REG     equ     2eh     ; surround sound sample rate
   143                              <1> CODEC_PCM_LFE_DACRATE_REG       equ     30h     ; LFE sample rate
   144                              <1> CODEC_LR_ADCRATE_REG            equ     32h     ; PCM in sample rate
   145                              <1> CODEC_MIC_ADCRATE_REG           equ     34h     ; mic in sample rate
   146                              <1> 
   147                              <1> ; registers 36-7a are reserved on the ICH
   148                              <1> 
   149                              <1> CODEC_VENDORID1_REG             equ     7ch     ; codec vendor ID 1
   150                              <1> CODEC_VENDORID2_REG             equ     7eh     ; codec vendor ID 2
   151                              <1> 
   152                              <1> ; Mixer registers 0 through 51h reside in the ICH and are not forwarded over
   153                              <1> ; the AC97 link to the codec, which I think is a little weird.  Looks like
   154                              <1> ; the ICH makes it so you don't need a fully functional codec to play audio?
   155                              <1> ;
   156                              <1> ; whenever 2 codecs are present in the system, use BIT7 to access the 2nd
   157                              <1> ; set of registers, ie 80h-feh
   158                              <1> 
   159                              <1> PRIMARY_CODEC                   equ     0       ; 0-7F for primary codec
   160                              <1> SECONDARY_CODEC                 equ     BIT7    ; 80-8f registers for 2ndary
   161                              <1> 
   162                              <1> SAMPLE_RATE_441khz	equ     44100   ; 44.1Khz (cd quality) rate
   163                              <1> 
   164                              <1> ; ----------------------------------------------------------------------------
   165                              <1> ; 17/02/2017
   166                              <1> PCI_IO_BASE	equ 10h			; = NAMBAR register offset
   167                              <1> AC97_INT_LINE   equ 3Ch			; AC97 Interrupt Line register offset
   168                              <1> 
   169                              <1> ; ----------------------------------------------------------------------------
   170                              <1> ; ICH2AC97.INC
   171                              <1> ; ----------------------------------------------------------------------------
   172                              <1> 
   173                              <1> ; PCI stuff
   174                              <1> 
   175                              <1> ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
   176                              <1> 
   177                              <1> INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
   178                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   179                              <1> SIS_VID		equ	1039h
   180                              <1> NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
   181                              <1> AMD_VID		equ	1022h
   182                              <1> 
   183                              <1> ICH_DID         equ     2415h           ; ICH device ID
   184                              <1> ICH0_DID        equ     2425h           ; ICH0
   185                              <1> ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
   186                              <1>                                         ; they all should be compatible.
   187                              <1> 
   188                              <1> ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
   189                              <1> ICH3_DID	equ     2485h           ; ICH3
   190                              <1> ICH4_DID        equ     24C5h           ; ICH4
   191                              <1> ICH5_DID	equ     24D5h           ; ICH5 
   192                              <1> ICH6_DID	equ     266Eh           ; ICH6
   193                              <1> ESB6300_DID	equ     25A6h           ; 6300ESB
   194                              <1> ESB631X_DID	equ     2698h           ; 631XESB
   195                              <1> ICH7_DID	equ	27DEh		; ICH7
   196                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   197                              <1> MX82440_DID	equ	7195h
   198                              <1> SI7012_DID	equ	7012h
   199                              <1> NFORCE_DID	equ	01B1h
   200                              <1> NFORCE2_DID	equ	006Ah
   201                              <1> AMD8111_DID	equ	746Dh
   202                              <1> AMD768_DID	equ	7445h
   203                              <1> ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
   204                              <1> CK804_DID	equ	0059h
   205                              <1> MCP04_DID	equ	003Ah
   206                              <1> CK8_DID		equ	008Ah
   207                              <1> NFORCE3_DID	equ	00DAh
   208                              <1> CK8S_DID	equ	00EAh
   209                              <1> 
   210                              <1> NAMBAR_REG      equ     10h             ; native audio mixer BAR
   211                              <1>  NAM_SIZE       equ     256             ; 256 bytes required.
   212                              <1> 
   213                              <1> NABMBAR_REG     equ     14h             ; native audio bus mastering BAR
   214                              <1>  NABM_SIZE      equ     64              ; 64 bytes
   215                              <1> 
   216                              <1> ; BUS master registers, accessed via NABMBAR+offset
   217                              <1> 
   218                              <1> ; ICH supports 3 different types of register sets for three types of things
   219                              <1> ; it can do, thus:
   220                              <1> ;
   221                              <1> ; PCM in (for recording) aka PI
   222                              <1> ; PCM out (for playback) aka PO
   223                              <1> ; MIC in (for recording) aka MC
   224                              <1> 
   225                              <1> PI_BDBAR_REG            equ     0       ; PCM in buffer descriptor BAR
   226                              <1> PO_BDBAR_REG            equ     10h     ; PCM out buffer descriptor BAR
   227                              <1> MC_BDBAR_REG            equ     20h     ; MIC in buffer descriptor BAR
   228                              <1> 
   229                              <1> ; each buffer descriptor BAR holds a pointer which has entries to the buffer
   230                              <1> ; contents of the .WAV file we're going to play. Each entry is 8 bytes long
   231                              <1> ; (more on that later) and can contain 32 entries total, so each BAR is
   232                              <1> ; 256 bytes in length, thus:
   233                              <1> 
   234                              <1> BDL_SIZE                equ     32*8    ; Buffer Descriptor List size
   235                              <1> INDEX_MASK              equ     31      ; indexes must be 0-31
   236                              <1> 
   237                              <1> 
   238                              <1> 
   239                              <1> PI_CIV_REG              equ     4       ; PCM in current Index value (RO)
   240                              <1> PO_CIV_REG              equ     14h     ; PCM out current Index value (RO)
   241                              <1> MC_CIV_REG              equ     24h     ; MIC in current Index value (RO)
   242                              <1> ;8bit read only
   243                              <1> ; each current index value is simply a pointer showing us which buffer
   244                              <1> ; (0-31) the codec is currently processing. Once this counter hits 31, it
   245                              <1> ; wraps back to 0.
   246                              <1> ; this can be handy to know, as once it hits 31, we're almost out of data to
   247                              <1> ; play back or room to record!
   248                              <1> 
   249                              <1> 
   250                              <1> PI_LVI_REG              equ     5       ; PCM in Last Valid Index
   251                              <1> PO_LVI_REG              equ     15h     ; PCM out Last Valid Index
   252                              <1> MC_LVI_REG              equ     25h     ; MIC in Last Valid Index
   253                              <1> ;8bit read/write
   254                              <1> ; The Last Valid Index is a number (0-31) to let the codec know what buffer
   255                              <1> ; number to stop on after processing. It could be very nasty to play audio
   256                              <1> ; from buffers that aren't filled with the audio we want to play.
   257                              <1> 
   258                              <1> 
   259                              <1> PI_SR_REG               equ     6       ; PCM in Status register
   260                              <1> PO_SR_REG               equ     16h     ; PCM out Status register
   261                              <1> MC_SR_REG               equ     26h     ; MIC in Status register
   262                              <1> ;16bit read/write
   263                              <1> ; status registers.  Bitfields follow:
   264                              <1> 
   265                              <1> FIFO_ERR                equ     BIT4    ; FIFO Over/Underrun W1TC.
   266                              <1> 
   267                              <1> BCIS                    equ     BIT3    ; buffer completion interrupt status.
   268                              <1>                                         ; Set whenever the last sample in ANY
   269                              <1>                                         ; buffer is finished.  Bit is only
   270                              <1>                                         ; set when the Interrupt on Complete
   271                              <1>                                         ; (BIT4 of control reg) is set.
   272                              <1> 
   273                              <1> LVBCI                   equ     BIT2    ; Set whenever the codec has processed
   274                              <1>                                         ; the last buffer in the buffer list.
   275                              <1>                                         ; Will fire an interrupt if IOC bit is
   276                              <1>                                         ; set. Probably set after the last
   277                              <1>                                         ; sample in the last buffer is
   278                              <1>                                         ; processed.  W1TC
   279                              <1> 
   280                              <1>                                         ; 
   281                              <1> CELV                    equ     BIT1    ; Current buffer == last valid.
   282                              <1>                                         ; Bit is RO and remains set until LVI is
   283                              <1>                                         ; cleared.  Probably set up the start
   284                              <1>                                         ; of processing for the last buffer.
   285                              <1> 
   286                              <1> 
   287                              <1> DCH                     equ     BIT0    ; DMA controller halted.
   288                              <1>                                         ; set whenever audio stream is stopped
   289                              <1>                                         ; or something else goes wrong.
   290                              <1> 
   291                              <1> 
   292                              <1> PI_PICB_REG             equ     8       ; PCM in position in current buffer(RO)
   293                              <1> PO_PICB_REG             equ     18h     ; PCM out position in current buffer(RO)
   294                              <1> MC_PICB_REG             equ     28h     ; MIC in position in current buffer (RO)
   295                              <1> ;16bit read only
   296                              <1> ; position in current buffer regs show the number of dwords left to be
   297                              <1> ; processed in the current buffer.
   298                              <1> ; 
   299                              <1> 
   300                              <1> PI_PIV_REG              equ     0ah     ; PCM in Prefected index value
   301                              <1> PO_PIV_REG              equ     1ah     ; PCM out Prefected index value
   302                              <1> MC_PIV_REG              equ     2ah     ; MIC in Prefected index value
   303                              <1> ;8bit, read only
   304                              <1> ; Prefetched index value register.
   305                              <1> ; tells which buffer number (0-31) has be prefetched. I'd imagine this
   306                              <1> ; value follows the current index value fairly closely. (CIV+1)
   307                              <1> ;
   308                              <1> 
   309                              <1> 
   310                              <1> PI_CR_REG               equ     0bh     ; PCM in Control Register
   311                              <1> PO_CR_REG               equ     1bh     ; PCM out Control Register
   312                              <1> MC_CR_REG               equ     2bh     ; MIC in Control Register
   313                              <1> ; 8bit
   314                              <1> ; Control register *MUST* only be accessed as an 8bit value.
   315                              <1> ; Control register. See bitfields below.
   316                              <1> ;
   317                              <1> 
   318                              <1> 
   319                              <1> IOCE                    equ     BIT4    ; interrupt on complete enable.
   320                              <1>                                         ; set this bit if you want an intrtpt
   321                              <1>                                         ; to fire whenever LVBCI is set.
   322                              <1> FEIFE                   equ     BIT3    ; set if you want an interrupt to fire
   323                              <1>                                         ; whenever there is a FIFO (over or
   324                              <1>                                         ; under) error.
   325                              <1> LVBIE                   equ     BIT2    ; last valid buffer interrupt enable.
   326                              <1>                                         ; set if you want an interrupt to fire
   327                              <1>                                         ; whenever the completion of the last
   328                              <1>                                         ; valid buffer.
   329                              <1> RR                      equ     BIT1    ; reset registers.  Nukes all regs
   330                              <1>                                         ; except bits 4:2 of this register.
   331                              <1>                                         ; Only set this bit if BIT 0 is 0
   332                              <1> RPBM                    equ     BIT0    ; Run/Pause
   333                              <1>                                         ; set this bit to start the codec!
   334                              <1> 
   335                              <1> 
   336                              <1> GLOB_CNT_REG            equ     2ch     ; Global control register
   337                              <1> SEC_RES_EN              equ     BIT5    ; secondary codec resume event 
   338                              <1>                                         ; interrupt enable.  Not used here.
   339                              <1> PRI_RES_EN              equ     BIT4    ; ditto for primary. Not used here.
   340                              <1> ACLINK_OFF              equ     BIT3    ; Turn off the AC97 link
   341                              <1> ACWARM_RESET            equ     BIT2    ; Awaken the AC97 link from sleep.
   342                              <1>                                         ; registers preserved, bit self clears
   343                              <1> ACCOLD_RESET            equ     BIT1    ; Reset everything in the AC97 and
   344                              <1>                                         ; reset all registers.  Not self clearing
   345                              <1> 
   346                              <1> GPIIE                   equ     BIT0    ; GPI Interrupt enable.
   347                              <1>                                         ; set if you want an interrupt to
   348                              <1>                                         ; fire upon ANY of the bits in the
   349                              <1>                                         ; GPI (general pursose inputs?) not used.
   350                              <1> 
   351                              <1> GLOB_STS_REG            equ     30h     ; Global Status register (RO)
   352                              <1> 
   353                              <1> MD3                     equ     BIT17   ; modem powerdown status (yawn)
   354                              <1> AD3                     equ     BIT16   ; Audio powerdown status (yawn)
   355                              <1> RD_COMPLETE_STS         equ     BIT15   ; Codec read timed out. 0=normal
   356                              <1> BIT3SLOT12              equ     BIT14   ; shadowed status of bit 3 in slot 12
   357                              <1> BIT2SLOT12              equ     BIT13   ; shadowed status of bit 2 in slot 12
   358                              <1> BIT1SLOT12              equ     BIT12   ; shadowed status of bit 1 in slot 12
   359                              <1> SEC_RESUME_STS          equ     BIT11   ; secondary codec has resumed (and irqed)
   360                              <1> PRI_RESUME_STS          equ     BIT10   ; primary codec has resumed (and irqed)
   361                              <1> SEC_CODEC_RDY           equ     BIT9    ; secondary codec is ready for action
   362                              <1> PRI_CODEC_RDY           equ     BIT8    ; Primary codec is ready for action
   363                              <1>                                         ; software must check these bits before
   364                              <1>                                         ; starting the codec!
   365                              <1> MIC_IN_IRQ              equ     BIT7    ; MIC in caused an interrupt
   366                              <1> PCM_OUT_IRQ             equ     BIT6    ; One of the PCM out channels IRQed
   367                              <1> PCM_IN_IRQ              equ     BIT5    ; One of the PCM in channels IRQed
   368                              <1> MODEM_OUT_IRQ           equ     BIT2    ; modem out channel IRQed
   369                              <1> MODEM_IN_IRQ            equ     BIT1    ; modem in channel IRQed
   370                              <1> GPI_STS_CHANGE          equ     BIT0    ; set whenever GPI's have changed.
   371                              <1>                                         ; BIT0 of slot 12 also reflects this.
   372                              <1> 
   373                              <1> ACC_SEMA_REG            equ     34h     ; Codec write semiphore register
   374                              <1> CODEC_BUSY              equ     BIT0    ; codec register I/O is happening
   375                              <1>                                         ; self clearing
   376                              <1> ;
   377                              <1> ; Buffer Descriptors List
   378                              <1> ; As stated earlier, each buffer descriptor list is a set of (up to) 32 
   379                              <1> ; descriptors, each 8 bytes in length. Bytes 0-3 of a descriptor entry point
   380                              <1> ; to a chunk of memory to either play from or record to. Bytes 4-7 of an
   381                              <1> ; entry describe various control things detailed below.
   382                              <1> ; 
   383                              <1> ; Buffer pointers must always be aligned on a Dword boundry.
   384                              <1> ;
   385                              <1> 
   386                              <1> IOC                     equ     BIT31   ; Fire an interrupt whenever this
   387                              <1>                                         ; buffer is complete.
   388                              <1> 
   389                              <1> BUP                     equ     BIT30   ; Buffer Underrun Policy.
   390                              <1>                                         ; if this buffer is the last buffer
   391                              <1>                                         ; in a playback, fill the remaining
   392                              <1>                                         ; samples with 0 (silence) or not.
   393                              <1>                                         ; It's a good idea to set this to 1
   394                              <1>                                         ; for the last buffer in playback,
   395                              <1>                                         ; otherwise you're likely to get a lot
   396                              <1>                                         ; of noise at the end of the sound.
   397                              <1> 
   398                              <1> ;
   399                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   400                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   401                              <1> ; Luckily for us, that's the same format as .wav files.
   402                              <1> ;
   403                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   404                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   405                              <1> ;
   406                              <1> ; A value of 0 in these bits means play no samples.
   407                              <1> ;
   408                              <1> 
   409                              <1> ; 11/11/2023
   410                              <1> CTRL_ST_CREADY		equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
   411                              <1> CODEC_REG_POWERDOWN	equ	26h
    23                                  
    24                                  _STARTUP:
    25                                  
    26                                  ; memory allocation
    27                                  
    28 00000000 E85D01                          call    setFree				; deallocate unused DOS mem
    29                                  
    30                                  	; 17/02/2017
    31                                  	; Clear BSS (uninitialized data) area
    32 00000003 31C0                    	xor	ax, ax ; 0
    33 00000005 B92240                  	mov	cx, (EOF - bss_start)/2
    34 00000008 BF[DC10]                	mov	di, bss_start
    35 0000000B F3AB                    	rep	stosw
    36                                  
    37                                  ; allocate 256 bytes of data for DCM_OUT Buffer Descriptor List. (BDL)
    38                                  
    39 0000000D B81000                          mov     ax, BDL_SIZE / 16
    40 00000010 E85501                          call    memAlloc
    41 00000013 A3[0811]                        mov     [BDL_BUFFER], ax		; segment 
    42                                  
    43                                  ; allocate 2 buffers, 64k each for now.
    44                                  
    45 00000016 B80010                          mov     ax, BUFFERSIZE / 16		; 64k for .WAV file
    46 00000019 E84C01                          call    memAlloc
    47 0000001C A3[0A11]                        mov     [WAV_BUFFER1], ax		; segment
    48                                  
    49 0000001F B80010                  	mov	ax, BUFFERSIZE / 16
    50 00000022 E84301                  	call	memAlloc
    51 00000025 A3[0C11]                	mov	[WAV_BUFFER2], ax
    52                                  
    53                                  ; Detect/reset AC97 
    54                                  
    55 00000028 E8B002                          call    pciFindDevice
    56 0000002B 7342                            jnc     short _1
    57                                  
    58                                  ; couldn't find the audio device!
    59                                  
    60 0000002D 0E                      	push	cs
    61 0000002E 1F                      	pop	ds
    62 0000002F BA[3900]                        mov     dx, noDevMsg
    63 00000032 B409                            mov     ah, 9
    64 00000034 CD21                            int     21h
    65 00000036 E91701                          jmp     exit
    66                                  
    67                                  ; 17/02/2017
    68 00000039 4572726F723A20556E-     noDevMsg: db "Error: Unable to find intel ICH based audio device!",CR,LF,"$"
    68 00000042 61626C6520746F2066-
    68 0000004B 696E6420696E74656C-
    68 00000054 204943482062617365-
    68 0000005D 6420617564696F2064-
    68 00000066 6576696365210D0A24 
    69                                  
    70                                  _1:
    71                                  	; eax = BUS/DEV/FN
    72                                  	;	00000000BBBBBBBBDDDDDFFF00000000
    73                                  	; edx = DEV/VENDOR
    74                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
    75                                  
    76 0000006F 66A3[0E11]              	mov	[bus_dev_fn], eax
    77 00000073 668916[1211]            	mov	[dev_vendor], edx
    78                                  
    79                                  	; get ICH base address regs for mixer and bus master
    80                                  
    81 00000078 B010                            mov     al, NAMBAR_REG
    82 0000007A E8D001                          call    pciRegRead16			; read PCI registers 10-11
    83 0000007D 83E2FE                          and     dx, IO_ADDR_MASK 		; mask off BIT0
    84                                  
    85 00000080 8916[0411]                      mov     [NAMBAR], dx			; save audio mixer base addy
    86                                  
    87 00000084 B014                    	mov     al, NABMBAR_REG
    88 00000086 E8C401                          call    pciRegRead16
    89 00000089 83E2FE                          and     dx, IO_ADDR_MASK
    90                                  
    91 0000008C 8916[0611]                      mov     [NABMBAR], dx			; save bus master base addy
    92                                  
    93                                  	; 06/11/2023
    94                                  	;; init controller
    95                                  	;; 17/02/2017
    96                                  	;mov	al, PCI_CMD_REG ; command register (04h)
    97                                  	;call	pciRegRead16 ; pciRegRead8
    98                                  	;
    99                                  	;; eax = BUS/DEV/FN/REG
   100                                  	;;  dx = PCI Command Register Content ; 17/02/2017
   101                                  	;; 	00000000CCCCCCCC
   102                                  	;mov	[stats_cmd], dx
   103                                  	;
   104                                  	; 06/11/2023
   105                                  	;mov	al, PCI_IO_BASE ; IO base address register (10h)
   106                                  	;call	pciRegRead32
   107                                  	;
   108                                  	;and	dx, 0FFC0h	; IO_ADDR_MASK (0FFFE) ?
   109                                          ;mov	[ac97_io_base], dx
   110                                  
   111 00000090 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
   112 00000092 E8B001                  	call	pciRegRead8 ; 17/02/2017
   113                                  
   114 00000095 8816[FB10]              	mov     [ac97_int_ln_reg], dl
   115                                  
   116                                  ; 09/11/2023
   117                                  ; 05/11/2023
   118                                  %if 1
   119                                  	; 28/11/2016
   120 00000099 BB0100                  	mov	bx, 1
   121 0000009C 30F6                    	xor	dh, dh 	 ; 17/02/2017
   122                                  	; 10/11/2023
   123                                  	;mov	cx, dx
   124                                  	;shl	bx, cl
   125                                  
   126                                  	; 04/11/2023
   127 0000009E FA                      	cli
   128                                  
   129                                  	;not	bx
   130 0000009F E4A1                    	in	al, 0A1h ; irq 8-15
   131 000000A1 88C4                            mov	ah, al
   132 000000A3 E421                            in	al, 21h  ; irq 0-7 
   133                                  
   134                                  	; 04/11/2023
   135                                  	; save IRQ status
   136 000000A5 A3[FE10]                	mov	[IRQ_status], ax
   137                                  
   138                                  	;and	ax, bx   ; unmask
   139 000000A8 0FB3D0                   	btr	ax, dx	 ; unmask
   140 000000AB E621                    	out	21h, al  ; enable interrupt (if irq <= 7)
   141 000000AD 88E0                    	mov	al, ah
   142 000000AF E6A1                    	out	0A1h, al ; enable interrupt (if irq > 7)
   143                                  	;not	bx
   144                                  
   145                                  	; 04/11/2023
   146                                  	;mov	dx, 4D1h			;8259 ELCR1
   147                                          ;in	al, dx
   148                                  	;mov	ah, al
   149                                  	;mov	dx, 4D0h 
   150                                          ;in	al, dx
   151                                  	;;or	ax, bx        
   152                                  	;bts	ax, cx
   153                                  	;mov	dx, 4D0h
   154                                  	;out	dx, al                          ;set level-triggered mode
   155                                  	;mov	al, ah
   156                                  	;mov	dx, 4D1h
   157                                  	;out	dx, al                          ;set level-triggered mode
   158                                  
   159                                  	; 24/11/2016 - Erdogan Tan
   160                                  	;mov	bx, cx
   161                                  	; 10/11/2023
   162 000000B1 89D3                    	mov	bx, dx
   163 000000B3 8A9F[270F]              	mov	bl, [bx+irq_int]
   164 000000B7 C1E302                  	shl	bx, 2 ; * 4
   165                                  
   166                                  	; set up interrupt vector
   167                                  	; 30/11/2016
   168 000000BA 06                      	push	es
   169 000000BB 31C0                    	xor	ax, ax
   170 000000BD 8EC0                    	mov	es, ax
   171                                  	; 04/11/2023
   172                                  	; save interrupt vector
   173 000000BF 268B07                  	mov	ax, [es:bx]
   174 000000C2 A3[0011]                	mov	[IRQ_vector], ax
   175 000000C5 268B4702                	mov	ax, [es:bx+2]
   176 000000C9 A3[0211]                	mov	[IRQ_vector+2], ax
   177                                  
   178 000000CC 26C707[760E]            	mov	word [es:bx], ac97_int_handler
   179 000000D1 8CC8                    	mov	ax, cs
   180 000000D3 26894702                	mov	[es:bx+2], ax
   181 000000D7 07                      	pop	es
   182                                  
   183                                  	; 04/11/2023
   184 000000D8 FB                      	sti
   185                                  
   186                                  %endif
   187 000000D9 E8E70B                  	call	write_ac97_dev_info 
   188                                  
   189                                  ; check the command line for a file to play
   190                                  
   191                                          ;push	ds
   192 000000DC E89200                          call    processCmdline			; get the filename
   193                                  
   194                                  ; open the file
   195 000000DF B002                            mov     al, OPEN                        ; open existing file
   196 000000E1 E8AD00                          call    openFile                        ; no error? ok.
   197                                          ;pop	ds
   198 000000E4 7322                            jnc     short _gsr
   199                                  
   200                                  ; file not found!
   201                                  
   202                                          ;push   cs
   203                                          ;pop    ds
   204 000000E6 BA[EF00]                        mov	dx, noFileErrMsg
   205 000000E9 B409                            mov     ah, 9
   206 000000EB CD21                            int     21h
   207 000000ED EB61                            jmp     exit
   208                                  
   209                                  noFileErrMsg:
   210 000000EF 4572726F723A206669-     	db "Error: file not found.",CR,LF,"$"
   210 000000F8 6C65206E6F7420666F-
   210 00000101 756E642E0D0A24     
   211                                  
   212                                  _gsr:
   213 00000108 E8AD00                          call    getSampleRate                   ; read the sample rate
   214                                                                                  ; pass it onto codec.
   215 0000010B 7243                    	jc	short exit ; 19/11/2016 - nothing to do
   216                                  
   217 0000010D A3[1611]                	mov	[sample_rate], ax
   218                                  	
   219                                  	; 19/11/2016
   220 00000110 880E[1811]              	mov	[stmo], cl
   221 00000114 8816[1A11]              	mov	[bps], dl
   222                                  	
   223                                  	; 17/02/2017
   224 00000118 C606[1C11]00            	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit 
   225 0000011D FEC9                    	dec	cl
   226 0000011F 7504                    	jnz	short _gsr_1 ; stereo
   227 00000121 FE06[1C11]              	inc	byte [fbs_shift] ; 1 = mono or 8 bit		
   228                                  _gsr_1:	
   229 00000125 80FA08                  	cmp	dl, 8 
   230 00000128 7704                    	ja	short _gsr_2 ; 16 bit samples
   231 0000012A FE06[1C11]              	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   232                                  _gsr_2:	
   233 0000012E E8F40C                  	call	write_sample_rate
   234                                  
   235                                  	; 05/11/2023
   236                                  _2:
   237 00000131 E8FE06                  	call	check4keyboardstop  ; flush keyboard buffer
   238 00000134 72FB                    	jc	short _2 	; 07/11/2023
   239                                  
   240                                  	; 09/11/2023
   241                                  	;; 05/11/2023
   242                                  	;mov	eax, [bus_dev_fn]
   243                                  	;mov	al, PCI_CMD_REG
   244                                  	;call	pciRegRead16			; read PCI command register
   245                                  	;; 17/02/2017
   246                                  	;;mov	dx, [stats_cmd]
   247                                          ;or	dl, IO_ENA+BM_ENA               ; enable IO and bus master
   248                                  	;call	pciRegWrite16 ; pciRegWrite8
   249                                  
   250                                  	;; 06/11/2023
   251                                  	;;mov	eax, [bus_dev_fn]
   252                                  	;;mov	al, PCI_CMD_REG
   253                                  	;;call	pciRegRead8                     ; read PCI command register
   254                                  	;;or	dl, IO_ENA+BM_ENA               ; enable IO and bus master
   255                                  	;;call	pciRegWrite8
   256                                  
   257                                  ; setup the Codec (actually mixer registers) 
   258 00000136 E8E601                          call    codecConfig                     ; unmute codec, set rates.
   259                                  	; 11/11/2023
   260 00000139 721C                    	jc	short init_err
   261                                  ;
   262                                  ; position file pointer to start in actual wav data
   263                                  ; MUCH improvement should really be done here to check if sample size is
   264                                  ; supported, make sure there are 2 channels, etc.  
   265                                  ;
   266 0000013B B442                            mov     ah, 42h
   267 0000013D B000                            mov     al, 0                           ; from start of file
   268 0000013F 8B1E[F810]                      mov     bx, [filehandle]
   269 00000143 31C9                            xor     cx, cx
   270 00000145 BA2C00                          mov     dx, 44                          ; jump past .wav/riff header
   271 00000148 CD21                            int     21h
   272                                  
   273                                  ; play the .wav file. Most of the good stuff is in here.
   274                                  
   275 0000014A E83803                          call    playWav
   276                                  
   277                                  ; close the .wav file and exit.
   278                                  
   279                                  close_exit:			; 11/11/2023
   280 0000014D E85300                          call    closeFile
   281                                  
   282                                  exit:
   283 00000150 B8004C                          mov     ax, 4c00h
   284 00000153 CD21                    	int 	21h
   285                                  
   286                                  here:
   287 00000155 EBFE                    	jmp	short here
   288                                  
   289                                  	; 11/11/2023
   290                                  init_err:
   291 00000157 BA[7210]                	mov	dx, msg_init_err
   292                                  vra_err: ; 12/11/2023
   293 0000015A B409                            mov	ah, 9
   294 0000015C CD21                            int	21h
   295 0000015E EBED                    	jmp	short close_exit
   296                                  
   297                                  ; MEMALLOC.ASM
   298                                  ;-- SETFREE: Release memory not used  ----------------
   299                                  ;-- Input    : ES = address of PSP
   300                                  ;-- Output   : none
   301                                  ;-- Register : AX, BX, CL and FLAGS are changed 
   302                                  ;-- Info     : Since the stack-segment is always the last segment in an 
   303                                  ;              EXE-file, ES:0000 points to the beginning and SS:SP
   304                                  ;              to the end of the program in memory. Through this the
   305                                  ;              length of the program can be calculated 
   306                                  ; call this routine once at the beginning of the program to free up memory
   307                                  ; assigned to it by DOS.
   308                                  
   309                                  setFree:
   310 00000160 BB0010                  	  mov	bx, 65536/16	; 4K paragraphs ; 17/02/2017 (Erdogan Tan)		
   311                                  
   312 00000163 B44A                              mov	ah, 4ah		; pass new length to DOS
   313 00000165 CD21                              int	21h
   314                                  
   315 00000167 C3                                retn			; back to caller 
   316                                  				; new size (allocated memory) = 64KB
   317                                  
   318                                  memAlloc:
   319                                  ; input: AX = # of paragraphs required
   320                                  ; output: AX = segment of block to use
   321                                  
   322 00000168 53                      	push	bx
   323 00000169 89C3                    	mov	bx, ax
   324 0000016B B448                    	mov	ah, 48h
   325 0000016D CD21                    	int	21h
   326 0000016F 5B                      	pop	bx
   327 00000170 C3                      	retn
   328                                  
   329                                  ; CMDLINE.ASM
   330                                  ; parse the command line
   331                                  ; entry: none
   332                                  ; exit: DS:DX to the 1st supplied item on the command line 
   333                                  
   334                                  processCmdline:
   335 00000171 53                              push    bx
   336 00000172 56                              push    si
   337                                  
   338                                          ;mov    ah, 51h
   339                                          ;int    21h
   340                                          ;mov    ds, bx
   341                                  
   342 00000173 BE8000                          mov     si, 80h
   343 00000176 0FB61C                          movzx   bx, byte [si]
   344 00000179 01DE                            add     si, bx
   345 0000017B 46                              inc     si
   346                                  
   347 0000017C C60400                          mov     byte [si], NULL         ; zero terminate
   348                                  
   349 0000017F BE8100                          mov     si, 81h
   350                                  
   351                                  cmdlineloop:
   352 00000182 AC                              lodsb
   353                                  
   354 00000183 3C00                            cmp     al, NULL                ; found end of line?
   355 00000185 7404                            je      short exitpc
   356 00000187 3C20                            cmp     al, ' '                 ; found a space?
   357 00000189 74F7                            je      short cmdlineloop
   358                                  
   359                                          ; must be the filename here.
   360                                  exitpc:
   361 0000018B 4E                              dec     si                      ; point to start of filename
   362 0000018C 89F2                            mov     dx, si
   363 0000018E 5E                              pop     si
   364 0000018F 5B                              pop     bx
   365 00000190 C3                      	retn
   366                                  
   367                                  ; FILE.ASM
   368                                  ;open or create file
   369                                  ;
   370                                  ;input: ds:dx-->filename (asciiz)
   371                                  ;       al=file Mode (create or open)
   372                                  ;output: none  cs:[filehandle] filled
   373                                  ;
   374                                  openFile:
   375 00000191 50                      	push	ax
   376 00000192 51                      	push	cx
   377 00000193 B43B                    	mov	ah, 3bh			; start with a mode
   378 00000195 00C4                    	add	ah, al			; add in create or open mode
   379 00000197 31C9                    	xor	cx, cx
   380 00000199 CD21                    	int	21h
   381 0000019B 7203                    	jc	short _of1
   382                                  	;mov	[cs:filehandle], ax
   383 0000019D A3[F810]                	mov	[filehandle], ax
   384                                  _of1:
   385 000001A0 59                      	pop	cx
   386 000001A1 58                      	pop	ax
   387 000001A2 C3                      	retn
   388                                  
   389                                  ; close the currently open file
   390                                  ; input: none, uses cs:[filehandle]
   391                                  closeFile:
   392 000001A3 50                      	push	ax
   393 000001A4 53                      	push	bx
   394 000001A5 833E[F810]FF            	cmp	word [filehandle], -1
   395 000001AA 7409                    	jz	short _cf1
   396 000001AC 8B1E[F810]              	mov     bx, [filehandle]  
   397 000001B0 B8003E                  	mov     ax,3e00h
   398 000001B3 CD21                            int     21h              ;close file
   399                                  _cf1:
   400 000001B5 5B                      	pop	bx
   401 000001B6 58                      	pop	ax
   402 000001B7 C3                      	retn
   403                                  
   404                                  getSampleRate:
   405                                  	; 08/12/2016
   406                                  ; reads the sample rate from the .wav file.
   407                                  ; entry: none - assumes file is already open
   408                                  	; 19/11/2016 - Erdogan Tan
   409                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   410                                  ;	cx = number of channels (mono=1, stereo=2)
   411                                  ;	dx = bits per sample (8, 16)
   412                                  
   413 000001B8 53                      	push    bx
   414                                  
   415 000001B9 B442                            mov     ah, 42h
   416 000001BB B000                            mov     al, 0				; from start of file
   417 000001BD 8B1E[F810]                      mov     bx, [filehandle]
   418 000001C1 31C9                            xor     cx, cx
   419 000001C3 BA0800                          mov     dx, 08h				; "WAVE"
   420 000001C6 CD21                            int     21h
   421                                  
   422 000001C8 BA[DC10]                        mov     dx, smpRBuff
   423 000001CB B91C00                          mov     cx, 28				; 28 bytes
   424 000001CE B43F                    	mov	ah, 3fh
   425 000001D0 CD21                            int     21h
   426                                  
   427 000001D2 813E[DC10]5741          	cmp	word [smpRBuff], 'WA'
   428 000001D8 751C                    	jne	short gsr_stc
   429                                  
   430 000001DA 813E[DE10]5645          	cmp	word [smpRBuff+2], 'VE'
   431 000001E0 7514                    	jne	short gsr_stc
   432                                  
   433 000001E2 833E[E810]01            	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   434 000001E7 750D                    	jne	short gsr_stc
   435                                  
   436                                  
   437 000001E9 8B0E[EA10]              	mov	cx, [smpRBuff+14]	; return num of channels in CX
   438 000001ED A1[EC10]                        mov     ax, [smpRBuff+16]	; return sample rate in AX
   439 000001F0 8B16[F610]              	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   440                                  gsr_retn:
   441 000001F4 5B                              pop     bx
   442 000001F5 C3                              retn
   443                                  
   444                                  gsr_stc:
   445 000001F6 F9                      	stc
   446 000001F7 EBFB                    	jmp	short gsr_retn
   447                                  
   448                                  %include 'ac97.asm' ; 29/11/2016 (AC97 codec configuration)
     1                              <1> ; 13/11/2023
     2                              <1> ; 12/11/2023
     3                              <1> ; 11/11/2023
     4                              <1> ; 06/11/2023
     5                              <1> ; 05/11/2023
     6                              <1> ; 04/11/2023
     7                              <1> ; 03/11/2023
     8                              <1> ; PCI and AC97 codec functions for wav player
     9                              <1> ; Erdogan Tan (17/02/2017)
    10                              <1> 
    11                              <1> ; ----------------------------------------------------------------------------
    12                              <1> ; PCI.ASM
    13                              <1> ; ----------------------------------------------------------------------------
    14                              <1> 
    15                              <1> ; PCI device register reader/writers.
    16                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    17                              <1> ; 		Last Update: 17/02/2017
    18                              <1> 
    19                              <1> ;===============================================================
    20                              <1> ; 8/16/32bit PCI reader
    21                              <1> ;
    22                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    23                              <1> ;           BIT30 set if 32 bit access requested
    24                              <1> ;           BIT29 set if 16 bit access requested
    25                              <1> ;           otherwise defaults to 8 bit read
    26                              <1> ;
    27                              <1> ; Exit:  DL,DX,EDX register data depending on requested read size
    28                              <1> ;
    29                              <1> ; Note: this routine is meant to be called via pciRegRead8, pciRegread16,
    30                              <1> ;	or pciRegRead32, listed below.
    31                              <1> ;
    32                              <1> ; Note2: don't attempt to read 32bits of data from a non dword aligned reg
    33                              <1> ;	 number. Likewise, don't do 16bit reads from non word aligned reg #
    34                              <1> ; 
    35                              <1> pciRegRead:
    36 000001F9 6653                <1> 	push	ebx
    37 000001FB 51                  <1> 	push	cx
    38 000001FC 6689C3              <1>         mov     ebx, eax                        ; save eax, dh
    39 000001FF 88F1                <1>         mov     cl, dh
    40 00000201 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    41 00000207 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
    42 0000020D 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
    43                              <1> 
    44 0000020F BAF80C              <1>         mov     dx, PCI_INDEX_PORT
    45 00000212 66EF                <1>         out     dx, eax                         ; write PCI selector
    46                              <1> 
    47 00000214 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
    48 00000217 88D8                <1>         mov     al, bl
    49 00000219 2403                <1>         and     al, 3                           ; figure out which port to
    50 0000021B 00C2                <1>         add     dl, al                          ; read to
    51                              <1> 
    52 0000021D 66ED                <1> 	in      eax, dx                         ; do 32bit read
    53 0000021F 66F7C300000080      <1>         test    ebx, PCI32
    54 00000226 7403                <1>         jz      short _pregr1
    55                              <1> 
    56 00000228 6689C2              <1>         mov     edx, eax                        ; return 32bits of data
    57                              <1> _pregr1:
    58 0000022B 89C2                <1> 	mov     dx, ax                          ; return 16bits of data
    59 0000022D 66F7C3000000C0      <1>         test    ebx, PCI32+PCI16
    60 00000234 7502                <1>         jnz     short _pregr2
    61 00000236 88CE                <1>         mov     dh, cl                          ; restore dh for 8 bit read
    62                              <1> _pregr2:
    63 00000238 6689D8              <1>         mov     eax, ebx                        ; restore eax
    64 0000023B 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    65 00000241 59                  <1> 	pop	cx
    66 00000242 665B                <1> 	pop	ebx
    67 00000244 C3                  <1> 	retn
    68                              <1> 
    69                              <1> pciRegRead8:
    70 00000245 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32             ; set up 8 bit read size
    71 0000024B EBAC                <1>         jmp     short pciRegRead		; call generic PCI access
    72                              <1> 
    73                              <1> pciRegRead16:
    74 0000024D 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit read size
    75 00000253 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
    76 00000259 EB9E                <1>         jmp     short pciRegRead
    77                              <1> 
    78                              <1> pciRegRead32:
    79 0000025B 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit read size
    80 00000261 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
    81 00000267 EB90                <1>         jmp     short pciRegRead
    82                              <1> 
    83                              <1> ;===============================================================
    84                              <1> ; 8/16/32bit PCI writer
    85                              <1> ;
    86                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    87                              <1> ;           BIT31 set if 32 bit access requested
    88                              <1> ;           BIT30 set if 16 bit access requested
    89                              <1> ;           otherwise defaults to 8bit read
    90                              <1> ;        DL/DX/EDX data to write depending on size
    91                              <1> ;
    92                              <1> ;
    93                              <1> ; note: this routine is meant to be called via pciRegWrite8, pciRegWrite16,
    94                              <1> ; 	or pciRegWrite32 as detailed below.
    95                              <1> ;
    96                              <1> ; Note2: don't attempt to write 32bits of data from a non dword aligned reg
    97                              <1> ;	 number. Likewise, don't do 16bit writes from non word aligned reg #
    98                              <1> ;
    99                              <1> pciRegWrite:
   100 00000269 6653                <1> 	push	ebx
   101 0000026B 51                  <1> 	push	cx
   102 0000026C 6689C3              <1>         mov     ebx, eax                        ; save eax, dx
   103 0000026F 89D1                <1>         mov     cx, dx
   104 00000271 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
   105 00000277 6625FFFFFFBF        <1>         and     eax, ~PCI16 ; NOT PCI16         ; clear out data size request
   106 0000027D 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
   107                              <1> 
   108 0000027F BAF80C              <1>         mov     dx, PCI_INDEX_PORT
   109 00000282 66EF                <1>         out     dx, eax                         ; write PCI selector
   110                              <1> 
   111 00000284 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
   112 00000287 88D8                <1>         mov     al, bl
   113 00000289 2403                <1>         and     al, 3                           ; figure out which port to
   114 0000028B 00C2                <1>         add     dl, al                          ; write to
   115                              <1> 
   116 0000028D 6689D0              <1>         mov     eax, edx                        ; put data into eax
   117 00000290 89C8                <1>         mov     ax, cx
   118                              <1> 
   119 00000292 EE                  <1>         out     dx, al
   120 00000293 66F7C3000000C0      <1>         test    ebx, PCI16+PCI32                ; only 8bit access? bail
   121 0000029A 740C                <1>         jz      short _pregw1
   122                              <1> 
   123 0000029C EF                  <1>         out     dx, ax                          ; write 16 bit value
   124 0000029D 66F7C300000040      <1>         test    ebx, PCI16                      ; 16bit requested?  bail
   125 000002A4 7502                <1>         jnz     short _pregw1
   126                              <1> 
   127 000002A6 66EF                <1>         out     dx, eax                         ; write full 32bit
   128                              <1> _pregw1:
   129 000002A8 6689D8              <1>         mov     eax, ebx                        ; restore eax
   130 000002AB 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
   131 000002B1 89CA                <1>         mov     dx, cx                          ; restore dx
   132 000002B3 59                  <1> 	pop	cx
   133 000002B4 665B                <1> 	pop	ebx
   134 000002B6 C3                  <1> 	ret
   135                              <1> 
   136                              <1> pciRegWrite8:
   137 000002B7 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 8 bit write size
   138 000002BD EBAA                <1>         jmp     short pciRegWrite		; call generic PCI access
   139                              <1> 
   140                              <1> pciRegWrite16:
   141 000002BF 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit write size
   142 000002C5 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
   143 000002CB EB9C                <1>         jmp     short pciRegWrite
   144                              <1> 
   145                              <1> pciRegWrite32:
   146 000002CD 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit write size
   147 000002D3 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
   148 000002D9 EB8E                <1>         jmp     short pciRegWrite
   149                              <1> 
   150                              <1> ; 17/02/2017 (Modifed by Erdogan Tan for various ICH device IDs)
   151                              <1> ;===============================================================
   152                              <1> ; PCIFindDevice: scan through PCI space looking for a device+vendor ID
   153                              <1> ;
   154                              <1> ;  ENTRY: none
   155                              <1> ;; Entry: EAX=Device+Vendor ID
   156                              <1> ;
   157                              <1> ;  Exit: EAX=PCI address if device found
   158                              <1> ;	 EDX=Device+Vendor ID
   159                              <1> ;        CY clear if found, set if not found. EAX invalid if CY set.
   160                              <1> ;
   161                              <1> ; [old stackless] Destroys: ebx, esi, edi, cl
   162                              <1> ;
   163                              <1> pciFindDevice:
   164                              <1> 	;push	cx
   165                              <1> 	;push	eax ; *
   166                              <1> 	;push	esi
   167                              <1> 	;push	edi
   168                              <1> 
   169                              <1>  	;mov     esi, eax                ; save off vend+device ID
   170                              <1> 
   171                              <1> 	; 17/02/2017
   172 000002DB BE[370F]            <1> 	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
   173 000002DE B91500              <1> 	mov	cx, valid_id_count
   174                              <1> pfd_0:
   175 000002E1 66BF00FFFF7F        <1>        	mov     edi, (80000000h - 100h) ; start with bus 0, dev 0 func 0
   176                              <1> nextPCIdevice:
   177 000002E7 6681C700010000      <1>         add     edi, 100h
   178 000002EE 6681FF00F8FF80      <1>         cmp     edi, 80FFF800h		; scanned all devices?
   179                              <1>         ;stc
   180                              <1>         ;je 	short PCIScanExit       ; not found
   181 000002F5 720D                <1> 	jb	short pfd_1
   182 000002F7 66BF00000080        <1> 	mov     edi, 80000000h
   183 000002FD 83C604              <1> 	add	si, 4 ; scan for next device ID
   184 00000300 E202                <1> 	loop	pfd_1	 
   185 00000302 F9                  <1> 	stc	
   186                              <1> 	;jmp 	short PCIScanExit
   187 00000303 C3                  <1> 	retn
   188                              <1> pfd_1:
   189 00000304 6689F8              <1>         mov     eax, edi                ; read PCI registers
   190 00000307 E851FF              <1>         call    pciRegRead32
   191                              <1>         ;cmp    edx, esi                ; found device?
   192 0000030A 663B14              <1>         cmp	edx, dword [si]
   193 0000030D 75D8                <1> 	jne     short nextPCIdevice
   194                              <1>         ;clc
   195                              <1> PCIScanExit:
   196                              <1> 	;pushf
   197 0000030F 66B800000080        <1> 	mov	eax, BIT31
   198 00000315 66F7D0              <1> 	not	eax
   199 00000318 6621F8              <1> 	and	eax, edi		; return only bus/dev/fn #
   200                              <1> 	;popf
   201                              <1> 
   202                              <1> 	;pop	edi
   203                              <1> 	;pop	esi
   204                              <1> 	;pop	edx ; *
   205                              <1> 	;pop	cx
   206 0000031B C3                  <1> 	retn
   207                              <1> 
   208                              <1> ; ----------------------------------------------------------------------------
   209                              <1> ; CODEC.ASM
   210                              <1> ; ----------------------------------------------------------------------------
   211                              <1> 
   212                              <1> ; codec configuration code. Not much here really.
   213                              <1> ; NASM version: Erdogan Tan (29/11/2016)
   214                              <1> 
   215                              <1> ; enable codec, unmute stuff, set output rate to 44.1
   216                              <1> ; entry: ax = desired sample rate
   217                              <1> 
   218                              <1> ; 11/11/2023
   219                              <1> ; 06/11/2023
   220                              <1> %if 1
   221                              <1> 
   222                              <1> 	; 11/11/2023
   223                              <1> init_ac97_codec_err1:
   224 0000031C F9                  <1> 	stc
   225                              <1> init_ac97_codec_err2:
   226 0000031D C3                  <1> 	retn
   227                              <1> 
   228                              <1> 	; 13/11/2023
   229 0000031E 01                  <1> VRA:	db 1	
   230                              <1> 
   231                              <1> codecConfig:
   232                              <1> 	; 04/11/2023
   233                              <1> 	; 17/02/2017 
   234                              <1> 	; 07/11/2016 (Erdogan Tan)
   235                              <1> 	;PORT_NABM_GLB_CTRL_STAT equ 60h
   236                              <1> 
   237                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   238                              <1>  	; 'AC97_DEF.H'
   239                              <1> 	;AC97_EXTENDED_STATUS equ 002Ah
   240                              <1> 	AC97_EA_SPDIF	equ 0002h
   241                              <1> 	AC97_EA_VRA	equ 0001h
   242                              <1> 	; 04/11/2023
   243                              <1> 	ICH_PO_CR_RESET equ 0002h  ; reset codec
   244                              <1> 	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
   245                              <1> 	ICH_PCM_246_MASK equ 300000h ; 6 channels
   246                              <1> 
   247                              <1> 	; 04/11/2023
   248                              <1> init_ac97_controller:
   249 0000031F 66A1[0E11]          <1> 	mov	eax, [bus_dev_fn]
   250 00000323 B004                <1> 	mov	al, PCI_CMD_REG
   251 00000325 E825FF              <1> 	call	pciRegRead16		; read PCI command register
   252 00000328 80CA05              <1> 	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
   253 0000032B E891FF              <1> 	call	pciRegWrite16
   254                              <1> 
   255 0000032E E84901              <1> 	call	delay_100ms
   256                              <1> 
   257                              <1> init_ac97_codec:
   258                              <1> 	; 11/11/2023
   259                              <1> 	; (TRDOS 386 v2.0.5, 'audio.s')
   260 00000331 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   261 00000334 0316[0611]          <1> 	add	dx, [NABMBAR]
   262 00000338 66ED                <1> 	in	eax, dx
   263                              <1> 	; ?
   264 0000033A BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   265 0000033D 0316[0611]          <1> 	add	dx, [NABMBAR]
   266 00000341 66ED                <1> 	in	eax, dx
   267                              <1> 
   268 00000343 6683F8FF            <1> 	cmp	eax, 0FFFFFFFFh ; -1
   269 00000347 74D3                <1> 	je	short init_ac97_codec_err1
   270                              <1> 
   271 00000349 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   272 0000034F 7503                <1> 	jnz	short _ac97_codec_ready
   273                              <1> 
   274 00000351 E8A600              <1> 	call	reset_ac97_codec
   275                              <1> 	; 11/11/2023
   276                              <1> 	;jc	short init_ac97_codec_err2
   277                              <1> 
   278                              <1> _ac97_codec_ready:
   279 00000354 8B16[0411]          <1> 	mov	dx, [NAMBAR]
   280                              <1> 	;add	dx, 0 ; ac_reg_0 ; reset register
   281 00000358 EF                  <1> 	out	dx, ax
   282                              <1> 
   283 00000359 E81E01              <1> 	call	delay_100ms
   284                              <1> 
   285                              <1> ;	xor	eax, eax ; 0
   286                              <1> ;	mov	dx, [NAMBAR]
   287                              <1> ;	add	dx, CODEC_REG_POWERDOWN
   288                              <1> ;	out	dx, ax
   289                              <1> ;
   290                              <1> ;	; wait for 1 second
   291                              <1> ;	mov	ecx, 1000 ; 1000*0.25ms = 1s
   292                              <1> ;_ac97_codec_rloop:
   293                              <1> ;	call	delay1_4ms
   294                              <1> ;	call	delay1_4ms
   295                              <1> ;	call	delay1_4ms
   296                              <1> ;	call	delay1_4ms
   297                              <1> ;	;mov	dx, [NAMBAR]
   298                              <1> ;	;add	dx, CODEC_REG_POWERDOWN
   299                              <1> ;	in	ax, dx	
   300                              <1> ;	and	ax, 0Fh
   301                              <1> ;	cmp	al, 0Fh
   302                              <1> ;	je	short _ac97_codec_init_ok
   303                              <1> ;	loop	_ac97_codec_rloop 
   304                              <1> ;
   305                              <1> ;init_ac97_codec_err1:
   306                              <1> ;	stc
   307                              <1> ;
   308                              <1> ;init_ac97_codec_err2:
   309                              <1> ;	retn
   310                              <1> 
   311                              <1> _ac97_codec_init_ok:
   312                              <1>         ; 11/11/2023
   313                              <1> 	;mov	al, 2 ; force set 16-bit 2-channel PCM
   314                              <1> 	;mov	dx, GLOB_CNT_REG ; 2Ch
   315                              <1> 	;add	dx, [NABMBAR]
   316                              <1> 	;out	dx, eax
   317                              <1> 
   318                              <1> 	;;call	delay1_4ms
   319                              <1> 
   320 0000035C E86600              <1> 	call 	reset_ac97_controller
   321                              <1> 
   322                              <1> 	; 11/11/2023
   323 0000035F E84109              <1> 	call	delay1_4ms
   324                              <1> 
   325                              <1> 	;call 	setup_ac97_codec
   326                              <1> 
   327                              <1> setup_ac97_codec:
   328                              <1> 	; 12/11/2023
   329 00000362 813E[1611]80BB      <1> 	cmp	word [sample_rate], 48000
   330 00000368 742F                <1> 	je	short skip_rate
   331                              <1> 
   332                              <1> ; 11/11/2023
   333                              <1> ; 05/11/2023
   334                              <1> ;%if 1
   335                              <1> 	AC97_EA_VRA equ BIT0 ; 11/11/2023
   336                              <1> 
   337                              <1> 	; 11/11/2023
   338 0000036A 8B16[0411]          <1> 	mov    	dx, [NAMBAR]               	
   339 0000036E 83C22A              <1> 	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah  	  
   340 00000371 ED                  <1> 	in     	ax, dx
   341 00000372 24FD                <1> 	and	al, ~BIT1 ; Clear DRA
   342 00000374 0C01                <1> 	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
   343 00000376 EF                  <1> 	out	dx, ax			; Enable variable rate audio
   344                              <1> 	
   345 00000377 B90A00              <1> 	mov	cx, 10
   346                              <1> check_vra:
   347 0000037A E8FD00              <1> 	call	delay_100ms
   348                              <1> 
   349                              <1> 	; 11/11/2023
   350 0000037D ED                  <1> 	in	ax, dx
   351 0000037E A801                <1> 	test	al, AC97_EA_VRA ; 1
   352 00000380 7509                <1> 	jnz	short set_rate
   353                              <1> 
   354                              <1> 	; 11/11/2023
   355 00000382 E2F6                <1> 	loop	check_vra
   356                              <1> 
   357                              <1> 	; 13/11/2023
   358 00000384 C606[1E03]00        <1> 	mov	byte [VRA], 0
   359 00000389 EB0E                <1> 	jmp	short skip_rate	
   360                              <1> 
   361                              <1> 	; 12/11/2023
   362                              <1> 	;pop	ax ; discard return address to the caller
   363                              <1> 	;mov	dx, msg_no_vra
   364                              <1> 	;jmp	vra_err
   365                              <1> 
   366                              <1> set_rate:
   367 0000038B A1[1611]            <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   368                              <1> 
   369 0000038E 8B16[0411]          <1> 	mov    	dx, [NAMBAR]               	
   370 00000392 83C22C              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   371 00000395 EF                  <1> 	out	dx, ax 			; PCM Front/Center Output Sample Rate
   372                              <1> 
   373 00000396 E8E100              <1> 	call	delay_100ms
   374                              <1> 
   375                              <1> 	; 12/11/2023
   376                              <1> skip_rate:
   377                              <1> 	; 11/11/2023 (temporary)
   378                              <1> 
   379                              <1> 	;mov   	dx, [NAMBAR]               	
   380                              <1> 	;add   	dx, CODEC_PCM_SURND_DACRATE_REG	; 2Eh  	  
   381                              <1> 	;out	dx, ax 			; PCM Surround Output Sample Rate
   382                              <1> 
   383                              <1> 	;call	delay_100ms
   384                              <1> 
   385                              <1> 	;mov   	dx, [NAMBAR]               	
   386                              <1> 	;add   	dx, CODEC_PCM_LFE_DACRATE_REG	; 30h  	  
   387                              <1> 	;out	dx, ax 			; PCM LFE Output Sample Rate
   388                              <1> 
   389                              <1> 	;call	delay_100ms
   390                              <1> 
   391                              <1> 	; 05/11/2023 (temporary)
   392                              <1> 	;mov	dx, [NAMBAR]               	
   393                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   394                              <1> 	;out	dx, ax 			; PCM Input Sample Rate
   395                              <1> 	;
   396                              <1> 	;call	delay_100ms
   397                              <1> 
   398 00000399 B80202              <1> 	mov	ax, 0202h
   399 0000039C 8B16[0411]          <1>   	mov     dx, [NAMBAR]
   400 000003A0 83C202              <1>   	add     dx, CODEC_MASTER_VOL_REG	;02h 
   401 000003A3 EF                  <1> 	out     dx, ax
   402                              <1> 
   403                              <1> 	; 11/11/2023
   404                              <1>         ;call	delay1_4ms
   405                              <1>         ;call	delay1_4ms
   406                              <1>         ;call	delay1_4ms
   407                              <1>         ;call	delay1_4ms
   408                              <1>  	;
   409                              <1>   	;mov	dx, [NAMBAR]
   410                              <1>   	;add	dx, CODEC_MASTER_MONO_VOL_REG	;06h 
   411                              <1>   	;out	dx, ax
   412                              <1> 
   413                              <1> 	; 11/11/2023
   414                              <1>         ;call	delay1_4ms
   415                              <1>         ;call	delay1_4ms
   416                              <1>         ;call	delay1_4ms
   417                              <1>         ;call	delay1_4ms
   418                              <1> 	;
   419                              <1> 	;mov	ax, 02h
   420                              <1>   	;mov	dx, [NAMBAR]
   421                              <1>   	;add	dx, CODEC_PCBEEP_VOL_REG	;0Ah 
   422                              <1>   	;out	dx, ax
   423                              <1> 
   424 000003A4 E8FC08              <1>         call    delay1_4ms
   425 000003A7 E8F908              <1>         call    delay1_4ms
   426 000003AA E8F608              <1>         call    delay1_4ms
   427 000003AD E8F308              <1>         call    delay1_4ms
   428                              <1> 
   429                              <1> 	;mov	ax, 0202h
   430 000003B0 8B16[0411]          <1>   	mov     dx, [NAMBAR]
   431 000003B4 83C218              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h 
   432 000003B7 EF                  <1>   	out     dx, ax
   433                              <1> 
   434 000003B8 E8E808              <1>         call    delay1_4ms
   435 000003BB E8E508              <1>         call    delay1_4ms
   436 000003BE E8E208              <1>         call    delay1_4ms
   437 000003C1 E8DF08              <1>         call    delay1_4ms
   438                              <1> 
   439                              <1> 	; 11/11/2023
   440                              <1> 	;mov	ax, 8008h ; Mute
   441                              <1>   	;mov	dx, [NAMBAR]
   442                              <1> 	;add	dx, CODEC_PHONE_VOL_REG		;0Ch
   443                              <1> 	;			 ; AC97_PHONE_VOL ; TAD Input (Mono)
   444                              <1>   	;out	dx, ax
   445                              <1> 	;
   446                              <1>         ;call	delay1_4ms
   447                              <1>         ;call	delay1_4ms
   448                              <1>         ;call	delay1_4ms
   449                              <1> 	;call	delay1_4ms
   450                              <1> 
   451                              <1> 	;mov	ax, 0808h
   452                              <1> 	;mov	dx, [NAMBAR]
   453                              <1> 	;add	dx, CODEC_LINE_IN_VOL_REG ;10h ; Line Input (Stereo)
   454                              <1> 	;out	dx, ax
   455                              <1> 	;
   456                              <1>         ;call	delay1_4ms
   457                              <1>         ;call	delay1_4ms
   458                              <1>         ;call	delay1_4ms
   459                              <1> 	;call	delay1_4ms
   460                              <1> 
   461                              <1>   	;mov	dx, [NAMBAR]
   462                              <1>         ;add	dx, CODEC_CD_VOL_REG ;12h ; CD Input (Stereo)
   463                              <1>   	;out	dx, ax
   464                              <1> 	;
   465                              <1>   	;mov	dx, [NAMBAR]
   466                              <1>         ;add	dx, CODEC_AUX_VOL_REG ;16h ; Aux Input (Stereo)
   467                              <1>   	;out	dx, ax
   468                              <1> 	;
   469                              <1>         ;call	delay1_4ms
   470                              <1>         ;call	delay1_4ms
   471                              <1>         ;call	delay1_4ms
   472                              <1> 	;call	delay1_4ms
   473                              <1> 
   474                              <1> ;detect_ac97_codec:
   475 000003C4 C3                  <1>         retn
   476                              <1> 
   477                              <1> reset_ac97_controller:
   478                              <1> 	; 11/11/2023
   479                              <1> 	; 10/06/2017
   480                              <1> 	; 29/05/2017
   481                              <1> 	; 28/05/2017
   482                              <1> 	; reset AC97 audio controller registers
   483 000003C5 31C0                <1> 	xor     ax, ax
   484 000003C7 BA0B00              <1>         mov	dx, PI_CR_REG
   485 000003CA 0316[0611]          <1> 	add	dx, [NABMBAR]
   486 000003CE EE                  <1> 	out     dx, al
   487                              <1> 
   488 000003CF BA1B00              <1>         mov     dx, PO_CR_REG
   489 000003D2 0316[0611]          <1> 	add	dx, [NABMBAR]
   490 000003D6 EE                  <1> 	out     dx, al
   491                              <1> 
   492 000003D7 BA2B00              <1>         mov     dx, MC_CR_REG
   493 000003DA 0316[0611]          <1> 	add	dx, [NABMBAR]
   494 000003DE EE                  <1> 	out     dx, al
   495                              <1> 
   496 000003DF B002                <1>         mov     al, RR
   497 000003E1 BA0B00              <1>         mov     dx, PI_CR_REG
   498 000003E4 0316[0611]          <1> 	add	dx, [NABMBAR]
   499 000003E8 EE                  <1> 	out     dx, al
   500                              <1> 
   501 000003E9 BA1B00              <1>         mov     dx, PO_CR_REG
   502 000003EC 0316[0611]          <1> 	add	dx, [NABMBAR]
   503 000003F0 EE                  <1> 	out     dx, al
   504                              <1> 
   505 000003F1 BA2B00              <1>         mov     dx, MC_CR_REG
   506 000003F4 0316[0611]          <1> 	add	dx, [NABMBAR]
   507 000003F8 EE                  <1> 	out     dx, al
   508                              <1> 
   509 000003F9 C3                  <1> 	retn
   510                              <1> 
   511                              <1> reset_ac97_codec:
   512                              <1> 	; 11/11/2023
   513                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   514 000003FA BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   515 000003FD 0316[0611]          <1> 	add	dx, [NABMBAR]
   516 00000401 66ED                <1> 	in	eax, dx
   517                              <1> 
   518                              <1> 	;test	eax, 2
   519                              <1> 	; 06/08/2022
   520 00000403 A802                <1> 	test	al, 2
   521 00000405 7405                <1> 	jz	short _r_ac97codec_cold	
   522                              <1> 
   523 00000407 E80E00              <1> 	call	warm_ac97codec_reset
   524 0000040A 7306                <1> 	jnc	short _r_ac97codec_ok
   525                              <1> _r_ac97codec_cold:
   526 0000040C E83400              <1>         call    cold_ac97codec_reset
   527 0000040F 7301                <1>         jnc     short _r_ac97codec_ok
   528                              <1> 	
   529                              <1> 	; 16/04/2017
   530                              <1>         ;xor	eax, eax	; timeout error
   531                              <1>        	;stc
   532 00000411 C3                  <1> 	retn
   533                              <1> 
   534                              <1> _r_ac97codec_ok:
   535 00000412 6631C0              <1>         xor     eax, eax
   536                              <1>         ;mov	al, VIA_ACLINK_C00_READY ; 1
   537 00000415 FEC0                <1>         inc	al
   538 00000417 C3                  <1> 	retn
   539                              <1> 
   540                              <1> warm_ac97codec_reset:
   541                              <1> 	; 11/11/2023
   542                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   543                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   544 00000418 66B806000000        <1> 	mov	eax, 6
   545 0000041E BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   546 00000421 0316[0611]          <1> 	add	dx, [NABMBAR]
   547 00000425 66EF                <1> 	out	dx, eax
   548                              <1> 
   549 00000427 B90A00              <1> 	mov	cx, 10	; total 1s
   550                              <1> _warm_ac97c_rst_wait:
   551 0000042A E84D00              <1> 	call	delay_100ms
   552                              <1> 
   553 0000042D BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   554 00000430 0316[0611]          <1> 	add	dx, [NABMBAR]
   555 00000434 66ED                <1> 	in	eax, dx
   556                              <1> 
   557 00000436 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   558 0000043C 7504                <1> 	jnz	short _warm_ac97c_rst_ok
   559                              <1> 
   560 0000043E 49                  <1>         dec     cx
   561 0000043F 75E9                <1>         jnz     short _warm_ac97c_rst_wait
   562                              <1> 
   563                              <1> _warm_ac97c_rst_fail:
   564 00000441 F9                  <1>         stc
   565                              <1> _warm_ac97c_rst_ok:
   566 00000442 C3                  <1> 	retn
   567                              <1> 
   568                              <1> cold_ac97codec_reset:
   569                              <1> 	; 11/11/2023
   570                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   571                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   572 00000443 66B802000000        <1>         mov	eax, 2
   573 00000449 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   574 0000044C 0316[0611]          <1> 	add	dx, [NABMBAR]
   575 00000450 66EF                <1> 	out	dx, eax
   576                              <1> 
   577 00000452 E82500              <1> 	call	delay_100ms 	; wait 100 ms
   578 00000455 E82200              <1> 	call	delay_100ms 	; wait 100 ms
   579 00000458 E81F00              <1> 	call	delay_100ms 	; wait 100 ms
   580 0000045B E81C00              <1> 	call	delay_100ms 	; wait 100 ms
   581                              <1> 
   582 0000045E B91000              <1> 	mov	cx, 16	; total 20*100 ms = 2s
   583                              <1> 
   584                              <1> _cold_ac97c_rst_wait:
   585 00000461 BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   586 00000464 0316[0611]          <1> 	add	dx, [NABMBAR]
   587 00000468 66ED                <1> 	in	eax, dx
   588                              <1> 
   589 0000046A 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   590 00000470 7507                <1> 	jnz	short _cold_ac97c_rst_ok
   591                              <1> 
   592 00000472 E80500              <1> 	call	delay_100ms
   593                              <1> 
   594 00000475 49                  <1>         dec     cx
   595 00000476 75E9                <1>         jnz     short _cold_ac97c_rst_wait
   596                              <1> 
   597                              <1> _cold_ac97c_rst_fail:
   598 00000478 F9                  <1>         stc
   599                              <1> _cold_ac97c_rst_ok:
   600 00000479 C3                  <1> 	retn
   601                              <1> 
   602                              <1> delay_100ms:
   603                              <1> 	; 11/11/2023
   604                              <1> 	; 29/05/2017
   605                              <1> 	; 24/03/2017 ('codec.asm')
   606                              <1> 	; wait 100 ms
   607 0000047A 51                  <1> 	push	cx
   608 0000047B B99001              <1> 	mov	cx, 400  ; 400*0.25ms
   609                              <1> _delay_x_ms:
   610 0000047E E82208              <1> 	call	delay1_4ms
   611 00000481 E2FB                <1>         loop	_delay_x_ms
   612 00000483 59                  <1> 	pop	cx
   613 00000484 C3                  <1> 	retn
   614                              <1> 
   615                              <1> %endif
   616                              <1> 
   617                              <1> ; 11/11/2023
   618                              <1> %if 0
   619                              <1> 
   620                              <1> codecConfig:
   621                              <1> 	; 06/11/2023
   622                              <1> 	; TUNELOOP version (playing without interrupt)
   623                              <1> 	; 04/11/2023
   624                              <1> 	; 17/02/2017 
   625                              <1> 	; 07/11/2016 (Erdogan Tan)
   626                              <1> 
   627                              <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   628                              <1> 
   629                              <1> 	mov    	dx, [NAMBAR]               	
   630                              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   631                              <1> 	out	dx, ax 				; out sample rate
   632                              <1> 		
   633                              <1> 	; 05/11/2023 temp
   634                              <1> 	;mov	dx, [NAMBAR]               	
   635                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   636                              <1> 	;out	dx, ax 
   637                              <1> 
   638                              <1>         call    delay1_4ms
   639                              <1>         call    delay1_4ms
   640                              <1>         call    delay1_4ms
   641                              <1>         call    delay1_4ms
   642                              <1> 
   643                              <1> 	mov	eax, [dev_vendor]
   644                              <1>         cmp	eax, (SI7012_DID<<16)+SIS_VID
   645                              <1>         jne	short cConfig1
   646                              <1> 
   647                              <1> 	; Unmute quirk specifically for the SiS7012
   648                              <1> 
   649                              <1> 	CUSTOM_SIS_7012_REG equ 4Ch ; SiS7012-specific register
   650                              <1> 	
   651                              <1>         mov     dx, [NABMBAR]
   652                              <1>         add     dx, CUSTOM_SIS_7012_REG
   653                              <1>         in      ax, dx
   654                              <1>         or	al, 1
   655                              <1>         out     dx, ax
   656                              <1> 
   657                              <1> cConfig1:
   658                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   659                              <1> 	; initial ac97 volumes (and clear mute flag)
   660                              <1> 		
   661                              <1>   	mov     dx, [NAMBAR]
   662                              <1>   	add     dx, CODEC_MASTER_VOL_REG        ;02h ; STEREO
   663                              <1>   	;xor	ax, ax ; volume attenuation = 0 (max. volume)
   664                              <1>   	; 03/11/2023
   665                              <1> 	mov	ax, 0202h
   666                              <1> 	out     dx, ax
   667                              <1> 
   668                              <1>         call    delay1_4ms	; delays because codecs are slow
   669                              <1>         call    delay1_4ms
   670                              <1>         call    delay1_4ms
   671                              <1>         call    delay1_4ms
   672                              <1>  
   673                              <1>   	mov     dx, [NAMBAR]
   674                              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h
   675                              <1>   	;;xor	ax, ax
   676                              <1> 	;mov	ax, 0202h
   677                              <1>   	out     dx, ax
   678                              <1> 
   679                              <1>         call    delay1_4ms
   680                              <1>         call    delay1_4ms
   681                              <1>         call    delay1_4ms
   682                              <1>         call    delay1_4ms
   683                              <1>  
   684                              <1> 	retn
   685                              <1> 
   686                              <1> %endif
   449                                  ;%include 'ich_wav.asm' ; 17/02/2017 (ICH AC97 wav playing functions)
   450                                  %include 'ich_wave.asm' ; 11/11/2023 (ICH AC97 wav playing functions)
     1                              <1> ; 13/11/2023
     2                              <1> ; 11/11/2023
     3                              <1> ; 10/11/2023
     4                              <1> ; 09/11/2023
     5                              <1> ; 03/11/2023 - 08/11/2023
     6                              <1> ; DOS based .WAV player using AC'97 and codec interface.
     7                              <1> ; ---------------------------------------------------------------
     8                              <1> ; NASM version: Erdogan Tan (29/11/2016)
     9                              <1> ; Last Update: 17/02/2017 (by Erdogan Tan)
    10                              <1> 
    11                              <1> ; AC97 interrupt version - 09/11/2023 - Erdogan Tan
    12                              <1> ; sample rate conversion version - 13/11/2023 - Erdogan Tan
    13                              <1> 
    14                              <1> ; ICHWAV.ASM
    15                              <1> 
    16                              <1> ; player internal variables and other equates.
    17                              <1> BUFFERSIZE      equ     64 * 1024       ; 64k file buffer size.
    18                              <1> ENDOFFILE       equ     BIT0            ; flag for knowing end of file
    19                              <1> 
    20                              <1> ;===========================================================================
    21                              <1> ; entry: none. File is already open and [filehandle] filled.
    22                              <1> ; exit:  not until the song is finished or the user aborts.
    23                              <1> ;
    24                              <1> playWav:
    25                              <1> 	; 13/11/2023
    26                              <1> 
    27 00000485 803E[1E03]01        <1> 	cmp	byte [VRA], 1
    28 0000048A 720F                <1> 	jb	short chk_sample_rate
    29                              <1> playwav_48_khz:	
    30 0000048C C706[3B06][5C07]    <1> 	mov	word [loadfromwavfile], loadFromFile
    31                              <1> 	;mov	word [loadsize], 0 ; 65536
    32 00000492 C706[3F06]0080      <1> 	mov	word [buffersize], 32768 ; samples
    33 00000498 E9A801              <1> 	jmp	playWav_vra
    34                              <1> 
    35                              <1> chk_sample_rate:
    36                              <1> 	; set conversion parameters
    37                              <1> 	; (for 8, 11.025, 16, 22.050, 24, 32 kHZ)
    38 0000049B A1[1611]            <1> 	mov	ax, [sample_rate]
    39 0000049E 3D80BB              <1> 	cmp	ax, 48000
    40 000004A1 74E9                <1> 	je	short playwav_48_khz
    41                              <1> chk_22khz:
    42 000004A3 3D2256              <1> 	cmp	ax, 22050
    43 000004A6 752F                <1> 	jne	short chk_11khz
    44 000004A8 803E[1A11]08        <1> 	cmp	byte [bps], 8
    45 000004AD 760F                <1> 	jna	short chk_22khz_1
    46 000004AF BB[9A0C]            <1> 	mov	bx, load_22khz_stereo_16_bit
    47 000004B2 803E[1811]01        <1> 	cmp	byte [stmo], 1 
    48 000004B7 7512                <1> 	jne	short chk_22khz_2
    49 000004B9 BB[9A0C]            <1> 	mov	bx, load_22khz_mono_16_bit
    50 000004BC EB0D                <1> 	jmp	short chk_22khz_2
    51                              <1> chk_22khz_1:
    52 000004BE BB[9A0C]            <1> 	mov	bx, load_22khz_stereo_8_bit
    53 000004C1 803E[1811]01        <1> 	cmp	byte [stmo], 1 
    54 000004C6 7503                <1> 	jne	short chk_22khz_2
    55 000004C8 BB[9A0C]            <1> 	mov	bx, load_22khz_mono_8_bit
    56                              <1> chk_22khz_2:
    57 000004CB B85A1D              <1> 	mov	ax, 7514  ; (442*17)
    58 000004CE BA2500              <1> 	mov	dx, 37
    59 000004D1 B91100              <1> 	mov	cx, 17 
    60 000004D4 E93301              <1> 	jmp	set_sizes	
    61                              <1> chk_11khz:
    62 000004D7 3D112B              <1> 	cmp	ax, 11025
    63 000004DA 752F                <1> 	jne	short chk_44khz
    64 000004DC 803E[1A11]08        <1> 	cmp	byte [bps], 8
    65 000004E1 760F                <1> 	jna	short chk_11khz_1
    66 000004E3 BB[9A0C]            <1> 	mov	bx, load_11khz_stereo_16_bit
    67 000004E6 803E[1811]01        <1> 	cmp	byte [stmo], 1 
    68 000004EB 7512                <1> 	jne	short chk_11khz_2
    69 000004ED BB[9A0C]            <1> 	mov	bx, load_11khz_mono_16_bit
    70 000004F0 EB0D                <1> 	jmp	short chk_11khz_2
    71                              <1> chk_11khz_1:
    72 000004F2 BB[9A0C]            <1> 	mov	bx, load_11khz_stereo_8_bit
    73 000004F5 803E[1811]01        <1> 	cmp	byte [stmo], 1 
    74 000004FA 7503                <1> 	jne	short chk_11khz_2
    75 000004FC BB[9A0C]            <1> 	mov	bx, load_11khz_mono_8_bit
    76                              <1> chk_11khz_2:
    77 000004FF B8AD0E              <1> 	mov	ax, 3757  ; (221*17)
    78 00000502 BA4A00              <1> 	mov	dx, 74
    79 00000505 B91100              <1> 	mov	cx, 17
    80 00000508 E9FF00              <1> 	jmp	set_sizes 
    81                              <1> chk_44khz:
    82 0000050B 3D44AC              <1> 	cmp	ax, 44100
    83 0000050E 752F                <1> 	jne	short chk_16khz
    84 00000510 803E[1A11]08        <1> 	cmp	byte [bps], 8
    85 00000515 760F                <1> 	jna	short chk_44khz_1
    86 00000517 BB[9A0C]            <1> 	mov	bx, load_44khz_stereo_16_bit
    87 0000051A 803E[1811]01        <1> 	cmp	byte [stmo], 1 
    88 0000051F 7512                <1> 	jne	short chk_44khz_2
    89 00000521 BB[9A0C]            <1> 	mov	bx, load_44khz_mono_16_bit
    90 00000524 EB0D                <1> 	jmp	short chk_44khz_2
    91                              <1> chk_44khz_1:
    92 00000526 BB[9A0C]            <1> 	mov	bx, load_44khz_stereo_8_bit
    93 00000529 803E[1811]01        <1> 	cmp	byte [stmo], 1 
    94 0000052E 7503                <1> 	jne	short chk_44khz_2
    95 00000530 BB[9A0C]            <1> 	mov	bx, load_44khz_mono_8_bit
    96                              <1> chk_44khz_2:
    97 00000533 B8D93A              <1> 	mov	ax, 15065 ; (655*23)
    98 00000536 BA1900              <1> 	mov	dx, 25
    99 00000539 B91700              <1> 	mov	cx, 23
   100 0000053C E9CB00              <1> 	jmp	set_sizes 
   101                              <1> chk_16khz:
   102 0000053F 3D803E              <1> 	cmp	ax, 16000
   103 00000542 752F                <1> 	jne	short chk_8khz
   104 00000544 803E[1A11]08        <1> 	cmp	byte [bps], 8
   105 00000549 760F                <1> 	jna	short chk_16khz_1
   106 0000054B BB[1B0C]            <1> 	mov	bx, load_16khz_stereo_16_bit
   107 0000054E 803E[1811]01        <1> 	cmp	byte [stmo], 1 
   108 00000553 7512                <1> 	jne	short chk_16khz_2
   109 00000555 BB[C60B]            <1> 	mov	bx, load_16khz_mono_16_bit
   110 00000558 EB0D                <1> 	jmp	short chk_16khz_2
   111                              <1> chk_16khz_1:
   112 0000055A BB[390B]            <1> 	mov	bx, load_16khz_stereo_8_bit
   113 0000055D 803E[1811]01        <1> 	cmp	byte [stmo], 1 
   114 00000562 7503                <1> 	jne	short chk_16khz_2
   115 00000564 BB[DE0A]            <1> 	mov	bx, load_16khz_mono_8_bit
   116                              <1> chk_16khz_2:
   117 00000567 B85515              <1> 	mov	ax, 5461
   118 0000056A BA0300              <1> 	mov	dx, 3
   119 0000056D B90100              <1> 	mov	cx, 1
   120 00000570 E99700              <1> 	jmp	set_sizes 
   121                              <1> chk_8khz:
   122 00000573 3D401F              <1> 	cmp	ax, 8000
   123 00000576 752E                <1> 	jne	short chk_24khz
   124 00000578 803E[1A11]08        <1> 	cmp	byte [bps], 8
   125 0000057D 760F                <1> 	jna	short chk_8khz_1
   126 0000057F BB[1F0A]            <1> 	mov	bx, load_8khz_stereo_16_bit
   127 00000582 803E[1811]01        <1> 	cmp	byte [stmo], 1 
   128 00000587 7512                <1> 	jne	short chk_8khz_2
   129 00000589 BB[A309]            <1> 	mov	bx, load_8khz_mono_16_bit
   130 0000058C EB0D                <1> 	jmp	short chk_8khz_2
   131                              <1> chk_8khz_1:
   132 0000058E BB[D408]            <1> 	mov	bx, load_8khz_stereo_8_bit
   133 00000591 803E[1811]01        <1> 	cmp	byte [stmo], 1 
   134 00000596 7503                <1> 	jne	short chk_8khz_2
   135 00000598 BB[3F08]            <1> 	mov	bx, load_8khz_mono_8_bit
   136                              <1> chk_8khz_2:
   137 0000059B B8AA0A              <1> 	mov	ax, 2730
   138 0000059E BA0600              <1> 	mov	dx, 6
   139 000005A1 B90100              <1> 	mov	cx, 1
   140 000005A4 EB64                <1> 	jmp	short set_sizes 
   141                              <1> chk_24khz:
   142 000005A6 3DC05D              <1> 	cmp	ax, 24000
   143 000005A9 752E                <1> 	jne	short chk_32khz
   144 000005AB 803E[1A11]08        <1> 	cmp	byte [bps], 8
   145 000005B0 760F                <1> 	jna	short chk_24khz_1
   146 000005B2 BB[9A0C]            <1> 	mov	bx, load_24khz_stereo_16_bit
   147 000005B5 803E[1811]01        <1> 	cmp	byte [stmo], 1 
   148 000005BA 7512                <1> 	jne	short chk_24khz_2
   149 000005BC BB[9A0C]            <1> 	mov	bx, load_24khz_mono_16_bit
   150 000005BF EB0D                <1> 	jmp	short chk_24khz_2
   151                              <1> chk_24khz_1:
   152 000005C1 BB[9A0C]            <1> 	mov	bx, load_24khz_stereo_8_bit
   153 000005C4 803E[1811]01        <1> 	cmp	byte [stmo], 1 
   154 000005C9 7503                <1> 	jne	short chk_24khz_2
   155 000005CB BB[9A0C]            <1> 	mov	bx, load_24khz_mono_8_bit
   156                              <1> chk_24khz_2:
   157 000005CE B80020              <1> 	mov	ax, 8192
   158 000005D1 BA0200              <1> 	mov	dx, 2
   159 000005D4 B90100              <1> 	mov	cx, 1
   160 000005D7 EB31                <1> 	jmp	short set_sizes 
   161                              <1> chk_32khz:
   162 000005D9 3D007D              <1> 	cmp	ax, 32000
   163 000005DC 7556                <1> 	jne	short vra_needed
   164 000005DE 803E[1A11]08        <1> 	cmp	byte [bps], 8
   165 000005E3 760F                <1> 	jna	short chk_32khz_1
   166 000005E5 BB[9A0C]            <1> 	mov	bx, load_32khz_stereo_16_bit
   167 000005E8 803E[1811]01        <1> 	cmp	byte [stmo], 1 
   168 000005ED 750F                <1> 	jne	short chk_32khz_2
   169 000005EF BB[9A0C]            <1> 	mov	bx, load_32khz_mono_16_bit
   170 000005F2 EB0A                <1> 	jmp	short chk_32khz_2
   171                              <1> chk_32khz_1:
   172 000005F4 BB[9A0C]            <1> 	mov	bx, load_32khz_stereo_8_bit
   173 000005F7 803E[1811]01        <1> 	cmp	byte [stmo], 1 
   174 000005FC 7500                <1> 	jne	short chk_32khz_2
   175                              <1> chk_32khz_2:
   176 000005FE BB[9A0C]            <1> 	mov	bx, load_32khz_mono_8_bit
   177 00000601 B8AA2A              <1> 	mov	ax, 10922
   178 00000604 BA0300              <1> 	mov	dx, 3
   179 00000607 B90200              <1> 	mov	cx, 2
   180                              <1> 	;jmp	short set_sizes 
   181                              <1> set_sizes:
   182 0000060A 803E[1811]01        <1> 	cmp	byte [stmo], 1
   183 0000060F 7402                <1> 	je	short ss_1
   184 00000611 D1E0                <1> 	shl	ax, 1
   185                              <1> ss_1:
   186 00000613 803E[1A11]08        <1> 	cmp	byte [bps], 8
   187 00000618 7602                <1> 	jna	short ss_2
   188                              <1> 	; 16 bit samples
   189 0000061A D1E0                <1> 	shl	ax, 1
   190                              <1> ss_2:
   191 0000061C A3[3D06]            <1> 	mov	[loadsize], ax
   192 0000061F F7E2                <1> 	mul	dx
   193                              <1> 	;cmp	cx, 1
   194                              <1> 	;je	short ss_3
   195                              <1> ;ss_3:
   196 00000621 F7F1                <1> 	div	cx
   197 00000623 8A0E[1C11]          <1> 	mov	cl, [fbs_shift]
   198 00000627 D3E0                <1> 	shl	ax, cl
   199 00000629 D1E8                <1> 	shr	ax, 1	; buffer size is 16 bit sample count
   200 0000062B A3[3F06]            <1> 	mov	[buffersize], ax 
   201 0000062E 891E[3B06]          <1> 	mov	[loadfromwavfile], bx
   202 00000632 EB0F                <1> 	jmp	short playWav_vra
   203                              <1> 
   204                              <1> vra_needed:
   205                              <1> 	; 13/11/2023
   206 00000634 58                  <1> 	pop	ax ; discard return address to the caller
   207 00000635 BA[A310]            <1> 	mov	dx, msg_no_vra
   208 00000638 E91FFB              <1> 	jmp	vra_err
   209                              <1> 
   210                              <1> 	; 13/11/2023
   211                              <1> loadfromwavfile:
   212 0000063B [5C07]              <1> 	dw	loadFromFile
   213                              <1> loadsize:	; read from wav file
   214 0000063D 0000                <1> 	dw	0
   215                              <1> buffersize:	; write to DMA buffer
   216 0000063F 00800000            <1> 	dd	32768 ; 16 bit samples (not bytes)
   217                              <1> 
   218                              <1> playWav_vra:
   219                              <1> 	; 07/11/2023
   220                              <1> 	; clear buffer 2
   221                              <1>         ;push	es
   222                              <1> 	;mov	ax, [WAV_BUFFER2]
   223                              <1> 	;mov	es, ax
   224                              <1> 	;sub	ax, ax
   225                              <1> 	;mov	di, ax ; 17/02/2017
   226                              <1> 	;mov	cx, (BUFFERSIZE/2)
   227                              <1> 	;rep	stosw
   228                              <1> 	;pop	es	     
   229                              <1> 	
   230                              <1> 	; load 64k into buffer 1
   231 00000643 A1[0A11]            <1>         mov     ax, [WAV_BUFFER1]
   232                              <1>         ;call	loadFromFile
   233                              <1> 	; 13/11/2023
   234 00000646 FF16[3B06]          <1> 	call	word [loadfromwavfile]
   235                              <1> 
   236                              <1> 	; and 64k into buffer 2
   237 0000064A A1[0C11]            <1> 	mov     ax, [WAV_BUFFER2]
   238                              <1>        	;call	loadFromFile
   239                              <1> 	; 13/11/2023
   240 0000064D FF16[3B06]          <1> 	call	word [loadfromwavfile]
   241                              <1> 
   242                              <1> ; register reset the DMA engine. This may cause a pop noise on the output
   243                              <1> ; lines when the device is reset. Prolly a better idea to mute output, then
   244                              <1> ; reset.
   245                              <1> 
   246                              <1> 	; 11/11/2023
   247                              <1>         ;mov	dx, [NABMBAR]
   248                              <1>         ;add	dx, PO_CR_REG		; set pointer to Ctrl reg
   249                              <1>         ;mov	al, RR			; set reset
   250                              <1> 	;out	dx, al			; self clearing bit
   251                              <1> 
   252                              <1> ; write last valid index to 31 to start with.
   253                              <1> ; The Last Valid Index register tells the DMA engine when to stop playing.
   254                              <1> ; 
   255                              <1> ; As we progress through the song we change the last valid index to always be
   256                              <1> ; something other than the index we're currently playing.  
   257                              <1> ;
   258                              <1> 	; 08/11/2023
   259                              <1> 	;; 07/11/2023
   260                              <1> 	;mov	al, 1
   261                              <1>         ;;mov	al, 31
   262                              <1> 	;call	setLastValidIndex
   263                              <1> 
   264                              <1> ; create Buffer Descriptor List
   265                              <1> ;
   266                              <1> ; A buffer descriptor list is a list of pointers and control bits that the
   267                              <1> ; DMA engine uses to know where to get the .wav data and how to play it.
   268                              <1> ;
   269                              <1> ; I set it up to use only 2 buffers of .wav data, and whenever 1 buffer is
   270                              <1> ; playing, I refresh the other one with good data.
   271                              <1> ;
   272                              <1> ;
   273                              <1> ; For the control bits, you can specify that the DMA engine fire an interrupt
   274                              <1> ; after a buffer has been processed, but I poll the current index register
   275                              <1> ; to know when it's safe to update the other buffer.
   276                              <1> ;
   277                              <1> ; I set the BUP bit, which tells the DMA engine to just play 0's (silence)
   278                              <1> ; if it ever runs out of data to play. Good for safety.
   279                              <1> ;
   280 00000651 06                  <1>         push    es
   281 00000652 A1[0811]            <1>         mov     ax, [BDL_BUFFER]		; get segment # for BDL
   282 00000655 8EC0                <1>         mov     es, ax
   283                              <1> 
   284 00000657 B91000              <1>         mov     cx, 32 / 2                      ; make 32 entries in BDL
   285 0000065A 31FF                <1>         xor     di, di                          
   286                              <1> _0:
   287                              <1> 
   288                              <1> ; set buffer descriptor 0 to start of data file in memory
   289 0000065C 660FB706[0A11]      <1>         movzx   eax, word [WAV_BUFFER1]
   290 00000662 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   291 00000666 66AB                <1>         stosd                                   ; store pointer to wavbuffer1
   292                              <1> 
   293                              <1> ;
   294                              <1> ; set length to 32k samples. 1 sample is 16bits or 2bytes.
   295                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples.
   296                              <1> ; 
   297                              <1> 
   298                              <1> ; 17/02/2017 (Erdogan Tan)
   299                              <1> ; Intel 82801AA (ICH) & Intel 82801AB (ICH0) I/O Controller Hub AC97
   300                              <1> ; Programmers Reference Manual
   301                              <1> 
   302                              <1> ; 2.2.1 Buffer Descriptor List  (on Page 13)
   303                              <1> 	;
   304                              <1> 	;  Generic Form of Buffer Descriptor
   305                              <1> 	;  ---------------------------------
   306                              <1> 	;  63   62    61-48    47-32   31-0
   307                              <1> 	;  ---  ---  --------  ------- -----
   308                              <1> 	;  IOC  BUP -reserved- Buffer  Buffer
   309                              <1> 	;		      Length   Pointer
   310                              <1> 	;		      [15:0]   [31:0]
   311                              <1> 	;
   312                              <1> 	;  IOC:	Interrupt On Completion. 
   313                              <1> 	;	1 = Enabled. 
   314                              <1> 	;	    When this is set, it means that the controller should
   315                              <1> 	;	    issue an interrupt upon completion of this buffer.
   316                              <1> 	;	    It should also set the IOC bit in the status register
   317                              <1> 	;	0 = Disabled	
   318                              <1> 	;
   319                              <1> 	;  BUP: Buffer Underrun Policy.
   320                              <1> 	;       0 = When this buffer is complete,
   321                              <1> 	;	    if the next buffer is not yet ready 
   322                              <1> 	;	    (i.e., the last valid buffer has been processed),
   323                              <1> 	;	    then continue to transmit the last valid sample.
   324                              <1> 	;	1 = When this buffer is complete,
   325                              <1> 	;     	    if this is the last valid buffer, transmit zeros after
   326                              <1> 	;	    this buffer has been processed completely.
   327                              <1> 	;	    This bit typically is set only if this is the last 
   328                              <1> 	;	    buffer in the current stream.
   329                              <1> 	;
   330                              <1> 	; [31:0]: Buffer pointer. This field points to the location of
   331                              <1> 	;	  the data buffer. Since samples can be as wide as one
   332                              <1> 	;	  word, the buffer must be aligned with word boundaries,
   333                              <1> 	;	  to prevent samples from straddling DWord boundaries.
   334                              <1> 	;
   335                              <1> 	; [15:0]: Buffer Length: This is the length of the data buffer,
   336                              <1> 	;	  in number of samples. The controller uses this data
   337                              <1> 	;	  to determine the length of the buffer, in bytes.
   338                              <1> 	;	  "0" indicates no sample to process.
   339                              <1> 
   340                              <1> ; ICH2AC97.INC
   341                              <1> 
   342                              <1> ;	IOC	equ     BIT31   ; Fire an interrupt whenever this
   343                              <1> 				; buffer is complete.
   344                              <1> 
   345                              <1> ;	BUP	equ     BIT30   ; Buffer Underrun Policy.
   346                              <1> 				; if this buffer is the last buffer
   347                              <1> 				; in a playback, fill the remaining
   348                              <1> 				; samples with 0 (silence) or not.
   349                              <1> 				; It's a good idea to set this to 1
   350                              <1> 				; for the last buffer in playback,
   351                              <1> 				; otherwise you're likely to get a lot
   352                              <1> 				; of noise at the end of the sound.
   353                              <1> ;
   354                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   355                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   356                              <1> ; Luckily for us, that's the same format as .wav files.
   357                              <1> ;
   358                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   359                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   360                              <1> ;
   361                              <1> ; A value of 0 in these bits means play no samples.
   362                              <1> ;
   363                              <1> 
   364                              <1> ; ICHWAV.ASM
   365                              <1> 
   366                              <1> 	;mov	eax, BUFFERSIZE / 2 ; size of half buffer (32K)
   367                              <1> 	; 13/11/2023
   368 00000668 66A1[3F06]          <1> 	mov	eax, [buffersize]
   369                              <1> 
   370                              <1> 	; 09/11/2023
   371 0000066C 660D000000C0        <1> 	or	eax, IOC + BUP
   372                              <1> 	; 06/11/2023
   373                              <1> 	;or	eax, BUP
   374 00000672 66AB                <1> 	stosd
   375                              <1> 
   376                              <1> ; 2nd buffer:
   377                              <1> 
   378 00000674 660FB706[0C11]      <1>         movzx   eax, word [WAV_BUFFER2]
   379 0000067A 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   380 0000067E 66AB                <1>         stosd                                   ; store pointer to wavbuffer2
   381                              <1> 
   382                              <1> ; set length to 64k (32k of two 16 bit samples)
   383                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples
   384                              <1> ; 
   385                              <1> 	;mov	eax, BUFFERSIZE / 2
   386                              <1> 	; 13/11/2023
   387 00000680 66A1[3F06]          <1> 	mov	eax, [buffersize]
   388                              <1> 
   389                              <1> 	; 09/11/2023
   390 00000684 660D000000C0        <1> 	or	eax, IOC + BUP
   391                              <1> 	; 06/11/2023
   392                              <1> 	;or	eax, BUP
   393 0000068A 66AB                <1> 	stosd
   394                              <1> 
   395 0000068C E2CE                <1>         loop    _0
   396 0000068E 07                  <1>         pop     es
   397                              <1> 
   398                              <1> ;
   399                              <1> ; tell the DMA engine where to find our list of Buffer Descriptors.
   400                              <1> ; this 32bit value is a flat mode memory offset (ie no segment:offset)
   401                              <1> ;
   402                              <1> ; write NABMBAR+10h with offset of buffer descriptor list
   403                              <1> ;
   404 0000068F 660FB706[0811]      <1>         movzx   eax, word [BDL_BUFFER]
   405 00000695 66C1E004            <1> 	shl     eax, 4                          ; convert seg:off to 0:off
   406 00000699 8B16[0611]          <1>         mov     dx, [NABMBAR]
   407 0000069D 83C210              <1>         add     dx, PO_BDBAR_REG                ; set pointer to BDL
   408 000006A0 66EF                <1>         out     dx, eax                         ; write to AC97 controller
   409                              <1> 
   410                              <1> ;
   411                              <1> ; All set. Let's play some music.
   412                              <1> ;
   413                              <1> 
   414                              <1> 	; 10/11/2023
   415                              <1> 	; 08/11/2023
   416                              <1> 	; 07/11/2023
   417                              <1> 	; 08/12/2016
   418                              <1> 	; 07/10/2016
   419                              <1> 	;mov	al, 1
   420 000006A2 B01F                <1> 	mov	al, 31
   421 000006A4 A2[1E11]            <1> 	mov	[LVI], al ; 10/11/2023
   422 000006A7 E87F01              <1> 	call	setLastValidIndex
   423                              <1> 
   424                              <1> 	; 06/11/2023 (not neccessary)
   425                              <1> 	;; 05/11/2023
   426                              <1> 	;; reset current index
   427                              <1> 	;mov	al, 0
   428                              <1> 	;call	setCurrentIndex
   429                              <1> 
   430                              <1> 	; 06/11/2023
   431                              <1> 	;mov	byte [tLoop], 1 ; 30/11/2016
   432                              <1> 
   433                              <1> 	; 17/02/2017
   434 000006AA 8B16[0611]          <1>         mov     dx, [NABMBAR]
   435 000006AE 83C21B              <1>         add     dx, PO_CR_REG                   ; PCM out Control Register
   436                              <1>         ; 09/11/2023
   437 000006B1 B011                <1> 	mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
   438                              <1> 	;			; (LVBI interrupt will not be enabled)
   439                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   440                              <1> 	;mov	al, RPBM
   441 000006B3 EE                  <1> 	out     dx, al                          ; Start bus master operation.
   442                              <1> 
   443                              <1> 	; 09/11/2023
   444 000006B4 C606[1D11]3F        <1> 	mov	byte [b_indicator], '?'	
   445                              <1> 
   446                              <1> 	; 06/11/2023
   447                              <1> 	;call	delay1_4ms
   448                              <1> 	;call	delay1_4ms
   449                              <1> 	;call	delay1_4ms
   450                              <1> 	;call	delay1_4ms
   451                              <1> 
   452                              <1> 	; 10/11/2023
   453                              <1> 	;mov	byte [tloop], 1
   454                              <1> 
   455                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   456                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   457                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   458                              <1> 
   459                              <1> ; 09/11/2023   
   460                              <1> ; 06/11/2023
   461                              <1> %if 1
   462                              <1> 	; 08/12/2016
   463                              <1> 	; 28/11/2016
   464                              <1> p_loop:
   465 000006B9 E87601              <1> 	call    check4keyboardstop ; keyboard halt?
   466 000006BC 732A                <1>         jnc	short r_loop 	   ; no ; 09/11/2023
   467                              <1> 
   468                              <1> 	; 09/11/2023
   469                              <1> 	;or	byte [flags], ENDOFFILE
   470                              <1> 	;mov	byte [b_indicator], '0'
   471                              <1> q_loop:
   472                              <1> 	;mov	al, '0'
   473 000006BE E88D00              <1> 	call	tL0
   474                              <1> 
   475                              <1> 	; 04/11/2023
   476                              <1> 	; finished with song, stop everything
   477 000006C1 E8FD07              <1> 	call	ac97_stop
   478                              <1> 
   479                              <1> 	; 11/11/2023
   480                              <1> irq_restore:	
   481                              <1> 	; restore previous interrupt vector and interrupt_status
   482 000006C4 FA                  <1> 	cli
   483 000006C5 E4A1                <1> 	in	al, 0A1h ; irq 8-15
   484 000006C7 A0[FF10]            <1> 	mov	al, [IRQ_status+1]
   485 000006CA E6A1                <1> 	out	0A1h, al 
   486 000006CC E421                <1> 	in	al, 021h ; irq 0-7
   487 000006CE A0[FE10]            <1> 	mov	al, [IRQ_status]
   488 000006D1 E621                <1> 	out	21h, al 
   489                              <1> 	; ...
   490 000006D3 06                  <1> 	push	es
   491 000006D4 31C0                <1> 	xor	ax, ax
   492 000006D6 8EC0                <1> 	mov	es, ax
   493 000006D8 A1[0011]            <1> 	mov	ax, [IRQ_vector]
   494 000006DB 268907              <1> 	mov	[es:bx], ax
   495 000006DE A1[0211]            <1> 	mov	ax, [IRQ_vector+2]
   496 000006E1 26894702            <1> 	mov	[es:bx+2], ax
   497 000006E5 07                  <1> 	pop	es
   498 000006E6 FB                  <1> 	sti
   499 000006E7 C3                  <1> 	retn
   500                              <1> 
   501                              <1> r_loop:
   502                              <1> 	; 10/11/2023
   503                              <1> 	;nop
   504                              <1> 	;nop
   505                              <1> 	;nop
   506                              <1> 
   507                              <1> 	; 11/11/2023	
   508 000006E8 B030                <1> 	mov	al, '0'
   509 000006EA 803E[FD10]00        <1> 	cmp	byte [tloop], 0
   510 000006EF 74C8                <1> 	je	short p_loop
   511 000006F1 7CCB                <1> 	jl	short q_loop
   512                              <1> 
   513 000006F3 FE0E[FD10]          <1> 	dec	byte [tloop] ; 0
   514                              <1> 
   515 000006F7 803E[1D11]31        <1> 	cmp	byte [b_indicator], '1'
   516 000006FC 7515                <1> 	jne	short s_loop
   517                              <1> 
   518                              <1> 	; load buffer 1
   519 000006FE A1[0A11]            <1> 	mov	ax, [WAV_BUFFER1]
   520                              <1> u_loop:
   521                              <1> 	;call	loadFromFile
   522                              <1> 	; 13/11/2023
   523 00000701 FF16[3B06]          <1> 	call	[loadfromwavfile]
   524 00000705 7304                <1> 	jnc	short v_loop
   525 00000707 B030                <1> 	mov	al, '0'
   526 00000709 EBB3                <1> 	jmp	short q_loop
   527                              <1> v_loop:
   528                              <1> 	; 09/11/2023 - Erdogan Tan
   529                              <1> 	; (print buffer number on top left of the screen)
   530 0000070B A0[1D11]            <1> 	mov	al, [b_indicator]
   531 0000070E E83D00              <1> 	call	tL0
   532 00000711 EBA6                <1> 	jmp	short p_loop
   533                              <1> s_loop:
   534                              <1> 	; load buffer 2
   535 00000713 A1[0C11]            <1> 	mov	ax, [WAV_BUFFER2]
   536 00000716 EBE9                <1> 	jmp	short u_loop
   537                              <1> 
   538                              <1> %endif
   539                              <1> 
   540                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   541                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   542                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   543                              <1> 
   544                              <1> ; 11/11/2023
   545                              <1> ; 10/11/2023
   546                              <1> ; 09/11/2023
   547                              <1> ; 08/11/2023
   548                              <1> ; 07/11/2023
   549                              <1> %if 1
   550                              <1> 
   551                              <1> tuneLoop:
   552                              <1> 	; 11/11/2023
   553                              <1> 	; 10/11/2023
   554                              <1> 	; 09/11/2023
   555                              <1> 	; 08/11/2023
   556                              <1> 	; 06/11/2023
   557                              <1> 	;mov	al, '1'
   558                              <1> 	;call	tL0
   559                              <1> tL1:
   560                              <1> 	; 10/11/2023
   561                              <1> 	;mov	byte [tloop], 1
   562                              <1> 
   563                              <1> 	; 11/11/2023
   564                              <1> 	;call    updateLVI	; set LVI != CIV
   565                              <1> 	;jz	short tL4	
   566                              <1> 
   567                              <1> 	; 11/11/2023
   568 00000718 C606[FD10]01        <1> 	mov	byte [tloop], 1
   569                              <1> 
   570 0000071D E80001              <1> 	call    getCurrentIndex
   571                              <1> 
   572                              <1> 	; 10/11/2023
   573 00000720 3A06[1E11]          <1> 	cmp	al, [LVI]
   574 00000724 7511                <1> 	jne	short tL2
   575                              <1> 
   576 00000726 F606[FA10]01        <1> 	test	byte [flags], ENDOFFILE
   577                              <1> 	;jnz	short tL2
   578 0000072B 751A                <1> 	jnz	short tL4
   579                              <1> 
   580 0000072D 48                  <1> 	dec	ax
   581 0000072E 241F                <1> 	and	al, 1Fh 
   582 00000730 E8F600              <1> 	call	setLastValidIndex	
   583 00000733 8606[1E11]          <1> 	xchg	al, [LVI]
   584                              <1> 
   585                              <1> tL2:
   586 00000737 A801                <1> 	test	al, BIT0
   587 00000739 7406                <1> 	jz	short tL3
   588                              <1> 
   589 0000073B C606[1D11]31        <1> 	mov	byte [b_indicator], '1'
   590 00000740 C3                  <1> 	retn
   591                              <1> tL3:	
   592 00000741 C606[1D11]32        <1> 	mov	byte [b_indicator], '2'
   593 00000746 C3                  <1> 	retn
   594                              <1> tL4:
   595                              <1> 	; 11/11/2023
   596 00000747 C606[FD10]FF        <1> 	mov	byte [tloop], -1
   597 0000074C F9                  <1> 	stc
   598 0000074D C3                  <1> 	retn
   599                              <1> 
   600                              <1> 
   601                              <1> 	; 06/11/2023
   602                              <1> tL0:
   603                              <1> 	; 08/11/2023
   604                              <1> 	; 05/11/2023
   605                              <1> 	; 17/02/2017 - Buffer switch test (temporary)
   606                              <1> 	; 06/11/2023
   607                              <1> 	; al = buffer indicator ('1', '2' or '0' -stop- )
   608 0000074E 1E                  <1> 	push	ds
   609                              <1> 	;push	bx 
   610 0000074F BB00B8              <1> 	mov	bx, 0B800h ; video display page segment
   611 00000752 8EDB                <1> 	mov	ds, bx
   612 00000754 29DB                <1> 	sub	bx, bx ; 0
   613 00000756 B44E                <1> 	mov	ah, 4Eh
   614 00000758 8907                <1> 	mov	[bx], ax ; show current play buffer (1, 2)
   615                              <1> 	;pop	bx
   616 0000075A 1F                  <1> 	pop	ds
   617 0000075B C3                  <1> 	retn
   618                              <1> 
   619                              <1> %endif
   620                              <1> 
   621                              <1> ; 08/11/2023
   622                              <1> ; 07/11/2023
   623                              <1> %if 0
   624                              <1> 
   625                              <1> tuneLoop:
   626                              <1> 	; 07/11/2023
   627                              <1> 	;mov	dx, NABMBAR
   628                              <1> 	;add	dx, PO_CIV_REG ; 14h
   629                              <1> tL1:
   630                              <1> 	call    updateLVI	; set LVI != CIV
   631                              <1> 	call    check4keyboardstop
   632                              <1> 	jc	short _exit_
   633                              <1> 	call    getCurrentIndex
   634                              <1> 	test	al, BIT0
   635                              <1> 	jz	short tL1	; loop if buffer 2 is not playing
   636                              <1> 
   637                              <1> 	; load buffer 1
   638                              <1> 	mov     ax, [WAV_BUFFER1]
   639                              <1> 	call	loadFromFile
   640                              <1> 	jc	short _exit_	; end of file
   641                              <1> tL2:
   642                              <1> 	call    updateLVI
   643                              <1> 	call    check4keyboardstop
   644                              <1> 	jc	short _exit_
   645                              <1> 	call    getCurrentIndex
   646                              <1> 	test	al, BIT0
   647                              <1> 	jnz	short tL2	; loop if buffer 1 is not playing
   648                              <1> 
   649                              <1> 	; load buffer 2
   650                              <1> 	mov     ax, [WAV_BUFFER2]
   651                              <1> 	call	loadFromFile
   652                              <1> 	jnc	short tuneLoop
   653                              <1> _exit_:
   654                              <1> 	mov	dx, [NABMBAR]		
   655                              <1> 	add	dx, PO_CR_REG	; PCM out Control Register
   656                              <1> 	mov	al, 0
   657                              <1> 	out	dx, al		; stop player
   658                              <1> 	retn
   659                              <1> 
   660                              <1> %endif
   661                              <1> 
   662                              <1> ; load data from file in 32k chunks. Would be nice to load 1 64k chunk,
   663                              <1> ; but in DOS you can only load FFFF bytes at a time.
   664                              <1> ;
   665                              <1> ; entry: ax = segment to load data to
   666                              <1> ; exit: CY set if end of file reached.
   667                              <1> ; note: last file buffer is padded with 0's to avoid pops at the end of song.
   668                              <1> ; assumes file is already open. uses [filehandle]
   669                              <1> 
   670                              <1> ; 07/11/2023
   671                              <1> %if 0
   672                              <1> 
   673                              <1> loadFromFile:
   674                              <1> 	; 07/11/2023
   675                              <1> 	; 06/11/2023
   676                              <1> 	; 17/02/2017
   677                              <1> 	;push	ax
   678                              <1> 	;push	cx
   679                              <1> 	;push	dx
   680                              <1> 	;push	bx
   681                              <1> 
   682                              <1> 	;push	es
   683                              <1> 	;push	ds
   684                              <1> 	
   685                              <1>         test    byte [flags], ENDOFFILE	; have we already read the
   686                              <1> 	;stc				; last of the file?
   687                              <1> 	; 05/11/2023
   688                              <1> 	;jnz	endLFF
   689                              <1> 	jz	short lff_12	; 06/11/2023
   690                              <1> 	; 06/11/2023
   691                              <1> 	;;mov	byte [tLoop], 0
   692                              <1> 	;jmp	endLFF
   693                              <1> 	stc
   694                              <1> 	retn
   695                              <1> 
   696                              <1> lff_12:	; 06/11/2023    
   697                              <1> 	mov	[fbs_seg], ax ; save buffer segment
   698                              <1> 	xor	dx, dx
   699                              <1> lff_0:
   700                              <1> 	mov	[fbs_off], dx ; buffer offset
   701                              <1> 
   702                              <1> 	mov     bx, (BUFFERSIZE / 2)	; 32k chunk
   703                              <1> 	mov	cl, [fbs_shift]   
   704                              <1> 	and	cl, cl
   705                              <1> 	jz	short lff_1 ; stereo, 16 bit	
   706                              <1> 
   707                              <1> 	; fbs_shift =
   708                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   709                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   710                              <1> 	shr	bx, cl ; 32K / multiplier
   711                              <1> 
   712                              <1> 	mov	ax, cs
   713                              <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   714                              <1> lff_1:
   715                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   716                              <1> 	; load file into memory
   717                              <1>         mov	cx, bx                         
   718                              <1> 	mov	bx, [filehandle]
   719                              <1> 	mov     ds, ax
   720                              <1>        	mov	ah, 3fh
   721                              <1> 	int	21h
   722                              <1> 
   723                              <1> 	mov	bx, cs
   724                              <1> 	mov	ds, bx
   725                              <1> 
   726                              <1> 	jc	short lff_9 ; error !
   727                              <1> 
   728                              <1> 	and	ax, ax
   729                              <1> 	jz	short lff_10
   730                              <1> 	
   731                              <1> 	mov	bl, [fbs_shift] ; shift count  
   732                              <1> 	or	bl, bl
   733                              <1> 	jz	short lff_7 ; 16 bit stereo samples
   734                              <1> 
   735                              <1> 	push	es
   736                              <1> 	; 06/11/2023
   737                              <1> 	;push	di
   738                              <1> 	;push	si
   739                              <1> 	mov	di, [fbs_off]
   740                              <1> 	mov	si, [fbs_seg] ; buffer segment
   741                              <1> 	mov	es, si
   742                              <1> 	mov	si, temp_buffer ; temporary buffer address
   743                              <1> 	mov	cl, [bps] ; bits per sample (8 or 16)
   744                              <1> 	cmp	cl, 8
   745                              <1> 	jne	short lff_4 ; 16 bit samples
   746                              <1> 	; 8 bit samples
   747                              <1> 	mov	cx, ax ; byte count
   748                              <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   749                              <1> 	jz	short lff_3 ; 8 bit, stereo
   750                              <1> lff_2:
   751                              <1> 	; mono & 8 bit
   752                              <1> 	lodsb
   753                              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   754                              <1> 	stosw	; left channel
   755                              <1> 	stosw	; right channel
   756                              <1> 	loop	lff_2
   757                              <1> 	jmp	short lff_6	
   758                              <1> lff_3:
   759                              <1> 	; stereo & 8 bit
   760                              <1> 	lodsb
   761                              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   762                              <1> 	stosw
   763                              <1> 	loop	lff_3			
   764                              <1> 	jmp	short lff_6
   765                              <1> lff_4:
   766                              <1> 	; 16 bit mono samples
   767                              <1> 	mov	cx, ax ; word count
   768                              <1> lff_5:	
   769                              <1> 	lodsw
   770                              <1> 	stosw	; left channel
   771                              <1> 	stosw	; right channel
   772                              <1> 	loop	lff_5
   773                              <1> lff_6:
   774                              <1> 	mov	ax, di ; save next buffer offset/position
   775                              <1> 	; 06/11/2023
   776                              <1> 	;pop	si
   777                              <1> 	;pop	di
   778                              <1> 	pop	es
   779                              <1> ;lff_7:        
   780                              <1> 	; 06/11/2023
   781                              <1> 	and	ax, ax
   782                              <1> 	jz	short endLFF ; end of 2nd half
   783                              <1> 	mov	cx, (BUFFERSIZE / 2)
   784                              <1> lff_7:
   785                              <1> 	cmp	ax, cx
   786                              <1> 	je	short endLFF	 ; 06/11/2023
   787                              <1> 	;jb	short lff_11
   788                              <1> 	;xor	cx, cx
   789                              <1> 	;sub	cx, ax
   790                              <1> 	;neg	cx
   791                              <1> 	jmp	short lff_11
   792                              <1> lff_8:
   793                              <1> 	; 07/11/2023
   794                              <1> 	cmp	word [fbs_off], (BUFFERSIZE / 2) ; 32768
   795                              <1> 	jnb	short endLFF
   796                              <1> 	
   797                              <1> 	mov	dx, ax ; buffer offset
   798                              <1> 	mov	ax, [fbs_seg] ; buffer segment
   799                              <1> 	jmp	lff_0
   800                              <1> lff_9:  
   801                              <1> 	; 07/11/2023
   802                              <1> 	;; 06/11/2023 (temporary)
   803                              <1> 	;mov	al, '!'  ; error
   804                              <1> 	;call	tL0
   805                              <1> 
   806                              <1> 	xor	ax, ax
   807                              <1> lff_10:
   808                              <1> 	; 07/11/2023
   809                              <1> 	;mov	cx, (BUFFERSIZE / 2)  
   810                              <1> lff_11:
   811                              <1> 	call    padfill				; blank pad the remainder
   812                              <1>         ;clc					; don't exit with CY yet.
   813                              <1>         or	byte [flags], ENDOFFILE		; end of file flag
   814                              <1> endLFF:
   815                              <1>         ;pop	ds
   816                              <1> 	;pop	es
   817                              <1> 	; 06/11/2023
   818                              <1> 	;pop	bx
   819                              <1> 	;pop	dx
   820                              <1>         ;pop	cx
   821                              <1>         ;pop	ax
   822                              <1>         retn
   823                              <1> 
   824                              <1> %endif
   825                              <1> 
   826                              <1> ; 08/11/2023
   827                              <1> ; 07/11/2023
   828                              <1> %if 1
   829                              <1> 
   830                              <1> loadFromFile:
   831                              <1> 	; 07/11/2023
   832                              <1> 
   833 0000075C F606[FA10]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
   834                              <1> 					; last of the file?
   835 00000761 7402                <1> 	jz	short lff_0		; no
   836 00000763 F9                  <1> 	stc
   837 00000764 C3                  <1> 	retn
   838                              <1> 
   839                              <1> lff_0:
   840                              <1> 	; 08/11/2023
   841 00000765 89C5                <1> 	mov	bp, ax ; save buffer segment	
   842                              <1> 
   843 00000767 8A0E[1C11]          <1> 	mov	cl, [fbs_shift]   
   844 0000076B 20C9                <1> 	and	cl, cl
   845 0000076D 7470                <1> 	jz	short lff_1 ; stereo, 16 bit	
   846                              <1> 
   847 0000076F BFFFFF              <1> 	mov	di, BUFFERSIZE - 1 ; 65535
   848                              <1> 
   849                              <1> 	; fbs_shift =
   850                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   851                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   852 00000772 D3EF                <1> 	shr	di, cl
   853 00000774 47                  <1> 	inc	di ; 16384 for 8 bit and mono	
   854                              <1> 		   ; 32768 for 8 bit or mono	
   855                              <1> 
   856 00000775 8CC8                <1> 	mov	ax, cs
   857 00000777 BA[2011]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   858                              <1> 
   859                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   860                              <1> 	; load file into memory
   861 0000077A 89F9                <1>         mov	cx, di                       
   862 0000077C 8B1E[F810]          <1> 	mov	bx, [filehandle]
   863 00000780 8ED8                <1> 	mov     ds, ax
   864 00000782 B43F                <1>        	mov	ah, 3Fh
   865 00000784 CD21                <1> 	int	21h
   866                              <1> 
   867 00000786 8CCB                <1> 	mov	bx, cs
   868 00000788 8EDB                <1> 	mov	ds, bx
   869                              <1> 
   870 0000078A 724A                <1> 	jc	short lff_4 ; error !
   871                              <1> 
   872                              <1> 	; 08/11/2023
   873 0000078C 31D2                <1> 	xor	dx, dx ; 0
   874                              <1> 
   875 0000078E 21C0                <1> 	and	ax, ax
   876 00000790 7476                <1> 	jz	short lff_3
   877                              <1> 
   878 00000792 8A1E[1C11]          <1> 	mov	bl, [fbs_shift]
   879                              <1> 
   880 00000796 06                  <1> 	push	es
   881 00000797 89D7                <1> 	mov	di, dx ; 0 ; [fbs_off]
   882                              <1> 	;mov	bp, [fbs_seg] ; buffer segment
   883 00000799 8EC5                <1> 	mov	es, bp
   884 0000079B BE[2011]            <1> 	mov	si, temp_buffer ; temporary buffer address
   885 0000079E 89C1                <1> 	mov	cx, ax ; byte count
   886 000007A0 803E[1A11]08        <1> 	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   887 000007A5 751B                <1> 	jne	short lff_7 ; 16 bit samples
   888                              <1> 	; 8 bit samples
   889 000007A7 FECB                <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   890 000007A9 740C                <1> 	jz	short lff_6 ; 8 bit, stereo
   891                              <1> lff_5:
   892                              <1> 	; mono & 8 bit
   893 000007AB AC                  <1> 	lodsb
   894 000007AC 2C80                <1> 	sub	al, 80h ; 08/11/2023
   895 000007AE C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   896 000007B1 AB                  <1> 	stosw	; left channel
   897 000007B2 AB                  <1> 	stosw	; right channel
   898 000007B3 E2F6                <1> 	loop	lff_5
   899 000007B5 EB12                <1> 	jmp	short lff_9	
   900                              <1> lff_6:
   901                              <1> 	; stereo & 8 bit
   902 000007B7 AC                  <1> 	lodsb
   903 000007B8 2C80                <1> 	sub	al, 80h ; 08/11/2023
   904 000007BA C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   905 000007BD AB                  <1> 	stosw
   906 000007BE E2F7                <1> 	loop	lff_6			
   907 000007C0 EB07                <1> 	jmp	short lff_9
   908                              <1> lff_7:
   909 000007C2 D1E9                <1> 	shr	cx, 1 ; word count
   910                              <1> lff_8:
   911 000007C4 AD                  <1> 	lodsw
   912 000007C5 AB                  <1> 	stosw	; left channel
   913 000007C6 AB                  <1> 	stosw	; right channel
   914 000007C7 E2FB                <1> 	loop	lff_8
   915                              <1> lff_9:
   916 000007C9 07                  <1> 	pop	es
   917 000007CA 09FF                <1> 	or	di, di
   918 000007CC 7442                <1> 	jz	short endLFF ; 64KB ok 
   919                              <1> 	
   920 000007CE 89F8                <1> 	mov	ax, di ; [fbs_off]
   921 000007D0 48                  <1> 	dec	ax
   922 000007D1 B9FFFF              <1> 	mov	cx, BUFFERSIZE - 1 ; 65535
   923 000007D4 EB32                <1> 	jmp	short lff_3
   924                              <1> 
   925                              <1> lff_4:
   926                              <1> 	; 08/11/2023
   927 000007D6 B021                <1> 	mov	al, '!'  ; error
   928 000007D8 E873FF              <1> 	call	tL0
   929                              <1> 
   930 000007DB 31C0                <1> 	xor	ax, ax
   931 000007DD EB29                <1> 	jmp	short lff_3
   932                              <1> 	
   933                              <1> lff_1:  
   934                              <1> 	;mov	bp, ax ; save buffer segment
   935 000007DF 31D2                <1> 	xor	dx, dx
   936                              <1> 	; load file into memory
   937 000007E1 B90080              <1>         mov	cx, (BUFFERSIZE / 2)	; 32k chunk
   938 000007E4 8B1E[F810]          <1> 	mov	bx, [filehandle]
   939 000007E8 8ED8                <1> 	mov     ds, ax
   940 000007EA B43F                <1>        	mov	ah, 3Fh
   941 000007EC CD21                <1> 	int	21h
   942                              <1> 
   943 000007EE 8CCF                <1> 	mov	di, cs
   944 000007F0 8EDF                <1> 	mov	ds, di
   945                              <1> 
   946                              <1> 	; 07/11/2023
   947 000007F2 72E2                <1> 	jc	short lff_4 ; error !
   948                              <1> 	
   949 000007F4 39C8                <1> 	cmp	ax, cx
   950 000007F6 7510                <1> 	jne	short lff_3
   951                              <1> lff_2:
   952                              <1> 	; 08/11/2023
   953 000007F8 01C2                <1> 	add	dx, ax
   954                              <1> 	;mov	cx, (BUFFERSIZE / 2)	; 32k chunk
   955                              <1> 	;mov	bx, [filehandle]
   956 000007FA 8EDD                <1> 	mov     ds, bp
   957 000007FC B43F                <1>        	mov	ah, 3Fh
   958 000007FE CD21                <1> 	int	21h
   959                              <1> 
   960                              <1> 	;mov	di, cs
   961 00000800 8EDF                <1> 	mov	ds, di
   962                              <1> 
   963 00000802 72D2                <1> 	jc	short lff_4 ; error !
   964                              <1> 
   965 00000804 39C8                <1> 	cmp	ax, cx
   966 00000806 7408                <1> 	je	short endLFF
   967                              <1> lff_3:
   968 00000808 E80600              <1> 	call    padfill			; blank pad the remainder
   969                              <1>         ;clc				; don't exit with CY yet.
   970 0000080B 800E[FA10]01        <1>         or	byte [flags], ENDOFFILE	; end of file flag
   971                              <1> endLFF:
   972 00000810 C3                  <1>         retn
   973                              <1> 
   974                              <1> %endif
   975                              <1> 
   976                              <1> ; entry ds:ax points to last byte in file
   977                              <1> ; cx=target size
   978                              <1> ; note: must do byte size fill
   979                              <1> ; destroys bx, cx
   980                              <1> ;
   981                              <1> padfill:
   982                              <1> 	; 07/11/2023
   983                              <1> 	; 06/11/2023
   984                              <1> 	; 17/02/2017
   985 00000811 06                  <1> 	push	es
   986                              <1>         ;push	di
   987                              <1> 	;mov	di, [fbs_seg]
   988                              <1> 	;mov	es, di
   989 00000812 8EC5                <1>         mov	es, bp
   990 00000814 29C1                <1> 	sub	cx, ax
   991                              <1> 	; 08/11/2023
   992                              <1> 	;mov	di, ax ; (wrong)
   993 00000816 89D7                <1> 	mov	di, dx ; buffer offset
   994 00000818 01C7                <1> 	add	di, ax       	
   995                              <1> 	; 07/11/2023
   996                              <1> 	;add	di, [fbs_off]
   997 0000081A 30C0                <1>         xor	al, al
   998 0000081C F3AA                <1> 	rep	stosb
   999                              <1> 	;mov	[fbs_off], di
  1000                              <1> 	;pop	di
  1001 0000081E 07                  <1>         pop	es
  1002 0000081F C3                  <1> 	retn
  1003                              <1> 
  1004                              <1> ; returns AL = current index value
  1005                              <1> getCurrentIndex:
  1006                              <1> 	; 08/11/2023
  1007                              <1> 	;push	dx
  1008 00000820 8B16[0611]          <1> 	mov	dx, [NABMBAR]      		
  1009 00000824 83C214              <1> 	add	dx, PO_CIV_REG
  1010 00000827 EC                  <1> 	in	al, dx
  1011                              <1> 	;pop	dx
  1012                              <1> uLVI2:	;	06/11/2023
  1013 00000828 C3                  <1> 	retn
  1014                              <1> 
  1015                              <1> ; examines the CIV and the LVI. When they're the same, we set LVI <> CIV
  1016                              <1> ; that way, we never run out of buffers to play
  1017                              <1> 
  1018                              <1> ; 08/11/2023
  1019                              <1> %if 0
  1020                              <1> 	; 07/11/2023
  1021                              <1> updateLVI:
  1022                              <1> 	push	ax
  1023                              <1> 	push	dx
  1024                              <1> 	; 06/11/2023
  1025                              <1> 	mov	dx, [NABMBAR]
  1026                              <1> 	add	dx, PO_CIV_REG
  1027                              <1> 	; (Current Index Value and Last Valid Index value)
  1028                              <1> 	in	ax, dx
  1029                              <1> 
  1030                              <1> 	cmp	al, ah ; is current index = last index ?
  1031                              <1> 	jne	short uLVI1
  1032                              <1> 
  1033                              <1> 	call	setNewIndex
  1034                              <1> uLVI1:
  1035                              <1> 	pop	dx
  1036                              <1> 	pop	ax
  1037                              <1> 	retn
  1038                              <1> 
  1039                              <1> setNewIndex:
  1040                              <1> 	; 07/11/2023
  1041                              <1> 	push	ax
  1042                              <1>         call    getCurrentIndex                 ; get CIV
  1043                              <1>         test    byte [flags], ENDOFFILE
  1044                              <1>         jnz     short sni_1
  1045                              <1>         ; not at the end of the file yet.
  1046                              <1>         dec     al                              ; make new index <> current
  1047                              <1>         and     al, INDEX_MASK                  ; make sure new value is 0-31
  1048                              <1> sni_1:
  1049                              <1>         call    setLastValidIndex               ; write new value
  1050                              <1>         clc
  1051                              <1>         pop	ax
  1052                              <1> 	retn
  1053                              <1> 
  1054                              <1> %endif	
  1055                              <1> 
  1056                              <1> ; 08/11/2023
  1057                              <1> ; 07/11/2023
  1058                              <1> %if 0
  1059                              <1> updateLVI:
  1060                              <1> 	; 06/11/2023
  1061                              <1> 	mov	dx, [NABMBAR]      		
  1062                              <1> 	add	dx, PO_CIV_REG
  1063                              <1> 	; (Current Index Value and Last Valid Index value)
  1064                              <1> 	in	ax, dx
  1065                              <1> 
  1066                              <1> 	cmp	al, ah ; is current index = last index ?
  1067                              <1> 	jne	short uLVI2
  1068                              <1> 
  1069                              <1> 	; 10/11/2023
  1070                              <1> 	; 08/11/2023	
  1071                              <1> 	call	getCurrentIndex
  1072                              <1>  
  1073                              <1> 	test	byte [flags], ENDOFFILE
  1074                              <1> 	;jnz	short uLVI1
  1075                              <1> 	jz	short uLVI0  ; 08/11/2023
  1076                              <1> 
  1077                              <1> 	; 08/11/2023
  1078                              <1> 	push	ax
  1079                              <1> 	mov	dx, [NABMBAR]
  1080                              <1> 	add	dx, PO_SR_REG  ; PCM out status register
  1081                              <1> 	in	ax, dx
  1082                              <1> 
  1083                              <1> 	;test	al, 2
  1084                              <1> 	test	al, 3 ; bit 1 = Current Equals Last Valid (CELV)
  1085                              <1> 		      ; (has been processed)
  1086                              <1> 		      ; bit 0 = 1 -> DMA Controller Halted (DCH)
  1087                              <1> 	pop	ax
  1088                              <1> 	jz	short uLVI1
  1089                              <1> uLVI3:
  1090                              <1> 	xor	ax, ax
  1091                              <1> 	; zf = 1
  1092                              <1> 	retn
  1093                              <1> uLVI0:
  1094                              <1>         ; not at the end of the file yet.
  1095                              <1> 	dec	al
  1096                              <1> 	and	al, 1Fh
  1097                              <1> uLVI1:
  1098                              <1> 	;call	setLastValidIndex
  1099                              <1> ;uLVI2:
  1100                              <1> 	;retn
  1101                              <1> 
  1102                              <1> %endif
  1103                              <1> 	
  1104                              <1> ;input AL = index # to stop on
  1105                              <1> setLastValidIndex:
  1106                              <1> 	; 08/11/2023
  1107                              <1> 	;push	dx
  1108 00000829 8B16[0611]          <1> 	mov	dx, [NABMBAR]
  1109 0000082D 83C215              <1> 	add	dx, PO_LVI_REG
  1110 00000830 EE                  <1>         out     dx, al
  1111                              <1> 	;pop	dx
  1112 00000831 C3                  <1> 	retn
  1113                              <1> 
  1114                              <1> ; 06/11/2023
  1115                              <1> ;	; 05/11/2023
  1116                              <1> ;setCurrentIndex:
  1117                              <1> ;	;push	dx
  1118                              <1> ;	mov	dx, [NABMBAR]
  1119                              <1> ;	add	dx, PO_CIV_REG
  1120                              <1> ;	out	dx, al
  1121                              <1> ;	;pop	dx
  1122                              <1> ;	retn
  1123                              <1> 
  1124                              <1> ; checks if either shift key has been pressed. Exits with CY if so.
  1125                              <1> ; 
  1126                              <1> check4keyboardstop:
  1127                              <1> 
  1128                              <1> ; 06/11/2023
  1129                              <1> %if 1
  1130                              <1> 	; 08/11/2023
  1131                              <1> 	; 04/11/2023
  1132 00000832 B401                <1> 	mov	ah, 1
  1133 00000834 CD16                <1> 	int	16h
  1134 00000836 F8                  <1> 	clc
  1135 00000837 7405                <1> 	jz	short _cksr
  1136 00000839 30E4                <1> 	xor	ah, ah
  1137 0000083B CD16                <1> 	int	16h
  1138 0000083D F9                  <1> 	stc
  1139                              <1> _cksr:
  1140 0000083E C3                  <1> 	retn
  1141                              <1> %endif
  1142                              <1> 
  1143                              <1> ; 06/11/2023
  1144                              <1> ; 04/11/2023
  1145                              <1> %if 0	
  1146                              <1>         push    ds
  1147                              <1>         push    0
  1148                              <1>         pop     ds		       ; examine BDA for keyboard flags
  1149                              <1>         test    byte [417h], (BIT0 | BIT1)
  1150                              <1>         pop     ds
  1151                              <1>         stc
  1152                              <1>         jnz	short _cksr ; 07/11/2023
  1153                              <1> 	;jz	short _cksr ; 06/11/2023
  1154                              <1>         clc
  1155                              <1> _cksr:
  1156                              <1>         retn
  1157                              <1> %endif
  1158                              <1> 
  1159                              <1> ; 13/11/2023 - Erdogan Tan - (VRA, sample rate conversion)
  1160                              <1> ; --------------------------------------------------------
  1161                              <1> 
  1162                              <1> load_8khz_mono_8_bit:
  1163                              <1> 	; 13/11/2023
  1164                              <1> 
  1165 0000083F F606[FA10]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1166                              <1> 					; last of the file?
  1167 00000844 7402                <1> 	jz	short lff8m_0		; no
  1168 00000846 F9                  <1> 	stc
  1169 00000847 C3                  <1> 	retn
  1170                              <1> 
  1171                              <1> lff8m_0:
  1172 00000848 8EC0                <1> 	mov	es, ax ; buffer segment	
  1173 0000084A 31FF                <1> 	xor	di, di
  1174 0000084C BA[2011]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1175                              <1> 	; ds = cs
  1176                              <1> 
  1177                              <1> 	; load file into memory
  1178 0000084F 8B0E[3D06]          <1>         mov	cx, [loadsize]
  1179 00000853 8B1E[F810]          <1> 	mov	bx, [filehandle]
  1180 00000857 B43F                <1>        	mov	ah, 3Fh
  1181 00000859 CD21                <1> 	int	21h
  1182 0000085B 7270                <1> 	jc	short lff8m_5 ; error !
  1183                              <1> 
  1184 0000085D 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1185 0000085F 21C0                <1> 	and	ax, ax
  1186 00000861 7457                <1> 	jz	short lff8m_3
  1187                              <1> 
  1188 00000863 89C1                <1> 	mov	cx, ax		; byte count
  1189                              <1> lff8m_1:
  1190 00000865 AC                  <1> 	lodsb
  1191 00000866 2C80                <1> 	sub	al, 80h
  1192 00000868 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1193 0000086B A3[9B0C]            <1> 	mov	[previous_val], ax
  1194 0000086E AB                  <1> 	stosw		; original sample (left channel)
  1195 0000086F AB                  <1> 	stosw		; original sample (right channel)
  1196 00000870 31C0                <1> 	xor	ax, ax
  1197 00000872 49                  <1> 	dec	cx
  1198 00000873 7405                <1> 	jz	short lff8m_2
  1199                              <1> 	;mov	al, [si]
  1200                              <1> 	;sub	al, 80h
  1201                              <1> 	;shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1202 00000875 8A24                <1> 	mov	ah, [si]
  1203 00000877 80EC80              <1> 	sub	ah, 80h
  1204                              <1> lff8m_2:
  1205                              <1> 	;mov	[new_val], ax
  1206 0000087A 89C5                <1> 	mov	bp, ax	; [new_val]
  1207 0000087C 0306[9B0C]          <1> 	add	ax, [previous_val]
  1208 00000880 D1E8                <1> 	shr	ax, 1
  1209 00000882 89C2                <1> 	mov	dx, ax	; this is interpolated middle (3th) sample
  1210 00000884 0306[9B0C]          <1> 	add	ax, [previous_val]
  1211 00000888 D1E8                <1> 	shr	ax, 1	
  1212 0000088A 89C3                <1> 	mov	bx, ax 	; this is temporary interpolation value	
  1213 0000088C 0306[9B0C]          <1> 	add	ax, [previous_val]
  1214 00000890 D1E8                <1> 	shr	ax, 1
  1215 00000892 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1216 00000893 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1217 00000894 89D8                <1> 	mov	ax, bx
  1218 00000896 01D0                <1> 	add	ax, dx
  1219 00000898 D1E8                <1> 	shr	ax, 1
  1220 0000089A AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1221 0000089B AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1222 0000089C 89D0                <1> 	mov	ax, dx
  1223 0000089E AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1224 0000089F AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1225                              <1> 	;mov	ax, [new_val]
  1226 000008A0 89E8                <1> 	mov	ax, bp
  1227 000008A2 01D0                <1> 	add	ax, dx
  1228 000008A4 D1E8                <1> 	shr	ax, 1
  1229 000008A6 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value
  1230 000008A8 01D0                <1> 	add	ax, dx
  1231 000008AA D1E8                <1> 	shr	ax, 1
  1232 000008AC AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1233 000008AD AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1234                              <1> 	;mov	ax, [new_val]
  1235 000008AE 89E8                <1> 	mov	ax, bp
  1236 000008B0 01D8                <1> 	add	ax, bx
  1237 000008B2 D1E8                <1> 	shr	ax, 1
  1238 000008B4 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1239 000008B5 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1240                              <1> 	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1241 000008B6 09C9                <1> 	or	cx, cx
  1242 000008B8 75AB                <1> 	jnz	short lff8m_1
  1243                              <1> 
  1244                              <1> lff8s_3:
  1245                              <1> lff8m_3:
  1246                              <1> lff8s2_3:
  1247                              <1> lff8m2_3:
  1248                              <1> lff16s_3:
  1249                              <1> lff16m_3:
  1250                              <1> lff16s2_3:
  1251                              <1> lff16m2_3:
  1252 000008BA 8B0E[3F06]          <1> 	mov	cx, [buffersize] ; 16 bit (48 kHZ, stereo) sample size
  1253 000008BE D1E1                <1> 	shl	cx, 1 ; byte count
  1254 000008C0 29F9                <1> 	sub	cx, di
  1255 000008C2 7606                <1> 	jna	short lff8m_4
  1256                              <1> 	;inc	cx
  1257 000008C4 D1E9                <1> 	shr	cx, 1
  1258 000008C6 31C0                <1> 	xor	ax, ax	 ; fill (remain part of) buffer with zeros	
  1259 000008C8 F3AB                <1> 	rep	stosw
  1260                              <1> lff8m_4:
  1261 000008CA 0E                  <1> 	push	cs
  1262 000008CB 07                  <1> 	pop	es
  1263 000008CC C3                  <1> 	retn
  1264                              <1> 
  1265                              <1> lff8s_5:
  1266                              <1> lff8m_5:
  1267                              <1> lff8s2_5:
  1268                              <1> lff8m2_5:
  1269                              <1> lff16s_5:
  1270                              <1> lff16m_5:
  1271                              <1> lff16s2_5:
  1272                              <1> lff16m2_5:
  1273 000008CD B021                <1> 	mov	al, '!'  ; error
  1274 000008CF E87CFE              <1> 	call	tL0
  1275                              <1> 
  1276 000008D2 EBE6                <1> 	jmp	short lff8m_3
  1277                              <1> 
  1278                              <1> load_8khz_stereo_8_bit:
  1279                              <1> 	; 13/11/2023
  1280                              <1> 
  1281 000008D4 F606[FA10]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1282                              <1> 					; last of the file?
  1283 000008D9 7402                <1> 	jz	short lff8s_0		; no
  1284 000008DB F9                  <1> 	stc
  1285 000008DC C3                  <1> 	retn
  1286                              <1> 
  1287                              <1> lff8s_0:
  1288 000008DD 8EC0                <1> 	mov	es, ax ; buffer segment	
  1289 000008DF 31FF                <1> 	xor	di, di
  1290 000008E1 BA[2011]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1291                              <1> 	; ds = cs
  1292                              <1> 
  1293                              <1> 	; load file into memory
  1294 000008E4 8B0E[3D06]          <1>         mov	cx, [loadsize]
  1295 000008E8 8B1E[F810]          <1> 	mov	bx, [filehandle]
  1296 000008EC B43F                <1>        	mov	ah, 3Fh
  1297 000008EE CD21                <1> 	int	21h
  1298 000008F0 72DB                <1> 	jc	short lff8s_5 ; error !
  1299                              <1> 
  1300 000008F2 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1301                              <1> 	
  1302 000008F4 D1E8                <1> 	shr	ax, 1
  1303                              <1> 	;and	ax, ax
  1304 000008F6 74C2                <1> 	jz	short lff8s_3
  1305                              <1> 
  1306 000008F8 89C1                <1> 	mov	cx, ax		; word count
  1307                              <1> lff8s_1:
  1308 000008FA AC                  <1> 	lodsb
  1309 000008FB 2C80                <1> 	sub	al, 80h
  1310 000008FD C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1311 00000900 A3[9B0C]            <1> 	mov	[previous_val_l], ax
  1312 00000903 AB                  <1> 	stosw		; original sample (L)
  1313 00000904 AC                  <1> 	lodsb
  1314 00000905 2C80                <1> 	sub	al, 80h
  1315 00000907 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1316 0000090A A3[9D0C]            <1> 	mov	[previous_val_r], ax
  1317 0000090D AB                  <1> 	stosw		; original sample (R)
  1318                              <1> 
  1319 0000090E 31C0                <1> 	xor	ax, ax
  1320 00000910 31D2                <1> 	xor	dx, dx
  1321 00000912 49                  <1> 	dec	cx
  1322 00000913 740C                <1> 	jz	short lff8s_2
  1323                              <1> 		; convert 8 bit sample to 16 bit sample
  1324 00000915 8B04                <1> 	mov	ax, [si]
  1325                              <1> 	;sub	al, 80h
  1326                              <1> 	;sub	ah, 80h
  1327                              <1> 	;mov	dh, ah
  1328                              <1> 	;shl	ax, 8
  1329 00000917 86E0                <1> 	xchg	ah, al ; ah <-> al
  1330 00000919 80EC80              <1> 	sub	ah, 80h
  1331 0000091C 86F0                <1> 	xchg	dh, al ; al -> dh, al = 0
  1332 0000091E 80EE80              <1> 	sub	dh, 80h
  1333                              <1> lff8s_2:
  1334 00000921 A3[9F0C]            <1> 	mov	[new_val_l], ax
  1335 00000924 8916[A10C]          <1> 	mov	[new_val_r], dx
  1336 00000928 0306[9B0C]          <1> 	add	ax, [previous_val_l]
  1337 0000092C D1E8                <1> 	shr	ax, 1
  1338 0000092E 89C2                <1> 	mov	dx, ax	; this is interpolated middle (3th) sample (L)
  1339 00000930 0306[9B0C]          <1> 	add	ax, [previous_val_l]
  1340 00000934 D1E8                <1> 	shr	ax, 1	
  1341 00000936 89C3                <1> 	mov	bx, ax 	; this is temporary interpolation value (L)
  1342 00000938 0306[9B0C]          <1> 	add	ax, [previous_val_l]
  1343 0000093C D1E8                <1> 	shr	ax, 1
  1344 0000093E AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1345 0000093F A1[A10C]            <1> 	mov	ax, [new_val_r]
  1346 00000942 0306[9D0C]          <1> 	add	ax, [previous_val_r]
  1347 00000946 D1E8                <1> 	shr	ax, 1
  1348 00000948 89C5                <1> 	mov	bp, ax	; this is interpolated middle (3th) sample (R)
  1349 0000094A 0306[9D0C]          <1> 	add	ax, [previous_val_r]
  1350 0000094E D1E8                <1> 	shr	ax, 1
  1351 00000950 50                  <1> 	push	ax ; *	; this is temporary interpolation value (R)
  1352 00000951 0306[9D0C]          <1> 	add	ax, [previous_val_r]
  1353 00000955 D1E8                <1> 	shr	ax, 1
  1354 00000957 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1355 00000958 89D8                <1> 	mov	ax, bx
  1356 0000095A 01D0                <1> 	add	ax, dx
  1357 0000095C D1E8                <1> 	shr	ax, 1
  1358 0000095E AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1359 0000095F 58                  <1> 	pop	ax ; *
  1360 00000960 01E8                <1> 	add	ax, bp
  1361 00000962 D1E8                <1> 	shr	ax, 1
  1362 00000964 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1363 00000965 89D0                <1> 	mov	ax, dx
  1364 00000967 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1365 00000968 89E8                <1> 	mov	ax, bp
  1366 0000096A AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1367 0000096B A1[9F0C]            <1> 	mov	ax, [new_val_l]
  1368 0000096E 01D0                <1> 	add	ax, dx
  1369 00000970 D1E8                <1> 	shr	ax, 1
  1370 00000972 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value (L)
  1371 00000974 01D0                <1> 	add	ax, dx
  1372 00000976 D1E8                <1> 	shr	ax, 1
  1373 00000978 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1374 00000979 A1[A10C]            <1> 	mov	ax, [new_val_r]
  1375 0000097C 01E8                <1> 	add	ax, bp
  1376 0000097E D1E8                <1> 	shr	ax, 1
  1377 00000980 50                  <1> 	push	ax ; ** ; this is temporary interpolation value (R)
  1378 00000981 01E8                <1> 	add	ax, bp
  1379 00000983 D1E8                <1> 	shr	ax, 1
  1380 00000985 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1381 00000986 A1[9F0C]            <1> 	mov	ax, [new_val_l]
  1382 00000989 01D8                <1> 	add	ax, bx
  1383 0000098B D1E8                <1> 	shr	ax, 1
  1384 0000098D AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1385 0000098E 58                  <1> 	pop	ax ; **
  1386 0000098F 0306[A10C]          <1> 	add	ax, [new_val_r]
  1387 00000993 D1E8                <1> 	shr	ax, 1
  1388 00000995 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1389                              <1> 	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1390 00000996 833E[9F0C]00        <1> 	cmp	word [new_val_l], 0
  1391 0000099B 7603                <1> 	jna	short lff8s_6
  1392 0000099D E95AFF              <1> 	jmp	lff8s_1
  1393                              <1> lff8s_6:
  1394 000009A0 E917FF              <1> 	jmp	lff8s_3
  1395                              <1> 
  1396                              <1> load_8khz_mono_16_bit:
  1397                              <1> 	; 13/11/2023
  1398                              <1> 
  1399 000009A3 F606[FA10]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1400                              <1> 					; last of the file?
  1401 000009A8 7402                <1> 	jz	short lff8m2_0		; no
  1402 000009AA F9                  <1> 	stc
  1403 000009AB C3                  <1> 	retn
  1404                              <1> 
  1405                              <1> lff8m2_0:
  1406 000009AC 8EC0                <1> 	mov	es, ax ; buffer segment	
  1407 000009AE 31FF                <1> 	xor	di, di
  1408 000009B0 BA[2011]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1409                              <1> 	; ds = cs
  1410                              <1> 
  1411                              <1> 	; load file into memory
  1412 000009B3 8B0E[3D06]          <1>         mov	cx, [loadsize]
  1413 000009B7 8B1E[F810]          <1> 	mov	bx, [filehandle]
  1414 000009BB B43F                <1>        	mov	ah, 3Fh
  1415 000009BD CD21                <1> 	int	21h
  1416 000009BF 725B                <1> 	jc	short lff8m2_7 ; error !
  1417                              <1> 
  1418 000009C1 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1419                              <1> 	
  1420 000009C3 D1E8                <1> 	shr	ax, 1
  1421                              <1> 	;and	ax, ax
  1422 000009C5 7503                <1> 	jnz	short lff8m2_8
  1423 000009C7 E9F0FE              <1> 	jmp	lff8m2_3
  1424                              <1> lff8m2_8:
  1425 000009CA 89C1                <1> 	mov	cx, ax		; word count
  1426                              <1> lff8m2_1:
  1427 000009CC AD                  <1> 	lodsw
  1428 000009CD A3[9B0C]            <1> 	mov	[previous_val], ax
  1429 000009D0 AB                  <1> 	stosw		; original sample (left channel)
  1430 000009D1 AB                  <1> 	stosw		; original sample (right channel)
  1431 000009D2 31C0                <1> 	xor	ax, ax
  1432 000009D4 49                  <1> 	dec	cx
  1433 000009D5 7402                <1> 	jz	short lff8m2_2
  1434 000009D7 8B04                <1> 	mov	ax, [si]
  1435                              <1> lff8m2_2:
  1436 000009D9 89C5                <1> 	mov	bp, ax	; [new_val]
  1437 000009DB 0306[9B0C]          <1> 	add	ax, [previous_val]
  1438 000009DF D1E8                <1> 	shr	ax, 1
  1439 000009E1 89C2                <1> 	mov	dx, ax	; this is interpolated middle (3th) sample
  1440 000009E3 0306[9B0C]          <1> 	add	ax, [previous_val]
  1441 000009E7 D1E8                <1> 	shr	ax, 1	; this is temporary interpolation value
  1442 000009E9 89C3                <1> 	mov	bx, ax 		
  1443 000009EB 0306[9B0C]          <1> 	add	ax, [previous_val]
  1444 000009EF D1E8                <1> 	shr	ax, 1
  1445 000009F1 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1446 000009F2 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1447 000009F3 89D8                <1> 	mov	ax, bx
  1448 000009F5 01D0                <1> 	add	ax, dx
  1449 000009F7 D1E8                <1> 	shr	ax, 1
  1450 000009F9 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1451 000009FA AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1452 000009FB 89D0                <1> 	mov	ax, dx
  1453 000009FD AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1454 000009FE AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1455 000009FF 89E8                <1> 	mov	ax, bp
  1456 00000A01 01D0                <1> 	add	ax, dx
  1457 00000A03 D1E8                <1> 	shr	ax, 1
  1458 00000A05 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value
  1459 00000A07 01D0                <1> 	add	ax, dx
  1460 00000A09 D1E8                <1> 	shr	ax, 1
  1461 00000A0B AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1462 00000A0C AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1463 00000A0D 89E8                <1> 	mov	ax, bp
  1464 00000A0F 01D8                <1> 	add	ax, bx
  1465 00000A11 D1E8                <1> 	shr	ax, 1
  1466 00000A13 AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1467 00000A14 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1468                              <1> 	; 8 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1469 00000A15 09C9                <1> 	or	cx, cx
  1470 00000A17 75B3                <1> 	jnz	short lff8m2_1
  1471 00000A19 E99EFE              <1> 	jmp	lff8m2_3
  1472                              <1> 
  1473                              <1> lff8m2_7:
  1474                              <1> lff8s2_7:
  1475 00000A1C E9AEFE              <1> 	jmp	lff8m2_5  ; error
  1476                              <1> 
  1477                              <1> load_8khz_stereo_16_bit:
  1478                              <1> 	; 13/11/2023
  1479                              <1> 
  1480 00000A1F F606[FA10]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1481                              <1> 					; last of the file?
  1482 00000A24 7402                <1> 	jz	short lff8s2_0		; no
  1483 00000A26 F9                  <1> 	stc
  1484 00000A27 C3                  <1> 	retn
  1485                              <1> 
  1486                              <1> lff8s2_0:
  1487 00000A28 8EC0                <1> 	mov	es, ax ; buffer segment	
  1488 00000A2A 31FF                <1> 	xor	di, di
  1489 00000A2C BA[2011]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1490                              <1> 	; ds = cs
  1491                              <1> 
  1492                              <1> 	; load file into memory
  1493 00000A2F 8B0E[3D06]          <1>         mov	cx, [loadsize]
  1494 00000A33 8B1E[F810]          <1> 	mov	bx, [filehandle]
  1495 00000A37 B43F                <1>        	mov	ah, 3Fh
  1496 00000A39 CD21                <1> 	int	21h
  1497 00000A3B 72DF                <1> 	jc	short lff8s2_7 ; error !
  1498                              <1> 
  1499 00000A3D 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1500                              <1> 	
  1501 00000A3F D1E8                <1> 	shr	ax, 1
  1502                              <1> 	;and	ax, ax
  1503 00000A41 7503                <1> 	jnz	short lff8s2_8
  1504 00000A43 E974FE              <1> 	jmp	lff8s2_3
  1505                              <1> lff8s2_8:
  1506 00000A46 89C1                <1> 	mov	cx, ax ; word count
  1507                              <1> lff8s2_1:
  1508 00000A48 AD                  <1> 	lodsw
  1509 00000A49 A3[9B0C]            <1> 	mov	[previous_val_l], ax
  1510 00000A4C AB                  <1> 	stosw		; original sample (L)
  1511 00000A4D AD                  <1> 	lodsw
  1512 00000A4E A3[9D0C]            <1> 	mov	[previous_val_r], ax
  1513 00000A51 AB                  <1> 	stosw		; original sample (R)
  1514 00000A52 31D2                <1> 	xor	dx, dx
  1515 00000A54 31C0                <1> 	xor	ax, ax
  1516 00000A56 49                  <1> 	dec	cx	; 16 bit
  1517 00000A57 7408                <1> 	jz	short lff8s2_2
  1518 00000A59 49                  <1> 	dec	cx	; stereo
  1519 00000A5A 7405                <1> 	jz	short lff8s2_2
  1520 00000A5C 8B04                <1> 	mov	ax, [si]
  1521 00000A5E 8B5402              <1> 	mov	dx, [si+2]
  1522                              <1> lff8s2_2:
  1523 00000A61 A3[9F0C]            <1> 	mov	[new_val_l], ax
  1524 00000A64 8916[A10C]          <1> 	mov	[new_val_r], dx
  1525 00000A68 0306[9B0C]          <1> 	add	ax, [previous_val_l]
  1526 00000A6C D1E8                <1> 	shr	ax, 1
  1527 00000A6E 89C2                <1> 	mov	dx, ax	; this is interpolated middle (3th) sample (L)
  1528 00000A70 0306[9B0C]          <1> 	add	ax, [previous_val_l]
  1529 00000A74 D1E8                <1> 	shr	ax, 1	
  1530 00000A76 89C3                <1> 	mov	bx, ax 	; this is temporary interpolation value (L)
  1531 00000A78 0306[9B0C]          <1> 	add	ax, [previous_val_l]
  1532 00000A7C D1E8                <1> 	shr	ax, 1
  1533 00000A7E AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1534 00000A7F A1[A10C]            <1> 	mov	ax, [new_val_r]
  1535 00000A82 0306[9D0C]          <1> 	add	ax, [previous_val_r]
  1536 00000A86 D1E8                <1> 	shr	ax, 1
  1537 00000A88 89C5                <1> 	mov	bp, ax	; this is interpolated middle (3th) sample (R)
  1538 00000A8A 0306[9D0C]          <1> 	add	ax, [previous_val_r]
  1539 00000A8E D1E8                <1> 	shr	ax, 1
  1540 00000A90 50                  <1> 	push	ax ; *	; this is temporary interpolation value (R)
  1541 00000A91 0306[9D0C]          <1> 	add	ax, [previous_val_r]
  1542 00000A95 D1E8                <1> 	shr	ax, 1
  1543 00000A97 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1544 00000A98 89D8                <1> 	mov	ax, bx
  1545 00000A9A 01D0                <1> 	add	ax, dx
  1546 00000A9C D1E8                <1> 	shr	ax, 1
  1547 00000A9E AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1548 00000A9F 58                  <1> 	pop	ax ; *
  1549 00000AA0 01E8                <1> 	add	ax, bp
  1550 00000AA2 D1E8                <1> 	shr	ax, 1
  1551 00000AA4 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1552 00000AA5 89D0                <1> 	mov	ax, dx
  1553 00000AA7 AB                  <1> 	stosw		; this is middle (3th) interpolated sample (L)
  1554 00000AA8 89E8                <1> 	mov	ax, bp
  1555 00000AAA AB                  <1> 	stosw		; this is middle (3th) interpolated sample (R)
  1556 00000AAB A1[9F0C]            <1> 	mov	ax, [new_val_l]
  1557 00000AAE 01D0                <1> 	add	ax, dx
  1558 00000AB0 D1E8                <1> 	shr	ax, 1
  1559 00000AB2 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value (L)
  1560 00000AB4 01D0                <1> 	add	ax, dx
  1561 00000AB6 D1E8                <1> 	shr	ax, 1
  1562 00000AB8 AB                  <1> 	stosw		; this is 4th interpolated sample (L)
  1563 00000AB9 A1[A10C]            <1> 	mov	ax, [new_val_r]
  1564 00000ABC 01E8                <1> 	add	ax, bp
  1565 00000ABE D1E8                <1> 	shr	ax, 1
  1566 00000AC0 50                  <1> 	push	ax ; ** ; this is temporary interpolation value (R)
  1567 00000AC1 01E8                <1> 	add	ax, bp
  1568 00000AC3 D1E8                <1> 	shr	ax, 1
  1569 00000AC5 AB                  <1> 	stosw		; this is 4th interpolated sample (R)
  1570 00000AC6 A1[9F0C]            <1> 	mov	ax, [new_val_l]
  1571 00000AC9 01D8                <1> 	add	ax, bx
  1572 00000ACB D1E8                <1> 	shr	ax, 1
  1573 00000ACD AB                  <1> 	stosw		; this is 5th interpolated sample (L)
  1574 00000ACE 58                  <1> 	pop	ax ; **
  1575 00000ACF 0306[A10C]          <1> 	add	ax, [new_val_r]
  1576 00000AD3 D1E8                <1> 	shr	ax, 1
  1577 00000AD5 AB                  <1> 	stosw		; this is 5th interpolated sample (R)
  1578                              <1> 	; 8 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1579 00000AD6 E303                <1> 	jcxz	lff8_s2_9
  1580 00000AD8 E96DFF              <1> 	jmp	lff8s2_1
  1581                              <1> lff8_s2_9:
  1582 00000ADB E9DCFD              <1> 	jmp	lff8s2_3
  1583                              <1> 
  1584                              <1> ; .....................
  1585                              <1> 
  1586                              <1> load_16khz_mono_8_bit:
  1587                              <1> 	; 13/11/2023
  1588                              <1> 
  1589 00000ADE F606[FA10]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1590                              <1> 					; last of the file?
  1591 00000AE3 7402                <1> 	jz	short lff16m_0		; no
  1592 00000AE5 F9                  <1> 	stc
  1593 00000AE6 C3                  <1> 	retn
  1594                              <1> 
  1595                              <1> lff16m_0:
  1596 00000AE7 8EC0                <1> 	mov	es, ax ; buffer segment	
  1597 00000AE9 31FF                <1> 	xor	di, di
  1598 00000AEB BA[2011]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1599                              <1> 	; ds = cs
  1600                              <1> 
  1601                              <1> 	; load file into memory
  1602 00000AEE 8B0E[3D06]          <1>         mov	cx, [loadsize]
  1603 00000AF2 8B1E[F810]          <1> 	mov	bx, [filehandle]
  1604 00000AF6 B43F                <1>        	mov	ah, 3Fh
  1605 00000AF8 CD21                <1> 	int	21h
  1606 00000AFA 723A                <1> 	jc	short lff16m_7 ; error !
  1607                              <1> 
  1608 00000AFC 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1609                              <1> 	
  1610 00000AFE 21C0                <1> 	and	ax, ax
  1611 00000B00 7503                <1> 	jnz	short lff16m_8
  1612 00000B02 E9B5FD              <1> 	jmp	lff16m_3
  1613                              <1> lff16m_8:
  1614 00000B05 89C1                <1> 	mov	cx, ax		; byte count
  1615                              <1> lff16m_1:
  1616 00000B07 AC                  <1> 	lodsb
  1617 00000B08 2C80                <1> 	sub	al, 80h
  1618 00000B0A C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1619                              <1> 	;mov	[previous_val], ax
  1620 00000B0D 89C3                <1> 	mov	bx, ax
  1621 00000B0F AB                  <1> 	stosw		; original sample (left channel)
  1622 00000B10 AB                  <1> 	stosw		; original sample (right channel)
  1623 00000B11 31C0                <1> 	xor	ax, ax
  1624 00000B13 49                  <1> 	dec	cx
  1625 00000B14 7405                <1> 	jz	short lff16m_2
  1626                              <1> 	;mov	al, [si]
  1627                              <1> 	;sub	al, 80h
  1628                              <1> 	;shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1629 00000B16 8A24                <1> 	mov	ah, [si]
  1630 00000B18 80EC80              <1> 	sub	ah, 80h
  1631                              <1> lff16m_2:
  1632                              <1> 	;mov	[new_val], ax
  1633 00000B1B 89C5                <1> 	mov	bp, ax
  1634                              <1> 	;add	ax, [previous_val]
  1635 00000B1D 01D8                <1> 	add	ax, bx
  1636 00000B1F D1E8                <1> 	shr	ax, 1
  1637 00000B21 89C2                <1> 	mov	dx, ax	; this is interpolated middle (temp) sample
  1638                              <1> 	;add	ax, [previous_val]
  1639 00000B23 01D8                <1> 	add	ax, bx
  1640 00000B25 D1E8                <1> 	shr	ax, 1
  1641 00000B27 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1642 00000B28 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1643                              <1> 	;mov	ax, [new_val]
  1644 00000B29 89E8                <1> 	mov	ax, bp
  1645 00000B2B 01D0                <1> 	add	ax, dx
  1646 00000B2D AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1647 00000B2E AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1648                              <1> 	
  1649                              <1> 	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1650 00000B2F 09C9                <1> 	or	cx, cx
  1651 00000B31 75D4                <1> 	jnz	short lff16m_1
  1652 00000B33 E984FD              <1> 	jmp	lff16m_3
  1653                              <1> 
  1654                              <1> lff16m_7:
  1655                              <1> lff16s_7:
  1656 00000B36 E994FD              <1> 	jmp	lff16m_5  ; error
  1657                              <1> 
  1658                              <1> load_16khz_stereo_8_bit:
  1659                              <1> 	; 13/11/2023
  1660                              <1> 
  1661 00000B39 F606[FA10]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1662                              <1> 					; last of the file?
  1663 00000B3E 7402                <1> 	jz	short lff16s_0		; no
  1664 00000B40 F9                  <1> 	stc
  1665 00000B41 C3                  <1> 	retn
  1666                              <1> 
  1667                              <1> lff16s_0:
  1668 00000B42 8EC0                <1> 	mov	es, ax ; buffer segment	
  1669 00000B44 31FF                <1> 	xor	di, di
  1670 00000B46 BA[2011]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1671                              <1> 	; ds = cs
  1672                              <1> 
  1673                              <1> 	; load file into memory
  1674 00000B49 8B0E[3D06]          <1>         mov	cx, [loadsize]
  1675 00000B4D 8B1E[F810]          <1> 	mov	bx, [filehandle]
  1676 00000B51 B43F                <1>        	mov	ah, 3Fh
  1677 00000B53 CD21                <1> 	int	21h
  1678 00000B55 72DF                <1> 	jc	short lff16s_7 ; error !
  1679                              <1> 
  1680 00000B57 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1681                              <1> 	
  1682 00000B59 D1E8                <1> 	shr	ax, 1
  1683                              <1> 	;and	ax, ax
  1684 00000B5B 7503                <1> 	jnz	short lff16s_8
  1685 00000B5D E95AFD              <1> 	jmp	lff16s_3
  1686                              <1> lff16s_8:
  1687 00000B60 89C1                <1> 	mov	cx, ax		; word count
  1688                              <1> lff16s_1:
  1689 00000B62 AC                  <1> 	lodsb
  1690 00000B63 2C80                <1> 	sub	al, 80h
  1691 00000B65 C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1692 00000B68 A3[9B0C]            <1> 	mov	[previous_val_l], ax
  1693 00000B6B AB                  <1> 	stosw		; original sample (L)
  1694 00000B6C AC                  <1> 	lodsb
  1695 00000B6D 2C80                <1> 	sub	al, 80h
  1696 00000B6F C1E008              <1> 	shl	ax, 8	; convert 8 bit sample to 16 bit sample
  1697 00000B72 A3[9D0C]            <1> 	mov	[previous_val_r], ax
  1698 00000B75 AB                  <1> 	stosw		; original sample (R)
  1699                              <1> 
  1700 00000B76 31C0                <1> 	xor	ax, ax
  1701 00000B78 31D2                <1> 	xor	dx, dx
  1702 00000B7A 49                  <1> 	dec	cx
  1703 00000B7B 740C                <1> 	jz	short lff16s_2
  1704                              <1> 		; convert 8 bit sample to 16 bit sample
  1705 00000B7D 8B04                <1> 	mov	ax, [si]
  1706                              <1> 	;sub	al, 80h
  1707                              <1> 	;sub	ah, 80h
  1708                              <1> 	;mov	dh, ah
  1709                              <1> 	;shl	ax, 8
  1710 00000B7F 86E0                <1> 	xchg	ah, al ; ah <-> al
  1711 00000B81 80EC80              <1> 	sub	ah, 80h
  1712 00000B84 86F0                <1> 	xchg	dh, al ; al -> dh, al = 0
  1713 00000B86 80EE80              <1> 	sub	dh, 80h
  1714                              <1> lff16s_2:
  1715                              <1> 	;mov	[new_val_l], ax
  1716 00000B89 89C5                <1> 	mov	bp, ax
  1717 00000B8B 8916[A10C]          <1> 	mov	[new_val_r], dx
  1718 00000B8F 0306[9B0C]          <1> 	add	ax, [previous_val_l]
  1719 00000B93 D1E8                <1> 	shr	ax, 1
  1720 00000B95 89C2                <1> 	mov	dx, ax	; this is temporary interpolation value (L)
  1721 00000B97 0306[9B0C]          <1> 	add	ax, [previous_val_l]
  1722 00000B9B D1E8                <1> 	shr	ax, 1
  1723 00000B9D AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1724 00000B9E A1[A10C]            <1> 	mov	ax, [new_val_r]
  1725 00000BA1 0306[9D0C]          <1> 	add	ax, [previous_val_r]
  1726 00000BA5 D1E8                <1> 	shr	ax, 1
  1727 00000BA7 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value (R)
  1728 00000BA9 0306[9D0C]          <1> 	add	ax, [previous_val_r]
  1729 00000BAD D1E8                <1> 	shr	ax, 1
  1730 00000BAF AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1731                              <1> 	;mov	ax, [new_val_l]
  1732 00000BB0 89E8                <1> 	mov	ax, bp
  1733 00000BB2 01D0                <1> 	add	ax, dx
  1734 00000BB4 D1E8                <1> 	shr	ax, 1
  1735 00000BB6 AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1736 00000BB7 A1[A10C]            <1> 	mov	ax, [new_val_r]
  1737 00000BBA 01D8                <1> 	add	ax, bx
  1738 00000BBC D1E8                <1> 	shr	ax, 1
  1739 00000BBE AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1740                              <1> 	
  1741                              <1> 	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1742 00000BBF 09C9                <1> 	or	cx, cx
  1743 00000BC1 759F                <1> 	jnz	short lff16s_1
  1744 00000BC3 E9F4FC              <1> 	jmp	lff16s_3
  1745                              <1> 
  1746                              <1> load_16khz_mono_16_bit:
  1747                              <1> 	; 13/11/2023
  1748                              <1> 
  1749 00000BC6 F606[FA10]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1750                              <1> 					; last of the file?
  1751 00000BCB 7402                <1> 	jz	short lff16m2_0		; no
  1752 00000BCD F9                  <1> 	stc
  1753 00000BCE C3                  <1> 	retn
  1754                              <1> 
  1755                              <1> lff16m2_0:
  1756 00000BCF 8EC0                <1> 	mov	es, ax ; buffer segment	
  1757 00000BD1 31FF                <1> 	xor	di, di
  1758 00000BD3 BA[2011]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1759                              <1> 	; ds = cs
  1760                              <1> 
  1761                              <1> 	; load file into memory
  1762 00000BD6 8B0E[3D06]          <1>         mov	cx, [loadsize]
  1763 00000BDA 8B1E[F810]          <1> 	mov	bx, [filehandle]
  1764 00000BDE B43F                <1>        	mov	ah, 3Fh
  1765 00000BE0 CD21                <1> 	int	21h
  1766 00000BE2 7234                <1> 	jc	short lff16m2_7 ; error !
  1767                              <1> 
  1768 00000BE4 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1769                              <1> 	
  1770 00000BE6 D1E8                <1> 	shr	ax, 1
  1771                              <1> 	;and	ax, ax
  1772 00000BE8 7503                <1> 	jnz	short lff16m2_8
  1773 00000BEA E9CDFC              <1> 	jmp	lff16m2_3
  1774                              <1> lff16m2_8:
  1775 00000BED 89C1                <1> 	mov	cx, ax		; word count
  1776                              <1> lff16m2_1:
  1777 00000BEF AD                  <1> 	lodsw
  1778                              <1> 	;mov	[previous_val], ax
  1779 00000BF0 89C3                <1> 	mov	bx, ax
  1780 00000BF2 AB                  <1> 	stosw		; original sample (left channel)
  1781 00000BF3 AB                  <1> 	stosw		; original sample (right channel)
  1782 00000BF4 31C0                <1> 	xor	ax, ax
  1783 00000BF6 49                  <1> 	dec	cx
  1784 00000BF7 7402                <1> 	jz	short lff16m2_2
  1785 00000BF9 8B04                <1> 	mov	ax, [si]
  1786                              <1> lff16m2_2:
  1787 00000BFB 89C5                <1> 	mov	bp, ax	; [new_val]
  1788                              <1> 	;add	ax, [previous_val]
  1789 00000BFD 01D8                <1> 	add	ax, bx
  1790 00000BFF D1E8                <1> 	shr	ax, 1
  1791 00000C01 89C2                <1> 	mov	dx, ax	; this is temporary interpolation value
  1792                              <1> 	;add	ax, [previous_val]
  1793 00000C03 01D8                <1> 	add	ax, bx
  1794 00000C05 D1E8                <1> 	shr	ax, 1
  1795 00000C07 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1796 00000C08 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1797 00000C09 89E8                <1> 	mov	ax, bp 
  1798 00000C0B 01D0                <1> 	add	ax, dx
  1799 00000C0D D1E8                <1> 	shr	ax, 1
  1800 00000C0F AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1801 00000C10 AB                  <1> 	stosw		; this is 2nd interpolated sample (R)
  1802                              <1> 	; 16 kHZ mono to 48 kHZ stereo conversion of the sample is OK
  1803 00000C11 09C9                <1> 	or	cx, cx
  1804 00000C13 75DA                <1> 	jnz	short lff16m2_1
  1805 00000C15 E9A2FC              <1> 	jmp	lff16m2_3
  1806                              <1> 
  1807                              <1> lff16m2_7:
  1808                              <1> lff16s2_7:
  1809 00000C18 E9B2FC              <1> 	jmp	lff16m2_5  ; error
  1810                              <1> 
  1811                              <1> load_16khz_stereo_16_bit:
  1812                              <1> 	; 13/11/2023
  1813                              <1> 
  1814 00000C1B F606[FA10]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
  1815                              <1> 					; last of the file?
  1816 00000C20 7402                <1> 	jz	short lff16s2_0		; no
  1817 00000C22 F9                  <1> 	stc
  1818 00000C23 C3                  <1> 	retn
  1819                              <1> 
  1820                              <1> lff16s2_0:
  1821 00000C24 8EC0                <1> 	mov	es, ax ; buffer segment	
  1822 00000C26 31FF                <1> 	xor	di, di
  1823 00000C28 BA[2011]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
  1824                              <1> 	; ds = cs
  1825                              <1> 
  1826                              <1> 	; load file into memory
  1827 00000C2B 8B0E[3D06]          <1>         mov	cx, [loadsize]
  1828 00000C2F 8B1E[F810]          <1> 	mov	bx, [filehandle]
  1829 00000C33 B43F                <1>        	mov	ah, 3Fh
  1830 00000C35 CD21                <1> 	int	21h
  1831 00000C37 72DF                <1> 	jc	short lff16s2_7 ; error !
  1832                              <1> 
  1833 00000C39 89D6                <1> 	mov	si, dx ; temp_buffer ; temporary buffer address
  1834                              <1> 	
  1835 00000C3B D1E8                <1> 	shr	ax, 1
  1836                              <1> 	;and	ax, ax
  1837 00000C3D 7503                <1> 	jnz	short lff16s2_8
  1838 00000C3F E978FC              <1> 	jmp	lff16s2_3
  1839                              <1> lff16s2_8:
  1840 00000C42 89C1                <1> 	mov	cx, ax		; word count
  1841                              <1> lff16s2_1:
  1842 00000C44 AD                  <1> 	lodsw
  1843 00000C45 A3[9B0C]            <1> 	mov	[previous_val_l], ax
  1844 00000C48 AB                  <1> 	stosw		; original sample (L)
  1845 00000C49 AD                  <1> 	lodsw
  1846 00000C4A A3[9D0C]            <1> 	mov	[previous_val_r], ax
  1847 00000C4D AB                  <1> 	stosw		; original sample (R)
  1848 00000C4E 31D2                <1> 	xor	dx, dx
  1849 00000C50 31C0                <1> 	xor	ax, ax
  1850 00000C52 49                  <1> 	dec	cx	; 16 bit
  1851 00000C53 7408                <1> 	jz	short lff16s2_2
  1852 00000C55 49                  <1> 	dec	cx	; stereo
  1853 00000C56 7405                <1> 	jz	short lff16s2_2
  1854 00000C58 8B04                <1> 	mov	ax, [si]
  1855 00000C5A 8B5402              <1> 	mov	dx, [si+2]
  1856                              <1> lff16s2_2:
  1857                              <1> 	;mov	[new_val_l], ax
  1858 00000C5D 89C5                <1> 	mov	bp, ax
  1859 00000C5F 8916[A10C]          <1> 	mov	[new_val_r], dx
  1860 00000C63 0306[9B0C]          <1> 	add	ax, [previous_val_l]
  1861 00000C67 D1E8                <1> 	shr	ax, 1
  1862 00000C69 89C2                <1> 	mov	dx, ax	; this is temporary interpolation value (L)
  1863 00000C6B 0306[9B0C]          <1> 	add	ax, [previous_val_l]
  1864 00000C6F D1E8                <1> 	shr	ax, 1
  1865 00000C71 AB                  <1> 	stosw		; this is 1st interpolated sample (L)
  1866 00000C72 A1[A10C]            <1> 	mov	ax, [new_val_r]
  1867 00000C75 0306[9D0C]          <1> 	add	ax, [previous_val_r]
  1868 00000C79 D1E8                <1> 	shr	ax, 1
  1869 00000C7B 89C3                <1> 	mov	bx, ax	; this is temporary interpolation value (R)
  1870 00000C7D 0306[9D0C]          <1> 	add	ax, [previous_val_r]
  1871 00000C81 D1E8                <1> 	shr	ax, 1
  1872 00000C83 AB                  <1> 	stosw		; this is 1st interpolated sample (R)
  1873                              <1> 	;mov	ax, [new_val_l]
  1874 00000C84 89E8                <1> 	mov	ax, bp
  1875 00000C86 01D0                <1> 	add	ax, dx
  1876 00000C88 D1E8                <1> 	shr	ax, 1
  1877 00000C8A AB                  <1> 	stosw		; this is 2nd interpolated sample (L)
  1878 00000C8B A1[A10C]            <1> 	mov	ax, [new_val_r]
  1879 00000C8E 01D8                <1> 	add	ax, bx
  1880 00000C90 D1E8                <1> 	shr	ax, 1
  1881 00000C92 AB                  <1> 	stosw 		; this is 2nd interpolated sample (R)
  1882                              <1> 	
  1883                              <1> 	; 16 kHZ stereo to 48 kHZ stereo conversion of the sample is OK
  1884 00000C93 09C9                <1> 	or	cx, cx
  1885 00000C95 75AD                <1> 	jnz	short lff16s2_1
  1886 00000C97 E920FC              <1> 	jmp	lff16s2_3
  1887                              <1> 
  1888                              <1> ; .....................
  1889                              <1> 
  1890                              <1> ; 13/11/2023 (temporary)
  1891                              <1> load_22khz_stereo_16_bit:
  1892                              <1> load_22khz_mono_16_bit:
  1893                              <1> load_22khz_stereo_8_bit:
  1894                              <1> load_22khz_mono_8_bit:
  1895                              <1> load_11khz_stereo_16_bit:
  1896                              <1> load_11khz_mono_16_bit:
  1897                              <1> load_11khz_stereo_8_bit:
  1898                              <1> load_11khz_mono_8_bit:
  1899                              <1> load_44khz_stereo_16_bit:
  1900                              <1> load_44khz_mono_16_bit:
  1901                              <1> load_44khz_stereo_8_bit:
  1902                              <1> load_44khz_mono_8_bit:
  1903                              <1> load_24khz_stereo_16_bit:
  1904                              <1> load_24khz_mono_16_bit:
  1905                              <1> load_24khz_stereo_8_bit:
  1906                              <1> load_24khz_mono_8_bit:
  1907                              <1> load_32khz_stereo_16_bit:
  1908                              <1> load_32khz_mono_16_bit:
  1909                              <1> load_32khz_stereo_8_bit:
  1910                              <1> load_32khz_mono_8_bit:
  1911 00000C9A C3                  <1> 	retn
  1912                              <1> 
  1913                              <1> 
  1914                              <1> ; 13/11/2023
  1915                              <1> previous_val:
  1916 00000C9B 0000                <1> previous_val_l: dw 0
  1917 00000C9D 0000                <1> previous_val_r: dw 0
  1918                              <1> new_val:
  1919 00000C9F 0000                <1> new_val_l: dw 0
  1920 00000CA1 0000                <1> new_val_r: dw 0	
  1921                              <1> 	
  1922                              <1> ; --------------------------------------------------------	
  1923                              <1> 		
   451                                  
   452                                  ; UTILS.ASM
   453                                  ;----------------------------------------------------------------------------
   454                                  ;       delay1_4ms - Delay for 1/4 millisecond.
   455                                  ;		    1mS = 1000us
   456                                  ;       Entry:
   457                                  ;         None
   458                                  ;       Exit:
   459                                  ;	  None
   460                                  ;
   461                                  ;       Modified:
   462                                  ;         None
   463                                  ;
   464                                  PORTB			EQU	061h
   465                                    REFRESH_STATUS	EQU	010h		; Refresh signal status
   466                                  
   467                                  delay1_4ms:
   468 00000CA3 50                              push    ax 
   469 00000CA4 51                              push    cx
   470 00000CA5 B91000                          mov     cx, 16			; close enough.
   471 00000CA8 E461                    	in	al,PORTB
   472 00000CAA 2410                    	and	al,REFRESH_STATUS
   473 00000CAC 88C4                    	mov	ah,al			; Start toggle state
   474 00000CAE 09C9                    	or	cx, cx
   475 00000CB0 7401                    	jz	short _d4ms1
   476 00000CB2 41                      	inc	cx			; Throwaway first toggle
   477                                  _d4ms1:	
   478 00000CB3 E461                    	in	al,PORTB		; Read system control port
   479 00000CB5 2410                    	and	al,REFRESH_STATUS	; Refresh toggles 15.085 microseconds
   480 00000CB7 38C4                    	cmp	ah,al
   481 00000CB9 74F8                    	je	short _d4ms1		; Wait for state change
   482                                  
   483 00000CBB 88C4                    	mov	ah,al			; Update with new state
   484 00000CBD 49                      	dec	cx
   485 00000CBE 75F3                    	jnz	short _d4ms1
   486                                  
   487 00000CC0 59                              pop     cx
   488 00000CC1 58                              pop     ax
   489 00000CC2 C3                              retn
   490                                  
   491                                  	; 13/11/2016 - Erdogan Tan
   492                                  write_ac97_dev_info:
   493                                  	; BUS/DEV/FN
   494                                  	;	00000000BBBBBBBBDDDDDFFF00000000
   495                                  	; DEV/VENDOR
   496                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
   497                                  
   498 00000CC3 30FF                    	xor	bh, bh
   499 00000CC5 668B36[1211]            	mov	esi, [dev_vendor]
   500 00000CCA 89F0                    	mov	ax, si
   501 00000CCC 88C3                    	mov	bl, al
   502 00000CCE 88DA                    	mov	dl, bl
   503 00000CD0 80E30F                  	and	bl, 0Fh
   504 00000CD3 8A87[8B0F]              	mov	al, [bx+hex_chars]
   505 00000CD7 A2[CE0F]                	mov	[msgVendorId+3], al
   506 00000CDA 88D3                    	mov	bl, dl
   507 00000CDC C0EB04                  	shr	bl, 4
   508 00000CDF 8A87[8B0F]              	mov	al, [bx+hex_chars]
   509 00000CE3 A2[CD0F]                	mov	[msgVendorId+2], al
   510 00000CE6 88E3                    	mov	bl, ah
   511 00000CE8 88DA                    	mov	dl, bl
   512 00000CEA 80E30F                  	and	bl, 0Fh
   513 00000CED 8A87[8B0F]              	mov	al, [bx+hex_chars]
   514 00000CF1 A2[CC0F]                	mov	[msgVendorId+1], al
   515 00000CF4 88D3                    	mov	bl, dl
   516 00000CF6 C0EB04                  	shr	bl, 4
   517 00000CF9 8A87[8B0F]              	mov	al, [bx+hex_chars]
   518 00000CFD A2[CB0F]                	mov	[msgVendorId], al
   519 00000D00 66C1EE10                	shr	esi, 16
   520 00000D04 89F0                    	mov	ax, si
   521 00000D06 88C3                    	mov	bl, al
   522 00000D08 88DA                    	mov	dl, bl
   523 00000D0A 80E30F                  	and	bl, 0Fh
   524 00000D0D 8A87[8B0F]              	mov	al, [bx+hex_chars]
   525 00000D11 A2[DF0F]                	mov	[msgDevId+3], al
   526 00000D14 88D3                    	mov	bl, dl
   527 00000D16 C0EB04                  	shr	bl, 4
   528 00000D19 8A87[8B0F]              	mov	al, [bx+hex_chars]
   529 00000D1D A2[DE0F]                	mov	[msgDevId+2], al
   530 00000D20 88E3                    	mov	bl, ah
   531 00000D22 88DA                    	mov	dl, bl
   532 00000D24 80E30F                  	and	bl, 0Fh
   533 00000D27 8A87[8B0F]              	mov	al, [bx+hex_chars]
   534 00000D2B A2[DD0F]                	mov	[msgDevId+1], al
   535 00000D2E 88D3                    	mov	bl, dl
   536 00000D30 C0EB04                  	shr	bl, 4
   537 00000D33 8A87[8B0F]              	mov	al, [bx+hex_chars]
   538 00000D37 A2[DC0F]                	mov	[msgDevId], al
   539                                  
   540 00000D3A 668B36[0E11]            	mov	esi, [bus_dev_fn]
   541 00000D3F 66C1EE08                	shr	esi, 8
   542 00000D43 89F0                    	mov	ax, si
   543 00000D45 88C3                    	mov	bl, al
   544 00000D47 88DA                    	mov	dl, bl
   545 00000D49 80E307                  	and	bl, 7 ; bit 0,1,2
   546 00000D4C 8A87[8B0F]              	mov	al, [bx+hex_chars]
   547 00000D50 A2[0310]                	mov	[msgFncNo+1], al
   548 00000D53 88D3                    	mov	bl, dl
   549 00000D55 C0EB03                  	shr	bl, 3
   550 00000D58 88DA                    	mov	dl, bl
   551 00000D5A 80E30F                  	and	bl, 0Fh
   552 00000D5D 8A87[8B0F]              	mov	al, [bx+hex_chars]
   553 00000D61 A2[F50F]                	mov	[msgDevNo+1], al
   554 00000D64 88D3                    	mov	bl, dl
   555 00000D66 C0EB04                  	shr	bl, 4
   556 00000D69 8A87[8B0F]              	mov	al, [bx+hex_chars]
   557 00000D6D A2[F40F]                	mov	[msgDevNo], al
   558 00000D70 88E3                    	mov	bl, ah
   559 00000D72 88DA                    	mov	dl, bl
   560 00000D74 80E30F                  	and	bl, 0Fh
   561 00000D77 8A87[8B0F]              	mov	al, [bx+hex_chars]
   562 00000D7B A2[E90F]                	mov	[msgBusNo+1], al
   563 00000D7E 88D3                    	mov	bl, dl
   564 00000D80 C0EB04                  	shr	bl, 4
   565 00000D83 8A87[8B0F]              	mov	al, [bx+hex_chars]
   566 00000D87 A2[E80F]                	mov	[msgBusNo], al
   567                                  
   568 00000D8A A1[0411]                	mov	ax, [NAMBAR]
   569 00000D8D 88C3                    	mov	bl, al
   570 00000D8F 88DA                    	mov	dl, bl
   571 00000D91 80E30F                  	and	bl, 0Fh
   572 00000D94 8A87[8B0F]              	mov	al, [bx+hex_chars]
   573 00000D98 A2[1210]                	mov	[msgNamBar+3], al
   574 00000D9B 88D3                    	mov	bl, dl
   575 00000D9D C0EB04                  	shr	bl, 4
   576 00000DA0 8A87[8B0F]              	mov	al, [bx+hex_chars]
   577 00000DA4 A2[1110]                	mov	[msgNamBar+2], al
   578 00000DA7 88E3                    	mov	bl, ah
   579 00000DA9 88DA                    	mov	dl, bl
   580 00000DAB 80E30F                  	and	bl, 0Fh
   581 00000DAE 8A87[8B0F]              	mov	al, [bx+hex_chars]
   582 00000DB2 A2[1010]                	mov	[msgNamBar+1], al
   583 00000DB5 88D3                    	mov	bl, dl
   584 00000DB7 C0EB04                  	shr	bl, 4
   585 00000DBA 8A87[8B0F]              	mov	al, [bx+hex_chars]
   586 00000DBE A2[0F10]                	mov	[msgNamBar], al
   587                                  
   588                                  	; 05/11/2023
   589 00000DC1 A1[0611]                	mov	ax, [NABMBAR]
   590 00000DC4 88C3                    	mov	bl, al
   591 00000DC6 88DA                    	mov	dl, bl
   592 00000DC8 80E30F                  	and	bl, 0Fh
   593 00000DCB 678A83[8B0F0000]        	mov	al, [ebx+hex_chars]
   594 00000DD2 A2[2110]                	mov	[msgNabmBar+3], al
   595 00000DD5 88D3                    	mov	bl, dl
   596 00000DD7 C0EB04                  	shr	bl, 4
   597 00000DDA 678A83[8B0F0000]        	mov	al, [ebx+hex_chars]
   598 00000DE1 A2[2010]                	mov	[msgNabmBar+2], al
   599 00000DE4 88E3                    	mov	bl, ah
   600 00000DE6 88DA                    	mov	dl, bl
   601 00000DE8 80E30F                  	and	bl, 0Fh
   602 00000DEB 678A83[8B0F0000]        	mov	al, [ebx+hex_chars]
   603 00000DF2 A2[1F10]                	mov	[msgNabmBar+1], al
   604 00000DF5 88D3                    	mov	bl, dl
   605 00000DF7 C0EB04                  	shr	bl, 4
   606 00000DFA 678A83[8B0F0000]        	mov	al, [ebx+hex_chars]
   607 00000E01 A2[1E10]                	mov	[msgNabmBar], al
   608                                  
   609                                  	; 24/11/2016
   610 00000E04 30E4                    	xor	ah, ah
   611 00000E06 A0[FB10]                	mov	al, [ac97_int_ln_reg]
   612 00000E09 B10A                    	mov	cl, 10
   613 00000E0B F6F1                    	div	cl
   614 00000E0D 0106[2910]              	add	[msgIRQ], ax
   615 00000E11 20C0                    	and	al, al
   616 00000E13 7508                    	jnz	short _pmi
   617 00000E15 A0[2A10]                	mov	al, [msgIRQ+1]
   618 00000E18 B420                    	mov	ah, ' '
   619 00000E1A A3[2910]                	mov	[msgIRQ], ax
   620                                  _pmi:
   621 00000E1D BA[9C0F]                        mov	dx, msgAC97Info
   622 00000E20 B409                            mov     ah, 9
   623 00000E22 CD21                            int     21h
   624 00000E24 C3                              retn
   625                                  
   626                                  write_sample_rate:
   627                                  	; ax = sample rate (hertz)
   628                                  
   629 00000E25 31D2                    	xor	dx, dx
   630 00000E27 B90A00                  	mov	cx, 10
   631 00000E2A F7F1                    	div	cx
   632 00000E2C 0016[3F10]              	add	[msgHertz+4], dl
   633 00000E30 29D2                    	sub	dx, dx
   634 00000E32 F7F1                    	div	cx
   635 00000E34 0016[3E10]              	add	[msgHertz+3], dl
   636 00000E38 29D2                    	sub	dx, dx
   637 00000E3A F7F1                    	div	cx
   638 00000E3C 0016[3D10]              	add	[msgHertz+2], dl
   639 00000E40 29D2                    	sub	dx, dx
   640 00000E42 F7F1                    	div	cx
   641 00000E44 0016[3C10]              	add	[msgHertz+1], dl
   642 00000E48 0006[3B10]              	add	[msgHertz], al
   643                                  	
   644 00000E4C BA[2E10]                        mov     dx, msgSampleRate
   645 00000E4F B409                            mov     ah, 9
   646 00000E51 CD21                            int     21h
   647                                  
   648                                  	; 19/11/2016
   649 00000E53 BA[5410]                	mov	dx, msg16Bits
   650 00000E56 803E[1A11]10            	cmp	byte [bps], 16
   651 00000E5B 7403                    	je	short wsr_1
   652 00000E5D BA[4510]                	mov	dx, msg8Bits
   653                                  wsr_1:
   654 00000E60 B409                            mov     ah, 9
   655 00000E62 CD21                            int     21h
   656                                  
   657 00000E64 BA[4D10]                	mov	dx, msgMono
   658 00000E67 803E[1811]01            	cmp	byte [stmo], 1
   659 00000E6C 7403                    	je	short wsr_2
   660 00000E6E BA[5D10]                	mov	dx, msgStereo		
   661                                  wsr_2:
   662 00000E71 B409                            mov     ah, 9
   663 00000E73 CD21                            int     21h
   664                                  
   665 00000E75 C3                              retn
   666                                  
   667                                  ;detect_codec:
   668                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   669                                  ;	mov	eax, 7Ch
   670                                  ;	call	codec_read
   671                                  ;       shl     eax, 16
   672                                  ;       mov     [codec_id], eax
   673                                  ;
   674                                  ;	mov	eax, 7Eh
   675                                  ;       call	codec_read
   676                                  ;       or      eax, [codec_id]
   677                                  ;       mov     [codec_chip_id], eax
   678                                  ;       and     eax, 0FFFFFF00h
   679                                  ;
   680                                  ;       mov     edi, codecs
   681                                  ;_dcb:
   682                                  ;       mov     ebx, [di]
   683                                  ;       test    ebx, ebx
   684                                  ;       jz      short _dco_unknown
   685                                  ;
   686                                  ;       cmp     eax, ebx
   687                                  ;       jne     short _dco_next
   688                                  ;       mov     ax, [di+4]
   689                                  ;       mov     [codec_vendor_ids], ax
   690                                  ;       movzx   esi, ax
   691                                  ;       call	print_msg
   692                                  ;       
   693                                  ;	mov	ax, [di+6]
   694                                  ;	call	detect_chip
   695                                  ;       retn
   696                                  ;
   697                                  ;_dco_next:
   698                                  ;       add     di, 8
   699                                  ;       jmp     short _dcb
   700                                  ;
   701                                  ;_dco_unknown:
   702                                  ;       mov    word [codec_vendor_ids], ac_unknown
   703                                  ;       mov    word [codec_chip_ids], chip_unknown
   704                                  ;       mov     esi, chip_unknown
   705                                  ;	call	print_msg
   706                                  ;       mov     eax, [codec_chip_id]
   707                                  ;       call    dword2str
   708                                  ;       call	print_msg
   709                                  ;       retn
   710                                  
   711                                  ;detect_chip:
   712                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   713                                  ;	mov	di, ax ; chip_tab
   714                                  ;       mov     eax, [codec_chip_id]
   715                                  ;       and     ax, 0FFh
   716                                  ;_dch1:
   717                                  ;       mov     bx, [di]
   718                                  ;       cmp     bx, 0FFh
   719                                  ;       je      short _dch_unknown
   720                                  ;
   721                                  ;       cmp     ax, bx
   722                                  ;       jne     short _dch_next
   723                                  ;       mov     ax, [di+2]
   724                                  ;       mov     [codec_chip_ids], ax
   725                                  ;       mov     si, ax
   726                                  ;       call	print_msg
   727                                  ;       retn
   728                                  
   729                                  ;_dch_next:
   730                                  ;       add     di, 4
   731                                  ;       jmp     short _dch1
   732                                  ;
   733                                  ;_dch_unknown:
   734                                  ;       mov    word [codec_chip_ids], chip_unknown
   735                                  ;       mov     si, chip_unknown
   736                                  ;       call	print_msg
   737                                  ;       mov     eax, [codec_chip_id]
   738                                  ;       call    dword2str
   739                                  ;       call	print_msg
   740                                  ;       retn
   741                                  
   742                                  ; 10/11/2023
   743                                  ; 09/11/2023
   744                                  ; 06/11/2023
   745                                  %if 1
   746                                  
   747                                  ac97_int_handler:
   748                                  	; 11/11/2023
   749                                  	; 10/11/2023
   750                                  	; 17/02/2016
   751 00000E76 6650                    	push	eax	; 11/11/2023
   752 00000E78 52                      	push	dx
   753                                  	; 05/11/2023	
   754                                  	;push	cx
   755                                  	;push	bx
   756                                  	;push	si
   757                                  	;push	di
   758                                  
   759                                  	; 10/11/2023
   760                                  	; EOI at first
   761 00000E79 B020                    	mov	al, 20h
   762 00000E7B F606[FB10]08            	test	byte [ac97_int_ln_reg], 8
   763 00000E80 7402                    	jz	short _ih_0
   764 00000E82 E6A0                    	out 	0A0h, al ; 20h	; EOI
   765                                  _ih_0:
   766 00000E84 E620                    	out	20h, al  ; 20h	; EOI
   767                                  
   768                                  	; 11/11/2023
   769                                  	; 09/11/2023
   770 00000E86 BA3000                  	mov	dx, GLOB_STS_REG
   771 00000E89 0316[0611]                      add	dx, [NABMBAR]
   772 00000E8D 66ED                    	in	eax, dx
   773                                  	
   774                                  	; 09/11/2023,
   775 00000E8F 6683F8FF                        cmp	eax, 0FFFFFFFFh ; -1
   776 00000E93 741D                    	je	short _ih_2
   777                                  	
   778 00000E95 A840                    	test	al, 40h		; PCM Out Interrupt
   779 00000E97 7509                    	jnz	short _ih_1
   780                                  
   781 00000E99 6685C0                  	test	eax, eax
   782 00000E9C 7414                    	jz	short _ih_2
   783                                  
   784                                   	;mov	dx, GLOB_STS_REG
   785                                          ;add	dx, [NABMBAR]
   786 00000E9E 66EF                    	out	dx, eax
   787 00000EA0 EB10                    	jmp	short _ih_2
   788                                  
   789                                  	; .....
   790                                  	;mov	al, 1
   791                                  	; 10/11/2023
   792                                  	;mov	[tloop], al  ; 1
   793                                  
   794                                  	;cmp	[inside], al ; 1
   795                                  	;jnb	short _ih_3	; busy
   796                                  
   797                                  	;mov	[inside], al ; 1
   798                                  	;
   799                                  	;; 09/11/2023
   800                                          ;mov	dx, [NABMBAR]
   801                                          ;add	dx, PO_SR_REG	; set pointer to Status reg
   802                                  	;in	al, dx
   803                                  	;; 10/11/2023
   804                                  	;;;out	dx, eax
   805                                  	;;out	dx, al		; clear interrupt event
   806                                  	;			; (by writing 1 to same bits)
   807                                  	;
   808                                  	;;mov	[pcm_irq_status], al ; 05/11/2023
   809                                  	;test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
   810                                  	;jz	short _ih_2
   811                                  	; .....
   812                                  
   813                                  _ih_1:
   814                                  	; 11/11/2023
   815 00000EA2 6650                    	push	eax
   816                                  
   817                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   818                                  	;mov	dx, PO_SR_REG
   819                                          ;add	dx, [NABMBAR]
   820                                  	;out	dx, ax
   821                                  
   822                                  	; 10/11/2023
   823                                  	; 28/11/2016 - Erdogan Tan
   824 00000EA4 E871F8                  	call	tuneLoop
   825                                  
   826                                  	; 11/11/2023
   827 00000EA7 6658                    	pop	eax
   828 00000EA9 BA3000                  	mov	dx, GLOB_STS_REG
   829 00000EAC 0316[0611]                      add	dx, [NABMBAR]
   830 00000EB0 66EF                    	out	dx, eax
   831                                  _ih_2:
   832                                  	; 11/11/2023
   833 00000EB2 8B16[0611]              	mov	dx, [NABMBAR]
   834 00000EB6 83C216                  	add	dx, PO_SR_REG	; set pointer to Status reg
   835 00000EB9 B81C00                  	mov	ax, 1Ch
   836 00000EBC EF                      	out	dx, ax
   837                                  
   838                                  ;	; 10/11/2023
   839                                  ;	mov	al, 20h
   840                                  ;	test	byte [ac97_int_ln_reg], 8
   841                                  ;	jz	short _ih_3
   842                                  ;	out 	0A0h, al ; 20h	; EOI
   843                                  ;_ih_3:
   844                                  ;	out	20h, al  ; 20h	; EOI
   845                                  ;_ih_4:
   846                                  	;mov	byte [inside], 0
   847                                  	;pop	di
   848                                  	;pop	si
   849                                  	;pop	bx
   850                                  	;pop	cx
   851 00000EBD 5A                      	pop	dx
   852 00000EBE 6658                    	pop	eax ; 11/11/2023
   853 00000EC0 CF                      	iret
   854                                  
   855                                  %endif
   856                                  
   857                                  ; 10/11/2023
   858                                  ; 09/11/2023
   859                                  ; 06/11/2023
   860                                  %if 0
   861                                  
   862                                  ac97_int_handler:
   863                                  	; 10/11/2023
   864                                  	; 17/02/2016
   865                                  	push	ax	; 09/11/2023
   866                                  	push	dx
   867                                  	; 05/11/2023
   868                                  	;push	cx
   869                                  	;push	bx
   870                                  	;push	si
   871                                  	;push	di
   872                                  
   873                                  	; 10/11/2023
   874                                  	; EOI at first
   875                                  	mov	al, 20h
   876                                  	test	byte [ac97_int_ln_reg], 8
   877                                  	jz	short _ih_0
   878                                  	out 	0A0h, al ; 20h	; EOI
   879                                  _ih_0:
   880                                  	out	20h, al  ; 20h	; EOI
   881                                  
   882                                  	mov	al, 1
   883                                  
   884                                  	; 10/11/2023
   885                                  	;mov	[tloop], al  ; 1
   886                                  
   887                                  	cmp	[inside], al ; 1
   888                                  	jnb	short _ih_3	; busy
   889                                  
   890                                  	mov	[inside], al ; 1
   891                                  
   892                                  	; 09/11/2023
   893                                          mov	dx, [NABMBAR]
   894                                          add	dx, PO_SR_REG	; set pointer to Status reg
   895                                  	in	al, dx
   896                                  	; 10/11/2023
   897                                  	;out	dx, eax
   898                                  	out	dx, al		; clear interrupt event
   899                                  				; (by writing 1 to same bits)
   900                                  
   901                                  	;mov	[pcm_irq_status], al ; 05/11/2023
   902                                  	test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
   903                                  	jz	short _ih_2
   904                                  	
   905                                  	; 09/11/2023
   906                                  	;mov	dx, GLOB_STS_REG
   907                                          ;add	dx, [NABMBAR]
   908                                  	;in	eax, dx
   909                                  	
   910                                  	; 09/11/2023,
   911                                          ;cmp	eax, 0FFFFFFFFh ; -1
   912                                  	;je	short _ih_2
   913                                  	
   914                                  	;test	al, 40h		; PCM Out Interrupt
   915                                  	;jz	short _ih_2
   916                                  _ih_1:
   917                                  	; 10/11/2023
   918                                  	; 28/11/2016 - Erdogan Tan
   919                                  	call	tuneLoop
   920                                  	;jnc	short _ih_2
   921                                  	;dec	byte [tloop] ; [tloop] = 0
   922                                  _ih_2:
   923                                  	mov	byte [inside], 0
   924                                  _ih_3:
   925                                  	;pop	di
   926                                  	;pop	si
   927                                  	;pop	bx
   928                                  	;pop	cx
   929                                  	pop	dx
   930                                  	pop	ax ; 09/11/2023
   931                                  	iret
   932                                  
   933                                  %endif
   934                                  
   935                                  
   936                                  ac97_stop:
   937                                  	; 11/11/2023
   938                                  	; 09/11/2023
   939                                  	; 05/11/2023
   940                                  	; 04/11/2023 
   941                                  	; 28/05/2017 (TRDOS 386 v2, 'audio.s')
   942                                  	;mov	byte [tLoop], 0 ; stop ! ; 05/11/2023
   943                                  ;_ac97_stop:
   944                                  
   945                                  	; 11/11/2023
   946 00000EC1 8B16[0411]              	mov	dx, [NAMBAR]
   947                                  	;add	dx, 0 ; ac_reg_0 ; reset register
   948 00000EC5 EF                      	out	dx, ax
   949                                  
   950                                  	; 04/11/2023
   951                                  	; 09/10/2017 (TRDOS 386 v2, 'audio.s')
   952                                  	; 11/06/2017
   953 00000EC6 30C0                    	xor	al, al ; 0
   954 00000EC8 E80D00                  	call	ac97_po_cmd
   955                                  
   956                                  	; (Ref: KolibriOS, intelac97.asm, 'stop:')
   957                                  	; Clear FIFOE, BCIS, LVBCI (Ref: Intel ICH hub manual)
   958 00000ECB B81C00                  	mov     ax, 1Ch
   959 00000ECE 8B16[0611]              	mov     dx, [NABMBAR]
   960 00000ED2 83C216                  	add     dx, PO_SR_REG
   961 00000ED5 EF                      	out     dx, ax
   962                                  
   963                                  	; 11/06/2017
   964 00000ED6 B002                    	mov     al, RR
   965                                  ac97_po_cmd:
   966                                  	; 11/06/2017
   967                                  	; 29/05/2017
   968 00000ED8 8B16[0611]              	mov     dx, [NABMBAR]
   969 00000EDC 83C21B                          add     dx, PO_CR_REG		; PCM out control register
   970 00000EDF EE                      	out	dx, al
   971 00000EE0 C3                      	retn
   972                                  
   973                                  print_msg:
   974                                  	; 13/11/2016 - Erdogan Tan 
   975                                  	; esi = ASCIIZ text address
   976                                  	;
   977 00000EE1 BB0700                  	mov	bx, 7h
   978 00000EE4 B40E                    	mov	ah, 0Eh 
   979                                  pm_next_char:
   980 00000EE6 AC                      	lodsb
   981 00000EE7 20C0                    	and	al, al
   982 00000EE9 7404                    	jz	short pm_retn
   983 00000EEB CD10                    	int	10h
   984 00000EED EBF7                    	jmp	short pm_next_char
   985                                  pm_retn:
   986 00000EEF C3                      	retn
   987                                  
   988                                  ; 06/11/2023
   989                                  ;dword2str:
   990                                  ;	; 13/11/2016 - Erdogan Tan 
   991                                  ;	; eax = dword value
   992                                  ;	;
   993                                  ;	call	dwordtohex
   994                                  ;	mov	[dword_str], edx
   995                                  ;	mov	[dword_str+4], eax
   996                                  ;	mov	si, dword_str
   997                                  ;	retn
   998                                  
   999                                  	; trdos386.s (unix386.s) - 10/05/2015
  1000                                  	; Convert binary number to hexadecimal string
  1001                                  
  1002                                  bytetohex:
  1003                                  	; INPUT ->
  1004                                  	; 	AL = byte (binary number)
  1005                                  	; OUTPUT ->
  1006                                  	;	AX = hexadecimal string
  1007                                  	;
  1008 00000EF0 53                      	push	bx
  1009 00000EF1 30FF                    	xor	bh, bh
  1010 00000EF3 88C3                    	mov	bl, al
  1011 00000EF5 C0EB04                  	shr	bl, 4
  1012 00000EF8 8A9F[8B0F]              	mov	bl, [bx+hex_chars] 	 	
  1013 00000EFC 86D8                    	xchg	bl, al
  1014 00000EFE 80E30F                  	and	bl, 0Fh
  1015 00000F01 8AA7[8B0F]              	mov	ah, [bx+hex_chars] 
  1016 00000F05 5B                      	pop	bx	
  1017 00000F06 C3                      	retn
  1018                                  
  1019                                  wordtohex:
  1020                                  	; INPUT ->
  1021                                  	; 	AX = word (binary number)
  1022                                  	; OUTPUT ->
  1023                                  	;	EAX = hexadecimal string
  1024                                  	;
  1025 00000F07 53                      	push	bx
  1026 00000F08 30FF                    	xor	bh, bh
  1027 00000F0A 86E0                    	xchg	ah, al
  1028 00000F0C 50                      	push	ax
  1029 00000F0D 88E3                    	mov	bl, ah
  1030 00000F0F C0EB04                  	shr	bl, 4
  1031 00000F12 8A87[8B0F]              	mov	al, [bx+hex_chars] 	 	
  1032 00000F16 88E3                    	mov	bl, ah
  1033 00000F18 80E30F                  	and	bl, 0Fh
  1034 00000F1B 8AA7[8B0F]              	mov	ah, [bx+hex_chars]
  1035 00000F1F 66C1E010                	shl	eax, 16
  1036 00000F23 58                      	pop	ax
  1037 00000F24 5B                      	pop	bx
  1038 00000F25 EBC9                    	jmp	short bytetohex
  1039                                  
  1040                                  ; 06/11/2023
  1041                                  ;dwordtohex:
  1042                                  ;	; INPUT ->
  1043                                  ;	; 	EAX = dword (binary number)
  1044                                  ;	; OUTPUT ->
  1045                                  ;	;	EDX:EAX = hexadecimal string
  1046                                  ;	;
  1047                                  ;	push	eax
  1048                                  ;	shr	eax, 16
  1049                                  ;	call	wordtohex
  1050                                  ;	mov	edx, eax
  1051                                  ;	pop	eax
  1052                                  ;	call	wordtohex
  1053                                  ;	retn
  1054                                  
  1055                                  _DATA:
  1056                                  
  1057                                  ; 24/11/2016
  1058                                  ;	IRQ  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 
  1059 00000F27 08090A0B0C0D0E0F70-     irq_int	 db 08h,09h,0Ah,0Bh,0Ch,0Dh,0Eh,0Fh,70h,71h,72h,73h,74h,75h,76h,77h
  1059 00000F30 71727374757677     
  1060                                  
  1061                                  ; 17/02/2017
  1062                                  ; Valid ICH device IDs
  1063                                  
  1064                                  valid_ids:
  1065 00000F37 86801524                dd	(ICH_DID << 16) + INTEL_VID  	 ; 8086h:2415h 
  1066 00000F3B 86802524                dd	(ICH0_DID << 16) + INTEL_VID 	 ; 8086h:2425h 
  1067 00000F3F 86804524                dd	(ICH2_DID << 16) + INTEL_VID 	 ; 8086h:2445h 
  1068 00000F43 86808524                dd	(ICH3_DID << 16) + INTEL_VID 	 ; 8086h:2485h 
  1069 00000F47 8680C524                dd	(ICH4_DID << 16) + INTEL_VID 	 ; 8086h:24C5h
  1070 00000F4B 8680D524                dd	(ICH5_DID << 16) + INTEL_VID 	 ; 8086h:24D5h
  1071 00000F4F 86806E26                dd	(ICH6_DID << 16) + INTEL_VID 	 ; 8086h:266Eh
  1072 00000F53 8680A625                dd	(ESB6300_DID << 16) + INTEL_VID  ; 8086h:25A6h
  1073 00000F57 86809826                dd	(ESB631X_DID << 16) + INTEL_VID  ; 8086h:2698h
  1074 00000F5B 8680DE27                dd	(ICH7_DID << 16) + INTEL_VID 	 ; 8086h:27DEh
  1075                                  ; 03/11/2023 - Erdogan Tan
  1076 00000F5F 86809571                dd	(MX82440_DID << 16) + INTEL_VID  ; 8086h:7195h
  1077 00000F63 39101270                dd	(SI7012_DID << 16)  + SIS_VID	 ; 1039h:7012h
  1078 00000F67 DE10B101                dd 	(NFORCE_DID << 16)  + NVIDIA_VID ; 10DEh:01B1h
  1079 00000F6B DE106A00                dd 	(NFORCE2_DID << 16) + NVIDIA_VID ; 10DEh:006Ah
  1080 00000F6F 22106D74                dd 	(AMD8111_DID << 16) + AMD_VID 	 ; 1022h:746Dh
  1081 00000F73 22104574                dd 	(AMD768_DID << 16)  + AMD_VID 	 ; 1022h:7445h
  1082 00000F77 DE105900                dd 	(CK804_DID << 16) + NVIDIA_VID	 ; 10DEh:0059h
  1083 00000F7B DE103A00                dd 	(MCP04_DID << 16) + NVIDIA_VID	 ; 10DEh:003Ah
  1084 00000F7F DE108A00                dd 	(CK8_DID << 16) + NVIDIA_VID	 ; 1022h:008Ah
  1085 00000F83 DE10DA00                dd 	(NFORCE3_DID << 16) + NVIDIA_VID ; 10DEh:00DAh
  1086 00000F87 DE10EA00                dd 	(CK8S_DID << 16) + NVIDIA_VID	 ; 10DEh:00EAh
  1087                                  
  1088                                  valid_id_count:	equ ($ - valid_ids)>>2 ; 05/11/2023
  1089                                  
  1090                                  ; 13/11/2016
  1091 00000F8B 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  1091 00000F94 3941424344454600   
  1092 00000F9C 414339372041756469-     msgAC97Info	db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  1092 00000FA5 6F20436F6E74726F6C-
  1092 00000FAE 6C6572202620436F64-
  1092 00000FB7 656320496E666F0D0A 
  1093 00000FC0 56656E646F72204944-     		db "Vendor ID: "
  1093 00000FC9 3A20               
  1094 00000FCB 303030306820446576-     msgVendorId	db "0000h Device ID: "
  1094 00000FD4 6963652049443A20   
  1095 00000FDC 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  1096 00000FE3 4275733A20              		db "Bus: "
  1097 00000FE8 303068204465766963-     msgBusNo	db "00h Device: "
  1097 00000FF1 653A20             
  1098 00000FF4 3030682046756E6374-     msgDevNo	db "00h Function: "
  1098 00000FFD 696F6E3A20         
  1099 00001002 303068                  msgFncNo	db "00h"
  1100 00001005 0D0A                    		db 0Dh, 0Ah
  1101                                  ; 05/11/2023	
  1102 00001007 4E414D4241523A20        		db "NAMBAR: "
  1103 0000100F 303030306820            msgNamBar	db "0000h "
  1104 00001015 4E41424D4241523A20      		db "NABMBAR: "
  1105 0000101E 303030306820495251-     msgNabmBar	db "0000h IRQ: "
  1105 00001027 3A20               
  1106 00001029 3030                    msgIRQ		dw 3030h
  1107 0000102B 0D0A24                  		db 0Dh, 0Ah, "$"
  1108 0000102E 53616D706C65205261-     msgSampleRate	db "Sample Rate: "
  1108 00001037 74653A20           
  1109 0000103B 303030303020487A20-     msgHertz	db "00000 Hz ", "$" 
  1109 00001044 24                 
  1110 00001045 3820626974732024        msg8Bits	db "8 bits ", "$" 
  1111 0000104D 4D6F6E6F0D0A24          msgMono		db "Mono", 0Dh, 0Ah, "$"
  1112 00001054 313620626974732024      msg16Bits	db "16 bits ", "$" 
  1113 0000105D 53746572656F0D0A24      msgStereo	db "Stereo", 0Dh, 0Ah, "$"
  1114                                  
  1115                                  ;; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
  1116                                  ;codec_id	dd 0
  1117                                  ;codec_chip_id	dd 0
  1118                                  ;codec_vendor_ids dw 0
  1119                                  ;codec_chip_ids	dw 0
  1120                                  
  1121 00001066 3030303030303030        dword_str	 dd 30303030h, 30303030h
  1122 0000106E 680D0A00                		 db 'h', 0Dh, 0Ah, 0
  1123                                  
  1124                                  ;ac_unknown     db 'unknown manufacturer',13,10,0
  1125                                  ;ac_Realtek     db 'Realtek Semiconductor',13,10,0
  1126                                  ;ac_Analog      db 'Analog Devices',13,10,0
  1127                                  ;ac_CMedia      db 'C-Media Electronics',13,10,0
  1128                                  ;ac_Cirrus      db 'Cirrus Logic',13,10,0
  1129                                  ;ac_Wolfson     db 'Wolfson Microelectronics',13,10,0
  1130                                  ;ac_VIA         db 'VIA Technologies',13,10,0
  1131                                  ;ac_SigmaTel    db 'SigmaTel',13,10,0
  1132                                  ;ac_eMicro      db 'eMicro',13,10,0
  1133                                  ;
  1134                                  ;chip_unknown   db 'unknown codec id ', 0
  1135                                  
  1136                                  ;CHIP_REALTEK   equ 414C4700h
  1137                                  ;CHIP_CMEDIA    equ 434D4900h
  1138                                  ;CHIP_VIA       equ 56494100h
  1139                                  
  1140                                  ;codecs        dd CHIP_CMEDIA
  1141                                  ;	       dw ac_CMedia, chips_CMedia
  1142                                  ;              dd CHIP_REALTEK
  1143                                  ;	       dw ac_Realtek, chips_Realtek
  1144                                  ;              dd CHIP_VIA
  1145                                  ;	       dw ac_VIA, chips_VIA
  1146                                  ;              dd 0
  1147                                  
  1148                                  ;chips_Realtek dw 10h, chip_ALC201a
  1149                                  ;              dw 20h, chip_ALC650
  1150                                  ;              dw 21h, chip_ALC650D
  1151                                  ;              dw 22h, chip_ALC650E
  1152                                  ;              dw 23h, chip_ALC650F
  1153                                  ;              dw 60h, chip_ALC655
  1154                                  ;              dw 80h, chip_ALC658
  1155                                  ;              dw 81h, chip_ALC658D
  1156                                  ;              dw 90h, chip_ALC850
  1157                                  ;              dw 0FFh
  1158                                  
  1159                                  ;chips_CMedia  dw 41h, chip_CM9738
  1160                                  ;              dw 61h, chip_CM9739
  1161                                  ;              dw 69h, chip_CM9780
  1162                                  ;              dw 78h, chip_CM9761
  1163                                  ;              dw 82h, chip_CM9761
  1164                                  ;              dw 83h, chip_CM9761
  1165                                  ;              dw 0FFh
  1166                                  
  1167                                  ;chips_VIA     dw 61h, chip_VIA1612A
  1168                                  ;              dw 0FFh
  1169                                  
  1170                                  ;Realtek
  1171                                  ;chip_ALC201a    db 'ALC201a',0dh,0ah,00h
  1172                                  ;chip_ALC650     db 'ALC650 ',0dh,0ah,00h
  1173                                  ;chip_ALC650D    db 'ALC650D',0dh,0ah,00h
  1174                                  ;chip_ALC650E    db 'ALC650E',0dh,0ah,00h
  1175                                  ;chip_ALC650F    db 'ALC650F',0dh,0ah,00h
  1176                                  ;chip_ALC655     db 'ALC655 ',0dh,0ah,00h
  1177                                  ;chip_ALC658     db 'ALC658 ',0dh,0ah,00h
  1178                                  ;chip_ALC658D    db 'ALC658D',0dh,0ah,00h
  1179                                  ;chip_ALC850     db 'ALC850 ',0dh,0ah,00h
  1180                                  
  1181                                  ;CMedia
  1182                                  ;chip_CM9738     db 'CMI9738', 0dh,0ah,0
  1183                                  ;chip_CM9739     db 'CMI9739', 0dh,0ah,0
  1184                                  ;chip_CM9780     db 'CMI9780', 0dh,0ah,0
  1185                                  ;chip_CM9761     db 'CMI9761', 0dh,0ah,0
  1186                                  
  1187                                  ;VIA
  1188                                  ;chip_VIA1612A   db 'VIA1612A',13,10,0
  1189                                  
  1190                                  ; 11/11/2023
  1191                                  msg_init_err:
  1192 00001072 0D0A                    	db	CR, LF
  1193 00001074 4143393720436F6E74-     	db	"AC97 Controller/Codec initialization error !"
  1193 0000107D 726F6C6C65722F436F-
  1193 00001086 64656320696E697469-
  1193 0000108F 616C697A6174696F6E-
  1193 00001098 206572726F722021   
  1194 000010A0 0D0A24                  	db	CR, LF, "$"
  1195                                  
  1196                                  ; 12/11/2023
  1197                                  msg_no_vra:
  1198 000010A3 0D0A                    	db	CR, LF
  1199 000010A5 4E6F20565241207375-     	db	"No VRA support ! Only 48 kHZ sample rate supported !"
  1199 000010AE 70706F72742021204F-
  1199 000010B7 6E6C79203438206B48-
  1199 000010C0 5A2073616D706C6520-
  1199 000010C9 726174652073757070-
  1199 000010D2 6F727465642021     
  1200 000010D9 0D0A24                  	db	CR, LF, "$"
  1201                                  
  1202                                  ; 17/02/2017
  1203                                  bss_start:
  1204                                  
  1205                                  ABSOLUTE bss_start
  1206                                  
  1207                                  alignb 2
  1208                                  
  1209                                  ; 28/11/2016
  1210                                  
  1211 000010DC <res 1Ch>               smpRBuff:	resw 14 ; 19/11/2016 - Erdogan Tan
  1212                                  
  1213 000010F8 ????                    filehandle:	resw 1
  1214                                  
  1215 000010FA ??                      flags:		resb 1
  1216                                  ; 06/11/2023
  1217 000010FB ??                      ac97_int_ln_reg: resb 1
  1218                                  
  1219                                  ; 09/11/2023
  1220                                  ; 06/11/2023
  1221                                  ;pcm_irq_status: resb 1	; 05/11/2023
  1222 000010FC ??                      inside:		resb 1
  1223 000010FD ??                      tloop:		resb 1	; 10/11/2023
  1224                                  
  1225                                  ; 09/11/2023
  1226                                  ; 04/11/2023 - 06/11/2023
  1227 000010FE ????                    IRQ_status:	resw 1	; IRQ status before enabling audio interrupt
  1228 00001100 ????????                IRQ_vector:	resd 1  ; Previous interrupt handler address	
  1229                                  
  1230                                  ; 17/02/2017
  1231                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  1232                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  1233                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  1234                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  1235 00001104 ????                    NAMBAR:		resw 1			; BAR for mixer
  1236 00001106 ????                    NABMBAR:	resw 1			; BAR for bus master regs
  1237                                  
  1238                                  ; 256 byte buffer for descriptor list
  1239 00001108 ????                    BDL_BUFFER:	resw 1			; segment of our 256byte BDL buffer
  1240 0000110A ????                    WAV_BUFFER1:	resw 1			; segment of our WAV storage
  1241                                  ; 64k buffers for wav file storage
  1242 0000110C ????                    WAV_BUFFER2:	resw 1			; segment of 2nd wav buffer
  1243                                  
  1244                                  ; 06/11/2023
  1245                                  ;tBuff:		resb 1
  1246                                  ;ac97_int_ln_reg: resb 1
  1247                                  
  1248                                  ; 12/11/2016 - Erdogan Tan
  1249                                  
  1250 0000110E ????????                bus_dev_fn:	resd 1
  1251 00001112 ????????                dev_vendor:	resd 1
  1252                                  ; 06/11/2023
  1253                                  ;stats_cmd:	resw 1 ; 17/02/2017
  1254                                  ; 05/11/2023
  1255                                  ;ac97_io_base:	resw 1
  1256 00001116 ????                    sample_rate:	resw 1
  1257                                  
  1258                                  ; 19/11/2016
  1259 00001118 ????                    stmo:		resw 1 
  1260 0000111A ????                    bps:		resw 1
  1261                                  
  1262                                  ; 08/11/2023
  1263                                  ; 07/11/2023
  1264 0000111C ??                      fbs_shift:	resb 1
  1265                                  ; 09/11/2023
  1266 0000111D ??                      b_indicator:	resb 1
  1267                                  ; 10/11/2023
  1268 0000111E ??                      LVI:		resb 1
  1269 0000111F ??                      		resb 1 ; 10/11/2023 
  1270                                  
  1271                                  ;fbs_seg:	resw 1
  1272                                  ;fbs_off:	resw 1
  1273                                  
  1274                                  ;alignb 2
  1275                                  
  1276                                  ; 32 kilo bytes for temporay buffer
  1277                                  ; (for stereo-mono, 8bit/16bit corrections)
  1278 00001120 <res 8000h>             temp_buffer:	resb 32768
  1279                                  
  1280                                  ;alignb 16
  1281                                  EOF:
