     1                                  ; ****************************************************************************
     2                                  ; PLAYWAV.ASM - ICH AC97 .wav player for DOS.			   PLAYWAV.COM
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; Last Update: 04/11/2023 (Previous: 17/02/2017)
     5                                  ; ----------------------------------------------------------------------------
     6                                  ; Beginning: 17/02/2017
     7                                  ; ----------------------------------------------------------------------------
     8                                  ; Assembler: NASM version 2.11 (2.15)
     9                                  ;	     nasm playwav.asm -l playwav.lst -o PLAYWAV.COM	
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Derived from '.wav file player for DOS' Jeff Leyda, Sep 02, 2002 
    12                                  ; ****************************************************************************
    13                                  ; Modidified from 'PLAYER.COM' for VIA VT8233 wav player source code by
    14                                  ; (PLAYER.ASM) by Erdogan Tan (07/11/2016 - 08/12/2016)
    15                                  
    16                                  [BITS 16]
    17                                  
    18                                  [ORG 100h] 
    19                                  
    20                                  	%include 'ac97.inc' ; 17/02/2017 ; 03/11/2023
     1                              <1> ; 03/11/2023
     2                              <1> ; 17/02/2017 (Erdogan Tan, PLAYWAV.ASM)
     3                              <1> ; constant.inc & codec.inc (for ICH AC97 wav player, 'PLAYWAV.COM') 
     4                              <1> 
     5                              <1> ; ----------------------------------------------------------------------------
     6                              <1> ; CONSTANT.INC
     7                              <1> ; ----------------------------------------------------------------------------
     8                              <1> 
     9                              <1> ;constants of stuff that seem hard to remember at times.
    10                              <1> 
    11                              <1> TRUE  EQU 1
    12                              <1> FALSE EQU 0
    13                              <1> 
    14                              <1> ENABLED  EQU 1
    15                              <1> DISABLED EQU 0
    16                              <1> 
    17                              <1> BIT0  EQU 1
    18                              <1> BIT1  EQU 2
    19                              <1> BIT2  EQU 4
    20                              <1> BIT3  EQU 8
    21                              <1> BIT4  EQU 10h
    22                              <1> BIT5  EQU 20h
    23                              <1> BIT6  EQU 40h
    24                              <1> BIT7  EQU 80h
    25                              <1> BIT8  EQU 100h
    26                              <1> BIT9  EQU 200h
    27                              <1> BIT10 EQU 400h
    28                              <1> BIT11 EQU 800h
    29                              <1> BIT12 EQU 1000h
    30                              <1> BIT13 EQU 2000h
    31                              <1> BIT14 EQU 4000h
    32                              <1> BIT15 EQU 8000h
    33                              <1> BIT16 EQU 10000h
    34                              <1> BIT17 EQU 20000h
    35                              <1> BIT18 EQU 40000h
    36                              <1> BIT19 EQU 80000h
    37                              <1> BIT20 EQU 100000h
    38                              <1> BIT21 EQU 200000h
    39                              <1> BIT22 EQU 400000h
    40                              <1> BIT23 EQU 800000h
    41                              <1> BIT24 EQU 1000000h
    42                              <1> BIT25 EQU 2000000h
    43                              <1> BIT26 EQU 4000000h
    44                              <1> BIT27 EQU 8000000h
    45                              <1> BIT28 EQU 10000000h
    46                              <1> BIT29 EQU 20000000h
    47                              <1> BIT30 EQU 40000000h
    48                              <1> BIT31 EQU 80000000h
    49                              <1> 
    50                              <1> ;special characters
    51                              <1> NUL     EQU 0
    52                              <1> NULL    EQU 0
    53                              <1> BELL    EQU 07
    54                              <1> BS      EQU 08
    55                              <1> TAB     EQU 09
    56                              <1> LF      EQU 10
    57                              <1> CR      EQU 13
    58                              <1> ESCAPE  EQU 27           ;ESC is a reserved word....
    59                              <1> 
    60                              <1> 
    61                              <1> ;file stuff
    62                              <1> READONLY  EQU   BIT0
    63                              <1> HIDDEN    EQU   BIT1
    64                              <1> SYSTEM    EQU   BIT2
    65                              <1> VOLUME    EQU   BIT3         ;ignored for file access
    66                              <1> DIRECTORY EQU   BIT4         ;must be 0 for file access
    67                              <1> ARCHIVE   EQU   BIT5
    68                              <1> SHAREABLE EQU   BIT7         ;for novell networks
    69                              <1> OPEN	EQU	2		; open existing file
    70                              <1> CREATE	EQU	1		; create new file
    71                              <1> 
    72                              <1> 
    73                              <1> ; PCI equates
    74                              <1> ; PCI function address (PFA)
    75                              <1> ; bit 31 = 1
    76                              <1> ; bit 23:16 = bus number     (0-255)
    77                              <1> ; bit 15:11 = device number  (0-31)
    78                              <1> ; bit 10:8 = function number (0-7)
    79                              <1> ; bit 7:0 = register number  (0-255)
    80                              <1> 
    81                              <1> IO_ADDR_MASK    EQU     0FFFEh          ; mask off bit 0 for reading BARs
    82                              <1> PCI_INDEX_PORT  EQU     0CF8h
    83                              <1> PCI_DATA_PORT   EQU     0CFCh
    84                              <1> PCI32           EQU     BIT31           ; bitflag to signal 32bit access
    85                              <1> PCI16           EQU     BIT30           ; bitflag for 16bit access
    86                              <1> 
    87                              <1> PCI_FN0         EQU     0 << 8
    88                              <1> PCI_FN1         EQU     1 << 8
    89                              <1> PCI_FN2         EQU     2 << 8
    90                              <1> PCI_FN3         EQU     3 << 8
    91                              <1> PCI_FN4         EQU     4 << 8
    92                              <1> PCI_FN5         EQU     5 << 8
    93                              <1> PCI_FN6         EQU     6 << 8
    94                              <1> PCI_FN7         EQU     7 << 8
    95                              <1> 
    96                              <1> PCI_CMD_REG		EQU	04h		; reg 04, command reg
    97                              <1>  IO_ENA			EQU	BIT0		; i/o decode enable
    98                              <1>  MEM_ENA		EQU	BIT1		; memory decode enable
    99                              <1>  BM_ENA                 EQU     BIT2		; bus master enable
   100                              <1> 
   101                              <1> ; ----------------------------------------------------------------------------
   102                              <1> ; CODEC.INC
   103                              <1> ; ----------------------------------------------------------------------------
   104                              <1> 
   105                              <1> ;Codec registers.
   106                              <1> ;
   107                              <1> ;Not all codecs are created equal. Refer to the spec for your specific codec.
   108                              <1> ;
   109                              <1> ;All registers are 16bits wide.  Access to codec registers over the AC97 link
   110                              <1> ;is defined by the OEM.  
   111                              <1> ;
   112                              <1> ;Secondary codec's are accessed by ORing in BIT7 of all register accesses.
   113                              <1> ;
   114                              <1> 
   115                              <1> ; each codec/mixer register is 16bits
   116                              <1> 
   117                              <1> CODEC_RESET_REG                 equ     00      ; reset codec
   118                              <1> CODEC_MASTER_VOL_REG            equ     02      ; master volume
   119                              <1> CODEC_HP_VOL_REG                equ     04      ; headphone volume
   120                              <1> CODEC_MASTER_MONO_VOL_REG       equ     06      ; master mono volume
   121                              <1> CODEC_MASTER_TONE_REG           equ     08      ; master tone (R+L)
   122                              <1> CODEC_PCBEEP_VOL_REG            equ     0ah     ; PC beep volume
   123                              <1> CODEC_PHONE_VOL_REG             equ     0bh     ; phone volume
   124                              <1> CODEC_MIC_VOL_REG               equ     0eh     ; MIC volume
   125                              <1> CODEC_LINE_IN_VOL_REG           equ     10h     ; line input volume
   126                              <1> CODEC_CD_VOL_REG                equ     12h     ; CD volume
   127                              <1> CODEC_VID_VOL_REG               equ     14h     ; video volume
   128                              <1> CODEC_AUX_VOL_REG               equ     16h     ; aux volume
   129                              <1> CODEC_PCM_OUT_REG               equ     18h     ; PCM output volume
   130                              <1> CODEC_RECORD_SELECT_REG         equ     1ah     ; record select input
   131                              <1> CODEC_RECORD_VOL_REG            equ     1ch     ; record volume
   132                              <1> CODEC_RECORD_MIC_VOL_REG        equ     1eh     ; record mic volume
   133                              <1> CODEC_GP_REG                    equ     20h     ; general purpose
   134                              <1> CODEC_3D_CONTROL_REG            equ     22h     ; 3D control
   135                              <1> ; 24h is reserved
   136                              <1> CODEC_POWER_CTRL_REG            equ     26h     ; powerdown control
   137                              <1> CODEC_EXT_AUDIO_REG             equ     28h     ; extended audio
   138                              <1> CODEC_EXT_AUDIO_CTRL_REG        equ     2ah     ; extended audio control
   139                              <1> CODEC_PCM_FRONT_DACRATE_REG     equ     2ch     ; PCM out sample rate
   140                              <1> CODEC_PCM_SURND_DACRATE_REG     equ     2eh     ; surround sound sample rate
   141                              <1> CODEC_PCM_LFE_DACRATE_REG       equ     30h     ; LFE sample rate
   142                              <1> CODEC_LR_ADCRATE_REG            equ     32h     ; PCM in sample rate
   143                              <1> CODEC_MIC_ADCRATE_REG           equ     34h     ; mic in sample rate
   144                              <1> 
   145                              <1> ; registers 36-7a are reserved on the ICH
   146                              <1> 
   147                              <1> CODEC_VENDORID1_REG             equ     7ch     ; codec vendor ID 1
   148                              <1> CODEC_VENDORID2_REG             equ     7eh     ; codec vendor ID 2
   149                              <1> 
   150                              <1> ; Mixer registers 0 through 51h reside in the ICH and are not forwarded over
   151                              <1> ; the AC97 link to the codec, which I think is a little weird.  Looks like
   152                              <1> ; the ICH makes it so you don't need a fully functional codec to play audio?
   153                              <1> ;
   154                              <1> ; whenever 2 codecs are present in the system, use BIT7 to access the 2nd
   155                              <1> ; set of registers, ie 80h-feh
   156                              <1> 
   157                              <1> PRIMARY_CODEC                   equ     0       ; 0-7F for primary codec
   158                              <1> SECONDARY_CODEC                 equ     BIT7    ; 80-8f registers for 2ndary
   159                              <1> 
   160                              <1> SAMPLE_RATE_441khz	equ     44100   ; 44.1Khz (cd quality) rate
   161                              <1> 
   162                              <1> ; ----------------------------------------------------------------------------
   163                              <1> ; 17/02/2017
   164                              <1> PCI_IO_BASE	equ 10h			; = NAMBAR register offset
   165                              <1> AC97_INT_LINE   equ 3Ch			; AC97 Interrupt Line register offset
   166                              <1> 
   167                              <1> ; ----------------------------------------------------------------------------
   168                              <1> ; ICH2AC97.INC
   169                              <1> ; ----------------------------------------------------------------------------
   170                              <1> 
   171                              <1> ; PCI stuff
   172                              <1> 
   173                              <1> ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
   174                              <1> 
   175                              <1> INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
   176                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   177                              <1> SIS_VID		equ	1039h
   178                              <1> NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
   179                              <1> AMD_VID		equ	1022h
   180                              <1> 
   181                              <1> 
   182                              <1> ICH_DID         equ     2415h           ; ICH device ID
   183                              <1> ICH0_DID        equ     2425h           ; ICH0
   184                              <1> ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
   185                              <1>                                         ; they all should be compatible.
   186                              <1> ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
   187                              <1> ICH3_DID	equ     2485h           ; ICH3
   188                              <1> ICH4_DID        equ     24C5h           ; ICH4
   189                              <1> ICH5_DID	equ     24D5h           ; ICH5 
   190                              <1> ICH6_DID	equ     266Eh           ; ICH6
   191                              <1> ESB6300_DID	equ     25A6h           ; 6300ESB
   192                              <1> ESB631X_DID	equ     2698h           ; 631XESB
   193                              <1> ICH7_DID	equ	27DEh		; ICH7
   194                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   195                              <1> MX82440_DID	equ	7195h
   196                              <1> SI7012_DID	equ	7012h
   197                              <1> NFORCE_DID	equ	01B1h
   198                              <1> NFORCE2_DID	equ	006Ah
   199                              <1> AMD8111_DID	equ	746Dh
   200                              <1> AMD768_DID	equ	7445h
   201                              <1> ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
   202                              <1> CK804_DID	equ	0059h
   203                              <1> MCP04_DID	equ	003Ah
   204                              <1> CK8_DID		equ	008Ah
   205                              <1> NFORCE3_DID	equ	00DAh
   206                              <1> CK8S_DID	equ	00EAh	
   207                              <1> ;
   208                              <1> 
   209                              <1> NAMBAR_REG      equ     10h             ; native audio mixer BAR
   210                              <1>  NAM_SIZE       equ     256             ; 256 bytes required.
   211                              <1> 
   212                              <1> NABMBAR_REG     equ     14h             ; native audio bus mastering BAR
   213                              <1>  NABM_SIZE      equ     64              ; 64 bytes
   214                              <1> 
   215                              <1> ; BUS master registers, accessed via NABMBAR+offset
   216                              <1> 
   217                              <1> ; ICH supports 3 different types of register sets for three types of things
   218                              <1> ; it can do, thus:
   219                              <1> ;
   220                              <1> ; PCM in (for recording) aka PI
   221                              <1> ; PCM out (for playback) aka PO
   222                              <1> ; MIC in (for recording) aka MC
   223                              <1> 
   224                              <1> PI_BDBAR_REG            equ     0       ; PCM in buffer descriptor BAR
   225                              <1> PO_BDBAR_REG            equ     10h     ; PCM out buffer descriptor BAR
   226                              <1> MC_BDBAR_REG            equ     20h     ; MIC in buffer descriptor BAR
   227                              <1> 
   228                              <1> ; each buffer descriptor BAR holds a pointer which has entries to the buffer
   229                              <1> ; contents of the .WAV file we're going to play. Each entry is 8 bytes long
   230                              <1> ; (more on that later) and can contain 32 entries total, so each BAR is
   231                              <1> ; 256 bytes in length, thus:
   232                              <1> 
   233                              <1> BDL_SIZE                equ     32*8    ; Buffer Descriptor List size
   234                              <1> INDEX_MASK              equ     31      ; indexes must be 0-31
   235                              <1> 
   236                              <1> 
   237                              <1> 
   238                              <1> PI_CIV_REG              equ     4       ; PCM in current Index value (RO)
   239                              <1> PO_CIV_REG              equ     14h     ; PCM out current Index value (RO)
   240                              <1> MC_CIV_REG              equ     24h     ; MIC in current Index value (RO)
   241                              <1> ;8bit read only
   242                              <1> ; each current index value is simply a pointer showing us which buffer
   243                              <1> ; (0-31) the codec is currently processing. Once this counter hits 31, it
   244                              <1> ; wraps back to 0.
   245                              <1> ; this can be handy to know, as once it hits 31, we're almost out of data to
   246                              <1> ; play back or room to record!
   247                              <1> 
   248                              <1> 
   249                              <1> PI_LVI_REG              equ     5       ; PCM in Last Valid Index
   250                              <1> PO_LVI_REG              equ     15h     ; PCM out Last Valid Index
   251                              <1> MC_LVI_REG              equ     25h     ; MIC in Last Valid Index
   252                              <1> ;8bit read/write
   253                              <1> ; The Last Valid Index is a number (0-31) to let the codec know what buffer
   254                              <1> ; number to stop on after processing.  It could be very nasty to play audio
   255                              <1> ; from buffers that aren't filled with the audio we want to play.
   256                              <1> 
   257                              <1> 
   258                              <1> PI_SR_REG               equ     6       ; PCM in Status register
   259                              <1> PO_SR_REG               equ     16h     ; PCM out Status register
   260                              <1> MC_SR_REG               equ     26h     ; MIC in Status register
   261                              <1> ;16bit read/write
   262                              <1> ; status registers.  Bitfields follow:
   263                              <1> 
   264                              <1> FIFO_ERR                equ     BIT4    ; FIFO Over/Underrun W1TC.
   265                              <1> 
   266                              <1> BCIS                    equ     BIT3    ; buffer completion interrupt status.
   267                              <1>                                         ; Set whenever the last sample in ANY
   268                              <1>                                         ; buffer is finished.  Bit is only
   269                              <1>                                         ; set when the Interrupt on Complete
   270                              <1>                                         ; (BIT4 of control reg) is set.
   271                              <1> 
   272                              <1> LVBCI                   equ     BIT2    ; Set whenever the codec has processed
   273                              <1>                                         ; the last buffer in the buffer list.
   274                              <1>                                         ; Will fire an interrupt if IOC bit is
   275                              <1>                                         ; set. Probably set after the last
   276                              <1>                                         ; sample in the last buffer is
   277                              <1>                                         ; processed.  W1TC
   278                              <1> 
   279                              <1>                                         ; 
   280                              <1> CELV                    equ     BIT1    ; Current buffer == last valid.
   281                              <1>                                         ; Bit is RO and remains set until LVI is
   282                              <1>                                         ; cleared.  Probably set up the start
   283                              <1>                                         ; of processing for the last buffer.
   284                              <1> 
   285                              <1> 
   286                              <1> DCH                     equ     BIT0    ; DMA controller halted.
   287                              <1>                                         ; set whenever audio stream is stopped
   288                              <1>                                         ; or something else goes wrong.
   289                              <1> 
   290                              <1> 
   291                              <1> PI_PICB_REG             equ     8       ; PCM in position in current buffer(RO)
   292                              <1> PO_PICB_REG             equ     18h     ; PCM out position in current buffer(RO)
   293                              <1> MC_PICB_REG             equ     28h     ; MIC in position in current buffer (RO)
   294                              <1> ;16bit read only
   295                              <1> ; position in current buffer regs show the number of dwords left to be
   296                              <1> ; processed in the current buffer.
   297                              <1> ; 
   298                              <1> 
   299                              <1> PI_PIV_REG              equ     0ah     ; PCM in Prefected index value
   300                              <1> PO_PIV_REG              equ     1ah     ; PCM out Prefected index value
   301                              <1> MC_PIV_REG              equ     2ah     ; MIC in Prefected index value
   302                              <1> ;8bit, read only
   303                              <1> ; Prefetched index value register.
   304                              <1> ; tells which buffer number (0-31) has be prefetched.  I'd imagine this
   305                              <1> ; value follows the current index value fairly closely. (CIV+1)
   306                              <1> ;
   307                              <1> 
   308                              <1> 
   309                              <1> PI_CR_REG               equ     0bh     ; PCM in Control Register
   310                              <1> PO_CR_REG               equ     1bh     ; PCM out Control Register
   311                              <1> MC_CR_REG               equ     2bh     ; MIC in Control Register
   312                              <1> ; 8bit
   313                              <1> ; Control register *MUST* only be accessed as an 8bit value.
   314                              <1> ; Control register. See bitfields below.
   315                              <1> ;
   316                              <1> 
   317                              <1> 
   318                              <1> IOCE                    equ     BIT4    ; interrupt on complete enable.
   319                              <1>                                         ; set this bit if you want an intrtpt
   320                              <1>                                         ; to fire whenever LVBCI is set.
   321                              <1> FEIFE                   equ     BIT3    ; set if you want an interrupt to fire
   322                              <1>                                         ; whenever there is a FIFO (over or
   323                              <1>                                         ; under) error.
   324                              <1> LVBIE                   equ     BIT2    ; last valid buffer interrupt enable.
   325                              <1>                                         ; set if you want an interrupt to fire
   326                              <1>                                         ; whenever the completion of the last
   327                              <1>                                         ; valid buffer.
   328                              <1> RR                      equ     BIT1    ; reset registers. Nukes all regs
   329                              <1>                                         ; except bits 4:2 of this register.
   330                              <1>                                         ; Only set this bit if BIT 0 is 0
   331                              <1> RPBM                    equ     BIT0    ; Run/Pause
   332                              <1>                                         ; set this bit to start the codec!
   333                              <1> 
   334                              <1> GLOB_CNT_REG            equ     2ch     ; Global control register
   335                              <1> SEC_RES_EN              equ     BIT5    ; secondary codec resume event 
   336                              <1>                                         ; interrupt enable.  Not used here.
   337                              <1> PRI_RES_EN              equ     BIT4    ; ditto for primary. Not used here.
   338                              <1> ACLINK_OFF              equ     BIT3    ; Turn off the AC97 link
   339                              <1> ACWARM_RESET            equ     BIT2    ; Awaken the AC97 link from sleep.
   340                              <1>                                         ; registers preserved, bit self clears
   341                              <1> ACCOLD_RESET            equ     BIT1    ; Reset everything in the AC97 and
   342                              <1>                                         ; reset all registers. Not self clearing
   343                              <1> 
   344                              <1> GPIIE                   equ     BIT0    ; GPI Interrupt enable.
   345                              <1>                                         ; set if you want an interrupt to
   346                              <1>                                         ; fire upon ANY of the bits in the
   347                              <1>                                         ; GPI (general pursose inputs?) not used.
   348                              <1> 
   349                              <1> GLOB_STS_REG            equ     30h     ; Global Status register (RO)
   350                              <1> 
   351                              <1> MD3                     equ     BIT17   ; modem powerdown status (yawn)
   352                              <1> AD3                     equ     BIT16   ; Audio powerdown status (yawn)
   353                              <1> RD_COMPLETE_STS         equ     BIT15   ; Codec read timed out. 0=normal
   354                              <1> BIT3SLOT12              equ     BIT14   ; shadowed status of bit 3 in slot 12
   355                              <1> BIT2SLOT12              equ     BIT13   ; shadowed status of bit 2 in slot 12
   356                              <1> BIT1SLOT12              equ     BIT12   ; shadowed status of bit 1 in slot 12
   357                              <1> SEC_RESUME_STS          equ     BIT11   ; secondary codec has resumed (and irqed)
   358                              <1> PRI_RESUME_STS          equ     BIT10   ; primary codec has resumed (and irqed)
   359                              <1> SEC_CODEC_RDY           equ     BIT9    ; secondary codec is ready for action
   360                              <1> PRI_CODEC_RDY           equ     BIT8    ; Primary codec is ready for action
   361                              <1>                                         ; software must check these bits before
   362                              <1>                                         ; starting the codec!
   363                              <1> MIC_IN_IRQ              equ     BIT7    ; MIC in caused an interrupt
   364                              <1> PCM_OUT_IRQ             equ     BIT6    ; One of the PCM out channels IRQed
   365                              <1> PCM_IN_IRQ              equ     BIT5    ; One of the PCM in channels IRQed
   366                              <1> MODEM_OUT_IRQ           equ     BIT2    ; modem out channel IRQed
   367                              <1> MODEM_IN_IRQ            equ     BIT1    ; modem in channel IRQed
   368                              <1> GPI_STS_CHANGE          equ     BIT0    ; set whenever GPI's have changed.
   369                              <1>                                         ; BIT0 of slot 12 also reflects this.
   370                              <1> 
   371                              <1> 
   372                              <1> ACC_SEMA_REG            equ     34h     ; Codec write semaphore register
   373                              <1> CODEC_BUSY              equ     BIT0    ; codec register I/O is happening
   374                              <1>                                         ; self clearing
   375                              <1> ;
   376                              <1> ; Buffer Descriptors List
   377                              <1> ; As stated earlier, each buffer descriptor list is a set of (up to) 32 
   378                              <1> ; descriptors, each 8 bytes in length.  Bytes 0-3 of a descriptor entry point
   379                              <1> ; to a chunk of memory to either play from or record to. Bytes 4-7 of an
   380                              <1> ; entry describe various control things detailed below.
   381                              <1> ; 
   382                              <1> ; Buffer pointers must always be aligned on a Dword boundry.
   383                              <1> ;
   384                              <1> 
   385                              <1> IOC                     equ     BIT31   ; Fire an interrupt whenever this
   386                              <1>                                         ; buffer is complete.
   387                              <1> 
   388                              <1> BUP                     equ     BIT30   ; Buffer Underrun Policy.
   389                              <1>                                         ; if this buffer is the last buffer
   390                              <1>                                         ; in a playback, fill the remaining
   391                              <1>                                         ; samples with 0 (silence) or not.
   392                              <1>                                         ; It's a good idea to set this to 1
   393                              <1>                                         ; for the last buffer in playback,
   394                              <1>                                         ; otherwise you're likely to get a lot
   395                              <1>                                         ; of noise at the end of the sound.
   396                              <1> 
   397                              <1> ;
   398                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   399                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   400                              <1> ; Luckily for us, that's the same format as .wav files.
   401                              <1> ;
   402                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   403                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   404                              <1> ;
   405                              <1> ; A value of 0 in these bits means play no samples.
   406                              <1> ;
    21                                  
    22                                  _STARTUP:
    23                                  
    24                                  ; memory allocation
    25                                  
    26 00000000 E86201                          call    setFree				; deallocate unused DOS mem
    27                                  
    28                                  	; 17/02/2017
    29                                  	; Clear BSS (uninitialized data) area
    30 00000003 31C0                    	xor	ax, ax ; 0
    31 00000005 B92840                  	mov	cx, (EOF - bss_start)/2
    32 00000008 BF[300A]                	mov	di, bss_start
    33 0000000B F3AB                    	rep	stosw
    34                                  
    35                                  ; allocate 256 bytes of data for DCM_OUT Buffer Descriptor List. (BDL)
    36                                  
    37 0000000D B81000                          mov     ax, BDL_SIZE / 16
    38 00000010 E85A01                          call    memAlloc
    39 00000013 A3[5A0A]                        mov     [BDL_BUFFER], ax		; segment 
    40                                  
    41                                  ; allocate 2 buffers, 64k each for now.
    42                                  
    43 00000016 B80010                          mov     ax, BUFFERSIZE / 16		; 64k for .WAV file
    44 00000019 E85101                          call    memAlloc
    45 0000001C A3[5C0A]                        mov     [WAV_BUFFER1], ax		; segment
    46                                  
    47 0000001F B80010                  	mov	ax, BUFFERSIZE / 16
    48 00000022 E84801                  	call	memAlloc
    49 00000025 A3[5E0A]                	mov	[WAV_BUFFER2], ax
    50                                  
    51                                  ; Detect/reset AC97 
    52                                  
    53 00000028 E8B502                  	call	pciFindDevice
    54 0000002B 7342                            jnc	short _1
    55                                  
    56                                  ; couldn't find the audio device!
    57                                  
    58 0000002D 0E                      	push	cs
    59 0000002E 1F                      	pop	ds
    60 0000002F BA[3900]                        mov     dx, noDevMsg
    61 00000032 B409                            mov     ah, 9
    62 00000034 CD21                            int     21h
    63 00000036 E92501                          jmp     exit
    64                                  
    65                                  ; 17/02/2017
    66 00000039 4572726F723A20556E-     noDevMsg db "Error: Unable to find intel ICH based audio device!",CR,LF,"$"
    66 00000042 61626C6520746F2066-
    66 0000004B 696E6420696E74656C-
    66 00000054 204943482062617365-
    66 0000005D 6420617564696F2064-
    66 00000066 6576696365210D0A24 
    67                                  
    68                                  	; 03/11/2023
    69                                  _1:
    70                                  	; eax = BUS/DEV/FN
    71                                  	;	00000000BBBBBBBBDDDDDFFF00000000
    72                                  	; edx = DEV/VENDOR
    73                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
    74                                  
    75 0000006F 66A3[620A]              	mov	[bus_dev_fn], eax
    76 00000073 668916[660A]            	mov	[dev_vendor], edx
    77                                  
    78                                  	; init controller
    79                                  	; 17/02/2017
    80 00000078 B004                    	mov	al, PCI_CMD_REG ; command register (04h)
    81 0000007A E8D501                  	call	pciRegRead16 ; pciRegRead8
    82                                  
    83                                  	; eax = BUS/DEV/FN/REG
    84                                  	;  dx = PCI Command Register Content ; 17/02/2017
    85 0000007D 8916[6A0A]              	mov	[stats_cmd], dx
    86                                  
    87                                  	; get ICH base address regs for mixer and bus master
    88                                  
    89 00000081 B010                            mov     al, NAMBAR_REG
    90 00000083 E8CC01                          call    pciRegRead16			; read PCI registers 10-11
    91 00000086 83E2FE                          and     dx, IO_ADDR_MASK 		; mask off BIT0
    92                                  
    93 00000089 8916[560A]                      mov     [NAMBAR], dx			; save audio mixer base addr
    94                                  
    95 0000008D B014                    	mov     al, NABMBAR_REG
    96 0000008F E8C001                          call    pciRegRead16
    97 00000092 83E2FE                          and     dx, IO_ADDR_MASK
    98                                  
    99 00000095 8916[580A]                      mov     [NABMBAR], dx			; save bus master base addr
   100                                  
   101 00000099 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
   102 0000009B E8AC01                  	call	pciRegRead8 ; 17/02/2017
   103                                  
   104 0000009E 8816[610A]              	mov     [ac97_int_ln_reg], dl
   105                                  
   106                                  	; 28/11/2016
   107 000000A2 BB0100                  	mov	bx, 1
   108 000000A5 30F6                    	xor	dh, dh 	 ; 17/02/2017
   109 000000A7 89D1                    	mov	cx, dx
   110 000000A9 D3E3                    	shl	bx, cl
   111                                  
   112                                  	; 04/11/2023
   113 000000AB FA                      	cli
   114                                  
   115                                  	;not	bx
   116 000000AC E4A1                    	in	al, 0A1h ; irq 8-15
   117 000000AE 88C4                            mov	ah, al
   118 000000B0 E421                            in	al, 21h  ; irq 0-7 
   119                                  
   120                                  	; 04/11/2023
   121                                  	; save IRQ status
   122 000000B2 A3[500A]                	mov	[IRQ_status], ax
   123                                  
   124                                  	;and	ax, bx   ; unmask
   125 000000B5 0FB3D0                   	btr	ax, dx	 ; unmask
   126 000000B8 E621                    	out	21h, al  ; enable interrupt (if irq <= 7)
   127 000000BA 88E0                    	mov	al, ah
   128 000000BC E6A1                    	out	0A1h, al ; enable interrupt (if irq > 7)
   129                                  	;not	bx
   130                                  
   131                                  	; 04/11/2023
   132                                  	;mov	dx, 4D1h			;8259 ELCR1
   133                                          ;in	al, dx
   134                                  	;mov	ah, al
   135                                  	;mov	dx, 4D0h 
   136                                          ;in	al, dx
   137                                  	;;or	ax, bx        
   138                                  	;bts	ax, cx
   139                                  	;mov	dx, 4D0h
   140                                  	;out	dx, al                          ;set level-triggered mode
   141                                  	;mov	al, ah
   142                                  	;mov	dx, 4D1h
   143                                  	;out	dx, al                          ;set level-triggered mode
   144                                  
   145                                  	; 24/11/2016 - Erdogan Tan
   146 000000BE 89CB                    	mov	bx, cx
   147                                  	;mov	bx, dx
   148 000000C0 8A9F[E408]              	mov	bl, [bx+irq_int]
   149 000000C4 C1E302                  	shl	bx, 2 ; * 4
   150                                  
   151                                  	; set up interrupt vector
   152                                  	; 30/11/2016
   153 000000C7 06                      	push	es
   154 000000C8 31C0                    	xor	ax, ax
   155 000000CA 8EC0                    	mov	es, ax
   156                                  	; 04/11/2023
   157                                  	; save interrupt vector
   158 000000CC 268B07                  	mov	ax, [es:bx]
   159 000000CF A3[520A]                	mov	[IRQ_vector], ax
   160 000000D2 268B4702                	mov	ax, [es:bx+2]
   161 000000D6 A3[540A]                	mov	[IRQ_vector+2], ax
   162                                  
   163 000000D9 26C707[9807]            	mov	word [es:bx], ac97_int_handler
   164 000000DE 8CC8                    	mov	ax, cs
   165 000000E0 26894702                	mov	[es:bx+2], ax
   166 000000E4 07                      	pop	es
   167                                  
   168                                  	; 04/11/2023	
   169 000000E5 FB                      	sti
   170                                  		
   171 000000E6 E8FC04                  	call	write_ac97_dev_info 
   172                                  
   173                                  ; check the command line for a file to play
   174                                  
   175                                          ;push	ds
   176 000000E9 E88A00                          call    processCmdline			; get the filename
   177                                  
   178                                  ; open the file
   179 000000EC B002                            mov     al, OPEN                        ; open existing file
   180 000000EE E8A500                          call    openFile                        ; no error? ok.
   181                                          ;pop	ds
   182 000000F1 7322                            jnc     short _gsr
   183                                  
   184                                  ; file not found!
   185                                  
   186                                          ;push   cs
   187                                          ;pop    ds
   188 000000F3 BA[FC00]                        mov	dx, noFileErrMsg
   189 000000F6 B409                            mov     ah, 9
   190 000000F8 CD21                            int     21h
   191 000000FA EB62                            jmp     exit
   192                                  
   193 000000FC 4572726F723A206669-     noFileErrMsg  db "Error: file not found.",CR,LF,"$"
   193 00000105 6C65206E6F7420666F-
   193 0000010E 756E642E0D0A24     
   194                                  
   195                                  _gsr:
   196 00000115 E8A500                          call    getSampleRate                   ; read the sample rate
   197                                                                                  ; pass it onto codec.
   198 00000118 7244                    	jc	short exit ; 19/11/2016 - nothing to do
   199                                  
   200 0000011A A3[6C0A]                	mov	[sample_rate], ax
   201                                  	; 19/11/2016
   202 0000011D 880E[6E0A]              	mov	[stmo], cl
   203 00000121 8816[700A]              	mov	[bps], dl
   204                                  
   205                                  	; 17/02/2017
   206 00000125 C606[720A]00            	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit 
   207 0000012A FEC9                    	dec	cl
   208 0000012C 7504                    	jnz	short _gsr_1 ; stereo
   209 0000012E FE06[720A]              	inc	byte [fbs_shift] ; 1 = mono or 8 bit		
   210                                  _gsr_1:	
   211 00000132 80FA08                  	cmp	dl, 8 
   212 00000135 7704                    	ja	short _gsr_2 ; 16 bit samples
   213 00000137 FE06[720A]              	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   214                                  _gsr_2:	
   215 0000013B E80906                  	call	write_sample_rate
   216                                  
   217                                  	; 04/11/2023
   218                                  _2:
   219 0000013E E87704                  	call	check4keyboardstop  ; flush keyboard buffer
   220 00000141 73FB                    	jnc	short _2 
   221                                  
   222                                  	; 03/11/2023
   223 00000143 E85B07                  	call	ich_init
   224                                  	;
   225                                  	; 17/02/2017
   226                                  	;mov	dx, [stats_cmd]
   227                                          ;or	dl, IO_ENA+BM_ENA               ; enable IO and bus master
   228                                          ;call	pciRegWrite16 ; pciRegWrite8
   229                                  
   230                                  	; 04/11/2023
   231                                  	; 03/11/2023
   232                                  ; setup the Codec (actually mixer registers) 
   233 00000146 E8D501                          call    codecConfig                     ; unmute codec, set rates.
   234                                  
   235                                  ; position file pointer to start in actual wav data
   236                                  ; MUCH improvement should really be done here to check if sample size is
   237                                  ; supported, make sure there are 2 channels, etc.  
   238                                  
   239 00000149 B442                            mov     ah, 42h
   240 0000014B B000                            mov     al, 0                           ; from start of file
   241 0000014D 8B1E[4C0A]                      mov     bx, [filehandle]
   242 00000151 31C9                            xor     cx, cx
   243 00000153 BA2C00                          mov     dx, 44                          ; jump past .wav/riff header
   244 00000156 CD21                            int     21h
   245                                  
   246                                  ; play the .wav file. Most of the good stuff is in here.
   247                                  
   248 00000158 E87D02                          call    playWav
   249                                  
   250                                  ; close the .wav file and exit.
   251                                  
   252 0000015B E84A00                          call    closeFile
   253                                  
   254                                  exit:
   255 0000015E B8004C                          mov     ax, 4c00h
   256 00000161 CD21                    	int 	21h
   257                                  
   258                                  here:
   259 00000163 EBFE                    	jmp	short here
   260                                  
   261                                  ; MEMALLOC.ASM
   262                                  ;-- SETFREE: Release memory not used  ----------------
   263                                  ;-- Input    : ES = address of PSP
   264                                  ;-- Output   : none
   265                                  ;-- Register : AX, BX, CL and FLAGS are changed 
   266                                  ;-- Info     : Since the stack-segment is always the last segment in an 
   267                                  ;              EXE-file, ES:0000 points to the beginning and SS:SP
   268                                  ;              to the end of the program in memory. Through this the
   269                                  ;              length of the program can be calculated 
   270                                  ; call this routine once at the beginning of the program to free up memory
   271                                  ; assigned to it by DOS.
   272                                  
   273                                  setFree:
   274 00000165 BB0010                  	  mov	bx, 65536/16	; 4K paragraphs ; 17/02/2017 (Erdogan Tan)		
   275                                  
   276 00000168 B44A                              mov	ah, 4Ah		; pass new length to DOS
   277 0000016A CD21                              int	21h
   278                                  
   279 0000016C C3                                retn			; back to caller 
   280                                  				; new size (allocated memory) = 64KB
   281                                  
   282                                  memAlloc:
   283                                  ; input: AX = # of paragraphs required
   284                                  ; output: AX = segment of block to use
   285                                  
   286 0000016D 53                      	push	bx
   287 0000016E 89C3                    	mov	bx, ax
   288 00000170 B448                    	mov	ah, 48h
   289 00000172 CD21                    	int	21h
   290 00000174 5B                      	pop	bx
   291 00000175 C3                      	retn
   292                                  
   293                                  ; CMDLINE.ASM
   294                                  ; parse the command line
   295                                  ; entry: none
   296                                  ; exit: DS:DX to the 1st supplied item on the command line 
   297                                  
   298                                  processCmdline:
   299 00000176 53                              push    bx
   300 00000177 56                              push    si
   301                                  
   302                                          ;mov    ah, 51h
   303                                          ;int    21h
   304                                          ;mov    ds, bx
   305                                  
   306 00000178 BE8000                          mov     si, 80h
   307 0000017B 0FB61C                          movzx   bx, byte [si]
   308 0000017E 01DE                            add     si, bx
   309 00000180 46                              inc     si
   310                                  
   311 00000181 C60400                          mov     byte [si], NULL         ; zero terminate
   312                                  
   313 00000184 BE8100                          mov     si, 81h
   314                                  
   315                                  cmdlineloop:
   316 00000187 AC                              lodsb
   317                                  
   318 00000188 3C00                            cmp     al, NULL                ; found end of line?
   319 0000018A 7404                            je      short exitpc
   320 0000018C 3C20                            cmp     al, ' '                 ; found a space?
   321 0000018E 74F7                            je      short cmdlineloop
   322                                  
   323                                          ; must be the filename here.
   324                                  exitpc:
   325 00000190 4E                              dec     si                      ; point to start of filename
   326 00000191 89F2                            mov     dx, si
   327 00000193 5E                              pop     si
   328 00000194 5B                              pop     bx
   329 00000195 C3                      	retn
   330                                  
   331                                  ; FILE.ASM
   332                                  ;open or create file
   333                                  ;
   334                                  ;input: ds:dx-->filename (asciiz)
   335                                  ;       al=file Mode (create or open)
   336                                  ;output: none  cs:[filehandle] filled
   337                                  ;
   338                                  openFile:
   339 00000196 50                      	push	ax
   340 00000197 51                      	push	cx
   341 00000198 B43B                    	mov	ah, 3bh			; start with a mode
   342 0000019A 00C4                    	add	ah, al			; add in create or open mode
   343 0000019C 31C9                    	xor	cx, cx
   344 0000019E CD21                    	int	21h
   345 000001A0 7203                    	jc	short _of1
   346                                  	;mov	[cs:filehandle], ax
   347 000001A2 A3[4C0A]                	mov	[filehandle], ax
   348                                  _of1:
   349 000001A5 59                      	pop	cx
   350 000001A6 58                      	pop	ax
   351 000001A7 C3                      	retn
   352                                  
   353                                  ; close the currently open file
   354                                  ; input: none, uses cs:[filehandle]
   355                                  closeFile:
   356 000001A8 50                      	push	ax
   357 000001A9 53                      	push	bx
   358 000001AA 833E[4C0A]FF            	cmp	word [filehandle], -1
   359 000001AF 7409                    	jz	short _cf1
   360 000001B1 8B1E[4C0A]              	mov     bx, [filehandle]  
   361 000001B5 B8003E                  	mov     ax,3e00h
   362 000001B8 CD21                            int     21h              ;close file
   363                                  _cf1:
   364 000001BA 5B                      	pop	bx
   365 000001BB 58                      	pop	ax
   366 000001BC C3                      	retn
   367                                  
   368                                  getSampleRate:
   369                                  	; 08/12/2016
   370                                  ; reads the sample rate from the .wav file.
   371                                  ; entry: none - assumes file is already open
   372                                  	; 19/11/2016 - Erdogan Tan
   373                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   374                                  ;	cx = number of channels (mono=1, stereo=2)
   375                                  ;	dx = bits per sample (8, 16)
   376                                  
   377 000001BD 53                      	push    bx
   378                                  
   379 000001BE B442                            mov     ah, 42h
   380 000001C0 B000                            mov     al, 0				; from start of file
   381 000001C2 8B1E[4C0A]                      mov     bx, [filehandle]
   382 000001C6 31C9                            xor     cx, cx
   383 000001C8 BA0800                          mov     dx, 08h				; "WAVE"
   384 000001CB CD21                            int     21h
   385                                  
   386 000001CD BA[300A]                        mov     dx, smpRBuff
   387 000001D0 B91C00                          mov     cx, 28				; 28 bytes
   388 000001D3 B43F                    	mov	ah, 3fh
   389 000001D5 CD21                            int     21h
   390                                  
   391 000001D7 813E[300A]5741          	cmp	word [smpRBuff], 'WA'
   392 000001DD 751C                    	jne	short gsr_stc
   393                                  
   394 000001DF 813E[320A]5645          	cmp	word [smpRBuff+2], 'VE'
   395 000001E5 7514                    	jne	short gsr_stc
   396                                  
   397 000001E7 833E[3C0A]01            	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   398 000001EC 750D                    	jne	short gsr_stc
   399                                  
   400                                  
   401 000001EE 8B0E[3E0A]              	mov	cx, [smpRBuff+14]	; return num of channels in CX
   402 000001F2 A1[400A]                        mov     ax, [smpRBuff+16]	; return sample rate in AX
   403 000001F5 8B16[4A0A]              	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   404                                  gsr_retn:
   405 000001F9 5B                              pop     bx
   406 000001FA C3                              retn
   407                                  
   408                                  gsr_stc:
   409 000001FB F9                      	stc
   410 000001FC EBFB                    	jmp	short gsr_retn
   411                                  
   412                                  %include 'ac97.asm' ; 29/11/2016 (AC97 codec configuration)
     1                              <1> ; 04/11/2023
     2                              <1> ; 03/11/2023
     3                              <1> ; PCI and AC97 codec functions for wav player
     4                              <1> ; Erdogan Tan (17/02/2017)
     5                              <1>  
     6                              <1> ; ----------------------------------------------------------------------------
     7                              <1> ; PCI.ASM
     8                              <1> ; ----------------------------------------------------------------------------
     9                              <1> 
    10                              <1> ; PCI device register reader/writers.
    11                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    12                              <1> ; 		Last Update: 17/02/2017
    13                              <1> 
    14                              <1> ;===============================================================
    15                              <1> ; 8/16/32bit PCI reader
    16                              <1> ;
    17                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    18                              <1> ;           BIT30 set if 32 bit access requested
    19                              <1> ;           BIT29 set if 16 bit access requested
    20                              <1> ;           otherwise defaults to 8bit read
    21                              <1> ;
    22                              <1> ; Exit:  DL,DX,EDX register data depending on requested read size
    23                              <1> ;
    24                              <1> ; Note: this routine is meant to be called via pciRegRead8, pciRegread16,
    25                              <1> ;	or pciRegRead32, listed below.
    26                              <1> ;
    27                              <1> ; Note2: don't attempt to read 32bits of data from a non dword aligned reg
    28                              <1> ;	 number.  Likewise, don't do 16bit reads from non word aligned reg #
    29                              <1> ; 
    30                              <1> pciRegRead:
    31 000001FE 6653                <1> 	push	ebx
    32 00000200 51                  <1> 	push	cx
    33 00000201 6689C3              <1>         mov     ebx, eax                        ; save eax, dh
    34 00000204 88F1                <1>         mov     cl, dh
    35 00000206 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    36 0000020C 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
    37 00000212 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
    38                              <1> 
    39 00000214 BAF80C              <1>         mov     dx, PCI_INDEX_PORT
    40 00000217 66EF                <1>         out     dx, eax                         ; write PCI selector
    41                              <1> 
    42 00000219 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
    43 0000021C 88D8                <1>         mov     al, bl
    44 0000021E 2403                <1>         and     al, 3                           ; figure out which port to
    45 00000220 00C2                <1>         add     dl, al                          ; read to
    46                              <1> 
    47 00000222 66ED                <1> 	in      eax, dx                         ; do 32bit read
    48 00000224 66F7C300000080      <1>         test    ebx, PCI32
    49 0000022B 7403                <1>         jz      short _pregr1
    50                              <1> 
    51 0000022D 6689C2              <1>         mov     edx, eax                        ; return 32bits of data
    52                              <1> _pregr1:
    53 00000230 89C2                <1> 	mov     dx, ax                          ; return 16bits of data
    54 00000232 66F7C3000000C0      <1>         test    ebx, PCI32+PCI16
    55 00000239 7502                <1>         jnz     short _pregr2
    56 0000023B 88CE                <1>         mov     dh, cl                          ; restore dh for 8 bit read
    57                              <1> _pregr2:
    58 0000023D 6689D8              <1>         mov     eax, ebx                        ; restore eax
    59 00000240 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    60 00000246 59                  <1> 	pop	cx
    61 00000247 665B                <1> 	pop	ebx
    62 00000249 C3                  <1> 	retn
    63                              <1> 
    64                              <1> pciRegRead8:
    65 0000024A 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32             ; set up 8 bit read size
    66 00000250 EBAC                <1>         jmp     short pciRegRead		; call generic PCI access
    67                              <1> 
    68                              <1> pciRegRead16:
    69 00000252 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit read size
    70 00000258 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
    71 0000025E EB9E                <1>         jmp     short pciRegRead
    72                              <1> 
    73                              <1> pciRegRead32:
    74 00000260 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit read size
    75 00000266 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
    76 0000026C EB90                <1>         jmp     short pciRegRead
    77                              <1> 
    78                              <1> ;===============================================================
    79                              <1> ; 8/16/32bit PCI writer
    80                              <1> ;
    81                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    82                              <1> ;           BIT31 set if 32 bit access requested
    83                              <1> ;           BIT30 set if 16 bit access requested
    84                              <1> ;           otherwise defaults to 8bit read
    85                              <1> ;        DL/DX/EDX data to write depending on size
    86                              <1> ;
    87                              <1> ;
    88                              <1> ; note: this routine is meant to be called via pciRegWrite8, pciRegWrite16,
    89                              <1> ; 	or pciRegWrite32 as detailed below.
    90                              <1> ;
    91                              <1> ; Note2: don't attempt to write 32bits of data from a non dword aligned reg
    92                              <1> ;	 number. Likewise, don't do 16bit writes from non word aligned reg #
    93                              <1> ;
    94                              <1> pciRegWrite:
    95 0000026E 6653                <1> 	push	ebx
    96 00000270 51                  <1> 	push	cx
    97 00000271 6689C3              <1>         mov     ebx, eax                        ; save eax, dx
    98 00000274 89D1                <1>         mov     cx, dx
    99 00000276 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
   100 0000027C 6625FFFFFFBF        <1>         and     eax, ~PCI16 ; NOT PCI16         ; clear out data size request
   101 00000282 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
   102                              <1> 
   103 00000284 BAF80C              <1>         mov     dx, PCI_INDEX_PORT
   104 00000287 66EF                <1>         out     dx, eax                         ; write PCI selector
   105                              <1> 
   106 00000289 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
   107 0000028C 88D8                <1>         mov     al, bl
   108 0000028E 2403                <1>         and     al, 3                           ; figure out which port to
   109 00000290 00C2                <1>         add     dl, al                          ; write to
   110                              <1> 
   111 00000292 6689D0              <1>         mov     eax, edx                        ; put data into eax
   112 00000295 89C8                <1>         mov     ax, cx
   113                              <1> 
   114 00000297 EE                  <1>         out     dx, al
   115 00000298 66F7C3000000C0      <1>         test    ebx, PCI16+PCI32                ; only 8bit access? bail
   116 0000029F 740C                <1>         jz      short _pregw1
   117                              <1> 
   118 000002A1 EF                  <1>         out     dx, ax                          ; write 16 bit value
   119 000002A2 66F7C300000040      <1>         test    ebx, PCI16                      ; 16bit requested?  bail
   120 000002A9 7502                <1>         jnz     short _pregw1
   121                              <1> 
   122 000002AB 66EF                <1>         out     dx, eax                         ; write full 32bit
   123                              <1> _pregw1:
   124 000002AD 6689D8              <1>         mov     eax, ebx                        ; restore eax
   125 000002B0 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
   126 000002B6 89CA                <1>         mov     dx, cx                          ; restore dx
   127 000002B8 59                  <1> 	pop	cx
   128 000002B9 665B                <1> 	pop	ebx
   129 000002BB C3                  <1> 	ret
   130                              <1> 
   131                              <1> pciRegWrite8:
   132 000002BC 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 8 bit write size
   133 000002C2 EBAA                <1>         jmp     short pciRegWrite		; call generic PCI access
   134                              <1> 
   135                              <1> pciRegWrite16:
   136 000002C4 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit write size
   137 000002CA 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
   138 000002D0 EB9C                <1>         jmp     short pciRegWrite
   139                              <1> 
   140                              <1> pciRegWrite32:
   141 000002D2 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit write size
   142 000002D8 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
   143 000002DE EB8E                <1>         jmp     short pciRegWrite
   144                              <1> 
   145                              <1> ; 17/02/2017 (Modifed by Erdogan Tan for various ICH device IDs)
   146                              <1> ;===============================================================
   147                              <1> ; PCIFindDevice: scan through PCI space looking for a device+vendor ID
   148                              <1> ;
   149                              <1> ;  ENTRY: none
   150                              <1> ;; Entry: EAX=Device+Vendor ID
   151                              <1> ;
   152                              <1> ;  Exit: EAX=PCI address if device found
   153                              <1> ;	 EDX=Device+Vendor ID
   154                              <1> ;        CY clear if found, set if not found. EAX invalid if CY set.
   155                              <1> ;
   156                              <1> ; [old stackless] Destroys: ebx, esi, edi, cl
   157                              <1> 
   158                              <1> 	; 04/11/2023
   159                              <1> pciFindDevice:
   160                              <1> 	;push	cx
   161                              <1> 	;push	eax ; *
   162                              <1> 	;push	esi
   163                              <1> 	;push	edi
   164                              <1> 
   165                              <1>  	;mov     esi, eax                ; save off vend+device ID
   166                              <1> 
   167                              <1> 	; 17/02/2017
   168 000002E0 BE[F408]            <1> 	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
   169 000002E3 B95400              <1> 	mov	cx, valid_id_count
   170                              <1> pfd_0:
   171 000002E6 66BF00FFFF7F        <1>        	mov     edi, (80000000h - 100h) ; start with bus 0, dev 0 func 0
   172                              <1> nextPCIdevice:
   173 000002EC 6681C700010000      <1>         add     edi, 100h
   174 000002F3 6681FF00F8FF80      <1>         cmp     edi, 80FFF800h		; scanned all devices?
   175                              <1>         ;stc
   176                              <1>         ;je 	short PCIScanExit       ; not found
   177 000002FA 720D                <1> 	jb	short pfd_1
   178 000002FC 66BF00000080        <1> 	mov     edi, 80000000h
   179 00000302 83C604              <1> 	add	si, 4 ; scan for next device ID
   180 00000305 E202                <1> 	loop	pfd_1	 
   181 00000307 F9                  <1> 	stc	
   182                              <1> 	;jmp 	short PCIScanExit
   183 00000308 C3                  <1> 	retn
   184                              <1> pfd_1:
   185 00000309 6689F8              <1>         mov     eax, edi                ; read PCI registers
   186 0000030C E851FF              <1>         call    pciRegRead32
   187                              <1>         ;cmp    edx, esi                ; found device?
   188 0000030F 663B14              <1>         cmp	edx, dword [si]
   189 00000312 75D8                <1> 	jne     short nextPCIdevice
   190                              <1>         ;clc
   191                              <1> PCIScanExit:
   192                              <1> 	;pushf
   193                              <1> 	;mov	eax, BIT31
   194                              <1> 	;not	eax
   195                              <1> 	; 04/11/2023
   196 00000314 66B8FFFFFF7F        <1> 	mov	eax, ~BIT31
   197 0000031A 6621F8              <1> 	and	eax, edi		; return only bus/dev/fn #
   198                              <1> 	;popf
   199                              <1> 
   200                              <1> 	;pop	edi
   201                              <1> 	;pop	esi
   202                              <1> 	;pop	edx ; *
   203                              <1> 	;pop	cx
   204 0000031D C3                  <1> 	retn
   205                              <1> 
   206                              <1> ; ----------------------------------------------------------------------------
   207                              <1> ; CODEC.ASM
   208                              <1> ; ----------------------------------------------------------------------------
   209                              <1> 
   210                              <1> ; codec configuration code. Not much here really.
   211                              <1> ; NASM version: Erdogan Tan (29/11/2016)
   212                              <1> 
   213                              <1> ; enable codec, unmute stuff, set output rate to 44.1
   214                              <1> ; entry: ax = desired sample rate
   215                              <1> 
   216                              <1> codecConfig:
   217                              <1> 	; 04/11/2023
   218                              <1> 	; 17/02/2017 
   219                              <1> 	; 07/11/2016 (Erdogan Tan)
   220                              <1> 	;PORT_NABM_GLB_CTRL_STAT equ 60h
   221                              <1> 
   222                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   223                              <1>  	; 'AC97_DEF.H'
   224                              <1> 	;AC97_EXTENDED_STATUS equ 002Ah
   225                              <1> 	AC97_EA_SPDIF	equ 0002h
   226                              <1> 	AC97_EA_VRA	equ 0001h
   227                              <1> 	; 04/11/2023
   228                              <1> 	ICH_PO_CR_RESET equ 0002h  ; reset codec
   229                              <1> 	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
   230                              <1> 
   231                              <1> 	; 04/11/2023
   232                              <1> init_ac97_controller:
   233 0000031E 66A1[620A]          <1> 	mov	eax, [bus_dev_fn]
   234 00000322 B004                <1> 	mov	al, PCI_CMD_REG
   235 00000324 E82BFF              <1> 	call	pciRegRead16		; read PCI command register
   236 00000327 80CA05              <1> 	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
   237 0000032A E897FF              <1> 	call	pciRegWrite16
   238                              <1> 
   239                              <1> delay_100ms:
   240                              <1> 	; 29/05/2017
   241                              <1> 	; 24/03/2017 ('codec.asm')
   242                              <1> 	; wait 100 ms
   243 0000032D 66B990010000        <1> 	mov	ecx, 400  ; 400*0.25ms
   244                              <1> _delay_x_ms:
   245 00000333 E88F02              <1> 	call	delay1_4ms
   246 00000336 E2FB                <1>         loop	_delay_x_ms
   247                              <1> 
   248                              <1> init_ac97_codec:
   249                              <1> 	; 04/11/2023
   250                              <1> 	; reset codec
   251 00000338 8B16[580A]          <1> 	mov     dx, [NABMBAR]
   252 0000033C 83C21B              <1> 	add	dx, PO_CR_REG
   253 0000033F EC                  <1> 	in	al, dx
   254 00000340 0C02                <1> 	or	al, ICH_PO_CR_RESET
   255 00000342 EE                  <1> 	out	dx, al
   256                              <1> 
   257 00000343 E87F02              <1> 	call	delay1_4ms
   258                              <1> 
   259                              <1> 	; set channels (2) and bits (16/32)
   260 00000346 8B16[580A]          <1> 	mov     dx, [NABMBAR]
   261 0000034A 83C22C              <1> 	add	dx, GLOB_CNT_REG
   262 0000034D 66ED                <1> 	in	eax, dx
   263 0000034F 6625FFFF8FFF        <1> 	and	eax, ~(ICH_PCM_246_MASK | ICH_PCM_20BIT)
   264 00000355 66EF                <1> 	out	dx, eax
   265                              <1> 
   266 00000357 8B16[560A]          <1> 	mov	dx, [NAMBAR]
   267                              <1> 	;add	dx, 0 ; ac_reg_0 ; reset register
   268 0000035B EF                  <1> 	out	dx, ax
   269                              <1> 
   270 0000035C 6631C0              <1> 	xor	eax, eax ; 0
   271 0000035F 8B16[560A]          <1> 	mov	dx, [NAMBAR]
   272 00000363 83C226              <1> 	add	dx, CODEC_POWER_CTRL_REG ; CODEC_REG_POWERDOWN
   273 00000366 EF                  <1> 	out	dx, ax
   274                              <1> 
   275                              <1> 	; wait for (max.) 1 second
   276 00000367 B9E803              <1> 	mov	cx, 1000 ; 100*0.25ms = 1s
   277                              <1> _ac97_codec_rloop:
   278 0000036A E85802              <1> 	call	delay1_4ms
   279 0000036D E85502              <1> 	call	delay1_4ms
   280 00000370 E85202              <1> 	call	delay1_4ms
   281 00000373 E84F02              <1> 	call	delay1_4ms
   282                              <1> 	;mov	dx, [NAMBAR]
   283                              <1> 	;add	dx, CODEC_POWER_CTRL_REG ; CODEC_REG_POWERDOWN
   284 00000376 ED                  <1> 	in	ax, dx	
   285 00000377 83E00F              <1> 	and	ax, 0Fh
   286 0000037A 3C0F                <1> 	cmp	al, 0Fh
   287 0000037C 7402                <1> 	je	short _ac97_codec_init_ok
   288 0000037E E2EA                <1> 	loop	_ac97_codec_rloop 
   289                              <1> 
   290                              <1> _ac97_codec_init_ok:
   291                              <1> reset_ac97_controller:
   292                              <1> 	; 04/11/2023
   293 00000380 31C0                <1> 	xor     ax, ax
   294 00000382 BA0B00              <1>         mov	dx, PI_CR_REG
   295 00000385 0316[580A]          <1> 	add	dx, [NABMBAR]
   296 00000389 EE                  <1> 	out     dx, al
   297                              <1> 
   298 0000038A BA1B00              <1>         mov     dx, PO_CR_REG
   299 0000038D 0316[580A]          <1> 	add	dx, [NABMBAR]
   300 00000391 EE                  <1> 	out     dx, al
   301                              <1> 
   302 00000392 BA2B00              <1>         mov     dx, MC_CR_REG
   303 00000395 0316[580A]          <1> 	add	dx, [NABMBAR]
   304 00000399 EE                  <1> 	out     dx, al
   305                              <1> 
   306 0000039A B002                <1>         mov     al, RR
   307 0000039C BA0B00              <1>         mov     dx, PI_CR_REG
   308 0000039F 0316[580A]          <1> 	add	dx, [NABMBAR]
   309 000003A3 EE                  <1> 	out     dx, al
   310                              <1> 
   311 000003A4 BA1B00              <1>         mov     dx, PO_CR_REG
   312 000003A7 0316[580A]          <1> 	add	dx, [NABMBAR]
   313 000003AB EE                  <1> 	out     dx, al
   314                              <1> 
   315 000003AC BA2B00              <1>         mov     dx, MC_CR_REG
   316 000003AF 0316[580A]          <1> 	add	dx, [NABMBAR]
   317 000003B3 EE                  <1> 	out     dx, al
   318                              <1> 
   319                              <1> setup_ac97_codec:
   320                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   321                              <1> 	; initial ac97 volumes (and clear mute flag)
   322                              <1> 		
   323 000003B4 8B16[560A]          <1>   	mov     dx, [NAMBAR]
   324 000003B8 83C202              <1>   	add     dx, CODEC_MASTER_VOL_REG        ;02h ; STEREO
   325                              <1>   	;xor	ax, ax ; volume attenuation = 0 (max. volume)
   326                              <1>   	; 03/11/2023
   327 000003BB B80202              <1> 	mov	ax, 0202h
   328 000003BE EF                  <1> 	out     dx, ax
   329                              <1>  
   330 000003BF 8B16[560A]          <1>   	mov     dx, [NAMBAR]
   331 000003C3 83C206              <1>   	add     dx, CODEC_MASTER_MONO_VOL_REG   ;06h 
   332                              <1>   	;;xor	ax, ax
   333                              <1> 	;mov	ax, 0202h
   334 000003C6 EF                  <1>   	out     dx, ax
   335                              <1> 
   336 000003C7 8B16[560A]          <1>   	mov     dx, [NAMBAR]
   337 000003CB 83C20A              <1>   	add     dx, CODEC_PCBEEP_VOL_REG        ;0Ah 
   338                              <1>   	;;xor	ax, ax
   339                              <1>   	;mov	ax, 0202h
   340 000003CE EF                  <1> 	out     dx, ax
   341                              <1> 
   342 000003CF 8B16[560A]          <1>   	mov     dx, [NAMBAR]
   343 000003D3 83C218              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h
   344                              <1>   	;;xor	ax, ax
   345                              <1> 	;mov	ax, 0202h
   346 000003D6 EF                  <1>   	out     dx, ax
   347                              <1> 
   348                              <1> 	;mov	ax, 8008h ; Mute
   349                              <1>   	;mov	dx, [NAMBAR]
   350                              <1> 	;add	dx, CODEC_PHONE_VOL_REG		;0Ch
   351                              <1> 	;			 ; AC97_PHONE_VOL ; TAD Input (Mono)
   352                              <1>   	;out	dx, ax
   353                              <1> 	;
   354                              <1>         ;mov	ax, 0808h
   355                              <1>   	;mov	dx, [NAMBAR]
   356                              <1>         ;add	dx, CODEC_LINE_IN_VOL_REG ;10h ; Line Input (Stereo)
   357                              <1>   	;out	dx, ax
   358                              <1> 	;
   359                              <1> 	;;mov	ax, 0808h
   360                              <1>   	;mov	dx, [NAMBAR]
   361                              <1>         ;add	dx, CODEC_CD_VOL_REG ;12h ; CR Input (Stereo)
   362                              <1>   	;out	dx, ax
   363                              <1> 	;
   364                              <1> 	;;mov	ax, 0808h
   365                              <1>   	;mov	dx, [NAMBAR]
   366                              <1>         ;add	dx, CODEC_AUX_VOL_REG ;16h ; Aux Input (Stereo)
   367                              <1>   	;out	dx, ax
   368                              <1> 
   369                              <1> 	; 03/11/2023
   370                              <1>         ;call	delay1_4ms
   371                              <1>         ;call	delay1_4ms
   372                              <1>         ;call	delay1_4ms
   373                              <1> 	;call	delay1_4ms
   374                              <1> 
   375 000003D7 C3                  <1> 	retn
   376                              <1> 
   377                              <1> ; 03/11/2023
   378                              <1> %if 0   
   379                              <1> 	mov	cx, AC97_EA_SPDIF		; S/PDIF Enable bit
   380                              <1> 	; set variable bit rate bit
   381                              <1> 	cmp	word [sample_rate], 48000
   382                              <1> 	je	short cconf_0
   383                              <1> 	or	cl, AC97_EA_VRA			; Enable variable rate
   384                              <1> cconf_0:
   385                              <1> 	mov    	dx, [NAMBAR]               	
   386                              <1> 	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah  	  
   387                              <1> 	in     	ax, dx
   388                              <1> 	;or	ax, AC97_EA_SPDIF ; 2
   389                              <1> 	or	ax, cx ; 03/11/2023
   390                              <1> 	out	dx, ax 				; Enable S/PDIF & VRA
   391                              <1> 
   392                              <1> 	cmp	word [sample_rate], 48000
   393                              <1> 	je	short cconf_1
   394                              <1> 
   395                              <1> 	;mov    dx, [NAMBAR]               	; mixer base address
   396                              <1> 	;add	dx, CODEC_EXT_AUDIO_REG	       	; 28h  	  
   397                              <1> 	;in	ax, dx
   398                              <1> 	;and	ax, 1
   399                              <1> 	;jnz	short _ssr
   400                              <1> 	;jmp	short cconf_1
   401                              <1> ;_ssr:
   402                              <1> 	mov    	dx, [NAMBAR]               	
   403                              <1> 	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah  	  
   404                              <1> 	in     	ax, dx
   405                              <1> 	or	ax, 1
   406                              <1> 	out	dx, ax 				; Enable variable rate audio
   407                              <1> 
   408                              <1>         call    delay1_4ms
   409                              <1>         call    delay1_4ms
   410                              <1>         call    delay1_4ms
   411                              <1>         call    delay1_4ms
   412                              <1> 
   413                              <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   414                              <1> 
   415                              <1> 	mov    	dx, [NAMBAR]               	
   416                              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   417                              <1> 	out	dx, ax 				; out sample rate
   418                              <1> 		
   419                              <1> 	;mov    dx, [NAMBAR]               	
   420                              <1> 	;add    dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   421                              <1> 	;out	dx, ax
   422                              <1> 
   423                              <1>         call    delay1_4ms
   424                              <1>         call    delay1_4ms
   425                              <1>         call    delay1_4ms
   426                              <1>         call    delay1_4ms
   427                              <1> 
   428                              <1> ;cconf_1:
   429                              <1> 	mov     dx, [NAMBAR]			; mixer base address
   430                              <1>         add     dx, CODEC_RESET_REG  		; reset register
   431                              <1>         mov	ax, 42
   432                              <1> 	out     dx, ax                          ; reset
   433                              <1> 
   434                              <1> 	mov     dx, [NABMBAR]			; bus master base address
   435                              <1>         add     dx, PORT_NABM_GLB_CTRL_STAT
   436                              <1>         mov	ax, 2
   437                              <1> 	out     dx, ax                         
   438                              <1> 
   439                              <1> 	mov	cx, 7
   440                              <1> _100ms:
   441                              <1>         call    delay1_4ms
   442                              <1>         call    delay1_4ms
   443                              <1>         call    delay1_4ms
   444                              <1>         call    delay1_4ms
   445                              <1> 	loop	_100ms
   446                              <1>         retn
   447                              <1> 
   448                              <1> cconf_1:
   449                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', prepare_playback)
   450                              <1> 	;ICH_PO_SR_REG	equ 0016h  ; PCM out status register
   451                              <1> 	;ICH_PO_CR_REG  equ 001Bh  ; PCM out control Register
   452                              <1> 	ICH_PO_SR_DCH	equ 0001h  ; DMA controller halted
   453                              <1> 	ICH_PO_CR_RESET equ 0002h  ; reset codec
   454                              <1> 	;ICH_GLOB_CNT_REG equ 002Ch ; Global control register
   455                              <1> 	;ICH_PCM_246_MASK equ 300000h ; 6 channels
   456                              <1> 	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
   457                              <1> 	ICH_SAMPLE_CAP	equ 0C00000h ; ICH4 sample capability
   458                              <1> 	AC97_SPDIF_CONTROL equ 003Ah ; S/PDIF Control
   459                              <1> 	AC97_SC_SPSR_MASK equ 0CFFFh ; S/PDIF Sample Rate bits
   460                              <1> 	;AC97_SC_SPSR_44K  equ 0    ; Use 44.1kHz Sample rate */
   461                              <1> 	AC97_SC_SPSR_48K  equ 2000h ; Use 48kHz Sample rate */
   462                              <1> 	AC97_SC_SPSR_32K  equ 3000h ; Use 32kHz Sample rate */
   463                              <1> 	
   464                              <1> 	mov	cx, 4
   465                              <1> cconf_2:
   466                              <1> 	; wait until DMA stopped
   467                              <1> 	mov     dx, [NABMBAR]
   468                              <1> 	add	dx, PO_SR_REG
   469                              <1> 	in	al, dx
   470                              <1> 	test	al, ICH_PO_SR_DCH
   471                              <1> 	jnz	short cconf_3
   472                              <1>         call    delay1_4ms
   473                              <1> 	loop	cconf_2		
   474                              <1> cconf_3:
   475                              <1> 	; reset codec
   476                              <1> 	mov     dx, [NABMBAR]
   477                              <1> 	add	dx, PO_CR_REG
   478                              <1> 	in	al, dx
   479                              <1> 	or	al, ICH_PO_CR_RESET
   480                              <1> 	out	dx, al
   481                              <1> 
   482                              <1> 	call	delay1_4ms
   483                              <1> 
   484                              <1> 	; set channels (2) and bits (16/32)
   485                              <1> 	mov     dx, [NABMBAR]
   486                              <1> 	add	dx, GLOB_CNT_REG
   487                              <1> 	in	eax, dx
   488                              <1> 	and	eax,~(ICH_PCM_246_MASK | ICH_PCM_20BIT)
   489                              <1> 	
   490                              <1> 	; 03/11/2023 (ICH4 and 32 bit samples)
   491                              <1> 	;cmp	byte [bps], 16 ; > 16 bit (32 bit)
   492                              <1> 	;jna	short cconf_4
   493                              <1> 	;
   494                              <1> 	;mov	ebx, [dev_vendor]
   495                              <1> 	;shr	ebx, 16
   496                              <1> 	;cmp	bx, ICH4_DID
   497                              <1> 	;jne	short cconf_4
   498                              <1> 	;
   499                              <1> 	;mov	ebx, eax
   500                              <1> 	;mov	dx, [NABMBAR]
   501                              <1> 	;add	dx, GLOB_STS_REG
   502                              <1> 	;in	eax, dx
   503                              <1> 	;and	eax, ICH_SAMPLE_CAP
   504                              <1> 	;cmp	eax, ICH_PCM_20BIT
   505                              <1> 	;jne	short cconf_4
   506                              <1> 	;mov	eax, ebx
   507                              <1> 	;or	eax, ICH_PCM_20BIT
   508                              <1> 	;mov     dx, [NABMBAR]
   509                              <1> 	;add	dx, GLOB_CNT_REG
   510                              <1> cconf_4:
   511                              <1> 	out	dx, eax
   512                              <1> 
   513                              <1> 	; set set spdif frequence
   514                              <1> 	mov	ax, [sample_rate]
   515                              <1> 	xor	ebx, ebx ; AC97_SC_SPSR_44K
   516                              <1> 	cmp	ax, 44100
   517                              <1> 	je	short cconf_5
   518                              <1> 	mov	bx, AC97_SC_SPSR_32K
   519                              <1> 	cmp	ax, 32000
   520                              <1> 	je	short cconf_5
   521                              <1> 	mov	bx, AC97_SC_SPSR_48K ; default 
   522                              <1> cconf_5:
   523                              <1> 	mov	dx, [NAMBAR]
   524                              <1> 	add	dx, AC97_SPDIF_CONTROL	
   525                              <1> 	in	ax, dx
   526                              <1> 	and	ax, AC97_SC_SPSR_MASK
   527                              <1> 	or	eax, ebx
   528                              <1> 	out	dx, ax
   529                              <1> 
   530                              <1> 	call	delay1_4ms
   531                              <1> 	
   532                              <1> 	; set analog ac97 frequence
   533                              <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   534                              <1> 	mov    	dx, [NAMBAR]               	
   535                              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   536                              <1> 	out	dx, ax 			; out sample rate
   537                              <1> 
   538                              <1> 	call	delay1_4ms
   539                              <1>         call	delay1_4ms
   540                              <1>         call	delay1_4ms
   541                              <1>         call	delay1_4ms
   542                              <1> 	
   543                              <1> 	retn
   544                              <1> 
   545                              <1> %endif
   413                                  %include 'ich_wav.asm' ; 17/02/2017 (ICH AC97 wav playing functions)
     1                              <1> ; 04/11/2023
     2                              <1> ; 03/11/2023
     3                              <1> ; DOS based .WAV player using AC'97 and codec interface.
     4                              <1> ; ---------------------------------------------------------------
     5                              <1> ; NASM version: Erdogan Tan (29/11/2016)
     6                              <1> ; Last Update: 17/02/2017 (by Erdogan Tan)
     7                              <1> 
     8                              <1> ; ICHWAV.ASM
     9                              <1> 
    10                              <1> ; player internal variables and other equates.
    11                              <1> BUFFERSIZE      equ     64 * 1024       ; 64k file buffer size.
    12                              <1> ENDOFFILE       equ     BIT0            ; flag for knowing end of file
    13                              <1> 
    14                              <1> ;===========================================================================
    15                              <1> ; entry: none.  File is already open and [filehandle] filled.
    16                              <1> ; exit:  not until the song is finished or the user aborts.
    17                              <1> 
    18                              <1> 	; 04/11/2023
    19                              <1> 	; 03/11/2023
    20                              <1> playWav:
    21                              <1> 	; clear buffer 2
    22 000003D8 06                  <1>         push	es
    23 000003D9 A1[5E0A]            <1> 	mov     ax, [WAV_BUFFER2]
    24 000003DC 8EC0                <1> 	mov	es, ax
    25 000003DE 29C0                <1> 	sub	ax, ax
    26 000003E0 89C7                <1> 	mov	di, ax ; 17/02/2017
    27 000003E2 B90080              <1> 	mov	cx, (BUFFERSIZE/2)
    28 000003E5 F3AB                <1> 	rep	stosw
    29 000003E7 07                  <1> 	pop	es	     
    30                              <1> 	
    31                              <1>        ; load 64k into buffer 1
    32 000003E8 A1[5C0A]            <1>         mov     ax, [WAV_BUFFER1]
    33 000003EB E8E300              <1>         call    loadFromFile
    34                              <1> 
    35                              <1>        ; and 64k into buffer 2
    36 000003EE A1[5E0A]            <1> 	mov     ax, [WAV_BUFFER2]
    37 000003F1 E8DD00              <1>        	call    loadFromFile
    38                              <1> 
    39                              <1> ; register reset the DMA engine. This may cause a pop noise on the output
    40                              <1> ; lines when the device is reset. Prolly a better idea to mute output, then
    41                              <1> ; reset.
    42                              <1> 
    43                              <1> 	; 03/11/2023
    44                              <1>         ;mov	dx, [NABMBAR]
    45                              <1>         ;add	dx, PO_CR_REG		; set pointer to Ctrl reg
    46                              <1>         ;mov	al, RR			; set reset
    47                              <1> 	;out	dx, al			; self clearing bit
    48                              <1> 
    49                              <1> 	; 04/11/2023
    50                              <1> ac97_start_play:
    51                              <1> 	; set output rate
    52                              <1> 	; entry: [audio_freq] = desired sample rate
    53                              <1> 
    54                              <1> 	AC97_EA_VRA equ 0001h
    55                              <1> 		
    56 000003F4 8B16[560A]          <1> 	mov    	dx, [NAMBAR]               	
    57 000003F8 83C22A              <1> 	add    	dx, CODEC_EXT_AUDIO_CTRL_REG	; 2Ah
    58 000003FB ED                  <1> 	in     	ax, dx
    59 000003FC 0C01                <1> 	or	al, AC97_EA_VRA	; 1
    60 000003FE EF                  <1> 	out	dx, ax			; Enable variable bit rate audio
    61                              <1> 
    62                              <1>        ;call    delay1_4ms
    63                              <1>        ;call    delay1_4ms
    64                              <1>        ;call    delay1_4ms
    65                              <1>        ;call    delay1_4ms
    66                              <1> 
    67 000003FF A1[6C0A]            <1> 	mov	ax, [sample_rate]	; audio frequence
    68                              <1> 
    69 00000402 8B16[560A]          <1> 	mov    	dx, [NAMBAR]               	
    70 00000406 83C22C              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
    71 00000409 EF                  <1> 	out	dx, ax 			; out sample rate
    72                              <1> 		
    73                              <1>        ;call    delay1_4ms
    74                              <1>        ;call    delay1_4ms
    75                              <1>        ;call    delay1_4ms
    76                              <1>        ;call    delay1_4ms
    77                              <1> 
    78                              <1> ; register reset the DMA engine. This may cause a pop noise on the output
    79                              <1> ; lines when the device is reset. Prolly a better idea to mute output, then
    80                              <1> ; reset.
    81                              <1> 
    82 0000040A 8B16[580A]          <1> 	mov	dx, [NABMBAR]
    83 0000040E 83C21B              <1>         add	dx, PO_CR_REG                  ; set pointer to Cntl reg
    84 00000411 B002                <1>         mov	al, RR                         ; set reset
    85 00000413 EE                  <1>         out	dx, al                         ; self clearing bit
    86                              <1> 				
    87                              <1> ; write last valid index to 31 to start with.
    88                              <1> ; The Last Valid Index register tells the DMA engine when to stop playing.
    89                              <1> ; 
    90                              <1> ; As we progress through the song we change the last valid index to always be
    91                              <1> ; something other than the index we're currently playing.  
    92                              <1> 
    93                              <1> 	; 03/11/2023
    94                              <1>         ;;mov   al, 1
    95                              <1>         ;mov	al, 31
    96                              <1> 	;call   setLastValidIndex
    97                              <1> 
    98                              <1> ; create Buffer Descriptor List
    99                              <1> ;
   100                              <1> ; A buffer descriptor list is a list of pointers and control bits that the
   101                              <1> ; DMA engine uses to know where to get the .wav data and how to play it.
   102                              <1> ;
   103                              <1> ; I set it up to use only 2 buffers of .wav data, and whenever 1 buffer is
   104                              <1> ; playing, I refresh the other one with good data.
   105                              <1> ;
   106                              <1> ;
   107                              <1> ; For the control bits, you can specify that the DMA engine fire an interrupt
   108                              <1> ; after a buffer has been processed, but I poll the current index register
   109                              <1> ; to know when it's safe to update the other buffer.
   110                              <1> ;
   111                              <1> ; I set the BUP bit, which tells the DMA engine to just play 0's (silence)
   112                              <1> ; if it ever runs out of data to play. Good for safety.
   113                              <1> 
   114                              <1> 	; 04/11/2023
   115                              <1> set_ac97_bdl:
   116                              <1> 
   117 00000414 06                  <1>         push    es
   118 00000415 A1[5A0A]            <1>         mov     ax, [BDL_BUFFER]		; get segment # for BDL
   119 00000418 8EC0                <1>         mov     es, ax
   120                              <1> 
   121 0000041A B91000              <1>         mov     cx, 32 / 2                      ; make 32 entries in BDL
   122 0000041D 31FF                <1>         xor     di, di                          
   123                              <1> _0:
   124                              <1> 
   125                              <1> ; set buffer descriptor 0 to start of data file in memory
   126                              <1> 
   127 0000041F 660FB706[5C0A]      <1>         movzx   eax, word [WAV_BUFFER1]
   128 00000425 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   129 00000429 66AB                <1>         stosd                                   ; store pointer to wavbuffer1
   130                              <1> 
   131                              <1> ; set length to 32k samples. 1 sample is 16bits or 2bytes.
   132                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples.
   133                              <1> 
   134                              <1> ; 17/02/2017 (Erdogan Tan)
   135                              <1> ; Intel 82801AA (ICH) & Intel 82801AB (ICH0) I/O Controller Hub AC 97
   136                              <1> ; Programmers Reference Manual
   137                              <1> 
   138                              <1> ; 2.2.1 Buffer Descriptor List  (on Page 13)
   139                              <1> 	;
   140                              <1> 	;  Generic Form of Buffer Descriptor
   141                              <1> 	;  ---------------------------------
   142                              <1> 	;  63   62    61-48    47-32   31-0
   143                              <1> 	;  ---  ---  --------  ------- -----
   144                              <1> 	;  IOC  BUP -reserved- Buffer  Buffer
   145                              <1> 	;		      Length   Pointer
   146                              <1> 	;		      [15:0]   [31:0]
   147                              <1> 	;
   148                              <1> 	;  IOC:	Interrupt On Completion. 
   149                              <1> 	;	1 = Enabled. 
   150                              <1> 	;	    When this is set, it means that the controller should
   151                              <1> 	;	    issue an interrupt upon completion of this buffer.
   152                              <1> 	;	    It should also set the IOC bit in the status register
   153                              <1> 	;	0 = Disabled	
   154                              <1> 	;
   155                              <1> 	;  BUP: Buffer Underrun Policy.
   156                              <1> 	;       0 = When this buffer is complete,
   157                              <1> 	;	    if the next buffer is not yet ready 
   158                              <1> 	;	    (i.e., the last valid buffer has been processed),
   159                              <1> 	;	    then continue to transmit the last valid sample.
   160                              <1> 	;	1 = When this buffer is complete,
   161                              <1> 	;     	    if this is the last valid buffer, transmit zeros after
   162                              <1> 	;	    this buffer has been processed completely.
   163                              <1> 	;	    This bit typically is set only if this is the last 
   164                              <1> 	;	    buffer in the current stream.
   165                              <1> 	;
   166                              <1> 	; [31:0]: Buffer pointer. This field points to the location of
   167                              <1> 	;	  the data buffer. Since samples can be as wide as one
   168                              <1> 	;	  word, the buffer must be aligned with word boundaries,
   169                              <1> 	;	  to prevent samples from straddling DWord boundaries.
   170                              <1> 	;
   171                              <1> 	; [15:0]: Buffer Length: This is the length of the data buffer,
   172                              <1> 	;	  in number of samples. The controller uses this data
   173                              <1> 	;	  to determine the length of the buffer, in bytes.
   174                              <1> 	;	  "0" indicates no sample to process.
   175                              <1> 
   176                              <1> ; ICH2AC97.INC
   177                              <1> 
   178                              <1> ;	IOC	equ     BIT31   ; Fire an interrupt whenever this
   179                              <1> 				; buffer is complete.
   180                              <1> 
   181                              <1> ;	BUP	equ     BIT30   ; Buffer Underrun Policy.
   182                              <1> 				; if this buffer is the last buffer
   183                              <1> 				; in a playback, fill the remaining
   184                              <1> 				; samples with 0 (silence) or not.
   185                              <1> 				; It's a good idea to set this to 1
   186                              <1> 				; for the last buffer in playback,
   187                              <1> 				; otherwise you're likely to get a lot
   188                              <1> 				; of noise at the end of the sound.
   189                              <1> ;
   190                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   191                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   192                              <1> ; Luckily for us, that's the same format as .wav files.
   193                              <1> ;
   194                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   195                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   196                              <1> ;
   197                              <1> ; A value of 0 in these bits means play no samples.
   198                              <1> 
   199                              <1> ; ICHWAV.ASM
   200                              <1> 
   201 0000042B 66B800800000        <1> 	mov	eax, BUFFERSIZE / 2 ; count of 16 bit samples
   202                              <1> 	; 04/11/2023
   203                              <1> 	;shr	eax, 1	; count of 16 bit samples
   204                              <1> 	;or	eax, IOC + BUP
   205 00000431 660D00000080        <1> 	or	eax, IOC
   206 00000437 66AB                <1> 	stosd
   207                              <1> 
   208                              <1> ; 2nd buffer:
   209                              <1> 
   210 00000439 660FB706[5E0A]      <1>         movzx   eax, word [WAV_BUFFER2]
   211 0000043F 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   212 00000443 66AB                <1>         stosd                                   ; store pointer to wavbuffer2
   213                              <1> 
   214                              <1> ; set length to 64k (32k of two 16 bit samples)
   215                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples
   216                              <1> 
   217 00000445 66B800800000        <1> 	mov	eax, BUFFERSIZE / 2 ; count of 16 bit samples
   218                              <1> 	; 04/11/2023
   219                              <1> 	;shr	eax, 1 ; count of 16 bit samples
   220                              <1> 	;or	eax, IOC + BUP
   221 0000044B 660D00000080        <1> 	or	eax, IOC
   222 00000451 66AB                <1> 	stosd
   223                              <1> 
   224 00000453 E2CA                <1>         loop    _0
   225 00000455 07                  <1>         pop     es
   226                              <1> 
   227                              <1> ; tell the DMA engine where to find our list of Buffer Descriptors.
   228                              <1> ; this 32bit value is a flat mode memory offset (ie no segment:offset)
   229                              <1> ;
   230                              <1> ; write NABMBAR+10h with offset of buffer descriptor list
   231                              <1> 
   232 00000456 660FB706[5A0A]      <1>         movzx   eax, word [BDL_BUFFER]
   233 0000045C 66C1E004            <1> 	shl     eax, 4                          ; convert seg:off to 0:off
   234 00000460 8B16[580A]          <1>         mov     dx, [NABMBAR]
   235 00000464 83C210              <1>         add     dx, PO_BDBAR_REG                ; set pointer to BDL
   236 00000467 66EF                <1>         out     dx, eax                         ; write to AC97 controller
   237                              <1> 
   238                              <1> ; All set. Let's play some music.
   239                              <1> 
   240                              <1> 	; 03/11/2023
   241                              <1> 	; set last index
   242                              <1> 	; 08/12/2016
   243                              <1> 	; 07/10/2016
   244                              <1>         ;mov    al, 1
   245 00000469 B01F                <1>         mov	al, 31	; ICH_DMABUF_PERIODS-1 ; 03/11/2023
   246 0000046B E83801              <1> 	call    setLastValidIndex
   247                              <1> 
   248                              <1> 	; 03/11/2023
   249                              <1> 	; reset current index
   250 0000046E B000                <1> 	mov	al, 0
   251 00000470 E83C01              <1> 	call	setCurrentIndex
   252                              <1> 
   253                              <1> 	;mov	byte [tLoop], 1 ; 30/11/2016
   254                              <1> 	; 04/11/2023
   255 00000473 C606[600A]01        <1> 	mov	byte [audio_play_cmd], 1
   256                              <1> 
   257                              <1> 	; 04/11/2023
   258                              <1> ac97_play:
   259                              <1> 	; 03/11/2023
   260                              <1> 	; 17/02/2017
   261 00000478 8B16[580A]          <1>         mov     dx, [NABMBAR]
   262 0000047C 83C21B              <1>         add     dx, PO_CR_REG   ; PCM out Control Register
   263                              <1>         ;mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
   264                              <1> 				; (LVBI interrupt will not be enabled)
   265                              <1> 	; 03/11/2023
   266 0000047F EC                  <1> 	in	al, dx
   267 00000480 0C11                <1> 	or	al, IOCE + RPBM	
   268 00000482 EE                  <1> 	out     dx, al		; Start bus master operation.
   269                              <1> 
   270                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   271                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   272                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   273                              <1>    
   274                              <1> 	; 08/12/2016
   275                              <1> 	; 28/11/2016
   276                              <1> p_loop:
   277 00000483 E83201              <1> 	call    check4keyboardstop  ; keyboard halt?
   278 00000486 7227                <1>         jc	short r_loop	; no
   279                              <1> 
   280                              <1> 	;mov	byte [tLoop], 0
   281                              <1> 	; 04/11/2023
   282                              <1> 	;mov	byte [audio_play_cmd], 0
   283                              <1> 	;call	ac97_stop
   284                              <1> 	;retn
   285                              <1> _exit_:
   286                              <1> 	; 04/11/2023
   287                              <1> 	; finished with song, stop everything
   288 00000488 E88E03              <1> 	call	ac97_stop
   289                              <1> 	
   290                              <1> 	; restore previous interrupt vector and interrupt_status
   291 0000048B FA                  <1> 	cli
   292 0000048C E4A1                <1> 	in	al, 0A1h ; irq 8-15
   293 0000048E A0[510A]            <1> 	mov	al, [IRQ_status+1]
   294 00000491 E6A1                <1> 	out	0A1h, al 
   295 00000493 E421                <1> 	in	al, 021h ; irq 0-7
   296 00000495 A0[500A]            <1> 	mov	al, [IRQ_status]
   297 00000498 E621                <1> 	out	21h, al 
   298                              <1> 	; ...
   299 0000049A 06                  <1> 	push	es
   300 0000049B 31C0                <1> 	xor	ax, ax
   301 0000049D 8EC0                <1> 	mov	es, ax
   302 0000049F A1[520A]            <1> 	mov	ax, [IRQ_vector]
   303 000004A2 268907              <1> 	mov	[es:bx], ax
   304 000004A5 A1[540A]            <1> 	mov	ax, [IRQ_vector+2]
   305 000004A8 26894702            <1> 	mov	[es:bx+2], ax
   306 000004AC 07                  <1> 	pop	es
   307 000004AD FB                  <1> 	sti
   308                              <1> 	
   309 000004AE C3                  <1> 	retn	
   310                              <1> 	
   311                              <1> r_loop:
   312                              <1> 	; 07/12/2016 - Erdogan Tan
   313 000004AF 90                  <1> 	nop
   314 000004B0 90                  <1> 	nop
   315 000004B1 90                  <1> 	nop
   316                              <1> 	
   317                              <1> 	; 17/02/2017
   318                              <1> 	;mov	al, [tBuff]
   319                              <1> 	;dec	al ; 1-32 -> 0-31 or 0 -> 0FFh
   320                              <1> 	;js	short p_loop
   321                              <1> 	;mov	byte [tBuff], 0 ; reset
   322                              <1> 	; 04/11/2023
   323 000004B2 A0[4F0A]            <1> 	mov	al, [audio_flag]
   324 000004B5 20C0                <1> 	and	al, al
   325                              <1> 	;;jnz	short q_loop 
   326                              <1>         ;jz	short q_loop ; Fill buffer 1 while playing buffer 2
   327 000004B7 74CA                <1> 	jz	short p_loop
   328 000004B9 FEC8                <1> 	dec	al
   329 000004BB 740F                <1> 	jz	short q_loop ; Fill buffer 1 while playing buffer 2	 	
   330                              <1> 
   331                              <1> 	; Fill buffer 2 while playing bUffer 1
   332 000004BD A1[5E0A]            <1> 	mov     ax, [WAV_BUFFER2] ; [tBuff]=2 (from tuneLoop)
   333                              <1> s_loop:
   334 000004C0 E80E00              <1>         call    loadFromFile
   335 000004C3 72C3                <1> 	jc	short _exit_
   336                              <1> 	;jmp	short r_loop
   337                              <1> 	; 04/11/2023
   338 000004C5 C606[4F0A]00        <1> 	mov	byte [audio_flag], 0 ; reset
   339 000004CA EBB7                <1> 	jmp	short p_loop
   340                              <1> q_loop:
   341 000004CC A1[5C0A]            <1>      	mov     ax, [WAV_BUFFER1] ; [tBuff]=1 (from tuneLoop)
   342                              <1>         ;call    loadFromFile
   343                              <1> 	;jc	short _exit_
   344                              <1> 	;;jmp	short r_loop
   345                              <1> 	;; 04/11/2023
   346                              <1> 	;jmp	short p_loop
   347                              <1> 	; 04/11/2023
   348 000004CF EBEF                <1> 	jmp	short s_loop
   349                              <1> 	
   350                              <1> 
   351                              <1> ; 04/11/2023
   352                              <1> %if 0
   353                              <1> 		
   354                              <1> tuneLoop:
   355                              <1> 	; 08/12/2016
   356                              <1> 	; 28/11/2016 - Erdogan Tan
   357                              <1> 	
   358                              <1> 	cmp	byte [tLoop], 1
   359                              <1> 	jb	short _exit
   360                              <1> _tlp_1:	
   361                              <1> 	; 17/02/2017
   362                              <1> 	call	getCurrentIndex
   363                              <1> 	inc	al ; 0-31 -> 1-32
   364                              <1> 	mov	[tBuff], al
   365                              <1> 
   366                              <1> 	; 17/02/2017 - Buffer switch test (temporary)
   367                              <1> 	push	es 
   368                              <1> 	mov	si, 0B800h ; video display page segment
   369                              <1> 	mov	es, si
   370                              <1> 	sub	si, si ; 0
   371                              <1> 	mov	ah, 4Eh
   372                              <1> 	and	al, 1
   373                              <1> 	add	al, '1'
   374                              <1> 	mov	[es:si], ax ; show current play buffer (1, 2)
   375                              <1> 	pop	es
   376                              <1> 
   377                              <1> 	; 17/02/2017
   378                              <1> 
   379                              <1> 	;test	byte [irq_status], LVBCI ; last buff completion intr.
   380                              <1> 	;jz	short _tlp2 ; BCIS ; Buffer completion interrupt
   381                              <1> 
   382                              <1> 	; Last Valid Buffer Completion Interrupt (LVBCI).
   383                              <1> 	;   1 = Last valid buffer has been processed. 
   384                              <1> 	;	It remains active until cleared by software. 
   385                              <1> 	;	This bit indicates the occurrence of the event 
   386                              <1> 	;	signified by the last valid buffer being processed.
   387                              <1> 	;	Thus, this is an event status bit that can be cleared
   388                              <1> 	;	by software once this event has been recognized.
   389                              <1> 	;	This event causes an interrupt if the enable bit
   390                              <1> 	;	in the Control Register is set. The interrupt is
   391                              <1> 	;	cleared when the software clears this bit.
   392                              <1> 	;	In the case of Transmits (PCM out, Modem out) this bit
   393                              <1> 	;	is set, after the last valid buffer has been
   394                              <1> 	;	fetched (not after transmitting it).
   395                              <1> 	;	While in the case of Receives, this bit is set after
   396                              <1> 	;	the data for the last buffer has been written to memory.
   397                              <1> 	;   0 = Cleared by writing a "1" to this bit position.
   398                              <1> 
   399                              <1> 	; Note: We are not using LVBCI 
   400                              <1> 	;     Last Buffer Completion Interrupt !!!
   401                              <1> 
   402                              <1> 	; 17/02/2017
   403                              <1>         ;mov     dx, [NABMBAR]
   404                              <1>         ;add     dx, PO_SR_REG	; PCM out Status register
   405                              <1>         ;mov     al, [irq_status]
   406                              <1>         ;out     dx, al		; Clear (LVBCI) interrupt status
   407                              <1> 	;retn
   408                              <1> 
   409                              <1> ;_tlp2:
   410                              <1> 	; Buffer Completion Interrupt Status (BCIS).
   411                              <1> 	;   1 =	Set by the hardware after the last sample 
   412                              <1> 	; 	of a buffer has been processed, AND if the Interrupt
   413                              <1> 	; 	on Completion (IOC) bit is set in the command byte of 
   414                              <1> 	; 	the buffer descriptor. It remains active
   415                              <1> 	; 	until cleared by software.
   416                              <1> 	;   0 =	Cleared by writing a "1" to this bit position.
   417                              <1> 
   418                              <1> 	; 17/02/2017
   419                              <1>         mov     dx, [NABMBAR]
   420                              <1>         add     dx, PO_SR_REG	; PCM out Status register
   421                              <1>         mov     al, [irq_status]
   422                              <1>         out     dx, al		; Clear (BCI) interrupt status
   423                              <1> 	retn
   424                              <1> 
   425                              <1> _exit_:
   426                              <1> 	;mov	byte [tLoop], 0
   427                              <1> _exit:
   428                              <1>         ;; finished with song, stop everything
   429                              <1> 	;mov	dx, [NABMBAR]		
   430                              <1>         ;add	dx, PO_CR_REG           ; PCM out Control Register
   431                              <1>         ;mov	al, 0
   432                              <1>         ;out	dx, al                  ; stop player
   433                              <1> _return:
   434                              <1> 	retn
   435                              <1> 
   436                              <1> %endif
   437                              <1> 
   438                              <1> ; load data from file in 32k chunks. Would be nice to load 1 64k chunk,
   439                              <1> ; but in DOS you can only load FFFF bytes at a time.
   440                              <1> ;
   441                              <1> ; entry: ax = segment to load data to
   442                              <1> ; exit: CY set if end of file reached.
   443                              <1> ; note: last file buffer is padded with 0's to avoid pops at the end of song.
   444                              <1> ; assumes file is already open. uses [filehandle]
   445                              <1> 
   446                              <1> loadFromFile:
   447                              <1> 	; 03/11/2023
   448                              <1> 	; 17/02/2017
   449 000004D1 50                  <1>         push    ax
   450 000004D2 51                  <1>         push    cx
   451 000004D3 52                  <1>         push    dx
   452 000004D4 53                  <1> 	push	bx
   453                              <1> 	;push	es
   454                              <1> 	;push	ds
   455                              <1> 	
   456 000004D5 F606[4E0A]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
   457                              <1> 	;stc				; last of the file?
   458                              <1> 	;jnz	endLFF
   459                              <1> 	; 03/11/2023
   460 000004DA 7404                <1> 	jz	short lff_12
   461 000004DC F9                  <1> 	stc
   462 000004DD E9A100              <1> 	jmp	endLFF
   463                              <1> lff_12:
   464 000004E0 A3[730A]            <1> 	mov	[fbs_seg], ax ; save buffer segment
   465 000004E3 31D2                <1> 	xor	dx, dx
   466                              <1> lff_0:
   467 000004E5 8916[750A]          <1> 	mov	[fbs_off], dx ; buffer offset
   468                              <1> 
   469 000004E9 BB0080              <1> 	mov     bx, (BUFFERSIZE / 2)	; 32k chunk
   470 000004EC 8A0E[720A]          <1> 	mov	cl, [fbs_shift]   
   471 000004F0 20C9                <1> 	and	cl, cl
   472 000004F2 7407                <1> 	jz	short lff_1 ; stereo, 16 bit	
   473                              <1> 
   474                              <1> 	; fbs_shift =
   475                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   476                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   477 000004F4 D3EB                <1> 	shr	bx, cl ; 32K / multiplier
   478                              <1> 
   479 000004F6 8CC8                <1> 	mov	ax, cs
   480 000004F8 BA[770A]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   481                              <1> lff_1:
   482                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   483                              <1> 	; load file into memory
   484 000004FB 89D9                <1>         mov	cx, bx                         
   485 000004FD 8B1E[4C0A]          <1> 	mov	bx, [filehandle]
   486 00000501 8ED8                <1> 	mov     ds, ax
   487 00000503 B43F                <1>        	mov	ah, 3fh
   488 00000505 CD21                <1> 	int	21h
   489                              <1> 
   490 00000507 8CCB                <1> 	mov	bx, cs
   491 00000509 8EDB                <1> 	mov	ds, bx
   492                              <1> 
   493 0000050B 7267                <1> 	jc	short lff_9 ; error !
   494                              <1> 
   495 0000050D 21C0                <1> 	and	ax, ax
   496 0000050F 7465                <1> 	jz	short lff_10
   497                              <1> 	
   498 00000511 8A1E[720A]          <1> 	mov	bl, [fbs_shift] ; shift count  
   499 00000515 08DB                <1> 	or	bl, bl
   500 00000517 7441                <1> 	jz	short lff_7 ; 16 bit stereo samples
   501                              <1> 
   502 00000519 06                  <1> 	push	es
   503 0000051A 57                  <1> 	push	di
   504 0000051B 56                  <1> 	push	si
   505 0000051C 8B3E[750A]          <1> 	mov	di, [fbs_off]
   506 00000520 8B36[730A]          <1> 	mov	si, [fbs_seg] ; buffer segment
   507 00000524 8EC6                <1> 	mov	es, si
   508 00000526 BE[770A]            <1> 	mov	si, temp_buffer ; temporary buffer address
   509 00000529 8A0E[700A]          <1> 	mov	cl, [bps] ; bits per sample (8 or 16)
   510 0000052D 80F908              <1> 	cmp	cl, 8
   511 00000530 7519                <1> 	jne	short lff_4 ; 16 bit samples
   512                              <1> 	; 8 bit samples
   513 00000532 89C1                <1> 	mov	cx, ax ; byte count
   514 00000534 FECB                <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   515 00000536 740A                <1> 	jz	short lff_3 ; 8 bit, stereo
   516                              <1> lff_2:
   517                              <1> 	; mono & 8 bit
   518 00000538 AC                  <1> 	lodsb
   519 00000539 C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   520 0000053C AB                  <1> 	stosw	; left channel
   521 0000053D AB                  <1> 	stosw	; right channel
   522 0000053E E2F8                <1> 	loop	lff_2
   523 00000540 EB10                <1> 	jmp	short lff_6	
   524                              <1> lff_3:
   525                              <1> 	; stereo & 8 bit
   526 00000542 AC                  <1> 	lodsb
   527 00000543 C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   528 00000546 AB                  <1> 	stosw
   529 00000547 E2F9                <1> 	loop	lff_3			
   530 00000549 EB07                <1> 	jmp	short lff_6
   531                              <1> lff_4:
   532                              <1> 	; 16 bit mono samples
   533 0000054B 89C1                <1> 	mov	cx, ax ; word count
   534                              <1> lff_5:	
   535 0000054D AD                  <1> 	lodsw
   536 0000054E AB                  <1> 	stosw	; left channel
   537 0000054F AB                  <1> 	stosw	; right channel
   538 00000550 E2FB                <1> 	loop	lff_5
   539                              <1> lff_6:
   540 00000552 89F8                <1> 	mov	ax, di ; save next buffer offset/position
   541 00000554 5E                  <1> 	pop	si
   542 00000555 5F                  <1> 	pop	di
   543 00000556 07                  <1> 	pop	es
   544 00000557 B90080              <1> 	mov	cx, (BUFFERSIZE / 2)
   545                              <1> lff_7:        
   546 0000055A 21C0                <1> 	and	ax, ax
   547 0000055C 7423                <1> 	jz	short endLFF ; ; end of 2nd half
   548                              <1> 
   549 0000055E 39C8                <1> 	cmp	ax, cx
   550 00000560 740A                <1> 	je	short lff_8
   551 00000562 7215                <1> 	jb	short lff_11
   552 00000564 31C9                <1> 	xor	cx, cx
   553 00000566 29C1                <1> 	sub	cx, ax
   554 00000568 F7D9                <1> 	neg	cx
   555 0000056A EB0D                <1> 	jmp	short lff_11
   556                              <1> lff_8:
   557 0000056C 89C2                <1> 	mov	dx, ax ; buffer offset
   558 0000056E A1[730A]            <1> 	mov	ax, [fbs_seg] ; buffer segment
   559 00000571 E971FF              <1> 	jmp	lff_0
   560                              <1> lff_9:  
   561 00000574 31C0                <1> 	xor	ax, ax
   562                              <1> lff_10:
   563 00000576 B90080              <1> 	mov	cx, (BUFFERSIZE / 2)  
   564                              <1> lff_11:
   565 00000579 E80A00              <1> 	call    padfill			; blank pad the remainder
   566                              <1>         ;clc				; don't exit with CY yet.
   567 0000057C 800E[4E0A]01        <1>         or	byte [flags], ENDOFFILE	; end of file flag
   568                              <1> endLFF:
   569                              <1>         ;pop	ds
   570                              <1> 	;pop	es
   571 00000581 5B                  <1> 	pop	bx
   572 00000582 5A                  <1> 	pop     dx
   573 00000583 59                  <1>         pop     cx
   574 00000584 58                  <1>         pop     ax
   575 00000585 C3                  <1>         retn
   576                              <1> 
   577                              <1> ; entry ds:ax points to last byte in file
   578                              <1> ; cx=target size
   579                              <1> ; note: must do byte size fill
   580                              <1> ; destroys bx, cx
   581                              <1> ;
   582                              <1> padfill:
   583                              <1> 	; 17/02/2017
   584 00000586 06                  <1> 	push	es
   585 00000587 57                  <1>         push    di
   586 00000588 8B3E[730A]          <1> 	mov	di, [fbs_seg]
   587 0000058C 8EC7                <1> 	mov	es, di
   588 0000058E 29C1                <1>         sub     cx, ax
   589 00000590 89C7                <1> 	mov	di, ax       	
   590 00000592 033E[750A]          <1> 	add	di, [fbs_off]
   591 00000596 30C0                <1>         xor     al, al
   592 00000598 F3AA                <1> 	rep	stosb
   593                              <1>         ;mov	[fbs_off], di
   594 0000059A 5F                  <1> 	pop     di
   595 0000059B 07                  <1>         pop	es
   596 0000059C C3                  <1> 	retn
   597                              <1> 
   598                              <1> ; returns AL = current index value
   599                              <1> getCurrentIndex:
   600                              <1> 	;push	dx
   601 0000059D 8B16[580A]          <1> 	mov	dx, [NABMBAR]
   602 000005A1 83C214              <1> 	add	dx, PO_CIV_REG
   603 000005A4 EC                  <1> 	in	al, dx
   604                              <1> 	;pop	dx
   605 000005A5 C3                  <1> 	retn
   606                              <1> 	
   607                              <1> ;input AL = index # to stop on
   608                              <1> setLastValidIndex:
   609                              <1> 	;push	dx
   610 000005A6 8B16[580A]          <1> 	mov	dx, [NABMBAR]
   611 000005AA 83C215              <1> 	add	dx, PO_LVI_REG
   612 000005AD EE                  <1>         out     dx, al
   613                              <1> 	;pop	dx
   614 000005AE C3                  <1> 	retn
   615                              <1> 
   616                              <1> 	; 03/11/2023
   617                              <1> setCurrentIndex:
   618                              <1> 	;push	dx
   619 000005AF 8B16[580A]          <1> 	mov	dx, [NABMBAR]
   620 000005B3 83C214              <1> 	add	dx, PO_CIV_REG
   621 000005B6 EE                  <1> 	out	dx, al
   622                              <1> 	;pop	dx
   623 000005B7 C3                  <1> 	retn
   624                              <1> 
   625                              <1> ; checks if either shift key has been pressed. Exits with CY if so.
   626                              <1> ; 
   627                              <1> check4keyboardstop:
   628                              <1> 
   629                              <1> ; 04/11/2023
   630                              <1> %if 0	
   631                              <1>         push    es
   632                              <1>         push    0
   633                              <1>         pop     es		       ; examine BDA for keyboard flags
   634                              <1>         test    byte [es:417h], (BIT0 | BIT1)
   635                              <1>         pop     es
   636                              <1>         stc
   637                              <1>         jnz     short _cksr
   638                              <1>         clc
   639                              <1> _cksr:
   640                              <1>         retn
   641                              <1> %endif
   642                              <1> 	; 04/11/2023
   643 000005B8 B401                <1> 	mov	ah, 1
   644 000005BA CD16                <1> 	int	16h
   645 000005BC 7405                <1> 	jz	short _cksr
   646 000005BE 30E4                <1> 	xor	ah, ah
   647 000005C0 CD16                <1> 	int	16h
   648 000005C2 C3                  <1> 	retn
   649                              <1> _cksr:
   650 000005C3 F9                  <1> 	stc
   651 000005C4 C3                  <1> 	retn
   414                                  
   415                                  ; UTILS.ASM
   416                                  ;----------------------------------------------------------------------------
   417                                  ;       delay1_4ms - Delay for 1/4 millisecond.
   418                                  ;		    1mS = 1000us
   419                                  ;       Entry:
   420                                  ;         None
   421                                  ;       Exit:
   422                                  ;	  None
   423                                  ;
   424                                  ;       Modified:
   425                                  ;         None
   426                                  ;
   427                                  PORTB			EQU	061h
   428                                    REFRESH_STATUS	EQU	010h		; Refresh signal status
   429                                  
   430                                  delay1_4ms:
   431 000005C5 50                              push    ax 
   432 000005C6 51                              push    cx
   433 000005C7 B91000                          mov     cx, 16			; close enough.
   434 000005CA E461                    	in	al,PORTB
   435 000005CC 2410                    	and	al,REFRESH_STATUS
   436 000005CE 88C4                    	mov	ah,al			; Start toggle state
   437 000005D0 09C9                    	or	cx, cx
   438 000005D2 7401                    	jz	short _d4ms1
   439 000005D4 41                      	inc	cx			; Throwaway first toggle
   440                                  _d4ms1:	
   441 000005D5 E461                    	in	al,PORTB		; Read system control port
   442 000005D7 2410                    	and	al,REFRESH_STATUS	; Refresh toggles 15.085 microseconds
   443 000005D9 38C4                    	cmp	ah,al
   444 000005DB 74F8                    	je	short _d4ms1		; Wait for state change
   445                                  
   446 000005DD 88C4                    	mov	ah,al			; Update with new state
   447 000005DF 49                      	dec	cx
   448 000005E0 75F3                    	jnz	short _d4ms1
   449                                  
   450 000005E2 59                              pop     cx
   451 000005E3 58                              pop     ax
   452 000005E4 C3                              retn
   453                                  
   454                                  	; 13/11/2016 - Erdogan Tan
   455                                  write_ac97_dev_info:
   456                                  	; BUS/DEV/FN
   457                                  	;	00000000BBBBBBBBDDDDDFFF00000000
   458                                  	; DEV/VENDOR
   459                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
   460                                  
   461 000005E5 30FF                    	xor	bh, bh
   462 000005E7 668B36[660A]            	mov	esi, [dev_vendor]
   463 000005EC 89F0                    	mov	ax, si
   464 000005EE 88C3                    	mov	bl, al
   465 000005F0 88DA                    	mov	dl, bl
   466 000005F2 80E30F                  	and	bl, 0Fh
   467 000005F5 8A87[4809]              	mov	al, [bx+hex_chars]
   468 000005F9 A2[8B09]                	mov	[msgVendorId+3], al
   469 000005FC 88D3                    	mov	bl, dl
   470 000005FE C0EB04                  	shr	bl, 4
   471 00000601 8A87[4809]              	mov	al, [bx+hex_chars]
   472 00000605 A2[8A09]                	mov	[msgVendorId+2], al
   473 00000608 88E3                    	mov	bl, ah
   474 0000060A 88DA                    	mov	dl, bl
   475 0000060C 80E30F                  	and	bl, 0Fh
   476 0000060F 8A87[4809]              	mov	al, [bx+hex_chars]
   477 00000613 A2[8909]                	mov	[msgVendorId+1], al
   478 00000616 88D3                    	mov	bl, dl
   479 00000618 C0EB04                  	shr	bl, 4
   480 0000061B 8A87[4809]              	mov	al, [bx+hex_chars]
   481 0000061F A2[8809]                	mov	[msgVendorId], al
   482 00000622 66C1EE10                	shr	esi, 16
   483 00000626 89F0                    	mov	ax, si
   484 00000628 88C3                    	mov	bl, al
   485 0000062A 88DA                    	mov	dl, bl
   486 0000062C 80E30F                  	and	bl, 0Fh
   487 0000062F 8A87[4809]              	mov	al, [bx+hex_chars]
   488 00000633 A2[9C09]                	mov	[msgDevId+3], al
   489 00000636 88D3                    	mov	bl, dl
   490 00000638 C0EB04                  	shr	bl, 4
   491 0000063B 8A87[4809]              	mov	al, [bx+hex_chars]
   492 0000063F A2[9B09]                	mov	[msgDevId+2], al
   493 00000642 88E3                    	mov	bl, ah
   494 00000644 88DA                    	mov	dl, bl
   495 00000646 80E30F                  	and	bl, 0Fh
   496 00000649 8A87[4809]              	mov	al, [bx+hex_chars]
   497 0000064D A2[9A09]                	mov	[msgDevId+1], al
   498 00000650 88D3                    	mov	bl, dl
   499 00000652 C0EB04                  	shr	bl, 4
   500 00000655 8A87[4809]              	mov	al, [bx+hex_chars]
   501 00000659 A2[9909]                	mov	[msgDevId], al
   502                                  
   503 0000065C 668B36[620A]            	mov	esi, [bus_dev_fn]
   504 00000661 66C1EE08                	shr	esi, 8
   505 00000665 89F0                    	mov	ax, si
   506 00000667 88C3                    	mov	bl, al
   507 00000669 88DA                    	mov	dl, bl
   508 0000066B 80E307                  	and	bl, 7 ; bit 0,1,2
   509 0000066E 8A87[4809]              	mov	al, [bx+hex_chars]
   510 00000672 A2[C009]                	mov	[msgFncNo+1], al
   511 00000675 88D3                    	mov	bl, dl
   512 00000677 C0EB03                  	shr	bl, 3
   513 0000067A 88DA                    	mov	dl, bl
   514 0000067C 80E30F                  	and	bl, 0Fh
   515 0000067F 8A87[4809]              	mov	al, [bx+hex_chars]
   516 00000683 A2[B209]                	mov	[msgDevNo+1], al
   517 00000686 88D3                    	mov	bl, dl
   518 00000688 C0EB04                  	shr	bl, 4
   519 0000068B 8A87[4809]              	mov	al, [bx+hex_chars]
   520 0000068F A2[B109]                	mov	[msgDevNo], al
   521 00000692 88E3                    	mov	bl, ah
   522 00000694 88DA                    	mov	dl, bl
   523 00000696 80E30F                  	and	bl, 0Fh
   524 00000699 8A87[4809]              	mov	al, [bx+hex_chars]
   525 0000069D A2[A609]                	mov	[msgBusNo+1], al
   526 000006A0 88D3                    	mov	bl, dl
   527 000006A2 C0EB04                  	shr	bl, 4
   528 000006A5 8A87[4809]              	mov	al, [bx+hex_chars]
   529 000006A9 A2[A509]                	mov	[msgBusNo], al
   530                                  
   531 000006AC A1[560A]                	mov	ax, [NAMBAR]
   532 000006AF 88C3                    	mov	bl, al
   533 000006B1 88DA                    	mov	dl, bl
   534 000006B3 80E30F                  	and	bl, 0Fh
   535 000006B6 8A87[4809]              	mov	al, [bx+hex_chars]
   536 000006BA A2[CF09]                	mov	[msgNamBar+3], al
   537 000006BD 88D3                    	mov	bl, dl
   538 000006BF C0EB04                  	shr	bl, 4
   539 000006C2 8A87[4809]              	mov	al, [bx+hex_chars]
   540 000006C6 A2[CE09]                	mov	[msgNamBar+2], al
   541 000006C9 88E3                    	mov	bl, ah
   542 000006CB 88DA                    	mov	dl, bl
   543 000006CD 80E30F                  	and	bl, 0Fh
   544 000006D0 8A87[4809]              	mov	al, [bx+hex_chars]
   545 000006D4 A2[CD09]                	mov	[msgNamBar+1], al
   546 000006D7 88D3                    	mov	bl, dl
   547 000006D9 C0EB04                  	shr	bl, 4
   548 000006DC 8A87[4809]              	mov	al, [bx+hex_chars]
   549 000006E0 A2[CC09]                	mov	[msgNamBar], al
   550                                  
   551                                  	; 03/11/2023
   552 000006E3 A1[580A]                	mov	ax, [NABMBAR]
   553 000006E6 88C3                    	mov	bl, al
   554 000006E8 88DA                    	mov	dl, bl
   555 000006EA 80E30F                  	and	bl, 0Fh
   556 000006ED 678A83[48090000]        	mov	al, [ebx+hex_chars]
   557 000006F4 A2[DF09]                	mov	[msgNabmBar+3], al
   558 000006F7 88D3                    	mov	bl, dl
   559 000006F9 C0EB04                  	shr	bl, 4
   560 000006FC 678A83[48090000]        	mov	al, [ebx+hex_chars]
   561 00000703 A2[DE09]                	mov	[msgNabmBar+2], al
   562 00000706 88E3                    	mov	bl, ah
   563 00000708 88DA                    	mov	dl, bl
   564 0000070A 80E30F                  	and	bl, 0Fh
   565 0000070D 678A83[48090000]        	mov	al, [ebx+hex_chars]
   566 00000714 A2[DD09]                	mov	[msgNabmBar+1], al
   567 00000717 88D3                    	mov	bl, dl
   568 00000719 C0EB04                  	shr	bl, 4
   569 0000071C 678A83[48090000]        	mov	al, [ebx+hex_chars]
   570 00000723 A2[DC09]                	mov	[msgNabmBar], al
   571                                  
   572                                  	; 24/11/2016
   573 00000726 30E4                    	xor	ah, ah
   574 00000728 A0[610A]                	mov	al, [ac97_int_ln_reg]
   575 0000072B B10A                    	mov	cl, 10
   576 0000072D F6F1                    	div	cl
   577 0000072F 0106[E709]              	add	[msgIRQ], ax
   578 00000733 20C0                    	and	al, al
   579 00000735 7508                    	jnz	short _pmi
   580 00000737 A0[E809]                	mov	al, [msgIRQ+1]
   581 0000073A B420                    	mov	ah, ' '
   582 0000073C A3[E709]                	mov	[msgIRQ], ax
   583                                  _pmi:
   584 0000073F BA[5909]                        mov	dx, msgAC97Info
   585 00000742 B409                            mov     ah, 9
   586 00000744 CD21                            int     21h
   587 00000746 C3                              retn
   588                                  
   589                                  write_sample_rate:
   590                                  	; ax = sample rate (hertz)
   591                                  
   592 00000747 31D2                    	xor	dx, dx
   593 00000749 B90A00                  	mov	cx, 10
   594 0000074C F7F1                    	div	cx
   595 0000074E 0016[FD09]              	add	[msgHertz+4], dl
   596 00000752 29D2                    	sub	dx, dx
   597 00000754 F7F1                    	div	cx
   598 00000756 0016[FC09]              	add	[msgHertz+3], dl
   599 0000075A 29D2                    	sub	dx, dx
   600 0000075C F7F1                    	div	cx
   601 0000075E 0016[FB09]              	add	[msgHertz+2], dl
   602 00000762 29D2                    	sub	dx, dx
   603 00000764 F7F1                    	div	cx
   604 00000766 0016[FA09]              	add	[msgHertz+1], dl
   605 0000076A 0006[F909]              	add	[msgHertz], al
   606                                  	
   607 0000076E BA[EC09]                        mov     dx, msgSampleRate
   608 00000771 B409                            mov     ah, 9
   609 00000773 CD21                            int     21h
   610                                  
   611                                  	; 19/11/2016
   612 00000775 BA[120A]                	mov	dx, msg16Bits
   613 00000778 803E[700A]10            	cmp	byte [bps], 16
   614 0000077D 7403                    	je	short wsr_1
   615 0000077F BA[030A]                	mov	dx, msg8Bits
   616                                  wsr_1:
   617 00000782 B409                            mov     ah, 9
   618 00000784 CD21                            int     21h
   619                                  
   620 00000786 BA[0B0A]                	mov	dx, msgMono
   621 00000789 803E[6E0A]01            	cmp	byte [stmo], 1
   622 0000078E 7403                    	je	short wsr_2
   623 00000790 BA[1B0A]                	mov	dx, msgStereo		
   624                                  wsr_2:
   625 00000793 B409                            mov     ah, 9
   626 00000795 CD21                            int     21h
   627                                  
   628 00000797 C3                              retn
   629                                  
   630                                  ;detect_codec:
   631                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   632                                  ;	mov	eax, 7Ch
   633                                  ;	call	codec_read
   634                                  ;       shl     eax, 16
   635                                  ;       mov     [codec_id], eax
   636                                  ;
   637                                  ;	mov	eax, 7Eh
   638                                  ;       call	codec_read
   639                                  ;       or      eax, [codec_id]
   640                                  ;       mov     [codec_chip_id], eax
   641                                  ;       and     eax, 0FFFFFF00h
   642                                  ;
   643                                  ;       mov     edi, codecs
   644                                  ;_dcb:
   645                                  ;       mov     ebx, [di]
   646                                  ;       test    ebx, ebx
   647                                  ;       jz      short _dco_unknown
   648                                  ;
   649                                  ;       cmp     eax, ebx
   650                                  ;       jne     short _dco_next
   651                                  ;       mov     ax, [di+4]
   652                                  ;       mov     [codec_vendor_ids], ax
   653                                  ;       movzx   esi, ax
   654                                  ;       call	print_msg
   655                                  ;       
   656                                  ;	mov	ax, [di+6]
   657                                  ;	call	detect_chip
   658                                  ;       retn
   659                                  ;
   660                                  ;_dco_next:
   661                                  ;       add     di, 8
   662                                  ;       jmp     short _dcb
   663                                  ;
   664                                  ;_dco_unknown:
   665                                  ;       mov    word [codec_vendor_ids], ac_unknown
   666                                  ;       mov    word [codec_chip_ids], chip_unknown
   667                                  ;       mov     esi, chip_unknown
   668                                  ;	call	print_msg
   669                                  ;       mov     eax, [codec_chip_id]
   670                                  ;       call    dword2str
   671                                  ;       call	print_msg
   672                                  ;       retn
   673                                  
   674                                  ;detect_chip:
   675                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   676                                  ;	mov	di, ax ; chip_tab
   677                                  ;       mov     eax, [codec_chip_id]
   678                                  ;       and     ax, 0FFh
   679                                  ;_dch1:
   680                                  ;       mov     bx, [di]
   681                                  ;       cmp     bx, 0FFh
   682                                  ;       je      short _dch_unknown
   683                                  ;
   684                                  ;       cmp     ax, bx
   685                                  ;       jne     short _dch_next
   686                                  ;       mov     ax, [di+2]
   687                                  ;       mov     [codec_chip_ids], ax
   688                                  ;       mov     si, ax
   689                                  ;       call	print_msg
   690                                  ;       retn
   691                                  
   692                                  ;_dch_next:
   693                                  ;       add     di, 4
   694                                  ;       jmp     short _dch1
   695                                  ;
   696                                  ;_dch_unknown:
   697                                  ;       mov    word [codec_chip_ids], chip_unknown
   698                                  ;       mov     si, chip_unknown
   699                                  ;       call	print_msg
   700                                  ;       mov     eax, [codec_chip_id]
   701                                  ;       call    dword2str
   702                                  ;       call	print_msg
   703                                  ;       retn
   704                                  
   705                                  ac97_int_handler:
   706                                  	; 04/11/2023
   707                                  	; 06/08/2022 - TRDOS 386 v2.0.5
   708                                  	; 12/10/2017
   709                                  	; 10/10/2017
   710                                  	; 09/10/2017
   711                                  	; 13/06/2017, 13/06/2017
   712                                  	; 10/06/2017, 11/06/2017
   713                                  	; Interrupt Handler for AC97 (ICH) Audio Controller
   714                                  	; Note: called by 'dev_IRQ_service' 
   715                                  	; 28/05/2017 (TDOS 386 v2, 'audio.s')
   716                                  
   717 00000798 FA                      	cli
   718                                  
   719 00000799 6650                    	push	eax
   720 0000079B 52                      	push	dx
   721                                  
   722 0000079C BA3000                          mov	dx, GLOB_STS_REG
   723 0000079F 0316[580A]                      add	dx, [NABMBAR]
   724 000007A3 66ED                    	in	eax, dx
   725                                  	
   726                                  	; 04/11/2023,
   727 000007A5 6683F8FF                        cmp	eax, 0FFFFFFFFh ; -1
   728 000007A9 745D                    	je	short _ac97_ih5
   729                                  	
   730 000007AB A840                    	test	al, 40h		; PCM Out Interrupt
   731 000007AD 7509                    	jnz	short _ac97_ih0
   732                                  	
   733 000007AF 6685C0                  	test	eax, eax
   734 000007B2 7454                    	jz	short _ac97_ih5  ; exit
   735                                  	
   736                                   	;mov	dx, GLOB_STS_REG
   737                                          ;add	dx, [NABMBAR]
   738 000007B4 66EF                    	out	dx, eax
   739                                  	
   740 000007B6 EB50                    	jmp	short _ac97_ih5	 ; exit
   741                                  
   742                                  _ac97_ih0:
   743 000007B8 803E[600A]01            	cmp	byte [audio_play_cmd], 1
   744                                  	;;jb	short _ac97_ih4 ; stop command !
   745                                  	; 04/11/2023
   746                                  	;jb	short _ac97_ih5
   747 000007BD 722C                    	jb	short _ac97_ih1
   748                                  
   749 000007BF 6650                    	push	eax
   750                                  	
   751 000007C1 B81C00                  	mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   752                                  	;mov	ax, 8	; 04/11/2023
   753 000007C4 BA1600                  	mov	dx, PO_SR_REG
   754 000007C7 0316[580A]                      add	dx, [NABMBAR]
   755 000007CB EF                      	out	dx, ax
   756                                  
   757 000007CC BA1400                  	mov	dx, PO_CIV_REG
   758 000007CF 0316[580A]                      add	dx, [NABMBAR]
   759 000007D3 EC                      	in	al, dx
   760                                  
   761 000007D4 50                      	push	ax ; [audio_civ]
   762 000007D5 FEC8                    	dec	al
   763 000007D7 241F                    	and	al, 1Fh
   764                                  
   765 000007D9 BA1500                          mov     dx, PO_LVI_REG
   766 000007DC 0316[580A]                      add	dx, [NABMBAR]
   767 000007E0 EE                              out	dx, al
   768                                  
   769 000007E1 58                      	pop	ax ; [audio_civ]
   770 000007E2 2401                    	and	al, 1
   771                                  	; 04/11/2023
   772 000007E4 FEC0                    	inc	al
   773 000007E6 A2[4F0A]                	mov	[audio_flag], al 
   774                                  	;; [audio_flag] : 1 = Buffer 1, 2 = Buffer 2
   775                                  	;
   776 000007E9 6658                    	pop	eax
   777                                  _ac97_ih1:
   778                                  	; 04/11/2023
   779                                  	;and	ax, 40h
   780 000007EB 8B16[580A]                      mov	dx, [NABMBAR]
   781 000007EF 83C230                  	add	dx, GLOB_STS_REG
   782 000007F2 66EF                    	out	dx, eax
   783                                  
   784                                  ac97_tuneloop:
   785                                  	; 04/11/2023
   786 000007F4 A0[4F0A]                	mov	al, [audio_flag]
   787 000007F7 1E                      	push	ds
   788 000007F8 56                      	push	si 
   789 000007F9 BE00B8                  	mov	si, 0B800h ; video display page segment
   790 000007FC 8EDE                    	mov	ds, si
   791 000007FE 29F6                    	sub	si, si ; 0
   792 00000800 B44E                    	mov	ah, 4Eh
   793 00000802 0430                    	add	al, '0'
   794 00000804 8904                    	mov	[si], ax ; show current play buffer (1, 2)
   795 00000806 5E                      	pop	si
   796 00000807 1F                      	pop	ds
   797                                  _ac97_ih2:
   798                                  _ac97_ih3:
   799                                  	;jmp	short _ac97_ih5
   800                                  
   801                                  ;_ac97_ih4:
   802                                  ;	; 09/10/2017
   803                                  ;	call	_ac97_stop
   804                                  ;	;
   805                                  ;	pop	eax
   806                                  ;	;
   807                                  ;	and     ax, 40h
   808                                  ;       mov	dx, [NABMBAR]
   809                                  ;	add	dx, GLOB_STS_REG
   810                                  ;	out	dx, eax
   811                                  
   812                                  _ac97_ih5:
   813 00000808 B020                    	mov	al, 20h
   814 0000080A F606[610A]08            	test	byte [ac97_int_ln_reg], 8
   815 0000080F 7402                    	jz	short _ih_1
   816 00000811 E6A0                    	out 	0A0h, al ; 20h ; EOI
   817                                  _ih_1:
   818 00000813 E620                    	out	20h, al  ; 20h ; EOI
   819                                  _ih_2:
   820 00000815 5A                      	pop	dx
   821 00000816 6658                    	pop	eax
   822 00000818 CF                      	iret
   823                                  
   824                                  ac97_stop:
   825                                  	; 04/11/2023 
   826                                  	; 28/05/2017 (TRDOS 386 v2, 'audio.s')
   827 00000819 C606[600A]00            	mov	byte [audio_play_cmd], 0 ; stop !
   828                                  ;_ac97_stop:
   829                                  	; 04/11/2023
   830                                  	; 09/10/2017 (TRDOS 386 v2, 'audio.s')
   831                                  	; 11/06/2017
   832 0000081E 30C0                    	xor	al, al ; 0
   833 00000820 E80D00                  	call	ac97_po_cmd
   834                                  
   835                                  	; (Ref: KolibriOS, intelac97.asm, 'stop:')
   836                                  	; Clear FIFOE, BCIS, LVBCI (Ref: Intel ICH hub manual)
   837 00000823 B81C00                  	mov     ax, 1Ch
   838 00000826 8B16[580A]              	mov     dx, [NABMBAR]
   839 0000082A 83C216                  	add     dx, PO_SR_REG
   840 0000082D EF                      	out     dx, ax
   841                                  
   842                                  	; 11/06/2017
   843 0000082E B002                    	mov     al, RR
   844                                  ac97_po_cmd:
   845                                  	 ;11/06/2017
   846                                  	; 29/05/2017
   847 00000830 8B16[580A]              	mov     dx, [NABMBAR]
   848 00000834 83C21B                          add     dx, PO_CR_REG		; PCM out control register
   849 00000837 EE                      	out	dx, al
   850 00000838 C3                      	retn
   851                                  
   852                                  print_msg:
   853                                  	; 13/11/2016 - Erdogan Tan 
   854                                  	; esi = ASCIIZ text address
   855                                  	;
   856 00000839 BB0700                  	mov	bx, 7h
   857 0000083C B40E                    	mov	ah, 0Eh 
   858                                  pm_next_char:
   859 0000083E AC                      	lodsb
   860 0000083F 20C0                    	and	al, al
   861 00000841 7404                    	jz	short pm_retn
   862 00000843 CD10                    	int	10h
   863 00000845 EBF7                    	jmp	short pm_next_char
   864                                  pm_retn:
   865 00000847 C3                      	retn
   866                                  
   867                                  dword2str:
   868                                  	; 13/11/2016 - Erdogan Tan 
   869                                  	; eax = dword value
   870                                  	;
   871 00000848 E84400                  	call	dwordtohex
   872 0000084B 668916[240A]            	mov	[dword_str], edx
   873 00000850 66A3[280A]              	mov	[dword_str+4], eax
   874 00000854 BE[240A]                	mov	si, dword_str
   875 00000857 C3                      	retn
   876                                  
   877                                  	; trdos386.s (unix386.s) - 10/05/2015
   878                                  	; Convert binary number to hexadecimal string
   879                                  
   880                                  bytetohex:
   881                                  	; INPUT ->
   882                                  	; 	AL = byte (binary number)
   883                                  	; OUTPUT ->
   884                                  	;	AX = hexadecimal string
   885                                  	;
   886 00000858 53                      	push	bx
   887 00000859 30FF                    	xor	bh, bh
   888 0000085B 88C3                    	mov	bl, al
   889 0000085D C0EB04                  	shr	bl, 4
   890 00000860 8A9F[4809]              	mov	bl, [bx+hex_chars] 	 	
   891 00000864 86D8                    	xchg	bl, al
   892 00000866 80E30F                  	and	bl, 0Fh
   893 00000869 8AA7[4809]              	mov	ah, [bx+hex_chars] 
   894 0000086D 5B                      	pop	bx	
   895 0000086E C3                      	retn
   896                                  
   897                                  wordtohex:
   898                                  	; INPUT ->
   899                                  	; 	AX = word (binary number)
   900                                  	; OUTPUT ->
   901                                  	;	EAX = hexadecimal string
   902                                  	;
   903 0000086F 53                      	push	bx
   904 00000870 30FF                    	xor	bh, bh
   905 00000872 86E0                    	xchg	ah, al
   906 00000874 50                      	push	ax
   907 00000875 88E3                    	mov	bl, ah
   908 00000877 C0EB04                  	shr	bl, 4
   909 0000087A 8A87[4809]              	mov	al, [bx+hex_chars] 	 	
   910 0000087E 88E3                    	mov	bl, ah
   911 00000880 80E30F                  	and	bl, 0Fh
   912 00000883 8AA7[4809]              	mov	ah, [bx+hex_chars]
   913 00000887 66C1E010                	shl	eax, 16
   914 0000088B 58                      	pop	ax
   915 0000088C 5B                      	pop	bx
   916 0000088D EBC9                    	jmp	short bytetohex
   917                                  
   918                                  dwordtohex:
   919                                  	; INPUT ->
   920                                  	; 	EAX = dword (binary number)
   921                                  	; OUTPUT ->
   922                                  	;	EDX:EAX = hexadecimal string
   923                                  	;
   924 0000088F 6650                    	push	eax
   925 00000891 66C1E810                	shr	eax, 16
   926 00000895 E8D7FF                  	call	wordtohex
   927 00000898 6689C2                  	mov	edx, eax
   928 0000089B 6658                    	pop	eax
   929 0000089D E8CFFF                  	call	wordtohex
   930 000008A0 C3                      	retn
   931                                  
   932                                  ich_init:
   933                                  	; 03/11/2023 (Ref: MPXPLAY source code, 'SC_ICH.C' file)
   934                                  
   935                                  	ICH_GLOB_STAT_PCR equ    100h  ; primary codec is ready
   936                                  	ICH_GLOB_STAT_RCS equ   8000h  ; completion status
   937                                  	ICH_PCM_246_MASK  equ 300000h  ; 6 channels
   938                                  	ICH_GLOB_CNT_ACLINKOFF equ 8h  ; turn off ac97 link
   939                                   		
   940 000008A1 8B16[580A]              	mov	dx, [NABMBAR]
   941 000008A5 83C230                  	add	dx, GLOB_STS_REG
   942 000008A8 66ED                    	in	eax, dx
   943 000008AA 662500800000            	and	eax, ICH_GLOB_STAT_RCS
   944 000008B0 66EF                    	out	dx, eax
   945                                  
   946 000008B2 8B16[580A]              	mov	dx, [NABMBAR]
   947 000008B6 83C22C                  	add	dx, GLOB_CNT_REG
   948 000008B9 66ED                    	in	eax, dx
   949 000008BB 6625F7FFCFFF            	and	eax, ~(ICH_GLOB_CNT_ACLINKOFF | ICH_PCM_246_MASK)
   950                                  	; finish cold or do warm reset
   951 000008C1 3402                    	xor	al, ACCOLD_RESET
   952 000008C3 7502                    	jnz	short ich_i_1
   953 000008C5 0C04                    	or	al, ACWARM_RESET
   954                                  ich_i_1:
   955 000008C7 66EF                    	out	dx, eax
   956                                  
   957                                  	; wait for codec ready status
   958 000008C9 B90500                  	mov	cx, 5
   959                                  ich_i_2:
   960 000008CC 8B16[580A]              	mov	dx, [NABMBAR]
   961 000008D0 83C230                  	add	dx, GLOB_STS_REG
   962 000008D3 66ED                    	in	eax, dx
   963 000008D5 66A900010000            	test	eax, ICH_GLOB_STAT_PCR
   964 000008DB 7506                    	jnz	short ich_i_3
   965 000008DD E8E5FC                  	call	delay1_4ms
   966 000008E0 E2EA                    	loop	ich_i_2
   967 000008E2 F9                      	stc
   968                                  ich_i_3:
   969 000008E3 C3                      	retn
   970                                  
   971                                  _DATA:
   972                                  
   973                                  ; 24/11/2016
   974                                  ;	       IRQ  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 
   975 000008E4 08090A0B0C0D0E0F70-     irq_int		db 08h,09h,0Ah,0Bh,0Ch,0Dh,0Eh,0Fh,70h,71h,72h,73h,74h,75h,76h,77h
   975 000008ED 71727374757677     
   976                                  
   977                                  ; 17/02/2017
   978                                  ; Valid ICH device IDs
   979                                  
   980                                  valid_ids:
   981 000008F4 86801524                dd	(ICH_DID << 16) + INTEL_VID  ; 8086h:2415h 
   982 000008F8 86802524                dd	(ICH0_DID << 16) + INTEL_VID ; 8086h:2425h 
   983 000008FC 86804524                dd	(ICH2_DID << 16) + INTEL_VID ; 8086h:2445h 
   984 00000900 86808524                dd	(ICH3_DID << 16) + INTEL_VID ; 8086h:2485h 
   985 00000904 8680C524                dd	(ICH4_DID << 16) + INTEL_VID ; 8086h:24C5h
   986 00000908 8680D524                dd	(ICH5_DID << 16) + INTEL_VID ; 8086h:24D5h
   987 0000090C 86806E26                dd	(ICH6_DID << 16) + INTEL_VID ; 8086h:266Eh
   988 00000910 8680A625                dd	(ESB6300_DID << 16) + INTEL_VID ; 8086h:25A6h
   989 00000914 86809826                dd	(ESB631X_DID << 16) + INTEL_VID ; 8086h:2698h
   990 00000918 8680DE27                dd	(ICH7_DID << 16) + INTEL_VID ; 8086h:27DEh
   991                                  ; 03/11/2023 - Erdogan Tan
   992 0000091C 86809571                dd	(MX82440_DID << 16) + INTEL_VID ; 8086h:7195h
   993 00000920 39101270                dd	(SI7012_DID << 16)  + SIS_VID	; 1039h:7012h
   994 00000924 DE10B101                dd 	(NFORCE_DID << 16)  + NVIDIA_VID ; 10DEh:01B1h
   995 00000928 DE106A00                dd 	(NFORCE2_DID << 16) + NVIDIA_VID ; 10DEh:006Ah
   996 0000092C 22106D74                dd 	(AMD8111_DID << 16) + AMD_VID ; 1022h:746Dh
   997 00000930 22104574                dd 	(AMD768_DID << 16)  + AMD_VID ; 1022h:7445h
   998 00000934 DE105900                dd 	(CK804_DID << 16) + NVIDIA_VID ; 10DEh:0059h
   999 00000938 DE103A00                dd 	(MCP04_DID << 16) + NVIDIA_VID ; 10DEh:003Ah
  1000 0000093C DE108A00                dd 	(CK8_DID << 16) + NVIDIA_VID ; 1022h:008Ah
  1001 00000940 DE10DA00                dd 	(NFORCE3_DID << 16) + NVIDIA_VID ; 10DEh:00DAh
  1002 00000944 DE10EA00                dd 	(CK8S_DID << 16) + NVIDIA_VID ; 10DEh:00EAh
  1003                                  
  1004                                  valid_id_count:	equ $ - valid_ids 
  1005                                  
  1006                                  ; 13/11/2016
  1007 00000948 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  1007 00000951 3941424344454600   
  1008 00000959 414339372041756469-     msgAC97Info	db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  1008 00000962 6F20436F6E74726F6C-
  1008 0000096B 6C6572202620436F64-
  1008 00000974 656320496E666F0D0A 
  1009 0000097D 56656E646F72204944-     		db "Vendor ID: "
  1009 00000986 3A20               
  1010 00000988 303030306820446576-     msgVendorId	db "0000h Device ID: "
  1010 00000991 6963652049443A20   
  1011 00000999 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  1012 000009A0 4275733A20              		db "Bus: "
  1013 000009A5 303068204465766963-     msgBusNo	db "00h Device: "
  1013 000009AE 653A20             
  1014 000009B1 3030682046756E6374-     msgDevNo	db "00h Function: "
  1014 000009BA 696F6E3A20         
  1015 000009BF 303068                  msgFncNo	db "00h"
  1016 000009C2 0D0A                    		db 0Dh, 0Ah
  1017 000009C4 4E414D4241523A20        		db "NAMBAR: "
  1018 000009CC 30303030682020          msgNamBar	db "0000h  "
  1019 000009D3 4E41424D4241523A20      		db "NABMBAR: "
  1020 000009DC 303030306820495251-     msgNabmBar	db "0000h IRQ: "
  1020 000009E5 3A20               
  1021 000009E7 3030                    msgIRQ		dw 3030h
  1022 000009E9 0D0A24                  		db 0Dh, 0Ah, "$"
  1023 000009EC 53616D706C65205261-     msgSampleRate	db "Sample Rate: "
  1023 000009F5 74653A20           
  1024 000009F9 303030303020487A20-     msgHertz	db "00000 Hz ", "$" 
  1024 00000A02 24                 
  1025 00000A03 3820626974732024        msg8Bits	db "8 bits ", "$" 
  1026 00000A0B 4D6F6E6F0D0A24          msgMono		db "Mono", 0Dh, 0Ah, "$"
  1027 00000A12 313620626974732024      msg16Bits	db "16 bits ", "$" 
  1028 00000A1B 53746572656F0D0A24      msgStereo	db "Stereo", 0Dh, 0Ah, "$"
  1029                                  
  1030                                  ;; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
  1031                                  ;codec_id	dd 0
  1032                                  ;codec_chip_id	dd 0
  1033                                  ;codec_vendor_ids dw 0
  1034                                  ;codec_chip_ids	dw 0
  1035                                  
  1036 00000A24 3030303030303030        dword_str	 dd 30303030h, 30303030h
  1037 00000A2C 680D0A00                		 db 'h', 0Dh, 0Ah, 0
  1038                                  
  1039                                  ;ac_unknown     db 'unknown manufacturer',13,10,0
  1040                                  ;ac_Realtek     db 'Realtek Semiconductor',13,10,0
  1041                                  ;ac_Analog      db 'Analog Devices',13,10,0
  1042                                  ;ac_CMedia      db 'C-Media Electronics',13,10,0
  1043                                  ;ac_Cirrus      db 'Cirrus Logic',13,10,0
  1044                                  ;ac_Wolfson     db 'Wolfson Microelectronics',13,10,0
  1045                                  ;ac_VIA         db 'VIA Technologies',13,10,0
  1046                                  ;ac_SigmaTel    db 'SigmaTel',13,10,0
  1047                                  ;ac_eMicro      db 'eMicro',13,10,0
  1048                                  ;
  1049                                  ;chip_unknown   db 'unknown codec id ', 0
  1050                                  
  1051                                  ;CHIP_REALTEK   equ 414C4700h
  1052                                  ;CHIP_CMEDIA    equ 434D4900h
  1053                                  ;CHIP_VIA       equ 56494100h
  1054                                  
  1055                                  ;codecs        dd CHIP_CMEDIA
  1056                                  ;	       dw ac_CMedia, chips_CMedia
  1057                                  ;              dd CHIP_REALTEK
  1058                                  ;	       dw ac_Realtek, chips_Realtek
  1059                                  ;              dd CHIP_VIA
  1060                                  ;	       dw ac_VIA, chips_VIA
  1061                                  ;              dd 0
  1062                                  
  1063                                  ;chips_Realtek dw 10h, chip_ALC201a
  1064                                  ;              dw 20h, chip_ALC650
  1065                                  ;              dw 21h, chip_ALC650D
  1066                                  ;              dw 22h, chip_ALC650E
  1067                                  ;              dw 23h, chip_ALC650F
  1068                                  ;              dw 60h, chip_ALC655
  1069                                  ;              dw 80h, chip_ALC658
  1070                                  ;              dw 81h, chip_ALC658D
  1071                                  ;              dw 90h, chip_ALC850
  1072                                  ;              dw 0FFh
  1073                                  
  1074                                  ;chips_CMedia  dw 41h, chip_CM9738
  1075                                  ;              dw 61h, chip_CM9739
  1076                                  ;              dw 69h, chip_CM9780
  1077                                  ;              dw 78h, chip_CM9761
  1078                                  ;              dw 82h, chip_CM9761
  1079                                  ;              dw 83h, chip_CM9761
  1080                                  ;              dw 0FFh
  1081                                  
  1082                                  ;chips_VIA     dw 61h, chip_VIA1612A
  1083                                  ;              dw 0FFh
  1084                                  
  1085                                  ;Realtek
  1086                                  ;chip_ALC201a    db 'ALC201a',0dh,0ah,00h
  1087                                  ;chip_ALC650     db 'ALC650 ',0dh,0ah,00h
  1088                                  ;chip_ALC650D    db 'ALC650D',0dh,0ah,00h
  1089                                  ;chip_ALC650E    db 'ALC650E',0dh,0ah,00h
  1090                                  ;chip_ALC650F    db 'ALC650F',0dh,0ah,00h
  1091                                  ;chip_ALC655     db 'ALC655 ',0dh,0ah,00h
  1092                                  ;chip_ALC658     db 'ALC658 ',0dh,0ah,00h
  1093                                  ;chip_ALC658D    db 'ALC658D',0dh,0ah,00h
  1094                                  ;chip_ALC850     db 'ALC850 ',0dh,0ah,00h
  1095                                  
  1096                                  ;CMedia
  1097                                  ;chip_CM9738     db 'CMI9738', 0dh,0ah,0
  1098                                  ;chip_CM9739     db 'CMI9739', 0dh,0ah,0
  1099                                  ;chip_CM9780     db 'CMI9780', 0dh,0ah,0
  1100                                  ;chip_CM9761     db 'CMI9761', 0dh,0ah,0
  1101                                  
  1102                                  ;VIA
  1103                                  ;chip_VIA1612A   db 'VIA1612A',13,10,0
  1104                                  
  1105                                  ; 17/02/2017
  1106                                  bss_start:
  1107                                  
  1108                                  ABSOLUTE bss_start
  1109                                  
  1110                                  alignb 2
  1111                                  
  1112                                  ; 28/11/2016
  1113                                  
  1114 00000A30 <res 1Ch>               smpRBuff:	resw 14 ; 19/11/2016 - Erdogan Tan
  1115                                  
  1116 00000A4C ????                    filehandle:	resw 1
  1117                                  
  1118 00000A4E ??                      flags:		resb 1
  1119                                  ; 04/11/2023
  1120 00000A4F ??                      audio_flag:	resb 1	; (buffer 1 or buffer 2)
  1121                                  
  1122                                  ;irq_status:	resb 1	; AC97 IRQ status
  1123                                  ;inside:	resb 1
  1124                                  ;tLoop:		resb 1	
  1125                                  
  1126                                  ; 04/11/2023
  1127 00000A50 ????                    IRQ_status:	resw 1	; IRQ status before enabling audio interrupt
  1128 00000A52 ????????                IRQ_vector:	resd 1  ; Previous interrupt handler address
  1129                                  
  1130                                  ; 17/02/2017
  1131                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  1132                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  1133                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  1134                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  1135 00000A56 ????                    NAMBAR:		resw 1			; BAR for mixer
  1136 00000A58 ????                    NABMBAR         resw 1			; BAR for bus master regs
  1137                                  
  1138                                  ; 256 byte buffer for descriptor list
  1139 00000A5A ????                    BDL_BUFFER:	resw 1			; segment of our 256byte BDL buffer
  1140 00000A5C ????                    WAV_BUFFER1:	resw 1			; segment of our WAV storage
  1141                                  ; 64k buffers for wav file storage
  1142 00000A5E ????                    WAV_BUFFER2:	resw 1			; segment of 2nd wav buffer
  1143                                  
  1144                                  ; 04/11/2023
  1145                                  ;tBuff:		resb 1
  1146 00000A60 ??                      audio_play_cmd:	resb 1
  1147 00000A61 ??                      ac97_int_ln_reg: resb 1
  1148                                  
  1149                                  ; 12/11/2016 - Erdogan Tan
  1150                                  
  1151 00000A62 ????????                bus_dev_fn:	resd 1
  1152 00000A66 ????????                dev_vendor:	resd 1
  1153 00000A6A ????                    stats_cmd:	resw 1 ; 17/02/2017
  1154 00000A6C ????                    sample_rate:	resw 1
  1155                                  ; 19/11/2016
  1156 00000A6E ????                    stmo:		resw 1 
  1157 00000A70 ????                    bps:		resw 1
  1158                                  
  1159 00000A72 ??                      fbs_shift:	resb 1
  1160 00000A73 ????                    fbs_seg:	resw 1
  1161 00000A75 ????                    fbs_off:	resw 1
  1162                                  
  1163                                  ; 32 kilo bytes for temporay buffer
  1164                                  ; (for stereo-mono, 8bit/16bit corrections)
  1165 00000A77 <res 8000h>             temp_buffer:	resb 32768
  1166 00008A77 <res 9h>                alignb 16
  1167                                  EOF:
