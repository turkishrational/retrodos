     1                                  ; ****************************************************************************
     2                                  ; PLAYWAV.ASM - ICH AC97 .wav player for DOS.			   PLAYWAV.COM
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; Last Update: 13/05/2024
     5                                  ; ----------------------------------------------------------------------------
     6                                  ; Beginning: 17/02/2017
     7                                  ; ----------------------------------------------------------------------------
     8                                  ; Assembler: NASM version 2.15
     9                                  ;	     nasm playwav.asm -l playwav.lst -o PLAYWAV.COM	
    10                                  ; ----------------------------------------------------------------------------
    11                                  ; Derived from '.wav file player for DOS' Jeff Leyda, Sep 02, 2002 
    12                                  ; ****************************************************************************
    13                                  ; Modidified from 'PLAYER.COM' for VIA VT8233 wav player source code by
    14                                  ; (PLAYER.ASM) by Erdogan Tan (07/11/2016 - 08/12/2016)
    15                                  
    16                                  [BITS 16]
    17                                  
    18                                  [ORG 100h] 
    19                                  
    20                                  	%include 'ac97.inc' ; 17/02/2017
     1                              <1> ; 11/11/2023
     2                              <1> ; 05/11/2023
     3                              <1> ; 03/11/2023
     4                              <1> ; 17/02/2017 (Erdogan Tan, PLAYWAV.ASM)
     5                              <1> ; constant.inc & codec.inc (for ICH AC97 wav player, 'PLAYWAV.COM') 
     6                              <1> 
     7                              <1> ; ----------------------------------------------------------------------------
     8                              <1> ; CONSTANT.INC
     9                              <1> ; ----------------------------------------------------------------------------
    10                              <1> 
    11                              <1> ;constants of stuff that seem hard to remember at times.
    12                              <1> 
    13                              <1> TRUE  EQU 1
    14                              <1> FALSE EQU 0
    15                              <1> 
    16                              <1> ENABLED  EQU 1
    17                              <1> DISABLED EQU 0
    18                              <1> 
    19                              <1> BIT0  EQU 1
    20                              <1> BIT1  EQU 2
    21                              <1> BIT2  EQU 4
    22                              <1> BIT3  EQU 8
    23                              <1> BIT4  EQU 10h
    24                              <1> BIT5  EQU 20h
    25                              <1> BIT6  EQU 40h
    26                              <1> BIT7  EQU 80h
    27                              <1> BIT8  EQU 100h
    28                              <1> BIT9  EQU 200h
    29                              <1> BIT10 EQU 400h
    30                              <1> BIT11 EQU 800h
    31                              <1> BIT12 EQU 1000h
    32                              <1> BIT13 EQU 2000h
    33                              <1> BIT14 EQU 4000h
    34                              <1> BIT15 EQU 8000h
    35                              <1> BIT16 EQU 10000h
    36                              <1> BIT17 EQU 20000h
    37                              <1> BIT18 EQU 40000h
    38                              <1> BIT19 EQU 80000h
    39                              <1> BIT20 EQU 100000h
    40                              <1> BIT21 EQU 200000h
    41                              <1> BIT22 EQU 400000h
    42                              <1> BIT23 EQU 800000h
    43                              <1> BIT24 EQU 1000000h
    44                              <1> BIT25 EQU 2000000h
    45                              <1> BIT26 EQU 4000000h
    46                              <1> BIT27 EQU 8000000h
    47                              <1> BIT28 EQU 10000000h
    48                              <1> BIT29 EQU 20000000h
    49                              <1> BIT30 EQU 40000000h
    50                              <1> BIT31 EQU 80000000h
    51                              <1> 
    52                              <1> ;special characters
    53                              <1> NUL     EQU 0
    54                              <1> NULL    EQU 0
    55                              <1> BELL    EQU 07
    56                              <1> BS      EQU 08
    57                              <1> TAB     EQU 09
    58                              <1> LF      EQU 10
    59                              <1> CR      EQU 13
    60                              <1> ESCAPE  EQU 27           ;ESC is a reserved word....
    61                              <1> 
    62                              <1> 
    63                              <1> ;file stuff
    64                              <1> READONLY  EQU   BIT0
    65                              <1> HIDDEN    EQU   BIT1
    66                              <1> SYSTEM    EQU   BIT2
    67                              <1> VOLUME    EQU   BIT3         ;ignored for file access
    68                              <1> DIRECTORY EQU   BIT4         ;must be 0 for file access
    69                              <1> ARCHIVE   EQU   BIT5
    70                              <1> SHAREABLE EQU   BIT7         ;for novell networks
    71                              <1> OPEN	EQU	2		; open existing file
    72                              <1> CREATE	EQU	1		; create new file
    73                              <1> 
    74                              <1> 
    75                              <1> ; PCI equates
    76                              <1> ; PCI function address (PFA)
    77                              <1> ; bit 31 = 1
    78                              <1> ; bit 23:16 = bus number     (0-255)
    79                              <1> ; bit 15:11 = device number  (0-31)
    80                              <1> ; bit 10:8 = function number (0-7)
    81                              <1> ; bit 7:0 = register number  (0-255)
    82                              <1> 
    83                              <1> IO_ADDR_MASK    EQU     0FFFEh          ; mask off bit 0 for reading BARs
    84                              <1> PCI_INDEX_PORT  EQU     0CF8h
    85                              <1> PCI_DATA_PORT   EQU     0CFCh
    86                              <1> PCI32           EQU     BIT31           ; bitflag to signal 32bit access
    87                              <1> PCI16           EQU     BIT30           ; bitflag for 16bit access
    88                              <1> 
    89                              <1> PCI_FN0         EQU     0 << 8
    90                              <1> PCI_FN1         EQU     1 << 8
    91                              <1> PCI_FN2         EQU     2 << 8
    92                              <1> PCI_FN3         EQU     3 << 8
    93                              <1> PCI_FN4         EQU     4 << 8
    94                              <1> PCI_FN5         EQU     5 << 8
    95                              <1> PCI_FN6         EQU     6 << 8
    96                              <1> PCI_FN7         EQU     7 << 8
    97                              <1> 
    98                              <1> PCI_CMD_REG		EQU	04h		; reg 04, command reg
    99                              <1>  IO_ENA			EQU	BIT0		; i/o decode enable
   100                              <1>  MEM_ENA		EQU	BIT1		; memory decode enable
   101                              <1>  BM_ENA                 EQU     BIT2		; bus master enable
   102                              <1> 
   103                              <1> ; ----------------------------------------------------------------------------
   104                              <1> ; CODEC.INC
   105                              <1> ; ----------------------------------------------------------------------------
   106                              <1> 
   107                              <1> ;Codec registers.
   108                              <1> ;
   109                              <1> ;Not all codecs are created equal. Refer to the spec for your specific codec.
   110                              <1> ;
   111                              <1> ;All registers are 16bits wide.  Access to codec registers over the AC97 link
   112                              <1> ;is defined by the OEM.  
   113                              <1> ;
   114                              <1> ;Secondary codec's are accessed by ORing in BIT7 of all register accesses.
   115                              <1> ;
   116                              <1> 
   117                              <1> ; each codec/mixer register is 16bits
   118                              <1> 
   119                              <1> CODEC_RESET_REG                 equ     00      ; reset codec
   120                              <1> CODEC_MASTER_VOL_REG            equ     02      ; master volume
   121                              <1> CODEC_HP_VOL_REG                equ     04      ; headphone volume
   122                              <1> CODEC_MASTER_MONO_VOL_REG       equ     06      ; master mono volume
   123                              <1> CODEC_MASTER_TONE_REG           equ     08      ; master tone (R+L)
   124                              <1> CODEC_PCBEEP_VOL_REG            equ     0ah     ; PC beep volume
   125                              <1> CODEC_PHONE_VOL_REG             equ     0bh     ; phone volume
   126                              <1> CODEC_MIC_VOL_REG               equ     0eh     ; MIC volume
   127                              <1> CODEC_LINE_IN_VOL_REG           equ     10h     ; line input volume
   128                              <1> CODEC_CD_VOL_REG                equ     12h     ; CD volume
   129                              <1> CODEC_VID_VOL_REG               equ     14h     ; video volume
   130                              <1> CODEC_AUX_VOL_REG               equ     16h     ; aux volume
   131                              <1> CODEC_PCM_OUT_REG               equ     18h     ; PCM output volume
   132                              <1> CODEC_RECORD_SELECT_REG         equ     1ah     ; record select input
   133                              <1> CODEC_RECORD_VOL_REG            equ     1ch     ; record volume
   134                              <1> CODEC_RECORD_MIC_VOL_REG        equ     1eh     ; record mic volume
   135                              <1> CODEC_GP_REG                    equ     20h     ; general purpose
   136                              <1> CODEC_3D_CONTROL_REG            equ     22h     ; 3D control
   137                              <1> ; 24h is reserved
   138                              <1> CODEC_POWER_CTRL_REG            equ     26h     ; powerdown control
   139                              <1> CODEC_EXT_AUDIO_REG             equ     28h     ; extended audio
   140                              <1> CODEC_EXT_AUDIO_CTRL_REG        equ     2ah     ; extended audio control
   141                              <1> CODEC_PCM_FRONT_DACRATE_REG     equ     2ch     ; PCM out sample rate
   142                              <1> CODEC_PCM_SURND_DACRATE_REG     equ     2eh     ; surround sound sample rate
   143                              <1> CODEC_PCM_LFE_DACRATE_REG       equ     30h     ; LFE sample rate
   144                              <1> CODEC_LR_ADCRATE_REG            equ     32h     ; PCM in sample rate
   145                              <1> CODEC_MIC_ADCRATE_REG           equ     34h     ; mic in sample rate
   146                              <1> 
   147                              <1> ; registers 36-7a are reserved on the ICH
   148                              <1> 
   149                              <1> CODEC_VENDORID1_REG             equ     7ch     ; codec vendor ID 1
   150                              <1> CODEC_VENDORID2_REG             equ     7eh     ; codec vendor ID 2
   151                              <1> 
   152                              <1> ; Mixer registers 0 through 51h reside in the ICH and are not forwarded over
   153                              <1> ; the AC97 link to the codec, which I think is a little weird.  Looks like
   154                              <1> ; the ICH makes it so you don't need a fully functional codec to play audio?
   155                              <1> ;
   156                              <1> ; whenever 2 codecs are present in the system, use BIT7 to access the 2nd
   157                              <1> ; set of registers, ie 80h-feh
   158                              <1> 
   159                              <1> PRIMARY_CODEC                   equ     0       ; 0-7F for primary codec
   160                              <1> SECONDARY_CODEC                 equ     BIT7    ; 80-8f registers for 2ndary
   161                              <1> 
   162                              <1> SAMPLE_RATE_441khz	equ     44100   ; 44.1Khz (cd quality) rate
   163                              <1> 
   164                              <1> ; ----------------------------------------------------------------------------
   165                              <1> ; 17/02/2017
   166                              <1> PCI_IO_BASE	equ 10h			; = NAMBAR register offset
   167                              <1> AC97_INT_LINE   equ 3Ch			; AC97 Interrupt Line register offset
   168                              <1> 
   169                              <1> ; ----------------------------------------------------------------------------
   170                              <1> ; ICH2AC97.INC
   171                              <1> ; ----------------------------------------------------------------------------
   172                              <1> 
   173                              <1> ; PCI stuff
   174                              <1> 
   175                              <1> ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
   176                              <1> 
   177                              <1> INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
   178                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   179                              <1> SIS_VID		equ	1039h
   180                              <1> NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
   181                              <1> AMD_VID		equ	1022h
   182                              <1> 
   183                              <1> ICH_DID         equ     2415h           ; ICH device ID
   184                              <1> ICH0_DID        equ     2425h           ; ICH0
   185                              <1> ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
   186                              <1>                                         ; they all should be compatible.
   187                              <1> 
   188                              <1> ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
   189                              <1> ICH3_DID	equ     2485h           ; ICH3
   190                              <1> ICH4_DID        equ     24C5h           ; ICH4
   191                              <1> ICH5_DID	equ     24D5h           ; ICH5 
   192                              <1> ICH6_DID	equ     266Eh           ; ICH6
   193                              <1> ESB6300_DID	equ     25A6h           ; 6300ESB
   194                              <1> ESB631X_DID	equ     2698h           ; 631XESB
   195                              <1> ICH7_DID	equ	27DEh		; ICH7
   196                              <1> ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   197                              <1> MX82440_DID	equ	7195h
   198                              <1> SI7012_DID	equ	7012h
   199                              <1> NFORCE_DID	equ	01B1h
   200                              <1> NFORCE2_DID	equ	006Ah
   201                              <1> AMD8111_DID	equ	746Dh
   202                              <1> AMD768_DID	equ	7445h
   203                              <1> ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
   204                              <1> CK804_DID	equ	0059h
   205                              <1> MCP04_DID	equ	003Ah
   206                              <1> CK8_DID		equ	008Ah
   207                              <1> NFORCE3_DID	equ	00DAh
   208                              <1> CK8S_DID	equ	00EAh
   209                              <1> 
   210                              <1> NAMBAR_REG      equ     10h             ; native audio mixer BAR
   211                              <1>  NAM_SIZE       equ     256             ; 256 bytes required.
   212                              <1> 
   213                              <1> NABMBAR_REG     equ     14h             ; native audio bus mastering BAR
   214                              <1>  NABM_SIZE      equ     64              ; 64 bytes
   215                              <1> 
   216                              <1> ; BUS master registers, accessed via NABMBAR+offset
   217                              <1> 
   218                              <1> ; ICH supports 3 different types of register sets for three types of things
   219                              <1> ; it can do, thus:
   220                              <1> ;
   221                              <1> ; PCM in (for recording) aka PI
   222                              <1> ; PCM out (for playback) aka PO
   223                              <1> ; MIC in (for recording) aka MC
   224                              <1> 
   225                              <1> PI_BDBAR_REG            equ     0       ; PCM in buffer descriptor BAR
   226                              <1> PO_BDBAR_REG            equ     10h     ; PCM out buffer descriptor BAR
   227                              <1> MC_BDBAR_REG            equ     20h     ; MIC in buffer descriptor BAR
   228                              <1> 
   229                              <1> ; each buffer descriptor BAR holds a pointer which has entries to the buffer
   230                              <1> ; contents of the .WAV file we're going to play. Each entry is 8 bytes long
   231                              <1> ; (more on that later) and can contain 32 entries total, so each BAR is
   232                              <1> ; 256 bytes in length, thus:
   233                              <1> 
   234                              <1> BDL_SIZE                equ     32*8    ; Buffer Descriptor List size
   235                              <1> INDEX_MASK              equ     31      ; indexes must be 0-31
   236                              <1> 
   237                              <1> 
   238                              <1> 
   239                              <1> PI_CIV_REG              equ     4       ; PCM in current Index value (RO)
   240                              <1> PO_CIV_REG              equ     14h     ; PCM out current Index value (RO)
   241                              <1> MC_CIV_REG              equ     24h     ; MIC in current Index value (RO)
   242                              <1> ;8bit read only
   243                              <1> ; each current index value is simply a pointer showing us which buffer
   244                              <1> ; (0-31) the codec is currently processing. Once this counter hits 31, it
   245                              <1> ; wraps back to 0.
   246                              <1> ; this can be handy to know, as once it hits 31, we're almost out of data to
   247                              <1> ; play back or room to record!
   248                              <1> 
   249                              <1> 
   250                              <1> PI_LVI_REG              equ     5       ; PCM in Last Valid Index
   251                              <1> PO_LVI_REG              equ     15h     ; PCM out Last Valid Index
   252                              <1> MC_LVI_REG              equ     25h     ; MIC in Last Valid Index
   253                              <1> ;8bit read/write
   254                              <1> ; The Last Valid Index is a number (0-31) to let the codec know what buffer
   255                              <1> ; number to stop on after processing. It could be very nasty to play audio
   256                              <1> ; from buffers that aren't filled with the audio we want to play.
   257                              <1> 
   258                              <1> 
   259                              <1> PI_SR_REG               equ     6       ; PCM in Status register
   260                              <1> PO_SR_REG               equ     16h     ; PCM out Status register
   261                              <1> MC_SR_REG               equ     26h     ; MIC in Status register
   262                              <1> ;16bit read/write
   263                              <1> ; status registers.  Bitfields follow:
   264                              <1> 
   265                              <1> FIFO_ERR                equ     BIT4    ; FIFO Over/Underrun W1TC.
   266                              <1> 
   267                              <1> BCIS                    equ     BIT3    ; buffer completion interrupt status.
   268                              <1>                                         ; Set whenever the last sample in ANY
   269                              <1>                                         ; buffer is finished.  Bit is only
   270                              <1>                                         ; set when the Interrupt on Complete
   271                              <1>                                         ; (BIT4 of control reg) is set.
   272                              <1> 
   273                              <1> LVBCI                   equ     BIT2    ; Set whenever the codec has processed
   274                              <1>                                         ; the last buffer in the buffer list.
   275                              <1>                                         ; Will fire an interrupt if IOC bit is
   276                              <1>                                         ; set. Probably set after the last
   277                              <1>                                         ; sample in the last buffer is
   278                              <1>                                         ; processed.  W1TC
   279                              <1> 
   280                              <1>                                         ; 
   281                              <1> CELV                    equ     BIT1    ; Current buffer == last valid.
   282                              <1>                                         ; Bit is RO and remains set until LVI is
   283                              <1>                                         ; cleared.  Probably set up the start
   284                              <1>                                         ; of processing for the last buffer.
   285                              <1> 
   286                              <1> 
   287                              <1> DCH                     equ     BIT0    ; DMA controller halted.
   288                              <1>                                         ; set whenever audio stream is stopped
   289                              <1>                                         ; or something else goes wrong.
   290                              <1> 
   291                              <1> 
   292                              <1> PI_PICB_REG             equ     8       ; PCM in position in current buffer(RO)
   293                              <1> PO_PICB_REG             equ     18h     ; PCM out position in current buffer(RO)
   294                              <1> MC_PICB_REG             equ     28h     ; MIC in position in current buffer (RO)
   295                              <1> ;16bit read only
   296                              <1> ; position in current buffer regs show the number of dwords left to be
   297                              <1> ; processed in the current buffer.
   298                              <1> ; 
   299                              <1> 
   300                              <1> PI_PIV_REG              equ     0ah     ; PCM in Prefected index value
   301                              <1> PO_PIV_REG              equ     1ah     ; PCM out Prefected index value
   302                              <1> MC_PIV_REG              equ     2ah     ; MIC in Prefected index value
   303                              <1> ;8bit, read only
   304                              <1> ; Prefetched index value register.
   305                              <1> ; tells which buffer number (0-31) has be prefetched. I'd imagine this
   306                              <1> ; value follows the current index value fairly closely. (CIV+1)
   307                              <1> ;
   308                              <1> 
   309                              <1> 
   310                              <1> PI_CR_REG               equ     0bh     ; PCM in Control Register
   311                              <1> PO_CR_REG               equ     1bh     ; PCM out Control Register
   312                              <1> MC_CR_REG               equ     2bh     ; MIC in Control Register
   313                              <1> ; 8bit
   314                              <1> ; Control register *MUST* only be accessed as an 8bit value.
   315                              <1> ; Control register. See bitfields below.
   316                              <1> ;
   317                              <1> 
   318                              <1> 
   319                              <1> IOCE                    equ     BIT4    ; interrupt on complete enable.
   320                              <1>                                         ; set this bit if you want an intrtpt
   321                              <1>                                         ; to fire whenever LVBCI is set.
   322                              <1> FEIFE                   equ     BIT3    ; set if you want an interrupt to fire
   323                              <1>                                         ; whenever there is a FIFO (over or
   324                              <1>                                         ; under) error.
   325                              <1> LVBIE                   equ     BIT2    ; last valid buffer interrupt enable.
   326                              <1>                                         ; set if you want an interrupt to fire
   327                              <1>                                         ; whenever the completion of the last
   328                              <1>                                         ; valid buffer.
   329                              <1> RR                      equ     BIT1    ; reset registers.  Nukes all regs
   330                              <1>                                         ; except bits 4:2 of this register.
   331                              <1>                                         ; Only set this bit if BIT 0 is 0
   332                              <1> RPBM                    equ     BIT0    ; Run/Pause
   333                              <1>                                         ; set this bit to start the codec!
   334                              <1> 
   335                              <1> 
   336                              <1> GLOB_CNT_REG            equ     2ch     ; Global control register
   337                              <1> SEC_RES_EN              equ     BIT5    ; secondary codec resume event 
   338                              <1>                                         ; interrupt enable.  Not used here.
   339                              <1> PRI_RES_EN              equ     BIT4    ; ditto for primary. Not used here.
   340                              <1> ACLINK_OFF              equ     BIT3    ; Turn off the AC97 link
   341                              <1> ACWARM_RESET            equ     BIT2    ; Awaken the AC97 link from sleep.
   342                              <1>                                         ; registers preserved, bit self clears
   343                              <1> ACCOLD_RESET            equ     BIT1    ; Reset everything in the AC97 and
   344                              <1>                                         ; reset all registers.  Not self clearing
   345                              <1> 
   346                              <1> GPIIE                   equ     BIT0    ; GPI Interrupt enable.
   347                              <1>                                         ; set if you want an interrupt to
   348                              <1>                                         ; fire upon ANY of the bits in the
   349                              <1>                                         ; GPI (general pursose inputs?) not used.
   350                              <1> 
   351                              <1> GLOB_STS_REG            equ     30h     ; Global Status register (RO)
   352                              <1> 
   353                              <1> MD3                     equ     BIT17   ; modem powerdown status (yawn)
   354                              <1> AD3                     equ     BIT16   ; Audio powerdown status (yawn)
   355                              <1> RD_COMPLETE_STS         equ     BIT15   ; Codec read timed out. 0=normal
   356                              <1> BIT3SLOT12              equ     BIT14   ; shadowed status of bit 3 in slot 12
   357                              <1> BIT2SLOT12              equ     BIT13   ; shadowed status of bit 2 in slot 12
   358                              <1> BIT1SLOT12              equ     BIT12   ; shadowed status of bit 1 in slot 12
   359                              <1> SEC_RESUME_STS          equ     BIT11   ; secondary codec has resumed (and irqed)
   360                              <1> PRI_RESUME_STS          equ     BIT10   ; primary codec has resumed (and irqed)
   361                              <1> SEC_CODEC_RDY           equ     BIT9    ; secondary codec is ready for action
   362                              <1> PRI_CODEC_RDY           equ     BIT8    ; Primary codec is ready for action
   363                              <1>                                         ; software must check these bits before
   364                              <1>                                         ; starting the codec!
   365                              <1> MIC_IN_IRQ              equ     BIT7    ; MIC in caused an interrupt
   366                              <1> PCM_OUT_IRQ             equ     BIT6    ; One of the PCM out channels IRQed
   367                              <1> PCM_IN_IRQ              equ     BIT5    ; One of the PCM in channels IRQed
   368                              <1> MODEM_OUT_IRQ           equ     BIT2    ; modem out channel IRQed
   369                              <1> MODEM_IN_IRQ            equ     BIT1    ; modem in channel IRQed
   370                              <1> GPI_STS_CHANGE          equ     BIT0    ; set whenever GPI's have changed.
   371                              <1>                                         ; BIT0 of slot 12 also reflects this.
   372                              <1> 
   373                              <1> ACC_SEMA_REG            equ     34h     ; Codec write semiphore register
   374                              <1> CODEC_BUSY              equ     BIT0    ; codec register I/O is happening
   375                              <1>                                         ; self clearing
   376                              <1> ;
   377                              <1> ; Buffer Descriptors List
   378                              <1> ; As stated earlier, each buffer descriptor list is a set of (up to) 32 
   379                              <1> ; descriptors, each 8 bytes in length. Bytes 0-3 of a descriptor entry point
   380                              <1> ; to a chunk of memory to either play from or record to. Bytes 4-7 of an
   381                              <1> ; entry describe various control things detailed below.
   382                              <1> ; 
   383                              <1> ; Buffer pointers must always be aligned on a Dword boundry.
   384                              <1> ;
   385                              <1> 
   386                              <1> IOC                     equ     BIT31   ; Fire an interrupt whenever this
   387                              <1>                                         ; buffer is complete.
   388                              <1> 
   389                              <1> BUP                     equ     BIT30   ; Buffer Underrun Policy.
   390                              <1>                                         ; if this buffer is the last buffer
   391                              <1>                                         ; in a playback, fill the remaining
   392                              <1>                                         ; samples with 0 (silence) or not.
   393                              <1>                                         ; It's a good idea to set this to 1
   394                              <1>                                         ; for the last buffer in playback,
   395                              <1>                                         ; otherwise you're likely to get a lot
   396                              <1>                                         ; of noise at the end of the sound.
   397                              <1> 
   398                              <1> ;
   399                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   400                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   401                              <1> ; Luckily for us, that's the same format as .wav files.
   402                              <1> ;
   403                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   404                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   405                              <1> ;
   406                              <1> ; A value of 0 in these bits means play no samples.
   407                              <1> ;
   408                              <1> 
   409                              <1> ; 11/11/2023
   410                              <1> CTRL_ST_CREADY		equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
   411                              <1> CODEC_REG_POWERDOWN	equ	26h
    21                                  
    22                                  _STARTUP:
    23                                  
    24                                  ; memory allocation
    25                                  
    26 00000000 E88001                          call    setFree				; deallocate unused DOS mem
    27                                  
    28                                  	; 17/02/2017
    29                                  	; Clear BSS (uninitialized data) area
    30 00000003 31C0                    	xor	ax, ax ; 0
    31 00000005 B92740                  	mov	cx, (EOF - bss_start)/2
    32 00000008 BF[620A]                	mov	di, bss_start
    33 0000000B F3AB                    	rep	stosw
    34                                  
    35                                  ; allocate 256 bytes of data for DCM_OUT Buffer Descriptor List. (BDL)
    36                                  
    37 0000000D B81000                          mov     ax, BDL_SIZE / 16
    38 00000010 E87801                          call    memAlloc
    39 00000013 A3[880A]                        mov     [BDL_BUFFER], ax		; segment 
    40                                  
    41                                  ; allocate 2 buffers, 64k each for now.
    42                                  
    43 00000016 B80010                          mov     ax, BUFFERSIZE / 16		; 64k for .WAV file
    44 00000019 E86F01                          call    memAlloc
    45 0000001C A3[8A0A]                        mov     [WAV_BUFFER1], ax		; segment
    46                                  
    47 0000001F B80010                  	mov	ax, BUFFERSIZE / 16
    48 00000022 E86601                  	call	memAlloc
    49 00000025 A3[8C0A]                	mov	[WAV_BUFFER2], ax
    50                                  
    51                                  ; Detect/reset AC97 
    52                                  ;
    53 00000028 E8D302                          call    pciFindDevice
    54 0000002B 7342                            jnc     short _1
    55                                  
    56                                  ; couldn't find the audio device!
    57                                  
    58 0000002D 0E                      	push	cs
    59 0000002E 1F                      	pop	ds
    60 0000002F BA[3900]                        mov     dx, noDevMsg
    61 00000032 B409                            mov     ah, 9
    62 00000034 CD21                            int     21h
    63 00000036 E93A01                          jmp     exit
    64                                  
    65                                  ; 17/02/2017
    66 00000039 4572726F723A20556E-     noDevMsg db "Error: Unable to find intel ICH based audio device!",CR,LF,"$"
    66 00000042 61626C6520746F2066-
    66 0000004B 696E6420696E74656C-
    66 00000054 204943482062617365-
    66 0000005D 6420617564696F2064-
    66 00000066 6576696365210D0A24 
    67                                  
    68                                  _1:
    69                                  	; eax = BUS/DEV/FN
    70                                  	;	00000000BBBBBBBBDDDDDFFF00000000
    71                                  	; edx = DEV/VENDOR
    72                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
    73                                  
    74 0000006F 66A3[900A]              	mov	[bus_dev_fn], eax
    75 00000073 668916[940A]            	mov	[dev_vendor], edx
    76                                  
    77                                  	; get ICH base address regs for mixer and bus master
    78                                  
    79 00000078 B010                            mov     al, NAMBAR_REG
    80 0000007A E8F301                          call    pciRegRead16			; read PCI registers 10-11
    81 0000007D 83E2FE                          and     dx, IO_ADDR_MASK 		; mask off BIT0
    82                                  
    83 00000080 8916[840A]                      mov     [NAMBAR], dx			; save audio mixer base addy
    84                                  
    85 00000084 B014                    	mov     al, NABMBAR_REG
    86 00000086 E8E701                          call    pciRegRead16
    87 00000089 83E2FE                          and     dx, IO_ADDR_MASK
    88                                  
    89 0000008C 8916[860A]                      mov     [NABMBAR], dx			; save bus master base addy
    90                                  
    91                                  	; init controller
    92                                  	; 17/02/2017
    93 00000090 B004                    	mov	al, PCI_CMD_REG ; command register (04h)
    94 00000092 E8DB01                  	call	pciRegRead16 ; pciRegRead8
    95                                  
    96                                  	; eax = BUS/DEV/FN/REG
    97                                  	;  dx = PCI Command Register Content ; 17/02/2017
    98                                  	; 	00000000CCCCCCCC
    99 00000095 8916[980A]              	mov	[stats_cmd], dx
   100                                  
   101 00000099 B010                    	mov	al, PCI_IO_BASE ; IO base address register (10h)
   102 0000009B E8E001                  	call	pciRegRead32
   103                                  
   104 0000009E 83E2C0                  	and     dx, 0FFC0h	; IO_ADDR_MASK (0FFFE) ?
   105 000000A1 8916[9A0A]                      mov     [ac97_io_base], dx
   106                                  
   107 000000A5 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
   108 000000A7 E8BE01                  	call	pciRegRead8 ; 17/02/2017
   109                                  
   110 000000AA 8816[8F0A]              	mov     [ac97_int_ln_reg], dl
   111                                  
   112                                  	; 28/11/2016
   113 000000AE BB0100                  	mov	bx, 1
   114 000000B1 30F6                    	xor	dh, dh 	 ; 17/02/2017
   115 000000B3 89D1                    	mov	cx, dx
   116 000000B5 D3E3                    	shl	bx, cl
   117                                  
   118                                  	;not	bx
   119 000000B7 E4A1                    	in	al, 0A1h ; irq 8-15
   120 000000B9 88C4                            mov	ah, al
   121 000000BB E421                            in	al, 21h  ; irq 0-7 
   122                                  	;and	ax, bx   ; unmask
   123 000000BD 0FB3D0                   	btr	ax, dx	 ; unmask
   124 000000C0 E621                    	out	21h, al  ; enable interrupt (if irq <= 7)
   125 000000C2 88E0                    	mov	al, ah
   126 000000C4 E6A1                    	out	0A1h, al ; enable interrupt (if irq > 7)
   127                                  	;not	bx
   128                                  
   129 000000C6 BAD104                  	mov	dx, 4D1h			;8259 ELCR1
   130 000000C9 EC                              in	al, dx
   131 000000CA 88C4                    	mov	ah, al
   132 000000CC BAD004                  	mov	dx, 4D0h 
   133 000000CF EC                              in	al, dx
   134                                  	;or	ax, bx        
   135 000000D0 0FABC8                  	bts	ax, cx
   136 000000D3 BAD004                  	mov	dx, 4D0h
   137 000000D6 EE                      	out	dx, al                          ;set level-triggered mode
   138 000000D7 88E0                    	mov	al, ah
   139 000000D9 BAD104                  	mov	dx, 4D1h
   140 000000DC EE                      	out	dx, al                          ;set level-triggered mode
   141                                  
   142                                  	; 24/11/2016 - Erdogan Tan
   143 000000DD 89CB                    	mov	bx, cx
   144                                  	;mov	bx, dx
   145 000000DF 8A9F[B208]              	mov	bl, [bx+irq_int]
   146 000000E3 C1E302                  	shl	bx, 2 ; * 4
   147                                  
   148                                  	; set up interrupt vector
   149                                  	; 30/11/2016
   150 000000E6 06                      	push	es
   151 000000E7 31C0                    	xor	ax, ax
   152 000000E9 8EC0                    	mov	es, ax
   153 000000EB 26C707[0A08]            	mov	word [es:bx], ac97_int_handler
   154 000000F0 8CC8                    	mov	ax, cs
   155 000000F2 26894702                	mov	[es:bx+2], ax
   156 000000F6 07                      	pop	es
   157                                  		
   158 000000F7 E8A005                  	call	write_ac97_dev_info 
   159                                  
   160                                  ; check the command line for a file to play
   161                                  
   162                                          ;push    ds
   163 000000FA E89700                          call    processCmdline			; get the filename
   164                                  
   165                                  ; open the file
   166 000000FD B002                            mov     al, OPEN                        ; open existing file
   167 000000FF E8B200                          call    openFile                        ; no error? ok.
   168                                          ;pop     ds
   169 00000102 7322                            jnc     short _gsr
   170                                  
   171                                  ; file not found!
   172                                  
   173                                          ;push   cs
   174                                          ;pop    ds
   175 00000104 BA[0D01]                        mov	dx, noFileErrMsg
   176 00000107 B409                            mov     ah, 9
   177 00000109 CD21                            int     21h
   178 0000010B EB66                            jmp     exit
   179                                  
   180 0000010D 4572726F723A206669-     noFileErrMsg  db "Error: file not found.",CR,LF,"$"
   180 00000116 6C65206E6F7420666F-
   180 0000011F 756E642E0D0A24     
   181                                  
   182                                  _gsr:
   183 00000126 E8B200                          call    getSampleRate                   ; read the sample rate
   184                                                                                  ; pass it onto codec.
   185 00000129 7248                    	jc	short exit ; 19/11/2016 - nothing to do
   186                                  
   187 0000012B A3[9C0A]                	mov	[sample_rate], ax
   188                                  	; 19/11/2016
   189 0000012E 880E[9E0A]              	mov	[stmo], cl
   190 00000132 8816[A00A]              	mov	[bps], dl
   191                                  
   192                                  	; 17/02/2017
   193 00000136 C606[A20A]00            	mov	byte [fbs_shift], 0 ; 0 = stereo and 16 bit 
   194 0000013B FEC9                    	dec	cl
   195 0000013D 7504                    	jnz	short _gsr_1 ; stereo
   196 0000013F FE06[A20A]              	inc	byte [fbs_shift] ; 1 = mono or 8 bit		
   197                                  _gsr_1:	
   198 00000143 80FA08                  	cmp	dl, 8 
   199 00000146 7704                    	ja	short _gsr_2 ; 16 bit samples
   200 00000148 FE06[A20A]              	inc	byte [fbs_shift] ; 2 = mono and 8 bit
   201                                  _gsr_2:	
   202 0000014C E86A06                  	call	write_sample_rate
   203                                  
   204                                  	; 17/02/2017
   205 0000014F 8B16[980A]              	mov	dx, [stats_cmd]
   206 00000153 80CA05                          or      dl, IO_ENA+BM_ENA               ; enable IO and bus master
   207 00000156 E88901                          call    pciRegWrite16 ; pciRegWrite8
   208                                  
   209                                  ; setup the Codec (actually mixer registers) 
   210 00000159 E8E501                          call    codecConfig                     ; unmute codec, set rates.
   211                                  	
   212                                  	; 13/05/2024
   213                                  	; 11/11/2023
   214 0000015C 721C                    	jc	short init_err
   215                                  
   216                                  ;
   217                                  ; position file pointer to start in actual wav data
   218                                  ; MUCH improvement should really be done here to check if sample size is
   219                                  ; supported, make sure there are 2 channels, etc.  
   220                                  ;
   221 0000015E B442                            mov     ah, 42h
   222 00000160 B000                            mov     al, 0                           ; from start of file
   223 00000162 8B1E[7E0A]                      mov     bx, [filehandle]
   224 00000166 31C9                            xor     cx, cx
   225 00000168 BA2C00                          mov     dx, 44                          ; jump past .wav/riff header
   226 0000016B CD21                            int     21h
   227                                  
   228                                  ; play the .wav file.  Most of the good stuff is in here.
   229                                  
   230 0000016D E83703                          call    playWav
   231                                  
   232                                  ; close the .wav file and exit.
   233                                  
   234                                  close_exit:	; 13/05/2024
   235 00000170 E85300                          call    closeFile
   236                                  
   237                                  exit:
   238 00000173 B8004C                          mov     ax, 4c00h
   239 00000176 CD21                    	int 	21h
   240                                  
   241                                  here:
   242 00000178 EBFE                    	jmp	short here
   243                                  
   244                                  	; 13/05/2024
   245                                  init_err:
   246 0000017A BA[F809]                	mov	dx, msg_init_err
   247                                  
   248                                  	; 13/05/2024
   249                                  vra_err: ; 12/11/2023
   250                                  	;mov	dx, msg_no_vra
   251 0000017D B409                            mov	ah, 9
   252 0000017F CD21                            int	21h
   253 00000181 EBED                    	jmp	short close_exit
   254                                  
   255                                  ; MEMALLOC.ASM
   256                                  ;-- SETFREE: Release memory not used  ----------------
   257                                  ;-- Input    : ES = address of PSP
   258                                  ;-- Output   : none
   259                                  ;-- Register : AX, BX, CL and FLAGS are changed 
   260                                  ;-- Info     : Since the stack-segment is always the last segment in an 
   261                                  ;              EXE-file, ES:0000 points to the beginning and SS:SP
   262                                  ;              to the end of the program in memory. Through this the
   263                                  ;              length of the program can be calculated 
   264                                  ; call this routine once at the beginning of the program to free up memory
   265                                  ; assigned to it by DOS.
   266                                  
   267                                  setFree:
   268 00000183 BB0010                  	  mov	bx, 65536/16	; 4K paragraphs ; 17/02/2017 (Erdogan Tan)		
   269                                  
   270 00000186 B44A                              mov	ah, 4ah		;pass new length to DOS
   271 00000188 CD21                              int	21h
   272                                  
   273 0000018A C3                                retn			; back to caller 
   274                                  				; new size (allocated memory) = 64KB
   275                                  
   276                                  memAlloc:
   277                                  ; input: AX = # of paragraphs required
   278                                  ; output: AX = segment of block to use
   279                                  
   280 0000018B 53                      	push	bx
   281 0000018C 89C3                    	mov	bx, ax
   282 0000018E B448                    	mov	ah, 48h
   283 00000190 CD21                    	int	21h
   284 00000192 5B                      	pop	bx
   285 00000193 C3                      	retn
   286                                  
   287                                  ; CMDLINE.ASM
   288                                  ; parse the command line
   289                                  ; entry: none
   290                                  ; exit: DS:DX to the 1st supplied item on the command line 
   291                                  
   292                                  processCmdline:
   293 00000194 53                              push    bx
   294 00000195 56                              push    si
   295                                  
   296                                          ;mov    ah, 51h
   297                                          ;int    21h
   298                                          ;mov    ds, bx
   299                                  
   300 00000196 BE8000                          mov     si, 80h
   301 00000199 0FB61C                          movzx   bx, byte [si]
   302 0000019C 01DE                            add     si, bx
   303 0000019E 46                              inc     si
   304                                  
   305 0000019F C60400                          mov     byte [si], NULL         ; zero terminate
   306                                  
   307 000001A2 BE8100                          mov     si, 81h
   308                                  
   309                                  cmdlineloop:
   310 000001A5 AC                              lodsb
   311                                  
   312 000001A6 3C00                            cmp     al, NULL                ; found end of line?
   313 000001A8 7404                            je      short exitpc
   314 000001AA 3C20                            cmp     al, ' '                 ; found a space?
   315 000001AC 74F7                            je      short cmdlineloop
   316                                  
   317                                          ; must be the filename here.
   318                                  exitpc:
   319 000001AE 4E                              dec     si                      ; point to start of filename
   320 000001AF 89F2                            mov     dx, si
   321 000001B1 5E                              pop     si
   322 000001B2 5B                              pop     bx
   323 000001B3 C3                      	retn
   324                                  
   325                                  ; FILE.ASM
   326                                  ;open or create file
   327                                  ;
   328                                  ;input: ds:dx-->filename (asciiz)
   329                                  ;       al=file Mode (create or open)
   330                                  ;output: none  cs:[filehandle] filled
   331                                  ;
   332                                  openFile:
   333 000001B4 50                      	push	ax
   334 000001B5 51                      	push	cx
   335 000001B6 B43B                    	mov	ah, 3bh			; start with a mode
   336 000001B8 00C4                    	add	ah, al			; add in create or open mode
   337 000001BA 31C9                    	xor	cx, cx
   338 000001BC CD21                    	int	21h
   339 000001BE 7203                    	jc	short _of1
   340                                  	;mov	[cs:filehandle], ax
   341 000001C0 A3[7E0A]                	mov	[filehandle], ax
   342                                  _of1:
   343 000001C3 59                      	pop	cx
   344 000001C4 58                      	pop	ax
   345 000001C5 C3                      	retn
   346                                  
   347                                  ; close the currently open file
   348                                  ; input: none, uses cs:[filehandle]
   349                                  closeFile:
   350 000001C6 50                      	push	ax
   351 000001C7 53                      	push	bx
   352 000001C8 833E[7E0A]FF            	cmp	word [filehandle], -1
   353 000001CD 7409                    	jz	short _cf1
   354 000001CF 8B1E[7E0A]              	mov     bx, [filehandle]  
   355 000001D3 B8003E                  	mov     ax,3e00h
   356 000001D6 CD21                            int     21h              ;close file
   357                                  _cf1:
   358 000001D8 5B                      	pop	bx
   359 000001D9 58                      	pop	ax
   360 000001DA C3                      	retn
   361                                  
   362                                  getSampleRate:
   363                                  	; 08/12/2016
   364                                  ; reads the sample rate from the .wav file.
   365                                  ; entry: none - assumes file is already open
   366                                  	; 19/11/2016 - Erdogan Tan
   367                                  ; exit: ax = sample rate (11025, 22050, 44100, 48000)
   368                                  ;	cx = number of channels (mono=1, stereo=2)
   369                                  ;	dx = bits per sample (8, 16)
   370                                  
   371 000001DB 53                      	push    bx
   372                                  
   373 000001DC B442                            mov     ah, 42h
   374 000001DE B000                            mov     al, 0				; from start of file
   375 000001E0 8B1E[7E0A]                      mov     bx, [filehandle]
   376 000001E4 31C9                            xor     cx, cx
   377 000001E6 BA0800                          mov     dx, 08h				; "WAVE"
   378 000001E9 CD21                            int     21h
   379                                  
   380 000001EB BA[620A]                        mov     dx, smpRBuff
   381 000001EE B91C00                          mov     cx, 28				; 28 bytes
   382 000001F1 B43F                    	mov	ah, 3fh
   383 000001F3 CD21                            int     21h
   384                                  
   385 000001F5 813E[620A]5741          	cmp	word [smpRBuff], 'WA'
   386 000001FB 751C                    	jne	short gsr_stc
   387                                  
   388 000001FD 813E[640A]5645          	cmp	word [smpRBuff+2], 'VE'
   389 00000203 7514                    	jne	short gsr_stc
   390                                  
   391 00000205 833E[6E0A]01            	cmp	word [smpRBuff+12], 1	; Offset 20, must be 1 (= PCM)
   392 0000020A 750D                    	jne	short gsr_stc
   393                                  
   394                                  
   395 0000020C 8B0E[700A]              	mov	cx, [smpRBuff+14]	; return num of channels in CX
   396 00000210 A1[720A]                        mov     ax, [smpRBuff+16]	; return sample rate in AX
   397 00000213 8B16[7C0A]              	mov	dx, [smpRBuff+26]	; return bits per sample value in DX
   398                                  gsr_retn:
   399 00000217 5B                              pop     bx
   400 00000218 C3                              retn
   401                                  
   402                                  gsr_stc:
   403 00000219 F9                      	stc
   404 0000021A EBFB                    	jmp	short gsr_retn
   405                                  
   406                                  %include 'ac97.asm' ; 29/11/2016 (AC97 codec configuration)
     1                              <1> ; 12/11/2023
     2                              <1> ; 11/11/2023
     3                              <1> ; 06/11/2023
     4                              <1> ; 05/11/2023
     5                              <1> ; 04/11/2023
     6                              <1> ; 03/11/2023
     7                              <1> ; PCI and AC97 codec functions for wav player
     8                              <1> ; Erdogan Tan (17/02/2017)
     9                              <1> 
    10                              <1> ; ----------------------------------------------------------------------------
    11                              <1> ; PCI.ASM
    12                              <1> ; ----------------------------------------------------------------------------
    13                              <1> 
    14                              <1> ; PCI device register reader/writers.
    15                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    16                              <1> ; 		Last Update: 17/02/2017
    17                              <1> 
    18                              <1> ;===============================================================
    19                              <1> ; 8/16/32bit PCI reader
    20                              <1> ;
    21                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    22                              <1> ;           BIT30 set if 32 bit access requested
    23                              <1> ;           BIT29 set if 16 bit access requested
    24                              <1> ;           otherwise defaults to 8 bit read
    25                              <1> ;
    26                              <1> ; Exit:  DL,DX,EDX register data depending on requested read size
    27                              <1> ;
    28                              <1> ; Note: this routine is meant to be called via pciRegRead8, pciRegread16,
    29                              <1> ;	or pciRegRead32, listed below.
    30                              <1> ;
    31                              <1> ; Note2: don't attempt to read 32bits of data from a non dword aligned reg
    32                              <1> ;	 number. Likewise, don't do 16bit reads from non word aligned reg #
    33                              <1> ; 
    34                              <1> pciRegRead:
    35 0000021C 6653                <1> 	push	ebx
    36 0000021E 51                  <1> 	push	cx
    37 0000021F 6689C3              <1>         mov     ebx, eax                        ; save eax, dh
    38 00000222 88F1                <1>         mov     cl, dh
    39 00000224 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    40 0000022A 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
    41 00000230 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
    42                              <1> 
    43 00000232 BAF80C              <1>         mov     dx, PCI_INDEX_PORT
    44 00000235 66EF                <1>         out     dx, eax                         ; write PCI selector
    45                              <1> 
    46 00000237 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
    47 0000023A 88D8                <1>         mov     al, bl
    48 0000023C 2403                <1>         and     al, 3                           ; figure out which port to
    49 0000023E 00C2                <1>         add     dl, al                          ; read to
    50                              <1> 
    51 00000240 66ED                <1> 	in      eax, dx                         ; do 32bit read
    52 00000242 66F7C300000080      <1>         test    ebx, PCI32
    53 00000249 7403                <1>         jz      short _pregr1
    54                              <1> 
    55 0000024B 6689C2              <1>         mov     edx, eax                        ; return 32bits of data
    56                              <1> _pregr1:
    57 0000024E 89C2                <1> 	mov     dx, ax                          ; return 16bits of data
    58 00000250 66F7C3000000C0      <1>         test    ebx, PCI32+PCI16
    59 00000257 7502                <1>         jnz     short _pregr2
    60 00000259 88CE                <1>         mov     dh, cl                          ; restore dh for 8 bit read
    61                              <1> _pregr2:
    62 0000025B 6689D8              <1>         mov     eax, ebx                        ; restore eax
    63 0000025E 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
    64 00000264 59                  <1> 	pop	cx
    65 00000265 665B                <1> 	pop	ebx
    66 00000267 C3                  <1> 	retn
    67                              <1> 
    68                              <1> pciRegRead8:
    69 00000268 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32             ; set up 8 bit read size
    70 0000026E EBAC                <1>         jmp     short pciRegRead		; call generic PCI access
    71                              <1> 
    72                              <1> pciRegRead16:
    73 00000270 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit read size
    74 00000276 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
    75 0000027C EB9E                <1>         jmp     short pciRegRead
    76                              <1> 
    77                              <1> pciRegRead32:
    78 0000027E 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit read size
    79 00000284 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
    80 0000028A EB90                <1>         jmp     short pciRegRead
    81                              <1> 
    82                              <1> ;===============================================================
    83                              <1> ; 8/16/32bit PCI writer
    84                              <1> ;
    85                              <1> ; Entry: EAX=PCI Bus/Device/fn/register number
    86                              <1> ;           BIT31 set if 32 bit access requested
    87                              <1> ;           BIT30 set if 16 bit access requested
    88                              <1> ;           otherwise defaults to 8bit read
    89                              <1> ;        DL/DX/EDX data to write depending on size
    90                              <1> ;
    91                              <1> ;
    92                              <1> ; note: this routine is meant to be called via pciRegWrite8, pciRegWrite16,
    93                              <1> ; 	or pciRegWrite32 as detailed below.
    94                              <1> ;
    95                              <1> ; Note2: don't attempt to write 32bits of data from a non dword aligned reg
    96                              <1> ;	 number. Likewise, don't do 16bit writes from non word aligned reg #
    97                              <1> ;
    98                              <1> pciRegWrite:
    99 0000028C 6653                <1> 	push	ebx
   100 0000028E 51                  <1> 	push	cx
   101 0000028F 6689C3              <1>         mov     ebx, eax                        ; save eax, dx
   102 00000292 89D1                <1>         mov     cx, dx
   103 00000294 660D00000080        <1>         or      eax, BIT31                      ; make a PCI access request
   104 0000029A 6625FFFFFFBF        <1>         and     eax, ~PCI16 ; NOT PCI16         ; clear out data size request
   105 000002A0 24FC                <1>         and     al, ~3 ; NOT 3                  ; force index to be dword
   106                              <1> 
   107 000002A2 BAF80C              <1>         mov     dx, PCI_INDEX_PORT
   108 000002A5 66EF                <1>         out     dx, eax                         ; write PCI selector
   109                              <1> 
   110 000002A7 BAFC0C              <1>         mov     dx, PCI_DATA_PORT
   111 000002AA 88D8                <1>         mov     al, bl
   112 000002AC 2403                <1>         and     al, 3                           ; figure out which port to
   113 000002AE 00C2                <1>         add     dl, al                          ; write to
   114                              <1> 
   115 000002B0 6689D0              <1>         mov     eax, edx                        ; put data into eax
   116 000002B3 89C8                <1>         mov     ax, cx
   117                              <1> 
   118 000002B5 EE                  <1>         out     dx, al
   119 000002B6 66F7C3000000C0      <1>         test    ebx, PCI16+PCI32                ; only 8bit access? bail
   120 000002BD 740C                <1>         jz      short _pregw1
   121                              <1> 
   122 000002BF EF                  <1>         out     dx, ax                          ; write 16 bit value
   123 000002C0 66F7C300000040      <1>         test    ebx, PCI16                      ; 16bit requested?  bail
   124 000002C7 7502                <1>         jnz     short _pregw1
   125                              <1> 
   126 000002C9 66EF                <1>         out     dx, eax                         ; write full 32bit
   127                              <1> _pregw1:
   128 000002CB 6689D8              <1>         mov     eax, ebx                        ; restore eax
   129 000002CE 6625FFFFFFBF        <1>         and     eax, (~PCI32)+PCI16             ; clear out data size request
   130 000002D4 89CA                <1>         mov     dx, cx                          ; restore dx
   131 000002D6 59                  <1> 	pop	cx
   132 000002D7 665B                <1> 	pop	ebx
   133 000002D9 C3                  <1> 	ret
   134                              <1> 
   135                              <1> pciRegWrite8:
   136 000002DA 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 8 bit write size
   137 000002E0 EBAA                <1>         jmp     short pciRegWrite		; call generic PCI access
   138                              <1> 
   139                              <1> pciRegWrite16:
   140 000002E2 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 16 bit write size
   141 000002E8 660D00000040        <1>         or      eax, PCI16			; call generic PCI access
   142 000002EE EB9C                <1>         jmp     short pciRegWrite
   143                              <1> 
   144                              <1> pciRegWrite32:
   145 000002F0 6625FFFFFF3F        <1>         and     eax, (~PCI16)+PCI32		; set up 32 bit write size
   146 000002F6 660D00000080        <1>         or      eax, PCI32			; call generic PCI access
   147 000002FC EB8E                <1>         jmp     short pciRegWrite
   148                              <1> 
   149                              <1> ; 17/02/2017 (Modifed by Erdogan Tan for various ICH device IDs)
   150                              <1> ;===============================================================
   151                              <1> ; PCIFindDevice: scan through PCI space looking for a device+vendor ID
   152                              <1> ;
   153                              <1> ;  ENTRY: none
   154                              <1> ;; Entry: EAX=Device+Vendor ID
   155                              <1> ;
   156                              <1> ;  Exit: EAX=PCI address if device found
   157                              <1> ;	 EDX=Device+Vendor ID
   158                              <1> ;        CY clear if found, set if not found. EAX invalid if CY set.
   159                              <1> ;
   160                              <1> ; [old stackless] Destroys: ebx, esi, edi, cl
   161                              <1> ;
   162                              <1> pciFindDevice:
   163                              <1> 	;push	cx
   164                              <1> 	;push	eax ; *
   165                              <1> 	;push	esi
   166                              <1> 	;push	edi
   167                              <1> 
   168                              <1>  	;mov     esi, eax                ; save off vend+device ID
   169                              <1> 
   170                              <1> 	; 17/02/2017
   171 000002FE BE[C208]            <1> 	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
   172 00000301 B91500              <1> 	mov	cx, valid_id_count
   173                              <1> pfd_0:
   174 00000304 66BF00FFFF7F        <1>        	mov     edi, (80000000h - 100h) ; start with bus 0, dev 0 func 0
   175                              <1> nextPCIdevice:
   176 0000030A 6681C700010000      <1>         add     edi, 100h
   177 00000311 6681FF00F8FF80      <1>         cmp     edi, 80FFF800h		; scanned all devices?
   178                              <1>         ;stc
   179                              <1>         ;je 	short PCIScanExit       ; not found
   180 00000318 720D                <1> 	jb	short pfd_1
   181 0000031A 66BF00000080        <1> 	mov     edi, 80000000h
   182 00000320 83C604              <1> 	add	si, 4 ; scan for next device ID
   183 00000323 E202                <1> 	loop	pfd_1	 
   184 00000325 F9                  <1> 	stc	
   185                              <1> 	;jmp 	short PCIScanExit
   186 00000326 C3                  <1> 	retn
   187                              <1> pfd_1:
   188 00000327 6689F8              <1>         mov     eax, edi                ; read PCI registers
   189 0000032A E851FF              <1>         call    pciRegRead32
   190                              <1>         ;cmp    edx, esi                ; found device?
   191 0000032D 663B14              <1>         cmp	edx, dword [si]
   192 00000330 75D8                <1> 	jne     short nextPCIdevice
   193                              <1>         ;clc
   194                              <1> PCIScanExit:
   195                              <1> 	;pushf
   196 00000332 66B800000080        <1> 	mov	eax, BIT31
   197 00000338 66F7D0              <1> 	not	eax
   198 0000033B 6621F8              <1> 	and	eax, edi		; return only bus/dev/fn #
   199                              <1> 	;popf
   200                              <1> 
   201                              <1> 	;pop	edi
   202                              <1> 	;pop	esi
   203                              <1> 	;pop	edx ; *
   204                              <1> 	;pop	cx
   205 0000033E C3                  <1> 	retn
   206                              <1> 
   207                              <1> ; ----------------------------------------------------------------------------
   208                              <1> ; CODEC.ASM
   209                              <1> ; ----------------------------------------------------------------------------
   210                              <1> 
   211                              <1> ; codec configuration code. Not much here really.
   212                              <1> ; NASM version: Erdogan Tan (29/11/2016)
   213                              <1> 
   214                              <1> ; enable codec, unmute stuff, set output rate to 44.1
   215                              <1> ; entry: ax = desired sample rate
   216                              <1> 
   217                              <1> ; 11/11/2023
   218                              <1> ; 06/11/2023
   219                              <1> %if 1
   220                              <1> 
   221                              <1> 	; 11/11/2023
   222                              <1> init_ac97_codec_err1:
   223 0000033F F9                  <1> 	stc
   224                              <1> init_ac97_codec_err2:
   225 00000340 C3                  <1> 	retn
   226                              <1> 
   227                              <1> codecConfig:
   228                              <1> 	; 04/11/2023
   229                              <1> 	; 17/02/2017 
   230                              <1> 	; 07/11/2016 (Erdogan Tan)
   231                              <1> 	;PORT_NABM_GLB_CTRL_STAT equ 60h
   232                              <1> 
   233                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   234                              <1>  	; 'AC97_DEF.H'
   235                              <1> 	;AC97_EXTENDED_STATUS equ 002Ah
   236                              <1> 	AC97_EA_SPDIF	equ 0002h
   237                              <1> 	AC97_EA_VRA	equ 0001h
   238                              <1> 	; 04/11/2023
   239                              <1> 	ICH_PO_CR_RESET equ 0002h  ; reset codec
   240                              <1> 	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
   241                              <1> 	ICH_PCM_246_MASK equ 300000h ; 6 channels
   242                              <1> 
   243                              <1> 	; 04/11/2023
   244                              <1> init_ac97_controller:
   245 00000341 66A1[900A]          <1> 	mov	eax, [bus_dev_fn]
   246 00000345 B004                <1> 	mov	al, PCI_CMD_REG
   247 00000347 E826FF              <1> 	call	pciRegRead16		; read PCI command register
   248 0000034A 80CA05              <1> 	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
   249 0000034D E892FF              <1> 	call	pciRegWrite16
   250                              <1> 
   251 00000350 E84901              <1> 	call	delay_100ms
   252                              <1> 
   253                              <1> init_ac97_codec:
   254                              <1> 	; 11/11/2023
   255                              <1> 	; (TRDOS 386 v2.0.5, 'audio.s')
   256 00000353 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   257 00000356 0316[860A]          <1> 	add	dx, [NABMBAR]
   258 0000035A 66ED                <1> 	in	eax, dx
   259                              <1> 	; ?
   260 0000035C BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   261 0000035F 0316[860A]          <1> 	add	dx, [NABMBAR]
   262 00000363 66ED                <1> 	in	eax, dx
   263                              <1> 
   264 00000365 6683F8FF            <1> 	cmp	eax, 0FFFFFFFFh ; -1
   265 00000369 74D4                <1> 	je	short init_ac97_codec_err1
   266                              <1> 
   267 0000036B 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   268 00000371 7503                <1> 	jnz	short _ac97_codec_ready
   269                              <1> 
   270 00000373 E8A600              <1> 	call	reset_ac97_codec
   271                              <1> 	; 11/11/2023
   272                              <1> 	;jc	short init_ac97_codec_err2
   273                              <1> 
   274                              <1> _ac97_codec_ready:
   275 00000376 8B16[840A]          <1> 	mov	dx, [NAMBAR]
   276                              <1> 	;add	dx, 0 ; ac_reg_0 ; reset register
   277 0000037A EF                  <1> 	out	dx, ax
   278                              <1> 
   279 0000037B E81E01              <1> 	call	delay_100ms
   280                              <1> 
   281                              <1> ;	xor	eax, eax ; 0
   282                              <1> ;	mov	dx, [NAMBAR]
   283                              <1> ;	add	dx, CODEC_REG_POWERDOWN
   284                              <1> ;	out	dx, ax
   285                              <1> ;
   286                              <1> ;	; wait for 1 second
   287                              <1> ;	mov	ecx, 1000 ; 1000*0.25ms = 1s
   288                              <1> ;_ac97_codec_rloop:
   289                              <1> ;	call	delay1_4ms
   290                              <1> ;	call	delay1_4ms
   291                              <1> ;	call	delay1_4ms
   292                              <1> ;	call	delay1_4ms
   293                              <1> ;	;mov	dx, [NAMBAR]
   294                              <1> ;	;add	dx, CODEC_REG_POWERDOWN
   295                              <1> ;	in	ax, dx	
   296                              <1> ;	and	ax, 0Fh
   297                              <1> ;	cmp	al, 0Fh
   298                              <1> ;	je	short _ac97_codec_init_ok
   299                              <1> ;	loop	_ac97_codec_rloop 
   300                              <1> ;
   301                              <1> ;init_ac97_codec_err1:
   302                              <1> ;	stc
   303                              <1> ;
   304                              <1> ;init_ac97_codec_err2:
   305                              <1> ;	retn
   306                              <1> 
   307                              <1> _ac97_codec_init_ok:
   308                              <1>         ; 11/11/2023
   309                              <1> 	;mov	al, 2 ; force set 16-bit 2-channel PCM
   310                              <1> 	;mov	dx, GLOB_CNT_REG ; 2Ch
   311                              <1> 	;add	dx, [NABMBAR]
   312                              <1> 	;out	dx, eax
   313                              <1> 
   314                              <1> 	;;call	delay1_4ms
   315                              <1> 
   316 0000037E E86600              <1> 	call 	reset_ac97_controller
   317                              <1> 
   318                              <1> 	; 11/11/2023
   319 00000381 E8F602              <1> 	call	delay1_4ms
   320                              <1> 
   321                              <1> 	;call 	setup_ac97_codec
   322                              <1> 
   323                              <1> setup_ac97_codec:
   324                              <1> 	; 12/11/2023
   325 00000384 813E[9C0A]80BB      <1> 	cmp	word [sample_rate], 48000
   326 0000038A 742F                <1> 	je	short skip_rate
   327                              <1> 
   328                              <1> ; 11/11/2023
   329                              <1> ; 05/11/2023
   330                              <1> ;%if 1
   331                              <1> 	AC97_EA_VRA equ BIT0 ; 11/11/2023
   332                              <1> 
   333                              <1> 	; 11/11/2023
   334 0000038C 8B16[840A]          <1> 	mov    	dx, [NAMBAR]               	
   335 00000390 83C22A              <1> 	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah  	  
   336 00000393 ED                  <1> 	in     	ax, dx
   337 00000394 24FD                <1> 	and	al, ~BIT1 ; Clear DRA
   338 00000396 0C01                <1> 	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
   339 00000398 EF                  <1> 	out	dx, ax			; Enable variable rate audio
   340                              <1> 	
   341 00000399 B90A00              <1> 	mov	cx, 10
   342                              <1> check_vra:
   343 0000039C E8FD00              <1> 	call	delay_100ms
   344                              <1> 
   345                              <1> 	; 11/11/2023
   346 0000039F ED                  <1> 	in	ax, dx
   347 000003A0 A801                <1> 	test	al, AC97_EA_VRA ; 1
   348 000003A2 7509                <1> 	jnz	short set_rate
   349                              <1> 
   350                              <1> 	; 11/11/2023
   351 000003A4 E2F6                <1> 	loop	check_vra
   352                              <1> 
   353                              <1> 	; 12/11/2023
   354 000003A6 58                  <1> 	pop	ax ; discard return address to the caller
   355 000003A7 BA[290A]            <1> 	mov	dx, msg_no_vra
   356 000003AA E9D0FD              <1> 	jmp	vra_err
   357                              <1> 
   358                              <1> set_rate:
   359 000003AD A1[9C0A]            <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   360                              <1> 
   361 000003B0 8B16[840A]          <1> 	mov    	dx, [NAMBAR]               	
   362 000003B4 83C22C              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   363 000003B7 EF                  <1> 	out	dx, ax 			; PCM Front/Center Output Sample Rate
   364                              <1> 
   365 000003B8 E8E100              <1> 	call	delay_100ms
   366                              <1> 
   367                              <1> 	; 12/11/2023
   368                              <1> skip_rate:
   369                              <1> 	; 11/11/2023 (temporary)
   370                              <1> 
   371                              <1> 	;mov   	dx, [NAMBAR]               	
   372                              <1> 	;add   	dx, CODEC_PCM_SURND_DACRATE_REG	; 2Eh  	  
   373                              <1> 	;out	dx, ax 			; PCM Surround Output Sample Rate
   374                              <1> 
   375                              <1> 	;call	delay_100ms
   376                              <1> 
   377                              <1> 	;mov   	dx, [NAMBAR]               	
   378                              <1> 	;add   	dx, CODEC_PCM_LFE_DACRATE_REG	; 30h  	  
   379                              <1> 	;out	dx, ax 			; PCM LFE Output Sample Rate
   380                              <1> 
   381                              <1> 	;call	delay_100ms
   382                              <1> 
   383                              <1> 	; 05/11/2023 (temporary)
   384                              <1> 	;mov	dx, [NAMBAR]               	
   385                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   386                              <1> 	;out	dx, ax 			; PCM Input Sample Rate
   387                              <1> 	;
   388                              <1> 	;call	delay_100ms
   389                              <1> 
   390 000003BB B80202              <1> 	mov	ax, 0202h
   391 000003BE 8B16[840A]          <1>   	mov     dx, [NAMBAR]
   392 000003C2 83C202              <1>   	add     dx, CODEC_MASTER_VOL_REG	;02h 
   393 000003C5 EF                  <1> 	out     dx, ax
   394                              <1> 
   395                              <1> 	; 11/11/2023
   396                              <1>         ;call	delay1_4ms
   397                              <1>         ;call	delay1_4ms
   398                              <1>         ;call	delay1_4ms
   399                              <1>         ;call	delay1_4ms
   400                              <1>  	;
   401                              <1>   	;mov	dx, [NAMBAR]
   402                              <1>   	;add	dx, CODEC_MASTER_MONO_VOL_REG	;06h 
   403                              <1>   	;out	dx, ax
   404                              <1> 
   405                              <1> 	; 11/11/2023
   406                              <1>         ;call	delay1_4ms
   407                              <1>         ;call	delay1_4ms
   408                              <1>         ;call	delay1_4ms
   409                              <1>         ;call	delay1_4ms
   410                              <1> 	;
   411                              <1> 	;mov	ax, 02h
   412                              <1>   	;mov	dx, [NAMBAR]
   413                              <1>   	;add	dx, CODEC_PCBEEP_VOL_REG	;0Ah 
   414                              <1>   	;out	dx, ax
   415                              <1> 
   416 000003C6 E8B102              <1>         call    delay1_4ms
   417 000003C9 E8AE02              <1>         call    delay1_4ms
   418 000003CC E8AB02              <1>         call    delay1_4ms
   419 000003CF E8A802              <1>         call    delay1_4ms
   420                              <1> 
   421                              <1> 	;mov	ax, 0202h
   422 000003D2 8B16[840A]          <1>   	mov     dx, [NAMBAR]
   423 000003D6 83C218              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h 
   424 000003D9 EF                  <1>   	out     dx, ax
   425                              <1> 
   426 000003DA E89D02              <1>         call    delay1_4ms
   427 000003DD E89A02              <1>         call    delay1_4ms
   428 000003E0 E89702              <1>         call    delay1_4ms
   429 000003E3 E89402              <1>         call    delay1_4ms
   430                              <1> 
   431                              <1> 	; 11/11/2023
   432                              <1> 	;mov	ax, 8008h ; Mute
   433                              <1>   	;mov	dx, [NAMBAR]
   434                              <1> 	;add	dx, CODEC_PHONE_VOL_REG		;0Ch
   435                              <1> 	;			 ; AC97_PHONE_VOL ; TAD Input (Mono)
   436                              <1>   	;out	dx, ax
   437                              <1> 	;
   438                              <1>         ;call	delay1_4ms
   439                              <1>         ;call	delay1_4ms
   440                              <1>         ;call	delay1_4ms
   441                              <1> 	;call	delay1_4ms
   442                              <1> 
   443                              <1> 	;mov	ax, 0808h
   444                              <1> 	;mov	dx, [NAMBAR]
   445                              <1> 	;add	dx, CODEC_LINE_IN_VOL_REG ;10h ; Line Input (Stereo)
   446                              <1> 	;out	dx, ax
   447                              <1> 	;
   448                              <1>         ;call	delay1_4ms
   449                              <1>         ;call	delay1_4ms
   450                              <1>         ;call	delay1_4ms
   451                              <1> 	;call	delay1_4ms
   452                              <1> 
   453                              <1>   	;mov	dx, [NAMBAR]
   454                              <1>         ;add	dx, CODEC_CD_VOL_REG ;12h ; CD Input (Stereo)
   455                              <1>   	;out	dx, ax
   456                              <1> 	;
   457                              <1>   	;mov	dx, [NAMBAR]
   458                              <1>         ;add	dx, CODEC_AUX_VOL_REG ;16h ; Aux Input (Stereo)
   459                              <1>   	;out	dx, ax
   460                              <1> 	;
   461                              <1>         ;call	delay1_4ms
   462                              <1>         ;call	delay1_4ms
   463                              <1>         ;call	delay1_4ms
   464                              <1> 	;call	delay1_4ms
   465                              <1> 
   466                              <1> ;detect_ac97_codec:
   467 000003E6 C3                  <1>         retn
   468                              <1> 
   469                              <1> reset_ac97_controller:
   470                              <1> 	; 11/11/2023
   471                              <1> 	; 10/06/2017
   472                              <1> 	; 29/05/2017
   473                              <1> 	; 28/05/2017
   474                              <1> 	; reset AC97 audio controller registers
   475 000003E7 31C0                <1> 	xor     ax, ax
   476 000003E9 BA0B00              <1>         mov	dx, PI_CR_REG
   477 000003EC 0316[860A]          <1> 	add	dx, [NABMBAR]
   478 000003F0 EE                  <1> 	out     dx, al
   479                              <1> 
   480 000003F1 BA1B00              <1>         mov     dx, PO_CR_REG
   481 000003F4 0316[860A]          <1> 	add	dx, [NABMBAR]
   482 000003F8 EE                  <1> 	out     dx, al
   483                              <1> 
   484 000003F9 BA2B00              <1>         mov     dx, MC_CR_REG
   485 000003FC 0316[860A]          <1> 	add	dx, [NABMBAR]
   486 00000400 EE                  <1> 	out     dx, al
   487                              <1> 
   488 00000401 B002                <1>         mov     al, RR
   489 00000403 BA0B00              <1>         mov     dx, PI_CR_REG
   490 00000406 0316[860A]          <1> 	add	dx, [NABMBAR]
   491 0000040A EE                  <1> 	out     dx, al
   492                              <1> 
   493 0000040B BA1B00              <1>         mov     dx, PO_CR_REG
   494 0000040E 0316[860A]          <1> 	add	dx, [NABMBAR]
   495 00000412 EE                  <1> 	out     dx, al
   496                              <1> 
   497 00000413 BA2B00              <1>         mov     dx, MC_CR_REG
   498 00000416 0316[860A]          <1> 	add	dx, [NABMBAR]
   499 0000041A EE                  <1> 	out     dx, al
   500                              <1> 
   501 0000041B C3                  <1> 	retn
   502                              <1> 
   503                              <1> reset_ac97_codec:
   504                              <1> 	; 11/11/2023
   505                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   506 0000041C BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   507 0000041F 0316[860A]          <1> 	add	dx, [NABMBAR]
   508 00000423 66ED                <1> 	in	eax, dx
   509                              <1> 
   510                              <1> 	;test	eax, 2
   511                              <1> 	; 06/08/2022
   512 00000425 A802                <1> 	test	al, 2
   513 00000427 7405                <1> 	jz	short _r_ac97codec_cold	
   514                              <1> 
   515 00000429 E80E00              <1> 	call	warm_ac97codec_reset
   516 0000042C 7306                <1> 	jnc	short _r_ac97codec_ok
   517                              <1> _r_ac97codec_cold:
   518 0000042E E83400              <1>         call    cold_ac97codec_reset
   519 00000431 7301                <1>         jnc     short _r_ac97codec_ok
   520                              <1> 	
   521                              <1> 	; 16/04/2017
   522                              <1>         ;xor	eax, eax	; timeout error
   523                              <1>        	;stc
   524 00000433 C3                  <1> 	retn
   525                              <1> 
   526                              <1> _r_ac97codec_ok:
   527 00000434 6631C0              <1>         xor     eax, eax
   528                              <1>         ;mov	al, VIA_ACLINK_C00_READY ; 1
   529 00000437 FEC0                <1>         inc	al
   530 00000439 C3                  <1> 	retn
   531                              <1> 
   532                              <1> warm_ac97codec_reset:
   533                              <1> 	; 11/11/2023
   534                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   535                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   536 0000043A 66B806000000        <1> 	mov	eax, 6
   537 00000440 BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   538 00000443 0316[860A]          <1> 	add	dx, [NABMBAR]
   539 00000447 66EF                <1> 	out	dx, eax
   540                              <1> 
   541 00000449 B90A00              <1> 	mov	cx, 10	; total 1s
   542                              <1> _warm_ac97c_rst_wait:
   543 0000044C E84D00              <1> 	call	delay_100ms
   544                              <1> 
   545 0000044F BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   546 00000452 0316[860A]          <1> 	add	dx, [NABMBAR]
   547 00000456 66ED                <1> 	in	eax, dx
   548                              <1> 
   549 00000458 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   550 0000045E 7504                <1> 	jnz	short _warm_ac97c_rst_ok
   551                              <1> 
   552 00000460 49                  <1>         dec     cx
   553 00000461 75E9                <1>         jnz     short _warm_ac97c_rst_wait
   554                              <1> 
   555                              <1> _warm_ac97c_rst_fail:
   556 00000463 F9                  <1>         stc
   557                              <1> _warm_ac97c_rst_ok:
   558 00000464 C3                  <1> 	retn
   559                              <1> 
   560                              <1> cold_ac97codec_reset:
   561                              <1> 	; 11/11/2023
   562                              <1> 	; 06/08/2022 - TRDOS 386 v2.0.5
   563                              <1> 	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
   564 00000465 66B802000000        <1>         mov	eax, 2
   565 0000046B BA2C00              <1> 	mov	dx, GLOB_CNT_REG ; 2Ch
   566 0000046E 0316[860A]          <1> 	add	dx, [NABMBAR]
   567 00000472 66EF                <1> 	out	dx, eax
   568                              <1> 
   569 00000474 E82500              <1> 	call	delay_100ms 	; wait 100 ms
   570 00000477 E82200              <1> 	call	delay_100ms 	; wait 100 ms
   571 0000047A E81F00              <1> 	call	delay_100ms 	; wait 100 ms
   572 0000047D E81C00              <1> 	call	delay_100ms 	; wait 100 ms
   573                              <1> 
   574 00000480 B91000              <1> 	mov	cx, 16	; total 20*100 ms = 2s
   575                              <1> 
   576                              <1> _cold_ac97c_rst_wait:
   577 00000483 BA3000              <1> 	mov	dx, GLOB_STS_REG ; 30h
   578 00000486 0316[860A]          <1> 	add	dx, [NABMBAR]
   579 0000048A 66ED                <1> 	in	eax, dx
   580                              <1> 
   581 0000048C 66A900030010        <1> 	test	eax, CTRL_ST_CREADY
   582 00000492 7507                <1> 	jnz	short _cold_ac97c_rst_ok
   583                              <1> 
   584 00000494 E80500              <1> 	call	delay_100ms
   585                              <1> 
   586 00000497 49                  <1>         dec     cx
   587 00000498 75E9                <1>         jnz     short _cold_ac97c_rst_wait
   588                              <1> 
   589                              <1> _cold_ac97c_rst_fail:
   590 0000049A F9                  <1>         stc
   591                              <1> _cold_ac97c_rst_ok:
   592 0000049B C3                  <1> 	retn
   593                              <1> 
   594                              <1> delay_100ms:
   595                              <1> 	; 11/11/2023
   596                              <1> 	; 29/05/2017
   597                              <1> 	; 24/03/2017 ('codec.asm')
   598                              <1> 	; wait 100 ms
   599 0000049C 51                  <1> 	push	cx
   600 0000049D B99001              <1> 	mov	cx, 400  ; 400*0.25ms
   601                              <1> _delay_x_ms:
   602 000004A0 E8D701              <1> 	call	delay1_4ms
   603 000004A3 E2FB                <1>         loop	_delay_x_ms
   604 000004A5 59                  <1> 	pop	cx
   605 000004A6 C3                  <1> 	retn
   606                              <1> 
   607                              <1> %endif
   608                              <1> 
   609                              <1> ; 11/11/2023
   610                              <1> %if 0
   611                              <1> 
   612                              <1> codecConfig:
   613                              <1> 	; 06/11/2023
   614                              <1> 	; TUNELOOP version (playing without interrupt)
   615                              <1> 	; 04/11/2023
   616                              <1> 	; 17/02/2017 
   617                              <1> 	; 07/11/2016 (Erdogan Tan)
   618                              <1> 
   619                              <1> 	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
   620                              <1> 
   621                              <1> 	mov    	dx, [NAMBAR]               	
   622                              <1> 	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
   623                              <1> 	out	dx, ax 				; out sample rate
   624                              <1> 		
   625                              <1> 	; 05/11/2023 temp
   626                              <1> 	;mov	dx, [NAMBAR]               	
   627                              <1> 	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
   628                              <1> 	;out	dx, ax 
   629                              <1> 
   630                              <1>         call    delay1_4ms
   631                              <1>         call    delay1_4ms
   632                              <1>         call    delay1_4ms
   633                              <1>         call    delay1_4ms
   634                              <1> 
   635                              <1> 	mov	eax, [dev_vendor]
   636                              <1>         cmp	eax, (SI7012_DID<<16)+SIS_VID
   637                              <1>         jne	short cConfig1
   638                              <1> 
   639                              <1> 	; Unmute quirk specifically for the SiS7012
   640                              <1> 
   641                              <1> 	CUSTOM_SIS_7012_REG equ 4Ch ; SiS7012-specific register
   642                              <1> 	
   643                              <1>         mov     dx, [NABMBAR]
   644                              <1>         add     dx, CUSTOM_SIS_7012_REG
   645                              <1>         in      ax, dx
   646                              <1>         or	al, 1
   647                              <1>         out     dx, ax
   648                              <1> 
   649                              <1> cConfig1:
   650                              <1> 	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
   651                              <1> 	; initial ac97 volumes (and clear mute flag)
   652                              <1> 		
   653                              <1>   	mov     dx, [NAMBAR]
   654                              <1>   	add     dx, CODEC_MASTER_VOL_REG        ;02h ; STEREO
   655                              <1>   	;xor	ax, ax ; volume attenuation = 0 (max. volume)
   656                              <1>   	; 03/11/2023
   657                              <1> 	mov	ax, 0202h
   658                              <1> 	out     dx, ax
   659                              <1> 
   660                              <1>         call    delay1_4ms	; delays because codecs are slow
   661                              <1>         call    delay1_4ms
   662                              <1>         call    delay1_4ms
   663                              <1>         call    delay1_4ms
   664                              <1>  
   665                              <1>   	mov     dx, [NAMBAR]
   666                              <1>   	add     dx, CODEC_PCM_OUT_REG		;18h
   667                              <1>   	;;xor	ax, ax
   668                              <1> 	;mov	ax, 0202h
   669                              <1>   	out     dx, ax
   670                              <1> 
   671                              <1>         call    delay1_4ms
   672                              <1>         call    delay1_4ms
   673                              <1>         call    delay1_4ms
   674                              <1>         call    delay1_4ms
   675                              <1>  
   676                              <1> 	retn
   677                              <1> 
   678                              <1> %endif
   407                                  %include 'ich_wav.asm' ; 17/02/2017 (ICH AC97 wav playing functions)
     1                              <1> ; 11/11/2023
     2                              <1> ; 08/11/2023
     3                              <1> ; 06/11/2023
     4                              <1> ; 05/11/2023
     5                              <1> ; 04/11/2023
     6                              <1> ; 03/11/2023
     7                              <1> ; DOS based .WAV player using AC'97 and codec interface.
     8                              <1> ; ---------------------------------------------------------------
     9                              <1> ; NASM version: Erdogan Tan (29/11/2016)
    10                              <1> ; Last Update: 17/02/2017 (by Erdogan Tan)
    11                              <1> 
    12                              <1> ; TUNELOOP version (playing without interrupt) - 06/11/2023 - Erdogan Tan
    13                              <1> 
    14                              <1> ; ICHWAV.ASM
    15                              <1> 
    16                              <1> ; player internal variables and other equates.
    17                              <1> BUFFERSIZE      equ     64 * 1024       ; 64k file buffer size.
    18                              <1> ENDOFFILE       equ     BIT0            ; flag for knowing end of file
    19                              <1> 
    20                              <1> ;===========================================================================
    21                              <1> ; entry: none. File is already open and [filehandle] filled.
    22                              <1> ; exit:  not until the song is finished or the user aborts.
    23                              <1> ;
    24                              <1> playWav:
    25                              <1> 	; 07/11/2023
    26                              <1> 	; clear buffer 2
    27                              <1>         ;push	es
    28                              <1> 	;mov	ax, [WAV_BUFFER2]
    29                              <1> 	;mov	es, ax
    30                              <1> 	;sub	ax, ax
    31                              <1> 	;mov	di, ax ; 17/02/2017
    32                              <1> 	;mov	cx, (BUFFERSIZE/2)
    33                              <1> 	;rep	stosw
    34                              <1> 	;pop	es	     
    35                              <1> 	
    36                              <1> 	; load 64k into buffer 1
    37 000004A7 A1[8A0A]            <1>         mov     ax, [WAV_BUFFER1]
    38 000004AA E8C000              <1>         call    loadFromFile
    39                              <1> 
    40                              <1> 	; and 64k into buffer 2
    41 000004AD A1[8C0A]            <1> 	mov     ax, [WAV_BUFFER2]
    42 000004B0 E8BA00              <1>        	call    loadFromFile
    43                              <1> 
    44                              <1> ; register reset the DMA engine. This may cause a pop noise on the output
    45                              <1> ; lines when the device is reset. Prolly a better idea to mute output, then
    46                              <1> ; reset.
    47                              <1> ;
    48                              <1> 	; 11/11/2023
    49                              <1>         ;mov	dx, [NABMBAR]
    50                              <1>         ;add	dx, PO_CR_REG		; set pointer to Ctrl reg
    51                              <1>         ;mov	al, RR			; set reset
    52                              <1> 	;out	dx, al			; self clearing bit
    53                              <1> 
    54                              <1> ; write last valid index to 31 to start with.
    55                              <1> ; The Last Valid Index register tells the DMA engine when to stop playing.
    56                              <1> ; 
    57                              <1> ; As we progress through the song we change the last valid index to always be
    58                              <1> ; something other than the index we're currently playing.  
    59                              <1> ;
    60                              <1> 	; 08/11/2023
    61                              <1> 	;; 07/11/2023
    62                              <1> 	;mov	al, 1
    63                              <1>         ;;mov	al, 31
    64                              <1> 	;call	setLastValidIndex
    65                              <1> 
    66                              <1> ; create Buffer Descriptor List
    67                              <1> ;
    68                              <1> ; A buffer descriptor list is a list of pointers and control bits that the
    69                              <1> ; DMA engine uses to know where to get the .wav data and how to play it.
    70                              <1> ;
    71                              <1> ; I set it up to use only 2 buffers of .wav data, and whenever 1 buffer is
    72                              <1> ; playing, I refresh the other one with good data.
    73                              <1> ;
    74                              <1> ;
    75                              <1> ; For the control bits, you can specify that the DMA engine fire an interrupt
    76                              <1> ; after a buffer has been processed, but I poll the current index register
    77                              <1> ; to know when it's safe to update the other buffer.
    78                              <1> ;
    79                              <1> ; I set the BUP bit, which tells the DMA engine to just play 0's (silence)
    80                              <1> ; if it ever runs out of data to play. Good for safety.
    81                              <1> ;
    82 000004B3 06                  <1>         push    es
    83 000004B4 A1[880A]            <1>         mov     ax, [BDL_BUFFER]		; get segment # for BDL
    84 000004B7 8EC0                <1>         mov     es, ax
    85                              <1> 
    86 000004B9 B91000              <1>         mov     cx, 32 / 2                      ; make 32 entries in BDL
    87 000004BC 31FF                <1>         xor     di, di                          
    88                              <1> _0:
    89                              <1> 
    90                              <1> ; set buffer descriptor 0 to start of data file in memory
    91 000004BE 660FB706[8A0A]      <1>         movzx   eax, word [WAV_BUFFER1]
    92 000004C4 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
    93 000004C8 66AB                <1>         stosd                                   ; store pointer to wavbuffer1
    94                              <1> 
    95                              <1> ;
    96                              <1> ; set length to 32k samples. 1 sample is 16bits or 2bytes.
    97                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples.
    98                              <1> ; 
    99                              <1> 
   100                              <1> ; 17/02/2017 (Erdogan Tan)
   101                              <1> ; Intel 82801AA (ICH) & Intel 82801AB (ICH0) I/O Controller Hub AC97
   102                              <1> ; Programmers Reference Manual
   103                              <1> 
   104                              <1> ; 2.2.1 Buffer Descriptor List  (on Page 13)
   105                              <1> 	;
   106                              <1> 	;  Generic Form of Buffer Descriptor
   107                              <1> 	;  ---------------------------------
   108                              <1> 	;  63   62    61-48    47-32   31-0
   109                              <1> 	;  ---  ---  --------  ------- -----
   110                              <1> 	;  IOC  BUP -reserved- Buffer  Buffer
   111                              <1> 	;		      Length   Pointer
   112                              <1> 	;		      [15:0]   [31:0]
   113                              <1> 	;
   114                              <1> 	;  IOC:	Interrupt On Completion. 
   115                              <1> 	;	1 = Enabled. 
   116                              <1> 	;	    When this is set, it means that the controller should
   117                              <1> 	;	    issue an interrupt upon completion of this buffer.
   118                              <1> 	;	    It should also set the IOC bit in the status register
   119                              <1> 	;	0 = Disabled	
   120                              <1> 	;
   121                              <1> 	;  BUP: Buffer Underrun Policy.
   122                              <1> 	;       0 = When this buffer is complete,
   123                              <1> 	;	    if the next buffer is not yet ready 
   124                              <1> 	;	    (i.e., the last valid buffer has been processed),
   125                              <1> 	;	    then continue to transmit the last valid sample.
   126                              <1> 	;	1 = When this buffer is complete,
   127                              <1> 	;     	    if this is the last valid buffer, transmit zeros after
   128                              <1> 	;	    this buffer has been processed completely.
   129                              <1> 	;	    This bit typically is set only if this is the last 
   130                              <1> 	;	    buffer in the current stream.
   131                              <1> 	;
   132                              <1> 	; [31:0]: Buffer pointer. This field points to the location of
   133                              <1> 	;	  the data buffer. Since samples can be as wide as one
   134                              <1> 	;	  word, the buffer must be aligned with word boundaries,
   135                              <1> 	;	  to prevent samples from straddling DWord boundaries.
   136                              <1> 	;
   137                              <1> 	; [15:0]: Buffer Length: This is the length of the data buffer,
   138                              <1> 	;	  in number of samples. The controller uses this data
   139                              <1> 	;	  to determine the length of the buffer, in bytes.
   140                              <1> 	;	  "0" indicates no sample to process.
   141                              <1> 
   142                              <1> ; ICH2AC97.INC
   143                              <1> 
   144                              <1> ;	IOC	equ     BIT31   ; Fire an interrupt whenever this
   145                              <1> 				; buffer is complete.
   146                              <1> 
   147                              <1> ;	BUP	equ     BIT30   ; Buffer Underrun Policy.
   148                              <1> 				; if this buffer is the last buffer
   149                              <1> 				; in a playback, fill the remaining
   150                              <1> 				; samples with 0 (silence) or not.
   151                              <1> 				; It's a good idea to set this to 1
   152                              <1> 				; for the last buffer in playback,
   153                              <1> 				; otherwise you're likely to get a lot
   154                              <1> 				; of noise at the end of the sound.
   155                              <1> ;
   156                              <1> ; Bits 15:0 contain the length of the buffer, in number of samples, which
   157                              <1> ; are 16 bits each, coupled in left and right pairs, or 32bits each.
   158                              <1> ; Luckily for us, that's the same format as .wav files.
   159                              <1> ;
   160                              <1> ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
   161                              <1> ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
   162                              <1> ;
   163                              <1> ; A value of 0 in these bits means play no samples.
   164                              <1> ;
   165                              <1> 
   166                              <1> ; ICHWAV.ASM
   167                              <1> 
   168 000004CA 66B800800000        <1> 	mov	eax, BUFFERSIZE / 2 ; size of half buffer (32K)
   169                              <1> 	;or	eax, IOC + BUP
   170                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   171 000004D0 660D00000040        <1> 	or	eax, BUP
   172 000004D6 66AB                <1> 	stosd
   173                              <1> 
   174                              <1> ; 2nd buffer:
   175                              <1> 
   176 000004D8 660FB706[8C0A]      <1>         movzx   eax, word [WAV_BUFFER2]
   177 000004DE 66C1E004            <1>         shl     eax, 4                          ; convert seg:off ->0:offset
   178 000004E2 66AB                <1>         stosd                                   ; store pointer to wavbuffer2
   179                              <1> 
   180                              <1> ; set length to 64k (32k of two 16 bit samples)
   181                              <1> ; Set control (bits 31:16) to BUP, bits 15:0=number of samples
   182                              <1> ; 
   183 000004E4 66B800800000        <1> 	mov	eax, BUFFERSIZE / 2
   184                              <1> 	;or	eax, IOC + BUP
   185                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   186 000004EA 660D00000040        <1> 	or	eax, BUP
   187 000004F0 66AB                <1> 	stosd
   188                              <1> 
   189 000004F2 E2CA                <1>         loop    _0
   190 000004F4 07                  <1>         pop     es
   191                              <1> 
   192                              <1> ;
   193                              <1> ; tell the DMA engine where to find our list of Buffer Descriptors.
   194                              <1> ; this 32bit value is a flat mode memory offset (ie no segment:offset)
   195                              <1> ;
   196                              <1> ; write NABMBAR+10h with offset of buffer descriptor list
   197                              <1> ;
   198 000004F5 660FB706[880A]      <1>         movzx   eax, word [BDL_BUFFER]
   199 000004FB 66C1E004            <1> 	shl     eax, 4                          ; convert seg:off to 0:off
   200 000004FF 8B16[860A]          <1>         mov     dx, [NABMBAR]
   201 00000503 83C210              <1>         add     dx, PO_BDBAR_REG                ; set pointer to BDL
   202 00000506 66EF                <1>         out     dx, eax                         ; write to AC97 controller
   203                              <1> 
   204                              <1> ;
   205                              <1> ; All set. Let's play some music.
   206                              <1> ;
   207                              <1> 
   208                              <1> 	; 08/11/2023
   209                              <1> 	; 07/11/2023
   210                              <1> 	; 08/12/2016
   211                              <1> 	; 07/10/2016
   212                              <1>         ;mov	al, 1
   213 00000508 B01F                <1>         mov	al, 31
   214 0000050A E85801              <1> 	call	setLastValidIndex
   215                              <1> 
   216                              <1> 	; 06/11/2023 (not neccessary)
   217                              <1> 	;; 05/11/2023
   218                              <1> 	;; reset current index
   219                              <1> 	;mov	al, 0
   220                              <1> 	;call	setCurrentIndex
   221                              <1> 
   222                              <1> 	; 06/11/2023
   223                              <1> 	;mov	byte [tLoop], 1 ; 30/11/2016
   224                              <1> 
   225                              <1> 	; 17/02/2017
   226 0000050D 8B16[860A]          <1>         mov     dx, [NABMBAR]
   227 00000511 83C21B              <1>         add     dx, PO_CR_REG                   ; PCM out Control Register
   228                              <1>         ;mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
   229                              <1> 	;			; (LVBI interrupt will not be enabled)
   230                              <1> 	; 06/11/2023 (TUNELOOP version, without interrupt)
   231 00000514 B001                <1> 	mov	al, RPBM
   232 00000516 EE                  <1> 	out     dx, al                          ; Start bus master operation.
   233                              <1> 
   234                              <1> 	; 06/11/2023
   235                              <1> 	;call	delay1_4ms
   236                              <1> 	;call	delay1_4ms
   237                              <1> 	;call	delay1_4ms
   238                              <1> 	;call	delay1_4ms
   239                              <1> 
   240                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   241                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   242                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   243                              <1>    
   244                              <1> ; 06/11/2023 (TUNELOOP version, without interrupt)
   245                              <1> %if 0
   246                              <1> 	; 08/12/2016
   247                              <1> 	; 28/11/2016
   248                              <1> p_loop:
   249                              <1> 	call    check4keyboardstop      ; keyboard halt?
   250                              <1>         jc	short r_loop 	; no ; 05/11/2023
   251                              <1> 
   252                              <1> 	;mov	byte [tLoop], 0
   253                              <1> 	; 04/11/2023
   254                              <1> 	;mov	byte [audio_play_cmd], 0
   255                              <1> 	;call	ac97_stop
   256                              <1> 	;retn
   257                              <1> _exit_:
   258                              <1> 	; 04/11/2023
   259                              <1> 	; finished with song, stop everything
   260                              <1> 	call	ac97_stop
   261                              <1> 	
   262                              <1> 	; restore previous interrupt vector and interrupt_status
   263                              <1> 	cli
   264                              <1> 	in	al, 0A1h ; irq 8-15
   265                              <1> 	mov	al, [IRQ_status+1]
   266                              <1> 	out	0A1h, al 
   267                              <1> 	in	al, 021h ; irq 0-7
   268                              <1> 	mov	al, [IRQ_status]
   269                              <1> 	out	21h, al 
   270                              <1> 	; ...
   271                              <1> 	push	es
   272                              <1> 	xor	ax, ax
   273                              <1> 	mov	es, ax
   274                              <1> 	mov	ax, [IRQ_vector]
   275                              <1> 	mov	[es:bx], ax
   276                              <1> 	mov	ax, [IRQ_vector+2]
   277                              <1> 	mov	[es:bx+2], ax
   278                              <1> 	pop	es
   279                              <1> 	sti
   280                              <1> 	retn
   281                              <1> 
   282                              <1> r_loop:
   283                              <1> 	; 07/12/2016 - Erdogan Tan
   284                              <1> 	nop
   285                              <1> 	nop
   286                              <1> 	nop
   287                              <1> 	; 17/02/2017
   288                              <1> 	mov	al, [tBuff]
   289                              <1> 	dec	al ; 1-32 -> 0-31 or 0 -> 0FFh
   290                              <1> 	js	short  p_loop
   291                              <1> 	mov	byte [tBuff], 0 ; reset
   292                              <1> 	and	al, 1
   293                              <1> 	jnz	short q_loop
   294                              <1>         mov     ax, [WAV_BUFFER2] ; [tBuff]=2 (from tuneLoop)
   295                              <1> s_loop:
   296                              <1>         call    loadFromFile
   297                              <1> 	;jc	short _exit_
   298                              <1> 	; 05/11/2023
   299                              <1> 	jc	short exit_loop
   300                              <1> 	jmp	short r_loop
   301                              <1> q_loop:
   302                              <1>      	mov     ax, [WAV_BUFFER1] ; [tBuff]=1 (from tuneLoop)
   303                              <1>         ;call	loadFromFile
   304                              <1> 	;jc	short _exit_
   305                              <1> 	;jmp	short r_loop
   306                              <1> 	; 05/11/2023
   307                              <1> 	jmp	short s_loop
   308                              <1> 
   309                              <1> exit_loop: 
   310                              <1> 	mov	byte [tLoop], 0
   311                              <1> 	retn
   312                              <1> 		
   313                              <1> tuneLoop:
   314                              <1> 	; 05/11/2023
   315                              <1> 	; 08/12/2016
   316                              <1> 	; 28/11/2016 - Erdogan Tan
   317                              <1> 	
   318                              <1> 	cmp	byte [tLoop], 1
   319                              <1> 	jb	short _exit_ ; 05/11/2023
   320                              <1> _tlp_1:	
   321                              <1> 	; 17/02/2017
   322                              <1> 	call	getCurrentIndex
   323                              <1> 	inc	al ; 0-31 -> 1-32
   324                              <1> 	mov	[tBuff], al
   325                              <1> 
   326                              <1> 	; 05/11/2023
   327                              <1> 	dec	ax
   328                              <1> 	dec	ax
   329                              <1> 	and	al, 1Fh
   330                              <1> 	call	setLastValidIndex
   331                              <1> 
   332                              <1> 	; 05/11/2023
   333                              <1> 	; 17/02/2017 - Buffer switch test (temporary)
   334                              <1> 	push	ds
   335                              <1> 	push	si 
   336                              <1> 	mov	si, 0B800h ; video display page segment
   337                              <1> 	mov	ds, si
   338                              <1> 	sub	si, si ; 0
   339                              <1> 	mov	ah, 4Eh
   340                              <1> 	and	al, 1
   341                              <1> 	add	al, '1'
   342                              <1> 	mov	[si], ax ; show current play buffer (1, 2)
   343                              <1> 	pop	si
   344                              <1> 	pop	ds
   345                              <1> 
   346                              <1> 	; 17/02/2017
   347                              <1> 
   348                              <1> 	;test	byte [irq_status], LVBCI ; last buff completion intr.
   349                              <1> 	;jz	short _tlp2 ; BCIS ; Buffer completion interrupt
   350                              <1> 
   351                              <1> 	; Last Valid Buffer Completion Interrupt (LVBCI).
   352                              <1> 	;   1 = Last valid buffer has been processed. 
   353                              <1> 	;	It remains active until cleared by software. 
   354                              <1> 	;	This bit indicates the occurrence of the event 
   355                              <1> 	;	signified by the last valid buffer being processed.
   356                              <1> 	;	Thus, this is an event status bit that can be cleared
   357                              <1> 	;	by software once this event has been recognized.
   358                              <1> 	;	This event causes an interrupt if the enable bit
   359                              <1> 	;	in the Control Register is set. The interrupt is
   360                              <1> 	;	cleared when the software clears this bit.
   361                              <1> 	;	In the case of Transmits (PCM out, Modem out) this bit
   362                              <1> 	;	is set, after the last valid buffer has been
   363                              <1> 	;	fetched (not after transmitting it).
   364                              <1> 	;	While in the case of Receives, this bit is set after
   365                              <1> 	;	the data for the last buffer has been written to memory.
   366                              <1> 	;   0 = Cleared by writing a "1" to this bit position.
   367                              <1> 
   368                              <1> 	; Note: We are not using LVBCI 
   369                              <1> 	;     Last Buffer Completion Interrupt !!!
   370                              <1> 
   371                              <1> 	; 17/02/2017
   372                              <1>         ;mov     dx, [NABMBAR]
   373                              <1>         ;add     dx, PO_SR_REG	; PCM out Status register
   374                              <1>         ;mov     al, [irq_status]
   375                              <1>         ;out     dx, al		; Clear (LVBCI) interrupt status
   376                              <1> 	;retn
   377                              <1> 
   378                              <1> ;_tlp2:
   379                              <1> 	; Buffer Completion Interrupt Status (BCIS).
   380                              <1> 	;   1 =	Set by the hardware after the last sample 
   381                              <1> 	; 	of a buffer has been processed, AND if the Interrupt
   382                              <1> 	; 	on Completion (IOC) bit is set in the command byte of 
   383                              <1> 	; 	the buffer descriptor. It remains active
   384                              <1> 	; 	until cleared by software.
   385                              <1> 	;   0 =	Cleared by writing a "1" to this bit position.
   386                              <1> 
   387                              <1> 	; 17/02/2017
   388                              <1>         mov     dx, [NABMBAR]
   389                              <1>         add     dx, PO_SR_REG	; PCM out Status register
   390                              <1>         mov     al, [pcm_irq_status] ; 05/11/2023
   391                              <1>         out     dx, al		; Clear (BCI) interrupt status
   392                              <1> 	retn
   393                              <1> 
   394                              <1> ;_exit_:
   395                              <1> ;	mov	byte [tLoop], 0
   396                              <1> ;_exit:
   397                              <1> ;       ; finished with song, stop everything
   398                              <1> ;	mov     dx, [NABMBAR]		
   399                              <1> ;       add     dx, PO_CR_REG           ; PCM out Control Register
   400                              <1> ;       mov     al, 0
   401                              <1> ;       out     dx, al                  ; stop player
   402                              <1> ;_return:
   403                              <1> ;	retn
   404                              <1> 
   405                              <1> %endif
   406                              <1> 
   407                              <1> ; while DMA engine is running, examine current index and wait until it hits 1
   408                              <1> ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
   409                              <1> ; 64k. Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
   410                              <1> 
   411                              <1> ; 08/11/2023
   412                              <1> ; 07/11/2023
   413                              <1> %if 1
   414                              <1> 
   415                              <1> tuneLoop:
   416                              <1> 	; 08/11/2023
   417                              <1> 	; 06/11/2023
   418 00000517 B031                <1> 	mov	al, '1'
   419 00000519 E84300              <1> 	call	tL0
   420                              <1> tL1:
   421 0000051C E81B01              <1> 	call    updateLVI	; /set LVI != CIV/
   422 0000051F 7432                <1> 	jz	short _exit_	; 08/11/2023
   423 00000521 E84A01              <1> 	call    check4keyboardstop
   424 00000524 722D                <1> 	jc	short _exit_
   425 00000526 E80801              <1> 	call    getCurrentIndex
   426 00000529 A801                <1> 	test	al, BIT0
   427 0000052B 74EF                <1> 	jz	short tL1	; loop if buffer 2 is not playing
   428                              <1> 
   429                              <1> 	; load buffer 1
   430 0000052D A1[8A0A]            <1> 	mov     ax, [WAV_BUFFER1]
   431 00000530 E83A00              <1> 	call	loadFromFile
   432 00000533 721E                <1> 	jc	short _exit_	; end of file
   433                              <1> 
   434 00000535 B032                <1> 	mov	al, '2'
   435 00000537 E82500              <1> 	call	tL0
   436                              <1> tL2:
   437 0000053A E8FD00              <1> 	call    updateLVI
   438 0000053D 7414                <1> 	jz	short _exit_	; 08/11/2023
   439 0000053F E82C01              <1> 	call    check4keyboardstop
   440 00000542 720F                <1> 	jc	short _exit_
   441 00000544 E8EA00              <1> 	call    getCurrentIndex
   442 00000547 A801                <1> 	test	al, BIT0
   443 00000549 75EF                <1> 	jnz	short tL2	; loop if buffer 1 is not playing
   444                              <1> 
   445                              <1> 	; load buffer 2
   446 0000054B A1[8C0A]            <1> 	mov     ax, [WAV_BUFFER2]
   447 0000054E E81C00              <1> 	call	loadFromFile
   448 00000551 73C4                <1> 	jnc	short tuneLoop
   449                              <1> _exit_:
   450 00000553 8B16[860A]          <1> 	mov	dx, [NABMBAR]		
   451 00000557 83C21B              <1> 	add	dx, PO_CR_REG	; PCM out Control Register
   452 0000055A B000                <1> 	mov	al, 0
   453 0000055C EE                  <1> 	out	dx, al		; stop player
   454                              <1> 
   455 0000055D 0430                <1> 	add	al, '0'
   456                              <1> 	;call	tL0
   457                              <1> 	;
   458                              <1> 	;retn
   459                              <1> 	; 06/11/2023
   460                              <1> 	;jmp	short tL0
   461                              <1> 	;retn
   462                              <1> 
   463                              <1> 	; 06/11/2023
   464                              <1> tL0:
   465                              <1> 	; 08/11/2023
   466                              <1> 	; 05/11/2023
   467                              <1> 	; 17/02/2017 - Buffer switch test (temporary)
   468                              <1> 	; 06/11/2023
   469                              <1> 	; al = buffer indicator ('1', '2' or '0' -stop- )
   470 0000055F 1E                  <1> 	push	ds
   471                              <1> 	;push	bx 
   472 00000560 BB00B8              <1> 	mov	bx, 0B800h ; video display page segment
   473 00000563 8EDB                <1> 	mov	ds, bx
   474 00000565 29DB                <1> 	sub	bx, bx ; 0
   475 00000567 B44E                <1> 	mov	ah, 4Eh
   476 00000569 8907                <1> 	mov	[bx], ax ; show current play buffer (1, 2)
   477                              <1> 	;pop	bx
   478 0000056B 1F                  <1> 	pop	ds
   479 0000056C C3                  <1> 	retn
   480                              <1> 
   481                              <1> %endif
   482                              <1> 
   483                              <1> ; 08/11/2023
   484                              <1> ; 07/11/2023
   485                              <1> %if 0
   486                              <1> 
   487                              <1> tuneLoop:
   488                              <1> 	; 07/11/2023
   489                              <1> 	;mov	dx, NABMBAR
   490                              <1> 	;add	dx, PO_CIV_REG ; 14h
   491                              <1> tL1:
   492                              <1> 	call    updateLVI	; set LVI != CIV
   493                              <1> 	call    check4keyboardstop
   494                              <1> 	jc	short _exit_
   495                              <1> 	call    getCurrentIndex
   496                              <1> 	test	al, BIT0
   497                              <1> 	jz	short tL1	; loop if buffer 2 is not playing
   498                              <1> 
   499                              <1> 	; load buffer 1
   500                              <1> 	mov     ax, [WAV_BUFFER1]
   501                              <1> 	call	loadFromFile
   502                              <1> 	jc	short _exit_	; end of file
   503                              <1> tL2:
   504                              <1> 	call    updateLVI
   505                              <1> 	call    check4keyboardstop
   506                              <1> 	jc	short _exit_
   507                              <1> 	call    getCurrentIndex
   508                              <1> 	test	al, BIT0
   509                              <1> 	jnz	short tL2	; loop if buffer 1 is not playing
   510                              <1> 
   511                              <1> 	; load buffer 2
   512                              <1> 	mov     ax, [WAV_BUFFER2]
   513                              <1> 	call	loadFromFile
   514                              <1> 	jnc	short tuneLoop
   515                              <1> _exit_:
   516                              <1> 	mov	dx, [NABMBAR]		
   517                              <1> 	add	dx, PO_CR_REG	; PCM out Control Register
   518                              <1> 	mov	al, 0
   519                              <1> 	out	dx, al		; stop player
   520                              <1> 	retn
   521                              <1> 
   522                              <1> %endif
   523                              <1> 
   524                              <1> ; load data from file in 32k chunks. Would be nice to load 1 64k chunk,
   525                              <1> ; but in DOS you can only load FFFF bytes at a time.
   526                              <1> ;
   527                              <1> ; entry: ax = segment to load data to
   528                              <1> ; exit: CY set if end of file reached.
   529                              <1> ; note: last file buffer is padded with 0's to avoid pops at the end of song.
   530                              <1> ; assumes file is already open. uses [filehandle]
   531                              <1> 
   532                              <1> ; 07/11/2023
   533                              <1> %if 0
   534                              <1> 
   535                              <1> loadFromFile:
   536                              <1> 	; 07/11/2023
   537                              <1> 	; 06/11/2023
   538                              <1> 	; 17/02/2017
   539                              <1> 	;push	ax
   540                              <1> 	;push	cx
   541                              <1> 	;push	dx
   542                              <1> 	;push	bx
   543                              <1> 
   544                              <1> 	;push	es
   545                              <1> 	;push	ds
   546                              <1> 	
   547                              <1>         test    byte [flags], ENDOFFILE	; have we already read the
   548                              <1> 	;stc				; last of the file?
   549                              <1> 	; 05/11/2023
   550                              <1> 	;jnz	endLFF
   551                              <1> 	jz	short lff_12	; 06/11/2023
   552                              <1> 	; 06/11/2023
   553                              <1> 	;;mov	byte [tLoop], 0
   554                              <1> 	;jmp	endLFF
   555                              <1> 	stc
   556                              <1> 	retn
   557                              <1> 
   558                              <1> lff_12:	; 06/11/2023    
   559                              <1> 	mov	[fbs_seg], ax ; save buffer segment
   560                              <1> 	xor	dx, dx
   561                              <1> lff_0:
   562                              <1> 	mov	[fbs_off], dx ; buffer offset
   563                              <1> 
   564                              <1> 	mov     bx, (BUFFERSIZE / 2)	; 32k chunk
   565                              <1> 	mov	cl, [fbs_shift]   
   566                              <1> 	and	cl, cl
   567                              <1> 	jz	short lff_1 ; stereo, 16 bit	
   568                              <1> 
   569                              <1> 	; fbs_shift =
   570                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   571                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   572                              <1> 	shr	bx, cl ; 32K / multiplier
   573                              <1> 
   574                              <1> 	mov	ax, cs
   575                              <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   576                              <1> lff_1:
   577                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   578                              <1> 	; load file into memory
   579                              <1>         mov	cx, bx                         
   580                              <1> 	mov	bx, [filehandle]
   581                              <1> 	mov     ds, ax
   582                              <1>        	mov	ah, 3fh
   583                              <1> 	int	21h
   584                              <1> 
   585                              <1> 	mov	bx, cs
   586                              <1> 	mov	ds, bx
   587                              <1> 
   588                              <1> 	jc	short lff_9 ; error !
   589                              <1> 
   590                              <1> 	and	ax, ax
   591                              <1> 	jz	short lff_10
   592                              <1> 	
   593                              <1> 	mov	bl, [fbs_shift] ; shift count  
   594                              <1> 	or	bl, bl
   595                              <1> 	jz	short lff_7 ; 16 bit stereo samples
   596                              <1> 
   597                              <1> 	push	es
   598                              <1> 	; 06/11/2023
   599                              <1> 	;push	di
   600                              <1> 	;push	si
   601                              <1> 	mov	di, [fbs_off]
   602                              <1> 	mov	si, [fbs_seg] ; buffer segment
   603                              <1> 	mov	es, si
   604                              <1> 	mov	si, temp_buffer ; temporary buffer address
   605                              <1> 	mov	cl, [bps] ; bits per sample (8 or 16)
   606                              <1> 	cmp	cl, 8
   607                              <1> 	jne	short lff_4 ; 16 bit samples
   608                              <1> 	; 8 bit samples
   609                              <1> 	mov	cx, ax ; byte count
   610                              <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   611                              <1> 	jz	short lff_3 ; 8 bit, stereo
   612                              <1> lff_2:
   613                              <1> 	; mono & 8 bit
   614                              <1> 	lodsb
   615                              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   616                              <1> 	stosw	; left channel
   617                              <1> 	stosw	; right channel
   618                              <1> 	loop	lff_2
   619                              <1> 	jmp	short lff_6	
   620                              <1> lff_3:
   621                              <1> 	; stereo & 8 bit
   622                              <1> 	lodsb
   623                              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   624                              <1> 	stosw
   625                              <1> 	loop	lff_3			
   626                              <1> 	jmp	short lff_6
   627                              <1> lff_4:
   628                              <1> 	; 16 bit mono samples
   629                              <1> 	mov	cx, ax ; word count
   630                              <1> lff_5:	
   631                              <1> 	lodsw
   632                              <1> 	stosw	; left channel
   633                              <1> 	stosw	; right channel
   634                              <1> 	loop	lff_5
   635                              <1> lff_6:
   636                              <1> 	mov	ax, di ; save next buffer offset/position
   637                              <1> 	; 06/11/2023
   638                              <1> 	;pop	si
   639                              <1> 	;pop	di
   640                              <1> 	pop	es
   641                              <1> ;lff_7:        
   642                              <1> 	; 06/11/2023
   643                              <1> 	and	ax, ax
   644                              <1> 	jz	short endLFF ; end of 2nd half
   645                              <1> 	mov	cx, (BUFFERSIZE / 2)
   646                              <1> lff_7:
   647                              <1> 	cmp	ax, cx
   648                              <1> 	je	short endLFF	 ; 06/11/2023
   649                              <1> 	;jb	short lff_11
   650                              <1> 	;xor	cx, cx
   651                              <1> 	;sub	cx, ax
   652                              <1> 	;neg	cx
   653                              <1> 	jmp	short lff_11
   654                              <1> lff_8:
   655                              <1> 	; 07/11/2023
   656                              <1> 	cmp	word [fbs_off], (BUFFERSIZE / 2) ; 32768
   657                              <1> 	jnb	short endLFF
   658                              <1> 	
   659                              <1> 	mov	dx, ax ; buffer offset
   660                              <1> 	mov	ax, [fbs_seg] ; buffer segment
   661                              <1> 	jmp	lff_0
   662                              <1> lff_9:  
   663                              <1> 	; 07/11/2023
   664                              <1> 	;; 06/11/2023 (temporary)
   665                              <1> 	;mov	al, '!'  ; error
   666                              <1> 	;call	tL0
   667                              <1> 
   668                              <1> 	xor	ax, ax
   669                              <1> lff_10:
   670                              <1> 	; 07/11/2023
   671                              <1> 	;mov	cx, (BUFFERSIZE / 2)  
   672                              <1> lff_11:
   673                              <1> 	call    padfill				; blank pad the remainder
   674                              <1>         ;clc					; don't exit with CY yet.
   675                              <1>         or	byte [flags], ENDOFFILE		; end of file flag
   676                              <1> endLFF:
   677                              <1>         ;pop	ds
   678                              <1> 	;pop	es
   679                              <1> 	; 06/11/2023
   680                              <1> 	;pop	bx
   681                              <1> 	;pop	dx
   682                              <1>         ;pop	cx
   683                              <1>         ;pop	ax
   684                              <1>         retn
   685                              <1> 
   686                              <1> %endif
   687                              <1> 
   688                              <1> ; 08/11/2023
   689                              <1> ; 07/11/2023
   690                              <1> %if 1
   691                              <1> 
   692                              <1> loadFromFile:
   693                              <1> 	; 07/11/2023
   694                              <1> 
   695 0000056D F606[800A]01        <1>         test    byte [flags], ENDOFFILE	; have we already read the
   696                              <1> 					; last of the file?
   697 00000572 7402                <1> 	jz	short lff_0		; no
   698 00000574 F9                  <1> 	stc
   699 00000575 C3                  <1> 	retn
   700                              <1> 
   701                              <1> lff_0:
   702                              <1> 	; 08/11/2023
   703 00000576 89C5                <1> 	mov	bp, ax ; save buffer segment	
   704                              <1> 
   705 00000578 8A0E[A20A]          <1> 	mov	cl, [fbs_shift]   
   706 0000057C 20C9                <1> 	and	cl, cl
   707 0000057E 7467                <1> 	jz	short lff_1 ; stereo, 16 bit	
   708                              <1> 
   709 00000580 BFFFFF              <1> 	mov	di, BUFFERSIZE - 1 ; 65535
   710                              <1> 
   711                              <1> 	; fbs_shift =
   712                              <1> 	;	2 for mono and 8 bit sample (multiplier = 4)
   713                              <1> 	;	1 for mono or 8 bit sample (multiplier = 2)
   714 00000583 D3EF                <1> 	shr	di, cl
   715 00000585 47                  <1> 	inc	di ; 16384 for 8 bit and mono	
   716                              <1> 		   ; 32768 for 8 bit or mono	
   717                              <1> 
   718 00000586 8CC8                <1> 	mov	ax, cs
   719 00000588 BA[A70A]            <1> 	mov	dx, temp_buffer ; temporary buffer for wav data
   720                              <1> 
   721                              <1> 	; 17/02/2017 (stereo/mono, 8bit/16bit corrections)
   722                              <1> 	; load file into memory
   723 0000058B 89F9                <1>         mov	cx, di                       
   724 0000058D 8B1E[7E0A]          <1> 	mov	bx, [filehandle]
   725 00000591 8ED8                <1> 	mov     ds, ax
   726 00000593 B43F                <1>        	mov	ah, 3Fh
   727 00000595 CD21                <1> 	int	21h
   728                              <1> 
   729 00000597 8CCB                <1> 	mov	bx, cs
   730 00000599 8EDB                <1> 	mov	ds, bx
   731                              <1> 
   732 0000059B 727C                <1> 	jc	short lff_4 ; error !
   733                              <1> 
   734                              <1> 	; 08/11/2023
   735 0000059D 31D2                <1> 	xor	dx, dx ; 0
   736                              <1> 
   737 0000059F 21C0                <1> 	and	ax, ax
   738 000005A1 746D                <1> 	jz	short lff_3
   739                              <1> 
   740 000005A3 8A1E[A20A]          <1> 	mov	bl, [fbs_shift]
   741                              <1> 
   742 000005A7 06                  <1> 	push	es
   743 000005A8 89D7                <1> 	mov	di, dx ; 0 ; [fbs_off]
   744                              <1> 	;mov	bp, [fbs_seg] ; buffer segment
   745 000005AA 8EC5                <1> 	mov	es, bp
   746 000005AC BE[A70A]            <1> 	mov	si, temp_buffer ; temporary buffer address
   747 000005AF 89C1                <1> 	mov	cx, ax ; byte count
   748 000005B1 803E[A00A]08        <1> 	cmp	byte [bps], 8 ; bits per sample (8 or 16)
   749 000005B6 751B                <1> 	jne	short lff_7 ; 16 bit samples
   750                              <1> 	; 8 bit samples
   751 000005B8 FECB                <1> 	dec	bl  ; shift count, 1 = stereo, 2 = mono
   752 000005BA 740C                <1> 	jz	short lff_6 ; 8 bit, stereo
   753                              <1> lff_5:
   754                              <1> 	; mono & 8 bit
   755 000005BC AC                  <1> 	lodsb
   756 000005BD 2C80                <1> 	sub	al, 80h ; 08/11/2023
   757 000005BF C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   758 000005C2 AB                  <1> 	stosw	; left channel
   759 000005C3 AB                  <1> 	stosw	; right channel
   760 000005C4 E2F6                <1> 	loop	lff_5
   761 000005C6 EB12                <1> 	jmp	short lff_9	
   762                              <1> lff_6:
   763                              <1> 	; stereo & 8 bit
   764 000005C8 AC                  <1> 	lodsb
   765 000005C9 2C80                <1> 	sub	al, 80h ; 08/11/2023
   766 000005CB C1E008              <1> 	shl	ax, 8 ; convert 8 bit sample to 16 bit sample
   767 000005CE AB                  <1> 	stosw
   768 000005CF E2F7                <1> 	loop	lff_6			
   769 000005D1 EB07                <1> 	jmp	short lff_9
   770                              <1> lff_7:
   771 000005D3 D1E9                <1> 	shr	cx, 1 ; word count
   772                              <1> lff_8:
   773 000005D5 AD                  <1> 	lodsw
   774 000005D6 AB                  <1> 	stosw	; left channel
   775 000005D7 AB                  <1> 	stosw	; right channel
   776 000005D8 E2FB                <1> 	loop	lff_8
   777                              <1> lff_9:
   778 000005DA 07                  <1> 	pop	es
   779 000005DB 09FF                <1> 	or	di, di
   780 000005DD 7439                <1> 	jz	short endLFF ; 64KB ok 
   781                              <1> 	
   782 000005DF 89F8                <1> 	mov	ax, di ; [fbs_off]
   783 000005E1 48                  <1> 	dec	ax
   784 000005E2 B9FFFF              <1> 	mov	cx, BUFFERSIZE - 1 ; 65535
   785 000005E5 EB29                <1> 	jmp	short lff_3
   786                              <1> 	
   787                              <1> lff_1:  
   788                              <1> 	;mov	bp, ax ; save buffer segment
   789 000005E7 31D2                <1> 	xor	dx, dx
   790                              <1> 	; load file into memory
   791 000005E9 B90080              <1>         mov	cx, (BUFFERSIZE / 2)	; 32k chunk
   792 000005EC 8B1E[7E0A]          <1> 	mov	bx, [filehandle]
   793 000005F0 8ED8                <1> 	mov     ds, ax
   794 000005F2 B43F                <1>        	mov	ah, 3Fh
   795 000005F4 CD21                <1> 	int	21h
   796                              <1> 
   797 000005F6 8CCF                <1> 	mov	di, cs
   798 000005F8 8EDF                <1> 	mov	ds, di
   799                              <1> 
   800                              <1> 	; 07/11/2023
   801 000005FA 721D                <1> 	jc	short lff_4 ; error !
   802                              <1> 	
   803 000005FC 39C8                <1> 	cmp	ax, cx
   804 000005FE 7510                <1> 	jne	short lff_3
   805                              <1> lff_2:
   806                              <1> 	; 08/11/2023
   807 00000600 01C2                <1> 	add	dx, ax
   808                              <1> 	;mov	cx, (BUFFERSIZE / 2)	; 32k chunk
   809                              <1> 	;mov	bx, [filehandle]
   810 00000602 8EDD                <1> 	mov     ds, bp
   811 00000604 B43F                <1>        	mov	ah, 3Fh
   812 00000606 CD21                <1> 	int	21h
   813                              <1> 
   814                              <1> 	;mov	di, cs
   815 00000608 8EDF                <1> 	mov	ds, di
   816                              <1> 
   817 0000060A 720D                <1> 	jc	short lff_4 ; error !
   818                              <1> 
   819 0000060C 39C8                <1> 	cmp	ax, cx
   820 0000060E 7408                <1> 	je	short endLFF
   821                              <1> lff_3:
   822 00000610 E80F00              <1> 	call    padfill			; blank pad the remainder
   823                              <1>         ;clc				; don't exit with CY yet.
   824 00000613 800E[800A]01        <1>         or	byte [flags], ENDOFFILE	; end of file flag
   825                              <1> endLFF:
   826 00000618 C3                  <1>         retn
   827                              <1> lff_4:
   828                              <1> 	; 08/11/2023
   829 00000619 B021                <1> 	mov	al, '!'  ; error
   830 0000061B E841FF              <1> 	call	tL0
   831                              <1> 
   832 0000061E 31C0                <1> 	xor	ax, ax
   833 00000620 EBEE                <1> 	jmp	short lff_3
   834                              <1> 
   835                              <1> %endif
   836                              <1> 
   837                              <1> ; entry ds:ax points to last byte in file
   838                              <1> ; cx=target size
   839                              <1> ; note: must do byte size fill
   840                              <1> ; destroys bx, cx
   841                              <1> ;
   842                              <1> padfill:
   843                              <1> 	; 07/11/2023
   844                              <1> 	; 06/11/2023
   845                              <1> 	; 17/02/2017
   846 00000622 06                  <1> 	push	es
   847                              <1>         ;push	di
   848                              <1> 	;mov	di, [fbs_seg]
   849                              <1> 	;mov	es, di
   850 00000623 8EC5                <1>         mov	es, bp
   851 00000625 29C1                <1> 	sub	cx, ax
   852                              <1> 	; 08/11/2023
   853                              <1> 	;mov	di, ax ; (wrong)
   854 00000627 89D7                <1> 	mov	di, dx ; buffer offset
   855 00000629 01C7                <1> 	add	di, ax       	
   856                              <1> 	; 07/11/2023
   857                              <1> 	;add	di, [fbs_off]
   858 0000062B 30C0                <1>         xor	al, al
   859 0000062D F3AA                <1> 	rep	stosb
   860                              <1> 	;mov	[fbs_off], di
   861                              <1> 	;pop	di
   862 0000062F 07                  <1>         pop	es
   863 00000630 C3                  <1> 	retn
   864                              <1> 
   865                              <1> ; returns AL = current index value
   866                              <1> getCurrentIndex:
   867                              <1> 	; 08/11/2023
   868                              <1> 	;push	dx
   869 00000631 8B16[860A]          <1> 	mov	dx, [NABMBAR]      		
   870 00000635 83C214              <1> 	add	dx, PO_CIV_REG
   871 00000638 EC                  <1> 	in	al, dx
   872                              <1> 	;pop	dx
   873                              <1> uLVI2:	;	06/11/2023
   874 00000639 C3                  <1> 	retn
   875                              <1> 
   876                              <1> ; examines the CIV and the LVI. When they're the same, we set LVI <> CIV
   877                              <1> ; that way, we never run out of buffers to play
   878                              <1> 
   879                              <1> ; 08/11/2023
   880                              <1> %if 0
   881                              <1> 	; 07/11/2023
   882                              <1> updateLVI:
   883                              <1> 	push	ax
   884                              <1> 	push	dx
   885                              <1> 	; 06/11/2023
   886                              <1> 	mov	dx, [NABMBAR]
   887                              <1> 	add	dx, PO_CIV_REG
   888                              <1> 	; (Current Index Value and Last Valid Index value)
   889                              <1> 	in	ax, dx
   890                              <1> 
   891                              <1> 	cmp	al, ah ; is current index = last index ?
   892                              <1> 	jne	short uLVI1
   893                              <1> 
   894                              <1> 	call	setNewIndex
   895                              <1> uLVI1:
   896                              <1> 	pop	dx
   897                              <1> 	pop	ax
   898                              <1> 	retn
   899                              <1> 
   900                              <1> setNewIndex:
   901                              <1> 	; 07/11/2023
   902                              <1> 	push	ax
   903                              <1>         call    getCurrentIndex                 ; get CIV
   904                              <1>         test    byte [flags], ENDOFFILE
   905                              <1>         jnz     short sni_1
   906                              <1>         ; not at the end of the file yet.
   907                              <1>         dec     al                              ; make new index <> current
   908                              <1>         and     al, INDEX_MASK                  ; make sure new value is 0-31
   909                              <1> sni_1:
   910                              <1>         call    setLastValidIndex               ; write new value
   911                              <1>         clc
   912                              <1>         pop	ax
   913                              <1> 	retn
   914                              <1> 
   915                              <1> %endif	
   916                              <1> 
   917                              <1> ; 08/11/2023
   918                              <1> ; 07/11/2023
   919                              <1> ;%if 1
   920                              <1> updateLVI:
   921                              <1> 	; 06/11/2023
   922 0000063A 8B16[860A]          <1> 	mov	dx, [NABMBAR]      		
   923 0000063E 83C214              <1> 	add	dx, PO_CIV_REG
   924                              <1> 	; (Current Index Value and Last Valid Index value)
   925 00000641 ED                  <1> 	in	ax, dx
   926                              <1> 
   927 00000642 38E0                <1> 	cmp	al, ah ; is current index = last index ?
   928 00000644 75F3                <1> 	jne	short uLVI2
   929                              <1> 
   930                              <1> 	; 08/11/2023	
   931 00000646 E8E8FF              <1> 	call	getCurrentIndex
   932                              <1>  
   933 00000649 F606[800A]01        <1> 	test	byte [flags], ENDOFFILE
   934                              <1> 	;jnz	short uLVI1
   935 0000064E 7411                <1> 	jz	short uLVI0  ; 08/11/2023
   936                              <1> 
   937                              <1> 	; 08/11/2023
   938 00000650 50                  <1> 	push	ax
   939 00000651 8B16[860A]          <1> 	mov	dx, [NABMBAR]
   940 00000655 83C216              <1> 	add	dx, PO_SR_REG  ; PCM out status register
   941 00000658 ED                  <1> 	in	ax, dx
   942                              <1> 
   943 00000659 A803                <1> 	test	al, 3 ; bit 1 = Current Equals Last Valid (CELV)
   944                              <1> 		      ; (has been processed)
   945                              <1> 		      ; bit 0 = 1 -> DMA Controller Halted (DCH)
   946 0000065B 58                  <1> 	pop	ax
   947 0000065C 7407                <1> 	jz	short uLVI1
   948                              <1> uLVI3:
   949 0000065E 31C0                <1> 	xor	ax, ax
   950                              <1> 	; zf = 1
   951 00000660 C3                  <1> 	retn
   952                              <1> uLVI0:
   953                              <1>         ; not at the end of the file yet.
   954 00000661 FEC8                <1> 	dec	al
   955 00000663 241F                <1> 	and	al, 1Fh
   956                              <1> uLVI1:
   957                              <1> 	;call	setLastValidIndex
   958                              <1> ;uLVI2:
   959                              <1> 	;retn
   960                              <1> 
   961                              <1> ;%endif
   962                              <1> 	
   963                              <1> ;input AL = index # to stop on
   964                              <1> setLastValidIndex:
   965                              <1> 	; 08/11/2023
   966                              <1> 	;push	dx
   967 00000665 8B16[860A]          <1> 	mov	dx, [NABMBAR]
   968 00000669 83C215              <1> 	add	dx, PO_LVI_REG
   969 0000066C EE                  <1>         out     dx, al
   970                              <1> 	;pop	dx
   971 0000066D C3                  <1> 	retn
   972                              <1> 
   973                              <1> ; 06/11/2023
   974                              <1> ;	; 05/11/2023
   975                              <1> ;setCurrentIndex:
   976                              <1> ;	;push	dx
   977                              <1> ;	mov	dx, [NABMBAR]
   978                              <1> ;	add	dx, PO_CIV_REG
   979                              <1> ;	out	dx, al
   980                              <1> ;	;pop	dx
   981                              <1> ;	retn
   982                              <1> 
   983                              <1> ; checks if either shift key has been pressed. Exits with CY if so.
   984                              <1> ; 
   985                              <1> check4keyboardstop:
   986                              <1> 
   987                              <1> ; 06/11/2023
   988                              <1> %if 1
   989                              <1> 	; 08/11/2023
   990                              <1> 	; 04/11/2023
   991 0000066E B401                <1> 	mov	ah, 1
   992 00000670 CD16                <1> 	int	16h
   993 00000672 7405                <1> 	jz	short _cksr
   994 00000674 30E4                <1> 	xor	ah, ah
   995 00000676 CD16                <1> 	int	16h
   996 00000678 F9                  <1> 	stc
   997                              <1> _cksr:
   998 00000679 C3                  <1> 	retn
   999                              <1> %endif
  1000                              <1> 
  1001                              <1> ; 06/11/2023
  1002                              <1> ; 04/11/2023
  1003                              <1> %if 0	
  1004                              <1>         push    ds
  1005                              <1>         push    0
  1006                              <1>         pop     ds		       ; examine BDA for keyboard flags
  1007                              <1>         test    byte [417h], (BIT0 | BIT1)
  1008                              <1>         pop     ds
  1009                              <1>         stc
  1010                              <1>         jnz	short _cksr ; 07/11/2023
  1011                              <1> 	;jz	short _cksr ; 06/11/2023
  1012                              <1>         clc
  1013                              <1> _cksr:
  1014                              <1>         retn
  1015                              <1> %endif
   408                                  
   409                                  ; UTILS.ASM
   410                                  ;----------------------------------------------------------------------------
   411                                  ;       delay1_4ms - Delay for 1/4 millisecond.
   412                                  ;		    1mS = 1000us
   413                                  ;       Entry:
   414                                  ;         None
   415                                  ;       Exit:
   416                                  ;	  None
   417                                  ;
   418                                  ;       Modified:
   419                                  ;         None
   420                                  ;
   421                                  PORTB			EQU	061h
   422                                    REFRESH_STATUS	EQU	010h		; Refresh signal status
   423                                  
   424                                  delay1_4ms:
   425 0000067A 50                              push    ax 
   426 0000067B 51                              push    cx
   427 0000067C B91000                          mov     cx, 16			; close enough.
   428 0000067F E461                    	in	al,PORTB
   429 00000681 2410                    	and	al,REFRESH_STATUS
   430 00000683 88C4                    	mov	ah,al			; Start toggle state
   431 00000685 09C9                    	or	cx, cx
   432 00000687 7401                    	jz	short _d4ms1
   433 00000689 41                      	inc	cx			; Throwaway first toggle
   434                                  _d4ms1:	
   435 0000068A E461                    	in	al,PORTB		; Read system control port
   436 0000068C 2410                    	and	al,REFRESH_STATUS	; Refresh toggles 15.085 microseconds
   437 0000068E 38C4                    	cmp	ah,al
   438 00000690 74F8                    	je	short _d4ms1		; Wait for state change
   439                                  
   440 00000692 88C4                    	mov	ah,al			; Update with new state
   441 00000694 49                      	dec	cx
   442 00000695 75F3                    	jnz	short _d4ms1
   443                                  
   444 00000697 59                              pop     cx
   445 00000698 58                              pop     ax
   446 00000699 C3                              retn
   447                                  
   448                                  	; 13/11/2016 - Erdogan Tan
   449                                  write_ac97_dev_info:
   450                                  	; BUS/DEV/FN
   451                                  	;	00000000BBBBBBBBDDDDDFFF00000000
   452                                  	; DEV/VENDOR
   453                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
   454                                  
   455 0000069A 30FF                    	xor	bh, bh
   456 0000069C 668B36[940A]            	mov	esi, [dev_vendor]
   457 000006A1 89F0                    	mov	ax, si
   458 000006A3 88C3                    	mov	bl, al
   459 000006A5 88DA                    	mov	dl, bl
   460 000006A7 80E30F                  	and	bl, 0Fh
   461 000006AA 8A87[1609]              	mov	al, [bx+hex_chars]
   462 000006AE A2[5909]                	mov	[msgVendorId+3], al
   463 000006B1 88D3                    	mov	bl, dl
   464 000006B3 C0EB04                  	shr	bl, 4
   465 000006B6 8A87[1609]              	mov	al, [bx+hex_chars]
   466 000006BA A2[5809]                	mov	[msgVendorId+2], al
   467 000006BD 88E3                    	mov	bl, ah
   468 000006BF 88DA                    	mov	dl, bl
   469 000006C1 80E30F                  	and	bl, 0Fh
   470 000006C4 8A87[1609]              	mov	al, [bx+hex_chars]
   471 000006C8 A2[5709]                	mov	[msgVendorId+1], al
   472 000006CB 88D3                    	mov	bl, dl
   473 000006CD C0EB04                  	shr	bl, 4
   474 000006D0 8A87[1609]              	mov	al, [bx+hex_chars]
   475 000006D4 A2[5609]                	mov	[msgVendorId], al
   476 000006D7 66C1EE10                	shr	esi, 16
   477 000006DB 89F0                    	mov	ax, si
   478 000006DD 88C3                    	mov	bl, al
   479 000006DF 88DA                    	mov	dl, bl
   480 000006E1 80E30F                  	and	bl, 0Fh
   481 000006E4 8A87[1609]              	mov	al, [bx+hex_chars]
   482 000006E8 A2[6A09]                	mov	[msgDevId+3], al
   483 000006EB 88D3                    	mov	bl, dl
   484 000006ED C0EB04                  	shr	bl, 4
   485 000006F0 8A87[1609]              	mov	al, [bx+hex_chars]
   486 000006F4 A2[6909]                	mov	[msgDevId+2], al
   487 000006F7 88E3                    	mov	bl, ah
   488 000006F9 88DA                    	mov	dl, bl
   489 000006FB 80E30F                  	and	bl, 0Fh
   490 000006FE 8A87[1609]              	mov	al, [bx+hex_chars]
   491 00000702 A2[6809]                	mov	[msgDevId+1], al
   492 00000705 88D3                    	mov	bl, dl
   493 00000707 C0EB04                  	shr	bl, 4
   494 0000070A 8A87[1609]              	mov	al, [bx+hex_chars]
   495 0000070E A2[6709]                	mov	[msgDevId], al
   496                                  
   497 00000711 668B36[900A]            	mov	esi, [bus_dev_fn]
   498 00000716 66C1EE08                	shr	esi, 8
   499 0000071A 89F0                    	mov	ax, si
   500 0000071C 88C3                    	mov	bl, al
   501 0000071E 88DA                    	mov	dl, bl
   502 00000720 80E307                  	and	bl, 7 ; bit 0,1,2
   503 00000723 8A87[1609]              	mov	al, [bx+hex_chars]
   504 00000727 A2[8E09]                	mov	[msgFncNo+1], al
   505 0000072A 88D3                    	mov	bl, dl
   506 0000072C C0EB03                  	shr	bl, 3
   507 0000072F 88DA                    	mov	dl, bl
   508 00000731 80E30F                  	and	bl, 0Fh
   509 00000734 8A87[1609]              	mov	al, [bx+hex_chars]
   510 00000738 A2[8009]                	mov	[msgDevNo+1], al
   511 0000073B 88D3                    	mov	bl, dl
   512 0000073D C0EB04                  	shr	bl, 4
   513 00000740 8A87[1609]              	mov	al, [bx+hex_chars]
   514 00000744 A2[7F09]                	mov	[msgDevNo], al
   515 00000747 88E3                    	mov	bl, ah
   516 00000749 88DA                    	mov	dl, bl
   517 0000074B 80E30F                  	and	bl, 0Fh
   518 0000074E 8A87[1609]              	mov	al, [bx+hex_chars]
   519 00000752 A2[7409]                	mov	[msgBusNo+1], al
   520 00000755 88D3                    	mov	bl, dl
   521 00000757 C0EB04                  	shr	bl, 4
   522 0000075A 8A87[1609]              	mov	al, [bx+hex_chars]
   523 0000075E A2[7309]                	mov	[msgBusNo], al
   524                                  
   525 00000761 A1[9A0A]                	mov	ax, [ac97_io_base]
   526 00000764 88C3                    	mov	bl, al
   527 00000766 88DA                    	mov	dl, bl
   528 00000768 80E30F                  	and	bl, 0Fh
   529 0000076B 8A87[1609]              	mov	al, [bx+hex_chars]
   530 0000076F A2[A709]                	mov	[msgIOBaseAddr+3], al
   531 00000772 88D3                    	mov	bl, dl
   532 00000774 C0EB04                  	shr	bl, 4
   533 00000777 8A87[1609]              	mov	al, [bx+hex_chars]
   534 0000077B A2[A609]                	mov	[msgIOBaseAddr+2], al
   535 0000077E 88E3                    	mov	bl, ah
   536 00000780 88DA                    	mov	dl, bl
   537 00000782 80E30F                  	and	bl, 0Fh
   538 00000785 8A87[1609]              	mov	al, [bx+hex_chars]
   539 00000789 A2[A509]                	mov	[msgIOBaseAddr+1], al
   540 0000078C 88D3                    	mov	bl, dl
   541 0000078E C0EB04                  	shr	bl, 4
   542 00000791 8A87[1609]              	mov	al, [bx+hex_chars]
   543 00000795 A2[A409]                	mov	[msgIOBaseAddr], al
   544                                  
   545                                  	; 24/11/2016
   546 00000798 30E4                    	xor	ah, ah
   547 0000079A A0[8F0A]                	mov	al, [ac97_int_ln_reg]
   548 0000079D B10A                    	mov	cl, 10
   549 0000079F F6F1                    	div	cl
   550 000007A1 0106[AF09]              	add	[msgIRQ], ax
   551 000007A5 20C0                    	and	al, al
   552 000007A7 7508                    	jnz	short _pmi
   553 000007A9 A0[B009]                	mov	al, [msgIRQ+1]
   554 000007AC B420                    	mov	ah, ' '
   555 000007AE A3[AF09]                	mov	[msgIRQ], ax
   556                                  _pmi:
   557 000007B1 BA[2709]                        mov	dx, msgAC97Info
   558 000007B4 B409                            mov     ah, 9
   559 000007B6 CD21                            int     21h
   560 000007B8 C3                              retn
   561                                  
   562                                  write_sample_rate:
   563                                  	; ax = sample rate (hertz)
   564                                  
   565 000007B9 31D2                    	xor	dx, dx
   566 000007BB B90A00                  	mov	cx, 10
   567 000007BE F7F1                    	div	cx
   568 000007C0 0016[C509]              	add	[msgHertz+4], dl
   569 000007C4 29D2                    	sub	dx, dx
   570 000007C6 F7F1                    	div	cx
   571 000007C8 0016[C409]              	add	[msgHertz+3], dl
   572 000007CC 29D2                    	sub	dx, dx
   573 000007CE F7F1                    	div	cx
   574 000007D0 0016[C309]              	add	[msgHertz+2], dl
   575 000007D4 29D2                    	sub	dx, dx
   576 000007D6 F7F1                    	div	cx
   577 000007D8 0016[C209]              	add	[msgHertz+1], dl
   578 000007DC 0006[C109]              	add	[msgHertz], al
   579                                  	
   580 000007E0 BA[B409]                        mov     dx, msgSampleRate
   581 000007E3 B409                            mov     ah, 9
   582 000007E5 CD21                            int     21h
   583                                  
   584                                  	; 19/11/2016
   585 000007E7 BA[DA09]                	mov	dx, msg16Bits
   586 000007EA 803E[A00A]10            	cmp	byte [bps], 16
   587 000007EF 7403                    	je	short wsr_1
   588 000007F1 BA[CB09]                	mov	dx, msg8Bits
   589                                  wsr_1:
   590 000007F4 B409                            mov     ah, 9
   591 000007F6 CD21                            int     21h
   592                                  
   593 000007F8 BA[D309]                	mov	dx, msgMono
   594 000007FB 803E[9E0A]01            	cmp	byte [stmo], 1
   595 00000800 7403                    	je	short wsr_2
   596 00000802 BA[E309]                	mov	dx, msgStereo		
   597                                  wsr_2:
   598 00000805 B409                            mov     ah, 9
   599 00000807 CD21                            int     21h
   600                                  
   601 00000809 C3                              retn
   602                                  
   603                                  ;detect_codec:
   604                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   605                                  ;	mov	eax, 7Ch
   606                                  ;	call	codec_read
   607                                  ;       shl     eax, 16
   608                                  ;       mov     [codec_id], eax
   609                                  ;
   610                                  ;	mov	eax, 7Eh
   611                                  ;       call	codec_read
   612                                  ;       or      eax, [codec_id]
   613                                  ;       mov     [codec_chip_id], eax
   614                                  ;       and     eax, 0FFFFFF00h
   615                                  ;
   616                                  ;       mov     edi, codecs
   617                                  ;_dcb:
   618                                  ;       mov     ebx, [di]
   619                                  ;       test    ebx, ebx
   620                                  ;       jz      short _dco_unknown
   621                                  ;
   622                                  ;       cmp     eax, ebx
   623                                  ;       jne     short _dco_next
   624                                  ;       mov     ax, [di+4]
   625                                  ;       mov     [codec_vendor_ids], ax
   626                                  ;       movzx   esi, ax
   627                                  ;       call	print_msg
   628                                  ;       
   629                                  ;	mov	ax, [di+6]
   630                                  ;	call	detect_chip
   631                                  ;       retn
   632                                  ;
   633                                  ;_dco_next:
   634                                  ;       add     di, 8
   635                                  ;       jmp     short _dcb
   636                                  ;
   637                                  ;_dco_unknown:
   638                                  ;       mov    word [codec_vendor_ids], ac_unknown
   639                                  ;       mov    word [codec_chip_ids], chip_unknown
   640                                  ;       mov     esi, chip_unknown
   641                                  ;	call	print_msg
   642                                  ;       mov     eax, [codec_chip_id]
   643                                  ;       call    dword2str
   644                                  ;       call	print_msg
   645                                  ;       retn
   646                                  
   647                                  ;detect_chip:
   648                                  ;	; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   649                                  ;	mov	di, ax ; chip_tab
   650                                  ;       mov     eax, [codec_chip_id]
   651                                  ;       and     ax, 0FFh
   652                                  ;_dch1:
   653                                  ;       mov     bx, [di]
   654                                  ;       cmp     bx, 0FFh
   655                                  ;       je      short _dch_unknown
   656                                  ;
   657                                  ;       cmp     ax, bx
   658                                  ;       jne     short _dch_next
   659                                  ;       mov     ax, [di+2]
   660                                  ;       mov     [codec_chip_ids], ax
   661                                  ;       mov     si, ax
   662                                  ;       call	print_msg
   663                                  ;       retn
   664                                  
   665                                  ;_dch_next:
   666                                  ;       add     di, 4
   667                                  ;       jmp     short _dch1
   668                                  ;
   669                                  ;_dch_unknown:
   670                                  ;       mov    word [codec_chip_ids], chip_unknown
   671                                  ;       mov     si, chip_unknown
   672                                  ;       call	print_msg
   673                                  ;       mov     eax, [codec_chip_id]
   674                                  ;       call    dword2str
   675                                  ;       call	print_msg
   676                                  ;       retn
   677                                  
   678                                  ac97_int_handler:
   679                                  	; 17/02/2016
   680 0000080A 50                      	push	ax
   681 0000080B 52                      	push	dx
   682 0000080C 51                      	push	cx
   683 0000080D 53                      	push	bx
   684 0000080E 56                      	push	si
   685 0000080F 57                      	push	di
   686                                  
   687 00000810 803E[820A]01            	cmp	byte [inside], 1
   688 00000815 731C                    	jnb	short _busy
   689                                  
   690 00000817 C606[820A]01            	mov	byte [inside], 1
   691                                  
   692 0000081C 8B16[860A]                      mov     dx, [NABMBAR]
   693 00000820 83C216                          add     dx, PO_SR_REG	; set pointer to Status reg
   694 00000823 EC                      	in	al, dx
   695 00000824 A2[810A]                	mov	[irq_status], al
   696 00000827 A808                    	test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
   697 00000829 741C                    	jz	short _ih_3
   698                                  
   699                                  	; 28/11/2016 - Erdogan Tan
   700 0000082B E8E9FC                  	call	tuneLoop
   701                                  _ih0:
   702 0000082E C606[820A]00            	mov	byte [inside], 0
   703                                  _busy:
   704 00000833 B020                    	mov	al, 20h
   705 00000835 F606[8F0A]08            	test	byte [ac97_int_ln_reg], 8
   706 0000083A 7402                    	jz	short _ih_1
   707 0000083C E6A0                    	out 	0A0h, al ; 20h ; EOI
   708                                  _ih_1:
   709 0000083E E620                    	out	20h, al  ; 20h ; EOI
   710                                  _ih_2:
   711 00000840 5F                      	pop	di
   712 00000841 5E                      	pop	si
   713 00000842 5B                      	pop	bx
   714 00000843 59                      	pop	cx
   715 00000844 5A                      	pop	dx
   716 00000845 58                      	pop	ax
   717 00000846 CF                      	iret
   718                                  _ih_3:
   719                                  	; 17/02/2017
   720 00000847 EE                      	out	dx, al ; clear interrupt event (by writing 1 to same bits)
   721 00000848 EBE4                    	jmp	short _ih0
   722                                  
   723                                  print_msg:
   724                                  	; 13/11/2016 - Erdogan Tan 
   725                                  	; esi = ASCIIZ text address
   726                                  	;
   727 0000084A BB0700                  	mov	bx, 7h
   728 0000084D B40E                    	mov	ah, 0Eh 
   729                                  pm_next_char:
   730 0000084F AC                      	lodsb
   731 00000850 20C0                    	and	al, al
   732 00000852 7404                    	jz	short pm_retn
   733 00000854 CD10                    	int	10h
   734 00000856 EBF7                    	jmp	short pm_next_char
   735                                  pm_retn:
   736 00000858 C3                      	retn
   737                                  
   738                                  dword2str:
   739                                  	; 13/11/2016 - Erdogan Tan 
   740                                  	; eax = dword value
   741                                  	;
   742 00000859 E84400                  	call	dwordtohex
   743 0000085C 668916[EC09]            	mov	[dword_str], edx
   744 00000861 66A3[F009]              	mov	[dword_str+4], eax
   745 00000865 BE[EC09]                	mov	si, dword_str
   746 00000868 C3                      	retn
   747                                  
   748                                  	; trdos386.s (unix386.s) - 10/05/2015
   749                                  	; Convert binary number to hexadecimal string
   750                                  
   751                                  bytetohex:
   752                                  	; INPUT ->
   753                                  	; 	AL = byte (binary number)
   754                                  	; OUTPUT ->
   755                                  	;	AX = hexadecimal string
   756                                  	;
   757 00000869 53                      	push	bx
   758 0000086A 30FF                    	xor	bh, bh
   759 0000086C 88C3                    	mov	bl, al
   760 0000086E C0EB04                  	shr	bl, 4
   761 00000871 8A9F[1609]              	mov	bl, [bx+hex_chars] 	 	
   762 00000875 86D8                    	xchg	bl, al
   763 00000877 80E30F                  	and	bl, 0Fh
   764 0000087A 8AA7[1609]              	mov	ah, [bx+hex_chars] 
   765 0000087E 5B                      	pop	bx	
   766 0000087F C3                      	retn
   767                                  
   768                                  wordtohex:
   769                                  	; INPUT ->
   770                                  	; 	AX = word (binary number)
   771                                  	; OUTPUT ->
   772                                  	;	EAX = hexadecimal string
   773                                  	;
   774 00000880 53                      	push	bx
   775 00000881 30FF                    	xor	bh, bh
   776 00000883 86E0                    	xchg	ah, al
   777 00000885 50                      	push	ax
   778 00000886 88E3                    	mov	bl, ah
   779 00000888 C0EB04                  	shr	bl, 4
   780 0000088B 8A87[1609]              	mov	al, [bx+hex_chars] 	 	
   781 0000088F 88E3                    	mov	bl, ah
   782 00000891 80E30F                  	and	bl, 0Fh
   783 00000894 8AA7[1609]              	mov	ah, [bx+hex_chars]
   784 00000898 66C1E010                	shl	eax, 16
   785 0000089C 58                      	pop	ax
   786 0000089D 5B                      	pop	bx
   787 0000089E EBC9                    	jmp	short bytetohex
   788                                  
   789                                  dwordtohex:
   790                                  	; INPUT ->
   791                                  	; 	EAX = dword (binary number)
   792                                  	; OUTPUT ->
   793                                  	;	EDX:EAX = hexadecimal string
   794                                  	;
   795 000008A0 6650                    	push	eax
   796 000008A2 66C1E810                	shr	eax, 16
   797 000008A6 E8D7FF                  	call	wordtohex
   798 000008A9 6689C2                  	mov	edx, eax
   799 000008AC 6658                    	pop	eax
   800 000008AE E8CFFF                  	call	wordtohex
   801 000008B1 C3                      	retn
   802                                  
   803                                  _DATA:
   804                                  
   805                                  ; 24/11/2016
   806                                  ;	       IRQ  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 
   807 000008B2 08090A0B0C0D0E0F70-     irq_int		db 08h,09h,0Ah,0Bh,0Ch,0Dh,0Eh,0Fh,70h,71h,72h,73h,74h,75h,76h,77h
   807 000008BB 71727374757677     
   808                                  
   809                                  ; 17/02/2017
   810                                  ; Valid ICH device IDs
   811                                  
   812                                  valid_ids:
   813 000008C2 86801524                dd	(ICH_DID << 16) + INTEL_VID  	 ; 8086h:2415h 
   814 000008C6 86802524                dd	(ICH0_DID << 16) + INTEL_VID 	 ; 8086h:2425h 
   815 000008CA 86804524                dd	(ICH2_DID << 16) + INTEL_VID 	 ; 8086h:2445h 
   816 000008CE 86808524                dd	(ICH3_DID << 16) + INTEL_VID 	 ; 8086h:2485h 
   817 000008D2 8680C524                dd	(ICH4_DID << 16) + INTEL_VID 	 ; 8086h:24C5h
   818 000008D6 8680D524                dd	(ICH5_DID << 16) + INTEL_VID 	 ; 8086h:24D5h
   819 000008DA 86806E26                dd	(ICH6_DID << 16) + INTEL_VID 	 ; 8086h:266Eh
   820 000008DE 8680A625                dd	(ESB6300_DID << 16) + INTEL_VID  ; 8086h:25A6h
   821 000008E2 86809826                dd	(ESB631X_DID << 16) + INTEL_VID  ; 8086h:2698h
   822 000008E6 8680DE27                dd	(ICH7_DID << 16) + INTEL_VID 	 ; 8086h:27DEh
   823                                  ; 03/11/2023 - Erdogan Tan
   824 000008EA 86809571                dd	(MX82440_DID << 16) + INTEL_VID  ; 8086h:7195h
   825 000008EE 39101270                dd	(SI7012_DID << 16)  + SIS_VID	 ; 1039h:7012h
   826 000008F2 DE10B101                dd 	(NFORCE_DID << 16)  + NVIDIA_VID ; 10DEh:01B1h
   827 000008F6 DE106A00                dd 	(NFORCE2_DID << 16) + NVIDIA_VID ; 10DEh:006Ah
   828 000008FA 22106D74                dd 	(AMD8111_DID << 16) + AMD_VID 	 ; 1022h:746Dh
   829 000008FE 22104574                dd 	(AMD768_DID << 16)  + AMD_VID 	 ; 1022h:7445h
   830 00000902 DE105900                dd 	(CK804_DID << 16) + NVIDIA_VID	 ; 10DEh:0059h
   831 00000906 DE103A00                dd 	(MCP04_DID << 16) + NVIDIA_VID	 ; 10DEh:003Ah
   832 0000090A DE108A00                dd 	(CK8_DID << 16) + NVIDIA_VID	 ; 1022h:008Ah
   833 0000090E DE10DA00                dd 	(NFORCE3_DID << 16) + NVIDIA_VID ; 10DEh:00DAh
   834 00000912 DE10EA00                dd 	(CK8S_DID << 16) + NVIDIA_VID	 ; 10DEh:00EAh
   835                                  
   836                                  valid_id_count:	equ ($ - valid_ids)>>2 ; 05/11/2023
   837                                  
   838                                  ; 13/11/2016
   839 00000916 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
   839 0000091F 3941424344454600   
   840 00000927 414339372041756469-     msgAC97Info	db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
   840 00000930 6F20436F6E74726F6C-
   840 00000939 6C6572202620436F64-
   840 00000942 656320496E666F0D0A 
   841 0000094B 56656E646F72204944-     		db "Vendor ID: "
   841 00000954 3A20               
   842 00000956 303030306820446576-     msgVendorId	db "0000h Device ID: "
   842 0000095F 6963652049443A20   
   843 00000967 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
   844 0000096E 4275733A20              		db "Bus: "
   845 00000973 303068204465766963-     msgBusNo	db "00h Device: "
   845 0000097C 653A20             
   846 0000097F 3030682046756E6374-     msgDevNo	db "00h Function: "
   846 00000988 696F6E3A20         
   847 0000098D 303068                  msgFncNo	db "00h"
   848 00000990 0D0A                    		db 0Dh, 0Ah
   849 00000992 492F4F204261736520-     		db "I/O Base Address: "
   849 0000099B 416464726573733A20 
   850 000009A4 303030306820495251-     msgIOBaseAddr	db "0000h IRQ: "
   850 000009AD 3A20               
   851 000009AF 3030                    msgIRQ		dw 3030h
   852 000009B1 0D0A24                  		db 0Dh, 0Ah, "$"
   853 000009B4 53616D706C65205261-     msgSampleRate	db "Sample Rate: "
   853 000009BD 74653A20           
   854 000009C1 303030303020487A20-     msgHertz	db "00000 Hz ", "$" 
   854 000009CA 24                 
   855 000009CB 3820626974732024        msg8Bits	db "8 bits ", "$" 
   856 000009D3 4D6F6E6F0D0A24          msgMono		db "Mono", 0Dh, 0Ah, "$"
   857 000009DA 313620626974732024      msg16Bits	db "16 bits ", "$" 
   858 000009E3 53746572656F0D0A24      msgStereo	db "Stereo", 0Dh, 0Ah, "$"
   859                                  
   860                                  ;; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
   861                                  ;codec_id	dd 0
   862                                  ;codec_chip_id	dd 0
   863                                  ;codec_vendor_ids dw 0
   864                                  ;codec_chip_ids	dw 0
   865                                  
   866 000009EC 3030303030303030        dword_str	 dd 30303030h, 30303030h
   867 000009F4 680D0A00                		 db 'h', 0Dh, 0Ah, 0
   868                                  
   869                                  ;ac_unknown     db 'unknown manufacturer',13,10,0
   870                                  ;ac_Realtek     db 'Realtek Semiconductor',13,10,0
   871                                  ;ac_Analog      db 'Analog Devices',13,10,0
   872                                  ;ac_CMedia      db 'C-Media Electronics',13,10,0
   873                                  ;ac_Cirrus      db 'Cirrus Logic',13,10,0
   874                                  ;ac_Wolfson     db 'Wolfson Microelectronics',13,10,0
   875                                  ;ac_VIA         db 'VIA Technologies',13,10,0
   876                                  ;ac_SigmaTel    db 'SigmaTel',13,10,0
   877                                  ;ac_eMicro      db 'eMicro',13,10,0
   878                                  ;
   879                                  ;chip_unknown   db 'unknown codec id ', 0
   880                                  
   881                                  ;CHIP_REALTEK   equ 414C4700h
   882                                  ;CHIP_CMEDIA    equ 434D4900h
   883                                  ;CHIP_VIA       equ 56494100h
   884                                  
   885                                  ;codecs        dd CHIP_CMEDIA
   886                                  ;	       dw ac_CMedia, chips_CMedia
   887                                  ;              dd CHIP_REALTEK
   888                                  ;	       dw ac_Realtek, chips_Realtek
   889                                  ;              dd CHIP_VIA
   890                                  ;	       dw ac_VIA, chips_VIA
   891                                  ;              dd 0
   892                                  
   893                                  ;chips_Realtek dw 10h, chip_ALC201a
   894                                  ;              dw 20h, chip_ALC650
   895                                  ;              dw 21h, chip_ALC650D
   896                                  ;              dw 22h, chip_ALC650E
   897                                  ;              dw 23h, chip_ALC650F
   898                                  ;              dw 60h, chip_ALC655
   899                                  ;              dw 80h, chip_ALC658
   900                                  ;              dw 81h, chip_ALC658D
   901                                  ;              dw 90h, chip_ALC850
   902                                  ;              dw 0FFh
   903                                  
   904                                  ;chips_CMedia  dw 41h, chip_CM9738
   905                                  ;              dw 61h, chip_CM9739
   906                                  ;              dw 69h, chip_CM9780
   907                                  ;              dw 78h, chip_CM9761
   908                                  ;              dw 82h, chip_CM9761
   909                                  ;              dw 83h, chip_CM9761
   910                                  ;              dw 0FFh
   911                                  
   912                                  ;chips_VIA     dw 61h, chip_VIA1612A
   913                                  ;              dw 0FFh
   914                                  
   915                                  ;Realtek
   916                                  ;chip_ALC201a    db 'ALC201a',0dh,0ah,00h
   917                                  ;chip_ALC650     db 'ALC650 ',0dh,0ah,00h
   918                                  ;chip_ALC650D    db 'ALC650D',0dh,0ah,00h
   919                                  ;chip_ALC650E    db 'ALC650E',0dh,0ah,00h
   920                                  ;chip_ALC650F    db 'ALC650F',0dh,0ah,00h
   921                                  ;chip_ALC655     db 'ALC655 ',0dh,0ah,00h
   922                                  ;chip_ALC658     db 'ALC658 ',0dh,0ah,00h
   923                                  ;chip_ALC658D    db 'ALC658D',0dh,0ah,00h
   924                                  ;chip_ALC850     db 'ALC850 ',0dh,0ah,00h
   925                                  
   926                                  ;CMedia
   927                                  ;chip_CM9738     db 'CMI9738', 0dh,0ah,0
   928                                  ;chip_CM9739     db 'CMI9739', 0dh,0ah,0
   929                                  ;chip_CM9780     db 'CMI9780', 0dh,0ah,0
   930                                  ;chip_CM9761     db 'CMI9761', 0dh,0ah,0
   931                                  
   932                                  ;VIA
   933                                  ;chip_VIA1612A   db 'VIA1612A',13,10,0
   934                                  
   935                                  ; 11/11/2023
   936                                  msg_init_err:
   937 000009F8 0D0A                    	db	CR, LF
   938 000009FA 4143393720436F6E74-     	db	"AC97 Controller/Codec initialization error !"
   938 00000A03 726F6C6C65722F436F-
   938 00000A0C 64656320696E697469-
   938 00000A15 616C697A6174696F6E-
   938 00000A1E 206572726F722021   
   939 00000A26 0D0A24                  	db	CR, LF, "$"
   940                                  
   941                                  ; 12/11/2023
   942                                  msg_no_vra:
   943 00000A29 0D0A                    	db	CR, LF
   944 00000A2B 4E6F20565241207375-     	db	"No VRA support ! Only 48 kHZ sample rate supported !"
   944 00000A34 70706F72742021204F-
   944 00000A3D 6E6C79203438206B48-
   944 00000A46 5A2073616D706C6520-
   944 00000A4F 726174652073757070-
   944 00000A58 6F727465642021     
   945 00000A5F 0D0A24                  	db	CR, LF, "$"
   946                                  
   947                                  ; 17/02/2017
   948                                  bss_start:
   949                                  
   950                                  ABSOLUTE bss_start
   951                                  
   952                                  alignb 2
   953                                  
   954                                  ; 28/11/2016
   955                                  
   956 00000A62 <res 1Ch>               smpRBuff:	resw 14 ; 19/11/2016 - Erdogan Tan
   957                                  
   958 00000A7E ????                    filehandle:	resw 1
   959                                  
   960 00000A80 ??                      flags:		resb 1
   961 00000A81 ??                      irq_status:	resb 1
   962                                  
   963 00000A82 ??                      inside:		resb 1
   964 00000A83 ??                      tLoop:		resb 1	
   965                                  
   966                                  ; 17/02/2017
   967                                  ; NAMBAR:  Native Audio Mixer Base Address Register
   968                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
   969                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
   970                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
   971 00000A84 ????                    NAMBAR:		resw 1			; BAR for mixer
   972 00000A86 ????                    NABMBAR         resw 1			; BAR for bus master regs
   973                                  
   974                                  ; 256 byte buffer for descriptor list
   975 00000A88 ????                    BDL_BUFFER:	resw 1			; segment of our 256byte BDL buffer
   976 00000A8A ????                    WAV_BUFFER1:	resw 1			; segment of our WAV storage
   977                                  ; 64k buffers for wav file storage
   978 00000A8C ????                    WAV_BUFFER2:	resw 1			; segment of 2nd wav buffer
   979                                  
   980 00000A8E ??                      tBuff:		resb 1
   981                                  
   982 00000A8F ??                      ac97_int_ln_reg: resb 1
   983                                  
   984                                  ; 12/11/2016 - Erdogan Tan
   985                                  
   986 00000A90 ????????                bus_dev_fn:	resd 1
   987 00000A94 ????????                dev_vendor:	resd 1
   988 00000A98 ????                    stats_cmd:	resw 1 ; 17/02/2017
   989 00000A9A ????                    ac97_io_base:	resw 1
   990 00000A9C ????                    sample_rate:	resw 1
   991                                  ; 19/11/2016
   992 00000A9E ????                    stmo:		resw 1 
   993 00000AA0 ????                    bps:		resw 1
   994                                  
   995 00000AA2 ??                      fbs_shift:	resb 1
   996 00000AA3 ????                    fbs_seg:	resw 1
   997 00000AA5 ????                    fbs_off:	resw 1
   998                                  
   999                                  ; 32 kilo bytes for temporay buffer
  1000                                  ; (for stereo-mono, 8bit/16bit corrections)
  1001 00000AA7 <res 8000h>             temp_buffer:	resb 32768
  1002 00008AA7 <res 9h>                alignb 16
  1003                                  EOF:
