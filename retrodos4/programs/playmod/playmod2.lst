     1                                  ; ****************************************************************************
     2                                  ; playmod2.asm (for MSDOS)
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; PLAYMOD2.COM ! ICH AC97 MOD PLAYER & VGA DEMO program by Erdogan TAN
     5                                  ;
     6                                  ; 18/02/2017
     7                                  ;
     8                                  ; [ Last Modification: 13/05/2024 ]
     9                                  ;
    10                                  ; Derived from source code of 'PLAYWAV.COM' ('PLAYWAV.ASM') by Erdogan Tan
    11                                  ;							      (17/02/2017)
    12                                  ; Modified from 'PLAYMOD.COM' ('playmod.asm') source code 
    13                                  ;		 VIA VT8237 MOD PLAYER & VGA DEMO program by Erdogan TAN
    14                                  ;							     (15/02/2017)	
    15                                  ;
    16                                  ; Derived from source code of 'PLAY.EXE' (TINYPLAY) by Carlos Hasan (1993)
    17                                  ;          PLAY.EXE: PLAY.ASM, MODLOAD.ASM, MODPLAY.ASM, SB.ASM
    18                                  ;
    19                                  ; Assembler: NASM 2.11
    20                                  ; ----------------------------------------------------------------------------
    21                                  ;	   nasm  playmod2.asm -l playmod2.lst -o PLAYMOD2.COM	
    22                                  ; ****************************************************************************
    23                                  
    24                                  ; Tiny MOD Player v0.1b by Carlos Hasan.
    25                                  ;		July 14th, 1993.
    26                                  
    27                                  ;=============================================================================
    28                                  ;               PLAYWAV.ASM / PLAYER.ASM / TINYPLAY.ASM
    29                                  ;=============================================================================
    30                                  ; Audio controller, codec & PCI functions are derived from '.wav file player 
    31                                  ; for DOS' source code by Jeff Leyda (PLAYER.EXE), Sep 02, 2002.
    32                                  
    33                                  ; TUNELOOP version ; 12/05/2024
    34                                  
    35                                  [BITS 16]
    36                                  [org 100h]
    37                                  
    38                                  Start:
    39 00000000 E8CF00                  	call    DetectICH		; Detect AC97 Audio Device
    40                                  GetFileName:    			; Parse  the Command line...
    41 00000003 BE8000                  	mov	si, 80h
    42 00000006 8A1C                    	mov	bl, [si]
    43 00000008 30FF                    	xor	bh, bh
    44 0000000A 43                      	inc	bx
    45 0000000B C60000                  	mov	byte [si+bx], 0		; make AsciiZ filename.
    46 0000000E 46                      	inc	si
    47                                  ScanName:       
    48 0000000F AC                      	lodsb
    49 00000010 84C0                    	test	al, al
    50 00000012 0F84B200                	je	pmsg_2017
    51 00000016 3C20                    	cmp	al, 20h
    52 00000018 74F5                    	je	short ScanName		; scan start of name.
    53 0000001A 89F7                    	mov	di, si
    54 0000001C 4F                      	dec	di
    55                                  ScanPeriod:
    56 0000001D AC                      	lodsb
    57 0000001E 3C2E                    	cmp	al, '.'			; if period NOT found,
    58 00000020 7410                    	je	short PrintMesg		; then add a .MOD extension.
    59 00000022 84C0                    	test	al, al
    60 00000024 75F7                    	jnz	short ScanPeriod
    61 00000026 4E                      	dec	si
    62                                  SetExt:
    63                                  	;mov	byte [si+0], '.'
    64                                  	;mov	byte [si+1], 'M'
    65                                  	;mov	byte [si+2], 'O'
    66                                  	;mov	byte [si+3], 'D'
    67 00000027 66C7042E4D4F44          	mov	dword [si], '.MOD'
    68 0000002E C6440400                	mov	byte [si+4], 0
    69                                  
    70                                  PrintMesg:
    71 00000032 B80009                  	mov	ax, 0900h		; Prints the Credits Text.
    72                                  	;lea	dx, [Credits]
    73 00000035 BA[BC0D]                	mov	dx, Credits
    74 00000038 CD21                    	int	21h
    75                                  
    76                                  	; 13/05/2024
    77 0000003A E8E00B                  	call	write_ac97_dev_info
    78 0000003D B80009                  	mov	ax, 0900h		; Prints the Credits Text.
    79 00000040 BA[ED0D]                	mov	dx, CRLF
    80 00000043 CD21                    	int	21h
    81                                  LoadMod:  
    82                                  	; es:di = Filename address
    83 00000045 06                      	push	es
    84 00000046 57                      	push	di
    85 00000047 E8F804                  	call    LoadModule		; Load the MODule...
    86                                  
    87 0000004A 833E[A650]00            	cmp     word [ErrorInfo], 0	; any error loading?
    88 0000004F 740A                    	je      short init_codec
    89                                  
    90 00000051 B80009                  	mov     ax, 0900h		; yes, print error and Exit.
    91                                  	;lea    dx, [ErrorMesg]
    92 00000054 BA[F00D]                	mov	dx, ErrorMesg
    93 00000057 CD21                    	int     21h
    94 00000059 EB66                    	jmp     Exit
    95                                  
    96                                  init_codec:
    97 0000005B E8BF0B                  	call	write_ac97_dev_info
    98                                  
    99                                  	; 08/05/2024
   100                                  	; 17/02/2017
   101                                  	;mov	dx, [stats_cmd]
   102                                          ;or	dl, IO_ENA+BM_ENA		; enable IO and bus master
   103                                          ;call	pciRegWrite16 ; pciRegWrite8
   104                                  
   105                                  	; 18/02/2017
   106 0000005E C706[E454]2256          	mov	word [sample_rate], 22050	; Mixing at 22.050 kHz
   107                                  
   108                                  	; 08/05/2024
   109                                  	; (48 kHZ mixing is necessary 
   110                                  	;  if the AC97 hardware/codec has not got VRA feature)
   111                                  	; ((or frequency converting code would be needed))
   112                                  	;mov	word [sample_rate], 48000	; Mixing at 48 kHz
   113                                  
   114                                  ; setup the Codec (actually mixer registers)
   115 00000064 E8FD01                          call    codecConfig			; unmute codec, set rates.
   116 00000067 731A                    	jnc	short PlayNow
   117                                  
   118                                  _codec_err:
   119 00000069 0E                      	push	cs
   120 0000006A 1F                      	pop	ds
   121 0000006B BA[7400]                        mov	dx, CodecErrMsg
   122 0000006E B409                            mov     ah, 9
   123 00000070 CD21                            int     21h
   124 00000072 EB4D                            jmp     Exit
   125                                  
   126 00000074 436F64656320457272-     CodecErrMsg db "Codec Error!"
   126 0000007D 6F7221             
   127 00000080 0D0A24                  	db	CR,LF,"$"
   128                                  PlayNow:  
   129 00000083 B8[A40F]                	mov	ax, BdlBuffer
   130 00000086 A3[920F]                	mov	[BDL_BUFFER], ax
   131                                      
   132 00000089 B8[A410]                	mov	ax, DmaBuffer		; DmaBuffer (4096 bytes) buff addr
   133 0000008C A3[940F]                	mov	[DMA_BUFFER1], ax	; 2048 byte half buffer 1 
   134                                  
   135 0000008F 050020                  	add	ax, BUFFERSIZE		; code/current segment
   136 00000092 A3[960F]                	mov	[DMA_BUFFER2], ax	; 2048 byte half buffer 2
   137                                    
   138                                  	;mov    word [MixSpeed], 22050	; Mixing at 22.050 kHz
   139                                  
   140 00000095 E8780A                  	call    StartPlaying
   141                                  
   142 00000098 B81300                  	mov     ax, 0013h		; Set Mode 320x200x256
   143 0000009B CD10                    	int     10h
   144                                  
   145 0000009D B98000                  	mov     cx, 128			; Make a lookup table
   146 000000A0 31DB                    	xor     bx, bx			; for fastest pixel
   147 000000A2 BA002D                  	mov     dx, 320*(100-64)	; addressing.
   148                                  MakeOfs:        
   149 000000A5 8997[B0B1]              	mov     [RowOfs+bx], dx
   150 000000A9 8997[B2B1]              	mov     [RowOfs+bx+2], dx
   151 000000AD 81C24001                	add     dx, 320
   152 000000B1 83C304                  	add     bx, 4
   153 000000B4 E2EF                    	loop    MakeOfs
   154                                  
   155                                  ; Note: Normally IRQ 0 calls the ModPlay Polling at 18.2Hz thru
   156                                  ;       the software interrupt 1Ch. If the IRQ 0 is disabled, then
   157                                  ;       the INT 1Ch MUST BE CALLED at least MixSpeed/1024 times per
   158                                  ;       second, or the module will sound "looped".
   159                                  ;       Because we need better sync with the ModPlayer to draw the scope,
   160                                  ;       the polling is called from my routine, and then the irq 0 must be
   161                                  ;       disabled. The [DmaBuffer] points to the current buffer of 8-bit
   162                                  ;       samples played by the Sound Blaster. Note that some samples are
   163                                  ;       discarded in the next code, just for fun!
   164                                  
   165                                  	;in     al, 21h			; disable irq 0!
   166                                  	;or     al, 00000001b
   167                                  	;out    21h, al
   168                                  		
   169 000000B6 E83D03                  	call	ModPlay ; 13/02/2017
   170                                  
   171                                  	;in	al, 21h			; enable irq 0!
   172                                  	;and	al, 11111110b
   173                                  	;out	21h, al
   174                                  
   175 000000B9 B80300                  	mov     ax, 0003h		; Set Text Mode 80x25x16
   176 000000BC CD10                    	int     10h
   177                                  
   178 000000BE E8D00A                  	call	StopPlaying		; STOP!
   179                                  Exit:           
   180                                  	;call   FreeModule		; Free MODule core.
   181                                  error_exit:
   182 000000C1 B8004C                  	mov     ax, 4C00h		; Bye!
   183 000000C4 CD21                    	int     21h
   184                                  here:
   185 000000C6 EBFE                    	jmp	short here
   186                                  
   187                                  pmsg_2017:
   188 000000C8 B80009                  	mov     ax, 0900h		; Prints the Credits Text.
   189                                  	;lea    dx, [msg_2017]
   190 000000CB BA[5C0D]                	mov	dx, msg_2017
   191 000000CE CD21                    	int     21h
   192 000000D0 EBEF                    	jmp	short Exit
   193                                  
   194                                  DetectICH:
   195                                  	; 18/02/2017
   196                                  	; Detech Intel ICH based AC97 Audio Device 
   197 000000D2 E84E01                  	call    pciFindDevice 	; AC97.ASM (PLAYWAV.COM)
   198 000000D5 733F                            jnc     short _1
   199                                  
   200                                  ; couldn't find the audio device!
   201                                  	;push	cs
   202                                  	;pop	ds
   203 000000D7 BA[E000]                        mov     dx, noDevMsg
   204 000000DA B409                            mov     ah, 9
   205 000000DC CD21                            int     21h
   206 000000DE EBE1                            jmp     short error_exit
   207                                  
   208 000000E0 4572726F723A20556E-     noDevMsg db "Error: Unable to find Intel ICH based audio device!",CR,LF,"$"
   208 000000E9 61626C6520746F2066-
   208 000000F2 696E6420496E74656C-
   208 000000FB 204943482062617365-
   208 00000104 6420617564696F2064-
   208 0000010D 6576696365210D0A24 
   209                                  
   210                                  _1:
   211                                  	; 18/02/2017
   212                                  	; eax = BUS/DEV/FN
   213                                  	;	00000000BBBBBBBBDDDDDFFF00000000
   214                                  	; edx = DEV/VENDOR
   215                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
   216                                  
   217 00000116 66A3[9A0F]              	mov	[bus_dev_fn], eax
   218 0000011A 668916[9E0F]            	mov	[dev_vendor], edx
   219                                  
   220                                  	; get ICH base address regs for mixer and bus master
   221                                  
   222 0000011F B010                            mov     al, NAMBAR_REG
   223 00000121 E87100                          call    pciRegRead16			; read PCI registers 10-11
   224 00000124 83E2FE                          and     dx, IO_ADDR_MASK 		; mask off BIT0
   225                                  
   226 00000127 8916[840F]                      mov     [NAMBAR], dx			; save audio mixer base addr
   227                                  
   228 0000012B B014                    	mov     al, NABMBAR_REG
   229 0000012D E86500                          call    pciRegRead16
   230 00000130 83E2FE                          and     dx, IO_ADDR_MASK
   231                                  
   232 00000133 8916[860F]                      mov     [NABMBAR], dx			; save bus master base addr
   233                                  
   234                                  	; 08/05/2024
   235                                  	; 06/11/2023
   236                                  	;; init controller
   237                                  	;; 17/02/2017
   238                                  	;mov	al, PCI_CMD_REG ; command register (04h)
   239                                  	;call	pciRegRead16 ; pciRegRead8
   240                                  	;
   241                                  	;; eax = BUS/DEV/FN/REG
   242                                  	;;  dx = PCI Command Register Content ; 17/02/2017
   243                                  	;; 	00000000CCCCCCCC
   244                                  	;mov	[stats_cmd], dx
   245                                  	;
   246                                  	; 06/11/2023
   247                                  	;mov	al, PCI_IO_BASE ; IO base address register (10h)
   248                                  	;call	pciRegRead32
   249                                  	;
   250                                  	;and	dx, 0FFC0h	; IO_ADDR_MASK (0FFFE) ?
   251                                          ;mov	[ac97_io_base], dx
   252                                  
   253 00000137 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
   254 00000139 E85100                  	call	pciRegRead8 ; 17/02/2017
   255                                  
   256 0000013C 8816[980F]              	mov     [ac97_int_ln_reg], dl
   257                                  
   258                                  ; 12/05/2024 (tuneloop version)
   259                                  %if 0
   260                                  	; 28/11/2016
   261                                  	;mov	bx, 1	; 08/05/2024
   262                                  	xor	dh, dh	; 17/02/2017
   263                                  	; 10/11/2023
   264                                  	;mov	cx, dx
   265                                  	;shl	bx, cl
   266                                  
   267                                  	; 04/11/2023
   268                                  	cli
   269                                  
   270                                  	;not	bx
   271                                  	in	al, 0A1h ; irq 8-15
   272                                          mov	ah, al
   273                                          in	al, 21h  ; irq 0-7 
   274                                  
   275                                  	; 04/11/2023
   276                                  	; save IRQ status
   277                                  	mov	[IRQ_status], ax
   278                                  
   279                                  	; 08/05/2024
   280                                  	;mov	dx, 4D1h			;8259 ELCR1
   281                                          ;in	al, dx
   282                                  	;mov	ah, al
   283                                  	;mov	dx, 4D0h 
   284                                          ;in	al, dx
   285                                  	;;or	ax, bx        
   286                                  	;bts	ax, cx
   287                                  	;mov	dx, 4D0h
   288                                  	;out	dx, al                          ;set level-triggered mode
   289                                  	;mov	al, ah
   290                                  	;mov	dx, 4D1h
   291                                  	;out	dx, al                          ;set level-triggered mode
   292                                  
   293                                  	; 24/11/2016 - Erdogan Tan
   294                                  	;mov	bx, cx
   295                                  	; 10/11/2023
   296                                  	mov	bx, dx
   297                                  	mov	bl, [bx+irq_int]
   298                                  	shl	bx, 2 ; * 4
   299                                  
   300                                  	; set up interrupt vector
   301                                  	; 30/11/2016
   302                                  	push	es
   303                                  	xor	ax, ax
   304                                  	mov	es, ax
   305                                  	; 04/11/2023
   306                                  	; save interrupt vector
   307                                  	mov	ax, [es:bx]
   308                                  	mov	[IRQ_vector], ax
   309                                  	mov	ax, [es:bx+2]
   310                                  	mov	[IRQ_vector+2], ax
   311                                  
   312                                  	mov	word [es:bx], ac97_int_handler
   313                                  	mov	ax, cs
   314                                  	mov	[es:bx+2], ax
   315                                  	pop	es
   316                                  
   317                                  	; 04/11/2023
   318                                  	sti
   319                                  %endif
   320 00000140 C3                      	retn
   321                                  
   322                                  ; 12/05/2024 (tuneloop version)
   323                                  %if 0
   324                                  
   325                                  ac97_int_handler:
   326                                  	; 11/05/2024
   327                                  	; 11/11/2023
   328                                  	; 10/11/2023
   329                                  	; 17/02/2016
   330                                  	push	eax	; 11/11/2023
   331                                  	push	dx
   332                                  	; 05/11/2023
   333                                  	;push	cx
   334                                  	;push	bx
   335                                  	;push	si
   336                                  	;push	di
   337                                  
   338                                  	; 10/11/2023
   339                                  	; EOI at first
   340                                  	mov	al, 20h
   341                                  	test	byte [ac97_int_ln_reg], 8
   342                                  	jz	short _ih_0
   343                                  	out 	0A0h, al ; 20h	; EOI
   344                                  _ih_0:
   345                                  	out	20h, al  ; 20h	; EOI
   346                                  
   347                                  	; 11/11/2023
   348                                  	; 09/11/2023
   349                                  	mov	dx, GLOB_STS_REG
   350                                          add	dx, [NABMBAR]
   351                                  	in	eax, dx
   352                                  	
   353                                  	; 12/05/2024
   354                                  	; 09/11/2023,
   355                                          ;cmp	eax, 0FFFFFFFFh ; -1
   356                                  	;je	short _ih_2
   357                                  	
   358                                  	; 12/05/2024
   359                                  	;test	al, 40h		; PCM Out Interrupt
   360                                  	;jnz	short _ih_1
   361                                  
   362                                  	;test	eax, eax
   363                                  	;jz	short _ih_2
   364                                  	; 12/05/2024
   365                                  	test	ax, PCM_OUT_IRQ+BCIS
   366                                  	jnz	short _ih_1
   367                                  
   368                                   	;mov	dx, GLOB_STS_REG
   369                                          ;add	dx, [NABMBAR]
   370                                  	out	dx, eax
   371                                  	jmp	short _ih_2
   372                                  
   373                                  	; .....
   374                                  	;mov	al, 1
   375                                  	; 10/11/2023
   376                                  	;mov	[tLoop], al  ; 1
   377                                  
   378                                  	;cmp	[inside], al ; 1
   379                                  	;jnb	short _ih_3	; busy
   380                                  
   381                                  	;mov	[inside], al ; 1
   382                                  	;
   383                                  	;; 09/11/2023
   384                                          ;mov	dx, [NABMBAR]
   385                                          ;add	dx, PO_SR_REG	; set pointer to Status reg
   386                                  	;in	al, dx
   387                                  	;; 10/11/2023
   388                                  	;;;out	dx, eax
   389                                  	;;out	dx, al		; clear interrupt event
   390                                  	;			; (by writing 1 to same bits)
   391                                  	;
   392                                  	;;mov	[pcm_irq_status], al ; 05/11/2023
   393                                  	;test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
   394                                  	;jz	short _ih_2
   395                                  	; .....
   396                                  
   397                                  _ih_1:
   398                                  	; 11/11/2023
   399                                  	push	eax
   400                                  
   401                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   402                                  	;mov	dx, PO_SR_REG
   403                                          ;add	dx, [NABMBAR]
   404                                  	;out	dx, ax
   405                                  
   406                                  	; 10/11/2023
   407                                  	; 28/11/2016 - Erdogan Tan
   408                                  	call	tuneLoop
   409                                  
   410                                  	; 11/11/2023
   411                                  	pop	eax
   412                                  	mov	dx, GLOB_STS_REG
   413                                          add	dx, [NABMBAR]
   414                                  	out	dx, eax
   415                                  _ih_2:
   416                                  	; 11/11/2023
   417                                  	mov	dx, [NABMBAR]
   418                                  	add	dx, PO_SR_REG	; set pointer to Status reg
   419                                  	mov	ax, 1Ch
   420                                  	out	dx, ax
   421                                  
   422                                  ;	; 10/11/2023
   423                                  ;	mov	al, 20h
   424                                  ;	test	byte [ac97_int_ln_reg], 8
   425                                  ;	jz	short _ih_3
   426                                  ;	out 	0A0h, al ; 20h	; EOI
   427                                  ;_ih_3:
   428                                  ;	out	20h, al  ; 20h	; EOI
   429                                  ;_ih_4:
   430                                  	;mov	byte [inside], 0
   431                                  	;pop	di
   432                                  	;pop	si
   433                                  	;pop	bx
   434                                  	;pop	cx
   435                                  	pop	dx
   436                                  	pop	eax ; 11/11/2023
   437                                  	iret
   438                                  
   439                                  %endif
   440                                  
   441                                  ;=============================================================================
   442                                  ;               PCI.ASM
   443                                  ;=============================================================================
   444                                  
   445                                  ; EQUATES
   446                                  
   447                                  ;constants of stuff that seem hard to remember at times.
   448                                  
   449                                  TRUE  EQU 1
   450                                  FALSE EQU 0
   451                                  
   452                                  ENABLED  EQU 1
   453                                  DISABLED EQU 0
   454                                  
   455                                  BIT0  EQU 1
   456                                  BIT1  EQU 2
   457                                  BIT2  EQU 4
   458                                  BIT3  EQU 8
   459                                  BIT4  EQU 10h
   460                                  BIT5  EQU 20h
   461                                  BIT6  EQU 40h
   462                                  BIT7  EQU 80h
   463                                  BIT8  EQU 100h
   464                                  BIT9  EQU 200h
   465                                  BIT10 EQU 400h
   466                                  BIT11 EQU 800h
   467                                  BIT12 EQU 1000h
   468                                  BIT13 EQU 2000h
   469                                  BIT14 EQU 4000h
   470                                  BIT15 EQU 8000h
   471                                  BIT16 EQU 10000h
   472                                  BIT17 EQU 20000h
   473                                  BIT18 EQU 40000h
   474                                  BIT19 EQU 80000h
   475                                  BIT20 EQU 100000h
   476                                  BIT21 EQU 200000h
   477                                  BIT22 EQU 400000h
   478                                  BIT23 EQU 800000h
   479                                  BIT24 EQU 1000000h
   480                                  BIT25 EQU 2000000h
   481                                  BIT26 EQU 4000000h
   482                                  BIT27 EQU 8000000h
   483                                  BIT28 EQU 10000000h
   484                                  BIT29 EQU 20000000h
   485                                  BIT30 EQU 40000000h
   486                                  BIT31 EQU 80000000h
   487                                  
   488                                  ;special characters
   489                                  NUL     EQU 0
   490                                  NULL    EQU 0
   491                                  BELL    EQU 07
   492                                  BS      EQU 08
   493                                  TAB     EQU 09
   494                                  LF      EQU 10
   495                                  CR      EQU 13
   496                                  ESCAPE  EQU 27           ;ESC is a reserved word....
   497                                  
   498                                  
   499                                  ;file stuff
   500                                  READONLY  EQU   BIT0
   501                                  HIDDEN    EQU   BIT1
   502                                  SYSTEM    EQU   BIT2
   503                                  VOLUME    EQU   BIT3         ;ignored for file access
   504                                  DIRECTORY EQU   BIT4         ;must be 0 for file access
   505                                  ARCHIVE   EQU   BIT5
   506                                  SHAREABLE EQU   BIT7         ;for novell networks
   507                                  OPEN	EQU	2		; open existing file
   508                                  CREATE	EQU	1		; create new file
   509                                  
   510                                  
   511                                  ; PCI equates
   512                                  ; PCI function address (PFA)
   513                                  ; bit 31 = 1
   514                                  ; bit 23:16 = bus number     (0-255)
   515                                  ; bit 15:11 = device number  (0-31)
   516                                  ; bit 10:8 = function number (0-7)
   517                                  ; bit 7:0 = register number  (0-255)
   518                                  
   519                                  IO_ADDR_MASK    EQU     0FFFEh          ; mask off bit 0 for reading BARs
   520                                  PCI_INDEX_PORT  EQU     0CF8h
   521                                  PCI_DATA_PORT   EQU     0CFCh
   522                                  PCI32           EQU     BIT31           ; bitflag to signal 32bit access
   523                                  PCI16           EQU     BIT30           ; bitflag for 16bit access
   524                                  
   525                                  PCI_FN0         EQU     0 << 8
   526                                  PCI_FN1         EQU     1 << 8
   527                                  PCI_FN2         EQU     2 << 8
   528                                  PCI_FN3         EQU     3 << 8
   529                                  PCI_FN4         EQU     4 << 8
   530                                  PCI_FN5         EQU     5 << 8
   531                                  PCI_FN6         EQU     6 << 8
   532                                  PCI_FN7         EQU     7 << 8
   533                                  
   534                                  PCI_CMD_REG		EQU	04h		; reg 04, command reg
   535                                   IO_ENA			EQU	BIT0		; i/o decode enable
   536                                   MEM_ENA		EQU	BIT1		; memory decode enable
   537                                   BM_ENA                 EQU     BIT2		; bus master enable
   538                                  
   539                                  ; CODE
   540                                  
   541                                  ; AC97.ASM
   542                                  ; PCI device register reader/writers.
   543                                  ; NASM version: Erdogan Tan (29/11/2016)
   544                                  ; 		Last Update: 17/02/2017
   545                                  
   546                                  ;===============================================================
   547                                  ; 8/16/32bit PCI reader
   548                                  ;
   549                                  ; Entry: EAX=PCI Bus/Device/fn/register number
   550                                  ;           BIT30 set if 32 bit access requested
   551                                  ;           BIT29 set if 16 bit access requested
   552                                  ;           otherwise defaults to 8bit read
   553                                  ;
   554                                  ; Exit:  DL,DX,EDX register data depending on requested read size
   555                                  ;
   556                                  ; Note: this routine is meant to be called via pciRegRead8, pciRegread16,
   557                                  ;	or pciRegRead32, listed below.
   558                                  ;
   559                                  ; Note2: don't attempt to read 32bits of data from a non dword aligned reg
   560                                  ;	 number.  Likewise, don't do 16bit reads from non word aligned reg #
   561                                  ; 
   562                                  pciRegRead:
   563 00000141 6653                    	push	ebx
   564 00000143 51                      	push	cx
   565 00000144 6689C3                          mov     ebx, eax                        ; save eax, dh
   566 00000147 88F1                            mov     cl, dh
   567 00000149 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   568 0000014F 660D00000080                    or      eax, BIT31                      ; make a PCI access request
   569 00000155 24FC                            and     al, ~3 ; NOT 3                  ; force index to be dword
   570                                  
   571 00000157 BAF80C                          mov     dx, PCI_INDEX_PORT
   572 0000015A 66EF                            out     dx, eax                         ; write PCI selector
   573                                  
   574 0000015C BAFC0C                          mov     dx, PCI_DATA_PORT
   575 0000015F 88D8                            mov     al, bl
   576 00000161 2403                            and     al, 3                           ; figure out which port to
   577 00000163 00C2                            add     dl, al                          ; read to
   578                                  
   579 00000165 66ED                    	in      eax, dx                         ; do 32bit read
   580 00000167 66F7C300000080                  test    ebx, PCI32
   581 0000016E 7403                            jz      short _pregr1
   582                                  
   583 00000170 6689C2                          mov     edx, eax                        ; return 32bits of data
   584                                  _pregr1:
   585 00000173 89C2                    	mov     dx, ax                          ; return 16bits of data
   586 00000175 66F7C3000000C0                  test    ebx, PCI32+PCI16
   587 0000017C 7502                            jnz     short _pregr2
   588 0000017E 88CE                            mov     dh, cl                          ; restore dh for 8 bit read
   589                                  _pregr2:
   590 00000180 6689D8                          mov     eax, ebx                        ; restore eax
   591 00000183 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   592 00000189 59                      	pop	cx
   593 0000018A 665B                    	pop	ebx
   594 0000018C C3                      	retn
   595                                  
   596                                  pciRegRead8:
   597 0000018D 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32             ; set up 8 bit read size
   598 00000193 EBAC                            jmp     short pciRegRead		; call generic PCI access
   599                                  
   600                                  pciRegRead16:
   601 00000195 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 16 bit read size
   602 0000019B 660D00000040                    or      eax, PCI16			; call generic PCI access
   603 000001A1 EB9E                            jmp     short pciRegRead
   604                                  
   605                                  pciRegRead32:
   606 000001A3 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 32 bit read size
   607 000001A9 660D00000080                    or      eax, PCI32			; call generic PCI access
   608 000001AF EB90                            jmp     short pciRegRead
   609                                  
   610                                  ;===============================================================
   611                                  ; 8/16/32bit PCI writer
   612                                  ;
   613                                  ; Entry: EAX=PCI Bus/Device/fn/register number
   614                                  ;           BIT31 set if 32 bit access requested
   615                                  ;           BIT30 set if 16 bit access requested
   616                                  ;           otherwise defaults to 8bit read
   617                                  ;        DL/DX/EDX data to write depending on size
   618                                  ;
   619                                  ;
   620                                  ; note: this routine is meant to be called via pciRegWrite8, pciRegWrite16,
   621                                  ; 	or pciRegWrite32 as detailed below.
   622                                  ;
   623                                  ; Note2: don't attempt to write 32bits of data from a non dword aligned reg
   624                                  ;	 number.  Likewise, don't do 16bit writes from non word aligned reg #
   625                                  ;
   626                                  pciRegWrite:
   627 000001B1 6653                    	push	ebx
   628 000001B3 51                      	push	cx
   629 000001B4 6689C3                          mov     ebx, eax                        ; save eax, dx
   630 000001B7 89D1                            mov     cx, dx
   631 000001B9 660D00000080                    or      eax, BIT31                      ; make a PCI access request
   632 000001BF 6625FFFFFFBF                    and     eax, ~PCI16 ; NOT PCI16         ; clear out data size request
   633 000001C5 24FC                            and     al, ~3 ; NOT 3                  ; force index to be dword
   634                                  
   635 000001C7 BAF80C                          mov     dx, PCI_INDEX_PORT
   636 000001CA 66EF                            out     dx, eax                         ; write PCI selector
   637                                  
   638 000001CC BAFC0C                          mov     dx, PCI_DATA_PORT
   639 000001CF 88D8                            mov     al, bl
   640 000001D1 2403                            and     al, 3                           ; figure out which port to
   641 000001D3 00C2                            add     dl, al                          ; write to
   642                                  
   643 000001D5 6689D0                          mov     eax, edx                        ; put data into eax
   644 000001D8 89C8                            mov     ax, cx
   645                                  
   646 000001DA EE                              out     dx, al
   647 000001DB 66F7C3000000C0                  test    ebx, PCI16+PCI32                ; only 8bit access? bail
   648 000001E2 740C                            jz      short _pregw1
   649                                  
   650 000001E4 EF                              out     dx, ax                          ; write 16 bit value
   651 000001E5 66F7C300000040                  test    ebx, PCI16                      ; 16bit requested?  bail
   652 000001EC 7502                            jnz     short _pregw1
   653                                  
   654 000001EE 66EF                            out     dx, eax                         ; write full 32bit
   655                                  _pregw1:
   656 000001F0 6689D8                          mov     eax, ebx                        ; restore eax
   657 000001F3 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   658 000001F9 89CA                            mov     dx, cx                          ; restore dx
   659 000001FB 59                      	pop	cx
   660 000001FC 665B                    	pop	ebx
   661 000001FE C3                      	ret
   662                                  
   663                                  pciRegWrite8:
   664 000001FF 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 8 bit write size
   665 00000205 EBAA                            jmp     short pciRegWrite		; call generic PCI access
   666                                  
   667                                  pciRegWrite16:
   668 00000207 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 16 bit write size
   669 0000020D 660D00000040                    or      eax, PCI16			; call generic PCI access
   670 00000213 EB9C                            jmp     short pciRegWrite
   671                                  
   672                                  pciRegWrite32:
   673 00000215 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 32 bit write size
   674 0000021B 660D00000080                    or      eax, PCI32			; call generic PCI access
   675 00000221 EB8E                            jmp     short pciRegWrite
   676                                  
   677                                  ; AC97.ASM (PLAYWAV.COM)
   678                                  ; 17/02/2017 (Modifed by Erdogan Tan for various ICH device IDs)
   679                                  ;===============================================================
   680                                  ; PCIFindDevice: scan through PCI space looking for a device+vendor ID
   681                                  ;
   682                                  ;  ENTRY: none
   683                                  ;; Entry: EAX=Device+Vendor ID
   684                                  ;
   685                                  ;  Exit: EAX=PCI address if device found
   686                                  ;	 EDX=Device+Vendor ID
   687                                  ;        CY clear if found, set if not found. EAX invalid if CY set.
   688                                  ;
   689                                  ; [old stackless] Destroys: ebx, esi, edi, cl
   690                                  ;
   691                                  pciFindDevice:
   692                                  	;push	cx
   693                                  	;push	eax ; *
   694                                  	;push	esi
   695                                  	;push	edi
   696                                  
   697                                   	;mov     esi, eax                ; save off vend+device ID
   698                                  
   699                                  	; 17/02/2017
   700 00000223 BE[850E]                	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
   701 00000226 B91500                  	mov	cx, valid_id_count
   702                                  pfd_0:
   703 00000229 66BF00FFFF7F                   	mov     edi, (80000000h - 100h) ; start with bus 0, dev 0 func 0
   704                                  nextPCIdevice:
   705 0000022F 6681C700010000                  add     edi, 100h
   706 00000236 6681FF00F8FF80                  cmp     edi, 80FFF800h		; scanned all devices?
   707                                          ;stc
   708                                          ;je 	short PCIScanExit       ; not found
   709 0000023D 720D                    	jb	short pfd_1
   710 0000023F 66BF00000080            	mov     edi, 80000000h
   711 00000245 83C604                  	add	si, 4 ; scan for next device ID
   712 00000248 E202                    	loop	pfd_1	 
   713 0000024A F9                      	stc	
   714                                  	;jmp 	short PCIScanExit
   715 0000024B C3                      	retn
   716                                  pfd_1:
   717 0000024C 6689F8                          mov     eax, edi                ; read PCI registers
   718 0000024F E851FF                          call    pciRegRead32
   719                                          ;cmp    edx, esi                ; found device?
   720 00000252 663B14                          cmp	edx, dword [si]
   721 00000255 75D8                    	jne     short nextPCIdevice
   722                                          ;clc
   723                                  PCIScanExit:
   724                                  	;pushf
   725 00000257 66B800000080            	mov	eax, BIT31
   726 0000025D 66F7D0                  	not	eax
   727 00000260 6621F8                  	and	eax, edi		; return only bus/dev/fn #
   728                                  	;popf
   729                                  
   730                                  	;pop	edi
   731                                  	;pop	esi
   732                                  	;pop	edx ; *
   733                                  	;pop	cx
   734 00000263 C3                      	retn
   735                                  
   736                                  ;=============================================================================
   737                                  ;               CODEC.ASM
   738                                  ;=============================================================================
   739                                  
   740                                  ; EQUATES
   741                                  
   742                                  ;Codec registers.
   743                                  ;
   744                                  ;Not all codecs are created equal. Refer to the spec for your specific codec.
   745                                  ;
   746                                  ;All registers are 16bits wide.  Access to codec registers over the AC97 link
   747                                  ;is defined by the OEM.  
   748                                  ;
   749                                  ;Secondary codec's are accessed by ORing in BIT7 of all register accesses.
   750                                  ;
   751                                  
   752                                  ; each codec/mixer register is 16bits
   753                                  
   754                                  CODEC_RESET_REG                 equ     00      ; reset codec
   755                                  CODEC_MASTER_VOL_REG            equ     02      ; master volume
   756                                  CODEC_HP_VOL_REG                equ     04      ; headphone volume
   757                                  CODEC_MASTER_MONO_VOL_REG       equ     06      ; master mono volume
   758                                  CODEC_MASTER_TONE_REG           equ     08      ; master tone (R+L)
   759                                  CODEC_PCBEEP_VOL_REG            equ     0ah     ; PC beep volume
   760                                  CODEC_PHONE_VOL_REG             equ     0bh     ; phone volume
   761                                  CODEC_MIC_VOL_REG               equ     0eh     ; MIC volume
   762                                  CODEC_LINE_IN_VOL_REG           equ     10h     ; line input volume
   763                                  CODEC_CD_VOL_REG                equ     12h     ; CD volume
   764                                  CODEC_VID_VOL_REG               equ     14h     ; video volume
   765                                  CODEC_AUX_VOL_REG               equ     16h     ; aux volume
   766                                  CODEC_PCM_OUT_REG               equ     18h     ; PCM output volume
   767                                  CODEC_RECORD_SELECT_REG         equ     1ah     ; record select input
   768                                  CODEC_RECORD_VOL_REG            equ     1ch     ; record volume
   769                                  CODEC_RECORD_MIC_VOL_REG        equ     1eh     ; record mic volume
   770                                  CODEC_GP_REG                    equ     20h     ; general purpose
   771                                  CODEC_3D_CONTROL_REG            equ     22h     ; 3D control
   772                                  ; 24h is reserved
   773                                  CODEC_POWER_CTRL_REG            equ     26h     ; powerdown control
   774                                  CODEC_EXT_AUDIO_REG             equ     28h     ; extended audio
   775                                  CODEC_EXT_AUDIO_CTRL_REG        equ     2ah     ; extended audio control
   776                                  CODEC_PCM_FRONT_DACRATE_REG     equ     2ch     ; PCM out sample rate
   777                                  CODEC_PCM_SURND_DACRATE_REG     equ     2eh     ; surround sound sample rate
   778                                  CODEC_PCM_LFE_DACRATE_REG       equ     30h     ; LFE sample rate
   779                                  CODEC_LR_ADCRATE_REG            equ     32h     ; PCM in sample rate
   780                                  CODEC_MIC_ADCRATE_REG           equ     34h     ; mic in sample rate
   781                                  
   782                                  ; registers 36-7a are reserved on the ICH
   783                                  
   784                                  CODEC_VENDORID1_REG             equ     7ch     ; codec vendor ID 1
   785                                  CODEC_VENDORID2_REG             equ     7eh     ; codec vendor ID 2
   786                                  
   787                                  ; Mixer registers 0 through 51h reside in the ICH and are not forwarded over
   788                                  ; the AC97 link to the codec, which I think is a little weird.  Looks like
   789                                  ; the ICH makes it so you don't need a fully functional codec to play audio?
   790                                  ;
   791                                  ; whenever 2 codecs are present in the system, use BIT7 to access the 2nd
   792                                  ; set of registers, ie 80h-feh
   793                                  
   794                                  PRIMARY_CODEC                   equ     0       ; 0-7F for primary codec
   795                                  SECONDARY_CODEC                 equ     BIT7    ; 80-8f registers for 2ndary
   796                                  
   797                                  SAMPLE_RATE_441khz	equ     44100   ; 44.1Khz (cd quality) rate
   798                                  
   799                                  ; ----------------------------------------------------------------------------
   800                                  ; 17/02/2017
   801                                  PCI_IO_BASE	equ 10h			; = NAMBAR register offset
   802                                  AC97_INT_LINE   equ 3Ch			; AC97 Interrupt Line register offset
   803                                  
   804                                  ; ----------------------------------------------------------------------------
   805                                  ; ICH2AC97.INC
   806                                  ; ----------------------------------------------------------------------------
   807                                  
   808                                  ; PCI stuff
   809                                  
   810                                  ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
   811                                  
   812                                  INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
   813                                  
   814                                  ; 08/05/2024
   815                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   816                                  SIS_VID		equ	1039h
   817                                  NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
   818                                  AMD_VID		equ	1022h
   819                                  
   820                                  ICH_DID         equ     2415h           ; ICH device ID
   821                                  ICH0_DID        equ     2425h           ; ICH0
   822                                  ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
   823                                                                          ; they all should be compatible.
   824                                  ; 08/05/2024
   825                                  ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
   826                                  ICH3_DID	equ     2485h           ; ICH3
   827                                  ICH4_DID        equ     24C5h           ; ICH4
   828                                  ICH5_DID	equ     24D5h           ; ICH5 
   829                                  ICH6_DID	equ     266Eh           ; ICH6
   830                                  ESB6300_DID	equ     25A6h           ; 6300ESB
   831                                  ESB631X_DID	equ     2698h           ; 631XESB
   832                                  ICH7_DID	equ	27DEh		; ICH7
   833                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   834                                  MX82440_DID	equ	7195h
   835                                  SI7012_DID	equ	7012h
   836                                  NFORCE_DID	equ	01B1h
   837                                  NFORCE2_DID	equ	006Ah
   838                                  AMD8111_DID	equ	746Dh
   839                                  AMD768_DID	equ	7445h
   840                                  ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
   841                                  CK804_DID	equ	0059h
   842                                  MCP04_DID	equ	003Ah
   843                                  CK8_DID		equ	008Ah
   844                                  NFORCE3_DID	equ	00DAh
   845                                  CK8S_DID	equ	00EAh
   846                                  
   847                                  NAMBAR_REG      equ     10h             ; native audio mixer BAR
   848                                   NAM_SIZE       equ     256             ; 256 bytes required.
   849                                  
   850                                  NABMBAR_REG     equ     14h             ; native audio bus mastering BAR
   851                                   NABM_SIZE      equ     64              ; 64 bytes
   852                                  
   853                                  ; BUS master registers, accessed via NABMBAR+offset
   854                                  
   855                                  ; ICH supports 3 different types of register sets for three types of things
   856                                  ; it can do, thus:
   857                                  ;
   858                                  ; PCM in (for recording) aka PI
   859                                  ; PCM out (for playback) aka PO
   860                                  ; MIC in (for recording) aka MC
   861                                  
   862                                  PI_BDBAR_REG            equ     0       ; PCM in buffer descriptor BAR
   863                                  PO_BDBAR_REG            equ     10h     ; PCM out buffer descriptor BAR
   864                                  MC_BDBAR_REG            equ     20h     ; MIC in buffer descriptor BAR
   865                                  
   866                                  ; each buffer descriptor BAR holds a pointer which has entries to the buffer
   867                                  ; contents of the .WAV file we're going to play.  Each entry is 8 bytes long
   868                                  ; (more on that later) and can contain 32 entries total, so each BAR is
   869                                  ; 256 bytes in length, thus:
   870                                  
   871                                  BDL_SIZE                equ     32*8    ; Buffer Descriptor List size
   872                                  INDEX_MASK              equ     31      ; indexes must be 0-31
   873                                  
   874                                  
   875                                  
   876                                  PI_CIV_REG              equ     4       ; PCM in current Index value (RO)
   877                                  PO_CIV_REG              equ     14h     ; PCM out current Index value (RO)
   878                                  MC_CIV_REG              equ     24h     ; MIC in current Index value (RO)
   879                                  ;8bit read only
   880                                  ; each current index value is simply a pointer showing us which buffer
   881                                  ; (0-31) the codec is currently processing.  Once this counter hits 31, it
   882                                  ; wraps back to 0.
   883                                  ; this can be handy to know, as once it hits 31, we're almost out of data to
   884                                  ; play back or room to record!
   885                                  
   886                                  
   887                                  PI_LVI_REG              equ     5       ; PCM in Last Valid Index
   888                                  PO_LVI_REG              equ     15h     ; PCM out Last Valid Index
   889                                  MC_LVI_REG              equ     25h     ; MIC in Last Valid Index
   890                                  ;8bit read/write
   891                                  ; The Last Valid Index is a number (0-31) to let the codec know what buffer
   892                                  ; number to stop on after processing.  It could be very nasty to play audio
   893                                  ; from buffers that aren't filled with the audio we want to play.
   894                                  
   895                                  
   896                                  PI_SR_REG               equ     6       ; PCM in Status register
   897                                  PO_SR_REG               equ     16h     ; PCM out Status register
   898                                  MC_SR_REG               equ     26h     ; MIC in Status register
   899                                  ;16bit read/write
   900                                  ; status registers.  Bitfields follow:
   901                                  
   902                                  FIFO_ERR                equ     BIT4    ; FIFO Over/Underrun W1TC.
   903                                  
   904                                  BCIS                    equ     BIT3    ; buffer completion interrupt status.
   905                                                                          ; Set whenever the last sample in ANY
   906                                                                          ; buffer is finished.  Bit is only
   907                                                                          ; set when the Interrupt on Complete
   908                                                                          ; (BIT4 of control reg) is set.
   909                                  
   910                                  LVBCI                   equ     BIT2    ; Set whenever the codec has processed
   911                                                                          ; the last buffer in the buffer list.
   912                                                                          ; Will fire an interrupt if IOC bit is
   913                                                                          ; set. Probably set after the last
   914                                                                          ; sample in the last buffer is
   915                                                                          ; processed.  W1TC
   916                                  
   917                                                                          ; 
   918                                  CELV                    equ     BIT1    ; Current buffer == last valid.
   919                                                                          ; Bit is RO and remains set until LVI is
   920                                                                          ; cleared.  Probably set up the start
   921                                                                          ; of processing for the last buffer.
   922                                  
   923                                  
   924                                  DCH                     equ     BIT0    ; DMA controller halted.
   925                                                                          ; set whenever audio stream is stopped
   926                                                                          ; or something else goes wrong.
   927                                  
   928                                  PI_PICB_REG             equ     8       ; PCM in position in current buffer(RO)
   929                                  PO_PICB_REG             equ     18h     ; PCM out position in current buffer(RO)
   930                                  MC_PICB_REG             equ     28h     ; MIC in position in current buffer (RO)
   931                                  ;16bit read only
   932                                  ; position in current buffer regs show the number of dwords left to be
   933                                  ; processed in the current buffer.
   934                                  ; 
   935                                  
   936                                  PI_PIV_REG              equ     0ah     ; PCM in Prefected index value
   937                                  PO_PIV_REG              equ     1ah     ; PCM out Prefected index value
   938                                  MC_PIV_REG              equ     2ah     ; MIC in Prefected index value
   939                                  ;8bit, read only
   940                                  ; Prefetched index value register.
   941                                  ; tells which buffer number (0-31) has be prefetched.  I'd imagine this
   942                                  ; value follows the current index value fairly closely. (CIV+1)
   943                                  ;
   944                                  
   945                                  PI_CR_REG               equ     0bh     ; PCM in Control Register
   946                                  PO_CR_REG               equ     1bh     ; PCM out Control Register
   947                                  MC_CR_REG               equ     2bh     ; MIC in Control Register
   948                                  ; 8bit
   949                                  ; Control register *MUST* only be accessed as an 8bit value.
   950                                  ; Control register.  See bitfields below.
   951                                  ;
   952                                  
   953                                  IOCE                    equ     BIT4    ; interrupt on complete enable.
   954                                                                          ; set this bit if you want an intrtpt
   955                                                                          ; to fire whenever LVBCI is set.
   956                                  FEIFE                   equ     BIT3    ; set if you want an interrupt to fire
   957                                                                          ; whenever there is a FIFO (over or
   958                                                                          ; under) error.
   959                                  LVBIE                   equ     BIT2    ; last valid buffer interrupt enable.
   960                                                                          ; set if you want an interrupt to fire
   961                                                                          ; whenever the completion of the last
   962                                                                          ; valid buffer.
   963                                  RR                      equ     BIT1    ; reset registers.  Nukes all regs
   964                                                                          ; except bits 4:2 of this register.
   965                                                                          ; Only set this bit if BIT 0 is 0
   966                                  RPBM                    equ     BIT0    ; Run/Pause
   967                                                                          ; set this bit to start the codec!
   968                                  
   969                                  
   970                                  GLOB_CNT_REG            equ     2ch     ; Global control register
   971                                  SEC_RES_EN              equ     BIT5    ; secondary codec resume event 
   972                                                                          ; interrupt enable.  Not used here.
   973                                  PRI_RES_EN              equ     BIT4    ; ditto for primary. Not used here.
   974                                  ACLINK_OFF              equ     BIT3    ; Turn off the AC97 link
   975                                  ACWARM_RESET            equ     BIT2    ; Awaken the AC97 link from sleep.
   976                                                                          ; registers preserved, bit self clears
   977                                  ACCOLD_RESET            equ     BIT1    ; Reset everything in the AC97 and
   978                                                                          ; reset all registers.  Not self clearing
   979                                  
   980                                  GPIIE                   equ     BIT0    ; GPI Interrupt enable.
   981                                                                          ; set if you want an interrupt to
   982                                                                          ; fire upon ANY of the bits in the
   983                                                                          ; GPI (general pursose inputs?) not used.
   984                                  
   985                                  GLOB_STS_REG            equ     30h     ; Global Status register (RO)
   986                                  
   987                                  MD3                     equ     BIT17   ; modem powerdown status (yawn)
   988                                  AD3                     equ     BIT16   ; Audio powerdown status (yawn)
   989                                  RD_COMPLETE_STS         equ     BIT15   ; Codec read timed out. 0=normal
   990                                  BIT3SLOT12              equ     BIT14   ; shadowed status of bit 3 in slot 12
   991                                  BIT2SLOT12              equ     BIT13   ; shadowed status of bit 2 in slot 12
   992                                  BIT1SLOT12              equ     BIT12   ; shadowed status of bit 1 in slot 12
   993                                  SEC_RESUME_STS          equ     BIT11   ; secondary codec has resumed (and irqed)
   994                                  PRI_RESUME_STS          equ     BIT10   ; primary codec has resumed (and irqed)
   995                                  SEC_CODEC_RDY           equ     BIT9    ; secondary codec is ready for action
   996                                  PRI_CODEC_RDY           equ     BIT8    ; Primary codec is ready for action
   997                                                                          ; software must check these bits before
   998                                                                          ; starting the codec!
   999                                  MIC_IN_IRQ              equ     BIT7    ; MIC in caused an interrupt
  1000                                  PCM_OUT_IRQ             equ     BIT6    ; One of the PCM out channels IRQed
  1001                                  PCM_IN_IRQ              equ     BIT5    ; One of the PCM in channels IRQed
  1002                                  MODEM_OUT_IRQ           equ     BIT2    ; modem out channel IRQed
  1003                                  MODEM_IN_IRQ            equ     BIT1    ; modem in channel IRQed
  1004                                  GPI_STS_CHANGE          equ     BIT0    ; set whenever GPI's have changed.
  1005                                                                          ; BIT0 of slot 12 also reflects this.
  1006                                  
  1007                                  
  1008                                  ACC_SEMA_REG            equ     34h     ; Codec write semiphore register
  1009                                  CODEC_BUSY              equ     BIT0    ; codec register I/O is happening
  1010                                                                          ; self clearing
  1011                                  ;
  1012                                  ; Buffer Descriptors List
  1013                                  ; As stated earlier, each buffer descriptor list is a set of (up to) 32 
  1014                                  ; descriptors, each 8 bytes in length.  Bytes 0-3 of a descriptor entry point
  1015                                  ; to a chunk of memory to either play from or record to.  Bytes 4-7 of an
  1016                                  ; entry describe various control things detailed below.
  1017                                  ; 
  1018                                  ; Buffer pointers must always be aligned on a Dword boundry.
  1019                                  ;
  1020                                  ;
  1021                                  
  1022                                  IOC                     equ     BIT31   ; Fire an interrupt whenever this
  1023                                                                          ; buffer is complete.
  1024                                  
  1025                                  BUP                     equ     BIT30   ; Buffer Underrun Policy.
  1026                                                                          ; if this buffer is the last buffer
  1027                                                                          ; in a playback, fill the remaining
  1028                                                                          ; samples with 0 (silence) or not.
  1029                                                                          ; It's a good idea to set this to 1
  1030                                                                          ; for the last buffer in playback,
  1031                                                                          ; otherwise you're likely to get a lot
  1032                                                                          ; of noise at the end of the sound.
  1033                                  
  1034                                  ;
  1035                                  ; Bits 15:0 contain the length of the buffer, in number of samples, which
  1036                                  ; are 16 bits each, coupled in left and right pairs, or 32bits each.
  1037                                  ; Luckily for us, that's the same format as .wav files.
  1038                                  ;
  1039                                  ; A value of FFFF is 65536 samples.  Running at 44.1Khz, that's just about
  1040                                  ; 1.5 seconds of sample time.  FFFF * 32bits is 1FFFFh bytes or 128k of data.
  1041                                  ;
  1042                                  ; A value of 0 in these bits means play no samples.
  1043                                  ;
  1044                                  
  1045                                  ; CODE
  1046                                  
  1047                                  ; AC97.ASM
  1048                                  
  1049                                  ; codec configuration code.  Not much here really.
  1050                                  ; NASM version: Erdogan Tan (29/11/2016)
  1051                                  
  1052                                  ; enable codec, unmute stuff, set output rate to 44.1
  1053                                  ; entry: ax = desired sample rate
  1054                                  ;
  1055                                  
  1056                                  ; 08/05/2024
  1057                                  %if 0
  1058                                  
  1059                                  codecConfig:
  1060                                  	; 17/02/2017 
  1061                                  	; 07/11/2016 (Erdogan Tan)
  1062                                  	PORT_NABM_GLB_CTRL_STAT equ 60h
  1063                                  
  1064                                  	;mov    dx, [NAMBAR]               	; mixer base address
  1065                                  	;add	dx, CODEC_EXT_AUDIO_REG	       	; 28h  	  
  1066                                  	;in	ax, dx
  1067                                  	;and	ax, 1
  1068                                  	;jnz	short _ssr
  1069                                  	;pop	ax
  1070                                  	;jmp	short cconf_1
  1071                                  
  1072                                  _ssr:
  1073                                  	mov    	dx, [NAMBAR]               	
  1074                                  	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah  	  
  1075                                  	in     	ax, dx
  1076                                  	or	ax, 1
  1077                                  	out	dx, ax 				; Enable variable rate audio
  1078                                  
  1079                                          call    delay1_4ms
  1080                                          call    delay1_4ms
  1081                                          call    delay1_4ms
  1082                                          call    delay1_4ms
  1083                                  
  1084                                  	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
  1085                                  
  1086                                  	mov    	dx, [NAMBAR]               	
  1087                                  	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
  1088                                  	out	dx, ax 				; out sample rate
  1089                                  		
  1090                                  	;mov    dx, [NAMBAR]               	
  1091                                  	;add    dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
  1092                                  	;out	dx, ax 
  1093                                  
  1094                                          call    delay1_4ms
  1095                                          call    delay1_4ms
  1096                                          call    delay1_4ms
  1097                                          call    delay1_4ms
  1098                                  
  1099                                  ;cconf_1:
  1100                                  	mov     dx, [NAMBAR]			; mixer base address
  1101                                          add     dx, CODEC_RESET_REG  		; reset register
  1102                                          mov	ax, 42
  1103                                  	out     dx, ax                          ; reset
  1104                                  
  1105                                  	mov     dx, [NABMBAR]			; bus master base address
  1106                                          add     dx, PORT_NABM_GLB_CTRL_STAT
  1107                                          mov	ax, 2
  1108                                  	out     dx, ax                         
  1109                                  
  1110                                  	mov	cx, 7
  1111                                  _100ms:
  1112                                  	push	cx
  1113                                          call    delay1_4ms
  1114                                          call    delay1_4ms
  1115                                          call    delay1_4ms
  1116                                          call    delay1_4ms
  1117                                  	pop	cx
  1118                                  	loop	_100ms	
  1119                                  	
  1120                                    	mov     dx, [NAMBAR]
  1121                                    	add     dx, CODEC_MASTER_VOL_REG        ;02h 
  1122                                    	xor     ax, ax ; ; volume attenuation = 0 (max. volume)
  1123                                    	out     dx, ax
  1124                                   
  1125                                    	mov     dx, [NAMBAR]
  1126                                    	add     dx, CODEC_MASTER_MONO_VOL_REG   ;06h 
  1127                                    	;xor    ax, ax
  1128                                    	out     dx, ax
  1129                                  
  1130                                    	mov     dx, [NAMBAR]
  1131                                    	add     dx, CODEC_PCBEEP_VOL_REG        ;0Ah 
  1132                                    	;xor    ax, ax
  1133                                    	out     dx, ax
  1134                                  
  1135                                    	mov     dx, [NAMBAR]
  1136                                    	add     dx, CODEC_PCM_OUT_REG		;18h 
  1137                                    	;xor    ax, ax
  1138                                    	out     dx, ax
  1139                                  
  1140                                          call    delay1_4ms
  1141                                          call    delay1_4ms
  1142                                          call    delay1_4ms
  1143                                          call    delay1_4ms
  1144                                  
  1145                                          retn
  1146                                  
  1147                                  %else
  1148                                  	; 12/05/2024
  1149                                  	; 08/05/2024
  1150                                  	; (ac97_vra.asm, 19/11/2023, Erdogan Tan, playwav3.asm) 
  1151                                  codecConfig:
  1152                                  	; 02/12/2023
  1153                                  	; 26/11/2023
  1154                                  	; 21/11/2023
  1155                                  	; 20/11/2023
  1156                                  	; 19/11/2023 (TRDOS 386 v2.0.7)
  1157                                  	; 15/11/2023
  1158                                  	; 04/11/2023
  1159                                  	; 17/02/2017 
  1160                                  	; 07/11/2016 (Erdogan Tan)
  1161                                  	;PORT_NABM_GLB_CTRL_STAT equ 60h
  1162                                  
  1163                                  	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
  1164                                   	; 'AC97_DEF.H'
  1165                                  	;AC97_EXTENDED_STATUS equ 002Ah
  1166                                  	AC97_EA_SPDIF	equ 0002h
  1167                                  	AC97_EA_VRA	equ 0001h
  1168                                  	; 04/11/2023
  1169                                  	ICH_PO_CR_RESET equ 0002h  ; reset codec
  1170                                  	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
  1171                                  	ICH_PCM_246_MASK equ 300000h ; 6 channels
  1172                                  
  1173                                  	; 08/05/2024
  1174                                  	; 11/11/2023
  1175                                  	CTRL_ST_CREADY	equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
  1176                                  	CODEC_REG_POWERDOWN equ	26h
  1177                                  
  1178                                  	; 04/11/2023
  1179                                  init_ac97_controller:
  1180 00000264 66A1[9A0F]              	mov	eax, [bus_dev_fn]
  1181 00000268 B004                    	mov	al, PCI_CMD_REG
  1182 0000026A E828FF                  	call	pciRegRead16		; read PCI command register
  1183 0000026D 80CA05                  	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
  1184 00000270 E894FF                  	call	pciRegWrite16
  1185                                  
  1186                                  ; 02/12/2023
  1187                                  	;call	delay_100ms ; 29/05/2017
  1188                                  
  1189                                  	; 02/12/2023
  1190 00000273 E81F09                  	call	delay1_4ms
  1191 00000276 E81C09                  	call	delay1_4ms
  1192 00000279 E81909                  	call	delay1_4ms
  1193 0000027C E81609                  	call	delay1_4ms
  1194                                  
  1195                                  init_ac97_codec:
  1196                                  	; 18/11/2023
  1197 0000027F BD2800                  	mov	bp, 40
  1198                                  _initc_1:
  1199                                  	; 11/11/2023
  1200                                  	; (TRDOS 386 v2.0.5, 'audio.s')
  1201 00000282 BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1202 00000285 0316[860F]              	add	dx, [NABMBAR]
  1203 00000289 66ED                    	in	eax, dx
  1204                                  
  1205                                  	; 02/12/2023
  1206 0000028B E80709                  	call	delay1_4ms
  1207                                  
  1208                                  	; ?
  1209                                  	;; 15/11/2023
  1210                                  	;;mov	cx, 40
  1211                                  	;mov	bp, 40 ; 18/11/2023
  1212                                  ;_initc_1:
  1213 0000028E BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1214 00000291 0316[860F]              	add	dx, [NABMBAR]
  1215 00000295 66ED                    	in	eax, dx
  1216                                  
  1217                                  	; 02/12/2023
  1218 00000297 E8FB08                  	call	delay1_4ms
  1219                                  
  1220 0000029A 6683F8FF                	cmp	eax, 0FFFFFFFFh ; -1
  1221                                  	;je	short init_ac97_codec_err1
  1222                                  	; 15/11/2023
  1223 0000029E 7508                    	jne	short _initc_3
  1224                                  _initc_2:
  1225                                  	;dec	cx
  1226 000002A0 4D                      	dec	bp	; 18/11/2023
  1227                                  	;jz	short init_ac97_codec_err1
  1228                                  	; 19/11/2023
  1229 000002A1 7412                    	jz	short _ac97_codec_ready
  1230                                  
  1231 000002A3 E84501                  	call	delay_100ms
  1232 000002A6 EBDA                    	jmp	short _initc_1
  1233                                  _initc_3:
  1234 000002A8 66A900030010            	test	eax, CTRL_ST_CREADY
  1235 000002AE 7505                    	jnz	short _ac97_codec_ready
  1236                                  
  1237 000002B0 E8B800                  	call	reset_ac97_codec
  1238                                  	; 11/11/2023
  1239                                  	;jc	short init_ac97_codec_err2
  1240                                  	; 15/11/2023
  1241                                  	;jc	short _initc_2
  1242                                  	; 26/11/2023
  1243 000002B3 EBEB                    	jmp	short _initc_2
  1244                                  
  1245                                  _ac97_codec_ready:
  1246 000002B5 8B16[840F]              	mov	dx, [NAMBAR]
  1247                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  1248 000002B9 EF                      	out	dx, ax
  1249                                  
  1250 000002BA E82E01                  	call	delay_100ms
  1251                                  
  1252                                  	; 19/11/2023
  1253 000002BD 09ED                    	or	bp, bp
  1254 000002BF 751C                    	jnz	short _ac97_codec_init_ok
  1255                                  
  1256 000002C1 6631C0                  	xor	eax, eax ; 0
  1257 000002C4 8B16[840F]              	mov	dx, [NAMBAR]
  1258 000002C8 83C226                  	add	dx, CODEC_REG_POWERDOWN
  1259 000002CB EF                      	out	dx, ax
  1260                                  	
  1261                                  	; 19/11/2023
  1262                                  	; wait for 1 second
  1263                                  	;mov	ecx, 1000 ; 1000*4*0.25ms = 1s
  1264 000002CC B90A00                  	mov	cx, 10
  1265                                  _ac97_codec_rloop:
  1266                                  	;call	delay1_4ms
  1267                                  	;call	delay1_4ms
  1268                                  	;call	delay1_4ms
  1269                                  	;call	delay1_4ms
  1270 000002CF E81901                  	call	delay_100ms
  1271                                  	;mov	dx, [NAMBAR]
  1272                                  	;add	dx, CODEC_REG_POWERDOWN
  1273 000002D2 ED                      	in	ax, dx	
  1274 000002D3 83E00F                  	and	ax, 0Fh
  1275 000002D6 3C0F                    	cmp	al, 0Fh
  1276 000002D8 7403                    	je	short _ac97_codec_init_ok
  1277 000002DA E2F3                    	loop	_ac97_codec_rloop 
  1278                                  
  1279                                  	; 12/05/2024
  1280                                  	; cf = 1
  1281                                  init_ac97_codec_err1:
  1282                                  	;stc	; 12/05/2024
  1283                                  init_ac97_codec_err2:
  1284 000002DC C3                      	retn
  1285                                  
  1286                                  _ac97_codec_init_ok:
  1287                                          ; 11/11/2023
  1288                                  	;mov	al, 2 ; force set 16-bit 2-channel PCM
  1289                                  	;mov	dx, GLOB_CNT_REG ; 2Ch
  1290                                  	;add	dx, [NABMBAR]
  1291                                  	;out	dx, eax
  1292                                  
  1293                                  	;;call	delay1_4ms
  1294                                  
  1295 000002DD E85600                  	call 	reset_ac97_controller
  1296                                  
  1297                                  	; 11/11/2023
  1298 000002E0 E8B208                  	call	delay1_4ms
  1299                                  	; 21/11/2023 - temporary
  1300 000002E3 E80501                  	call	delay_100ms
  1301                                  
  1302                                  	;call 	setup_ac97_codec
  1303                                  
  1304                                  setup_ac97_codec:
  1305                                  	; 08/05/2028
  1306                                  	; [sample_rate] = 22050
  1307                                  	; 12/11/2023
  1308                                  	;cmp	word [sample_rate], 48000
  1309                                  	;je	short skip_rate
  1310                                  
  1311                                  ; 11/11/2023
  1312                                  ; 05/11/2023
  1313                                  ;%if 1
  1314                                  	AC97_EA_VRA equ BIT0 ; 11/11/2023
  1315                                  
  1316                                  	; 11/11/2023
  1317 000002E6 8B16[840F]              	mov    	dx, [NAMBAR]               	
  1318 000002EA 83C22A                  	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah  	  
  1319 000002ED ED                      	in     	ax, dx
  1320                                  
  1321                                  	; 02/12/2023
  1322 000002EE E8A408                  	call	delay1_4ms
  1323                                  
  1324 000002F1 24FD                    	and	al, ~BIT1 ; Clear DRA
  1325 000002F3 0C01                    	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
  1326 000002F5 EF                      	out	dx, ax			; Enable variable rate audio
  1327                                  	
  1328 000002F6 B90A00                  	mov	cx, 10
  1329                                  check_vra:
  1330 000002F9 E8EF00                  	call	delay_100ms
  1331                                  
  1332                                  	; 11/11/2023
  1333 000002FC ED                      	in	ax, dx
  1334 000002FD A801                    	test	al, AC97_EA_VRA ; 1
  1335 000002FF 750A                    	jnz	short set_rate
  1336                                  
  1337                                  	; 11/11/2023
  1338 00000301 E2F6                    	loop	check_vra
  1339                                  
  1340                                  	; 13/11/2023
  1341                                  	;mov	byte [VRA], 0
  1342                                  	; 08/05/2024
  1343 00000303 C706[E454]80BB          	mov	word [sample_rate], 48000
  1344 00000309 EB0E                    	jmp	short skip_rate	
  1345                                  
  1346                                  	; 12/11/2023
  1347                                  	;pop	ax ; discard return address to the caller
  1348                                  	;mov	dx, msg_no_vra
  1349                                  	;jmp	vra_err
  1350                                  
  1351                                  set_rate:
  1352 0000030B A1[E454]                	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
  1353                                  	; 08/05/2024
  1354                                  	; ax = 22050 (Hz)
  1355                                  
  1356 0000030E 8B16[840F]              	mov    	dx, [NAMBAR]               	
  1357 00000312 83C22C                  	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
  1358 00000315 EF                      	out	dx, ax 			; PCM Front/Center Output Sample Rate
  1359                                  
  1360 00000316 E8D200                  	call	delay_100ms
  1361                                  
  1362                                  	; 12/11/2023
  1363                                  skip_rate:
  1364                                  	; 11/11/2023 (temporary)
  1365                                  
  1366                                  	;mov   	dx, [NAMBAR]               	
  1367                                  	;add   	dx, CODEC_PCM_SURND_DACRATE_REG	; 2Eh  	  
  1368                                  	;out	dx, ax 			; PCM Surround Output Sample Rate
  1369                                  
  1370                                  	;call	delay_100ms
  1371                                  
  1372                                  	;mov   	dx, [NAMBAR]               	
  1373                                  	;add   	dx, CODEC_PCM_LFE_DACRATE_REG	; 30h  	  
  1374                                  	;out	dx, ax 			; PCM LFE Output Sample Rate
  1375                                  
  1376                                  	;call	delay_100ms
  1377                                  
  1378                                  	; 05/11/2023 (temporary)
  1379                                  	;mov	dx, [NAMBAR]               	
  1380                                  	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
  1381                                  	;out	dx, ax 			; PCM Input Sample Rate
  1382                                  	;
  1383                                  	;call	delay_100ms
  1384                                  
  1385 00000319 B80202                  	mov	ax, 0202h
  1386 0000031C A2[A30F]                	mov	[volume], al ; 29
  1387 0000031F 8B16[840F]              	mov     dx, [NAMBAR]
  1388 00000323 83C202                    	add     dx, CODEC_MASTER_VOL_REG	;02h 
  1389 00000326 EF                      	out     dx, ax
  1390                                  
  1391                                  	; 11/11/2023
  1392                                          ;call	delay1_4ms
  1393                                          ;call	delay1_4ms
  1394                                          ;call	delay1_4ms
  1395                                          ;call	delay1_4ms
  1396                                   	;
  1397                                    	;mov	dx, [NAMBAR]
  1398                                    	;add	dx, CODEC_MASTER_MONO_VOL_REG	;06h 
  1399                                    	;out	dx, ax
  1400                                  
  1401                                  	; 11/11/2023
  1402                                          ;call	delay1_4ms
  1403                                          ;call	delay1_4ms
  1404                                          ;call	delay1_4ms
  1405                                          ;call	delay1_4ms
  1406                                  	;
  1407                                  	;mov	ax, 02h
  1408                                    	;mov	dx, [NAMBAR]
  1409                                    	;add	dx, CODEC_PCBEEP_VOL_REG	;0Ah 
  1410                                    	;out	dx, ax
  1411                                  
  1412                                  	; 20/11/2023
  1413                                          ;call	delay1_4ms
  1414                                          ;call	delay1_4ms
  1415                                          ;call	delay1_4ms
  1416                                          ;call	delay1_4ms
  1417                                  	; 21/11/2023 temporary
  1418 00000327 E8C100                  	call	delay_100ms
  1419                                  
  1420                                  	;mov	ax, 0202h
  1421 0000032A 8B16[840F]                	mov     dx, [NAMBAR]
  1422 0000032E 83C218                    	add     dx, CODEC_PCM_OUT_REG		;18h 
  1423 00000331 EF                        	out     dx, ax
  1424                                  
  1425                                  	; 20/11/2023
  1426                                          ;call	delay1_4ms
  1427                                          ;call	delay1_4ms
  1428                                          ;call	delay1_4ms
  1429                                          ;call	delay1_4ms
  1430                                  	; 21/11/2023 - temporary
  1431 00000332 E8B600                  	call	delay_100ms
  1432                                  
  1433                                  	; 11/11/2023
  1434                                  	;mov	ax, 8008h ; Mute
  1435                                    	;mov	dx, [NAMBAR]
  1436                                  	;add	dx, CODEC_PHONE_VOL_REG		;0Ch
  1437                                  	;			 ; AC97_PHONE_VOL ; TAD Input (Mono)
  1438                                    	;out	dx, ax
  1439                                  	;
  1440                                          ;call	delay1_4ms
  1441                                          ;call	delay1_4ms
  1442                                          ;call	delay1_4ms
  1443                                  	;call	delay1_4ms
  1444                                  
  1445                                  	;mov	ax, 0808h
  1446                                  	;mov	dx, [NAMBAR]
  1447                                  	;add	dx, CODEC_LINE_IN_VOL_REG ;10h ; Line Input (Stereo)
  1448                                  	;out	dx, ax
  1449                                  	;
  1450                                          ;call	delay1_4ms
  1451                                          ;call	delay1_4ms
  1452                                          ;call	delay1_4ms
  1453                                  	;call	delay1_4ms
  1454                                  
  1455                                    	;mov	dx, [NAMBAR]
  1456                                          ;add	dx, CODEC_CD_VOL_REG ;12h ; CD Input (Stereo)
  1457                                    	;out	dx, ax
  1458                                  	;
  1459                                    	;mov	dx, [NAMBAR]
  1460                                          ;add	dx, CODEC_AUX_VOL_REG ;16h ; Aux Input (Stereo)
  1461                                    	;out	dx, ax
  1462                                  	;
  1463                                          ;call	delay1_4ms
  1464                                          ;call	delay1_4ms
  1465                                          ;call	delay1_4ms
  1466                                  	;call	delay1_4ms
  1467                                  
  1468                                  ;detect_ac97_codec:
  1469 00000335 C3                              retn
  1470                                  
  1471                                  reset_ac97_controller:
  1472                                  	; 11/11/2023
  1473                                  	; 10/06/2017
  1474                                  	; 29/05/2017
  1475                                  	; 28/05/2017
  1476                                  	; reset AC97 audio controller registers
  1477 00000336 31C0                    	xor     ax, ax
  1478 00000338 BA0B00                          mov	dx, PI_CR_REG
  1479 0000033B 0316[860F]              	add	dx, [NABMBAR]
  1480 0000033F EE                      	out     dx, al
  1481                                  
  1482 00000340 BA1B00                          mov     dx, PO_CR_REG
  1483 00000343 0316[860F]              	add	dx, [NABMBAR]
  1484 00000347 EE                      	out     dx, al
  1485                                  
  1486 00000348 BA2B00                          mov     dx, MC_CR_REG
  1487 0000034B 0316[860F]              	add	dx, [NABMBAR]
  1488 0000034F EE                      	out     dx, al
  1489                                  
  1490 00000350 B002                            mov     al, RR
  1491 00000352 BA0B00                          mov     dx, PI_CR_REG
  1492 00000355 0316[860F]              	add	dx, [NABMBAR]
  1493 00000359 EE                      	out     dx, al
  1494                                  
  1495 0000035A BA1B00                          mov     dx, PO_CR_REG
  1496 0000035D 0316[860F]              	add	dx, [NABMBAR]
  1497 00000361 EE                      	out     dx, al
  1498                                  
  1499 00000362 BA2B00                          mov     dx, MC_CR_REG
  1500 00000365 0316[860F]              	add	dx, [NABMBAR]
  1501 00000369 EE                      	out     dx, al
  1502                                  
  1503 0000036A C3                      	retn
  1504                                  
  1505                                  reset_ac97_codec:
  1506                                  	; 11/11/2023
  1507                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1508 0000036B BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1509 0000036E 0316[860F]              	add	dx, [NABMBAR]
  1510 00000372 66ED                    	in	eax, dx
  1511                                  
  1512                                  	;test	eax, 2
  1513                                  	; 06/08/2022
  1514 00000374 A802                    	test	al, 2
  1515 00000376 7405                    	jz	short _r_ac97codec_cold	
  1516                                  
  1517 00000378 E80E00                  	call	warm_ac97codec_reset
  1518 0000037B 7306                    	jnc	short _r_ac97codec_ok
  1519                                  _r_ac97codec_cold:
  1520 0000037D E83400                          call    cold_ac97codec_reset
  1521 00000380 7301                            jnc     short _r_ac97codec_ok
  1522                                  	
  1523                                  	; 16/04/2017
  1524                                          ;xor	eax, eax	; timeout error
  1525                                         	;stc
  1526 00000382 C3                      	retn
  1527                                  
  1528                                  _r_ac97codec_ok:
  1529 00000383 6631C0                          xor     eax, eax
  1530                                          ;mov	al, VIA_ACLINK_C00_READY ; 1
  1531 00000386 FEC0                            inc	al
  1532 00000388 C3                      	retn
  1533                                  
  1534                                  warm_ac97codec_reset:
  1535                                  	; 11/11/2023
  1536                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  1537                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1538 00000389 66B806000000            	mov	eax, 6
  1539 0000038F BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1540 00000392 0316[860F]              	add	dx, [NABMBAR]
  1541 00000396 66EF                    	out	dx, eax
  1542                                  
  1543 00000398 B90A00                  	mov	cx, 10	; total 1s
  1544                                  _warm_ac97c_rst_wait:
  1545 0000039B E84D00                  	call	delay_100ms
  1546                                  
  1547 0000039E BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1548 000003A1 0316[860F]              	add	dx, [NABMBAR]
  1549 000003A5 66ED                    	in	eax, dx
  1550                                  
  1551 000003A7 66A900030010            	test	eax, CTRL_ST_CREADY
  1552 000003AD 7504                    	jnz	short _warm_ac97c_rst_ok
  1553                                  
  1554 000003AF 49                              dec     cx
  1555 000003B0 75E9                            jnz     short _warm_ac97c_rst_wait
  1556                                  
  1557                                  _warm_ac97c_rst_fail:
  1558 000003B2 F9                              stc
  1559                                  _warm_ac97c_rst_ok:
  1560 000003B3 C3                      	retn
  1561                                  
  1562                                  cold_ac97codec_reset:
  1563                                  	; 11/11/2023
  1564                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  1565                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1566 000003B4 66B802000000                    mov	eax, 2
  1567 000003BA BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1568 000003BD 0316[860F]              	add	dx, [NABMBAR]
  1569 000003C1 66EF                    	out	dx, eax
  1570                                  
  1571 000003C3 E82500                  	call	delay_100ms 	; wait 100 ms
  1572 000003C6 E82200                  	call	delay_100ms 	; wait 100 ms
  1573 000003C9 E81F00                  	call	delay_100ms 	; wait 100 ms
  1574 000003CC E81C00                  	call	delay_100ms 	; wait 100 ms
  1575                                  
  1576 000003CF B91000                  	mov	cx, 16	; total 20*100 ms = 2s
  1577                                  
  1578                                  _cold_ac97c_rst_wait:
  1579 000003D2 BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1580 000003D5 0316[860F]              	add	dx, [NABMBAR]
  1581 000003D9 66ED                    	in	eax, dx
  1582                                  
  1583 000003DB 66A900030010            	test	eax, CTRL_ST_CREADY
  1584 000003E1 7507                    	jnz	short _cold_ac97c_rst_ok
  1585                                  
  1586 000003E3 E80500                  	call	delay_100ms
  1587                                  
  1588 000003E6 49                              dec     cx
  1589 000003E7 75E9                            jnz     short _cold_ac97c_rst_wait
  1590                                  
  1591                                  _cold_ac97c_rst_fail:
  1592 000003E9 F9                              stc
  1593                                  _cold_ac97c_rst_ok:
  1594 000003EA C3                      	retn
  1595                                  
  1596                                  delay_100ms:
  1597                                  	; 11/11/2023
  1598                                  	; 29/05/2017
  1599                                  	; 24/03/2017 ('codec.asm')
  1600                                  	; wait 100 ms
  1601 000003EB 51                      	push	cx
  1602 000003EC B99001                  	mov	cx, 400  ; 400*0.25ms
  1603                                  _delay_x_ms:
  1604 000003EF E8A307                  	call	delay1_4ms
  1605 000003F2 E2FB                            loop	_delay_x_ms
  1606 000003F4 59                      	pop	cx
  1607 000003F5 C3                      	retn
  1608                                  
  1609                                  %endif
  1610                                  
  1611                                  ;=============================================================================
  1612                                  ;               ICH_WAV.ASM
  1613                                  ;=============================================================================
  1614                                  
  1615                                  ; DOS based .WAV player using AC'97 and codec interface.
  1616                                  ; ---------------------------------------------------------------
  1617                                  ; NASM version: Erdogan Tan (29/11/2016)
  1618                                  ; Last Update: 17/02/2017 (by Erdogan Tan)
  1619                                  
  1620                                  ; ICHWAV.ASM
  1621                                  ; PLAYMOD.ASM
  1622                                  ; player internal variables and other equates.
  1623                                  BUFFERSIZE	equ	2048*4		; 8K half buffer size. 18/02/2017
  1624                                  ENDOFFILE	equ	BIT0		; flag for knowing end of file
  1625                                  
  1626                                  ;===========================================================================
  1627                                  ; entry: none.  File is already open and [filehandle] filled.
  1628                                  ; exit:  not until the song is finished or the user aborts.
  1629                                  ;
  1630                                  ; 18/02/2017
  1631                                  ModPlay: ; 13/02/2017  ; ModPlay Polling!
  1632                                  	;cld
  1633                                  	; clear (half) buffer 2
  1634                                         	;mov	di, [DMA_BUFFER2]
  1635                                  	;sub	ax, ax
  1636                                  	;mov	cx, (BUFFERSIZE/2)
  1637                                  	;rep	stosw
  1638                                  	
  1639                                         ; load 2048 bytes into buffer 1
  1640 000003F6 8B36[940F]              	mov	si, [DMA_BUFFER1]
  1641                                  	; 11/05/2024
  1642                                  	;mov	cx, BUFFERSIZE
  1643                                  	;push	ds ; segment
  1644                                  	;push	si ; offset
  1645                                  	;push	cx ; count
  1646 000003FA E89506                  	call    GetSamples_ICH ; 18/02/2017
  1647                                  
  1648                                         ; load 2048 bytes into buffer  2
  1649 000003FD 8B36[960F]              	mov	si, [DMA_BUFFER2]
  1650                                  	; 11/05/2024
  1651                                  	;mov	cx, BUFFERSIZE
  1652                                  	;push	ds ; segment
  1653                                  	;push	si ; offset
  1654                                  	;push	cx ; count
  1655 00000401 E88E06                  	call	GetSamples_ICH ; 18/02/2017
  1656                                  
  1657                                  ; register reset the DMA engine. This may cause a pop noise on the output
  1658                                  ; lines when the device is reset. Prolly a better idea to mute output, then
  1659                                  ; reset.
  1660                                  
  1661                                  	; 08/05/2024
  1662                                          ;mov    dx, [NABMBAR]
  1663                                          ;add    dx, PO_CR_REG		; set pointer to Ctrl reg
  1664                                          ;mov    al, RR			; set reset
  1665                                  	;out    dx, al			; self clearing bit
  1666                                  
  1667                                  ; write last valid index to 31 to start with.
  1668                                  ; The Last Valid Index register tells the DMA engine when to stop playing.
  1669                                  ; 
  1670                                  ; As we progress through the song we change the last valid index to always be
  1671                                  ; something other than the index we're currently playing.  
  1672                                  ;
  1673                                          ;;mov   al, 1
  1674                                          ;mov	al, 31
  1675                                  	;call   setLastValidIndex
  1676                                  
  1677                                  ; create Buffer Descriptor List
  1678                                  ;
  1679                                  ; A buffer descriptor list is a list of pointers and control bits that the
  1680                                  ; DMA engine uses to know where to get the .wav data and how to play it.
  1681                                  ;
  1682                                  ; I set it up to use only 2 buffers of .wav data, and whenever 1 buffer is
  1683                                  ; playing, I refresh the other one with good data.
  1684                                  ;
  1685                                  ;
  1686                                  ; For the control bits, you can specify that the DMA engine fire an interrupt
  1687                                  ; after a buffer has been processed, but I poll the current index register
  1688                                  ; to know when it's safe to update the other buffer.
  1689                                  ;
  1690                                  ; I set the BUP bit, which tells the DMA engine to just play 0's (silence)
  1691                                  ; if it ever runs out of data to play. Good for safety.
  1692                                  ;
  1693                                  	; 14/02/2017
  1694 00000404 8B3E[920F]                      mov     di, [BDL_BUFFER]		; get BDL address
  1695 00000408 B91000                          mov     cx, 32 / 2                      ; make 32 entries in BDL
  1696 0000040B 6631D2                  	xor	edx, edx
  1697 0000040E 8CDA                    	mov	dx, ds
  1698 00000410 66C1E204                	shl	edx, 4 ; segment*16 (linear/physical address of the segment)
  1699                                  _0:
  1700                                  
  1701                                  ; set buffer descriptor 0 to start of data file in memory
  1702                                  	; 14/02/2017
  1703 00000414 660FB706[940F]                  movzx   eax, word [DMA_BUFFER1]
  1704 0000041A 6601D0                  	add	eax, edx ; linear/physical address of the buffer (seg*16+off)
  1705 0000041D 66AB                            stosd					; store dmabuffer1 address
  1706                                  
  1707                                  ;
  1708                                  ; set length to 32k samples. 1 sample is 16bits or 2bytes.
  1709                                  ; Set control (bits 31:16) to BUP, bits 15:0=number of samples.
  1710                                  ; 
  1711                                  
  1712                                  ; 17/02/2017 (Erdogan Tan)
  1713                                  ; Intel 82801AA (ICH) & Intel 82801AB (ICH0) I/O Controller Hub AC 97
  1714                                  ; Programmers Reference Manual
  1715                                  
  1716                                  ; 2.2.1 Buffer Descriptor List  (on Page 13)
  1717                                  	;
  1718                                  	;  Generic Form of Buffer Descriptor
  1719                                  	;  ---------------------------------
  1720                                  	;  63   62    61-48    47-32   31-0
  1721                                  	;  ---  ---  --------  ------- -----
  1722                                  	;  IOC  BUP -reserved- Buffer  Buffer
  1723                                  	;		      Length   Pointer
  1724                                  	;		      [15:0]   [31:0]
  1725                                  	;
  1726                                  	;  IOC:	Interrupt On Completion. 
  1727                                  	;	1 = Enabled. 
  1728                                  	;	    When this is set, it means that the controller should
  1729                                  	;	    issue an interrupt upon completion of this buffer.
  1730                                  	;	    It should also set the IOC bit in the status register
  1731                                  	;	0 = Disabled	
  1732                                  	;
  1733                                  	;  BUP: Buffer Underrun Policy.
  1734                                  	;       0 = When this buffer is complete,
  1735                                  	;	    if the next buffer is not yet ready 
  1736                                  	;	    (i.e., the last valid buffer has been processed),
  1737                                  	;	    then continue to transmit the last valid sample.
  1738                                  	;	1 = When this buffer is complete,
  1739                                  	;     	    if this is the last valid buffer, transmit zeros after
  1740                                  	;	    this buffer has been processed completely.
  1741                                  	;	    This bit typically is set only if this is the last 
  1742                                  	;	    buffer in the current stream.
  1743                                  	;
  1744                                  	; [31:0]: Buffer pointer. This field points to the location of
  1745                                  	;	  the data buffer. Since samples can be as wide as one
  1746                                  	;	  word, the buffer must be aligned with word boundaries,
  1747                                  	;	  to prevent samples from straddling DWord boundaries.
  1748                                  	;
  1749                                  	; [15:0]: Buffer Length: This is the length of the data buffer,
  1750                                  	;	  in number of samples. The controller uses this data
  1751                                  	;	  to determine the length of the buffer, in bytes.
  1752                                  	;	  "0" indicates no sample to process.
  1753                                  
  1754                                  ; ICH2AC97.INC
  1755                                  
  1756                                  ;	IOC	equ     BIT31   ; Fire an interrupt whenever this
  1757                                  				; buffer is complete.
  1758                                  
  1759                                  ;	BUP	equ     BIT30   ; Buffer Underrun Policy.
  1760                                  				; if this buffer is the last buffer
  1761                                  				; in a playback, fill the remaining
  1762                                  				; samples with 0 (silence) or not.
  1763                                  				; It's a good idea to set this to 1
  1764                                  				; for the last buffer in playback,
  1765                                  				; otherwise you're likely to get a lot
  1766                                  				; of noise at the end of the sound.
  1767                                  ;
  1768                                  ; Bits 15:0 contain the length of the buffer, in number of samples, which
  1769                                  ; are 16 bits each, coupled in left and right pairs, or 32bits each.
  1770                                  ; Luckily for us, that's the same format as .wav files.
  1771                                  ;
  1772                                  ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
  1773                                  ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
  1774                                  ;
  1775                                  ; A value of 0 in these bits means play no samples.
  1776                                  ;
  1777                                  	; 08/12/2016 - Erdogan Tan
  1778                                  	;mov	eax, BUFFERSIZE
  1779                                  	;or	eax, IOC + BUP
  1780                                  	; 12/05/2024
  1781 0000041F 66B800100000            	mov	eax, BUFFERSIZE/2
  1782 00000425 660D00000040            	or	eax, BUP ; (tuneloop without interrupt)
  1783 0000042B 66AB                    	stosd
  1784                                  
  1785                                  ; 2nd buffer:
  1786                                  	; 14/02/2017
  1787 0000042D 660FB706[960F]                  movzx   eax, word [DMA_BUFFER2]
  1788 00000433 6601D0                  	add	eax, edx ; linear/physical address of the buffer (seg*16+off)
  1789 00000436 66AB                            stosd					; store dmabuffer2 address
  1790                                  
  1791                                  ; set length to 64k (32k of two 16 bit samples)
  1792                                  ; Set control (bits 31:16) to BUP, bits 15:0=number of samples
  1793                                  ; 
  1794                                  	; 08/12/2016 - Erdogan Tan
  1795                                  	;mov	eax, BUFFERSIZE
  1796                                  	;or	eax, IOC + BUP
  1797                                  	; 12/05/2024
  1798 00000438 66B800100000            	mov	eax, BUFFERSIZE/2
  1799                                  	; 12/05/2024
  1800 0000043E 660D00000040            	or	eax, BUP ; (tuneloop without interrupt)
  1801 00000444 66AB                    	stosd
  1802 00000446 E2CC                            loop    _0
  1803                                  
  1804                                  ;
  1805                                  ; tell the DMA engine where to find our list of Buffer Descriptors.
  1806                                  ; this 32bit value is a flat mode memory offset (ie no segment:offset)
  1807                                  ;
  1808                                  ; write NABMBAR+10h with offset of buffer descriptor list
  1809                                  ;
  1810 00000448 660FB706[920F]                  movzx   eax, word [BDL_BUFFER]
  1811                                  	; 14/02/2017
  1812 0000044E 6601D0                  	add	eax, edx ; linear/physical address of the BDL
  1813                                    	; 18/02/2017
  1814 00000451 8B16[860F]                      mov     dx, [NABMBAR]
  1815 00000455 83C210                          add     dx, PO_BDBAR_REG                ; set pointer to BDL
  1816 00000458 66EF                            out     dx, eax                         ; write to AC97 controller
  1817                                  
  1818                                  ;
  1819                                  ; All set.  Let's play some music.
  1820                                  ;
  1821                                  	; 08/12/2016
  1822                                  	; 07/10/2016
  1823                                          ;mov    al, 1
  1824 0000045A B01F                            mov	al, 31
  1825                                  	; 08/05/2024
  1826 0000045C A2[A20F]                	mov	[LVI], al ; 10/11/2023
  1827                                  	
  1828 0000045F E8C200                  	call    setLastValidIndex
  1829                                  
  1830 00000462 C606[8B0F]01            	mov	byte [tLoop], 1 ; 30/11/2016
  1831                                  
  1832                                  ; 12/05/2024 (tuneloop, without interrupt)
  1833                                  %if 0
  1834                                  	; 12/05/2024	
  1835                                  	; 17/02/2017
  1836                                          ;mov    dx, [NABMBAR]
  1837                                          ;add    dx, PO_CR_REG                   ; PCM out Control Register
  1838                                          ;mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
  1839                                  	;			; (LVBI interrupt will not be enabled)
  1840                                          ;out    dx, al                          ; Start bus master operation.
  1841                                  
  1842                                  ; while DMA engine is running, examine current index and wait until it hits 1
  1843                                  ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
  1844                                  ; 64k.  Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
  1845                                     
  1846                                  	; 18/02/2017
  1847                                  	; 14/02/2017
  1848                                  	; 13/02/2017
  1849                                  	; 08/12/2016
  1850                                  	; 28/11/2016
  1851                                  
  1852                                  	push	es
  1853                                  	mov	ax, 0A000h
  1854                                  	mov	es, ax
  1855                                  	;mov	bp, DmaBuffer ; 14/02/2017
  1856                                  p_loop:
  1857                                  	mov     ah, 1			; any key pressed?
  1858                                  	int     16h			; no, Loop.
  1859                                  	jz	short q_loop
  1860                                  
  1861                                  	mov     ah, 0			; flush key buffer...
  1862                                  	int     16h
  1863                                  p_return:
  1864                                  	mov	byte [tLoop], 0	; 13/02/2017
  1865                                  	pop	es
  1866                                  	retn
  1867                                  q_loop:
  1868                                  	; 10/05/2024
  1869                                  	xor	ax, ax
  1870                                  	xchg	al, [tBuff] ; AL = [tBuff], [tBuff] = 0
  1871                                  	cmp	al, 1
  1872                                  	ja	short r_loop
  1873                                  	jb	short ScopeLoop
  1874                                  	;
  1875                                       	mov	si, [DMA_BUFFER1] ; [tBuff]=1 (from tuneLoop)
  1876                                         	jmp	short s_loop 
  1877                                  r_loop:
  1878                                  	; 13/02/2017
  1879                                          mov     si, [DMA_BUFFER2] ; [tBuff]=2 (from tuneLoop)
  1880                                  s_loop:
  1881                                  	; 14/02/2017
  1882                                  	;mov	bp, si ; save current buffer addres in bp register
  1883                                  	; 11/05/2024
  1884                                  	;mov	cx, BUFFERSIZE ; 2048*4 byte
  1885                                  	;push	ds ; segment
  1886                                  	;push	si ; offset
  1887                                  	;push	cx ; count
  1888                                  	call    GetSamples_ICH ; 18/02/2017
  1889                                  	;
  1890                                  ScopeLoop:
  1891                                  	;mov    si, bp			; get current samples
  1892                                  	mov	si, MOD_BUFFER ; 18/02/2017
  1893                                  	xor     cx, cx			; to be drawed ...
  1894                                  	xor     dx, dx
  1895                                  DrawLoop:       
  1896                                  	mov     bx, dx			; (save Index)
  1897                                  	mov     di, [Scope+bx]		; get old SCOPE pixel address
  1898                                  	mov     byte [es:di], 0		; erase it!
  1899                                  	lodsb				; get a sample (8-bit)
  1900                                  	mov     bl, al			; calc new pixel address...
  1901                                  	xor     bh, bh
  1902                                  	shl     bx, 1
  1903                                  	mov     di, [RowOfs+bx]
  1904                                  	add     di, cx
  1905                                  	mov     bx, dx			; (restore Index)
  1906                                  	mov     [Scope+bx], di		; save new address...
  1907                                  	mov     byte [es:di], 10 ; 0Ah	; and DRAW.
  1908                                  	add     dx, 2			; the next pixel...
  1909                                  	inc     cx
  1910                                  	cmp     cx, 320			; 320 pixels drawed?
  1911                                  	jb      short DrawLoop
  1912                                  	jmp	short p_loop
  1913                                  
  1914                                  tuneLoop:
  1915                                  	; 11/05/2024
  1916                                  	; 11/11/2023
  1917                                  	; 10/11/2023
  1918                                  	; 18/02/2017
  1919                                  	; 08/12/2016
  1920                                  	; 28/11/2016 - Erdogan Tan
  1921                                  
  1922                                  	; 11/05/2024
  1923                                  	cmp	byte [tLoop], 1
  1924                                  	jb	short tL3
  1925                                  	
  1926                                  	call    getCurrentIndex
  1927                                  
  1928                                  	; 10/11/2023
  1929                                  	cmp	al, [LVI]
  1930                                  	jne	short tL1
  1931                                  
  1932                                  	dec	ax
  1933                                  	and	al, 1Fh 
  1934                                  	call	setLastValidIndex
  1935                                  	xchg	al, [LVI]
  1936                                  tL1:
  1937                                  	test	al, BIT0
  1938                                  	jz	short tL2
  1939                                  
  1940                                  	; 11/05/2024
  1941                                  	mov	byte [tBuff], 1
  1942                                  	retn
  1943                                  tL2:	
  1944                                  	mov	byte [tBuff], 2
  1945                                  tL3:
  1946                                  	retn
  1947                                  
  1948                                  ; returns AL = current index value
  1949                                  getCurrentIndex:
  1950                                  	;push	dx
  1951                                  	mov	dx, [NABMBAR]
  1952                                  	add	dx, PO_CIV_REG
  1953                                  	in	al, dx
  1954                                  	;pop	dx
  1955                                  	retn
  1956                                  
  1957                                  ;input AL = index # to stop on
  1958                                  setLastValidIndex:
  1959                                  	;push	dx
  1960                                  	mov	dx, [NABMBAR]
  1961                                  	add	dx, PO_LVI_REG
  1962                                          out     dx, al
  1963                                  	;pop	dx
  1964                                  	retn
  1965                                  
  1966                                  %else
  1967                                  	; 12/05/2024
  1968                                  	; 17/02/2017
  1969 00000467 8B16[860F]                      mov     dx, [NABMBAR]
  1970 0000046B 83C21B                          add     dx, PO_CR_REG		; PCM out Control Register
  1971                                          ;mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
  1972                                  	;			; (LVBI interrupt will not be enabled)
  1973                                  	; 06/11/2023 (TUNELOOP version, without interrupt)
  1974 0000046E B001                    	mov	al, RPBM
  1975 00000470 EE                      	out     dx, al			; Start bus master operation.
  1976                                  
  1977 00000471 06                      	push	es
  1978 00000472 B800A0                  	mov	ax, 0A000h
  1979 00000475 8EC0                    	mov	es, ax
  1980                                  
  1981                                  	; 12/05/2024
  1982                                  ;p_loop:
  1983                                  ;	call	tuneLoop
  1984                                  ;	cmp	byte [tLoop], 0
  1985                                  ;	ja	short p_loop
  1986                                  ;	pop	es
  1987                                  ;	retn
  1988                                  
  1989                                  p_loop:
  1990 00000477 B401                    	mov     ah, 1			; any key pressed?
  1991                                  	;mov	ah, 11h
  1992 00000479 CD16                    	int     16h			; no, Loop.
  1993 0000047B 743D                    	jz	short q_loop
  1994                                  
  1995 0000047D B400                    	mov	ah, 0
  1996                                  	;mov    ah, 10h			; flush key buffer...
  1997 0000047F CD16                    	int     16h
  1998                                  
  1999                                  	; 12/05/2024 (change PCM out volume)
  2000 00000481 3C2B                    	cmp	al, '+'
  2001 00000483 750B                    	jne	short p_1
  2002                                  	
  2003 00000485 A0[A30F]                	mov	al, [volume]
  2004 00000488 3C00                    	cmp	al, 0
  2005 0000048A 762E                    	jna	short q_loop
  2006 0000048C FEC8                    	dec	al
  2007 0000048E EB0D                    	jmp	short p_2
  2008                                  p_1:
  2009 00000490 3C2D                    	cmp	al, '-'
  2010 00000492 7524                    	jne	short p_return
  2011                                  
  2012 00000494 A0[A30F]                	mov	al, [volume]
  2013 00000497 3C1F                    	cmp	al, 31
  2014 00000499 731F                    	jnb	short q_loop	
  2015 0000049B FEC0                    	inc	al
  2016                                  p_2:
  2017 0000049D A2[A30F]                	mov	[volume], al
  2018 000004A0 88C4                    	mov	ah, al
  2019 000004A2 8B16[840F]              	mov     dx, [NAMBAR]
  2020                                    	;add    dx, CODEC_MASTER_VOL_REG
  2021 000004A6 83C218                  	add	dx, CODEC_PCM_OUT_REG
  2022 000004A9 EF                      	out     dx, ax
  2023                                  
  2024                                  	; 12/05/2024
  2025 000004AA E8E806                  	call    delay1_4ms
  2026 000004AD E8E506                          call    delay1_4ms
  2027 000004B0 E8E206                          call    delay1_4ms
  2028 000004B3 E8DF06                          call    delay1_4ms
  2029                                  
  2030 000004B6 EB02                    	jmp	short q_loop
  2031                                  
  2032                                  p_return:
  2033 000004B8 07                      	pop	es
  2034 000004B9 C3                      	retn
  2035                                  q_loop:
  2036                                  tuneLoop:
  2037                                  	; 12/05/2024
  2038                                  	; 18/11/2023 (ich_wav4.asm, Erdogan Tan)
  2039                                  tL1:
  2040 000004BA E85400                  	call    updateLVI	; /set LVI != CIV/
  2041                                  	;call   check4keyboardstop
  2042                                  	;jc	short _exit_
  2043                                  	;call   getCurrentIndex
  2044 000004BD A801                    	test	al, BIT0
  2045 000004BF 74F9                    	jz	short tL1	; loop if buffer 2 is not playing
  2046                                  
  2047 000004C1 8B36[940F]              	mov     si, [DMA_BUFFER1]
  2048 000004C5 E8CA05                  	call    GetSamples_ICH
  2049                                  
  2050 000004C8 E81300                  	call	ScopeLoop
  2051                                  tL2:
  2052 000004CB E84300                  	call    updateLVI
  2053                                  	;call   check4keyboardstop
  2054                                  	;jc	short _exit_
  2055                                  	;call   getCurrentIndex
  2056 000004CE A801                    	test	al, BIT0
  2057 000004D0 75F9                    	jnz	short tL2	; loop if buffer 1 is not playing
  2058                                  
  2059 000004D2 8B36[960F]              	mov     si, [DMA_BUFFER2]
  2060 000004D6 E8B905                  	call    GetSamples_ICH
  2061                                  
  2062 000004D9 E80200                  	call	ScopeLoop
  2063 000004DC EB99                    	jmp	short p_loop
  2064                                  
  2065                                  ScopeLoop:
  2066                                  	;mov    si, bp			; get current samples
  2067 000004DE BE[B2B3]                	mov	si, MOD_BUFFER ; 18/02/2017
  2068 000004E1 31C9                    	xor     cx, cx			; to be drawed ...
  2069 000004E3 31D2                    	xor     dx, dx
  2070                                  DrawLoop:       
  2071 000004E5 89D3                    	mov     bx, dx			; (save Index)
  2072 000004E7 8BBF[30AF]              	mov     di, [Scope+bx]		; get old SCOPE pixel address
  2073 000004EB 26C60500                	mov     byte [es:di], 0		; erase it!
  2074                                  	;lodsb				; get a sample (8-bit)
  2075                                  	; 12/05/2024
  2076 000004EF AD                      	lodsw
  2077 000004F0 88C3                    	mov     bl, al			; calc new pixel address...
  2078 000004F2 30FF                    	xor     bh, bh
  2079 000004F4 D1E3                    	shl     bx, 1
  2080 000004F6 8BBF[B0B1]              	mov     di, [RowOfs+bx]
  2081 000004FA 01CF                    	add     di, cx
  2082 000004FC 89D3                    	mov     bx, dx			; (restore Index)
  2083 000004FE 89BF[30AF]              	mov     [Scope+bx], di		; save new address...
  2084 00000502 26C6050A                	mov     byte [es:di], 10 ; 0Ah	; and DRAW.
  2085 00000506 83C202                  	add     dx, 2			; the next pixel...
  2086 00000509 41                      	inc     cx
  2087 0000050A 81F94001                	cmp     cx, 320			; 320 pixels drawed?
  2088 0000050E 72D5                    	jb      short DrawLoop
  2089 00000510 C3                      	retn
  2090                                  	
  2091                                  ;_exit_:
  2092                                  	;mov	byte [tLoop], 0
  2093                                  	;retn
  2094                                  
  2095                                  	; 12/05/2024
  2096                                  updateLVI:
  2097                                  	; 06/11/2023
  2098 00000511 8B16[860F]              	mov	dx, [NABMBAR]      		
  2099 00000515 83C214                  	add	dx, PO_CIV_REG
  2100                                  	; (Current Index Value and Last Valid Index value)
  2101 00000518 ED                      	in	ax, dx
  2102                                  
  2103 00000519 38E0                    	cmp	al, ah ; is current index = last index ?
  2104 0000051B 750F                    	jne	short uLVI_exit ; 12/05/2024
  2105                                  
  2106                                  	; 08/11/2023	
  2107 0000051D E80D00                  	call	getCurrentIndex
  2108                                  
  2109 00000520 FEC8                    	dec	al
  2110 00000522 241F                    	and	al, 1Fh
  2111                                  
  2112                                  ;input AL = index # to stop on
  2113                                  setLastValidIndex:
  2114                                  	; 08/11/2023
  2115                                  	;push	dx
  2116 00000524 8B16[860F]              	mov	dx, [NABMBAR]
  2117 00000528 83C215                  	add	dx, PO_LVI_REG
  2118 0000052B EE                              out     dx, al
  2119                                  	;pop	dx
  2120                                  uLVI_exit:	; 12/05/2024
  2121 0000052C C3                      	retn
  2122                                  
  2123                                  ; returns AL = current index value
  2124                                  getCurrentIndex:
  2125                                  	;push	dx
  2126 0000052D 8B16[860F]              	mov	dx, [NABMBAR]
  2127 00000531 83C214                  	add	dx, PO_CIV_REG
  2128 00000534 EC                      	in	al, dx
  2129                                  	;pop	dx
  2130 00000535 C3                      	retn
  2131                                  
  2132                                  	; 12/05/2024
  2133                                  check4keyboardstop:
  2134                                  	; 08/11/2023
  2135                                  	; 04/11/2023
  2136 00000536 B401                    	mov	ah, 1
  2137 00000538 CD16                    	int	16h
  2138 0000053A 7405                    	jz	short _cksr
  2139 0000053C 30E4                    	xor	ah, ah
  2140 0000053E CD16                    	int	16h
  2141 00000540 F9                      	stc
  2142                                  _cksr:
  2143 00000541 C3                      	retn
  2144                                  
  2145                                  %endif
  2146                                  
  2147                                  ;=============================================================================
  2148                                  ;               MODLOAD.ASM
  2149                                  ;=============================================================================
  2150                                  
  2151                                  ; Amiga Module Loader v0.1b by Carlos Hasan.
  2152                                  ;		July 10th, 1993.
  2153                                  
  2154                                  ; STRUCTURES
  2155                                  
  2156                                  struc ModSample
  2157 00000000 <res 16h>               .msName:	resb 22
  2158 00000016 ????                    .msLength:	resw 1
  2159 00000018 ??                      .msFinetune:	resb 1
  2160 00000019 ??                      .msVolume:	resb 1
  2161 0000001A ????                    .msRepeat:	resw 1
  2162 0000001C ????                    .msRepLen:	resw 1
  2163                                  .size:
  2164                                  endstruc
  2165                                  
  2166                                  struc ModHeader
  2167 00000000 <res 14h>               .mhName:	resb 20
  2168 00000014 <res 3A2h>              .mhSamples:	resb ModSample.size*31
  2169 000003B6 ??                      .mhOrderLen:	resb 1
  2170 000003B7 ??                      .mhReStart:	resb 1
  2171 000003B8 <res 80h>               .mhOrder:	resb 128
  2172 00000438 ????????                .mhSign:	resw 2
  2173                                  .size:	
  2174                                  endstruc
  2175                                  
  2176                                  struc ModInfoRec
  2177 00000000 ??                      .OrderLen:	resb 1
  2178 00000001 ??                      .ReStart:	resb 1
  2179 00000002 <res 80h>               .Order:		resb 128
  2180 00000082 ????????                .Patterns:	resd 1
  2181 00000086 <res 3Eh>               .SampOfs:	resw 31
  2182 000000C4 <res 3Eh>               .SampSeg:	resw 31
  2183 00000102 <res 3Eh>               .SampLen:	resw 31
  2184 00000140 <res 3Eh>               .SampRep:	resw 31
  2185 0000017E <res 3Eh>               .SampRepLen:	resw 31
  2186 000001BC <res 3Eh>               .SampVol:	resw 31
  2187                                  .size:	
  2188                                  endstruc
  2189                                  
  2190                                  ; CODE
  2191                                  
  2192                                  LoadModule:
  2193                                  		;es:di = filename
  2194                                  
  2195                                  		;[sp+4] = es
  2196                                  		;[sp+2] = di
  2197                                  
  2198                                  		FileName equ 4		
  2199                                  
  2200 00000542 55                      		push    bp
  2201 00000543 89E5                    		mov     bp, sp
  2202 00000545 60                      		pusha
  2203 00000546 1E                      		push    ds
  2204 00000547 06                      		push    es
  2205                                  
  2206 00000548 C706[A650]0100          		mov	word [ErrorInfo], 1
  2207                                  
  2208 0000054E E85101                  		call    ClearModInfo
  2209                                  OpenFile:       
  2210 00000551 1E                      		push    ds
  2211 00000552 B8003D                  		mov     ax, 3D00h
  2212 00000555 C55604                  		lds     dx, [bp+FileName]
  2213 00000558 CD21                    		int     21h
  2214 0000055A 1F                      		pop     ds
  2215 0000055B 0F823C01                		jc      Failed
  2216 0000055F A3[A450]                		mov     [FileHandle], ax
  2217                                  
  2218                                  ReadHeader:     
  2219 00000562 B8003F                  		mov     ax, 3F00h
  2220 00000565 8B1E[A450]              		mov     bx, [FileHandle]
  2221 00000569 B93C04                  		mov     cx, ModHeader.size
  2222                                  		;lea    dx, [Header]
  2223 0000056C BA[A850]                		mov	dx, Header
  2224 0000056F CD21                    		int     21h
  2225 00000571 0F821D01                		jc      CloseFile
  2226                                  CheckMK:        
  2227 00000575 813E[E054]4D2E          		cmp     word [Header+ModHeader.mhSign], 'M.'
  2228 0000057B 7508                    		jne     short CheckFLT4
  2229 0000057D 813E[E254]4B2E          		cmp     word [Header+ModHeader.mhSign+2], 'K.'
  2230 00000583 7439                    		je      short IsModFile
  2231                                  CheckFLT4:
  2232 00000585 813E[E054]464C          		cmp     word [Header+ModHeader.mhSign], 'FL'
  2233 0000058B 7508                    		jne     short Is15Inst
  2234 0000058D 813E[E254]5434          		cmp     word [Header+ModHeader.mhSign+2], 'T4'
  2235 00000593 7429                    		je      short IsModFile
  2236                                  Is15Inst:
  2237 00000595 BE[7E52]                		mov     si, (Header+ModHeader.mhSamples) + (15*ModSample.size)
  2238 00000598 BF[5E54]                		mov     di, Header+ModHeader.mhOrderLen
  2239 0000059B 8CD8                    		mov     ax, ds
  2240 0000059D 8EC0                    		mov     es, ax
  2241 0000059F FC                      		cld
  2242 000005A0 B98200                  		mov     cx, 130
  2243 000005A3 F3A4                    		rep     movsb
  2244 000005A5 BF[7E52]                		mov     di, Header+ModHeader.mhSamples + (15*ModSample.size)
  2245 000005A8 31C0                    		xor     ax, ax
  2246 000005AA B9E001                  		mov     cx, 16*ModSample.size
  2247 000005AD F3AA                    		rep     stosb
  2248                                  SeekPatterns:   
  2249 000005AF B80042                  		mov     ax, 4200h
  2250 000005B2 8B1E[A450]              		mov     bx, [FileHandle]
  2251 000005B6 B90000                  		mov     cx, 0
  2252 000005B9 BA5802                  		mov     dx, 600
  2253 000005BC CD21                    		int     21h
  2254                                  IsModFile:  
  2255 000005BE A0[5E54]                		mov     al, [Header+ModHeader.mhOrderLen]
  2256 000005C1 A2[E654]                		mov     [ModInfo.OrderLen], al
  2257                                  
  2258 000005C4 A0[5F54]                		mov     al, [Header+ModHeader.mhReStart]
  2259 000005C7 3A06[5E54]              		cmp     al, [Header+ModHeader.mhOrderLen]
  2260 000005CB 7202                    		jb      short SetReStart
  2261 000005CD B07F                    		mov     al, 7Fh
  2262                                  SetReStart:
  2263 000005CF A2[E754]                		mov     [ModInfo.ReStart], al
  2264                                  
  2265 000005D2 B98000                  		mov     cx, 128
  2266 000005D5 31C0                    		xor     ax, ax
  2267 000005D7 31DB                    		xor     bx, bx
  2268                                  CopyOrder:
  2269 000005D9 8AA7[6054]              		mov     ah, [Header+ModHeader.mhOrder+bx]
  2270 000005DD 88A7[E854]              		mov     [ModInfo.Order+bx], ah
  2271 000005E1 38C4                    		cmp     ah, al
  2272 000005E3 7202                    		jb      short NextOrder
  2273 000005E5 88E0                    		mov     al, ah
  2274                                  NextOrder:
  2275 000005E7 43                      		inc     bx
  2276 000005E8 E2EF                    		loop    CopyOrder
  2277                                  AllocPatterns:  
  2278                                  		; Erdogan Tan (13/02/2017)
  2279 000005EA 30E4                    		xor	ah, ah
  2280 000005EC FEC0                    		inc	al
  2281                                  		; al = count of 1024 bytes
  2282 000005EE 89C3                    		mov	bx, ax
  2283                                  		; count of paragraphs = al*64 
  2284 000005F0 C1E006                  		shl	ax, 6 ; *64
  2285 000005F3 89C5                    		mov	bp, ax
  2286 000005F5 8CCA                    		mov	dx, cs ; current (code) segment
  2287 000005F7 81C20010                		add	dx, 1000h ; next 64K (4096*16)
  2288                                  		;
  2289 000005FB C706[6855]0000          		mov	word [ModInfo.Patterns], 0
  2290 00000601 8916[6A55]              		mov	[ModInfo.Patterns+2], dx
  2291                                  		;
  2292 00000605 01D5                    		add	bp, dx ; next segment for samples
  2293                                  ReadPatterns:   
  2294 00000607 1E                      		push    ds
  2295 00000608 B8003F                  		mov     ax, 3F00h
  2296 0000060B 89D9                    		mov     cx, bx ; count of 1024 bytes
  2297 0000060D C1E10A                  		shl     cx, 10 ; byte count (cx*1024)
  2298 00000610 8B1E[A450]              		mov     bx, [FileHandle]
  2299                                  		;lds    dx, [ModInfo.Patterns]
  2300 00000614 8EDA                    		mov	ds, dx
  2301 00000616 31D2                    		xor	dx, dx
  2302 00000618 CD21                    		int     21h
  2303 0000061A 1F                      		pop     ds
  2304 0000061B 7275                    		jc      CloseFile
  2305                                  
  2306                                  		;lea	si, [Header+ModHeader.mhSamples]
  2307 0000061D BE[BC50]                		mov	si, Header+ModHeader.mhSamples
  2308 00000620 31FF                    		xor     di, di
  2309                                  CopySamples:
  2310 00000622 8B4416                  		mov     ax, [si+ModSample.msLength]
  2311 00000625 86C4                    		xchg    al, ah
  2312 00000627 D1E0                    		shl     ax, 1
  2313 00000629 8985[E855]              		mov     [ModInfo.SampLen+di], ax
  2314 0000062D 8A4419                  		mov     al, [si+ModSample.msVolume]
  2315 00000630 30E4                    		xor     ah, ah
  2316 00000632 8985[A256]              		mov     [ModInfo.SampVol+di], ax
  2317 00000636 8B441A                  		mov     ax, [si+ModSample.msRepeat]
  2318 00000639 86C4                    		xchg    al, ah
  2319 0000063B D1E0                    		shl     ax, 1
  2320 0000063D 8985[2656]              		mov     [ModInfo.SampRep+di], ax
  2321 00000641 8B441C                  		mov     ax, [si+ModSample.msRepLen]
  2322 00000644 86C4                    		xchg    al, ah
  2323 00000646 D1E0                    		shl     ax, 1
  2324 00000648 8985[6456]              		mov     [ModInfo.SampRepLen+di], ax
  2325 0000064C 83C61E                  		add     si, ModSample.size
  2326 0000064F 83C702                  		add     di, 2
  2327 00000652 83FF3E                  		cmp     di, 2*31
  2328 00000655 72CB                    		jb      short CopySamples
  2329                                  
  2330 00000657 31F6                    		xor     si, si
  2331                                  AllocSamples:
  2332                                  		; Erdogan Tan (13/02/2017)
  2333                                  		;mov	bx, [ModInfo.SampLen+si]
  2334 00000659 8B8C[E855]              		mov	cx, [ModInfo.SampLen+si]
  2335 0000065D 89CB                    		mov	bx, cx
  2336 0000065F C1EB04                  		shr     bx, 4 ; byte count / 16
  2337 00000662 7420                    		jz      short NextSample
  2338 00000664 43                      		inc	bx ; number of paragraphs
  2339 00000665 C784[6C55]0000          		mov	word [ModInfo.SampOfs+si], 0
  2340 0000066B 89AC[AA55]              		mov     [ModInfo.SampSeg+si], bp
  2341 0000066F 89EA                    		mov	dx, bp
  2342 00000671 01DD                    		add	bp, bx ; next segment for sample 
  2343                                  ReadSample:
  2344 00000673 1E                      		push    ds
  2345 00000674 B8003F                  		mov     ax, 3F00h
  2346 00000677 8B1E[A450]              		mov     bx, [FileHandle]
  2347                                  		;mov    cx, [ModInfo.SampLen+si]
  2348                                  		;mov    dx, [ModInfo.SampOfs+si]
  2349                                  		;mov    ds, [ModInfo.SampSeg+si]
  2350 0000067B 8EDA                    		mov	ds, dx
  2351 0000067D 31D2                    		xor	dx, dx	
  2352 0000067F CD21                    		int     21h
  2353 00000681 1F                      		pop     ds
  2354 00000682 720E                    		jc      short CloseFile
  2355                                  NextSample:
  2356 00000684 83C602                  		add     si, 2
  2357 00000687 83FE3E                  		cmp     si, 2*31
  2358 0000068A 72CD                    		jb      short AllocSamples
  2359                                  
  2360 0000068C C706[A650]0000          		mov     word [ErrorInfo], 0
  2361                                  CloseFile:      
  2362 00000692 B8003E                  		mov     ax, 3E00h
  2363 00000695 8B1E[A450]              		mov     bx, [FileHandle]
  2364 00000699 CD21                    		int     21h
  2365                                  Failed:         
  2366 0000069B 07                      		pop     es
  2367 0000069C 1F                      		pop     ds
  2368 0000069D 61                      		popa
  2369 0000069E 5D                      		pop     bp
  2370 0000069F C20400                  		ret	4
  2371                                  
  2372                                  FreeModule:
  2373                                  		; Erdogan Tan (13/02/2017)
  2374                                  		; nothing to do here for memory de-allocation
  2375                                  ClearModInfo:
  2376 000006A2 60                      		pusha
  2377 000006A3 06                      		push    es
  2378 000006A4 8CD8                    		mov     ax, ds
  2379 000006A6 8EC0                    		mov     es, ax
  2380                                  		;lea    di, [ModInfo]
  2381 000006A8 BF[E654]                		mov	di, ModInfo
  2382 000006AB B9FA01                  		mov     cx, ModInfoRec.size
  2383 000006AE FC                      		cld
  2384 000006AF 31C0                    		xor     ax, ax
  2385 000006B1 F3AA                    		rep     stosb
  2386 000006B3 07                      		pop     es
  2387 000006B4 61                      		popa
  2388 000006B5 C3                      		retn
  2389                                  
  2390                                  ;=============================================================================
  2391                                  ;               MODPLAY.ASM
  2392                                  ;=============================================================================
  2393                                  
  2394                                  ; Amiga Module Player v0.3b by Carlos Hasan.
  2395                                  ;		July 23th, 1993.
  2396                                  
  2397                                  ; EQUATES
  2398                                  
  2399                                  NumTracks       equ 4
  2400                                  DefTempo        equ 6
  2401                                  DefBpm          equ 125
  2402                                  MidCRate        equ 8448
  2403                                  MixBufSize      equ 4096
  2404                                  
  2405                                  ; STRUCTURES
  2406                                  
  2407                                  struc TrackInfo
  2408 00000000 ????????                .Samples:	resd 1
  2409 00000004 ????                    .Position:	resw 1
  2410 00000006 ????                    .Len:		resw 1
  2411 00000008 ????                    .Repeat:	resw 1
  2412 0000000A ????                    .RepLen:	resw 1
  2413 0000000C ??                      .Volume: 	resb 1
  2414 0000000D ??                      .Error:		resb 1
  2415 0000000E ????                    .Period:	resw 1
  2416 00000010 ????                    .Pitch:		resw 1
  2417 00000012 ????                    .Effect:	resw 1
  2418 00000014 ????                    .PortTo:	resw 1
  2419 00000016 ??                      .PortParm:	resb 1
  2420 00000017 ??                      .VibPos:	resb 1
  2421 00000018 ??                      .VibParm:	resb 1
  2422 00000019 ??                      .OldSampOfs:	resb 1
  2423 0000001A ????????????            .Arp:		resw 3
  2424 00000020 ????                    .ArpIndex:	resw 1
  2425                                  .size:
  2426                                  endstruc
  2427                                  
  2428                                  ; CODE
  2429                                  
  2430                                  ;--------------------------------------------------------------------------
  2431                                  ; BeatTrack:  Process the next beat in one track.
  2432                                  ;  In:
  2433                                  ;    ds:di -  Track info Address.
  2434                                  ;--------------------------------------------------------------------------
  2435                                  
  2436                                  BeatTrack:
  2437 000006B6 8B5512                  		mov     dx, [di+TrackInfo.Effect]
  2438 000006B9 85D2                    		test    dx, dx
  2439 000006BB 7430                    		je      short None
  2440 000006BD 80FE00                  		cmp     dh, 00h
  2441 000006C0 742C                    		je      short Arpeggio
  2442 000006C2 80FE01                  		cmp     dh, 01h
  2443 000006C5 743E                    		je      short PortUp
  2444 000006C7 80FE02                  		cmp     dh, 02h
  2445 000006CA 7455                    		je      short PortDown
  2446 000006CC 80FE03                  		cmp     dh, 03h
  2447 000006CF 746D                    		je      short TonePort
  2448 000006D1 80FE04                  		cmp     dh, 04h
  2449 000006D4 0F849100                		je      Vibrato
  2450 000006D8 80FE05                  		cmp     dh, 05h
  2451 000006DB 0F84D600                		je      PortSlide
  2452 000006DF 80FE06                  		cmp     dh, 06h
  2453 000006E2 0F84D700                		je      VibSlide
  2454 000006E6 80FE0A                  		cmp     dh, 0Ah
  2455 000006E9 0F84D800                		je      VolSlide
  2456                                  None:           
  2457 000006ED C3                      		retn
  2458                                  Arpeggio:
  2459 000006EE 8B5D20                  		mov     bx, [di+TrackInfo.ArpIndex]
  2460 000006F1 8B411A                  		mov     ax, [di+TrackInfo.Arp+bx]
  2461 000006F4 894510                  		mov     [di+TrackInfo.Pitch], ax
  2462 000006F7 83C302                  		add     bx, 2
  2463 000006FA 83FB06                  		cmp     bx, 6
  2464 000006FD 7202                    		jb      short SetArpIndex
  2465 000006FF 31DB                    		xor     bx,bx
  2466                                  SetArpIndex:
  2467 00000701 895D20                  		mov     [di+TrackInfo.ArpIndex], bx
  2468 00000704 C3                      		retn
  2469                                  PortUp:
  2470 00000705 30F6                    		xor     dh, dh
  2471 00000707 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2472 0000070A 29D3                    		sub     bx, dx
  2473 0000070C 83FB71                  		cmp     bx, 113
  2474 0000070F 7D03                    		jge     short NotSmall
  2475 00000711 BB7100                  		mov     bx, 113
  2476                                  NotSmall:
  2477 00000714 895D0E                  		mov     [di+TrackInfo.Period], bx
  2478 00000717 01DB                    		add     bx, bx
  2479 00000719 8B87[E056]              		mov     ax, [PitchTable+bx]
  2480 0000071D 894510                  		mov     [di+TrackInfo.Pitch], ax
  2481 00000720 C3                      		retn
  2482                                  PortDown:
  2483 00000721 30F6                    		xor     dh, dh
  2484 00000723 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2485 00000726 01D3                    		add     bx, dx
  2486 00000728 81FB5803                		cmp     bx, 856
  2487 0000072C 7E03                    		jle     short NotBig
  2488 0000072E BB5803                  		mov     bx, 856
  2489 00000731 895D0E                  NotBig:         mov     [di+TrackInfo.Period], bx
  2490 00000734 01DB                    		add     bx, bx
  2491 00000736 8B87[E056]              		mov     ax, [PitchTable+bx]
  2492 0000073A 894510                  		mov     [di+TrackInfo.Pitch], ax
  2493 0000073D C3                      		retn
  2494                                  TonePort:
  2495 0000073E 30F6                    		xor     dh, dh
  2496 00000740 8B4514                  		mov     ax, [di+TrackInfo.PortTo]
  2497 00000743 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2498 00000746 39C3                    		cmp     bx, ax
  2499 00000748 741E                    		je      short NoPort
  2500 0000074A 7F0A                    		jg      short PortToUp
  2501                                  PortToDown:     
  2502 0000074C 01D3                    		add     bx, dx
  2503 0000074E 39C3                    		cmp     bx, ax
  2504 00000750 7E0A                    		jle     short SetPort
  2505                                  FixPort:        
  2506 00000752 89C3                    		mov     bx, ax
  2507 00000754 EB06                    		jmp     short SetPort
  2508                                  PortToUp:
  2509 00000756 29D3                    		sub     bx, dx
  2510 00000758 39C3                    		cmp     bx, ax
  2511 0000075A 7CF6                    		jl      short FixPort
  2512                                  SetPort:        
  2513 0000075C 895D0E                  		mov     [di+TrackInfo.Period], bx
  2514 0000075F 01DB                    		add     bx, bx
  2515 00000761 8B87[E056]              		mov     ax, [PitchTable+bx]
  2516 00000765 894510                  		mov     [di+TrackInfo.Pitch], ax
  2517                                  NoPort:         
  2518 00000768 C3                      		retn
  2519                                  Vibrato:
  2520 00000769 88D6                    		mov     dh, dl
  2521 0000076B 80E20F                  		and     dl, 0Fh
  2522 0000076E C0EE04                  		shr     dh, 4
  2523 00000771 C0E602                  		shl     dh, 2
  2524 00000774 007517                  		add     [di+TrackInfo.VibPos], dh
  2525 00000777 8A7517                  		mov     dh, [di+TrackInfo.VibPos]
  2526 0000077A 88F3                    		mov     bl, dh
  2527 0000077C C0EB02                  		shr     bl, 2
  2528 0000077F 83E31F                  		and     bx, 1Fh
  2529 00000782 8A87[0D0E]              		mov     al, [SinTable+bx]
  2530 00000786 F6E2                    		mul     dl
  2531 00000788 D1C0                    		rol     ax, 1
  2532 0000078A 86C4                    		xchg    al, ah
  2533 0000078C 80E401                  		and     ah, 1
  2534 0000078F 84F6                    		test    dh, dh
  2535 00000791 7902                    		jns     short VibUp
  2536 00000793 F7D8                    		neg     ax
  2537                                  VibUp:          
  2538 00000795 03450E                  		add     ax, [di+TrackInfo.Period]
  2539 00000798 89C3                    		mov     bx, ax
  2540 0000079A 83FB71                  		cmp     bx, 113
  2541 0000079D 7D03                    		jge     short NoLoVib
  2542 0000079F BB7100                  		mov     bx, 113
  2543                                  NoLoVib:        
  2544 000007A2 81FB5803                		cmp     bx, 856
  2545 000007A6 7E03                    		jle     short NoHiVib
  2546 000007A8 BB5803                  		mov     bx, 856
  2547                                  NoHiVib:        
  2548 000007AB 01DB                    		add     bx, bx
  2549 000007AD 8B87[E056]              		mov     ax, [PitchTable+bx]
  2550 000007B1 894510                  		mov     [di+TrackInfo.Pitch], ax
  2551 000007B4 C3                      		retn
  2552                                  PortSlide:
  2553 000007B5 E80D00                  		call    VolSlide
  2554 000007B8 8A5516                  		mov     dl, [di+TrackInfo.PortParm]
  2555 000007BB EB81                    		jmp     short TonePort
  2556                                  VibSlide:
  2557 000007BD E80500                  		call    VolSlide
  2558 000007C0 8A5518                  		mov     dl, [di+TrackInfo.VibParm]
  2559 000007C3 EBA4                    		jmp     short Vibrato
  2560                                  VolSlide:
  2561 000007C5 88D6                    		mov     dh, dl
  2562 000007C7 80E20F                  		and     dl, 0Fh
  2563 000007CA C0EE04                  		shr     dh, 4
  2564 000007CD 8A450C                  		mov     al, [di+TrackInfo.Volume]
  2565 000007D0 28D0                    		sub     al, dl
  2566 000007D2 7D02                    		jge     short NoLoVol
  2567 000007D4 30C0                    		xor     al, al
  2568                                  NoLoVol:        
  2569 000007D6 00F0                    		add     al, dh
  2570 000007D8 3C40                    		cmp     al, 64
  2571 000007DA 7602                    		jbe     short NoHiVol
  2572 000007DC B040                    		mov     al, 64
  2573                                  NoHiVol:        
  2574 000007DE 88450C                  		mov     [di+TrackInfo.Volume], al
  2575 000007E1 C3                      		retn
  2576                                  
  2577                                  ;--------------------------------------------------------------------------
  2578                                  ; GetTrack:   Get the next Note from a pattern.
  2579                                  ;  In:
  2580                                  ;    ds:di -  Track info Address.
  2581                                  ;    es:si -  Pattern Note Address.
  2582                                  ; Out:
  2583                                  ;    es:si -  The Next Pattern Note address.
  2584                                  ;--------------------------------------------------------------------------
  2585                                  
  2586                                  GetTrack:
  2587 000007E2 26AD                    		es lodsw
  2588 000007E4 86C4                    		xchg    al, ah
  2589 000007E6 88E3                    		mov     bl, ah
  2590 000007E8 80E40F                  		and     ah, 0Fh
  2591 000007EB 89C1                    		mov     cx, ax
  2592 000007ED 26AD                    		es lodsw
  2593 000007EF 86C4                    		xchg    al, ah
  2594 000007F1 88E7                    		mov     bh, ah
  2595 000007F3 80E40F                  		and     ah, 0Fh
  2596 000007F6 89C2                    		mov     dx, ax
  2597 000007F8 895512                  		mov     [di+TrackInfo.Effect], dx
  2598 000007FB 80E3F0                  		and     bl, 0F0h
  2599 000007FE C0EF04                  		shr     bh, 4
  2600 00000801 08FB                    		or      bl, bh
  2601 00000803 742E                    		je      short SetPeriod
  2602                                  SetSample:
  2603 00000805 30FF                    		xor     bh, bh
  2604 00000807 4B                      		dec     bx
  2605 00000808 01DB                    		add     bx, bx
  2606 0000080A 8B87[A256]              		mov     ax, [ModInfo.SampVol+bx]
  2607 0000080E 88450C                  		mov     [di+TrackInfo.Volume], al
  2608 00000811 8B87[6C55]              		mov     ax, [ModInfo.SampOfs+bx]
  2609 00000815 8905                    		mov     [di+TrackInfo.Samples], ax
  2610 00000817 8B87[AA55]              		mov     ax, [ModInfo.SampSeg+bx]
  2611 0000081B 894502                  		mov     [di+TrackInfo.Samples+2], ax
  2612 0000081E 8B87[E855]              		mov     ax, [ModInfo.SampLen+bx]
  2613 00000822 894506                  		mov     [di+TrackInfo.Len], ax
  2614 00000825 8B87[2656]              		mov     ax, [ModInfo.SampRep+bx]
  2615 00000829 894508                  		mov     [di+TrackInfo.Repeat], ax
  2616 0000082C 8B87[6456]              		mov     ax, [ModInfo.SampRepLen+bx]
  2617 00000830 89450A                  		mov     [di+TrackInfo.RepLen], ax
  2618                                  SetPeriod:      
  2619 00000833 85C9                    		test    cx, cx
  2620 00000835 741B                    		je      short SetEffect
  2621                                  
  2622 00000837 894D14                  		mov     [di+TrackInfo.PortTo], cx
  2623 0000083A 80FE03                  		cmp     dh, 03h
  2624 0000083D 7413                    		je      short SetEffect
  2625                                  
  2626 0000083F 894D0E                  		mov     [di+TrackInfo.Period], cx
  2627 00000842 89CB                    		mov     bx, cx
  2628 00000844 01DB                    		add     bx, bx
  2629 00000846 8B87[E056]              		mov     ax, [PitchTable+bx]
  2630 0000084A 894510                  		mov     [di+TrackInfo.Pitch], ax
  2631 0000084D C745040000              		mov     word [di+TrackInfo.Position], 0
  2632                                  SetEffect:
  2633 00000852 85D2                    		test    dx, dx
  2634 00000854 742A                    		je      short InitNone
  2635 00000856 80FE00                  		cmp     dh, 00h
  2636 00000859 0F84C400                		je      InitArpeggio
  2637 0000085D 80FE03                  		cmp     dh, 03h
  2638 00000860 741F                    		je      short InitTonePort
  2639 00000862 80FE04                  		cmp     dh, 04h
  2640 00000865 7428                    		je      short InitVibrato
  2641 00000867 80FE09                  		cmp     dh, 09h
  2642 0000086A 744A                    		je      short SampleOfs
  2643 0000086C 80FE0B                  		cmp     dh, 0Bh
  2644 0000086F 7457                    		je      short PosJump
  2645 00000871 80FE0C                  		cmp     dh, 0Ch
  2646 00000874 745C                    		je      short SetVolume
  2647 00000876 80FE0D                  		cmp     dh, 0Dh
  2648 00000879 7462                    		je      short Break
  2649 0000087B 80FE0F                  		cmp     dh, 0Fh
  2650 0000087E 7478                    		je      short SetSpeed
  2651                                  InitNone:
  2652 00000880 C3                      		retn
  2653                                  InitTonePort:
  2654 00000881 84D2                    		test    dl, dl
  2655 00000883 7503                    		jne     short SetPortParm
  2656 00000885 8A5516                  		mov     dl, [di+TrackInfo.PortParm]
  2657                                  SetPortParm:    
  2658 00000888 885516                  		mov     [di+TrackInfo.PortParm], dl
  2659 0000088B 895512                  		mov     [di+TrackInfo.Effect], dx
  2660 0000088E C3                      		retn
  2661                                  InitVibrato:
  2662 0000088F 8A4518                  		mov     al, [di+TrackInfo.VibParm]
  2663 00000892 88C4                    		mov     ah, al
  2664 00000894 240F                    		and     al, 0Fh
  2665 00000896 80E4F0                  		and     ah, 0F0h
  2666 00000899 F6C20F                  		test    dl, 0Fh
  2667 0000089C 7502                    		jne     short OkDepth
  2668 0000089E 08C2                    		or      dl, al
  2669                                  OkDepth:        
  2670 000008A0 F6C2F0                  		test    dl, 0F0h
  2671 000008A3 7502                    		jne     short OkRate
  2672 000008A5 08E2                    		or      dl, ah
  2673                                  OkRate:         
  2674 000008A7 885518                  		mov     [di+TrackInfo.VibParm], dl
  2675 000008AA 895512                  		mov     [di+TrackInfo.Effect], dx
  2676 000008AD 85C9                    		test    cx, cx
  2677 000008AF 7404                    		je      short OkPos
  2678 000008B1 C6451700                		mov     byte [di+TrackInfo.VibPos], 0
  2679                                  OkPos:          
  2680 000008B5 C3                      		retn
  2681                                  SampleOfs:      
  2682 000008B6 84D2                    		test    dl, dl
  2683 000008B8 7503                    		jne     short SetSampleOfs
  2684 000008BA 8A5519                  		mov     dl, [di+TrackInfo.OldSampOfs]
  2685                                  SetSampleOfs:
  2686 000008BD 885519                  		mov     [di+TrackInfo.OldSampOfs], dl
  2687 000008C0 88D6                    		mov     dh, dl
  2688 000008C2 30D2                    		xor     dl, dl
  2689 000008C4 895504                  		mov     [di+TrackInfo.Position], dx
  2690 000008C7 C3                      		retn
  2691                                  PosJump:
  2692 000008C8 8816[92AE]              		mov     [OrderPos], dl
  2693 000008CC C606[96AE]40            		mov     byte [Row], 64
  2694 000008D1 C3                      		retn
  2695                                  SetVolume:
  2696 000008D2 80FA40                  		cmp     dl, 64
  2697 000008D5 7602                    		jbe     short OkVol
  2698 000008D7 B240                    		mov     dl, 64
  2699                                  OkVol:
  2700 000008D9 88550C                  		mov     [di+TrackInfo.Volume], dl
  2701 000008DC C3                      		retn
  2702                                  Break:
  2703 000008DD 88D6                    		mov     dh, dl
  2704 000008DF 80E20F                  		and     dl, 0Fh
  2705 000008E2 C0EE04                  		shr     dh, 4
  2706 000008E5 00F6                    		add     dh, dh
  2707 000008E7 00F2                    		add     dl, dh
  2708 000008E9 C0E602                  		shl     dh, 2
  2709 000008EC 00F2                    		add     dl, dh
  2710 000008EE 8816[97AE]              		mov     [BreakRow], dl
  2711 000008F2 C606[96AE]40            		mov     byte [Row], 64
  2712 000008F7 C3                      		retn
  2713                                  SetSpeed:
  2714 000008F8 84D2                    		test    dl,dl
  2715 000008FA 7424                    		je      Skip
  2716 000008FC 80FA1F                  		cmp     dl,31
  2717 000008FF 7709                    		ja      short SetBpm
  2718                                  SetTempo:       
  2719 00000901 8816[93AE]              		mov     [Tempo], dl
  2720 00000905 8816[94AE]              		mov     [TempoWait], dl
  2721 00000909 C3                      		retn
  2722                                  SetBpm:
  2723 0000090A 8816[95AE]              		mov     [Bpm], dl
  2724 0000090E B067                    		mov     al, 103
  2725 00000910 F6E2                    		mul     dl
  2726 00000912 88E3                    		mov     bl, ah
  2727 00000914 30FF                    		xor     bh, bh
  2728 00000916 A1[E454]                		mov     ax, [MixSpeed]
  2729 00000919 31D2                    		xor     dx, dx
  2730 0000091B F7F3                    		div     bx
  2731 0000091D A3[98AE]                		mov     [BpmSamples], ax
  2732                                  Skip:           
  2733 00000920 C3                      		retn
  2734                                  InitArpeggio:
  2735 00000921 88D6                    		mov     dh, dl
  2736 00000923 80E20F                  		and     dl, 0Fh
  2737 00000926 C0EE04                  		shr     dh, 4
  2738 00000929 B92400                  		mov     cx, 36
  2739 0000092C 31DB                    		xor     bx, bx
  2740 0000092E 8B450E                  		mov     ax, [di+TrackInfo.Period]
  2741                                  gt_ScanPeriod:
  2742 00000931 3B87[2D0E]              		cmp     ax, [PeriodTable+bx]
  2743 00000935 7305                    		jae     short SetArp
  2744 00000937 83C302                  		add     bx, 2
  2745 0000093A E2F5                    		loop    gt_ScanPeriod
  2746                                  SetArp:         
  2747 0000093C 01D2                    		add     dx, dx
  2748 0000093E 00DE                    		add     dh, bl
  2749 00000940 00DA                    		add     dl, bl
  2750 00000942 8B9F[2D0E]              		mov     bx, [PeriodTable+bx]
  2751 00000946 01DB                    		add     bx, bx
  2752 00000948 8B87[E056]              		mov     ax, [PitchTable+bx]
  2753 0000094C 89451A                  		mov     [di+TrackInfo.Arp], ax
  2754 0000094F 88F3                    		mov     bl, dh
  2755 00000951 30FF                    		xor     bh, bh
  2756 00000953 8B9F[2D0E]              		mov     bx, [PeriodTable+bx]
  2757 00000957 01DB                    		add     bx, bx
  2758 00000959 8B87[E056]              		mov     ax, [PitchTable+bx]
  2759 0000095D 89451C                  		mov     [di+TrackInfo.Arp+2], ax
  2760 00000960 88D3                    		mov     bl, dl
  2761 00000962 30FF                    		xor     bh, bh
  2762 00000964 8B9F[2D0E]              		mov     bx, [PeriodTable+bx]
  2763 00000968 01DB                    		add     bx, bx
  2764 0000096A 8B87[E056]              		mov     ax, [PitchTable+bx]
  2765 0000096E 89451E                  		mov     [di+TrackInfo.Arp+4], ax
  2766 00000971 C745200000              		mov     word [di+TrackInfo.ArpIndex], 0
  2767 00000976 C3                      		retn
  2768                                  
  2769                                  ;--------------------------------------------------------------------------
  2770                                  ; UpdateTracks:  Main code to process the next tick to be played.
  2771                                  ;--------------------------------------------------------------------------
  2772                                  
  2773                                  UpdateTracks:
  2774 00000977 FE0E[94AE]              		dec     byte [TempoWait]
  2775 0000097B 740F                    		jz      short GetTracks
  2776                                  
  2777 0000097D B90400                  		mov	cx, NumTracks
  2778 00000980 BF[A4AE]                		mov	di, Tracks
  2779                                  BeatTracks:
  2780 00000983 E830FD                  		call	BeatTrack	
  2781 00000986 83C722                  		add	di, TrackInfo.size
  2782 00000989 E2F8                    		loop	BeatTracks
  2783 0000098B C3                      		retn
  2784                                  GetTracks:
  2785 0000098C A0[93AE]                		mov     al, [Tempo]
  2786 0000098F A2[94AE]                		mov     [TempoWait], al
  2787                                  
  2788 00000992 C436[A0AE]              		les     si, [Note]
  2789 00000996 803E[96AE]40            		cmp     byte [Row], 64
  2790 0000099B 7246                    		jb      short NoPattWrap
  2791                                  
  2792 0000099D C436[6855]              		les     si, [ModInfo.Patterns]
  2793 000009A1 8A1E[92AE]              		mov     bl, [OrderPos]
  2794 000009A5 3A1E[E654]              		cmp     bl, [ModInfo.OrderLen]
  2795 000009A9 720E                    		jb      short NoOrderWrap
  2796 000009AB 8A1E[E754]              		mov     bl, [ModInfo.ReStart]
  2797 000009AF 881E[92AE]              		mov     [OrderPos], bl
  2798 000009B3 3A1E[E654]              		cmp     bl, [ModInfo.OrderLen]
  2799 000009B7 7343                    		jae     short NoUpdate
  2800                                  NoOrderWrap:    
  2801 000009B9 30FF                    		xor     bh, bh
  2802 000009BB 8A9F[E854]              		mov     bl, [ModInfo.Order+bx]
  2803 000009BF C1E30A                  		shl     bx, 10
  2804 000009C2 01DE                    		add     si, bx
  2805 000009C4 8A1E[97AE]              		mov     bl, [BreakRow]
  2806 000009C8 881E[96AE]              		mov     [Row], bl
  2807 000009CC 30FF                    		xor     bh, bh
  2808 000009CE 883E[97AE]              		mov     [BreakRow], bh
  2809 000009D2 C1E304                  		shl     bx, 4
  2810 000009D5 01DE                    		add     si, bx
  2811 000009D7 8936[A0AE]              		mov     [Note], si
  2812 000009DB 8C06[A2AE]              		mov     [Note+2], es
  2813 000009DF FE06[92AE]              		inc     byte [OrderPos]
  2814                                  NoPattWrap:     
  2815 000009E3 FE06[96AE]              		inc     byte [Row]
  2816                                  
  2817 000009E7 FC                      		cld
  2818 000009E8 B90400                  		mov	cx, NumTracks
  2819 000009EB BF[A4AE]                		mov	di, Tracks
  2820                                  GetTracks_next:
  2821 000009EE 51                      		push	cx		
  2822 000009EF E8F0FD                  		call	GetTrack
  2823 000009F2 59                      		pop	cx
  2824 000009F3 83C722                  		add	di, TrackInfo.size
  2825 000009F6 E2F6                    		loop	GetTracks_next
  2826                                  
  2827 000009F8 8936[A0AE]              		mov     [Note], si
  2828                                  NoUpdate:
  2829 000009FC C3                      		retn
  2830                                  
  2831                                  ;--------------------------------------------------------------------------
  2832                                  ; MixTrack:  Mixes one track into a CLEAN buffer.
  2833                                  ;  In:
  2834                                  ;   ds:si -  Track Info Address.
  2835                                  ;   ds:di -  Buffer Address.
  2836                                  ;    cx   -  Buffer Size.
  2837                                  ;--------------------------------------------------------------------------
  2838                                  
  2839                                  MixTrack:
  2840 000009FD 837C0A02                		cmp     word [si+TrackInfo.RepLen], 2
  2841 00000A01 7742                    		ja      short MixLooped
  2842                                  MixNonLooped:   
  2843 00000A03 C414                    		les     dx, [si+TrackInfo.Samples]
  2844 00000A05 8B5C04                  		mov     bx, [si+TrackInfo.Position]
  2845 00000A08 8B6C06                  		mov     bp, [si+TrackInfo.Len]
  2846 00000A0B 52                      		push    dx
  2847 00000A0C 56                      		push    si
  2848 00000A0D 01D3                    		add     bx, dx
  2849 00000A0F 01D5                    		add     bp, dx
  2850 00000A11 8B5410                  		mov     dx, [si+TrackInfo.Pitch]
  2851 00000A14 8A440C                  		mov     al, [si+TrackInfo.Volume]
  2852 00000A17 8A640D                  		mov     ah, [si+TrackInfo.Error]
  2853 00000A1A 89DE                    		mov     si, bx
  2854 00000A1C 88C7                    		mov     bh, al
  2855 00000A1E 88D0                    		mov     al, dl
  2856 00000A20 88F2                    		mov     dl, dh
  2857 00000A22 30F6                    		xor     dh, dh
  2858                                  nlMixSamp:      
  2859 00000A24 39EE                    		cmp     si, bp
  2860 00000A26 7310                    		jae     short nlMixBye
  2861 00000A28 268A1C                  		mov     bl, [es:si]
  2862 00000A2B 8A9F[925D]              		mov     bl, [VolTable+bx]
  2863 00000A2F 001D                    		add     [di], bl
  2864 00000A31 47                      		inc     di
  2865 00000A32 00C4                    		add     ah, al
  2866 00000A34 11D6                    		adc     si, dx
  2867 00000A36 E2EC                    		loop    nlMixSamp
  2868                                  nlMixBye:       
  2869 00000A38 89F3                    		mov     bx, si
  2870 00000A3A 5E                      		pop     si
  2871 00000A3B 5A                      		pop     dx
  2872 00000A3C 29D3                    		sub     bx, dx
  2873 00000A3E 895C04                  		mov     [si+TrackInfo.Position], bx
  2874 00000A41 88640D                  		mov     [si+TrackInfo.Error], ah
  2875 00000A44 C3                      		retn
  2876                                  MixLooped:
  2877 00000A45 C414                    		les     dx, [si+TrackInfo.Samples]
  2878 00000A47 8B5C04                  		mov     bx, [si+TrackInfo.Position]
  2879 00000A4A 8B6C0A                  		mov     bp, [si+TrackInfo.RepLen]
  2880 00000A4D 892E[9EAE]              		mov     [BufRep], bp
  2881 00000A51 036C08                  		add     bp, [si+TrackInfo.Repeat]
  2882 00000A54 52                      		push    dx
  2883 00000A55 56                      		push    si
  2884 00000A56 01D3                    		add     bx, dx
  2885 00000A58 01D5                    		add     bp, dx
  2886 00000A5A 8B5410                  		mov     dx, [si+TrackInfo.Pitch]
  2887 00000A5D 8A440C                  		mov     al, [si+TrackInfo.Volume]
  2888 00000A60 8A640D                  		mov     ah, [si+TrackInfo.Error]
  2889 00000A63 89DE                    		mov     si, bx
  2890 00000A65 88C7                    		mov     bh, al
  2891 00000A67 88D0                    		mov     al, dl
  2892 00000A69 88F2                    		mov     dl, dh
  2893 00000A6B 30F6                    		xor     dh, dh
  2894                                  lpMixSamp:      
  2895 00000A6D 39EE                    		cmp     si, bp
  2896 00000A6F 7204                    		jb      short lpMixNow
  2897 00000A71 2B36[9EAE]              		sub     si, [BufRep]
  2898                                  lpMixNow:       
  2899 00000A75 268A1C                  		mov     bl, [es:si]
  2900 00000A78 8A9F[925D]              		mov     bl, [VolTable+bx]
  2901 00000A7C 001D                    		add     [di], bl
  2902 00000A7E 47                      		inc     di
  2903 00000A7F 00C4                    		add     ah, al
  2904 00000A81 11D6                    		adc     si, dx
  2905 00000A83 E2E8                    		loop    lpMixSamp
  2906                                  lpMixBye:       
  2907 00000A85 89F3                    		mov     bx, si
  2908 00000A87 5E                      		pop     si
  2909 00000A88 5A                      		pop     dx
  2910 00000A89 29D3                    		sub     bx, dx
  2911 00000A8B 895C04                  		mov     [si+TrackInfo.Position], bx
  2912 00000A8E 88640D                  		mov     [si+TrackInfo.Error], ah
  2913 00000A91 C3                      		retn
  2914                                  
  2915                                  GetSamples_ICH:
  2916                                  		; 11/05/2024
  2917                                  		; 18/02/2017
  2918                                  		; 8 bit mono samples 
  2919                                  		; must be converted to 16 bit, stereo samples (for ICH) !
  2920                                  		; (ICH AC97 Modification by Erdogan Tan)
  2921 00000A92 8936[B0B3]              		mov	[_si_], si ; DMA Buff Addr, [DMA_BUFFER1] or [DMA_BUFFER2]
  2922                                  		; 11/05/2024
  2923                                  		;mov	si, MOD_BUFFER
  2924                                  		;shr	cx, 2 ; mod buffer size = dma (half) buffer size / 4 (*)
  2925                                  
  2926                                  ;--------------------------------------------------------------------------
  2927                                  ; GetSamples:  Returns the next chunk of samples to be played.
  2928                                  ;  In:
  2929                                  ;    Buffer  - Buffer Address.
  2930                                  ;    Count   - Buffer Size.
  2931                                  ;--------------------------------------------------------------------------
  2932                                  
  2933                                  GetSamples:
  2934                                  		;ds:si = buffer address
  2935                                  		;cx = count
  2936                                  
  2937                                  		; 11/05/2024
  2938                                  		;
  2939                                  		;;[sp+6] = ds
  2940                                  		;;[sp+4] = si
  2941                                  		;;[sp+2] = count
  2942                                  		;
  2943                                  		;Count	equ 4
  2944                                  		;Buffer	equ 6 
  2945                                  		;
  2946                                  		;push	bp
  2947                                  		;mov	bp, sp
  2948                                  		;
  2949                                  		;push    es
  2950                                  		;;;push  ds
  2951                                  		;;;pusha
  2952                                  		;
  2953                                  		;cld
  2954                                  		;
  2955                                  		;les	di, [bp+Buffer]
  2956                                  		;mov    bx, [bp+Count]
  2957                                  
  2958                                  		; 11/05/2024
  2959                                  		; ds = cs
  2960 00000A96 06                      		push	es ; +
  2961                                  
  2962 00000A97 1E                      		push	ds
  2963 00000A98 07                      		pop	es
  2964                                  
  2965                                  		; 11/05/2024
  2966 00000A99 BF[B2B3]                		mov	di, MOD_BUFFER
  2967 00000A9C BB0008                  		mov	bx, (BUFFERSIZE/4) ; (*) ; 2048
  2968                                  NextChunk:
  2969 00000A9F 833E[9CAE]00            		cmp     word [BufLen], 0
  2970 00000AA4 7534                    		jne     short CopyChunk
  2971                                  
  2972                                  		; 11/05/2024
  2973 00000AA6 06                      		push	es
  2974 00000AA7 53                      		push	bx
  2975 00000AA8 57                      		push	di
  2976                                  MixChunk:       
  2977                                  		;lea    di, [MixBuffer]
  2978 00000AA9 BF[929E]                		mov	di, MixBuffer
  2979 00000AAC 8B0E[98AE]              		mov     cx, [BpmSamples]
  2980 00000AB0 893E[9AAE]              		mov     [BufPtr], di
  2981 00000AB4 890E[9CAE]              		mov     [BufLen], cx
  2982                                  
  2983                                  		; 12/05/2024
  2984                                  		; es = ds
  2985                                  		;mov    ax, ds
  2986                                  		;mov    es, ax
  2987                                  
  2988 00000AB8 B080                    		mov    al, 80h
  2989 00000ABA F3AA                    		rep    stosb
  2990                                  
  2991 00000ABC B90400                  		mov	cx, NumTracks
  2992 00000ABF BE[82AE]                		mov	si, Tracks - TrackInfo.size
  2993                                  GetSamples_next:
  2994 00000AC2 51                      		push	cx
  2995 00000AC3 83C622                  		add	si, TrackInfo.size
  2996 00000AC6 8B0E[9CAE]              		mov	cx, [BufLen]
  2997 00000ACA 8B3E[9AAE]              		mov	di, [BufPtr]
  2998 00000ACE E82CFF                  		call	MixTrack
  2999 00000AD1 59                      		pop	cx
  3000 00000AD2 E2EE                    		loop	GetSamples_next
  3001                                  
  3002 00000AD4 E8A0FE                  		call    UpdateTracks
  3003                                  
  3004 00000AD7 5F                      		pop	di
  3005 00000AD8 5B                      		pop	bx
  3006 00000AD9 07                      		pop	es ; es = ds ; 12/05/2024
  3007                                  CopyChunk:      
  3008 00000ADA 8B0E[9CAE]              		mov     cx, [BufLen]
  3009 00000ADE 39D9                    		cmp     cx, bx
  3010 00000AE0 7602                    		jbe     short MoveChunk
  3011 00000AE2 89D9                    		mov     cx, bx
  3012                                  MoveChunk:
  3013 00000AE4 8B36[9AAE]              		mov     si, [BufPtr]
  3014 00000AE8 010E[9AAE]              		add     [BufPtr], cx
  3015 00000AEC 290E[9CAE]              		sub     [BufLen], cx
  3016 00000AF0 29CB                    		sub     bx, cx
  3017 00000AF2 F3A4                    		rep     movsb
  3018 00000AF4 85DB                    		test    bx, bx
  3019 00000AF6 75A7                    		jnz     short NextChunk
  3020                                  
  3021                                  		;;popa
  3022                                  		;;pop	ds
  3023                                  		;pop	es
  3024                                  		;pop	bp
  3025                                  		;ret	6
  3026                                  
  3027                                  ; GetSamples_ICH_convert_samples:
  3028                                  		; 11/05/2024
  3029                                  		; es = ds = cs
  3030                                  		; 18/02/2017
  3031                                  		;mov	di, ds
  3032                                  		;mov	es, di
  3033 00000AF8 8B3E[B0B3]              		mov	di, [_si_] ; DMA Buffer Address (16 bit, stereo)
  3034 00000AFC BE[B1B3]                		mov	si, MOD_BUFFER - 1 ; buffer for 8 bit mono samples
  3035 00000AFF B90008                  		mov	cx, (BUFFERSIZE/4) ; (*) ; 2048 ; 11/04/2024
  3036 00000B02 30C0                    		xor	al, al
  3037                                  gscs_loop:		
  3038 00000B04 46                      		inc	si
  3039 00000B05 8A24                    		mov	ah, [si] ; convert 8 bit sample to 16 bit sample
  3040                                  		; 11/05/2024
  3041 00000B07 80EC80                  		sub	ah, 80h
  3042                                  
  3043 00000B0A AB                      		stosw	; left channel
  3044 00000B0B AB                      		stosw	; right channel
  3045 00000B0C E2F6                    		loop	gscs_loop
  3046                                  
  3047                                  		; 11/05/2024
  3048 00000B0E 07                      		pop	es ; +
  3049                                  		;pop	bp
  3050                                  		;ret	6
  3051 00000B0F C3                      		retn
  3052                                  
  3053                                  ;--------------------------------------------------------------------------
  3054                                  ; StartPlaying: Initializes the Sound System.
  3055                                  ;  In:
  3056                                  ;   Module Information Resources.
  3057                                  ;--------------------------------------------------------------------------
  3058                                  
  3059                                  StartPlaying:
  3060 00000B10 60                      		pusha
  3061 00000B11 1E                      		push    ds
  3062 00000B12 06                      		push    es
  3063                                  SetModParms:    
  3064 00000B13 C606[92AE]00            		mov     byte [OrderPos], 0
  3065 00000B18 C606[93AE]06            		mov     byte [Tempo], DefTempo
  3066 00000B1D C606[94AE]06            		mov     byte [TempoWait], DefTempo
  3067 00000B22 C606[95AE]7D            		mov     byte [Bpm], DefBpm
  3068 00000B27 C606[96AE]40            		mov     byte [Row], 64
  3069 00000B2C C606[97AE]00            		mov     byte [BreakRow], 0
  3070 00000B31 A1[E454]                		mov     ax, [MixSpeed]
  3071 00000B34 31D2                    		xor     dx, dx
  3072 00000B36 BB3200                  		mov     bx, 24*DefBpm/60
  3073 00000B39 F7F3                    		div     bx
  3074 00000B3B A3[98AE]                		mov     [BpmSamples], ax
  3075                                  ClearTracks:    
  3076 00000B3E BF[A4AE]                		mov     di, Tracks
  3077 00000B41 8CD8                    		mov     ax, ds
  3078 00000B43 8EC0                    		mov     es, ax
  3079 00000B45 B98800                  		mov     cx, NumTracks*TrackInfo.size
  3080 00000B48 31C0                    		xor     ax, ax
  3081 00000B4A FC                      		cld
  3082 00000B4B F3AA                    		rep     stosb
  3083                                  
  3084 00000B4D A3[9AAE]                		mov     [BufPtr], ax
  3085 00000B50 A3[9CAE]                		mov     [BufLen], ax
  3086                                  MakePitch:
  3087 00000B53 B80021                  		mov     ax, MidCRate
  3088 00000B56 BBAC01                  		mov     bx, 428
  3089 00000B59 F7E3                    		mul     bx
  3090 00000B5B F736[E454]              		div     word [MixSpeed]
  3091 00000B5F 30F6                    		xor     dh, dh
  3092 00000B61 88E2                    		mov     dl, ah
  3093 00000B63 88C4                    		mov     ah, al
  3094 00000B65 30C0                    		xor     al, al
  3095 00000B67 B95903                  		mov     cx, 857
  3096 00000B6A 31DB                    		xor     bx, bx
  3097 00000B6C BF[E056]                		mov     di, PitchTable
  3098                                  PitchLoop:      
  3099 00000B6F 50                      		push    ax
  3100 00000B70 52                      		push    dx
  3101 00000B71 39DA                    		cmp     dx, bx
  3102 00000B73 7302                    		jae     short NoDiv
  3103 00000B75 F7F3                    		div     bx
  3104                                  NoDiv:          
  3105 00000B77 AB                      		stosw
  3106 00000B78 5A                      		pop     dx
  3107 00000B79 58                      		pop     ax
  3108 00000B7A 43                      		inc     bx
  3109 00000B7B E2F2                    		loop    PitchLoop
  3110                                  MakeVolume:     
  3111 00000B7D B90041                  		mov     cx, 16640
  3112 00000B80 89CB                    		mov     bx, cx
  3113                                  VolLoop:
  3114 00000B82 4B                      		dec     bx
  3115 00000B83 88D8                    		mov     al, bl
  3116 00000B85 F6EF                    		imul    bh
  3117 00000B87 88A7[925D]              		mov     [VolTable+bx], ah
  3118 00000B8B E2F5                    		loop    VolLoop
  3119                                  
  3120 00000B8D 07                      		pop     es
  3121 00000B8E 1F                      		pop     ds
  3122 00000B8F 61                      		popa
  3123 00000B90 C3                      		retn	; 12/05/2024
  3124                                  
  3125                                  ;--------------------------------------------------------------------------
  3126                                  ; StopPlaying: ShutDown the Sound System.
  3127                                  ;--------------------------------------------------------------------------
  3128                                  
  3129                                  StopPlaying:
  3130                                  	; 08/05/2024
  3131                                  	; 04/11/2023
  3132                                  	; finished with song, stop everything
  3133 00000B91 E8A801                  	call	ac97_stop
  3134                                  
  3135                                  ; 12/05/2024 (tuneloop version)
  3136                                  %if 0
  3137                                  	; 11/11/2023
  3138                                  irq_restore:	
  3139                                  	; restore previous interrupt vector and interrupt_status
  3140                                  	cli
  3141                                  	in	al, 0A1h ; irq 8-15
  3142                                  	mov	al, [IRQ_status+1]
  3143                                  	out	0A1h, al 
  3144                                  	in	al, 021h ; irq 0-7
  3145                                  	mov	al, [IRQ_status]
  3146                                  	out	21h, al 
  3147                                  	; ...
  3148                                  	push	es
  3149                                  	xor	ax, ax
  3150                                  	mov	es, ax
  3151                                  	mov	ax, [IRQ_vector]
  3152                                  	mov	[es:bx], ax
  3153                                  	mov	ax, [IRQ_vector+2]
  3154                                  	mov	[es:bx+2], ax
  3155                                  	pop	es
  3156                                  
  3157                                  	sti
  3158                                  %endif
  3159 00000B94 C3                      	retn
  3160                                  
  3161                                  ;=============================================================================
  3162                                  ;               PLAYER.ASM
  3163                                  ;=============================================================================
  3164                                  
  3165                                  ; UTILS.ASM
  3166                                  ;----------------------------------------------------------------------------
  3167                                  ;       delay1_4ms - Delay for 1/4 millisecond.
  3168                                  ;		    1mS = 1000us
  3169                                  ;       Entry:
  3170                                  ;         None
  3171                                  ;       Exit:
  3172                                  ;	  None
  3173                                  ;
  3174                                  ;       Modified:
  3175                                  ;         None
  3176                                  ;
  3177                                  PORTB			EQU	061h
  3178                                    REFRESH_STATUS	EQU	010h		; Refresh signal status
  3179                                  
  3180                                  delay1_4ms:
  3181 00000B95 50                              push    ax 
  3182 00000B96 51                              push    cx
  3183 00000B97 B91000                          mov     cx, 16			; close enough.
  3184 00000B9A E461                    	in	al,PORTB
  3185 00000B9C 2410                    	and	al,REFRESH_STATUS
  3186 00000B9E 88C4                    	mov	ah,al			; Start toggle state
  3187 00000BA0 09C9                    	or	cx, cx
  3188 00000BA2 7401                    	jz	short _d4ms1
  3189 00000BA4 41                      	inc	cx			; Throwaway first toggle
  3190                                  _d4ms1:	
  3191 00000BA5 E461                    	in	al,PORTB		; Read system control port
  3192 00000BA7 2410                    	and	al,REFRESH_STATUS	; Refresh toggles 15.085 microseconds
  3193 00000BA9 38C4                    	cmp	ah,al
  3194 00000BAB 74F8                    	je	short _d4ms1		; Wait for state change
  3195                                  
  3196 00000BAD 88C4                    	mov	ah,al			; Update with new state
  3197 00000BAF 49                      	dec	cx
  3198 00000BB0 75F3                    	jnz	short _d4ms1
  3199                                  
  3200 00000BB2 59                              pop     cx
  3201 00000BB3 58                              pop     ax
  3202 00000BB4 C3                              retn
  3203                                  
  3204                                  print_msg:
  3205                                  	; 13/11/2016 - Erdogan Tan 
  3206                                  	; esi = ASCIIZ text address
  3207                                  	;
  3208 00000BB5 BB0700                  	mov	bx, 7h
  3209 00000BB8 B40E                    	mov	ah, 0Eh 
  3210                                  pm_next_char:
  3211 00000BBA AC                      	lodsb
  3212 00000BBB 20C0                    	and	al, al
  3213 00000BBD 7404                    	jz	short pm_retn
  3214 00000BBF CD10                    	int	10h
  3215 00000BC1 EBF7                    	jmp	short pm_next_char
  3216                                  pm_retn:
  3217 00000BC3 C3                      	retn
  3218                                  
  3219                                  dword2str:
  3220                                  	; 13/11/2016 - Erdogan Tan 
  3221                                  	; eax = dword value
  3222                                  	;
  3223 00000BC4 E84400                  	call	dwordtohex
  3224 00000BC7 668916[770F]            	mov	[dword_str], edx
  3225 00000BCC 66A3[7B0F]              	mov	[dword_str+4], eax
  3226 00000BD0 BE[770F]                	mov	si, dword_str
  3227 00000BD3 C3                      	retn
  3228                                  
  3229                                  	; trdos386.s (unix386.s) - 10/05/2015
  3230                                  	; Convert binary number to hexadecimal string
  3231                                  
  3232                                  bytetohex:
  3233                                  	; INPUT ->
  3234                                  	; 	AL = byte (binary number)
  3235                                  	; OUTPUT ->
  3236                                  	;	AX = hexadecimal string
  3237                                  	;
  3238 00000BD4 53                      	push	bx
  3239 00000BD5 30FF                    	xor	bh, bh
  3240 00000BD7 88C3                    	mov	bl, al
  3241 00000BD9 C0EB04                  	shr	bl, 4
  3242 00000BDC 8A9F[D90E]              	mov	bl, [bx+hex_chars] 	 	
  3243 00000BE0 86D8                    	xchg	bl, al
  3244 00000BE2 80E30F                  	and	bl, 0Fh
  3245 00000BE5 8AA7[D90E]              	mov	ah, [bx+hex_chars] 
  3246 00000BE9 5B                      	pop	bx	
  3247 00000BEA C3                      	retn
  3248                                  
  3249                                  wordtohex:
  3250                                  	; INPUT ->
  3251                                  	; 	AX = word (binary number)
  3252                                  	; OUTPUT ->
  3253                                  	;	EAX = hexadecimal string
  3254                                  	;
  3255 00000BEB 53                      	push	bx
  3256 00000BEC 30FF                    	xor	bh, bh
  3257 00000BEE 86E0                    	xchg	ah, al
  3258 00000BF0 50                      	push	ax
  3259 00000BF1 88E3                    	mov	bl, ah
  3260 00000BF3 C0EB04                  	shr	bl, 4
  3261 00000BF6 8A87[D90E]              	mov	al, [bx+hex_chars] 	 	
  3262 00000BFA 88E3                    	mov	bl, ah
  3263 00000BFC 80E30F                  	and	bl, 0Fh
  3264 00000BFF 8AA7[D90E]              	mov	ah, [bx+hex_chars]
  3265 00000C03 66C1E010                	shl	eax, 16
  3266 00000C07 58                      	pop	ax
  3267 00000C08 5B                      	pop	bx
  3268 00000C09 EBC9                    	jmp	short bytetohex
  3269                                  
  3270                                  dwordtohex:
  3271                                  	; INPUT ->
  3272                                  	; 	EAX = dword (binary number)
  3273                                  	; OUTPUT ->
  3274                                  	;	EDX:EAX = hexadecimal string
  3275                                  	;
  3276 00000C0B 6650                    	push	eax
  3277 00000C0D 66C1E810                	shr	eax, 16
  3278 00000C11 E8D7FF                  	call	wordtohex
  3279 00000C14 6689C2                  	mov	edx, eax
  3280 00000C17 6658                    	pop	eax
  3281 00000C19 E8CFFF                  	call	wordtohex
  3282 00000C1C C3                      	retn
  3283                                  
  3284                                  	; 13/11/2016 - Erdogan Tan
  3285                                  write_ac97_dev_info:
  3286                                  	; BUS/DEV/FN
  3287                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  3288                                  	; DEV/VENDOR
  3289                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  3290                                  
  3291 00000C1D 30FF                    	xor	bh, bh
  3292 00000C1F 668B36[9E0F]            	mov	esi, [dev_vendor]
  3293 00000C24 89F0                    	mov	ax, si
  3294 00000C26 88C3                    	mov	bl, al
  3295 00000C28 88DA                    	mov	dl, bl
  3296 00000C2A 80E30F                  	and	bl, 0Fh
  3297 00000C2D 8A87[D90E]              	mov	al, [bx+hex_chars]
  3298 00000C31 A2[1C0F]                	mov	[msgVendorId+3], al
  3299 00000C34 88D3                    	mov	bl, dl
  3300 00000C36 C0EB04                  	shr	bl, 4
  3301 00000C39 8A87[D90E]              	mov	al, [bx+hex_chars]
  3302 00000C3D A2[1B0F]                	mov	[msgVendorId+2], al
  3303 00000C40 88E3                    	mov	bl, ah
  3304 00000C42 88DA                    	mov	dl, bl
  3305 00000C44 80E30F                  	and	bl, 0Fh
  3306 00000C47 8A87[D90E]              	mov	al, [bx+hex_chars]
  3307 00000C4B A2[1A0F]                	mov	[msgVendorId+1], al
  3308 00000C4E 88D3                    	mov	bl, dl
  3309 00000C50 C0EB04                  	shr	bl, 4
  3310 00000C53 8A87[D90E]              	mov	al, [bx+hex_chars]
  3311 00000C57 A2[190F]                	mov	[msgVendorId], al
  3312 00000C5A 66C1EE10                	shr	esi, 16
  3313 00000C5E 89F0                    	mov	ax, si
  3314 00000C60 88C3                    	mov	bl, al
  3315 00000C62 88DA                    	mov	dl, bl
  3316 00000C64 80E30F                  	and	bl, 0Fh
  3317 00000C67 8A87[D90E]              	mov	al, [bx+hex_chars]
  3318 00000C6B A2[2D0F]                	mov	[msgDevId+3], al
  3319 00000C6E 88D3                    	mov	bl, dl
  3320 00000C70 C0EB04                  	shr	bl, 4
  3321 00000C73 8A87[D90E]              	mov	al, [bx+hex_chars]
  3322 00000C77 A2[2C0F]                	mov	[msgDevId+2], al
  3323 00000C7A 88E3                    	mov	bl, ah
  3324 00000C7C 88DA                    	mov	dl, bl
  3325 00000C7E 80E30F                  	and	bl, 0Fh
  3326 00000C81 8A87[D90E]              	mov	al, [bx+hex_chars]
  3327 00000C85 A2[2B0F]                	mov	[msgDevId+1], al
  3328 00000C88 88D3                    	mov	bl, dl
  3329 00000C8A C0EB04                  	shr	bl, 4
  3330 00000C8D 8A87[D90E]              	mov	al, [bx+hex_chars]
  3331 00000C91 A2[2A0F]                	mov	[msgDevId], al
  3332                                  
  3333 00000C94 668B36[9A0F]            	mov	esi, [bus_dev_fn]
  3334 00000C99 66C1EE08                	shr	esi, 8
  3335 00000C9D 89F0                    	mov	ax, si
  3336 00000C9F 88C3                    	mov	bl, al
  3337 00000CA1 88DA                    	mov	dl, bl
  3338 00000CA3 80E307                  	and	bl, 7 ; bit 0,1,2
  3339 00000CA6 8A87[D90E]              	mov	al, [bx+hex_chars]
  3340 00000CAA A2[510F]                	mov	[msgFncNo+1], al
  3341 00000CAD 88D3                    	mov	bl, dl
  3342 00000CAF C0EB03                  	shr	bl, 3
  3343 00000CB2 88DA                    	mov	dl, bl
  3344 00000CB4 80E30F                  	and	bl, 0Fh
  3345 00000CB7 8A87[D90E]              	mov	al, [bx+hex_chars]
  3346 00000CBB A2[430F]                	mov	[msgDevNo+1], al
  3347 00000CBE 88D3                    	mov	bl, dl
  3348 00000CC0 C0EB04                  	shr	bl, 4
  3349 00000CC3 8A87[D90E]              	mov	al, [bx+hex_chars]
  3350 00000CC7 A2[420F]                	mov	[msgDevNo], al
  3351 00000CCA 88E3                    	mov	bl, ah
  3352 00000CCC 88DA                    	mov	dl, bl
  3353 00000CCE 80E30F                  	and	bl, 0Fh
  3354 00000CD1 8A87[D90E]              	mov	al, [bx+hex_chars]
  3355 00000CD5 A2[370F]                	mov	[msgBusNo+1], al
  3356 00000CD8 88D3                    	mov	bl, dl
  3357 00000CDA C0EB04                  	shr	bl, 4
  3358 00000CDD 8A87[D90E]              	mov	al, [bx+hex_chars]
  3359 00000CE1 A2[360F]                	mov	[msgBusNo], al
  3360                                  
  3361                                  	;mov	ax, [ac97_io_base]
  3362                                  	; 08/05/2024
  3363 00000CE4 A1[860F]                	mov	ax, [NABMBAR]
  3364 00000CE7 88C3                    	mov	bl, al
  3365 00000CE9 88DA                    	mov	dl, bl
  3366 00000CEB 80E30F                  	and	bl, 0Fh
  3367 00000CEE 8A87[D90E]              	mov	al, [bx+hex_chars]
  3368 00000CF2 A2[6A0F]                	mov	[msgIOBaseAddr+3], al
  3369 00000CF5 88D3                    	mov	bl, dl
  3370 00000CF7 C0EB04                  	shr	bl, 4
  3371 00000CFA 8A87[D90E]              	mov	al, [bx+hex_chars]
  3372 00000CFE A2[690F]                	mov	[msgIOBaseAddr+2], al
  3373 00000D01 88E3                    	mov	bl, ah
  3374 00000D03 88DA                    	mov	dl, bl
  3375 00000D05 80E30F                  	and	bl, 0Fh
  3376 00000D08 8A87[D90E]              	mov	al, [bx+hex_chars]
  3377 00000D0C A2[680F]                	mov	[msgIOBaseAddr+1], al
  3378 00000D0F 88D3                    	mov	bl, dl
  3379 00000D11 C0EB04                  	shr	bl, 4
  3380 00000D14 8A87[D90E]              	mov	al, [bx+hex_chars]
  3381 00000D18 A2[670F]                	mov	[msgIOBaseAddr], al
  3382                                  
  3383                                  	; 24/11/2016
  3384 00000D1B 30E4                    	xor	ah, ah
  3385 00000D1D A0[980F]                	mov	al, [ac97_int_ln_reg]
  3386 00000D20 B10A                    	mov	cl, 10
  3387 00000D22 F6F1                    	div	cl
  3388 00000D24 0106[720F]              	add	[msgIRQ], ax
  3389 00000D28 20C0                    	and	al, al
  3390 00000D2A 7508                    	jnz	short _pmi
  3391 00000D2C A0[730F]                	mov	al, [msgIRQ+1]
  3392 00000D2F B420                    	mov	ah, ' '
  3393 00000D31 A3[720F]                	mov	[msgIRQ], ax
  3394                                  _pmi:
  3395 00000D34 BA[EA0E]                        mov	dx, msgAC97Info
  3396 00000D37 B409                            mov     ah, 9
  3397 00000D39 CD21                            int     21h
  3398 00000D3B C3                              retn
  3399                                  
  3400                                  	; 08/05/2024
  3401                                  ac97_stop:
  3402                                  	; 11/11/2023
  3403                                  	; 09/11/2023
  3404                                  	; 05/11/2023
  3405                                  	; 04/11/2023 
  3406                                  	; 28/05/2017 (TRDOS 386 v2, 'audio.s')
  3407                                  	;mov	byte [tLoop], 0 ; stop ! ; 05/11/2023
  3408                                  ;_ac97_stop:
  3409                                  
  3410                                  	; 11/11/2023
  3411 00000D3C 8B16[840F]              	mov	dx, [NAMBAR]
  3412                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  3413 00000D40 EF                      	out	dx, ax
  3414                                  
  3415                                  	; 04/11/2023
  3416                                  	; 09/10/2017 (TRDOS 386 v2, 'audio.s')
  3417                                  	; 11/06/2017
  3418 00000D41 30C0                    	xor	al, al ; 0
  3419 00000D43 E80D00                  	call	ac97_po_cmd
  3420                                  
  3421                                  	; (Ref: KolibriOS, intelac97.asm, 'stop:')
  3422                                  	; Clear FIFOE, BCIS, LVBCI (Ref: Intel ICH hub manual)
  3423 00000D46 B81C00                  	mov     ax, 1Ch
  3424 00000D49 8B16[860F]              	mov     dx, [NABMBAR]
  3425 00000D4D 83C216                  	add     dx, PO_SR_REG
  3426 00000D50 EF                      	out     dx, ax
  3427                                  
  3428                                  	; 11/06/2017
  3429 00000D51 B002                    	mov     al, RR
  3430                                  ac97_po_cmd:
  3431                                  	; 11/06/2017
  3432                                  	; 29/05/2017
  3433 00000D53 8B16[860F]              	mov     dx, [NABMBAR]
  3434 00000D57 83C21B                          add     dx, PO_CR_REG		; PCM out control register
  3435 00000D5A EE                      	out	dx, al
  3436 00000D5B C3                      	retn
  3437                                  
  3438                                  ;=============================================================================
  3439                                  ;               preinitialized data
  3440                                  ;=============================================================================
  3441                                  
  3442                                  ;=============================================================================
  3443                                  ;               PLAY.ASM - DATA
  3444                                  ;=============================================================================
  3445                                  
  3446                                  msg_2017:
  3447 00000D5C 54696E79204D4F4420-     		db	'Tiny MOD Player by Erdogan Tan. May 2024.',10,13
  3447 00000D65 506C61796572206279-
  3447 00000D6E 204572646F67616E20-
  3447 00000D77 54616E2E204D617920-
  3447 00000D80 323032342E0A0D     
  3448 00000D87 75736167653A20706C-     		db	'usage: playmod2 filename.mod', 10, 13, '$'
  3448 00000D90 61796D6F6432206669-
  3448 00000D99 6C656E616D652E6D6F-
  3448 00000DA2 640A0D24           
  3449 00000DA6 31382F30322F323031-     		db	'18/02/2017',0
  3449 00000DAF 3700               
  3450 00000DB1 31332F30352F323032-     		db	'13/05/2024',0
  3450 00000DBA 3400               
  3451                                  
  3452 00000DBC 54696E79204D4F4420-     Credits:	db	'Tiny MOD Player v0.1b by Carlos Hasan. July 1993.'
  3452 00000DC5 506C61796572207630-
  3452 00000DCE 2E3162206279204361-
  3452 00000DD7 726C6F732048617361-
  3452 00000DE0 6E2E204A756C792031-
  3452 00000DE9 3939332E           
  3453                                  CRLF:		; 13/05/2024
  3454 00000DED 0A0D24                  		db	10,13,'$'
  3455 00000DF0 4572726F72206C6F61-     ErrorMesg:	db	'Error loading Module file.',10,13,'$'
  3455 00000DF9 64696E67204D6F6475-
  3455 00000E02 6C652066696C652E0A-
  3455 00000E0B 0D24               
  3456                                  
  3457                                  ;=============================================================================
  3458                                  ;               MODPLAY.ASM - DATA
  3459                                  ;=============================================================================
  3460                                  
  3461                                  ;Credits:	db	'Amiga Module Player v0.3b by Carlos Hasan.'
  3462                                  
  3463 00000E0D 0019324A62788EA2B4-     SinTable:	db	0,25,50,74,98,120,142,162,180,197,212,225
  3463 00000E16 C5D4E1             
  3464 00000E19 ECF4FAFEFFFEFAF4EC-     		db	236,244,250,254,255,254,250,244,236,225
  3464 00000E22 E1                 
  3465 00000E23 D4C5B4A28E78624A32-     		db	212,197,180,162,142,120,98,74,50,25
  3465 00000E2C 19                 
  3466                                  
  3467 00000E2D 58032803FA02D002A6-     PeriodTable:	dw	856,808,762,720,678,640,604,570,538,508,480,453
  3467 00000E36 0280025C023A021A02-
  3467 00000E3F FC01E001C501       
  3468 00000E45 AC0194017D01680153-     		dw	428,404,381,360,339,320,302,285,269,254,240,226
  3468 00000E4E 0140012E011D010D01-
  3468 00000E57 FE00F000E200       
  3469 00000E5D D600CA00BE00B400AA-     		dw	214,202,190,180,170,160,151,143,135,127,120,113
  3469 00000E66 00A00097008F008700-
  3469 00000E6F 7F0078007100       
  3470                                  
  3471                                  ;=============================================================================
  3472                                  ;               PLAYWAV.ASM / PLAYER.ASM - DATA
  3473                                  ;=============================================================================
  3474                                  
  3475                                  ; 24/11/2016
  3476                                  ;	       IRQ  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 
  3477 00000E75 08090A0B0C0D0E0F70-     irq_int:	db 08h,09h,0Ah,0Bh,0Ch,0Dh,0Eh,0Fh,70h,71h,72h,73h,74h,75h,76h,77h
  3477 00000E7E 71727374757677     
  3478                                  
  3479                                  ; 17/02/2017
  3480                                  ; Valid ICH device IDs
  3481                                  
  3482                                  valid_ids:
  3483 00000E85 86801524                dd	(ICH_DID << 16) + INTEL_VID  	 ; 8086h:2415h
  3484 00000E89 86802524                dd	(ICH0_DID << 16) + INTEL_VID 	 ; 8086h:2425h
  3485 00000E8D 86804524                dd	(ICH2_DID << 16) + INTEL_VID 	 ; 8086h:2445h
  3486 00000E91 86808524                dd	(ICH3_DID << 16) + INTEL_VID 	 ; 8086h:2485h
  3487 00000E95 8680C524                dd	(ICH4_DID << 16) + INTEL_VID 	 ; 8086h:24C5h
  3488 00000E99 8680D524                dd	(ICH5_DID << 16) + INTEL_VID 	 ; 8086h:24D5h
  3489 00000E9D 86806E26                dd	(ICH6_DID << 16) + INTEL_VID 	 ; 8086h:266Eh
  3490 00000EA1 8680A625                dd	(ESB6300_DID << 16) + INTEL_VID  ; 8086h:25A6h
  3491 00000EA5 86809826                dd	(ESB631X_DID << 16) + INTEL_VID  ; 8086h:2698h
  3492 00000EA9 8680DE27                dd	(ICH7_DID << 16) + INTEL_VID 	 ; 8086h:27DEh
  3493                                  ; 03/11/2023 - Erdogan Tan
  3494 00000EAD 86809571                dd	(MX82440_DID << 16) + INTEL_VID  ; 8086h:7195h
  3495 00000EB1 39101270                dd	(SI7012_DID << 16)  + SIS_VID	 ; 1039h:7012h
  3496 00000EB5 DE10B101                dd 	(NFORCE_DID << 16)  + NVIDIA_VID ; 10DEh:01B1h
  3497 00000EB9 DE106A00                dd 	(NFORCE2_DID << 16) + NVIDIA_VID ; 10DEh:006Ah
  3498 00000EBD 22106D74                dd 	(AMD8111_DID << 16) + AMD_VID 	 ; 1022h:746Dh
  3499 00000EC1 22104574                dd 	(AMD768_DID << 16)  + AMD_VID 	 ; 1022h:7445h
  3500 00000EC5 DE105900                dd 	(CK804_DID << 16) + NVIDIA_VID	 ; 10DEh:0059h
  3501 00000EC9 DE103A00                dd 	(MCP04_DID << 16) + NVIDIA_VID	 ; 10DEh:003Ah
  3502 00000ECD DE108A00                dd 	(CK8_DID << 16) + NVIDIA_VID	 ; 1022h:008Ah
  3503 00000ED1 DE10DA00                dd 	(NFORCE3_DID << 16) + NVIDIA_VID ; 10DEh:00DAh
  3504 00000ED5 DE10EA00                dd 	(CK8S_DID << 16) + NVIDIA_VID	 ; 10DEh:00EAh
  3505                                  
  3506                                  valid_id_count:	equ ($ - valid_ids)>>2 ; 05/11/2023
  3507                                  
  3508                                  ; 13/11/2016
  3509 00000ED9 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  3509 00000EE2 3941424344454600   
  3510 00000EEA 414339372041756469-     msgAC97Info	db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  3510 00000EF3 6F20436F6E74726F6C-
  3510 00000EFC 6C6572202620436F64-
  3510 00000F05 656320496E666F0D0A 
  3511 00000F0E 56656E646F72204944-     		db "Vendor ID: "
  3511 00000F17 3A20               
  3512 00000F19 303030306820446576-     msgVendorId	db "0000h Device ID: "
  3512 00000F22 6963652049443A20   
  3513 00000F2A 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  3514 00000F31 4275733A20              		db "Bus: "
  3515 00000F36 303068204465766963-     msgBusNo	db "00h Device: "
  3515 00000F3F 653A20             
  3516 00000F42 3030682046756E6374-     msgDevNo	db "00h Function: "
  3516 00000F4B 696F6E3A20         
  3517 00000F50 303068                  msgFncNo	db "00h"
  3518 00000F53 0D0A                    		db 0Dh, 0Ah
  3519 00000F55 492F4F204261736520-     		db "I/O Base Address: "
  3519 00000F5E 416464726573733A20 
  3520 00000F67 303030306820495251-     msgIOBaseAddr	db "0000h IRQ: "
  3520 00000F70 3A20               
  3521 00000F72 3030                    msgIRQ		dw 3030h
  3522 00000F74 0D0A24                  		db 0Dh, 0Ah, "$"
  3523                                  
  3524                                  ;msgSampleRate	db "Sample Rate: "
  3525                                  ;msgHertz	db "00000 Hz ", "$" 
  3526                                  ;msg8Bits	db "8 bits ", "$" 
  3527                                  ;msgMono	db "Mono", 0Dh, 0Ah, "$"
  3528                                  ;msg16Bits	db "16 bits ", "$" 
  3529                                  ;msgStereo	db "Stereo", 0Dh, 0Ah, "$"
  3530                                  
  3531                                  ;; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
  3532                                  ;codec_id	dd 0
  3533                                  ;codec_chip_id	dd 0
  3534                                  ;codec_vendor_ids dw 0
  3535                                  ;codec_chip_ids	dw 0
  3536                                  
  3537 00000F77 3030303030303030        dword_str	 dd 30303030h, 30303030h
  3538 00000F7F 680D0A00                		 db 'h', 0Dh, 0Ah, 0
  3539                                  
  3540                                  ;=============================================================================
  3541                                  ;        	uninitialized data
  3542                                  ;=============================================================================
  3543                                  
  3544                                  bss_start:
  3545                                  
  3546                                  ABSOLUTE bss_start
  3547                                  
  3548 00000F83 ??                      alignb 4
  3549                                  
  3550                                  ; 17/02/2017
  3551                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  3552                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  3553                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  3554                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  3555 00000F84 ????                    NAMBAR:		resw 1			; BAR for mixer
  3556 00000F86 ????                    NABMBAR         resw 1			; BAR for bus master regs
  3557                                  
  3558 00000F88 ??                      tBuff:		resb	1
  3559                                  ;irq_status:	resb 	1
  3560 00000F89 ??                      pcm_irq_status:	resb	1 ; 08/05/2024
  3561                                  
  3562 00000F8A ??                      inside:		resb	1 
  3563 00000F8B ??                      tLoop:		resb 	1
  3564                                  
  3565                                  ; 08/05/2024
  3566 00000F8C ????                    IRQ_status:	resw 1	; IRQ status before enabling audio interrupt
  3567 00000F8E ????????                IRQ_vector:	resd 1  ; Previous interrupt handler address	
  3568                                  
  3569                                  ; 256 byte buffer for descriptor list
  3570 00000F92 ????                    BDL_BUFFER:	resw	1		; segment of our 256byte BDL buffer
  3571 00000F94 ????                    DMA_BUFFER1:	resw 	1		; Pointer to 1st half of DMA Buffer
  3572 00000F96 ????                    DMA_BUFFER2:	resw	1		; Pointer to 1st half of DMA Buffer
  3573                                  
  3574                                  ; 12/11/2016 - Erdogan Tan
  3575                                  
  3576 00000F98 ??                      ac97_int_ln_reg: resb 1 
  3577 00000F99 ??                      err_num:	resb 1
  3578                                  
  3579 00000F9A ????????                bus_dev_fn:	resd 1
  3580 00000F9E ????????                dev_vendor:	resd 1
  3581                                  ; 08/05/2024
  3582                                  ;stats_cmd:	resd 1
  3583                                  ;ac97_io_base:	resw 1
  3584 00000FA2 ??                      LVI:		resb 1
  3585                                  ; 12/05/2024
  3586 00000FA3 ??                      volume:		resb 1
  3587                                  
  3588                                  alignb 4
  3589                                  
  3590 00000FA4 <res 100h>              BdlBuffer:	resb	BDL_SIZE ; 13/02/2017
  3591 000010A4 <res 4000h>             DmaBuffer:	resb	2*BUFFERSIZE ; 13/02/2017
  3592                                  
  3593                                  ; MODLOAD.ASM
  3594 000050A4 ????                    FileHandle:	resw	1
  3595 000050A6 ????                    ErrorInfo:	resw	1
  3596 000050A8 <res 43Ch>              Header:		resb	ModHeader.size
  3597                                  
  3598                                  sample_rate: ; PLAYER.ASM (22050Hz)
  3599                                  ; MODPLAY.ASM
  3600 000054E4 ????                    MixSpeed:	resw 1
  3601                                  
  3602                                  ModInfo:
  3603 000054E6 ??                      ModInfo.OrderLen:   resb 1
  3604 000054E7 ??                      ModInfo.ReStart:    resb 1
  3605 000054E8 <res 80h>               ModInfo.Order:	    resb 128
  3606 00005568 ????????                ModInfo.Patterns:   resd 1
  3607                                  
  3608 0000556C <res 3Eh>               ModInfo.SampOfs:    resw 31
  3609 000055AA <res 3Eh>               ModInfo.SampSeg:    resw 31
  3610 000055E8 <res 3Eh>               ModInfo.SampLen:    resw 31
  3611 00005626 <res 3Eh>               ModInfo.SampRep:    resw 31
  3612 00005664 <res 3Eh>               ModInfo.SampRepLen: resw 31
  3613 000056A2 <res 3Eh>               ModInfo.SampVol:    resw 31
  3614                                  
  3615                                  ; MODPLAY.ASM
  3616 000056E0 <res 6B2h>              PitchTable:	resw	857
  3617 00005D92 <res 4100h>             VolTable:	resb	16640
  3618 00009E92 <res 1000h>             MixBuffer       resb	MixBufSize
  3619                                  
  3620                                  ; MODPLAY.ASM
  3621 0000AE92 ??                      OrderPos:	resb 1
  3622 0000AE93 ??                      Tempo:		resb 1
  3623 0000AE94 ??                      TempoWait:	resb 1
  3624 0000AE95 ??                      Bpm:		resb 1
  3625 0000AE96 ??                      Row:		resb 1
  3626 0000AE97 ??                      BreakRow:	resb 1
  3627 0000AE98 ????                    BpmSamples:	resw 1
  3628 0000AE9A ????                    BufPtr:		resw 1
  3629 0000AE9C ????                    BufLen:		resw 1
  3630 0000AE9E ????                    BufRep:		resw 1
  3631 0000AEA0 ????????                Note:		resd 1
  3632 0000AEA4 <res 88h>               Tracks:		resb TrackInfo.size*NumTracks
  3633                                  
  3634 0000AF2C ????????                alignb 16
  3635                                  
  3636                                  ; PLAY.ASM
  3637 0000AF30 <res 280h>              Scope:		resw	320
  3638 0000B1B0 <res 200h>              RowOfs:		resw	256
  3639                                  
  3640                                  ; 18/02/2017
  3641 0000B3B0 ????                    _si_:		resw 1
  3642 0000B3B2 <res 800h>              MOD_BUFFER:	resb BUFFERSIZE/4 ; 2048 ; 11/05/2024
  3643                                  EOF:
