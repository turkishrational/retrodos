     1                                  ; ****************************************************************************
     2                                  ; playmod2.asm (for MSDOS)
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; PLAYMOD2.COM ! ICH AC97 MOD PLAYER & VGA DEMO program by Erdogan TAN
     5                                  ;
     6                                  ; 18/02/2017
     7                                  ;
     8                                  ; [ Last Modification: 19/05/2024 ]
     9                                  ;
    10                                  ; Derived from source code of 'PLAYWAV.COM' ('PLAYWAV.ASM') by Erdogan Tan
    11                                  ;							      (17/02/2017)
    12                                  ; Modified from 'PLAYMOD.COM' ('playmod.asm') source code 
    13                                  ;		 VIA VT8237 MOD PLAYER & VGA DEMO program by Erdogan TAN
    14                                  ;							     (15/02/2017)	
    15                                  ;
    16                                  ; Derived from source code of 'PLAY.EXE' (TINYPLAY) by Carlos Hasan (1993)
    17                                  ;          PLAY.EXE: PLAY.ASM, MODLOAD.ASM, MODPLAY.ASM, SB.ASM
    18                                  ;
    19                                  ; Assembler: NASM 2.11
    20                                  ; ----------------------------------------------------------------------------
    21                                  ;	   nasm  playmod2.asm -l playmod2.lst -o PLAYMOD2.COM	
    22                                  ; ****************************************************************************
    23                                  
    24                                  ; Tiny MOD Player v0.1b by Carlos Hasan.
    25                                  ;		July 14th, 1993.
    26                                  
    27                                  ;=============================================================================
    28                                  ;               PLAYWAV.ASM / PLAYER.ASM / TINYPLAY.ASM
    29                                  ;=============================================================================
    30                                  ; Audio controller, codec & PCI functions are derived from '.wav file player 
    31                                  ; for DOS' source code by Jeff Leyda (PLAYER.EXE), Sep 02, 2002.
    32                                  
    33                                  ; TUNELOOP version ; 12/05/2024
    34                                  
    35                                  [BITS 16]
    36                                  [org 100h]
    37                                  
    38                                  Start:
    39 00000000 E8CC00                  	call    DetectICH		; Detect AC97 Audio Device
    40                                  GetFileName:    			; Parse  the Command line...
    41 00000003 BE8000                  	mov	si, 80h
    42 00000006 8A1C                    	mov	bl, [si]
    43 00000008 30FF                    	xor	bh, bh
    44 0000000A 43                      	inc	bx
    45 0000000B C60000                  	mov	byte [si+bx], 0		; make AsciiZ filename.
    46 0000000E 46                      	inc	si
    47                                  ScanName:       
    48 0000000F AC                      	lodsb
    49 00000010 84C0                    	test	al, al
    50 00000012 0F84AF00                	je	pmsg_2017
    51 00000016 3C20                    	cmp	al, 20h
    52 00000018 74F5                    	je	short ScanName		; scan start of name.
    53 0000001A 89F7                    	mov	di, si
    54 0000001C 4F                      	dec	di
    55                                  ScanPeriod:
    56 0000001D AC                      	lodsb
    57 0000001E 3C2E                    	cmp	al, '.'			; if period NOT found,
    58 00000020 7410                    	je	short PrintMesg		; then add a .MOD extension.
    59 00000022 84C0                    	test	al, al
    60 00000024 75F7                    	jnz	short ScanPeriod
    61 00000026 4E                      	dec	si
    62                                  SetExt:
    63                                  	;mov	byte [si+0], '.'
    64                                  	;mov	byte [si+1], 'M'
    65                                  	;mov	byte [si+2], 'O'
    66                                  	;mov	byte [si+3], 'D'
    67 00000027 66C7042E4D4F44          	mov	dword [si], '.MOD'
    68 0000002E C6440400                	mov	byte [si+4], 0
    69                                  
    70                                  PrintMesg:
    71 00000032 B80009                  	mov	ax, 0900h		; Prints the Credits Text.
    72                                  	;lea	dx, [Credits]
    73 00000035 BA[0B0E]                	mov	dx, Credits
    74 00000038 CD21                    	int	21h
    75                                  
    76                                  	; 13/05/2024
    77 0000003A E82F0C                  	call	write_ac97_dev_info
    78 0000003D B80009                  	mov	ax, 0900h		; Prints the Credits Text.
    79 00000040 BA[3C0E]                	mov	dx, CRLF
    80 00000043 CD21                    	int	21h
    81                                  LoadMod:  
    82                                  	; es:di = Filename address
    83 00000045 06                      	push	es
    84 00000046 57                      	push	di
    85 00000047 E84705                  	call    LoadModule		; Load the MODule...
    86                                  
    87 0000004A 833E[F660]00            	cmp     word [ErrorInfo], 0	; any error loading?
    88 0000004F 740A                    	je      short init_codec
    89                                  
    90 00000051 B80009                  	mov     ax, 0900h		; yes, print error and Exit.
    91                                  	;lea    dx, [ErrorMesg]
    92 00000054 BA[3F0E]                	mov	dx, ErrorMesg
    93 00000057 CD21                    	int     21h
    94 00000059 EB63                    	jmp     Exit
    95                                  
    96                                  init_codec:
    97                                  	; 13/05/2024
    98                                  	;call	write_ac97_dev_info
    99                                  
   100                                  	; 08/05/2024
   101                                  	; 17/02/2017
   102                                  	;mov	dx, [stats_cmd]
   103                                          ;or	dl, IO_ENA+BM_ENA		; enable IO and bus master
   104                                          ;call	pciRegWrite16 ; pciRegWrite8
   105                                  
   106                                  	; 18/02/2017
   107                                  	;mov	word [sample_rate], 22050	; Mixing at 22.050 kHz
   108                                  	; 14/05/2024
   109 0000005B C706[3465]C05D          	mov	word [sample_rate], 24000
   110                                  
   111                                  	; 08/05/2024
   112                                  	; (48 kHZ mixing is necessary 
   113                                  	;  if the AC97 hardware/codec has not got VRA feature)
   114                                  	; ((or frequency converting code would be needed))
   115                                  	;mov	word [sample_rate], 48000	; Mixing at 48 kHz
   116                                  
   117                                  ; setup the Codec (actually mixer registers)
   118 00000061 E8FD01                          call    codecConfig			; unmute codec, set rates.
   119 00000064 731A                    	jnc	short PlayNow
   120                                  
   121                                  _codec_err:
   122 00000066 0E                      	push	cs
   123 00000067 1F                      	pop	ds
   124 00000068 BA[7100]                        mov	dx, CodecErrMsg
   125 0000006B B409                            mov     ah, 9
   126 0000006D CD21                            int     21h
   127 0000006F EB4D                            jmp     Exit
   128                                  
   129 00000071 436F64656320457272-     CodecErrMsg db "Codec Error!"
   129 0000007A 6F7221             
   130 0000007D 0D0A24                  	db	CR,LF,"$"
   131                                  PlayNow:  
   132 00000080 B8[F40F]                	mov	ax, BdlBuffer
   133 00000083 A3[E20F]                	mov	[BDL_BUFFER], ax
   134                                      
   135 00000086 B8[F410]                	mov	ax, DmaBuffer		; DmaBuffer (4096 bytes) buff addr
   136 00000089 A3[E40F]                	mov	[DMA_BUFFER1], ax	; 2048 byte half buffer 1 
   137                                  
   138 0000008C 050028                  	add	ax, BUFFERSIZE		; code/current segment
   139 0000008F A3[E60F]                	mov	[DMA_BUFFER2], ax	; 2048 byte half buffer 2
   140                                    
   141                                  	;mov    word [MixSpeed], 22050	; Mixing at 22.050 kHz
   142                                  
   143 00000092 E8CA0A                  	call    StartPlaying
   144                                  
   145 00000095 B81300                  	mov     ax, 0013h		; Set Mode 320x200x256
   146 00000098 CD10                    	int     10h
   147                                  
   148 0000009A B98000                  	mov     cx, 128			; Make a lookup table
   149 0000009D 31DB                    	xor     bx, bx			; for fastest pixel
   150 0000009F BA002D                  	mov     dx, 320*(100-64)	; addressing.
   151                                  MakeOfs:        
   152 000000A2 8997[00C2]              	mov     [RowOfs+bx], dx
   153 000000A6 8997[02C2]              	mov     [RowOfs+bx+2], dx
   154 000000AA 81C24001                	add     dx, 320
   155 000000AE 83C304                  	add     bx, 4
   156 000000B1 E2EF                    	loop    MakeOfs
   157                                  
   158                                  ; Note: Normally IRQ 0 calls the ModPlay Polling at 18.2Hz thru
   159                                  ;       the software interrupt 1Ch. If the IRQ 0 is disabled, then
   160                                  ;       the INT 1Ch MUST BE CALLED at least MixSpeed/1024 times per
   161                                  ;       second, or the module will sound "looped".
   162                                  ;       Because we need better sync with the ModPlayer to draw the scope,
   163                                  ;       the polling is called from my routine, and then the irq 0 must be
   164                                  ;       disabled. The [DmaBuffer] points to the current buffer of 8-bit
   165                                  ;       samples played by the Sound Blaster. Note that some samples are
   166                                  ;       discarded in the next code, just for fun!
   167                                  
   168                                  	;in	al, 21h			; disable irq 0!
   169                                  	;or	al, 00000001b
   170                                  	;out	21h, al
   171                                  		
   172 000000B3 E87203                  	call	ModPlay ; 13/02/2017
   173                                  
   174                                  	;in	al, 21h			; enable irq 0!
   175                                  	;and	al, 11111110b
   176                                  	;out	21h, al
   177                                  
   178 000000B6 B80300                  	mov     ax, 0003h		; Set Text Mode 80x25x16
   179 000000B9 CD10                    	int     10h
   180                                  
   181 000000BB E8220B                  	call	StopPlaying		; STOP!
   182                                  Exit:           
   183                                  	;call   FreeModule		; Free MODule core.
   184                                  error_exit:
   185 000000BE B8004C                  	mov     ax, 4C00h		; Bye!
   186 000000C1 CD21                    	int     21h
   187                                  here:
   188 000000C3 EBFE                    	jmp	short here
   189                                  
   190                                  pmsg_2017:
   191 000000C5 B80009                  	mov     ax, 0900h		; Prints the Credits Text.
   192                                  	;lea    dx, [msg_2017]
   193 000000C8 BA[AB0D]                	mov	dx, msg_2017
   194 000000CB CD21                    	int     21h
   195 000000CD EBEF                    	jmp	short Exit
   196                                  
   197                                  DetectICH:
   198                                  	; 18/02/2017
   199                                  	; Detech Intel ICH based AC97 Audio Device 
   200 000000CF E84E01                  	call    pciFindDevice 	; AC97.ASM (PLAYWAV.COM)
   201 000000D2 733F                            jnc     short _1
   202                                  
   203                                  ; couldn't find the audio device!
   204                                  	;push	cs
   205                                  	;pop	ds
   206 000000D4 BA[DD00]                        mov     dx, noDevMsg
   207 000000D7 B409                            mov     ah, 9
   208 000000D9 CD21                            int     21h
   209 000000DB EBE1                            jmp     short error_exit
   210                                  
   211 000000DD 4572726F723A20556E-     noDevMsg db "Error: Unable to find Intel ICH based audio device!",CR,LF,"$"
   211 000000E6 61626C6520746F2066-
   211 000000EF 696E6420496E74656C-
   211 000000F8 204943482062617365-
   211 00000101 6420617564696F2064-
   211 0000010A 6576696365210D0A24 
   212                                  
   213                                  _1:
   214                                  	; 18/02/2017
   215                                  	; eax = BUS/DEV/FN
   216                                  	;	00000000BBBBBBBBDDDDDFFF00000000
   217                                  	; edx = DEV/VENDOR
   218                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
   219                                  
   220 00000113 66A3[EA0F]              	mov	[bus_dev_fn], eax
   221 00000117 668916[EE0F]            	mov	[dev_vendor], edx
   222                                  
   223                                  	; get ICH base address regs for mixer and bus master
   224                                  
   225 0000011C B010                            mov     al, NAMBAR_REG
   226 0000011E E87100                          call    pciRegRead16			; read PCI registers 10-11
   227                                          ;and    dx, IO_ADDR_MASK 		; mask off BIT0
   228                                  	; 14/05/2024
   229 00000121 80E2FE                  	and	dl, 0FEh
   230                                  
   231 00000124 8916[D40F]                      mov     [NAMBAR], dx			; save audio mixer base addr
   232                                  
   233 00000128 B014                    	mov     al, NABMBAR_REG
   234 0000012A E86500                          call    pciRegRead16
   235                                          ;and    dx, IO_ADDR_MASK
   236                                  	;/14/05/2024
   237 0000012D 80E2C0                  	and	dl, 0C0h
   238                                  
   239 00000130 8916[D60F]                      mov     [NABMBAR], dx			; save bus master base addr
   240                                  
   241                                  	; 08/05/2024
   242                                  	; 06/11/2023
   243                                  	;; init controller
   244                                  	;; 17/02/2017
   245                                  	;mov	al, PCI_CMD_REG ; command register (04h)
   246                                  	;call	pciRegRead16 ; pciRegRead8
   247                                  	;
   248                                  	;; eax = BUS/DEV/FN/REG
   249                                  	;;  dx = PCI Command Register Content ; 17/02/2017
   250                                  	;; 	00000000CCCCCCCC
   251                                  	;mov	[stats_cmd], dx
   252                                  	;
   253                                  	; 06/11/2023
   254                                  	;mov	al, PCI_IO_BASE ; IO base address register (10h)
   255                                  	;call	pciRegRead32
   256                                  	;
   257                                  	;and	dx, 0FFC0h	; IO_ADDR_MASK (0FFFE) ?
   258                                          ;mov	[ac97_io_base], dx
   259                                  
   260 00000134 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
   261 00000136 E85100                  	call	pciRegRead8 ; 17/02/2017
   262                                  
   263 00000139 8816[E80F]              	mov     [ac97_int_ln_reg], dl
   264                                  
   265                                  ; 12/05/2024 (tuneloop version)
   266                                  %if 0
   267                                  	; 28/11/2016
   268                                  	;mov	bx, 1	; 08/05/2024
   269                                  	xor	dh, dh	; 17/02/2017
   270                                  	; 10/11/2023
   271                                  	;mov	cx, dx
   272                                  	;shl	bx, cl
   273                                  
   274                                  	; 04/11/2023
   275                                  	cli
   276                                  
   277                                  	;not	bx
   278                                  	in	al, 0A1h ; irq 8-15
   279                                          mov	ah, al
   280                                          in	al, 21h  ; irq 0-7
   281                                  
   282                                  	; 04/11/2023
   283                                  	; save IRQ status
   284                                  	mov	[IRQ_status], ax
   285                                  
   286                                  	; 08/05/2024
   287                                  	;mov	dx, 4D1h			;8259 ELCR1
   288                                          ;in	al, dx
   289                                  	;mov	ah, al
   290                                  	;mov	dx, 4D0h 
   291                                          ;in	al, dx
   292                                  	;;or	ax, bx        
   293                                  	;bts	ax, cx
   294                                  	;mov	dx, 4D0h
   295                                  	;out	dx, al                          ;set level-triggered mode
   296                                  	;mov	al, ah
   297                                  	;mov	dx, 4D1h
   298                                  	;out	dx, al                          ;set level-triggered mode
   299                                  
   300                                  	; 24/11/2016 - Erdogan Tan
   301                                  	;mov	bx, cx
   302                                  	; 10/11/2023
   303                                  	mov	bx, dx
   304                                  	mov	bl, [bx+irq_int]
   305                                  	shl	bx, 2 ; * 4
   306                                  
   307                                  	; set up interrupt vector
   308                                  	; 30/11/2016
   309                                  	push	es
   310                                  	xor	ax, ax
   311                                  	mov	es, ax
   312                                  	; 04/11/2023
   313                                  	; save interrupt vector
   314                                  	mov	ax, [es:bx]
   315                                  	mov	[IRQ_vector], ax
   316                                  	mov	ax, [es:bx+2]
   317                                  	mov	[IRQ_vector+2], ax
   318                                  
   319                                  	mov	word [es:bx], ac97_int_handler
   320                                  	mov	ax, cs
   321                                  	mov	[es:bx+2], ax
   322                                  	pop	es
   323                                  
   324                                  	; 04/11/2023
   325                                  	sti
   326                                  %endif
   327 0000013D C3                      	retn
   328                                  
   329                                  ; 12/05/2024 (tuneloop version)
   330                                  %if 0
   331                                  
   332                                  ac97_int_handler:
   333                                  	; 11/05/2024
   334                                  	; 11/11/2023
   335                                  	; 10/11/2023
   336                                  	; 17/02/2016
   337                                  	push	eax	; 11/11/2023
   338                                  	push	dx
   339                                  	; 05/11/2023
   340                                  	;push	cx
   341                                  	;push	bx
   342                                  	;push	si
   343                                  	;push	di
   344                                  
   345                                  	; 10/11/2023
   346                                  	; EOI at first
   347                                  	mov	al, 20h
   348                                  	test	byte [ac97_int_ln_reg], 8
   349                                  	jz	short _ih_0
   350                                  	out 	0A0h, al ; 20h	; EOI
   351                                  _ih_0:
   352                                  	out	20h, al  ; 20h	; EOI
   353                                  
   354                                  	; 11/11/2023
   355                                  	; 09/11/2023
   356                                  	mov	dx, GLOB_STS_REG
   357                                          add	dx, [NABMBAR]
   358                                  	in	eax, dx
   359                                  	
   360                                  	; 12/05/2024
   361                                  	; 09/11/2023,
   362                                          ;cmp	eax, 0FFFFFFFFh ; -1
   363                                  	;je	short _ih_2
   364                                  	
   365                                  	; 12/05/2024
   366                                  	;test	al, 40h		; PCM Out Interrupt
   367                                  	;jnz	short _ih_1
   368                                  
   369                                  	;test	eax, eax
   370                                  	;jz	short _ih_2
   371                                  	; 12/05/2024
   372                                  	test	ax, PCM_OUT_IRQ+BCIS
   373                                  	jnz	short _ih_1
   374                                  
   375                                   	;mov	dx, GLOB_STS_REG
   376                                          ;add	dx, [NABMBAR]
   377                                  	out	dx, eax
   378                                  	jmp	short _ih_2
   379                                  
   380                                  	; .....
   381                                  	;mov	al, 1
   382                                  	; 10/11/2023
   383                                  	;mov	[tLoop], al  ; 1
   384                                  
   385                                  	;cmp	[inside], al ; 1
   386                                  	;jnb	short _ih_3	; busy
   387                                  
   388                                  	;mov	[inside], al ; 1
   389                                  	;
   390                                  	;; 09/11/2023
   391                                          ;mov	dx, [NABMBAR]
   392                                          ;add	dx, PO_SR_REG	; set pointer to Status reg
   393                                  	;in	al, dx
   394                                  	;; 10/11/2023
   395                                  	;;;out	dx, eax
   396                                  	;;out	dx, al		; clear interrupt event
   397                                  	;			; (by writing 1 to same bits)
   398                                  	;
   399                                  	;;mov	[pcm_irq_status], al ; 05/11/2023
   400                                  	;test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
   401                                  	;jz	short _ih_2
   402                                  	; .....
   403                                  
   404                                  _ih_1:
   405                                  	; 11/11/2023
   406                                  	push	eax
   407                                  
   408                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   409                                  	;mov	dx, PO_SR_REG
   410                                          ;add	dx, [NABMBAR]
   411                                  	;out	dx, ax
   412                                  
   413                                  	; 10/11/2023
   414                                  	; 28/11/2016 - Erdogan Tan
   415                                  	call	tuneLoop
   416                                  
   417                                  	; 11/11/2023
   418                                  	pop	eax
   419                                  	mov	dx, GLOB_STS_REG
   420                                          add	dx, [NABMBAR]
   421                                  	out	dx, eax
   422                                  _ih_2:
   423                                  	; 11/11/2023
   424                                  	mov	dx, [NABMBAR]
   425                                  	add	dx, PO_SR_REG	; set pointer to Status reg
   426                                  	mov	ax, 1Ch
   427                                  	out	dx, ax
   428                                  
   429                                  ;	; 10/11/2023
   430                                  ;	mov	al, 20h
   431                                  ;	test	byte [ac97_int_ln_reg], 8
   432                                  ;	jz	short _ih_3
   433                                  ;	out 	0A0h, al ; 20h	; EOI
   434                                  ;_ih_3:
   435                                  ;	out	20h, al  ; 20h	; EOI
   436                                  ;_ih_4:
   437                                  	;mov	byte [inside], 0
   438                                  	;pop	di
   439                                  	;pop	si
   440                                  	;pop	bx
   441                                  	;pop	cx
   442                                  	pop	dx
   443                                  	pop	eax ; 11/11/2023
   444                                  	iret
   445                                  
   446                                  %endif
   447                                  
   448                                  ;=============================================================================
   449                                  ;               PCI.ASM
   450                                  ;=============================================================================
   451                                  
   452                                  ; EQUATES
   453                                  
   454                                  ;constants of stuff that seem hard to remember at times.
   455                                  
   456                                  TRUE  EQU 1
   457                                  FALSE EQU 0
   458                                  
   459                                  ENABLED  EQU 1
   460                                  DISABLED EQU 0
   461                                  
   462                                  BIT0  EQU 1
   463                                  BIT1  EQU 2
   464                                  BIT2  EQU 4
   465                                  BIT3  EQU 8
   466                                  BIT4  EQU 10h
   467                                  BIT5  EQU 20h
   468                                  BIT6  EQU 40h
   469                                  BIT7  EQU 80h
   470                                  BIT8  EQU 100h
   471                                  BIT9  EQU 200h
   472                                  BIT10 EQU 400h
   473                                  BIT11 EQU 800h
   474                                  BIT12 EQU 1000h
   475                                  BIT13 EQU 2000h
   476                                  BIT14 EQU 4000h
   477                                  BIT15 EQU 8000h
   478                                  BIT16 EQU 10000h
   479                                  BIT17 EQU 20000h
   480                                  BIT18 EQU 40000h
   481                                  BIT19 EQU 80000h
   482                                  BIT20 EQU 100000h
   483                                  BIT21 EQU 200000h
   484                                  BIT22 EQU 400000h
   485                                  BIT23 EQU 800000h
   486                                  BIT24 EQU 1000000h
   487                                  BIT25 EQU 2000000h
   488                                  BIT26 EQU 4000000h
   489                                  BIT27 EQU 8000000h
   490                                  BIT28 EQU 10000000h
   491                                  BIT29 EQU 20000000h
   492                                  BIT30 EQU 40000000h
   493                                  BIT31 EQU 80000000h
   494                                  
   495                                  ;special characters
   496                                  NUL     EQU 0
   497                                  NULL    EQU 0
   498                                  BELL    EQU 07
   499                                  BS      EQU 08
   500                                  TAB     EQU 09
   501                                  LF      EQU 10
   502                                  CR      EQU 13
   503                                  ESCAPE  EQU 27           ;ESC is a reserved word....
   504                                  
   505                                  
   506                                  ;file stuff
   507                                  READONLY  EQU   BIT0
   508                                  HIDDEN    EQU   BIT1
   509                                  SYSTEM    EQU   BIT2
   510                                  VOLUME    EQU   BIT3         ;ignored for file access
   511                                  DIRECTORY EQU   BIT4         ;must be 0 for file access
   512                                  ARCHIVE   EQU   BIT5
   513                                  SHAREABLE EQU   BIT7         ;for novell networks
   514                                  OPEN	EQU	2		; open existing file
   515                                  CREATE	EQU	1		; create new file
   516                                  
   517                                  
   518                                  ; PCI equates
   519                                  ; PCI function address (PFA)
   520                                  ; bit 31 = 1
   521                                  ; bit 23:16 = bus number     (0-255)
   522                                  ; bit 15:11 = device number  (0-31)
   523                                  ; bit 10:8 = function number (0-7)
   524                                  ; bit 7:0 = register number  (0-255)
   525                                  
   526                                  IO_ADDR_MASK    EQU     0FFFEh          ; mask off bit 0 for reading BARs
   527                                  PCI_INDEX_PORT  EQU     0CF8h
   528                                  PCI_DATA_PORT   EQU     0CFCh
   529                                  PCI32           EQU     BIT31           ; bitflag to signal 32bit access
   530                                  PCI16           EQU     BIT30           ; bitflag for 16bit access
   531                                  
   532                                  PCI_FN0         EQU     0 << 8
   533                                  PCI_FN1         EQU     1 << 8
   534                                  PCI_FN2         EQU     2 << 8
   535                                  PCI_FN3         EQU     3 << 8
   536                                  PCI_FN4         EQU     4 << 8
   537                                  PCI_FN5         EQU     5 << 8
   538                                  PCI_FN6         EQU     6 << 8
   539                                  PCI_FN7         EQU     7 << 8
   540                                  
   541                                  PCI_CMD_REG		EQU	04h		; reg 04, command reg
   542                                   IO_ENA			EQU	BIT0		; i/o decode enable
   543                                   MEM_ENA		EQU	BIT1		; memory decode enable
   544                                   BM_ENA                 EQU     BIT2		; bus master enable
   545                                  
   546                                  ; CODE
   547                                  
   548                                  ; AC97.ASM
   549                                  ; PCI device register reader/writers.
   550                                  ; NASM version: Erdogan Tan (29/11/2016)
   551                                  ; 		Last Update: 17/02/2017
   552                                  
   553                                  ;===============================================================
   554                                  ; 8/16/32bit PCI reader
   555                                  ;
   556                                  ; Entry: EAX=PCI Bus/Device/fn/register number
   557                                  ;           BIT30 set if 32 bit access requested
   558                                  ;           BIT29 set if 16 bit access requested
   559                                  ;           otherwise defaults to 8bit read
   560                                  ;
   561                                  ; Exit:  DL,DX,EDX register data depending on requested read size
   562                                  ;
   563                                  ; Note: this routine is meant to be called via pciRegRead8, pciRegread16,
   564                                  ;	or pciRegRead32, listed below.
   565                                  ;
   566                                  ; Note2: don't attempt to read 32bits of data from a non dword aligned reg
   567                                  ;	 number.  Likewise, don't do 16bit reads from non word aligned reg #
   568                                  ; 
   569                                  pciRegRead:
   570 0000013E 6653                    	push	ebx
   571 00000140 51                      	push	cx
   572 00000141 6689C3                          mov     ebx, eax                        ; save eax, dh
   573 00000144 88F1                            mov     cl, dh
   574 00000146 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   575 0000014C 660D00000080                    or      eax, BIT31                      ; make a PCI access request
   576 00000152 24FC                            and     al, ~3 ; NOT 3                  ; force index to be dword
   577                                  
   578 00000154 BAF80C                          mov     dx, PCI_INDEX_PORT
   579 00000157 66EF                            out     dx, eax                         ; write PCI selector
   580                                  
   581 00000159 BAFC0C                          mov     dx, PCI_DATA_PORT
   582 0000015C 88D8                            mov     al, bl
   583 0000015E 2403                            and     al, 3                           ; figure out which port to
   584 00000160 00C2                            add     dl, al                          ; read to
   585                                  
   586 00000162 66ED                    	in      eax, dx                         ; do 32bit read
   587 00000164 66F7C300000080                  test    ebx, PCI32
   588 0000016B 7403                            jz      short _pregr1
   589                                  
   590 0000016D 6689C2                          mov     edx, eax                        ; return 32bits of data
   591                                  _pregr1:
   592 00000170 89C2                    	mov     dx, ax                          ; return 16bits of data
   593 00000172 66F7C3000000C0                  test    ebx, PCI32+PCI16
   594 00000179 7502                            jnz     short _pregr2
   595 0000017B 88CE                            mov     dh, cl                          ; restore dh for 8 bit read
   596                                  _pregr2:
   597 0000017D 6689D8                          mov     eax, ebx                        ; restore eax
   598 00000180 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   599 00000186 59                      	pop	cx
   600 00000187 665B                    	pop	ebx
   601 00000189 C3                      	retn
   602                                  
   603                                  pciRegRead8:
   604 0000018A 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32             ; set up 8 bit read size
   605 00000190 EBAC                            jmp     short pciRegRead		; call generic PCI access
   606                                  
   607                                  pciRegRead16:
   608 00000192 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 16 bit read size
   609 00000198 660D00000040                    or      eax, PCI16			; call generic PCI access
   610 0000019E EB9E                            jmp     short pciRegRead
   611                                  
   612                                  pciRegRead32:
   613 000001A0 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 32 bit read size
   614 000001A6 660D00000080                    or      eax, PCI32			; call generic PCI access
   615 000001AC EB90                            jmp     short pciRegRead
   616                                  
   617                                  ;===============================================================
   618                                  ; 8/16/32bit PCI writer
   619                                  ;
   620                                  ; Entry: EAX=PCI Bus/Device/fn/register number
   621                                  ;           BIT31 set if 32 bit access requested
   622                                  ;           BIT30 set if 16 bit access requested
   623                                  ;           otherwise defaults to 8bit read
   624                                  ;        DL/DX/EDX data to write depending on size
   625                                  ;
   626                                  ;
   627                                  ; note: this routine is meant to be called via pciRegWrite8, pciRegWrite16,
   628                                  ; 	or pciRegWrite32 as detailed below.
   629                                  ;
   630                                  ; Note2: don't attempt to write 32bits of data from a non dword aligned reg
   631                                  ;	 number.  Likewise, don't do 16bit writes from non word aligned reg #
   632                                  ;
   633                                  pciRegWrite:
   634 000001AE 6653                    	push	ebx
   635 000001B0 51                      	push	cx
   636 000001B1 6689C3                          mov     ebx, eax                        ; save eax, dx
   637 000001B4 89D1                            mov     cx, dx
   638 000001B6 660D00000080                    or      eax, BIT31                      ; make a PCI access request
   639 000001BC 6625FFFFFFBF                    and     eax, ~PCI16 ; NOT PCI16         ; clear out data size request
   640 000001C2 24FC                            and     al, ~3 ; NOT 3                  ; force index to be dword
   641                                  
   642 000001C4 BAF80C                          mov     dx, PCI_INDEX_PORT
   643 000001C7 66EF                            out     dx, eax                         ; write PCI selector
   644                                  
   645 000001C9 BAFC0C                          mov     dx, PCI_DATA_PORT
   646 000001CC 88D8                            mov     al, bl
   647 000001CE 2403                            and     al, 3                           ; figure out which port to
   648 000001D0 00C2                            add     dl, al                          ; write to
   649                                  
   650 000001D2 6689D0                          mov     eax, edx                        ; put data into eax
   651 000001D5 89C8                            mov     ax, cx
   652                                  
   653 000001D7 EE                              out     dx, al
   654 000001D8 66F7C3000000C0                  test    ebx, PCI16+PCI32                ; only 8bit access? bail
   655 000001DF 740C                            jz      short _pregw1
   656                                  
   657 000001E1 EF                              out     dx, ax                          ; write 16 bit value
   658 000001E2 66F7C300000040                  test    ebx, PCI16                      ; 16bit requested?  bail
   659 000001E9 7502                            jnz     short _pregw1
   660                                  
   661 000001EB 66EF                            out     dx, eax                         ; write full 32bit
   662                                  _pregw1:
   663 000001ED 6689D8                          mov     eax, ebx                        ; restore eax
   664 000001F0 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   665 000001F6 89CA                            mov     dx, cx                          ; restore dx
   666 000001F8 59                      	pop	cx
   667 000001F9 665B                    	pop	ebx
   668 000001FB C3                      	ret
   669                                  
   670                                  pciRegWrite8:
   671 000001FC 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 8 bit write size
   672 00000202 EBAA                            jmp     short pciRegWrite		; call generic PCI access
   673                                  
   674                                  pciRegWrite16:
   675 00000204 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 16 bit write size
   676 0000020A 660D00000040                    or      eax, PCI16			; call generic PCI access
   677 00000210 EB9C                            jmp     short pciRegWrite
   678                                  
   679                                  pciRegWrite32:
   680 00000212 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 32 bit write size
   681 00000218 660D00000080                    or      eax, PCI32			; call generic PCI access
   682 0000021E EB8E                            jmp     short pciRegWrite
   683                                  
   684                                  ; AC97.ASM (PLAYWAV.COM)
   685                                  ; 17/02/2017 (Modifed by Erdogan Tan for various ICH device IDs)
   686                                  ;===============================================================
   687                                  ; PCIFindDevice: scan through PCI space looking for a device+vendor ID
   688                                  ;
   689                                  ;  ENTRY: none
   690                                  ;; Entry: EAX=Device+Vendor ID
   691                                  ;
   692                                  ;  Exit: EAX=PCI address if device found
   693                                  ;	 EDX=Device+Vendor ID
   694                                  ;        CY clear if found, set if not found. EAX invalid if CY set.
   695                                  ;
   696                                  ; [old stackless] Destroys: ebx, esi, edi, cl
   697                                  ;
   698                                  pciFindDevice:
   699                                  	;push	cx
   700                                  	;push	eax ; *
   701                                  	;push	esi
   702                                  	;push	edi
   703                                  
   704                                   	;mov     esi, eax                ; save off vend+device ID
   705                                  
   706                                  	; 17/02/2017
   707 00000220 BE[D40E]                	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
   708 00000223 B91500                  	mov	cx, valid_id_count
   709                                  pfd_0:
   710 00000226 66BF00FFFF7F                   	mov     edi, (80000000h - 100h) ; start with bus 0, dev 0 func 0
   711                                  nextPCIdevice:
   712 0000022C 6681C700010000                  add     edi, 100h
   713 00000233 6681FF00F8FF80                  cmp     edi, 80FFF800h		; scanned all devices?
   714                                          ;stc
   715                                          ;je 	short PCIScanExit       ; not found
   716 0000023A 720D                    	jb	short pfd_1
   717 0000023C 66BF00000080            	mov     edi, 80000000h
   718 00000242 83C604                  	add	si, 4 ; scan for next device ID
   719 00000245 E202                    	loop	pfd_1	 
   720 00000247 F9                      	stc	
   721                                  	;jmp 	short PCIScanExit
   722 00000248 C3                      	retn
   723                                  pfd_1:
   724 00000249 6689F8                          mov     eax, edi                ; read PCI registers
   725 0000024C E851FF                          call    pciRegRead32
   726                                          ;cmp    edx, esi                ; found device?
   727 0000024F 663B14                          cmp	edx, dword [si]
   728 00000252 75D8                    	jne     short nextPCIdevice
   729                                          ;clc
   730                                  PCIScanExit:
   731                                  	;pushf
   732 00000254 66B800000080            	mov	eax, BIT31
   733 0000025A 66F7D0                  	not	eax
   734 0000025D 6621F8                  	and	eax, edi		; return only bus/dev/fn #
   735                                  	;popf
   736                                  
   737                                  	;pop	edi
   738                                  	;pop	esi
   739                                  	;pop	edx ; *
   740                                  	;pop	cx
   741 00000260 C3                      	retn
   742                                  
   743                                  ;=============================================================================
   744                                  ;               CODEC.ASM
   745                                  ;=============================================================================
   746                                  
   747                                  ; EQUATES
   748                                  
   749                                  ;Codec registers.
   750                                  ;
   751                                  ;Not all codecs are created equal. Refer to the spec for your specific codec.
   752                                  ;
   753                                  ;All registers are 16bits wide.  Access to codec registers over the AC97 link
   754                                  ;is defined by the OEM.  
   755                                  ;
   756                                  ;Secondary codec's are accessed by ORing in BIT7 of all register accesses.
   757                                  ;
   758                                  
   759                                  ; each codec/mixer register is 16bits
   760                                  
   761                                  CODEC_RESET_REG                 equ     00      ; reset codec
   762                                  CODEC_MASTER_VOL_REG            equ     02      ; master volume
   763                                  CODEC_HP_VOL_REG                equ     04      ; headphone volume
   764                                  CODEC_MASTER_MONO_VOL_REG       equ     06      ; master mono volume
   765                                  CODEC_MASTER_TONE_REG           equ     08      ; master tone (R+L)
   766                                  CODEC_PCBEEP_VOL_REG            equ     0ah     ; PC beep volume
   767                                  CODEC_PHONE_VOL_REG             equ     0bh     ; phone volume
   768                                  CODEC_MIC_VOL_REG               equ     0eh     ; MIC volume
   769                                  CODEC_LINE_IN_VOL_REG           equ     10h     ; line input volume
   770                                  CODEC_CD_VOL_REG                equ     12h     ; CD volume
   771                                  CODEC_VID_VOL_REG               equ     14h     ; video volume
   772                                  CODEC_AUX_VOL_REG               equ     16h     ; aux volume
   773                                  CODEC_PCM_OUT_REG               equ     18h     ; PCM output volume
   774                                  CODEC_RECORD_SELECT_REG         equ     1ah     ; record select input
   775                                  CODEC_RECORD_VOL_REG            equ     1ch     ; record volume
   776                                  CODEC_RECORD_MIC_VOL_REG        equ     1eh     ; record mic volume
   777                                  CODEC_GP_REG                    equ     20h     ; general purpose
   778                                  CODEC_3D_CONTROL_REG            equ     22h     ; 3D control
   779                                  ; 24h is reserved
   780                                  CODEC_POWER_CTRL_REG            equ     26h     ; powerdown control
   781                                  CODEC_EXT_AUDIO_REG             equ     28h     ; extended audio
   782                                  CODEC_EXT_AUDIO_CTRL_REG        equ     2ah     ; extended audio control
   783                                  CODEC_PCM_FRONT_DACRATE_REG     equ     2ch     ; PCM out sample rate
   784                                  CODEC_PCM_SURND_DACRATE_REG     equ     2eh     ; surround sound sample rate
   785                                  CODEC_PCM_LFE_DACRATE_REG       equ     30h     ; LFE sample rate
   786                                  CODEC_LR_ADCRATE_REG            equ     32h     ; PCM in sample rate
   787                                  CODEC_MIC_ADCRATE_REG           equ     34h     ; mic in sample rate
   788                                  
   789                                  ; registers 36-7a are reserved on the ICH
   790                                  
   791                                  CODEC_VENDORID1_REG             equ     7ch     ; codec vendor ID 1
   792                                  CODEC_VENDORID2_REG             equ     7eh     ; codec vendor ID 2
   793                                  
   794                                  ; Mixer registers 0 through 51h reside in the ICH and are not forwarded over
   795                                  ; the AC97 link to the codec, which I think is a little weird.  Looks like
   796                                  ; the ICH makes it so you don't need a fully functional codec to play audio?
   797                                  ;
   798                                  ; whenever 2 codecs are present in the system, use BIT7 to access the 2nd
   799                                  ; set of registers, ie 80h-feh
   800                                  
   801                                  PRIMARY_CODEC                   equ     0       ; 0-7F for primary codec
   802                                  SECONDARY_CODEC                 equ     BIT7    ; 80-8f registers for 2ndary
   803                                  
   804                                  SAMPLE_RATE_441khz	equ     44100   ; 44.1Khz (cd quality) rate
   805                                  
   806                                  ; ----------------------------------------------------------------------------
   807                                  ; 17/02/2017
   808                                  PCI_IO_BASE	equ 10h			; = NAMBAR register offset
   809                                  AC97_INT_LINE   equ 3Ch			; AC97 Interrupt Line register offset
   810                                  
   811                                  ; ----------------------------------------------------------------------------
   812                                  ; ICH2AC97.INC
   813                                  ; ----------------------------------------------------------------------------
   814                                  
   815                                  ; PCI stuff
   816                                  
   817                                  ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
   818                                  
   819                                  INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
   820                                  
   821                                  ; 08/05/2024
   822                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   823                                  SIS_VID		equ	1039h
   824                                  NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
   825                                  AMD_VID		equ	1022h
   826                                  
   827                                  ICH_DID         equ     2415h           ; ICH device ID
   828                                  ICH0_DID        equ     2425h           ; ICH0
   829                                  ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
   830                                                                          ; they all should be compatible.
   831                                  ; 08/05/2024
   832                                  ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
   833                                  ICH3_DID	equ     2485h           ; ICH3
   834                                  ICH4_DID        equ     24C5h           ; ICH4
   835                                  ICH5_DID	equ     24D5h           ; ICH5
   836                                  ICH6_DID	equ     266Eh           ; ICH6
   837                                  ESB6300_DID	equ     25A6h           ; 6300ESB
   838                                  ESB631X_DID	equ     2698h           ; 631XESB
   839                                  ICH7_DID	equ	27DEh		; ICH7
   840                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   841                                  MX82440_DID	equ	7195h
   842                                  SI7012_DID	equ	7012h
   843                                  NFORCE_DID	equ	01B1h
   844                                  NFORCE2_DID	equ	006Ah
   845                                  AMD8111_DID	equ	746Dh
   846                                  AMD768_DID	equ	7445h
   847                                  ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
   848                                  CK804_DID	equ	0059h
   849                                  MCP04_DID	equ	003Ah
   850                                  CK8_DID		equ	008Ah
   851                                  NFORCE3_DID	equ	00DAh
   852                                  CK8S_DID	equ	00EAh
   853                                  
   854                                  NAMBAR_REG      equ     10h             ; native audio mixer BAR
   855                                   NAM_SIZE       equ     256             ; 256 bytes required.
   856                                  
   857                                  NABMBAR_REG     equ     14h             ; native audio bus mastering BAR
   858                                   NABM_SIZE      equ     64              ; 64 bytes
   859                                  
   860                                  ; BUS master registers, accessed via NABMBAR+offset
   861                                  
   862                                  ; ICH supports 3 different types of register sets for three types of things
   863                                  ; it can do, thus:
   864                                  ;
   865                                  ; PCM in (for recording) aka PI
   866                                  ; PCM out (for playback) aka PO
   867                                  ; MIC in (for recording) aka MC
   868                                  
   869                                  PI_BDBAR_REG            equ     0       ; PCM in buffer descriptor BAR
   870                                  PO_BDBAR_REG            equ     10h     ; PCM out buffer descriptor BAR
   871                                  MC_BDBAR_REG            equ     20h     ; MIC in buffer descriptor BAR
   872                                  
   873                                  ; each buffer descriptor BAR holds a pointer which has entries to the buffer
   874                                  ; contents of the .WAV file we're going to play.  Each entry is 8 bytes long
   875                                  ; (more on that later) and can contain 32 entries total, so each BAR is
   876                                  ; 256 bytes in length, thus:
   877                                  
   878                                  BDL_SIZE                equ     32*8    ; Buffer Descriptor List size
   879                                  INDEX_MASK              equ     31      ; indexes must be 0-31
   880                                  
   881                                  
   882                                  
   883                                  PI_CIV_REG              equ     4       ; PCM in current Index value (RO)
   884                                  PO_CIV_REG              equ     14h     ; PCM out current Index value (RO)
   885                                  MC_CIV_REG              equ     24h     ; MIC in current Index value (RO)
   886                                  ;8bit read only
   887                                  ; each current index value is simply a pointer showing us which buffer
   888                                  ; (0-31) the codec is currently processing.  Once this counter hits 31, it
   889                                  ; wraps back to 0.
   890                                  ; this can be handy to know, as once it hits 31, we're almost out of data to
   891                                  ; play back or room to record!
   892                                  
   893                                  
   894                                  PI_LVI_REG              equ     5       ; PCM in Last Valid Index
   895                                  PO_LVI_REG              equ     15h     ; PCM out Last Valid Index
   896                                  MC_LVI_REG              equ     25h     ; MIC in Last Valid Index
   897                                  ;8bit read/write
   898                                  ; The Last Valid Index is a number (0-31) to let the codec know what buffer
   899                                  ; number to stop on after processing.  It could be very nasty to play audio
   900                                  ; from buffers that aren't filled with the audio we want to play.
   901                                  
   902                                  
   903                                  PI_SR_REG               equ     6       ; PCM in Status register
   904                                  PO_SR_REG               equ     16h     ; PCM out Status register
   905                                  MC_SR_REG               equ     26h     ; MIC in Status register
   906                                  ;16bit read/write
   907                                  ; status registers.  Bitfields follow:
   908                                  
   909                                  FIFO_ERR                equ     BIT4    ; FIFO Over/Underrun W1TC.
   910                                  
   911                                  BCIS                    equ     BIT3    ; buffer completion interrupt status.
   912                                                                          ; Set whenever the last sample in ANY
   913                                                                          ; buffer is finished.  Bit is only
   914                                                                          ; set when the Interrupt on Complete
   915                                                                          ; (BIT4 of control reg) is set.
   916                                  
   917                                  LVBCI                   equ     BIT2    ; Set whenever the codec has processed
   918                                                                          ; the last buffer in the buffer list.
   919                                                                          ; Will fire an interrupt if IOC bit is
   920                                                                          ; set. Probably set after the last
   921                                                                          ; sample in the last buffer is
   922                                                                          ; processed.  W1TC
   923                                  
   924                                                                          ; 
   925                                  CELV                    equ     BIT1    ; Current buffer == last valid.
   926                                                                          ; Bit is RO and remains set until LVI is
   927                                                                          ; cleared.  Probably set up the start
   928                                                                          ; of processing for the last buffer.
   929                                  
   930                                  
   931                                  DCH                     equ     BIT0    ; DMA controller halted.
   932                                                                          ; set whenever audio stream is stopped
   933                                                                          ; or something else goes wrong.
   934                                  
   935                                  PI_PICB_REG             equ     8       ; PCM in position in current buffer(RO)
   936                                  PO_PICB_REG             equ     18h     ; PCM out position in current buffer(RO)
   937                                  MC_PICB_REG             equ     28h     ; MIC in position in current buffer (RO)
   938                                  ;16bit read only
   939                                  ; position in current buffer regs show the number of dwords left to be
   940                                  ; processed in the current buffer.
   941                                  ; 
   942                                  
   943                                  PI_PIV_REG              equ     0ah     ; PCM in Prefected index value
   944                                  PO_PIV_REG              equ     1ah     ; PCM out Prefected index value
   945                                  MC_PIV_REG              equ     2ah     ; MIC in Prefected index value
   946                                  ;8bit, read only
   947                                  ; Prefetched index value register.
   948                                  ; tells which buffer number (0-31) has be prefetched.  I'd imagine this
   949                                  ; value follows the current index value fairly closely. (CIV+1)
   950                                  ;
   951                                  
   952                                  PI_CR_REG               equ     0bh     ; PCM in Control Register
   953                                  PO_CR_REG               equ     1bh     ; PCM out Control Register
   954                                  MC_CR_REG               equ     2bh     ; MIC in Control Register
   955                                  ; 8bit
   956                                  ; Control register *MUST* only be accessed as an 8bit value.
   957                                  ; Control register.  See bitfields below.
   958                                  ;
   959                                  
   960                                  IOCE                    equ     BIT4    ; interrupt on complete enable.
   961                                                                          ; set this bit if you want an intrtpt
   962                                                                          ; to fire whenever LVBCI is set.
   963                                  FEIFE                   equ     BIT3    ; set if you want an interrupt to fire
   964                                                                          ; whenever there is a FIFO (over or
   965                                                                          ; under) error.
   966                                  LVBIE                   equ     BIT2    ; last valid buffer interrupt enable.
   967                                                                          ; set if you want an interrupt to fire
   968                                                                          ; whenever the completion of the last
   969                                                                          ; valid buffer.
   970                                  RR                      equ     BIT1    ; reset registers.  Nukes all regs
   971                                                                          ; except bits 4:2 of this register.
   972                                                                          ; Only set this bit if BIT 0 is 0
   973                                  RPBM                    equ     BIT0    ; Run/Pause
   974                                                                          ; set this bit to start the codec!
   975                                  
   976                                  
   977                                  GLOB_CNT_REG            equ     2ch     ; Global control register
   978                                  SEC_RES_EN              equ     BIT5    ; secondary codec resume event 
   979                                                                          ; interrupt enable.  Not used here.
   980                                  PRI_RES_EN              equ     BIT4    ; ditto for primary. Not used here.
   981                                  ACLINK_OFF              equ     BIT3    ; Turn off the AC97 link
   982                                  ACWARM_RESET            equ     BIT2    ; Awaken the AC97 link from sleep.
   983                                                                          ; registers preserved, bit self clears
   984                                  ACCOLD_RESET            equ     BIT1    ; Reset everything in the AC97 and
   985                                                                          ; reset all registers.  Not self clearing
   986                                  
   987                                  GPIIE                   equ     BIT0    ; GPI Interrupt enable.
   988                                                                          ; set if you want an interrupt to
   989                                                                          ; fire upon ANY of the bits in the
   990                                                                          ; GPI (general pursose inputs?) not used.
   991                                  
   992                                  GLOB_STS_REG            equ     30h     ; Global Status register (RO)
   993                                  
   994                                  MD3                     equ     BIT17   ; modem powerdown status (yawn)
   995                                  AD3                     equ     BIT16   ; Audio powerdown status (yawn)
   996                                  RD_COMPLETE_STS         equ     BIT15   ; Codec read timed out. 0=normal
   997                                  BIT3SLOT12              equ     BIT14   ; shadowed status of bit 3 in slot 12
   998                                  BIT2SLOT12              equ     BIT13   ; shadowed status of bit 2 in slot 12
   999                                  BIT1SLOT12              equ     BIT12   ; shadowed status of bit 1 in slot 12
  1000                                  SEC_RESUME_STS          equ     BIT11   ; secondary codec has resumed (and irqed)
  1001                                  PRI_RESUME_STS          equ     BIT10   ; primary codec has resumed (and irqed)
  1002                                  SEC_CODEC_RDY           equ     BIT9    ; secondary codec is ready for action
  1003                                  PRI_CODEC_RDY           equ     BIT8    ; Primary codec is ready for action
  1004                                                                          ; software must check these bits before
  1005                                                                          ; starting the codec!
  1006                                  MIC_IN_IRQ              equ     BIT7    ; MIC in caused an interrupt
  1007                                  PCM_OUT_IRQ             equ     BIT6    ; One of the PCM out channels IRQed
  1008                                  PCM_IN_IRQ              equ     BIT5    ; One of the PCM in channels IRQed
  1009                                  MODEM_OUT_IRQ           equ     BIT2    ; modem out channel IRQed
  1010                                  MODEM_IN_IRQ            equ     BIT1    ; modem in channel IRQed
  1011                                  GPI_STS_CHANGE          equ     BIT0    ; set whenever GPI's have changed.
  1012                                                                          ; BIT0 of slot 12 also reflects this.
  1013                                  
  1014                                  
  1015                                  ACC_SEMA_REG            equ     34h     ; Codec write semiphore register
  1016                                  CODEC_BUSY              equ     BIT0    ; codec register I/O is happening
  1017                                                                          ; self clearing
  1018                                  ;
  1019                                  ; Buffer Descriptors List
  1020                                  ; As stated earlier, each buffer descriptor list is a set of (up to) 32 
  1021                                  ; descriptors, each 8 bytes in length.  Bytes 0-3 of a descriptor entry point
  1022                                  ; to a chunk of memory to either play from or record to.  Bytes 4-7 of an
  1023                                  ; entry describe various control things detailed below.
  1024                                  ; 
  1025                                  ; Buffer pointers must always be aligned on a Dword boundry.
  1026                                  ;
  1027                                  ;
  1028                                  
  1029                                  IOC                     equ     BIT31   ; Fire an interrupt whenever this
  1030                                                                          ; buffer is complete.
  1031                                  
  1032                                  BUP                     equ     BIT30   ; Buffer Underrun Policy.
  1033                                                                          ; if this buffer is the last buffer
  1034                                                                          ; in a playback, fill the remaining
  1035                                                                          ; samples with 0 (silence) or not.
  1036                                                                          ; It's a good idea to set this to 1
  1037                                                                          ; for the last buffer in playback,
  1038                                                                          ; otherwise you're likely to get a lot
  1039                                                                          ; of noise at the end of the sound.
  1040                                  
  1041                                  ;
  1042                                  ; Bits 15:0 contain the length of the buffer, in number of samples, which
  1043                                  ; are 16 bits each, coupled in left and right pairs, or 32bits each.
  1044                                  ; Luckily for us, that's the same format as .wav files.
  1045                                  ;
  1046                                  ; A value of FFFF is 65536 samples.  Running at 44.1Khz, that's just about
  1047                                  ; 1.5 seconds of sample time.  FFFF * 32bits is 1FFFFh bytes or 128k of data.
  1048                                  ;
  1049                                  ; A value of 0 in these bits means play no samples.
  1050                                  ;
  1051                                  
  1052                                  ; CODE
  1053                                  
  1054                                  ; AC97.ASM
  1055                                  
  1056                                  ; codec configuration code.  Not much here really.
  1057                                  ; NASM version: Erdogan Tan (29/11/2016)
  1058                                  
  1059                                  ; enable codec, unmute stuff, set output rate to 44.1
  1060                                  ; entry: ax = desired sample rate
  1061                                  ;
  1062                                  
  1063                                  ; 08/04/2024
  1064                                  %if 0
  1065                                  
  1066                                  codecConfig:
  1067                                  	; 17/02/2017 
  1068                                  	; 07/11/2016 (Erdogan Tan)
  1069                                  	PORT_NABM_GLB_CTRL_STAT equ 60h
  1070                                  
  1071                                  	;mov    dx, [NAMBAR]               	; mixer base address
  1072                                  	;add	dx, CODEC_EXT_AUDIO_REG	       	; 28h
  1073                                  	;in	ax, dx
  1074                                  	;and	ax, 1
  1075                                  	;jnz	short _ssr
  1076                                  	;pop	ax
  1077                                  	;jmp	short cconf_1
  1078                                  
  1079                                  _ssr:
  1080                                  	mov    	dx, [NAMBAR]
  1081                                  	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah
  1082                                  	in     	ax, dx
  1083                                  	or	ax, 1
  1084                                  	out	dx, ax 				; Enable variable rate audio
  1085                                  
  1086                                          call    delay1_4ms
  1087                                          call    delay1_4ms
  1088                                          call    delay1_4ms
  1089                                          call    delay1_4ms
  1090                                  
  1091                                  	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
  1092                                  
  1093                                  	mov    	dx, [NAMBAR]               	
  1094                                  	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch
  1095                                  	out	dx, ax 				; out sample rate
  1096                                  		
  1097                                  	;mov    dx, [NAMBAR]               	
  1098                                  	;add    dx, CODEC_LR_ADCRATE_REG 	; 32h
  1099                                  	;out	dx, ax 
  1100                                  
  1101                                          call    delay1_4ms
  1102                                          call    delay1_4ms
  1103                                          call    delay1_4ms
  1104                                          call    delay1_4ms
  1105                                  
  1106                                  ;cconf_1:
  1107                                  	mov     dx, [NAMBAR]			; mixer base address
  1108                                          add     dx, CODEC_RESET_REG  		; reset register
  1109                                          mov	ax, 42
  1110                                  	out     dx, ax                          ; reset
  1111                                  
  1112                                  	mov     dx, [NABMBAR]			; bus master base address
  1113                                          add     dx, PORT_NABM_GLB_CTRL_STAT
  1114                                          mov	ax, 2
  1115                                  	out     dx, ax                         
  1116                                  
  1117                                  	mov	cx, 7
  1118                                  _100ms:
  1119                                  	push	cx
  1120                                          call    delay1_4ms
  1121                                          call    delay1_4ms
  1122                                          call    delay1_4ms
  1123                                          call    delay1_4ms
  1124                                  	pop	cx
  1125                                  	loop	_100ms	
  1126                                  	
  1127                                    	mov     dx, [NAMBAR]
  1128                                    	add     dx, CODEC_MASTER_VOL_REG        ;02h
  1129                                    	xor     ax, ax ; ; volume attenuation = 0 (max. volume)
  1130                                    	out     dx, ax
  1131                                   
  1132                                    	mov     dx, [NAMBAR]
  1133                                    	add     dx, CODEC_MASTER_MONO_VOL_REG   ;06h
  1134                                    	;xor    ax, ax
  1135                                    	out     dx, ax
  1136                                  
  1137                                    	mov     dx, [NAMBAR]
  1138                                    	add     dx, CODEC_PCBEEP_VOL_REG        ;0Ah
  1139                                    	;xor    ax, ax
  1140                                    	out     dx, ax
  1141                                  
  1142                                    	mov     dx, [NAMBAR]
  1143                                    	add     dx, CODEC_PCM_OUT_REG		;18h
  1144                                    	;xor    ax, ax
  1145                                    	out     dx, ax
  1146                                  
  1147                                          call    delay1_4ms
  1148                                          call    delay1_4ms
  1149                                          call    delay1_4ms
  1150                                          call    delay1_4ms
  1151                                  
  1152                                          retn
  1153                                  
  1154                                  %else
  1155                                  	; 12/05/2024
  1156                                  	; 08/05/2024
  1157                                  	; (ac97_vra.asm, 19/11/2023, Erdogan Tan, playwav3.asm)
  1158                                  codecConfig:
  1159                                  	; 02/12/2023
  1160                                  	; 26/11/2023
  1161                                  	; 21/11/2023
  1162                                  	; 20/11/2023
  1163                                  	; 19/11/2023 (TRDOS 386 v2.0.7)
  1164                                  	; 15/11/2023
  1165                                  	; 04/11/2023
  1166                                  	; 17/02/2017 
  1167                                  	; 07/11/2016 (Erdogan Tan)
  1168                                  	;PORT_NABM_GLB_CTRL_STAT equ 60h
  1169                                  
  1170                                  	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
  1171                                   	; 'AC97_DEF.H'
  1172                                  	;AC97_EXTENDED_STATUS equ 002Ah
  1173                                  	AC97_EA_SPDIF	equ 0002h
  1174                                  	AC97_EA_VRA	equ 0001h
  1175                                  	; 04/11/2023
  1176                                  	ICH_PO_CR_RESET equ 0002h  ; reset codec
  1177                                  	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
  1178                                  	ICH_PCM_246_MASK equ 300000h ; 6 channels
  1179                                  
  1180                                  	; 08/05/2024
  1181                                  	; 11/11/2023
  1182                                  	CTRL_ST_CREADY	equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
  1183                                  	CODEC_REG_POWERDOWN equ	26h
  1184                                  
  1185                                  	; 04/11/2023
  1186                                  init_ac97_controller:
  1187 00000261 66A1[EA0F]              	mov	eax, [bus_dev_fn]
  1188 00000265 B004                    	mov	al, PCI_CMD_REG
  1189 00000267 E828FF                  	call	pciRegRead16		; read PCI command register
  1190 0000026A 80CA05                  	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
  1191 0000026D E894FF                  	call	pciRegWrite16
  1192                                  
  1193                                  	; 14/05/2024
  1194                                  	; 02/12/2023
  1195 00000270 E8AA01                  	call	delay_100ms ; 29/05/2017
  1196                                  
  1197                                  	; 02/12/2023
  1198                                  	;call	delay1_4ms
  1199                                  	;call	delay1_4ms
  1200                                  	;call	delay1_4ms
  1201                                  	;call	delay1_4ms
  1202                                  
  1203                                  init_ac97_codec:
  1204                                  	; 18/11/2023
  1205 00000273 BD2800                  	mov	bp, 40
  1206                                  	; 14/05/2024
  1207                                  	;mov	bp, 100
  1208                                  _initc_1:
  1209                                  	; 11/11/2023
  1210                                  	; (TRDOS 386 v2.0.5, 'audio.s')
  1211 00000276 BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1212 00000279 0316[D60F]              	add	dx, [NABMBAR]
  1213 0000027D 66ED                    	in	eax, dx
  1214                                  
  1215                                  	; 14/05/2024
  1216                                  	; 02/12/2023
  1217 0000027F E86209                  	call	delay1_4ms
  1218                                  
  1219                                  	; ?
  1220                                  	;; 15/11/2023
  1221                                  	;;mov	cx, 40
  1222                                  	;mov	bp, 40 ; 18/11/2023
  1223                                  ;_initc_1:
  1224 00000282 BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1225 00000285 0316[D60F]              	add	dx, [NABMBAR]
  1226 00000289 66ED                    	in	eax, dx
  1227                                  
  1228                                  	; 14/05/2024
  1229                                  	; 02/12/2023
  1230 0000028B E85609                  	call	delay1_4ms
  1231                                  
  1232 0000028E 6683F8FF                	cmp	eax, 0FFFFFFFFh ; -1
  1233                                  	;je	short init_ac97_codec_err1
  1234                                  	; 15/11/2023
  1235 00000292 7508                    	jne	short _initc_3
  1236                                  _initc_2:
  1237                                  	;dec	cx
  1238 00000294 4D                      	dec	bp	; 18/11/2023
  1239                                  	;jz	short init_ac97_codec_err1
  1240                                  	; 19/11/2023
  1241 00000295 7412                    	jz	short _ac97_codec_ready
  1242                                  
  1243 00000297 E88301                  	call	delay_100ms
  1244 0000029A EBDA                    	jmp	short _initc_1
  1245                                  _initc_3:
  1246 0000029C 66A900030010            	test	eax, CTRL_ST_CREADY
  1247 000002A2 7505                    	jnz	short _ac97_codec_ready
  1248                                  
  1249 000002A4 E8F600                  	call	reset_ac97_codec
  1250                                  	; 11/11/2023
  1251                                  	;jc	short init_ac97_codec_err2
  1252                                  	; 15/11/2023
  1253                                  	;jc	short _initc_2
  1254                                  	; 26/11/2023
  1255 000002A7 EBEB                    	jmp	short _initc_2
  1256                                  
  1257                                  _ac97_codec_ready:
  1258 000002A9 8B16[D40F]              	mov	dx, [NAMBAR]
  1259                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  1260 000002AD EF                      	out	dx, ax
  1261                                  
  1262 000002AE E86C01                  	call	delay_100ms
  1263                                  
  1264                                  	; 19/11/2023
  1265 000002B1 09ED                    	or	bp, bp
  1266 000002B3 7526                    	jnz	short _ac97_codec_init_ok
  1267                                  
  1268 000002B5 6631C0                  	xor	eax, eax ; 0
  1269 000002B8 8B16[D40F]              	mov	dx, [NAMBAR]
  1270 000002BC 83C226                  	add	dx, CODEC_REG_POWERDOWN
  1271 000002BF EF                      	out	dx, ax
  1272                                  	
  1273                                  	; 19/11/2023
  1274                                  	; wait for 1 second
  1275                                  	; 14/05/2024
  1276                                  	;mov	ecx, 1000 ; 1000*4*0.25ms = 1s
  1277                                  	;mov	cx, 10
  1278                                  	; 19/05/2024
  1279 000002C0 B92800                  	mov	cx, 40
  1280                                  _ac97_codec_rloop:
  1281                                  	;call	delay1_4ms
  1282                                  	;call	delay1_4ms
  1283                                  	;call	delay1_4ms
  1284                                  	;call	delay1_4ms
  1285 000002C3 E85701                  	call	delay_100ms
  1286                                  	
  1287 000002C6 8B16[D40F]              	mov	dx, [NAMBAR]
  1288 000002CA 83C226                  	add	dx, CODEC_REG_POWERDOWN
  1289 000002CD ED                      	in	ax, dx
  1290                                  
  1291                                  	; 14/05/2024
  1292                                  	; 02/12/2023
  1293 000002CE E81309                  	call	delay1_4ms
  1294                                  	
  1295 000002D1 83E00F                  	and	ax, 0Fh
  1296 000002D4 3C0F                    	cmp	al, 0Fh
  1297 000002D6 7403                    	je	short _ac97_codec_init_ok
  1298 000002D8 E2E9                    	loop	_ac97_codec_rloop 
  1299                                  
  1300                                  	; 12/05/2024
  1301                                  	; cf = 1
  1302                                  init_ac97_codec_err1:
  1303                                  	;stc	; 12/05/2024
  1304                                  init_ac97_codec_err2:
  1305 000002DA C3                      	retn
  1306                                  
  1307                                  _ac97_codec_init_ok:
  1308                                          ; 11/11/2023
  1309                                  	;mov	al, 2 ; force set 16-bit 2-channel PCM
  1310                                  	;mov	dx, GLOB_CNT_REG ; 2Ch
  1311                                  	;add	dx, [NABMBAR]
  1312                                  	;out	dx, eax
  1313                                  
  1314                                  	;;call	delay1_4ms
  1315                                  
  1316 000002DB E87800                  	call 	reset_ac97_controller
  1317                                  
  1318                                  	; 11/11/2023
  1319                                  	;call	delay1_4ms
  1320                                  	; 21/11/2023 - temporary
  1321 000002DE E83C01                  	call	delay_100ms
  1322                                  
  1323                                  	;call 	setup_ac97_codec
  1324                                  
  1325                                  setup_ac97_codec:
  1326                                  	; 08/05/2028
  1327                                  	; [sample_rate] = 22050
  1328                                  	; 12/11/2023
  1329                                  	;cmp	word [sample_rate], 48000
  1330                                  	;je	short skip_rate
  1331                                  
  1332                                  ; 11/11/2023
  1333                                  ; 05/11/2023
  1334                                  ;%if 1
  1335                                  	AC97_EA_VRA equ BIT0 ; 11/11/2023
  1336                                  
  1337                                  	; 18/05/2024
  1338 000002E1 E80009                  	call	delay1_4ms
  1339                                  
  1340                                  	; 16/05/2024
  1341 000002E4 8B16[D40F]              	mov	dx, [NAMBAR]
  1342 000002E8 83C228                  	add	dx, CODEC_EXT_AUDIO_REG	; 28h
  1343 000002EB ED                      	in	ax, dx
  1344                                  
  1345                                  	; 18/05/2024
  1346                                  	; 16/05/2024
  1347 000002EC E8F508                  	call	delay1_4ms
  1348                                  	; 17/05/2024
  1349                                  	;call	delay1_4ms
  1350                                  	;call	delay1_4ms
  1351                                  	;call	delay1_4ms
  1352                                  
  1353                                  	; 17/05/2024
  1354                                  	;call	delay_100ms
  1355                                  
  1356                                  	; 14/05/2024
  1357 000002EF A801                    	test	al, 1 ; BIT0 ; Variable Rate Audio bit
  1358 000002F1 741D                    	jz	short vra_not_supported
  1359                                  
  1360                                  	; 11/11/2023
  1361 000002F3 8B16[D40F]              	mov    	dx, [NAMBAR]
  1362 000002F7 83C22A                  	add    	dx, CODEC_EXT_AUDIO_CTRL_REG ; 2Ah
  1363 000002FA ED                      	in     	ax, dx
  1364                                  
  1365                                  	; 14/05/2024
  1366                                  	; 02/12/2023
  1367 000002FB E8E608                  	call	delay1_4ms
  1368                                  
  1369 000002FE 24FD                    	and	al, ~BIT1 ; Clear DRA
  1370 00000300 0C01                    	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
  1371 00000302 EF                      	out	dx, ax			; Enable variable rate audio
  1372                                  	
  1373 00000303 B90A00                  	mov	cx, 10
  1374                                  check_vra:
  1375 00000306 E81401                  	call	delay_100ms
  1376                                  
  1377                                  	; 11/11/2023
  1378 00000309 ED                      	in	ax, dx
  1379 0000030A A801                    	test	al, AC97_EA_VRA ; 1
  1380 0000030C 750A                    	jnz	short set_rate
  1381                                  
  1382                                  	; 11/11/2023
  1383 0000030E E2F6                    	loop	check_vra
  1384                                  
  1385                                  	; 13/11/2023
  1386                                  	;mov	byte [VRA], 0
  1387                                  	; 14/05/2024
  1388                                  vra_not_supported:
  1389                                  	; 08/05/2024
  1390 00000310 C706[3465]80BB          	mov	word [sample_rate], 48000
  1391 00000316 EB0E                    	jmp	short skip_rate	
  1392                                  
  1393                                  	; 12/11/2023
  1394                                  	;pop	ax ; discard return address to the caller
  1395                                  	;mov	dx, msg_no_vra
  1396                                  	;jmp	vra_err
  1397                                  
  1398                                  set_rate:
  1399 00000318 A1[3465]                	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
  1400                                  	; 08/05/2024
  1401                                  	; ax = 22050 (Hz)
  1402                                  
  1403 0000031B 8B16[D40F]              	mov    	dx, [NAMBAR]               	
  1404 0000031F 83C22C                  	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch
  1405 00000322 EF                      	out	dx, ax 			; PCM Front/Center Output Sample Rate
  1406                                  
  1407 00000323 E8F700                  	call	delay_100ms
  1408                                  
  1409                                  	; 12/11/2023
  1410                                  skip_rate:
  1411                                  	; 11/11/2023 (temporary)
  1412                                  
  1413                                  	;mov   	dx, [NAMBAR]               	
  1414                                  	;add   	dx, CODEC_PCM_SURND_DACRATE_REG	; 2Eh
  1415                                  	;out	dx, ax 			; PCM Surround Output Sample Rate
  1416                                  
  1417                                  	;call	delay_100ms
  1418                                  
  1419                                  	;mov   	dx, [NAMBAR]               	
  1420                                  	;add   	dx, CODEC_PCM_LFE_DACRATE_REG	; 30h
  1421                                  	;out	dx, ax 			; PCM LFE Output Sample Rate
  1422                                  
  1423                                  	;call	delay_100ms
  1424                                  
  1425                                  	; 05/11/2023 (temporary)
  1426                                  	;mov	dx, [NAMBAR]               	
  1427                                  	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h
  1428                                  	;out	dx, ax 			; PCM Input Sample Rate
  1429                                  	;
  1430                                  	;call	delay_100ms
  1431                                  
  1432 00000326 B80202                  	mov	ax, 0202h
  1433 00000329 A2[F30F]                	mov	[volume], al ; 29
  1434 0000032C 8B16[D40F]              	mov     dx, [NAMBAR]
  1435 00000330 83C202                    	add     dx, CODEC_MASTER_VOL_REG	; 02h
  1436 00000333 EF                      	out     dx, ax
  1437                                  
  1438                                  	; 11/11/2023
  1439                                          ;call	delay1_4ms
  1440                                          ;call	delay1_4ms
  1441                                          ;call	delay1_4ms
  1442                                          ;call	delay1_4ms
  1443                                   	;
  1444                                    	;mov	dx, [NAMBAR]
  1445                                    	;add	dx, CODEC_MASTER_MONO_VOL_REG	; 06h
  1446                                    	;out	dx, ax
  1447                                  
  1448                                  	; 11/11/2023
  1449                                          ;call	delay1_4ms
  1450                                          ;call	delay1_4ms
  1451                                          ;call	delay1_4ms
  1452                                          ;call	delay1_4ms
  1453                                  	;
  1454                                  	;mov	ax, 02h
  1455                                    	;mov	dx, [NAMBAR]
  1456                                    	;add	dx, CODEC_PCBEEP_VOL_REG	; 0Ah
  1457                                    	;out	dx, ax
  1458                                  
  1459                                  	; 14/05/2024	
  1460                                  	; 20/11/2023
  1461 00000334 E8AD08                          call	delay1_4ms
  1462 00000337 E8AA08                          call	delay1_4ms
  1463 0000033A E8A708                          call	delay1_4ms
  1464 0000033D E8A408                          call	delay1_4ms
  1465                                  
  1466                                  	; 21/11/2023 temporary
  1467                                  	;call	delay_100ms
  1468                                  
  1469                                  	;mov	ax, 0202h
  1470 00000340 8B16[D40F]                	mov     dx, [NAMBAR]
  1471 00000344 83C218                    	add     dx, CODEC_PCM_OUT_REG		; 18h
  1472 00000347 EF                        	out     dx, ax
  1473                                  
  1474                                  	; 14/05/2024
  1475                                  	; 20/11/2023
  1476 00000348 E89908                          call	delay1_4ms
  1477 0000034B E89608                          call	delay1_4ms
  1478 0000034E E89308                          call	delay1_4ms
  1479 00000351 E89008                          call	delay1_4ms
  1480                                  
  1481                                  	; 14/05/2024
  1482                                  	; 21/11/2023 - temporary
  1483                                  	;call	delay_100ms
  1484                                  
  1485                                  	; 11/11/2023
  1486                                  	;mov	ax, 8008h ; Mute
  1487                                    	;mov	dx, [NAMBAR]
  1488                                  	;add	dx, CODEC_PHONE_VOL_REG		; 0Ch
  1489                                  	;			 ; AC97_PHONE_VOL ; TAD Input (Mono)
  1490                                    	;out	dx, ax
  1491                                  	;
  1492                                          ;call	delay1_4ms
  1493                                          ;call	delay1_4ms
  1494                                          ;call	delay1_4ms
  1495                                  	;call	delay1_4ms
  1496                                  
  1497                                  	;mov	ax, 0808h
  1498                                  	;mov	dx, [NAMBAR]
  1499                                  	;add	dx, CODEC_LINE_IN_VOL_REG ;10h ; Line Input (Stereo)
  1500                                  	;out	dx, ax
  1501                                  	;
  1502                                          ;call	delay1_4ms
  1503                                          ;call	delay1_4ms
  1504                                          ;call	delay1_4ms
  1505                                  	;call	delay1_4ms
  1506                                  
  1507                                    	;mov	dx, [NAMBAR]
  1508                                          ;add	dx, CODEC_CD_VOL_REG ;12h ; CD Input (Stereo)
  1509                                    	;out	dx, ax
  1510                                  	;
  1511                                    	;mov	dx, [NAMBAR]
  1512                                          ;add	dx, CODEC_AUX_VOL_REG ;16h ; Aux Input (Stereo)
  1513                                    	;out	dx, ax
  1514                                  	;
  1515                                          ;call	delay1_4ms
  1516                                          ;call	delay1_4ms
  1517                                          ;call	delay1_4ms
  1518                                  	;call	delay1_4ms
  1519                                  
  1520                                  	; 14/05/2024
  1521                                  	;call	delay_100ms
  1522                                  
  1523                                  	; 14/05/2024
  1524 00000354 F8                      	clc
  1525                                  
  1526                                  ;detect_ac97_codec:
  1527 00000355 C3                              retn
  1528                                  
  1529                                  reset_ac97_controller:
  1530                                  	; 11/11/2023
  1531                                  	; 10/06/2017
  1532                                  	; 29/05/2017
  1533                                  	; 28/05/2017
  1534                                  	; reset AC97 audio controller registers
  1535 00000356 31C0                    	xor     ax, ax
  1536 00000358 BA0B00                          mov	dx, PI_CR_REG
  1537 0000035B 0316[D60F]              	add	dx, [NABMBAR]
  1538 0000035F EE                      	out     dx, al
  1539                                  
  1540                                  	; 14/05/2024
  1541 00000360 E88108                  	call	delay1_4ms
  1542                                  
  1543 00000363 BA1B00                          mov     dx, PO_CR_REG
  1544 00000366 0316[D60F]              	add	dx, [NABMBAR]
  1545 0000036A EE                      	out     dx, al
  1546                                  
  1547                                  	; 14/05/2024
  1548 0000036B E87608                  	call	delay1_4ms
  1549                                  
  1550 0000036E BA2B00                          mov     dx, MC_CR_REG
  1551 00000371 0316[D60F]              	add	dx, [NABMBAR]
  1552 00000375 EE                      	out     dx, al
  1553                                  
  1554                                  	; 14/05/2024
  1555 00000376 E86B08                  	call	delay1_4ms
  1556                                  
  1557 00000379 B002                            mov     al, RR
  1558 0000037B BA0B00                          mov     dx, PI_CR_REG
  1559 0000037E 0316[D60F]              	add	dx, [NABMBAR]
  1560 00000382 EE                      	out     dx, al
  1561                                  
  1562                                  	; 14/05/2024
  1563 00000383 E85E08                  	call	delay1_4ms
  1564                                  
  1565 00000386 BA1B00                          mov     dx, PO_CR_REG
  1566 00000389 0316[D60F]              	add	dx, [NABMBAR]
  1567 0000038D EE                      	out     dx, al
  1568                                  
  1569                                  	; 14/05/2024
  1570 0000038E E85308                  	call	delay1_4ms
  1571                                  
  1572 00000391 BA2B00                          mov     dx, MC_CR_REG
  1573 00000394 0316[D60F]              	add	dx, [NABMBAR]
  1574 00000398 EE                      	out     dx, al
  1575                                  
  1576                                  	; 14/05/2024
  1577 00000399 E84808                  	call	delay1_4ms
  1578                                  
  1579 0000039C C3                      	retn
  1580                                  
  1581                                  reset_ac97_codec:
  1582                                  	; 11/11/2023
  1583                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1584 0000039D BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1585 000003A0 0316[D60F]              	add	dx, [NABMBAR]
  1586 000003A4 66ED                    	in	eax, dx
  1587                                  
  1588                                  	;test	eax, 2
  1589                                  	; 06/08/2022
  1590 000003A6 A802                    	test	al, 2
  1591 000003A8 7405                    	jz	short _r_ac97codec_cold
  1592                                  
  1593 000003AA E80E00                  	call	warm_ac97codec_reset
  1594 000003AD 7306                    	jnc	short _r_ac97codec_ok
  1595                                  _r_ac97codec_cold:
  1596 000003AF E83400                          call    cold_ac97codec_reset
  1597 000003B2 7301                            jnc     short _r_ac97codec_ok
  1598                                  	
  1599                                  	; 16/04/2017
  1600                                          ;xor	eax, eax	; timeout error
  1601                                         	;stc
  1602 000003B4 C3                      	retn
  1603                                  
  1604                                  _r_ac97codec_ok:
  1605 000003B5 6631C0                          xor     eax, eax
  1606                                          ;mov	al, VIA_ACLINK_C00_READY ; 1
  1607 000003B8 FEC0                            inc	al
  1608 000003BA C3                      	retn
  1609                                  
  1610                                  warm_ac97codec_reset:
  1611                                  	; 11/11/2023
  1612                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  1613                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1614 000003BB 66B806000000            	mov	eax, 6
  1615 000003C1 BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1616 000003C4 0316[D60F]              	add	dx, [NABMBAR]
  1617 000003C8 66EF                    	out	dx, eax
  1618                                  
  1619 000003CA B90A00                  	mov	cx, 10	; total 1s
  1620                                  _warm_ac97c_rst_wait:
  1621 000003CD E84D00                  	call	delay_100ms
  1622                                  
  1623 000003D0 BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1624 000003D3 0316[D60F]              	add	dx, [NABMBAR]
  1625 000003D7 66ED                    	in	eax, dx
  1626                                  
  1627 000003D9 66A900030010            	test	eax, CTRL_ST_CREADY
  1628 000003DF 7504                    	jnz	short _warm_ac97c_rst_ok
  1629                                  
  1630 000003E1 49                              dec     cx
  1631 000003E2 75E9                            jnz     short _warm_ac97c_rst_wait
  1632                                  
  1633                                  _warm_ac97c_rst_fail:
  1634 000003E4 F9                              stc
  1635                                  _warm_ac97c_rst_ok:
  1636 000003E5 C3                      	retn
  1637                                  
  1638                                  cold_ac97codec_reset:
  1639                                  	; 11/11/2023
  1640                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  1641                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1642 000003E6 66B802000000                    mov	eax, 2
  1643 000003EC BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1644 000003EF 0316[D60F]              	add	dx, [NABMBAR]
  1645 000003F3 66EF                    	out	dx, eax
  1646                                  
  1647 000003F5 E82500                  	call	delay_100ms 	; wait 100 ms
  1648 000003F8 E82200                  	call	delay_100ms 	; wait 100 ms
  1649 000003FB E81F00                  	call	delay_100ms 	; wait 100 ms
  1650 000003FE E81C00                  	call	delay_100ms 	; wait 100 ms
  1651                                  
  1652 00000401 B91000                  	mov	cx, 16	; total 20*100 ms = 2s
  1653                                  
  1654                                  _cold_ac97c_rst_wait:
  1655 00000404 BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1656 00000407 0316[D60F]              	add	dx, [NABMBAR]
  1657 0000040B 66ED                    	in	eax, dx
  1658                                  
  1659 0000040D 66A900030010            	test	eax, CTRL_ST_CREADY
  1660 00000413 7507                    	jnz	short _cold_ac97c_rst_ok
  1661                                  
  1662 00000415 E80500                  	call	delay_100ms
  1663                                  
  1664 00000418 49                              dec     cx
  1665 00000419 75E9                            jnz     short _cold_ac97c_rst_wait
  1666                                  
  1667                                  _cold_ac97c_rst_fail:
  1668 0000041B F9                              stc
  1669                                  _cold_ac97c_rst_ok:
  1670 0000041C C3                      	retn
  1671                                  
  1672                                  delay_100ms:
  1673                                  	; 11/11/2023
  1674                                  	; 29/05/2017
  1675                                  	; 24/03/2017 ('codec.asm')
  1676                                  	; wait 100 ms
  1677 0000041D 51                      	push	cx
  1678 0000041E B99001                  	mov	cx, 400  ; 400*0.25ms
  1679                                  _delay_x_ms:
  1680 00000421 E8C007                  	call	delay1_4ms
  1681 00000424 E2FB                            loop	_delay_x_ms
  1682 00000426 59                      	pop	cx
  1683 00000427 C3                      	retn
  1684                                  
  1685                                  %endif
  1686                                  
  1687                                  ;=============================================================================
  1688                                  ;               ICH_WAV.ASM
  1689                                  ;=============================================================================
  1690                                  
  1691                                  ; DOS based .WAV player using AC'97 and codec interface.
  1692                                  ; ---------------------------------------------------------------
  1693                                  ; NASM version: Erdogan Tan (29/11/2016)
  1694                                  ; Last Update: 17/02/2017 (by Erdogan Tan)
  1695                                  
  1696                                  ; ICHWAV.ASM
  1697                                  ; PLAYMOD.ASM
  1698                                  ; player internal variables and other equates.
  1699                                  ;BUFFERSIZE	equ	2048*4		; 8K half buffer size. 18/02/2017
  1700                                  ; 14/05/2024
  1701                                  BUFFERSIZE	equ	2560*4
  1702                                  ENDOFFILE	equ	BIT0		; flag for knowing end of file
  1703                                  
  1704                                  ;===========================================================================
  1705                                  ; entry: none.  File is already open and [filehandle] filled.
  1706                                  ; exit:  not until the song is finished or the user aborts.
  1707                                  ;
  1708                                  ; 18/02/2017
  1709                                  ModPlay: ; 13/02/2017  ; ModPlay Polling!
  1710                                  	;cld
  1711                                  	; clear (half) buffer 2
  1712                                         	;mov	di, [DMA_BUFFER2]
  1713                                  	;sub	ax, ax
  1714                                  	;mov	cx, (BUFFERSIZE/2)
  1715                                  	;rep	stosw
  1716                                  
  1717                                  	; 15/05/2024
  1718 00000428 06                      	push	es
  1719 00000429 1E                      	push	ds
  1720 0000042A 07                      	pop	es
  1721 0000042B B94001                  	mov	cx, 320
  1722 0000042E BF[02C4]                	mov	di, MOD_BUFFER
  1723 00000431 B88080                  	mov	ax, 8080h
  1724 00000434 F3AB                    	rep	stosw
  1725 00000436 B900A0                  	mov	cx, 0A000h
  1726 00000439 8EC1                    	mov	es, cx
  1727 0000043B E8EF00                  	call	ScopeLoop
  1728 0000043E 07                      	pop	es
  1729                                  
  1730                                          ; load 2048 bytes into buffer 1
  1731 0000043F 8B36[E40F]              	mov	si, [DMA_BUFFER1]
  1732                                  	; 11/05/2024
  1733                                  	;mov	cx, BUFFERSIZE
  1734                                  	;push	ds ; segment
  1735                                  	;push	si ; offset
  1736                                  	;push	cx ; count
  1737 00000443 E89B06                  	call    GetSamples_ICH ; 18/02/2017
  1738                                  
  1739                                          ; load 2048 bytes into buffer  2
  1740 00000446 8B36[E60F]              	mov	si, [DMA_BUFFER2]
  1741                                  	; 11/05/2024
  1742                                  	;mov	cx, BUFFERSIZE
  1743                                  	;push	ds ; segment
  1744                                  	;push	si ; offset
  1745                                  	;push	cx ; count
  1746 0000044A E89406                  	call	GetSamples_ICH ; 18/02/2017
  1747                                  
  1748                                  ; register reset the DMA engine. This may cause a pop noise on the output
  1749                                  ; lines when the device is reset. Prolly a better idea to mute output, then
  1750                                  ; reset.
  1751                                  
  1752                                  	; 08/05/2024
  1753                                          ;mov    dx, [NABMBAR]
  1754                                          ;add    dx, PO_CR_REG		; set pointer to Ctrl reg
  1755                                          ;mov    al, RR			; set reset
  1756                                  	;out    dx, al			; self clearing bit
  1757                                  
  1758                                  ; write last valid index to 31 to start with.
  1759                                  ; The Last Valid Index register tells the DMA engine when to stop playing.
  1760                                  ; 
  1761                                  ; As we progress through the song we change the last valid index to always be
  1762                                  ; something other than the index we're currently playing.
  1763                                  ;
  1764                                          ;;mov   al, 1
  1765                                          ;mov	al, 31
  1766                                  	;call   setLastValidIndex
  1767                                  
  1768                                  ; create Buffer Descriptor List
  1769                                  ;
  1770                                  ; A buffer descriptor list is a list of pointers and control bits that the
  1771                                  ; DMA engine uses to know where to get the .wav data and how to play it.
  1772                                  ;
  1773                                  ; I set it up to use only 2 buffers of .wav data, and whenever 1 buffer is
  1774                                  ; playing, I refresh the other one with good data.
  1775                                  ;
  1776                                  ;
  1777                                  ; For the control bits, you can specify that the DMA engine fire an interrupt
  1778                                  ; after a buffer has been processed, but I poll the current index register
  1779                                  ; to know when it's safe to update the other buffer.
  1780                                  ;
  1781                                  ; I set the BUP bit, which tells the DMA engine to just play 0's (silence)
  1782                                  ; if it ever runs out of data to play. Good for safety.
  1783                                  ;
  1784                                  	; 14/02/2017
  1785 0000044D 8B3E[E20F]                      mov     di, [BDL_BUFFER]		; get BDL address
  1786 00000451 B91000                          mov     cx, 32 / 2                      ; make 32 entries in BDL
  1787 00000454 6631D2                  	xor	edx, edx
  1788 00000457 8CDA                    	mov	dx, ds
  1789 00000459 66C1E204                	shl	edx, 4 ; segment*16 (linear/physical address of the segment)
  1790                                  _0:
  1791                                  
  1792                                  ; set buffer descriptor 0 to start of data file in memory
  1793                                  	; 14/02/2017
  1794 0000045D 660FB706[E40F]                  movzx   eax, word [DMA_BUFFER1]
  1795 00000463 6601D0                  	add	eax, edx ; linear/physical address of the buffer (seg*16+off)
  1796 00000466 66AB                            stosd					; store dmabuffer1 address
  1797                                  
  1798                                  ;
  1799                                  ; set length to 32k samples. 1 sample is 16bits or 2bytes.
  1800                                  ; Set control (bits 31:16) to BUP, bits 15:0=number of samples.
  1801                                  ; 
  1802                                  
  1803                                  ; 17/02/2017 (Erdogan Tan)
  1804                                  ; Intel 82801AA (ICH) & Intel 82801AB (ICH0) I/O Controller Hub AC 97
  1805                                  ; Programmers Reference Manual
  1806                                  
  1807                                  ; 2.2.1 Buffer Descriptor List  (on Page 13)
  1808                                  	;
  1809                                  	;  Generic Form of Buffer Descriptor
  1810                                  	;  ---------------------------------
  1811                                  	;  63   62    61-48    47-32   31-0
  1812                                  	;  ---  ---  --------  ------- -----
  1813                                  	;  IOC  BUP -reserved- Buffer  Buffer
  1814                                  	;		      Length   Pointer
  1815                                  	;		      [15:0]   [31:0]
  1816                                  	;
  1817                                  	;  IOC:	Interrupt On Completion. 
  1818                                  	;	1 = Enabled. 
  1819                                  	;	    When this is set, it means that the controller should
  1820                                  	;	    issue an interrupt upon completion of this buffer.
  1821                                  	;	    It should also set the IOC bit in the status register
  1822                                  	;	0 = Disabled	
  1823                                  	;
  1824                                  	;  BUP: Buffer Underrun Policy.
  1825                                  	;       0 = When this buffer is complete,
  1826                                  	;	    if the next buffer is not yet ready 
  1827                                  	;	    (i.e., the last valid buffer has been processed),
  1828                                  	;	    then continue to transmit the last valid sample.
  1829                                  	;	1 = When this buffer is complete,
  1830                                  	;     	    if this is the last valid buffer, transmit zeros after
  1831                                  	;	    this buffer has been processed completely.
  1832                                  	;	    This bit typically is set only if this is the last 
  1833                                  	;	    buffer in the current stream.
  1834                                  	;
  1835                                  	; [31:0]: Buffer pointer. This field points to the location of
  1836                                  	;	  the data buffer. Since samples can be as wide as one
  1837                                  	;	  word, the buffer must be aligned with word boundaries,
  1838                                  	;	  to prevent samples from straddling DWord boundaries.
  1839                                  	;
  1840                                  	; [15:0]: Buffer Length: This is the length of the data buffer,
  1841                                  	;	  in number of samples. The controller uses this data
  1842                                  	;	  to determine the length of the buffer, in bytes.
  1843                                  	;	  "0" indicates no sample to process.
  1844                                  
  1845                                  ; ICH2AC97.INC
  1846                                  
  1847                                  ;	IOC	equ     BIT31   ; Fire an interrupt whenever this
  1848                                  				; buffer is complete.
  1849                                  
  1850                                  ;	BUP	equ     BIT30   ; Buffer Underrun Policy.
  1851                                  				; if this buffer is the last buffer
  1852                                  				; in a playback, fill the remaining
  1853                                  				; samples with 0 (silence) or not.
  1854                                  				; It's a good idea to set this to 1
  1855                                  				; for the last buffer in playback,
  1856                                  				; otherwise you're likely to get a lot
  1857                                  				; of noise at the end of the sound.
  1858                                  ;
  1859                                  ; Bits 15:0 contain the length of the buffer, in number of samples, which
  1860                                  ; are 16 bits each, coupled in left and right pairs, or 32bits each.
  1861                                  ; Luckily for us, that's the same format as .wav files.
  1862                                  ;
  1863                                  ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
  1864                                  ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
  1865                                  ;
  1866                                  ; A value of 0 in these bits means play no samples.
  1867                                  ;
  1868                                  	; 08/12/2016 - Erdogan Tan
  1869                                  	;mov	eax, BUFFERSIZE
  1870                                  	;or	eax, IOC + BUP
  1871                                  	; 12/05/2024
  1872 00000468 66B800140000            	mov	eax, BUFFERSIZE/2
  1873 0000046E 660D00000040            	or	eax, BUP ; (tuneloop without interrupt)
  1874 00000474 66AB                    	stosd
  1875                                  
  1876                                  ; 2nd buffer:
  1877                                  	; 14/02/2017
  1878 00000476 660FB706[E60F]                  movzx   eax, word [DMA_BUFFER2]
  1879 0000047C 6601D0                  	add	eax, edx ; linear/physical address of the buffer (seg*16+off)
  1880 0000047F 66AB                            stosd					; store dmabuffer2 address
  1881                                  
  1882                                  ; set length to 64k (32k of two 16 bit samples)
  1883                                  ; Set control (bits 31:16) to BUP, bits 15:0=number of samples
  1884                                  ; 
  1885                                  	; 08/12/2016 - Erdogan Tan
  1886                                  	;mov	eax, BUFFERSIZE
  1887                                  	;or	eax, IOC + BUP
  1888                                  	; 12/05/2024
  1889 00000481 66B800140000            	mov	eax, BUFFERSIZE/2
  1890                                  	; 12/05/2024
  1891 00000487 660D00000040            	or	eax, BUP ; (tuneloop without interrupt)
  1892 0000048D 66AB                    	stosd
  1893 0000048F E2CC                            loop    _0
  1894                                  
  1895                                  ;
  1896                                  ; tell the DMA engine where to find our list of Buffer Descriptors.
  1897                                  ; this 32bit value is a flat mode memory offset (ie no segment:offset)
  1898                                  ;
  1899                                  ; write NABMBAR+10h with offset of buffer descriptor list
  1900                                  ;
  1901 00000491 660FB706[E20F]                  movzx   eax, word [BDL_BUFFER]
  1902                                  	; 14/02/2017
  1903 00000497 6601D0                  	add	eax, edx ; linear/physical address of the BDL
  1904                                    	; 18/02/2017
  1905 0000049A 8B16[D60F]                      mov     dx, [NABMBAR]
  1906 0000049E 83C210                          add     dx, PO_BDBAR_REG                ; set pointer to BDL
  1907 000004A1 66EF                            out     dx, eax                         ; write to AC97 controller
  1908                                  
  1909                                  ;
  1910                                  ; All set.  Let's play some music.
  1911                                  ;
  1912                                  	; 08/12/2016
  1913                                  	; 07/10/2016
  1914                                          ;mov    al, 1
  1915 000004A3 B01F                            mov	al, 31
  1916                                  	; 08/05/2024
  1917 000004A5 A2[F20F]                	mov	[LVI], al ; 10/11/2023
  1918                                  	
  1919 000004A8 E8C800                  	call    setLastValidIndex
  1920                                  
  1921 000004AB C606[DB0F]01            	mov	byte [tLoop], 1 ; 30/11/2016
  1922                                  
  1923                                  ; 12/05/2024 (tuneloop, without interrupt)
  1924                                  %if 0
  1925                                  	; 12/05/2024	
  1926                                  	; 17/02/2017
  1927                                          ;mov    dx, [NABMBAR]
  1928                                          ;add    dx, PO_CR_REG                   ; PCM out Control Register
  1929                                          ;mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
  1930                                  	;			; (LVBI interrupt will not be enabled)
  1931                                          ;out    dx, al                          ; Start bus master operation.
  1932                                  
  1933                                  ; while DMA engine is running, examine current index and wait until it hits 1
  1934                                  ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
  1935                                  ; 64k.  Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
  1936                                     
  1937                                  	; 18/02/2017
  1938                                  	; 14/02/2017
  1939                                  	; 13/02/2017
  1940                                  	; 08/12/2016
  1941                                  	; 28/11/2016
  1942                                  
  1943                                  	push	es
  1944                                  	mov	ax, 0A000h
  1945                                  	mov	es, ax
  1946                                  	;mov	bp, DmaBuffer ; 14/02/2017
  1947                                  p_loop:
  1948                                  	mov     ah, 1			; any key pressed?
  1949                                  	int     16h			; no, Loop.
  1950                                  	jz	short q_loop
  1951                                  
  1952                                  	mov     ah, 0			; flush key buffer...
  1953                                  	int     16h
  1954                                  p_return:
  1955                                  	mov	byte [tLoop], 0	; 13/02/2017
  1956                                  	pop	es
  1957                                  	retn
  1958                                  q_loop:
  1959                                  	; 10/05/2024
  1960                                  	xor	ax, ax
  1961                                  	xchg	al, [tBuff] ; AL = [tBuff], [tBuff] = 0
  1962                                  	cmp	al, 1
  1963                                  	ja	short r_loop
  1964                                  	jb	short ScopeLoop
  1965                                  	;
  1966                                       	mov	si, [DMA_BUFFER1] ; [tBuff]=1 (from tuneLoop)
  1967                                         	jmp	short s_loop 
  1968                                  r_loop:
  1969                                  	; 13/02/2017
  1970                                          mov     si, [DMA_BUFFER2] ; [tBuff]=2 (from tuneLoop)
  1971                                  s_loop:
  1972                                  	; 14/02/2017
  1973                                  	;mov	bp, si ; save current buffer addres in bp register
  1974                                  	; 11/05/2024
  1975                                  	;mov	cx, BUFFERSIZE ; 2048*4 byte
  1976                                  	;push	ds ; segment
  1977                                  	;push	si ; offset
  1978                                  	;push	cx ; count
  1979                                  	call    GetSamples_ICH ; 18/02/2017
  1980                                  	;
  1981                                  ScopeLoop:
  1982                                  	;mov    si, bp			; get current samples
  1983                                  	mov	si, MOD_BUFFER ; 18/02/2017
  1984                                  	xor     cx, cx			; to be drawed ...
  1985                                  	xor     dx, dx
  1986                                  DrawLoop:       
  1987                                  	mov     bx, dx			; (save Index)
  1988                                  	mov     di, [Scope+bx]		; get old SCOPE pixel address
  1989                                  	mov     byte [es:di], 0		; erase it!
  1990                                  	lodsb				; get a sample (8-bit)
  1991                                  	mov     bl, al			; calc new pixel address...
  1992                                  	xor     bh, bh
  1993                                  	shl     bx, 1
  1994                                  	mov     di, [RowOfs+bx]
  1995                                  	add     di, cx
  1996                                  	mov     bx, dx			; (restore Index)
  1997                                  	mov     [Scope+bx], di		; save new address...
  1998                                  	mov     byte [es:di], 10 ; 0Ah	; and DRAW.
  1999                                  	add     dx, 2			; the next pixel...
  2000                                  	inc     cx
  2001                                  	cmp     cx, 320			; 320 pixels drawed?
  2002                                  	jb      short DrawLoop
  2003                                  	jmp	short p_loop
  2004                                  
  2005                                  tuneLoop:
  2006                                  	; 11/05/2024
  2007                                  	; 11/11/2023
  2008                                  	; 10/11/2023
  2009                                  	; 18/02/2017
  2010                                  	; 08/12/2016
  2011                                  	; 28/11/2016 - Erdogan Tan
  2012                                  
  2013                                  	; 11/05/2024
  2014                                  	cmp	byte [tLoop], 1
  2015                                  	jb	short tL3
  2016                                  	
  2017                                  	call    getCurrentIndex
  2018                                  
  2019                                  	; 10/11/2023
  2020                                  	cmp	al, [LVI]
  2021                                  	jne	short tL1
  2022                                  
  2023                                  	dec	ax
  2024                                  	and	al, 1Fh 
  2025                                  	call	setLastValidIndex
  2026                                  	xchg	al, [LVI]
  2027                                  tL1:
  2028                                  	test	al, BIT0
  2029                                  	jz	short tL2
  2030                                  
  2031                                  	; 11/05/2024
  2032                                  	mov	byte [tBuff], 1
  2033                                  	retn
  2034                                  tL2:	
  2035                                  	mov	byte [tBuff], 2
  2036                                  tL3:
  2037                                  	retn
  2038                                  
  2039                                  ; returns AL = current index value
  2040                                  getCurrentIndex:
  2041                                  	;push	dx
  2042                                  	mov	dx, [NABMBAR]
  2043                                  	add	dx, PO_CIV_REG
  2044                                  	in	al, dx
  2045                                  	;pop	dx
  2046                                  	retn
  2047                                  
  2048                                  ;input AL = index # to stop on
  2049                                  setLastValidIndex:
  2050                                  	;push	dx
  2051                                  	mov	dx, [NABMBAR]
  2052                                  	add	dx, PO_LVI_REG
  2053                                          out     dx, al
  2054                                  	;pop	dx
  2055                                  	retn
  2056                                  
  2057                                  %else
  2058                                  	; 12/05/2024
  2059                                  	; 17/02/2017
  2060 000004B0 8B16[D60F]                      mov     dx, [NABMBAR]
  2061 000004B4 83C21B                          add     dx, PO_CR_REG		; PCM out Control Register
  2062                                          ;mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
  2063                                  	;			; (LVBI interrupt will not be enabled)
  2064                                  	; 06/11/2023 (TUNELOOP version, without interrupt)
  2065 000004B7 B001                    	mov	al, RPBM
  2066 000004B9 EE                      	out     dx, al			; Start bus master operation.
  2067                                  
  2068 000004BA 06                      	push	es
  2069 000004BB B800A0                  	mov	ax, 0A000h
  2070 000004BE 8EC0                    	mov	es, ax
  2071                                  
  2072                                  	; 12/05/2024
  2073                                  ;p_loop:
  2074                                  ;	call	tuneLoop
  2075                                  ;	cmp	byte [tLoop], 0
  2076                                  ;	ja	short p_loop
  2077                                  ;	pop	es
  2078                                  ;	retn
  2079                                  
  2080                                  p_loop:
  2081 000004C0 B401                    	mov     ah, 1			; any key pressed?
  2082                                  	;mov	ah, 11h
  2083 000004C2 CD16                    	int     16h			; no, Loop.
  2084 000004C4 743D                    	jz	short q_loop
  2085                                  
  2086 000004C6 B400                    	mov	ah, 0
  2087                                  	;mov    ah, 10h			; flush key buffer...
  2088 000004C8 CD16                    	int     16h
  2089                                  
  2090                                  	; 12/05/2024 (change PCM out volume)
  2091 000004CA 3C2B                    	cmp	al, '+'
  2092 000004CC 750B                    	jne	short p_1
  2093                                  	
  2094 000004CE A0[F30F]                	mov	al, [volume]
  2095 000004D1 3C00                    	cmp	al, 0
  2096 000004D3 762E                    	jna	short q_loop
  2097 000004D5 FEC8                    	dec	al
  2098 000004D7 EB0D                    	jmp	short p_2
  2099                                  p_1:
  2100 000004D9 3C2D                    	cmp	al, '-'
  2101 000004DB 7524                    	jne	short p_return
  2102                                  
  2103 000004DD A0[F30F]                	mov	al, [volume]
  2104 000004E0 3C1F                    	cmp	al, 31
  2105 000004E2 731F                    	jnb	short q_loop	
  2106 000004E4 FEC0                    	inc	al
  2107                                  p_2:
  2108 000004E6 A2[F30F]                	mov	[volume], al
  2109 000004E9 88C4                    	mov	ah, al
  2110 000004EB 8B16[D40F]              	mov     dx, [NAMBAR]
  2111                                    	;add    dx, CODEC_MASTER_VOL_REG
  2112 000004EF 83C218                  	add	dx, CODEC_PCM_OUT_REG
  2113 000004F2 EF                      	out     dx, ax
  2114                                  
  2115                                  	; 12/05/2024
  2116 000004F3 E8EE06                  	call    delay1_4ms
  2117 000004F6 E8EB06                          call    delay1_4ms
  2118 000004F9 E8E806                          call    delay1_4ms
  2119 000004FC E8E506                          call    delay1_4ms
  2120                                  
  2121 000004FF EB02                    	jmp	short q_loop
  2122                                  
  2123                                  p_return:
  2124 00000501 07                      	pop	es
  2125 00000502 C3                      	retn
  2126                                  q_loop:
  2127                                  tuneLoop:
  2128                                  	; 12/05/2024
  2129                                  	; 18/11/2023 (ich_wav4.asm, Erdogan Tan)
  2130                                  tL1:
  2131 00000503 E85A00                  	call    updateLVI	; /set LVI != CIV/
  2132                                  	;call   check4keyboardstop
  2133                                  	;jc	short _exit_
  2134 00000506 E87300                  	call   getCurrentIndex
  2135 00000509 A801                    	test	al, BIT0
  2136 0000050B 74F6                    	jz	short tL1	; loop if buffer 2 is not playing
  2137                                  
  2138 0000050D 8B36[E40F]              	mov     si, [DMA_BUFFER1]
  2139 00000511 E8CD05                  	call    GetSamples_ICH
  2140                                  
  2141 00000514 E81600                  	call	ScopeLoop
  2142                                  tL2:
  2143 00000517 E84600                  	call    updateLVI
  2144                                  	;call   check4keyboardstop
  2145                                  	;jc	short _exit_
  2146 0000051A E85F00                  	call   getCurrentIndex
  2147 0000051D A801                    	test	al, BIT0
  2148 0000051F 75F6                    	jnz	short tL2	; loop if buffer 1 is not playing
  2149                                  
  2150 00000521 8B36[E60F]              	mov     si, [DMA_BUFFER2]
  2151 00000525 E8B905                  	call    GetSamples_ICH
  2152                                  
  2153 00000528 E80200                  	call	ScopeLoop
  2154 0000052B EB93                    	jmp	short p_loop
  2155                                  
  2156                                  ScopeLoop:
  2157                                  	;mov    si, bp			; get current samples
  2158 0000052D BE[02C4]                	mov	si, MOD_BUFFER ; 18/02/2017
  2159 00000530 31C9                    	xor     cx, cx			; to be drawed ...
  2160 00000532 31D2                    	xor     dx, dx
  2161                                  DrawLoop:       
  2162 00000534 89D3                    	mov     bx, dx			; (save Index)
  2163 00000536 8BBF[80BF]              	mov     di, [Scope+bx]		; get old SCOPE pixel address
  2164 0000053A 26C60500                	mov     byte [es:di], 0		; erase it!
  2165                                  	;lodsb				; get a sample (8-bit)
  2166                                  	; 14/05/2024
  2167 0000053E AD                      	lodsw
  2168 0000053F 88C3                    	mov     bl, al			; calc new pixel address...
  2169 00000541 30FF                    	xor     bh, bh
  2170 00000543 D1E3                    	shl     bx, 1
  2171 00000545 8BBF[00C2]              	mov     di, [RowOfs+bx]
  2172 00000549 01CF                    	add     di, cx
  2173 0000054B 89D3                    	mov     bx, dx			; (restore Index)
  2174 0000054D 89BF[80BF]              	mov     [Scope+bx], di		; save new address...
  2175 00000551 26C6050A                	mov     byte [es:di], 10 ; 0Ah	; and DRAW.
  2176 00000555 83C202                  	add     dx, 2			; the next pixel...
  2177 00000558 41                      	inc     cx
  2178 00000559 81F94001                	cmp     cx, 320			; 320 pixels drawed?
  2179 0000055D 72D5                    	jb      short DrawLoop
  2180 0000055F C3                      	retn
  2181                                  	
  2182                                  ;_exit_:
  2183                                  	;mov	byte [tLoop], 0
  2184                                  	;retn
  2185                                  
  2186                                  	; 12/05/2024
  2187                                  updateLVI:
  2188                                  	; 06/11/2023
  2189 00000560 8B16[D60F]              	mov	dx, [NABMBAR]
  2190 00000564 83C214                  	add	dx, PO_CIV_REG
  2191                                  	; (Current Index Value and Last Valid Index value)
  2192 00000567 ED                      	in	ax, dx
  2193                                  
  2194 00000568 38E0                    	cmp	al, ah ; is current index = last index ?
  2195 0000056A 750F                    	jne	short uLVI_exit ; 12/05/2024
  2196                                  
  2197                                  	; 08/11/2023	
  2198 0000056C E80D00                  	call	getCurrentIndex
  2199                                  
  2200 0000056F FEC8                    	dec	al
  2201 00000571 241F                    	and	al, 1Fh
  2202                                  
  2203                                  ;input AL = index # to stop on
  2204                                  setLastValidIndex:
  2205                                  	; 08/11/2023
  2206                                  	;push	dx
  2207 00000573 8B16[D60F]              	mov	dx, [NABMBAR]
  2208 00000577 83C215                  	add	dx, PO_LVI_REG
  2209 0000057A EE                              out     dx, al
  2210                                  	;pop	dx
  2211                                  uLVI_exit:	; 12/05/2024
  2212 0000057B C3                      	retn
  2213                                  
  2214                                  ; returns AL = current index value
  2215                                  getCurrentIndex:
  2216                                  	;push	dx
  2217 0000057C 8B16[D60F]              	mov	dx, [NABMBAR]
  2218 00000580 83C214                  	add	dx, PO_CIV_REG
  2219 00000583 EC                      	in	al, dx
  2220                                  	;pop	dx
  2221 00000584 C3                      	retn
  2222                                  
  2223                                  	; 12/05/2024
  2224                                  check4keyboardstop:
  2225                                  	; 08/11/2023
  2226                                  	; 04/11/2023
  2227 00000585 B401                    	mov	ah, 1
  2228 00000587 CD16                    	int	16h
  2229 00000589 7405                    	jz	short _cksr
  2230 0000058B 30E4                    	xor	ah, ah
  2231 0000058D CD16                    	int	16h
  2232 0000058F F9                      	stc
  2233                                  _cksr:
  2234 00000590 C3                      	retn
  2235                                  
  2236                                  %endif
  2237                                  
  2238                                  ;=============================================================================
  2239                                  ;               MODLOAD.ASM
  2240                                  ;=============================================================================
  2241                                  
  2242                                  ; Amiga Module Loader v0.1b by Carlos Hasan.
  2243                                  ;		July 10th, 1993.
  2244                                  
  2245                                  ; STRUCTURES
  2246                                  
  2247                                  struc ModSample
  2248 00000000 <res 16h>               .msName:	resb 22
  2249 00000016 ????                    .msLength:	resw 1
  2250 00000018 ??                      .msFinetune:	resb 1
  2251 00000019 ??                      .msVolume:	resb 1
  2252 0000001A ????                    .msRepeat:	resw 1
  2253 0000001C ????                    .msRepLen:	resw 1
  2254                                  .size:
  2255                                  endstruc
  2256                                  
  2257                                  struc ModHeader
  2258 00000000 <res 14h>               .mhName:	resb 20
  2259 00000014 <res 3A2h>              .mhSamples:	resb ModSample.size*31
  2260 000003B6 ??                      .mhOrderLen:	resb 1
  2261 000003B7 ??                      .mhReStart:	resb 1
  2262 000003B8 <res 80h>               .mhOrder:	resb 128
  2263 00000438 ????????                .mhSign:	resw 2
  2264                                  .size:	
  2265                                  endstruc
  2266                                  
  2267                                  struc ModInfoRec
  2268 00000000 ??                      .OrderLen:	resb 1
  2269 00000001 ??                      .ReStart:	resb 1
  2270 00000002 <res 80h>               .Order:		resb 128
  2271 00000082 ????????                .Patterns:	resd 1
  2272 00000086 <res 3Eh>               .SampOfs:	resw 31
  2273 000000C4 <res 3Eh>               .SampSeg:	resw 31
  2274 00000102 <res 3Eh>               .SampLen:	resw 31
  2275 00000140 <res 3Eh>               .SampRep:	resw 31
  2276 0000017E <res 3Eh>               .SampRepLen:	resw 31
  2277 000001BC <res 3Eh>               .SampVol:	resw 31
  2278                                  .size:	
  2279                                  endstruc
  2280                                  
  2281                                  ; CODE
  2282                                  
  2283                                  LoadModule:
  2284                                  		;es:di = filename
  2285                                  
  2286                                  		;[sp+4] = es
  2287                                  		;[sp+2] = di
  2288                                  
  2289                                  		FileName equ 4		
  2290                                  
  2291 00000591 55                      		push    bp
  2292 00000592 89E5                    		mov     bp, sp
  2293 00000594 60                      		pusha
  2294 00000595 1E                      		push    ds
  2295 00000596 06                      		push    es
  2296                                  
  2297 00000597 C706[F660]0100          		mov	word [ErrorInfo], 1
  2298                                  
  2299 0000059D E85101                  		call    ClearModInfo
  2300                                  OpenFile:       
  2301 000005A0 1E                      		push    ds
  2302 000005A1 B8003D                  		mov     ax, 3D00h
  2303 000005A4 C55604                  		lds     dx, [bp+FileName]
  2304 000005A7 CD21                    		int     21h
  2305 000005A9 1F                      		pop     ds
  2306 000005AA 0F823C01                		jc      Failed
  2307 000005AE A3[F460]                		mov     [FileHandle], ax
  2308                                  
  2309                                  ReadHeader:     
  2310 000005B1 B8003F                  		mov     ax, 3F00h
  2311 000005B4 8B1E[F460]              		mov     bx, [FileHandle]
  2312 000005B8 B93C04                  		mov     cx, ModHeader.size
  2313                                  		;lea    dx, [Header]
  2314 000005BB BA[F860]                		mov	dx, Header
  2315 000005BE CD21                    		int     21h
  2316 000005C0 0F821D01                		jc      CloseFile
  2317                                  CheckMK:        
  2318 000005C4 813E[3065]4D2E          		cmp     word [Header+ModHeader.mhSign], 'M.'
  2319 000005CA 7508                    		jne     short CheckFLT4
  2320 000005CC 813E[3265]4B2E          		cmp     word [Header+ModHeader.mhSign+2], 'K.'
  2321 000005D2 7439                    		je      short IsModFile
  2322                                  CheckFLT4:
  2323 000005D4 813E[3065]464C          		cmp     word [Header+ModHeader.mhSign], 'FL'
  2324 000005DA 7508                    		jne     short Is15Inst
  2325 000005DC 813E[3265]5434          		cmp     word [Header+ModHeader.mhSign+2], 'T4'
  2326 000005E2 7429                    		je      short IsModFile
  2327                                  Is15Inst:
  2328 000005E4 BE[CE62]                		mov     si, (Header+ModHeader.mhSamples) + (15*ModSample.size)
  2329 000005E7 BF[AE64]                		mov     di, Header+ModHeader.mhOrderLen
  2330 000005EA 8CD8                    		mov     ax, ds
  2331 000005EC 8EC0                    		mov     es, ax
  2332 000005EE FC                      		cld
  2333 000005EF B98200                  		mov     cx, 130
  2334 000005F2 F3A4                    		rep     movsb
  2335 000005F4 BF[CE62]                		mov     di, Header+ModHeader.mhSamples + (15*ModSample.size)
  2336 000005F7 31C0                    		xor     ax, ax
  2337 000005F9 B9E001                  		mov     cx, 16*ModSample.size
  2338 000005FC F3AA                    		rep     stosb
  2339                                  SeekPatterns:   
  2340 000005FE B80042                  		mov     ax, 4200h
  2341 00000601 8B1E[F460]              		mov     bx, [FileHandle]
  2342 00000605 B90000                  		mov     cx, 0
  2343 00000608 BA5802                  		mov     dx, 600
  2344 0000060B CD21                    		int     21h
  2345                                  IsModFile:  
  2346 0000060D A0[AE64]                		mov     al, [Header+ModHeader.mhOrderLen]
  2347 00000610 A2[3665]                		mov     [ModInfo.OrderLen], al
  2348                                  
  2349 00000613 A0[AF64]                		mov     al, [Header+ModHeader.mhReStart]
  2350 00000616 3A06[AE64]              		cmp     al, [Header+ModHeader.mhOrderLen]
  2351 0000061A 7202                    		jb      short SetReStart
  2352 0000061C B07F                    		mov     al, 7Fh
  2353                                  SetReStart:
  2354 0000061E A2[3765]                		mov     [ModInfo.ReStart], al
  2355                                  
  2356 00000621 B98000                  		mov     cx, 128
  2357 00000624 31C0                    		xor     ax, ax
  2358 00000626 31DB                    		xor     bx, bx
  2359                                  CopyOrder:
  2360 00000628 8AA7[B064]              		mov     ah, [Header+ModHeader.mhOrder+bx]
  2361 0000062C 88A7[3865]              		mov     [ModInfo.Order+bx], ah
  2362 00000630 38C4                    		cmp     ah, al
  2363 00000632 7202                    		jb      short NextOrder
  2364 00000634 88E0                    		mov     al, ah
  2365                                  NextOrder:
  2366 00000636 43                      		inc     bx
  2367 00000637 E2EF                    		loop    CopyOrder
  2368                                  AllocPatterns:  
  2369                                  		; Erdogan Tan (13/02/2017)
  2370 00000639 30E4                    		xor	ah, ah
  2371 0000063B FEC0                    		inc	al
  2372                                  		; al = count of 1024 bytes
  2373 0000063D 89C3                    		mov	bx, ax
  2374                                  		; count of paragraphs = al*64 
  2375 0000063F C1E006                  		shl	ax, 6 ; *64
  2376 00000642 89C5                    		mov	bp, ax
  2377 00000644 8CCA                    		mov	dx, cs ; current (code) segment
  2378 00000646 81C20010                		add	dx, 1000h ; next 64K (4096*16)
  2379                                  		;
  2380 0000064A C706[B865]0000          		mov	word [ModInfo.Patterns], 0
  2381 00000650 8916[BA65]              		mov	[ModInfo.Patterns+2], dx
  2382                                  		;
  2383 00000654 01D5                    		add	bp, dx ; next segment for samples
  2384                                  ReadPatterns:   
  2385 00000656 1E                      		push    ds
  2386 00000657 B8003F                  		mov     ax, 3F00h
  2387 0000065A 89D9                    		mov     cx, bx ; count of 1024 bytes
  2388 0000065C C1E10A                  		shl     cx, 10 ; byte count (cx*1024)
  2389 0000065F 8B1E[F460]              		mov     bx, [FileHandle]
  2390                                  		;lds    dx, [ModInfo.Patterns]
  2391 00000663 8EDA                    		mov	ds, dx
  2392 00000665 31D2                    		xor	dx, dx
  2393 00000667 CD21                    		int     21h
  2394 00000669 1F                      		pop     ds
  2395 0000066A 7275                    		jc      CloseFile
  2396                                  
  2397                                  		;lea	si, [Header+ModHeader.mhSamples]
  2398 0000066C BE[0C61]                		mov	si, Header+ModHeader.mhSamples
  2399 0000066F 31FF                    		xor     di, di
  2400                                  CopySamples:
  2401 00000671 8B4416                  		mov     ax, [si+ModSample.msLength]
  2402 00000674 86C4                    		xchg    al, ah
  2403 00000676 D1E0                    		shl     ax, 1
  2404 00000678 8985[3866]              		mov     [ModInfo.SampLen+di], ax
  2405 0000067C 8A4419                  		mov     al, [si+ModSample.msVolume]
  2406 0000067F 30E4                    		xor     ah, ah
  2407 00000681 8985[F266]              		mov     [ModInfo.SampVol+di], ax
  2408 00000685 8B441A                  		mov     ax, [si+ModSample.msRepeat]
  2409 00000688 86C4                    		xchg    al, ah
  2410 0000068A D1E0                    		shl     ax, 1
  2411 0000068C 8985[7666]              		mov     [ModInfo.SampRep+di], ax
  2412 00000690 8B441C                  		mov     ax, [si+ModSample.msRepLen]
  2413 00000693 86C4                    		xchg    al, ah
  2414 00000695 D1E0                    		shl     ax, 1
  2415 00000697 8985[B466]              		mov     [ModInfo.SampRepLen+di], ax
  2416 0000069B 83C61E                  		add     si, ModSample.size
  2417 0000069E 83C702                  		add     di, 2
  2418 000006A1 83FF3E                  		cmp     di, 2*31
  2419 000006A4 72CB                    		jb      short CopySamples
  2420                                  
  2421 000006A6 31F6                    		xor     si, si
  2422                                  AllocSamples:
  2423                                  		; Erdogan Tan (13/02/2017)
  2424                                  		;mov	bx, [ModInfo.SampLen+si]
  2425 000006A8 8B8C[3866]              		mov	cx, [ModInfo.SampLen+si]
  2426 000006AC 89CB                    		mov	bx, cx
  2427 000006AE C1EB04                  		shr     bx, 4 ; byte count / 16
  2428 000006B1 7420                    		jz      short NextSample
  2429 000006B3 43                      		inc	bx ; number of paragraphs
  2430 000006B4 C784[BC65]0000          		mov	word [ModInfo.SampOfs+si], 0
  2431 000006BA 89AC[FA65]              		mov     [ModInfo.SampSeg+si], bp
  2432 000006BE 89EA                    		mov	dx, bp
  2433 000006C0 01DD                    		add	bp, bx ; next segment for sample 
  2434                                  ReadSample:
  2435 000006C2 1E                      		push    ds
  2436 000006C3 B8003F                  		mov     ax, 3F00h
  2437 000006C6 8B1E[F460]              		mov     bx, [FileHandle]
  2438                                  		;mov    cx, [ModInfo.SampLen+si]
  2439                                  		;mov    dx, [ModInfo.SampOfs+si]
  2440                                  		;mov    ds, [ModInfo.SampSeg+si]
  2441 000006CA 8EDA                    		mov	ds, dx
  2442 000006CC 31D2                    		xor	dx, dx	
  2443 000006CE CD21                    		int     21h
  2444 000006D0 1F                      		pop     ds
  2445 000006D1 720E                    		jc      short CloseFile
  2446                                  NextSample:
  2447 000006D3 83C602                  		add     si, 2
  2448 000006D6 83FE3E                  		cmp     si, 2*31
  2449 000006D9 72CD                    		jb      short AllocSamples
  2450                                  
  2451 000006DB C706[F660]0000          		mov     word [ErrorInfo], 0
  2452                                  CloseFile:      
  2453 000006E1 B8003E                  		mov     ax, 3E00h
  2454 000006E4 8B1E[F460]              		mov     bx, [FileHandle]
  2455 000006E8 CD21                    		int     21h
  2456                                  Failed:         
  2457 000006EA 07                      		pop     es
  2458 000006EB 1F                      		pop     ds
  2459 000006EC 61                      		popa
  2460 000006ED 5D                      		pop     bp
  2461 000006EE C20400                  		ret	4
  2462                                  
  2463                                  FreeModule:
  2464                                  		; Erdogan Tan (13/02/2017)
  2465                                  		; nothing to do here for memory de-allocation
  2466                                  ClearModInfo:
  2467 000006F1 60                      		pusha
  2468 000006F2 06                      		push    es
  2469 000006F3 8CD8                    		mov     ax, ds
  2470 000006F5 8EC0                    		mov     es, ax
  2471                                  		;lea    di, [ModInfo]
  2472 000006F7 BF[3665]                		mov	di, ModInfo
  2473 000006FA B9FA01                  		mov     cx, ModInfoRec.size
  2474 000006FD FC                      		cld
  2475 000006FE 31C0                    		xor     ax, ax
  2476 00000700 F3AA                    		rep     stosb
  2477 00000702 07                      		pop     es
  2478 00000703 61                      		popa
  2479 00000704 C3                      		retn
  2480                                  
  2481                                  ;=============================================================================
  2482                                  ;               MODPLAY.ASM
  2483                                  ;=============================================================================
  2484                                  
  2485                                  ; Amiga Module Player v0.3b by Carlos Hasan.
  2486                                  ;		July 23th, 1993.
  2487                                  
  2488                                  ; EQUATES
  2489                                  
  2490                                  NumTracks       equ 4
  2491                                  DefTempo        equ 6
  2492                                  DefBpm          equ 125
  2493                                  MidCRate        equ 8448
  2494                                  MixBufSize      equ 4096
  2495                                  
  2496                                  ; STRUCTURES
  2497                                  
  2498                                  struc TrackInfo
  2499 00000000 ????????                .Samples:	resd 1
  2500 00000004 ????                    .Position:	resw 1
  2501 00000006 ????                    .Len:		resw 1
  2502 00000008 ????                    .Repeat:	resw 1
  2503 0000000A ????                    .RepLen:	resw 1
  2504 0000000C ??                      .Volume: 	resb 1
  2505 0000000D ??                      .Error:		resb 1
  2506 0000000E ????                    .Period:	resw 1
  2507 00000010 ????                    .Pitch:		resw 1
  2508 00000012 ????                    .Effect:	resw 1
  2509 00000014 ????                    .PortTo:	resw 1
  2510 00000016 ??                      .PortParm:	resb 1
  2511 00000017 ??                      .VibPos:	resb 1
  2512 00000018 ??                      .VibParm:	resb 1
  2513 00000019 ??                      .OldSampOfs:	resb 1
  2514 0000001A ????????????            .Arp:		resw 3
  2515 00000020 ????                    .ArpIndex:	resw 1
  2516                                  .size:
  2517                                  endstruc
  2518                                  
  2519                                  ; CODE
  2520                                  
  2521                                  ;--------------------------------------------------------------------------
  2522                                  ; BeatTrack:  Process the next beat in one track.
  2523                                  ;  In:
  2524                                  ;    ds:di -  Track info Address.
  2525                                  ;--------------------------------------------------------------------------
  2526                                  
  2527                                  BeatTrack:
  2528 00000705 8B5512                  		mov     dx, [di+TrackInfo.Effect]
  2529 00000708 85D2                    		test    dx, dx
  2530 0000070A 7430                    		je      short None
  2531 0000070C 80FE00                  		cmp     dh, 00h
  2532 0000070F 742C                    		je      short Arpeggio
  2533 00000711 80FE01                  		cmp     dh, 01h
  2534 00000714 743E                    		je      short PortUp
  2535 00000716 80FE02                  		cmp     dh, 02h
  2536 00000719 7455                    		je      short PortDown
  2537 0000071B 80FE03                  		cmp     dh, 03h
  2538 0000071E 746D                    		je      short TonePort
  2539 00000720 80FE04                  		cmp     dh, 04h
  2540 00000723 0F849100                		je      Vibrato
  2541 00000727 80FE05                  		cmp     dh, 05h
  2542 0000072A 0F84D600                		je      PortSlide
  2543 0000072E 80FE06                  		cmp     dh, 06h
  2544 00000731 0F84D700                		je      VibSlide
  2545 00000735 80FE0A                  		cmp     dh, 0Ah
  2546 00000738 0F84D800                		je      VolSlide
  2547                                  None:           
  2548 0000073C C3                      		retn
  2549                                  Arpeggio:
  2550 0000073D 8B5D20                  		mov     bx, [di+TrackInfo.ArpIndex]
  2551 00000740 8B411A                  		mov     ax, [di+TrackInfo.Arp+bx]
  2552 00000743 894510                  		mov     [di+TrackInfo.Pitch], ax
  2553 00000746 83C302                  		add     bx, 2
  2554 00000749 83FB06                  		cmp     bx, 6
  2555 0000074C 7202                    		jb      short SetArpIndex
  2556 0000074E 31DB                    		xor     bx,bx
  2557                                  SetArpIndex:
  2558 00000750 895D20                  		mov     [di+TrackInfo.ArpIndex], bx
  2559 00000753 C3                      		retn
  2560                                  PortUp:
  2561 00000754 30F6                    		xor     dh, dh
  2562 00000756 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2563 00000759 29D3                    		sub     bx, dx
  2564 0000075B 83FB71                  		cmp     bx, 113
  2565 0000075E 7D03                    		jge     short NotSmall
  2566 00000760 BB7100                  		mov     bx, 113
  2567                                  NotSmall:
  2568 00000763 895D0E                  		mov     [di+TrackInfo.Period], bx
  2569 00000766 01DB                    		add     bx, bx
  2570 00000768 8B87[3067]              		mov     ax, [PitchTable+bx]
  2571 0000076C 894510                  		mov     [di+TrackInfo.Pitch], ax
  2572 0000076F C3                      		retn
  2573                                  PortDown:
  2574 00000770 30F6                    		xor     dh, dh
  2575 00000772 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2576 00000775 01D3                    		add     bx, dx
  2577 00000777 81FB5803                		cmp     bx, 856
  2578 0000077B 7E03                    		jle     short NotBig
  2579 0000077D BB5803                  		mov     bx, 856
  2580 00000780 895D0E                  NotBig:         mov     [di+TrackInfo.Period], bx
  2581 00000783 01DB                    		add     bx, bx
  2582 00000785 8B87[3067]              		mov     ax, [PitchTable+bx]
  2583 00000789 894510                  		mov     [di+TrackInfo.Pitch], ax
  2584 0000078C C3                      		retn
  2585                                  TonePort:
  2586 0000078D 30F6                    		xor     dh, dh
  2587 0000078F 8B4514                  		mov     ax, [di+TrackInfo.PortTo]
  2588 00000792 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2589 00000795 39C3                    		cmp     bx, ax
  2590 00000797 741E                    		je      short NoPort
  2591 00000799 7F0A                    		jg      short PortToUp
  2592                                  PortToDown:     
  2593 0000079B 01D3                    		add     bx, dx
  2594 0000079D 39C3                    		cmp     bx, ax
  2595 0000079F 7E0A                    		jle     short SetPort
  2596                                  FixPort:        
  2597 000007A1 89C3                    		mov     bx, ax
  2598 000007A3 EB06                    		jmp     short SetPort
  2599                                  PortToUp:
  2600 000007A5 29D3                    		sub     bx, dx
  2601 000007A7 39C3                    		cmp     bx, ax
  2602 000007A9 7CF6                    		jl      short FixPort
  2603                                  SetPort:        
  2604 000007AB 895D0E                  		mov     [di+TrackInfo.Period], bx
  2605 000007AE 01DB                    		add     bx, bx
  2606 000007B0 8B87[3067]              		mov     ax, [PitchTable+bx]
  2607 000007B4 894510                  		mov     [di+TrackInfo.Pitch], ax
  2608                                  NoPort:         
  2609 000007B7 C3                      		retn
  2610                                  Vibrato:
  2611 000007B8 88D6                    		mov     dh, dl
  2612 000007BA 80E20F                  		and     dl, 0Fh
  2613 000007BD C0EE04                  		shr     dh, 4
  2614 000007C0 C0E602                  		shl     dh, 2
  2615 000007C3 007517                  		add     [di+TrackInfo.VibPos], dh
  2616 000007C6 8A7517                  		mov     dh, [di+TrackInfo.VibPos]
  2617 000007C9 88F3                    		mov     bl, dh
  2618 000007CB C0EB02                  		shr     bl, 2
  2619 000007CE 83E31F                  		and     bx, 1Fh
  2620 000007D1 8A87[5C0E]              		mov     al, [SinTable+bx]
  2621 000007D5 F6E2                    		mul     dl
  2622 000007D7 D1C0                    		rol     ax, 1
  2623 000007D9 86C4                    		xchg    al, ah
  2624 000007DB 80E401                  		and     ah, 1
  2625 000007DE 84F6                    		test    dh, dh
  2626 000007E0 7902                    		jns     short VibUp
  2627 000007E2 F7D8                    		neg     ax
  2628                                  VibUp:          
  2629 000007E4 03450E                  		add     ax, [di+TrackInfo.Period]
  2630 000007E7 89C3                    		mov     bx, ax
  2631 000007E9 83FB71                  		cmp     bx, 113
  2632 000007EC 7D03                    		jge     short NoLoVib
  2633 000007EE BB7100                  		mov     bx, 113
  2634                                  NoLoVib:        
  2635 000007F1 81FB5803                		cmp     bx, 856
  2636 000007F5 7E03                    		jle     short NoHiVib
  2637 000007F7 BB5803                  		mov     bx, 856
  2638                                  NoHiVib:        
  2639 000007FA 01DB                    		add     bx, bx
  2640 000007FC 8B87[3067]              		mov     ax, [PitchTable+bx]
  2641 00000800 894510                  		mov     [di+TrackInfo.Pitch], ax
  2642 00000803 C3                      		retn
  2643                                  PortSlide:
  2644 00000804 E80D00                  		call    VolSlide
  2645 00000807 8A5516                  		mov     dl, [di+TrackInfo.PortParm]
  2646 0000080A EB81                    		jmp     short TonePort
  2647                                  VibSlide:
  2648 0000080C E80500                  		call    VolSlide
  2649 0000080F 8A5518                  		mov     dl, [di+TrackInfo.VibParm]
  2650 00000812 EBA4                    		jmp     short Vibrato
  2651                                  VolSlide:
  2652 00000814 88D6                    		mov     dh, dl
  2653 00000816 80E20F                  		and     dl, 0Fh
  2654 00000819 C0EE04                  		shr     dh, 4
  2655 0000081C 8A450C                  		mov     al, [di+TrackInfo.Volume]
  2656 0000081F 28D0                    		sub     al, dl
  2657 00000821 7D02                    		jge     short NoLoVol
  2658 00000823 30C0                    		xor     al, al
  2659                                  NoLoVol:        
  2660 00000825 00F0                    		add     al, dh
  2661 00000827 3C40                    		cmp     al, 64
  2662 00000829 7602                    		jbe     short NoHiVol
  2663 0000082B B040                    		mov     al, 64
  2664                                  NoHiVol:        
  2665 0000082D 88450C                  		mov     [di+TrackInfo.Volume], al
  2666 00000830 C3                      		retn
  2667                                  
  2668                                  ;--------------------------------------------------------------------------
  2669                                  ; GetTrack:   Get the next Note from a pattern.
  2670                                  ;  In:
  2671                                  ;    ds:di -  Track info Address.
  2672                                  ;    es:si -  Pattern Note Address.
  2673                                  ; Out:
  2674                                  ;    es:si -  The Next Pattern Note address.
  2675                                  ;--------------------------------------------------------------------------
  2676                                  
  2677                                  GetTrack:
  2678 00000831 26AD                    		es lodsw
  2679 00000833 86C4                    		xchg    al, ah
  2680 00000835 88E3                    		mov     bl, ah
  2681 00000837 80E40F                  		and     ah, 0Fh
  2682 0000083A 89C1                    		mov     cx, ax
  2683 0000083C 26AD                    		es lodsw
  2684 0000083E 86C4                    		xchg    al, ah
  2685 00000840 88E7                    		mov     bh, ah
  2686 00000842 80E40F                  		and     ah, 0Fh
  2687 00000845 89C2                    		mov     dx, ax
  2688 00000847 895512                  		mov     [di+TrackInfo.Effect], dx
  2689 0000084A 80E3F0                  		and     bl, 0F0h
  2690 0000084D C0EF04                  		shr     bh, 4
  2691 00000850 08FB                    		or      bl, bh
  2692 00000852 742E                    		je      short SetPeriod
  2693                                  SetSample:
  2694 00000854 30FF                    		xor     bh, bh
  2695 00000856 4B                      		dec     bx
  2696 00000857 01DB                    		add     bx, bx
  2697 00000859 8B87[F266]              		mov     ax, [ModInfo.SampVol+bx]
  2698 0000085D 88450C                  		mov     [di+TrackInfo.Volume], al
  2699 00000860 8B87[BC65]              		mov     ax, [ModInfo.SampOfs+bx]
  2700 00000864 8905                    		mov     [di+TrackInfo.Samples], ax
  2701 00000866 8B87[FA65]              		mov     ax, [ModInfo.SampSeg+bx]
  2702 0000086A 894502                  		mov     [di+TrackInfo.Samples+2], ax
  2703 0000086D 8B87[3866]              		mov     ax, [ModInfo.SampLen+bx]
  2704 00000871 894506                  		mov     [di+TrackInfo.Len], ax
  2705 00000874 8B87[7666]              		mov     ax, [ModInfo.SampRep+bx]
  2706 00000878 894508                  		mov     [di+TrackInfo.Repeat], ax
  2707 0000087B 8B87[B466]              		mov     ax, [ModInfo.SampRepLen+bx]
  2708 0000087F 89450A                  		mov     [di+TrackInfo.RepLen], ax
  2709                                  SetPeriod:      
  2710 00000882 85C9                    		test    cx, cx
  2711 00000884 741B                    		je      short SetEffect
  2712                                  
  2713 00000886 894D14                  		mov     [di+TrackInfo.PortTo], cx
  2714 00000889 80FE03                  		cmp     dh, 03h
  2715 0000088C 7413                    		je      short SetEffect
  2716                                  
  2717 0000088E 894D0E                  		mov     [di+TrackInfo.Period], cx
  2718 00000891 89CB                    		mov     bx, cx
  2719 00000893 01DB                    		add     bx, bx
  2720 00000895 8B87[3067]              		mov     ax, [PitchTable+bx]
  2721 00000899 894510                  		mov     [di+TrackInfo.Pitch], ax
  2722 0000089C C745040000              		mov     word [di+TrackInfo.Position], 0
  2723                                  SetEffect:
  2724 000008A1 85D2                    		test    dx, dx
  2725 000008A3 742A                    		je      short InitNone
  2726 000008A5 80FE00                  		cmp     dh, 00h
  2727 000008A8 0F84C400                		je      InitArpeggio
  2728 000008AC 80FE03                  		cmp     dh, 03h
  2729 000008AF 741F                    		je      short InitTonePort
  2730 000008B1 80FE04                  		cmp     dh, 04h
  2731 000008B4 7428                    		je      short InitVibrato
  2732 000008B6 80FE09                  		cmp     dh, 09h
  2733 000008B9 744A                    		je      short SampleOfs
  2734 000008BB 80FE0B                  		cmp     dh, 0Bh
  2735 000008BE 7457                    		je      short PosJump
  2736 000008C0 80FE0C                  		cmp     dh, 0Ch
  2737 000008C3 745C                    		je      short SetVolume
  2738 000008C5 80FE0D                  		cmp     dh, 0Dh
  2739 000008C8 7462                    		je      short Break
  2740 000008CA 80FE0F                  		cmp     dh, 0Fh
  2741 000008CD 7478                    		je      short SetSpeed
  2742                                  InitNone:
  2743 000008CF C3                      		retn
  2744                                  InitTonePort:
  2745 000008D0 84D2                    		test    dl, dl
  2746 000008D2 7503                    		jne     short SetPortParm
  2747 000008D4 8A5516                  		mov     dl, [di+TrackInfo.PortParm]
  2748                                  SetPortParm:    
  2749 000008D7 885516                  		mov     [di+TrackInfo.PortParm], dl
  2750 000008DA 895512                  		mov     [di+TrackInfo.Effect], dx
  2751 000008DD C3                      		retn
  2752                                  InitVibrato:
  2753 000008DE 8A4518                  		mov     al, [di+TrackInfo.VibParm]
  2754 000008E1 88C4                    		mov     ah, al
  2755 000008E3 240F                    		and     al, 0Fh
  2756 000008E5 80E4F0                  		and     ah, 0F0h
  2757 000008E8 F6C20F                  		test    dl, 0Fh
  2758 000008EB 7502                    		jne     short OkDepth
  2759 000008ED 08C2                    		or      dl, al
  2760                                  OkDepth:        
  2761 000008EF F6C2F0                  		test    dl, 0F0h
  2762 000008F2 7502                    		jne     short OkRate
  2763 000008F4 08E2                    		or      dl, ah
  2764                                  OkRate:         
  2765 000008F6 885518                  		mov     [di+TrackInfo.VibParm], dl
  2766 000008F9 895512                  		mov     [di+TrackInfo.Effect], dx
  2767 000008FC 85C9                    		test    cx, cx
  2768 000008FE 7404                    		je      short OkPos
  2769 00000900 C6451700                		mov     byte [di+TrackInfo.VibPos], 0
  2770                                  OkPos:          
  2771 00000904 C3                      		retn
  2772                                  SampleOfs:      
  2773 00000905 84D2                    		test    dl, dl
  2774 00000907 7503                    		jne     short SetSampleOfs
  2775 00000909 8A5519                  		mov     dl, [di+TrackInfo.OldSampOfs]
  2776                                  SetSampleOfs:
  2777 0000090C 885519                  		mov     [di+TrackInfo.OldSampOfs], dl
  2778 0000090F 88D6                    		mov     dh, dl
  2779 00000911 30D2                    		xor     dl, dl
  2780 00000913 895504                  		mov     [di+TrackInfo.Position], dx
  2781 00000916 C3                      		retn
  2782                                  PosJump:
  2783 00000917 8816[E2BE]              		mov     [OrderPos], dl
  2784 0000091B C606[E6BE]40            		mov     byte [Row], 64
  2785 00000920 C3                      		retn
  2786                                  SetVolume:
  2787 00000921 80FA40                  		cmp     dl, 64
  2788 00000924 7602                    		jbe     short OkVol
  2789 00000926 B240                    		mov     dl, 64
  2790                                  OkVol:
  2791 00000928 88550C                  		mov     [di+TrackInfo.Volume], dl
  2792 0000092B C3                      		retn
  2793                                  Break:
  2794 0000092C 88D6                    		mov     dh, dl
  2795 0000092E 80E20F                  		and     dl, 0Fh
  2796 00000931 C0EE04                  		shr     dh, 4
  2797 00000934 00F6                    		add     dh, dh
  2798 00000936 00F2                    		add     dl, dh
  2799 00000938 C0E602                  		shl     dh, 2
  2800 0000093B 00F2                    		add     dl, dh
  2801 0000093D 8816[E7BE]              		mov     [BreakRow], dl
  2802 00000941 C606[E6BE]40            		mov     byte [Row], 64
  2803 00000946 C3                      		retn
  2804                                  SetSpeed:
  2805 00000947 84D2                    		test    dl,dl
  2806 00000949 7424                    		je      Skip
  2807 0000094B 80FA1F                  		cmp     dl,31
  2808 0000094E 7709                    		ja      short SetBpm
  2809                                  SetTempo:       
  2810 00000950 8816[E3BE]              		mov     [Tempo], dl
  2811 00000954 8816[E4BE]              		mov     [TempoWait], dl
  2812 00000958 C3                      		retn
  2813                                  SetBpm:
  2814 00000959 8816[E5BE]              		mov     [Bpm], dl
  2815 0000095D B067                    		mov     al, 103
  2816 0000095F F6E2                    		mul     dl
  2817 00000961 88E3                    		mov     bl, ah
  2818 00000963 30FF                    		xor     bh, bh
  2819 00000965 A1[3465]                		mov     ax, [MixSpeed]
  2820 00000968 31D2                    		xor     dx, dx
  2821 0000096A F7F3                    		div     bx
  2822 0000096C A3[E8BE]                		mov     [BpmSamples], ax
  2823                                  Skip:           
  2824 0000096F C3                      		retn
  2825                                  InitArpeggio:
  2826 00000970 88D6                    		mov     dh, dl
  2827 00000972 80E20F                  		and     dl, 0Fh
  2828 00000975 C0EE04                  		shr     dh, 4
  2829 00000978 B92400                  		mov     cx, 36
  2830 0000097B 31DB                    		xor     bx, bx
  2831 0000097D 8B450E                  		mov     ax, [di+TrackInfo.Period]
  2832                                  gt_ScanPeriod:
  2833 00000980 3B87[7C0E]              		cmp     ax, [PeriodTable+bx]
  2834 00000984 7305                    		jae     short SetArp
  2835 00000986 83C302                  		add     bx, 2
  2836 00000989 E2F5                    		loop    gt_ScanPeriod
  2837                                  SetArp:         
  2838 0000098B 01D2                    		add     dx, dx
  2839 0000098D 00DE                    		add     dh, bl
  2840 0000098F 00DA                    		add     dl, bl
  2841 00000991 8B9F[7C0E]              		mov     bx, [PeriodTable+bx]
  2842 00000995 01DB                    		add     bx, bx
  2843 00000997 8B87[3067]              		mov     ax, [PitchTable+bx]
  2844 0000099B 89451A                  		mov     [di+TrackInfo.Arp], ax
  2845 0000099E 88F3                    		mov     bl, dh
  2846 000009A0 30FF                    		xor     bh, bh
  2847 000009A2 8B9F[7C0E]              		mov     bx, [PeriodTable+bx]
  2848 000009A6 01DB                    		add     bx, bx
  2849 000009A8 8B87[3067]              		mov     ax, [PitchTable+bx]
  2850 000009AC 89451C                  		mov     [di+TrackInfo.Arp+2], ax
  2851 000009AF 88D3                    		mov     bl, dl
  2852 000009B1 30FF                    		xor     bh, bh
  2853 000009B3 8B9F[7C0E]              		mov     bx, [PeriodTable+bx]
  2854 000009B7 01DB                    		add     bx, bx
  2855 000009B9 8B87[3067]              		mov     ax, [PitchTable+bx]
  2856 000009BD 89451E                  		mov     [di+TrackInfo.Arp+4], ax
  2857 000009C0 C745200000              		mov     word [di+TrackInfo.ArpIndex], 0
  2858 000009C5 C3                      		retn
  2859                                  
  2860                                  ;--------------------------------------------------------------------------
  2861                                  ; UpdateTracks:  Main code to process the next tick to be played.
  2862                                  ;--------------------------------------------------------------------------
  2863                                  
  2864                                  UpdateTracks:
  2865 000009C6 FE0E[E4BE]              		dec     byte [TempoWait]
  2866 000009CA 740F                    		jz      short GetTracks
  2867                                  
  2868 000009CC B90400                  		mov	cx, NumTracks
  2869 000009CF BF[F4BE]                		mov	di, Tracks
  2870                                  BeatTracks:
  2871 000009D2 E830FD                  		call	BeatTrack	
  2872 000009D5 83C722                  		add	di, TrackInfo.size
  2873 000009D8 E2F8                    		loop	BeatTracks
  2874 000009DA C3                      		retn
  2875                                  GetTracks:
  2876 000009DB A0[E3BE]                		mov     al, [Tempo]
  2877 000009DE A2[E4BE]                		mov     [TempoWait], al
  2878                                  
  2879 000009E1 C436[F0BE]              		les     si, [Note]
  2880 000009E5 803E[E6BE]40            		cmp     byte [Row], 64
  2881 000009EA 7246                    		jb      short NoPattWrap
  2882                                  
  2883 000009EC C436[B865]              		les     si, [ModInfo.Patterns]
  2884 000009F0 8A1E[E2BE]              		mov     bl, [OrderPos]
  2885 000009F4 3A1E[3665]              		cmp     bl, [ModInfo.OrderLen]
  2886 000009F8 720E                    		jb      short NoOrderWrap
  2887 000009FA 8A1E[3765]              		mov     bl, [ModInfo.ReStart]
  2888 000009FE 881E[E2BE]              		mov     [OrderPos], bl
  2889 00000A02 3A1E[3665]              		cmp     bl, [ModInfo.OrderLen]
  2890 00000A06 7343                    		jae     short NoUpdate
  2891                                  NoOrderWrap:    
  2892 00000A08 30FF                    		xor     bh, bh
  2893 00000A0A 8A9F[3865]              		mov     bl, [ModInfo.Order+bx]
  2894 00000A0E C1E30A                  		shl     bx, 10
  2895 00000A11 01DE                    		add     si, bx
  2896 00000A13 8A1E[E7BE]              		mov     bl, [BreakRow]
  2897 00000A17 881E[E6BE]              		mov     [Row], bl
  2898 00000A1B 30FF                    		xor     bh, bh
  2899 00000A1D 883E[E7BE]              		mov     [BreakRow], bh
  2900 00000A21 C1E304                  		shl     bx, 4
  2901 00000A24 01DE                    		add     si, bx
  2902 00000A26 8936[F0BE]              		mov     [Note], si
  2903 00000A2A 8C06[F2BE]              		mov     [Note+2], es
  2904 00000A2E FE06[E2BE]              		inc     byte [OrderPos]
  2905                                  NoPattWrap:     
  2906 00000A32 FE06[E6BE]              		inc     byte [Row]
  2907                                  
  2908 00000A36 FC                      		cld
  2909 00000A37 B90400                  		mov	cx, NumTracks
  2910 00000A3A BF[F4BE]                		mov	di, Tracks
  2911                                  GetTracks_next:
  2912 00000A3D 51                      		push	cx		
  2913 00000A3E E8F0FD                  		call	GetTrack
  2914 00000A41 59                      		pop	cx
  2915 00000A42 83C722                  		add	di, TrackInfo.size
  2916 00000A45 E2F6                    		loop	GetTracks_next
  2917                                  
  2918 00000A47 8936[F0BE]              		mov     [Note], si
  2919                                  NoUpdate:
  2920 00000A4B C3                      		retn
  2921                                  
  2922                                  ;--------------------------------------------------------------------------
  2923                                  ; MixTrack:  Mixes one track into a CLEAN buffer.
  2924                                  ;  In:
  2925                                  ;   ds:si -  Track Info Address.
  2926                                  ;   ds:di -  Buffer Address.
  2927                                  ;    cx   -  Buffer Size.
  2928                                  ;--------------------------------------------------------------------------
  2929                                  
  2930                                  MixTrack:
  2931 00000A4C 837C0A02                		cmp     word [si+TrackInfo.RepLen], 2
  2932 00000A50 7742                    		ja      short MixLooped
  2933                                  MixNonLooped:   
  2934 00000A52 C414                    		les     dx, [si+TrackInfo.Samples]
  2935 00000A54 8B5C04                  		mov     bx, [si+TrackInfo.Position]
  2936 00000A57 8B6C06                  		mov     bp, [si+TrackInfo.Len]
  2937 00000A5A 52                      		push    dx
  2938 00000A5B 56                      		push    si
  2939 00000A5C 01D3                    		add     bx, dx
  2940 00000A5E 01D5                    		add     bp, dx
  2941 00000A60 8B5410                  		mov     dx, [si+TrackInfo.Pitch]
  2942 00000A63 8A440C                  		mov     al, [si+TrackInfo.Volume]
  2943 00000A66 8A640D                  		mov     ah, [si+TrackInfo.Error]
  2944 00000A69 89DE                    		mov     si, bx
  2945 00000A6B 88C7                    		mov     bh, al
  2946 00000A6D 88D0                    		mov     al, dl
  2947 00000A6F 88F2                    		mov     dl, dh
  2948 00000A71 30F6                    		xor     dh, dh
  2949                                  nlMixSamp:      
  2950 00000A73 39EE                    		cmp     si, bp
  2951 00000A75 7310                    		jae     short nlMixBye
  2952 00000A77 268A1C                  		mov     bl, [es:si]
  2953 00000A7A 8A9F[E26D]              		mov     bl, [VolTable+bx]
  2954 00000A7E 001D                    		add     [di], bl
  2955 00000A80 47                      		inc     di
  2956 00000A81 00C4                    		add     ah, al
  2957 00000A83 11D6                    		adc     si, dx
  2958 00000A85 E2EC                    		loop    nlMixSamp
  2959                                  nlMixBye:       
  2960 00000A87 89F3                    		mov     bx, si
  2961 00000A89 5E                      		pop     si
  2962 00000A8A 5A                      		pop     dx
  2963 00000A8B 29D3                    		sub     bx, dx
  2964 00000A8D 895C04                  		mov     [si+TrackInfo.Position], bx
  2965 00000A90 88640D                  		mov     [si+TrackInfo.Error], ah
  2966 00000A93 C3                      		retn
  2967                                  MixLooped:
  2968 00000A94 C414                    		les     dx, [si+TrackInfo.Samples]
  2969 00000A96 8B5C04                  		mov     bx, [si+TrackInfo.Position]
  2970 00000A99 8B6C0A                  		mov     bp, [si+TrackInfo.RepLen]
  2971 00000A9C 892E[EEBE]              		mov     [BufRep], bp
  2972 00000AA0 036C08                  		add     bp, [si+TrackInfo.Repeat]
  2973 00000AA3 52                      		push    dx
  2974 00000AA4 56                      		push    si
  2975 00000AA5 01D3                    		add     bx, dx
  2976 00000AA7 01D5                    		add     bp, dx
  2977 00000AA9 8B5410                  		mov     dx, [si+TrackInfo.Pitch]
  2978 00000AAC 8A440C                  		mov     al, [si+TrackInfo.Volume]
  2979 00000AAF 8A640D                  		mov     ah, [si+TrackInfo.Error]
  2980 00000AB2 89DE                    		mov     si, bx
  2981 00000AB4 88C7                    		mov     bh, al
  2982 00000AB6 88D0                    		mov     al, dl
  2983 00000AB8 88F2                    		mov     dl, dh
  2984 00000ABA 30F6                    		xor     dh, dh
  2985                                  lpMixSamp:      
  2986 00000ABC 39EE                    		cmp     si, bp
  2987 00000ABE 7204                    		jb      short lpMixNow
  2988 00000AC0 2B36[EEBE]              		sub     si, [BufRep]
  2989                                  lpMixNow:       
  2990 00000AC4 268A1C                  		mov     bl, [es:si]
  2991 00000AC7 8A9F[E26D]              		mov     bl, [VolTable+bx]
  2992 00000ACB 001D                    		add     [di], bl
  2993 00000ACD 47                      		inc     di
  2994 00000ACE 00C4                    		add     ah, al
  2995 00000AD0 11D6                    		adc     si, dx
  2996 00000AD2 E2E8                    		loop    lpMixSamp
  2997                                  lpMixBye:       
  2998 00000AD4 89F3                    		mov     bx, si
  2999 00000AD6 5E                      		pop     si
  3000 00000AD7 5A                      		pop     dx
  3001 00000AD8 29D3                    		sub     bx, dx
  3002 00000ADA 895C04                  		mov     [si+TrackInfo.Position], bx
  3003 00000ADD 88640D                  		mov     [si+TrackInfo.Error], ah
  3004 00000AE0 C3                      		retn
  3005                                  
  3006                                  GetSamples_ICH:
  3007                                  		; 11/05/2024
  3008                                  		; 18/02/2017
  3009                                  		; 8 bit mono samples 
  3010                                  		; must be converted to 16 bit, stereo samples (for ICH) !
  3011                                  		; (ICH AC97 Modification by Erdogan Tan)
  3012 00000AE1 8936[00C4]              		mov	[_si_], si ; DMA Buff Addr, [DMA_BUFFER1] or [DMA_BUFFER2]
  3013                                  		; 11/05/2024
  3014                                  		;mov	si, MOD_BUFFER
  3015                                  		;shr	cx, 2 ; mod buffer size = dma (half) buffer size / 4 (*)
  3016                                  
  3017                                  ;--------------------------------------------------------------------------
  3018                                  ; GetSamples:  Returns the next chunk of samples to be played.
  3019                                  ;  In:
  3020                                  ;    Buffer  - Buffer Address.
  3021                                  ;    Count   - Buffer Size.
  3022                                  ;--------------------------------------------------------------------------
  3023                                  
  3024                                  GetSamples:
  3025                                  		;ds:si = buffer address
  3026                                  		;cx = count
  3027                                  
  3028                                  		; 11/05/2024
  3029                                  		;
  3030                                  		;;[sp+6] = ds
  3031                                  		;;[sp+4] = si
  3032                                  		;;[sp+2] = count
  3033                                  		;
  3034                                  		;Count	equ 4
  3035                                  		;Buffer	equ 6 
  3036                                  		;
  3037                                  		;push	bp
  3038                                  		;mov	bp, sp
  3039                                  		;
  3040                                  		;push    es
  3041                                  		;;;push  ds
  3042                                  		;;;pusha
  3043                                  		;
  3044                                  		;cld
  3045                                  		;
  3046                                  		;les	di, [bp+Buffer]
  3047                                  		;mov    bx, [bp+Count]
  3048                                  
  3049                                  		; 11/05/2024
  3050                                  		; ds = cs
  3051 00000AE5 06                      		push	es ; +
  3052                                  
  3053 00000AE6 1E                      		push	ds
  3054 00000AE7 07                      		pop	es
  3055                                  
  3056                                  		; 11/05/2024
  3057 00000AE8 BF[02C4]                		mov	di, MOD_BUFFER
  3058 00000AEB BB000A                  		mov	bx, (BUFFERSIZE/4) ; (*) ; 2048
  3059                                  NextChunk:
  3060 00000AEE 833E[ECBE]00            		cmp     word [BufLen], 0
  3061 00000AF3 7534                    		jne     short CopyChunk
  3062                                  
  3063                                  		; 11/05/2024
  3064 00000AF5 06                      		push	es
  3065 00000AF6 53                      		push	bx
  3066 00000AF7 57                      		push	di
  3067                                  MixChunk:       
  3068                                  		;lea    di, [MixBuffer]
  3069 00000AF8 BF[E2AE]                		mov	di, MixBuffer
  3070 00000AFB 8B0E[E8BE]              		mov     cx, [BpmSamples]
  3071 00000AFF 893E[EABE]              		mov     [BufPtr], di
  3072 00000B03 890E[ECBE]              		mov     [BufLen], cx
  3073                                  
  3074                                  		; 12/05/2024
  3075                                  		; es = ds
  3076                                  		;mov    ax, ds
  3077                                  		;mov    es, ax
  3078                                  
  3079 00000B07 B080                    		mov    al, 80h
  3080 00000B09 F3AA                    		rep    stosb
  3081                                  
  3082 00000B0B B90400                  		mov	cx, NumTracks
  3083 00000B0E BE[D2BE]                		mov	si, Tracks - TrackInfo.size
  3084                                  GetSamples_next:
  3085 00000B11 51                      		push	cx
  3086 00000B12 83C622                  		add	si, TrackInfo.size
  3087 00000B15 8B0E[ECBE]              		mov	cx, [BufLen]
  3088 00000B19 8B3E[EABE]              		mov	di, [BufPtr]
  3089 00000B1D E82CFF                  		call	MixTrack
  3090 00000B20 59                      		pop	cx
  3091 00000B21 E2EE                    		loop	GetSamples_next
  3092                                  
  3093 00000B23 E8A0FE                  		call    UpdateTracks
  3094                                  
  3095 00000B26 5F                      		pop	di
  3096 00000B27 5B                      		pop	bx
  3097 00000B28 07                      		pop	es ; es = ds ; 12/05/2024
  3098                                  CopyChunk:      
  3099 00000B29 8B0E[ECBE]              		mov     cx, [BufLen]
  3100 00000B2D 39D9                    		cmp     cx, bx
  3101 00000B2F 7602                    		jbe     short MoveChunk
  3102 00000B31 89D9                    		mov     cx, bx
  3103                                  MoveChunk:
  3104 00000B33 8B36[EABE]              		mov     si, [BufPtr]
  3105 00000B37 010E[EABE]              		add     [BufPtr], cx
  3106 00000B3B 290E[ECBE]              		sub     [BufLen], cx
  3107 00000B3F 29CB                    		sub     bx, cx
  3108 00000B41 F3A4                    		rep     movsb
  3109 00000B43 85DB                    		test    bx, bx
  3110 00000B45 75A7                    		jnz     short NextChunk
  3111                                  
  3112                                  		;;popa
  3113                                  		;;pop	ds
  3114                                  		;pop	es
  3115                                  		;pop	bp
  3116                                  		;ret	6
  3117                                  
  3118                                  ; GetSamples_ICH_convert_samples:
  3119                                  		; 11/05/2024
  3120                                  		; es = ds = cs
  3121                                  		; 18/02/2017
  3122                                  		;mov	di, ds
  3123                                  		;mov	es, di
  3124 00000B47 8B3E[00C4]              		mov	di, [_si_] ; DMA Buffer Address (16 bit, stereo)
  3125 00000B4B BE[01C4]                		mov	si, MOD_BUFFER - 1 ; buffer for 8 bit mono samples
  3126 00000B4E B9000A                  		mov	cx, (BUFFERSIZE/4) ; (*) ; 2048 ; 11/04/2024
  3127 00000B51 30C0                    		xor	al, al
  3128                                  gscs_loop:		
  3129 00000B53 46                      		inc	si
  3130 00000B54 8A24                    		mov	ah, [si] ; convert 8 bit sample to 16 bit sample
  3131                                  		; 11/05/2024
  3132 00000B56 80EC80                  		sub	ah, 80h
  3133                                  
  3134 00000B59 AB                      		stosw	; left channel
  3135 00000B5A AB                      		stosw	; right channel
  3136 00000B5B E2F6                    		loop	gscs_loop
  3137                                  
  3138                                  		; 11/05/2024
  3139 00000B5D 07                      		pop	es ; +
  3140                                  		;pop	bp
  3141                                  		;ret	6
  3142 00000B5E C3                      		retn
  3143                                  
  3144                                  ;--------------------------------------------------------------------------
  3145                                  ; StartPlaying: Initializes the Sound System.
  3146                                  ;  In:
  3147                                  ;   Module Information Resources.
  3148                                  ;--------------------------------------------------------------------------
  3149                                  
  3150                                  StartPlaying:
  3151 00000B5F 60                      		pusha
  3152 00000B60 1E                      		push    ds
  3153 00000B61 06                      		push    es
  3154                                  SetModParms:    
  3155 00000B62 C606[E2BE]00            		mov     byte [OrderPos], 0
  3156 00000B67 C606[E3BE]06            		mov     byte [Tempo], DefTempo
  3157 00000B6C C606[E4BE]06            		mov     byte [TempoWait], DefTempo
  3158 00000B71 C606[E5BE]7D            		mov     byte [Bpm], DefBpm
  3159 00000B76 C606[E6BE]40            		mov     byte [Row], 64
  3160 00000B7B C606[E7BE]00            		mov     byte [BreakRow], 0
  3161 00000B80 A1[3465]                		mov     ax, [MixSpeed]
  3162 00000B83 31D2                    		xor     dx, dx
  3163 00000B85 BB3200                  		mov     bx, 24*DefBpm/60
  3164 00000B88 F7F3                    		div     bx
  3165 00000B8A A3[E8BE]                		mov     [BpmSamples], ax
  3166                                  ClearTracks:    
  3167 00000B8D BF[F4BE]                		mov     di, Tracks
  3168 00000B90 8CD8                    		mov     ax, ds
  3169 00000B92 8EC0                    		mov     es, ax
  3170 00000B94 B98800                  		mov     cx, NumTracks*TrackInfo.size
  3171 00000B97 31C0                    		xor     ax, ax
  3172 00000B99 FC                      		cld
  3173 00000B9A F3AA                    		rep     stosb
  3174                                  
  3175 00000B9C A3[EABE]                		mov     [BufPtr], ax
  3176 00000B9F A3[ECBE]                		mov     [BufLen], ax
  3177                                  MakePitch:
  3178 00000BA2 B80021                  		mov     ax, MidCRate
  3179 00000BA5 BBAC01                  		mov     bx, 428
  3180 00000BA8 F7E3                    		mul     bx
  3181 00000BAA F736[3465]              		div     word [MixSpeed]
  3182 00000BAE 30F6                    		xor     dh, dh
  3183 00000BB0 88E2                    		mov     dl, ah
  3184 00000BB2 88C4                    		mov     ah, al
  3185 00000BB4 30C0                    		xor     al, al
  3186 00000BB6 B95903                  		mov     cx, 857
  3187 00000BB9 31DB                    		xor     bx, bx
  3188 00000BBB BF[3067]                		mov     di, PitchTable
  3189                                  PitchLoop:      
  3190 00000BBE 50                      		push    ax
  3191 00000BBF 52                      		push    dx
  3192 00000BC0 39DA                    		cmp     dx, bx
  3193 00000BC2 7302                    		jae     short NoDiv
  3194 00000BC4 F7F3                    		div     bx
  3195                                  NoDiv:          
  3196 00000BC6 AB                      		stosw
  3197 00000BC7 5A                      		pop     dx
  3198 00000BC8 58                      		pop     ax
  3199 00000BC9 43                      		inc     bx
  3200 00000BCA E2F2                    		loop    PitchLoop
  3201                                  MakeVolume:     
  3202 00000BCC B90041                  		mov     cx, 16640
  3203 00000BCF 89CB                    		mov     bx, cx
  3204                                  VolLoop:
  3205 00000BD1 4B                      		dec     bx
  3206 00000BD2 88D8                    		mov     al, bl
  3207 00000BD4 F6EF                    		imul    bh
  3208 00000BD6 88A7[E26D]              		mov     [VolTable+bx], ah
  3209 00000BDA E2F5                    		loop    VolLoop
  3210                                  
  3211 00000BDC 07                      		pop     es
  3212 00000BDD 1F                      		pop     ds
  3213 00000BDE 61                      		popa
  3214 00000BDF C3                      		retn	; 12/05/2024
  3215                                  
  3216                                  ;--------------------------------------------------------------------------
  3217                                  ; StopPlaying: ShutDown the Sound System.
  3218                                  ;--------------------------------------------------------------------------
  3219                                  
  3220                                  StopPlaying:
  3221                                  	; 08/05/2024
  3222                                  	; 04/11/2023
  3223                                  	; finished with song, stop everything
  3224 00000BE0 E8A801                  	call	ac97_stop
  3225                                  
  3226                                  ; 12/05/2024 (tuneloop version)
  3227                                  %if 0
  3228                                  	; 11/11/2023
  3229                                  irq_restore:	
  3230                                  	; restore previous interrupt vector and interrupt_status
  3231                                  	cli
  3232                                  	in	al, 0A1h ; irq 8-15
  3233                                  	mov	al, [IRQ_status+1]
  3234                                  	out	0A1h, al 
  3235                                  	in	al, 021h ; irq 0-7
  3236                                  	mov	al, [IRQ_status]
  3237                                  	out	21h, al 
  3238                                  	; ...
  3239                                  	push	es
  3240                                  	xor	ax, ax
  3241                                  	mov	es, ax
  3242                                  	mov	ax, [IRQ_vector]
  3243                                  	mov	[es:bx], ax
  3244                                  	mov	ax, [IRQ_vector+2]
  3245                                  	mov	[es:bx+2], ax
  3246                                  	pop	es
  3247                                  
  3248                                  	sti
  3249                                  %endif
  3250 00000BE3 C3                      	retn
  3251                                  
  3252                                  ;=============================================================================
  3253                                  ;               PLAYER.ASM
  3254                                  ;=============================================================================
  3255                                  
  3256                                  ; UTILS.ASM
  3257                                  ;----------------------------------------------------------------------------
  3258                                  ;       delay1_4ms - Delay for 1/4 millisecond.
  3259                                  ;		    1mS = 1000us
  3260                                  ;       Entry:
  3261                                  ;         None
  3262                                  ;       Exit:
  3263                                  ;	  None
  3264                                  ;
  3265                                  ;       Modified:
  3266                                  ;         None
  3267                                  ;
  3268                                  PORTB			EQU	061h
  3269                                    REFRESH_STATUS	EQU	010h		; Refresh signal status
  3270                                  
  3271                                  delay1_4ms:
  3272 00000BE4 50                              push    ax 
  3273 00000BE5 51                              push    cx
  3274 00000BE6 B91000                          mov     cx, 16			; close enough.
  3275 00000BE9 E461                    	in	al,PORTB
  3276 00000BEB 2410                    	and	al,REFRESH_STATUS
  3277 00000BED 88C4                    	mov	ah,al			; Start toggle state
  3278 00000BEF 09C9                    	or	cx, cx
  3279 00000BF1 7401                    	jz	short _d4ms1
  3280 00000BF3 41                      	inc	cx			; Throwaway first toggle
  3281                                  _d4ms1:	
  3282 00000BF4 E461                    	in	al,PORTB		; Read system control port
  3283 00000BF6 2410                    	and	al,REFRESH_STATUS	; Refresh toggles 15.085 microseconds
  3284 00000BF8 38C4                    	cmp	ah,al
  3285 00000BFA 74F8                    	je	short _d4ms1		; Wait for state change
  3286                                  
  3287 00000BFC 88C4                    	mov	ah,al			; Update with new state
  3288 00000BFE 49                      	dec	cx
  3289 00000BFF 75F3                    	jnz	short _d4ms1
  3290                                  
  3291 00000C01 59                              pop     cx
  3292 00000C02 58                              pop     ax
  3293 00000C03 C3                              retn
  3294                                  
  3295                                  print_msg:
  3296                                  	; 13/11/2016 - Erdogan Tan 
  3297                                  	; esi = ASCIIZ text address
  3298                                  	;
  3299 00000C04 BB0700                  	mov	bx, 7h
  3300 00000C07 B40E                    	mov	ah, 0Eh 
  3301                                  pm_next_char:
  3302 00000C09 AC                      	lodsb
  3303 00000C0A 20C0                    	and	al, al
  3304 00000C0C 7404                    	jz	short pm_retn
  3305 00000C0E CD10                    	int	10h
  3306 00000C10 EBF7                    	jmp	short pm_next_char
  3307                                  pm_retn:
  3308 00000C12 C3                      	retn
  3309                                  
  3310                                  dword2str:
  3311                                  	; 13/11/2016 - Erdogan Tan 
  3312                                  	; eax = dword value
  3313                                  	;
  3314 00000C13 E84400                  	call	dwordtohex
  3315 00000C16 668916[C60F]            	mov	[dword_str], edx
  3316 00000C1B 66A3[CA0F]              	mov	[dword_str+4], eax
  3317 00000C1F BE[C60F]                	mov	si, dword_str
  3318 00000C22 C3                      	retn
  3319                                  
  3320                                  	; trdos386.s (unix386.s) - 10/05/2015
  3321                                  	; Convert binary number to hexadecimal string
  3322                                  
  3323                                  bytetohex:
  3324                                  	; INPUT ->
  3325                                  	; 	AL = byte (binary number)
  3326                                  	; OUTPUT ->
  3327                                  	;	AX = hexadecimal string
  3328                                  	;
  3329 00000C23 53                      	push	bx
  3330 00000C24 30FF                    	xor	bh, bh
  3331 00000C26 88C3                    	mov	bl, al
  3332 00000C28 C0EB04                  	shr	bl, 4
  3333 00000C2B 8A9F[280F]              	mov	bl, [bx+hex_chars]
  3334 00000C2F 86D8                    	xchg	bl, al
  3335 00000C31 80E30F                  	and	bl, 0Fh
  3336 00000C34 8AA7[280F]              	mov	ah, [bx+hex_chars]
  3337 00000C38 5B                      	pop	bx	
  3338 00000C39 C3                      	retn
  3339                                  
  3340                                  wordtohex:
  3341                                  	; INPUT ->
  3342                                  	; 	AX = word (binary number)
  3343                                  	; OUTPUT ->
  3344                                  	;	EAX = hexadecimal string
  3345                                  	;
  3346 00000C3A 53                      	push	bx
  3347 00000C3B 30FF                    	xor	bh, bh
  3348 00000C3D 86E0                    	xchg	ah, al
  3349 00000C3F 50                      	push	ax
  3350 00000C40 88E3                    	mov	bl, ah
  3351 00000C42 C0EB04                  	shr	bl, 4
  3352 00000C45 8A87[280F]              	mov	al, [bx+hex_chars]
  3353 00000C49 88E3                    	mov	bl, ah
  3354 00000C4B 80E30F                  	and	bl, 0Fh
  3355 00000C4E 8AA7[280F]              	mov	ah, [bx+hex_chars]
  3356 00000C52 66C1E010                	shl	eax, 16
  3357 00000C56 58                      	pop	ax
  3358 00000C57 5B                      	pop	bx
  3359 00000C58 EBC9                    	jmp	short bytetohex
  3360                                  
  3361                                  dwordtohex:
  3362                                  	; INPUT ->
  3363                                  	; 	EAX = dword (binary number)
  3364                                  	; OUTPUT ->
  3365                                  	;	EDX:EAX = hexadecimal string
  3366                                  	;
  3367 00000C5A 6650                    	push	eax
  3368 00000C5C 66C1E810                	shr	eax, 16
  3369 00000C60 E8D7FF                  	call	wordtohex
  3370 00000C63 6689C2                  	mov	edx, eax
  3371 00000C66 6658                    	pop	eax
  3372 00000C68 E8CFFF                  	call	wordtohex
  3373 00000C6B C3                      	retn
  3374                                  
  3375                                  	; 13/11/2016 - Erdogan Tan
  3376                                  write_ac97_dev_info:
  3377                                  	; BUS/DEV/FN
  3378                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  3379                                  	; DEV/VENDOR
  3380                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  3381                                  
  3382 00000C6C 30FF                    	xor	bh, bh
  3383 00000C6E 668B36[EE0F]            	mov	esi, [dev_vendor]
  3384 00000C73 89F0                    	mov	ax, si
  3385 00000C75 88C3                    	mov	bl, al
  3386 00000C77 88DA                    	mov	dl, bl
  3387 00000C79 80E30F                  	and	bl, 0Fh
  3388 00000C7C 8A87[280F]              	mov	al, [bx+hex_chars]
  3389 00000C80 A2[6B0F]                	mov	[msgVendorId+3], al
  3390 00000C83 88D3                    	mov	bl, dl
  3391 00000C85 C0EB04                  	shr	bl, 4
  3392 00000C88 8A87[280F]              	mov	al, [bx+hex_chars]
  3393 00000C8C A2[6A0F]                	mov	[msgVendorId+2], al
  3394 00000C8F 88E3                    	mov	bl, ah
  3395 00000C91 88DA                    	mov	dl, bl
  3396 00000C93 80E30F                  	and	bl, 0Fh
  3397 00000C96 8A87[280F]              	mov	al, [bx+hex_chars]
  3398 00000C9A A2[690F]                	mov	[msgVendorId+1], al
  3399 00000C9D 88D3                    	mov	bl, dl
  3400 00000C9F C0EB04                  	shr	bl, 4
  3401 00000CA2 8A87[280F]              	mov	al, [bx+hex_chars]
  3402 00000CA6 A2[680F]                	mov	[msgVendorId], al
  3403 00000CA9 66C1EE10                	shr	esi, 16
  3404 00000CAD 89F0                    	mov	ax, si
  3405 00000CAF 88C3                    	mov	bl, al
  3406 00000CB1 88DA                    	mov	dl, bl
  3407 00000CB3 80E30F                  	and	bl, 0Fh
  3408 00000CB6 8A87[280F]              	mov	al, [bx+hex_chars]
  3409 00000CBA A2[7C0F]                	mov	[msgDevId+3], al
  3410 00000CBD 88D3                    	mov	bl, dl
  3411 00000CBF C0EB04                  	shr	bl, 4
  3412 00000CC2 8A87[280F]              	mov	al, [bx+hex_chars]
  3413 00000CC6 A2[7B0F]                	mov	[msgDevId+2], al
  3414 00000CC9 88E3                    	mov	bl, ah
  3415 00000CCB 88DA                    	mov	dl, bl
  3416 00000CCD 80E30F                  	and	bl, 0Fh
  3417 00000CD0 8A87[280F]              	mov	al, [bx+hex_chars]
  3418 00000CD4 A2[7A0F]                	mov	[msgDevId+1], al
  3419 00000CD7 88D3                    	mov	bl, dl
  3420 00000CD9 C0EB04                  	shr	bl, 4
  3421 00000CDC 8A87[280F]              	mov	al, [bx+hex_chars]
  3422 00000CE0 A2[790F]                	mov	[msgDevId], al
  3423                                  
  3424 00000CE3 668B36[EA0F]            	mov	esi, [bus_dev_fn]
  3425 00000CE8 66C1EE08                	shr	esi, 8
  3426 00000CEC 89F0                    	mov	ax, si
  3427 00000CEE 88C3                    	mov	bl, al
  3428 00000CF0 88DA                    	mov	dl, bl
  3429 00000CF2 80E307                  	and	bl, 7 ; bit 0,1,2
  3430 00000CF5 8A87[280F]              	mov	al, [bx+hex_chars]
  3431 00000CF9 A2[A00F]                	mov	[msgFncNo+1], al
  3432 00000CFC 88D3                    	mov	bl, dl
  3433 00000CFE C0EB03                  	shr	bl, 3
  3434 00000D01 88DA                    	mov	dl, bl
  3435 00000D03 80E30F                  	and	bl, 0Fh
  3436 00000D06 8A87[280F]              	mov	al, [bx+hex_chars]
  3437 00000D0A A2[920F]                	mov	[msgDevNo+1], al
  3438 00000D0D 88D3                    	mov	bl, dl
  3439 00000D0F C0EB04                  	shr	bl, 4
  3440 00000D12 8A87[280F]              	mov	al, [bx+hex_chars]
  3441 00000D16 A2[910F]                	mov	[msgDevNo], al
  3442 00000D19 88E3                    	mov	bl, ah
  3443 00000D1B 88DA                    	mov	dl, bl
  3444 00000D1D 80E30F                  	and	bl, 0Fh
  3445 00000D20 8A87[280F]              	mov	al, [bx+hex_chars]
  3446 00000D24 A2[860F]                	mov	[msgBusNo+1], al
  3447 00000D27 88D3                    	mov	bl, dl
  3448 00000D29 C0EB04                  	shr	bl, 4
  3449 00000D2C 8A87[280F]              	mov	al, [bx+hex_chars]
  3450 00000D30 A2[850F]                	mov	[msgBusNo], al
  3451                                  
  3452                                  	;mov	ax, [ac97_io_base]
  3453                                  	; 08/05/2024
  3454 00000D33 A1[D60F]                	mov	ax, [NABMBAR]
  3455 00000D36 88C3                    	mov	bl, al
  3456 00000D38 88DA                    	mov	dl, bl
  3457 00000D3A 80E30F                  	and	bl, 0Fh
  3458 00000D3D 8A87[280F]              	mov	al, [bx+hex_chars]
  3459 00000D41 A2[B90F]                	mov	[msgIOBaseAddr+3], al
  3460 00000D44 88D3                    	mov	bl, dl
  3461 00000D46 C0EB04                  	shr	bl, 4
  3462 00000D49 8A87[280F]              	mov	al, [bx+hex_chars]
  3463 00000D4D A2[B80F]                	mov	[msgIOBaseAddr+2], al
  3464 00000D50 88E3                    	mov	bl, ah
  3465 00000D52 88DA                    	mov	dl, bl
  3466 00000D54 80E30F                  	and	bl, 0Fh
  3467 00000D57 8A87[280F]              	mov	al, [bx+hex_chars]
  3468 00000D5B A2[B70F]                	mov	[msgIOBaseAddr+1], al
  3469 00000D5E 88D3                    	mov	bl, dl
  3470 00000D60 C0EB04                  	shr	bl, 4
  3471 00000D63 8A87[280F]              	mov	al, [bx+hex_chars]
  3472 00000D67 A2[B60F]                	mov	[msgIOBaseAddr], al
  3473                                  
  3474                                  	; 24/11/2016
  3475 00000D6A 30E4                    	xor	ah, ah
  3476 00000D6C A0[E80F]                	mov	al, [ac97_int_ln_reg]
  3477 00000D6F B10A                    	mov	cl, 10
  3478 00000D71 F6F1                    	div	cl
  3479 00000D73 0106[C10F]              	add	[msgIRQ], ax
  3480 00000D77 20C0                    	and	al, al
  3481 00000D79 7508                    	jnz	short _pmi
  3482 00000D7B A0[C20F]                	mov	al, [msgIRQ+1]
  3483 00000D7E B420                    	mov	ah, ' '
  3484 00000D80 A3[C10F]                	mov	[msgIRQ], ax
  3485                                  _pmi:
  3486 00000D83 BA[390F]                        mov	dx, msgAC97Info
  3487 00000D86 B409                            mov     ah, 9
  3488 00000D88 CD21                            int     21h
  3489                                  
  3490 00000D8A C3                              retn
  3491                                  
  3492                                  	; 08/05/2024
  3493                                  ac97_stop:
  3494                                  	; 11/11/2023
  3495                                  	; 09/11/2023
  3496                                  	; 05/11/2023
  3497                                  	; 04/11/2023 
  3498                                  	; 28/05/2017 (TRDOS 386 v2, 'audio.s')
  3499                                  	;mov	byte [tLoop], 0 ; stop ! ; 05/11/2023
  3500                                  ;_ac97_stop:
  3501                                  
  3502                                  	; 11/11/2023
  3503 00000D8B 8B16[D40F]              	mov	dx, [NAMBAR]
  3504                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  3505 00000D8F EF                      	out	dx, ax
  3506                                  
  3507                                  	; 04/11/2023
  3508                                  	; 09/10/2017 (TRDOS 386 v2, 'audio.s')
  3509                                  	; 11/06/2017
  3510 00000D90 30C0                    	xor	al, al ; 0
  3511 00000D92 E80D00                  	call	ac97_po_cmd
  3512                                  
  3513                                  	; (Ref: KolibriOS, intelac97.asm, 'stop:')
  3514                                  	; Clear FIFOE, BCIS, LVBCI (Ref: Intel ICH hub manual)
  3515 00000D95 B81C00                  	mov     ax, 1Ch
  3516 00000D98 8B16[D60F]              	mov     dx, [NABMBAR]
  3517 00000D9C 83C216                  	add     dx, PO_SR_REG
  3518 00000D9F EF                      	out     dx, ax
  3519                                  
  3520                                  	; 11/06/2017
  3521 00000DA0 B002                    	mov     al, RR
  3522                                  ac97_po_cmd:
  3523                                  	; 11/06/2017
  3524                                  	; 29/05/2017
  3525 00000DA2 8B16[D60F]              	mov     dx, [NABMBAR]
  3526 00000DA6 83C21B                          add     dx, PO_CR_REG		; PCM out control register
  3527 00000DA9 EE                      	out	dx, al
  3528 00000DAA C3                      	retn
  3529                                  
  3530                                  ;=============================================================================
  3531                                  ;               preinitialized data
  3532                                  ;=============================================================================
  3533                                  
  3534                                  ;=============================================================================
  3535                                  ;               PLAY.ASM - DATA
  3536                                  ;=============================================================================
  3537                                  
  3538                                  msg_2017:
  3539 00000DAB 54696E79204D4F4420-     		db	'Tiny MOD Player by Erdogan Tan. May 2024.',10,13
  3539 00000DB4 506C61796572206279-
  3539 00000DBD 204572646F67616E20-
  3539 00000DC6 54616E2E204D617920-
  3539 00000DCF 323032342E0A0D     
  3540 00000DD6 75736167653A20706C-     		db	'usage: playmod2 filename.mod', 10, 13, '$'
  3540 00000DDF 61796D6F6432206669-
  3540 00000DE8 6C656E616D652E6D6F-
  3540 00000DF1 640A0D24           
  3541 00000DF5 31382F30322F323031-     		db	'18/02/2017',0
  3541 00000DFE 3700               
  3542 00000E00 31392F30352F323032-     		db	'19/05/2024',0
  3542 00000E09 3400               
  3543                                  
  3544 00000E0B 54696E79204D4F4420-     Credits:	db	'Tiny MOD Player v0.1b by Carlos Hasan. July 1993.'
  3544 00000E14 506C61796572207630-
  3544 00000E1D 2E3162206279204361-
  3544 00000E26 726C6F732048617361-
  3544 00000E2F 6E2E204A756C792031-
  3544 00000E38 3939332E           
  3545                                  CRLF:		; 13/05/2024
  3546 00000E3C 0A0D24                  		db	10,13,'$'
  3547 00000E3F 4572726F72206C6F61-     ErrorMesg:	db	'Error loading Module file.',10,13,'$'
  3547 00000E48 64696E67204D6F6475-
  3547 00000E51 6C652066696C652E0A-
  3547 00000E5A 0D24               
  3548                                  
  3549                                  ;=============================================================================
  3550                                  ;               MODPLAY.ASM - DATA
  3551                                  ;=============================================================================
  3552                                  
  3553                                  ;Credits:	db	'Amiga Module Player v0.3b by Carlos Hasan.'
  3554                                  
  3555 00000E5C 0019324A62788EA2B4-     SinTable:	db	0,25,50,74,98,120,142,162,180,197,212,225
  3555 00000E65 C5D4E1             
  3556 00000E68 ECF4FAFEFFFEFAF4EC-     		db	236,244,250,254,255,254,250,244,236,225
  3556 00000E71 E1                 
  3557 00000E72 D4C5B4A28E78624A32-     		db	212,197,180,162,142,120,98,74,50,25
  3557 00000E7B 19                 
  3558                                  
  3559 00000E7C 58032803FA02D002A6-     PeriodTable:	dw	856,808,762,720,678,640,604,570,538,508,480,453
  3559 00000E85 0280025C023A021A02-
  3559 00000E8E FC01E001C501       
  3560 00000E94 AC0194017D01680153-     		dw	428,404,381,360,339,320,302,285,269,254,240,226
  3560 00000E9D 0140012E011D010D01-
  3560 00000EA6 FE00F000E200       
  3561 00000EAC D600CA00BE00B400AA-     		dw	214,202,190,180,170,160,151,143,135,127,120,113
  3561 00000EB5 00A00097008F008700-
  3561 00000EBE 7F0078007100       
  3562                                  
  3563                                  ;=============================================================================
  3564                                  ;               PLAYWAV.ASM / PLAYER.ASM - DATA
  3565                                  ;=============================================================================
  3566                                  
  3567                                  ; 24/11/2016
  3568                                  ;	       IRQ  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 
  3569 00000EC4 08090A0B0C0D0E0F70-     irq_int:	db 08h,09h,0Ah,0Bh,0Ch,0Dh,0Eh,0Fh,70h,71h,72h,73h,74h,75h,76h,77h
  3569 00000ECD 71727374757677     
  3570                                  
  3571                                  ; 17/02/2017
  3572                                  ; Valid ICH device IDs
  3573                                  
  3574                                  valid_ids:
  3575 00000ED4 86801524                dd	(ICH_DID << 16) + INTEL_VID  	 ; 8086h:2415h
  3576 00000ED8 86802524                dd	(ICH0_DID << 16) + INTEL_VID 	 ; 8086h:2425h
  3577 00000EDC 86804524                dd	(ICH2_DID << 16) + INTEL_VID 	 ; 8086h:2445h
  3578 00000EE0 86808524                dd	(ICH3_DID << 16) + INTEL_VID 	 ; 8086h:2485h
  3579 00000EE4 8680C524                dd	(ICH4_DID << 16) + INTEL_VID 	 ; 8086h:24C5h
  3580 00000EE8 8680D524                dd	(ICH5_DID << 16) + INTEL_VID 	 ; 8086h:24D5h
  3581 00000EEC 86806E26                dd	(ICH6_DID << 16) + INTEL_VID 	 ; 8086h:266Eh
  3582 00000EF0 8680A625                dd	(ESB6300_DID << 16) + INTEL_VID  ; 8086h:25A6h
  3583 00000EF4 86809826                dd	(ESB631X_DID << 16) + INTEL_VID  ; 8086h:2698h
  3584 00000EF8 8680DE27                dd	(ICH7_DID << 16) + INTEL_VID 	 ; 8086h:27DEh
  3585                                  ; 03/11/2023 - Erdogan Tan
  3586 00000EFC 86809571                dd	(MX82440_DID << 16) + INTEL_VID  ; 8086h:7195h
  3587 00000F00 39101270                dd	(SI7012_DID << 16)  + SIS_VID	 ; 1039h:7012h
  3588 00000F04 DE10B101                dd 	(NFORCE_DID << 16)  + NVIDIA_VID ; 10DEh:01B1h
  3589 00000F08 DE106A00                dd 	(NFORCE2_DID << 16) + NVIDIA_VID ; 10DEh:006Ah
  3590 00000F0C 22106D74                dd 	(AMD8111_DID << 16) + AMD_VID 	 ; 1022h:746Dh
  3591 00000F10 22104574                dd 	(AMD768_DID << 16)  + AMD_VID 	 ; 1022h:7445h
  3592 00000F14 DE105900                dd 	(CK804_DID << 16) + NVIDIA_VID	 ; 10DEh:0059h
  3593 00000F18 DE103A00                dd 	(MCP04_DID << 16) + NVIDIA_VID	 ; 10DEh:003Ah
  3594 00000F1C DE108A00                dd 	(CK8_DID << 16) + NVIDIA_VID	 ; 1022h:008Ah
  3595 00000F20 DE10DA00                dd 	(NFORCE3_DID << 16) + NVIDIA_VID ; 10DEh:00DAh
  3596 00000F24 DE10EA00                dd 	(CK8S_DID << 16) + NVIDIA_VID	 ; 10DEh:00EAh
  3597                                  
  3598                                  valid_id_count:	equ ($ - valid_ids)>>2 ; 05/11/2023
  3599                                  
  3600                                  ; 13/11/2016
  3601 00000F28 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  3601 00000F31 3941424344454600   
  3602 00000F39 414339372041756469-     msgAC97Info	db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  3602 00000F42 6F20436F6E74726F6C-
  3602 00000F4B 6C6572202620436F64-
  3602 00000F54 656320496E666F0D0A 
  3603 00000F5D 56656E646F72204944-     		db "Vendor ID: "
  3603 00000F66 3A20               
  3604 00000F68 303030306820446576-     msgVendorId	db "0000h Device ID: "
  3604 00000F71 6963652049443A20   
  3605 00000F79 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  3606 00000F80 4275733A20              		db "Bus: "
  3607 00000F85 303068204465766963-     msgBusNo	db "00h Device: "
  3607 00000F8E 653A20             
  3608 00000F91 3030682046756E6374-     msgDevNo	db "00h Function: "
  3608 00000F9A 696F6E3A20         
  3609 00000F9F 303068                  msgFncNo	db "00h"
  3610 00000FA2 0D0A                    		db 0Dh, 0Ah
  3611 00000FA4 492F4F204261736520-     		db "I/O Base Address: "
  3611 00000FAD 416464726573733A20 
  3612 00000FB6 303030306820495251-     msgIOBaseAddr	db "0000h IRQ: "
  3612 00000FBF 3A20               
  3613 00000FC1 3030                    msgIRQ		dw 3030h
  3614 00000FC3 0D0A24                  		db 0Dh, 0Ah, "$"
  3615                                  
  3616                                  ;msgSampleRate	db "Sample Rate: "
  3617                                  ;msgHertz	db "00000 Hz ", "$" 
  3618                                  ;msg8Bits	db "8 bits ", "$" 
  3619                                  ;msgMono	db "Mono", 0Dh, 0Ah, "$"
  3620                                  ;msg16Bits	db "16 bits ", "$" 
  3621                                  ;msgStereo	db "Stereo", 0Dh, 0Ah, "$"
  3622                                  
  3623                                  ;; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
  3624                                  ;codec_id	dd 0
  3625                                  ;codec_chip_id	dd 0
  3626                                  ;codec_vendor_ids dw 0
  3627                                  ;codec_chip_ids	dw 0
  3628                                  
  3629 00000FC6 3030303030303030        dword_str	 dd 30303030h, 30303030h
  3630 00000FCE 680D0A00                		 db 'h', 0Dh, 0Ah, 0
  3631                                  
  3632                                  ;=============================================================================
  3633                                  ;        	uninitialized data
  3634                                  ;=============================================================================
  3635                                  
  3636                                  bss_start:
  3637                                  
  3638                                  ABSOLUTE bss_start
  3639                                  
  3640 00000FD2 ????                    alignb 4
  3641                                  
  3642                                  ; 17/02/2017
  3643                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  3644                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  3645                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  3646                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  3647 00000FD4 ????                    NAMBAR:		resw 1			; BAR for mixer
  3648 00000FD6 ????                    NABMBAR         resw 1			; BAR for bus master regs
  3649                                  
  3650 00000FD8 ??                      tBuff:		resb	1
  3651                                  ;irq_status:	resb 	1
  3652 00000FD9 ??                      pcm_irq_status:	resb	1 ; 08/05/2024
  3653                                  
  3654 00000FDA ??                      inside:		resb	1
  3655 00000FDB ??                      tLoop:		resb 	1
  3656                                  
  3657                                  ; 08/05/2024
  3658 00000FDC ????                    IRQ_status:	resw 1	; IRQ status before enabling audio interrupt
  3659 00000FDE ????????                IRQ_vector:	resd 1  ; Previous interrupt handler address
  3660                                  
  3661                                  ; 256 byte buffer for descriptor list
  3662 00000FE2 ????                    BDL_BUFFER:	resw	1		; segment of our 256byte BDL buffer
  3663 00000FE4 ????                    DMA_BUFFER1:	resw 	1		; Pointer to 1st half of DMA Buffer
  3664 00000FE6 ????                    DMA_BUFFER2:	resw	1		; Pointer to 2nd half of DMA Buffer
  3665                                  
  3666                                  ; 12/11/2016 - Erdogan Tan
  3667                                  
  3668 00000FE8 ??                      ac97_int_ln_reg: resb 1 
  3669 00000FE9 ??                      err_num:	resb 1
  3670                                  
  3671 00000FEA ????????                bus_dev_fn:	resd 1
  3672 00000FEE ????????                dev_vendor:	resd 1
  3673                                  ; 08/05/2024
  3674                                  ;stats_cmd:	resd 1
  3675                                  ;ac97_io_base:	resw 1
  3676 00000FF2 ??                      LVI:		resb 1
  3677                                  ; 12/05/2024
  3678 00000FF3 ??                      volume:		resb 1
  3679                                  
  3680                                  alignb 4
  3681                                  
  3682 00000FF4 <res 100h>              BdlBuffer:	resb	BDL_SIZE ; 13/02/2017
  3683 000010F4 <res 5000h>             DmaBuffer:	resb	2*BUFFERSIZE ; 13/02/2017
  3684                                  
  3685                                  ; MODLOAD.ASM
  3686 000060F4 ????                    FileHandle:	resw	1
  3687 000060F6 ????                    ErrorInfo:	resw	1
  3688 000060F8 <res 43Ch>              Header:		resb	ModHeader.size
  3689                                  
  3690                                  sample_rate: ; PLAYER.ASM (22050Hz)
  3691                                  ; MODPLAY.ASM
  3692 00006534 ????                    MixSpeed:	resw 1
  3693                                  
  3694                                  ModInfo:
  3695 00006536 ??                      ModInfo.OrderLen:   resb 1
  3696 00006537 ??                      ModInfo.ReStart:    resb 1
  3697 00006538 <res 80h>               ModInfo.Order:	    resb 128
  3698 000065B8 ????????                ModInfo.Patterns:   resd 1
  3699                                  
  3700 000065BC <res 3Eh>               ModInfo.SampOfs:    resw 31
  3701 000065FA <res 3Eh>               ModInfo.SampSeg:    resw 31
  3702 00006638 <res 3Eh>               ModInfo.SampLen:    resw 31
  3703 00006676 <res 3Eh>               ModInfo.SampRep:    resw 31
  3704 000066B4 <res 3Eh>               ModInfo.SampRepLen: resw 31
  3705 000066F2 <res 3Eh>               ModInfo.SampVol:    resw 31
  3706                                  
  3707                                  ; MODPLAY.ASM
  3708 00006730 <res 6B2h>              PitchTable:	resw	857
  3709 00006DE2 <res 4100h>             VolTable:	resb	16640
  3710 0000AEE2 <res 1000h>             MixBuffer       resb	MixBufSize
  3711                                  
  3712                                  ; MODPLAY.ASM
  3713 0000BEE2 ??                      OrderPos:	resb 1
  3714 0000BEE3 ??                      Tempo:		resb 1
  3715 0000BEE4 ??                      TempoWait:	resb 1
  3716 0000BEE5 ??                      Bpm:		resb 1
  3717 0000BEE6 ??                      Row:		resb 1
  3718 0000BEE7 ??                      BreakRow:	resb 1
  3719 0000BEE8 ????                    BpmSamples:	resw 1
  3720 0000BEEA ????                    BufPtr:		resw 1
  3721 0000BEEC ????                    BufLen:		resw 1
  3722 0000BEEE ????                    BufRep:		resw 1
  3723 0000BEF0 ????????                Note:		resd 1
  3724 0000BEF4 <res 88h>               Tracks:		resb TrackInfo.size*NumTracks
  3725                                  
  3726 0000BF7C ????????                alignb 16
  3727                                  
  3728                                  ; PLAY.ASM
  3729 0000BF80 <res 280h>              Scope:		resw	320
  3730 0000C200 <res 200h>              RowOfs:		resw	256
  3731                                  
  3732                                  ; 18/02/2017
  3733 0000C400 ????                    _si_:		resw 1
  3734 0000C402 <res A00h>              MOD_BUFFER:	resb BUFFERSIZE/4 ; 2048 ; 11/05/2024
  3735                                  EOF:
