     1                                  ; ****************************************************************************
     2                                  ; playmod2.asm (for MSDOS)
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; PLAYMOD2.COM ! ICH AC97 MOD PLAYER & VGA DEMO program by Erdogan TAN
     5                                  ;
     6                                  ; 18/02/2017
     7                                  ;
     8                                  ; [ Last Modification: 12/05/2024 ]
     9                                  ;
    10                                  ; Derived from source code of 'PLAYWAV.COM' ('PLAYWAV.ASM') by Erdogan Tan
    11                                  ;							      (17/02/2017)
    12                                  ; Modified from 'PLAYMOD.COM' ('playmod.asm') source code 
    13                                  ;		 VIA VT8237 MOD PLAYER & VGA DEMO program by Erdogan TAN
    14                                  ;							     (15/02/2017)	
    15                                  ;
    16                                  ; Derived from source code of 'PLAY.EXE' (TINYPLAY) by Carlos Hasan (1993)
    17                                  ;          PLAY.EXE: PLAY.ASM, MODLOAD.ASM, MODPLAY.ASM, SB.ASM
    18                                  ;
    19                                  ; Assembler: NASM 2.11
    20                                  ; ----------------------------------------------------------------------------
    21                                  ;	   nasm  playmod2.asm -l playmod2.lst -o PLAYMOD2.COM	
    22                                  ; ****************************************************************************
    23                                  
    24                                  ; Tiny MOD Player v0.1b by Carlos Hasan.
    25                                  ;		July 14th, 1993.
    26                                  
    27                                  ;=============================================================================
    28                                  ;               PLAYWAV.ASM / PLAYER.ASM / TINYPLAY.ASM
    29                                  ;=============================================================================
    30                                  ; Audio controller, codec & PCI functions are derived from '.wav file player 
    31                                  ; for DOS' source code by Jeff Leyda (PLAYER.EXE), Sep 02, 2002.
    32                                  
    33                                  ; TUNELOOP version ; 12/05/2024
    34                                  
    35                                  [BITS 16]
    36                                  [org 100h]
    37                                  
    38                                  Start:
    39 00000000 E8C400                  	call    DetectICH		; Detect AC97 Audio Device
    40                                  GetFileName:    			; Parse  the Command line...
    41 00000003 BE8000                  	mov	si, 80h
    42 00000006 8A1C                    	mov	bl, [si]
    43 00000008 30FF                    	xor	bh, bh
    44 0000000A 43                      	inc	bx
    45 0000000B C60000                  	mov	byte [si+bx], 0		; make AsciiZ filename.
    46 0000000E 46                      	inc	si
    47                                  ScanName:       
    48 0000000F AC                      	lodsb
    49 00000010 84C0                    	test	al, al
    50 00000012 0F84A700                	je	pmsg_2017
    51 00000016 3C20                    	cmp	al, 20h
    52 00000018 74F5                    	je	short ScanName		; scan start of name.
    53 0000001A 89F7                    	mov	di, si
    54 0000001C 4F                      	dec	di
    55                                  ScanPeriod:
    56 0000001D AC                      	lodsb
    57 0000001E 3C2E                    	cmp	al, '.'			; if period NOT found,
    58 00000020 7410                    	je	short PrintMesg		; then add a .MOD extension.
    59 00000022 84C0                    	test	al, al
    60 00000024 75F7                    	jnz	short ScanPeriod
    61 00000026 4E                      	dec	si
    62                                  SetExt:
    63                                  	;mov	byte [si+0], '.'
    64                                  	;mov	byte [si+1], 'M'
    65                                  	;mov	byte [si+2], 'O'
    66                                  	;mov	byte [si+3], 'D'
    67 00000027 66C7042E4D4F44          	mov	dword [si], '.MOD'
    68 0000002E C6440400                	mov	byte [si+4], 0
    69                                  
    70                                  PrintMesg:
    71 00000032 B80009                  	mov	ax, 0900h		; Prints the Credits Text.
    72                                  	;lea	dx, [Credits]
    73 00000035 BA[750D]                	mov	dx, Credits
    74 00000038 CD21                    	int	21h
    75                                  LoadMod:  
    76                                  	; es:di = Filename address
    77 0000003A 06                      	push	es
    78 0000003B 57                      	push	di
    79 0000003C E8BC04                  	call    LoadModule		; Load the MODule...
    80                                  
    81 0000003F 833E[9650]00            	cmp     word [ErrorInfo], 0	; any error loading?
    82 00000044 740A                    	je      short init_codec
    83                                  
    84 00000046 B80009                  	mov     ax, 0900h		; yes, print error and Exit.
    85                                  	;lea    dx, [ErrorMesg]
    86 00000049 BA[A90D]                	mov	dx, ErrorMesg
    87 0000004C CD21                    	int     21h
    88 0000004E EB66                    	jmp     Exit
    89                                  
    90                                  init_codec:
    91 00000050 E8830B                  	call	write_ac97_dev_info 
    92                                  
    93                                  	; 08/05/2024
    94                                  	; 17/02/2017
    95                                  	;mov	dx, [stats_cmd]
    96                                          ;or	dl, IO_ENA+BM_ENA		; enable IO and bus master
    97                                          ;call	pciRegWrite16 ; pciRegWrite8
    98                                  
    99                                  	; 18/02/2017
   100 00000053 C706[D454]2256          	mov	word [sample_rate], 22050	; Mixing at 22.050 kHz
   101                                  
   102                                  	; 08/05/2024
   103                                  	; (48 kHZ mixing is necessary 
   104                                  	;  if the AC97 hardware/codec has not got VRA feature)
   105                                  	; ((or frequency converting code would be needed))
   106                                  	;mov	word [sample_rate], 48000	; Mixing at 48 kHz
   107                                  
   108                                  ; setup the Codec (actually mixer registers) 
   109 00000059 E8FD01                          call    codecConfig			; unmute codec, set rates.
   110 0000005C 731A                    	jnc	short PlayNow
   111                                  
   112                                  _codec_err:
   113 0000005E 0E                      	push	cs
   114 0000005F 1F                      	pop	ds
   115 00000060 BA[6900]                        mov	dx, CodecErrMsg
   116 00000063 B409                            mov     ah, 9
   117 00000065 CD21                            int     21h
   118 00000067 EB4D                            jmp     Exit
   119                                  
   120 00000069 436F64656320457272-     CodecErrMsg db "Codec Error!"
   120 00000072 6F7221             
   121 00000075 0D0A24                  	db	CR,LF,"$"
   122                                  PlayNow:  
   123 00000078 B8[940F]                	mov	ax, BdlBuffer
   124 0000007B A3[820F]                	mov	[BDL_BUFFER], ax
   125                                      
   126 0000007E B8[9410]                	mov	ax, DmaBuffer		; DmaBuffer (4096 bytes) buff addr
   127 00000081 A3[840F]                	mov	[DMA_BUFFER1], ax	; 2048 byte half buffer 1 
   128                                  
   129 00000084 050020                  	add	ax, BUFFERSIZE		; code/current segment
   130 00000087 A3[860F]                	mov	[DMA_BUFFER2], ax	; 2048 byte half buffer 2
   131                                    
   132                                  	;mov    word [MixSpeed], 22050	; Mixing at 22.050 kHz
   133                                  
   134 0000008A E83C0A                  	call    StartPlaying
   135                                  
   136 0000008D B81300                  	mov     ax, 0013h		; Set Mode 320x200x256
   137 00000090 CD10                    	int     10h
   138                                  
   139 00000092 B98000                  	mov     cx, 128			; Make a lookup table
   140 00000095 31DB                    	xor     bx, bx			; for fastest pixel
   141 00000097 BA002D                  	mov     dx, 320*(100-64)	; addressing.
   142                                  MakeOfs:        
   143 0000009A 8997[A0B1]              	mov     [RowOfs+bx], dx
   144 0000009E 8997[A2B1]              	mov     [RowOfs+bx+2], dx
   145 000000A2 81C24001                	add     dx, 320
   146 000000A6 83C304                  	add     bx, 4
   147 000000A9 E2EF                    	loop    MakeOfs
   148                                  
   149                                  ; Note: Normally IRQ 0 calls the ModPlay Polling at 18.2Hz thru
   150                                  ;       the software interrupt 1Ch. If the IRQ 0 is disabled, then
   151                                  ;       the INT 1Ch MUST BE CALLED at least MixSpeed/1024 times per
   152                                  ;       second, or the module will sound "looped".
   153                                  ;       Because we need better sync with the ModPlayer to draw the scope,
   154                                  ;       the polling is called from my routine, and then the irq 0 must be
   155                                  ;       disabled. The [DmaBuffer] points to the current buffer of 8-bit
   156                                  ;       samples played by the Sound Blaster. Note that some samples are
   157                                  ;       discarded in the next code, just for fun!
   158                                  
   159                                  	;in     al, 21h			; disable irq 0!
   160                                  	;or     al, 00000001b
   161                                  	;out    21h, al
   162                                  		
   163 000000AB E83803                  	call	ModPlay ; 13/02/2017
   164                                  
   165                                  	;in	al, 21h			; enable irq 0!
   166                                  	;and	al, 11111110b
   167                                  	;out	21h, al
   168                                  
   169 000000AE B80300                  	mov     ax, 0003h		; Set Text Mode 80x25x16
   170 000000B1 CD10                    	int     10h
   171                                  
   172 000000B3 E8940A                  	call	StopPlaying		; STOP!
   173                                  Exit:           
   174                                  	;call   FreeModule		; Free MODule core.
   175                                  error_exit:
   176 000000B6 B8004C                  	mov     ax, 4C00h		; Bye!
   177 000000B9 CD21                    	int     21h
   178                                  here:
   179 000000BB EBFE                    	jmp	short here
   180                                  
   181                                  pmsg_2017:
   182 000000BD B80009                  	mov     ax, 0900h		; Prints the Credits Text.
   183                                  	;lea    dx, [msg_2017]
   184 000000C0 BA[150D]                	mov	dx, msg_2017
   185 000000C3 CD21                    	int     21h
   186 000000C5 EBEF                    	jmp	short Exit
   187                                  
   188                                  DetectICH:
   189                                  	; 18/02/2017
   190                                  	; Detech Intel ICH based AC97 Audio Device 
   191 000000C7 E84E01                  	call    pciFindDevice 	; AC97.ASM (PLAYWAV.COM)
   192 000000CA 733F                            jnc     short _1
   193                                  
   194                                  ; couldn't find the audio device!
   195                                  	;push	cs
   196                                  	;pop	ds
   197 000000CC BA[D500]                        mov     dx, noDevMsg
   198 000000CF B409                            mov     ah, 9
   199 000000D1 CD21                            int     21h
   200 000000D3 EBE1                            jmp     short error_exit
   201                                  
   202 000000D5 4572726F723A20556E-     noDevMsg db "Error: Unable to find Intel ICH based audio device!",CR,LF,"$"
   202 000000DE 61626C6520746F2066-
   202 000000E7 696E6420496E74656C-
   202 000000F0 204943482062617365-
   202 000000F9 6420617564696F2064-
   202 00000102 6576696365210D0A24 
   203                                  
   204                                  _1:
   205                                  	; 18/02/2017
   206                                  	; eax = BUS/DEV/FN
   207                                  	;	00000000BBBBBBBBDDDDDFFF00000000
   208                                  	; edx = DEV/VENDOR
   209                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
   210                                  
   211 0000010B 66A3[8A0F]              	mov	[bus_dev_fn], eax
   212 0000010F 668916[8E0F]            	mov	[dev_vendor], edx
   213                                  
   214                                  	; get ICH base address regs for mixer and bus master
   215                                  
   216 00000114 B010                            mov     al, NAMBAR_REG
   217 00000116 E87100                          call    pciRegRead16			; read PCI registers 10-11
   218 00000119 83E2FE                          and     dx, IO_ADDR_MASK 		; mask off BIT0
   219                                  
   220 0000011C 8916[740F]                      mov     [NAMBAR], dx			; save audio mixer base addy
   221                                  
   222 00000120 B014                    	mov     al, NABMBAR_REG
   223 00000122 E86500                          call    pciRegRead16
   224 00000125 83E2FE                          and     dx, IO_ADDR_MASK
   225                                  
   226 00000128 8916[760F]                      mov     [NABMBAR], dx			; save bus master base addy
   227                                  
   228                                  	; 08/05/2024
   229                                  	; 06/11/2023
   230                                  	;; init controller
   231                                  	;; 17/02/2017
   232                                  	;mov	al, PCI_CMD_REG ; command register (04h)
   233                                  	;call	pciRegRead16 ; pciRegRead8
   234                                  	;
   235                                  	;; eax = BUS/DEV/FN/REG
   236                                  	;;  dx = PCI Command Register Content ; 17/02/2017
   237                                  	;; 	00000000CCCCCCCC
   238                                  	;mov	[stats_cmd], dx
   239                                  	;
   240                                  	; 06/11/2023
   241                                  	;mov	al, PCI_IO_BASE ; IO base address register (10h)
   242                                  	;call	pciRegRead32
   243                                  	;
   244                                  	;and	dx, 0FFC0h	; IO_ADDR_MASK (0FFFE) ?
   245                                          ;mov	[ac97_io_base], dx
   246                                  
   247 0000012C B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
   248 0000012E E85100                  	call	pciRegRead8 ; 17/02/2017
   249                                  
   250 00000131 8816[880F]              	mov     [ac97_int_ln_reg], dl
   251                                  
   252                                  ; 12/05/2024 (tuneloop version)
   253                                  %if 0
   254                                  	; 28/11/2016
   255                                  	;mov	bx, 1	; 08/05/2024
   256                                  	xor	dh, dh	; 17/02/2017
   257                                  	; 10/11/2023
   258                                  	;mov	cx, dx
   259                                  	;shl	bx, cl
   260                                  
   261                                  	; 04/11/2023
   262                                  	cli
   263                                  
   264                                  	;not	bx
   265                                  	in	al, 0A1h ; irq 8-15
   266                                          mov	ah, al
   267                                          in	al, 21h  ; irq 0-7 
   268                                  
   269                                  	; 04/11/2023
   270                                  	; save IRQ status
   271                                  	mov	[IRQ_status], ax
   272                                  
   273                                  	; 08/05/2024
   274                                  	;mov	dx, 4D1h			;8259 ELCR1
   275                                          ;in	al, dx
   276                                  	;mov	ah, al
   277                                  	;mov	dx, 4D0h 
   278                                          ;in	al, dx
   279                                  	;;or	ax, bx        
   280                                  	;bts	ax, cx
   281                                  	;mov	dx, 4D0h
   282                                  	;out	dx, al                          ;set level-triggered mode
   283                                  	;mov	al, ah
   284                                  	;mov	dx, 4D1h
   285                                  	;out	dx, al                          ;set level-triggered mode
   286                                  
   287                                  	; 24/11/2016 - Erdogan Tan
   288                                  	;mov	bx, cx
   289                                  	; 10/11/2023
   290                                  	mov	bx, dx
   291                                  	mov	bl, [bx+irq_int]
   292                                  	shl	bx, 2 ; * 4
   293                                  
   294                                  	; set up interrupt vector
   295                                  	; 30/11/2016
   296                                  	push	es
   297                                  	xor	ax, ax
   298                                  	mov	es, ax
   299                                  	; 04/11/2023
   300                                  	; save interrupt vector
   301                                  	mov	ax, [es:bx]
   302                                  	mov	[IRQ_vector], ax
   303                                  	mov	ax, [es:bx+2]
   304                                  	mov	[IRQ_vector+2], ax
   305                                  
   306                                  	mov	word [es:bx], ac97_int_handler
   307                                  	mov	ax, cs
   308                                  	mov	[es:bx+2], ax
   309                                  	pop	es
   310                                  
   311                                  	; 04/11/2023
   312                                  	sti
   313                                  %endif
   314 00000135 C3                      	retn
   315                                  
   316                                  ; 12/05/2024 (tuneloop version)
   317                                  %if 0
   318                                  
   319                                  ac97_int_handler:
   320                                  	; 11/05/2024
   321                                  	; 11/11/2023
   322                                  	; 10/11/2023
   323                                  	; 17/02/2016
   324                                  	push	eax	; 11/11/2023
   325                                  	push	dx
   326                                  	; 05/11/2023
   327                                  	;push	cx
   328                                  	;push	bx
   329                                  	;push	si
   330                                  	;push	di
   331                                  
   332                                  	; 10/11/2023
   333                                  	; EOI at first
   334                                  	mov	al, 20h
   335                                  	test	byte [ac97_int_ln_reg], 8
   336                                  	jz	short _ih_0
   337                                  	out 	0A0h, al ; 20h	; EOI
   338                                  _ih_0:
   339                                  	out	20h, al  ; 20h	; EOI
   340                                  
   341                                  	; 11/11/2023
   342                                  	; 09/11/2023
   343                                  	mov	dx, GLOB_STS_REG
   344                                          add	dx, [NABMBAR]
   345                                  	in	eax, dx
   346                                  	
   347                                  	; 12/05/2024
   348                                  	; 09/11/2023,
   349                                          ;cmp	eax, 0FFFFFFFFh ; -1
   350                                  	;je	short _ih_2
   351                                  	
   352                                  	; 12/05/2024
   353                                  	;test	al, 40h		; PCM Out Interrupt
   354                                  	;jnz	short _ih_1
   355                                  
   356                                  	;test	eax, eax
   357                                  	;jz	short _ih_2
   358                                  	; 12/05/2024
   359                                  	test	ax, PCM_OUT_IRQ+BCIS
   360                                  	jnz	short _ih_1
   361                                  
   362                                   	;mov	dx, GLOB_STS_REG
   363                                          ;add	dx, [NABMBAR]
   364                                  	out	dx, eax
   365                                  	jmp	short _ih_2
   366                                  
   367                                  	; .....
   368                                  	;mov	al, 1
   369                                  	; 10/11/2023
   370                                  	;mov	[tLoop], al  ; 1
   371                                  
   372                                  	;cmp	[inside], al ; 1
   373                                  	;jnb	short _ih_3	; busy
   374                                  
   375                                  	;mov	[inside], al ; 1
   376                                  	;
   377                                  	;; 09/11/2023
   378                                          ;mov	dx, [NABMBAR]
   379                                          ;add	dx, PO_SR_REG	; set pointer to Status reg
   380                                  	;in	al, dx
   381                                  	;; 10/11/2023
   382                                  	;;;out	dx, eax
   383                                  	;;out	dx, al		; clear interrupt event
   384                                  	;			; (by writing 1 to same bits)
   385                                  	;
   386                                  	;;mov	[pcm_irq_status], al ; 05/11/2023
   387                                  	;test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
   388                                  	;jz	short _ih_2
   389                                  	; .....
   390                                  
   391                                  _ih_1:
   392                                  	; 11/11/2023
   393                                  	push	eax
   394                                  
   395                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   396                                  	;mov	dx, PO_SR_REG
   397                                          ;add	dx, [NABMBAR]
   398                                  	;out	dx, ax
   399                                  
   400                                  	; 10/11/2023
   401                                  	; 28/11/2016 - Erdogan Tan
   402                                  	call	tuneLoop
   403                                  
   404                                  	; 11/11/2023
   405                                  	pop	eax
   406                                  	mov	dx, GLOB_STS_REG
   407                                          add	dx, [NABMBAR]
   408                                  	out	dx, eax
   409                                  _ih_2:
   410                                  	; 11/11/2023
   411                                  	mov	dx, [NABMBAR]
   412                                  	add	dx, PO_SR_REG	; set pointer to Status reg
   413                                  	mov	ax, 1Ch
   414                                  	out	dx, ax
   415                                  
   416                                  ;	; 10/11/2023
   417                                  ;	mov	al, 20h
   418                                  ;	test	byte [ac97_int_ln_reg], 8
   419                                  ;	jz	short _ih_3
   420                                  ;	out 	0A0h, al ; 20h	; EOI
   421                                  ;_ih_3:
   422                                  ;	out	20h, al  ; 20h	; EOI
   423                                  ;_ih_4:
   424                                  	;mov	byte [inside], 0
   425                                  	;pop	di
   426                                  	;pop	si
   427                                  	;pop	bx
   428                                  	;pop	cx
   429                                  	pop	dx
   430                                  	pop	eax ; 11/11/2023
   431                                  	iret
   432                                  
   433                                  %endif
   434                                  
   435                                  ;=============================================================================
   436                                  ;               PCI.ASM
   437                                  ;=============================================================================
   438                                  
   439                                  ; EQUATES
   440                                  
   441                                  ;constants of stuff that seem hard to remember at times.
   442                                  
   443                                  TRUE  EQU 1
   444                                  FALSE EQU 0
   445                                  
   446                                  ENABLED  EQU 1
   447                                  DISABLED EQU 0
   448                                  
   449                                  BIT0  EQU 1
   450                                  BIT1  EQU 2
   451                                  BIT2  EQU 4
   452                                  BIT3  EQU 8
   453                                  BIT4  EQU 10h
   454                                  BIT5  EQU 20h
   455                                  BIT6  EQU 40h
   456                                  BIT7  EQU 80h
   457                                  BIT8  EQU 100h
   458                                  BIT9  EQU 200h
   459                                  BIT10 EQU 400h
   460                                  BIT11 EQU 800h
   461                                  BIT12 EQU 1000h
   462                                  BIT13 EQU 2000h
   463                                  BIT14 EQU 4000h
   464                                  BIT15 EQU 8000h
   465                                  BIT16 EQU 10000h
   466                                  BIT17 EQU 20000h
   467                                  BIT18 EQU 40000h
   468                                  BIT19 EQU 80000h
   469                                  BIT20 EQU 100000h
   470                                  BIT21 EQU 200000h
   471                                  BIT22 EQU 400000h
   472                                  BIT23 EQU 800000h
   473                                  BIT24 EQU 1000000h
   474                                  BIT25 EQU 2000000h
   475                                  BIT26 EQU 4000000h
   476                                  BIT27 EQU 8000000h
   477                                  BIT28 EQU 10000000h
   478                                  BIT29 EQU 20000000h
   479                                  BIT30 EQU 40000000h
   480                                  BIT31 EQU 80000000h
   481                                  
   482                                  ;special characters
   483                                  NUL     EQU 0
   484                                  NULL    EQU 0
   485                                  BELL    EQU 07
   486                                  BS      EQU 08
   487                                  TAB     EQU 09
   488                                  LF      EQU 10
   489                                  CR      EQU 13
   490                                  ESCAPE  EQU 27           ;ESC is a reserved word....
   491                                  
   492                                  
   493                                  ;file stuff
   494                                  READONLY  EQU   BIT0
   495                                  HIDDEN    EQU   BIT1
   496                                  SYSTEM    EQU   BIT2
   497                                  VOLUME    EQU   BIT3         ;ignored for file access
   498                                  DIRECTORY EQU   BIT4         ;must be 0 for file access
   499                                  ARCHIVE   EQU   BIT5
   500                                  SHAREABLE EQU   BIT7         ;for novell networks
   501                                  OPEN	EQU	2		; open existing file
   502                                  CREATE	EQU	1		; create new file
   503                                  
   504                                  
   505                                  ; PCI equates
   506                                  ; PCI function address (PFA)
   507                                  ; bit 31 = 1
   508                                  ; bit 23:16 = bus number     (0-255)
   509                                  ; bit 15:11 = device number  (0-31)
   510                                  ; bit 10:8 = function number (0-7)
   511                                  ; bit 7:0 = register number  (0-255)
   512                                  
   513                                  IO_ADDR_MASK    EQU     0FFFEh          ; mask off bit 0 for reading BARs
   514                                  PCI_INDEX_PORT  EQU     0CF8h
   515                                  PCI_DATA_PORT   EQU     0CFCh
   516                                  PCI32           EQU     BIT31           ; bitflag to signal 32bit access
   517                                  PCI16           EQU     BIT30           ; bitflag for 16bit access
   518                                  
   519                                  PCI_FN0         EQU     0 << 8
   520                                  PCI_FN1         EQU     1 << 8
   521                                  PCI_FN2         EQU     2 << 8
   522                                  PCI_FN3         EQU     3 << 8
   523                                  PCI_FN4         EQU     4 << 8
   524                                  PCI_FN5         EQU     5 << 8
   525                                  PCI_FN6         EQU     6 << 8
   526                                  PCI_FN7         EQU     7 << 8
   527                                  
   528                                  PCI_CMD_REG		EQU	04h		; reg 04, command reg
   529                                   IO_ENA			EQU	BIT0		; i/o decode enable
   530                                   MEM_ENA		EQU	BIT1		; memory decode enable
   531                                   BM_ENA                 EQU     BIT2		; bus master enable
   532                                  
   533                                  ; CODE
   534                                  
   535                                  ; AC97.ASM
   536                                  ; PCI device register reader/writers.
   537                                  ; NASM version: Erdogan Tan (29/11/2016)
   538                                  ; 		Last Update: 17/02/2017
   539                                  
   540                                  ;===============================================================
   541                                  ; 8/16/32bit PCI reader
   542                                  ;
   543                                  ; Entry: EAX=PCI Bus/Device/fn/register number
   544                                  ;           BIT30 set if 32 bit access requested
   545                                  ;           BIT29 set if 16 bit access requested
   546                                  ;           otherwise defaults to 8bit read
   547                                  ;
   548                                  ; Exit:  DL,DX,EDX register data depending on requested read size
   549                                  ;
   550                                  ; Note: this routine is meant to be called via pciRegRead8, pciRegread16,
   551                                  ;	or pciRegRead32, listed below.
   552                                  ;
   553                                  ; Note2: don't attempt to read 32bits of data from a non dword aligned reg
   554                                  ;	 number.  Likewise, don't do 16bit reads from non word aligned reg #
   555                                  ; 
   556                                  pciRegRead:
   557 00000136 6653                    	push	ebx
   558 00000138 51                      	push	cx
   559 00000139 6689C3                          mov     ebx, eax                        ; save eax, dh
   560 0000013C 88F1                            mov     cl, dh
   561 0000013E 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   562 00000144 660D00000080                    or      eax, BIT31                      ; make a PCI access request
   563 0000014A 24FC                            and     al, ~3 ; NOT 3                  ; force index to be dword
   564                                  
   565 0000014C BAF80C                          mov     dx, PCI_INDEX_PORT
   566 0000014F 66EF                            out     dx, eax                         ; write PCI selector
   567                                  
   568 00000151 BAFC0C                          mov     dx, PCI_DATA_PORT
   569 00000154 88D8                            mov     al, bl
   570 00000156 2403                            and     al, 3                           ; figure out which port to
   571 00000158 00C2                            add     dl, al                          ; read to
   572                                  
   573 0000015A 66ED                    	in      eax, dx                         ; do 32bit read
   574 0000015C 66F7C300000080                  test    ebx, PCI32
   575 00000163 7403                            jz      short _pregr1
   576                                  
   577 00000165 6689C2                          mov     edx, eax                        ; return 32bits of data
   578                                  _pregr1:
   579 00000168 89C2                    	mov     dx, ax                          ; return 16bits of data
   580 0000016A 66F7C3000000C0                  test    ebx, PCI32+PCI16
   581 00000171 7502                            jnz     short _pregr2
   582 00000173 88CE                            mov     dh, cl                          ; restore dh for 8 bit read
   583                                  _pregr2:
   584 00000175 6689D8                          mov     eax, ebx                        ; restore eax
   585 00000178 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   586 0000017E 59                      	pop	cx
   587 0000017F 665B                    	pop	ebx
   588 00000181 C3                      	retn
   589                                  
   590                                  pciRegRead8:
   591 00000182 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32             ; set up 8 bit read size
   592 00000188 EBAC                            jmp     short pciRegRead		; call generic PCI access
   593                                  
   594                                  pciRegRead16:
   595 0000018A 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 16 bit read size
   596 00000190 660D00000040                    or      eax, PCI16			; call generic PCI access
   597 00000196 EB9E                            jmp     short pciRegRead
   598                                  
   599                                  pciRegRead32:
   600 00000198 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 32 bit read size
   601 0000019E 660D00000080                    or      eax, PCI32			; call generic PCI access
   602 000001A4 EB90                            jmp     short pciRegRead
   603                                  
   604                                  ;===============================================================
   605                                  ; 8/16/32bit PCI writer
   606                                  ;
   607                                  ; Entry: EAX=PCI Bus/Device/fn/register number
   608                                  ;           BIT31 set if 32 bit access requested
   609                                  ;           BIT30 set if 16 bit access requested
   610                                  ;           otherwise defaults to 8bit read
   611                                  ;        DL/DX/EDX data to write depending on size
   612                                  ;
   613                                  ;
   614                                  ; note: this routine is meant to be called via pciRegWrite8, pciRegWrite16,
   615                                  ; 	or pciRegWrite32 as detailed below.
   616                                  ;
   617                                  ; Note2: don't attempt to write 32bits of data from a non dword aligned reg
   618                                  ;	 number.  Likewise, don't do 16bit writes from non word aligned reg #
   619                                  ;
   620                                  pciRegWrite:
   621 000001A6 6653                    	push	ebx
   622 000001A8 51                      	push	cx
   623 000001A9 6689C3                          mov     ebx, eax                        ; save eax, dx
   624 000001AC 89D1                            mov     cx, dx
   625 000001AE 660D00000080                    or      eax, BIT31                      ; make a PCI access request
   626 000001B4 6625FFFFFFBF                    and     eax, ~PCI16 ; NOT PCI16         ; clear out data size request
   627 000001BA 24FC                            and     al, ~3 ; NOT 3                  ; force index to be dword
   628                                  
   629 000001BC BAF80C                          mov     dx, PCI_INDEX_PORT
   630 000001BF 66EF                            out     dx, eax                         ; write PCI selector
   631                                  
   632 000001C1 BAFC0C                          mov     dx, PCI_DATA_PORT
   633 000001C4 88D8                            mov     al, bl
   634 000001C6 2403                            and     al, 3                           ; figure out which port to
   635 000001C8 00C2                            add     dl, al                          ; write to
   636                                  
   637 000001CA 6689D0                          mov     eax, edx                        ; put data into eax
   638 000001CD 89C8                            mov     ax, cx
   639                                  
   640 000001CF EE                              out     dx, al
   641 000001D0 66F7C3000000C0                  test    ebx, PCI16+PCI32                ; only 8bit access? bail
   642 000001D7 740C                            jz      short _pregw1
   643                                  
   644 000001D9 EF                              out     dx, ax                          ; write 16 bit value
   645 000001DA 66F7C300000040                  test    ebx, PCI16                      ; 16bit requested?  bail
   646 000001E1 7502                            jnz     short _pregw1
   647                                  
   648 000001E3 66EF                            out     dx, eax                         ; write full 32bit
   649                                  _pregw1:
   650 000001E5 6689D8                          mov     eax, ebx                        ; restore eax
   651 000001E8 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   652 000001EE 89CA                            mov     dx, cx                          ; restore dx
   653 000001F0 59                      	pop	cx
   654 000001F1 665B                    	pop	ebx
   655 000001F3 C3                      	ret
   656                                  
   657                                  pciRegWrite8:
   658 000001F4 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 8 bit write size
   659 000001FA EBAA                            jmp     short pciRegWrite		; call generic PCI access
   660                                  
   661                                  pciRegWrite16:
   662 000001FC 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 16 bit write size
   663 00000202 660D00000040                    or      eax, PCI16			; call generic PCI access
   664 00000208 EB9C                            jmp     short pciRegWrite
   665                                  
   666                                  pciRegWrite32:
   667 0000020A 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 32 bit write size
   668 00000210 660D00000080                    or      eax, PCI32			; call generic PCI access
   669 00000216 EB8E                            jmp     short pciRegWrite
   670                                  
   671                                  ; AC97.ASM (PLAYWAV.COM)
   672                                  ; 17/02/2017 (Modifed by Erdogan Tan for various ICH device IDs)
   673                                  ;===============================================================
   674                                  ; PCIFindDevice: scan through PCI space looking for a device+vendor ID
   675                                  ;
   676                                  ;  ENTRY: none
   677                                  ;; Entry: EAX=Device+Vendor ID
   678                                  ;
   679                                  ;  Exit: EAX=PCI address if device found
   680                                  ;	 EDX=Device+Vendor ID
   681                                  ;        CY clear if found, set if not found. EAX invalid if CY set.
   682                                  ;
   683                                  ; [old stackless] Destroys: ebx, esi, edi, cl
   684                                  ;
   685                                  pciFindDevice:
   686                                  	;push	cx
   687                                  	;push	eax ; *
   688                                  	;push	esi
   689                                  	;push	edi
   690                                  
   691                                   	;mov     esi, eax                ; save off vend+device ID
   692                                  
   693                                  	; 17/02/2017
   694 00000218 BE[3E0E]                	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
   695 0000021B B91500                  	mov	cx, valid_id_count
   696                                  pfd_0:
   697 0000021E 66BF00FFFF7F                   	mov     edi, (80000000h - 100h) ; start with bus 0, dev 0 func 0
   698                                  nextPCIdevice:
   699 00000224 6681C700010000                  add     edi, 100h
   700 0000022B 6681FF00F8FF80                  cmp     edi, 80FFF800h		; scanned all devices?
   701                                          ;stc
   702                                          ;je 	short PCIScanExit       ; not found
   703 00000232 720D                    	jb	short pfd_1
   704 00000234 66BF00000080            	mov     edi, 80000000h
   705 0000023A 83C604                  	add	si, 4 ; scan for next device ID
   706 0000023D E202                    	loop	pfd_1	 
   707 0000023F F9                      	stc	
   708                                  	;jmp 	short PCIScanExit
   709 00000240 C3                      	retn
   710                                  pfd_1:
   711 00000241 6689F8                          mov     eax, edi                ; read PCI registers
   712 00000244 E851FF                          call    pciRegRead32
   713                                          ;cmp    edx, esi                ; found device?
   714 00000247 663B14                          cmp	edx, dword [si]
   715 0000024A 75D8                    	jne     short nextPCIdevice
   716                                          ;clc
   717                                  PCIScanExit:
   718                                  	;pushf
   719 0000024C 66B800000080            	mov	eax, BIT31
   720 00000252 66F7D0                  	not	eax
   721 00000255 6621F8                  	and	eax, edi		; return only bus/dev/fn #
   722                                  	;popf
   723                                  
   724                                  	;pop	edi
   725                                  	;pop	esi
   726                                  	;pop	edx ; *
   727                                  	;pop	cx
   728 00000258 C3                      	retn
   729                                  
   730                                  ;=============================================================================
   731                                  ;               CODEC.ASM
   732                                  ;=============================================================================
   733                                  
   734                                  ; EQUATES
   735                                  
   736                                  ;Codec registers.
   737                                  ;
   738                                  ;Not all codecs are created equal. Refer to the spec for your specific codec.
   739                                  ;
   740                                  ;All registers are 16bits wide.  Access to codec registers over the AC97 link
   741                                  ;is defined by the OEM.  
   742                                  ;
   743                                  ;Secondary codec's are accessed by ORing in BIT7 of all register accesses.
   744                                  ;
   745                                  
   746                                  ; each codec/mixer register is 16bits
   747                                  
   748                                  CODEC_RESET_REG                 equ     00      ; reset codec
   749                                  CODEC_MASTER_VOL_REG            equ     02      ; master volume
   750                                  CODEC_HP_VOL_REG                equ     04      ; headphone volume
   751                                  CODEC_MASTER_MONO_VOL_REG       equ     06      ; master mono volume
   752                                  CODEC_MASTER_TONE_REG           equ     08      ; master tone (R+L)
   753                                  CODEC_PCBEEP_VOL_REG            equ     0ah     ; PC beep volume
   754                                  CODEC_PHONE_VOL_REG             equ     0bh     ; phone volume
   755                                  CODEC_MIC_VOL_REG               equ     0eh     ; MIC volume
   756                                  CODEC_LINE_IN_VOL_REG           equ     10h     ; line input volume
   757                                  CODEC_CD_VOL_REG                equ     12h     ; CD volume
   758                                  CODEC_VID_VOL_REG               equ     14h     ; video volume
   759                                  CODEC_AUX_VOL_REG               equ     16h     ; aux volume
   760                                  CODEC_PCM_OUT_REG               equ     18h     ; PCM output volume
   761                                  CODEC_RECORD_SELECT_REG         equ     1ah     ; record select input
   762                                  CODEC_RECORD_VOL_REG            equ     1ch     ; record volume
   763                                  CODEC_RECORD_MIC_VOL_REG        equ     1eh     ; record mic volume
   764                                  CODEC_GP_REG                    equ     20h     ; general purpose
   765                                  CODEC_3D_CONTROL_REG            equ     22h     ; 3D control
   766                                  ; 24h is reserved
   767                                  CODEC_POWER_CTRL_REG            equ     26h     ; powerdown control
   768                                  CODEC_EXT_AUDIO_REG             equ     28h     ; extended audio
   769                                  CODEC_EXT_AUDIO_CTRL_REG        equ     2ah     ; extended audio control
   770                                  CODEC_PCM_FRONT_DACRATE_REG     equ     2ch     ; PCM out sample rate
   771                                  CODEC_PCM_SURND_DACRATE_REG     equ     2eh     ; surround sound sample rate
   772                                  CODEC_PCM_LFE_DACRATE_REG       equ     30h     ; LFE sample rate
   773                                  CODEC_LR_ADCRATE_REG            equ     32h     ; PCM in sample rate
   774                                  CODEC_MIC_ADCRATE_REG           equ     34h     ; mic in sample rate
   775                                  
   776                                  ; registers 36-7a are reserved on the ICH
   777                                  
   778                                  CODEC_VENDORID1_REG             equ     7ch     ; codec vendor ID 1
   779                                  CODEC_VENDORID2_REG             equ     7eh     ; codec vendor ID 2
   780                                  
   781                                  ; Mixer registers 0 through 51h reside in the ICH and are not forwarded over
   782                                  ; the AC97 link to the codec, which I think is a little weird.  Looks like
   783                                  ; the ICH makes it so you don't need a fully functional codec to play audio?
   784                                  ;
   785                                  ; whenever 2 codecs are present in the system, use BIT7 to access the 2nd
   786                                  ; set of registers, ie 80h-feh
   787                                  
   788                                  PRIMARY_CODEC                   equ     0       ; 0-7F for primary codec
   789                                  SECONDARY_CODEC                 equ     BIT7    ; 80-8f registers for 2ndary
   790                                  
   791                                  SAMPLE_RATE_441khz	equ     44100   ; 44.1Khz (cd quality) rate
   792                                  
   793                                  ; ----------------------------------------------------------------------------
   794                                  ; 17/02/2017
   795                                  PCI_IO_BASE	equ 10h			; = NAMBAR register offset
   796                                  AC97_INT_LINE   equ 3Ch			; AC97 Interrupt Line register offset
   797                                  
   798                                  ; ----------------------------------------------------------------------------
   799                                  ; ICH2AC97.INC
   800                                  ; ----------------------------------------------------------------------------
   801                                  
   802                                  ; PCI stuff
   803                                  
   804                                  ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
   805                                  
   806                                  INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
   807                                  
   808                                  ; 08/05/2024
   809                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   810                                  SIS_VID		equ	1039h
   811                                  NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
   812                                  AMD_VID		equ	1022h
   813                                  
   814                                  ICH_DID         equ     2415h           ; ICH device ID
   815                                  ICH0_DID        equ     2425h           ; ICH0
   816                                  ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
   817                                                                          ; they all should be compatible.
   818                                  ; 08/05/2024
   819                                  ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
   820                                  ICH3_DID	equ     2485h           ; ICH3
   821                                  ICH4_DID        equ     24C5h           ; ICH4
   822                                  ICH5_DID	equ     24D5h           ; ICH5 
   823                                  ICH6_DID	equ     266Eh           ; ICH6
   824                                  ESB6300_DID	equ     25A6h           ; 6300ESB
   825                                  ESB631X_DID	equ     2698h           ; 631XESB
   826                                  ICH7_DID	equ	27DEh		; ICH7
   827                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   828                                  MX82440_DID	equ	7195h
   829                                  SI7012_DID	equ	7012h
   830                                  NFORCE_DID	equ	01B1h
   831                                  NFORCE2_DID	equ	006Ah
   832                                  AMD8111_DID	equ	746Dh
   833                                  AMD768_DID	equ	7445h
   834                                  ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
   835                                  CK804_DID	equ	0059h
   836                                  MCP04_DID	equ	003Ah
   837                                  CK8_DID		equ	008Ah
   838                                  NFORCE3_DID	equ	00DAh
   839                                  CK8S_DID	equ	00EAh
   840                                  
   841                                  NAMBAR_REG      equ     10h             ; native audio mixer BAR
   842                                   NAM_SIZE       equ     256             ; 256 bytes required.
   843                                  
   844                                  NABMBAR_REG     equ     14h             ; native audio bus mastering BAR
   845                                   NABM_SIZE      equ     64              ; 64 bytes
   846                                  
   847                                  ; BUS master registers, accessed via NABMBAR+offset
   848                                  
   849                                  ; ICH supports 3 different types of register sets for three types of things
   850                                  ; it can do, thus:
   851                                  ;
   852                                  ; PCM in (for recording) aka PI
   853                                  ; PCM out (for playback) aka PO
   854                                  ; MIC in (for recording) aka MC
   855                                  
   856                                  PI_BDBAR_REG            equ     0       ; PCM in buffer descriptor BAR
   857                                  PO_BDBAR_REG            equ     10h     ; PCM out buffer descriptor BAR
   858                                  MC_BDBAR_REG            equ     20h     ; MIC in buffer descriptor BAR
   859                                  
   860                                  ; each buffer descriptor BAR holds a pointer which has entries to the buffer
   861                                  ; contents of the .WAV file we're going to play.  Each entry is 8 bytes long
   862                                  ; (more on that later) and can contain 32 entries total, so each BAR is
   863                                  ; 256 bytes in length, thus:
   864                                  
   865                                  BDL_SIZE                equ     32*8    ; Buffer Descriptor List size
   866                                  INDEX_MASK              equ     31      ; indexes must be 0-31
   867                                  
   868                                  
   869                                  
   870                                  PI_CIV_REG              equ     4       ; PCM in current Index value (RO)
   871                                  PO_CIV_REG              equ     14h     ; PCM out current Index value (RO)
   872                                  MC_CIV_REG              equ     24h     ; MIC in current Index value (RO)
   873                                  ;8bit read only
   874                                  ; each current index value is simply a pointer showing us which buffer
   875                                  ; (0-31) the codec is currently processing.  Once this counter hits 31, it
   876                                  ; wraps back to 0.
   877                                  ; this can be handy to know, as once it hits 31, we're almost out of data to
   878                                  ; play back or room to record!
   879                                  
   880                                  
   881                                  PI_LVI_REG              equ     5       ; PCM in Last Valid Index
   882                                  PO_LVI_REG              equ     15h     ; PCM out Last Valid Index
   883                                  MC_LVI_REG              equ     25h     ; MIC in Last Valid Index
   884                                  ;8bit read/write
   885                                  ; The Last Valid Index is a number (0-31) to let the codec know what buffer
   886                                  ; number to stop on after processing.  It could be very nasty to play audio
   887                                  ; from buffers that aren't filled with the audio we want to play.
   888                                  
   889                                  
   890                                  PI_SR_REG               equ     6       ; PCM in Status register
   891                                  PO_SR_REG               equ     16h     ; PCM out Status register
   892                                  MC_SR_REG               equ     26h     ; MIC in Status register
   893                                  ;16bit read/write
   894                                  ; status registers.  Bitfields follow:
   895                                  
   896                                  FIFO_ERR                equ     BIT4    ; FIFO Over/Underrun W1TC.
   897                                  
   898                                  BCIS                    equ     BIT3    ; buffer completion interrupt status.
   899                                                                          ; Set whenever the last sample in ANY
   900                                                                          ; buffer is finished.  Bit is only
   901                                                                          ; set when the Interrupt on Complete
   902                                                                          ; (BIT4 of control reg) is set.
   903                                  
   904                                  LVBCI                   equ     BIT2    ; Set whenever the codec has processed
   905                                                                          ; the last buffer in the buffer list.
   906                                                                          ; Will fire an interrupt if IOC bit is
   907                                                                          ; set. Probably set after the last
   908                                                                          ; sample in the last buffer is
   909                                                                          ; processed.  W1TC
   910                                  
   911                                                                          ; 
   912                                  CELV                    equ     BIT1    ; Current buffer == last valid.
   913                                                                          ; Bit is RO and remains set until LVI is
   914                                                                          ; cleared.  Probably set up the start
   915                                                                          ; of processing for the last buffer.
   916                                  
   917                                  
   918                                  DCH                     equ     BIT0    ; DMA controller halted.
   919                                                                          ; set whenever audio stream is stopped
   920                                                                          ; or something else goes wrong.
   921                                  
   922                                  PI_PICB_REG             equ     8       ; PCM in position in current buffer(RO)
   923                                  PO_PICB_REG             equ     18h     ; PCM out position in current buffer(RO)
   924                                  MC_PICB_REG             equ     28h     ; MIC in position in current buffer (RO)
   925                                  ;16bit read only
   926                                  ; position in current buffer regs show the number of dwords left to be
   927                                  ; processed in the current buffer.
   928                                  ; 
   929                                  
   930                                  PI_PIV_REG              equ     0ah     ; PCM in Prefected index value
   931                                  PO_PIV_REG              equ     1ah     ; PCM out Prefected index value
   932                                  MC_PIV_REG              equ     2ah     ; MIC in Prefected index value
   933                                  ;8bit, read only
   934                                  ; Prefetched index value register.
   935                                  ; tells which buffer number (0-31) has be prefetched.  I'd imagine this
   936                                  ; value follows the current index value fairly closely. (CIV+1)
   937                                  ;
   938                                  
   939                                  PI_CR_REG               equ     0bh     ; PCM in Control Register
   940                                  PO_CR_REG               equ     1bh     ; PCM out Control Register
   941                                  MC_CR_REG               equ     2bh     ; MIC in Control Register
   942                                  ; 8bit
   943                                  ; Control register *MUST* only be accessed as an 8bit value.
   944                                  ; Control register.  See bitfields below.
   945                                  ;
   946                                  
   947                                  IOCE                    equ     BIT4    ; interrupt on complete enable.
   948                                                                          ; set this bit if you want an intrtpt
   949                                                                          ; to fire whenever LVBCI is set.
   950                                  FEIFE                   equ     BIT3    ; set if you want an interrupt to fire
   951                                                                          ; whenever there is a FIFO (over or
   952                                                                          ; under) error.
   953                                  LVBIE                   equ     BIT2    ; last valid buffer interrupt enable.
   954                                                                          ; set if you want an interrupt to fire
   955                                                                          ; whenever the completion of the last
   956                                                                          ; valid buffer.
   957                                  RR                      equ     BIT1    ; reset registers.  Nukes all regs
   958                                                                          ; except bits 4:2 of this register.
   959                                                                          ; Only set this bit if BIT 0 is 0
   960                                  RPBM                    equ     BIT0    ; Run/Pause
   961                                                                          ; set this bit to start the codec!
   962                                  
   963                                  
   964                                  GLOB_CNT_REG            equ     2ch     ; Global control register
   965                                  SEC_RES_EN              equ     BIT5    ; secondary codec resume event 
   966                                                                          ; interrupt enable.  Not used here.
   967                                  PRI_RES_EN              equ     BIT4    ; ditto for primary. Not used here.
   968                                  ACLINK_OFF              equ     BIT3    ; Turn off the AC97 link
   969                                  ACWARM_RESET            equ     BIT2    ; Awaken the AC97 link from sleep.
   970                                                                          ; registers preserved, bit self clears
   971                                  ACCOLD_RESET            equ     BIT1    ; Reset everything in the AC97 and
   972                                                                          ; reset all registers.  Not self clearing
   973                                  
   974                                  GPIIE                   equ     BIT0    ; GPI Interrupt enable.
   975                                                                          ; set if you want an interrupt to
   976                                                                          ; fire upon ANY of the bits in the
   977                                                                          ; GPI (general pursose inputs?) not used.
   978                                  
   979                                  GLOB_STS_REG            equ     30h     ; Global Status register (RO)
   980                                  
   981                                  MD3                     equ     BIT17   ; modem powerdown status (yawn)
   982                                  AD3                     equ     BIT16   ; Audio powerdown status (yawn)
   983                                  RD_COMPLETE_STS         equ     BIT15   ; Codec read timed out. 0=normal
   984                                  BIT3SLOT12              equ     BIT14   ; shadowed status of bit 3 in slot 12
   985                                  BIT2SLOT12              equ     BIT13   ; shadowed status of bit 2 in slot 12
   986                                  BIT1SLOT12              equ     BIT12   ; shadowed status of bit 1 in slot 12
   987                                  SEC_RESUME_STS          equ     BIT11   ; secondary codec has resumed (and irqed)
   988                                  PRI_RESUME_STS          equ     BIT10   ; primary codec has resumed (and irqed)
   989                                  SEC_CODEC_RDY           equ     BIT9    ; secondary codec is ready for action
   990                                  PRI_CODEC_RDY           equ     BIT8    ; Primary codec is ready for action
   991                                                                          ; software must check these bits before
   992                                                                          ; starting the codec!
   993                                  MIC_IN_IRQ              equ     BIT7    ; MIC in caused an interrupt
   994                                  PCM_OUT_IRQ             equ     BIT6    ; One of the PCM out channels IRQed
   995                                  PCM_IN_IRQ              equ     BIT5    ; One of the PCM in channels IRQed
   996                                  MODEM_OUT_IRQ           equ     BIT2    ; modem out channel IRQed
   997                                  MODEM_IN_IRQ            equ     BIT1    ; modem in channel IRQed
   998                                  GPI_STS_CHANGE          equ     BIT0    ; set whenever GPI's have changed.
   999                                                                          ; BIT0 of slot 12 also reflects this.
  1000                                  
  1001                                  
  1002                                  ACC_SEMA_REG            equ     34h     ; Codec write semiphore register
  1003                                  CODEC_BUSY              equ     BIT0    ; codec register I/O is happening
  1004                                                                          ; self clearing
  1005                                  ;
  1006                                  ; Buffer Descriptors List
  1007                                  ; As stated earlier, each buffer descriptor list is a set of (up to) 32 
  1008                                  ; descriptors, each 8 bytes in length.  Bytes 0-3 of a descriptor entry point
  1009                                  ; to a chunk of memory to either play from or record to.  Bytes 4-7 of an
  1010                                  ; entry describe various control things detailed below.
  1011                                  ; 
  1012                                  ; Buffer pointers must always be aligned on a Dword boundry.
  1013                                  ;
  1014                                  ;
  1015                                  
  1016                                  IOC                     equ     BIT31   ; Fire an interrupt whenever this
  1017                                                                          ; buffer is complete.
  1018                                  
  1019                                  BUP                     equ     BIT30   ; Buffer Underrun Policy.
  1020                                                                          ; if this buffer is the last buffer
  1021                                                                          ; in a playback, fill the remaining
  1022                                                                          ; samples with 0 (silence) or not.
  1023                                                                          ; It's a good idea to set this to 1
  1024                                                                          ; for the last buffer in playback,
  1025                                                                          ; otherwise you're likely to get a lot
  1026                                                                          ; of noise at the end of the sound.
  1027                                  
  1028                                  ;
  1029                                  ; Bits 15:0 contain the length of the buffer, in number of samples, which
  1030                                  ; are 16 bits each, coupled in left and right pairs, or 32bits each.
  1031                                  ; Luckily for us, that's the same format as .wav files.
  1032                                  ;
  1033                                  ; A value of FFFF is 65536 samples.  Running at 44.1Khz, that's just about
  1034                                  ; 1.5 seconds of sample time.  FFFF * 32bits is 1FFFFh bytes or 128k of data.
  1035                                  ;
  1036                                  ; A value of 0 in these bits means play no samples.
  1037                                  ;
  1038                                  
  1039                                  ; CODE
  1040                                  
  1041                                  ; AC97.ASM
  1042                                  
  1043                                  ; codec configuration code.  Not much here really.
  1044                                  ; NASM version: Erdogan Tan (29/11/2016)
  1045                                  
  1046                                  ; enable codec, unmute stuff, set output rate to 44.1
  1047                                  ; entry: ax = desired sample rate
  1048                                  ;
  1049                                  
  1050                                  ; 08/04/2024
  1051                                  %if 0
  1052                                  
  1053                                  codecConfig:
  1054                                  	; 17/02/2017 
  1055                                  	; 07/11/2016 (Erdogan Tan)
  1056                                  	PORT_NABM_GLB_CTRL_STAT equ 60h
  1057                                  
  1058                                  	;mov    dx, [NAMBAR]               	; mixer base address
  1059                                  	;add	dx, CODEC_EXT_AUDIO_REG	       	; 28h  	  
  1060                                  	;in	ax, dx
  1061                                  	;and	ax, 1
  1062                                  	;jnz	short _ssr
  1063                                  	;pop	ax
  1064                                  	;jmp	short cconf_1
  1065                                  
  1066                                  _ssr:
  1067                                  	mov    	dx, [NAMBAR]               	
  1068                                  	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah  	  
  1069                                  	in     	ax, dx
  1070                                  	or	ax, 1
  1071                                  	out	dx, ax 				; Enable variable rate audio
  1072                                  
  1073                                          call    delay1_4ms
  1074                                          call    delay1_4ms
  1075                                          call    delay1_4ms
  1076                                          call    delay1_4ms
  1077                                  
  1078                                  	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
  1079                                  
  1080                                  	mov    	dx, [NAMBAR]               	
  1081                                  	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
  1082                                  	out	dx, ax 				; out sample rate
  1083                                  		
  1084                                  	;mov    dx, [NAMBAR]               	
  1085                                  	;add    dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
  1086                                  	;out	dx, ax 
  1087                                  
  1088                                          call    delay1_4ms
  1089                                          call    delay1_4ms
  1090                                          call    delay1_4ms
  1091                                          call    delay1_4ms
  1092                                  
  1093                                  ;cconf_1:
  1094                                  	mov     dx, [NAMBAR]			; mixer base address
  1095                                          add     dx, CODEC_RESET_REG  		; reset register
  1096                                          mov	ax, 42
  1097                                  	out     dx, ax                          ; reset
  1098                                  
  1099                                  	mov     dx, [NABMBAR]			; bus master base address
  1100                                          add     dx, PORT_NABM_GLB_CTRL_STAT
  1101                                          mov	ax, 2
  1102                                  	out     dx, ax                         
  1103                                  
  1104                                  	mov	cx, 7
  1105                                  _100ms:
  1106                                  	push	cx
  1107                                          call    delay1_4ms
  1108                                          call    delay1_4ms
  1109                                          call    delay1_4ms
  1110                                          call    delay1_4ms
  1111                                  	pop	cx
  1112                                  	loop	_100ms	
  1113                                  	
  1114                                    	mov     dx, [NAMBAR]
  1115                                    	add     dx, CODEC_MASTER_VOL_REG        ;02h 
  1116                                    	xor     ax, ax ; ; volume attenuation = 0 (max. volume)
  1117                                    	out     dx, ax
  1118                                   
  1119                                    	mov     dx, [NAMBAR]
  1120                                    	add     dx, CODEC_MASTER_MONO_VOL_REG   ;06h 
  1121                                    	;xor    ax, ax
  1122                                    	out     dx, ax
  1123                                  
  1124                                    	mov     dx, [NAMBAR]
  1125                                    	add     dx, CODEC_PCBEEP_VOL_REG        ;0Ah 
  1126                                    	;xor    ax, ax
  1127                                    	out     dx, ax
  1128                                  
  1129                                    	mov     dx, [NAMBAR]
  1130                                    	add     dx, CODEC_PCM_OUT_REG		;18h 
  1131                                    	;xor    ax, ax
  1132                                    	out     dx, ax
  1133                                  
  1134                                          call    delay1_4ms
  1135                                          call    delay1_4ms
  1136                                          call    delay1_4ms
  1137                                          call    delay1_4ms
  1138                                  
  1139                                          retn
  1140                                  
  1141                                  %else
  1142                                  	; 08/05/2024
  1143                                  	; (ac97_vra.asm, 19/11/2023, Erdogan Tan, playwav3.asm) 
  1144                                  codecConfig:
  1145                                  	; 19/11/2023
  1146                                  	; 15/11/2023
  1147                                  	; 04/11/2023
  1148                                  	; 17/02/2017 
  1149                                  	; 07/11/2016 (Erdogan Tan)
  1150                                  	;PORT_NABM_GLB_CTRL_STAT equ 60h
  1151                                  
  1152                                  	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
  1153                                   	; 'AC97_DEF.H'
  1154                                  	;AC97_EXTENDED_STATUS equ 002Ah
  1155                                  	AC97_EA_SPDIF	equ 0002h
  1156                                  	AC97_EA_VRA	equ 0001h
  1157                                  	; 04/11/2023
  1158                                  	ICH_PO_CR_RESET equ 0002h  ; reset codec
  1159                                  	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
  1160                                  	ICH_PCM_246_MASK equ 300000h ; 6 channels
  1161                                  
  1162                                  	; 08/05/2024
  1163                                  	; 11/11/2023
  1164                                  	CTRL_ST_CREADY	equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
  1165                                  	CODEC_REG_POWERDOWN equ	26h
  1166                                  
  1167                                  	; 04/11/2023
  1168                                  init_ac97_controller:
  1169 00000259 66A1[8A0F]              	mov	eax, [bus_dev_fn]
  1170 0000025D B004                    	mov	al, PCI_CMD_REG
  1171 0000025F E828FF                  	call	pciRegRead16		; read PCI command register
  1172 00000262 80CA05                  	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
  1173 00000265 E894FF                  	call	pciRegWrite16
  1174                                  
  1175 00000268 E87001                  	call	delay_100ms
  1176                                  
  1177                                  init_ac97_codec:
  1178                                  	; 18/11/2023
  1179 0000026B BD2800                  	mov	bp, 40
  1180                                  _initc_1:
  1181                                  	; 11/11/2023
  1182                                  	; (TRDOS 386 v2.0.5, 'audio.s')
  1183 0000026E BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1184 00000271 0316[760F]              	add	dx, [NABMBAR]
  1185 00000275 66ED                    	in	eax, dx
  1186                                  	; ?
  1187                                  	;; 15/11/2023
  1188                                  	;;mov	cx, 40
  1189                                  	;mov	bp, 40 ; 18/11/2023
  1190                                  ;_initc_1:
  1191 00000277 BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1192 0000027A 0316[760F]              	add	dx, [NABMBAR]
  1193 0000027E 66ED                    	in	eax, dx
  1194                                  
  1195 00000280 6683F8FF                	cmp	eax, 0FFFFFFFFh ; -1
  1196                                  	;je	short init_ac97_codec_err1
  1197                                  	; 15/11/2023
  1198 00000284 7508                    	jne	short _initc_3
  1199                                  _initc_2:
  1200                                  	;dec	cx
  1201 00000286 4D                      	dec	bp	; 18/11/2023
  1202                                  	;jz	short init_ac97_codec_err1
  1203                                  	; 19/11/2023
  1204 00000287 7412                    	jz	short _ac97_codec_ready
  1205                                  
  1206 00000289 E84F01                  	call	delay_100ms
  1207 0000028C EBE0                    	jmp	short _initc_1
  1208                                  _initc_3:
  1209 0000028E 66A900030010            	test	eax, CTRL_ST_CREADY
  1210 00000294 7505                    	jnz	short _ac97_codec_ready
  1211                                  
  1212 00000296 E8C200                  	call	reset_ac97_codec
  1213                                  	; 11/11/2023
  1214                                  	;jc	short init_ac97_codec_err2
  1215                                  	; 15/11/2023
  1216 00000299 72EB                    	jc	short _initc_2
  1217                                  
  1218                                  _ac97_codec_ready:
  1219 0000029B 8B16[740F]              	mov	dx, [NAMBAR]
  1220                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  1221 0000029F EF                      	out	dx, ax
  1222                                  
  1223 000002A0 E83801                  	call	delay_100ms
  1224                                  
  1225                                  	; 19/11/2023
  1226 000002A3 09ED                    	or	bp, bp
  1227 000002A5 751D                    	jnz	short _ac97_codec_init_ok
  1228                                  
  1229 000002A7 6631C0                  	xor	eax, eax ; 0
  1230 000002AA 8B16[740F]              	mov	dx, [NAMBAR]
  1231 000002AE 83C226                  	add	dx, CODEC_REG_POWERDOWN
  1232 000002B1 EF                      	out	dx, ax
  1233                                  	
  1234                                  	; 19/11/2023
  1235                                  	; wait for 1 second
  1236                                  	;mov	ecx, 1000 ; 1000*4*0.25ms = 1s
  1237 000002B2 B90A00                  	mov	cx, 10
  1238                                  _ac97_codec_rloop:
  1239                                  	;call	delay1_4ms
  1240                                  	;call	delay1_4ms
  1241                                  	;call	delay1_4ms
  1242                                  	;call	delay1_4ms
  1243 000002B5 E82301                  	call	delay_100ms
  1244                                  	;mov	dx, [NAMBAR]
  1245                                  	;add	dx, CODEC_REG_POWERDOWN
  1246 000002B8 ED                      	in	ax, dx	
  1247 000002B9 83E00F                  	and	ax, 0Fh
  1248 000002BC 3C0F                    	cmp	al, 0Fh
  1249 000002BE 7404                    	je	short _ac97_codec_init_ok
  1250 000002C0 E2F3                    	loop	_ac97_codec_rloop 
  1251                                  
  1252                                  init_ac97_codec_err1:
  1253 000002C2 F9                      	stc
  1254                                  init_ac97_codec_err2:
  1255 000002C3 C3                      	retn
  1256                                  
  1257                                  _ac97_codec_init_ok:
  1258                                          ; 11/11/2023
  1259                                  	;mov	al, 2 ; force set 16-bit 2-channel PCM
  1260                                  	;mov	dx, GLOB_CNT_REG ; 2Ch
  1261                                  	;add	dx, [NABMBAR]
  1262                                  	;out	dx, eax
  1263                                  
  1264                                  	;;call	delay1_4ms
  1265                                  
  1266 000002C4 E85F00                  	call 	reset_ac97_controller
  1267                                  
  1268                                  	; 11/11/2023
  1269 000002C7 E88408                  	call	delay1_4ms
  1270                                  
  1271                                  	;call 	setup_ac97_codec
  1272                                  
  1273                                  setup_ac97_codec:
  1274                                  	; 08/05/2028
  1275                                  	; [sample_rate] = 22050
  1276                                  	; 12/11/2023
  1277                                  	;cmp	word [sample_rate], 48000
  1278                                  	;je	short skip_rate
  1279                                  
  1280                                  ; 11/11/2023
  1281                                  ; 05/11/2023
  1282                                  ;%if 1
  1283                                  	AC97_EA_VRA equ BIT0 ; 11/11/2023
  1284                                  
  1285                                  	; 11/11/2023
  1286 000002CA 8B16[740F]              	mov    	dx, [NAMBAR]               	
  1287 000002CE 83C22A                  	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah  	  
  1288 000002D1 ED                      	in     	ax, dx
  1289 000002D2 24FD                    	and	al, ~BIT1 ; Clear DRA
  1290 000002D4 0C01                    	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
  1291 000002D6 EF                      	out	dx, ax			; Enable variable rate audio
  1292                                  	
  1293 000002D7 B90A00                  	mov	cx, 10
  1294                                  check_vra:
  1295 000002DA E8FE00                  	call	delay_100ms
  1296                                  
  1297                                  	; 11/11/2023
  1298 000002DD ED                      	in	ax, dx
  1299 000002DE A801                    	test	al, AC97_EA_VRA ; 1
  1300 000002E0 750A                    	jnz	short set_rate
  1301                                  
  1302                                  	; 11/11/2023
  1303 000002E2 E2F6                    	loop	check_vra
  1304                                  
  1305                                  	; 13/11/2023
  1306                                  	;mov	byte [VRA], 0
  1307                                  	; 08/05/2024
  1308 000002E4 C706[D454]80BB          	mov	word [sample_rate], 48000
  1309 000002EA EB0E                    	jmp	short skip_rate	
  1310                                  
  1311                                  	; 12/11/2023
  1312                                  	;pop	ax ; discard return address to the caller
  1313                                  	;mov	dx, msg_no_vra
  1314                                  	;jmp	vra_err
  1315                                  
  1316                                  set_rate:
  1317 000002EC A1[D454]                	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
  1318                                  	; 08/05/2024
  1319                                  	; ax = 22050 (Hz)
  1320                                  
  1321 000002EF 8B16[740F]              	mov    	dx, [NAMBAR]               	
  1322 000002F3 83C22C                  	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
  1323 000002F6 EF                      	out	dx, ax 			; PCM Front/Center Output Sample Rate
  1324                                  
  1325 000002F7 E8E100                  	call	delay_100ms
  1326                                  
  1327                                  	; 12/11/2023
  1328                                  skip_rate:
  1329                                  	; 11/11/2023 (temporary)
  1330                                  
  1331                                  	;mov   	dx, [NAMBAR]               	
  1332                                  	;add   	dx, CODEC_PCM_SURND_DACRATE_REG	; 2Eh  	  
  1333                                  	;out	dx, ax 			; PCM Surround Output Sample Rate
  1334                                  
  1335                                  	;call	delay_100ms
  1336                                  
  1337                                  	;mov   	dx, [NAMBAR]               	
  1338                                  	;add   	dx, CODEC_PCM_LFE_DACRATE_REG	; 30h  	  
  1339                                  	;out	dx, ax 			; PCM LFE Output Sample Rate
  1340                                  
  1341                                  	;call	delay_100ms
  1342                                  
  1343                                  	; 05/11/2023 (temporary)
  1344                                  	;mov	dx, [NAMBAR]               	
  1345                                  	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
  1346                                  	;out	dx, ax 			; PCM Input Sample Rate
  1347                                  	;
  1348                                  	;call	delay_100ms
  1349                                  
  1350 000002FA B80202                  	mov	ax, 0202h
  1351 000002FD 8B16[740F]                	mov     dx, [NAMBAR]
  1352 00000301 83C202                    	add     dx, CODEC_MASTER_VOL_REG	;02h 
  1353 00000304 EF                      	out     dx, ax
  1354                                  
  1355                                  	; 11/11/2023
  1356                                          ;call	delay1_4ms
  1357                                          ;call	delay1_4ms
  1358                                          ;call	delay1_4ms
  1359                                          ;call	delay1_4ms
  1360                                   	;
  1361                                    	;mov	dx, [NAMBAR]
  1362                                    	;add	dx, CODEC_MASTER_MONO_VOL_REG	;06h 
  1363                                    	;out	dx, ax
  1364                                  
  1365                                  	; 11/11/2023
  1366                                          ;call	delay1_4ms
  1367                                          ;call	delay1_4ms
  1368                                          ;call	delay1_4ms
  1369                                          ;call	delay1_4ms
  1370                                  	;
  1371                                  	;mov	ax, 02h
  1372                                    	;mov	dx, [NAMBAR]
  1373                                    	;add	dx, CODEC_PCBEEP_VOL_REG	;0Ah 
  1374                                    	;out	dx, ax
  1375                                  
  1376 00000305 E84608                          call    delay1_4ms
  1377 00000308 E84308                          call    delay1_4ms
  1378 0000030B E84008                          call    delay1_4ms
  1379 0000030E E83D08                          call    delay1_4ms
  1380                                  
  1381                                  	;mov	ax, 0202h
  1382 00000311 8B16[740F]                	mov     dx, [NAMBAR]
  1383 00000315 83C218                    	add     dx, CODEC_PCM_OUT_REG		;18h 
  1384 00000318 EF                        	out     dx, ax
  1385                                  
  1386 00000319 E83208                          call    delay1_4ms
  1387 0000031C E82F08                          call    delay1_4ms
  1388 0000031F E82C08                          call    delay1_4ms
  1389 00000322 E82908                          call    delay1_4ms
  1390                                  
  1391                                  	; 11/11/2023
  1392                                  	;mov	ax, 8008h ; Mute
  1393                                    	;mov	dx, [NAMBAR]
  1394                                  	;add	dx, CODEC_PHONE_VOL_REG		;0Ch
  1395                                  	;			 ; AC97_PHONE_VOL ; TAD Input (Mono)
  1396                                    	;out	dx, ax
  1397                                  	;
  1398                                          ;call	delay1_4ms
  1399                                          ;call	delay1_4ms
  1400                                          ;call	delay1_4ms
  1401                                  	;call	delay1_4ms
  1402                                  
  1403                                  	;mov	ax, 0808h
  1404                                  	;mov	dx, [NAMBAR]
  1405                                  	;add	dx, CODEC_LINE_IN_VOL_REG ;10h ; Line Input (Stereo)
  1406                                  	;out	dx, ax
  1407                                  	;
  1408                                          ;call	delay1_4ms
  1409                                          ;call	delay1_4ms
  1410                                          ;call	delay1_4ms
  1411                                  	;call	delay1_4ms
  1412                                  
  1413                                    	;mov	dx, [NAMBAR]
  1414                                          ;add	dx, CODEC_CD_VOL_REG ;12h ; CD Input (Stereo)
  1415                                    	;out	dx, ax
  1416                                  	;
  1417                                    	;mov	dx, [NAMBAR]
  1418                                          ;add	dx, CODEC_AUX_VOL_REG ;16h ; Aux Input (Stereo)
  1419                                    	;out	dx, ax
  1420                                  	;
  1421                                          ;call	delay1_4ms
  1422                                          ;call	delay1_4ms
  1423                                          ;call	delay1_4ms
  1424                                  	;call	delay1_4ms
  1425                                  
  1426                                  ;detect_ac97_codec:
  1427 00000325 C3                              retn
  1428                                  
  1429                                  reset_ac97_controller:
  1430                                  	; 11/11/2023
  1431                                  	; 10/06/2017
  1432                                  	; 29/05/2017
  1433                                  	; 28/05/2017
  1434                                  	; reset AC97 audio controller registers
  1435 00000326 31C0                    	xor     ax, ax
  1436 00000328 BA0B00                          mov	dx, PI_CR_REG
  1437 0000032B 0316[760F]              	add	dx, [NABMBAR]
  1438 0000032F EE                      	out     dx, al
  1439                                  
  1440 00000330 BA1B00                          mov     dx, PO_CR_REG
  1441 00000333 0316[760F]              	add	dx, [NABMBAR]
  1442 00000337 EE                      	out     dx, al
  1443                                  
  1444 00000338 BA2B00                          mov     dx, MC_CR_REG
  1445 0000033B 0316[760F]              	add	dx, [NABMBAR]
  1446 0000033F EE                      	out     dx, al
  1447                                  
  1448 00000340 B002                            mov     al, RR
  1449 00000342 BA0B00                          mov     dx, PI_CR_REG
  1450 00000345 0316[760F]              	add	dx, [NABMBAR]
  1451 00000349 EE                      	out     dx, al
  1452                                  
  1453 0000034A BA1B00                          mov     dx, PO_CR_REG
  1454 0000034D 0316[760F]              	add	dx, [NABMBAR]
  1455 00000351 EE                      	out     dx, al
  1456                                  
  1457 00000352 BA2B00                          mov     dx, MC_CR_REG
  1458 00000355 0316[760F]              	add	dx, [NABMBAR]
  1459 00000359 EE                      	out     dx, al
  1460                                  
  1461 0000035A C3                      	retn
  1462                                  
  1463                                  reset_ac97_codec:
  1464                                  	; 11/11/2023
  1465                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1466 0000035B BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1467 0000035E 0316[760F]              	add	dx, [NABMBAR]
  1468 00000362 66ED                    	in	eax, dx
  1469                                  
  1470                                  	;test	eax, 2
  1471                                  	; 06/08/2022
  1472 00000364 A802                    	test	al, 2
  1473 00000366 7405                    	jz	short _r_ac97codec_cold	
  1474                                  
  1475 00000368 E80E00                  	call	warm_ac97codec_reset
  1476 0000036B 7306                    	jnc	short _r_ac97codec_ok
  1477                                  _r_ac97codec_cold:
  1478 0000036D E83400                          call    cold_ac97codec_reset
  1479 00000370 7301                            jnc     short _r_ac97codec_ok
  1480                                  	
  1481                                  	; 16/04/2017
  1482                                          ;xor	eax, eax	; timeout error
  1483                                         	;stc
  1484 00000372 C3                      	retn
  1485                                  
  1486                                  _r_ac97codec_ok:
  1487 00000373 6631C0                          xor     eax, eax
  1488                                          ;mov	al, VIA_ACLINK_C00_READY ; 1
  1489 00000376 FEC0                            inc	al
  1490 00000378 C3                      	retn
  1491                                  
  1492                                  warm_ac97codec_reset:
  1493                                  	; 11/11/2023
  1494                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  1495                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1496 00000379 66B806000000            	mov	eax, 6
  1497 0000037F BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1498 00000382 0316[760F]              	add	dx, [NABMBAR]
  1499 00000386 66EF                    	out	dx, eax
  1500                                  
  1501 00000388 B90A00                  	mov	cx, 10	; total 1s
  1502                                  _warm_ac97c_rst_wait:
  1503 0000038B E84D00                  	call	delay_100ms
  1504                                  
  1505 0000038E BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1506 00000391 0316[760F]              	add	dx, [NABMBAR]
  1507 00000395 66ED                    	in	eax, dx
  1508                                  
  1509 00000397 66A900030010            	test	eax, CTRL_ST_CREADY
  1510 0000039D 7504                    	jnz	short _warm_ac97c_rst_ok
  1511                                  
  1512 0000039F 49                              dec     cx
  1513 000003A0 75E9                            jnz     short _warm_ac97c_rst_wait
  1514                                  
  1515                                  _warm_ac97c_rst_fail:
  1516 000003A2 F9                              stc
  1517                                  _warm_ac97c_rst_ok:
  1518 000003A3 C3                      	retn
  1519                                  
  1520                                  cold_ac97codec_reset:
  1521                                  	; 11/11/2023
  1522                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  1523                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1524 000003A4 66B802000000                    mov	eax, 2
  1525 000003AA BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1526 000003AD 0316[760F]              	add	dx, [NABMBAR]
  1527 000003B1 66EF                    	out	dx, eax
  1528                                  
  1529 000003B3 E82500                  	call	delay_100ms 	; wait 100 ms
  1530 000003B6 E82200                  	call	delay_100ms 	; wait 100 ms
  1531 000003B9 E81F00                  	call	delay_100ms 	; wait 100 ms
  1532 000003BC E81C00                  	call	delay_100ms 	; wait 100 ms
  1533                                  
  1534 000003BF B91000                  	mov	cx, 16	; total 20*100 ms = 2s
  1535                                  
  1536                                  _cold_ac97c_rst_wait:
  1537 000003C2 BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1538 000003C5 0316[760F]              	add	dx, [NABMBAR]
  1539 000003C9 66ED                    	in	eax, dx
  1540                                  
  1541 000003CB 66A900030010            	test	eax, CTRL_ST_CREADY
  1542 000003D1 7507                    	jnz	short _cold_ac97c_rst_ok
  1543                                  
  1544 000003D3 E80500                  	call	delay_100ms
  1545                                  
  1546 000003D6 49                              dec     cx
  1547 000003D7 75E9                            jnz     short _cold_ac97c_rst_wait
  1548                                  
  1549                                  _cold_ac97c_rst_fail:
  1550 000003D9 F9                              stc
  1551                                  _cold_ac97c_rst_ok:
  1552 000003DA C3                      	retn
  1553                                  
  1554                                  delay_100ms:
  1555                                  	; 11/11/2023
  1556                                  	; 29/05/2017
  1557                                  	; 24/03/2017 ('codec.asm')
  1558                                  	; wait 100 ms
  1559 000003DB 51                      	push	cx
  1560 000003DC B99001                  	mov	cx, 400  ; 400*0.25ms
  1561                                  _delay_x_ms:
  1562 000003DF E86C07                  	call	delay1_4ms
  1563 000003E2 E2FB                            loop	_delay_x_ms
  1564 000003E4 59                      	pop	cx
  1565 000003E5 C3                      	retn
  1566                                  
  1567                                  %endif
  1568                                  
  1569                                  ;=============================================================================
  1570                                  ;               ICH_WAV.ASM
  1571                                  ;=============================================================================
  1572                                  
  1573                                  ; DOS based .WAV player using AC'97 and codec interface.
  1574                                  ; ---------------------------------------------------------------
  1575                                  ; NASM version: Erdogan Tan (29/11/2016)
  1576                                  ; Last Update: 17/02/2017 (by Erdogan Tan)
  1577                                  
  1578                                  ; ICHWAV.ASM
  1579                                  ; PLAYMOD.ASM
  1580                                  ; player internal variables and other equates.
  1581                                  BUFFERSIZE	equ	2048*4		; 8K half buffer size. 18/02/2017
  1582                                  ENDOFFILE	equ	BIT0		; flag for knowing end of file
  1583                                  
  1584                                  ;===========================================================================
  1585                                  ; entry: none.  File is already open and [filehandle] filled.
  1586                                  ; exit:  not until the song is finished or the user aborts.
  1587                                  ;
  1588                                  ; 18/02/2017
  1589                                  ModPlay: ; 13/02/2017  ; ModPlay Polling!
  1590                                  	;cld
  1591                                  	; clear (half) buffer 2
  1592                                         	;mov	di, [DMA_BUFFER2]
  1593                                  	;sub	ax, ax
  1594                                  	;mov	cx, (BUFFERSIZE/2)
  1595                                  	;rep	stosw
  1596                                  	
  1597                                         ; load 2048 bytes into buffer 1
  1598 000003E6 8B36[840F]              	mov	si, [DMA_BUFFER1]
  1599                                  	; 11/05/2024
  1600                                  	;mov	cx, BUFFERSIZE
  1601                                  	;push	ds ; segment
  1602                                  	;push	si ; offset
  1603                                  	;push	cx ; count
  1604 000003EA E85E06                  	call    GetSamples_ICH ; 18/02/2017
  1605                                  
  1606                                         ; load 2048 bytes into buffer  2
  1607 000003ED 8B36[860F]              	mov	si, [DMA_BUFFER2]
  1608                                  	; 11/05/2024
  1609                                  	;mov	cx, BUFFERSIZE
  1610                                  	;push	ds ; segment
  1611                                  	;push	si ; offset
  1612                                  	;push	cx ; count
  1613 000003F1 E85706                  	call	GetSamples_ICH ; 18/02/2017
  1614                                  
  1615                                  ; register reset the DMA engine. This may cause a pop noise on the output
  1616                                  ; lines when the device is reset. Prolly a better idea to mute output, then
  1617                                  ; reset.
  1618                                  
  1619                                  	; 08/05/2024
  1620                                          ;mov    dx, [NABMBAR]
  1621                                          ;add    dx, PO_CR_REG		; set pointer to Ctrl reg
  1622                                          ;mov    al, RR			; set reset
  1623                                  	;out    dx, al			; self clearing bit
  1624                                  
  1625                                  ; write last valid index to 31 to start with.
  1626                                  ; The Last Valid Index register tells the DMA engine when to stop playing.
  1627                                  ; 
  1628                                  ; As we progress through the song we change the last valid index to always be
  1629                                  ; something other than the index we're currently playing.  
  1630                                  ;
  1631                                          ;;mov   al, 1
  1632                                          ;mov	al, 31
  1633                                  	;call   setLastValidIndex
  1634                                  
  1635                                  ; create Buffer Descriptor List
  1636                                  ;
  1637                                  ; A buffer descriptor list is a list of pointers and control bits that the
  1638                                  ; DMA engine uses to know where to get the .wav data and how to play it.
  1639                                  ;
  1640                                  ; I set it up to use only 2 buffers of .wav data, and whenever 1 buffer is
  1641                                  ; playing, I refresh the other one with good data.
  1642                                  ;
  1643                                  ;
  1644                                  ; For the control bits, you can specify that the DMA engine fire an interrupt
  1645                                  ; after a buffer has been processed, but I poll the current index register
  1646                                  ; to know when it's safe to update the other buffer.
  1647                                  ;
  1648                                  ; I set the BUP bit, which tells the DMA engine to just play 0's (silence)
  1649                                  ; if it ever runs out of data to play. Good for safety.
  1650                                  ;
  1651                                  	; 14/02/2017
  1652 000003F4 8B3E[820F]                      mov     di, [BDL_BUFFER]		; get BDL address
  1653 000003F8 B91000                          mov     cx, 32 / 2                      ; make 32 entries in BDL
  1654 000003FB 6631D2                  	xor	edx, edx
  1655 000003FE 8CDA                    	mov	dx, ds
  1656 00000400 66C1E204                	shl	edx, 4 ; segment*16 (linear/physical address of the segment)
  1657                                  _0:
  1658                                  
  1659                                  ; set buffer descriptor 0 to start of data file in memory
  1660                                  	; 14/02/2017
  1661 00000404 660FB706[840F]                  movzx   eax, word [DMA_BUFFER1]
  1662 0000040A 6601D0                  	add	eax, edx ; linear/physical address of the buffer (seg*16+off)
  1663 0000040D 66AB                            stosd					; store dmabuffer1 address
  1664                                  
  1665                                  ;
  1666                                  ; set length to 32k samples. 1 sample is 16bits or 2bytes.
  1667                                  ; Set control (bits 31:16) to BUP, bits 15:0=number of samples.
  1668                                  ; 
  1669                                  
  1670                                  ; 17/02/2017 (Erdogan Tan)
  1671                                  ; Intel 82801AA (ICH) & Intel 82801AB (ICH0) I/O Controller Hub AC 97
  1672                                  ; Programmers Reference Manual
  1673                                  
  1674                                  ; 2.2.1 Buffer Descriptor List  (on Page 13)
  1675                                  	;
  1676                                  	;  Generic Form of Buffer Descriptor
  1677                                  	;  ---------------------------------
  1678                                  	;  63   62    61-48    47-32   31-0
  1679                                  	;  ---  ---  --------  ------- -----
  1680                                  	;  IOC  BUP -reserved- Buffer  Buffer
  1681                                  	;		      Length   Pointer
  1682                                  	;		      [15:0]   [31:0]
  1683                                  	;
  1684                                  	;  IOC:	Interrupt On Completion. 
  1685                                  	;	1 = Enabled. 
  1686                                  	;	    When this is set, it means that the controller should
  1687                                  	;	    issue an interrupt upon completion of this buffer.
  1688                                  	;	    It should also set the IOC bit in the status register
  1689                                  	;	0 = Disabled	
  1690                                  	;
  1691                                  	;  BUP: Buffer Underrun Policy.
  1692                                  	;       0 = When this buffer is complete,
  1693                                  	;	    if the next buffer is not yet ready 
  1694                                  	;	    (i.e., the last valid buffer has been processed),
  1695                                  	;	    then continue to transmit the last valid sample.
  1696                                  	;	1 = When this buffer is complete,
  1697                                  	;     	    if this is the last valid buffer, transmit zeros after
  1698                                  	;	    this buffer has been processed completely.
  1699                                  	;	    This bit typically is set only if this is the last 
  1700                                  	;	    buffer in the current stream.
  1701                                  	;
  1702                                  	; [31:0]: Buffer pointer. This field points to the location of
  1703                                  	;	  the data buffer. Since samples can be as wide as one
  1704                                  	;	  word, the buffer must be aligned with word boundaries,
  1705                                  	;	  to prevent samples from straddling DWord boundaries.
  1706                                  	;
  1707                                  	; [15:0]: Buffer Length: This is the length of the data buffer,
  1708                                  	;	  in number of samples. The controller uses this data
  1709                                  	;	  to determine the length of the buffer, in bytes.
  1710                                  	;	  "0" indicates no sample to process.
  1711                                  
  1712                                  ; ICH2AC97.INC
  1713                                  
  1714                                  ;	IOC	equ     BIT31   ; Fire an interrupt whenever this
  1715                                  				; buffer is complete.
  1716                                  
  1717                                  ;	BUP	equ     BIT30   ; Buffer Underrun Policy.
  1718                                  				; if this buffer is the last buffer
  1719                                  				; in a playback, fill the remaining
  1720                                  				; samples with 0 (silence) or not.
  1721                                  				; It's a good idea to set this to 1
  1722                                  				; for the last buffer in playback,
  1723                                  				; otherwise you're likely to get a lot
  1724                                  				; of noise at the end of the sound.
  1725                                  ;
  1726                                  ; Bits 15:0 contain the length of the buffer, in number of samples, which
  1727                                  ; are 16 bits each, coupled in left and right pairs, or 32bits each.
  1728                                  ; Luckily for us, that's the same format as .wav files.
  1729                                  ;
  1730                                  ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
  1731                                  ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
  1732                                  ;
  1733                                  ; A value of 0 in these bits means play no samples.
  1734                                  ;
  1735                                  	; 08/12/2016 - Erdogan Tan
  1736                                  	;mov	eax, BUFFERSIZE
  1737                                  	;or	eax, IOC + BUP
  1738                                  	; 12/05/2024
  1739 0000040F 66B800100000            	mov	eax, BUFFERSIZE/2
  1740 00000415 660D00000040            	or	eax, BUP ; (tuneloop without interrupt)
  1741 0000041B 66AB                    	stosd
  1742                                  
  1743                                  ; 2nd buffer:
  1744                                  	; 14/02/2017
  1745 0000041D 660FB706[860F]                  movzx   eax, word [DMA_BUFFER2]
  1746 00000423 6601D0                  	add	eax, edx ; linear/physical address of the buffer (seg*16+off)
  1747 00000426 66AB                            stosd					; store dmabuffer2 address
  1748                                  
  1749                                  ; set length to 64k (32k of two 16 bit samples)
  1750                                  ; Set control (bits 31:16) to BUP, bits 15:0=number of samples
  1751                                  ; 
  1752                                  	; 08/12/2016 - Erdogan Tan
  1753                                  	;mov	eax, BUFFERSIZE
  1754                                  	;or	eax, IOC + BUP
  1755                                  	; 12/05/2024
  1756 00000428 66B800100000            	mov	eax, BUFFERSIZE/2
  1757                                  	; 12/05/2024
  1758 0000042E 660D00000040            	or	eax, BUP ; (tuneloop without interrupt)
  1759 00000434 66AB                    	stosd
  1760 00000436 E2CC                            loop    _0
  1761                                  
  1762                                  ;
  1763                                  ; tell the DMA engine where to find our list of Buffer Descriptors.
  1764                                  ; this 32bit value is a flat mode memory offset (ie no segment:offset)
  1765                                  ;
  1766                                  ; write NABMBAR+10h with offset of buffer descriptor list
  1767                                  ;
  1768 00000438 660FB706[820F]                  movzx   eax, word [BDL_BUFFER]
  1769                                  	; 14/02/2017
  1770 0000043E 6601D0                  	add	eax, edx ; linear/physical address of the BDL
  1771                                    	; 18/02/2017
  1772 00000441 8B16[760F]                      mov     dx, [NABMBAR]
  1773 00000445 83C210                          add     dx, PO_BDBAR_REG                ; set pointer to BDL
  1774 00000448 66EF                            out     dx, eax                         ; write to AC97 controller
  1775                                  
  1776                                  ;
  1777                                  ; All set.  Let's play some music.
  1778                                  ;
  1779                                  	; 08/12/2016
  1780                                  	; 07/10/2016
  1781                                          ;mov    al, 1
  1782 0000044A B01F                            mov	al, 31
  1783                                  	; 08/05/2024
  1784 0000044C A2[920F]                	mov	[LVI], al ; 10/11/2023
  1785                                  	
  1786 0000044F E88B00                  	call    setLastValidIndex
  1787                                  
  1788 00000452 C606[7B0F]01            	mov	byte [tLoop], 1 ; 30/11/2016
  1789                                  
  1790                                  ; 12/05/2024 (tuneloop, without interrupt)
  1791                                  %if 0
  1792                                  	; 12/05/2024	
  1793                                  	; 17/02/2017
  1794                                          ;mov    dx, [NABMBAR]
  1795                                          ;add    dx, PO_CR_REG                   ; PCM out Control Register
  1796                                          ;mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
  1797                                  	;			; (LVBI interrupt will not be enabled)
  1798                                          ;out    dx, al                          ; Start bus master operation.
  1799                                  
  1800                                  ; while DMA engine is running, examine current index and wait until it hits 1
  1801                                  ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
  1802                                  ; 64k.  Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
  1803                                     
  1804                                  	; 18/02/2017
  1805                                  	; 14/02/2017
  1806                                  	; 13/02/2017
  1807                                  	; 08/12/2016
  1808                                  	; 28/11/2016
  1809                                  
  1810                                  	push	es
  1811                                  	mov	ax, 0A000h
  1812                                  	mov	es, ax
  1813                                  	;mov	bp, DmaBuffer ; 14/02/2017
  1814                                  p_loop:
  1815                                  	mov     ah, 1			; any key pressed?
  1816                                  	int     16h			; no, Loop.
  1817                                  	jz	short q_loop
  1818                                  
  1819                                  	mov     ah, 0			; flush key buffer...
  1820                                  	int     16h
  1821                                  p_return:
  1822                                  	mov	byte [tLoop], 0	; 13/02/2017
  1823                                  	pop	es
  1824                                  	retn
  1825                                  q_loop:
  1826                                  	; 10/05/2024
  1827                                  	xor	ax, ax
  1828                                  	xchg	al, [tBuff] ; AL = [tBuff], [tBuff] = 0
  1829                                  	cmp	al, 1
  1830                                  	ja	short r_loop
  1831                                  	jb	short ScopeLoop
  1832                                  	;
  1833                                       	mov	si, [DMA_BUFFER1] ; [tBuff]=1 (from tuneLoop)
  1834                                         	jmp	short s_loop 
  1835                                  r_loop:
  1836                                  	; 13/02/2017
  1837                                          mov     si, [DMA_BUFFER2] ; [tBuff]=2 (from tuneLoop)
  1838                                  s_loop:
  1839                                  	; 14/02/2017
  1840                                  	;mov	bp, si ; save current buffer addres in bp register
  1841                                  	; 11/05/2024
  1842                                  	;mov	cx, BUFFERSIZE ; 2048*4 byte
  1843                                  	;push	ds ; segment
  1844                                  	;push	si ; offset
  1845                                  	;push	cx ; count
  1846                                  	call    GetSamples_ICH ; 18/02/2017
  1847                                  	;
  1848                                  ScopeLoop:
  1849                                  	;mov    si, bp			; get current samples
  1850                                  	mov	si, MOD_BUFFER ; 18/02/2017
  1851                                  	xor     cx, cx			; to be drawed ...
  1852                                  	xor     dx, dx
  1853                                  DrawLoop:       
  1854                                  	mov     bx, dx			; (save Index)
  1855                                  	mov     di, [Scope+bx]		; get old SCOPE pixel address
  1856                                  	mov     byte [es:di], 0		; erase it!
  1857                                  	lodsb				; get a sample (8-bit)
  1858                                  	mov     bl, al			; calc new pixel address...
  1859                                  	xor     bh, bh
  1860                                  	shl     bx, 1
  1861                                  	mov     di, [RowOfs+bx]
  1862                                  	add     di, cx
  1863                                  	mov     bx, dx			; (restore Index)
  1864                                  	mov     [Scope+bx], di		; save new address...
  1865                                  	mov     byte [es:di], 10 ; 0Ah	; and DRAW.
  1866                                  	add     dx, 2			; the next pixel...
  1867                                  	inc     cx
  1868                                  	cmp     cx, 320			; 320 pixels drawed?
  1869                                  	jb      short DrawLoop
  1870                                  	jmp	short p_loop
  1871                                  
  1872                                  tuneLoop:
  1873                                  	; 11/05/2024
  1874                                  	; 11/11/2023
  1875                                  	; 10/11/2023
  1876                                  	; 18/02/2017
  1877                                  	; 08/12/2016
  1878                                  	; 28/11/2016 - Erdogan Tan
  1879                                  
  1880                                  	; 11/05/2024
  1881                                  	cmp	byte [tLoop], 1
  1882                                  	jb	short tL3
  1883                                  	
  1884                                  	call    getCurrentIndex
  1885                                  
  1886                                  	; 10/11/2023
  1887                                  	cmp	al, [LVI]
  1888                                  	jne	short tL1
  1889                                  
  1890                                  	dec	ax
  1891                                  	and	al, 1Fh 
  1892                                  	call	setLastValidIndex
  1893                                  	xchg	al, [LVI]
  1894                                  tL1:
  1895                                  	test	al, BIT0
  1896                                  	jz	short tL2
  1897                                  
  1898                                  	; 11/05/2024
  1899                                  	mov	byte [tBuff], 1
  1900                                  	retn
  1901                                  tL2:	
  1902                                  	mov	byte [tBuff], 2
  1903                                  tL3:
  1904                                  	retn
  1905                                  
  1906                                  ; returns AL = current index value
  1907                                  getCurrentIndex:
  1908                                  	;push	dx
  1909                                  	mov	dx, [NABMBAR]
  1910                                  	add	dx, PO_CIV_REG
  1911                                  	in	al, dx
  1912                                  	;pop	dx
  1913                                  	retn
  1914                                  
  1915                                  ;input AL = index # to stop on
  1916                                  setLastValidIndex:
  1917                                  	;push	dx
  1918                                  	mov	dx, [NABMBAR]
  1919                                  	add	dx, PO_LVI_REG
  1920                                          out     dx, al
  1921                                  	;pop	dx
  1922                                  	retn
  1923                                  
  1924                                  %else
  1925                                  	; 12/05/2024
  1926                                  	; 17/02/2017
  1927 00000457 8B16[760F]                      mov     dx, [NABMBAR]
  1928 0000045B 83C21B                          add     dx, PO_CR_REG		; PCM out Control Register
  1929                                          ;mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
  1930                                  	;			; (LVBI interrupt will not be enabled)
  1931                                  	; 06/11/2023 (TUNELOOP version, without interrupt)
  1932 0000045E B001                    	mov	al, RPBM
  1933 00000460 EE                      	out     dx, al			; Start bus master operation.
  1934                                  
  1935 00000461 06                      	push	es
  1936 00000462 B800A0                  	mov	ax, 0A000h
  1937 00000465 8EC0                    	mov	es, ax
  1938                                  
  1939                                  	; 12/05/2024
  1940                                  ;p_loop:
  1941                                  ;	call	tuneLoop
  1942                                  ;	cmp	byte [tLoop], 0
  1943                                  ;	ja	short p_loop
  1944                                  ;	pop	es
  1945                                  ;	retn
  1946                                  
  1947                                  p_loop:
  1948 00000467 B401                    	mov     ah, 1			; any key pressed?
  1949 00000469 CD16                    	int     16h			; no, Loop.
  1950 0000046B 7406                    	jz	short q_loop
  1951                                  
  1952 0000046D B400                    	mov     ah, 0			; flush key buffer...
  1953 0000046F CD16                    	int     16h
  1954                                  p_return:
  1955 00000471 07                      	pop	es
  1956 00000472 C3                      	retn
  1957                                  q_loop:
  1958                                  tuneLoop:
  1959                                  	; 12/05/2024
  1960                                  	; 18/11/2023 (ich_wav4.asm, Erdogan Tan)
  1961                                  tL1:
  1962 00000473 E85400                  	call    updateLVI	; /set LVI != CIV/
  1963                                  	;call   check4keyboardstop
  1964                                  	;jc	short _exit_
  1965                                  	;call   getCurrentIndex
  1966 00000476 A801                    	test	al, BIT0
  1967 00000478 74F9                    	jz	short tL1	; loop if buffer 2 is not playing
  1968                                  
  1969 0000047A 8B36[840F]              	mov     si, [DMA_BUFFER1]
  1970 0000047E E8CA05                  	call    GetSamples_ICH
  1971                                  
  1972 00000481 E81300                  	call	ScopeLoop
  1973                                  tL2:
  1974 00000484 E84300                  	call    updateLVI
  1975                                  	;call   check4keyboardstop
  1976                                  	;jc	short _exit_
  1977                                  	;call   getCurrentIndex
  1978 00000487 A801                    	test	al, BIT0
  1979 00000489 75F9                    	jnz	short tL2	; loop if buffer 1 is not playing
  1980                                  
  1981 0000048B 8B36[860F]              	mov     si, [DMA_BUFFER2]
  1982 0000048F E8B905                  	call    GetSamples_ICH
  1983                                  
  1984 00000492 E80200                  	call	ScopeLoop
  1985 00000495 EBD0                    	jmp	short p_loop
  1986                                  
  1987                                  ScopeLoop:
  1988                                  	;mov    si, bp			; get current samples
  1989 00000497 BE[A2B3]                	mov	si, MOD_BUFFER ; 18/02/2017
  1990 0000049A 31C9                    	xor     cx, cx			; to be drawed ...
  1991 0000049C 31D2                    	xor     dx, dx
  1992                                  DrawLoop:       
  1993 0000049E 89D3                    	mov     bx, dx			; (save Index)
  1994 000004A0 8BBF[20AF]              	mov     di, [Scope+bx]		; get old SCOPE pixel address
  1995 000004A4 26C60500                	mov     byte [es:di], 0		; erase it!
  1996 000004A8 AC                      	lodsb				; get a sample (8-bit)
  1997 000004A9 88C3                    	mov     bl, al			; calc new pixel address...
  1998 000004AB 30FF                    	xor     bh, bh
  1999 000004AD D1E3                    	shl     bx, 1
  2000 000004AF 8BBF[A0B1]              	mov     di, [RowOfs+bx]
  2001 000004B3 01CF                    	add     di, cx
  2002 000004B5 89D3                    	mov     bx, dx			; (restore Index)
  2003 000004B7 89BF[20AF]              	mov     [Scope+bx], di		; save new address...
  2004 000004BB 26C6050A                	mov     byte [es:di], 10 ; 0Ah	; and DRAW.
  2005 000004BF 83C202                  	add     dx, 2			; the next pixel...
  2006 000004C2 41                      	inc     cx
  2007 000004C3 81F94001                	cmp     cx, 320			; 320 pixels drawed?
  2008 000004C7 72D5                    	jb      short DrawLoop
  2009 000004C9 C3                      	retn
  2010                                  	
  2011                                  ;_exit_:
  2012                                  	;mov	byte [tLoop], 0
  2013                                  	;retn
  2014                                  
  2015                                  	; 12/05/2024
  2016                                  updateLVI:
  2017                                  	; 06/11/2023
  2018 000004CA 8B16[760F]              	mov	dx, [NABMBAR]      		
  2019 000004CE 83C214                  	add	dx, PO_CIV_REG
  2020                                  	; (Current Index Value and Last Valid Index value)
  2021 000004D1 ED                      	in	ax, dx
  2022                                  
  2023 000004D2 38E0                    	cmp	al, ah ; is current index = last index ?
  2024 000004D4 750F                    	jne	short uLVI_exit ; 12/05/2024
  2025                                  
  2026                                  	; 08/11/2023	
  2027 000004D6 E80D00                  	call	getCurrentIndex
  2028                                  
  2029 000004D9 FEC8                    	dec	al
  2030 000004DB 241F                    	and	al, 1Fh
  2031                                  
  2032                                  ;input AL = index # to stop on
  2033                                  setLastValidIndex:
  2034                                  	; 08/11/2023
  2035                                  	;push	dx
  2036 000004DD 8B16[760F]              	mov	dx, [NABMBAR]
  2037 000004E1 83C215                  	add	dx, PO_LVI_REG
  2038 000004E4 EE                              out     dx, al
  2039                                  	;pop	dx
  2040                                  uLVI_exit:	; 12/05/2024
  2041 000004E5 C3                      	retn
  2042                                  
  2043                                  ; returns AL = current index value
  2044                                  getCurrentIndex:
  2045                                  	;push	dx
  2046 000004E6 8B16[760F]              	mov	dx, [NABMBAR]
  2047 000004EA 83C214                  	add	dx, PO_CIV_REG
  2048 000004ED EC                      	in	al, dx
  2049                                  	;pop	dx
  2050 000004EE C3                      	retn
  2051                                  
  2052                                  	; 12/05/2024
  2053                                  check4keyboardstop:
  2054                                  	; 08/11/2023
  2055                                  	; 04/11/2023
  2056 000004EF B401                    	mov	ah, 1
  2057 000004F1 CD16                    	int	16h
  2058 000004F3 7405                    	jz	short _cksr
  2059 000004F5 30E4                    	xor	ah, ah
  2060 000004F7 CD16                    	int	16h
  2061 000004F9 F9                      	stc
  2062                                  _cksr:
  2063 000004FA C3                      	retn
  2064                                  
  2065                                  %endif
  2066                                  
  2067                                  ;=============================================================================
  2068                                  ;               MODLOAD.ASM
  2069                                  ;=============================================================================
  2070                                  
  2071                                  ; Amiga Module Loader v0.1b by Carlos Hasan.
  2072                                  ;		July 10th, 1993.
  2073                                  
  2074                                  ; STRUCTURES
  2075                                  
  2076                                  struc ModSample
  2077 00000000 <res 16h>               .msName:	resb 22
  2078 00000016 ????                    .msLength:	resw 1
  2079 00000018 ??                      .msFinetune:	resb 1
  2080 00000019 ??                      .msVolume:	resb 1
  2081 0000001A ????                    .msRepeat:	resw 1
  2082 0000001C ????                    .msRepLen:	resw 1
  2083                                  .size:
  2084                                  endstruc
  2085                                  
  2086                                  struc ModHeader
  2087 00000000 <res 14h>               .mhName:	resb 20
  2088 00000014 <res 3A2h>              .mhSamples:	resb ModSample.size*31
  2089 000003B6 ??                      .mhOrderLen:	resb 1
  2090 000003B7 ??                      .mhReStart:	resb 1
  2091 000003B8 <res 80h>               .mhOrder:	resb 128
  2092 00000438 ????????                .mhSign:	resw 2
  2093                                  .size:	
  2094                                  endstruc
  2095                                  
  2096                                  struc ModInfoRec
  2097 00000000 ??                      .OrderLen:	resb 1
  2098 00000001 ??                      .ReStart:	resb 1
  2099 00000002 <res 80h>               .Order:		resb 128
  2100 00000082 ????????                .Patterns:	resd 1
  2101 00000086 <res 3Eh>               .SampOfs:	resw 31
  2102 000000C4 <res 3Eh>               .SampSeg:	resw 31
  2103 00000102 <res 3Eh>               .SampLen:	resw 31
  2104 00000140 <res 3Eh>               .SampRep:	resw 31
  2105 0000017E <res 3Eh>               .SampRepLen:	resw 31
  2106 000001BC <res 3Eh>               .SampVol:	resw 31
  2107                                  .size:	
  2108                                  endstruc
  2109                                  
  2110                                  ; CODE
  2111                                  
  2112                                  LoadModule:
  2113                                  		;es:di = filename
  2114                                  
  2115                                  		;[sp+4] = es
  2116                                  		;[sp+2] = di
  2117                                  
  2118                                  		FileName equ 4		
  2119                                  
  2120 000004FB 55                      		push    bp
  2121 000004FC 89E5                    		mov     bp, sp
  2122 000004FE 60                      		pusha
  2123 000004FF 1E                      		push    ds
  2124 00000500 06                      		push    es
  2125                                  
  2126 00000501 C706[9650]0100          		mov	word [ErrorInfo], 1
  2127                                  
  2128 00000507 E85101                  		call    ClearModInfo
  2129                                  OpenFile:       
  2130 0000050A 1E                      		push    ds
  2131 0000050B B8003D                  		mov     ax, 3D00h
  2132 0000050E C55604                  		lds     dx, [bp+FileName]
  2133 00000511 CD21                    		int     21h
  2134 00000513 1F                      		pop     ds
  2135 00000514 0F823C01                		jc      Failed
  2136 00000518 A3[9450]                		mov     [FileHandle], ax
  2137                                  
  2138                                  ReadHeader:     
  2139 0000051B B8003F                  		mov     ax, 3F00h
  2140 0000051E 8B1E[9450]              		mov     bx, [FileHandle]
  2141 00000522 B93C04                  		mov     cx, ModHeader.size
  2142                                  		;lea    dx, [Header]
  2143 00000525 BA[9850]                		mov	dx, Header
  2144 00000528 CD21                    		int     21h
  2145 0000052A 0F821D01                		jc      CloseFile
  2146                                  CheckMK:        
  2147 0000052E 813E[D054]4D2E          		cmp     word [Header+ModHeader.mhSign], 'M.'
  2148 00000534 7508                    		jne     short CheckFLT4
  2149 00000536 813E[D254]4B2E          		cmp     word [Header+ModHeader.mhSign+2], 'K.'
  2150 0000053C 7439                    		je      short IsModFile
  2151                                  CheckFLT4:
  2152 0000053E 813E[D054]464C          		cmp     word [Header+ModHeader.mhSign], 'FL'
  2153 00000544 7508                    		jne     short Is15Inst
  2154 00000546 813E[D254]5434          		cmp     word [Header+ModHeader.mhSign+2], 'T4'
  2155 0000054C 7429                    		je      short IsModFile
  2156                                  Is15Inst:
  2157 0000054E BE[6E52]                		mov     si, (Header+ModHeader.mhSamples) + (15*ModSample.size)
  2158 00000551 BF[4E54]                		mov     di, Header+ModHeader.mhOrderLen
  2159 00000554 8CD8                    		mov     ax, ds
  2160 00000556 8EC0                    		mov     es, ax
  2161 00000558 FC                      		cld
  2162 00000559 B98200                  		mov     cx, 130
  2163 0000055C F3A4                    		rep     movsb
  2164 0000055E BF[6E52]                		mov     di, Header+ModHeader.mhSamples + (15*ModSample.size)
  2165 00000561 31C0                    		xor     ax, ax
  2166 00000563 B9E001                  		mov     cx, 16*ModSample.size
  2167 00000566 F3AA                    		rep     stosb
  2168                                  SeekPatterns:   
  2169 00000568 B80042                  		mov     ax, 4200h
  2170 0000056B 8B1E[9450]              		mov     bx, [FileHandle]
  2171 0000056F B90000                  		mov     cx, 0
  2172 00000572 BA5802                  		mov     dx, 600
  2173 00000575 CD21                    		int     21h
  2174                                  IsModFile:  
  2175 00000577 A0[4E54]                		mov     al, [Header+ModHeader.mhOrderLen]
  2176 0000057A A2[D654]                		mov     [ModInfo.OrderLen], al
  2177                                  
  2178 0000057D A0[4F54]                		mov     al, [Header+ModHeader.mhReStart]
  2179 00000580 3A06[4E54]              		cmp     al, [Header+ModHeader.mhOrderLen]
  2180 00000584 7202                    		jb      short SetReStart
  2181 00000586 B07F                    		mov     al, 7Fh
  2182                                  SetReStart:
  2183 00000588 A2[D754]                		mov     [ModInfo.ReStart], al
  2184                                  
  2185 0000058B B98000                  		mov     cx, 128
  2186 0000058E 31C0                    		xor     ax, ax
  2187 00000590 31DB                    		xor     bx, bx
  2188                                  CopyOrder:
  2189 00000592 8AA7[5054]              		mov     ah, [Header+ModHeader.mhOrder+bx]
  2190 00000596 88A7[D854]              		mov     [ModInfo.Order+bx], ah
  2191 0000059A 38C4                    		cmp     ah, al
  2192 0000059C 7202                    		jb      short NextOrder
  2193 0000059E 88E0                    		mov     al, ah
  2194                                  NextOrder:
  2195 000005A0 43                      		inc     bx
  2196 000005A1 E2EF                    		loop    CopyOrder
  2197                                  AllocPatterns:  
  2198                                  		; Erdogan Tan (13/02/2017)
  2199 000005A3 30E4                    		xor	ah, ah
  2200 000005A5 FEC0                    		inc	al
  2201                                  		; al = count of 1024 bytes
  2202 000005A7 89C3                    		mov	bx, ax
  2203                                  		; count of paragraphs = al*64 
  2204 000005A9 C1E006                  		shl	ax, 6 ; *64
  2205 000005AC 89C5                    		mov	bp, ax
  2206 000005AE 8CCA                    		mov	dx, cs ; current (code) segment
  2207 000005B0 81C20010                		add	dx, 1000h ; next 64K (4096*16)
  2208                                  		;
  2209 000005B4 C706[5855]0000          		mov	word [ModInfo.Patterns], 0
  2210 000005BA 8916[5A55]              		mov	[ModInfo.Patterns+2], dx
  2211                                  		;
  2212 000005BE 01D5                    		add	bp, dx ; next segment for samples
  2213                                  ReadPatterns:   
  2214 000005C0 1E                      		push    ds
  2215 000005C1 B8003F                  		mov     ax, 3F00h
  2216 000005C4 89D9                    		mov     cx, bx ; count of 1024 bytes
  2217 000005C6 C1E10A                  		shl     cx, 10 ; byte count (cx*1024)
  2218 000005C9 8B1E[9450]              		mov     bx, [FileHandle]
  2219                                  		;lds    dx, [ModInfo.Patterns]
  2220 000005CD 8EDA                    		mov	ds, dx
  2221 000005CF 31D2                    		xor	dx, dx
  2222 000005D1 CD21                    		int     21h
  2223 000005D3 1F                      		pop     ds
  2224 000005D4 7275                    		jc      CloseFile
  2225                                  
  2226                                  		;lea	si, [Header+ModHeader.mhSamples]
  2227 000005D6 BE[AC50]                		mov	si, Header+ModHeader.mhSamples
  2228 000005D9 31FF                    		xor     di, di
  2229                                  CopySamples:
  2230 000005DB 8B4416                  		mov     ax, [si+ModSample.msLength]
  2231 000005DE 86C4                    		xchg    al, ah
  2232 000005E0 D1E0                    		shl     ax, 1
  2233 000005E2 8985[D855]              		mov     [ModInfo.SampLen+di], ax
  2234 000005E6 8A4419                  		mov     al, [si+ModSample.msVolume]
  2235 000005E9 30E4                    		xor     ah, ah
  2236 000005EB 8985[9256]              		mov     [ModInfo.SampVol+di], ax
  2237 000005EF 8B441A                  		mov     ax, [si+ModSample.msRepeat]
  2238 000005F2 86C4                    		xchg    al, ah
  2239 000005F4 D1E0                    		shl     ax, 1
  2240 000005F6 8985[1656]              		mov     [ModInfo.SampRep+di], ax
  2241 000005FA 8B441C                  		mov     ax, [si+ModSample.msRepLen]
  2242 000005FD 86C4                    		xchg    al, ah
  2243 000005FF D1E0                    		shl     ax, 1
  2244 00000601 8985[5456]              		mov     [ModInfo.SampRepLen+di], ax
  2245 00000605 83C61E                  		add     si, ModSample.size
  2246 00000608 83C702                  		add     di, 2
  2247 0000060B 83FF3E                  		cmp     di, 2*31
  2248 0000060E 72CB                    		jb      short CopySamples
  2249                                  
  2250 00000610 31F6                    		xor     si, si
  2251                                  AllocSamples:
  2252                                  		; Erdogan Tan (13/02/2017)
  2253                                  		;mov	bx, [ModInfo.SampLen+si]
  2254 00000612 8B8C[D855]              		mov	cx, [ModInfo.SampLen+si]
  2255 00000616 89CB                    		mov	bx, cx
  2256 00000618 C1EB04                  		shr     bx, 4 ; byte count / 16
  2257 0000061B 7420                    		jz      short NextSample
  2258 0000061D 43                      		inc	bx ; number of paragraphs
  2259 0000061E C784[5C55]0000          		mov	word [ModInfo.SampOfs+si], 0
  2260 00000624 89AC[9A55]              		mov     [ModInfo.SampSeg+si], bp
  2261 00000628 89EA                    		mov	dx, bp
  2262 0000062A 01DD                    		add	bp, bx ; next segment for sample 
  2263                                  ReadSample:
  2264 0000062C 1E                      		push    ds
  2265 0000062D B8003F                  		mov     ax, 3F00h
  2266 00000630 8B1E[9450]              		mov     bx, [FileHandle]
  2267                                  		;mov    cx, [ModInfo.SampLen+si]
  2268                                  		;mov    dx, [ModInfo.SampOfs+si]
  2269                                  		;mov    ds, [ModInfo.SampSeg+si]
  2270 00000634 8EDA                    		mov	ds, dx
  2271 00000636 31D2                    		xor	dx, dx	
  2272 00000638 CD21                    		int     21h
  2273 0000063A 1F                      		pop     ds
  2274 0000063B 720E                    		jc      short CloseFile
  2275                                  NextSample:
  2276 0000063D 83C602                  		add     si, 2
  2277 00000640 83FE3E                  		cmp     si, 2*31
  2278 00000643 72CD                    		jb      short AllocSamples
  2279                                  
  2280 00000645 C706[9650]0000          		mov     word [ErrorInfo], 0
  2281                                  CloseFile:      
  2282 0000064B B8003E                  		mov     ax, 3E00h
  2283 0000064E 8B1E[9450]              		mov     bx, [FileHandle]
  2284 00000652 CD21                    		int     21h
  2285                                  Failed:         
  2286 00000654 07                      		pop     es
  2287 00000655 1F                      		pop     ds
  2288 00000656 61                      		popa
  2289 00000657 5D                      		pop     bp
  2290 00000658 C20400                  		ret	4
  2291                                  
  2292                                  FreeModule:
  2293                                  		; Erdogan Tan (13/02/2017)
  2294                                  		; nothing to do here for memory de-allocation
  2295                                  ClearModInfo:
  2296 0000065B 60                      		pusha
  2297 0000065C 06                      		push    es
  2298 0000065D 8CD8                    		mov     ax, ds
  2299 0000065F 8EC0                    		mov     es, ax
  2300                                  		;lea    di, [ModInfo]
  2301 00000661 BF[D654]                		mov	di, ModInfo
  2302 00000664 B9FA01                  		mov     cx, ModInfoRec.size
  2303 00000667 FC                      		cld
  2304 00000668 31C0                    		xor     ax, ax
  2305 0000066A F3AA                    		rep     stosb
  2306 0000066C 07                      		pop     es
  2307 0000066D 61                      		popa
  2308 0000066E C3                      		retn
  2309                                  
  2310                                  ;=============================================================================
  2311                                  ;               MODPLAY.ASM
  2312                                  ;=============================================================================
  2313                                  
  2314                                  ; Amiga Module Player v0.3b by Carlos Hasan.
  2315                                  ;		July 23th, 1993.
  2316                                  
  2317                                  ; EQUATES
  2318                                  
  2319                                  NumTracks       equ 4
  2320                                  DefTempo        equ 6
  2321                                  DefBpm          equ 125
  2322                                  MidCRate        equ 8448
  2323                                  MixBufSize      equ 4096
  2324                                  
  2325                                  ; STRUCTURES
  2326                                  
  2327                                  struc TrackInfo
  2328 00000000 ????????                .Samples:	resd 1
  2329 00000004 ????                    .Position:	resw 1
  2330 00000006 ????                    .Len:		resw 1
  2331 00000008 ????                    .Repeat:	resw 1
  2332 0000000A ????                    .RepLen:	resw 1
  2333 0000000C ??                      .Volume: 	resb 1
  2334 0000000D ??                      .Error:		resb 1
  2335 0000000E ????                    .Period:	resw 1
  2336 00000010 ????                    .Pitch:		resw 1
  2337 00000012 ????                    .Effect:	resw 1
  2338 00000014 ????                    .PortTo:	resw 1
  2339 00000016 ??                      .PortParm:	resb 1
  2340 00000017 ??                      .VibPos:	resb 1
  2341 00000018 ??                      .VibParm:	resb 1
  2342 00000019 ??                      .OldSampOfs:	resb 1
  2343 0000001A ????????????            .Arp:		resw 3
  2344 00000020 ????                    .ArpIndex:	resw 1
  2345                                  .size:
  2346                                  endstruc
  2347                                  
  2348                                  ; CODE
  2349                                  
  2350                                  ;--------------------------------------------------------------------------
  2351                                  ; BeatTrack:  Process the next beat in one track.
  2352                                  ;  In:
  2353                                  ;    ds:di -  Track info Address.
  2354                                  ;--------------------------------------------------------------------------
  2355                                  
  2356                                  BeatTrack:
  2357 0000066F 8B5512                  		mov     dx, [di+TrackInfo.Effect]
  2358 00000672 85D2                    		test    dx, dx
  2359 00000674 7430                    		je      short None
  2360 00000676 80FE00                  		cmp     dh, 00h
  2361 00000679 742C                    		je      short Arpeggio
  2362 0000067B 80FE01                  		cmp     dh, 01h
  2363 0000067E 743E                    		je      short PortUp
  2364 00000680 80FE02                  		cmp     dh, 02h
  2365 00000683 7455                    		je      short PortDown
  2366 00000685 80FE03                  		cmp     dh, 03h
  2367 00000688 746D                    		je      short TonePort
  2368 0000068A 80FE04                  		cmp     dh, 04h
  2369 0000068D 0F849100                		je      Vibrato
  2370 00000691 80FE05                  		cmp     dh, 05h
  2371 00000694 0F84D600                		je      PortSlide
  2372 00000698 80FE06                  		cmp     dh, 06h
  2373 0000069B 0F84D700                		je      VibSlide
  2374 0000069F 80FE0A                  		cmp     dh, 0Ah
  2375 000006A2 0F84D800                		je      VolSlide
  2376                                  None:           
  2377 000006A6 C3                      		retn
  2378                                  Arpeggio:
  2379 000006A7 8B5D20                  		mov     bx, [di+TrackInfo.ArpIndex]
  2380 000006AA 8B411A                  		mov     ax, [di+TrackInfo.Arp+bx]
  2381 000006AD 894510                  		mov     [di+TrackInfo.Pitch], ax
  2382 000006B0 83C302                  		add     bx, 2
  2383 000006B3 83FB06                  		cmp     bx, 6
  2384 000006B6 7202                    		jb      short SetArpIndex
  2385 000006B8 31DB                    		xor     bx,bx
  2386                                  SetArpIndex:
  2387 000006BA 895D20                  		mov     [di+TrackInfo.ArpIndex], bx
  2388 000006BD C3                      		retn
  2389                                  PortUp:
  2390 000006BE 30F6                    		xor     dh, dh
  2391 000006C0 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2392 000006C3 29D3                    		sub     bx, dx
  2393 000006C5 83FB71                  		cmp     bx, 113
  2394 000006C8 7D03                    		jge     short NotSmall
  2395 000006CA BB7100                  		mov     bx, 113
  2396                                  NotSmall:
  2397 000006CD 895D0E                  		mov     [di+TrackInfo.Period], bx
  2398 000006D0 01DB                    		add     bx, bx
  2399 000006D2 8B87[D056]              		mov     ax, [PitchTable+bx]
  2400 000006D6 894510                  		mov     [di+TrackInfo.Pitch], ax
  2401 000006D9 C3                      		retn
  2402                                  PortDown:
  2403 000006DA 30F6                    		xor     dh, dh
  2404 000006DC 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2405 000006DF 01D3                    		add     bx, dx
  2406 000006E1 81FB5803                		cmp     bx, 856
  2407 000006E5 7E03                    		jle     short NotBig
  2408 000006E7 BB5803                  		mov     bx, 856
  2409 000006EA 895D0E                  NotBig:         mov     [di+TrackInfo.Period], bx
  2410 000006ED 01DB                    		add     bx, bx
  2411 000006EF 8B87[D056]              		mov     ax, [PitchTable+bx]
  2412 000006F3 894510                  		mov     [di+TrackInfo.Pitch], ax
  2413 000006F6 C3                      		retn
  2414                                  TonePort:
  2415 000006F7 30F6                    		xor     dh, dh
  2416 000006F9 8B4514                  		mov     ax, [di+TrackInfo.PortTo]
  2417 000006FC 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2418 000006FF 39C3                    		cmp     bx, ax
  2419 00000701 741E                    		je      short NoPort
  2420 00000703 7F0A                    		jg      short PortToUp
  2421                                  PortToDown:     
  2422 00000705 01D3                    		add     bx, dx
  2423 00000707 39C3                    		cmp     bx, ax
  2424 00000709 7E0A                    		jle     short SetPort
  2425                                  FixPort:        
  2426 0000070B 89C3                    		mov     bx, ax
  2427 0000070D EB06                    		jmp     short SetPort
  2428                                  PortToUp:
  2429 0000070F 29D3                    		sub     bx, dx
  2430 00000711 39C3                    		cmp     bx, ax
  2431 00000713 7CF6                    		jl      short FixPort
  2432                                  SetPort:        
  2433 00000715 895D0E                  		mov     [di+TrackInfo.Period], bx
  2434 00000718 01DB                    		add     bx, bx
  2435 0000071A 8B87[D056]              		mov     ax, [PitchTable+bx]
  2436 0000071E 894510                  		mov     [di+TrackInfo.Pitch], ax
  2437                                  NoPort:         
  2438 00000721 C3                      		retn
  2439                                  Vibrato:
  2440 00000722 88D6                    		mov     dh, dl
  2441 00000724 80E20F                  		and     dl, 0Fh
  2442 00000727 C0EE04                  		shr     dh, 4
  2443 0000072A C0E602                  		shl     dh, 2
  2444 0000072D 007517                  		add     [di+TrackInfo.VibPos], dh
  2445 00000730 8A7517                  		mov     dh, [di+TrackInfo.VibPos]
  2446 00000733 88F3                    		mov     bl, dh
  2447 00000735 C0EB02                  		shr     bl, 2
  2448 00000738 83E31F                  		and     bx, 1Fh
  2449 0000073B 8A87[C60D]              		mov     al, [SinTable+bx]
  2450 0000073F F6E2                    		mul     dl
  2451 00000741 D1C0                    		rol     ax, 1
  2452 00000743 86C4                    		xchg    al, ah
  2453 00000745 80E401                  		and     ah, 1
  2454 00000748 84F6                    		test    dh, dh
  2455 0000074A 7902                    		jns     short VibUp
  2456 0000074C F7D8                    		neg     ax
  2457                                  VibUp:          
  2458 0000074E 03450E                  		add     ax, [di+TrackInfo.Period]
  2459 00000751 89C3                    		mov     bx, ax
  2460 00000753 83FB71                  		cmp     bx, 113
  2461 00000756 7D03                    		jge     short NoLoVib
  2462 00000758 BB7100                  		mov     bx, 113
  2463                                  NoLoVib:        
  2464 0000075B 81FB5803                		cmp     bx, 856
  2465 0000075F 7E03                    		jle     short NoHiVib
  2466 00000761 BB5803                  		mov     bx, 856
  2467                                  NoHiVib:        
  2468 00000764 01DB                    		add     bx, bx
  2469 00000766 8B87[D056]              		mov     ax, [PitchTable+bx]
  2470 0000076A 894510                  		mov     [di+TrackInfo.Pitch], ax
  2471 0000076D C3                      		retn
  2472                                  PortSlide:
  2473 0000076E E80D00                  		call    VolSlide
  2474 00000771 8A5516                  		mov     dl, [di+TrackInfo.PortParm]
  2475 00000774 EB81                    		jmp     short TonePort
  2476                                  VibSlide:
  2477 00000776 E80500                  		call    VolSlide
  2478 00000779 8A5518                  		mov     dl, [di+TrackInfo.VibParm]
  2479 0000077C EBA4                    		jmp     short Vibrato
  2480                                  VolSlide:
  2481 0000077E 88D6                    		mov     dh, dl
  2482 00000780 80E20F                  		and     dl, 0Fh
  2483 00000783 C0EE04                  		shr     dh, 4
  2484 00000786 8A450C                  		mov     al, [di+TrackInfo.Volume]
  2485 00000789 28D0                    		sub     al, dl
  2486 0000078B 7D02                    		jge     short NoLoVol
  2487 0000078D 30C0                    		xor     al, al
  2488                                  NoLoVol:        
  2489 0000078F 00F0                    		add     al, dh
  2490 00000791 3C40                    		cmp     al, 64
  2491 00000793 7602                    		jbe     short NoHiVol
  2492 00000795 B040                    		mov     al, 64
  2493                                  NoHiVol:        
  2494 00000797 88450C                  		mov     [di+TrackInfo.Volume], al
  2495 0000079A C3                      		retn
  2496                                  
  2497                                  ;--------------------------------------------------------------------------
  2498                                  ; GetTrack:   Get the next Note from a pattern.
  2499                                  ;  In:
  2500                                  ;    ds:di -  Track info Address.
  2501                                  ;    es:si -  Pattern Note Address.
  2502                                  ; Out:
  2503                                  ;    es:si -  The Next Pattern Note address.
  2504                                  ;--------------------------------------------------------------------------
  2505                                  
  2506                                  GetTrack:
  2507 0000079B 26AD                    		es lodsw
  2508 0000079D 86C4                    		xchg    al, ah
  2509 0000079F 88E3                    		mov     bl, ah
  2510 000007A1 80E40F                  		and     ah, 0Fh
  2511 000007A4 89C1                    		mov     cx, ax
  2512 000007A6 26AD                    		es lodsw
  2513 000007A8 86C4                    		xchg    al, ah
  2514 000007AA 88E7                    		mov     bh, ah
  2515 000007AC 80E40F                  		and     ah, 0Fh
  2516 000007AF 89C2                    		mov     dx, ax
  2517 000007B1 895512                  		mov     [di+TrackInfo.Effect], dx
  2518 000007B4 80E3F0                  		and     bl, 0F0h
  2519 000007B7 C0EF04                  		shr     bh, 4
  2520 000007BA 08FB                    		or      bl, bh
  2521 000007BC 742E                    		je      short SetPeriod
  2522                                  SetSample:
  2523 000007BE 30FF                    		xor     bh, bh
  2524 000007C0 4B                      		dec     bx
  2525 000007C1 01DB                    		add     bx, bx
  2526 000007C3 8B87[9256]              		mov     ax, [ModInfo.SampVol+bx]
  2527 000007C7 88450C                  		mov     [di+TrackInfo.Volume], al
  2528 000007CA 8B87[5C55]              		mov     ax, [ModInfo.SampOfs+bx]
  2529 000007CE 8905                    		mov     [di+TrackInfo.Samples], ax
  2530 000007D0 8B87[9A55]              		mov     ax, [ModInfo.SampSeg+bx]
  2531 000007D4 894502                  		mov     [di+TrackInfo.Samples+2], ax
  2532 000007D7 8B87[D855]              		mov     ax, [ModInfo.SampLen+bx]
  2533 000007DB 894506                  		mov     [di+TrackInfo.Len], ax
  2534 000007DE 8B87[1656]              		mov     ax, [ModInfo.SampRep+bx]
  2535 000007E2 894508                  		mov     [di+TrackInfo.Repeat], ax
  2536 000007E5 8B87[5456]              		mov     ax, [ModInfo.SampRepLen+bx]
  2537 000007E9 89450A                  		mov     [di+TrackInfo.RepLen], ax
  2538                                  SetPeriod:      
  2539 000007EC 85C9                    		test    cx, cx
  2540 000007EE 741B                    		je      short SetEffect
  2541                                  
  2542 000007F0 894D14                  		mov     [di+TrackInfo.PortTo], cx
  2543 000007F3 80FE03                  		cmp     dh, 03h
  2544 000007F6 7413                    		je      short SetEffect
  2545                                  
  2546 000007F8 894D0E                  		mov     [di+TrackInfo.Period], cx
  2547 000007FB 89CB                    		mov     bx, cx
  2548 000007FD 01DB                    		add     bx, bx
  2549 000007FF 8B87[D056]              		mov     ax, [PitchTable+bx]
  2550 00000803 894510                  		mov     [di+TrackInfo.Pitch], ax
  2551 00000806 C745040000              		mov     word [di+TrackInfo.Position], 0
  2552                                  SetEffect:
  2553 0000080B 85D2                    		test    dx, dx
  2554 0000080D 742A                    		je      short InitNone
  2555 0000080F 80FE00                  		cmp     dh, 00h
  2556 00000812 0F84C400                		je      InitArpeggio
  2557 00000816 80FE03                  		cmp     dh, 03h
  2558 00000819 741F                    		je      short InitTonePort
  2559 0000081B 80FE04                  		cmp     dh, 04h
  2560 0000081E 7428                    		je      short InitVibrato
  2561 00000820 80FE09                  		cmp     dh, 09h
  2562 00000823 744A                    		je      short SampleOfs
  2563 00000825 80FE0B                  		cmp     dh, 0Bh
  2564 00000828 7457                    		je      short PosJump
  2565 0000082A 80FE0C                  		cmp     dh, 0Ch
  2566 0000082D 745C                    		je      short SetVolume
  2567 0000082F 80FE0D                  		cmp     dh, 0Dh
  2568 00000832 7462                    		je      short Break
  2569 00000834 80FE0F                  		cmp     dh, 0Fh
  2570 00000837 7478                    		je      short SetSpeed
  2571                                  InitNone:
  2572 00000839 C3                      		retn
  2573                                  InitTonePort:
  2574 0000083A 84D2                    		test    dl, dl
  2575 0000083C 7503                    		jne     short SetPortParm
  2576 0000083E 8A5516                  		mov     dl, [di+TrackInfo.PortParm]
  2577                                  SetPortParm:    
  2578 00000841 885516                  		mov     [di+TrackInfo.PortParm], dl
  2579 00000844 895512                  		mov     [di+TrackInfo.Effect], dx
  2580 00000847 C3                      		retn
  2581                                  InitVibrato:
  2582 00000848 8A4518                  		mov     al, [di+TrackInfo.VibParm]
  2583 0000084B 88C4                    		mov     ah, al
  2584 0000084D 240F                    		and     al, 0Fh
  2585 0000084F 80E4F0                  		and     ah, 0F0h
  2586 00000852 F6C20F                  		test    dl, 0Fh
  2587 00000855 7502                    		jne     short OkDepth
  2588 00000857 08C2                    		or      dl, al
  2589                                  OkDepth:        
  2590 00000859 F6C2F0                  		test    dl, 0F0h
  2591 0000085C 7502                    		jne     short OkRate
  2592 0000085E 08E2                    		or      dl, ah
  2593                                  OkRate:         
  2594 00000860 885518                  		mov     [di+TrackInfo.VibParm], dl
  2595 00000863 895512                  		mov     [di+TrackInfo.Effect], dx
  2596 00000866 85C9                    		test    cx, cx
  2597 00000868 7404                    		je      short OkPos
  2598 0000086A C6451700                		mov     byte [di+TrackInfo.VibPos], 0
  2599                                  OkPos:          
  2600 0000086E C3                      		retn
  2601                                  SampleOfs:      
  2602 0000086F 84D2                    		test    dl, dl
  2603 00000871 7503                    		jne     short SetSampleOfs
  2604 00000873 8A5519                  		mov     dl, [di+TrackInfo.OldSampOfs]
  2605                                  SetSampleOfs:
  2606 00000876 885519                  		mov     [di+TrackInfo.OldSampOfs], dl
  2607 00000879 88D6                    		mov     dh, dl
  2608 0000087B 30D2                    		xor     dl, dl
  2609 0000087D 895504                  		mov     [di+TrackInfo.Position], dx
  2610 00000880 C3                      		retn
  2611                                  PosJump:
  2612 00000881 8816[82AE]              		mov     [OrderPos], dl
  2613 00000885 C606[86AE]40            		mov     byte [Row], 64
  2614 0000088A C3                      		retn
  2615                                  SetVolume:
  2616 0000088B 80FA40                  		cmp     dl, 64
  2617 0000088E 7602                    		jbe     short OkVol
  2618 00000890 B240                    		mov     dl, 64
  2619                                  OkVol:
  2620 00000892 88550C                  		mov     [di+TrackInfo.Volume], dl
  2621 00000895 C3                      		retn
  2622                                  Break:
  2623 00000896 88D6                    		mov     dh, dl
  2624 00000898 80E20F                  		and     dl, 0Fh
  2625 0000089B C0EE04                  		shr     dh, 4
  2626 0000089E 00F6                    		add     dh, dh
  2627 000008A0 00F2                    		add     dl, dh
  2628 000008A2 C0E602                  		shl     dh, 2
  2629 000008A5 00F2                    		add     dl, dh
  2630 000008A7 8816[87AE]              		mov     [BreakRow], dl
  2631 000008AB C606[86AE]40            		mov     byte [Row], 64
  2632 000008B0 C3                      		retn
  2633                                  SetSpeed:
  2634 000008B1 84D2                    		test    dl,dl
  2635 000008B3 7424                    		je      Skip
  2636 000008B5 80FA1F                  		cmp     dl,31
  2637 000008B8 7709                    		ja      short SetBpm
  2638                                  SetTempo:       
  2639 000008BA 8816[83AE]              		mov     [Tempo], dl
  2640 000008BE 8816[84AE]              		mov     [TempoWait], dl
  2641 000008C2 C3                      		retn
  2642                                  SetBpm:
  2643 000008C3 8816[85AE]              		mov     [Bpm], dl
  2644 000008C7 B067                    		mov     al, 103
  2645 000008C9 F6E2                    		mul     dl
  2646 000008CB 88E3                    		mov     bl, ah
  2647 000008CD 30FF                    		xor     bh, bh
  2648 000008CF A1[D454]                		mov     ax, [MixSpeed]
  2649 000008D2 31D2                    		xor     dx, dx
  2650 000008D4 F7F3                    		div     bx
  2651 000008D6 A3[88AE]                		mov     [BpmSamples], ax
  2652                                  Skip:           
  2653 000008D9 C3                      		retn
  2654                                  InitArpeggio:
  2655 000008DA 88D6                    		mov     dh, dl
  2656 000008DC 80E20F                  		and     dl, 0Fh
  2657 000008DF C0EE04                  		shr     dh, 4
  2658 000008E2 B92400                  		mov     cx, 36
  2659 000008E5 31DB                    		xor     bx, bx
  2660 000008E7 8B450E                  		mov     ax, [di+TrackInfo.Period]
  2661                                  gt_ScanPeriod:
  2662 000008EA 3B87[E60D]              		cmp     ax, [PeriodTable+bx]
  2663 000008EE 7305                    		jae     short SetArp
  2664 000008F0 83C302                  		add     bx, 2
  2665 000008F3 E2F5                    		loop    gt_ScanPeriod
  2666                                  SetArp:         
  2667 000008F5 01D2                    		add     dx, dx
  2668 000008F7 00DE                    		add     dh, bl
  2669 000008F9 00DA                    		add     dl, bl
  2670 000008FB 8B9F[E60D]              		mov     bx, [PeriodTable+bx]
  2671 000008FF 01DB                    		add     bx, bx
  2672 00000901 8B87[D056]              		mov     ax, [PitchTable+bx]
  2673 00000905 89451A                  		mov     [di+TrackInfo.Arp], ax
  2674 00000908 88F3                    		mov     bl, dh
  2675 0000090A 30FF                    		xor     bh, bh
  2676 0000090C 8B9F[E60D]              		mov     bx, [PeriodTable+bx]
  2677 00000910 01DB                    		add     bx, bx
  2678 00000912 8B87[D056]              		mov     ax, [PitchTable+bx]
  2679 00000916 89451C                  		mov     [di+TrackInfo.Arp+2], ax
  2680 00000919 88D3                    		mov     bl, dl
  2681 0000091B 30FF                    		xor     bh, bh
  2682 0000091D 8B9F[E60D]              		mov     bx, [PeriodTable+bx]
  2683 00000921 01DB                    		add     bx, bx
  2684 00000923 8B87[D056]              		mov     ax, [PitchTable+bx]
  2685 00000927 89451E                  		mov     [di+TrackInfo.Arp+4], ax
  2686 0000092A C745200000              		mov     word [di+TrackInfo.ArpIndex], 0
  2687 0000092F C3                      		retn
  2688                                  
  2689                                  ;--------------------------------------------------------------------------
  2690                                  ; UpdateTracks:  Main code to process the next tick to be played.
  2691                                  ;--------------------------------------------------------------------------
  2692                                  
  2693                                  UpdateTracks:
  2694 00000930 FE0E[84AE]              		dec     byte [TempoWait]
  2695 00000934 740F                    		jz      short GetTracks
  2696                                  
  2697 00000936 B90400                  		mov	cx, NumTracks
  2698 00000939 BF[94AE]                		mov	di, Tracks
  2699                                  BeatTracks:
  2700 0000093C E830FD                  		call	BeatTrack	
  2701 0000093F 83C722                  		add	di, TrackInfo.size
  2702 00000942 E2F8                    		loop	BeatTracks
  2703 00000944 C3                      		retn
  2704                                  GetTracks:
  2705 00000945 A0[83AE]                		mov     al, [Tempo]
  2706 00000948 A2[84AE]                		mov     [TempoWait], al
  2707                                  
  2708 0000094B C436[90AE]              		les     si, [Note]
  2709 0000094F 803E[86AE]40            		cmp     byte [Row], 64
  2710 00000954 7246                    		jb      short NoPattWrap
  2711                                  
  2712 00000956 C436[5855]              		les     si, [ModInfo.Patterns]
  2713 0000095A 8A1E[82AE]              		mov     bl, [OrderPos]
  2714 0000095E 3A1E[D654]              		cmp     bl, [ModInfo.OrderLen]
  2715 00000962 720E                    		jb      short NoOrderWrap
  2716 00000964 8A1E[D754]              		mov     bl, [ModInfo.ReStart]
  2717 00000968 881E[82AE]              		mov     [OrderPos], bl
  2718 0000096C 3A1E[D654]              		cmp     bl, [ModInfo.OrderLen]
  2719 00000970 7343                    		jae     short NoUpdate
  2720                                  NoOrderWrap:    
  2721 00000972 30FF                    		xor     bh, bh
  2722 00000974 8A9F[D854]              		mov     bl, [ModInfo.Order+bx]
  2723 00000978 C1E30A                  		shl     bx, 10
  2724 0000097B 01DE                    		add     si, bx
  2725 0000097D 8A1E[87AE]              		mov     bl, [BreakRow]
  2726 00000981 881E[86AE]              		mov     [Row], bl
  2727 00000985 30FF                    		xor     bh, bh
  2728 00000987 883E[87AE]              		mov     [BreakRow], bh
  2729 0000098B C1E304                  		shl     bx, 4
  2730 0000098E 01DE                    		add     si, bx
  2731 00000990 8936[90AE]              		mov     [Note], si
  2732 00000994 8C06[92AE]              		mov     [Note+2], es
  2733 00000998 FE06[82AE]              		inc     byte [OrderPos]
  2734                                  NoPattWrap:     
  2735 0000099C FE06[86AE]              		inc     byte [Row]
  2736                                  
  2737 000009A0 FC                      		cld
  2738 000009A1 B90400                  		mov	cx, NumTracks
  2739 000009A4 BF[94AE]                		mov	di, Tracks
  2740                                  GetTracks_next:
  2741 000009A7 51                      		push	cx		
  2742 000009A8 E8F0FD                  		call	GetTrack
  2743 000009AB 59                      		pop	cx
  2744 000009AC 83C722                  		add	di, TrackInfo.size
  2745 000009AF E2F6                    		loop	GetTracks_next
  2746                                  
  2747 000009B1 8936[90AE]              		mov     [Note], si
  2748                                  NoUpdate:
  2749 000009B5 C3                      		retn
  2750                                  
  2751                                  ;--------------------------------------------------------------------------
  2752                                  ; MixTrack:  Mixes one track into a CLEAN buffer.
  2753                                  ;  In:
  2754                                  ;   ds:si -  Track Info Address.
  2755                                  ;   ds:di -  Buffer Address.
  2756                                  ;    cx   -  Buffer Size.
  2757                                  ;--------------------------------------------------------------------------
  2758                                  
  2759                                  MixTrack:
  2760 000009B6 837C0A02                		cmp     word [si+TrackInfo.RepLen], 2
  2761 000009BA 7742                    		ja      short MixLooped
  2762                                  MixNonLooped:   
  2763 000009BC C414                    		les     dx, [si+TrackInfo.Samples]
  2764 000009BE 8B5C04                  		mov     bx, [si+TrackInfo.Position]
  2765 000009C1 8B6C06                  		mov     bp, [si+TrackInfo.Len]
  2766 000009C4 52                      		push    dx
  2767 000009C5 56                      		push    si
  2768 000009C6 01D3                    		add     bx, dx
  2769 000009C8 01D5                    		add     bp, dx
  2770 000009CA 8B5410                  		mov     dx, [si+TrackInfo.Pitch]
  2771 000009CD 8A440C                  		mov     al, [si+TrackInfo.Volume]
  2772 000009D0 8A640D                  		mov     ah, [si+TrackInfo.Error]
  2773 000009D3 89DE                    		mov     si, bx
  2774 000009D5 88C7                    		mov     bh, al
  2775 000009D7 88D0                    		mov     al, dl
  2776 000009D9 88F2                    		mov     dl, dh
  2777 000009DB 30F6                    		xor     dh, dh
  2778                                  nlMixSamp:      
  2779 000009DD 39EE                    		cmp     si, bp
  2780 000009DF 7310                    		jae     short nlMixBye
  2781 000009E1 268A1C                  		mov     bl, [es:si]
  2782 000009E4 8A9F[825D]              		mov     bl, [VolTable+bx]
  2783 000009E8 001D                    		add     [di], bl
  2784 000009EA 47                      		inc     di
  2785 000009EB 00C4                    		add     ah, al
  2786 000009ED 11D6                    		adc     si, dx
  2787 000009EF E2EC                    		loop    nlMixSamp
  2788                                  nlMixBye:       
  2789 000009F1 89F3                    		mov     bx, si
  2790 000009F3 5E                      		pop     si
  2791 000009F4 5A                      		pop     dx
  2792 000009F5 29D3                    		sub     bx, dx
  2793 000009F7 895C04                  		mov     [si+TrackInfo.Position], bx
  2794 000009FA 88640D                  		mov     [si+TrackInfo.Error], ah
  2795 000009FD C3                      		retn
  2796                                  MixLooped:
  2797 000009FE C414                    		les     dx, [si+TrackInfo.Samples]
  2798 00000A00 8B5C04                  		mov     bx, [si+TrackInfo.Position]
  2799 00000A03 8B6C0A                  		mov     bp, [si+TrackInfo.RepLen]
  2800 00000A06 892E[8EAE]              		mov     [BufRep], bp
  2801 00000A0A 036C08                  		add     bp, [si+TrackInfo.Repeat]
  2802 00000A0D 52                      		push    dx
  2803 00000A0E 56                      		push    si
  2804 00000A0F 01D3                    		add     bx, dx
  2805 00000A11 01D5                    		add     bp, dx
  2806 00000A13 8B5410                  		mov     dx, [si+TrackInfo.Pitch]
  2807 00000A16 8A440C                  		mov     al, [si+TrackInfo.Volume]
  2808 00000A19 8A640D                  		mov     ah, [si+TrackInfo.Error]
  2809 00000A1C 89DE                    		mov     si, bx
  2810 00000A1E 88C7                    		mov     bh, al
  2811 00000A20 88D0                    		mov     al, dl
  2812 00000A22 88F2                    		mov     dl, dh
  2813 00000A24 30F6                    		xor     dh, dh
  2814                                  lpMixSamp:      
  2815 00000A26 39EE                    		cmp     si, bp
  2816 00000A28 7204                    		jb      short lpMixNow
  2817 00000A2A 2B36[8EAE]              		sub     si, [BufRep]
  2818                                  lpMixNow:       
  2819 00000A2E 268A1C                  		mov     bl, [es:si]
  2820 00000A31 8A9F[825D]              		mov     bl, [VolTable+bx]
  2821 00000A35 001D                    		add     [di], bl
  2822 00000A37 47                      		inc     di
  2823 00000A38 00C4                    		add     ah, al
  2824 00000A3A 11D6                    		adc     si, dx
  2825 00000A3C E2E8                    		loop    lpMixSamp
  2826                                  lpMixBye:       
  2827 00000A3E 89F3                    		mov     bx, si
  2828 00000A40 5E                      		pop     si
  2829 00000A41 5A                      		pop     dx
  2830 00000A42 29D3                    		sub     bx, dx
  2831 00000A44 895C04                  		mov     [si+TrackInfo.Position], bx
  2832 00000A47 88640D                  		mov     [si+TrackInfo.Error], ah
  2833 00000A4A C3                      		retn
  2834                                  
  2835                                  GetSamples_ICH:
  2836                                  		; 11/05/2024
  2837                                  		; 18/02/2017
  2838                                  		; 8 bit mono samples 
  2839                                  		; must be converted to 16 bit, stereo samples (for ICH) !
  2840                                  		; (ICH AC97 Modification by Erdogan Tan)
  2841 00000A4B 8936[A0B3]              		mov	[_si_], si ; DMA Buff Addr, [DMA_BUFFER1] or [DMA_BUFFER2]
  2842                                  		; 11/05/2024
  2843                                  		;mov	si, MOD_BUFFER
  2844                                  		;shr	cx, 2 ; mod buffer size = dma (half) buffer size / 4 (*)
  2845                                  
  2846                                  ;--------------------------------------------------------------------------
  2847                                  ; GetSamples:  Returns the next chunk of samples to be played.
  2848                                  ;  In:
  2849                                  ;    Buffer  - Buffer Address.
  2850                                  ;    Count   - Buffer Size.
  2851                                  ;--------------------------------------------------------------------------
  2852                                  
  2853                                  GetSamples:
  2854                                  		;ds:si = buffer address
  2855                                  		;cx = count
  2856                                  
  2857                                  		; 11/05/2024
  2858                                  		;
  2859                                  		;;[sp+6] = ds
  2860                                  		;;[sp+4] = si
  2861                                  		;;[sp+2] = count
  2862                                  		;
  2863                                  		;Count	equ 4
  2864                                  		;Buffer	equ 6 
  2865                                  		;
  2866                                  		;push	bp
  2867                                  		;mov	bp, sp
  2868                                  		;
  2869                                  		;push    es
  2870                                  		;;;push  ds
  2871                                  		;;;pusha
  2872                                  		;
  2873                                  		;cld
  2874                                  		;
  2875                                  		;les	di, [bp+Buffer]
  2876                                  		;mov    bx, [bp+Count]
  2877                                  
  2878                                  		; 11/05/2024
  2879                                  		; ds = cs
  2880 00000A4F 06                      		push	es ; +
  2881                                  
  2882 00000A50 1E                      		push	ds
  2883 00000A51 07                      		pop	es
  2884                                  
  2885                                  		; 11/05/2024
  2886 00000A52 BF[A2B3]                		mov	di, MOD_BUFFER
  2887 00000A55 BB0008                  		mov	bx, (BUFFERSIZE/4) ; (*) ; 2048
  2888                                  NextChunk:
  2889 00000A58 833E[8CAE]00            		cmp     word [BufLen], 0
  2890 00000A5D 7534                    		jne     short CopyChunk
  2891                                  
  2892                                  		; 11/05/2024
  2893 00000A5F 06                      		push	es
  2894 00000A60 53                      		push	bx
  2895 00000A61 57                      		push	di
  2896                                  MixChunk:       
  2897                                  		;lea    di, [MixBuffer]
  2898 00000A62 BF[829E]                		mov	di, MixBuffer
  2899 00000A65 8B0E[88AE]              		mov     cx, [BpmSamples]
  2900 00000A69 893E[8AAE]              		mov     [BufPtr], di
  2901 00000A6D 890E[8CAE]              		mov     [BufLen], cx
  2902                                  
  2903                                  		; 12/05/2024
  2904                                  		; es = ds
  2905                                  		;mov    ax, ds
  2906                                  		;mov    es, ax
  2907                                  
  2908 00000A71 B080                    		mov    al, 80h
  2909 00000A73 F3AA                    		rep    stosb
  2910                                  
  2911 00000A75 B90400                  		mov	cx, NumTracks
  2912 00000A78 BE[72AE]                		mov	si, Tracks - TrackInfo.size
  2913                                  GetSamples_next:
  2914 00000A7B 51                      		push	cx
  2915 00000A7C 83C622                  		add	si, TrackInfo.size
  2916 00000A7F 8B0E[8CAE]              		mov	cx, [BufLen]
  2917 00000A83 8B3E[8AAE]              		mov	di, [BufPtr]
  2918 00000A87 E82CFF                  		call	MixTrack
  2919 00000A8A 59                      		pop	cx
  2920 00000A8B E2EE                    		loop	GetSamples_next
  2921                                  
  2922 00000A8D E8A0FE                  		call    UpdateTracks
  2923                                  
  2924 00000A90 5F                      		pop	di
  2925 00000A91 5B                      		pop	bx
  2926 00000A92 07                      		pop	es ; es = ds ; 12/05/2024
  2927                                  CopyChunk:      
  2928 00000A93 8B0E[8CAE]              		mov     cx, [BufLen]
  2929 00000A97 39D9                    		cmp     cx, bx
  2930 00000A99 7602                    		jbe     short MoveChunk
  2931 00000A9B 89D9                    		mov     cx, bx
  2932                                  MoveChunk:
  2933 00000A9D 8B36[8AAE]              		mov     si, [BufPtr]
  2934 00000AA1 010E[8AAE]              		add     [BufPtr], cx
  2935 00000AA5 290E[8CAE]              		sub     [BufLen], cx
  2936 00000AA9 29CB                    		sub     bx, cx
  2937 00000AAB F3A4                    		rep     movsb
  2938 00000AAD 85DB                    		test    bx, bx
  2939 00000AAF 75A7                    		jnz     short NextChunk
  2940                                  
  2941                                  		;;popa
  2942                                  		;;pop	ds
  2943                                  		;pop	es
  2944                                  		;pop	bp
  2945                                  		;ret	6
  2946                                  
  2947                                  ; GetSamples_ICH_convert_samples:
  2948                                  		; 11/05/2024
  2949                                  		; es = ds = cs
  2950                                  		; 18/02/2017
  2951                                  		;mov	di, ds
  2952                                  		;mov	es, di
  2953 00000AB1 8B3E[A0B3]              		mov	di, [_si_] ; DMA Buffer Address (16 bit, stereo)
  2954 00000AB5 BE[A1B3]                		mov	si, MOD_BUFFER - 1 ; buffer for 8 bit mono samples
  2955 00000AB8 B90008                  		mov	cx, (BUFFERSIZE/4) ; (*) ; 2048 ; 11/04/2024
  2956 00000ABB 30C0                    		xor	al, al
  2957                                  gscs_loop:		
  2958 00000ABD 46                      		inc	si
  2959 00000ABE 8A24                    		mov	ah, [si] ; convert 8 bit sample to 16 bit sample
  2960                                  		; 11/05/2024
  2961 00000AC0 80EC80                  		sub	ah, 80h
  2962                                  
  2963 00000AC3 AB                      		stosw	; left channel
  2964 00000AC4 AB                      		stosw	; right channel
  2965 00000AC5 E2F6                    		loop	gscs_loop
  2966                                  
  2967                                  		; 11/05/2024
  2968 00000AC7 07                      		pop	es ; +
  2969                                  		;pop	bp
  2970                                  		;ret	6
  2971 00000AC8 C3                      		retn
  2972                                  
  2973                                  ;--------------------------------------------------------------------------
  2974                                  ; StartPlaying: Initializes the Sound System.
  2975                                  ;  In:
  2976                                  ;   Module Information Resources.
  2977                                  ;--------------------------------------------------------------------------
  2978                                  
  2979                                  StartPlaying:
  2980 00000AC9 60                      		pusha
  2981 00000ACA 1E                      		push    ds
  2982 00000ACB 06                      		push    es
  2983                                  SetModParms:    
  2984 00000ACC C606[82AE]00            		mov     byte [OrderPos], 0
  2985 00000AD1 C606[83AE]06            		mov     byte [Tempo], DefTempo
  2986 00000AD6 C606[84AE]06            		mov     byte [TempoWait], DefTempo
  2987 00000ADB C606[85AE]7D            		mov     byte [Bpm], DefBpm
  2988 00000AE0 C606[86AE]40            		mov     byte [Row], 64
  2989 00000AE5 C606[87AE]00            		mov     byte [BreakRow], 0
  2990 00000AEA A1[D454]                		mov     ax, [MixSpeed]
  2991 00000AED 31D2                    		xor     dx, dx
  2992 00000AEF BB3200                  		mov     bx, 24*DefBpm/60
  2993 00000AF2 F7F3                    		div     bx
  2994 00000AF4 A3[88AE]                		mov     [BpmSamples], ax
  2995                                  ClearTracks:    
  2996 00000AF7 BF[94AE]                		mov     di, Tracks
  2997 00000AFA 8CD8                    		mov     ax, ds
  2998 00000AFC 8EC0                    		mov     es, ax
  2999 00000AFE B98800                  		mov     cx, NumTracks*TrackInfo.size
  3000 00000B01 31C0                    		xor     ax, ax
  3001 00000B03 FC                      		cld
  3002 00000B04 F3AA                    		rep     stosb
  3003                                  
  3004 00000B06 A3[8AAE]                		mov     [BufPtr], ax
  3005 00000B09 A3[8CAE]                		mov     [BufLen], ax
  3006                                  MakePitch:
  3007 00000B0C B80021                  		mov     ax, MidCRate
  3008 00000B0F BBAC01                  		mov     bx, 428
  3009 00000B12 F7E3                    		mul     bx
  3010 00000B14 F736[D454]              		div     word [MixSpeed]
  3011 00000B18 30F6                    		xor     dh, dh
  3012 00000B1A 88E2                    		mov     dl, ah
  3013 00000B1C 88C4                    		mov     ah, al
  3014 00000B1E 30C0                    		xor     al, al
  3015 00000B20 B95903                  		mov     cx, 857
  3016 00000B23 31DB                    		xor     bx, bx
  3017 00000B25 BF[D056]                		mov     di, PitchTable
  3018                                  PitchLoop:      
  3019 00000B28 50                      		push    ax
  3020 00000B29 52                      		push    dx
  3021 00000B2A 39DA                    		cmp     dx, bx
  3022 00000B2C 7302                    		jae     short NoDiv
  3023 00000B2E F7F3                    		div     bx
  3024                                  NoDiv:          
  3025 00000B30 AB                      		stosw
  3026 00000B31 5A                      		pop     dx
  3027 00000B32 58                      		pop     ax
  3028 00000B33 43                      		inc     bx
  3029 00000B34 E2F2                    		loop    PitchLoop
  3030                                  MakeVolume:     
  3031 00000B36 B90041                  		mov     cx, 16640
  3032 00000B39 89CB                    		mov     bx, cx
  3033                                  VolLoop:
  3034 00000B3B 4B                      		dec     bx
  3035 00000B3C 88D8                    		mov     al, bl
  3036 00000B3E F6EF                    		imul    bh
  3037 00000B40 88A7[825D]              		mov     [VolTable+bx], ah
  3038 00000B44 E2F5                    		loop    VolLoop
  3039                                  
  3040 00000B46 07                      		pop     es
  3041 00000B47 1F                      		pop     ds
  3042 00000B48 61                      		popa
  3043 00000B49 C3                      		retn	; 12/05/2024
  3044                                  
  3045                                  ;--------------------------------------------------------------------------
  3046                                  ; StopPlaying: ShutDown the Sound System.
  3047                                  ;--------------------------------------------------------------------------
  3048                                  
  3049                                  StopPlaying:
  3050                                  	; 08/05/2024
  3051                                  	; 04/11/2023
  3052                                  	; finished with song, stop everything
  3053 00000B4A E8A801                  	call	ac97_stop
  3054                                  
  3055                                  ; 12/05/2024 (tuneloop version)
  3056                                  %if 0
  3057                                  	; 11/11/2023
  3058                                  irq_restore:	
  3059                                  	; restore previous interrupt vector and interrupt_status
  3060                                  	cli
  3061                                  	in	al, 0A1h ; irq 8-15
  3062                                  	mov	al, [IRQ_status+1]
  3063                                  	out	0A1h, al 
  3064                                  	in	al, 021h ; irq 0-7
  3065                                  	mov	al, [IRQ_status]
  3066                                  	out	21h, al 
  3067                                  	; ...
  3068                                  	push	es
  3069                                  	xor	ax, ax
  3070                                  	mov	es, ax
  3071                                  	mov	ax, [IRQ_vector]
  3072                                  	mov	[es:bx], ax
  3073                                  	mov	ax, [IRQ_vector+2]
  3074                                  	mov	[es:bx+2], ax
  3075                                  	pop	es
  3076                                  
  3077                                  	sti
  3078                                  %endif
  3079 00000B4D C3                      	retn
  3080                                  
  3081                                  ;=============================================================================
  3082                                  ;               PLAYER.ASM
  3083                                  ;=============================================================================
  3084                                  
  3085                                  ; UTILS.ASM
  3086                                  ;----------------------------------------------------------------------------
  3087                                  ;       delay1_4ms - Delay for 1/4 millisecond.
  3088                                  ;		    1mS = 1000us
  3089                                  ;       Entry:
  3090                                  ;         None
  3091                                  ;       Exit:
  3092                                  ;	  None
  3093                                  ;
  3094                                  ;       Modified:
  3095                                  ;         None
  3096                                  ;
  3097                                  PORTB			EQU	061h
  3098                                    REFRESH_STATUS	EQU	010h		; Refresh signal status
  3099                                  
  3100                                  delay1_4ms:
  3101 00000B4E 50                              push    ax 
  3102 00000B4F 51                              push    cx
  3103 00000B50 B91000                          mov     cx, 16			; close enough.
  3104 00000B53 E461                    	in	al,PORTB
  3105 00000B55 2410                    	and	al,REFRESH_STATUS
  3106 00000B57 88C4                    	mov	ah,al			; Start toggle state
  3107 00000B59 09C9                    	or	cx, cx
  3108 00000B5B 7401                    	jz	short _d4ms1
  3109 00000B5D 41                      	inc	cx			; Throwaway first toggle
  3110                                  _d4ms1:	
  3111 00000B5E E461                    	in	al,PORTB		; Read system control port
  3112 00000B60 2410                    	and	al,REFRESH_STATUS	; Refresh toggles 15.085 microseconds
  3113 00000B62 38C4                    	cmp	ah,al
  3114 00000B64 74F8                    	je	short _d4ms1		; Wait for state change
  3115                                  
  3116 00000B66 88C4                    	mov	ah,al			; Update with new state
  3117 00000B68 49                      	dec	cx
  3118 00000B69 75F3                    	jnz	short _d4ms1
  3119                                  
  3120 00000B6B 59                              pop     cx
  3121 00000B6C 58                              pop     ax
  3122 00000B6D C3                              retn
  3123                                  
  3124                                  print_msg:
  3125                                  	; 13/11/2016 - Erdogan Tan 
  3126                                  	; esi = ASCIIZ text address
  3127                                  	;
  3128 00000B6E BB0700                  	mov	bx, 7h
  3129 00000B71 B40E                    	mov	ah, 0Eh 
  3130                                  pm_next_char:
  3131 00000B73 AC                      	lodsb
  3132 00000B74 20C0                    	and	al, al
  3133 00000B76 7404                    	jz	short pm_retn
  3134 00000B78 CD10                    	int	10h
  3135 00000B7A EBF7                    	jmp	short pm_next_char
  3136                                  pm_retn:
  3137 00000B7C C3                      	retn
  3138                                  
  3139                                  dword2str:
  3140                                  	; 13/11/2016 - Erdogan Tan 
  3141                                  	; eax = dword value
  3142                                  	;
  3143 00000B7D E84400                  	call	dwordtohex
  3144 00000B80 668916[680F]            	mov	[dword_str], edx
  3145 00000B85 66A3[6C0F]              	mov	[dword_str+4], eax
  3146 00000B89 BE[680F]                	mov	si, dword_str
  3147 00000B8C C3                      	retn
  3148                                  
  3149                                  	; trdos386.s (unix386.s) - 10/05/2015
  3150                                  	; Convert binary number to hexadecimal string
  3151                                  
  3152                                  bytetohex:
  3153                                  	; INPUT ->
  3154                                  	; 	AL = byte (binary number)
  3155                                  	; OUTPUT ->
  3156                                  	;	AX = hexadecimal string
  3157                                  	;
  3158 00000B8D 53                      	push	bx
  3159 00000B8E 30FF                    	xor	bh, bh
  3160 00000B90 88C3                    	mov	bl, al
  3161 00000B92 C0EB04                  	shr	bl, 4
  3162 00000B95 8A9F[920E]              	mov	bl, [bx+hex_chars] 	 	
  3163 00000B99 86D8                    	xchg	bl, al
  3164 00000B9B 80E30F                  	and	bl, 0Fh
  3165 00000B9E 8AA7[920E]              	mov	ah, [bx+hex_chars] 
  3166 00000BA2 5B                      	pop	bx	
  3167 00000BA3 C3                      	retn
  3168                                  
  3169                                  wordtohex:
  3170                                  	; INPUT ->
  3171                                  	; 	AX = word (binary number)
  3172                                  	; OUTPUT ->
  3173                                  	;	EAX = hexadecimal string
  3174                                  	;
  3175 00000BA4 53                      	push	bx
  3176 00000BA5 30FF                    	xor	bh, bh
  3177 00000BA7 86E0                    	xchg	ah, al
  3178 00000BA9 50                      	push	ax
  3179 00000BAA 88E3                    	mov	bl, ah
  3180 00000BAC C0EB04                  	shr	bl, 4
  3181 00000BAF 8A87[920E]              	mov	al, [bx+hex_chars] 	 	
  3182 00000BB3 88E3                    	mov	bl, ah
  3183 00000BB5 80E30F                  	and	bl, 0Fh
  3184 00000BB8 8AA7[920E]              	mov	ah, [bx+hex_chars]
  3185 00000BBC 66C1E010                	shl	eax, 16
  3186 00000BC0 58                      	pop	ax
  3187 00000BC1 5B                      	pop	bx
  3188 00000BC2 EBC9                    	jmp	short bytetohex
  3189                                  
  3190                                  dwordtohex:
  3191                                  	; INPUT ->
  3192                                  	; 	EAX = dword (binary number)
  3193                                  	; OUTPUT ->
  3194                                  	;	EDX:EAX = hexadecimal string
  3195                                  	;
  3196 00000BC4 6650                    	push	eax
  3197 00000BC6 66C1E810                	shr	eax, 16
  3198 00000BCA E8D7FF                  	call	wordtohex
  3199 00000BCD 6689C2                  	mov	edx, eax
  3200 00000BD0 6658                    	pop	eax
  3201 00000BD2 E8CFFF                  	call	wordtohex
  3202 00000BD5 C3                      	retn
  3203                                  
  3204                                  	; 13/11/2016 - Erdogan Tan
  3205                                  write_ac97_dev_info:
  3206                                  	; BUS/DEV/FN
  3207                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  3208                                  	; DEV/VENDOR
  3209                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  3210                                  
  3211 00000BD6 30FF                    	xor	bh, bh
  3212 00000BD8 668B36[8E0F]            	mov	esi, [dev_vendor]
  3213 00000BDD 89F0                    	mov	ax, si
  3214 00000BDF 88C3                    	mov	bl, al
  3215 00000BE1 88DA                    	mov	dl, bl
  3216 00000BE3 80E30F                  	and	bl, 0Fh
  3217 00000BE6 8A87[920E]              	mov	al, [bx+hex_chars]
  3218 00000BEA A2[D50E]                	mov	[msgVendorId+3], al
  3219 00000BED 88D3                    	mov	bl, dl
  3220 00000BEF C0EB04                  	shr	bl, 4
  3221 00000BF2 8A87[920E]              	mov	al, [bx+hex_chars]
  3222 00000BF6 A2[D40E]                	mov	[msgVendorId+2], al
  3223 00000BF9 88E3                    	mov	bl, ah
  3224 00000BFB 88DA                    	mov	dl, bl
  3225 00000BFD 80E30F                  	and	bl, 0Fh
  3226 00000C00 8A87[920E]              	mov	al, [bx+hex_chars]
  3227 00000C04 A2[D30E]                	mov	[msgVendorId+1], al
  3228 00000C07 88D3                    	mov	bl, dl
  3229 00000C09 C0EB04                  	shr	bl, 4
  3230 00000C0C 8A87[920E]              	mov	al, [bx+hex_chars]
  3231 00000C10 A2[D20E]                	mov	[msgVendorId], al
  3232 00000C13 66C1EE10                	shr	esi, 16
  3233 00000C17 89F0                    	mov	ax, si
  3234 00000C19 88C3                    	mov	bl, al
  3235 00000C1B 88DA                    	mov	dl, bl
  3236 00000C1D 80E30F                  	and	bl, 0Fh
  3237 00000C20 8A87[920E]              	mov	al, [bx+hex_chars]
  3238 00000C24 A2[E60E]                	mov	[msgDevId+3], al
  3239 00000C27 88D3                    	mov	bl, dl
  3240 00000C29 C0EB04                  	shr	bl, 4
  3241 00000C2C 8A87[920E]              	mov	al, [bx+hex_chars]
  3242 00000C30 A2[E50E]                	mov	[msgDevId+2], al
  3243 00000C33 88E3                    	mov	bl, ah
  3244 00000C35 88DA                    	mov	dl, bl
  3245 00000C37 80E30F                  	and	bl, 0Fh
  3246 00000C3A 8A87[920E]              	mov	al, [bx+hex_chars]
  3247 00000C3E A2[E40E]                	mov	[msgDevId+1], al
  3248 00000C41 88D3                    	mov	bl, dl
  3249 00000C43 C0EB04                  	shr	bl, 4
  3250 00000C46 8A87[920E]              	mov	al, [bx+hex_chars]
  3251 00000C4A A2[E30E]                	mov	[msgDevId], al
  3252                                  
  3253 00000C4D 668B36[8A0F]            	mov	esi, [bus_dev_fn]
  3254 00000C52 66C1EE08                	shr	esi, 8
  3255 00000C56 89F0                    	mov	ax, si
  3256 00000C58 88C3                    	mov	bl, al
  3257 00000C5A 88DA                    	mov	dl, bl
  3258 00000C5C 80E307                  	and	bl, 7 ; bit 0,1,2
  3259 00000C5F 8A87[920E]              	mov	al, [bx+hex_chars]
  3260 00000C63 A2[0A0F]                	mov	[msgFncNo+1], al
  3261 00000C66 88D3                    	mov	bl, dl
  3262 00000C68 C0EB03                  	shr	bl, 3
  3263 00000C6B 88DA                    	mov	dl, bl
  3264 00000C6D 80E30F                  	and	bl, 0Fh
  3265 00000C70 8A87[920E]              	mov	al, [bx+hex_chars]
  3266 00000C74 A2[FC0E]                	mov	[msgDevNo+1], al
  3267 00000C77 88D3                    	mov	bl, dl
  3268 00000C79 C0EB04                  	shr	bl, 4
  3269 00000C7C 8A87[920E]              	mov	al, [bx+hex_chars]
  3270 00000C80 A2[FB0E]                	mov	[msgDevNo], al
  3271 00000C83 88E3                    	mov	bl, ah
  3272 00000C85 88DA                    	mov	dl, bl
  3273 00000C87 80E30F                  	and	bl, 0Fh
  3274 00000C8A 8A87[920E]              	mov	al, [bx+hex_chars]
  3275 00000C8E A2[F00E]                	mov	[msgBusNo+1], al
  3276 00000C91 88D3                    	mov	bl, dl
  3277 00000C93 C0EB04                  	shr	bl, 4
  3278 00000C96 8A87[920E]              	mov	al, [bx+hex_chars]
  3279 00000C9A A2[EF0E]                	mov	[msgBusNo], al
  3280                                  
  3281                                  	;mov	ax, [ac97_io_base]
  3282                                  	; 08/05/2024
  3283 00000C9D A1[760F]                	mov	ax, [NABMBAR]
  3284 00000CA0 88C3                    	mov	bl, al
  3285 00000CA2 88DA                    	mov	dl, bl
  3286 00000CA4 80E30F                  	and	bl, 0Fh
  3287 00000CA7 8A87[920E]              	mov	al, [bx+hex_chars]
  3288 00000CAB A2[230F]                	mov	[msgIOBaseAddr+3], al
  3289 00000CAE 88D3                    	mov	bl, dl
  3290 00000CB0 C0EB04                  	shr	bl, 4
  3291 00000CB3 8A87[920E]              	mov	al, [bx+hex_chars]
  3292 00000CB7 A2[220F]                	mov	[msgIOBaseAddr+2], al
  3293 00000CBA 88E3                    	mov	bl, ah
  3294 00000CBC 88DA                    	mov	dl, bl
  3295 00000CBE 80E30F                  	and	bl, 0Fh
  3296 00000CC1 8A87[920E]              	mov	al, [bx+hex_chars]
  3297 00000CC5 A2[210F]                	mov	[msgIOBaseAddr+1], al
  3298 00000CC8 88D3                    	mov	bl, dl
  3299 00000CCA C0EB04                  	shr	bl, 4
  3300 00000CCD 8A87[920E]              	mov	al, [bx+hex_chars]
  3301 00000CD1 A2[200F]                	mov	[msgIOBaseAddr], al
  3302                                  
  3303                                  	; 24/11/2016
  3304 00000CD4 30E4                    	xor	ah, ah
  3305 00000CD6 A0[880F]                	mov	al, [ac97_int_ln_reg]
  3306 00000CD9 B10A                    	mov	cl, 10
  3307 00000CDB F6F1                    	div	cl
  3308 00000CDD 0106[2B0F]              	add	[msgIRQ], ax
  3309 00000CE1 20C0                    	and	al, al
  3310 00000CE3 7508                    	jnz	short _pmi
  3311 00000CE5 A0[2C0F]                	mov	al, [msgIRQ+1]
  3312 00000CE8 B420                    	mov	ah, ' '
  3313 00000CEA A3[2B0F]                	mov	[msgIRQ], ax
  3314                                  _pmi:
  3315 00000CED BA[A30E]                        mov	dx, msgAC97Info
  3316 00000CF0 B409                            mov     ah, 9
  3317 00000CF2 CD21                            int     21h
  3318 00000CF4 C3                              retn
  3319                                  
  3320                                  	; 08/05/2024
  3321                                  ac97_stop:
  3322                                  	; 11/11/2023
  3323                                  	; 09/11/2023
  3324                                  	; 05/11/2023
  3325                                  	; 04/11/2023 
  3326                                  	; 28/05/2017 (TRDOS 386 v2, 'audio.s')
  3327                                  	;mov	byte [tLoop], 0 ; stop ! ; 05/11/2023
  3328                                  ;_ac97_stop:
  3329                                  
  3330                                  	; 11/11/2023
  3331 00000CF5 8B16[740F]              	mov	dx, [NAMBAR]
  3332                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  3333 00000CF9 EF                      	out	dx, ax
  3334                                  
  3335                                  	; 04/11/2023
  3336                                  	; 09/10/2017 (TRDOS 386 v2, 'audio.s')
  3337                                  	; 11/06/2017
  3338 00000CFA 30C0                    	xor	al, al ; 0
  3339 00000CFC E80D00                  	call	ac97_po_cmd
  3340                                  
  3341                                  	; (Ref: KolibriOS, intelac97.asm, 'stop:')
  3342                                  	; Clear FIFOE, BCIS, LVBCI (Ref: Intel ICH hub manual)
  3343 00000CFF B81C00                  	mov     ax, 1Ch
  3344 00000D02 8B16[760F]              	mov     dx, [NABMBAR]
  3345 00000D06 83C216                  	add     dx, PO_SR_REG
  3346 00000D09 EF                      	out     dx, ax
  3347                                  
  3348                                  	; 11/06/2017
  3349 00000D0A B002                    	mov     al, RR
  3350                                  ac97_po_cmd:
  3351                                  	; 11/06/2017
  3352                                  	; 29/05/2017
  3353 00000D0C 8B16[760F]              	mov     dx, [NABMBAR]
  3354 00000D10 83C21B                          add     dx, PO_CR_REG		; PCM out control register
  3355 00000D13 EE                      	out	dx, al
  3356 00000D14 C3                      	retn
  3357                                  
  3358                                  ;=============================================================================
  3359                                  ;               preinitialized data
  3360                                  ;=============================================================================
  3361                                  
  3362                                  ;=============================================================================
  3363                                  ;               PLAY.ASM - DATA
  3364                                  ;=============================================================================
  3365                                  
  3366                                  msg_2017:
  3367 00000D15 54696E79204D4F4420-     		db	'Tiny MOD Player by Erdogan Tan. May 2024.',10,13
  3367 00000D1E 506C61796572206279-
  3367 00000D27 204572646F67616E20-
  3367 00000D30 54616E2E204D617920-
  3367 00000D39 323032342E0A0D     
  3368 00000D40 75736167653A20706C-     		db	'usage: playmod2 filename.mod', 10, 13, '$'
  3368 00000D49 61796D6F6432206669-
  3368 00000D52 6C656E616D652E6D6F-
  3368 00000D5B 640A0D24           
  3369 00000D5F 31382F30322F323031-     		db	'18/02/2017',0
  3369 00000D68 3700               
  3370 00000D6A 30382F30352F323032-     		db	'08/05/2024',0
  3370 00000D73 3400               
  3371                                  
  3372 00000D75 54696E79204D4F4420-     Credits:	db	'Tiny MOD Player v0.1b by Carlos Hasan. July 1993.'
  3372 00000D7E 506C61796572207630-
  3372 00000D87 2E3162206279204361-
  3372 00000D90 726C6F732048617361-
  3372 00000D99 6E2E204A756C792031-
  3372 00000DA2 3939332E           
  3373 00000DA6 0A0D24                  		db	10,13,'$'
  3374 00000DA9 4572726F72206C6F61-     ErrorMesg:	db	'Error loading Module file.',10,13,'$'
  3374 00000DB2 64696E67204D6F6475-
  3374 00000DBB 6C652066696C652E0A-
  3374 00000DC4 0D24               
  3375                                  
  3376                                  ;=============================================================================
  3377                                  ;               MODPLAY.ASM - DATA
  3378                                  ;=============================================================================
  3379                                  
  3380                                  ;Credits:	db	'Amiga Module Player v0.3b by Carlos Hasan.'
  3381                                  
  3382 00000DC6 0019324A62788EA2B4-     SinTable:	db	0,25,50,74,98,120,142,162,180,197,212,225
  3382 00000DCF C5D4E1             
  3383 00000DD2 ECF4FAFEFFFEFAF4EC-     		db	236,244,250,254,255,254,250,244,236,225
  3383 00000DDB E1                 
  3384 00000DDC D4C5B4A28E78624A32-     		db	212,197,180,162,142,120,98,74,50,25
  3384 00000DE5 19                 
  3385                                  
  3386 00000DE6 58032803FA02D002A6-     PeriodTable:	dw	856,808,762,720,678,640,604,570,538,508,480,453
  3386 00000DEF 0280025C023A021A02-
  3386 00000DF8 FC01E001C501       
  3387 00000DFE AC0194017D01680153-     		dw	428,404,381,360,339,320,302,285,269,254,240,226
  3387 00000E07 0140012E011D010D01-
  3387 00000E10 FE00F000E200       
  3388 00000E16 D600CA00BE00B400AA-     		dw	214,202,190,180,170,160,151,143,135,127,120,113
  3388 00000E1F 00A00097008F008700-
  3388 00000E28 7F0078007100       
  3389                                  
  3390                                  ;=============================================================================
  3391                                  ;               PLAYWAV.ASM / PLAYER.ASM - DATA
  3392                                  ;=============================================================================
  3393                                  
  3394                                  ; 24/11/2016
  3395                                  ;	       IRQ  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 
  3396 00000E2E 08090A0B0C0D0E0F70-     irq_int:	db 08h,09h,0Ah,0Bh,0Ch,0Dh,0Eh,0Fh,70h,71h,72h,73h,74h,75h,76h,77h
  3396 00000E37 71727374757677     
  3397                                  
  3398                                  ; 17/02/2017
  3399                                  ; Valid ICH device IDs
  3400                                  
  3401                                  valid_ids:
  3402 00000E3E 86801524                dd	(ICH_DID << 16) + INTEL_VID  	 ; 8086h:2415h
  3403 00000E42 86802524                dd	(ICH0_DID << 16) + INTEL_VID 	 ; 8086h:2425h
  3404 00000E46 86804524                dd	(ICH2_DID << 16) + INTEL_VID 	 ; 8086h:2445h
  3405 00000E4A 86808524                dd	(ICH3_DID << 16) + INTEL_VID 	 ; 8086h:2485h
  3406 00000E4E 8680C524                dd	(ICH4_DID << 16) + INTEL_VID 	 ; 8086h:24C5h
  3407 00000E52 8680D524                dd	(ICH5_DID << 16) + INTEL_VID 	 ; 8086h:24D5h
  3408 00000E56 86806E26                dd	(ICH6_DID << 16) + INTEL_VID 	 ; 8086h:266Eh
  3409 00000E5A 8680A625                dd	(ESB6300_DID << 16) + INTEL_VID  ; 8086h:25A6h
  3410 00000E5E 86809826                dd	(ESB631X_DID << 16) + INTEL_VID  ; 8086h:2698h
  3411 00000E62 8680DE27                dd	(ICH7_DID << 16) + INTEL_VID 	 ; 8086h:27DEh
  3412                                  ; 03/11/2023 - Erdogan Tan
  3413 00000E66 86809571                dd	(MX82440_DID << 16) + INTEL_VID  ; 8086h:7195h
  3414 00000E6A 39101270                dd	(SI7012_DID << 16)  + SIS_VID	 ; 1039h:7012h
  3415 00000E6E DE10B101                dd 	(NFORCE_DID << 16)  + NVIDIA_VID ; 10DEh:01B1h
  3416 00000E72 DE106A00                dd 	(NFORCE2_DID << 16) + NVIDIA_VID ; 10DEh:006Ah
  3417 00000E76 22106D74                dd 	(AMD8111_DID << 16) + AMD_VID 	 ; 1022h:746Dh
  3418 00000E7A 22104574                dd 	(AMD768_DID << 16)  + AMD_VID 	 ; 1022h:7445h
  3419 00000E7E DE105900                dd 	(CK804_DID << 16) + NVIDIA_VID	 ; 10DEh:0059h
  3420 00000E82 DE103A00                dd 	(MCP04_DID << 16) + NVIDIA_VID	 ; 10DEh:003Ah
  3421 00000E86 DE108A00                dd 	(CK8_DID << 16) + NVIDIA_VID	 ; 1022h:008Ah
  3422 00000E8A DE10DA00                dd 	(NFORCE3_DID << 16) + NVIDIA_VID ; 10DEh:00DAh
  3423 00000E8E DE10EA00                dd 	(CK8S_DID << 16) + NVIDIA_VID	 ; 10DEh:00EAh
  3424                                  
  3425                                  valid_id_count:	equ ($ - valid_ids)>>2 ; 05/11/2023
  3426                                  
  3427                                  ; 13/11/2016
  3428 00000E92 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  3428 00000E9B 3941424344454600   
  3429 00000EA3 414339372041756469-     msgAC97Info	db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  3429 00000EAC 6F20436F6E74726F6C-
  3429 00000EB5 6C6572202620436F64-
  3429 00000EBE 656320496E666F0D0A 
  3430 00000EC7 56656E646F72204944-     		db "Vendor ID: "
  3430 00000ED0 3A20               
  3431 00000ED2 303030306820446576-     msgVendorId	db "0000h Device ID: "
  3431 00000EDB 6963652049443A20   
  3432 00000EE3 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  3433 00000EEA 4275733A20              		db "Bus: "
  3434 00000EEF 303068204465766963-     msgBusNo	db "00h Device: "
  3434 00000EF8 653A20             
  3435 00000EFB 3030682046756E6374-     msgDevNo	db "00h Function: "
  3435 00000F04 696F6E3A20         
  3436 00000F09 303068                  msgFncNo	db "00h"
  3437 00000F0C 0D0A                    		db 0Dh, 0Ah
  3438 00000F0E 492F4F204261736520-     		db "I/O Base Address: "
  3438 00000F17 416464726573733A20 
  3439 00000F20 303030306820495251-     msgIOBaseAddr	db "0000h IRQ: "
  3439 00000F29 3A20               
  3440 00000F2B 3030                    msgIRQ		dw 3030h
  3441 00000F2D 0D0A24                  		db 0Dh, 0Ah, "$"
  3442 00000F30 53616D706C65205261-     msgSampleRate	db "Sample Rate: "
  3442 00000F39 74653A20           
  3443 00000F3D 303030303020487A20-     msgHertz	db "00000 Hz ", "$" 
  3443 00000F46 24                 
  3444 00000F47 3820626974732024        msg8Bits	db "8 bits ", "$" 
  3445 00000F4F 4D6F6E6F0D0A24          msgMono		db "Mono", 0Dh, 0Ah, "$"
  3446 00000F56 313620626974732024      msg16Bits	db "16 bits ", "$" 
  3447 00000F5F 53746572656F0D0A24      msgStereo	db "Stereo", 0Dh, 0Ah, "$"
  3448                                  
  3449                                  ;; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
  3450                                  ;codec_id	dd 0
  3451                                  ;codec_chip_id	dd 0
  3452                                  ;codec_vendor_ids dw 0
  3453                                  ;codec_chip_ids	dw 0
  3454                                  
  3455 00000F68 3030303030303030        dword_str	 dd 30303030h, 30303030h
  3456 00000F70 680D0A00                		 db 'h', 0Dh, 0Ah, 0
  3457                                  
  3458                                  ;=============================================================================
  3459                                  ;        	uninitialized data
  3460                                  ;=============================================================================
  3461                                  
  3462                                  bss_start:
  3463                                  
  3464                                  ABSOLUTE bss_start
  3465                                  
  3466                                  alignb 4
  3467                                  
  3468                                  ; 17/02/2017
  3469                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  3470                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  3471                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  3472                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  3473 00000F74 ????                    NAMBAR:		resw 1			; BAR for mixer
  3474 00000F76 ????                    NABMBAR         resw 1			; BAR for bus master regs
  3475                                  
  3476 00000F78 ??                      tBuff:		resb	1
  3477                                  ;irq_status:	resb 	1
  3478 00000F79 ??                      pcm_irq_status:	resb	1 ; 08/05/2024
  3479                                  
  3480 00000F7A ??                      inside:		resb	1 
  3481 00000F7B ??                      tLoop:		resb 	1
  3482                                  
  3483                                  ; 08/05/2024
  3484 00000F7C ????                    IRQ_status:	resw 1	; IRQ status before enabling audio interrupt
  3485 00000F7E ????????                IRQ_vector:	resd 1  ; Previous interrupt handler address	
  3486                                  
  3487                                  ; 256 byte buffer for descriptor list
  3488 00000F82 ????                    BDL_BUFFER:	resw	1		; segment of our 256byte BDL buffer
  3489 00000F84 ????                    DMA_BUFFER1:	resw 	1		; Pointer to 1st half of DMA Buffer
  3490 00000F86 ????                    DMA_BUFFER2:	resw	1		; Pointer to 1st half of DMA Buffer
  3491                                  
  3492                                  ; 12/11/2016 - Erdogan Tan
  3493                                  
  3494 00000F88 ??                      ac97_int_ln_reg: resb 1 
  3495 00000F89 ??                      err_num:	resb 1
  3496                                  
  3497 00000F8A ????????                bus_dev_fn:	resd 1
  3498 00000F8E ????????                dev_vendor:	resd 1
  3499                                  ; 08/05/2024
  3500                                  ;stats_cmd:	resd 1
  3501                                  ;ac97_io_base:	resw 1
  3502 00000F92 ??                      LVI:		resb 1
  3503 00000F93 ??                      		resb 1
  3504                                  alignb 4
  3505                                  
  3506 00000F94 <res 100h>              BdlBuffer:	resb	BDL_SIZE ; 13/02/2017
  3507 00001094 <res 4000h>             DmaBuffer:	resb	2*BUFFERSIZE ; 13/02/2017
  3508                                  
  3509                                  ; MODLOAD.ASM
  3510 00005094 ????                    FileHandle:	resw	1
  3511 00005096 ????                    ErrorInfo:	resw	1
  3512 00005098 <res 43Ch>              Header:		resb	ModHeader.size
  3513                                  
  3514                                  sample_rate: ; PLAYER.ASM (22050Hz)
  3515                                  ; MODPLAY.ASM
  3516 000054D4 ????                    MixSpeed:	resw 1
  3517                                  
  3518                                  ModInfo:
  3519 000054D6 ??                      ModInfo.OrderLen:   resb 1
  3520 000054D7 ??                      ModInfo.ReStart:    resb 1
  3521 000054D8 <res 80h>               ModInfo.Order:	    resb 128
  3522 00005558 ????????                ModInfo.Patterns:   resd 1
  3523                                  
  3524 0000555C <res 3Eh>               ModInfo.SampOfs:    resw 31
  3525 0000559A <res 3Eh>               ModInfo.SampSeg:    resw 31
  3526 000055D8 <res 3Eh>               ModInfo.SampLen:    resw 31
  3527 00005616 <res 3Eh>               ModInfo.SampRep:    resw 31
  3528 00005654 <res 3Eh>               ModInfo.SampRepLen: resw 31
  3529 00005692 <res 3Eh>               ModInfo.SampVol:    resw 31
  3530                                  
  3531                                  ; MODPLAY.ASM
  3532 000056D0 <res 6B2h>              PitchTable:	resw	857
  3533 00005D82 <res 4100h>             VolTable:	resb	16640
  3534 00009E82 <res 1000h>             MixBuffer       resb	MixBufSize
  3535                                  
  3536                                  ; MODPLAY.ASM
  3537 0000AE82 ??                      OrderPos:	resb 1
  3538 0000AE83 ??                      Tempo:		resb 1
  3539 0000AE84 ??                      TempoWait:	resb 1
  3540 0000AE85 ??                      Bpm:		resb 1
  3541 0000AE86 ??                      Row:		resb 1
  3542 0000AE87 ??                      BreakRow:	resb 1
  3543 0000AE88 ????                    BpmSamples:	resw 1
  3544 0000AE8A ????                    BufPtr:		resw 1
  3545 0000AE8C ????                    BufLen:		resw 1
  3546 0000AE8E ????                    BufRep:		resw 1
  3547 0000AE90 ????????                Note:		resd 1
  3548 0000AE94 <res 88h>               Tracks:		resb TrackInfo.size*NumTracks
  3549                                  
  3550 0000AF1C ????????                alignb 16
  3551                                  
  3552                                  ; PLAY.ASM
  3553 0000AF20 <res 280h>              Scope:		resw	320
  3554 0000B1A0 <res 200h>              RowOfs:		resw	256
  3555                                  
  3556                                  ; 18/02/2017
  3557 0000B3A0 ????                    _si_:		resw 1
  3558 0000B3A2 <res 800h>              MOD_BUFFER:	resb BUFFERSIZE/4 ; 2048 ; 11/05/2024
  3559                                  EOF:
