     1                                  ; ****************************************************************************
     2                                  ; playmod3.asm (for MSDOS)
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; PLAYMOD3.COM ! ICH AC97 MOD PLAYER & VGA DEMO program by Erdogan TAN
     5                                  ;
     6                                  ; 18/02/2017
     7                                  ;
     8                                  ; [ Last Modification: 15/05/2024 ]
     9                                  ;
    10                                  ; Derived from source code of 'PLAYWAV.COM' ('PLAYWAV.ASM') by Erdogan Tan
    11                                  ;							      (17/02/2017)
    12                                  ; Modified from 'PLAYMOD2.COM' ('playmod2.asm') source code 
    13                                  ;		 AC97 MOD PLAYER & VGA DEMO program (tuneloop version)
    14                                  ;						by Erdogan TAN (12/05/2024)	
    15                                  ;
    16                                  ; Derived from source code of 'PLAY.EXE' (TINYPLAY) by Carlos Hasan (1993)
    17                                  ;          PLAY.EXE: PLAY.ASM, MODLOAD.ASM, MODPLAY.ASM, SB.ASM
    18                                  ;
    19                                  ; Assembler: NASM 2.15
    20                                  ; ----------------------------------------------------------------------------
    21                                  ;	   nasm  playmod3.asm -l playmod3.lst -o PLAYMOD3.COM	
    22                                  ; ****************************************************************************
    23                                  
    24                                  ; Tiny MOD Player v0.1b by Carlos Hasan.
    25                                  ;		July 14th, 1993.
    26                                  
    27                                  ;=============================================================================
    28                                  ;               PLAYWAV.ASM / PLAYER.ASM / TINYPLAY.ASM
    29                                  ;=============================================================================
    30                                  ; Audio controller, codec & PCI functions are derived from '.wav file player 
    31                                  ; for DOS' source code by Jeff Leyda (PLAYER.EXE), Sep 02, 2002.
    32                                  
    33                                  ; AC97 Interrupt version ; 12/05/2024
    34                                  
    35                                  [BITS 16]
    36                                  [org 100h]
    37                                  
    38                                  Start:
    39                                  	; 15/05/2024
    40                                  	; 13/05/2024
    41                                  	; Clear BSS (uninitialized data) area
    42                                  	;xor	ax, ax ; 0
    43                                  	;mov	cx, (EOF - bss_start)/2
    44                                  	;mov	di, bss_start
    45                                  	;rep	stosw
    46                                  
    47 00000000 E8CC00                  	call    DetectICH		; Detect AC97 Audio Device
    48                                  GetFileName:    			; Parse  the Command line...
    49 00000003 BE8000                  	mov	si, 80h
    50 00000006 8A1C                    	mov	bl, [si]
    51 00000008 30FF                    	xor	bh, bh
    52 0000000A 43                      	inc	bx
    53 0000000B C60000                  	mov	byte [si+bx], 0		; make AsciiZ filename.
    54 0000000E 46                      	inc	si
    55                                  ScanName:       
    56 0000000F AC                      	lodsb
    57 00000010 84C0                    	test	al, al
    58 00000012 0F84AF00                	je	pmsg_2017
    59 00000016 3C20                    	cmp	al, 20h
    60 00000018 74F5                    	je	short ScanName		; scan start of name.
    61 0000001A 89F7                    	mov	di, si
    62 0000001C 4F                      	dec	di
    63                                  ScanPeriod:
    64 0000001D AC                      	lodsb
    65 0000001E 3C2E                    	cmp	al, '.'			; if period NOT found,
    66 00000020 7410                    	je	short PrintMesg		; then add a .MOD extension.
    67 00000022 84C0                    	test	al, al
    68 00000024 75F7                    	jnz	short ScanPeriod
    69 00000026 4E                      	dec	si
    70                                  SetExt:
    71                                  	;mov	byte [si+0], '.'
    72                                  	;mov	byte [si+1], 'M'
    73                                  	;mov	byte [si+2], 'O'
    74                                  	;mov	byte [si+3], 'D'
    75 00000027 66C7042E4D4F44          	mov	dword [si], '.MOD'
    76 0000002E C6440400                	mov	byte [si+4], 0
    77                                  
    78                                  PrintMesg:
    79 00000032 B80009                  	mov	ax, 0900h		; Prints the Credits Text.
    80                                  	;lea	dx, [Credits]
    81 00000035 BA[8D0E]                	mov	dx, Credits
    82 00000038 CD21                    	int	21h
    83                                  
    84                                  	; 13/05/2024
    85 0000003A E8B10C                  	call	write_ac97_dev_info
    86 0000003D B80009                  	mov	ax, 0900h		; Prints the Credits Text.
    87 00000040 BA[BE0E]                	mov	dx, CRLF
    88 00000043 CD21                    	int	21h
    89                                  LoadMod:  
    90                                  	; es:di = Filename address
    91 00000045 06                      	push	es
    92 00000046 57                      	push	di
    93 00000047 E8A605                  	call    LoadModule		; Load the MODule...
    94                                  
    95 0000004A 833E[8261]00            	cmp     word [ErrorInfo], 0	; any error loading?
    96 0000004F 740A                    	je      short init_codec
    97                                  
    98 00000051 B80009                  	mov     ax, 0900h		; yes, print error and Exit.
    99                                  	;lea    dx, [ErrorMesg]
   100 00000054 BA[C10E]                	mov	dx, ErrorMesg
   101 00000057 CD21                    	int     21h
   102 00000059 EB63                    	jmp     Exit
   103                                  
   104                                  init_codec:
   105                                  	; 13/05/2024
   106                                  	;call	write_ac97_dev_info
   107                                  
   108                                  	; 08/05/2024
   109                                  	; 17/02/2017
   110                                  	;mov	dx, [stats_cmd]
   111                                          ;or	dl, IO_ENA+BM_ENA		; enable IO and bus master
   112                                          ;call	pciRegWrite16 ; pciRegWrite8
   113                                  
   114                                  	; 18/02/2017
   115                                  	;mov	word [sample_rate], 22050	; Mixing at 22.050 kHz
   116                                  	; 15/05/2024
   117 0000005B C706[C065]C05D          	mov	word [sample_rate], 24000
   118                                  
   119                                  	; 08/05/2024
   120                                  	; (48 kHZ mixing is necessary 
   121                                  	;  if the AC97 hardware/codec has not got VRA feature)
   122                                  	; ((or frequency converting code would be needed))
   123                                  	;mov	word [sample_rate], 48000	; Mixing at 48 kHz
   124                                  
   125                                  ; setup the Codec (actually mixer registers) 
   126 00000061 E89202                          call    codecConfig			; unmute codec, set rates.
   127 00000064 731A                    	jnc	short PlayNow
   128                                  
   129                                  _codec_err:
   130 00000066 0E                      	push	cs
   131 00000067 1F                      	pop	ds
   132 00000068 BA[7100]                        mov	dx, CodecErrMsg
   133 0000006B B409                            mov     ah, 9
   134 0000006D CD21                            int     21h
   135 0000006F EB4D                            jmp     Exit
   136                                  
   137 00000071 436F64656320457272-     CodecErrMsg db "Codec Error!"
   137 0000007A 6F7221             
   138 0000007D 0D0A24                  	db	CR,LF,"$"
   139                                  PlayNow:  
   140 00000080 B8[8010]                	mov	ax, BdlBuffer
   141 00000083 A3[6210]                	mov	[BDL_BUFFER], ax
   142                                      
   143 00000086 B8[8011]                	mov	ax, DmaBuffer		; DmaBuffer (4096 bytes) buff addr
   144 00000089 A3[6410]                	mov	[DMA_BUFFER1], ax	; 2048 byte half buffer 1 
   145                                  
   146 0000008C 050028                  	add	ax, BUFFERSIZE		; code/current segment
   147 0000008F A3[6610]                	mov	[DMA_BUFFER2], ax	; 2048 byte half buffer 2
   148                                    
   149                                  	;mov    word [MixSpeed], 22050	; Mixing at 22.050 kHz
   150                                  
   151 00000092 E8290B                  	call    StartPlaying
   152                                  
   153 00000095 B81300                  	mov     ax, 0013h		; Set Mode 320x200x256
   154 00000098 CD10                    	int     10h
   155                                  
   156 0000009A B98000                  	mov     cx, 128			; Make a lookup table
   157 0000009D 31DB                    	xor     bx, bx			; for fastest pixel
   158 0000009F BA002D                  	mov     dx, 320*(100-64)	; addressing.
   159                                  MakeOfs:        
   160 000000A2 8997[90C2]              	mov     [RowOfs+bx], dx
   161 000000A6 8997[92C2]              	mov     [RowOfs+bx+2], dx
   162 000000AA 81C24001                	add     dx, 320
   163 000000AE 83C304                  	add     bx, 4
   164 000000B1 E2EF                    	loop    MakeOfs
   165                                  
   166                                  ; Note: Normally IRQ 0 calls the ModPlay Polling at 18.2Hz thru
   167                                  ;       the software interrupt 1Ch. If the IRQ 0 is disabled, then
   168                                  ;       the INT 1Ch MUST BE CALLED at least MixSpeed/1024 times per
   169                                  ;       second, or the module will sound "looped".
   170                                  ;       Because we need better sync with the ModPlayer to draw the scope,
   171                                  ;       the polling is called from my routine, and then the irq 0 must be
   172                                  ;       disabled. The [DmaBuffer] points to the current buffer of 8-bit
   173                                  ;       samples played by the Sound Blaster. Note that some samples are
   174                                  ;       discarded in the next code, just for fun!
   175                                  
   176                                  	;in     al, 21h			; disable irq 0!
   177                                  	;or     al, 00000001b
   178                                  	;out    21h, al
   179                                  		
   180 000000B3 E8F503                  	call	ModPlay ; 13/02/2017
   181                                  
   182                                  	;in	al, 21h			; enable irq 0!
   183                                  	;and	al, 11111110b
   184                                  	;out	21h, al
   185                                  
   186 000000B6 B80300                  	mov     ax, 0003h		; Set Text Mode 80x25x16
   187 000000B9 CD10                    	int     10h
   188                                  
   189 000000BB E8810B                  	call	StopPlaying		; STOP!
   190                                  Exit:           
   191                                  	;call   FreeModule		; Free MODule core.
   192                                  error_exit:
   193 000000BE B8004C                  	mov     ax, 4C00h		; Bye!
   194 000000C1 CD21                    	int     21h
   195                                  here:
   196 000000C3 EBFE                    	jmp	short here
   197                                  
   198                                  pmsg_2017:
   199 000000C5 B80009                  	mov     ax, 0900h		; Prints the Credits Text.
   200                                  	;lea    dx, [msg_2017]
   201 000000C8 BA[2D0E]                	mov	dx, msg_2017
   202 000000CB CD21                    	int     21h
   203 000000CD EBEF                    	jmp	short Exit
   204                                  
   205                                  DetectICH:
   206                                  	; 18/02/2017
   207                                  	; Detech Intel ICH based AC97 Audio Device 
   208 000000CF E8E301                  	call    pciFindDevice 	; AC97.ASM (PLAYWAV.COM)
   209 000000D2 733F                            jnc     short _1
   210                                  
   211                                  ; couldn't find the audio device!
   212                                  	;push	cs
   213                                  	;pop	ds
   214 000000D4 BA[DD00]                        mov     dx, noDevMsg
   215 000000D7 B409                            mov     ah, 9
   216 000000D9 CD21                            int     21h
   217 000000DB EBE1                            jmp     short error_exit
   218                                  
   219 000000DD 4572726F723A20556E-     noDevMsg db "Error: Unable to find Intel ICH based audio device!",CR,LF,"$"
   219 000000E6 61626C6520746F2066-
   219 000000EF 696E6420496E74656C-
   219 000000F8 204943482062617365-
   219 00000101 6420617564696F2064-
   219 0000010A 6576696365210D0A24 
   220                                  
   221                                  _1:
   222                                  	; 18/02/2017
   223                                  	; eax = BUS/DEV/FN
   224                                  	;	00000000BBBBBBBBDDDDDFFF00000000
   225                                  	; edx = DEV/VENDOR
   226                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
   227                                  
   228 00000113 66A3[6A10]              	mov	[bus_dev_fn], eax
   229 00000117 668916[6E10]            	mov	[dev_vendor], edx
   230                                  
   231                                  	; get ICH base address regs for mixer and bus master
   232                                  
   233 0000011C B010                            mov     al, NAMBAR_REG
   234 0000011E E80601                          call    pciRegRead16			; read PCI registers 10-11
   235                                          ;and    dx, IO_ADDR_MASK 		; mask off BIT0
   236                                  	; 14/05/2024
   237 00000121 80E2FE                  	and	dl, 0FEh
   238                                  
   239 00000124 8916[5410]                      mov     [NAMBAR], dx			; save audio mixer base addr
   240                                  
   241 00000128 B014                    	mov     al, NABMBAR_REG
   242 0000012A E8FA00                          call    pciRegRead16
   243                                          ;and    dx, IO_ADDR_MASK
   244                                  	; 14/05/2024
   245 0000012D 80E2C0                  	and	dl, 0C0h
   246                                  
   247 00000130 8916[5610]                      mov     [NABMBAR], dx			; save bus master base addr
   248                                  
   249                                  	; 08/05/2024
   250                                  	; 06/11/2023
   251                                  	;; init controller
   252                                  	;; 17/02/2017
   253                                  	;mov	al, PCI_CMD_REG ; command register (04h)
   254                                  	;call	pciRegRead16 ; pciRegRead8
   255                                  	;
   256                                  	;; eax = BUS/DEV/FN/REG
   257                                  	;;  dx = PCI Command Register Content ; 17/02/2017
   258                                  	;; 	00000000CCCCCCCC
   259                                  	;mov	[stats_cmd], dx
   260                                  	;
   261                                  	; 06/11/2023
   262                                  	;mov	al, PCI_IO_BASE ; IO base address register (10h)
   263                                  	;call	pciRegRead32
   264                                  	;
   265                                  	;and	dx, 0FFC0h	; IO_ADDR_MASK (0FFFE) ?
   266                                          ;mov	[ac97_io_base], dx
   267                                  
   268 00000134 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
   269 00000136 E8E600                  	call	pciRegRead8 ; 17/02/2017
   270                                  
   271 00000139 8816[6810]              	mov     [ac97_int_ln_reg], dl
   272                                  
   273                                  	; 28/11/2016
   274                                  	;mov	bx, 1	; 08/05/2024
   275 0000013D 30F6                    	xor	dh, dh	; 17/02/2017
   276                                  	; 10/11/2023
   277                                  	;mov	cx, dx
   278                                  	;shl	bx, cl
   279                                  
   280                                  	; 04/11/2023
   281 0000013F FA                      	cli
   282                                  
   283                                  	;not	bx
   284 00000140 E4A1                    	in	al, 0A1h ; irq 8-15
   285 00000142 88C4                            mov	ah, al
   286 00000144 E421                            in	al, 21h  ; irq 0-7 
   287                                  
   288                                  	; 04/11/2023
   289                                  	; save IRQ status
   290 00000146 A3[5C10]                	mov	[IRQ_status], ax
   291                                  
   292                                  	; 12/05/2024 (enable AC97 IRQ)
   293                                  	;mov	cl, dl
   294                                  	;mov	bx, 1
   295                                  	;shl	bx, cl
   296                                  	;not	bx
   297                                  	;and	ax, bx
   298                                  	;out	21h, al
   299                                  	;mov	al, ah
   300                                  	;out	0A1h, al
   301                                  
   302                                  	; 15/05/2024
   303                                  	;;and	ax, bx   ; unmask
   304                                   	;btr	ax, dx	 ; unmask
   305                                  	;out	21h, al  ; enable interrupt (if irq <= 7)
   306                                  	;mov	al, ah
   307                                  	;out	0A1h, al ; enable interrupt (if irq > 7)
   308                                  	;;not	bx
   309                                  
   310                                  	; 08/05/2024
   311                                  	;mov	dx, 4D1h			;8259 ELCR1
   312                                          ;in	al, dx
   313                                  	;mov	ah, al
   314                                  	;mov	dx, 4D0h
   315                                          ;in	al, dx
   316                                  	;;or	ax, bx
   317                                  	;bts	ax, cx
   318                                  	;mov	dx, 4D0h
   319                                  	;out	dx, al                          ;set level-triggered mode
   320                                  	;mov	al, ah
   321                                  	;mov	dx, 4D1h
   322                                  	;out	dx, al                          ;set level-triggered mode
   323                                  
   324                                  	; 24/11/2016 - Erdogan Tan
   325                                  	;mov	bx, cx
   326                                  	; 10/11/2023
   327 00000149 89D3                    	mov	bx, dx
   328 0000014B 8A9F[460F]              	mov	bl, [bx+irq_int]
   329 0000014F C1E302                  	shl	bx, 2 ; * 4
   330                                  
   331                                  	; set up interrupt vector
   332                                  	; 30/11/2016
   333 00000152 06                      	push	es
   334 00000153 31C0                    	xor	ax, ax
   335 00000155 8EC0                    	mov	es, ax
   336                                  	; 04/11/2023
   337                                  	; save interrupt vector
   338                                  	;mov	ax, [es:bx]
   339                                  	; 13/05/2024
   340 00000157 B8[6C01]                	mov	ax, ac97_int_handler
   341 0000015A 268707                  	xchg	ax, [es:bx]
   342 0000015D A3[5E10]                	mov	[IRQ_vector], ax
   343                                  	;mov	ax, [es:bx+2]
   344                                  	; 13/05/2024
   345 00000160 8CC8                    	mov	ax, cs
   346 00000162 26874702                	xchg	ax, [es:bx+2]
   347 00000166 A3[6010]                	mov	[IRQ_vector+2], ax
   348                                  
   349                                  	; 13/05/2024
   350                                  	;mov	word [es:bx], ac97_int_handler
   351                                  	;mov	ax, cs
   352                                  	;mov	[es:bx+2], ax
   353                                  	
   354 00000169 07                      	pop	es
   355                                  
   356                                  	; 04/11/2023
   357 0000016A FB                      	sti
   358                                  
   359 0000016B C3                      	retn
   360                                  
   361                                  	; 15/05/2024
   362                                  ac97_int_handler:
   363                                  	; 13/05/2024
   364                                  	; 12/05/2024
   365                                  	; 11/05/2024
   366                                  	; 11/11/2023
   367                                  	; 10/11/2023
   368                                  	; 17/02/2016
   369 0000016C 6650                    	push	eax	; 11/11/2023
   370 0000016E 52                      	push	dx
   371                                  	; 05/11/2023
   372                                  	;push	cx
   373                                  	;push	bx
   374                                  	;push	si
   375                                  	;push	di
   376                                  
   377                                  	; 10/11/2023
   378                                  	; EOI at first
   379 0000016F B020                    	mov	al, 20h
   380 00000171 F606[6810]08            	test	byte [ac97_int_ln_reg], 8
   381 00000176 7402                    	jz	short _ih_0
   382 00000178 E6A0                    	out 	0A0h, al ; 20h	; EOI
   383                                  _ih_0:
   384 0000017A E620                    	out	20h, al  ; 20h	; EOI
   385                                  
   386                                  	; 11/11/2023
   387                                  	; 09/11/2023
   388 0000017C BA3000                  	mov	dx, GLOB_STS_REG
   389 0000017F 0316[5610]                      add	dx, [NABMBAR]
   390 00000183 66ED                    	in	eax, dx
   391                                  
   392                                  	; 12/05/2024
   393                                  	; 09/11/2023
   394                                  	;cmp	eax, 0FFFFFFFFh ; -1
   395                                  	;je	short _ih_3
   396                                  	; 15/05/2024
   397 00000185 6640                    	inc	eax	; 0FFFFFFFFh
   398 00000187 7446                    	jz	short _ih_3
   399 00000189 6648                    	dec	eax	; 0
   400 0000018B 7442                    	jz	short _ih_3
   401                                  
   402                                  	; 15/05/2024
   403 0000018D 803E[5B10]01            	cmp	byte [tLoop], 1
   404 00000192 7239                    	jb	short _ih_2	
   405                                  
   406                                  	; 12/05/2024
   407                                  	;test	al, 40h		; PCM Out Interrupt
   408                                  	; 15/05/2024
   409 00000194 A848                    	test	al, PCM_OUT_IRQ+BCIS
   410 00000196 7502                    	jnz	short _ih_1
   411                                  
   412                                  	; 15/05/2024
   413                                  	;test	eax, eax
   414                                  	;jz	short _ih_3
   415                                  
   416                                  	; 12/05/2024
   417                                  	;test	ax, PCM_OUT_IRQ+BCIS
   418                                  	;jnz	short _ih_1
   419                                  
   420                                   	;mov	dx, GLOB_STS_REG
   421                                          ;add	dx, [NABMBAR]
   422                                  	; 12/05/2024
   423                                  	;out	dx, eax
   424 00000198 EB33                    	jmp	short _ih_2
   425                                  	;jmp	short _ih_3
   426                                  
   427                                  	; .....
   428                                  	;mov	al, 1
   429                                  	; 10/11/2023
   430                                  	;mov	[tLoop], al  ; 1
   431                                  
   432                                  	;cmp	[inside], al ; 1
   433                                  	;jnb	short _ih_2	; busy
   434                                  
   435                                  	;mov	[inside], al ; 1
   436                                  	;
   437                                  	;; 09/11/2023
   438                                          ;mov	dx, [NABMBAR]
   439                                          ;add	dx, PO_SR_REG	; set pointer to Status reg
   440                                  	;in	al, dx
   441                                  	;; 10/11/2023
   442                                  	;;;out	dx, eax
   443                                  	;;out	dx, al		; clear interrupt event
   444                                  	;			; (by writing 1 to same bits)
   445                                  	;
   446                                  	;;mov	[pcm_irq_status], al ; 05/11/2023
   447                                  	;test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
   448                                  	;jz	short _ih_3
   449                                  	; .....
   450                                  
   451                                  _ih_1:
   452                                  	; 11/11/2023
   453                                  	;push	eax
   454                                  	; 15/05/2024
   455 0000019A 50                      	push	ax
   456                                  
   457                                  	; 13/05/2024
   458 0000019B B81C00                  	mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   459 0000019E BA1600                  	mov	dx, PO_SR_REG
   460 000001A1 0316[5610]                      add	dx, [NABMBAR]
   461 000001A5 EF                      	out	dx, ax
   462                                  
   463                                  	; 13/05/2024
   464 000001A6 BA1400                  	mov	dx, PO_CIV_REG
   465 000001A9 0316[5610]                      add	dx, [NABMBAR]
   466 000001AD EC                      	in	al, dx
   467 000001AE 88C4                    	mov	ah, al
   468 000001B0 FEC8                    	dec	al
   469 000001B2 241F                    	and	al, 1Fh
   470 000001B4 BA1500                          mov     dx, PO_LVI_REG
   471 000001B7 0316[5610]                      add	dx, [NABMBAR]
   472 000001BB EE                              out	dx, al
   473 000001BC 80E401                  	and	ah, 1
   474                                  	; 13/05/2024
   475 000001BF FEC4                    	inc	ah
   476 000001C1 8826[5810]              	mov	[tBuff], ah ; 1 = Buffer 1, 2 = Buffer 2
   477                                  
   478                                  	; 13/05/2024
   479                                  	; 10/11/2023
   480                                  	; 28/11/2016 - Erdogan Tan
   481                                  	;call	tuneLoop
   482                                  
   483                                  	; 11/11/2023
   484                                  	;pop	eax
   485                                  	; 15/05/2024
   486 000001C5 58                      	pop	ax	
   487                                  
   488 000001C6 BA3000                  	mov	dx, GLOB_STS_REG
   489 000001C9 0316[5610]                      add	dx, [NABMBAR]
   490                                  _ih_2:			; 12/05/2024
   491 000001CD 66EF                    	out	dx, eax
   492                                  
   493                                  	; 12/05/2024
   494                                  _ih_3:
   495                                  	; 11/11/2023
   496                                  	;mov	dx, [NABMBAR]
   497                                  	;add	dx, PO_SR_REG	; set pointer to Status reg
   498                                  	;mov	ax, 1Ch
   499                                  	;out	dx, ax
   500                                  
   501                                  ;	; 10/11/2023
   502                                  ;	mov	al, 20h
   503                                  ;	test	byte [ac97_int_ln_reg], 8
   504                                  ;	jz	short _ih_3
   505                                  ;	out 	0A0h, al ; 20h	; EOI
   506                                  ;_ih_3:
   507                                  ;	out	20h, al  ; 20h	; EOI
   508                                  ;_ih_4:
   509                                  	;mov	byte [inside], 0
   510                                  	;pop	di
   511                                  	;pop	si
   512                                  	;pop	bx
   513                                  	;pop	cx
   514 000001CF 5A                      	pop	dx
   515 000001D0 6658                    	pop	eax ; 11/11/2023
   516 000001D2 CF                      	iret
   517                                  
   518                                  ;=============================================================================
   519                                  ;               PCI.ASM
   520                                  ;=============================================================================
   521                                  
   522                                  ; EQUATES
   523                                  
   524                                  ;constants of stuff that seem hard to remember at times.
   525                                  
   526                                  TRUE  EQU 1
   527                                  FALSE EQU 0
   528                                  
   529                                  ENABLED  EQU 1
   530                                  DISABLED EQU 0
   531                                  
   532                                  BIT0  EQU 1
   533                                  BIT1  EQU 2
   534                                  BIT2  EQU 4
   535                                  BIT3  EQU 8
   536                                  BIT4  EQU 10h
   537                                  BIT5  EQU 20h
   538                                  BIT6  EQU 40h
   539                                  BIT7  EQU 80h
   540                                  BIT8  EQU 100h
   541                                  BIT9  EQU 200h
   542                                  BIT10 EQU 400h
   543                                  BIT11 EQU 800h
   544                                  BIT12 EQU 1000h
   545                                  BIT13 EQU 2000h
   546                                  BIT14 EQU 4000h
   547                                  BIT15 EQU 8000h
   548                                  BIT16 EQU 10000h
   549                                  BIT17 EQU 20000h
   550                                  BIT18 EQU 40000h
   551                                  BIT19 EQU 80000h
   552                                  BIT20 EQU 100000h
   553                                  BIT21 EQU 200000h
   554                                  BIT22 EQU 400000h
   555                                  BIT23 EQU 800000h
   556                                  BIT24 EQU 1000000h
   557                                  BIT25 EQU 2000000h
   558                                  BIT26 EQU 4000000h
   559                                  BIT27 EQU 8000000h
   560                                  BIT28 EQU 10000000h
   561                                  BIT29 EQU 20000000h
   562                                  BIT30 EQU 40000000h
   563                                  BIT31 EQU 80000000h
   564                                  
   565                                  ;special characters
   566                                  NUL     EQU 0
   567                                  NULL    EQU 0
   568                                  BELL    EQU 07
   569                                  BS      EQU 08
   570                                  TAB     EQU 09
   571                                  LF      EQU 10
   572                                  CR      EQU 13
   573                                  ESCAPE  EQU 27           ;ESC is a reserved word....
   574                                  
   575                                  
   576                                  ;file stuff
   577                                  READONLY  EQU   BIT0
   578                                  HIDDEN    EQU   BIT1
   579                                  SYSTEM    EQU   BIT2
   580                                  VOLUME    EQU   BIT3         ;ignored for file access
   581                                  DIRECTORY EQU   BIT4         ;must be 0 for file access
   582                                  ARCHIVE   EQU   BIT5
   583                                  SHAREABLE EQU   BIT7         ;for novell networks
   584                                  OPEN	EQU	2		; open existing file
   585                                  CREATE	EQU	1		; create new file
   586                                  
   587                                  ; PCI equates
   588                                  ; PCI function address (PFA)
   589                                  ; bit 31 = 1
   590                                  ; bit 23:16 = bus number     (0-255)
   591                                  ; bit 15:11 = device number  (0-31)
   592                                  ; bit 10:8 = function number (0-7)
   593                                  ; bit 7:0 = register number  (0-255)
   594                                  
   595                                  IO_ADDR_MASK    EQU     0FFFEh          ; mask off bit 0 for reading BARs
   596                                  PCI_INDEX_PORT  EQU     0CF8h
   597                                  PCI_DATA_PORT   EQU     0CFCh
   598                                  PCI32           EQU     BIT31           ; bitflag to signal 32bit access
   599                                  PCI16           EQU     BIT30           ; bitflag for 16bit access
   600                                  
   601                                  PCI_FN0         EQU     0 << 8
   602                                  PCI_FN1         EQU     1 << 8
   603                                  PCI_FN2         EQU     2 << 8
   604                                  PCI_FN3         EQU     3 << 8
   605                                  PCI_FN4         EQU     4 << 8
   606                                  PCI_FN5         EQU     5 << 8
   607                                  PCI_FN6         EQU     6 << 8
   608                                  PCI_FN7         EQU     7 << 8
   609                                  
   610                                  PCI_CMD_REG		EQU	04h		; reg 04, command reg
   611                                   IO_ENA			EQU	BIT0		; i/o decode enable
   612                                   MEM_ENA		EQU	BIT1		; memory decode enable
   613                                   BM_ENA                 EQU     BIT2		; bus master enable
   614                                  
   615                                  ; CODE
   616                                  
   617                                  ; AC97.ASM
   618                                  ; PCI device register reader/writers.
   619                                  ; NASM version: Erdogan Tan (29/11/2016)
   620                                  ; 		Last Update: 17/02/2017
   621                                  
   622                                  ;===============================================================
   623                                  ; 8/16/32bit PCI reader
   624                                  ;
   625                                  ; Entry: EAX=PCI Bus/Device/fn/register number
   626                                  ;           BIT30 set if 32 bit access requested
   627                                  ;           BIT29 set if 16 bit access requested
   628                                  ;           otherwise defaults to 8bit read
   629                                  ;
   630                                  ; Exit:  DL,DX,EDX register data depending on requested read size
   631                                  ;
   632                                  ; Note: this routine is meant to be called via pciRegRead8, pciRegread16,
   633                                  ;	or pciRegRead32, listed below.
   634                                  ;
   635                                  ; Note2: don't attempt to read 32bits of data from a non dword aligned reg
   636                                  ;	 number.  Likewise, don't do 16bit reads from non word aligned reg #
   637                                  ; 
   638                                  pciRegRead:
   639 000001D3 6653                    	push	ebx
   640 000001D5 51                      	push	cx
   641 000001D6 6689C3                          mov     ebx, eax                        ; save eax, dh
   642 000001D9 88F1                            mov     cl, dh
   643 000001DB 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   644 000001E1 660D00000080                    or      eax, BIT31                      ; make a PCI access request
   645 000001E7 24FC                            and     al, ~3 ; NOT 3                  ; force index to be dword
   646                                  
   647 000001E9 BAF80C                          mov     dx, PCI_INDEX_PORT
   648 000001EC 66EF                            out     dx, eax                         ; write PCI selector
   649                                  
   650 000001EE BAFC0C                          mov     dx, PCI_DATA_PORT
   651 000001F1 88D8                            mov     al, bl
   652 000001F3 2403                            and     al, 3                           ; figure out which port to
   653 000001F5 00C2                            add     dl, al                          ; read to
   654                                  
   655 000001F7 66ED                    	in      eax, dx                         ; do 32bit read
   656 000001F9 66F7C300000080                  test    ebx, PCI32
   657 00000200 7403                            jz      short _pregr1
   658                                  
   659 00000202 6689C2                          mov     edx, eax                        ; return 32bits of data
   660                                  _pregr1:
   661 00000205 89C2                    	mov     dx, ax                          ; return 16bits of data
   662 00000207 66F7C3000000C0                  test    ebx, PCI32+PCI16
   663 0000020E 7502                            jnz     short _pregr2
   664 00000210 88CE                            mov     dh, cl                          ; restore dh for 8 bit read
   665                                  _pregr2:
   666 00000212 6689D8                          mov     eax, ebx                        ; restore eax
   667 00000215 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   668 0000021B 59                      	pop	cx
   669 0000021C 665B                    	pop	ebx
   670 0000021E C3                      	retn
   671                                  
   672                                  pciRegRead8:
   673 0000021F 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32             ; set up 8 bit read size
   674 00000225 EBAC                            jmp     short pciRegRead		; call generic PCI access
   675                                  
   676                                  pciRegRead16:
   677 00000227 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 16 bit read size
   678 0000022D 660D00000040                    or      eax, PCI16			; call generic PCI access
   679 00000233 EB9E                            jmp     short pciRegRead
   680                                  
   681                                  pciRegRead32:
   682 00000235 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 32 bit read size
   683 0000023B 660D00000080                    or      eax, PCI32			; call generic PCI access
   684 00000241 EB90                            jmp     short pciRegRead
   685                                  
   686                                  ;===============================================================
   687                                  ; 8/16/32bit PCI writer
   688                                  ;
   689                                  ; Entry: EAX=PCI Bus/Device/fn/register number
   690                                  ;           BIT31 set if 32 bit access requested
   691                                  ;           BIT30 set if 16 bit access requested
   692                                  ;           otherwise defaults to 8bit read
   693                                  ;        DL/DX/EDX data to write depending on size
   694                                  ;
   695                                  ;
   696                                  ; note: this routine is meant to be called via pciRegWrite8, pciRegWrite16,
   697                                  ; 	or pciRegWrite32 as detailed below.
   698                                  ;
   699                                  ; Note2: don't attempt to write 32bits of data from a non dword aligned reg
   700                                  ;	 number.  Likewise, don't do 16bit writes from non word aligned reg #
   701                                  ;
   702                                  pciRegWrite:
   703 00000243 6653                    	push	ebx
   704 00000245 51                      	push	cx
   705 00000246 6689C3                          mov     ebx, eax                        ; save eax, dx
   706 00000249 89D1                            mov     cx, dx
   707 0000024B 660D00000080                    or      eax, BIT31                      ; make a PCI access request
   708 00000251 6625FFFFFFBF                    and     eax, ~PCI16 ; NOT PCI16         ; clear out data size request
   709 00000257 24FC                            and     al, ~3 ; NOT 3                  ; force index to be dword
   710                                  
   711 00000259 BAF80C                          mov     dx, PCI_INDEX_PORT
   712 0000025C 66EF                            out     dx, eax                         ; write PCI selector
   713                                  
   714 0000025E BAFC0C                          mov     dx, PCI_DATA_PORT
   715 00000261 88D8                            mov     al, bl
   716 00000263 2403                            and     al, 3                           ; figure out which port to
   717 00000265 00C2                            add     dl, al                          ; write to
   718                                  
   719 00000267 6689D0                          mov     eax, edx                        ; put data into eax
   720 0000026A 89C8                            mov     ax, cx
   721                                  
   722 0000026C EE                              out     dx, al
   723 0000026D 66F7C3000000C0                  test    ebx, PCI16+PCI32                ; only 8bit access? bail
   724 00000274 740C                            jz      short _pregw1
   725                                  
   726 00000276 EF                              out     dx, ax                          ; write 16 bit value
   727 00000277 66F7C300000040                  test    ebx, PCI16                      ; 16bit requested?  bail
   728 0000027E 7502                            jnz     short _pregw1
   729                                  
   730 00000280 66EF                            out     dx, eax                         ; write full 32bit
   731                                  _pregw1:
   732 00000282 6689D8                          mov     eax, ebx                        ; restore eax
   733 00000285 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   734 0000028B 89CA                            mov     dx, cx                          ; restore dx
   735 0000028D 59                      	pop	cx
   736 0000028E 665B                    	pop	ebx
   737 00000290 C3                      	ret
   738                                  
   739                                  pciRegWrite8:
   740 00000291 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 8 bit write size
   741 00000297 EBAA                            jmp     short pciRegWrite		; call generic PCI access
   742                                  
   743                                  pciRegWrite16:
   744 00000299 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 16 bit write size
   745 0000029F 660D00000040                    or      eax, PCI16			; call generic PCI access
   746 000002A5 EB9C                            jmp     short pciRegWrite
   747                                  
   748                                  pciRegWrite32:
   749 000002A7 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 32 bit write size
   750 000002AD 660D00000080                    or      eax, PCI32			; call generic PCI access
   751 000002B3 EB8E                            jmp     short pciRegWrite
   752                                  
   753                                  ; AC97.ASM (PLAYWAV.COM)
   754                                  ; 17/02/2017 (Modifed by Erdogan Tan for various ICH device IDs)
   755                                  ;===============================================================
   756                                  ; PCIFindDevice: scan through PCI space looking for a device+vendor ID
   757                                  ;
   758                                  ;  ENTRY: none
   759                                  ;; Entry: EAX=Device+Vendor ID
   760                                  ;
   761                                  ;  Exit: EAX=PCI address if device found
   762                                  ;	 EDX=Device+Vendor ID
   763                                  ;        CY clear if found, set if not found. EAX invalid if CY set.
   764                                  ;
   765                                  ; [old stackless] Destroys: ebx, esi, edi, cl
   766                                  ;
   767                                  pciFindDevice:
   768                                  	;push	cx
   769                                  	;push	eax ; *
   770                                  	;push	esi
   771                                  	;push	edi
   772                                  
   773                                   	;mov     esi, eax                ; save off vend+device ID
   774                                  
   775                                  	; 17/02/2017
   776 000002B5 BE[560F]                	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
   777 000002B8 B91500                  	mov	cx, valid_id_count
   778                                  pfd_0:
   779 000002BB 66BF00FFFF7F                   	mov     edi, (80000000h - 100h) ; start with bus 0, dev 0 func 0
   780                                  nextPCIdevice:
   781 000002C1 6681C700010000                  add     edi, 100h
   782 000002C8 6681FF00F8FF80                  cmp     edi, 80FFF800h		; scanned all devices?
   783                                          ;stc
   784                                          ;je 	short PCIScanExit       ; not found
   785 000002CF 720D                    	jb	short pfd_1
   786 000002D1 66BF00000080            	mov     edi, 80000000h
   787 000002D7 83C604                  	add	si, 4 ; scan for next device ID
   788 000002DA E202                    	loop	pfd_1	 
   789 000002DC F9                      	stc	
   790                                  	;jmp 	short PCIScanExit
   791 000002DD C3                      	retn
   792                                  pfd_1:
   793 000002DE 6689F8                          mov     eax, edi                ; read PCI registers
   794 000002E1 E851FF                          call    pciRegRead32
   795                                          ;cmp    edx, esi                ; found device?
   796 000002E4 663B14                          cmp	edx, dword [si]
   797 000002E7 75D8                    	jne     short nextPCIdevice
   798                                          ;clc
   799                                  PCIScanExit:
   800                                  	;pushf
   801 000002E9 66B800000080            	mov	eax, BIT31
   802 000002EF 66F7D0                  	not	eax
   803 000002F2 6621F8                  	and	eax, edi		; return only bus/dev/fn #
   804                                  	;popf
   805                                  
   806                                  	;pop	edi
   807                                  	;pop	esi
   808                                  	;pop	edx ; *
   809                                  	;pop	cx
   810 000002F5 C3                      	retn
   811                                  
   812                                  ;=============================================================================
   813                                  ;               CODEC.ASM
   814                                  ;=============================================================================
   815                                  
   816                                  ; EQUATES
   817                                  
   818                                  ;Codec registers.
   819                                  ;
   820                                  ;Not all codecs are created equal. Refer to the spec for your specific codec.
   821                                  ;
   822                                  ;All registers are 16bits wide.  Access to codec registers over the AC97 link
   823                                  ;is defined by the OEM.  
   824                                  ;
   825                                  ;Secondary codec's are accessed by ORing in BIT7 of all register accesses.
   826                                  ;
   827                                  
   828                                  ; each codec/mixer register is 16bits
   829                                  
   830                                  CODEC_RESET_REG                 equ     00      ; reset codec
   831                                  CODEC_MASTER_VOL_REG            equ     02      ; master volume
   832                                  CODEC_HP_VOL_REG                equ     04      ; headphone volume
   833                                  CODEC_MASTER_MONO_VOL_REG       equ     06      ; master mono volume
   834                                  CODEC_MASTER_TONE_REG           equ     08      ; master tone (R+L)
   835                                  CODEC_PCBEEP_VOL_REG            equ     0ah     ; PC beep volume
   836                                  CODEC_PHONE_VOL_REG             equ     0bh     ; phone volume
   837                                  CODEC_MIC_VOL_REG               equ     0eh     ; MIC volume
   838                                  CODEC_LINE_IN_VOL_REG           equ     10h     ; line input volume
   839                                  CODEC_CD_VOL_REG                equ     12h     ; CD volume
   840                                  CODEC_VID_VOL_REG               equ     14h     ; video volume
   841                                  CODEC_AUX_VOL_REG               equ     16h     ; aux volume
   842                                  CODEC_PCM_OUT_REG               equ     18h     ; PCM output volume
   843                                  CODEC_RECORD_SELECT_REG         equ     1ah     ; record select input
   844                                  CODEC_RECORD_VOL_REG            equ     1ch     ; record volume
   845                                  CODEC_RECORD_MIC_VOL_REG        equ     1eh     ; record mic volume
   846                                  CODEC_GP_REG                    equ     20h     ; general purpose
   847                                  CODEC_3D_CONTROL_REG            equ     22h     ; 3D control
   848                                  ; 24h is reserved
   849                                  CODEC_POWER_CTRL_REG            equ     26h     ; powerdown control
   850                                  CODEC_EXT_AUDIO_REG             equ     28h     ; extended audio
   851                                  CODEC_EXT_AUDIO_CTRL_REG        equ     2ah     ; extended audio control
   852                                  CODEC_PCM_FRONT_DACRATE_REG     equ     2ch     ; PCM out sample rate
   853                                  CODEC_PCM_SURND_DACRATE_REG     equ     2eh     ; surround sound sample rate
   854                                  CODEC_PCM_LFE_DACRATE_REG       equ     30h     ; LFE sample rate
   855                                  CODEC_LR_ADCRATE_REG            equ     32h     ; PCM in sample rate
   856                                  CODEC_MIC_ADCRATE_REG           equ     34h     ; mic in sample rate
   857                                  
   858                                  ; registers 36-7a are reserved on the ICH
   859                                  
   860                                  CODEC_VENDORID1_REG             equ     7ch     ; codec vendor ID 1
   861                                  CODEC_VENDORID2_REG             equ     7eh     ; codec vendor ID 2
   862                                  
   863                                  ; Mixer registers 0 through 51h reside in the ICH and are not forwarded over
   864                                  ; the AC97 link to the codec, which I think is a little weird.  Looks like
   865                                  ; the ICH makes it so you don't need a fully functional codec to play audio?
   866                                  ;
   867                                  ; whenever 2 codecs are present in the system, use BIT7 to access the 2nd
   868                                  ; set of registers, ie 80h-feh
   869                                  
   870                                  PRIMARY_CODEC                   equ     0       ; 0-7F for primary codec
   871                                  SECONDARY_CODEC                 equ     BIT7    ; 80-8f registers for 2ndary
   872                                  
   873                                  SAMPLE_RATE_441khz	equ     44100   ; 44.1Khz (cd quality) rate
   874                                  
   875                                  ; ----------------------------------------------------------------------------
   876                                  ; 17/02/2017
   877                                  PCI_IO_BASE	equ 10h			; = NAMBAR register offset
   878                                  AC97_INT_LINE   equ 3Ch			; AC97 Interrupt Line register offset
   879                                  
   880                                  ; ----------------------------------------------------------------------------
   881                                  ; ICH2AC97.INC
   882                                  ; ----------------------------------------------------------------------------
   883                                  
   884                                  ; PCI stuff
   885                                  
   886                                  ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
   887                                  
   888                                  INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
   889                                  
   890                                  ; 08/05/2024
   891                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   892                                  SIS_VID		equ	1039h
   893                                  NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
   894                                  AMD_VID		equ	1022h
   895                                  
   896                                  ICH_DID         equ     2415h           ; ICH device ID
   897                                  ICH0_DID        equ     2425h           ; ICH0
   898                                  ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
   899                                                                          ; they all should be compatible.
   900                                  ; 08/05/2024
   901                                  ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
   902                                  ICH3_DID	equ     2485h           ; ICH3
   903                                  ICH4_DID        equ     24C5h           ; ICH4
   904                                  ICH5_DID	equ     24D5h           ; ICH5 
   905                                  ICH6_DID	equ     266Eh           ; ICH6
   906                                  ESB6300_DID	equ     25A6h           ; 6300ESB
   907                                  ESB631X_DID	equ     2698h           ; 631XESB
   908                                  ICH7_DID	equ	27DEh		; ICH7
   909                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
   910                                  MX82440_DID	equ	7195h
   911                                  SI7012_DID	equ	7012h
   912                                  NFORCE_DID	equ	01B1h
   913                                  NFORCE2_DID	equ	006Ah
   914                                  AMD8111_DID	equ	746Dh
   915                                  AMD768_DID	equ	7445h
   916                                  ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
   917                                  CK804_DID	equ	0059h
   918                                  MCP04_DID	equ	003Ah
   919                                  CK8_DID		equ	008Ah
   920                                  NFORCE3_DID	equ	00DAh
   921                                  CK8S_DID	equ	00EAh
   922                                  
   923                                  NAMBAR_REG      equ     10h             ; native audio mixer BAR
   924                                   NAM_SIZE       equ     256             ; 256 bytes required.
   925                                  
   926                                  NABMBAR_REG     equ     14h             ; native audio bus mastering BAR
   927                                   NABM_SIZE      equ     64              ; 64 bytes
   928                                  
   929                                  ; BUS master registers, accessed via NABMBAR+offset
   930                                  
   931                                  ; ICH supports 3 different types of register sets for three types of things
   932                                  ; it can do, thus:
   933                                  ;
   934                                  ; PCM in (for recording) aka PI
   935                                  ; PCM out (for playback) aka PO
   936                                  ; MIC in (for recording) aka MC
   937                                  
   938                                  PI_BDBAR_REG            equ     0       ; PCM in buffer descriptor BAR
   939                                  PO_BDBAR_REG            equ     10h     ; PCM out buffer descriptor BAR
   940                                  MC_BDBAR_REG            equ     20h     ; MIC in buffer descriptor BAR
   941                                  
   942                                  ; each buffer descriptor BAR holds a pointer which has entries to the buffer
   943                                  ; contents of the .WAV file we're going to play.  Each entry is 8 bytes long
   944                                  ; (more on that later) and can contain 32 entries total, so each BAR is
   945                                  ; 256 bytes in length, thus:
   946                                  
   947                                  BDL_SIZE                equ     32*8    ; Buffer Descriptor List size
   948                                  INDEX_MASK              equ     31      ; indexes must be 0-31
   949                                  
   950                                  
   951                                  
   952                                  PI_CIV_REG              equ     4       ; PCM in current Index value (RO)
   953                                  PO_CIV_REG              equ     14h     ; PCM out current Index value (RO)
   954                                  MC_CIV_REG              equ     24h     ; MIC in current Index value (RO)
   955                                  ;8bit read only
   956                                  ; each current index value is simply a pointer showing us which buffer
   957                                  ; (0-31) the codec is currently processing.  Once this counter hits 31, it
   958                                  ; wraps back to 0.
   959                                  ; this can be handy to know, as once it hits 31, we're almost out of data to
   960                                  ; play back or room to record!
   961                                  
   962                                  
   963                                  PI_LVI_REG              equ     5       ; PCM in Last Valid Index
   964                                  PO_LVI_REG              equ     15h     ; PCM out Last Valid Index
   965                                  MC_LVI_REG              equ     25h     ; MIC in Last Valid Index
   966                                  ;8bit read/write
   967                                  ; The Last Valid Index is a number (0-31) to let the codec know what buffer
   968                                  ; number to stop on after processing.  It could be very nasty to play audio
   969                                  ; from buffers that aren't filled with the audio we want to play.
   970                                  
   971                                  
   972                                  PI_SR_REG               equ     6       ; PCM in Status register
   973                                  PO_SR_REG               equ     16h     ; PCM out Status register
   974                                  MC_SR_REG               equ     26h     ; MIC in Status register
   975                                  ;16bit read/write
   976                                  ; status registers.  Bitfields follow:
   977                                  
   978                                  FIFO_ERR                equ     BIT4    ; FIFO Over/Underrun W1TC.
   979                                  
   980                                  BCIS                    equ     BIT3    ; buffer completion interrupt status.
   981                                                                          ; Set whenever the last sample in ANY
   982                                                                          ; buffer is finished.  Bit is only
   983                                                                          ; set when the Interrupt on Complete
   984                                                                          ; (BIT4 of control reg) is set.
   985                                  
   986                                  LVBCI                   equ     BIT2    ; Set whenever the codec has processed
   987                                                                          ; the last buffer in the buffer list.
   988                                                                          ; Will fire an interrupt if IOC bit is
   989                                                                          ; set. Probably set after the last
   990                                                                          ; sample in the last buffer is
   991                                                                          ; processed.  W1TC
   992                                  
   993                                                                          ; 
   994                                  CELV                    equ     BIT1    ; Current buffer == last valid.
   995                                                                          ; Bit is RO and remains set until LVI is
   996                                                                          ; cleared.  Probably set up the start
   997                                                                          ; of processing for the last buffer.
   998                                  
   999                                  
  1000                                  DCH                     equ     BIT0    ; DMA controller halted.
  1001                                                                          ; set whenever audio stream is stopped
  1002                                                                          ; or something else goes wrong.
  1003                                  
  1004                                  PI_PICB_REG             equ     8       ; PCM in position in current buffer(RO)
  1005                                  PO_PICB_REG             equ     18h     ; PCM out position in current buffer(RO)
  1006                                  MC_PICB_REG             equ     28h     ; MIC in position in current buffer (RO)
  1007                                  ;16bit read only
  1008                                  ; position in current buffer regs show the number of dwords left to be
  1009                                  ; processed in the current buffer.
  1010                                  ; 
  1011                                  
  1012                                  PI_PIV_REG              equ     0ah     ; PCM in Prefected index value
  1013                                  PO_PIV_REG              equ     1ah     ; PCM out Prefected index value
  1014                                  MC_PIV_REG              equ     2ah     ; MIC in Prefected index value
  1015                                  ;8bit, read only
  1016                                  ; Prefetched index value register.
  1017                                  ; tells which buffer number (0-31) has be prefetched.  I'd imagine this
  1018                                  ; value follows the current index value fairly closely. (CIV+1)
  1019                                  ;
  1020                                  
  1021                                  PI_CR_REG               equ     0bh     ; PCM in Control Register
  1022                                  PO_CR_REG               equ     1bh     ; PCM out Control Register
  1023                                  MC_CR_REG               equ     2bh     ; MIC in Control Register
  1024                                  ; 8bit
  1025                                  ; Control register *MUST* only be accessed as an 8bit value.
  1026                                  ; Control register.  See bitfields below.
  1027                                  ;
  1028                                  
  1029                                  IOCE                    equ     BIT4    ; interrupt on complete enable.
  1030                                                                          ; set this bit if you want an intrtpt
  1031                                                                          ; to fire whenever LVBCI is set.
  1032                                  FEIFE                   equ     BIT3    ; set if you want an interrupt to fire
  1033                                                                          ; whenever there is a FIFO (over or
  1034                                                                          ; under) error.
  1035                                  LVBIE                   equ     BIT2    ; last valid buffer interrupt enable.
  1036                                                                          ; set if you want an interrupt to fire
  1037                                                                          ; whenever the completion of the last
  1038                                                                          ; valid buffer.
  1039                                  RR                      equ     BIT1    ; reset registers.  Nukes all regs
  1040                                                                          ; except bits 4:2 of this register.
  1041                                                                          ; Only set this bit if BIT 0 is 0
  1042                                  RPBM                    equ     BIT0    ; Run/Pause
  1043                                                                          ; set this bit to start the codec!
  1044                                  
  1045                                  
  1046                                  GLOB_CNT_REG            equ     2ch     ; Global control register
  1047                                  SEC_RES_EN              equ     BIT5    ; secondary codec resume event 
  1048                                                                          ; interrupt enable.  Not used here.
  1049                                  PRI_RES_EN              equ     BIT4    ; ditto for primary. Not used here.
  1050                                  ACLINK_OFF              equ     BIT3    ; Turn off the AC97 link
  1051                                  ACWARM_RESET            equ     BIT2    ; Awaken the AC97 link from sleep.
  1052                                                                          ; registers preserved, bit self clears
  1053                                  ACCOLD_RESET            equ     BIT1    ; Reset everything in the AC97 and
  1054                                                                          ; reset all registers.  Not self clearing
  1055                                  
  1056                                  GPIIE                   equ     BIT0    ; GPI Interrupt enable.
  1057                                                                          ; set if you want an interrupt to
  1058                                                                          ; fire upon ANY of the bits in the
  1059                                                                          ; GPI (general pursose inputs?) not used.
  1060                                  
  1061                                  GLOB_STS_REG            equ     30h     ; Global Status register (RO)
  1062                                  
  1063                                  MD3                     equ     BIT17   ; modem powerdown status (yawn)
  1064                                  AD3                     equ     BIT16   ; Audio powerdown status (yawn)
  1065                                  RD_COMPLETE_STS         equ     BIT15   ; Codec read timed out. 0=normal
  1066                                  BIT3SLOT12              equ     BIT14   ; shadowed status of bit 3 in slot 12
  1067                                  BIT2SLOT12              equ     BIT13   ; shadowed status of bit 2 in slot 12
  1068                                  BIT1SLOT12              equ     BIT12   ; shadowed status of bit 1 in slot 12
  1069                                  SEC_RESUME_STS          equ     BIT11   ; secondary codec has resumed (and irqed)
  1070                                  PRI_RESUME_STS          equ     BIT10   ; primary codec has resumed (and irqed)
  1071                                  SEC_CODEC_RDY           equ     BIT9    ; secondary codec is ready for action
  1072                                  PRI_CODEC_RDY           equ     BIT8    ; Primary codec is ready for action
  1073                                                                          ; software must check these bits before
  1074                                                                          ; starting the codec!
  1075                                  MIC_IN_IRQ              equ     BIT7    ; MIC in caused an interrupt
  1076                                  PCM_OUT_IRQ             equ     BIT6    ; One of the PCM out channels IRQed
  1077                                  PCM_IN_IRQ              equ     BIT5    ; One of the PCM in channels IRQed
  1078                                  MODEM_OUT_IRQ           equ     BIT2    ; modem out channel IRQed
  1079                                  MODEM_IN_IRQ            equ     BIT1    ; modem in channel IRQed
  1080                                  GPI_STS_CHANGE          equ     BIT0    ; set whenever GPI's have changed.
  1081                                                                          ; BIT0 of slot 12 also reflects this.
  1082                                  
  1083                                  
  1084                                  ACC_SEMA_REG            equ     34h     ; Codec write semiphore register
  1085                                  CODEC_BUSY              equ     BIT0    ; codec register I/O is happening
  1086                                                                          ; self clearing
  1087                                  ;
  1088                                  ; Buffer Descriptors List
  1089                                  ; As stated earlier, each buffer descriptor list is a set of (up to) 32 
  1090                                  ; descriptors, each 8 bytes in length.  Bytes 0-3 of a descriptor entry point
  1091                                  ; to a chunk of memory to either play from or record to.  Bytes 4-7 of an
  1092                                  ; entry describe various control things detailed below.
  1093                                  ; 
  1094                                  ; Buffer pointers must always be aligned on a Dword boundry.
  1095                                  ;
  1096                                  ;
  1097                                  
  1098                                  IOC                     equ     BIT31   ; Fire an interrupt whenever this
  1099                                                                          ; buffer is complete.
  1100                                  
  1101                                  BUP                     equ     BIT30   ; Buffer Underrun Policy.
  1102                                                                          ; if this buffer is the last buffer
  1103                                                                          ; in a playback, fill the remaining
  1104                                                                          ; samples with 0 (silence) or not.
  1105                                                                          ; It's a good idea to set this to 1
  1106                                                                          ; for the last buffer in playback,
  1107                                                                          ; otherwise you're likely to get a lot
  1108                                                                          ; of noise at the end of the sound.
  1109                                  
  1110                                  ;
  1111                                  ; Bits 15:0 contain the length of the buffer, in number of samples, which
  1112                                  ; are 16 bits each, coupled in left and right pairs, or 32bits each.
  1113                                  ; Luckily for us, that's the same format as .wav files.
  1114                                  ;
  1115                                  ; A value of FFFF is 65536 samples.  Running at 44.1Khz, that's just about
  1116                                  ; 1.5 seconds of sample time.  FFFF * 32bits is 1FFFFh bytes or 128k of data.
  1117                                  ;
  1118                                  ; A value of 0 in these bits means play no samples.
  1119                                  ;
  1120                                  
  1121                                  ; CODE
  1122                                  
  1123                                  ; AC97.ASM
  1124                                  
  1125                                  ; codec configuration code.  Not much here really.
  1126                                  ; NASM version: Erdogan Tan (29/11/2016)
  1127                                  
  1128                                  ; enable codec, unmute stuff, set output rate to 44.1
  1129                                  ; entry: ax = desired sample rate
  1130                                  ;
  1131                                  	
  1132                                  	; 15/05/2024
  1133                                  	; 12/05/2024
  1134                                  	; 08/05/2024
  1135                                  	; (ac97_vra.asm, 19/11/2023, Erdogan Tan, playwav3.asm) 
  1136                                  codecConfig:
  1137                                  	; 02/12/2023
  1138                                  	; 26/11/2023
  1139                                  	; 21/11/2023
  1140                                  	; 20/11/2023
  1141                                  	; 19/11/2023 (TRDOS 386 v2.0.7)
  1142                                  	; 15/11/2023
  1143                                  	; 04/11/2023
  1144                                  	; 17/02/2017 
  1145                                  	; 07/11/2016 (Erdogan Tan)
  1146                                  	;PORT_NABM_GLB_CTRL_STAT equ 60h
  1147                                  
  1148                                  	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
  1149                                   	; 'AC97_DEF.H'
  1150                                  	;AC97_EXTENDED_STATUS equ 002Ah
  1151                                  	AC97_EA_SPDIF	equ 0002h
  1152                                  	AC97_EA_VRA	equ 0001h
  1153                                  	; 04/11/2023
  1154                                  	ICH_PO_CR_RESET equ 0002h  ; reset codec
  1155                                  	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
  1156                                  	ICH_PCM_246_MASK equ 300000h ; 6 channels
  1157                                  
  1158                                  	; 08/05/2024
  1159                                  	; 11/11/2023
  1160                                  	CTRL_ST_CREADY	equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
  1161                                  	CODEC_REG_POWERDOWN equ	26h
  1162                                  
  1163                                  	; 04/11/2023
  1164                                  init_ac97_controller:
  1165 000002F6 66A1[6A10]              	mov	eax, [bus_dev_fn]
  1166 000002FA B004                    	mov	al, PCI_CMD_REG
  1167 000002FC E828FF                  	call	pciRegRead16		; read PCI command register
  1168 000002FF 80CA05                  	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
  1169 00000302 E894FF                  	call	pciRegWrite16
  1170                                  
  1171                                  	; 14/05/2024
  1172                                  	; 02/12/2023
  1173 00000305 E89801                  	call	delay_100ms ; 29/05/2017
  1174                                  
  1175                                  	; 02/12/2023
  1176                                  	;call	delay1_4ms
  1177                                  	;call	delay1_4ms
  1178                                  	;call	delay1_4ms
  1179                                  	;call	delay1_4ms
  1180                                  
  1181                                  init_ac97_codec:
  1182                                  	; 18/11/2023
  1183 00000308 BD2800                  	mov	bp, 40
  1184                                  	; 14/05/2024
  1185                                  	;mov	bp, 100
  1186                                  _initc_1:
  1187                                  	; 11/11/2023
  1188                                  	; (TRDOS 386 v2.0.5, 'audio.s')
  1189 0000030B BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1190 0000030E 0316[5610]              	add	dx, [NABMBAR]
  1191 00000312 66ED                    	in	eax, dx
  1192                                  
  1193                                  	; 02/12/2023
  1194 00000314 E84F09                  	call	delay1_4ms
  1195                                  
  1196                                  	; ?
  1197                                  	;; 15/11/2023
  1198                                  	;;mov	cx, 40
  1199                                  	;mov	bp, 40 ; 18/11/2023
  1200                                  ;_initc_1:
  1201 00000317 BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1202 0000031A 0316[5610]              	add	dx, [NABMBAR]
  1203 0000031E 66ED                    	in	eax, dx
  1204                                  
  1205                                  	; 02/12/2023
  1206 00000320 E84309                  	call	delay1_4ms
  1207                                  
  1208 00000323 6683F8FF                	cmp	eax, 0FFFFFFFFh ; -1
  1209                                  	;je	short init_ac97_codec_err1
  1210                                  	; 15/11/2023
  1211 00000327 7508                    	jne	short _initc_3
  1212                                  _initc_2:
  1213                                  	;dec	cx
  1214 00000329 4D                      	dec	bp	; 18/11/2023
  1215                                  	;jz	short init_ac97_codec_err1
  1216                                  	; 19/11/2023
  1217 0000032A 7412                    	jz	short _ac97_codec_ready
  1218                                  
  1219 0000032C E87101                  	call	delay_100ms
  1220 0000032F EBDA                    	jmp	short _initc_1
  1221                                  _initc_3:
  1222 00000331 66A900030010            	test	eax, CTRL_ST_CREADY
  1223 00000337 7505                    	jnz	short _ac97_codec_ready
  1224                                  
  1225 00000339 E8E400                  	call	reset_ac97_codec
  1226                                  	; 11/11/2023
  1227                                  	;jc	short init_ac97_codec_err2
  1228                                  	; 15/11/2023
  1229                                  	;jc	short _initc_2
  1230                                  	; 26/11/2023
  1231 0000033C EBEB                    	jmp	short _initc_2
  1232                                  
  1233                                  _ac97_codec_ready:
  1234 0000033E 8B16[5410]              	mov	dx, [NAMBAR]
  1235                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  1236 00000342 EF                      	out	dx, ax
  1237                                  
  1238 00000343 E85A01                  	call	delay_100ms
  1239                                  
  1240                                  	; 19/11/2023
  1241 00000346 09ED                    	or	bp, bp
  1242 00000348 7522                    	jnz	short _ac97_codec_init_ok
  1243                                  
  1244 0000034A 6631C0                  	xor	eax, eax ; 0
  1245 0000034D 8B16[5410]              	mov	dx, [NAMBAR]
  1246 00000351 83C226                  	add	dx, CODEC_REG_POWERDOWN
  1247 00000354 EF                      	out	dx, ax
  1248                                  	
  1249                                  	; 19/11/2023
  1250                                  	; wait for 1 second
  1251                                  	; 15/05/2024
  1252 00000355 66B9E8030000            	mov	ecx, 1000 ; 1000*4*0.25ms = 1s
  1253                                  	;mov	cx, 10
  1254                                  _ac97_codec_rloop:
  1255                                  	;call	delay1_4ms
  1256                                  	;call	delay1_4ms
  1257                                  	;call	delay1_4ms
  1258                                  	;call	delay1_4ms
  1259 0000035B E84201                  	call	delay_100ms
  1260                                  
  1261                                  	;mov	dx, [NAMBAR]
  1262                                  	;add	dx, CODEC_REG_POWERDOWN
  1263 0000035E ED                      	in	ax, dx
  1264                                  
  1265                                  	; 14/05/2024
  1266                                  	; 02/12/2023
  1267 0000035F E80409                  	call	delay1_4ms
  1268                                  	
  1269 00000362 83E00F                  	and	ax, 0Fh
  1270 00000365 3C0F                    	cmp	al, 0Fh
  1271 00000367 7403                    	je	short _ac97_codec_init_ok
  1272 00000369 E2F0                    	loop	_ac97_codec_rloop 
  1273                                  
  1274                                  	; 12/05/2024
  1275                                  	; cf = 1
  1276                                  init_ac97_codec_err1:
  1277                                  	;stc	; 12/05/2024
  1278                                  init_ac97_codec_err2:
  1279 0000036B C3                      	retn
  1280                                  
  1281                                  _ac97_codec_init_ok:
  1282                                          ; 11/11/2023
  1283                                  	;mov	al, 2 ; force set 16-bit 2-channel PCM
  1284                                  	;mov	dx, GLOB_CNT_REG ; 2Ch
  1285                                  	;add	dx, [NABMBAR]
  1286                                  	;out	dx, eax
  1287                                  
  1288                                  	;;call	delay1_4ms
  1289                                  
  1290 0000036C E86A00                  	call 	reset_ac97_controller
  1291                                  
  1292                                  	; 11/11/2023
  1293                                  	;call	delay1_4ms
  1294                                  	; 21/11/2023 - temporary
  1295 0000036F E82E01                  	call	delay_100ms
  1296                                  
  1297                                  	;call 	setup_ac97_codec
  1298                                  
  1299                                  setup_ac97_codec:
  1300                                  	; 08/05/2028
  1301                                  	; [sample_rate] = 22050
  1302                                  	; 12/11/2023
  1303                                  	;cmp	word [sample_rate], 48000
  1304                                  	;je	short skip_rate
  1305                                  
  1306                                  ; 11/11/2023
  1307                                  ; 05/11/2023
  1308                                  ;%if 1
  1309                                  	AC97_EA_VRA equ BIT0 ; 11/11/2023
  1310                                  
  1311                                  	; 11/11/2023
  1312 00000372 8B16[5410]              	mov    	dx, [NAMBAR]               	
  1313 00000376 83C22A                  	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah  	  
  1314 00000379 ED                      	in     	ax, dx
  1315                                  
  1316                                  	; 02/12/2023
  1317 0000037A E8E908                  	call	delay1_4ms
  1318                                  
  1319                                  	; 15/05/2024
  1320 0000037D A801                    	test	al, 1 ; BIT0 ; Variable Rate Audio bit
  1321 0000037F 7412                    	jz	short vra_not_supported
  1322                                  
  1323 00000381 24FD                    	and	al, ~BIT1 ; Clear DRA
  1324 00000383 0C01                    	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
  1325 00000385 EF                      	out	dx, ax			; Enable variable rate audio
  1326                                  	
  1327 00000386 B90A00                  	mov	cx, 10
  1328                                  check_vra:
  1329 00000389 E81401                  	call	delay_100ms
  1330                                  
  1331                                  	; 11/11/2023
  1332 0000038C ED                      	in	ax, dx
  1333 0000038D A801                    	test	al, AC97_EA_VRA ; 1
  1334 0000038F 750A                    	jnz	short set_rate
  1335                                  
  1336                                  	; 11/11/2023
  1337 00000391 E2F6                    	loop	check_vra
  1338                                  
  1339                                  	; 13/11/2023
  1340                                  	;mov	byte [VRA], 0
  1341                                  vra_not_supported:
  1342                                  	; 08/05/2024
  1343 00000393 C706[C065]80BB          	mov	word [sample_rate], 48000
  1344 00000399 EB0E                    	jmp	short skip_rate	
  1345                                  
  1346                                  	; 12/11/2023
  1347                                  	;pop	ax ; discard return address to the caller
  1348                                  	;mov	dx, msg_no_vra
  1349                                  	;jmp	vra_err
  1350                                  
  1351                                  set_rate:
  1352 0000039B A1[C065]                	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
  1353                                  	; 08/05/2024
  1354                                  	; ax = 22050 (Hz)
  1355                                  
  1356 0000039E 8B16[5410]              	mov    	dx, [NAMBAR]               	
  1357 000003A2 83C22C                  	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
  1358 000003A5 EF                      	out	dx, ax 			; PCM Front/Center Output Sample Rate
  1359                                  
  1360 000003A6 E8F700                  	call	delay_100ms
  1361                                  
  1362                                  	; 12/11/2023
  1363                                  skip_rate:
  1364                                  	; 11/11/2023 (temporary)
  1365                                  
  1366                                  	;mov   	dx, [NAMBAR]               	
  1367                                  	;add   	dx, CODEC_PCM_SURND_DACRATE_REG	; 2Eh  	  
  1368                                  	;out	dx, ax 			; PCM Surround Output Sample Rate
  1369                                  
  1370                                  	;call	delay_100ms
  1371                                  
  1372                                  	;mov   	dx, [NAMBAR]               	
  1373                                  	;add   	dx, CODEC_PCM_LFE_DACRATE_REG	; 30h  	  
  1374                                  	;out	dx, ax 			; PCM LFE Output Sample Rate
  1375                                  
  1376                                  	;call	delay_100ms
  1377                                  
  1378                                  	; 05/11/2023 (temporary)
  1379                                  	;mov	dx, [NAMBAR]               	
  1380                                  	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
  1381                                  	;out	dx, ax 			; PCM Input Sample Rate
  1382                                  	;
  1383                                  	;call	delay_100ms
  1384                                  
  1385 000003A9 B80202                  	mov	ax, 0202h
  1386 000003AC A2[7310]                	mov	[volume], al ; 29
  1387 000003AF 8B16[5410]              	mov     dx, [NAMBAR]
  1388 000003B3 83C202                    	add     dx, CODEC_MASTER_VOL_REG	;02h 
  1389 000003B6 EF                      	out     dx, ax
  1390                                  
  1391                                  	; 11/11/2023
  1392                                          ;call	delay1_4ms
  1393                                          ;call	delay1_4ms
  1394                                          ;call	delay1_4ms
  1395                                          ;call	delay1_4ms
  1396                                   	;
  1397                                    	;mov	dx, [NAMBAR]
  1398                                    	;add	dx, CODEC_MASTER_MONO_VOL_REG	;06h 
  1399                                    	;out	dx, ax
  1400                                  
  1401                                  	; 11/11/2023
  1402                                          ;call	delay1_4ms
  1403                                          ;call	delay1_4ms
  1404                                          ;call	delay1_4ms
  1405                                          ;call	delay1_4ms
  1406                                  	;
  1407                                  	;mov	ax, 02h
  1408                                    	;mov	dx, [NAMBAR]
  1409                                    	;add	dx, CODEC_PCBEEP_VOL_REG	;0Ah 
  1410                                    	;out	dx, ax
  1411                                  
  1412                                  	; 14/05/2024
  1413                                  	; 20/11/2023
  1414 000003B7 E8AC08                          call	delay1_4ms
  1415 000003BA E8A908                          call	delay1_4ms
  1416 000003BD E8A608                          call	delay1_4ms
  1417 000003C0 E8A308                          call	delay1_4ms
  1418                                  
  1419                                  	; 21/11/2023 temporary
  1420                                  	;call	delay_100ms
  1421                                  
  1422                                  	;mov	ax, 0202h
  1423 000003C3 8B16[5410]                	mov     dx, [NAMBAR]
  1424 000003C7 83C218                    	add     dx, CODEC_PCM_OUT_REG		;18h 
  1425 000003CA EF                        	out     dx, ax
  1426                                  
  1427                                  	; 14/05/2024
  1428                                  	; 20/11/2023
  1429 000003CB E89808                          call	delay1_4ms
  1430 000003CE E89508                          call	delay1_4ms
  1431 000003D1 E89208                          call	delay1_4ms
  1432 000003D4 E88F08                          call	delay1_4ms
  1433                                  
  1434                                  	; 14/05/2024
  1435                                  	; 21/11/2023 - temporary
  1436                                  	;call	delay_100ms
  1437                                  
  1438                                  	; 11/11/2023
  1439                                  	;mov	ax, 8008h ; Mute
  1440                                    	;mov	dx, [NAMBAR]
  1441                                  	;add	dx, CODEC_PHONE_VOL_REG		;0Ch
  1442                                  	;			 ; AC97_PHONE_VOL ; TAD Input (Mono)
  1443                                    	;out	dx, ax
  1444                                  	;
  1445                                          ;call	delay1_4ms
  1446                                          ;call	delay1_4ms
  1447                                          ;call	delay1_4ms
  1448                                  	;call	delay1_4ms
  1449                                  
  1450                                  	;mov	ax, 0808h
  1451                                  	;mov	dx, [NAMBAR]
  1452                                  	;add	dx, CODEC_LINE_IN_VOL_REG ;10h ; Line Input (Stereo)
  1453                                  	;out	dx, ax
  1454                                  	;
  1455                                          ;call	delay1_4ms
  1456                                          ;call	delay1_4ms
  1457                                          ;call	delay1_4ms
  1458                                  	;call	delay1_4ms
  1459                                  
  1460                                    	;mov	dx, [NAMBAR]
  1461                                          ;add	dx, CODEC_CD_VOL_REG ;12h ; CD Input (Stereo)
  1462                                    	;out	dx, ax
  1463                                  	;
  1464                                    	;mov	dx, [NAMBAR]
  1465                                          ;add	dx, CODEC_AUX_VOL_REG ;16h ; Aux Input (Stereo)
  1466                                    	;out	dx, ax
  1467                                  	;
  1468                                          ;call	delay1_4ms
  1469                                          ;call	delay1_4ms
  1470                                          ;call	delay1_4ms
  1471                                  	;call	delay1_4ms
  1472                                  
  1473                                  	; 14/05/2024
  1474                                  	;call	delay_100ms
  1475                                  
  1476                                  	; 14/05/2024
  1477 000003D7 F8                      	clc
  1478                                  
  1479                                  ;detect_ac97_codec:
  1480 000003D8 C3                              retn
  1481                                  
  1482                                  reset_ac97_controller:
  1483                                  	; 11/11/2023
  1484                                  	; 10/06/2017
  1485                                  	; 29/05/2017
  1486                                  	; 28/05/2017
  1487                                  	; reset AC97 audio controller registers
  1488 000003D9 31C0                    	xor     ax, ax
  1489 000003DB BA0B00                          mov	dx, PI_CR_REG
  1490 000003DE 0316[5610]              	add	dx, [NABMBAR]
  1491 000003E2 EE                      	out     dx, al
  1492                                  
  1493                                  	; 14/05/2024
  1494 000003E3 E88008                  	call	delay1_4ms
  1495                                  
  1496 000003E6 BA1B00                          mov     dx, PO_CR_REG
  1497 000003E9 0316[5610]              	add	dx, [NABMBAR]
  1498 000003ED EE                      	out     dx, al
  1499                                  
  1500                                  	; 14/05/2024
  1501 000003EE E87508                  	call	delay1_4ms
  1502                                  
  1503 000003F1 BA2B00                          mov     dx, MC_CR_REG
  1504 000003F4 0316[5610]              	add	dx, [NABMBAR]
  1505 000003F8 EE                      	out     dx, al
  1506                                  
  1507                                  	; 14/05/2024
  1508 000003F9 E86A08                  	call	delay1_4ms
  1509                                  
  1510 000003FC B002                            mov     al, RR
  1511 000003FE BA0B00                          mov     dx, PI_CR_REG
  1512 00000401 0316[5610]              	add	dx, [NABMBAR]
  1513 00000405 EE                      	out     dx, al
  1514                                  
  1515                                  	; 14/05/2024
  1516 00000406 E85D08                  	call	delay1_4ms
  1517                                  
  1518 00000409 BA1B00                          mov     dx, PO_CR_REG
  1519 0000040C 0316[5610]              	add	dx, [NABMBAR]
  1520 00000410 EE                      	out     dx, al
  1521                                  
  1522                                  	; 14/05/2024
  1523 00000411 E85208                  	call	delay1_4ms
  1524                                  
  1525 00000414 BA2B00                          mov     dx, MC_CR_REG
  1526 00000417 0316[5610]              	add	dx, [NABMBAR]
  1527 0000041B EE                      	out     dx, al
  1528                                  
  1529                                  	; 14/05/2024
  1530 0000041C E84708                  	call	delay1_4ms
  1531                                  
  1532 0000041F C3                      	retn
  1533                                  
  1534                                  reset_ac97_codec:
  1535                                  	; 11/11/2023
  1536                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1537 00000420 BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1538 00000423 0316[5610]              	add	dx, [NABMBAR]
  1539 00000427 66ED                    	in	eax, dx
  1540                                  
  1541                                  	;test	eax, 2
  1542                                  	; 06/08/2022
  1543 00000429 A802                    	test	al, 2
  1544 0000042B 7405                    	jz	short _r_ac97codec_cold	
  1545                                  
  1546 0000042D E80E00                  	call	warm_ac97codec_reset
  1547 00000430 7306                    	jnc	short _r_ac97codec_ok
  1548                                  _r_ac97codec_cold:
  1549 00000432 E83400                          call    cold_ac97codec_reset
  1550 00000435 7301                            jnc     short _r_ac97codec_ok
  1551                                  	
  1552                                  	; 16/04/2017
  1553                                          ;xor	eax, eax	; timeout error
  1554                                         	;stc
  1555 00000437 C3                      	retn
  1556                                  
  1557                                  _r_ac97codec_ok:
  1558 00000438 6631C0                          xor     eax, eax
  1559                                          ;mov	al, VIA_ACLINK_C00_READY ; 1
  1560 0000043B FEC0                            inc	al
  1561 0000043D C3                      	retn
  1562                                  
  1563                                  warm_ac97codec_reset:
  1564                                  	; 11/11/2023
  1565                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  1566                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1567 0000043E 66B806000000            	mov	eax, 6
  1568 00000444 BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1569 00000447 0316[5610]              	add	dx, [NABMBAR]
  1570 0000044B 66EF                    	out	dx, eax
  1571                                  
  1572 0000044D B90A00                  	mov	cx, 10	; total 1s
  1573                                  _warm_ac97c_rst_wait:
  1574 00000450 E84D00                  	call	delay_100ms
  1575                                  
  1576 00000453 BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1577 00000456 0316[5610]              	add	dx, [NABMBAR]
  1578 0000045A 66ED                    	in	eax, dx
  1579                                  
  1580 0000045C 66A900030010            	test	eax, CTRL_ST_CREADY
  1581 00000462 7504                    	jnz	short _warm_ac97c_rst_ok
  1582                                  
  1583 00000464 49                              dec     cx
  1584 00000465 75E9                            jnz     short _warm_ac97c_rst_wait
  1585                                  
  1586                                  _warm_ac97c_rst_fail:
  1587 00000467 F9                              stc
  1588                                  _warm_ac97c_rst_ok:
  1589 00000468 C3                      	retn
  1590                                  
  1591                                  cold_ac97codec_reset:
  1592                                  	; 11/11/2023
  1593                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  1594                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1595 00000469 66B802000000                    mov	eax, 2
  1596 0000046F BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1597 00000472 0316[5610]              	add	dx, [NABMBAR]
  1598 00000476 66EF                    	out	dx, eax
  1599                                  
  1600 00000478 E82500                  	call	delay_100ms 	; wait 100 ms
  1601 0000047B E82200                  	call	delay_100ms 	; wait 100 ms
  1602 0000047E E81F00                  	call	delay_100ms 	; wait 100 ms
  1603 00000481 E81C00                  	call	delay_100ms 	; wait 100 ms
  1604                                  
  1605 00000484 B91000                  	mov	cx, 16	; total 20*100 ms = 2s
  1606                                  
  1607                                  _cold_ac97c_rst_wait:
  1608 00000487 BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1609 0000048A 0316[5610]              	add	dx, [NABMBAR]
  1610 0000048E 66ED                    	in	eax, dx
  1611                                  
  1612 00000490 66A900030010            	test	eax, CTRL_ST_CREADY
  1613 00000496 7507                    	jnz	short _cold_ac97c_rst_ok
  1614                                  
  1615 00000498 E80500                  	call	delay_100ms
  1616                                  
  1617 0000049B 49                              dec     cx
  1618 0000049C 75E9                            jnz     short _cold_ac97c_rst_wait
  1619                                  
  1620                                  _cold_ac97c_rst_fail:
  1621 0000049E F9                              stc
  1622                                  _cold_ac97c_rst_ok:
  1623 0000049F C3                      	retn
  1624                                  
  1625                                  delay_100ms:
  1626                                  	; 11/11/2023
  1627                                  	; 29/05/2017
  1628                                  	; 24/03/2017 ('codec.asm')
  1629                                  	; wait 100 ms
  1630 000004A0 51                      	push	cx
  1631 000004A1 B99001                  	mov	cx, 400  ; 400*0.25ms
  1632                                  _delay_x_ms:
  1633 000004A4 E8BF07                  	call	delay1_4ms
  1634 000004A7 E2FB                            loop	_delay_x_ms
  1635 000004A9 59                      	pop	cx
  1636 000004AA C3                      	retn
  1637                                  
  1638                                  ;=============================================================================
  1639                                  ;               ICH_WAV.ASM
  1640                                  ;=============================================================================
  1641                                  
  1642                                  ; DOS based .WAV player using AC'97 and codec interface.
  1643                                  ; ---------------------------------------------------------------
  1644                                  ; NASM version: Erdogan Tan (29/11/2016)
  1645                                  ; Last Update: 17/02/2017 (by Erdogan Tan)
  1646                                  
  1647                                  ; ICHWAV.ASM
  1648                                  ; PLAYMOD.ASM
  1649                                  ; player internal variables and other equates.
  1650                                  ;BUFFERSIZE	equ	2048*4		; 8K half buffer size. 18/02/2017
  1651                                  ; 15/05/2024
  1652                                  BUFFERSIZE	equ	2560*4
  1653                                  ;ENDOFFILE	equ	BIT0		; flag for knowing end of file
  1654                                  
  1655                                  ;===========================================================================
  1656                                  ; entry: none.  File is already open and [filehandle] filled.
  1657                                  ; exit:  not until the song is finished or the user aborts.
  1658                                  ;
  1659                                  ; 18/02/2017
  1660                                  ModPlay: ; 13/02/2017  ; ModPlay Polling!
  1661                                  	;cld
  1662                                  	; clear (half) buffer 2
  1663                                         	;mov	di, [DMA_BUFFER2]
  1664                                  	;sub	ax, ax
  1665                                  	;mov	cx, (BUFFERSIZE/2)
  1666                                  	;rep	stosw
  1667                                  
  1668                                  	; 15/05/2024
  1669 000004AB 06                      	push	es
  1670 000004AC 1E                      	push	ds
  1671 000004AD 07                      	pop	es
  1672 000004AE B94001                  	mov	cx, 320
  1673 000004B1 BF[92C4]                	mov	di, MOD_BUFFER
  1674 000004B4 B88080                  	mov	ax, 8080h
  1675 000004B7 F3AB                    	rep	stosw
  1676 000004B9 B900A0                  	mov	cx, 0A000h
  1677 000004BC 8EC1                    	mov	es, cx
  1678 000004BE E8FC00                  	call	ScopeLoop
  1679 000004C1 07                      	pop	es
  1680                                  	
  1681                                          ; load 2048 bytes into buffer 1
  1682 000004C2 8B36[6410]              	mov	si, [DMA_BUFFER1]
  1683                                  	; 11/05/2024
  1684                                  	;mov	cx, BUFFERSIZE
  1685                                  	;push	ds ; segment
  1686                                  	;push	si ; offset
  1687                                  	;push	cx ; count
  1688 000004C6 E87706                  	call    GetSamples_ICH ; 18/02/2017
  1689                                  
  1690                                          ; load 2048 bytes into buffer  2
  1691 000004C9 8B36[6610]              	mov	si, [DMA_BUFFER2]
  1692                                  	; 11/05/2024
  1693                                  	;mov	cx, BUFFERSIZE
  1694                                  	;push	ds ; segment
  1695                                  	;push	si ; offset
  1696                                  	;push	cx ; count
  1697 000004CD E87006                  	call	GetSamples_ICH ; 18/02/2017
  1698                                  
  1699                                  ; register reset the DMA engine. This may cause a pop noise on the output
  1700                                  ; lines when the device is reset. Prolly a better idea to mute output, then
  1701                                  ; reset.
  1702                                  
  1703                                  	; 08/05/2024
  1704                                          ;mov    dx, [NABMBAR]
  1705                                          ;add    dx, PO_CR_REG		; set pointer to Ctrl reg
  1706                                          ;mov    al, RR			; set reset
  1707                                  	;out    dx, al			; self clearing bit
  1708                                  
  1709                                  ; write last valid index to 31 to start with.
  1710                                  ; The Last Valid Index register tells the DMA engine when to stop playing.
  1711                                  ; 
  1712                                  ; As we progress through the song we change the last valid index to always be
  1713                                  ; something other than the index we're currently playing.  
  1714                                  ;
  1715                                          ;;mov   al, 1
  1716                                          ;mov	al, 31
  1717                                  	;call   setLastValidIndex
  1718                                  
  1719                                  ; create Buffer Descriptor List
  1720                                  ;
  1721                                  ; A buffer descriptor list is a list of pointers and control bits that the
  1722                                  ; DMA engine uses to know where to get the .wav data and how to play it.
  1723                                  ;
  1724                                  ; I set it up to use only 2 buffers of .wav data, and whenever 1 buffer is
  1725                                  ; playing, I refresh the other one with good data.
  1726                                  ;
  1727                                  ;
  1728                                  ; For the control bits, you can specify that the DMA engine fire an interrupt
  1729                                  ; after a buffer has been processed, but I poll the current index register
  1730                                  ; to know when it's safe to update the other buffer.
  1731                                  ;
  1732                                  ; I set the BUP bit, which tells the DMA engine to just play 0's (silence)
  1733                                  ; if it ever runs out of data to play. Good for safety.
  1734                                  ;
  1735                                  	; 14/02/2017
  1736 000004D0 8B3E[6210]                      mov     di, [BDL_BUFFER]		; get BDL address
  1737 000004D4 B91000                          mov     cx, 32 / 2                      ; make 32 entries in BDL
  1738 000004D7 6631D2                  	xor	edx, edx
  1739 000004DA 8CDA                    	mov	dx, ds
  1740 000004DC 66C1E204                	shl	edx, 4 ; segment*16 (linear/physical address of the segment)
  1741                                  _0:
  1742                                  
  1743                                  ; set buffer descriptor 0 to start of data file in memory
  1744                                  	; 14/02/2017
  1745 000004E0 660FB706[6410]                  movzx   eax, word [DMA_BUFFER1]
  1746 000004E6 6601D0                  	add	eax, edx ; linear/physical address of the buffer (seg*16+off)
  1747 000004E9 66AB                            stosd					; store dmabuffer1 address
  1748                                  
  1749                                  ;
  1750                                  ; set length to 32k samples. 1 sample is 16bits or 2bytes.
  1751                                  ; Set control (bits 31:16) to BUP, bits 15:0=number of samples.
  1752                                  ; 
  1753                                  
  1754                                  ; 17/02/2017 (Erdogan Tan)
  1755                                  ; Intel 82801AA (ICH) & Intel 82801AB (ICH0) I/O Controller Hub AC 97
  1756                                  ; Programmers Reference Manual
  1757                                  
  1758                                  ; 2.2.1 Buffer Descriptor List  (on Page 13)
  1759                                  	;
  1760                                  	;  Generic Form of Buffer Descriptor
  1761                                  	;  ---------------------------------
  1762                                  	;  63   62    61-48    47-32   31-0
  1763                                  	;  ---  ---  --------  ------- -----
  1764                                  	;  IOC  BUP -reserved- Buffer  Buffer
  1765                                  	;		      Length   Pointer
  1766                                  	;		      [15:0]   [31:0]
  1767                                  	;
  1768                                  	;  IOC:	Interrupt On Completion. 
  1769                                  	;	1 = Enabled. 
  1770                                  	;	    When this is set, it means that the controller should
  1771                                  	;	    issue an interrupt upon completion of this buffer.
  1772                                  	;	    It should also set the IOC bit in the status register
  1773                                  	;	0 = Disabled	
  1774                                  	;
  1775                                  	;  BUP: Buffer Underrun Policy.
  1776                                  	;       0 = When this buffer is complete,
  1777                                  	;	    if the next buffer is not yet ready 
  1778                                  	;	    (i.e., the last valid buffer has been processed),
  1779                                  	;	    then continue to transmit the last valid sample.
  1780                                  	;	1 = When this buffer is complete,
  1781                                  	;     	    if this is the last valid buffer, transmit zeros after
  1782                                  	;	    this buffer has been processed completely.
  1783                                  	;	    This bit typically is set only if this is the last 
  1784                                  	;	    buffer in the current stream.
  1785                                  	;
  1786                                  	; [31:0]: Buffer pointer. This field points to the location of
  1787                                  	;	  the data buffer. Since samples can be as wide as one
  1788                                  	;	  word, the buffer must be aligned with word boundaries,
  1789                                  	;	  to prevent samples from straddling DWord boundaries.
  1790                                  	;
  1791                                  	; [15:0]: Buffer Length: This is the length of the data buffer,
  1792                                  	;	  in number of samples. The controller uses this data
  1793                                  	;	  to determine the length of the buffer, in bytes.
  1794                                  	;	  "0" indicates no sample to process.
  1795                                  
  1796                                  ; ICH2AC97.INC
  1797                                  
  1798                                  ;	IOC	equ     BIT31   ; Fire an interrupt whenever this
  1799                                  				; buffer is complete.
  1800                                  
  1801                                  ;	BUP	equ     BIT30   ; Buffer Underrun Policy.
  1802                                  				; if this buffer is the last buffer
  1803                                  				; in a playback, fill the remaining
  1804                                  				; samples with 0 (silence) or not.
  1805                                  				; It's a good idea to set this to 1
  1806                                  				; for the last buffer in playback,
  1807                                  				; otherwise you're likely to get a lot
  1808                                  				; of noise at the end of the sound.
  1809                                  ;
  1810                                  ; Bits 15:0 contain the length of the buffer, in number of samples, which
  1811                                  ; are 16 bits each, coupled in left and right pairs, or 32bits each.
  1812                                  ; Luckily for us, that's the same format as .wav files.
  1813                                  ;
  1814                                  ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
  1815                                  ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
  1816                                  ;
  1817                                  ; A value of 0 in these bits means play no samples.
  1818                                  ;
  1819                                  	; 08/12/2016 - Erdogan Tan
  1820                                  	;mov	eax, BUFFERSIZE
  1821                                  	; 12/05/2024
  1822 000004EB 66B800140000            	mov	eax, BUFFERSIZE/2
  1823 000004F1 660D000000C0            	or	eax, IOC + BUP
  1824 000004F7 66AB                    	stosd
  1825                                  
  1826                                  ; 2nd buffer:
  1827                                  	; 14/02/2017
  1828 000004F9 660FB706[6610]                  movzx   eax, word [DMA_BUFFER2]
  1829 000004FF 6601D0                  	add	eax, edx ; linear/physical address of the buffer (seg*16+off)
  1830 00000502 66AB                            stosd					; store dmabuffer2 address
  1831                                  
  1832                                  ; set length to 64k (32k of two 16 bit samples)
  1833                                  ; Set control (bits 31:16) to BUP, bits 15:0=number of samples
  1834                                  ; 
  1835                                  	; 08/12/2016 - Erdogan Tan
  1836                                  	;mov	eax, BUFFERSIZE
  1837                                  	; 12/05/2024
  1838 00000504 66B800140000            	mov	eax, BUFFERSIZE/2
  1839 0000050A 660D000000C0            	or	eax, IOC + BUP
  1840 00000510 66AB                    	stosd
  1841 00000512 E2CC                            loop    _0
  1842                                  ;
  1843                                  ; tell the DMA engine where to find our list of Buffer Descriptors.
  1844                                  ; this 32bit value is a flat mode memory offset (ie no segment:offset)
  1845                                  ;
  1846                                  ; write NABMBAR+10h with offset of buffer descriptor list
  1847                                  ;
  1848 00000514 660FB706[6210]                  movzx   eax, word [BDL_BUFFER]
  1849                                  	; 14/02/2017
  1850 0000051A 6601D0                  	add	eax, edx ; linear/physical address of the BDL
  1851                                    	; 18/02/2017
  1852 0000051D 8B16[5610]                      mov     dx, [NABMBAR]
  1853 00000521 83C210                          add     dx, PO_BDBAR_REG                ; set pointer to BDL
  1854 00000524 66EF                            out     dx, eax                         ; write to AC97 controller
  1855                                  
  1856                                  	; 15/05/2024
  1857 00000526 E83D07                  	call	delay1_4ms
  1858                                  ;
  1859                                  ; All set. Let's play some music.
  1860                                  ;
  1861                                  	; 08/12/2016
  1862                                  	; 07/10/2016
  1863                                          ;mov    al, 1
  1864 00000529 B01F                            mov	al, 31
  1865                                  
  1866                                  	; 13/05/2024
  1867                                  	; 08/05/2024
  1868                                  	;mov	[LVI], al ; 10/11/2023
  1869                                  	;call   setLastValidIndex
  1870                                  
  1871                                  	;input AL = index # to stop on
  1872                                  setLastValidIndex:
  1873 0000052B 8B16[5610]              	mov	dx, [NABMBAR]
  1874 0000052F 83C215                  	add	dx, PO_LVI_REG
  1875 00000532 EE                              out     dx, al
  1876                                  
  1877 00000533 C606[5B10]01            	mov	byte [tLoop], 1 ; 30/11/2016
  1878                                  
  1879                                  	; 15/05/2024
  1880 00000538 E82B07                  	call	delay1_4ms
  1881                                  
  1882                                  	; 12/05/2024	
  1883                                  	; 17/02/2017
  1884 0000053B 8B16[5610]                      mov	dx, [NABMBAR]
  1885 0000053F 83C21B                          add	dx, PO_CR_REG			; PCM out Control Register
  1886 00000542 B011                            mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
  1887                                  				; (LVBI interrupt will not be enabled)
  1888 00000544 EE                              out	dx, al				; Start bus master operation.
  1889                                  
  1890                                  	; 15/05/2024
  1891 00000545 E81E07                  	call	delay1_4ms
  1892 00000548 E81B07                  	call	delay1_4ms
  1893 0000054B E81807                  	call	delay1_4ms
  1894 0000054E E81507                  	call	delay1_4ms
  1895                                  
  1896                                  ; while DMA engine is running, examine current index and wait until it hits 1
  1897                                  ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
  1898                                  ; 64k.  Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
  1899                                     
  1900                                  	; 18/02/2017
  1901                                  	; 14/02/2017
  1902                                  	; 13/02/2017
  1903                                  	; 08/12/2016
  1904                                  	; 28/11/2016
  1905                                  
  1906 00000551 06                      	push	es
  1907 00000552 B800A0                  	mov	ax, 0A000h
  1908 00000555 8EC0                    	mov	es, ax
  1909                                  	;mov	bp, DmaBuffer ; 14/02/2017
  1910                                  p_loop:
  1911 00000557 B401                    	mov     ah, 1			; any key pressed?
  1912                                  	;mov	ah, 11h
  1913 00000559 CD16                    	int     16h			; no, Loop.
  1914 0000055B 7442                    	jz	short q_loop
  1915                                  
  1916 0000055D B400                    	mov	ah, 0
  1917                                  	;mov    ah, 10h			; flush key buffer...
  1918 0000055F CD16                    	int     16h
  1919                                  
  1920                                  	; 12/05/2024 (change PCM out volume)
  1921 00000561 3C2B                    	cmp	al, '+'
  1922 00000563 750B                    	jne	short p_1
  1923                                  	
  1924 00000565 A0[7310]                	mov	al, [volume]
  1925 00000568 3C00                    	cmp	al, 0
  1926 0000056A 7633                    	jna	short q_loop
  1927 0000056C FEC8                    	dec	al
  1928 0000056E EB0D                    	jmp	short p_2
  1929                                  p_1:
  1930 00000570 3C2D                    	cmp	al, '-'
  1931 00000572 7524                    	jne	short p_return
  1932                                  
  1933 00000574 A0[7310]                	mov	al, [volume]
  1934 00000577 3C1F                    	cmp	al, 31
  1935 00000579 7324                    	jnb	short q_loop
  1936 0000057B FEC0                    	inc	al
  1937                                  p_2:
  1938 0000057D A2[7310]                	mov	[volume], al
  1939 00000580 88C4                    	mov	ah, al
  1940 00000582 8B16[5410]              	mov     dx, [NAMBAR]
  1941                                    	;add    dx, CODEC_MASTER_VOL_REG
  1942 00000586 83C218                  	add	dx, CODEC_PCM_OUT_REG
  1943 00000589 EF                      	out     dx, ax
  1944                                  
  1945                                  	; 12/05/2024
  1946 0000058A E8D906                  	call    delay1_4ms
  1947 0000058D E8D606                          call    delay1_4ms
  1948 00000590 E8D306                          call    delay1_4ms
  1949 00000593 E8D006                          call    delay1_4ms
  1950                                  
  1951 00000596 EB07                    	jmp	short q_loop
  1952                                  
  1953                                  p_return:
  1954 00000598 C606[5B10]00            	mov	byte [tLoop], 0	; 13/02/2017
  1955 0000059D 07                      	pop	es
  1956 0000059E C3                      	retn
  1957                                  
  1958                                  q_loop:
  1959                                  	; 10/05/2024
  1960 0000059F 31C0                    	xor	ax, ax
  1961 000005A1 8606[5810]              	xchg	al, [tBuff] ; AL = [tBuff], [tBuff] = 0
  1962 000005A5 3C01                    	cmp	al, 1
  1963 000005A7 7708                    	ja	short r_loop
  1964                                  	;jb	short ScopeLoop
  1965                                  	; 15/05/2024
  1966 000005A9 720D                    	jb	short x_loop
  1967                                  	;
  1968 000005AB 8B36[6410]                   	mov	si, [DMA_BUFFER1] ; [tBuff]=1 (from tuneLoop)
  1969 000005AF EB04                           	jmp	short s_loop 
  1970                                  r_loop:
  1971                                  	; 13/02/2017
  1972 000005B1 8B36[6610]                      mov     si, [DMA_BUFFER2] ; [tBuff]=2 (from tuneLoop)
  1973                                  s_loop:
  1974                                  	; 14/02/2017
  1975                                  	;mov	bp, si ; save current buffer addres in bp register
  1976                                  	; 11/05/2024
  1977                                  	;mov	cx, BUFFERSIZE ; 2048*4 byte
  1978                                  	;push	ds ; segment
  1979                                  	;push	si ; offset
  1980                                  	;push	cx ; count
  1981 000005B5 E88805                  	call    GetSamples_ICH ; 18/02/2017
  1982                                  
  1983                                  	; 15/05/2024
  1984                                  x_loop:
  1985 000005B8 E80200                  	call	ScopeLoop
  1986 000005BB EB9A                    	jmp	short p_loop
  1987                                  
  1988                                  ScopeLoop:
  1989                                  	;mov    si, bp			; get current samples
  1990 000005BD BE[92C4]                	mov	si, MOD_BUFFER ; 18/02/2017
  1991 000005C0 31C9                    	xor     cx, cx			; to be drawed ...
  1992 000005C2 31D2                    	xor     dx, dx
  1993                                  DrawLoop:       
  1994 000005C4 89D3                    	mov     bx, dx			; (save Index)
  1995 000005C6 8BBF[10C0]              	mov     di, [Scope+bx]		; get old SCOPE pixel address
  1996 000005CA 26C60500                	mov     byte [es:di], 0		; erase it!
  1997 000005CE AC                      	lodsb				; get a sample (8-bit)
  1998 000005CF 88C3                    	mov     bl, al			; calc new pixel address...
  1999 000005D1 30FF                    	xor     bh, bh
  2000 000005D3 D1E3                    	shl     bx, 1
  2001 000005D5 8BBF[90C2]              	mov     di, [RowOfs+bx]
  2002 000005D9 01CF                    	add     di, cx
  2003 000005DB 89D3                    	mov     bx, dx			; (restore Index)
  2004 000005DD 89BF[10C0]              	mov     [Scope+bx], di		; save new address...
  2005 000005E1 26C6050A                	mov     byte [es:di], 10 ; 0Ah	; and DRAW.
  2006 000005E5 83C202                  	add     dx, 2			; the next pixel...
  2007 000005E8 41                      	inc     cx
  2008 000005E9 81F94001                	cmp     cx, 320			; 320 pixels drawed?
  2009 000005ED 72D5                    	jb      short DrawLoop
  2010                                  	; 15/05/2024
  2011                                  	;jmp	p_loop
  2012 000005EF C3                      	retn
  2013                                  
  2014                                  ; 13/05/2024
  2015                                  %if 0
  2016                                  
  2017                                  tuneLoop:
  2018                                  	; 11/05/2024
  2019                                  	; 11/11/2023
  2020                                  	; 10/11/2023
  2021                                  	; 18/02/2017
  2022                                  	; 08/12/2016
  2023                                  	; 28/11/2016 - Erdogan Tan
  2024                                  
  2025                                  	; 11/05/2024
  2026                                  	cmp	byte [tLoop], 1
  2027                                  	jb	short tL3
  2028                                  	
  2029                                  	call    getCurrentIndex
  2030                                  
  2031                                  	; 10/11/2023
  2032                                  	cmp	al, [LVI]
  2033                                  	jne	short tL1
  2034                                  
  2035                                  	dec	ax
  2036                                  	and	al, 1Fh 
  2037                                  	call	setLastValidIndex
  2038                                  	xchg	al, [LVI]
  2039                                  tL1:
  2040                                  	test	al, BIT0
  2041                                  	jz	short tL2
  2042                                  
  2043                                  	; 11/05/2024
  2044                                  	mov	byte [tBuff], 1
  2045                                  	retn
  2046                                  tL2:	
  2047                                  	mov	byte [tBuff], 2
  2048                                  tL3:
  2049                                  	retn
  2050                                  
  2051                                  ; returns AL = current index value
  2052                                  getCurrentIndex:
  2053                                  	;push	dx
  2054                                  	mov	dx, [NABMBAR]
  2055                                  	add	dx, PO_CIV_REG
  2056                                  	in	al, dx
  2057                                  	;pop	dx
  2058                                  	retn
  2059                                  
  2060                                  ;input AL = index # to stop on
  2061                                  setLastValidIndex:
  2062                                  	;push	dx
  2063                                  	mov	dx, [NABMBAR]
  2064                                  	add	dx, PO_LVI_REG
  2065                                          out     dx, al
  2066                                  	;pop	dx
  2067                                  	retn
  2068                                  
  2069                                  %endif
  2070                                  
  2071                                  ;=============================================================================
  2072                                  ;               MODLOAD.ASM
  2073                                  ;=============================================================================
  2074                                  
  2075                                  ; Amiga Module Loader v0.1b by Carlos Hasan.
  2076                                  ;		July 10th, 1993.
  2077                                  
  2078                                  ; STRUCTURES
  2079                                  
  2080                                  struc ModSample
  2081 00000000 <res 16h>               .msName:	resb 22
  2082 00000016 ????                    .msLength:	resw 1
  2083 00000018 ??                      .msFinetune:	resb 1
  2084 00000019 ??                      .msVolume:	resb 1
  2085 0000001A ????                    .msRepeat:	resw 1
  2086 0000001C ????                    .msRepLen:	resw 1
  2087                                  .size:
  2088                                  endstruc
  2089                                  
  2090                                  struc ModHeader
  2091 00000000 <res 14h>               .mhName:	resb 20
  2092 00000014 <res 3A2h>              .mhSamples:	resb ModSample.size*31
  2093 000003B6 ??                      .mhOrderLen:	resb 1
  2094 000003B7 ??                      .mhReStart:	resb 1
  2095 000003B8 <res 80h>               .mhOrder:	resb 128
  2096 00000438 ????????                .mhSign:	resw 2
  2097                                  .size:	
  2098                                  endstruc
  2099                                  
  2100                                  struc ModInfoRec
  2101 00000000 ??                      .OrderLen:	resb 1
  2102 00000001 ??                      .ReStart:	resb 1
  2103 00000002 <res 80h>               .Order:		resb 128
  2104 00000082 ????????                .Patterns:	resd 1
  2105 00000086 <res 3Eh>               .SampOfs:	resw 31
  2106 000000C4 <res 3Eh>               .SampSeg:	resw 31
  2107 00000102 <res 3Eh>               .SampLen:	resw 31
  2108 00000140 <res 3Eh>               .SampRep:	resw 31
  2109 0000017E <res 3Eh>               .SampRepLen:	resw 31
  2110 000001BC <res 3Eh>               .SampVol:	resw 31
  2111                                  .size:	
  2112                                  endstruc
  2113                                  
  2114                                  ; CODE
  2115                                  
  2116                                  LoadModule:
  2117                                  		;es:di = filename
  2118                                  
  2119                                  		;[sp+4] = es
  2120                                  		;[sp+2] = di
  2121                                  
  2122                                  		FileName equ 4		
  2123                                  
  2124 000005F0 55                      		push    bp
  2125 000005F1 89E5                    		mov     bp, sp
  2126 000005F3 60                      		pusha
  2127 000005F4 1E                      		push    ds
  2128 000005F5 06                      		push    es
  2129                                  
  2130 000005F6 C706[8261]0100          		mov	word [ErrorInfo], 1
  2131                                  
  2132 000005FC E85101                  		call    ClearModInfo
  2133                                  OpenFile:       
  2134 000005FF 1E                      		push    ds
  2135 00000600 B8003D                  		mov     ax, 3D00h
  2136 00000603 C55604                  		lds     dx, [bp+FileName]
  2137 00000606 CD21                    		int     21h
  2138 00000608 1F                      		pop     ds
  2139 00000609 0F823C01                		jc      Failed
  2140 0000060D A3[8061]                		mov     [FileHandle], ax
  2141                                  
  2142                                  ReadHeader:     
  2143 00000610 B8003F                  		mov     ax, 3F00h
  2144 00000613 8B1E[8061]              		mov     bx, [FileHandle]
  2145 00000617 B93C04                  		mov     cx, ModHeader.size
  2146                                  		;lea    dx, [Header]
  2147 0000061A BA[8461]                		mov	dx, Header
  2148 0000061D CD21                    		int     21h
  2149 0000061F 0F821D01                		jc      CloseFile
  2150                                  CheckMK:        
  2151 00000623 813E[BC65]4D2E          		cmp     word [Header+ModHeader.mhSign], 'M.'
  2152 00000629 7508                    		jne     short CheckFLT4
  2153 0000062B 813E[BE65]4B2E          		cmp     word [Header+ModHeader.mhSign+2], 'K.'
  2154 00000631 7439                    		je      short IsModFile
  2155                                  CheckFLT4:
  2156 00000633 813E[BC65]464C          		cmp     word [Header+ModHeader.mhSign], 'FL'
  2157 00000639 7508                    		jne     short Is15Inst
  2158 0000063B 813E[BE65]5434          		cmp     word [Header+ModHeader.mhSign+2], 'T4'
  2159 00000641 7429                    		je      short IsModFile
  2160                                  Is15Inst:
  2161 00000643 BE[5A63]                		mov     si, (Header+ModHeader.mhSamples) + (15*ModSample.size)
  2162 00000646 BF[3A65]                		mov     di, Header+ModHeader.mhOrderLen
  2163 00000649 8CD8                    		mov     ax, ds
  2164 0000064B 8EC0                    		mov     es, ax
  2165 0000064D FC                      		cld
  2166 0000064E B98200                  		mov     cx, 130
  2167 00000651 F3A4                    		rep     movsb
  2168 00000653 BF[5A63]                		mov     di, Header+ModHeader.mhSamples + (15*ModSample.size)
  2169 00000656 31C0                    		xor     ax, ax
  2170 00000658 B9E001                  		mov     cx, 16*ModSample.size
  2171 0000065B F3AA                    		rep     stosb
  2172                                  SeekPatterns:   
  2173 0000065D B80042                  		mov     ax, 4200h
  2174 00000660 8B1E[8061]              		mov     bx, [FileHandle]
  2175 00000664 B90000                  		mov     cx, 0
  2176 00000667 BA5802                  		mov     dx, 600
  2177 0000066A CD21                    		int     21h
  2178                                  IsModFile:  
  2179 0000066C A0[3A65]                		mov     al, [Header+ModHeader.mhOrderLen]
  2180 0000066F A2[C265]                		mov     [ModInfo.OrderLen], al
  2181                                  
  2182 00000672 A0[3B65]                		mov     al, [Header+ModHeader.mhReStart]
  2183 00000675 3A06[3A65]              		cmp     al, [Header+ModHeader.mhOrderLen]
  2184 00000679 7202                    		jb      short SetReStart
  2185 0000067B B07F                    		mov     al, 7Fh
  2186                                  SetReStart:
  2187 0000067D A2[C365]                		mov     [ModInfo.ReStart], al
  2188                                  
  2189 00000680 B98000                  		mov     cx, 128
  2190 00000683 31C0                    		xor     ax, ax
  2191 00000685 31DB                    		xor     bx, bx
  2192                                  CopyOrder:
  2193 00000687 8AA7[3C65]              		mov     ah, [Header+ModHeader.mhOrder+bx]
  2194 0000068B 88A7[C465]              		mov     [ModInfo.Order+bx], ah
  2195 0000068F 38C4                    		cmp     ah, al
  2196 00000691 7202                    		jb      short NextOrder
  2197 00000693 88E0                    		mov     al, ah
  2198                                  NextOrder:
  2199 00000695 43                      		inc     bx
  2200 00000696 E2EF                    		loop    CopyOrder
  2201                                  AllocPatterns:  
  2202                                  		; Erdogan Tan (13/02/2017)
  2203 00000698 30E4                    		xor	ah, ah
  2204 0000069A FEC0                    		inc	al
  2205                                  		; al = count of 1024 bytes
  2206 0000069C 89C3                    		mov	bx, ax
  2207                                  		; count of paragraphs = al*64 
  2208 0000069E C1E006                  		shl	ax, 6 ; *64
  2209 000006A1 89C5                    		mov	bp, ax
  2210 000006A3 8CCA                    		mov	dx, cs ; current (code) segment
  2211 000006A5 81C20010                		add	dx, 1000h ; next 64K (4096*16)
  2212                                  		;
  2213 000006A9 C706[4466]0000          		mov	word [ModInfo.Patterns], 0
  2214 000006AF 8916[4666]              		mov	[ModInfo.Patterns+2], dx
  2215                                  		;
  2216 000006B3 01D5                    		add	bp, dx ; next segment for samples
  2217                                  ReadPatterns:   
  2218 000006B5 1E                      		push    ds
  2219 000006B6 B8003F                  		mov     ax, 3F00h
  2220 000006B9 89D9                    		mov     cx, bx ; count of 1024 bytes
  2221 000006BB C1E10A                  		shl     cx, 10 ; byte count (cx*1024)
  2222 000006BE 8B1E[8061]              		mov     bx, [FileHandle]
  2223                                  		;lds    dx, [ModInfo.Patterns]
  2224 000006C2 8EDA                    		mov	ds, dx
  2225 000006C4 31D2                    		xor	dx, dx
  2226 000006C6 CD21                    		int     21h
  2227 000006C8 1F                      		pop     ds
  2228 000006C9 7275                    		jc      CloseFile
  2229                                  
  2230                                  		;lea	si, [Header+ModHeader.mhSamples]
  2231 000006CB BE[9861]                		mov	si, Header+ModHeader.mhSamples
  2232 000006CE 31FF                    		xor     di, di
  2233                                  CopySamples:
  2234 000006D0 8B4416                  		mov     ax, [si+ModSample.msLength]
  2235 000006D3 86C4                    		xchg    al, ah
  2236 000006D5 D1E0                    		shl     ax, 1
  2237 000006D7 8985[C466]              		mov     [ModInfo.SampLen+di], ax
  2238 000006DB 8A4419                  		mov     al, [si+ModSample.msVolume]
  2239 000006DE 30E4                    		xor     ah, ah
  2240 000006E0 8985[7E67]              		mov     [ModInfo.SampVol+di], ax
  2241 000006E4 8B441A                  		mov     ax, [si+ModSample.msRepeat]
  2242 000006E7 86C4                    		xchg    al, ah
  2243 000006E9 D1E0                    		shl     ax, 1
  2244 000006EB 8985[0267]              		mov     [ModInfo.SampRep+di], ax
  2245 000006EF 8B441C                  		mov     ax, [si+ModSample.msRepLen]
  2246 000006F2 86C4                    		xchg    al, ah
  2247 000006F4 D1E0                    		shl     ax, 1
  2248 000006F6 8985[4067]              		mov     [ModInfo.SampRepLen+di], ax
  2249 000006FA 83C61E                  		add     si, ModSample.size
  2250 000006FD 83C702                  		add     di, 2
  2251 00000700 83FF3E                  		cmp     di, 2*31
  2252 00000703 72CB                    		jb      short CopySamples
  2253                                  
  2254 00000705 31F6                    		xor     si, si
  2255                                  AllocSamples:
  2256                                  		; Erdogan Tan (13/02/2017)
  2257                                  		;mov	bx, [ModInfo.SampLen+si]
  2258 00000707 8B8C[C466]              		mov	cx, [ModInfo.SampLen+si]
  2259 0000070B 89CB                    		mov	bx, cx
  2260 0000070D C1EB04                  		shr     bx, 4 ; byte count / 16
  2261 00000710 7420                    		jz      short NextSample
  2262 00000712 43                      		inc	bx ; number of paragraphs
  2263 00000713 C784[4866]0000          		mov	word [ModInfo.SampOfs+si], 0
  2264 00000719 89AC[8666]              		mov     [ModInfo.SampSeg+si], bp
  2265 0000071D 89EA                    		mov	dx, bp
  2266 0000071F 01DD                    		add	bp, bx ; next segment for sample 
  2267                                  ReadSample:
  2268 00000721 1E                      		push    ds
  2269 00000722 B8003F                  		mov     ax, 3F00h
  2270 00000725 8B1E[8061]              		mov     bx, [FileHandle]
  2271                                  		;mov    cx, [ModInfo.SampLen+si]
  2272                                  		;mov    dx, [ModInfo.SampOfs+si]
  2273                                  		;mov    ds, [ModInfo.SampSeg+si]
  2274 00000729 8EDA                    		mov	ds, dx
  2275 0000072B 31D2                    		xor	dx, dx	
  2276 0000072D CD21                    		int     21h
  2277 0000072F 1F                      		pop     ds
  2278 00000730 720E                    		jc      short CloseFile
  2279                                  NextSample:
  2280 00000732 83C602                  		add     si, 2
  2281 00000735 83FE3E                  		cmp     si, 2*31
  2282 00000738 72CD                    		jb      short AllocSamples
  2283                                  
  2284 0000073A C706[8261]0000          		mov     word [ErrorInfo], 0
  2285                                  CloseFile:      
  2286 00000740 B8003E                  		mov     ax, 3E00h
  2287 00000743 8B1E[8061]              		mov     bx, [FileHandle]
  2288 00000747 CD21                    		int     21h
  2289                                  Failed:         
  2290 00000749 07                      		pop     es
  2291 0000074A 1F                      		pop     ds
  2292 0000074B 61                      		popa
  2293 0000074C 5D                      		pop     bp
  2294 0000074D C20400                  		ret	4
  2295                                  
  2296                                  FreeModule:
  2297                                  		; Erdogan Tan (13/02/2017)
  2298                                  		; nothing to do here for memory de-allocation
  2299                                  ClearModInfo:
  2300 00000750 60                      		pusha
  2301 00000751 06                      		push    es
  2302 00000752 8CD8                    		mov     ax, ds
  2303 00000754 8EC0                    		mov     es, ax
  2304                                  		;lea    di, [ModInfo]
  2305 00000756 BF[C265]                		mov	di, ModInfo
  2306 00000759 B9FA01                  		mov     cx, ModInfoRec.size
  2307 0000075C FC                      		cld
  2308 0000075D 31C0                    		xor     ax, ax
  2309 0000075F F3AA                    		rep     stosb
  2310 00000761 07                      		pop     es
  2311 00000762 61                      		popa
  2312 00000763 C3                      		retn
  2313                                  
  2314                                  ;=============================================================================
  2315                                  ;               MODPLAY.ASM
  2316                                  ;=============================================================================
  2317                                  
  2318                                  ; Amiga Module Player v0.3b by Carlos Hasan.
  2319                                  ;		July 23th, 1993.
  2320                                  
  2321                                  ; EQUATES
  2322                                  
  2323                                  NumTracks       equ 4
  2324                                  DefTempo        equ 6
  2325                                  DefBpm          equ 125
  2326                                  MidCRate        equ 8448
  2327                                  MixBufSize      equ 4096
  2328                                  
  2329                                  ; STRUCTURES
  2330                                  
  2331                                  struc TrackInfo
  2332 00000000 ????????                .Samples:	resd 1
  2333 00000004 ????                    .Position:	resw 1
  2334 00000006 ????                    .Len:		resw 1
  2335 00000008 ????                    .Repeat:	resw 1
  2336 0000000A ????                    .RepLen:	resw 1
  2337 0000000C ??                      .Volume: 	resb 1
  2338 0000000D ??                      .Error:		resb 1
  2339 0000000E ????                    .Period:	resw 1
  2340 00000010 ????                    .Pitch:		resw 1
  2341 00000012 ????                    .Effect:	resw 1
  2342 00000014 ????                    .PortTo:	resw 1
  2343 00000016 ??                      .PortParm:	resb 1
  2344 00000017 ??                      .VibPos:	resb 1
  2345 00000018 ??                      .VibParm:	resb 1
  2346 00000019 ??                      .OldSampOfs:	resb 1
  2347 0000001A ????????????            .Arp:		resw 3
  2348 00000020 ????                    .ArpIndex:	resw 1
  2349                                  .size:
  2350                                  endstruc
  2351                                  
  2352                                  ; CODE
  2353                                  
  2354                                  ;--------------------------------------------------------------------------
  2355                                  ; BeatTrack:  Process the next beat in one track.
  2356                                  ;  In:
  2357                                  ;    ds:di -  Track info Address.
  2358                                  ;--------------------------------------------------------------------------
  2359                                  
  2360                                  BeatTrack:
  2361 00000764 8B5512                  		mov     dx, [di+TrackInfo.Effect]
  2362 00000767 85D2                    		test    dx, dx
  2363 00000769 7430                    		je      short None
  2364 0000076B 80FE00                  		cmp     dh, 00h
  2365 0000076E 742C                    		je      short Arpeggio
  2366 00000770 80FE01                  		cmp     dh, 01h
  2367 00000773 743E                    		je      short PortUp
  2368 00000775 80FE02                  		cmp     dh, 02h
  2369 00000778 7455                    		je      short PortDown
  2370 0000077A 80FE03                  		cmp     dh, 03h
  2371 0000077D 746D                    		je      short TonePort
  2372 0000077F 80FE04                  		cmp     dh, 04h
  2373 00000782 0F849100                		je      Vibrato
  2374 00000786 80FE05                  		cmp     dh, 05h
  2375 00000789 0F84D600                		je      PortSlide
  2376 0000078D 80FE06                  		cmp     dh, 06h
  2377 00000790 0F84D700                		je      VibSlide
  2378 00000794 80FE0A                  		cmp     dh, 0Ah
  2379 00000797 0F84D800                		je      VolSlide
  2380                                  None:           
  2381 0000079B C3                      		retn
  2382                                  Arpeggio:
  2383 0000079C 8B5D20                  		mov     bx, [di+TrackInfo.ArpIndex]
  2384 0000079F 8B411A                  		mov     ax, [di+TrackInfo.Arp+bx]
  2385 000007A2 894510                  		mov     [di+TrackInfo.Pitch], ax
  2386 000007A5 83C302                  		add     bx, 2
  2387 000007A8 83FB06                  		cmp     bx, 6
  2388 000007AB 7202                    		jb      short SetArpIndex
  2389 000007AD 31DB                    		xor     bx,bx
  2390                                  SetArpIndex:
  2391 000007AF 895D20                  		mov     [di+TrackInfo.ArpIndex], bx
  2392 000007B2 C3                      		retn
  2393                                  PortUp:
  2394 000007B3 30F6                    		xor     dh, dh
  2395 000007B5 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2396 000007B8 29D3                    		sub     bx, dx
  2397 000007BA 83FB71                  		cmp     bx, 113
  2398 000007BD 7D03                    		jge     short NotSmall
  2399 000007BF BB7100                  		mov     bx, 113
  2400                                  NotSmall:
  2401 000007C2 895D0E                  		mov     [di+TrackInfo.Period], bx
  2402 000007C5 01DB                    		add     bx, bx
  2403 000007C7 8B87[BC67]              		mov     ax, [PitchTable+bx]
  2404 000007CB 894510                  		mov     [di+TrackInfo.Pitch], ax
  2405 000007CE C3                      		retn
  2406                                  PortDown:
  2407 000007CF 30F6                    		xor     dh, dh
  2408 000007D1 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2409 000007D4 01D3                    		add     bx, dx
  2410 000007D6 81FB5803                		cmp     bx, 856
  2411 000007DA 7E03                    		jle     short NotBig
  2412 000007DC BB5803                  		mov     bx, 856
  2413 000007DF 895D0E                  NotBig:         mov     [di+TrackInfo.Period], bx
  2414 000007E2 01DB                    		add     bx, bx
  2415 000007E4 8B87[BC67]              		mov     ax, [PitchTable+bx]
  2416 000007E8 894510                  		mov     [di+TrackInfo.Pitch], ax
  2417 000007EB C3                      		retn
  2418                                  TonePort:
  2419 000007EC 30F6                    		xor     dh, dh
  2420 000007EE 8B4514                  		mov     ax, [di+TrackInfo.PortTo]
  2421 000007F1 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2422 000007F4 39C3                    		cmp     bx, ax
  2423 000007F6 741E                    		je      short NoPort
  2424 000007F8 7F0A                    		jg      short PortToUp
  2425                                  PortToDown:     
  2426 000007FA 01D3                    		add     bx, dx
  2427 000007FC 39C3                    		cmp     bx, ax
  2428 000007FE 7E0A                    		jle     short SetPort
  2429                                  FixPort:        
  2430 00000800 89C3                    		mov     bx, ax
  2431 00000802 EB06                    		jmp     short SetPort
  2432                                  PortToUp:
  2433 00000804 29D3                    		sub     bx, dx
  2434 00000806 39C3                    		cmp     bx, ax
  2435 00000808 7CF6                    		jl      short FixPort
  2436                                  SetPort:        
  2437 0000080A 895D0E                  		mov     [di+TrackInfo.Period], bx
  2438 0000080D 01DB                    		add     bx, bx
  2439 0000080F 8B87[BC67]              		mov     ax, [PitchTable+bx]
  2440 00000813 894510                  		mov     [di+TrackInfo.Pitch], ax
  2441                                  NoPort:         
  2442 00000816 C3                      		retn
  2443                                  Vibrato:
  2444 00000817 88D6                    		mov     dh, dl
  2445 00000819 80E20F                  		and     dl, 0Fh
  2446 0000081C C0EE04                  		shr     dh, 4
  2447 0000081F C0E602                  		shl     dh, 2
  2448 00000822 007517                  		add     [di+TrackInfo.VibPos], dh
  2449 00000825 8A7517                  		mov     dh, [di+TrackInfo.VibPos]
  2450 00000828 88F3                    		mov     bl, dh
  2451 0000082A C0EB02                  		shr     bl, 2
  2452 0000082D 83E31F                  		and     bx, 1Fh
  2453 00000830 8A87[DE0E]              		mov     al, [SinTable+bx]
  2454 00000834 F6E2                    		mul     dl
  2455 00000836 D1C0                    		rol     ax, 1
  2456 00000838 86C4                    		xchg    al, ah
  2457 0000083A 80E401                  		and     ah, 1
  2458 0000083D 84F6                    		test    dh, dh
  2459 0000083F 7902                    		jns     short VibUp
  2460 00000841 F7D8                    		neg     ax
  2461                                  VibUp:          
  2462 00000843 03450E                  		add     ax, [di+TrackInfo.Period]
  2463 00000846 89C3                    		mov     bx, ax
  2464 00000848 83FB71                  		cmp     bx, 113
  2465 0000084B 7D03                    		jge     short NoLoVib
  2466 0000084D BB7100                  		mov     bx, 113
  2467                                  NoLoVib:        
  2468 00000850 81FB5803                		cmp     bx, 856
  2469 00000854 7E03                    		jle     short NoHiVib
  2470 00000856 BB5803                  		mov     bx, 856
  2471                                  NoHiVib:        
  2472 00000859 01DB                    		add     bx, bx
  2473 0000085B 8B87[BC67]              		mov     ax, [PitchTable+bx]
  2474 0000085F 894510                  		mov     [di+TrackInfo.Pitch], ax
  2475 00000862 C3                      		retn
  2476                                  PortSlide:
  2477 00000863 E80D00                  		call    VolSlide
  2478 00000866 8A5516                  		mov     dl, [di+TrackInfo.PortParm]
  2479 00000869 EB81                    		jmp     short TonePort
  2480                                  VibSlide:
  2481 0000086B E80500                  		call    VolSlide
  2482 0000086E 8A5518                  		mov     dl, [di+TrackInfo.VibParm]
  2483 00000871 EBA4                    		jmp     short Vibrato
  2484                                  VolSlide:
  2485 00000873 88D6                    		mov     dh, dl
  2486 00000875 80E20F                  		and     dl, 0Fh
  2487 00000878 C0EE04                  		shr     dh, 4
  2488 0000087B 8A450C                  		mov     al, [di+TrackInfo.Volume]
  2489 0000087E 28D0                    		sub     al, dl
  2490 00000880 7D02                    		jge     short NoLoVol
  2491 00000882 30C0                    		xor     al, al
  2492                                  NoLoVol:        
  2493 00000884 00F0                    		add     al, dh
  2494 00000886 3C40                    		cmp     al, 64
  2495 00000888 7602                    		jbe     short NoHiVol
  2496 0000088A B040                    		mov     al, 64
  2497                                  NoHiVol:        
  2498 0000088C 88450C                  		mov     [di+TrackInfo.Volume], al
  2499 0000088F C3                      		retn
  2500                                  
  2501                                  ;--------------------------------------------------------------------------
  2502                                  ; GetTrack:   Get the next Note from a pattern.
  2503                                  ;  In:
  2504                                  ;    ds:di -  Track info Address.
  2505                                  ;    es:si -  Pattern Note Address.
  2506                                  ; Out:
  2507                                  ;    es:si -  The Next Pattern Note address.
  2508                                  ;--------------------------------------------------------------------------
  2509                                  
  2510                                  GetTrack:
  2511 00000890 26AD                    		es lodsw
  2512 00000892 86C4                    		xchg    al, ah
  2513 00000894 88E3                    		mov     bl, ah
  2514 00000896 80E40F                  		and     ah, 0Fh
  2515 00000899 89C1                    		mov     cx, ax
  2516 0000089B 26AD                    		es lodsw
  2517 0000089D 86C4                    		xchg    al, ah
  2518 0000089F 88E7                    		mov     bh, ah
  2519 000008A1 80E40F                  		and     ah, 0Fh
  2520 000008A4 89C2                    		mov     dx, ax
  2521 000008A6 895512                  		mov     [di+TrackInfo.Effect], dx
  2522 000008A9 80E3F0                  		and     bl, 0F0h
  2523 000008AC C0EF04                  		shr     bh, 4
  2524 000008AF 08FB                    		or      bl, bh
  2525 000008B1 742E                    		je      short SetPeriod
  2526                                  SetSample:
  2527 000008B3 30FF                    		xor     bh, bh
  2528 000008B5 4B                      		dec     bx
  2529 000008B6 01DB                    		add     bx, bx
  2530 000008B8 8B87[7E67]              		mov     ax, [ModInfo.SampVol+bx]
  2531 000008BC 88450C                  		mov     [di+TrackInfo.Volume], al
  2532 000008BF 8B87[4866]              		mov     ax, [ModInfo.SampOfs+bx]
  2533 000008C3 8905                    		mov     [di+TrackInfo.Samples], ax
  2534 000008C5 8B87[8666]              		mov     ax, [ModInfo.SampSeg+bx]
  2535 000008C9 894502                  		mov     [di+TrackInfo.Samples+2], ax
  2536 000008CC 8B87[C466]              		mov     ax, [ModInfo.SampLen+bx]
  2537 000008D0 894506                  		mov     [di+TrackInfo.Len], ax
  2538 000008D3 8B87[0267]              		mov     ax, [ModInfo.SampRep+bx]
  2539 000008D7 894508                  		mov     [di+TrackInfo.Repeat], ax
  2540 000008DA 8B87[4067]              		mov     ax, [ModInfo.SampRepLen+bx]
  2541 000008DE 89450A                  		mov     [di+TrackInfo.RepLen], ax
  2542                                  SetPeriod:      
  2543 000008E1 85C9                    		test    cx, cx
  2544 000008E3 741B                    		je      short SetEffect
  2545                                  
  2546 000008E5 894D14                  		mov     [di+TrackInfo.PortTo], cx
  2547 000008E8 80FE03                  		cmp     dh, 03h
  2548 000008EB 7413                    		je      short SetEffect
  2549                                  
  2550 000008ED 894D0E                  		mov     [di+TrackInfo.Period], cx
  2551 000008F0 89CB                    		mov     bx, cx
  2552 000008F2 01DB                    		add     bx, bx
  2553 000008F4 8B87[BC67]              		mov     ax, [PitchTable+bx]
  2554 000008F8 894510                  		mov     [di+TrackInfo.Pitch], ax
  2555 000008FB C745040000              		mov     word [di+TrackInfo.Position], 0
  2556                                  SetEffect:
  2557 00000900 85D2                    		test    dx, dx
  2558 00000902 742A                    		je      short InitNone
  2559 00000904 80FE00                  		cmp     dh, 00h
  2560 00000907 0F84C400                		je      InitArpeggio
  2561 0000090B 80FE03                  		cmp     dh, 03h
  2562 0000090E 741F                    		je      short InitTonePort
  2563 00000910 80FE04                  		cmp     dh, 04h
  2564 00000913 7428                    		je      short InitVibrato
  2565 00000915 80FE09                  		cmp     dh, 09h
  2566 00000918 744A                    		je      short SampleOfs
  2567 0000091A 80FE0B                  		cmp     dh, 0Bh
  2568 0000091D 7457                    		je      short PosJump
  2569 0000091F 80FE0C                  		cmp     dh, 0Ch
  2570 00000922 745C                    		je      short SetVolume
  2571 00000924 80FE0D                  		cmp     dh, 0Dh
  2572 00000927 7462                    		je      short Break
  2573 00000929 80FE0F                  		cmp     dh, 0Fh
  2574 0000092C 7478                    		je      short SetSpeed
  2575                                  InitNone:
  2576 0000092E C3                      		retn
  2577                                  InitTonePort:
  2578 0000092F 84D2                    		test    dl, dl
  2579 00000931 7503                    		jne     short SetPortParm
  2580 00000933 8A5516                  		mov     dl, [di+TrackInfo.PortParm]
  2581                                  SetPortParm:    
  2582 00000936 885516                  		mov     [di+TrackInfo.PortParm], dl
  2583 00000939 895512                  		mov     [di+TrackInfo.Effect], dx
  2584 0000093C C3                      		retn
  2585                                  InitVibrato:
  2586 0000093D 8A4518                  		mov     al, [di+TrackInfo.VibParm]
  2587 00000940 88C4                    		mov     ah, al
  2588 00000942 240F                    		and     al, 0Fh
  2589 00000944 80E4F0                  		and     ah, 0F0h
  2590 00000947 F6C20F                  		test    dl, 0Fh
  2591 0000094A 7502                    		jne     short OkDepth
  2592 0000094C 08C2                    		or      dl, al
  2593                                  OkDepth:        
  2594 0000094E F6C2F0                  		test    dl, 0F0h
  2595 00000951 7502                    		jne     short OkRate
  2596 00000953 08E2                    		or      dl, ah
  2597                                  OkRate:         
  2598 00000955 885518                  		mov     [di+TrackInfo.VibParm], dl
  2599 00000958 895512                  		mov     [di+TrackInfo.Effect], dx
  2600 0000095B 85C9                    		test    cx, cx
  2601 0000095D 7404                    		je      short OkPos
  2602 0000095F C6451700                		mov     byte [di+TrackInfo.VibPos], 0
  2603                                  OkPos:          
  2604 00000963 C3                      		retn
  2605                                  SampleOfs:      
  2606 00000964 84D2                    		test    dl, dl
  2607 00000966 7503                    		jne     short SetSampleOfs
  2608 00000968 8A5519                  		mov     dl, [di+TrackInfo.OldSampOfs]
  2609                                  SetSampleOfs:
  2610 0000096B 885519                  		mov     [di+TrackInfo.OldSampOfs], dl
  2611 0000096E 88D6                    		mov     dh, dl
  2612 00000970 30D2                    		xor     dl, dl
  2613 00000972 895504                  		mov     [di+TrackInfo.Position], dx
  2614 00000975 C3                      		retn
  2615                                  PosJump:
  2616 00000976 8816[6EBF]              		mov     [OrderPos], dl
  2617 0000097A C606[72BF]40            		mov     byte [Row], 64
  2618 0000097F C3                      		retn
  2619                                  SetVolume:
  2620 00000980 80FA40                  		cmp     dl, 64
  2621 00000983 7602                    		jbe     short OkVol
  2622 00000985 B240                    		mov     dl, 64
  2623                                  OkVol:
  2624 00000987 88550C                  		mov     [di+TrackInfo.Volume], dl
  2625 0000098A C3                      		retn
  2626                                  Break:
  2627 0000098B 88D6                    		mov     dh, dl
  2628 0000098D 80E20F                  		and     dl, 0Fh
  2629 00000990 C0EE04                  		shr     dh, 4
  2630 00000993 00F6                    		add     dh, dh
  2631 00000995 00F2                    		add     dl, dh
  2632 00000997 C0E602                  		shl     dh, 2
  2633 0000099A 00F2                    		add     dl, dh
  2634 0000099C 8816[73BF]              		mov     [BreakRow], dl
  2635 000009A0 C606[72BF]40            		mov     byte [Row], 64
  2636 000009A5 C3                      		retn
  2637                                  SetSpeed:
  2638 000009A6 84D2                    		test    dl,dl
  2639 000009A8 7424                    		je      Skip
  2640 000009AA 80FA1F                  		cmp     dl,31
  2641 000009AD 7709                    		ja      short SetBpm
  2642                                  SetTempo:       
  2643 000009AF 8816[6FBF]              		mov     [Tempo], dl
  2644 000009B3 8816[70BF]              		mov     [TempoWait], dl
  2645 000009B7 C3                      		retn
  2646                                  SetBpm:
  2647 000009B8 8816[71BF]              		mov     [Bpm], dl
  2648 000009BC B067                    		mov     al, 103
  2649 000009BE F6E2                    		mul     dl
  2650 000009C0 88E3                    		mov     bl, ah
  2651 000009C2 30FF                    		xor     bh, bh
  2652 000009C4 A1[C065]                		mov     ax, [MixSpeed]
  2653 000009C7 31D2                    		xor     dx, dx
  2654 000009C9 F7F3                    		div     bx
  2655 000009CB A3[74BF]                		mov     [BpmSamples], ax
  2656                                  Skip:           
  2657 000009CE C3                      		retn
  2658                                  InitArpeggio:
  2659 000009CF 88D6                    		mov     dh, dl
  2660 000009D1 80E20F                  		and     dl, 0Fh
  2661 000009D4 C0EE04                  		shr     dh, 4
  2662 000009D7 B92400                  		mov     cx, 36
  2663 000009DA 31DB                    		xor     bx, bx
  2664 000009DC 8B450E                  		mov     ax, [di+TrackInfo.Period]
  2665                                  gt_ScanPeriod:
  2666 000009DF 3B87[FE0E]              		cmp     ax, [PeriodTable+bx]
  2667 000009E3 7305                    		jae     short SetArp
  2668 000009E5 83C302                  		add     bx, 2
  2669 000009E8 E2F5                    		loop    gt_ScanPeriod
  2670                                  SetArp:         
  2671 000009EA 01D2                    		add     dx, dx
  2672 000009EC 00DE                    		add     dh, bl
  2673 000009EE 00DA                    		add     dl, bl
  2674 000009F0 8B9F[FE0E]              		mov     bx, [PeriodTable+bx]
  2675 000009F4 01DB                    		add     bx, bx
  2676 000009F6 8B87[BC67]              		mov     ax, [PitchTable+bx]
  2677 000009FA 89451A                  		mov     [di+TrackInfo.Arp], ax
  2678 000009FD 88F3                    		mov     bl, dh
  2679 000009FF 30FF                    		xor     bh, bh
  2680 00000A01 8B9F[FE0E]              		mov     bx, [PeriodTable+bx]
  2681 00000A05 01DB                    		add     bx, bx
  2682 00000A07 8B87[BC67]              		mov     ax, [PitchTable+bx]
  2683 00000A0B 89451C                  		mov     [di+TrackInfo.Arp+2], ax
  2684 00000A0E 88D3                    		mov     bl, dl
  2685 00000A10 30FF                    		xor     bh, bh
  2686 00000A12 8B9F[FE0E]              		mov     bx, [PeriodTable+bx]
  2687 00000A16 01DB                    		add     bx, bx
  2688 00000A18 8B87[BC67]              		mov     ax, [PitchTable+bx]
  2689 00000A1C 89451E                  		mov     [di+TrackInfo.Arp+4], ax
  2690 00000A1F C745200000              		mov     word [di+TrackInfo.ArpIndex], 0
  2691 00000A24 C3                      		retn
  2692                                  
  2693                                  ;--------------------------------------------------------------------------
  2694                                  ; UpdateTracks:  Main code to process the next tick to be played.
  2695                                  ;--------------------------------------------------------------------------
  2696                                  
  2697                                  UpdateTracks:
  2698 00000A25 FE0E[70BF]              		dec     byte [TempoWait]
  2699 00000A29 740F                    		jz      short GetTracks
  2700                                  
  2701 00000A2B B90400                  		mov	cx, NumTracks
  2702 00000A2E BF[80BF]                		mov	di, Tracks
  2703                                  BeatTracks:
  2704 00000A31 E830FD                  		call	BeatTrack	
  2705 00000A34 83C722                  		add	di, TrackInfo.size
  2706 00000A37 E2F8                    		loop	BeatTracks
  2707 00000A39 C3                      		retn
  2708                                  GetTracks:
  2709 00000A3A A0[6FBF]                		mov     al, [Tempo]
  2710 00000A3D A2[70BF]                		mov     [TempoWait], al
  2711                                  
  2712 00000A40 C436[7CBF]              		les     si, [Note]
  2713 00000A44 803E[72BF]40            		cmp     byte [Row], 64
  2714 00000A49 7246                    		jb      short NoPattWrap
  2715                                  
  2716 00000A4B C436[4466]              		les     si, [ModInfo.Patterns]
  2717 00000A4F 8A1E[6EBF]              		mov     bl, [OrderPos]
  2718 00000A53 3A1E[C265]              		cmp     bl, [ModInfo.OrderLen]
  2719 00000A57 720E                    		jb      short NoOrderWrap
  2720 00000A59 8A1E[C365]              		mov     bl, [ModInfo.ReStart]
  2721 00000A5D 881E[6EBF]              		mov     [OrderPos], bl
  2722 00000A61 3A1E[C265]              		cmp     bl, [ModInfo.OrderLen]
  2723 00000A65 7343                    		jae     short NoUpdate
  2724                                  NoOrderWrap:    
  2725 00000A67 30FF                    		xor     bh, bh
  2726 00000A69 8A9F[C465]              		mov     bl, [ModInfo.Order+bx]
  2727 00000A6D C1E30A                  		shl     bx, 10
  2728 00000A70 01DE                    		add     si, bx
  2729 00000A72 8A1E[73BF]              		mov     bl, [BreakRow]
  2730 00000A76 881E[72BF]              		mov     [Row], bl
  2731 00000A7A 30FF                    		xor     bh, bh
  2732 00000A7C 883E[73BF]              		mov     [BreakRow], bh
  2733 00000A80 C1E304                  		shl     bx, 4
  2734 00000A83 01DE                    		add     si, bx
  2735 00000A85 8936[7CBF]              		mov     [Note], si
  2736 00000A89 8C06[7EBF]              		mov     [Note+2], es
  2737 00000A8D FE06[6EBF]              		inc     byte [OrderPos]
  2738                                  NoPattWrap:     
  2739 00000A91 FE06[72BF]              		inc     byte [Row]
  2740                                  
  2741 00000A95 FC                      		cld
  2742 00000A96 B90400                  		mov	cx, NumTracks
  2743 00000A99 BF[80BF]                		mov	di, Tracks
  2744                                  GetTracks_next:
  2745 00000A9C 51                      		push	cx		
  2746 00000A9D E8F0FD                  		call	GetTrack
  2747 00000AA0 59                      		pop	cx
  2748 00000AA1 83C722                  		add	di, TrackInfo.size
  2749 00000AA4 E2F6                    		loop	GetTracks_next
  2750                                  
  2751 00000AA6 8936[7CBF]              		mov     [Note], si
  2752                                  NoUpdate:
  2753 00000AAA C3                      		retn
  2754                                  
  2755                                  ;--------------------------------------------------------------------------
  2756                                  ; MixTrack:  Mixes one track into a CLEAN buffer.
  2757                                  ;  In:
  2758                                  ;   ds:si -  Track Info Address.
  2759                                  ;   ds:di -  Buffer Address.
  2760                                  ;    cx   -  Buffer Size.
  2761                                  ;--------------------------------------------------------------------------
  2762                                  
  2763                                  MixTrack:
  2764 00000AAB 837C0A02                		cmp     word [si+TrackInfo.RepLen], 2
  2765 00000AAF 7742                    		ja      short MixLooped
  2766                                  MixNonLooped:   
  2767 00000AB1 C414                    		les     dx, [si+TrackInfo.Samples]
  2768 00000AB3 8B5C04                  		mov     bx, [si+TrackInfo.Position]
  2769 00000AB6 8B6C06                  		mov     bp, [si+TrackInfo.Len]
  2770 00000AB9 52                      		push    dx
  2771 00000ABA 56                      		push    si
  2772 00000ABB 01D3                    		add     bx, dx
  2773 00000ABD 01D5                    		add     bp, dx
  2774 00000ABF 8B5410                  		mov     dx, [si+TrackInfo.Pitch]
  2775 00000AC2 8A440C                  		mov     al, [si+TrackInfo.Volume]
  2776 00000AC5 8A640D                  		mov     ah, [si+TrackInfo.Error]
  2777 00000AC8 89DE                    		mov     si, bx
  2778 00000ACA 88C7                    		mov     bh, al
  2779 00000ACC 88D0                    		mov     al, dl
  2780 00000ACE 88F2                    		mov     dl, dh
  2781 00000AD0 30F6                    		xor     dh, dh
  2782                                  nlMixSamp:      
  2783 00000AD2 39EE                    		cmp     si, bp
  2784 00000AD4 7310                    		jae     short nlMixBye
  2785 00000AD6 268A1C                  		mov     bl, [es:si]
  2786 00000AD9 8A9F[6E6E]              		mov     bl, [VolTable+bx]
  2787 00000ADD 001D                    		add     [di], bl
  2788 00000ADF 47                      		inc     di
  2789 00000AE0 00C4                    		add     ah, al
  2790 00000AE2 11D6                    		adc     si, dx
  2791 00000AE4 E2EC                    		loop    nlMixSamp
  2792                                  nlMixBye:       
  2793 00000AE6 89F3                    		mov     bx, si
  2794 00000AE8 5E                      		pop     si
  2795 00000AE9 5A                      		pop     dx
  2796 00000AEA 29D3                    		sub     bx, dx
  2797 00000AEC 895C04                  		mov     [si+TrackInfo.Position], bx
  2798 00000AEF 88640D                  		mov     [si+TrackInfo.Error], ah
  2799 00000AF2 C3                      		retn
  2800                                  MixLooped:
  2801 00000AF3 C414                    		les     dx, [si+TrackInfo.Samples]
  2802 00000AF5 8B5C04                  		mov     bx, [si+TrackInfo.Position]
  2803 00000AF8 8B6C0A                  		mov     bp, [si+TrackInfo.RepLen]
  2804 00000AFB 892E[7ABF]              		mov     [BufRep], bp
  2805 00000AFF 036C08                  		add     bp, [si+TrackInfo.Repeat]
  2806 00000B02 52                      		push    dx
  2807 00000B03 56                      		push    si
  2808 00000B04 01D3                    		add     bx, dx
  2809 00000B06 01D5                    		add     bp, dx
  2810 00000B08 8B5410                  		mov     dx, [si+TrackInfo.Pitch]
  2811 00000B0B 8A440C                  		mov     al, [si+TrackInfo.Volume]
  2812 00000B0E 8A640D                  		mov     ah, [si+TrackInfo.Error]
  2813 00000B11 89DE                    		mov     si, bx
  2814 00000B13 88C7                    		mov     bh, al
  2815 00000B15 88D0                    		mov     al, dl
  2816 00000B17 88F2                    		mov     dl, dh
  2817 00000B19 30F6                    		xor     dh, dh
  2818                                  lpMixSamp:      
  2819 00000B1B 39EE                    		cmp     si, bp
  2820 00000B1D 7204                    		jb      short lpMixNow
  2821 00000B1F 2B36[7ABF]              		sub     si, [BufRep]
  2822                                  lpMixNow:       
  2823 00000B23 268A1C                  		mov     bl, [es:si]
  2824 00000B26 8A9F[6E6E]              		mov     bl, [VolTable+bx]
  2825 00000B2A 001D                    		add     [di], bl
  2826 00000B2C 47                      		inc     di
  2827 00000B2D 00C4                    		add     ah, al
  2828 00000B2F 11D6                    		adc     si, dx
  2829 00000B31 E2E8                    		loop    lpMixSamp
  2830                                  lpMixBye:       
  2831 00000B33 89F3                    		mov     bx, si
  2832 00000B35 5E                      		pop     si
  2833 00000B36 5A                      		pop     dx
  2834 00000B37 29D3                    		sub     bx, dx
  2835 00000B39 895C04                  		mov     [si+TrackInfo.Position], bx
  2836 00000B3C 88640D                  		mov     [si+TrackInfo.Error], ah
  2837 00000B3F C3                      		retn
  2838                                  
  2839                                  GetSamples_ICH:
  2840                                  		; 11/05/2024
  2841                                  		; 18/02/2017
  2842                                  		; 8 bit mono samples 
  2843                                  		; must be converted to 16 bit, stereo samples (for ICH) !
  2844                                  		; (ICH AC97 Modification by Erdogan Tan)
  2845 00000B40 8936[90C4]              		mov	[_si_], si ; DMA Buff Addr, [DMA_BUFFER1] or [DMA_BUFFER2]
  2846                                  		; 11/05/2024
  2847                                  		;mov	si, MOD_BUFFER
  2848                                  		;shr	cx, 2 ; mod buffer size = dma (half) buffer size / 4 (*)
  2849                                  
  2850                                  ;--------------------------------------------------------------------------
  2851                                  ; GetSamples:  Returns the next chunk of samples to be played.
  2852                                  ;  In:
  2853                                  ;    Buffer  - Buffer Address.
  2854                                  ;    Count   - Buffer Size.
  2855                                  ;--------------------------------------------------------------------------
  2856                                  
  2857                                  GetSamples:
  2858                                  		;ds:si = buffer address
  2859                                  		;cx = count
  2860                                  
  2861                                  		; 11/05/2024
  2862                                  		;
  2863                                  		;;[sp+6] = ds
  2864                                  		;;[sp+4] = si
  2865                                  		;;[sp+2] = count
  2866                                  		;
  2867                                  		;Count	equ 4
  2868                                  		;Buffer	equ 6 
  2869                                  		;
  2870                                  		;push	bp
  2871                                  		;mov	bp, sp
  2872                                  		;
  2873                                  		;push    es
  2874                                  		;;;push  ds
  2875                                  		;;;pusha
  2876                                  		;
  2877                                  		;cld
  2878                                  		;
  2879                                  		;les	di, [bp+Buffer]
  2880                                  		;mov    bx, [bp+Count]
  2881                                  
  2882                                  		; 11/05/2024
  2883                                  		; ds = cs
  2884 00000B44 06                      		push	es ; +
  2885                                  
  2886 00000B45 1E                      		push	ds
  2887 00000B46 07                      		pop	es
  2888                                  
  2889                                  		; 11/05/2024
  2890 00000B47 BF[92C4]                		mov	di, MOD_BUFFER
  2891 00000B4A BB000A                  		mov	bx, (BUFFERSIZE/4) ; (*) ; 2048
  2892                                  NextChunk:
  2893 00000B4D 833E[78BF]00            		cmp     word [BufLen], 0
  2894 00000B52 7534                    		jne     short CopyChunk
  2895                                  
  2896                                  		; 11/05/2024
  2897 00000B54 06                      		push	es
  2898 00000B55 53                      		push	bx
  2899 00000B56 57                      		push	di
  2900                                  MixChunk:       
  2901                                  		;lea    di, [MixBuffer]
  2902 00000B57 BF[6EAF]                		mov	di, MixBuffer
  2903 00000B5A 8B0E[74BF]              		mov     cx, [BpmSamples]
  2904 00000B5E 893E[76BF]              		mov     [BufPtr], di
  2905 00000B62 890E[78BF]              		mov     [BufLen], cx
  2906                                  
  2907                                  		; 12/05/2024
  2908                                  		; es = ds
  2909                                  		;mov    ax, ds
  2910                                  		;mov    es, ax
  2911                                  
  2912 00000B66 B080                    		mov    al, 80h
  2913 00000B68 F3AA                    		rep    stosb
  2914                                  
  2915 00000B6A B90400                  		mov	cx, NumTracks
  2916 00000B6D BE[5EBF]                		mov	si, Tracks - TrackInfo.size
  2917                                  GetSamples_next:
  2918 00000B70 51                      		push	cx
  2919 00000B71 83C622                  		add	si, TrackInfo.size
  2920 00000B74 8B0E[78BF]              		mov	cx, [BufLen]
  2921 00000B78 8B3E[76BF]              		mov	di, [BufPtr]
  2922 00000B7C E82CFF                  		call	MixTrack
  2923 00000B7F 59                      		pop	cx
  2924 00000B80 E2EE                    		loop	GetSamples_next
  2925                                  
  2926 00000B82 E8A0FE                  		call    UpdateTracks
  2927                                  
  2928 00000B85 5F                      		pop	di
  2929 00000B86 5B                      		pop	bx
  2930 00000B87 07                      		pop	es ; es = ds ; 12/05/2024
  2931                                  CopyChunk:      
  2932 00000B88 8B0E[78BF]              		mov     cx, [BufLen]
  2933 00000B8C 39D9                    		cmp     cx, bx
  2934 00000B8E 7602                    		jbe     short MoveChunk
  2935 00000B90 89D9                    		mov     cx, bx
  2936                                  MoveChunk:
  2937 00000B92 8B36[76BF]              		mov     si, [BufPtr]
  2938 00000B96 010E[76BF]              		add     [BufPtr], cx
  2939 00000B9A 290E[78BF]              		sub     [BufLen], cx
  2940 00000B9E 29CB                    		sub     bx, cx
  2941 00000BA0 F3A4                    		rep     movsb
  2942 00000BA2 85DB                    		test    bx, bx
  2943 00000BA4 75A7                    		jnz     short NextChunk
  2944                                  
  2945                                  		;;popa
  2946                                  		;;pop	ds
  2947                                  		;pop	es
  2948                                  		;pop	bp
  2949                                  		;ret	6
  2950                                  
  2951                                  ; GetSamples_ICH_convert_samples:
  2952                                  		; 11/05/2024
  2953                                  		; es = ds = cs
  2954                                  		; 18/02/2017
  2955                                  		;mov	di, ds
  2956                                  		;mov	es, di
  2957 00000BA6 8B3E[90C4]              		mov	di, [_si_] ; DMA Buffer Address (16 bit, stereo)
  2958 00000BAA BE[91C4]                		mov	si, MOD_BUFFER - 1 ; buffer for 8 bit mono samples
  2959 00000BAD B9000A                  		mov	cx, (BUFFERSIZE/4) ; (*) ; 2048 ; 11/04/2024
  2960 00000BB0 30C0                    		xor	al, al
  2961                                  gscs_loop:		
  2962 00000BB2 46                      		inc	si
  2963 00000BB3 8A24                    		mov	ah, [si] ; convert 8 bit sample to 16 bit sample
  2964                                  		; 11/05/2024
  2965 00000BB5 80EC80                  		sub	ah, 80h
  2966                                  
  2967 00000BB8 AB                      		stosw	; left channel
  2968 00000BB9 AB                      		stosw	; right channel
  2969 00000BBA E2F6                    		loop	gscs_loop
  2970                                  
  2971                                  		; 11/05/2024
  2972 00000BBC 07                      		pop	es ; +
  2973                                  		;pop	bp
  2974                                  		;ret	6
  2975 00000BBD C3                      		retn
  2976                                  
  2977                                  ;--------------------------------------------------------------------------
  2978                                  ; StartPlaying: Initializes the Sound System.
  2979                                  ;  In:
  2980                                  ;   Module Information Resources.
  2981                                  ;--------------------------------------------------------------------------
  2982                                  
  2983                                  StartPlaying:
  2984 00000BBE 60                      		pusha
  2985 00000BBF 1E                      		push    ds
  2986 00000BC0 06                      		push    es
  2987                                  SetModParms:    
  2988 00000BC1 C606[6EBF]00            		mov     byte [OrderPos], 0
  2989 00000BC6 C606[6FBF]06            		mov     byte [Tempo], DefTempo
  2990 00000BCB C606[70BF]06            		mov     byte [TempoWait], DefTempo
  2991 00000BD0 C606[71BF]7D            		mov     byte [Bpm], DefBpm
  2992 00000BD5 C606[72BF]40            		mov     byte [Row], 64
  2993 00000BDA C606[73BF]00            		mov     byte [BreakRow], 0
  2994 00000BDF A1[C065]                		mov     ax, [MixSpeed]
  2995 00000BE2 31D2                    		xor     dx, dx
  2996 00000BE4 BB3200                  		mov     bx, 24*DefBpm/60
  2997 00000BE7 F7F3                    		div     bx
  2998 00000BE9 A3[74BF]                		mov     [BpmSamples], ax
  2999                                  ClearTracks:    
  3000 00000BEC BF[80BF]                		mov     di, Tracks
  3001 00000BEF 8CD8                    		mov     ax, ds
  3002 00000BF1 8EC0                    		mov     es, ax
  3003 00000BF3 B98800                  		mov     cx, NumTracks*TrackInfo.size
  3004 00000BF6 31C0                    		xor     ax, ax
  3005 00000BF8 FC                      		cld
  3006 00000BF9 F3AA                    		rep     stosb
  3007                                  
  3008 00000BFB A3[76BF]                		mov     [BufPtr], ax
  3009 00000BFE A3[78BF]                		mov     [BufLen], ax
  3010                                  MakePitch:
  3011 00000C01 B80021                  		mov     ax, MidCRate
  3012 00000C04 BBAC01                  		mov     bx, 428
  3013 00000C07 F7E3                    		mul     bx
  3014 00000C09 F736[C065]              		div     word [MixSpeed]
  3015 00000C0D 30F6                    		xor     dh, dh
  3016 00000C0F 88E2                    		mov     dl, ah
  3017 00000C11 88C4                    		mov     ah, al
  3018 00000C13 30C0                    		xor     al, al
  3019 00000C15 B95903                  		mov     cx, 857
  3020 00000C18 31DB                    		xor     bx, bx
  3021 00000C1A BF[BC67]                		mov     di, PitchTable
  3022                                  PitchLoop:      
  3023 00000C1D 50                      		push    ax
  3024 00000C1E 52                      		push    dx
  3025 00000C1F 39DA                    		cmp     dx, bx
  3026 00000C21 7302                    		jae     short NoDiv
  3027 00000C23 F7F3                    		div     bx
  3028                                  NoDiv:          
  3029 00000C25 AB                      		stosw
  3030 00000C26 5A                      		pop     dx
  3031 00000C27 58                      		pop     ax
  3032 00000C28 43                      		inc     bx
  3033 00000C29 E2F2                    		loop    PitchLoop
  3034                                  MakeVolume:     
  3035 00000C2B B90041                  		mov     cx, 16640
  3036 00000C2E 89CB                    		mov     bx, cx
  3037                                  VolLoop:
  3038 00000C30 4B                      		dec     bx
  3039 00000C31 88D8                    		mov     al, bl
  3040 00000C33 F6EF                    		imul    bh
  3041 00000C35 88A7[6E6E]              		mov     [VolTable+bx], ah
  3042 00000C39 E2F5                    		loop    VolLoop
  3043                                  
  3044 00000C3B 07                      		pop     es
  3045 00000C3C 1F                      		pop     ds
  3046 00000C3D 61                      		popa
  3047 00000C3E C3                      		retn	; 12/05/2024
  3048                                  
  3049                                  ;--------------------------------------------------------------------------
  3050                                  ; StopPlaying: ShutDown the Sound System.
  3051                                  ;--------------------------------------------------------------------------
  3052                                  
  3053                                  StopPlaying:
  3054                                  	; 08/05/2024
  3055                                  	; 04/11/2023
  3056                                  	; finished with song, stop everything
  3057 00000C3F E8CB01                  	call	ac97_stop
  3058                                  
  3059                                  	; 11/11/2023
  3060                                  irq_restore:	
  3061                                  	; restore previous interrupt vector and interrupt_status
  3062 00000C42 FA                      	cli
  3063 00000C43 E4A1                    	in	al, 0A1h ; irq 8-15
  3064 00000C45 A0[5D10]                	mov	al, [IRQ_status+1]
  3065 00000C48 E6A1                    	out	0A1h, al 
  3066 00000C4A E421                    	in	al, 021h ; irq 0-7
  3067 00000C4C A0[5C10]                	mov	al, [IRQ_status]
  3068 00000C4F E621                    	out	21h, al 
  3069                                  	; ...
  3070 00000C51 06                      	push	es
  3071 00000C52 31C0                    	xor	ax, ax
  3072 00000C54 8EC0                    	mov	es, ax
  3073 00000C56 A1[5E10]                	mov	ax, [IRQ_vector]
  3074 00000C59 268907                  	mov	[es:bx], ax
  3075 00000C5C A1[6010]                	mov	ax, [IRQ_vector+2]
  3076 00000C5F 26894702                	mov	[es:bx+2], ax
  3077 00000C63 07                      	pop	es
  3078                                  
  3079 00000C64 FB                      	sti
  3080                                  
  3081 00000C65 C3                      	retn
  3082                                  
  3083                                  ;=============================================================================
  3084                                  ;               PLAYER.ASM
  3085                                  ;=============================================================================
  3086                                  
  3087                                  ; UTILS.ASM
  3088                                  ;----------------------------------------------------------------------------
  3089                                  ;       delay1_4ms - Delay for 1/4 millisecond.
  3090                                  ;		    1mS = 1000us
  3091                                  ;       Entry:
  3092                                  ;         None
  3093                                  ;       Exit:
  3094                                  ;	  None
  3095                                  ;
  3096                                  ;       Modified:
  3097                                  ;         None
  3098                                  ;
  3099                                  PORTB			EQU	061h
  3100                                    REFRESH_STATUS	EQU	010h		; Refresh signal status
  3101                                  
  3102                                  delay1_4ms:
  3103 00000C66 50                              push    ax 
  3104 00000C67 51                              push    cx
  3105 00000C68 B91000                          mov     cx, 16			; close enough.
  3106 00000C6B E461                    	in	al,PORTB
  3107 00000C6D 2410                    	and	al,REFRESH_STATUS
  3108 00000C6F 88C4                    	mov	ah,al			; Start toggle state
  3109 00000C71 09C9                    	or	cx, cx
  3110 00000C73 7401                    	jz	short _d4ms1
  3111 00000C75 41                      	inc	cx			; Throwaway first toggle
  3112                                  _d4ms1:	
  3113 00000C76 E461                    	in	al,PORTB		; Read system control port
  3114 00000C78 2410                    	and	al,REFRESH_STATUS	; Refresh toggles 15.085 microseconds
  3115 00000C7A 38C4                    	cmp	ah,al
  3116 00000C7C 74F8                    	je	short _d4ms1		; Wait for state change
  3117                                  
  3118 00000C7E 88C4                    	mov	ah,al			; Update with new state
  3119 00000C80 49                      	dec	cx
  3120 00000C81 75F3                    	jnz	short _d4ms1
  3121                                  
  3122 00000C83 59                              pop     cx
  3123 00000C84 58                              pop     ax
  3124 00000C85 C3                              retn
  3125                                  
  3126                                  print_msg:
  3127                                  	; 13/11/2016 - Erdogan Tan 
  3128                                  	; esi = ASCIIZ text address
  3129                                  	;
  3130 00000C86 BB0700                  	mov	bx, 7h
  3131 00000C89 B40E                    	mov	ah, 0Eh 
  3132                                  pm_next_char:
  3133 00000C8B AC                      	lodsb
  3134 00000C8C 20C0                    	and	al, al
  3135 00000C8E 7404                    	jz	short pm_retn
  3136 00000C90 CD10                    	int	10h
  3137 00000C92 EBF7                    	jmp	short pm_next_char
  3138                                  pm_retn:
  3139 00000C94 C3                      	retn
  3140                                  
  3141                                  dword2str:
  3142                                  	; 13/11/2016 - Erdogan Tan 
  3143                                  	; eax = dword value
  3144                                  	;
  3145 00000C95 E84400                  	call	dwordtohex
  3146 00000C98 668916[4810]            	mov	[dword_str], edx
  3147 00000C9D 66A3[4C10]              	mov	[dword_str+4], eax
  3148 00000CA1 BE[4810]                	mov	si, dword_str
  3149 00000CA4 C3                      	retn
  3150                                  
  3151                                  	; trdos386.s (unix386.s) - 10/05/2015
  3152                                  	; Convert binary number to hexadecimal string
  3153                                  
  3154                                  bytetohex:
  3155                                  	; INPUT ->
  3156                                  	; 	AL = byte (binary number)
  3157                                  	; OUTPUT ->
  3158                                  	;	AX = hexadecimal string
  3159                                  	;
  3160 00000CA5 53                      	push	bx
  3161 00000CA6 30FF                    	xor	bh, bh
  3162 00000CA8 88C3                    	mov	bl, al
  3163 00000CAA C0EB04                  	shr	bl, 4
  3164 00000CAD 8A9F[AA0F]              	mov	bl, [bx+hex_chars] 	 	
  3165 00000CB1 86D8                    	xchg	bl, al
  3166 00000CB3 80E30F                  	and	bl, 0Fh
  3167 00000CB6 8AA7[AA0F]              	mov	ah, [bx+hex_chars] 
  3168 00000CBA 5B                      	pop	bx	
  3169 00000CBB C3                      	retn
  3170                                  
  3171                                  wordtohex:
  3172                                  	; INPUT ->
  3173                                  	; 	AX = word (binary number)
  3174                                  	; OUTPUT ->
  3175                                  	;	EAX = hexadecimal string
  3176                                  	;
  3177 00000CBC 53                      	push	bx
  3178 00000CBD 30FF                    	xor	bh, bh
  3179 00000CBF 86E0                    	xchg	ah, al
  3180 00000CC1 50                      	push	ax
  3181 00000CC2 88E3                    	mov	bl, ah
  3182 00000CC4 C0EB04                  	shr	bl, 4
  3183 00000CC7 8A87[AA0F]              	mov	al, [bx+hex_chars] 	 	
  3184 00000CCB 88E3                    	mov	bl, ah
  3185 00000CCD 80E30F                  	and	bl, 0Fh
  3186 00000CD0 8AA7[AA0F]              	mov	ah, [bx+hex_chars]
  3187 00000CD4 66C1E010                	shl	eax, 16
  3188 00000CD8 58                      	pop	ax
  3189 00000CD9 5B                      	pop	bx
  3190 00000CDA EBC9                    	jmp	short bytetohex
  3191                                  
  3192                                  dwordtohex:
  3193                                  	; INPUT ->
  3194                                  	; 	EAX = dword (binary number)
  3195                                  	; OUTPUT ->
  3196                                  	;	EDX:EAX = hexadecimal string
  3197                                  	;
  3198 00000CDC 6650                    	push	eax
  3199 00000CDE 66C1E810                	shr	eax, 16
  3200 00000CE2 E8D7FF                  	call	wordtohex
  3201 00000CE5 6689C2                  	mov	edx, eax
  3202 00000CE8 6658                    	pop	eax
  3203 00000CEA E8CFFF                  	call	wordtohex
  3204 00000CED C3                      	retn
  3205                                  
  3206                                  	; 13/11/2016 - Erdogan Tan
  3207                                  write_ac97_dev_info:
  3208                                  	; BUS/DEV/FN
  3209                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  3210                                  	; DEV/VENDOR
  3211                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  3212                                  
  3213 00000CEE 30FF                    	xor	bh, bh
  3214 00000CF0 668B36[6E10]            	mov	esi, [dev_vendor]
  3215 00000CF5 89F0                    	mov	ax, si
  3216 00000CF7 88C3                    	mov	bl, al
  3217 00000CF9 88DA                    	mov	dl, bl
  3218 00000CFB 80E30F                  	and	bl, 0Fh
  3219 00000CFE 8A87[AA0F]              	mov	al, [bx+hex_chars]
  3220 00000D02 A2[ED0F]                	mov	[msgVendorId+3], al
  3221 00000D05 88D3                    	mov	bl, dl
  3222 00000D07 C0EB04                  	shr	bl, 4
  3223 00000D0A 8A87[AA0F]              	mov	al, [bx+hex_chars]
  3224 00000D0E A2[EC0F]                	mov	[msgVendorId+2], al
  3225 00000D11 88E3                    	mov	bl, ah
  3226 00000D13 88DA                    	mov	dl, bl
  3227 00000D15 80E30F                  	and	bl, 0Fh
  3228 00000D18 8A87[AA0F]              	mov	al, [bx+hex_chars]
  3229 00000D1C A2[EB0F]                	mov	[msgVendorId+1], al
  3230 00000D1F 88D3                    	mov	bl, dl
  3231 00000D21 C0EB04                  	shr	bl, 4
  3232 00000D24 8A87[AA0F]              	mov	al, [bx+hex_chars]
  3233 00000D28 A2[EA0F]                	mov	[msgVendorId], al
  3234 00000D2B 66C1EE10                	shr	esi, 16
  3235 00000D2F 89F0                    	mov	ax, si
  3236 00000D31 88C3                    	mov	bl, al
  3237 00000D33 88DA                    	mov	dl, bl
  3238 00000D35 80E30F                  	and	bl, 0Fh
  3239 00000D38 8A87[AA0F]              	mov	al, [bx+hex_chars]
  3240 00000D3C A2[FE0F]                	mov	[msgDevId+3], al
  3241 00000D3F 88D3                    	mov	bl, dl
  3242 00000D41 C0EB04                  	shr	bl, 4
  3243 00000D44 8A87[AA0F]              	mov	al, [bx+hex_chars]
  3244 00000D48 A2[FD0F]                	mov	[msgDevId+2], al
  3245 00000D4B 88E3                    	mov	bl, ah
  3246 00000D4D 88DA                    	mov	dl, bl
  3247 00000D4F 80E30F                  	and	bl, 0Fh
  3248 00000D52 8A87[AA0F]              	mov	al, [bx+hex_chars]
  3249 00000D56 A2[FC0F]                	mov	[msgDevId+1], al
  3250 00000D59 88D3                    	mov	bl, dl
  3251 00000D5B C0EB04                  	shr	bl, 4
  3252 00000D5E 8A87[AA0F]              	mov	al, [bx+hex_chars]
  3253 00000D62 A2[FB0F]                	mov	[msgDevId], al
  3254                                  
  3255 00000D65 668B36[6A10]            	mov	esi, [bus_dev_fn]
  3256 00000D6A 66C1EE08                	shr	esi, 8
  3257 00000D6E 89F0                    	mov	ax, si
  3258 00000D70 88C3                    	mov	bl, al
  3259 00000D72 88DA                    	mov	dl, bl
  3260 00000D74 80E307                  	and	bl, 7 ; bit 0,1,2
  3261 00000D77 8A87[AA0F]              	mov	al, [bx+hex_chars]
  3262 00000D7B A2[2210]                	mov	[msgFncNo+1], al
  3263 00000D7E 88D3                    	mov	bl, dl
  3264 00000D80 C0EB03                  	shr	bl, 3
  3265 00000D83 88DA                    	mov	dl, bl
  3266 00000D85 80E30F                  	and	bl, 0Fh
  3267 00000D88 8A87[AA0F]              	mov	al, [bx+hex_chars]
  3268 00000D8C A2[1410]                	mov	[msgDevNo+1], al
  3269 00000D8F 88D3                    	mov	bl, dl
  3270 00000D91 C0EB04                  	shr	bl, 4
  3271 00000D94 8A87[AA0F]              	mov	al, [bx+hex_chars]
  3272 00000D98 A2[1310]                	mov	[msgDevNo], al
  3273 00000D9B 88E3                    	mov	bl, ah
  3274 00000D9D 88DA                    	mov	dl, bl
  3275 00000D9F 80E30F                  	and	bl, 0Fh
  3276 00000DA2 8A87[AA0F]              	mov	al, [bx+hex_chars]
  3277 00000DA6 A2[0810]                	mov	[msgBusNo+1], al
  3278 00000DA9 88D3                    	mov	bl, dl
  3279 00000DAB C0EB04                  	shr	bl, 4
  3280 00000DAE 8A87[AA0F]              	mov	al, [bx+hex_chars]
  3281 00000DB2 A2[0710]                	mov	[msgBusNo], al
  3282                                  
  3283                                  	;mov	ax, [ac97_io_base]
  3284                                  	; 08/05/2024
  3285 00000DB5 A1[5610]                	mov	ax, [NABMBAR]
  3286 00000DB8 88C3                    	mov	bl, al
  3287 00000DBA 88DA                    	mov	dl, bl
  3288 00000DBC 80E30F                  	and	bl, 0Fh
  3289 00000DBF 8A87[AA0F]              	mov	al, [bx+hex_chars]
  3290 00000DC3 A2[3B10]                	mov	[msgIOBaseAddr+3], al
  3291 00000DC6 88D3                    	mov	bl, dl
  3292 00000DC8 C0EB04                  	shr	bl, 4
  3293 00000DCB 8A87[AA0F]              	mov	al, [bx+hex_chars]
  3294 00000DCF A2[3A10]                	mov	[msgIOBaseAddr+2], al
  3295 00000DD2 88E3                    	mov	bl, ah
  3296 00000DD4 88DA                    	mov	dl, bl
  3297 00000DD6 80E30F                  	and	bl, 0Fh
  3298 00000DD9 8A87[AA0F]              	mov	al, [bx+hex_chars]
  3299 00000DDD A2[3910]                	mov	[msgIOBaseAddr+1], al
  3300 00000DE0 88D3                    	mov	bl, dl
  3301 00000DE2 C0EB04                  	shr	bl, 4
  3302 00000DE5 8A87[AA0F]              	mov	al, [bx+hex_chars]
  3303 00000DE9 A2[3810]                	mov	[msgIOBaseAddr], al
  3304                                  
  3305                                  	; 24/11/2016
  3306 00000DEC 30E4                    	xor	ah, ah
  3307 00000DEE A0[6810]                	mov	al, [ac97_int_ln_reg]
  3308 00000DF1 B10A                    	mov	cl, 10
  3309 00000DF3 F6F1                    	div	cl
  3310 00000DF5 0106[4310]              	add	[msgIRQ], ax
  3311 00000DF9 20C0                    	and	al, al
  3312 00000DFB 7508                    	jnz	short _pmi
  3313 00000DFD A0[4410]                	mov	al, [msgIRQ+1]
  3314 00000E00 B420                    	mov	ah, ' '
  3315 00000E02 A3[4310]                	mov	[msgIRQ], ax
  3316                                  _pmi:
  3317 00000E05 BA[BB0F]                        mov	dx, msgAC97Info
  3318 00000E08 B409                            mov     ah, 9
  3319 00000E0A CD21                            int     21h
  3320 00000E0C C3                              retn
  3321                                  
  3322                                  	; 08/05/2024
  3323                                  ac97_stop:
  3324                                  	; 11/11/2023
  3325                                  	; 09/11/2023
  3326                                  	; 05/11/2023
  3327                                  	; 04/11/2023 
  3328                                  	; 28/05/2017 (TRDOS 386 v2, 'audio.s')
  3329                                  	;mov	byte [tLoop], 0 ; stop ! ; 05/11/2023
  3330                                  ;_ac97_stop:
  3331                                  
  3332                                  	; 11/11/2023
  3333 00000E0D 8B16[5410]              	mov	dx, [NAMBAR]
  3334                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  3335 00000E11 EF                      	out	dx, ax
  3336                                  
  3337                                  	; 04/11/2023
  3338                                  	; 09/10/2017 (TRDOS 386 v2, 'audio.s')
  3339                                  	; 11/06/2017
  3340 00000E12 30C0                    	xor	al, al ; 0
  3341 00000E14 E80D00                  	call	ac97_po_cmd
  3342                                  
  3343                                  	; (Ref: KolibriOS, intelac97.asm, 'stop:')
  3344                                  	; Clear FIFOE, BCIS, LVBCI (Ref: Intel ICH hub manual)
  3345 00000E17 B81C00                  	mov     ax, 1Ch
  3346 00000E1A 8B16[5610]              	mov     dx, [NABMBAR]
  3347 00000E1E 83C216                  	add     dx, PO_SR_REG
  3348 00000E21 EF                      	out     dx, ax
  3349                                  
  3350                                  	; 11/06/2017
  3351 00000E22 B002                    	mov     al, RR
  3352                                  ac97_po_cmd:
  3353                                  	; 11/06/2017
  3354                                  	; 29/05/2017
  3355 00000E24 8B16[5610]              	mov     dx, [NABMBAR]
  3356 00000E28 83C21B                          add     dx, PO_CR_REG		; PCM out control register
  3357 00000E2B EE                      	out	dx, al
  3358 00000E2C C3                      	retn
  3359                                  
  3360                                  ;=============================================================================
  3361                                  ;               preinitialized data
  3362                                  ;=============================================================================
  3363                                  
  3364                                  ;=============================================================================
  3365                                  ;               PLAY.ASM - DATA
  3366                                  ;=============================================================================
  3367                                  
  3368                                  msg_2017:
  3369 00000E2D 54696E79204D4F4420-     		db	'Tiny MOD Player by Erdogan Tan. May 2024.',10,13
  3369 00000E36 506C61796572206279-
  3369 00000E3F 204572646F67616E20-
  3369 00000E48 54616E2E204D617920-
  3369 00000E51 323032342E0A0D     
  3370 00000E58 75736167653A20706C-     		db	'usage: playmod2 filename.mod', 10, 13, '$'
  3370 00000E61 61796D6F6432206669-
  3370 00000E6A 6C656E616D652E6D6F-
  3370 00000E73 640A0D24           
  3371 00000E77 31382F30322F323031-     		db	'18/02/2017',0
  3371 00000E80 3700               
  3372 00000E82 31352F30352F323032-     		db	'15/05/2024',0
  3372 00000E8B 3400               
  3373                                  
  3374 00000E8D 54696E79204D4F4420-     Credits:	db	'Tiny MOD Player v0.1b by Carlos Hasan. July 1993.'
  3374 00000E96 506C61796572207630-
  3374 00000E9F 2E3162206279204361-
  3374 00000EA8 726C6F732048617361-
  3374 00000EB1 6E2E204A756C792031-
  3374 00000EBA 3939332E           
  3375                                  CRLF:		; 13/05/2024
  3376 00000EBE 0A0D24                  		db	10,13,'$'
  3377 00000EC1 4572726F72206C6F61-     ErrorMesg:	db	'Error loading Module file.',10,13,'$'
  3377 00000ECA 64696E67204D6F6475-
  3377 00000ED3 6C652066696C652E0A-
  3377 00000EDC 0D24               
  3378                                  
  3379                                  ;=============================================================================
  3380                                  ;               MODPLAY.ASM - DATA
  3381                                  ;=============================================================================
  3382                                  
  3383                                  ;Credits:	db	'Amiga Module Player v0.3b by Carlos Hasan.'
  3384                                  
  3385 00000EDE 0019324A62788EA2B4-     SinTable:	db	0,25,50,74,98,120,142,162,180,197,212,225
  3385 00000EE7 C5D4E1             
  3386 00000EEA ECF4FAFEFFFEFAF4EC-     		db	236,244,250,254,255,254,250,244,236,225
  3386 00000EF3 E1                 
  3387 00000EF4 D4C5B4A28E78624A32-     		db	212,197,180,162,142,120,98,74,50,25
  3387 00000EFD 19                 
  3388                                  
  3389 00000EFE 58032803FA02D002A6-     PeriodTable:	dw	856,808,762,720,678,640,604,570,538,508,480,453
  3389 00000F07 0280025C023A021A02-
  3389 00000F10 FC01E001C501       
  3390 00000F16 AC0194017D01680153-     		dw	428,404,381,360,339,320,302,285,269,254,240,226
  3390 00000F1F 0140012E011D010D01-
  3390 00000F28 FE00F000E200       
  3391 00000F2E D600CA00BE00B400AA-     		dw	214,202,190,180,170,160,151,143,135,127,120,113
  3391 00000F37 00A00097008F008700-
  3391 00000F40 7F0078007100       
  3392                                  
  3393                                  ;=============================================================================
  3394                                  ;               PLAYWAV.ASM / PLAYER.ASM - DATA
  3395                                  ;=============================================================================
  3396                                  
  3397                                  ; 24/11/2016
  3398                                  ;	       IRQ  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 
  3399 00000F46 08090A0B0C0D0E0F70-     irq_int:	db 08h,09h,0Ah,0Bh,0Ch,0Dh,0Eh,0Fh,70h,71h,72h,73h,74h,75h,76h,77h
  3399 00000F4F 71727374757677     
  3400                                  
  3401                                  ; 17/02/2017
  3402                                  ; Valid ICH device IDs
  3403                                  
  3404                                  valid_ids:
  3405 00000F56 86801524                dd	(ICH_DID << 16) + INTEL_VID  	 ; 8086h:2415h
  3406 00000F5A 86802524                dd	(ICH0_DID << 16) + INTEL_VID 	 ; 8086h:2425h
  3407 00000F5E 86804524                dd	(ICH2_DID << 16) + INTEL_VID 	 ; 8086h:2445h
  3408 00000F62 86808524                dd	(ICH3_DID << 16) + INTEL_VID 	 ; 8086h:2485h
  3409 00000F66 8680C524                dd	(ICH4_DID << 16) + INTEL_VID 	 ; 8086h:24C5h
  3410 00000F6A 8680D524                dd	(ICH5_DID << 16) + INTEL_VID 	 ; 8086h:24D5h
  3411 00000F6E 86806E26                dd	(ICH6_DID << 16) + INTEL_VID 	 ; 8086h:266Eh
  3412 00000F72 8680A625                dd	(ESB6300_DID << 16) + INTEL_VID  ; 8086h:25A6h
  3413 00000F76 86809826                dd	(ESB631X_DID << 16) + INTEL_VID  ; 8086h:2698h
  3414 00000F7A 8680DE27                dd	(ICH7_DID << 16) + INTEL_VID 	 ; 8086h:27DEh
  3415                                  ; 03/11/2023 - Erdogan Tan
  3416 00000F7E 86809571                dd	(MX82440_DID << 16) + INTEL_VID  ; 8086h:7195h
  3417 00000F82 39101270                dd	(SI7012_DID << 16)  + SIS_VID	 ; 1039h:7012h
  3418 00000F86 DE10B101                dd 	(NFORCE_DID << 16)  + NVIDIA_VID ; 10DEh:01B1h
  3419 00000F8A DE106A00                dd 	(NFORCE2_DID << 16) + NVIDIA_VID ; 10DEh:006Ah
  3420 00000F8E 22106D74                dd 	(AMD8111_DID << 16) + AMD_VID 	 ; 1022h:746Dh
  3421 00000F92 22104574                dd 	(AMD768_DID << 16)  + AMD_VID 	 ; 1022h:7445h
  3422 00000F96 DE105900                dd 	(CK804_DID << 16) + NVIDIA_VID	 ; 10DEh:0059h
  3423 00000F9A DE103A00                dd 	(MCP04_DID << 16) + NVIDIA_VID	 ; 10DEh:003Ah
  3424 00000F9E DE108A00                dd 	(CK8_DID << 16) + NVIDIA_VID	 ; 1022h:008Ah
  3425 00000FA2 DE10DA00                dd 	(NFORCE3_DID << 16) + NVIDIA_VID ; 10DEh:00DAh
  3426 00000FA6 DE10EA00                dd 	(CK8S_DID << 16) + NVIDIA_VID	 ; 10DEh:00EAh
  3427                                  
  3428                                  valid_id_count:	equ ($ - valid_ids)>>2 ; 05/11/2023
  3429                                  
  3430                                  ; 13/11/2016
  3431 00000FAA 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  3431 00000FB3 3941424344454600   
  3432 00000FBB 414339372041756469-     msgAC97Info	db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  3432 00000FC4 6F20436F6E74726F6C-
  3432 00000FCD 6C6572202620436F64-
  3432 00000FD6 656320496E666F0D0A 
  3433 00000FDF 56656E646F72204944-     		db "Vendor ID: "
  3433 00000FE8 3A20               
  3434 00000FEA 303030306820446576-     msgVendorId	db "0000h Device ID: "
  3434 00000FF3 6963652049443A20   
  3435 00000FFB 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  3436 00001002 4275733A20              		db "Bus: "
  3437 00001007 303068204465766963-     msgBusNo	db "00h Device: "
  3437 00001010 653A20             
  3438 00001013 3030682046756E6374-     msgDevNo	db "00h Function: "
  3438 0000101C 696F6E3A20         
  3439 00001021 303068                  msgFncNo	db "00h"
  3440 00001024 0D0A                    		db 0Dh, 0Ah
  3441 00001026 492F4F204261736520-     		db "I/O Base Address: "
  3441 0000102F 416464726573733A20 
  3442 00001038 303030306820495251-     msgIOBaseAddr	db "0000h IRQ: "
  3442 00001041 3A20               
  3443 00001043 3030                    msgIRQ		dw 3030h
  3444 00001045 0D0A24                  		db 0Dh, 0Ah, "$"
  3445                                  
  3446                                  ;msgSampleRate	db "Sample Rate: "
  3447                                  ;msgHertz	db "00000 Hz ", "$" 
  3448                                  ;msg8Bits	db "8 bits ", "$" 
  3449                                  ;msgMono	db "Mono", 0Dh, 0Ah, "$"
  3450                                  ;msg16Bits	db "16 bits ", "$" 
  3451                                  ;msgStereo	db "Stereo", 0Dh, 0Ah, "$"
  3452                                  
  3453                                  ;; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
  3454                                  ;codec_id	dd 0
  3455                                  ;codec_chip_id	dd 0
  3456                                  ;codec_vendor_ids dw 0
  3457                                  ;codec_chip_ids	dw 0
  3458                                  
  3459 00001048 3030303030303030        dword_str	 dd 30303030h, 30303030h
  3460 00001050 680D0A00                		 db 'h', 0Dh, 0Ah, 0
  3461                                  
  3462                                  ;=============================================================================
  3463                                  ;        	uninitialized data
  3464                                  ;=============================================================================
  3465                                  
  3466                                  bss_start:
  3467                                  
  3468                                  ABSOLUTE bss_start
  3469                                  
  3470                                  alignb 4
  3471                                  
  3472                                  ; 17/02/2017
  3473                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  3474                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  3475                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  3476                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  3477 00001054 ????                    NAMBAR:		resw 1			; BAR for mixer
  3478 00001056 ????                    NABMBAR         resw 1			; BAR for bus master regs
  3479                                  
  3480 00001058 ??                      tBuff:		resb	1
  3481                                  ;irq_status:	resb 	1
  3482 00001059 ??                      pcm_irq_status:	resb	1 ; 08/05/2024
  3483                                  
  3484 0000105A ??                      inside:		resb	1 
  3485 0000105B ??                      tLoop:		resb 	1
  3486                                  
  3487                                  ; 08/05/2024
  3488 0000105C ????                    IRQ_status:	resw 1	; IRQ status before enabling audio interrupt
  3489 0000105E ????????                IRQ_vector:	resd 1  ; Previous interrupt handler address	
  3490                                  
  3491                                  ; 256 byte buffer for descriptor list
  3492 00001062 ????                    BDL_BUFFER:	resw	1		; segment of our 256byte BDL buffer
  3493 00001064 ????                    DMA_BUFFER1:	resw 	1		; Pointer to 1st half of DMA Buffer
  3494 00001066 ????                    DMA_BUFFER2:	resw	1		; Pointer to 1st half of DMA Buffer
  3495                                  
  3496                                  ; 12/11/2016 - Erdogan Tan
  3497                                  
  3498 00001068 ??                      ac97_int_ln_reg: resb 1 
  3499 00001069 ??                      err_num:	resb 1
  3500                                  
  3501 0000106A ????????                bus_dev_fn:	resd 1
  3502 0000106E ????????                dev_vendor:	resd 1
  3503                                  ; 08/05/2024
  3504                                  ;stats_cmd:	resd 1
  3505                                  ;ac97_io_base:	resw 1
  3506 00001072 ??                      LVI:		resb 1
  3507                                  ; 12/05/2024
  3508 00001073 ??                      volume:		resb 1
  3509                                  
  3510                                  ;alignb 4
  3511                                  ; 13/05/2024
  3512 00001074 <res Ch>                alignb 16
  3513                                  
  3514 00001080 <res 100h>              BdlBuffer:	resb	BDL_SIZE ; 13/02/2017
  3515 00001180 <res 5000h>             DmaBuffer:	resb	2*BUFFERSIZE ; 13/02/2017
  3516                                  
  3517                                  ; MODLOAD.ASM
  3518 00006180 ????                    FileHandle:	resw	1
  3519 00006182 ????                    ErrorInfo:	resw	1
  3520 00006184 <res 43Ch>              Header:		resb	ModHeader.size
  3521                                  
  3522                                  sample_rate: ; PLAYER.ASM (22050Hz)
  3523                                  ; MODPLAY.ASM
  3524 000065C0 ????                    MixSpeed:	resw 1
  3525                                  
  3526                                  ModInfo:
  3527 000065C2 ??                      ModInfo.OrderLen:   resb 1
  3528 000065C3 ??                      ModInfo.ReStart:    resb 1
  3529 000065C4 <res 80h>               ModInfo.Order:	    resb 128
  3530 00006644 ????????                ModInfo.Patterns:   resd 1
  3531                                  
  3532 00006648 <res 3Eh>               ModInfo.SampOfs:    resw 31
  3533 00006686 <res 3Eh>               ModInfo.SampSeg:    resw 31
  3534 000066C4 <res 3Eh>               ModInfo.SampLen:    resw 31
  3535 00006702 <res 3Eh>               ModInfo.SampRep:    resw 31
  3536 00006740 <res 3Eh>               ModInfo.SampRepLen: resw 31
  3537 0000677E <res 3Eh>               ModInfo.SampVol:    resw 31
  3538                                  
  3539                                  ; MODPLAY.ASM
  3540 000067BC <res 6B2h>              PitchTable:	resw	857
  3541 00006E6E <res 4100h>             VolTable:	resb	16640
  3542 0000AF6E <res 1000h>             MixBuffer       resb	MixBufSize
  3543                                  
  3544                                  ; MODPLAY.ASM
  3545 0000BF6E ??                      OrderPos:	resb 1
  3546 0000BF6F ??                      Tempo:		resb 1
  3547 0000BF70 ??                      TempoWait:	resb 1
  3548 0000BF71 ??                      Bpm:		resb 1
  3549 0000BF72 ??                      Row:		resb 1
  3550 0000BF73 ??                      BreakRow:	resb 1
  3551 0000BF74 ????                    BpmSamples:	resw 1
  3552 0000BF76 ????                    BufPtr:		resw 1
  3553 0000BF78 ????                    BufLen:		resw 1
  3554 0000BF7A ????                    BufRep:		resw 1
  3555 0000BF7C ????????                Note:		resd 1
  3556 0000BF80 <res 88h>               Tracks:		resb TrackInfo.size*NumTracks
  3557                                  
  3558 0000C008 ????????????????        alignb 16
  3559                                  
  3560                                  ; PLAY.ASM
  3561 0000C010 <res 280h>              Scope:		resw	320
  3562 0000C290 <res 200h>              RowOfs:		resw	256
  3563                                  
  3564                                  ; 18/02/2017
  3565 0000C490 ????                    _si_:		resw 1
  3566 0000C492 <res A00h>              MOD_BUFFER:	resb BUFFERSIZE/4 ; 2048 ; 11/05/2024
  3567                                  EOF:
