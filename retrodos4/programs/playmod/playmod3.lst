     1                                  ; ****************************************************************************
     2                                  ; playmod3.asm (for MSDOS)
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; PLAYMOD3.COM ! ICH AC97 MOD PLAYER & VGA DEMO program by Erdogan TAN
     5                                  ;
     6                                  ; 18/02/2017
     7                                  ;
     8                                  ; [ Last Modification: 16/05/2024 ]
     9                                  ;
    10                                  ; Derived from source code of 'PLAYWAV.COM' ('PLAYWAV.ASM') by Erdogan Tan
    11                                  ;							      (17/02/2017)
    12                                  ; Modified from 'PLAYMOD2.COM' ('playmod2.asm') source code 
    13                                  ;		 AC97 MOD PLAYER & VGA DEMO program (tuneloop version)
    14                                  ;						by Erdogan TAN (12/05/2024)	
    15                                  ;
    16                                  ; Derived from source code of 'PLAY.EXE' (TINYPLAY) by Carlos Hasan (1993)
    17                                  ;          PLAY.EXE: PLAY.ASM, MODLOAD.ASM, MODPLAY.ASM, SB.ASM
    18                                  ;
    19                                  ; Assembler: NASM 2.15
    20                                  ; ----------------------------------------------------------------------------
    21                                  ;	   nasm  playmod3.asm -l playmod3.lst -o PLAYMOD3.COM	
    22                                  ; ****************************************************************************
    23                                  
    24                                  ; Tiny MOD Player v0.1b by Carlos Hasan.
    25                                  ;		July 14th, 1993.
    26                                  
    27                                  ;=============================================================================
    28                                  ;               PLAYWAV.ASM / PLAYER.ASM / TINYPLAY.ASM
    29                                  ;=============================================================================
    30                                  ; Audio controller, codec & PCI functions are derived from '.wav file player 
    31                                  ; for DOS' source code by Jeff Leyda (PLAYER.EXE), Sep 02, 2002.
    32                                  
    33                                  ; AC97 Interrupt version ; 12/05/2024
    34                                  
    35                                  [BITS 16]
    36                                  [org 100h]
    37                                  
    38                                  Start:
    39                                  	; 15/05/2024
    40                                  	; 13/05/2024
    41                                  	; Clear BSS (uninitialized data) area
    42                                  	;xor	ax, ax ; 0
    43                                  	;mov	cx, (EOF - bss_start)/2
    44                                  	;mov	di, bss_start
    45                                  	;rep	stosw
    46                                  
    47 00000000 E8C900                  	call    DetectICH		; Detect AC97 Audio Device
    48                                  GetFileName:    			; Parse  the Command line...
    49 00000003 BE8000                  	mov	si, 80h
    50 00000006 8A1C                    	mov	bl, [si]
    51 00000008 30FF                    	xor	bh, bh
    52 0000000A 43                      	inc	bx
    53 0000000B C60000                  	mov	byte [si+bx], 0		; make AsciiZ filename.
    54 0000000E 46                      	inc	si
    55                                  ScanName:       
    56 0000000F AC                      	lodsb
    57 00000010 84C0                    	test	al, al
    58 00000012 0F84AC00                	je	pmsg_2017
    59 00000016 3C20                    	cmp	al, 20h
    60 00000018 74F5                    	je	short ScanName		; scan start of name.
    61 0000001A 89F7                    	mov	di, si
    62 0000001C 4F                      	dec	di
    63                                  ScanPeriod:
    64 0000001D AC                      	lodsb
    65 0000001E 3C2E                    	cmp	al, '.'			; if period NOT found,
    66 00000020 7410                    	je	short PrintMesg		; then add a .MOD extension.
    67 00000022 84C0                    	test	al, al
    68 00000024 75F7                    	jnz	short ScanPeriod
    69 00000026 4E                      	dec	si
    70                                  SetExt:
    71                                  	;mov	byte [si+0], '.'
    72                                  	;mov	byte [si+1], 'M'
    73                                  	;mov	byte [si+2], 'O'
    74                                  	;mov	byte [si+3], 'D'
    75 00000027 66C7042E4D4F44          	mov	dword [si], '.MOD'
    76 0000002E C6440400                	mov	byte [si+4], 0
    77                                  
    78                                  PrintMesg:
    79 00000032 B80009                  	mov	ax, 0900h		; Prints the Credits Text.
    80                                  	;lea	dx, [Credits]
    81 00000035 BA[7D0E]                	mov	dx, Credits
    82 00000038 CD21                    	int	21h
    83                                  
    84                                  	; 13/05/2024
    85 0000003A E8A10C                  	call	write_ac97_dev_info
    86 0000003D B80009                  	mov	ax, 0900h		; Prints the Credits Text.
    87 00000040 BA[AE0E]                	mov	dx, CRLF
    88 00000043 CD21                    	int	21h
    89                                  LoadMod:  
    90                                  	; es:di = Filename address
    91 00000045 06                      	push	es
    92 00000046 57                      	push	di
    93 00000047 E89605                  	call    LoadModule		; Load the MODule...
    94                                  
    95 0000004A 833E[7289]00            	cmp     word [ErrorInfo], 0	; any error loading?
    96 0000004F 740A                    	je      short init_codec
    97                                  
    98 00000051 B80009                  	mov     ax, 0900h		; yes, print error and Exit.
    99                                  	;lea    dx, [ErrorMesg]
   100 00000054 BA[B10E]                	mov	dx, ErrorMesg
   101 00000057 CD21                    	int     21h
   102 00000059 EB60                    	jmp     Exit
   103                                  
   104                                  init_codec:
   105                                  	; 13/05/2024
   106                                  	;call	write_ac97_dev_info
   107                                  
   108                                  	; 08/05/2024
   109                                  	; 17/02/2017
   110                                  	;mov	dx, [stats_cmd]
   111                                          ;or	dl, IO_ENA+BM_ENA		; enable IO and bus master
   112                                          ;call	pciRegWrite16 ; pciRegWrite8
   113                                  
   114                                  	; 18/02/2017
   115                                  	;mov	word [sample_rate], 22050	; Mixing at 22.050 kHz
   116                                  	; 15/05/2024
   117 0000005B C706[B08D]C05D          	mov	word [sample_rate], 24000
   118                                  	; 16/05/2024
   119                                  	;mov	word [sample_rate], 16000
   120                                  
   121                                  	; 08/05/2024
   122                                  	; (48 kHZ mixing is necessary 
   123                                  	;  if the AC97 hardware/codec has not got VRA feature)
   124                                  	; ((or frequency converting code would be needed))
   125                                  	;mov	word [sample_rate], 48000	; Mixing at 48 kHz
   126                                  
   127                                  ; setup the Codec (actually mixer registers) 
   128 00000061 E87F02                          call    codecConfig			; unmute codec, set rates.
   129 00000064 731A                    	jnc	short PlayNow
   130                                  
   131                                  _codec_err:
   132 00000066 0E                      	push	cs
   133 00000067 1F                      	pop	ds
   134 00000068 BA[7100]                        mov	dx, CodecErrMsg
   135 0000006B B409                            mov     ah, 9
   136 0000006D CD21                            int     21h
   137 0000006F EB4A                            jmp     Exit
   138                                  
   139 00000071 436F64656320457272-     CodecErrMsg db "Codec Error!"
   139 0000007A 6F7221             
   140 0000007D 0D0A24                  	db	CR,LF,"$"
   141                                  PlayNow:  
   142 00000080 B8[7010]                	mov	ax, BdlBuffer
   143 00000083 A3[5210]                	mov	[BDL_BUFFER], ax
   144                                      
   145 00000086 B8[7011]                	mov	ax, DmaBuffer		; DmaBuffer (4096 bytes) buff addr
   146 00000089 A3[5410]                	mov	[DMA_BUFFER1], ax	; 2048 byte half buffer 1 
   147                                  
   148 0000008C 05003C                  	add	ax, BUFFERSIZE		; code/current segment
   149 0000008F A3[5610]                	mov	[DMA_BUFFER2], ax	; 2048 byte half buffer 2
   150                                    
   151                                  	;mov    word [MixSpeed], 22050	; Mixing at 22.050 kHz
   152                                  
   153 00000092 E8190B                  	call    StartPlaying
   154                                  
   155 00000095 B81300                  	mov     ax, 0013h		; Set Mode 320x200x256
   156 00000098 CD10                    	int     10h
   157                                  
   158 0000009A B98000                  	mov     cx, 128			; Make a lookup table
   159 0000009D 31DB                    	xor     bx, bx			; for fastest pixel
   160 0000009F BA002D                  	mov     dx, 320*(100-64)	; addressing.
   161                                  MakeOfs:        
   162 000000A2 8997[80EA]              	mov     [RowOfs+bx], dx
   163 000000A6 8997[82EA]              	mov     [RowOfs+bx+2], dx
   164 000000AA 81C24001                	add     dx, 320
   165 000000AE 83C304                  	add     bx, 4
   166 000000B1 E2EF                    	loop    MakeOfs
   167                                  
   168                                  ; Note: Normally IRQ 0 calls the ModPlay Polling at 18.2Hz thru
   169                                  ;       the software interrupt 1Ch. If the IRQ 0 is disabled, then
   170                                  ;       the INT 1Ch MUST BE CALLED at least MixSpeed/1024 times per
   171                                  ;       second, or the module will sound "looped".
   172                                  ;       Because we need better sync with the ModPlayer to draw the scope,
   173                                  ;       the polling is called from my routine, and then the irq 0 must be
   174                                  ;       disabled. The [DmaBuffer] points to the current buffer of 8-bit
   175                                  ;       samples played by the Sound Blaster. Note that some samples are
   176                                  ;       discarded in the next code, just for fun!
   177                                  
   178                                  	;in     al, 21h			; disable irq 0!
   179                                  	;or     al, 00000001b
   180                                  	;out    21h, al
   181                                  		
   182 000000B3 E8E203                  	call	ModPlay ; 13/02/2017
   183                                  
   184                                  	;in	al, 21h			; enable irq 0!
   185                                  	;and	al, 11111110b
   186                                  	;out	21h, al
   187                                  
   188 000000B6 B80300                  	mov     ax, 0003h		; Set Text Mode 80x25x16
   189 000000B9 CD10                    	int     10h
   190                                  
   191                                  	; 16/05/2024
   192                                  	;call	StopPlaying		; STOP!
   193                                  Exit:           
   194                                  	;call   FreeModule		; Free MODule core.
   195                                  error_exit:
   196 000000BB B8004C                  	mov     ax, 4C00h		; Bye!
   197 000000BE CD21                    	int     21h
   198                                  here:
   199 000000C0 EBFE                    	jmp	short here
   200                                  
   201                                  pmsg_2017:
   202 000000C2 B80009                  	mov     ax, 0900h		; Prints the Credits Text.
   203                                  	;lea    dx, [msg_2017]
   204 000000C5 BA[1D0E]                	mov	dx, msg_2017
   205 000000C8 CD21                    	int     21h
   206 000000CA EBEF                    	jmp	short Exit
   207                                  
   208                                  DetectICH:
   209                                  	; 18/02/2017
   210                                  	; Detech Intel ICH based AC97 Audio Device 
   211 000000CC E8D301                  	call    pciFindDevice 	; AC97.ASM (PLAYWAV.COM)
   212 000000CF 733F                            jnc     short _1
   213                                  
   214                                  ; couldn't find the audio device!
   215                                  	;push	cs
   216                                  	;pop	ds
   217 000000D1 BA[DA00]                        mov     dx, noDevMsg
   218 000000D4 B409                            mov     ah, 9
   219 000000D6 CD21                            int     21h
   220 000000D8 EBE1                            jmp     short error_exit
   221                                  
   222 000000DA 4572726F723A20556E-     noDevMsg db "Error: Unable to find Intel ICH based audio device!",CR,LF,"$"
   222 000000E3 61626C6520746F2066-
   222 000000EC 696E6420496E74656C-
   222 000000F5 204943482062617365-
   222 000000FE 6420617564696F2064-
   222 00000107 6576696365210D0A24 
   223                                  
   224                                  _1:
   225                                  	; 18/02/2017
   226                                  	; eax = BUS/DEV/FN
   227                                  	;	00000000BBBBBBBBDDDDDFFF00000000
   228                                  	; edx = DEV/VENDOR
   229                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
   230                                  
   231 00000110 66A3[5A10]              	mov	[bus_dev_fn], eax
   232 00000114 668916[5E10]            	mov	[dev_vendor], edx
   233                                  
   234                                  	; get ICH base address regs for mixer and bus master
   235                                  
   236 00000119 B010                            mov     al, NAMBAR_REG
   237 0000011B E8F600                          call    pciRegRead16			; read PCI registers 10-11
   238                                          ;and    dx, IO_ADDR_MASK 		; mask off BIT0
   239                                  	; 14/05/2024
   240 0000011E 80E2FE                  	and	dl, 0FEh
   241                                  
   242 00000121 8916[4410]                      mov     [NAMBAR], dx			; save audio mixer base addr
   243                                  
   244 00000125 B014                    	mov     al, NABMBAR_REG
   245 00000127 E8EA00                          call    pciRegRead16
   246                                          ;and    dx, IO_ADDR_MASK
   247                                  	; 14/05/2024
   248 0000012A 80E2C0                  	and	dl, 0C0h
   249                                  
   250 0000012D 8916[4610]                      mov     [NABMBAR], dx			; save bus master base addr
   251                                  
   252                                  	; 08/05/2024
   253                                  	; 06/11/2023
   254                                  	;; init controller
   255                                  	;; 17/02/2017
   256                                  	;mov	al, PCI_CMD_REG ; command register (04h)
   257                                  	;call	pciRegRead16 ; pciRegRead8
   258                                  	;
   259                                  	;; eax = BUS/DEV/FN/REG
   260                                  	;;  dx = PCI Command Register Content ; 17/02/2017
   261                                  	;; 	00000000CCCCCCCC
   262                                  	;mov	[stats_cmd], dx
   263                                  	;
   264                                  	; 06/11/2023
   265                                  	;mov	al, PCI_IO_BASE ; IO base address register (10h)
   266                                  	;call	pciRegRead32
   267                                  	;
   268                                  	;and	dx, 0FFC0h	; IO_ADDR_MASK (0FFFE) ?
   269                                          ;mov	[ac97_io_base], dx
   270                                  
   271 00000131 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
   272 00000133 E8D600                  	call	pciRegRead8 ; 17/02/2017
   273                                  
   274 00000136 8816[5810]              	mov     [ac97_int_ln_reg], dl
   275                                  
   276                                  	; 28/11/2016
   277                                  	;mov	bx, 1	; 08/05/2024
   278 0000013A 30F6                    	xor	dh, dh	; 17/02/2017
   279                                  	; 10/11/2023
   280                                  	;mov	cx, dx
   281                                  	;shl	bx, cl
   282                                  
   283                                  	; 04/11/2023
   284 0000013C FA                      	cli
   285                                  
   286                                  	;not	bx
   287 0000013D E4A1                    	in	al, 0A1h ; irq 8-15
   288 0000013F 88C4                            mov	ah, al
   289 00000141 E421                            in	al, 21h  ; irq 0-7 
   290                                  
   291                                  	; 04/11/2023
   292                                  	; save IRQ status
   293 00000143 A3[4C10]                	mov	[IRQ_status], ax
   294                                  
   295                                  	; 12/05/2024 (enable AC97 IRQ)
   296                                  	;mov	cl, dl
   297                                  	;mov	bx, 1
   298                                  	;shl	bx, cl
   299                                  	;not	bx
   300                                  	;and	ax, bx
   301                                  	;out	21h, al
   302                                  	;mov	al, ah
   303                                  	;out	0A1h, al
   304                                  
   305                                  	; 15/05/2024
   306                                  	;and	ax, bx   ; unmask
   307 00000146 0FB3D0                   	btr	ax, dx	 ; unmask
   308 00000149 E621                    	out	21h, al  ; enable interrupt (if irq <= 7)
   309 0000014B 88E0                    	mov	al, ah
   310 0000014D E6A1                    	out	0A1h, al ; enable interrupt (if irq > 7)
   311                                  	;not	bx
   312                                  
   313                                  	; 08/05/2024
   314                                  	;mov	dx, 4D1h			;8259 ELCR1
   315                                          ;in	al, dx
   316                                  	;mov	ah, al
   317                                  	;mov	dx, 4D0h
   318                                          ;in	al, dx
   319                                  	;;or	ax, bx
   320                                  	;bts	ax, cx
   321                                  	;mov	dx, 4D0h
   322                                  	;out	dx, al                          ;set level-triggered mode
   323                                  	;mov	al, ah
   324                                  	;mov	dx, 4D1h
   325                                  	;out	dx, al                          ;set level-triggered mode
   326                                  
   327                                  	; 24/11/2016 - Erdogan Tan
   328                                  	;mov	bx, cx
   329                                  	; 10/11/2023
   330 0000014F 89D3                    	mov	bx, dx
   331 00000151 8A9F[360F]              	mov	bl, [bx+irq_int]
   332 00000155 C1E302                  	shl	bx, 2 ; * 4
   333                                  
   334                                  	; set up interrupt vector
   335                                  	; 30/11/2016
   336 00000158 06                      	push	es
   337 00000159 31C0                    	xor	ax, ax
   338 0000015B 8EC0                    	mov	es, ax
   339                                  	; 04/11/2023
   340                                  	; save interrupt vector
   341                                  	;mov	ax, [es:bx]
   342                                  	; 13/05/2024
   343 0000015D B8[7201]                	mov	ax, ac97_int_handler
   344 00000160 268707                  	xchg	ax, [es:bx]
   345 00000163 A3[4E10]                	mov	[IRQ_vector], ax
   346                                  	;mov	ax, [es:bx+2]
   347                                  	; 13/05/2024
   348 00000166 8CC8                    	mov	ax, cs
   349 00000168 26874702                	xchg	ax, [es:bx+2]
   350 0000016C A3[5010]                	mov	[IRQ_vector+2], ax
   351                                  
   352                                  	; 13/05/2024
   353                                  	;mov	word [es:bx], ac97_int_handler
   354                                  	;mov	ax, cs
   355                                  	;mov	[es:bx+2], ax
   356                                  	
   357 0000016F 07                      	pop	es
   358                                  
   359                                  	; 04/11/2023
   360 00000170 FB                      	sti
   361                                  
   362 00000171 C3                      	retn
   363                                  
   364                                  ; 16/05/2024
   365                                  %if 0
   366                                  	; 15/05/2024
   367                                  ac97_int_handler:
   368                                  	; 13/05/2024
   369                                  	; 12/05/2024
   370                                  	; 11/05/2024
   371                                  	; 11/11/2023
   372                                  	; 10/11/2023
   373                                  	; 17/02/2016
   374                                  	push	eax	; 11/11/2023
   375                                  	push	dx
   376                                  	; 05/11/2023
   377                                  	;push	cx
   378                                  	;push	bx
   379                                  	;push	si
   380                                  	;push	di
   381                                  
   382                                  	; 10/11/2023
   383                                  	; EOI at first
   384                                  	mov	al, 20h
   385                                  	test	byte [ac97_int_ln_reg], 8
   386                                  	jz	short _ih_0
   387                                  	out 	0A0h, al ; 20h	; EOI
   388                                  _ih_0:
   389                                  	out	20h, al  ; 20h	; EOI
   390                                  
   391                                  	; 11/11/2023
   392                                  	; 09/11/2023
   393                                  	mov	dx, GLOB_STS_REG
   394                                          add	dx, [NABMBAR]
   395                                  	in	eax, dx
   396                                  
   397                                  	; 12/05/2024
   398                                  	; 09/11/2023
   399                                  	;cmp	eax, 0FFFFFFFFh ; -1
   400                                  	;je	short _ih_3
   401                                  	; 15/05/2024
   402                                  	inc	eax	; 0FFFFFFFFh
   403                                  	jz	short _ih_3
   404                                  	dec	eax	; 0
   405                                  	jz	short _ih_3
   406                                  
   407                                  	; 15/05/2024
   408                                  	cmp	byte [tLoop], 1
   409                                  	jb	short _ih_2	
   410                                  
   411                                  	; 12/05/2024
   412                                  	;test	al, 40h		; PCM Out Interrupt
   413                                  	; 15/05/2024
   414                                  	test	al, PCM_OUT_IRQ
   415                                  	jnz	short _ih_1
   416                                  
   417                                  	; 15/05/2024
   418                                  	;test	eax, eax
   419                                  	;jz	short _ih_3
   420                                  
   421                                  	; 12/05/2024
   422                                  	;test	ax, PCM_OUT_IRQ
   423                                  	;jnz	short _ih_1
   424                                  
   425                                   	;mov	dx, GLOB_STS_REG
   426                                          ;add	dx, [NABMBAR]
   427                                  	; 12/05/2024
   428                                  	;out	dx, eax
   429                                  	jmp	short _ih_2
   430                                  	;jmp	short _ih_3
   431                                  
   432                                  	; .....
   433                                  	;mov	al, 1
   434                                  	; 10/11/2023
   435                                  	;mov	[tLoop], al  ; 1
   436                                  
   437                                  	;cmp	[inside], al ; 1
   438                                  	;jnb	short _ih_2	; busy
   439                                  
   440                                  	;mov	[inside], al ; 1
   441                                  	;
   442                                  	;; 09/11/2023
   443                                          ;mov	dx, [NABMBAR]
   444                                          ;add	dx, PO_SR_REG	; set pointer to Status reg
   445                                  	;in	al, dx
   446                                  	;; 10/11/2023
   447                                  	;;;out	dx, eax
   448                                  	;;out	dx, al		; clear interrupt event
   449                                  	;			; (by writing 1 to same bits)
   450                                  	;
   451                                  	;;mov	[pcm_irq_status], al ; 05/11/2023
   452                                  	;test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
   453                                  	;jz	short _ih_3
   454                                  	; .....
   455                                  
   456                                  _ih_1:
   457                                  	; 11/11/2023
   458                                  	;push	eax
   459                                  	; 15/05/2024
   460                                  	push	ax
   461                                  
   462                                  	; 13/05/2024
   463                                  	mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   464                                  	mov	dx, PO_SR_REG
   465                                          add	dx, [NABMBAR]
   466                                  	out	dx, ax
   467                                  
   468                                  	; 13/05/2024
   469                                  	mov	dx, PO_CIV_REG
   470                                          add	dx, [NABMBAR]
   471                                  	in	al, dx
   472                                  	mov	ah, al
   473                                  	dec	al
   474                                  	and	al, 1Fh
   475                                          mov     dx, PO_LVI_REG
   476                                          add	dx, [NABMBAR]
   477                                          out	dx, al
   478                                  	and	ah, 1
   479                                  	; 13/05/2024
   480                                  	inc	ah
   481                                  	mov	[tBuff], ah ; 1 = Buffer 1, 2 = Buffer 2
   482                                  
   483                                  	; 13/05/2024
   484                                  	; 10/11/2023
   485                                  	; 28/11/2016 - Erdogan Tan
   486                                  	;call	tuneLoop
   487                                  
   488                                  	; 11/11/2023
   489                                  	;pop	eax
   490                                  	; 15/05/2024
   491                                  	pop	ax	
   492                                  
   493                                  	mov	dx, GLOB_STS_REG
   494                                          add	dx, [NABMBAR]
   495                                  _ih_2:			; 12/05/2024
   496                                  	out	dx, eax
   497                                  
   498                                  	; 12/05/2024
   499                                  _ih_3:
   500                                  	; 11/11/2023
   501                                  	;mov	dx, [NABMBAR]
   502                                  	;add	dx, PO_SR_REG	; set pointer to Status reg
   503                                  	;mov	ax, 1Ch
   504                                  	;out	dx, ax
   505                                  
   506                                  ;	; 10/11/2023
   507                                  ;	mov	al, 20h
   508                                  ;	test	byte [ac97_int_ln_reg], 8
   509                                  ;	jz	short _ih_3
   510                                  ;	out 	0A0h, al ; 20h	; EOI
   511                                  ;_ih_3:
   512                                  ;	out	20h, al  ; 20h	; EOI
   513                                  ;_ih_4:
   514                                  	;mov	byte [inside], 0
   515                                  	;pop	di
   516                                  	;pop	si
   517                                  	;pop	bx
   518                                  	;pop	cx
   519                                  	pop	dx
   520                                  	pop	eax ; 11/11/2023
   521                                  	iret
   522                                  %else
   523                                  	; 16/05/2024
   524                                  	; 15/05/2024
   525                                  ac97_int_handler:
   526                                  	; 13/05/2024
   527                                  	; 12/05/2024
   528                                  	; 11/05/2024
   529                                  	; 11/11/2023
   530                                  	; 10/11/2023
   531                                  	; 17/02/2016
   532 00000172 50                      	push	ax ; +	; 16/05/2024 		
   533                                  	;push	eax ; *	; 11/11/2023
   534 00000173 52                      	push	dx ; **
   535                                  	; 05/11/2023
   536                                  	;push	cx
   537                                  	;push	bx
   538                                  	;push	si
   539                                  	;push	di
   540                                  
   541                                  	; 16/05/2024
   542                                  	; 10/11/2023
   543                                  	; EOI at first
   544 00000174 B020                    	mov	al, 20h
   545 00000176 F606[5810]08            	test	byte [ac97_int_ln_reg], 8
   546 0000017B 7402                    	jz	short _ih_0
   547 0000017D E6A0                    	out 	0A0h, al ; 20h	; EOI
   548                                  _ih_0:
   549 0000017F E620                    	out	20h, al  ; 20h	; EOI
   550                                  
   551                                  	; 16/05/2024
   552                                  ;	mov	dx, GLOB_STS_REG
   553                                  ;	add	dx, [NABMBAR]
   554                                  ;	in	eax, dx
   555                                  ;
   556                                  ;	inc	eax	; 0FFFFFFFFh
   557                                  ;	jz	short _ih_3
   558                                  ;	dec	eax	; 0
   559                                  ;	;jz	short _ih_3
   560                                  ;_ih_3:
   561                                  ;	; 16/05/2024
   562                                  ;	push	eax ; ***
   563                                  
   564                                  	; 16/05/2024
   565                                  	; 24/11/2023 (TRDOS386 'audio.s')
   566 00000181 8B16[4610]                      mov	dx, [NABMBAR]
   567 00000185 83C216                  	add	dx, PO_SR_REG
   568 00000188 ED                      	in	ax, dx
   569                                  
   570 00000189 A808                    	test	al, BCIS ; bit 3, 8
   571 0000018B 7428                    	jz	short _ih_2
   572                                  
   573                                  	; 15/05/2024
   574 0000018D 803E[4B10]01            	cmp	byte [tLoop], 1
   575 00000192 7221                    	jb	short _ih_2
   576                                  _ih_1:
   577                                  	; 16/05/2024
   578                                  	; 13/05/2024
   579                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   580                                  	;add	dx, PO_SR_REG
   581                                          ;add	dx, [NABMBAR]
   582                                  	;out	dx, ax
   583                                  
   584                                  	; 16/05/2024
   585 00000194 50                      	push	ax ; ****	
   586                                  
   587                                  	; 13/05/2024
   588 00000195 BA1400                  	mov	dx, PO_CIV_REG
   589 00000198 0316[4610]                      add	dx, [NABMBAR]
   590 0000019C EC                      	in	al, dx
   591 0000019D 88C4                    	mov	ah, al
   592 0000019F FEC8                    	dec	al
   593 000001A1 241F                    	and	al, 1Fh
   594 000001A3 BA1500                          mov     dx, PO_LVI_REG
   595 000001A6 0316[4610]                      add	dx, [NABMBAR]
   596 000001AA EE                              out	dx, al
   597 000001AB 80E401                  	and	ah, 1
   598                                  	; 13/05/2024
   599 000001AE FEC4                    	inc	ah
   600 000001B0 8826[4810]              	mov	[tBuff], ah ; 1 = Buffer 1, 2 = Buffer 2
   601                                  
   602                                  	; 13/05/2024
   603                                  	; 10/11/2023
   604                                  	; 28/11/2016 - Erdogan Tan
   605                                  	;call	tuneLoop
   606                                  
   607                                  	; 16/05/2024
   608 000001B4 58                      	pop	ax ; ****
   609                                  
   610                                  	; 16/05/2024
   611                                  _ih_2:
   612                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   613 000001B5 8B16[4610]              	mov	dx, [NABMBAR]
   614 000001B9 83C216                  	add	dx, PO_SR_REG
   615 000001BC EF                      	out	dx, ax
   616                                  
   617                                  ;	; 16/05/2024
   618                                  ;	pop	eax ; ***
   619                                  ;	
   620                                  ;	or	eax, eax
   621                                  ;	jz	short _ih_4
   622                                  ;	
   623                                  ;	mov	dx, GLOB_STS_REG
   624                                  ;	add	dx, [NABMBAR]
   625                                  ;	out	dx, eax
   626                                  
   627                                  	; 16/05/2024
   628                                  _ih_4:
   629                                  	; 10/11/2023
   630                                  	;mov	al, 20h
   631                                  	;test	byte [ac97_int_ln_reg], 8
   632                                  	;jz	short _ih_5
   633                                  	;out 	0A0h, al ; 20h	; EOI
   634                                  ;_ih_5:
   635                                  	;out	20h, al  ; 20h	; EOI
   636                                  ;_ih_6:
   637                                  	;pop	di
   638                                  	;pop	si
   639                                  	;pop	bx
   640                                  	;pop	cx
   641 000001BD 5A                      	pop	dx ; **
   642                                  	;pop	eax ; *	; 11/11/2023	
   643 000001BE 58                      	pop	ax ; + ; 16/05/2024
   644 000001BF CF                      	iret
   645                                  %endif
   646                                  
   647                                  ;=============================================================================
   648                                  ;               PCI.ASM
   649                                  ;=============================================================================
   650                                  
   651                                  ; EQUATES
   652                                  
   653                                  ;constants of stuff that seem hard to remember at times.
   654                                  
   655                                  TRUE  EQU 1
   656                                  FALSE EQU 0
   657                                  
   658                                  ENABLED  EQU 1
   659                                  DISABLED EQU 0
   660                                  
   661                                  BIT0  EQU 1
   662                                  BIT1  EQU 2
   663                                  BIT2  EQU 4
   664                                  BIT3  EQU 8
   665                                  BIT4  EQU 10h
   666                                  BIT5  EQU 20h
   667                                  BIT6  EQU 40h
   668                                  BIT7  EQU 80h
   669                                  BIT8  EQU 100h
   670                                  BIT9  EQU 200h
   671                                  BIT10 EQU 400h
   672                                  BIT11 EQU 800h
   673                                  BIT12 EQU 1000h
   674                                  BIT13 EQU 2000h
   675                                  BIT14 EQU 4000h
   676                                  BIT15 EQU 8000h
   677                                  BIT16 EQU 10000h
   678                                  BIT17 EQU 20000h
   679                                  BIT18 EQU 40000h
   680                                  BIT19 EQU 80000h
   681                                  BIT20 EQU 100000h
   682                                  BIT21 EQU 200000h
   683                                  BIT22 EQU 400000h
   684                                  BIT23 EQU 800000h
   685                                  BIT24 EQU 1000000h
   686                                  BIT25 EQU 2000000h
   687                                  BIT26 EQU 4000000h
   688                                  BIT27 EQU 8000000h
   689                                  BIT28 EQU 10000000h
   690                                  BIT29 EQU 20000000h
   691                                  BIT30 EQU 40000000h
   692                                  BIT31 EQU 80000000h
   693                                  
   694                                  ;special characters
   695                                  NUL     EQU 0
   696                                  NULL    EQU 0
   697                                  BELL    EQU 07
   698                                  BS      EQU 08
   699                                  TAB     EQU 09
   700                                  LF      EQU 10
   701                                  CR      EQU 13
   702                                  ESCAPE  EQU 27           ;ESC is a reserved word....
   703                                  
   704                                  
   705                                  ;file stuff
   706                                  READONLY  EQU   BIT0
   707                                  HIDDEN    EQU   BIT1
   708                                  SYSTEM    EQU   BIT2
   709                                  VOLUME    EQU   BIT3         ;ignored for file access
   710                                  DIRECTORY EQU   BIT4         ;must be 0 for file access
   711                                  ARCHIVE   EQU   BIT5
   712                                  SHAREABLE EQU   BIT7         ;for novell networks
   713                                  OPEN	EQU	2		; open existing file
   714                                  CREATE	EQU	1		; create new file
   715                                  
   716                                  ; PCI equates
   717                                  ; PCI function address (PFA)
   718                                  ; bit 31 = 1
   719                                  ; bit 23:16 = bus number     (0-255)
   720                                  ; bit 15:11 = device number  (0-31)
   721                                  ; bit 10:8 = function number (0-7)
   722                                  ; bit 7:0 = register number  (0-255)
   723                                  
   724                                  IO_ADDR_MASK    EQU     0FFFEh          ; mask off bit 0 for reading BARs
   725                                  PCI_INDEX_PORT  EQU     0CF8h
   726                                  PCI_DATA_PORT   EQU     0CFCh
   727                                  PCI32           EQU     BIT31           ; bitflag to signal 32bit access
   728                                  PCI16           EQU     BIT30           ; bitflag for 16bit access
   729                                  
   730                                  PCI_FN0         EQU     0 << 8
   731                                  PCI_FN1         EQU     1 << 8
   732                                  PCI_FN2         EQU     2 << 8
   733                                  PCI_FN3         EQU     3 << 8
   734                                  PCI_FN4         EQU     4 << 8
   735                                  PCI_FN5         EQU     5 << 8
   736                                  PCI_FN6         EQU     6 << 8
   737                                  PCI_FN7         EQU     7 << 8
   738                                  
   739                                  PCI_CMD_REG		EQU	04h		; reg 04, command reg
   740                                   IO_ENA			EQU	BIT0		; i/o decode enable
   741                                   MEM_ENA		EQU	BIT1		; memory decode enable
   742                                   BM_ENA                 EQU     BIT2		; bus master enable
   743                                  
   744                                  ; CODE
   745                                  
   746                                  ; AC97.ASM
   747                                  ; PCI device register reader/writers.
   748                                  ; NASM version: Erdogan Tan (29/11/2016)
   749                                  ; 		Last Update: 17/02/2017
   750                                  
   751                                  ;===============================================================
   752                                  ; 8/16/32bit PCI reader
   753                                  ;
   754                                  ; Entry: EAX=PCI Bus/Device/fn/register number
   755                                  ;           BIT30 set if 32 bit access requested
   756                                  ;           BIT29 set if 16 bit access requested
   757                                  ;           otherwise defaults to 8bit read
   758                                  ;
   759                                  ; Exit:  DL,DX,EDX register data depending on requested read size
   760                                  ;
   761                                  ; Note: this routine is meant to be called via pciRegRead8, pciRegread16,
   762                                  ;	or pciRegRead32, listed below.
   763                                  ;
   764                                  ; Note2: don't attempt to read 32bits of data from a non dword aligned reg
   765                                  ;	 number.  Likewise, don't do 16bit reads from non word aligned reg #
   766                                  ; 
   767                                  pciRegRead:
   768 000001C0 6653                    	push	ebx
   769 000001C2 51                      	push	cx
   770 000001C3 6689C3                          mov     ebx, eax                        ; save eax, dh
   771 000001C6 88F1                            mov     cl, dh
   772 000001C8 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   773 000001CE 660D00000080                    or      eax, BIT31                      ; make a PCI access request
   774 000001D4 24FC                            and     al, ~3 ; NOT 3                  ; force index to be dword
   775                                  
   776 000001D6 BAF80C                          mov     dx, PCI_INDEX_PORT
   777 000001D9 66EF                            out     dx, eax                         ; write PCI selector
   778                                  
   779 000001DB BAFC0C                          mov     dx, PCI_DATA_PORT
   780 000001DE 88D8                            mov     al, bl
   781 000001E0 2403                            and     al, 3                           ; figure out which port to
   782 000001E2 00C2                            add     dl, al                          ; read to
   783                                  
   784 000001E4 66ED                    	in      eax, dx                         ; do 32bit read
   785 000001E6 66F7C300000080                  test    ebx, PCI32
   786 000001ED 7403                            jz      short _pregr1
   787                                  
   788 000001EF 6689C2                          mov     edx, eax                        ; return 32bits of data
   789                                  _pregr1:
   790 000001F2 89C2                    	mov     dx, ax                          ; return 16bits of data
   791 000001F4 66F7C3000000C0                  test    ebx, PCI32+PCI16
   792 000001FB 7502                            jnz     short _pregr2
   793 000001FD 88CE                            mov     dh, cl                          ; restore dh for 8 bit read
   794                                  _pregr2:
   795 000001FF 6689D8                          mov     eax, ebx                        ; restore eax
   796 00000202 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   797 00000208 59                      	pop	cx
   798 00000209 665B                    	pop	ebx
   799 0000020B C3                      	retn
   800                                  
   801                                  pciRegRead8:
   802 0000020C 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32             ; set up 8 bit read size
   803 00000212 EBAC                            jmp     short pciRegRead		; call generic PCI access
   804                                  
   805                                  pciRegRead16:
   806 00000214 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 16 bit read size
   807 0000021A 660D00000040                    or      eax, PCI16			; call generic PCI access
   808 00000220 EB9E                            jmp     short pciRegRead
   809                                  
   810                                  pciRegRead32:
   811 00000222 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 32 bit read size
   812 00000228 660D00000080                    or      eax, PCI32			; call generic PCI access
   813 0000022E EB90                            jmp     short pciRegRead
   814                                  
   815                                  ;===============================================================
   816                                  ; 8/16/32bit PCI writer
   817                                  ;
   818                                  ; Entry: EAX=PCI Bus/Device/fn/register number
   819                                  ;           BIT31 set if 32 bit access requested
   820                                  ;           BIT30 set if 16 bit access requested
   821                                  ;           otherwise defaults to 8bit read
   822                                  ;        DL/DX/EDX data to write depending on size
   823                                  ;
   824                                  ;
   825                                  ; note: this routine is meant to be called via pciRegWrite8, pciRegWrite16,
   826                                  ; 	or pciRegWrite32 as detailed below.
   827                                  ;
   828                                  ; Note2: don't attempt to write 32bits of data from a non dword aligned reg
   829                                  ;	 number.  Likewise, don't do 16bit writes from non word aligned reg #
   830                                  ;
   831                                  pciRegWrite:
   832 00000230 6653                    	push	ebx
   833 00000232 51                      	push	cx
   834 00000233 6689C3                          mov     ebx, eax                        ; save eax, dx
   835 00000236 89D1                            mov     cx, dx
   836 00000238 660D00000080                    or      eax, BIT31                      ; make a PCI access request
   837 0000023E 6625FFFFFFBF                    and     eax, ~PCI16 ; NOT PCI16         ; clear out data size request
   838 00000244 24FC                            and     al, ~3 ; NOT 3                  ; force index to be dword
   839                                  
   840 00000246 BAF80C                          mov     dx, PCI_INDEX_PORT
   841 00000249 66EF                            out     dx, eax                         ; write PCI selector
   842                                  
   843 0000024B BAFC0C                          mov     dx, PCI_DATA_PORT
   844 0000024E 88D8                            mov     al, bl
   845 00000250 2403                            and     al, 3                           ; figure out which port to
   846 00000252 00C2                            add     dl, al                          ; write to
   847                                  
   848 00000254 6689D0                          mov     eax, edx                        ; put data into eax
   849 00000257 89C8                            mov     ax, cx
   850                                  
   851 00000259 EE                              out     dx, al
   852 0000025A 66F7C3000000C0                  test    ebx, PCI16+PCI32                ; only 8bit access? bail
   853 00000261 740C                            jz      short _pregw1
   854                                  
   855 00000263 EF                              out     dx, ax                          ; write 16 bit value
   856 00000264 66F7C300000040                  test    ebx, PCI16                      ; 16bit requested?  bail
   857 0000026B 7502                            jnz     short _pregw1
   858                                  
   859 0000026D 66EF                            out     dx, eax                         ; write full 32bit
   860                                  _pregw1:
   861 0000026F 6689D8                          mov     eax, ebx                        ; restore eax
   862 00000272 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   863 00000278 89CA                            mov     dx, cx                          ; restore dx
   864 0000027A 59                      	pop	cx
   865 0000027B 665B                    	pop	ebx
   866 0000027D C3                      	ret
   867                                  
   868                                  pciRegWrite8:
   869 0000027E 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 8 bit write size
   870 00000284 EBAA                            jmp     short pciRegWrite		; call generic PCI access
   871                                  
   872                                  pciRegWrite16:
   873 00000286 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 16 bit write size
   874 0000028C 660D00000040                    or      eax, PCI16			; call generic PCI access
   875 00000292 EB9C                            jmp     short pciRegWrite
   876                                  
   877                                  pciRegWrite32:
   878 00000294 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 32 bit write size
   879 0000029A 660D00000080                    or      eax, PCI32			; call generic PCI access
   880 000002A0 EB8E                            jmp     short pciRegWrite
   881                                  
   882                                  ; AC97.ASM (PLAYWAV.COM)
   883                                  ; 17/02/2017 (Modifed by Erdogan Tan for various ICH device IDs)
   884                                  ;===============================================================
   885                                  ; PCIFindDevice: scan through PCI space looking for a device+vendor ID
   886                                  ;
   887                                  ;  ENTRY: none
   888                                  ;; Entry: EAX=Device+Vendor ID
   889                                  ;
   890                                  ;  Exit: EAX=PCI address if device found
   891                                  ;	 EDX=Device+Vendor ID
   892                                  ;        CY clear if found, set if not found. EAX invalid if CY set.
   893                                  ;
   894                                  ; [old stackless] Destroys: ebx, esi, edi, cl
   895                                  ;
   896                                  pciFindDevice:
   897                                  	;push	cx
   898                                  	;push	eax ; *
   899                                  	;push	esi
   900                                  	;push	edi
   901                                  
   902                                   	;mov     esi, eax                ; save off vend+device ID
   903                                  
   904                                  	; 17/02/2017
   905 000002A2 BE[460F]                	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
   906 000002A5 B91500                  	mov	cx, valid_id_count
   907                                  pfd_0:
   908 000002A8 66BF00FFFF7F                   	mov     edi, (80000000h - 100h) ; start with bus 0, dev 0 func 0
   909                                  nextPCIdevice:
   910 000002AE 6681C700010000                  add     edi, 100h
   911 000002B5 6681FF00F8FF80                  cmp     edi, 80FFF800h		; scanned all devices?
   912                                          ;stc
   913                                          ;je 	short PCIScanExit       ; not found
   914 000002BC 720D                    	jb	short pfd_1
   915 000002BE 66BF00000080            	mov     edi, 80000000h
   916 000002C4 83C604                  	add	si, 4 ; scan for next device ID
   917 000002C7 E202                    	loop	pfd_1	 
   918 000002C9 F9                      	stc	
   919                                  	;jmp 	short PCIScanExit
   920 000002CA C3                      	retn
   921                                  pfd_1:
   922 000002CB 6689F8                          mov     eax, edi                ; read PCI registers
   923 000002CE E851FF                          call    pciRegRead32
   924                                          ;cmp    edx, esi                ; found device?
   925 000002D1 663B14                          cmp	edx, dword [si]
   926 000002D4 75D8                    	jne     short nextPCIdevice
   927                                          ;clc
   928                                  PCIScanExit:
   929                                  	;pushf
   930 000002D6 66B800000080            	mov	eax, BIT31
   931 000002DC 66F7D0                  	not	eax
   932 000002DF 6621F8                  	and	eax, edi		; return only bus/dev/fn #
   933                                  	;popf
   934                                  
   935                                  	;pop	edi
   936                                  	;pop	esi
   937                                  	;pop	edx ; *
   938                                  	;pop	cx
   939 000002E2 C3                      	retn
   940                                  
   941                                  ;=============================================================================
   942                                  ;               CODEC.ASM
   943                                  ;=============================================================================
   944                                  
   945                                  ; EQUATES
   946                                  
   947                                  ;Codec registers.
   948                                  ;
   949                                  ;Not all codecs are created equal. Refer to the spec for your specific codec.
   950                                  ;
   951                                  ;All registers are 16bits wide.  Access to codec registers over the AC97 link
   952                                  ;is defined by the OEM.  
   953                                  ;
   954                                  ;Secondary codec's are accessed by ORing in BIT7 of all register accesses.
   955                                  ;
   956                                  
   957                                  ; each codec/mixer register is 16bits
   958                                  
   959                                  CODEC_RESET_REG                 equ     00      ; reset codec
   960                                  CODEC_MASTER_VOL_REG            equ     02      ; master volume
   961                                  CODEC_HP_VOL_REG                equ     04      ; headphone volume
   962                                  CODEC_MASTER_MONO_VOL_REG       equ     06      ; master mono volume
   963                                  CODEC_MASTER_TONE_REG           equ     08      ; master tone (R+L)
   964                                  CODEC_PCBEEP_VOL_REG            equ     0ah     ; PC beep volume
   965                                  CODEC_PHONE_VOL_REG             equ     0bh     ; phone volume
   966                                  CODEC_MIC_VOL_REG               equ     0eh     ; MIC volume
   967                                  CODEC_LINE_IN_VOL_REG           equ     10h     ; line input volume
   968                                  CODEC_CD_VOL_REG                equ     12h     ; CD volume
   969                                  CODEC_VID_VOL_REG               equ     14h     ; video volume
   970                                  CODEC_AUX_VOL_REG               equ     16h     ; aux volume
   971                                  CODEC_PCM_OUT_REG               equ     18h     ; PCM output volume
   972                                  CODEC_RECORD_SELECT_REG         equ     1ah     ; record select input
   973                                  CODEC_RECORD_VOL_REG            equ     1ch     ; record volume
   974                                  CODEC_RECORD_MIC_VOL_REG        equ     1eh     ; record mic volume
   975                                  CODEC_GP_REG                    equ     20h     ; general purpose
   976                                  CODEC_3D_CONTROL_REG            equ     22h     ; 3D control
   977                                  ; 24h is reserved
   978                                  CODEC_POWER_CTRL_REG            equ     26h     ; powerdown control
   979                                  CODEC_EXT_AUDIO_REG             equ     28h     ; extended audio
   980                                  CODEC_EXT_AUDIO_CTRL_REG        equ     2ah     ; extended audio control
   981                                  CODEC_PCM_FRONT_DACRATE_REG     equ     2ch     ; PCM out sample rate
   982                                  CODEC_PCM_SURND_DACRATE_REG     equ     2eh     ; surround sound sample rate
   983                                  CODEC_PCM_LFE_DACRATE_REG       equ     30h     ; LFE sample rate
   984                                  CODEC_LR_ADCRATE_REG            equ     32h     ; PCM in sample rate
   985                                  CODEC_MIC_ADCRATE_REG           equ     34h     ; mic in sample rate
   986                                  
   987                                  ; registers 36-7a are reserved on the ICH
   988                                  
   989                                  CODEC_VENDORID1_REG             equ     7ch     ; codec vendor ID 1
   990                                  CODEC_VENDORID2_REG             equ     7eh     ; codec vendor ID 2
   991                                  
   992                                  ; Mixer registers 0 through 51h reside in the ICH and are not forwarded over
   993                                  ; the AC97 link to the codec, which I think is a little weird.  Looks like
   994                                  ; the ICH makes it so you don't need a fully functional codec to play audio?
   995                                  ;
   996                                  ; whenever 2 codecs are present in the system, use BIT7 to access the 2nd
   997                                  ; set of registers, ie 80h-feh
   998                                  
   999                                  PRIMARY_CODEC                   equ     0       ; 0-7F for primary codec
  1000                                  SECONDARY_CODEC                 equ     BIT7    ; 80-8f registers for 2ndary
  1001                                  
  1002                                  SAMPLE_RATE_441khz	equ     44100   ; 44.1Khz (cd quality) rate
  1003                                  
  1004                                  ; ----------------------------------------------------------------------------
  1005                                  ; 17/02/2017
  1006                                  PCI_IO_BASE	equ 10h			; = NAMBAR register offset
  1007                                  AC97_INT_LINE   equ 3Ch			; AC97 Interrupt Line register offset
  1008                                  
  1009                                  ; ----------------------------------------------------------------------------
  1010                                  ; ICH2AC97.INC
  1011                                  ; ----------------------------------------------------------------------------
  1012                                  
  1013                                  ; PCI stuff
  1014                                  
  1015                                  ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
  1016                                  
  1017                                  INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
  1018                                  
  1019                                  ; 08/05/2024
  1020                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
  1021                                  SIS_VID		equ	1039h
  1022                                  NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
  1023                                  AMD_VID		equ	1022h
  1024                                  
  1025                                  ICH_DID         equ     2415h           ; ICH device ID
  1026                                  ICH0_DID        equ     2425h           ; ICH0
  1027                                  ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
  1028                                                                          ; they all should be compatible.
  1029                                  ; 08/05/2024
  1030                                  ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
  1031                                  ICH3_DID	equ     2485h           ; ICH3
  1032                                  ICH4_DID        equ     24C5h           ; ICH4
  1033                                  ICH5_DID	equ     24D5h           ; ICH5 
  1034                                  ICH6_DID	equ     266Eh           ; ICH6
  1035                                  ESB6300_DID	equ     25A6h           ; 6300ESB
  1036                                  ESB631X_DID	equ     2698h           ; 631XESB
  1037                                  ICH7_DID	equ	27DEh		; ICH7
  1038                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
  1039                                  MX82440_DID	equ	7195h
  1040                                  SI7012_DID	equ	7012h
  1041                                  NFORCE_DID	equ	01B1h
  1042                                  NFORCE2_DID	equ	006Ah
  1043                                  AMD8111_DID	equ	746Dh
  1044                                  AMD768_DID	equ	7445h
  1045                                  ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
  1046                                  CK804_DID	equ	0059h
  1047                                  MCP04_DID	equ	003Ah
  1048                                  CK8_DID		equ	008Ah
  1049                                  NFORCE3_DID	equ	00DAh
  1050                                  CK8S_DID	equ	00EAh
  1051                                  
  1052                                  NAMBAR_REG      equ     10h             ; native audio mixer BAR
  1053                                   NAM_SIZE       equ     256             ; 256 bytes required.
  1054                                  
  1055                                  NABMBAR_REG     equ     14h             ; native audio bus mastering BAR
  1056                                   NABM_SIZE      equ     64              ; 64 bytes
  1057                                  
  1058                                  ; BUS master registers, accessed via NABMBAR+offset
  1059                                  
  1060                                  ; ICH supports 3 different types of register sets for three types of things
  1061                                  ; it can do, thus:
  1062                                  ;
  1063                                  ; PCM in (for recording) aka PI
  1064                                  ; PCM out (for playback) aka PO
  1065                                  ; MIC in (for recording) aka MC
  1066                                  
  1067                                  PI_BDBAR_REG            equ     0       ; PCM in buffer descriptor BAR
  1068                                  PO_BDBAR_REG            equ     10h     ; PCM out buffer descriptor BAR
  1069                                  MC_BDBAR_REG            equ     20h     ; MIC in buffer descriptor BAR
  1070                                  
  1071                                  ; each buffer descriptor BAR holds a pointer which has entries to the buffer
  1072                                  ; contents of the .WAV file we're going to play.  Each entry is 8 bytes long
  1073                                  ; (more on that later) and can contain 32 entries total, so each BAR is
  1074                                  ; 256 bytes in length, thus:
  1075                                  
  1076                                  BDL_SIZE                equ     32*8    ; Buffer Descriptor List size
  1077                                  INDEX_MASK              equ     31      ; indexes must be 0-31
  1078                                  
  1079                                  
  1080                                  
  1081                                  PI_CIV_REG              equ     4       ; PCM in current Index value (RO)
  1082                                  PO_CIV_REG              equ     14h     ; PCM out current Index value (RO)
  1083                                  MC_CIV_REG              equ     24h     ; MIC in current Index value (RO)
  1084                                  ;8bit read only
  1085                                  ; each current index value is simply a pointer showing us which buffer
  1086                                  ; (0-31) the codec is currently processing.  Once this counter hits 31, it
  1087                                  ; wraps back to 0.
  1088                                  ; this can be handy to know, as once it hits 31, we're almost out of data to
  1089                                  ; play back or room to record!
  1090                                  
  1091                                  
  1092                                  PI_LVI_REG              equ     5       ; PCM in Last Valid Index
  1093                                  PO_LVI_REG              equ     15h     ; PCM out Last Valid Index
  1094                                  MC_LVI_REG              equ     25h     ; MIC in Last Valid Index
  1095                                  ;8bit read/write
  1096                                  ; The Last Valid Index is a number (0-31) to let the codec know what buffer
  1097                                  ; number to stop on after processing.  It could be very nasty to play audio
  1098                                  ; from buffers that aren't filled with the audio we want to play.
  1099                                  
  1100                                  
  1101                                  PI_SR_REG               equ     6       ; PCM in Status register
  1102                                  PO_SR_REG               equ     16h     ; PCM out Status register
  1103                                  MC_SR_REG               equ     26h     ; MIC in Status register
  1104                                  ;16bit read/write
  1105                                  ; status registers.  Bitfields follow:
  1106                                  
  1107                                  FIFO_ERR                equ     BIT4    ; FIFO Over/Underrun W1TC.
  1108                                  
  1109                                  BCIS                    equ     BIT3    ; buffer completion interrupt status.
  1110                                                                          ; Set whenever the last sample in ANY
  1111                                                                          ; buffer is finished.  Bit is only
  1112                                                                          ; set when the Interrupt on Complete
  1113                                                                          ; (BIT4 of control reg) is set.
  1114                                  
  1115                                  LVBCI                   equ     BIT2    ; Set whenever the codec has processed
  1116                                                                          ; the last buffer in the buffer list.
  1117                                                                          ; Will fire an interrupt if IOC bit is
  1118                                                                          ; set. Probably set after the last
  1119                                                                          ; sample in the last buffer is
  1120                                                                          ; processed.  W1TC
  1121                                  
  1122                                                                          ; 
  1123                                  CELV                    equ     BIT1    ; Current buffer == last valid.
  1124                                                                          ; Bit is RO and remains set until LVI is
  1125                                                                          ; cleared.  Probably set up the start
  1126                                                                          ; of processing for the last buffer.
  1127                                  
  1128                                  
  1129                                  DCH                     equ     BIT0    ; DMA controller halted.
  1130                                                                          ; set whenever audio stream is stopped
  1131                                                                          ; or something else goes wrong.
  1132                                  
  1133                                  PI_PICB_REG             equ     8       ; PCM in position in current buffer(RO)
  1134                                  PO_PICB_REG             equ     18h     ; PCM out position in current buffer(RO)
  1135                                  MC_PICB_REG             equ     28h     ; MIC in position in current buffer (RO)
  1136                                  ;16bit read only
  1137                                  ; position in current buffer regs show the number of dwords left to be
  1138                                  ; processed in the current buffer.
  1139                                  ; 
  1140                                  
  1141                                  PI_PIV_REG              equ     0ah     ; PCM in Prefected index value
  1142                                  PO_PIV_REG              equ     1ah     ; PCM out Prefected index value
  1143                                  MC_PIV_REG              equ     2ah     ; MIC in Prefected index value
  1144                                  ;8bit, read only
  1145                                  ; Prefetched index value register.
  1146                                  ; tells which buffer number (0-31) has be prefetched.  I'd imagine this
  1147                                  ; value follows the current index value fairly closely. (CIV+1)
  1148                                  ;
  1149                                  
  1150                                  PI_CR_REG               equ     0bh     ; PCM in Control Register
  1151                                  PO_CR_REG               equ     1bh     ; PCM out Control Register
  1152                                  MC_CR_REG               equ     2bh     ; MIC in Control Register
  1153                                  ; 8bit
  1154                                  ; Control register *MUST* only be accessed as an 8bit value.
  1155                                  ; Control register.  See bitfields below.
  1156                                  ;
  1157                                  
  1158                                  IOCE                    equ     BIT4    ; interrupt on complete enable.
  1159                                                                          ; set this bit if you want an intrtpt
  1160                                                                          ; to fire whenever LVBCI is set.
  1161                                  FEIFE                   equ     BIT3    ; set if you want an interrupt to fire
  1162                                                                          ; whenever there is a FIFO (over or
  1163                                                                          ; under) error.
  1164                                  LVBIE                   equ     BIT2    ; last valid buffer interrupt enable.
  1165                                                                          ; set if you want an interrupt to fire
  1166                                                                          ; whenever the completion of the last
  1167                                                                          ; valid buffer.
  1168                                  RR                      equ     BIT1    ; reset registers.  Nukes all regs
  1169                                                                          ; except bits 4:2 of this register.
  1170                                                                          ; Only set this bit if BIT 0 is 0
  1171                                  RPBM                    equ     BIT0    ; Run/Pause
  1172                                                                          ; set this bit to start the codec!
  1173                                  
  1174                                  
  1175                                  GLOB_CNT_REG            equ     2ch     ; Global control register
  1176                                  SEC_RES_EN              equ     BIT5    ; secondary codec resume event 
  1177                                                                          ; interrupt enable.  Not used here.
  1178                                  PRI_RES_EN              equ     BIT4    ; ditto for primary. Not used here.
  1179                                  ACLINK_OFF              equ     BIT3    ; Turn off the AC97 link
  1180                                  ACWARM_RESET            equ     BIT2    ; Awaken the AC97 link from sleep.
  1181                                                                          ; registers preserved, bit self clears
  1182                                  ACCOLD_RESET            equ     BIT1    ; Reset everything in the AC97 and
  1183                                                                          ; reset all registers.  Not self clearing
  1184                                  
  1185                                  GPIIE                   equ     BIT0    ; GPI Interrupt enable.
  1186                                                                          ; set if you want an interrupt to
  1187                                                                          ; fire upon ANY of the bits in the
  1188                                                                          ; GPI (general pursose inputs?) not used.
  1189                                  
  1190                                  GLOB_STS_REG            equ     30h     ; Global Status register (RO)
  1191                                  
  1192                                  MD3                     equ     BIT17   ; modem powerdown status (yawn)
  1193                                  AD3                     equ     BIT16   ; Audio powerdown status (yawn)
  1194                                  RD_COMPLETE_STS         equ     BIT15   ; Codec read timed out. 0=normal
  1195                                  BIT3SLOT12              equ     BIT14   ; shadowed status of bit 3 in slot 12
  1196                                  BIT2SLOT12              equ     BIT13   ; shadowed status of bit 2 in slot 12
  1197                                  BIT1SLOT12              equ     BIT12   ; shadowed status of bit 1 in slot 12
  1198                                  SEC_RESUME_STS          equ     BIT11   ; secondary codec has resumed (and irqed)
  1199                                  PRI_RESUME_STS          equ     BIT10   ; primary codec has resumed (and irqed)
  1200                                  SEC_CODEC_RDY           equ     BIT9    ; secondary codec is ready for action
  1201                                  PRI_CODEC_RDY           equ     BIT8    ; Primary codec is ready for action
  1202                                                                          ; software must check these bits before
  1203                                                                          ; starting the codec!
  1204                                  MIC_IN_IRQ              equ     BIT7    ; MIC in caused an interrupt
  1205                                  PCM_OUT_IRQ             equ     BIT6    ; One of the PCM out channels IRQed
  1206                                  PCM_IN_IRQ              equ     BIT5    ; One of the PCM in channels IRQed
  1207                                  MODEM_OUT_IRQ           equ     BIT2    ; modem out channel IRQed
  1208                                  MODEM_IN_IRQ            equ     BIT1    ; modem in channel IRQed
  1209                                  GPI_STS_CHANGE          equ     BIT0    ; set whenever GPI's have changed.
  1210                                                                          ; BIT0 of slot 12 also reflects this.
  1211                                  
  1212                                  
  1213                                  ACC_SEMA_REG            equ     34h     ; Codec write semiphore register
  1214                                  CODEC_BUSY              equ     BIT0    ; codec register I/O is happening
  1215                                                                          ; self clearing
  1216                                  ;
  1217                                  ; Buffer Descriptors List
  1218                                  ; As stated earlier, each buffer descriptor list is a set of (up to) 32 
  1219                                  ; descriptors, each 8 bytes in length.  Bytes 0-3 of a descriptor entry point
  1220                                  ; to a chunk of memory to either play from or record to.  Bytes 4-7 of an
  1221                                  ; entry describe various control things detailed below.
  1222                                  ; 
  1223                                  ; Buffer pointers must always be aligned on a Dword boundry.
  1224                                  ;
  1225                                  ;
  1226                                  
  1227                                  IOC                     equ     BIT31   ; Fire an interrupt whenever this
  1228                                                                          ; buffer is complete.
  1229                                  
  1230                                  BUP                     equ     BIT30   ; Buffer Underrun Policy.
  1231                                                                          ; if this buffer is the last buffer
  1232                                                                          ; in a playback, fill the remaining
  1233                                                                          ; samples with 0 (silence) or not.
  1234                                                                          ; It's a good idea to set this to 1
  1235                                                                          ; for the last buffer in playback,
  1236                                                                          ; otherwise you're likely to get a lot
  1237                                                                          ; of noise at the end of the sound.
  1238                                  
  1239                                  ;
  1240                                  ; Bits 15:0 contain the length of the buffer, in number of samples, which
  1241                                  ; are 16 bits each, coupled in left and right pairs, or 32bits each.
  1242                                  ; Luckily for us, that's the same format as .wav files.
  1243                                  ;
  1244                                  ; A value of FFFF is 65536 samples.  Running at 44.1Khz, that's just about
  1245                                  ; 1.5 seconds of sample time.  FFFF * 32bits is 1FFFFh bytes or 128k of data.
  1246                                  ;
  1247                                  ; A value of 0 in these bits means play no samples.
  1248                                  ;
  1249                                  
  1250                                  ; CODE
  1251                                  
  1252                                  ; AC97.ASM
  1253                                  
  1254                                  ; codec configuration code.  Not much here really.
  1255                                  ; NASM version: Erdogan Tan (29/11/2016)
  1256                                  
  1257                                  ; enable codec, unmute stuff, set output rate to 44.1
  1258                                  ; entry: ax = desired sample rate
  1259                                  ;
  1260                                  	
  1261                                  	; 15/05/2024
  1262                                  	; 12/05/2024
  1263                                  	; 08/05/2024
  1264                                  	; (ac97_vra.asm, 19/11/2023, Erdogan Tan, playwav3.asm) 
  1265                                  codecConfig:
  1266                                  	; 02/12/2023
  1267                                  	; 26/11/2023
  1268                                  	; 21/11/2023
  1269                                  	; 20/11/2023
  1270                                  	; 19/11/2023 (TRDOS 386 v2.0.7)
  1271                                  	; 15/11/2023
  1272                                  	; 04/11/2023
  1273                                  	; 17/02/2017 
  1274                                  	; 07/11/2016 (Erdogan Tan)
  1275                                  	;PORT_NABM_GLB_CTRL_STAT equ 60h
  1276                                  
  1277                                  	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
  1278                                   	; 'AC97_DEF.H'
  1279                                  	;AC97_EXTENDED_STATUS equ 002Ah
  1280                                  	AC97_EA_SPDIF	equ 0002h
  1281                                  	AC97_EA_VRA	equ 0001h
  1282                                  	; 04/11/2023
  1283                                  	ICH_PO_CR_RESET equ 0002h  ; reset codec
  1284                                  	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
  1285                                  	ICH_PCM_246_MASK equ 300000h ; 6 channels
  1286                                  
  1287                                  	; 08/05/2024
  1288                                  	; 11/11/2023
  1289                                  	CTRL_ST_CREADY	equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
  1290                                  	CODEC_REG_POWERDOWN equ	26h
  1291                                  
  1292                                  	; 04/11/2023
  1293                                  init_ac97_controller:
  1294 000002E3 66A1[5A10]              	mov	eax, [bus_dev_fn]
  1295 000002E7 B004                    	mov	al, PCI_CMD_REG
  1296 000002E9 E828FF                  	call	pciRegRead16		; read PCI command register
  1297 000002EC 80CA05                  	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
  1298 000002EF E894FF                  	call	pciRegWrite16
  1299                                  
  1300                                  	; 14/05/2024
  1301                                  	; 02/12/2023
  1302 000002F2 E89801                  	call	delay_100ms ; 29/05/2017
  1303                                  
  1304                                  	; 02/12/2023
  1305                                  	;call	delay1_4ms
  1306                                  	;call	delay1_4ms
  1307                                  	;call	delay1_4ms
  1308                                  	;call	delay1_4ms
  1309                                  
  1310                                  init_ac97_codec:
  1311                                  	; 18/11/2023
  1312 000002F5 BD2800                  	mov	bp, 40
  1313                                  	; 14/05/2024
  1314                                  	;mov	bp, 100
  1315                                  _initc_1:
  1316                                  	; 11/11/2023
  1317                                  	; (TRDOS 386 v2.0.5, 'audio.s')
  1318 000002F8 BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1319 000002FB 0316[4610]              	add	dx, [NABMBAR]
  1320 000002FF 66ED                    	in	eax, dx
  1321                                  
  1322                                  	; 02/12/2023
  1323 00000301 E85209                  	call	delay1_4ms
  1324                                  
  1325                                  	; ?
  1326                                  	;; 15/11/2023
  1327                                  	;;mov	cx, 40
  1328                                  	;mov	bp, 40 ; 18/11/2023
  1329                                  ;_initc_1:
  1330 00000304 BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1331 00000307 0316[4610]              	add	dx, [NABMBAR]
  1332 0000030B 66ED                    	in	eax, dx
  1333                                  
  1334                                  	; 02/12/2023
  1335 0000030D E84609                  	call	delay1_4ms
  1336                                  
  1337 00000310 6683F8FF                	cmp	eax, 0FFFFFFFFh ; -1
  1338                                  	;je	short init_ac97_codec_err1
  1339                                  	; 15/11/2023
  1340 00000314 7508                    	jne	short _initc_3
  1341                                  _initc_2:
  1342                                  	;dec	cx
  1343 00000316 4D                      	dec	bp	; 18/11/2023
  1344                                  	;jz	short init_ac97_codec_err1
  1345                                  	; 19/11/2023
  1346 00000317 7412                    	jz	short _ac97_codec_ready
  1347                                  
  1348 00000319 E87101                  	call	delay_100ms
  1349 0000031C EBDA                    	jmp	short _initc_1
  1350                                  _initc_3:
  1351 0000031E 66A900030010            	test	eax, CTRL_ST_CREADY
  1352 00000324 7505                    	jnz	short _ac97_codec_ready
  1353                                  
  1354 00000326 E8E400                  	call	reset_ac97_codec
  1355                                  	; 11/11/2023
  1356                                  	;jc	short init_ac97_codec_err2
  1357                                  	; 15/11/2023
  1358                                  	;jc	short _initc_2
  1359                                  	; 26/11/2023
  1360 00000329 EBEB                    	jmp	short _initc_2
  1361                                  
  1362                                  _ac97_codec_ready:
  1363 0000032B 8B16[4410]              	mov	dx, [NAMBAR]
  1364                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  1365 0000032F EF                      	out	dx, ax
  1366                                  
  1367 00000330 E85A01                  	call	delay_100ms
  1368                                  
  1369                                  	; 19/11/2023
  1370 00000333 09ED                    	or	bp, bp
  1371 00000335 7522                    	jnz	short _ac97_codec_init_ok
  1372                                  
  1373 00000337 6631C0                  	xor	eax, eax ; 0
  1374 0000033A 8B16[4410]              	mov	dx, [NAMBAR]
  1375 0000033E 83C226                  	add	dx, CODEC_REG_POWERDOWN
  1376 00000341 EF                      	out	dx, ax
  1377                                  	
  1378                                  	; 19/11/2023
  1379                                  	; wait for 1 second
  1380                                  	; 15/05/2024
  1381 00000342 66B9E8030000            	mov	ecx, 1000 ; 1000*4*0.25ms = 1s
  1382                                  	;mov	cx, 10
  1383                                  _ac97_codec_rloop:
  1384                                  	;call	delay1_4ms
  1385                                  	;call	delay1_4ms
  1386                                  	;call	delay1_4ms
  1387                                  	;call	delay1_4ms
  1388 00000348 E84201                  	call	delay_100ms
  1389                                  
  1390                                  	;mov	dx, [NAMBAR]
  1391                                  	;add	dx, CODEC_REG_POWERDOWN
  1392 0000034B ED                      	in	ax, dx
  1393                                  
  1394                                  	; 14/05/2024
  1395                                  	; 02/12/2023
  1396 0000034C E80709                  	call	delay1_4ms
  1397                                  	
  1398 0000034F 83E00F                  	and	ax, 0Fh
  1399 00000352 3C0F                    	cmp	al, 0Fh
  1400 00000354 7403                    	je	short _ac97_codec_init_ok
  1401 00000356 E2F0                    	loop	_ac97_codec_rloop 
  1402                                  
  1403                                  	; 12/05/2024
  1404                                  	; cf = 1
  1405                                  init_ac97_codec_err1:
  1406                                  	;stc	; 12/05/2024
  1407                                  init_ac97_codec_err2:
  1408 00000358 C3                      	retn
  1409                                  
  1410                                  _ac97_codec_init_ok:
  1411                                          ; 11/11/2023
  1412                                  	;mov	al, 2 ; force set 16-bit 2-channel PCM
  1413                                  	;mov	dx, GLOB_CNT_REG ; 2Ch
  1414                                  	;add	dx, [NABMBAR]
  1415                                  	;out	dx, eax
  1416                                  
  1417                                  	;;call	delay1_4ms
  1418                                  
  1419 00000359 E86A00                  	call 	reset_ac97_controller
  1420                                  
  1421                                  	; 11/11/2023
  1422                                  	;call	delay1_4ms
  1423                                  	; 21/11/2023 - temporary
  1424 0000035C E82E01                  	call	delay_100ms
  1425                                  
  1426                                  	;call 	setup_ac97_codec
  1427                                  
  1428                                  setup_ac97_codec:
  1429                                  	; 08/05/2028
  1430                                  	; [sample_rate] = 22050
  1431                                  	; 12/11/2023
  1432                                  	;cmp	word [sample_rate], 48000
  1433                                  	;je	short skip_rate
  1434                                  
  1435                                  ; 11/11/2023
  1436                                  ; 05/11/2023
  1437                                  ;%if 1
  1438                                  	AC97_EA_VRA equ BIT0 ; 11/11/2023
  1439                                  
  1440                                  	; 11/11/2023
  1441 0000035F 8B16[4410]              	mov    	dx, [NAMBAR]               	
  1442 00000363 83C22A                  	add    	dx, CODEC_EXT_AUDIO_CTRL_REG  	; 2Ah  	  
  1443 00000366 ED                      	in     	ax, dx
  1444                                  
  1445                                  	; 02/12/2023
  1446 00000367 E8EC08                  	call	delay1_4ms
  1447                                  
  1448                                  	; 15/05/2024
  1449 0000036A A801                    	test	al, 1 ; BIT0 ; Variable Rate Audio bit
  1450 0000036C 7412                    	jz	short vra_not_supported
  1451                                  
  1452 0000036E 24FD                    	and	al, ~BIT1 ; Clear DRA
  1453 00000370 0C01                    	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
  1454 00000372 EF                      	out	dx, ax			; Enable variable rate audio
  1455                                  	
  1456 00000373 B90A00                  	mov	cx, 10
  1457                                  check_vra:
  1458 00000376 E81401                  	call	delay_100ms
  1459                                  
  1460                                  	; 11/11/2023
  1461 00000379 ED                      	in	ax, dx
  1462 0000037A A801                    	test	al, AC97_EA_VRA ; 1
  1463 0000037C 750A                    	jnz	short set_rate
  1464                                  
  1465                                  	; 11/11/2023
  1466 0000037E E2F6                    	loop	check_vra
  1467                                  
  1468                                  	; 13/11/2023
  1469                                  	;mov	byte [VRA], 0
  1470                                  vra_not_supported:
  1471                                  	; 08/05/2024
  1472 00000380 C706[B08D]80BB          	mov	word [sample_rate], 48000
  1473 00000386 EB0E                    	jmp	short skip_rate	
  1474                                  
  1475                                  	; 12/11/2023
  1476                                  	;pop	ax ; discard return address to the caller
  1477                                  	;mov	dx, msg_no_vra
  1478                                  	;jmp	vra_err
  1479                                  
  1480                                  set_rate:
  1481 00000388 A1[B08D]                	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
  1482                                  	; 08/05/2024
  1483                                  	; ax = 22050 (Hz)
  1484                                  
  1485 0000038B 8B16[4410]              	mov    	dx, [NAMBAR]               	
  1486 0000038F 83C22C                  	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch  	  
  1487 00000392 EF                      	out	dx, ax 			; PCM Front/Center Output Sample Rate
  1488                                  
  1489 00000393 E8F700                  	call	delay_100ms
  1490                                  
  1491                                  	; 12/11/2023
  1492                                  skip_rate:
  1493                                  	; 11/11/2023 (temporary)
  1494                                  
  1495                                  	;mov   	dx, [NAMBAR]               	
  1496                                  	;add   	dx, CODEC_PCM_SURND_DACRATE_REG	; 2Eh  	  
  1497                                  	;out	dx, ax 			; PCM Surround Output Sample Rate
  1498                                  
  1499                                  	;call	delay_100ms
  1500                                  
  1501                                  	;mov   	dx, [NAMBAR]               	
  1502                                  	;add   	dx, CODEC_PCM_LFE_DACRATE_REG	; 30h  	  
  1503                                  	;out	dx, ax 			; PCM LFE Output Sample Rate
  1504                                  
  1505                                  	;call	delay_100ms
  1506                                  
  1507                                  	; 05/11/2023 (temporary)
  1508                                  	;mov	dx, [NAMBAR]               	
  1509                                  	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h  	  
  1510                                  	;out	dx, ax 			; PCM Input Sample Rate
  1511                                  	;
  1512                                  	;call	delay_100ms
  1513                                  
  1514 00000396 B80202                  	mov	ax, 0202h
  1515 00000399 A2[6310]                	mov	[volume], al ; 29
  1516 0000039C 8B16[4410]              	mov     dx, [NAMBAR]
  1517 000003A0 83C202                    	add     dx, CODEC_MASTER_VOL_REG	;02h 
  1518 000003A3 EF                      	out     dx, ax
  1519                                  
  1520                                  	; 11/11/2023
  1521                                          ;call	delay1_4ms
  1522                                          ;call	delay1_4ms
  1523                                          ;call	delay1_4ms
  1524                                          ;call	delay1_4ms
  1525                                   	;
  1526                                    	;mov	dx, [NAMBAR]
  1527                                    	;add	dx, CODEC_MASTER_MONO_VOL_REG	;06h 
  1528                                    	;out	dx, ax
  1529                                  
  1530                                  	; 11/11/2023
  1531                                          ;call	delay1_4ms
  1532                                          ;call	delay1_4ms
  1533                                          ;call	delay1_4ms
  1534                                          ;call	delay1_4ms
  1535                                  	;
  1536                                  	;mov	ax, 02h
  1537                                    	;mov	dx, [NAMBAR]
  1538                                    	;add	dx, CODEC_PCBEEP_VOL_REG	;0Ah 
  1539                                    	;out	dx, ax
  1540                                  
  1541                                  	; 14/05/2024
  1542                                  	; 20/11/2023
  1543 000003A4 E8AF08                          call	delay1_4ms
  1544 000003A7 E8AC08                          call	delay1_4ms
  1545 000003AA E8A908                          call	delay1_4ms
  1546 000003AD E8A608                          call	delay1_4ms
  1547                                  
  1548                                  	; 21/11/2023 temporary
  1549                                  	;call	delay_100ms
  1550                                  
  1551                                  	;mov	ax, 0202h
  1552 000003B0 8B16[4410]                	mov     dx, [NAMBAR]
  1553 000003B4 83C218                    	add     dx, CODEC_PCM_OUT_REG		;18h 
  1554 000003B7 EF                        	out     dx, ax
  1555                                  
  1556                                  	; 14/05/2024
  1557                                  	; 20/11/2023
  1558 000003B8 E89B08                          call	delay1_4ms
  1559 000003BB E89808                          call	delay1_4ms
  1560 000003BE E89508                          call	delay1_4ms
  1561 000003C1 E89208                          call	delay1_4ms
  1562                                  
  1563                                  	; 14/05/2024
  1564                                  	; 21/11/2023 - temporary
  1565                                  	;call	delay_100ms
  1566                                  
  1567                                  	; 11/11/2023
  1568                                  	;mov	ax, 8008h ; Mute
  1569                                    	;mov	dx, [NAMBAR]
  1570                                  	;add	dx, CODEC_PHONE_VOL_REG		;0Ch
  1571                                  	;			 ; AC97_PHONE_VOL ; TAD Input (Mono)
  1572                                    	;out	dx, ax
  1573                                  	;
  1574                                          ;call	delay1_4ms
  1575                                          ;call	delay1_4ms
  1576                                          ;call	delay1_4ms
  1577                                  	;call	delay1_4ms
  1578                                  
  1579                                  	;mov	ax, 0808h
  1580                                  	;mov	dx, [NAMBAR]
  1581                                  	;add	dx, CODEC_LINE_IN_VOL_REG ;10h ; Line Input (Stereo)
  1582                                  	;out	dx, ax
  1583                                  	;
  1584                                          ;call	delay1_4ms
  1585                                          ;call	delay1_4ms
  1586                                          ;call	delay1_4ms
  1587                                  	;call	delay1_4ms
  1588                                  
  1589                                    	;mov	dx, [NAMBAR]
  1590                                          ;add	dx, CODEC_CD_VOL_REG ;12h ; CD Input (Stereo)
  1591                                    	;out	dx, ax
  1592                                  	;
  1593                                    	;mov	dx, [NAMBAR]
  1594                                          ;add	dx, CODEC_AUX_VOL_REG ;16h ; Aux Input (Stereo)
  1595                                    	;out	dx, ax
  1596                                  	;
  1597                                          ;call	delay1_4ms
  1598                                          ;call	delay1_4ms
  1599                                          ;call	delay1_4ms
  1600                                  	;call	delay1_4ms
  1601                                  
  1602                                  	; 14/05/2024
  1603                                  	;call	delay_100ms
  1604                                  
  1605                                  	; 14/05/2024
  1606 000003C4 F8                      	clc
  1607                                  
  1608                                  ;detect_ac97_codec:
  1609 000003C5 C3                              retn
  1610                                  
  1611                                  reset_ac97_controller:
  1612                                  	; 11/11/2023
  1613                                  	; 10/06/2017
  1614                                  	; 29/05/2017
  1615                                  	; 28/05/2017
  1616                                  	; reset AC97 audio controller registers
  1617 000003C6 31C0                    	xor     ax, ax
  1618 000003C8 BA0B00                          mov	dx, PI_CR_REG
  1619 000003CB 0316[4610]              	add	dx, [NABMBAR]
  1620 000003CF EE                      	out     dx, al
  1621                                  
  1622                                  	; 14/05/2024
  1623 000003D0 E88308                  	call	delay1_4ms
  1624                                  
  1625 000003D3 BA1B00                          mov     dx, PO_CR_REG
  1626 000003D6 0316[4610]              	add	dx, [NABMBAR]
  1627 000003DA EE                      	out     dx, al
  1628                                  
  1629                                  	; 14/05/2024
  1630 000003DB E87808                  	call	delay1_4ms
  1631                                  
  1632 000003DE BA2B00                          mov     dx, MC_CR_REG
  1633 000003E1 0316[4610]              	add	dx, [NABMBAR]
  1634 000003E5 EE                      	out     dx, al
  1635                                  
  1636                                  	; 14/05/2024
  1637 000003E6 E86D08                  	call	delay1_4ms
  1638                                  
  1639 000003E9 B002                            mov     al, RR
  1640 000003EB BA0B00                          mov     dx, PI_CR_REG
  1641 000003EE 0316[4610]              	add	dx, [NABMBAR]
  1642 000003F2 EE                      	out     dx, al
  1643                                  
  1644                                  	; 14/05/2024
  1645 000003F3 E86008                  	call	delay1_4ms
  1646                                  
  1647 000003F6 BA1B00                          mov     dx, PO_CR_REG
  1648 000003F9 0316[4610]              	add	dx, [NABMBAR]
  1649 000003FD EE                      	out     dx, al
  1650                                  
  1651                                  	; 14/05/2024
  1652 000003FE E85508                  	call	delay1_4ms
  1653                                  
  1654 00000401 BA2B00                          mov     dx, MC_CR_REG
  1655 00000404 0316[4610]              	add	dx, [NABMBAR]
  1656 00000408 EE                      	out     dx, al
  1657                                  
  1658                                  	; 14/05/2024
  1659 00000409 E84A08                  	call	delay1_4ms
  1660                                  
  1661 0000040C C3                      	retn
  1662                                  
  1663                                  reset_ac97_codec:
  1664                                  	; 11/11/2023
  1665                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1666 0000040D BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1667 00000410 0316[4610]              	add	dx, [NABMBAR]
  1668 00000414 66ED                    	in	eax, dx
  1669                                  
  1670                                  	;test	eax, 2
  1671                                  	; 06/08/2022
  1672 00000416 A802                    	test	al, 2
  1673 00000418 7405                    	jz	short _r_ac97codec_cold	
  1674                                  
  1675 0000041A E80E00                  	call	warm_ac97codec_reset
  1676 0000041D 7306                    	jnc	short _r_ac97codec_ok
  1677                                  _r_ac97codec_cold:
  1678 0000041F E83400                          call    cold_ac97codec_reset
  1679 00000422 7301                            jnc     short _r_ac97codec_ok
  1680                                  	
  1681                                  	; 16/04/2017
  1682                                          ;xor	eax, eax	; timeout error
  1683                                         	;stc
  1684 00000424 C3                      	retn
  1685                                  
  1686                                  _r_ac97codec_ok:
  1687 00000425 6631C0                          xor     eax, eax
  1688                                          ;mov	al, VIA_ACLINK_C00_READY ; 1
  1689 00000428 FEC0                            inc	al
  1690 0000042A C3                      	retn
  1691                                  
  1692                                  warm_ac97codec_reset:
  1693                                  	; 11/11/2023
  1694                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  1695                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1696 0000042B 66B806000000            	mov	eax, 6
  1697 00000431 BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1698 00000434 0316[4610]              	add	dx, [NABMBAR]
  1699 00000438 66EF                    	out	dx, eax
  1700                                  
  1701 0000043A B90A00                  	mov	cx, 10	; total 1s
  1702                                  _warm_ac97c_rst_wait:
  1703 0000043D E84D00                  	call	delay_100ms
  1704                                  
  1705 00000440 BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1706 00000443 0316[4610]              	add	dx, [NABMBAR]
  1707 00000447 66ED                    	in	eax, dx
  1708                                  
  1709 00000449 66A900030010            	test	eax, CTRL_ST_CREADY
  1710 0000044F 7504                    	jnz	short _warm_ac97c_rst_ok
  1711                                  
  1712 00000451 49                              dec     cx
  1713 00000452 75E9                            jnz     short _warm_ac97c_rst_wait
  1714                                  
  1715                                  _warm_ac97c_rst_fail:
  1716 00000454 F9                              stc
  1717                                  _warm_ac97c_rst_ok:
  1718 00000455 C3                      	retn
  1719                                  
  1720                                  cold_ac97codec_reset:
  1721                                  	; 11/11/2023
  1722                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  1723                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1724 00000456 66B802000000                    mov	eax, 2
  1725 0000045C BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1726 0000045F 0316[4610]              	add	dx, [NABMBAR]
  1727 00000463 66EF                    	out	dx, eax
  1728                                  
  1729 00000465 E82500                  	call	delay_100ms 	; wait 100 ms
  1730 00000468 E82200                  	call	delay_100ms 	; wait 100 ms
  1731 0000046B E81F00                  	call	delay_100ms 	; wait 100 ms
  1732 0000046E E81C00                  	call	delay_100ms 	; wait 100 ms
  1733                                  
  1734 00000471 B91000                  	mov	cx, 16	; total 20*100 ms = 2s
  1735                                  
  1736                                  _cold_ac97c_rst_wait:
  1737 00000474 BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1738 00000477 0316[4610]              	add	dx, [NABMBAR]
  1739 0000047B 66ED                    	in	eax, dx
  1740                                  
  1741 0000047D 66A900030010            	test	eax, CTRL_ST_CREADY
  1742 00000483 7507                    	jnz	short _cold_ac97c_rst_ok
  1743                                  
  1744 00000485 E80500                  	call	delay_100ms
  1745                                  
  1746 00000488 49                              dec     cx
  1747 00000489 75E9                            jnz     short _cold_ac97c_rst_wait
  1748                                  
  1749                                  _cold_ac97c_rst_fail:
  1750 0000048B F9                              stc
  1751                                  _cold_ac97c_rst_ok:
  1752 0000048C C3                      	retn
  1753                                  
  1754                                  delay_100ms:
  1755                                  	; 11/11/2023
  1756                                  	; 29/05/2017
  1757                                  	; 24/03/2017 ('codec.asm')
  1758                                  	; wait 100 ms
  1759 0000048D 51                      	push	cx
  1760 0000048E B99001                  	mov	cx, 400  ; 400*0.25ms
  1761                                  _delay_x_ms:
  1762 00000491 E8C207                  	call	delay1_4ms
  1763 00000494 E2FB                            loop	_delay_x_ms
  1764 00000496 59                      	pop	cx
  1765 00000497 C3                      	retn
  1766                                  
  1767                                  ;=============================================================================
  1768                                  ;               ICH_WAV.ASM
  1769                                  ;=============================================================================
  1770                                  
  1771                                  ; DOS based .WAV player using AC'97 and codec interface.
  1772                                  ; ---------------------------------------------------------------
  1773                                  ; NASM version: Erdogan Tan (29/11/2016)
  1774                                  ; Last Update: 17/02/2017 (by Erdogan Tan)
  1775                                  
  1776                                  ; ICHWAV.ASM
  1777                                  ; PLAYMOD.ASM
  1778                                  ; player internal variables and other equates.
  1779                                  ;BUFFERSIZE	equ	2048*4		; 8K half buffer size. 18/02/2017
  1780                                  ; 15/05/2024
  1781                                  ;BUFFERSIZE	equ	2560*4
  1782                                  ; 16/05/2024
  1783                                  BUFFERSIZE	equ	3840*4
  1784                                  ;ENDOFFILE	equ	BIT0		; flag for knowing end of file
  1785                                  
  1786                                  ;===========================================================================
  1787                                  ; entry: none.  File is already open and [filehandle] filled.
  1788                                  ; exit:  not until the song is finished or the user aborts.
  1789                                  ;
  1790                                  ; 18/02/2017
  1791                                  ModPlay: ; 13/02/2017  ; ModPlay Polling!
  1792                                  	;cld
  1793                                  	; clear (half) buffer 2
  1794                                         	;mov	di, [DMA_BUFFER2]
  1795                                  	;sub	ax, ax
  1796                                  	;mov	cx, (BUFFERSIZE/2)
  1797                                  	;rep	stosw
  1798                                  
  1799                                  	; 15/05/2024
  1800 00000498 06                      	push	es
  1801 00000499 1E                      	push	ds
  1802 0000049A 07                      	pop	es
  1803 0000049B B94001                  	mov	cx, 320
  1804 0000049E BF[82EC]                	mov	di, MOD_BUFFER
  1805 000004A1 B88080                  	mov	ax, 8080h
  1806 000004A4 F3AB                    	rep	stosw
  1807 000004A6 B900A0                  	mov	cx, 0A000h
  1808 000004A9 8EC1                    	mov	es, cx
  1809 000004AB E8FF00                  	call	ScopeLoop
  1810 000004AE 07                      	pop	es
  1811                                  	
  1812                                          ; load 2048 bytes into buffer 1
  1813 000004AF 8B36[5410]              	mov	si, [DMA_BUFFER1]
  1814                                  	; 11/05/2024
  1815                                  	;mov	cx, BUFFERSIZE
  1816                                  	;push	ds ; segment
  1817                                  	;push	si ; offset
  1818                                  	;push	cx ; count
  1819 000004B3 E87A06                  	call    GetSamples_ICH ; 18/02/2017
  1820                                  
  1821                                          ; load 2048 bytes into buffer  2
  1822 000004B6 8B36[5610]              	mov	si, [DMA_BUFFER2]
  1823                                  	; 11/05/2024
  1824                                  	;mov	cx, BUFFERSIZE
  1825                                  	;push	ds ; segment
  1826                                  	;push	si ; offset
  1827                                  	;push	cx ; count
  1828 000004BA E87306                  	call	GetSamples_ICH ; 18/02/2017
  1829                                  
  1830                                  ; register reset the DMA engine. This may cause a pop noise on the output
  1831                                  ; lines when the device is reset. Prolly a better idea to mute output, then
  1832                                  ; reset.
  1833                                  
  1834                                  	; 08/05/2024
  1835                                          ;mov    dx, [NABMBAR]
  1836                                          ;add    dx, PO_CR_REG		; set pointer to Ctrl reg
  1837                                          ;mov    al, RR			; set reset
  1838                                  	;out    dx, al			; self clearing bit
  1839                                  
  1840                                  ; write last valid index to 31 to start with.
  1841                                  ; The Last Valid Index register tells the DMA engine when to stop playing.
  1842                                  ; 
  1843                                  ; As we progress through the song we change the last valid index to always be
  1844                                  ; something other than the index we're currently playing.  
  1845                                  ;
  1846                                          ;;mov   al, 1
  1847                                          ;mov	al, 31
  1848                                  	;call   setLastValidIndex
  1849                                  
  1850                                  ; create Buffer Descriptor List
  1851                                  ;
  1852                                  ; A buffer descriptor list is a list of pointers and control bits that the
  1853                                  ; DMA engine uses to know where to get the .wav data and how to play it.
  1854                                  ;
  1855                                  ; I set it up to use only 2 buffers of .wav data, and whenever 1 buffer is
  1856                                  ; playing, I refresh the other one with good data.
  1857                                  ;
  1858                                  ;
  1859                                  ; For the control bits, you can specify that the DMA engine fire an interrupt
  1860                                  ; after a buffer has been processed, but I poll the current index register
  1861                                  ; to know when it's safe to update the other buffer.
  1862                                  ;
  1863                                  ; I set the BUP bit, which tells the DMA engine to just play 0's (silence)
  1864                                  ; if it ever runs out of data to play. Good for safety.
  1865                                  ;
  1866                                  	; 14/02/2017
  1867 000004BD 8B3E[5210]                      mov     di, [BDL_BUFFER]		; get BDL address
  1868 000004C1 B91000                          mov     cx, 32 / 2                      ; make 32 entries in BDL
  1869 000004C4 6631D2                  	xor	edx, edx
  1870 000004C7 8CDA                    	mov	dx, ds
  1871 000004C9 66C1E204                	shl	edx, 4 ; segment*16 (linear/physical address of the segment)
  1872                                  _0:
  1873                                  
  1874                                  ; set buffer descriptor 0 to start of data file in memory
  1875                                  	; 14/02/2017
  1876 000004CD 660FB706[5410]                  movzx   eax, word [DMA_BUFFER1]
  1877 000004D3 6601D0                  	add	eax, edx ; linear/physical address of the buffer (seg*16+off)
  1878 000004D6 66AB                            stosd					; store dmabuffer1 address
  1879                                  
  1880                                  ;
  1881                                  ; set length to 32k samples. 1 sample is 16bits or 2bytes.
  1882                                  ; Set control (bits 31:16) to BUP, bits 15:0=number of samples.
  1883                                  ; 
  1884                                  
  1885                                  ; 17/02/2017 (Erdogan Tan)
  1886                                  ; Intel 82801AA (ICH) & Intel 82801AB (ICH0) I/O Controller Hub AC 97
  1887                                  ; Programmers Reference Manual
  1888                                  
  1889                                  ; 2.2.1 Buffer Descriptor List  (on Page 13)
  1890                                  	;
  1891                                  	;  Generic Form of Buffer Descriptor
  1892                                  	;  ---------------------------------
  1893                                  	;  63   62    61-48    47-32   31-0
  1894                                  	;  ---  ---  --------  ------- -----
  1895                                  	;  IOC  BUP -reserved- Buffer  Buffer
  1896                                  	;		      Length   Pointer
  1897                                  	;		      [15:0]   [31:0]
  1898                                  	;
  1899                                  	;  IOC:	Interrupt On Completion. 
  1900                                  	;	1 = Enabled. 
  1901                                  	;	    When this is set, it means that the controller should
  1902                                  	;	    issue an interrupt upon completion of this buffer.
  1903                                  	;	    It should also set the IOC bit in the status register
  1904                                  	;	0 = Disabled	
  1905                                  	;
  1906                                  	;  BUP: Buffer Underrun Policy.
  1907                                  	;       0 = When this buffer is complete,
  1908                                  	;	    if the next buffer is not yet ready 
  1909                                  	;	    (i.e., the last valid buffer has been processed),
  1910                                  	;	    then continue to transmit the last valid sample.
  1911                                  	;	1 = When this buffer is complete,
  1912                                  	;     	    if this is the last valid buffer, transmit zeros after
  1913                                  	;	    this buffer has been processed completely.
  1914                                  	;	    This bit typically is set only if this is the last 
  1915                                  	;	    buffer in the current stream.
  1916                                  	;
  1917                                  	; [31:0]: Buffer pointer. This field points to the location of
  1918                                  	;	  the data buffer. Since samples can be as wide as one
  1919                                  	;	  word, the buffer must be aligned with word boundaries,
  1920                                  	;	  to prevent samples from straddling DWord boundaries.
  1921                                  	;
  1922                                  	; [15:0]: Buffer Length: This is the length of the data buffer,
  1923                                  	;	  in number of samples. The controller uses this data
  1924                                  	;	  to determine the length of the buffer, in bytes.
  1925                                  	;	  "0" indicates no sample to process.
  1926                                  
  1927                                  ; ICH2AC97.INC
  1928                                  
  1929                                  ;	IOC	equ     BIT31   ; Fire an interrupt whenever this
  1930                                  				; buffer is complete.
  1931                                  
  1932                                  ;	BUP	equ     BIT30   ; Buffer Underrun Policy.
  1933                                  				; if this buffer is the last buffer
  1934                                  				; in a playback, fill the remaining
  1935                                  				; samples with 0 (silence) or not.
  1936                                  				; It's a good idea to set this to 1
  1937                                  				; for the last buffer in playback,
  1938                                  				; otherwise you're likely to get a lot
  1939                                  				; of noise at the end of the sound.
  1940                                  ;
  1941                                  ; Bits 15:0 contain the length of the buffer, in number of samples, which
  1942                                  ; are 16 bits each, coupled in left and right pairs, or 32bits each.
  1943                                  ; Luckily for us, that's the same format as .wav files.
  1944                                  ;
  1945                                  ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
  1946                                  ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
  1947                                  ;
  1948                                  ; A value of 0 in these bits means play no samples.
  1949                                  ;
  1950                                  	; 08/12/2016 - Erdogan Tan
  1951                                  	;mov	eax, BUFFERSIZE
  1952                                  	; 12/05/2024
  1953 000004D8 66B8001E0000            	mov	eax, BUFFERSIZE/2
  1954 000004DE 660D000000C0            	or	eax, IOC + BUP
  1955 000004E4 66AB                    	stosd
  1956                                  
  1957                                  ; 2nd buffer:
  1958                                  	; 14/02/2017
  1959 000004E6 660FB706[5610]                  movzx   eax, word [DMA_BUFFER2]
  1960 000004EC 6601D0                  	add	eax, edx ; linear/physical address of the buffer (seg*16+off)
  1961 000004EF 66AB                            stosd					; store dmabuffer2 address
  1962                                  
  1963                                  ; set length to 64k (32k of two 16 bit samples)
  1964                                  ; Set control (bits 31:16) to BUP, bits 15:0=number of samples
  1965                                  ; 
  1966                                  	; 08/12/2016 - Erdogan Tan
  1967                                  	;mov	eax, BUFFERSIZE
  1968                                  	; 12/05/2024
  1969 000004F1 66B8001E0000            	mov	eax, BUFFERSIZE/2
  1970 000004F7 660D000000C0            	or	eax, IOC + BUP
  1971 000004FD 66AB                    	stosd
  1972 000004FF E2CC                            loop    _0
  1973                                  ;
  1974                                  ; tell the DMA engine where to find our list of Buffer Descriptors.
  1975                                  ; this 32bit value is a flat mode memory offset (ie no segment:offset)
  1976                                  ;
  1977                                  ; write NABMBAR+10h with offset of buffer descriptor list
  1978                                  ;
  1979 00000501 660FB706[5210]                  movzx   eax, word [BDL_BUFFER]
  1980                                  	; 14/02/2017
  1981 00000507 6601D0                  	add	eax, edx ; linear/physical address of the BDL
  1982                                    	; 18/02/2017
  1983 0000050A 8B16[4610]                      mov     dx, [NABMBAR]
  1984 0000050E 83C210                          add     dx, PO_BDBAR_REG                ; set pointer to BDL
  1985 00000511 66EF                            out     dx, eax                         ; write to AC97 controller
  1986                                  
  1987                                  	; 15/05/2024
  1988 00000513 E84007                  	call	delay1_4ms
  1989                                  ;
  1990                                  ; All set. Let's play some music.
  1991                                  ;
  1992                                  	; 08/12/2016
  1993                                  	; 07/10/2016
  1994                                          ;mov    al, 1
  1995 00000516 B01F                            mov	al, 31
  1996                                  
  1997                                  	; 13/05/2024
  1998                                  	; 08/05/2024
  1999                                  	;mov	[LVI], al ; 10/11/2023
  2000                                  	;call   setLastValidIndex
  2001                                  
  2002                                  	;input AL = index # to stop on
  2003                                  setLastValidIndex:
  2004 00000518 8B16[4610]              	mov	dx, [NABMBAR]
  2005 0000051C 83C215                  	add	dx, PO_LVI_REG
  2006 0000051F EE                              out     dx, al
  2007                                  
  2008 00000520 C606[4B10]01            	mov	byte [tLoop], 1 ; 30/11/2016
  2009                                  
  2010                                  	; 15/05/2024
  2011 00000525 E82E07                  	call	delay1_4ms
  2012                                  
  2013                                  	; 12/05/2024	
  2014                                  	; 17/02/2017
  2015 00000528 8B16[4610]                      mov	dx, [NABMBAR]
  2016 0000052C 83C21B                          add	dx, PO_CR_REG			; PCM out Control Register
  2017 0000052F B011                            mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
  2018                                  				; (LVBI interrupt will not be enabled)
  2019 00000531 EE                              out	dx, al				; Start bus master operation.
  2020                                  
  2021                                  	; 15/05/2024
  2022 00000532 E82107                  	call	delay1_4ms
  2023 00000535 E81E07                  	call	delay1_4ms
  2024 00000538 E81B07                  	call	delay1_4ms
  2025 0000053B E81807                  	call	delay1_4ms
  2026                                  
  2027                                  ; while DMA engine is running, examine current index and wait until it hits 1
  2028                                  ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
  2029                                  ; 64k.  Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
  2030                                     
  2031                                  	; 18/02/2017
  2032                                  	; 14/02/2017
  2033                                  	; 13/02/2017
  2034                                  	; 08/12/2016
  2035                                  	; 28/11/2016
  2036                                  
  2037 0000053E 06                      	push	es
  2038 0000053F B800A0                  	mov	ax, 0A000h
  2039 00000542 8EC0                    	mov	es, ax
  2040                                  	;mov	bp, DmaBuffer ; 14/02/2017
  2041                                  p_loop:
  2042 00000544 B401                    	mov     ah, 1			; any key pressed?
  2043                                  	;mov	ah, 11h
  2044 00000546 CD16                    	int     16h			; no, Loop.
  2045 00000548 7445                    	jz	short q_loop
  2046                                  
  2047 0000054A B400                    	mov	ah, 0
  2048                                  	;mov    ah, 10h			; flush key buffer...
  2049 0000054C CD16                    	int     16h
  2050                                  
  2051                                  	; 12/05/2024 (change PCM out volume)
  2052 0000054E 3C2B                    	cmp	al, '+'
  2053 00000550 750B                    	jne	short p_1
  2054                                  	
  2055 00000552 A0[6310]                	mov	al, [volume]
  2056 00000555 3C00                    	cmp	al, 0
  2057 00000557 7636                    	jna	short q_loop
  2058 00000559 FEC8                    	dec	al
  2059 0000055B EB0D                    	jmp	short p_2
  2060                                  p_1:
  2061 0000055D 3C2D                    	cmp	al, '-'
  2062 0000055F 7524                    	jne	short p_return
  2063                                  
  2064 00000561 A0[6310]                	mov	al, [volume]
  2065 00000564 3C1F                    	cmp	al, 31
  2066 00000566 7327                    	jnb	short q_loop
  2067 00000568 FEC0                    	inc	al
  2068                                  p_2:
  2069 0000056A A2[6310]                	mov	[volume], al
  2070 0000056D 88C4                    	mov	ah, al
  2071 0000056F 8B16[4410]              	mov     dx, [NAMBAR]
  2072                                    	;add    dx, CODEC_MASTER_VOL_REG
  2073 00000573 83C218                  	add	dx, CODEC_PCM_OUT_REG
  2074 00000576 EF                      	out     dx, ax
  2075                                  
  2076                                  	; 12/05/2024
  2077 00000577 E8DC06                  	call    delay1_4ms
  2078 0000057A E8D906                          call    delay1_4ms
  2079 0000057D E8D606                          call    delay1_4ms
  2080 00000580 E8D306                          call    delay1_4ms
  2081                                  
  2082 00000583 EB0A                    	jmp	short q_loop
  2083                                  
  2084                                  p_return:
  2085 00000585 C606[4B10]00            	mov	byte [tLoop], 0	; 13/02/2017
  2086                                  	; 16/05/2024
  2087 0000058A E8A206                  	call	StopPlaying
  2088 0000058D 07                      	pop	es
  2089 0000058E C3                      	retn
  2090                                  
  2091                                  q_loop:
  2092                                  	; 10/05/2024
  2093 0000058F 31C0                    	xor	ax, ax
  2094 00000591 8606[4810]              	xchg	al, [tBuff] ; AL = [tBuff], [tBuff] = 0
  2095 00000595 3C01                    	cmp	al, 1
  2096 00000597 7708                    	ja	short r_loop
  2097                                  	;jb	short ScopeLoop
  2098                                  	; 15/05/2024
  2099 00000599 720D                    	jb	short x_loop
  2100                                  	;
  2101 0000059B 8B36[5410]                   	mov	si, [DMA_BUFFER1] ; [tBuff]=1 (from tuneLoop)
  2102 0000059F EB04                           	jmp	short s_loop 
  2103                                  r_loop:
  2104                                  	; 13/02/2017
  2105 000005A1 8B36[5610]                      mov     si, [DMA_BUFFER2] ; [tBuff]=2 (from tuneLoop)
  2106                                  s_loop:
  2107                                  	; 14/02/2017
  2108                                  	;mov	bp, si ; save current buffer addres in bp register
  2109                                  	; 11/05/2024
  2110                                  	;mov	cx, BUFFERSIZE ; 2048*4 byte
  2111                                  	;push	ds ; segment
  2112                                  	;push	si ; offset
  2113                                  	;push	cx ; count
  2114 000005A5 E88805                  	call    GetSamples_ICH ; 18/02/2017
  2115                                  
  2116                                  	; 15/05/2024
  2117                                  x_loop:
  2118 000005A8 E80200                  	call	ScopeLoop
  2119 000005AB EB97                    	jmp	short p_loop
  2120                                  
  2121                                  ScopeLoop:
  2122                                  	;mov    si, bp			; get current samples
  2123 000005AD BE[82EC]                	mov	si, MOD_BUFFER ; 18/02/2017
  2124 000005B0 31C9                    	xor     cx, cx			; to be drawed ...
  2125 000005B2 31D2                    	xor     dx, dx
  2126                                  DrawLoop:       
  2127 000005B4 89D3                    	mov     bx, dx			; (save Index)
  2128 000005B6 8BBF[00E8]              	mov     di, [Scope+bx]		; get old SCOPE pixel address
  2129 000005BA 26C60500                	mov     byte [es:di], 0		; erase it!
  2130 000005BE AC                      	lodsb				; get a sample (8-bit)
  2131 000005BF 88C3                    	mov     bl, al			; calc new pixel address...
  2132 000005C1 30FF                    	xor     bh, bh
  2133 000005C3 D1E3                    	shl     bx, 1
  2134 000005C5 8BBF[80EA]              	mov     di, [RowOfs+bx]
  2135 000005C9 01CF                    	add     di, cx
  2136 000005CB 89D3                    	mov     bx, dx			; (restore Index)
  2137 000005CD 89BF[00E8]              	mov     [Scope+bx], di		; save new address...
  2138 000005D1 26C6050A                	mov     byte [es:di], 10 ; 0Ah	; and DRAW.
  2139 000005D5 83C202                  	add     dx, 2			; the next pixel...
  2140 000005D8 41                      	inc     cx
  2141 000005D9 81F94001                	cmp     cx, 320			; 320 pixels drawed?
  2142 000005DD 72D5                    	jb      short DrawLoop
  2143                                  	; 15/05/2024
  2144                                  	;jmp	p_loop
  2145 000005DF C3                      	retn
  2146                                  
  2147                                  ; 13/05/2024
  2148                                  %if 0
  2149                                  
  2150                                  tuneLoop:
  2151                                  	; 11/05/2024
  2152                                  	; 11/11/2023
  2153                                  	; 10/11/2023
  2154                                  	; 18/02/2017
  2155                                  	; 08/12/2016
  2156                                  	; 28/11/2016 - Erdogan Tan
  2157                                  
  2158                                  	; 11/05/2024
  2159                                  	cmp	byte [tLoop], 1
  2160                                  	jb	short tL3
  2161                                  	
  2162                                  	call    getCurrentIndex
  2163                                  
  2164                                  	; 10/11/2023
  2165                                  	cmp	al, [LVI]
  2166                                  	jne	short tL1
  2167                                  
  2168                                  	dec	ax
  2169                                  	and	al, 1Fh 
  2170                                  	call	setLastValidIndex
  2171                                  	xchg	al, [LVI]
  2172                                  tL1:
  2173                                  	test	al, BIT0
  2174                                  	jz	short tL2
  2175                                  
  2176                                  	; 11/05/2024
  2177                                  	mov	byte [tBuff], 1
  2178                                  	retn
  2179                                  tL2:	
  2180                                  	mov	byte [tBuff], 2
  2181                                  tL3:
  2182                                  	retn
  2183                                  
  2184                                  ; returns AL = current index value
  2185                                  getCurrentIndex:
  2186                                  	;push	dx
  2187                                  	mov	dx, [NABMBAR]
  2188                                  	add	dx, PO_CIV_REG
  2189                                  	in	al, dx
  2190                                  	;pop	dx
  2191                                  	retn
  2192                                  
  2193                                  ;input AL = index # to stop on
  2194                                  setLastValidIndex:
  2195                                  	;push	dx
  2196                                  	mov	dx, [NABMBAR]
  2197                                  	add	dx, PO_LVI_REG
  2198                                          out     dx, al
  2199                                  	;pop	dx
  2200                                  	retn
  2201                                  
  2202                                  %endif
  2203                                  
  2204                                  ;=============================================================================
  2205                                  ;               MODLOAD.ASM
  2206                                  ;=============================================================================
  2207                                  
  2208                                  ; Amiga Module Loader v0.1b by Carlos Hasan.
  2209                                  ;		July 10th, 1993.
  2210                                  
  2211                                  ; STRUCTURES
  2212                                  
  2213                                  struc ModSample
  2214 00000000 <res 16h>               .msName:	resb 22
  2215 00000016 ????                    .msLength:	resw 1
  2216 00000018 ??                      .msFinetune:	resb 1
  2217 00000019 ??                      .msVolume:	resb 1
  2218 0000001A ????                    .msRepeat:	resw 1
  2219 0000001C ????                    .msRepLen:	resw 1
  2220                                  .size:
  2221                                  endstruc
  2222                                  
  2223                                  struc ModHeader
  2224 00000000 <res 14h>               .mhName:	resb 20
  2225 00000014 <res 3A2h>              .mhSamples:	resb ModSample.size*31
  2226 000003B6 ??                      .mhOrderLen:	resb 1
  2227 000003B7 ??                      .mhReStart:	resb 1
  2228 000003B8 <res 80h>               .mhOrder:	resb 128
  2229 00000438 ????????                .mhSign:	resw 2
  2230                                  .size:	
  2231                                  endstruc
  2232                                  
  2233                                  struc ModInfoRec
  2234 00000000 ??                      .OrderLen:	resb 1
  2235 00000001 ??                      .ReStart:	resb 1
  2236 00000002 <res 80h>               .Order:		resb 128
  2237 00000082 ????????                .Patterns:	resd 1
  2238 00000086 <res 3Eh>               .SampOfs:	resw 31
  2239 000000C4 <res 3Eh>               .SampSeg:	resw 31
  2240 00000102 <res 3Eh>               .SampLen:	resw 31
  2241 00000140 <res 3Eh>               .SampRep:	resw 31
  2242 0000017E <res 3Eh>               .SampRepLen:	resw 31
  2243 000001BC <res 3Eh>               .SampVol:	resw 31
  2244                                  .size:	
  2245                                  endstruc
  2246                                  
  2247                                  ; CODE
  2248                                  
  2249                                  LoadModule:
  2250                                  		;es:di = filename
  2251                                  
  2252                                  		;[sp+4] = es
  2253                                  		;[sp+2] = di
  2254                                  
  2255                                  		FileName equ 4		
  2256                                  
  2257 000005E0 55                      		push    bp
  2258 000005E1 89E5                    		mov     bp, sp
  2259 000005E3 60                      		pusha
  2260 000005E4 1E                      		push    ds
  2261 000005E5 06                      		push    es
  2262                                  
  2263 000005E6 C706[7289]0100          		mov	word [ErrorInfo], 1
  2264                                  
  2265 000005EC E85101                  		call    ClearModInfo
  2266                                  OpenFile:       
  2267 000005EF 1E                      		push    ds
  2268 000005F0 B8003D                  		mov     ax, 3D00h
  2269 000005F3 C55604                  		lds     dx, [bp+FileName]
  2270 000005F6 CD21                    		int     21h
  2271 000005F8 1F                      		pop     ds
  2272 000005F9 0F823C01                		jc      Failed
  2273 000005FD A3[7089]                		mov     [FileHandle], ax
  2274                                  
  2275                                  ReadHeader:     
  2276 00000600 B8003F                  		mov     ax, 3F00h
  2277 00000603 8B1E[7089]              		mov     bx, [FileHandle]
  2278 00000607 B93C04                  		mov     cx, ModHeader.size
  2279                                  		;lea    dx, [Header]
  2280 0000060A BA[7489]                		mov	dx, Header
  2281 0000060D CD21                    		int     21h
  2282 0000060F 0F821D01                		jc      CloseFile
  2283                                  CheckMK:        
  2284 00000613 813E[AC8D]4D2E          		cmp     word [Header+ModHeader.mhSign], 'M.'
  2285 00000619 7508                    		jne     short CheckFLT4
  2286 0000061B 813E[AE8D]4B2E          		cmp     word [Header+ModHeader.mhSign+2], 'K.'
  2287 00000621 7439                    		je      short IsModFile
  2288                                  CheckFLT4:
  2289 00000623 813E[AC8D]464C          		cmp     word [Header+ModHeader.mhSign], 'FL'
  2290 00000629 7508                    		jne     short Is15Inst
  2291 0000062B 813E[AE8D]5434          		cmp     word [Header+ModHeader.mhSign+2], 'T4'
  2292 00000631 7429                    		je      short IsModFile
  2293                                  Is15Inst:
  2294 00000633 BE[4A8B]                		mov     si, (Header+ModHeader.mhSamples) + (15*ModSample.size)
  2295 00000636 BF[2A8D]                		mov     di, Header+ModHeader.mhOrderLen
  2296 00000639 8CD8                    		mov     ax, ds
  2297 0000063B 8EC0                    		mov     es, ax
  2298 0000063D FC                      		cld
  2299 0000063E B98200                  		mov     cx, 130
  2300 00000641 F3A4                    		rep     movsb
  2301 00000643 BF[4A8B]                		mov     di, Header+ModHeader.mhSamples + (15*ModSample.size)
  2302 00000646 31C0                    		xor     ax, ax
  2303 00000648 B9E001                  		mov     cx, 16*ModSample.size
  2304 0000064B F3AA                    		rep     stosb
  2305                                  SeekPatterns:   
  2306 0000064D B80042                  		mov     ax, 4200h
  2307 00000650 8B1E[7089]              		mov     bx, [FileHandle]
  2308 00000654 B90000                  		mov     cx, 0
  2309 00000657 BA5802                  		mov     dx, 600
  2310 0000065A CD21                    		int     21h
  2311                                  IsModFile:  
  2312 0000065C A0[2A8D]                		mov     al, [Header+ModHeader.mhOrderLen]
  2313 0000065F A2[B28D]                		mov     [ModInfo.OrderLen], al
  2314                                  
  2315 00000662 A0[2B8D]                		mov     al, [Header+ModHeader.mhReStart]
  2316 00000665 3A06[2A8D]              		cmp     al, [Header+ModHeader.mhOrderLen]
  2317 00000669 7202                    		jb      short SetReStart
  2318 0000066B B07F                    		mov     al, 7Fh
  2319                                  SetReStart:
  2320 0000066D A2[B38D]                		mov     [ModInfo.ReStart], al
  2321                                  
  2322 00000670 B98000                  		mov     cx, 128
  2323 00000673 31C0                    		xor     ax, ax
  2324 00000675 31DB                    		xor     bx, bx
  2325                                  CopyOrder:
  2326 00000677 8AA7[2C8D]              		mov     ah, [Header+ModHeader.mhOrder+bx]
  2327 0000067B 88A7[B48D]              		mov     [ModInfo.Order+bx], ah
  2328 0000067F 38C4                    		cmp     ah, al
  2329 00000681 7202                    		jb      short NextOrder
  2330 00000683 88E0                    		mov     al, ah
  2331                                  NextOrder:
  2332 00000685 43                      		inc     bx
  2333 00000686 E2EF                    		loop    CopyOrder
  2334                                  AllocPatterns:  
  2335                                  		; Erdogan Tan (13/02/2017)
  2336 00000688 30E4                    		xor	ah, ah
  2337 0000068A FEC0                    		inc	al
  2338                                  		; al = count of 1024 bytes
  2339 0000068C 89C3                    		mov	bx, ax
  2340                                  		; count of paragraphs = al*64 
  2341 0000068E C1E006                  		shl	ax, 6 ; *64
  2342 00000691 89C5                    		mov	bp, ax
  2343 00000693 8CCA                    		mov	dx, cs ; current (code) segment
  2344 00000695 81C20010                		add	dx, 1000h ; next 64K (4096*16)
  2345                                  		;
  2346 00000699 C706[348E]0000          		mov	word [ModInfo.Patterns], 0
  2347 0000069F 8916[368E]              		mov	[ModInfo.Patterns+2], dx
  2348                                  		;
  2349 000006A3 01D5                    		add	bp, dx ; next segment for samples
  2350                                  ReadPatterns:   
  2351 000006A5 1E                      		push    ds
  2352 000006A6 B8003F                  		mov     ax, 3F00h
  2353 000006A9 89D9                    		mov     cx, bx ; count of 1024 bytes
  2354 000006AB C1E10A                  		shl     cx, 10 ; byte count (cx*1024)
  2355 000006AE 8B1E[7089]              		mov     bx, [FileHandle]
  2356                                  		;lds    dx, [ModInfo.Patterns]
  2357 000006B2 8EDA                    		mov	ds, dx
  2358 000006B4 31D2                    		xor	dx, dx
  2359 000006B6 CD21                    		int     21h
  2360 000006B8 1F                      		pop     ds
  2361 000006B9 7275                    		jc      CloseFile
  2362                                  
  2363                                  		;lea	si, [Header+ModHeader.mhSamples]
  2364 000006BB BE[8889]                		mov	si, Header+ModHeader.mhSamples
  2365 000006BE 31FF                    		xor     di, di
  2366                                  CopySamples:
  2367 000006C0 8B4416                  		mov     ax, [si+ModSample.msLength]
  2368 000006C3 86C4                    		xchg    al, ah
  2369 000006C5 D1E0                    		shl     ax, 1
  2370 000006C7 8985[B48E]              		mov     [ModInfo.SampLen+di], ax
  2371 000006CB 8A4419                  		mov     al, [si+ModSample.msVolume]
  2372 000006CE 30E4                    		xor     ah, ah
  2373 000006D0 8985[6E8F]              		mov     [ModInfo.SampVol+di], ax
  2374 000006D4 8B441A                  		mov     ax, [si+ModSample.msRepeat]
  2375 000006D7 86C4                    		xchg    al, ah
  2376 000006D9 D1E0                    		shl     ax, 1
  2377 000006DB 8985[F28E]              		mov     [ModInfo.SampRep+di], ax
  2378 000006DF 8B441C                  		mov     ax, [si+ModSample.msRepLen]
  2379 000006E2 86C4                    		xchg    al, ah
  2380 000006E4 D1E0                    		shl     ax, 1
  2381 000006E6 8985[308F]              		mov     [ModInfo.SampRepLen+di], ax
  2382 000006EA 83C61E                  		add     si, ModSample.size
  2383 000006ED 83C702                  		add     di, 2
  2384 000006F0 83FF3E                  		cmp     di, 2*31
  2385 000006F3 72CB                    		jb      short CopySamples
  2386                                  
  2387 000006F5 31F6                    		xor     si, si
  2388                                  AllocSamples:
  2389                                  		; Erdogan Tan (13/02/2017)
  2390                                  		;mov	bx, [ModInfo.SampLen+si]
  2391 000006F7 8B8C[B48E]              		mov	cx, [ModInfo.SampLen+si]
  2392 000006FB 89CB                    		mov	bx, cx
  2393 000006FD C1EB04                  		shr     bx, 4 ; byte count / 16
  2394 00000700 7420                    		jz      short NextSample
  2395 00000702 43                      		inc	bx ; number of paragraphs
  2396 00000703 C784[388E]0000          		mov	word [ModInfo.SampOfs+si], 0
  2397 00000709 89AC[768E]              		mov     [ModInfo.SampSeg+si], bp
  2398 0000070D 89EA                    		mov	dx, bp
  2399 0000070F 01DD                    		add	bp, bx ; next segment for sample 
  2400                                  ReadSample:
  2401 00000711 1E                      		push    ds
  2402 00000712 B8003F                  		mov     ax, 3F00h
  2403 00000715 8B1E[7089]              		mov     bx, [FileHandle]
  2404                                  		;mov    cx, [ModInfo.SampLen+si]
  2405                                  		;mov    dx, [ModInfo.SampOfs+si]
  2406                                  		;mov    ds, [ModInfo.SampSeg+si]
  2407 00000719 8EDA                    		mov	ds, dx
  2408 0000071B 31D2                    		xor	dx, dx	
  2409 0000071D CD21                    		int     21h
  2410 0000071F 1F                      		pop     ds
  2411 00000720 720E                    		jc      short CloseFile
  2412                                  NextSample:
  2413 00000722 83C602                  		add     si, 2
  2414 00000725 83FE3E                  		cmp     si, 2*31
  2415 00000728 72CD                    		jb      short AllocSamples
  2416                                  
  2417 0000072A C706[7289]0000          		mov     word [ErrorInfo], 0
  2418                                  CloseFile:      
  2419 00000730 B8003E                  		mov     ax, 3E00h
  2420 00000733 8B1E[7089]              		mov     bx, [FileHandle]
  2421 00000737 CD21                    		int     21h
  2422                                  Failed:         
  2423 00000739 07                      		pop     es
  2424 0000073A 1F                      		pop     ds
  2425 0000073B 61                      		popa
  2426 0000073C 5D                      		pop     bp
  2427 0000073D C20400                  		ret	4
  2428                                  
  2429                                  FreeModule:
  2430                                  		; Erdogan Tan (13/02/2017)
  2431                                  		; nothing to do here for memory de-allocation
  2432                                  ClearModInfo:
  2433 00000740 60                      		pusha
  2434 00000741 06                      		push    es
  2435 00000742 8CD8                    		mov     ax, ds
  2436 00000744 8EC0                    		mov     es, ax
  2437                                  		;lea    di, [ModInfo]
  2438 00000746 BF[B28D]                		mov	di, ModInfo
  2439 00000749 B9FA01                  		mov     cx, ModInfoRec.size
  2440 0000074C FC                      		cld
  2441 0000074D 31C0                    		xor     ax, ax
  2442 0000074F F3AA                    		rep     stosb
  2443 00000751 07                      		pop     es
  2444 00000752 61                      		popa
  2445 00000753 C3                      		retn
  2446                                  
  2447                                  ;=============================================================================
  2448                                  ;               MODPLAY.ASM
  2449                                  ;=============================================================================
  2450                                  
  2451                                  ; Amiga Module Player v0.3b by Carlos Hasan.
  2452                                  ;		July 23th, 1993.
  2453                                  
  2454                                  ; EQUATES
  2455                                  
  2456                                  NumTracks       equ 4
  2457                                  DefTempo        equ 6
  2458                                  DefBpm          equ 125
  2459                                  MidCRate        equ 8448
  2460                                  MixBufSize      equ 4096
  2461                                  
  2462                                  ; STRUCTURES
  2463                                  
  2464                                  struc TrackInfo
  2465 00000000 ????????                .Samples:	resd 1
  2466 00000004 ????                    .Position:	resw 1
  2467 00000006 ????                    .Len:		resw 1
  2468 00000008 ????                    .Repeat:	resw 1
  2469 0000000A ????                    .RepLen:	resw 1
  2470 0000000C ??                      .Volume: 	resb 1
  2471 0000000D ??                      .Error:		resb 1
  2472 0000000E ????                    .Period:	resw 1
  2473 00000010 ????                    .Pitch:		resw 1
  2474 00000012 ????                    .Effect:	resw 1
  2475 00000014 ????                    .PortTo:	resw 1
  2476 00000016 ??                      .PortParm:	resb 1
  2477 00000017 ??                      .VibPos:	resb 1
  2478 00000018 ??                      .VibParm:	resb 1
  2479 00000019 ??                      .OldSampOfs:	resb 1
  2480 0000001A ????????????            .Arp:		resw 3
  2481 00000020 ????                    .ArpIndex:	resw 1
  2482                                  .size:
  2483                                  endstruc
  2484                                  
  2485                                  ; CODE
  2486                                  
  2487                                  ;--------------------------------------------------------------------------
  2488                                  ; BeatTrack:  Process the next beat in one track.
  2489                                  ;  In:
  2490                                  ;    ds:di -  Track info Address.
  2491                                  ;--------------------------------------------------------------------------
  2492                                  
  2493                                  BeatTrack:
  2494 00000754 8B5512                  		mov     dx, [di+TrackInfo.Effect]
  2495 00000757 85D2                    		test    dx, dx
  2496 00000759 7430                    		je      short None
  2497 0000075B 80FE00                  		cmp     dh, 00h
  2498 0000075E 742C                    		je      short Arpeggio
  2499 00000760 80FE01                  		cmp     dh, 01h
  2500 00000763 743E                    		je      short PortUp
  2501 00000765 80FE02                  		cmp     dh, 02h
  2502 00000768 7455                    		je      short PortDown
  2503 0000076A 80FE03                  		cmp     dh, 03h
  2504 0000076D 746D                    		je      short TonePort
  2505 0000076F 80FE04                  		cmp     dh, 04h
  2506 00000772 0F849100                		je      Vibrato
  2507 00000776 80FE05                  		cmp     dh, 05h
  2508 00000779 0F84D600                		je      PortSlide
  2509 0000077D 80FE06                  		cmp     dh, 06h
  2510 00000780 0F84D700                		je      VibSlide
  2511 00000784 80FE0A                  		cmp     dh, 0Ah
  2512 00000787 0F84D800                		je      VolSlide
  2513                                  None:           
  2514 0000078B C3                      		retn
  2515                                  Arpeggio:
  2516 0000078C 8B5D20                  		mov     bx, [di+TrackInfo.ArpIndex]
  2517 0000078F 8B411A                  		mov     ax, [di+TrackInfo.Arp+bx]
  2518 00000792 894510                  		mov     [di+TrackInfo.Pitch], ax
  2519 00000795 83C302                  		add     bx, 2
  2520 00000798 83FB06                  		cmp     bx, 6
  2521 0000079B 7202                    		jb      short SetArpIndex
  2522 0000079D 31DB                    		xor     bx,bx
  2523                                  SetArpIndex:
  2524 0000079F 895D20                  		mov     [di+TrackInfo.ArpIndex], bx
  2525 000007A2 C3                      		retn
  2526                                  PortUp:
  2527 000007A3 30F6                    		xor     dh, dh
  2528 000007A5 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2529 000007A8 29D3                    		sub     bx, dx
  2530 000007AA 83FB71                  		cmp     bx, 113
  2531 000007AD 7D03                    		jge     short NotSmall
  2532 000007AF BB7100                  		mov     bx, 113
  2533                                  NotSmall:
  2534 000007B2 895D0E                  		mov     [di+TrackInfo.Period], bx
  2535 000007B5 01DB                    		add     bx, bx
  2536 000007B7 8B87[AC8F]              		mov     ax, [PitchTable+bx]
  2537 000007BB 894510                  		mov     [di+TrackInfo.Pitch], ax
  2538 000007BE C3                      		retn
  2539                                  PortDown:
  2540 000007BF 30F6                    		xor     dh, dh
  2541 000007C1 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2542 000007C4 01D3                    		add     bx, dx
  2543 000007C6 81FB5803                		cmp     bx, 856
  2544 000007CA 7E03                    		jle     short NotBig
  2545 000007CC BB5803                  		mov     bx, 856
  2546 000007CF 895D0E                  NotBig:         mov     [di+TrackInfo.Period], bx
  2547 000007D2 01DB                    		add     bx, bx
  2548 000007D4 8B87[AC8F]              		mov     ax, [PitchTable+bx]
  2549 000007D8 894510                  		mov     [di+TrackInfo.Pitch], ax
  2550 000007DB C3                      		retn
  2551                                  TonePort:
  2552 000007DC 30F6                    		xor     dh, dh
  2553 000007DE 8B4514                  		mov     ax, [di+TrackInfo.PortTo]
  2554 000007E1 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2555 000007E4 39C3                    		cmp     bx, ax
  2556 000007E6 741E                    		je      short NoPort
  2557 000007E8 7F0A                    		jg      short PortToUp
  2558                                  PortToDown:     
  2559 000007EA 01D3                    		add     bx, dx
  2560 000007EC 39C3                    		cmp     bx, ax
  2561 000007EE 7E0A                    		jle     short SetPort
  2562                                  FixPort:        
  2563 000007F0 89C3                    		mov     bx, ax
  2564 000007F2 EB06                    		jmp     short SetPort
  2565                                  PortToUp:
  2566 000007F4 29D3                    		sub     bx, dx
  2567 000007F6 39C3                    		cmp     bx, ax
  2568 000007F8 7CF6                    		jl      short FixPort
  2569                                  SetPort:        
  2570 000007FA 895D0E                  		mov     [di+TrackInfo.Period], bx
  2571 000007FD 01DB                    		add     bx, bx
  2572 000007FF 8B87[AC8F]              		mov     ax, [PitchTable+bx]
  2573 00000803 894510                  		mov     [di+TrackInfo.Pitch], ax
  2574                                  NoPort:         
  2575 00000806 C3                      		retn
  2576                                  Vibrato:
  2577 00000807 88D6                    		mov     dh, dl
  2578 00000809 80E20F                  		and     dl, 0Fh
  2579 0000080C C0EE04                  		shr     dh, 4
  2580 0000080F C0E602                  		shl     dh, 2
  2581 00000812 007517                  		add     [di+TrackInfo.VibPos], dh
  2582 00000815 8A7517                  		mov     dh, [di+TrackInfo.VibPos]
  2583 00000818 88F3                    		mov     bl, dh
  2584 0000081A C0EB02                  		shr     bl, 2
  2585 0000081D 83E31F                  		and     bx, 1Fh
  2586 00000820 8A87[CE0E]              		mov     al, [SinTable+bx]
  2587 00000824 F6E2                    		mul     dl
  2588 00000826 D1C0                    		rol     ax, 1
  2589 00000828 86C4                    		xchg    al, ah
  2590 0000082A 80E401                  		and     ah, 1
  2591 0000082D 84F6                    		test    dh, dh
  2592 0000082F 7902                    		jns     short VibUp
  2593 00000831 F7D8                    		neg     ax
  2594                                  VibUp:          
  2595 00000833 03450E                  		add     ax, [di+TrackInfo.Period]
  2596 00000836 89C3                    		mov     bx, ax
  2597 00000838 83FB71                  		cmp     bx, 113
  2598 0000083B 7D03                    		jge     short NoLoVib
  2599 0000083D BB7100                  		mov     bx, 113
  2600                                  NoLoVib:        
  2601 00000840 81FB5803                		cmp     bx, 856
  2602 00000844 7E03                    		jle     short NoHiVib
  2603 00000846 BB5803                  		mov     bx, 856
  2604                                  NoHiVib:        
  2605 00000849 01DB                    		add     bx, bx
  2606 0000084B 8B87[AC8F]              		mov     ax, [PitchTable+bx]
  2607 0000084F 894510                  		mov     [di+TrackInfo.Pitch], ax
  2608 00000852 C3                      		retn
  2609                                  PortSlide:
  2610 00000853 E80D00                  		call    VolSlide
  2611 00000856 8A5516                  		mov     dl, [di+TrackInfo.PortParm]
  2612 00000859 EB81                    		jmp     short TonePort
  2613                                  VibSlide:
  2614 0000085B E80500                  		call    VolSlide
  2615 0000085E 8A5518                  		mov     dl, [di+TrackInfo.VibParm]
  2616 00000861 EBA4                    		jmp     short Vibrato
  2617                                  VolSlide:
  2618 00000863 88D6                    		mov     dh, dl
  2619 00000865 80E20F                  		and     dl, 0Fh
  2620 00000868 C0EE04                  		shr     dh, 4
  2621 0000086B 8A450C                  		mov     al, [di+TrackInfo.Volume]
  2622 0000086E 28D0                    		sub     al, dl
  2623 00000870 7D02                    		jge     short NoLoVol
  2624 00000872 30C0                    		xor     al, al
  2625                                  NoLoVol:        
  2626 00000874 00F0                    		add     al, dh
  2627 00000876 3C40                    		cmp     al, 64
  2628 00000878 7602                    		jbe     short NoHiVol
  2629 0000087A B040                    		mov     al, 64
  2630                                  NoHiVol:        
  2631 0000087C 88450C                  		mov     [di+TrackInfo.Volume], al
  2632 0000087F C3                      		retn
  2633                                  
  2634                                  ;--------------------------------------------------------------------------
  2635                                  ; GetTrack:   Get the next Note from a pattern.
  2636                                  ;  In:
  2637                                  ;    ds:di -  Track info Address.
  2638                                  ;    es:si -  Pattern Note Address.
  2639                                  ; Out:
  2640                                  ;    es:si -  The Next Pattern Note address.
  2641                                  ;--------------------------------------------------------------------------
  2642                                  
  2643                                  GetTrack:
  2644 00000880 26AD                    		es lodsw
  2645 00000882 86C4                    		xchg    al, ah
  2646 00000884 88E3                    		mov     bl, ah
  2647 00000886 80E40F                  		and     ah, 0Fh
  2648 00000889 89C1                    		mov     cx, ax
  2649 0000088B 26AD                    		es lodsw
  2650 0000088D 86C4                    		xchg    al, ah
  2651 0000088F 88E7                    		mov     bh, ah
  2652 00000891 80E40F                  		and     ah, 0Fh
  2653 00000894 89C2                    		mov     dx, ax
  2654 00000896 895512                  		mov     [di+TrackInfo.Effect], dx
  2655 00000899 80E3F0                  		and     bl, 0F0h
  2656 0000089C C0EF04                  		shr     bh, 4
  2657 0000089F 08FB                    		or      bl, bh
  2658 000008A1 742E                    		je      short SetPeriod
  2659                                  SetSample:
  2660 000008A3 30FF                    		xor     bh, bh
  2661 000008A5 4B                      		dec     bx
  2662 000008A6 01DB                    		add     bx, bx
  2663 000008A8 8B87[6E8F]              		mov     ax, [ModInfo.SampVol+bx]
  2664 000008AC 88450C                  		mov     [di+TrackInfo.Volume], al
  2665 000008AF 8B87[388E]              		mov     ax, [ModInfo.SampOfs+bx]
  2666 000008B3 8905                    		mov     [di+TrackInfo.Samples], ax
  2667 000008B5 8B87[768E]              		mov     ax, [ModInfo.SampSeg+bx]
  2668 000008B9 894502                  		mov     [di+TrackInfo.Samples+2], ax
  2669 000008BC 8B87[B48E]              		mov     ax, [ModInfo.SampLen+bx]
  2670 000008C0 894506                  		mov     [di+TrackInfo.Len], ax
  2671 000008C3 8B87[F28E]              		mov     ax, [ModInfo.SampRep+bx]
  2672 000008C7 894508                  		mov     [di+TrackInfo.Repeat], ax
  2673 000008CA 8B87[308F]              		mov     ax, [ModInfo.SampRepLen+bx]
  2674 000008CE 89450A                  		mov     [di+TrackInfo.RepLen], ax
  2675                                  SetPeriod:      
  2676 000008D1 85C9                    		test    cx, cx
  2677 000008D3 741B                    		je      short SetEffect
  2678                                  
  2679 000008D5 894D14                  		mov     [di+TrackInfo.PortTo], cx
  2680 000008D8 80FE03                  		cmp     dh, 03h
  2681 000008DB 7413                    		je      short SetEffect
  2682                                  
  2683 000008DD 894D0E                  		mov     [di+TrackInfo.Period], cx
  2684 000008E0 89CB                    		mov     bx, cx
  2685 000008E2 01DB                    		add     bx, bx
  2686 000008E4 8B87[AC8F]              		mov     ax, [PitchTable+bx]
  2687 000008E8 894510                  		mov     [di+TrackInfo.Pitch], ax
  2688 000008EB C745040000              		mov     word [di+TrackInfo.Position], 0
  2689                                  SetEffect:
  2690 000008F0 85D2                    		test    dx, dx
  2691 000008F2 742A                    		je      short InitNone
  2692 000008F4 80FE00                  		cmp     dh, 00h
  2693 000008F7 0F84C400                		je      InitArpeggio
  2694 000008FB 80FE03                  		cmp     dh, 03h
  2695 000008FE 741F                    		je      short InitTonePort
  2696 00000900 80FE04                  		cmp     dh, 04h
  2697 00000903 7428                    		je      short InitVibrato
  2698 00000905 80FE09                  		cmp     dh, 09h
  2699 00000908 744A                    		je      short SampleOfs
  2700 0000090A 80FE0B                  		cmp     dh, 0Bh
  2701 0000090D 7457                    		je      short PosJump
  2702 0000090F 80FE0C                  		cmp     dh, 0Ch
  2703 00000912 745C                    		je      short SetVolume
  2704 00000914 80FE0D                  		cmp     dh, 0Dh
  2705 00000917 7462                    		je      short Break
  2706 00000919 80FE0F                  		cmp     dh, 0Fh
  2707 0000091C 7478                    		je      short SetSpeed
  2708                                  InitNone:
  2709 0000091E C3                      		retn
  2710                                  InitTonePort:
  2711 0000091F 84D2                    		test    dl, dl
  2712 00000921 7503                    		jne     short SetPortParm
  2713 00000923 8A5516                  		mov     dl, [di+TrackInfo.PortParm]
  2714                                  SetPortParm:    
  2715 00000926 885516                  		mov     [di+TrackInfo.PortParm], dl
  2716 00000929 895512                  		mov     [di+TrackInfo.Effect], dx
  2717 0000092C C3                      		retn
  2718                                  InitVibrato:
  2719 0000092D 8A4518                  		mov     al, [di+TrackInfo.VibParm]
  2720 00000930 88C4                    		mov     ah, al
  2721 00000932 240F                    		and     al, 0Fh
  2722 00000934 80E4F0                  		and     ah, 0F0h
  2723 00000937 F6C20F                  		test    dl, 0Fh
  2724 0000093A 7502                    		jne     short OkDepth
  2725 0000093C 08C2                    		or      dl, al
  2726                                  OkDepth:        
  2727 0000093E F6C2F0                  		test    dl, 0F0h
  2728 00000941 7502                    		jne     short OkRate
  2729 00000943 08E2                    		or      dl, ah
  2730                                  OkRate:         
  2731 00000945 885518                  		mov     [di+TrackInfo.VibParm], dl
  2732 00000948 895512                  		mov     [di+TrackInfo.Effect], dx
  2733 0000094B 85C9                    		test    cx, cx
  2734 0000094D 7404                    		je      short OkPos
  2735 0000094F C6451700                		mov     byte [di+TrackInfo.VibPos], 0
  2736                                  OkPos:          
  2737 00000953 C3                      		retn
  2738                                  SampleOfs:      
  2739 00000954 84D2                    		test    dl, dl
  2740 00000956 7503                    		jne     short SetSampleOfs
  2741 00000958 8A5519                  		mov     dl, [di+TrackInfo.OldSampOfs]
  2742                                  SetSampleOfs:
  2743 0000095B 885519                  		mov     [di+TrackInfo.OldSampOfs], dl
  2744 0000095E 88D6                    		mov     dh, dl
  2745 00000960 30D2                    		xor     dl, dl
  2746 00000962 895504                  		mov     [di+TrackInfo.Position], dx
  2747 00000965 C3                      		retn
  2748                                  PosJump:
  2749 00000966 8816[5EE7]              		mov     [OrderPos], dl
  2750 0000096A C606[62E7]40            		mov     byte [Row], 64
  2751 0000096F C3                      		retn
  2752                                  SetVolume:
  2753 00000970 80FA40                  		cmp     dl, 64
  2754 00000973 7602                    		jbe     short OkVol
  2755 00000975 B240                    		mov     dl, 64
  2756                                  OkVol:
  2757 00000977 88550C                  		mov     [di+TrackInfo.Volume], dl
  2758 0000097A C3                      		retn
  2759                                  Break:
  2760 0000097B 88D6                    		mov     dh, dl
  2761 0000097D 80E20F                  		and     dl, 0Fh
  2762 00000980 C0EE04                  		shr     dh, 4
  2763 00000983 00F6                    		add     dh, dh
  2764 00000985 00F2                    		add     dl, dh
  2765 00000987 C0E602                  		shl     dh, 2
  2766 0000098A 00F2                    		add     dl, dh
  2767 0000098C 8816[63E7]              		mov     [BreakRow], dl
  2768 00000990 C606[62E7]40            		mov     byte [Row], 64
  2769 00000995 C3                      		retn
  2770                                  SetSpeed:
  2771 00000996 84D2                    		test    dl,dl
  2772 00000998 7424                    		je      Skip
  2773 0000099A 80FA1F                  		cmp     dl,31
  2774 0000099D 7709                    		ja      short SetBpm
  2775                                  SetTempo:       
  2776 0000099F 8816[5FE7]              		mov     [Tempo], dl
  2777 000009A3 8816[60E7]              		mov     [TempoWait], dl
  2778 000009A7 C3                      		retn
  2779                                  SetBpm:
  2780 000009A8 8816[61E7]              		mov     [Bpm], dl
  2781 000009AC B067                    		mov     al, 103
  2782 000009AE F6E2                    		mul     dl
  2783 000009B0 88E3                    		mov     bl, ah
  2784 000009B2 30FF                    		xor     bh, bh
  2785 000009B4 A1[B08D]                		mov     ax, [MixSpeed]
  2786 000009B7 31D2                    		xor     dx, dx
  2787 000009B9 F7F3                    		div     bx
  2788 000009BB A3[64E7]                		mov     [BpmSamples], ax
  2789                                  Skip:           
  2790 000009BE C3                      		retn
  2791                                  InitArpeggio:
  2792 000009BF 88D6                    		mov     dh, dl
  2793 000009C1 80E20F                  		and     dl, 0Fh
  2794 000009C4 C0EE04                  		shr     dh, 4
  2795 000009C7 B92400                  		mov     cx, 36
  2796 000009CA 31DB                    		xor     bx, bx
  2797 000009CC 8B450E                  		mov     ax, [di+TrackInfo.Period]
  2798                                  gt_ScanPeriod:
  2799 000009CF 3B87[EE0E]              		cmp     ax, [PeriodTable+bx]
  2800 000009D3 7305                    		jae     short SetArp
  2801 000009D5 83C302                  		add     bx, 2
  2802 000009D8 E2F5                    		loop    gt_ScanPeriod
  2803                                  SetArp:         
  2804 000009DA 01D2                    		add     dx, dx
  2805 000009DC 00DE                    		add     dh, bl
  2806 000009DE 00DA                    		add     dl, bl
  2807 000009E0 8B9F[EE0E]              		mov     bx, [PeriodTable+bx]
  2808 000009E4 01DB                    		add     bx, bx
  2809 000009E6 8B87[AC8F]              		mov     ax, [PitchTable+bx]
  2810 000009EA 89451A                  		mov     [di+TrackInfo.Arp], ax
  2811 000009ED 88F3                    		mov     bl, dh
  2812 000009EF 30FF                    		xor     bh, bh
  2813 000009F1 8B9F[EE0E]              		mov     bx, [PeriodTable+bx]
  2814 000009F5 01DB                    		add     bx, bx
  2815 000009F7 8B87[AC8F]              		mov     ax, [PitchTable+bx]
  2816 000009FB 89451C                  		mov     [di+TrackInfo.Arp+2], ax
  2817 000009FE 88D3                    		mov     bl, dl
  2818 00000A00 30FF                    		xor     bh, bh
  2819 00000A02 8B9F[EE0E]              		mov     bx, [PeriodTable+bx]
  2820 00000A06 01DB                    		add     bx, bx
  2821 00000A08 8B87[AC8F]              		mov     ax, [PitchTable+bx]
  2822 00000A0C 89451E                  		mov     [di+TrackInfo.Arp+4], ax
  2823 00000A0F C745200000              		mov     word [di+TrackInfo.ArpIndex], 0
  2824 00000A14 C3                      		retn
  2825                                  
  2826                                  ;--------------------------------------------------------------------------
  2827                                  ; UpdateTracks:  Main code to process the next tick to be played.
  2828                                  ;--------------------------------------------------------------------------
  2829                                  
  2830                                  UpdateTracks:
  2831 00000A15 FE0E[60E7]              		dec     byte [TempoWait]
  2832 00000A19 740F                    		jz      short GetTracks
  2833                                  
  2834 00000A1B B90400                  		mov	cx, NumTracks
  2835 00000A1E BF[70E7]                		mov	di, Tracks
  2836                                  BeatTracks:
  2837 00000A21 E830FD                  		call	BeatTrack	
  2838 00000A24 83C722                  		add	di, TrackInfo.size
  2839 00000A27 E2F8                    		loop	BeatTracks
  2840 00000A29 C3                      		retn
  2841                                  GetTracks:
  2842 00000A2A A0[5FE7]                		mov     al, [Tempo]
  2843 00000A2D A2[60E7]                		mov     [TempoWait], al
  2844                                  
  2845 00000A30 C436[6CE7]              		les     si, [Note]
  2846 00000A34 803E[62E7]40            		cmp     byte [Row], 64
  2847 00000A39 7246                    		jb      short NoPattWrap
  2848                                  
  2849 00000A3B C436[348E]              		les     si, [ModInfo.Patterns]
  2850 00000A3F 8A1E[5EE7]              		mov     bl, [OrderPos]
  2851 00000A43 3A1E[B28D]              		cmp     bl, [ModInfo.OrderLen]
  2852 00000A47 720E                    		jb      short NoOrderWrap
  2853 00000A49 8A1E[B38D]              		mov     bl, [ModInfo.ReStart]
  2854 00000A4D 881E[5EE7]              		mov     [OrderPos], bl
  2855 00000A51 3A1E[B28D]              		cmp     bl, [ModInfo.OrderLen]
  2856 00000A55 7343                    		jae     short NoUpdate
  2857                                  NoOrderWrap:    
  2858 00000A57 30FF                    		xor     bh, bh
  2859 00000A59 8A9F[B48D]              		mov     bl, [ModInfo.Order+bx]
  2860 00000A5D C1E30A                  		shl     bx, 10
  2861 00000A60 01DE                    		add     si, bx
  2862 00000A62 8A1E[63E7]              		mov     bl, [BreakRow]
  2863 00000A66 881E[62E7]              		mov     [Row], bl
  2864 00000A6A 30FF                    		xor     bh, bh
  2865 00000A6C 883E[63E7]              		mov     [BreakRow], bh
  2866 00000A70 C1E304                  		shl     bx, 4
  2867 00000A73 01DE                    		add     si, bx
  2868 00000A75 8936[6CE7]              		mov     [Note], si
  2869 00000A79 8C06[6EE7]              		mov     [Note+2], es
  2870 00000A7D FE06[5EE7]              		inc     byte [OrderPos]
  2871                                  NoPattWrap:     
  2872 00000A81 FE06[62E7]              		inc     byte [Row]
  2873                                  
  2874 00000A85 FC                      		cld
  2875 00000A86 B90400                  		mov	cx, NumTracks
  2876 00000A89 BF[70E7]                		mov	di, Tracks
  2877                                  GetTracks_next:
  2878 00000A8C 51                      		push	cx		
  2879 00000A8D E8F0FD                  		call	GetTrack
  2880 00000A90 59                      		pop	cx
  2881 00000A91 83C722                  		add	di, TrackInfo.size
  2882 00000A94 E2F6                    		loop	GetTracks_next
  2883                                  
  2884 00000A96 8936[6CE7]              		mov     [Note], si
  2885                                  NoUpdate:
  2886 00000A9A C3                      		retn
  2887                                  
  2888                                  ;--------------------------------------------------------------------------
  2889                                  ; MixTrack:  Mixes one track into a CLEAN buffer.
  2890                                  ;  In:
  2891                                  ;   ds:si -  Track Info Address.
  2892                                  ;   ds:di -  Buffer Address.
  2893                                  ;    cx   -  Buffer Size.
  2894                                  ;--------------------------------------------------------------------------
  2895                                  
  2896                                  MixTrack:
  2897 00000A9B 837C0A02                		cmp     word [si+TrackInfo.RepLen], 2
  2898 00000A9F 7742                    		ja      short MixLooped
  2899                                  MixNonLooped:   
  2900 00000AA1 C414                    		les     dx, [si+TrackInfo.Samples]
  2901 00000AA3 8B5C04                  		mov     bx, [si+TrackInfo.Position]
  2902 00000AA6 8B6C06                  		mov     bp, [si+TrackInfo.Len]
  2903 00000AA9 52                      		push    dx
  2904 00000AAA 56                      		push    si
  2905 00000AAB 01D3                    		add     bx, dx
  2906 00000AAD 01D5                    		add     bp, dx
  2907 00000AAF 8B5410                  		mov     dx, [si+TrackInfo.Pitch]
  2908 00000AB2 8A440C                  		mov     al, [si+TrackInfo.Volume]
  2909 00000AB5 8A640D                  		mov     ah, [si+TrackInfo.Error]
  2910 00000AB8 89DE                    		mov     si, bx
  2911 00000ABA 88C7                    		mov     bh, al
  2912 00000ABC 88D0                    		mov     al, dl
  2913 00000ABE 88F2                    		mov     dl, dh
  2914 00000AC0 30F6                    		xor     dh, dh
  2915                                  nlMixSamp:      
  2916 00000AC2 39EE                    		cmp     si, bp
  2917 00000AC4 7310                    		jae     short nlMixBye
  2918 00000AC6 268A1C                  		mov     bl, [es:si]
  2919 00000AC9 8A9F[5E96]              		mov     bl, [VolTable+bx]
  2920 00000ACD 001D                    		add     [di], bl
  2921 00000ACF 47                      		inc     di
  2922 00000AD0 00C4                    		add     ah, al
  2923 00000AD2 11D6                    		adc     si, dx
  2924 00000AD4 E2EC                    		loop    nlMixSamp
  2925                                  nlMixBye:       
  2926 00000AD6 89F3                    		mov     bx, si
  2927 00000AD8 5E                      		pop     si
  2928 00000AD9 5A                      		pop     dx
  2929 00000ADA 29D3                    		sub     bx, dx
  2930 00000ADC 895C04                  		mov     [si+TrackInfo.Position], bx
  2931 00000ADF 88640D                  		mov     [si+TrackInfo.Error], ah
  2932 00000AE2 C3                      		retn
  2933                                  MixLooped:
  2934 00000AE3 C414                    		les     dx, [si+TrackInfo.Samples]
  2935 00000AE5 8B5C04                  		mov     bx, [si+TrackInfo.Position]
  2936 00000AE8 8B6C0A                  		mov     bp, [si+TrackInfo.RepLen]
  2937 00000AEB 892E[6AE7]              		mov     [BufRep], bp
  2938 00000AEF 036C08                  		add     bp, [si+TrackInfo.Repeat]
  2939 00000AF2 52                      		push    dx
  2940 00000AF3 56                      		push    si
  2941 00000AF4 01D3                    		add     bx, dx
  2942 00000AF6 01D5                    		add     bp, dx
  2943 00000AF8 8B5410                  		mov     dx, [si+TrackInfo.Pitch]
  2944 00000AFB 8A440C                  		mov     al, [si+TrackInfo.Volume]
  2945 00000AFE 8A640D                  		mov     ah, [si+TrackInfo.Error]
  2946 00000B01 89DE                    		mov     si, bx
  2947 00000B03 88C7                    		mov     bh, al
  2948 00000B05 88D0                    		mov     al, dl
  2949 00000B07 88F2                    		mov     dl, dh
  2950 00000B09 30F6                    		xor     dh, dh
  2951                                  lpMixSamp:      
  2952 00000B0B 39EE                    		cmp     si, bp
  2953 00000B0D 7204                    		jb      short lpMixNow
  2954 00000B0F 2B36[6AE7]              		sub     si, [BufRep]
  2955                                  lpMixNow:       
  2956 00000B13 268A1C                  		mov     bl, [es:si]
  2957 00000B16 8A9F[5E96]              		mov     bl, [VolTable+bx]
  2958 00000B1A 001D                    		add     [di], bl
  2959 00000B1C 47                      		inc     di
  2960 00000B1D 00C4                    		add     ah, al
  2961 00000B1F 11D6                    		adc     si, dx
  2962 00000B21 E2E8                    		loop    lpMixSamp
  2963                                  lpMixBye:       
  2964 00000B23 89F3                    		mov     bx, si
  2965 00000B25 5E                      		pop     si
  2966 00000B26 5A                      		pop     dx
  2967 00000B27 29D3                    		sub     bx, dx
  2968 00000B29 895C04                  		mov     [si+TrackInfo.Position], bx
  2969 00000B2C 88640D                  		mov     [si+TrackInfo.Error], ah
  2970 00000B2F C3                      		retn
  2971                                  
  2972                                  GetSamples_ICH:
  2973                                  		; 11/05/2024
  2974                                  		; 18/02/2017
  2975                                  		; 8 bit mono samples 
  2976                                  		; must be converted to 16 bit, stereo samples (for ICH) !
  2977                                  		; (ICH AC97 Modification by Erdogan Tan)
  2978 00000B30 8936[80EC]              		mov	[_si_], si ; DMA Buff Addr, [DMA_BUFFER1] or [DMA_BUFFER2]
  2979                                  		; 11/05/2024
  2980                                  		;mov	si, MOD_BUFFER
  2981                                  		;shr	cx, 2 ; mod buffer size = dma (half) buffer size / 4 (*)
  2982                                  
  2983                                  ;--------------------------------------------------------------------------
  2984                                  ; GetSamples:  Returns the next chunk of samples to be played.
  2985                                  ;  In:
  2986                                  ;    Buffer  - Buffer Address.
  2987                                  ;    Count   - Buffer Size.
  2988                                  ;--------------------------------------------------------------------------
  2989                                  
  2990                                  GetSamples:
  2991                                  		;ds:si = buffer address
  2992                                  		;cx = count
  2993                                  
  2994                                  		; 11/05/2024
  2995                                  		;
  2996                                  		;;[sp+6] = ds
  2997                                  		;;[sp+4] = si
  2998                                  		;;[sp+2] = count
  2999                                  		;
  3000                                  		;Count	equ 4
  3001                                  		;Buffer	equ 6 
  3002                                  		;
  3003                                  		;push	bp
  3004                                  		;mov	bp, sp
  3005                                  		;
  3006                                  		;push    es
  3007                                  		;;;push  ds
  3008                                  		;;;pusha
  3009                                  		;
  3010                                  		;cld
  3011                                  		;
  3012                                  		;les	di, [bp+Buffer]
  3013                                  		;mov    bx, [bp+Count]
  3014                                  
  3015                                  		; 11/05/2024
  3016                                  		; ds = cs
  3017 00000B34 06                      		push	es ; +
  3018                                  
  3019 00000B35 1E                      		push	ds
  3020 00000B36 07                      		pop	es
  3021                                  
  3022                                  		; 11/05/2024
  3023 00000B37 BF[82EC]                		mov	di, MOD_BUFFER
  3024 00000B3A BB000F                  		mov	bx, (BUFFERSIZE/4) ; (*) ; 2048
  3025                                  NextChunk:
  3026 00000B3D 833E[68E7]00            		cmp     word [BufLen], 0
  3027 00000B42 7534                    		jne     short CopyChunk
  3028                                  
  3029                                  		; 11/05/2024
  3030 00000B44 06                      		push	es
  3031 00000B45 53                      		push	bx
  3032 00000B46 57                      		push	di
  3033                                  MixChunk:       
  3034                                  		;lea    di, [MixBuffer]
  3035 00000B47 BF[5ED7]                		mov	di, MixBuffer
  3036 00000B4A 8B0E[64E7]              		mov     cx, [BpmSamples]
  3037 00000B4E 893E[66E7]              		mov     [BufPtr], di
  3038 00000B52 890E[68E7]              		mov     [BufLen], cx
  3039                                  
  3040                                  		; 12/05/2024
  3041                                  		; es = ds
  3042                                  		;mov    ax, ds
  3043                                  		;mov    es, ax
  3044                                  
  3045 00000B56 B080                    		mov    al, 80h
  3046 00000B58 F3AA                    		rep    stosb
  3047                                  
  3048 00000B5A B90400                  		mov	cx, NumTracks
  3049 00000B5D BE[4EE7]                		mov	si, Tracks - TrackInfo.size
  3050                                  GetSamples_next:
  3051 00000B60 51                      		push	cx
  3052 00000B61 83C622                  		add	si, TrackInfo.size
  3053 00000B64 8B0E[68E7]              		mov	cx, [BufLen]
  3054 00000B68 8B3E[66E7]              		mov	di, [BufPtr]
  3055 00000B6C E82CFF                  		call	MixTrack
  3056 00000B6F 59                      		pop	cx
  3057 00000B70 E2EE                    		loop	GetSamples_next
  3058                                  
  3059 00000B72 E8A0FE                  		call    UpdateTracks
  3060                                  
  3061 00000B75 5F                      		pop	di
  3062 00000B76 5B                      		pop	bx
  3063 00000B77 07                      		pop	es ; es = ds ; 12/05/2024
  3064                                  CopyChunk:      
  3065 00000B78 8B0E[68E7]              		mov     cx, [BufLen]
  3066 00000B7C 39D9                    		cmp     cx, bx
  3067 00000B7E 7602                    		jbe     short MoveChunk
  3068 00000B80 89D9                    		mov     cx, bx
  3069                                  MoveChunk:
  3070 00000B82 8B36[66E7]              		mov     si, [BufPtr]
  3071 00000B86 010E[66E7]              		add     [BufPtr], cx
  3072 00000B8A 290E[68E7]              		sub     [BufLen], cx
  3073 00000B8E 29CB                    		sub     bx, cx
  3074 00000B90 F3A4                    		rep     movsb
  3075 00000B92 85DB                    		test    bx, bx
  3076 00000B94 75A7                    		jnz     short NextChunk
  3077                                  
  3078                                  		;;popa
  3079                                  		;;pop	ds
  3080                                  		;pop	es
  3081                                  		;pop	bp
  3082                                  		;ret	6
  3083                                  
  3084                                  ; GetSamples_ICH_convert_samples:
  3085                                  		; 11/05/2024
  3086                                  		; es = ds = cs
  3087                                  		; 18/02/2017
  3088                                  		;mov	di, ds
  3089                                  		;mov	es, di
  3090 00000B96 8B3E[80EC]              		mov	di, [_si_] ; DMA Buffer Address (16 bit, stereo)
  3091 00000B9A BE[81EC]                		mov	si, MOD_BUFFER - 1 ; buffer for 8 bit mono samples
  3092 00000B9D B9000F                  		mov	cx, (BUFFERSIZE/4) ; (*) ; 2048 ; 11/04/2024
  3093 00000BA0 30C0                    		xor	al, al
  3094                                  gscs_loop:		
  3095 00000BA2 46                      		inc	si
  3096 00000BA3 8A24                    		mov	ah, [si] ; convert 8 bit sample to 16 bit sample
  3097                                  		; 11/05/2024
  3098 00000BA5 80EC80                  		sub	ah, 80h
  3099                                  
  3100 00000BA8 AB                      		stosw	; left channel
  3101 00000BA9 AB                      		stosw	; right channel
  3102 00000BAA E2F6                    		loop	gscs_loop
  3103                                  
  3104                                  		; 11/05/2024
  3105 00000BAC 07                      		pop	es ; +
  3106                                  		;pop	bp
  3107                                  		;ret	6
  3108 00000BAD C3                      		retn
  3109                                  
  3110                                  ;--------------------------------------------------------------------------
  3111                                  ; StartPlaying: Initializes the Sound System.
  3112                                  ;  In:
  3113                                  ;   Module Information Resources.
  3114                                  ;--------------------------------------------------------------------------
  3115                                  
  3116                                  StartPlaying:
  3117 00000BAE 60                      		pusha
  3118 00000BAF 1E                      		push    ds
  3119 00000BB0 06                      		push    es
  3120                                  SetModParms:    
  3121 00000BB1 C606[5EE7]00            		mov     byte [OrderPos], 0
  3122 00000BB6 C606[5FE7]06            		mov     byte [Tempo], DefTempo
  3123 00000BBB C606[60E7]06            		mov     byte [TempoWait], DefTempo
  3124 00000BC0 C606[61E7]7D            		mov     byte [Bpm], DefBpm
  3125 00000BC5 C606[62E7]40            		mov     byte [Row], 64
  3126 00000BCA C606[63E7]00            		mov     byte [BreakRow], 0
  3127 00000BCF A1[B08D]                		mov     ax, [MixSpeed]
  3128 00000BD2 31D2                    		xor     dx, dx
  3129 00000BD4 BB3200                  		mov     bx, 24*DefBpm/60
  3130 00000BD7 F7F3                    		div     bx
  3131 00000BD9 A3[64E7]                		mov     [BpmSamples], ax
  3132                                  ClearTracks:    
  3133 00000BDC BF[70E7]                		mov     di, Tracks
  3134 00000BDF 8CD8                    		mov     ax, ds
  3135 00000BE1 8EC0                    		mov     es, ax
  3136 00000BE3 B98800                  		mov     cx, NumTracks*TrackInfo.size
  3137 00000BE6 31C0                    		xor     ax, ax
  3138 00000BE8 FC                      		cld
  3139 00000BE9 F3AA                    		rep     stosb
  3140                                  
  3141 00000BEB A3[66E7]                		mov     [BufPtr], ax
  3142 00000BEE A3[68E7]                		mov     [BufLen], ax
  3143                                  MakePitch:
  3144 00000BF1 B80021                  		mov     ax, MidCRate
  3145 00000BF4 BBAC01                  		mov     bx, 428
  3146 00000BF7 F7E3                    		mul     bx
  3147 00000BF9 F736[B08D]              		div     word [MixSpeed]
  3148 00000BFD 30F6                    		xor     dh, dh
  3149 00000BFF 88E2                    		mov     dl, ah
  3150 00000C01 88C4                    		mov     ah, al
  3151 00000C03 30C0                    		xor     al, al
  3152 00000C05 B95903                  		mov     cx, 857
  3153 00000C08 31DB                    		xor     bx, bx
  3154 00000C0A BF[AC8F]                		mov     di, PitchTable
  3155                                  PitchLoop:      
  3156 00000C0D 50                      		push    ax
  3157 00000C0E 52                      		push    dx
  3158 00000C0F 39DA                    		cmp     dx, bx
  3159 00000C11 7302                    		jae     short NoDiv
  3160 00000C13 F7F3                    		div     bx
  3161                                  NoDiv:          
  3162 00000C15 AB                      		stosw
  3163 00000C16 5A                      		pop     dx
  3164 00000C17 58                      		pop     ax
  3165 00000C18 43                      		inc     bx
  3166 00000C19 E2F2                    		loop    PitchLoop
  3167                                  MakeVolume:     
  3168 00000C1B B90041                  		mov     cx, 16640
  3169 00000C1E 89CB                    		mov     bx, cx
  3170                                  VolLoop:
  3171 00000C20 4B                      		dec     bx
  3172 00000C21 88D8                    		mov     al, bl
  3173 00000C23 F6EF                    		imul    bh
  3174 00000C25 88A7[5E96]              		mov     [VolTable+bx], ah
  3175 00000C29 E2F5                    		loop    VolLoop
  3176                                  
  3177 00000C2B 07                      		pop     es
  3178 00000C2C 1F                      		pop     ds
  3179 00000C2D 61                      		popa
  3180 00000C2E C3                      		retn	; 12/05/2024
  3181                                  
  3182                                  ;--------------------------------------------------------------------------
  3183                                  ; StopPlaying: ShutDown the Sound System.
  3184                                  ;--------------------------------------------------------------------------
  3185                                  
  3186                                  StopPlaying:
  3187                                  	; 08/05/2024
  3188                                  	; 04/11/2023
  3189                                  	; finished with song, stop everything
  3190 00000C2F E8CB01                  	call	ac97_stop
  3191                                  
  3192                                  	; 11/11/2023
  3193                                  irq_restore:	
  3194                                  	; restore previous interrupt vector and interrupt_status
  3195 00000C32 FA                      	cli
  3196 00000C33 E4A1                    	in	al, 0A1h ; irq 8-15
  3197 00000C35 A0[4D10]                	mov	al, [IRQ_status+1]
  3198 00000C38 E6A1                    	out	0A1h, al 
  3199 00000C3A E421                    	in	al, 021h ; irq 0-7
  3200 00000C3C A0[4C10]                	mov	al, [IRQ_status]
  3201 00000C3F E621                    	out	21h, al 
  3202                                  	; ...
  3203 00000C41 06                      	push	es
  3204 00000C42 31C0                    	xor	ax, ax
  3205 00000C44 8EC0                    	mov	es, ax
  3206 00000C46 A1[4E10]                	mov	ax, [IRQ_vector]
  3207 00000C49 268907                  	mov	[es:bx], ax
  3208 00000C4C A1[5010]                	mov	ax, [IRQ_vector+2]
  3209 00000C4F 26894702                	mov	[es:bx+2], ax
  3210 00000C53 07                      	pop	es
  3211                                  
  3212 00000C54 FB                      	sti
  3213                                  
  3214 00000C55 C3                      	retn
  3215                                  
  3216                                  ;=============================================================================
  3217                                  ;               PLAYER.ASM
  3218                                  ;=============================================================================
  3219                                  
  3220                                  ; UTILS.ASM
  3221                                  ;----------------------------------------------------------------------------
  3222                                  ;       delay1_4ms - Delay for 1/4 millisecond.
  3223                                  ;		    1mS = 1000us
  3224                                  ;       Entry:
  3225                                  ;         None
  3226                                  ;       Exit:
  3227                                  ;	  None
  3228                                  ;
  3229                                  ;       Modified:
  3230                                  ;         None
  3231                                  ;
  3232                                  PORTB			EQU	061h
  3233                                    REFRESH_STATUS	EQU	010h		; Refresh signal status
  3234                                  
  3235                                  delay1_4ms:
  3236 00000C56 50                              push    ax 
  3237 00000C57 51                              push    cx
  3238 00000C58 B91000                          mov     cx, 16			; close enough.
  3239 00000C5B E461                    	in	al,PORTB
  3240 00000C5D 2410                    	and	al,REFRESH_STATUS
  3241 00000C5F 88C4                    	mov	ah,al			; Start toggle state
  3242 00000C61 09C9                    	or	cx, cx
  3243 00000C63 7401                    	jz	short _d4ms1
  3244 00000C65 41                      	inc	cx			; Throwaway first toggle
  3245                                  _d4ms1:	
  3246 00000C66 E461                    	in	al,PORTB		; Read system control port
  3247 00000C68 2410                    	and	al,REFRESH_STATUS	; Refresh toggles 15.085 microseconds
  3248 00000C6A 38C4                    	cmp	ah,al
  3249 00000C6C 74F8                    	je	short _d4ms1		; Wait for state change
  3250                                  
  3251 00000C6E 88C4                    	mov	ah,al			; Update with new state
  3252 00000C70 49                      	dec	cx
  3253 00000C71 75F3                    	jnz	short _d4ms1
  3254                                  
  3255 00000C73 59                              pop     cx
  3256 00000C74 58                              pop     ax
  3257 00000C75 C3                              retn
  3258                                  
  3259                                  print_msg:
  3260                                  	; 13/11/2016 - Erdogan Tan 
  3261                                  	; esi = ASCIIZ text address
  3262                                  	;
  3263 00000C76 BB0700                  	mov	bx, 7h
  3264 00000C79 B40E                    	mov	ah, 0Eh 
  3265                                  pm_next_char:
  3266 00000C7B AC                      	lodsb
  3267 00000C7C 20C0                    	and	al, al
  3268 00000C7E 7404                    	jz	short pm_retn
  3269 00000C80 CD10                    	int	10h
  3270 00000C82 EBF7                    	jmp	short pm_next_char
  3271                                  pm_retn:
  3272 00000C84 C3                      	retn
  3273                                  
  3274                                  dword2str:
  3275                                  	; 13/11/2016 - Erdogan Tan 
  3276                                  	; eax = dword value
  3277                                  	;
  3278 00000C85 E84400                  	call	dwordtohex
  3279 00000C88 668916[3810]            	mov	[dword_str], edx
  3280 00000C8D 66A3[3C10]              	mov	[dword_str+4], eax
  3281 00000C91 BE[3810]                	mov	si, dword_str
  3282 00000C94 C3                      	retn
  3283                                  
  3284                                  	; trdos386.s (unix386.s) - 10/05/2015
  3285                                  	; Convert binary number to hexadecimal string
  3286                                  
  3287                                  bytetohex:
  3288                                  	; INPUT ->
  3289                                  	; 	AL = byte (binary number)
  3290                                  	; OUTPUT ->
  3291                                  	;	AX = hexadecimal string
  3292                                  	;
  3293 00000C95 53                      	push	bx
  3294 00000C96 30FF                    	xor	bh, bh
  3295 00000C98 88C3                    	mov	bl, al
  3296 00000C9A C0EB04                  	shr	bl, 4
  3297 00000C9D 8A9F[9A0F]              	mov	bl, [bx+hex_chars] 	 	
  3298 00000CA1 86D8                    	xchg	bl, al
  3299 00000CA3 80E30F                  	and	bl, 0Fh
  3300 00000CA6 8AA7[9A0F]              	mov	ah, [bx+hex_chars] 
  3301 00000CAA 5B                      	pop	bx	
  3302 00000CAB C3                      	retn
  3303                                  
  3304                                  wordtohex:
  3305                                  	; INPUT ->
  3306                                  	; 	AX = word (binary number)
  3307                                  	; OUTPUT ->
  3308                                  	;	EAX = hexadecimal string
  3309                                  	;
  3310 00000CAC 53                      	push	bx
  3311 00000CAD 30FF                    	xor	bh, bh
  3312 00000CAF 86E0                    	xchg	ah, al
  3313 00000CB1 50                      	push	ax
  3314 00000CB2 88E3                    	mov	bl, ah
  3315 00000CB4 C0EB04                  	shr	bl, 4
  3316 00000CB7 8A87[9A0F]              	mov	al, [bx+hex_chars] 	 	
  3317 00000CBB 88E3                    	mov	bl, ah
  3318 00000CBD 80E30F                  	and	bl, 0Fh
  3319 00000CC0 8AA7[9A0F]              	mov	ah, [bx+hex_chars]
  3320 00000CC4 66C1E010                	shl	eax, 16
  3321 00000CC8 58                      	pop	ax
  3322 00000CC9 5B                      	pop	bx
  3323 00000CCA EBC9                    	jmp	short bytetohex
  3324                                  
  3325                                  dwordtohex:
  3326                                  	; INPUT ->
  3327                                  	; 	EAX = dword (binary number)
  3328                                  	; OUTPUT ->
  3329                                  	;	EDX:EAX = hexadecimal string
  3330                                  	;
  3331 00000CCC 6650                    	push	eax
  3332 00000CCE 66C1E810                	shr	eax, 16
  3333 00000CD2 E8D7FF                  	call	wordtohex
  3334 00000CD5 6689C2                  	mov	edx, eax
  3335 00000CD8 6658                    	pop	eax
  3336 00000CDA E8CFFF                  	call	wordtohex
  3337 00000CDD C3                      	retn
  3338                                  
  3339                                  	; 13/11/2016 - Erdogan Tan
  3340                                  write_ac97_dev_info:
  3341                                  	; BUS/DEV/FN
  3342                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  3343                                  	; DEV/VENDOR
  3344                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  3345                                  
  3346 00000CDE 30FF                    	xor	bh, bh
  3347 00000CE0 668B36[5E10]            	mov	esi, [dev_vendor]
  3348 00000CE5 89F0                    	mov	ax, si
  3349 00000CE7 88C3                    	mov	bl, al
  3350 00000CE9 88DA                    	mov	dl, bl
  3351 00000CEB 80E30F                  	and	bl, 0Fh
  3352 00000CEE 8A87[9A0F]              	mov	al, [bx+hex_chars]
  3353 00000CF2 A2[DD0F]                	mov	[msgVendorId+3], al
  3354 00000CF5 88D3                    	mov	bl, dl
  3355 00000CF7 C0EB04                  	shr	bl, 4
  3356 00000CFA 8A87[9A0F]              	mov	al, [bx+hex_chars]
  3357 00000CFE A2[DC0F]                	mov	[msgVendorId+2], al
  3358 00000D01 88E3                    	mov	bl, ah
  3359 00000D03 88DA                    	mov	dl, bl
  3360 00000D05 80E30F                  	and	bl, 0Fh
  3361 00000D08 8A87[9A0F]              	mov	al, [bx+hex_chars]
  3362 00000D0C A2[DB0F]                	mov	[msgVendorId+1], al
  3363 00000D0F 88D3                    	mov	bl, dl
  3364 00000D11 C0EB04                  	shr	bl, 4
  3365 00000D14 8A87[9A0F]              	mov	al, [bx+hex_chars]
  3366 00000D18 A2[DA0F]                	mov	[msgVendorId], al
  3367 00000D1B 66C1EE10                	shr	esi, 16
  3368 00000D1F 89F0                    	mov	ax, si
  3369 00000D21 88C3                    	mov	bl, al
  3370 00000D23 88DA                    	mov	dl, bl
  3371 00000D25 80E30F                  	and	bl, 0Fh
  3372 00000D28 8A87[9A0F]              	mov	al, [bx+hex_chars]
  3373 00000D2C A2[EE0F]                	mov	[msgDevId+3], al
  3374 00000D2F 88D3                    	mov	bl, dl
  3375 00000D31 C0EB04                  	shr	bl, 4
  3376 00000D34 8A87[9A0F]              	mov	al, [bx+hex_chars]
  3377 00000D38 A2[ED0F]                	mov	[msgDevId+2], al
  3378 00000D3B 88E3                    	mov	bl, ah
  3379 00000D3D 88DA                    	mov	dl, bl
  3380 00000D3F 80E30F                  	and	bl, 0Fh
  3381 00000D42 8A87[9A0F]              	mov	al, [bx+hex_chars]
  3382 00000D46 A2[EC0F]                	mov	[msgDevId+1], al
  3383 00000D49 88D3                    	mov	bl, dl
  3384 00000D4B C0EB04                  	shr	bl, 4
  3385 00000D4E 8A87[9A0F]              	mov	al, [bx+hex_chars]
  3386 00000D52 A2[EB0F]                	mov	[msgDevId], al
  3387                                  
  3388 00000D55 668B36[5A10]            	mov	esi, [bus_dev_fn]
  3389 00000D5A 66C1EE08                	shr	esi, 8
  3390 00000D5E 89F0                    	mov	ax, si
  3391 00000D60 88C3                    	mov	bl, al
  3392 00000D62 88DA                    	mov	dl, bl
  3393 00000D64 80E307                  	and	bl, 7 ; bit 0,1,2
  3394 00000D67 8A87[9A0F]              	mov	al, [bx+hex_chars]
  3395 00000D6B A2[1210]                	mov	[msgFncNo+1], al
  3396 00000D6E 88D3                    	mov	bl, dl
  3397 00000D70 C0EB03                  	shr	bl, 3
  3398 00000D73 88DA                    	mov	dl, bl
  3399 00000D75 80E30F                  	and	bl, 0Fh
  3400 00000D78 8A87[9A0F]              	mov	al, [bx+hex_chars]
  3401 00000D7C A2[0410]                	mov	[msgDevNo+1], al
  3402 00000D7F 88D3                    	mov	bl, dl
  3403 00000D81 C0EB04                  	shr	bl, 4
  3404 00000D84 8A87[9A0F]              	mov	al, [bx+hex_chars]
  3405 00000D88 A2[0310]                	mov	[msgDevNo], al
  3406 00000D8B 88E3                    	mov	bl, ah
  3407 00000D8D 88DA                    	mov	dl, bl
  3408 00000D8F 80E30F                  	and	bl, 0Fh
  3409 00000D92 8A87[9A0F]              	mov	al, [bx+hex_chars]
  3410 00000D96 A2[F80F]                	mov	[msgBusNo+1], al
  3411 00000D99 88D3                    	mov	bl, dl
  3412 00000D9B C0EB04                  	shr	bl, 4
  3413 00000D9E 8A87[9A0F]              	mov	al, [bx+hex_chars]
  3414 00000DA2 A2[F70F]                	mov	[msgBusNo], al
  3415                                  
  3416                                  	;mov	ax, [ac97_io_base]
  3417                                  	; 08/05/2024
  3418 00000DA5 A1[4610]                	mov	ax, [NABMBAR]
  3419 00000DA8 88C3                    	mov	bl, al
  3420 00000DAA 88DA                    	mov	dl, bl
  3421 00000DAC 80E30F                  	and	bl, 0Fh
  3422 00000DAF 8A87[9A0F]              	mov	al, [bx+hex_chars]
  3423 00000DB3 A2[2B10]                	mov	[msgIOBaseAddr+3], al
  3424 00000DB6 88D3                    	mov	bl, dl
  3425 00000DB8 C0EB04                  	shr	bl, 4
  3426 00000DBB 8A87[9A0F]              	mov	al, [bx+hex_chars]
  3427 00000DBF A2[2A10]                	mov	[msgIOBaseAddr+2], al
  3428 00000DC2 88E3                    	mov	bl, ah
  3429 00000DC4 88DA                    	mov	dl, bl
  3430 00000DC6 80E30F                  	and	bl, 0Fh
  3431 00000DC9 8A87[9A0F]              	mov	al, [bx+hex_chars]
  3432 00000DCD A2[2910]                	mov	[msgIOBaseAddr+1], al
  3433 00000DD0 88D3                    	mov	bl, dl
  3434 00000DD2 C0EB04                  	shr	bl, 4
  3435 00000DD5 8A87[9A0F]              	mov	al, [bx+hex_chars]
  3436 00000DD9 A2[2810]                	mov	[msgIOBaseAddr], al
  3437                                  
  3438                                  	; 24/11/2016
  3439 00000DDC 30E4                    	xor	ah, ah
  3440 00000DDE A0[5810]                	mov	al, [ac97_int_ln_reg]
  3441 00000DE1 B10A                    	mov	cl, 10
  3442 00000DE3 F6F1                    	div	cl
  3443 00000DE5 0106[3310]              	add	[msgIRQ], ax
  3444 00000DE9 20C0                    	and	al, al
  3445 00000DEB 7508                    	jnz	short _pmi
  3446 00000DED A0[3410]                	mov	al, [msgIRQ+1]
  3447 00000DF0 B420                    	mov	ah, ' '
  3448 00000DF2 A3[3310]                	mov	[msgIRQ], ax
  3449                                  _pmi:
  3450 00000DF5 BA[AB0F]                        mov	dx, msgAC97Info
  3451 00000DF8 B409                            mov     ah, 9
  3452 00000DFA CD21                            int     21h
  3453 00000DFC C3                              retn
  3454                                  
  3455                                  	; 08/05/2024
  3456                                  ac97_stop:
  3457                                  	; 11/11/2023
  3458                                  	; 09/11/2023
  3459                                  	; 05/11/2023
  3460                                  	; 04/11/2023 
  3461                                  	; 28/05/2017 (TRDOS 386 v2, 'audio.s')
  3462                                  	;mov	byte [tLoop], 0 ; stop ! ; 05/11/2023
  3463                                  ;_ac97_stop:
  3464                                  
  3465                                  	; 11/11/2023
  3466 00000DFD 8B16[4410]              	mov	dx, [NAMBAR]
  3467                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  3468 00000E01 EF                      	out	dx, ax
  3469                                  
  3470                                  	; 04/11/2023
  3471                                  	; 09/10/2017 (TRDOS 386 v2, 'audio.s')
  3472                                  	; 11/06/2017
  3473 00000E02 30C0                    	xor	al, al ; 0
  3474 00000E04 E80D00                  	call	ac97_po_cmd
  3475                                  
  3476                                  	; (Ref: KolibriOS, intelac97.asm, 'stop:')
  3477                                  	; Clear FIFOE, BCIS, LVBCI (Ref: Intel ICH hub manual)
  3478 00000E07 B81C00                  	mov     ax, 1Ch
  3479 00000E0A 8B16[4610]              	mov     dx, [NABMBAR]
  3480 00000E0E 83C216                  	add     dx, PO_SR_REG
  3481 00000E11 EF                      	out     dx, ax
  3482                                  
  3483                                  	; 11/06/2017
  3484 00000E12 B002                    	mov     al, RR
  3485                                  ac97_po_cmd:
  3486                                  	; 11/06/2017
  3487                                  	; 29/05/2017
  3488 00000E14 8B16[4610]              	mov     dx, [NABMBAR]
  3489 00000E18 83C21B                          add     dx, PO_CR_REG		; PCM out control register
  3490 00000E1B EE                      	out	dx, al
  3491 00000E1C C3                      	retn
  3492                                  
  3493                                  ;=============================================================================
  3494                                  ;               preinitialized data
  3495                                  ;=============================================================================
  3496                                  
  3497                                  ;=============================================================================
  3498                                  ;               PLAY.ASM - DATA
  3499                                  ;=============================================================================
  3500                                  
  3501                                  msg_2017:
  3502 00000E1D 54696E79204D4F4420-     		db	'Tiny MOD Player by Erdogan Tan. May 2024.',10,13
  3502 00000E26 506C61796572206279-
  3502 00000E2F 204572646F67616E20-
  3502 00000E38 54616E2E204D617920-
  3502 00000E41 323032342E0A0D     
  3503 00000E48 75736167653A20706C-     		db	'usage: playmod2 filename.mod', 10, 13, '$'
  3503 00000E51 61796D6F6432206669-
  3503 00000E5A 6C656E616D652E6D6F-
  3503 00000E63 640A0D24           
  3504 00000E67 31382F30322F323031-     		db	'18/02/2017',0
  3504 00000E70 3700               
  3505 00000E72 31362F30352F323032-     		db	'16/05/2024',0
  3505 00000E7B 3400               
  3506                                  
  3507 00000E7D 54696E79204D4F4420-     Credits:	db	'Tiny MOD Player v0.1b by Carlos Hasan. July 1993.'
  3507 00000E86 506C61796572207630-
  3507 00000E8F 2E3162206279204361-
  3507 00000E98 726C6F732048617361-
  3507 00000EA1 6E2E204A756C792031-
  3507 00000EAA 3939332E           
  3508                                  CRLF:		; 13/05/2024
  3509 00000EAE 0A0D24                  		db	10,13,'$'
  3510 00000EB1 4572726F72206C6F61-     ErrorMesg:	db	'Error loading Module file.',10,13,'$'
  3510 00000EBA 64696E67204D6F6475-
  3510 00000EC3 6C652066696C652E0A-
  3510 00000ECC 0D24               
  3511                                  
  3512                                  ;=============================================================================
  3513                                  ;               MODPLAY.ASM - DATA
  3514                                  ;=============================================================================
  3515                                  
  3516                                  ;Credits:	db	'Amiga Module Player v0.3b by Carlos Hasan.'
  3517                                  
  3518 00000ECE 0019324A62788EA2B4-     SinTable:	db	0,25,50,74,98,120,142,162,180,197,212,225
  3518 00000ED7 C5D4E1             
  3519 00000EDA ECF4FAFEFFFEFAF4EC-     		db	236,244,250,254,255,254,250,244,236,225
  3519 00000EE3 E1                 
  3520 00000EE4 D4C5B4A28E78624A32-     		db	212,197,180,162,142,120,98,74,50,25
  3520 00000EED 19                 
  3521                                  
  3522 00000EEE 58032803FA02D002A6-     PeriodTable:	dw	856,808,762,720,678,640,604,570,538,508,480,453
  3522 00000EF7 0280025C023A021A02-
  3522 00000F00 FC01E001C501       
  3523 00000F06 AC0194017D01680153-     		dw	428,404,381,360,339,320,302,285,269,254,240,226
  3523 00000F0F 0140012E011D010D01-
  3523 00000F18 FE00F000E200       
  3524 00000F1E D600CA00BE00B400AA-     		dw	214,202,190,180,170,160,151,143,135,127,120,113
  3524 00000F27 00A00097008F008700-
  3524 00000F30 7F0078007100       
  3525                                  
  3526                                  ;=============================================================================
  3527                                  ;               PLAYWAV.ASM / PLAYER.ASM - DATA
  3528                                  ;=============================================================================
  3529                                  
  3530                                  ; 24/11/2016
  3531                                  ;	       IRQ  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 
  3532 00000F36 08090A0B0C0D0E0F70-     irq_int:	db 08h,09h,0Ah,0Bh,0Ch,0Dh,0Eh,0Fh,70h,71h,72h,73h,74h,75h,76h,77h
  3532 00000F3F 71727374757677     
  3533                                  
  3534                                  ; 17/02/2017
  3535                                  ; Valid ICH device IDs
  3536                                  
  3537                                  valid_ids:
  3538 00000F46 86801524                dd	(ICH_DID << 16) + INTEL_VID  	 ; 8086h:2415h
  3539 00000F4A 86802524                dd	(ICH0_DID << 16) + INTEL_VID 	 ; 8086h:2425h
  3540 00000F4E 86804524                dd	(ICH2_DID << 16) + INTEL_VID 	 ; 8086h:2445h
  3541 00000F52 86808524                dd	(ICH3_DID << 16) + INTEL_VID 	 ; 8086h:2485h
  3542 00000F56 8680C524                dd	(ICH4_DID << 16) + INTEL_VID 	 ; 8086h:24C5h
  3543 00000F5A 8680D524                dd	(ICH5_DID << 16) + INTEL_VID 	 ; 8086h:24D5h
  3544 00000F5E 86806E26                dd	(ICH6_DID << 16) + INTEL_VID 	 ; 8086h:266Eh
  3545 00000F62 8680A625                dd	(ESB6300_DID << 16) + INTEL_VID  ; 8086h:25A6h
  3546 00000F66 86809826                dd	(ESB631X_DID << 16) + INTEL_VID  ; 8086h:2698h
  3547 00000F6A 8680DE27                dd	(ICH7_DID << 16) + INTEL_VID 	 ; 8086h:27DEh
  3548                                  ; 03/11/2023 - Erdogan Tan
  3549 00000F6E 86809571                dd	(MX82440_DID << 16) + INTEL_VID  ; 8086h:7195h
  3550 00000F72 39101270                dd	(SI7012_DID << 16)  + SIS_VID	 ; 1039h:7012h
  3551 00000F76 DE10B101                dd 	(NFORCE_DID << 16)  + NVIDIA_VID ; 10DEh:01B1h
  3552 00000F7A DE106A00                dd 	(NFORCE2_DID << 16) + NVIDIA_VID ; 10DEh:006Ah
  3553 00000F7E 22106D74                dd 	(AMD8111_DID << 16) + AMD_VID 	 ; 1022h:746Dh
  3554 00000F82 22104574                dd 	(AMD768_DID << 16)  + AMD_VID 	 ; 1022h:7445h
  3555 00000F86 DE105900                dd 	(CK804_DID << 16) + NVIDIA_VID	 ; 10DEh:0059h
  3556 00000F8A DE103A00                dd 	(MCP04_DID << 16) + NVIDIA_VID	 ; 10DEh:003Ah
  3557 00000F8E DE108A00                dd 	(CK8_DID << 16) + NVIDIA_VID	 ; 1022h:008Ah
  3558 00000F92 DE10DA00                dd 	(NFORCE3_DID << 16) + NVIDIA_VID ; 10DEh:00DAh
  3559 00000F96 DE10EA00                dd 	(CK8S_DID << 16) + NVIDIA_VID	 ; 10DEh:00EAh
  3560                                  
  3561                                  valid_id_count:	equ ($ - valid_ids)>>2 ; 05/11/2023
  3562                                  
  3563                                  ; 13/11/2016
  3564 00000F9A 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  3564 00000FA3 3941424344454600   
  3565 00000FAB 414339372041756469-     msgAC97Info	db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  3565 00000FB4 6F20436F6E74726F6C-
  3565 00000FBD 6C6572202620436F64-
  3565 00000FC6 656320496E666F0D0A 
  3566 00000FCF 56656E646F72204944-     		db "Vendor ID: "
  3566 00000FD8 3A20               
  3567 00000FDA 303030306820446576-     msgVendorId	db "0000h Device ID: "
  3567 00000FE3 6963652049443A20   
  3568 00000FEB 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  3569 00000FF2 4275733A20              		db "Bus: "
  3570 00000FF7 303068204465766963-     msgBusNo	db "00h Device: "
  3570 00001000 653A20             
  3571 00001003 3030682046756E6374-     msgDevNo	db "00h Function: "
  3571 0000100C 696F6E3A20         
  3572 00001011 303068                  msgFncNo	db "00h"
  3573 00001014 0D0A                    		db 0Dh, 0Ah
  3574 00001016 492F4F204261736520-     		db "I/O Base Address: "
  3574 0000101F 416464726573733A20 
  3575 00001028 303030306820495251-     msgIOBaseAddr	db "0000h IRQ: "
  3575 00001031 3A20               
  3576 00001033 3030                    msgIRQ		dw 3030h
  3577 00001035 0D0A24                  		db 0Dh, 0Ah, "$"
  3578                                  
  3579                                  ;msgSampleRate	db "Sample Rate: "
  3580                                  ;msgHertz	db "00000 Hz ", "$" 
  3581                                  ;msg8Bits	db "8 bits ", "$" 
  3582                                  ;msgMono	db "Mono", 0Dh, 0Ah, "$"
  3583                                  ;msg16Bits	db "16 bits ", "$" 
  3584                                  ;msgStereo	db "Stereo", 0Dh, 0Ah, "$"
  3585                                  
  3586                                  ;; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
  3587                                  ;codec_id	dd 0
  3588                                  ;codec_chip_id	dd 0
  3589                                  ;codec_vendor_ids dw 0
  3590                                  ;codec_chip_ids	dw 0
  3591                                  
  3592 00001038 3030303030303030        dword_str	 dd 30303030h, 30303030h
  3593 00001040 680D0A00                		 db 'h', 0Dh, 0Ah, 0
  3594                                  
  3595                                  ;=============================================================================
  3596                                  ;        	uninitialized data
  3597                                  ;=============================================================================
  3598                                  
  3599                                  bss_start:
  3600                                  
  3601                                  ABSOLUTE bss_start
  3602                                  
  3603                                  alignb 4
  3604                                  
  3605                                  ; 17/02/2017
  3606                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  3607                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  3608                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  3609                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  3610 00001044 ????                    NAMBAR:		resw 1			; BAR for mixer
  3611 00001046 ????                    NABMBAR         resw 1			; BAR for bus master regs
  3612                                  
  3613 00001048 ??                      tBuff:		resb	1
  3614                                  ;irq_status:	resb 	1
  3615 00001049 ??                      pcm_irq_status:	resb	1 ; 08/05/2024
  3616                                  
  3617 0000104A ??                      inside:		resb	1 
  3618 0000104B ??                      tLoop:		resb 	1
  3619                                  
  3620                                  ; 08/05/2024
  3621 0000104C ????                    IRQ_status:	resw 1	; IRQ status before enabling audio interrupt
  3622 0000104E ????????                IRQ_vector:	resd 1  ; Previous interrupt handler address	
  3623                                  
  3624                                  ; 256 byte buffer for descriptor list
  3625 00001052 ????                    BDL_BUFFER:	resw	1		; segment of our 256byte BDL buffer
  3626 00001054 ????                    DMA_BUFFER1:	resw 	1		; Pointer to 1st half of DMA Buffer
  3627 00001056 ????                    DMA_BUFFER2:	resw	1		; Pointer to 1st half of DMA Buffer
  3628                                  
  3629                                  ; 12/11/2016 - Erdogan Tan
  3630                                  
  3631 00001058 ??                      ac97_int_ln_reg: resb 1 
  3632 00001059 ??                      err_num:	resb 1
  3633                                  
  3634 0000105A ????????                bus_dev_fn:	resd 1
  3635 0000105E ????????                dev_vendor:	resd 1
  3636                                  ; 08/05/2024
  3637                                  ;stats_cmd:	resd 1
  3638                                  ;ac97_io_base:	resw 1
  3639 00001062 ??                      LVI:		resb 1
  3640                                  ; 12/05/2024
  3641 00001063 ??                      volume:		resb 1
  3642                                  
  3643                                  ;alignb 4
  3644                                  ; 13/05/2024
  3645 00001064 <res Ch>                alignb 16
  3646                                  
  3647 00001070 <res 100h>              BdlBuffer:	resb	BDL_SIZE ; 13/02/2017
  3648 00001170 <res 7800h>             DmaBuffer:	resb	2*BUFFERSIZE ; 13/02/2017
  3649                                  
  3650                                  ; MODLOAD.ASM
  3651 00008970 ????                    FileHandle:	resw	1
  3652 00008972 ????                    ErrorInfo:	resw	1
  3653 00008974 <res 43Ch>              Header:		resb	ModHeader.size
  3654                                  
  3655                                  sample_rate: ; PLAYER.ASM (22050Hz)
  3656                                  ; MODPLAY.ASM
  3657 00008DB0 ????                    MixSpeed:	resw 1
  3658                                  
  3659                                  ModInfo:
  3660 00008DB2 ??                      ModInfo.OrderLen:   resb 1
  3661 00008DB3 ??                      ModInfo.ReStart:    resb 1
  3662 00008DB4 <res 80h>               ModInfo.Order:	    resb 128
  3663 00008E34 ????????                ModInfo.Patterns:   resd 1
  3664                                  
  3665 00008E38 <res 3Eh>               ModInfo.SampOfs:    resw 31
  3666 00008E76 <res 3Eh>               ModInfo.SampSeg:    resw 31
  3667 00008EB4 <res 3Eh>               ModInfo.SampLen:    resw 31
  3668 00008EF2 <res 3Eh>               ModInfo.SampRep:    resw 31
  3669 00008F30 <res 3Eh>               ModInfo.SampRepLen: resw 31
  3670 00008F6E <res 3Eh>               ModInfo.SampVol:    resw 31
  3671                                  
  3672                                  ; MODPLAY.ASM
  3673 00008FAC <res 6B2h>              PitchTable:	resw	857
  3674 0000965E <res 4100h>             VolTable:	resb	16640
  3675 0000D75E <res 1000h>             MixBuffer       resb	MixBufSize
  3676                                  
  3677                                  ; MODPLAY.ASM
  3678 0000E75E ??                      OrderPos:	resb 1
  3679 0000E75F ??                      Tempo:		resb 1
  3680 0000E760 ??                      TempoWait:	resb 1
  3681 0000E761 ??                      Bpm:		resb 1
  3682 0000E762 ??                      Row:		resb 1
  3683 0000E763 ??                      BreakRow:	resb 1
  3684 0000E764 ????                    BpmSamples:	resw 1
  3685 0000E766 ????                    BufPtr:		resw 1
  3686 0000E768 ????                    BufLen:		resw 1
  3687 0000E76A ????                    BufRep:		resw 1
  3688 0000E76C ????????                Note:		resd 1
  3689 0000E770 <res 88h>               Tracks:		resb TrackInfo.size*NumTracks
  3690                                  
  3691 0000E7F8 ????????????????        alignb 16
  3692                                  
  3693                                  ; PLAY.ASM
  3694 0000E800 <res 280h>              Scope:		resw	320
  3695 0000EA80 <res 200h>              RowOfs:		resw	256
  3696                                  
  3697                                  ; 18/02/2017
  3698 0000EC80 ????                    _si_:		resw 1
  3699 0000EC82 <res F00h>              MOD_BUFFER:	resb BUFFERSIZE/4 ; 2048 ; 11/05/2024
  3700                                  EOF:
