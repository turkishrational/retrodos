     1                                  ; ****************************************************************************
     2                                  ; playmod3.asm (for MSDOS)
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; PLAYMOD3.COM ! ICH AC97 MOD PLAYER & VGA DEMO program by Erdogan TAN
     5                                  ;
     6                                  ; 18/02/2017
     7                                  ;
     8                                  ; [ Last Modification: 16/05/2024 ]
     9                                  ;
    10                                  ; Derived from source code of 'PLAYWAV.COM' ('PLAYWAV.ASM') by Erdogan Tan
    11                                  ;							      (17/02/2017)
    12                                  ; Modified from 'PLAYMOD2.COM' ('playmod2.asm') source code 
    13                                  ;		 AC97 MOD PLAYER & VGA DEMO program (tuneloop version)
    14                                  ;						by Erdogan TAN (12/05/2024)
    15                                  ;
    16                                  ; Derived from source code of 'PLAY.EXE' (TINYPLAY) by Carlos Hasan (1993)
    17                                  ;          PLAY.EXE: PLAY.ASM, MODLOAD.ASM, MODPLAY.ASM, SB.ASM
    18                                  ;
    19                                  ; Assembler: NASM 2.15
    20                                  ; ----------------------------------------------------------------------------
    21                                  ;	   nasm  playmod3.asm -l playmod3.lst -o PLAYMOD3.COM	
    22                                  ; ****************************************************************************
    23                                  
    24                                  ; Tiny MOD Player v0.1b by Carlos Hasan.
    25                                  ;		July 14th, 1993.
    26                                  
    27                                  ;=============================================================================
    28                                  ;               PLAYWAV.ASM / PLAYER.ASM / TINYPLAY.ASM
    29                                  ;=============================================================================
    30                                  ; Audio controller, codec & PCI functions are derived from '.wav file player
    31                                  ; for DOS' source code by Jeff Leyda (PLAYER.EXE), Sep 02, 2002.
    32                                  
    33                                  ; AC97 Interrupt version ; 12/05/2024
    34                                  
    35                                  [BITS 16]
    36                                  [org 100h]
    37                                  
    38                                  Start:
    39                                  	; 15/05/2024
    40                                  	; 13/05/2024
    41                                  	; Clear BSS (uninitialized data) area
    42                                  	;xor	ax, ax ; 0
    43                                  	;mov	cx, (EOF - bss_start)/2
    44                                  	;mov	di, bss_start
    45                                  	;rep	stosw
    46                                  
    47 00000000 E8C900                  	call    DetectICH		; Detect AC97 Audio Device
    48                                  GetFileName:    			; Parse  the Command line...
    49 00000003 BE8000                  	mov	si, 80h
    50 00000006 8A1C                    	mov	bl, [si]
    51 00000008 30FF                    	xor	bh, bh
    52 0000000A 43                      	inc	bx
    53 0000000B C60000                  	mov	byte [si+bx], 0		; make AsciiZ filename.
    54 0000000E 46                      	inc	si
    55                                  ScanName:       
    56 0000000F AC                      	lodsb
    57 00000010 84C0                    	test	al, al
    58 00000012 0F84AC00                	je	pmsg_2017
    59 00000016 3C20                    	cmp	al, 20h
    60 00000018 74F5                    	je	short ScanName		; scan start of name.
    61 0000001A 89F7                    	mov	di, si
    62 0000001C 4F                      	dec	di
    63                                  ScanPeriod:
    64 0000001D AC                      	lodsb
    65 0000001E 3C2E                    	cmp	al, '.'			; if period NOT found,
    66 00000020 7410                    	je	short PrintMesg		; then add a .MOD extension.
    67 00000022 84C0                    	test	al, al
    68 00000024 75F7                    	jnz	short ScanPeriod
    69 00000026 4E                      	dec	si
    70                                  SetExt:
    71                                  	;mov	byte [si+0], '.'
    72                                  	;mov	byte [si+1], 'M'
    73                                  	;mov	byte [si+2], 'O'
    74                                  	;mov	byte [si+3], 'D'
    75 00000027 66C7042E4D4F44          	mov	dword [si], '.MOD'
    76 0000002E C6440400                	mov	byte [si+4], 0
    77                                  
    78                                  PrintMesg:
    79 00000032 B80009                  	mov	ax, 0900h		; Prints the Credits Text.
    80                                  	;lea	dx, [Credits]
    81 00000035 BA[880E]                	mov	dx, Credits
    82 00000038 CD21                    	int	21h
    83                                  
    84                                  	; 13/05/2024
    85 0000003A E8AC0C                  	call	write_ac97_dev_info
    86 0000003D B80009                  	mov	ax, 0900h		; Prints the Credits Text.
    87 00000040 BA[B90E]                	mov	dx, CRLF
    88 00000043 CD21                    	int	21h
    89                                  LoadMod:  
    90                                  	; es:di = Filename address
    91 00000045 06                      	push	es
    92 00000046 57                      	push	di
    93 00000047 E8A105                  	call    LoadModule		; Load the MODule...
    94                                  
    95 0000004A 833E[7289]00            	cmp     word [ErrorInfo], 0	; any error loading?
    96 0000004F 740A                    	je      short init_codec
    97                                  
    98 00000051 B80009                  	mov     ax, 0900h		; yes, print error and Exit.
    99                                  	;lea    dx, [ErrorMesg]
   100 00000054 BA[BC0E]                	mov	dx, ErrorMesg
   101 00000057 CD21                    	int     21h
   102 00000059 EB60                    	jmp     Exit
   103                                  
   104                                  init_codec:
   105                                  	; 13/05/2024
   106                                  	;call	write_ac97_dev_info
   107                                  
   108                                  	; 08/05/2024
   109                                  	; 17/02/2017
   110                                  	;mov	dx, [stats_cmd]
   111                                          ;or	dl, IO_ENA+BM_ENA		; enable IO and bus master
   112                                          ;call	pciRegWrite16 ; pciRegWrite8
   113                                  
   114                                  	; 18/02/2017
   115                                  	;mov	word [sample_rate], 22050	; Mixing at 22.050 kHz
   116                                  	; 15/05/2024
   117 0000005B C706[B08D]C05D          	mov	word [sample_rate], 24000
   118                                  	; 16/05/2024
   119                                  	;mov	word [sample_rate], 16000
   120                                  
   121                                  	; 08/05/2024
   122                                  	; (48 kHZ mixing is necessary 
   123                                  	;  if the AC97 hardware/codec has not got VRA feature)
   124                                  	; ((or frequency converting code would be needed))
   125                                  	;mov	word [sample_rate], 48000	; Mixing at 48 kHz
   126                                  
   127                                  ; setup the Codec (actually mixer registers)
   128 00000061 E87F02                          call    codecConfig			; unmute codec, set rates.
   129 00000064 731A                    	jnc	short PlayNow
   130                                  
   131                                  _codec_err:
   132 00000066 0E                      	push	cs
   133 00000067 1F                      	pop	ds
   134 00000068 BA[7100]                        mov	dx, CodecErrMsg
   135 0000006B B409                            mov     ah, 9
   136 0000006D CD21                            int     21h
   137 0000006F EB4A                            jmp     Exit
   138                                  
   139 00000071 436F64656320457272-     CodecErrMsg db "Codec Error!"
   139 0000007A 6F7221             
   140 0000007D 0D0A24                  	db	CR,LF,"$"
   141                                  PlayNow:  
   142 00000080 B8[7010]                	mov	ax, BdlBuffer
   143 00000083 A3[5E10]                	mov	[BDL_BUFFER], ax
   144                                      
   145 00000086 B8[7011]                	mov	ax, DmaBuffer		; DmaBuffer (4096 bytes) buff addr
   146 00000089 A3[6010]                	mov	[DMA_BUFFER1], ax	; 2048 byte half buffer 1 
   147                                  
   148 0000008C 05003C                  	add	ax, BUFFERSIZE		; code/current segment
   149 0000008F A3[6210]                	mov	[DMA_BUFFER2], ax	; 2048 byte half buffer 2
   150                                    
   151                                  	;mov    word [MixSpeed], 22050	; Mixing at 22.050 kHz
   152                                  
   153 00000092 E8240B                  	call    StartPlaying
   154                                  
   155 00000095 B81300                  	mov     ax, 0013h		; Set Mode 320x200x256
   156 00000098 CD10                    	int     10h
   157                                  
   158 0000009A B98000                  	mov     cx, 128			; Make a lookup table
   159 0000009D 31DB                    	xor     bx, bx			; for fastest pixel
   160 0000009F BA002D                  	mov     dx, 320*(100-64)	; addressing.
   161                                  MakeOfs:        
   162 000000A2 8997[80EA]              	mov     [RowOfs+bx], dx
   163 000000A6 8997[82EA]              	mov     [RowOfs+bx+2], dx
   164 000000AA 81C24001                	add     dx, 320
   165 000000AE 83C304                  	add     bx, 4
   166 000000B1 E2EF                    	loop    MakeOfs
   167                                  
   168                                  ; Note: Normally IRQ 0 calls the ModPlay Polling at 18.2Hz thru
   169                                  ;       the software interrupt 1Ch. If the IRQ 0 is disabled, then
   170                                  ;       the INT 1Ch MUST BE CALLED at least MixSpeed/1024 times per
   171                                  ;       second, or the module will sound "looped".
   172                                  ;       Because we need better sync with the ModPlayer to draw the scope,
   173                                  ;       the polling is called from my routine, and then the irq 0 must be
   174                                  ;       disabled. The [DmaBuffer] points to the current buffer of 8-bit
   175                                  ;       samples played by the Sound Blaster. Note that some samples are
   176                                  ;       discarded in the next code, just for fun!
   177                                  
   178                                  	;in     al, 21h			; disable irq 0!
   179                                  	;or     al, 00000001b
   180                                  	;out    21h, al
   181                                  		
   182 000000B3 E8ED03                  	call	ModPlay ; 13/02/2017
   183                                  
   184                                  	;in	al, 21h			; enable irq 0!
   185                                  	;and	al, 11111110b
   186                                  	;out	21h, al
   187                                  
   188 000000B6 B80300                  	mov     ax, 0003h		; Set Text Mode 80x25x16
   189 000000B9 CD10                    	int     10h
   190                                  
   191                                  	; 16/05/2024
   192                                  	;call	StopPlaying		; STOP!
   193                                  Exit:           
   194                                  	;call   FreeModule		; Free MODule core.
   195                                  error_exit:
   196 000000BB B8004C                  	mov     ax, 4C00h		; Bye!
   197 000000BE CD21                    	int     21h
   198                                  here:
   199 000000C0 EBFE                    	jmp	short here
   200                                  
   201                                  pmsg_2017:
   202 000000C2 B80009                  	mov     ax, 0900h		; Prints the Credits Text.
   203                                  	;lea    dx, [msg_2017]
   204 000000C5 BA[280E]                	mov	dx, msg_2017
   205 000000C8 CD21                    	int     21h
   206 000000CA EBEF                    	jmp	short Exit
   207                                  
   208                                  DetectICH:
   209                                  	; 18/02/2017
   210                                  	; Detech Intel ICH based AC97 Audio Device 
   211 000000CC E8D301                  	call    pciFindDevice 	; AC97.ASM (PLAYWAV.COM)
   212 000000CF 733F                            jnc     short _1
   213                                  
   214                                  ; couldn't find the audio device!
   215                                  	;push	cs
   216                                  	;pop	ds
   217 000000D1 BA[DA00]                        mov     dx, noDevMsg
   218 000000D4 B409                            mov     ah, 9
   219 000000D6 CD21                            int     21h
   220 000000D8 EBE1                            jmp     short error_exit
   221                                  
   222 000000DA 4572726F723A20556E-     noDevMsg db "Error: Unable to find Intel ICH based audio device!",CR,LF,"$"
   222 000000E3 61626C6520746F2066-
   222 000000EC 696E6420496E74656C-
   222 000000F5 204943482062617365-
   222 000000FE 6420617564696F2064-
   222 00000107 6576696365210D0A24 
   223                                  
   224                                  _1:
   225                                  	; 18/02/2017
   226                                  	; eax = BUS/DEV/FN
   227                                  	;	00000000BBBBBBBBDDDDDFFF00000000
   228                                  	; edx = DEV/VENDOR
   229                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
   230                                  
   231 00000110 66A3[6610]              	mov	[bus_dev_fn], eax
   232 00000114 668916[6A10]            	mov	[dev_vendor], edx
   233                                  
   234                                  	; get ICH base address regs for mixer and bus master
   235                                  
   236 00000119 B010                            mov     al, NAMBAR_REG
   237 0000011B E8F600                          call    pciRegRead16			; read PCI registers 10-11
   238                                          ;and    dx, IO_ADDR_MASK 		; mask off BIT0
   239                                  	; 14/05/2024
   240 0000011E 80E2FE                  	and	dl, 0FEh
   241                                  
   242 00000121 8916[5010]                      mov     [NAMBAR], dx			; save audio mixer base addr
   243                                  
   244 00000125 B014                    	mov     al, NABMBAR_REG
   245 00000127 E8EA00                          call    pciRegRead16
   246                                          ;and    dx, IO_ADDR_MASK
   247                                  	; 14/05/2024
   248 0000012A 80E2C0                  	and	dl, 0C0h
   249                                  
   250 0000012D 8916[5210]                      mov     [NABMBAR], dx			; save bus master base addr
   251                                  
   252                                  	; 08/05/2024
   253                                  	; 06/11/2023
   254                                  	;; init controller
   255                                  	;; 17/02/2017
   256                                  	;mov	al, PCI_CMD_REG ; command register (04h)
   257                                  	;call	pciRegRead16 ; pciRegRead8
   258                                  	;
   259                                  	;; eax = BUS/DEV/FN/REG
   260                                  	;;  dx = PCI Command Register Content ; 17/02/2017
   261                                  	;; 	00000000CCCCCCCC
   262                                  	;mov	[stats_cmd], dx
   263                                  	;
   264                                  	; 06/11/2023
   265                                  	;mov	al, PCI_IO_BASE ; IO base address register (10h)
   266                                  	;call	pciRegRead32
   267                                  	;
   268                                  	;and	dx, 0FFC0h	; IO_ADDR_MASK (0FFFE) ?
   269                                          ;mov	[ac97_io_base], dx
   270                                  
   271 00000131 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
   272 00000133 E8D600                  	call	pciRegRead8 ; 17/02/2017
   273                                  
   274 00000136 8816[6410]              	mov     [ac97_int_ln_reg], dl
   275                                  
   276                                  	; 28/11/2016
   277                                  	;mov	bx, 1	; 08/05/2024
   278 0000013A 30F6                    	xor	dh, dh	; 17/02/2017
   279                                  	; 10/11/2023
   280                                  	;mov	cx, dx
   281                                  	;shl	bx, cl
   282                                  
   283                                  	; 04/11/2023
   284 0000013C FA                      	cli
   285                                  
   286                                  	;not	bx
   287 0000013D E4A1                    	in	al, 0A1h ; irq 8-15
   288 0000013F 88C4                            mov	ah, al
   289 00000141 E421                            in	al, 21h  ; irq 0-7
   290                                  
   291                                  	; 04/11/2023
   292                                  	; save IRQ status
   293 00000143 A3[5810]                	mov	[IRQ_status], ax
   294                                  
   295                                  	; 12/05/2024 (enable AC97 IRQ)
   296                                  	;mov	cl, dl
   297                                  	;mov	bx, 1
   298                                  	;shl	bx, cl
   299                                  	;not	bx
   300                                  	;and	ax, bx
   301                                  	;out	21h, al
   302                                  	;mov	al, ah
   303                                  	;out	0A1h, al
   304                                  
   305                                  	; 15/05/2024
   306                                  	;and	ax, bx   ; unmask
   307 00000146 0FB3D0                   	btr	ax, dx	 ; unmask
   308 00000149 E621                    	out	21h, al  ; enable interrupt (if irq <= 7)
   309 0000014B 88E0                    	mov	al, ah
   310 0000014D E6A1                    	out	0A1h, al ; enable interrupt (if irq > 7)
   311                                  	;not	bx
   312                                  
   313                                  	; 08/05/2024
   314                                  	;mov	dx, 4D1h			;8259 ELCR1
   315                                          ;in	al, dx
   316                                  	;mov	ah, al
   317                                  	;mov	dx, 4D0h
   318                                          ;in	al, dx
   319                                  	;;or	ax, bx
   320                                  	;bts	ax, cx
   321                                  	;mov	dx, 4D0h
   322                                  	;out	dx, al                          ;set level-triggered mode
   323                                  	;mov	al, ah
   324                                  	;mov	dx, 4D1h
   325                                  	;out	dx, al                          ;set level-triggered mode
   326                                  
   327                                  	; 24/11/2016 - Erdogan Tan
   328                                  	;mov	bx, cx
   329                                  	; 10/11/2023
   330 0000014F 89D3                    	mov	bx, dx
   331 00000151 8A9F[410F]              	mov	bl, [bx+irq_int]
   332 00000155 C1E302                  	shl	bx, 2 ; * 4
   333                                  
   334                                  	; set up interrupt vector
   335                                  	; 30/11/2016
   336 00000158 06                      	push	es
   337 00000159 31C0                    	xor	ax, ax
   338 0000015B 8EC0                    	mov	es, ax
   339                                  	; 04/11/2023
   340                                  	; save interrupt vector
   341                                  	;mov	ax, [es:bx]
   342                                  	; 13/05/2024
   343 0000015D B8[7201]                	mov	ax, ac97_int_handler
   344 00000160 268707                  	xchg	ax, [es:bx]
   345 00000163 A3[5A10]                	mov	[IRQ_vector], ax
   346                                  	;mov	ax, [es:bx+2]
   347                                  	; 13/05/2024
   348 00000166 8CC8                    	mov	ax, cs
   349 00000168 26874702                	xchg	ax, [es:bx+2]
   350 0000016C A3[5C10]                	mov	[IRQ_vector+2], ax
   351                                  
   352                                  	; 13/05/2024
   353                                  	;mov	word [es:bx], ac97_int_handler
   354                                  	;mov	ax, cs
   355                                  	;mov	[es:bx+2], ax
   356                                  	
   357 0000016F 07                      	pop	es
   358                                  
   359                                  	; 04/11/2023
   360 00000170 FB                      	sti
   361                                  
   362 00000171 C3                      	retn
   363                                  
   364                                  ; 16/05/2024
   365                                  %if 0
   366                                  	; 15/05/2024
   367                                  ac97_int_handler:
   368                                  	; 13/05/2024
   369                                  	; 12/05/2024
   370                                  	; 11/05/2024
   371                                  	; 11/11/2023
   372                                  	; 10/11/2023
   373                                  	; 17/02/2016
   374                                  	push	eax	; 11/11/2023
   375                                  	push	dx
   376                                  	; 05/11/2023
   377                                  	;push	cx
   378                                  	;push	bx
   379                                  	;push	si
   380                                  	;push	di
   381                                  
   382                                  	; 10/11/2023
   383                                  	; EOI at first
   384                                  	mov	al, 20h
   385                                  	test	byte [ac97_int_ln_reg], 8
   386                                  	jz	short _ih_0
   387                                  	out 	0A0h, al ; 20h	; EOI
   388                                  _ih_0:
   389                                  	out	20h, al  ; 20h	; EOI
   390                                  
   391                                  	; 11/11/2023
   392                                  	; 09/11/2023
   393                                  	mov	dx, GLOB_STS_REG
   394                                          add	dx, [NABMBAR]
   395                                  	in	eax, dx
   396                                  
   397                                  	; 12/05/2024
   398                                  	; 09/11/2023
   399                                  	;cmp	eax, 0FFFFFFFFh ; -1
   400                                  	;je	short _ih_3
   401                                  	; 15/05/2024
   402                                  	inc	eax	; 0FFFFFFFFh
   403                                  	jz	short _ih_3
   404                                  	dec	eax	; 0
   405                                  	jz	short _ih_3
   406                                  
   407                                  	; 15/05/2024
   408                                  	cmp	byte [tLoop], 1
   409                                  	jb	short _ih_2
   410                                  
   411                                  	; 12/05/2024
   412                                  	;test	al, 40h		; PCM Out Interrupt
   413                                  	; 15/05/2024
   414                                  	test	al, PCM_OUT_IRQ
   415                                  	jnz	short _ih_1
   416                                  
   417                                  	; 15/05/2024
   418                                  	;test	eax, eax
   419                                  	;jz	short _ih_3
   420                                  
   421                                  	; 12/05/2024
   422                                  	;test	ax, PCM_OUT_IRQ
   423                                  	;jnz	short _ih_1
   424                                  
   425                                   	;mov	dx, GLOB_STS_REG
   426                                          ;add	dx, [NABMBAR]
   427                                  	; 12/05/2024
   428                                  	;out	dx, eax
   429                                  	jmp	short _ih_2
   430                                  	;jmp	short _ih_3
   431                                  
   432                                  	; .....
   433                                  	;mov	al, 1
   434                                  	; 10/11/2023
   435                                  	;mov	[tLoop], al  ; 1
   436                                  
   437                                  	;cmp	[inside], al ; 1
   438                                  	;jnb	short _ih_2	; busy
   439                                  
   440                                  	;mov	[inside], al ; 1
   441                                  	;
   442                                  	;; 09/11/2023
   443                                          ;mov	dx, [NABMBAR]
   444                                          ;add	dx, PO_SR_REG	; set pointer to Status reg
   445                                  	;in	al, dx
   446                                  	;; 10/11/2023
   447                                  	;;;out	dx, eax
   448                                  	;;out	dx, al		; clear interrupt event
   449                                  	;			; (by writing 1 to same bits)
   450                                  	;
   451                                  	;;mov	[pcm_irq_status], al ; 05/11/2023
   452                                  	;test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
   453                                  	;jz	short _ih_3
   454                                  	; .....
   455                                  
   456                                  _ih_1:
   457                                  	; 11/11/2023
   458                                  	;push	eax
   459                                  	; 15/05/2024
   460                                  	push	ax
   461                                  
   462                                  	; 13/05/2024
   463                                  	mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   464                                  	mov	dx, PO_SR_REG
   465                                          add	dx, [NABMBAR]
   466                                  	out	dx, ax
   467                                  
   468                                  	; 13/05/2024
   469                                  	mov	dx, PO_CIV_REG
   470                                          add	dx, [NABMBAR]
   471                                  	in	al, dx
   472                                  	mov	ah, al
   473                                  	dec	al
   474                                  	and	al, 1Fh
   475                                          mov     dx, PO_LVI_REG
   476                                          add	dx, [NABMBAR]
   477                                          out	dx, al
   478                                  	and	ah, 1
   479                                  	; 13/05/2024
   480                                  	inc	ah
   481                                  	mov	[tBuff], ah ; 1 = Buffer 1, 2 = Buffer 2
   482                                  
   483                                  	; 13/05/2024
   484                                  	; 10/11/2023
   485                                  	; 28/11/2016 - Erdogan Tan
   486                                  	;call	tuneLoop
   487                                  
   488                                  	; 11/11/2023
   489                                  	;pop	eax
   490                                  	; 15/05/2024
   491                                  	pop	ax
   492                                  
   493                                  	mov	dx, GLOB_STS_REG
   494                                          add	dx, [NABMBAR]
   495                                  _ih_2:			; 12/05/2024
   496                                  	out	dx, eax
   497                                  
   498                                  	; 12/05/2024
   499                                  _ih_3:
   500                                  	; 11/11/2023
   501                                  	;mov	dx, [NABMBAR]
   502                                  	;add	dx, PO_SR_REG	; set pointer to Status reg
   503                                  	;mov	ax, 1Ch
   504                                  	;out	dx, ax
   505                                  
   506                                  ;	; 10/11/2023
   507                                  ;	mov	al, 20h
   508                                  ;	test	byte [ac97_int_ln_reg], 8
   509                                  ;	jz	short _ih_3
   510                                  ;	out 	0A0h, al ; 20h	; EOI
   511                                  ;_ih_3:
   512                                  ;	out	20h, al  ; 20h	; EOI
   513                                  ;_ih_4:
   514                                  	;mov	byte [inside], 0
   515                                  	;pop	di
   516                                  	;pop	si
   517                                  	;pop	bx
   518                                  	;pop	cx
   519                                  	pop	dx
   520                                  	pop	eax ; 11/11/2023
   521                                  	iret
   522                                  %else
   523                                  	; 16/05/2024
   524                                  	; 15/05/2024
   525                                  ac97_int_handler:
   526                                  	; 13/05/2024
   527                                  	; 12/05/2024
   528                                  	; 11/05/2024
   529                                  	; 11/11/2023
   530                                  	; 10/11/2023
   531                                  	; 17/02/2016
   532 00000172 50                      	push	ax ; +	; 16/05/2024
   533                                  	;push	eax ; *	; 11/11/2023
   534 00000173 52                      	push	dx ; **
   535                                  	; 05/11/2023
   536                                  	;push	cx
   537                                  	;push	bx
   538                                  	;push	si
   539                                  	;push	di
   540                                  
   541                                  	; 16/05/2024
   542                                  	; 10/11/2023
   543                                  	; EOI at first
   544 00000174 B020                    	mov	al, 20h
   545 00000176 F606[6410]08            	test	byte [ac97_int_ln_reg], 8
   546 0000017B 7402                    	jz	short _ih_0
   547 0000017D E6A0                    	out 	0A0h, al ; 20h	; EOI
   548                                  _ih_0:
   549 0000017F E620                    	out	20h, al  ; 20h	; EOI
   550                                  
   551                                  	; 16/05/2024
   552                                  ;	mov	dx, GLOB_STS_REG
   553                                  ;	add	dx, [NABMBAR]
   554                                  ;	in	eax, dx
   555                                  ;
   556                                  ;	inc	eax	; 0FFFFFFFFh
   557                                  ;	jz	short _ih_3
   558                                  ;	dec	eax	; 0
   559                                  ;	;jz	short _ih_3
   560                                  ;_ih_3:
   561                                  ;	; 16/05/2024
   562                                  ;	push	eax ; ***
   563                                  
   564                                  	; 16/05/2024
   565                                  	; 24/11/2023 (TRDOS386 'audio.s')
   566 00000181 8B16[5210]                      mov	dx, [NABMBAR]
   567 00000185 83C216                  	add	dx, PO_SR_REG
   568 00000188 ED                      	in	ax, dx
   569                                  
   570 00000189 A808                    	test	al, BCIS ; bit 3, 8
   571 0000018B 7428                    	jz	short _ih_2
   572                                  
   573                                  	; 15/05/2024
   574 0000018D 803E[5710]01            	cmp	byte [tLoop], 1
   575 00000192 7221                    	jb	short _ih_2
   576                                  _ih_1:
   577                                  	; 16/05/2024
   578                                  	; 13/05/2024
   579                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   580                                  	;add	dx, PO_SR_REG
   581                                          ;add	dx, [NABMBAR]
   582                                  	;out	dx, ax
   583                                  
   584                                  	; 16/05/2024
   585 00000194 50                      	push	ax ; ****
   586                                  
   587                                  	; 13/05/2024
   588 00000195 BA1400                  	mov	dx, PO_CIV_REG
   589 00000198 0316[5210]                      add	dx, [NABMBAR]
   590 0000019C EC                      	in	al, dx
   591 0000019D 88C4                    	mov	ah, al
   592 0000019F FEC8                    	dec	al
   593 000001A1 241F                    	and	al, 1Fh
   594 000001A3 BA1500                          mov     dx, PO_LVI_REG
   595 000001A6 0316[5210]                      add	dx, [NABMBAR]
   596 000001AA EE                              out	dx, al
   597 000001AB 80E401                  	and	ah, 1
   598                                  	; 13/05/2024
   599 000001AE FEC4                    	inc	ah
   600 000001B0 8826[5410]              	mov	[tBuff], ah ; 1 = Buffer 1, 2 = Buffer 2
   601                                  
   602                                  	; 13/05/2024
   603                                  	; 10/11/2023
   604                                  	; 28/11/2016 - Erdogan Tan
   605                                  	;call	tuneLoop
   606                                  
   607                                  	; 16/05/2024
   608 000001B4 58                      	pop	ax ; ****
   609                                  
   610                                  	; 16/05/2024
   611                                  _ih_2:
   612                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   613 000001B5 8B16[5210]              	mov	dx, [NABMBAR]
   614 000001B9 83C216                  	add	dx, PO_SR_REG
   615 000001BC EF                      	out	dx, ax
   616                                  
   617                                  ;	; 16/05/2024
   618                                  ;	pop	eax ; ***
   619                                  ;	
   620                                  ;	or	eax, eax
   621                                  ;	jz	short _ih_4
   622                                  ;	
   623                                  ;	mov	dx, GLOB_STS_REG
   624                                  ;	add	dx, [NABMBAR]
   625                                  ;	out	dx, eax
   626                                  
   627                                  	; 16/05/2024
   628                                  _ih_4:
   629                                  	; 10/11/2023
   630                                  	;mov	al, 20h
   631                                  	;test	byte [ac97_int_ln_reg], 8
   632                                  	;jz	short _ih_5
   633                                  	;out 	0A0h, al ; 20h	; EOI
   634                                  ;_ih_5:
   635                                  	;out	20h, al  ; 20h	; EOI
   636                                  ;_ih_6:
   637                                  	;pop	di
   638                                  	;pop	si
   639                                  	;pop	bx
   640                                  	;pop	cx
   641 000001BD 5A                      	pop	dx ; **
   642                                  	;pop	eax ; *	; 11/11/2023
   643 000001BE 58                      	pop	ax ; + ; 16/05/2024
   644 000001BF CF                      	iret
   645                                  %endif
   646                                  
   647                                  ;=============================================================================
   648                                  ;               PCI.ASM
   649                                  ;=============================================================================
   650                                  
   651                                  ; EQUATES
   652                                  
   653                                  ;constants of stuff that seem hard to remember at times.
   654                                  
   655                                  TRUE  EQU 1
   656                                  FALSE EQU 0
   657                                  
   658                                  ENABLED  EQU 1
   659                                  DISABLED EQU 0
   660                                  
   661                                  BIT0  EQU 1
   662                                  BIT1  EQU 2
   663                                  BIT2  EQU 4
   664                                  BIT3  EQU 8
   665                                  BIT4  EQU 10h
   666                                  BIT5  EQU 20h
   667                                  BIT6  EQU 40h
   668                                  BIT7  EQU 80h
   669                                  BIT8  EQU 100h
   670                                  BIT9  EQU 200h
   671                                  BIT10 EQU 400h
   672                                  BIT11 EQU 800h
   673                                  BIT12 EQU 1000h
   674                                  BIT13 EQU 2000h
   675                                  BIT14 EQU 4000h
   676                                  BIT15 EQU 8000h
   677                                  BIT16 EQU 10000h
   678                                  BIT17 EQU 20000h
   679                                  BIT18 EQU 40000h
   680                                  BIT19 EQU 80000h
   681                                  BIT20 EQU 100000h
   682                                  BIT21 EQU 200000h
   683                                  BIT22 EQU 400000h
   684                                  BIT23 EQU 800000h
   685                                  BIT24 EQU 1000000h
   686                                  BIT25 EQU 2000000h
   687                                  BIT26 EQU 4000000h
   688                                  BIT27 EQU 8000000h
   689                                  BIT28 EQU 10000000h
   690                                  BIT29 EQU 20000000h
   691                                  BIT30 EQU 40000000h
   692                                  BIT31 EQU 80000000h
   693                                  
   694                                  ;special characters
   695                                  NUL     EQU 0
   696                                  NULL    EQU 0
   697                                  BELL    EQU 07
   698                                  BS      EQU 08
   699                                  TAB     EQU 09
   700                                  LF      EQU 10
   701                                  CR      EQU 13
   702                                  ESCAPE  EQU 27           ;ESC is a reserved word....
   703                                  
   704                                  
   705                                  ;file stuff
   706                                  READONLY  EQU   BIT0
   707                                  HIDDEN    EQU   BIT1
   708                                  SYSTEM    EQU   BIT2
   709                                  VOLUME    EQU   BIT3         ;ignored for file access
   710                                  DIRECTORY EQU   BIT4         ;must be 0 for file access
   711                                  ARCHIVE   EQU   BIT5
   712                                  SHAREABLE EQU   BIT7         ;for novell networks
   713                                  OPEN	EQU	2		; open existing file
   714                                  CREATE	EQU	1		; create new file
   715                                  
   716                                  ; PCI equates
   717                                  ; PCI function address (PFA)
   718                                  ; bit 31 = 1
   719                                  ; bit 23:16 = bus number     (0-255)
   720                                  ; bit 15:11 = device number  (0-31)
   721                                  ; bit 10:8 = function number (0-7)
   722                                  ; bit 7:0 = register number  (0-255)
   723                                  
   724                                  IO_ADDR_MASK    EQU     0FFFEh          ; mask off bit 0 for reading BARs
   725                                  PCI_INDEX_PORT  EQU     0CF8h
   726                                  PCI_DATA_PORT   EQU     0CFCh
   727                                  PCI32           EQU     BIT31           ; bitflag to signal 32bit access
   728                                  PCI16           EQU     BIT30           ; bitflag for 16bit access
   729                                  
   730                                  PCI_FN0         EQU     0 << 8
   731                                  PCI_FN1         EQU     1 << 8
   732                                  PCI_FN2         EQU     2 << 8
   733                                  PCI_FN3         EQU     3 << 8
   734                                  PCI_FN4         EQU     4 << 8
   735                                  PCI_FN5         EQU     5 << 8
   736                                  PCI_FN6         EQU     6 << 8
   737                                  PCI_FN7         EQU     7 << 8
   738                                  
   739                                  PCI_CMD_REG		EQU	04h		; reg 04, command reg
   740                                   IO_ENA			EQU	BIT0		; i/o decode enable
   741                                   MEM_ENA		EQU	BIT1		; memory decode enable
   742                                   BM_ENA                 EQU     BIT2		; bus master enable
   743                                  
   744                                  ; CODE
   745                                  
   746                                  ; AC97.ASM
   747                                  ; PCI device register reader/writers.
   748                                  ; NASM version: Erdogan Tan (29/11/2016)
   749                                  ; 		Last Update: 17/02/2017
   750                                  
   751                                  ;===============================================================
   752                                  ; 8/16/32bit PCI reader
   753                                  ;
   754                                  ; Entry: EAX=PCI Bus/Device/fn/register number
   755                                  ;           BIT30 set if 32 bit access requested
   756                                  ;           BIT29 set if 16 bit access requested
   757                                  ;           otherwise defaults to 8bit read
   758                                  ;
   759                                  ; Exit:  DL,DX,EDX register data depending on requested read size
   760                                  ;
   761                                  ; Note: this routine is meant to be called via pciRegRead8, pciRegread16,
   762                                  ;	or pciRegRead32, listed below.
   763                                  ;
   764                                  ; Note2: don't attempt to read 32bits of data from a non dword aligned reg
   765                                  ;	 number.  Likewise, don't do 16bit reads from non word aligned reg #
   766                                  ; 
   767                                  pciRegRead:
   768 000001C0 6653                    	push	ebx
   769 000001C2 51                      	push	cx
   770 000001C3 6689C3                          mov     ebx, eax                        ; save eax, dh
   771 000001C6 88F1                            mov     cl, dh
   772 000001C8 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   773 000001CE 660D00000080                    or      eax, BIT31                      ; make a PCI access request
   774 000001D4 24FC                            and     al, ~3 ; NOT 3                  ; force index to be dword
   775                                  
   776 000001D6 BAF80C                          mov     dx, PCI_INDEX_PORT
   777 000001D9 66EF                            out     dx, eax                         ; write PCI selector
   778                                  
   779 000001DB BAFC0C                          mov     dx, PCI_DATA_PORT
   780 000001DE 88D8                            mov     al, bl
   781 000001E0 2403                            and     al, 3                           ; figure out which port to
   782 000001E2 00C2                            add     dl, al                          ; read to
   783                                  
   784 000001E4 66ED                    	in      eax, dx                         ; do 32bit read
   785 000001E6 66F7C300000080                  test    ebx, PCI32
   786 000001ED 7403                            jz      short _pregr1
   787                                  
   788 000001EF 6689C2                          mov     edx, eax                        ; return 32bits of data
   789                                  _pregr1:
   790 000001F2 89C2                    	mov     dx, ax                          ; return 16bits of data
   791 000001F4 66F7C3000000C0                  test    ebx, PCI32+PCI16
   792 000001FB 7502                            jnz     short _pregr2
   793 000001FD 88CE                            mov     dh, cl                          ; restore dh for 8 bit read
   794                                  _pregr2:
   795 000001FF 6689D8                          mov     eax, ebx                        ; restore eax
   796 00000202 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   797 00000208 59                      	pop	cx
   798 00000209 665B                    	pop	ebx
   799 0000020B C3                      	retn
   800                                  
   801                                  pciRegRead8:
   802 0000020C 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32             ; set up 8 bit read size
   803 00000212 EBAC                            jmp     short pciRegRead		; call generic PCI access
   804                                  
   805                                  pciRegRead16:
   806 00000214 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 16 bit read size
   807 0000021A 660D00000040                    or      eax, PCI16			; call generic PCI access
   808 00000220 EB9E                            jmp     short pciRegRead
   809                                  
   810                                  pciRegRead32:
   811 00000222 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 32 bit read size
   812 00000228 660D00000080                    or      eax, PCI32			; call generic PCI access
   813 0000022E EB90                            jmp     short pciRegRead
   814                                  
   815                                  ;===============================================================
   816                                  ; 8/16/32bit PCI writer
   817                                  ;
   818                                  ; Entry: EAX=PCI Bus/Device/fn/register number
   819                                  ;           BIT31 set if 32 bit access requested
   820                                  ;           BIT30 set if 16 bit access requested
   821                                  ;           otherwise defaults to 8bit read
   822                                  ;        DL/DX/EDX data to write depending on size
   823                                  ;
   824                                  ;
   825                                  ; note: this routine is meant to be called via pciRegWrite8, pciRegWrite16,
   826                                  ; 	or pciRegWrite32 as detailed below.
   827                                  ;
   828                                  ; Note2: don't attempt to write 32bits of data from a non dword aligned reg
   829                                  ;	 number.  Likewise, don't do 16bit writes from non word aligned reg #
   830                                  ;
   831                                  pciRegWrite:
   832 00000230 6653                    	push	ebx
   833 00000232 51                      	push	cx
   834 00000233 6689C3                          mov     ebx, eax                        ; save eax, dx
   835 00000236 89D1                            mov     cx, dx
   836 00000238 660D00000080                    or      eax, BIT31                      ; make a PCI access request
   837 0000023E 6625FFFFFFBF                    and     eax, ~PCI16 ; NOT PCI16         ; clear out data size request
   838 00000244 24FC                            and     al, ~3 ; NOT 3                  ; force index to be dword
   839                                  
   840 00000246 BAF80C                          mov     dx, PCI_INDEX_PORT
   841 00000249 66EF                            out     dx, eax                         ; write PCI selector
   842                                  
   843 0000024B BAFC0C                          mov     dx, PCI_DATA_PORT
   844 0000024E 88D8                            mov     al, bl
   845 00000250 2403                            and     al, 3                           ; figure out which port to
   846 00000252 00C2                            add     dl, al                          ; write to
   847                                  
   848 00000254 6689D0                          mov     eax, edx                        ; put data into eax
   849 00000257 89C8                            mov     ax, cx
   850                                  
   851 00000259 EE                              out     dx, al
   852 0000025A 66F7C3000000C0                  test    ebx, PCI16+PCI32                ; only 8bit access? bail
   853 00000261 740C                            jz      short _pregw1
   854                                  
   855 00000263 EF                              out     dx, ax                          ; write 16 bit value
   856 00000264 66F7C300000040                  test    ebx, PCI16                      ; 16bit requested?  bail
   857 0000026B 7502                            jnz     short _pregw1
   858                                  
   859 0000026D 66EF                            out     dx, eax                         ; write full 32bit
   860                                  _pregw1:
   861 0000026F 6689D8                          mov     eax, ebx                        ; restore eax
   862 00000272 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   863 00000278 89CA                            mov     dx, cx                          ; restore dx
   864 0000027A 59                      	pop	cx
   865 0000027B 665B                    	pop	ebx
   866 0000027D C3                      	ret
   867                                  
   868                                  pciRegWrite8:
   869 0000027E 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 8 bit write size
   870 00000284 EBAA                            jmp     short pciRegWrite		; call generic PCI access
   871                                  
   872                                  pciRegWrite16:
   873 00000286 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 16 bit write size
   874 0000028C 660D00000040                    or      eax, PCI16			; call generic PCI access
   875 00000292 EB9C                            jmp     short pciRegWrite
   876                                  
   877                                  pciRegWrite32:
   878 00000294 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 32 bit write size
   879 0000029A 660D00000080                    or      eax, PCI32			; call generic PCI access
   880 000002A0 EB8E                            jmp     short pciRegWrite
   881                                  
   882                                  ; AC97.ASM (PLAYWAV.COM)
   883                                  ; 17/02/2017 (Modifed by Erdogan Tan for various ICH device IDs)
   884                                  ;===============================================================
   885                                  ; PCIFindDevice: scan through PCI space looking for a device+vendor ID
   886                                  ;
   887                                  ;  ENTRY: none
   888                                  ;; Entry: EAX=Device+Vendor ID
   889                                  ;
   890                                  ;  Exit: EAX=PCI address if device found
   891                                  ;	 EDX=Device+Vendor ID
   892                                  ;        CY clear if found, set if not found. EAX invalid if CY set.
   893                                  ;
   894                                  ; [old stackless] Destroys: ebx, esi, edi, cl
   895                                  ;
   896                                  pciFindDevice:
   897                                  	;push	cx
   898                                  	;push	eax ; *
   899                                  	;push	esi
   900                                  	;push	edi
   901                                  
   902                                   	;mov     esi, eax                ; save off vend+device ID
   903                                  
   904                                  	; 17/02/2017
   905 000002A2 BE[510F]                	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
   906 000002A5 B91500                  	mov	cx, valid_id_count
   907                                  pfd_0:
   908 000002A8 66BF00FFFF7F                   	mov     edi, (80000000h - 100h) ; start with bus 0, dev 0 func 0
   909                                  nextPCIdevice:
   910 000002AE 6681C700010000                  add     edi, 100h
   911 000002B5 6681FF00F8FF80                  cmp     edi, 80FFF800h		; scanned all devices?
   912                                          ;stc
   913                                          ;je 	short PCIScanExit       ; not found
   914 000002BC 720D                    	jb	short pfd_1
   915 000002BE 66BF00000080            	mov     edi, 80000000h
   916 000002C4 83C604                  	add	si, 4 ; scan for next device ID
   917 000002C7 E202                    	loop	pfd_1	 
   918 000002C9 F9                      	stc	
   919                                  	;jmp 	short PCIScanExit
   920 000002CA C3                      	retn
   921                                  pfd_1:
   922 000002CB 6689F8                          mov     eax, edi                ; read PCI registers
   923 000002CE E851FF                          call    pciRegRead32
   924                                          ;cmp    edx, esi                ; found device?
   925 000002D1 663B14                          cmp	edx, dword [si]
   926 000002D4 75D8                    	jne     short nextPCIdevice
   927                                          ;clc
   928                                  PCIScanExit:
   929                                  	;pushf
   930 000002D6 66B800000080            	mov	eax, BIT31
   931 000002DC 66F7D0                  	not	eax
   932 000002DF 6621F8                  	and	eax, edi		; return only bus/dev/fn #
   933                                  	;popf
   934                                  
   935                                  	;pop	edi
   936                                  	;pop	esi
   937                                  	;pop	edx ; *
   938                                  	;pop	cx
   939 000002E2 C3                      	retn
   940                                  
   941                                  ;=============================================================================
   942                                  ;               CODEC.ASM
   943                                  ;=============================================================================
   944                                  
   945                                  ; EQUATES
   946                                  
   947                                  ;Codec registers.
   948                                  ;
   949                                  ;Not all codecs are created equal. Refer to the spec for your specific codec.
   950                                  ;
   951                                  ;All registers are 16bits wide.  Access to codec registers over the AC97 link
   952                                  ;is defined by the OEM.  
   953                                  ;
   954                                  ;Secondary codec's are accessed by ORing in BIT7 of all register accesses.
   955                                  ;
   956                                  
   957                                  ; each codec/mixer register is 16bits
   958                                  
   959                                  CODEC_RESET_REG                 equ     00      ; reset codec
   960                                  CODEC_MASTER_VOL_REG            equ     02      ; master volume
   961                                  CODEC_HP_VOL_REG                equ     04      ; headphone volume
   962                                  CODEC_MASTER_MONO_VOL_REG       equ     06      ; master mono volume
   963                                  CODEC_MASTER_TONE_REG           equ     08      ; master tone (R+L)
   964                                  CODEC_PCBEEP_VOL_REG            equ     0ah     ; PC beep volume
   965                                  CODEC_PHONE_VOL_REG             equ     0bh     ; phone volume
   966                                  CODEC_MIC_VOL_REG               equ     0eh     ; MIC volume
   967                                  CODEC_LINE_IN_VOL_REG           equ     10h     ; line input volume
   968                                  CODEC_CD_VOL_REG                equ     12h     ; CD volume
   969                                  CODEC_VID_VOL_REG               equ     14h     ; video volume
   970                                  CODEC_AUX_VOL_REG               equ     16h     ; aux volume
   971                                  CODEC_PCM_OUT_REG               equ     18h     ; PCM output volume
   972                                  CODEC_RECORD_SELECT_REG         equ     1ah     ; record select input
   973                                  CODEC_RECORD_VOL_REG            equ     1ch     ; record volume
   974                                  CODEC_RECORD_MIC_VOL_REG        equ     1eh     ; record mic volume
   975                                  CODEC_GP_REG                    equ     20h     ; general purpose
   976                                  CODEC_3D_CONTROL_REG            equ     22h     ; 3D control
   977                                  ; 24h is reserved
   978                                  CODEC_POWER_CTRL_REG            equ     26h     ; powerdown control
   979                                  CODEC_EXT_AUDIO_REG             equ     28h     ; extended audio
   980                                  CODEC_EXT_AUDIO_CTRL_REG        equ     2ah     ; extended audio control
   981                                  CODEC_PCM_FRONT_DACRATE_REG     equ     2ch     ; PCM out sample rate
   982                                  CODEC_PCM_SURND_DACRATE_REG     equ     2eh     ; surround sound sample rate
   983                                  CODEC_PCM_LFE_DACRATE_REG       equ     30h     ; LFE sample rate
   984                                  CODEC_LR_ADCRATE_REG            equ     32h     ; PCM in sample rate
   985                                  CODEC_MIC_ADCRATE_REG           equ     34h     ; mic in sample rate
   986                                  
   987                                  ; registers 36-7a are reserved on the ICH
   988                                  
   989                                  CODEC_VENDORID1_REG             equ     7ch     ; codec vendor ID 1
   990                                  CODEC_VENDORID2_REG             equ     7eh     ; codec vendor ID 2
   991                                  
   992                                  ; Mixer registers 0 through 51h reside in the ICH and are not forwarded over
   993                                  ; the AC97 link to the codec, which I think is a little weird.  Looks like
   994                                  ; the ICH makes it so you don't need a fully functional codec to play audio?
   995                                  ;
   996                                  ; whenever 2 codecs are present in the system, use BIT7 to access the 2nd
   997                                  ; set of registers, ie 80h-feh
   998                                  
   999                                  PRIMARY_CODEC                   equ     0       ; 0-7F for primary codec
  1000                                  SECONDARY_CODEC                 equ     BIT7    ; 80-8f registers for 2ndary
  1001                                  
  1002                                  SAMPLE_RATE_441khz	equ     44100   ; 44.1Khz (cd quality) rate
  1003                                  
  1004                                  ; ----------------------------------------------------------------------------
  1005                                  ; 17/02/2017
  1006                                  PCI_IO_BASE	equ 10h			; = NAMBAR register offset
  1007                                  AC97_INT_LINE   equ 3Ch			; AC97 Interrupt Line register offset
  1008                                  
  1009                                  ; ----------------------------------------------------------------------------
  1010                                  ; ICH2AC97.INC
  1011                                  ; ----------------------------------------------------------------------------
  1012                                  
  1013                                  ; PCI stuff
  1014                                  
  1015                                  ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
  1016                                  
  1017                                  INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
  1018                                  
  1019                                  ; 08/05/2024
  1020                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
  1021                                  SIS_VID		equ	1039h
  1022                                  NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
  1023                                  AMD_VID		equ	1022h
  1024                                  
  1025                                  ICH_DID         equ     2415h           ; ICH device ID
  1026                                  ICH0_DID        equ     2425h           ; ICH0
  1027                                  ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
  1028                                                                          ; they all should be compatible.
  1029                                  ; 08/05/2024
  1030                                  ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
  1031                                  ICH3_DID	equ     2485h           ; ICH3
  1032                                  ICH4_DID        equ     24C5h           ; ICH4
  1033                                  ICH5_DID	equ     24D5h           ; ICH5 
  1034                                  ICH6_DID	equ     266Eh           ; ICH6
  1035                                  ESB6300_DID	equ     25A6h           ; 6300ESB
  1036                                  ESB631X_DID	equ     2698h           ; 631XESB
  1037                                  ICH7_DID	equ	27DEh		; ICH7
  1038                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
  1039                                  MX82440_DID	equ	7195h
  1040                                  SI7012_DID	equ	7012h
  1041                                  NFORCE_DID	equ	01B1h
  1042                                  NFORCE2_DID	equ	006Ah
  1043                                  AMD8111_DID	equ	746Dh
  1044                                  AMD768_DID	equ	7445h
  1045                                  ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
  1046                                  CK804_DID	equ	0059h
  1047                                  MCP04_DID	equ	003Ah
  1048                                  CK8_DID		equ	008Ah
  1049                                  NFORCE3_DID	equ	00DAh
  1050                                  CK8S_DID	equ	00EAh
  1051                                  
  1052                                  NAMBAR_REG      equ     10h             ; native audio mixer BAR
  1053                                   NAM_SIZE       equ     256             ; 256 bytes required.
  1054                                  
  1055                                  NABMBAR_REG     equ     14h             ; native audio bus mastering BAR
  1056                                   NABM_SIZE      equ     64              ; 64 bytes
  1057                                  
  1058                                  ; BUS master registers, accessed via NABMBAR+offset
  1059                                  
  1060                                  ; ICH supports 3 different types of register sets for three types of things
  1061                                  ; it can do, thus:
  1062                                  ;
  1063                                  ; PCM in (for recording) aka PI
  1064                                  ; PCM out (for playback) aka PO
  1065                                  ; MIC in (for recording) aka MC
  1066                                  
  1067                                  PI_BDBAR_REG            equ     0       ; PCM in buffer descriptor BAR
  1068                                  PO_BDBAR_REG            equ     10h     ; PCM out buffer descriptor BAR
  1069                                  MC_BDBAR_REG            equ     20h     ; MIC in buffer descriptor BAR
  1070                                  
  1071                                  ; each buffer descriptor BAR holds a pointer which has entries to the buffer
  1072                                  ; contents of the .WAV file we're going to play.  Each entry is 8 bytes long
  1073                                  ; (more on that later) and can contain 32 entries total, so each BAR is
  1074                                  ; 256 bytes in length, thus:
  1075                                  
  1076                                  BDL_SIZE                equ     32*8    ; Buffer Descriptor List size
  1077                                  INDEX_MASK              equ     31      ; indexes must be 0-31
  1078                                  
  1079                                  
  1080                                  
  1081                                  PI_CIV_REG              equ     4       ; PCM in current Index value (RO)
  1082                                  PO_CIV_REG              equ     14h     ; PCM out current Index value (RO)
  1083                                  MC_CIV_REG              equ     24h     ; MIC in current Index value (RO)
  1084                                  ;8bit read only
  1085                                  ; each current index value is simply a pointer showing us which buffer
  1086                                  ; (0-31) the codec is currently processing.  Once this counter hits 31, it
  1087                                  ; wraps back to 0.
  1088                                  ; this can be handy to know, as once it hits 31, we're almost out of data to
  1089                                  ; play back or room to record!
  1090                                  
  1091                                  
  1092                                  PI_LVI_REG              equ     5       ; PCM in Last Valid Index
  1093                                  PO_LVI_REG              equ     15h     ; PCM out Last Valid Index
  1094                                  MC_LVI_REG              equ     25h     ; MIC in Last Valid Index
  1095                                  ;8bit read/write
  1096                                  ; The Last Valid Index is a number (0-31) to let the codec know what buffer
  1097                                  ; number to stop on after processing.  It could be very nasty to play audio
  1098                                  ; from buffers that aren't filled with the audio we want to play.
  1099                                  
  1100                                  
  1101                                  PI_SR_REG               equ     6       ; PCM in Status register
  1102                                  PO_SR_REG               equ     16h     ; PCM out Status register
  1103                                  MC_SR_REG               equ     26h     ; MIC in Status register
  1104                                  ;16bit read/write
  1105                                  ; status registers.  Bitfields follow:
  1106                                  
  1107                                  FIFO_ERR                equ     BIT4    ; FIFO Over/Underrun W1TC.
  1108                                  
  1109                                  BCIS                    equ     BIT3    ; buffer completion interrupt status.
  1110                                                                          ; Set whenever the last sample in ANY
  1111                                                                          ; buffer is finished.  Bit is only
  1112                                                                          ; set when the Interrupt on Complete
  1113                                                                          ; (BIT4 of control reg) is set.
  1114                                  
  1115                                  LVBCI                   equ     BIT2    ; Set whenever the codec has processed
  1116                                                                          ; the last buffer in the buffer list.
  1117                                                                          ; Will fire an interrupt if IOC bit is
  1118                                                                          ; set. Probably set after the last
  1119                                                                          ; sample in the last buffer is
  1120                                                                          ; processed.  W1TC
  1121                                  
  1122                                                                          ; 
  1123                                  CELV                    equ     BIT1    ; Current buffer == last valid.
  1124                                                                          ; Bit is RO and remains set until LVI is
  1125                                                                          ; cleared.  Probably set up the start
  1126                                                                          ; of processing for the last buffer.
  1127                                  
  1128                                  
  1129                                  DCH                     equ     BIT0    ; DMA controller halted.
  1130                                                                          ; set whenever audio stream is stopped
  1131                                                                          ; or something else goes wrong.
  1132                                  
  1133                                  PI_PICB_REG             equ     8       ; PCM in position in current buffer(RO)
  1134                                  PO_PICB_REG             equ     18h     ; PCM out position in current buffer(RO)
  1135                                  MC_PICB_REG             equ     28h     ; MIC in position in current buffer (RO)
  1136                                  ;16bit read only
  1137                                  ; position in current buffer regs show the number of dwords left to be
  1138                                  ; processed in the current buffer.
  1139                                  ; 
  1140                                  
  1141                                  PI_PIV_REG              equ     0ah     ; PCM in Prefected index value
  1142                                  PO_PIV_REG              equ     1ah     ; PCM out Prefected index value
  1143                                  MC_PIV_REG              equ     2ah     ; MIC in Prefected index value
  1144                                  ;8bit, read only
  1145                                  ; Prefetched index value register.
  1146                                  ; tells which buffer number (0-31) has be prefetched.  I'd imagine this
  1147                                  ; value follows the current index value fairly closely. (CIV+1)
  1148                                  ;
  1149                                  
  1150                                  PI_CR_REG               equ     0bh     ; PCM in Control Register
  1151                                  PO_CR_REG               equ     1bh     ; PCM out Control Register
  1152                                  MC_CR_REG               equ     2bh     ; MIC in Control Register
  1153                                  ; 8bit
  1154                                  ; Control register *MUST* only be accessed as an 8bit value.
  1155                                  ; Control register.  See bitfields below.
  1156                                  ;
  1157                                  
  1158                                  IOCE                    equ     BIT4    ; interrupt on complete enable.
  1159                                                                          ; set this bit if you want an intrtpt
  1160                                                                          ; to fire whenever LVBCI is set.
  1161                                  FEIFE                   equ     BIT3    ; set if you want an interrupt to fire
  1162                                                                          ; whenever there is a FIFO (over or
  1163                                                                          ; under) error.
  1164                                  LVBIE                   equ     BIT2    ; last valid buffer interrupt enable.
  1165                                                                          ; set if you want an interrupt to fire
  1166                                                                          ; whenever the completion of the last
  1167                                                                          ; valid buffer.
  1168                                  RR                      equ     BIT1    ; reset registers.  Nukes all regs
  1169                                                                          ; except bits 4:2 of this register.
  1170                                                                          ; Only set this bit if BIT 0 is 0
  1171                                  RPBM                    equ     BIT0    ; Run/Pause
  1172                                                                          ; set this bit to start the codec!
  1173                                  
  1174                                  
  1175                                  GLOB_CNT_REG            equ     2ch     ; Global control register
  1176                                  SEC_RES_EN              equ     BIT5    ; secondary codec resume event 
  1177                                                                          ; interrupt enable.  Not used here.
  1178                                  PRI_RES_EN              equ     BIT4    ; ditto for primary. Not used here.
  1179                                  ACLINK_OFF              equ     BIT3    ; Turn off the AC97 link
  1180                                  ACWARM_RESET            equ     BIT2    ; Awaken the AC97 link from sleep.
  1181                                                                          ; registers preserved, bit self clears
  1182                                  ACCOLD_RESET            equ     BIT1    ; Reset everything in the AC97 and
  1183                                                                          ; reset all registers.  Not self clearing
  1184                                  
  1185                                  GPIIE                   equ     BIT0    ; GPI Interrupt enable.
  1186                                                                          ; set if you want an interrupt to
  1187                                                                          ; fire upon ANY of the bits in the
  1188                                                                          ; GPI (general pursose inputs?) not used.
  1189                                  
  1190                                  GLOB_STS_REG            equ     30h     ; Global Status register (RO)
  1191                                  
  1192                                  MD3                     equ     BIT17   ; modem powerdown status (yawn)
  1193                                  AD3                     equ     BIT16   ; Audio powerdown status (yawn)
  1194                                  RD_COMPLETE_STS         equ     BIT15   ; Codec read timed out. 0=normal
  1195                                  BIT3SLOT12              equ     BIT14   ; shadowed status of bit 3 in slot 12
  1196                                  BIT2SLOT12              equ     BIT13   ; shadowed status of bit 2 in slot 12
  1197                                  BIT1SLOT12              equ     BIT12   ; shadowed status of bit 1 in slot 12
  1198                                  SEC_RESUME_STS          equ     BIT11   ; secondary codec has resumed (and irqed)
  1199                                  PRI_RESUME_STS          equ     BIT10   ; primary codec has resumed (and irqed)
  1200                                  SEC_CODEC_RDY           equ     BIT9    ; secondary codec is ready for action
  1201                                  PRI_CODEC_RDY           equ     BIT8    ; Primary codec is ready for action
  1202                                                                          ; software must check these bits before
  1203                                                                          ; starting the codec!
  1204                                  MIC_IN_IRQ              equ     BIT7    ; MIC in caused an interrupt
  1205                                  PCM_OUT_IRQ             equ     BIT6    ; One of the PCM out channels IRQed
  1206                                  PCM_IN_IRQ              equ     BIT5    ; One of the PCM in channels IRQed
  1207                                  MODEM_OUT_IRQ           equ     BIT2    ; modem out channel IRQed
  1208                                  MODEM_IN_IRQ            equ     BIT1    ; modem in channel IRQed
  1209                                  GPI_STS_CHANGE          equ     BIT0    ; set whenever GPI's have changed.
  1210                                                                          ; BIT0 of slot 12 also reflects this.
  1211                                  
  1212                                  
  1213                                  ACC_SEMA_REG            equ     34h     ; Codec write semiphore register
  1214                                  CODEC_BUSY              equ     BIT0    ; codec register I/O is happening
  1215                                                                          ; self clearing
  1216                                  ;
  1217                                  ; Buffer Descriptors List
  1218                                  ; As stated earlier, each buffer descriptor list is a set of (up to) 32
  1219                                  ; descriptors, each 8 bytes in length.  Bytes 0-3 of a descriptor entry point
  1220                                  ; to a chunk of memory to either play from or record to.  Bytes 4-7 of an
  1221                                  ; entry describe various control things detailed below.
  1222                                  ; 
  1223                                  ; Buffer pointers must always be aligned on a Dword boundry.
  1224                                  ;
  1225                                  ;
  1226                                  
  1227                                  IOC                     equ     BIT31   ; Fire an interrupt whenever this
  1228                                                                          ; buffer is complete.
  1229                                  
  1230                                  BUP                     equ     BIT30   ; Buffer Underrun Policy.
  1231                                                                          ; if this buffer is the last buffer
  1232                                                                          ; in a playback, fill the remaining
  1233                                                                          ; samples with 0 (silence) or not.
  1234                                                                          ; It's a good idea to set this to 1
  1235                                                                          ; for the last buffer in playback,
  1236                                                                          ; otherwise you're likely to get a lot
  1237                                                                          ; of noise at the end of the sound.
  1238                                  
  1239                                  ;
  1240                                  ; Bits 15:0 contain the length of the buffer, in number of samples, which
  1241                                  ; are 16 bits each, coupled in left and right pairs, or 32bits each.
  1242                                  ; Luckily for us, that's the same format as .wav files.
  1243                                  ;
  1244                                  ; A value of FFFF is 65536 samples.  Running at 44.1Khz, that's just about
  1245                                  ; 1.5 seconds of sample time.  FFFF * 32bits is 1FFFFh bytes or 128k of data.
  1246                                  ;
  1247                                  ; A value of 0 in these bits means play no samples.
  1248                                  ;
  1249                                  
  1250                                  ; CODE
  1251                                  
  1252                                  ; AC97.ASM
  1253                                  
  1254                                  ; codec configuration code.  Not much here really.
  1255                                  ; NASM version: Erdogan Tan (29/11/2016)
  1256                                  
  1257                                  ; enable codec, unmute stuff, set output rate to 44.1
  1258                                  ; entry: ax = desired sample rate
  1259                                  ;
  1260                                  	
  1261                                  	; 15/05/2024
  1262                                  	; 12/05/2024
  1263                                  	; 08/05/2024
  1264                                  	; (ac97_vra.asm, 19/11/2023, Erdogan Tan, playwav3.asm)
  1265                                  codecConfig:
  1266                                  	; 02/12/2023
  1267                                  	; 26/11/2023
  1268                                  	; 21/11/2023
  1269                                  	; 20/11/2023
  1270                                  	; 19/11/2023 (TRDOS 386 v2.0.7)
  1271                                  	; 15/11/2023
  1272                                  	; 04/11/2023
  1273                                  	; 17/02/2017 
  1274                                  	; 07/11/2016 (Erdogan Tan)
  1275                                  	;PORT_NABM_GLB_CTRL_STAT equ 60h
  1276                                  
  1277                                  	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
  1278                                   	; 'AC97_DEF.H'
  1279                                  	;AC97_EXTENDED_STATUS equ 002Ah
  1280                                  	AC97_EA_SPDIF	equ 0002h
  1281                                  	AC97_EA_VRA	equ 0001h
  1282                                  	; 04/11/2023
  1283                                  	ICH_PO_CR_RESET equ 0002h  ; reset codec
  1284                                  	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
  1285                                  	ICH_PCM_246_MASK equ 300000h ; 6 channels
  1286                                  
  1287                                  	; 08/05/2024
  1288                                  	; 11/11/2023
  1289                                  	CTRL_ST_CREADY	equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
  1290                                  	CODEC_REG_POWERDOWN equ	26h
  1291                                  
  1292                                  	; 04/11/2023
  1293                                  init_ac97_controller:
  1294 000002E3 66A1[6610]              	mov	eax, [bus_dev_fn]
  1295 000002E7 B004                    	mov	al, PCI_CMD_REG
  1296 000002E9 E828FF                  	call	pciRegRead16		; read PCI command register
  1297 000002EC 80CA05                  	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
  1298 000002EF E894FF                  	call	pciRegWrite16
  1299                                  
  1300                                  	; 14/05/2024
  1301                                  	; 02/12/2023
  1302 000002F2 E8A301                  	call	delay_100ms ; 29/05/2017
  1303                                  
  1304                                  	; 02/12/2023
  1305                                  	;call	delay1_4ms
  1306                                  	;call	delay1_4ms
  1307                                  	;call	delay1_4ms
  1308                                  	;call	delay1_4ms
  1309                                  
  1310                                  init_ac97_codec:
  1311                                  	; 18/11/2023
  1312 000002F5 BD2800                  	mov	bp, 40
  1313                                  	; 14/05/2024
  1314                                  	;mov	bp, 100
  1315                                  _initc_1:
  1316                                  	; 11/11/2023
  1317                                  	; (TRDOS 386 v2.0.5, 'audio.s')
  1318 000002F8 BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1319 000002FB 0316[5210]              	add	dx, [NABMBAR]
  1320 000002FF 66ED                    	in	eax, dx
  1321                                  
  1322                                  	; 02/12/2023
  1323 00000301 E85D09                  	call	delay1_4ms
  1324                                  
  1325                                  	; ?
  1326                                  	;; 15/11/2023
  1327                                  	;;mov	cx, 40
  1328                                  	;mov	bp, 40 ; 18/11/2023
  1329                                  ;_initc_1:
  1330 00000304 BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1331 00000307 0316[5210]              	add	dx, [NABMBAR]
  1332 0000030B 66ED                    	in	eax, dx
  1333                                  
  1334                                  	; 02/12/2023
  1335 0000030D E85109                  	call	delay1_4ms
  1336                                  
  1337 00000310 6683F8FF                	cmp	eax, 0FFFFFFFFh ; -1
  1338                                  	;je	short init_ac97_codec_err1
  1339                                  	; 15/11/2023
  1340 00000314 7508                    	jne	short _initc_3
  1341                                  _initc_2:
  1342                                  	;dec	cx
  1343 00000316 4D                      	dec	bp	; 18/11/2023
  1344                                  	;jz	short init_ac97_codec_err1
  1345                                  	; 19/11/2023
  1346 00000317 7412                    	jz	short _ac97_codec_ready
  1347                                  
  1348 00000319 E87C01                  	call	delay_100ms
  1349 0000031C EBDA                    	jmp	short _initc_1
  1350                                  _initc_3:
  1351 0000031E 66A900030010            	test	eax, CTRL_ST_CREADY
  1352 00000324 7505                    	jnz	short _ac97_codec_ready
  1353                                  
  1354 00000326 E8EF00                  	call	reset_ac97_codec
  1355                                  	; 11/11/2023
  1356                                  	;jc	short init_ac97_codec_err2
  1357                                  	; 15/11/2023
  1358                                  	;jc	short _initc_2
  1359                                  	; 26/11/2023
  1360 00000329 EBEB                    	jmp	short _initc_2
  1361                                  
  1362                                  _ac97_codec_ready:
  1363 0000032B 8B16[5010]              	mov	dx, [NAMBAR]
  1364                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  1365 0000032F EF                      	out	dx, ax
  1366                                  
  1367 00000330 E86501                  	call	delay_100ms
  1368                                  
  1369                                  	; 19/11/2023
  1370 00000333 09ED                    	or	bp, bp
  1371 00000335 7522                    	jnz	short _ac97_codec_init_ok
  1372                                  
  1373 00000337 6631C0                  	xor	eax, eax ; 0
  1374 0000033A 8B16[5010]              	mov	dx, [NAMBAR]
  1375 0000033E 83C226                  	add	dx, CODEC_REG_POWERDOWN
  1376 00000341 EF                      	out	dx, ax
  1377                                  	
  1378                                  	; 19/11/2023
  1379                                  	; wait for 1 second
  1380                                  	; 15/05/2024
  1381 00000342 66B9E8030000            	mov	ecx, 1000 ; 1000*4*0.25ms = 1s
  1382                                  	;mov	cx, 10
  1383                                  _ac97_codec_rloop:
  1384                                  	;call	delay1_4ms
  1385                                  	;call	delay1_4ms
  1386                                  	;call	delay1_4ms
  1387                                  	;call	delay1_4ms
  1388 00000348 E84D01                  	call	delay_100ms
  1389                                  
  1390                                  	;mov	dx, [NAMBAR]
  1391                                  	;add	dx, CODEC_REG_POWERDOWN
  1392 0000034B ED                      	in	ax, dx
  1393                                  
  1394                                  	; 14/05/2024
  1395                                  	; 02/12/2023
  1396 0000034C E81209                  	call	delay1_4ms
  1397                                  	
  1398 0000034F 83E00F                  	and	ax, 0Fh
  1399 00000352 3C0F                    	cmp	al, 0Fh
  1400 00000354 7403                    	je	short _ac97_codec_init_ok
  1401 00000356 E2F0                    	loop	_ac97_codec_rloop 
  1402                                  
  1403                                  	; 12/05/2024
  1404                                  	; cf = 1
  1405                                  init_ac97_codec_err1:
  1406                                  	;stc	; 12/05/2024
  1407                                  init_ac97_codec_err2:
  1408 00000358 C3                      	retn
  1409                                  
  1410                                  _ac97_codec_init_ok:
  1411                                          ; 11/11/2023
  1412                                  	;mov	al, 2 ; force set 16-bit 2-channel PCM
  1413                                  	;mov	dx, GLOB_CNT_REG ; 2Ch
  1414                                  	;add	dx, [NABMBAR]
  1415                                  	;out	dx, eax
  1416                                  
  1417                                  	;;call	delay1_4ms
  1418                                  
  1419 00000359 E87500                  	call 	reset_ac97_controller
  1420                                  
  1421                                  	; 11/11/2023
  1422                                  	;call	delay1_4ms
  1423                                  	; 21/11/2023 - temporary
  1424 0000035C E83901                  	call	delay_100ms
  1425                                  
  1426                                  	;call 	setup_ac97_codec
  1427                                  
  1428                                  setup_ac97_codec:
  1429                                  	; 08/05/2028
  1430                                  	; [sample_rate] = 22050
  1431                                  	; 12/11/2023
  1432                                  	;cmp	word [sample_rate], 48000
  1433                                  	;je	short skip_rate
  1434                                  
  1435                                  ; 11/11/2023
  1436                                  ; 05/11/2023
  1437                                  ;%if 1
  1438                                  	AC97_EA_VRA equ BIT0 ; 11/11/2023
  1439                                  
  1440                                  	; 16/05/2024
  1441 0000035F 8B16[5010]              	mov	dx, [NAMBAR]
  1442 00000363 83C228                  	add	dx, CODEC_EXT_AUDIO_REG	; 28h
  1443 00000366 ED                      	in	ax, dx
  1444                                  
  1445                                  	; 16/05/2024
  1446 00000367 E8F708                  	call	delay1_4ms
  1447                                  
  1448                                  	; 14/05/2024
  1449 0000036A A801                    	test	al, 1 ; BIT0 ; Variable Rate Audio bit
  1450 0000036C 741D                    	jz	short vra_not_supported
  1451                                  
  1452                                  	; 11/11/2023
  1453 0000036E 8B16[5010]              	mov    	dx, [NAMBAR]
  1454 00000372 83C22A                  	add    	dx, CODEC_EXT_AUDIO_CTRL_REG ; 2Ah
  1455 00000375 ED                      	in     	ax, dx
  1456                                  
  1457                                  	; 14/05/2024
  1458                                  	; 02/12/2023
  1459 00000376 E8E808                  	call	delay1_4ms
  1460                                  
  1461 00000379 24FD                    	and	al, ~BIT1 ; Clear DRA
  1462 0000037B 0C01                    	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
  1463 0000037D EF                      	out	dx, ax			; Enable variable rate audio
  1464                                  	
  1465 0000037E B90A00                  	mov	cx, 10
  1466                                  check_vra:
  1467 00000381 E81401                  	call	delay_100ms
  1468                                  
  1469                                  	; 11/11/2023
  1470 00000384 ED                      	in	ax, dx
  1471 00000385 A801                    	test	al, AC97_EA_VRA ; 1
  1472 00000387 750A                    	jnz	short set_rate
  1473                                  
  1474                                  	; 11/11/2023
  1475 00000389 E2F6                    	loop	check_vra
  1476                                  
  1477                                  	; 13/11/2023
  1478                                  	;mov	byte [VRA], 0
  1479                                  vra_not_supported:
  1480                                  	; 08/05/2024
  1481 0000038B C706[B08D]80BB          	mov	word [sample_rate], 48000
  1482 00000391 EB0E                    	jmp	short skip_rate	
  1483                                  
  1484                                  	; 12/11/2023
  1485                                  	;pop	ax ; discard return address to the caller
  1486                                  	;mov	dx, msg_no_vra
  1487                                  	;jmp	vra_err
  1488                                  
  1489                                  set_rate:
  1490 00000393 A1[B08D]                	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
  1491                                  	; 08/05/2024
  1492                                  	; ax = 22050 (Hz)
  1493                                  
  1494 00000396 8B16[5010]              	mov    	dx, [NAMBAR]               	
  1495 0000039A 83C22C                  	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch
  1496 0000039D EF                      	out	dx, ax 			; PCM Front/Center Output Sample Rate
  1497                                  
  1498 0000039E E8F700                  	call	delay_100ms
  1499                                  
  1500                                  	; 12/11/2023
  1501                                  skip_rate:
  1502                                  	; 11/11/2023 (temporary)
  1503                                  
  1504                                  	;mov   	dx, [NAMBAR]
  1505                                  	;add   	dx, CODEC_PCM_SURND_DACRATE_REG	; 2Eh
  1506                                  	;out	dx, ax 			; PCM Surround Output Sample Rate
  1507                                  
  1508                                  	;call	delay_100ms
  1509                                  
  1510                                  	;mov   	dx, [NAMBAR]
  1511                                  	;add   	dx, CODEC_PCM_LFE_DACRATE_REG	; 30h
  1512                                  	;out	dx, ax 			; PCM LFE Output Sample Rate
  1513                                  
  1514                                  	;call	delay_100ms
  1515                                  
  1516                                  	; 05/11/2023 (temporary)
  1517                                  	;mov	dx, [NAMBAR]
  1518                                  	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h
  1519                                  	;out	dx, ax 			; PCM Input Sample Rate
  1520                                  	;
  1521                                  	;call	delay_100ms
  1522                                  
  1523 000003A1 B80202                  	mov	ax, 0202h
  1524 000003A4 A2[6F10]                	mov	[volume], al ; 29
  1525 000003A7 8B16[5010]              	mov     dx, [NAMBAR]
  1526 000003AB 83C202                    	add     dx, CODEC_MASTER_VOL_REG	; 02h
  1527 000003AE EF                      	out     dx, ax
  1528                                  
  1529                                  	; 11/11/2023
  1530                                          ;call	delay1_4ms
  1531                                          ;call	delay1_4ms
  1532                                          ;call	delay1_4ms
  1533                                          ;call	delay1_4ms
  1534                                   	;
  1535                                    	;mov	dx, [NAMBAR]
  1536                                    	;add	dx, CODEC_MASTER_MONO_VOL_REG	; 06h
  1537                                    	;out	dx, ax
  1538                                  
  1539                                  	; 11/11/2023
  1540                                          ;call	delay1_4ms
  1541                                          ;call	delay1_4ms
  1542                                          ;call	delay1_4ms
  1543                                          ;call	delay1_4ms
  1544                                  	;
  1545                                  	;mov	ax, 02h
  1546                                    	;mov	dx, [NAMBAR]
  1547                                    	;add	dx, CODEC_PCBEEP_VOL_REG	; 0Ah
  1548                                    	;out	dx, ax
  1549                                  
  1550                                  	; 14/05/2024
  1551                                  	; 20/11/2023
  1552 000003AF E8AF08                          call	delay1_4ms
  1553 000003B2 E8AC08                          call	delay1_4ms
  1554 000003B5 E8A908                          call	delay1_4ms
  1555 000003B8 E8A608                          call	delay1_4ms
  1556                                  
  1557                                  	; 21/11/2023 temporary
  1558                                  	;call	delay_100ms
  1559                                  
  1560                                  	;mov	ax, 0202h
  1561 000003BB 8B16[5010]                	mov     dx, [NAMBAR]
  1562 000003BF 83C218                    	add     dx, CODEC_PCM_OUT_REG		; 18h
  1563 000003C2 EF                        	out     dx, ax
  1564                                  
  1565                                  	; 14/05/2024
  1566                                  	; 20/11/2023
  1567 000003C3 E89B08                          call	delay1_4ms
  1568 000003C6 E89808                          call	delay1_4ms
  1569 000003C9 E89508                          call	delay1_4ms
  1570 000003CC E89208                          call	delay1_4ms
  1571                                  
  1572                                  	; 14/05/2024
  1573                                  	; 21/11/2023 - temporary
  1574                                  	;call	delay_100ms
  1575                                  
  1576                                  	; 11/11/2023
  1577                                  	;mov	ax, 8008h ; Mute
  1578                                    	;mov	dx, [NAMBAR]
  1579                                  	;add	dx, CODEC_PHONE_VOL_REG		; 0Ch
  1580                                  	;			 ; AC97_PHONE_VOL ; TAD Input (Mono)
  1581                                    	;out	dx, ax
  1582                                  	;
  1583                                          ;call	delay1_4ms
  1584                                          ;call	delay1_4ms
  1585                                          ;call	delay1_4ms
  1586                                  	;call	delay1_4ms
  1587                                  
  1588                                  	;mov	ax, 0808h
  1589                                  	;mov	dx, [NAMBAR]
  1590                                  	;add	dx, CODEC_LINE_IN_VOL_REG ;10h ; Line Input (Stereo)
  1591                                  	;out	dx, ax
  1592                                  	;
  1593                                          ;call	delay1_4ms
  1594                                          ;call	delay1_4ms
  1595                                          ;call	delay1_4ms
  1596                                  	;call	delay1_4ms
  1597                                  
  1598                                    	;mov	dx, [NAMBAR]
  1599                                          ;add	dx, CODEC_CD_VOL_REG ;12h ; CD Input (Stereo)
  1600                                    	;out	dx, ax
  1601                                  	;
  1602                                    	;mov	dx, [NAMBAR]
  1603                                          ;add	dx, CODEC_AUX_VOL_REG ;16h ; Aux Input (Stereo)
  1604                                    	;out	dx, ax
  1605                                  	;
  1606                                          ;call	delay1_4ms
  1607                                          ;call	delay1_4ms
  1608                                          ;call	delay1_4ms
  1609                                  	;call	delay1_4ms
  1610                                  
  1611                                  	; 14/05/2024
  1612                                  	;call	delay_100ms
  1613                                  
  1614                                  	; 14/05/2024
  1615 000003CF F8                      	clc
  1616                                  
  1617                                  ;detect_ac97_codec:
  1618 000003D0 C3                              retn
  1619                                  
  1620                                  reset_ac97_controller:
  1621                                  	; 11/11/2023
  1622                                  	; 10/06/2017
  1623                                  	; 29/05/2017
  1624                                  	; 28/05/2017
  1625                                  	; reset AC97 audio controller registers
  1626 000003D1 31C0                    	xor     ax, ax
  1627 000003D3 BA0B00                          mov	dx, PI_CR_REG
  1628 000003D6 0316[5210]              	add	dx, [NABMBAR]
  1629 000003DA EE                      	out     dx, al
  1630                                  
  1631                                  	; 14/05/2024
  1632 000003DB E88308                  	call	delay1_4ms
  1633                                  
  1634 000003DE BA1B00                          mov     dx, PO_CR_REG
  1635 000003E1 0316[5210]              	add	dx, [NABMBAR]
  1636 000003E5 EE                      	out     dx, al
  1637                                  
  1638                                  	; 14/05/2024
  1639 000003E6 E87808                  	call	delay1_4ms
  1640                                  
  1641 000003E9 BA2B00                          mov     dx, MC_CR_REG
  1642 000003EC 0316[5210]              	add	dx, [NABMBAR]
  1643 000003F0 EE                      	out     dx, al
  1644                                  
  1645                                  	; 14/05/2024
  1646 000003F1 E86D08                  	call	delay1_4ms
  1647                                  
  1648 000003F4 B002                            mov     al, RR
  1649 000003F6 BA0B00                          mov     dx, PI_CR_REG
  1650 000003F9 0316[5210]              	add	dx, [NABMBAR]
  1651 000003FD EE                      	out     dx, al
  1652                                  
  1653                                  	; 14/05/2024
  1654 000003FE E86008                  	call	delay1_4ms
  1655                                  
  1656 00000401 BA1B00                          mov     dx, PO_CR_REG
  1657 00000404 0316[5210]              	add	dx, [NABMBAR]
  1658 00000408 EE                      	out     dx, al
  1659                                  
  1660                                  	; 14/05/2024
  1661 00000409 E85508                  	call	delay1_4ms
  1662                                  
  1663 0000040C BA2B00                          mov     dx, MC_CR_REG
  1664 0000040F 0316[5210]              	add	dx, [NABMBAR]
  1665 00000413 EE                      	out     dx, al
  1666                                  
  1667                                  	; 14/05/2024
  1668 00000414 E84A08                  	call	delay1_4ms
  1669                                  
  1670 00000417 C3                      	retn
  1671                                  
  1672                                  reset_ac97_codec:
  1673                                  	; 11/11/2023
  1674                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1675 00000418 BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1676 0000041B 0316[5210]              	add	dx, [NABMBAR]
  1677 0000041F 66ED                    	in	eax, dx
  1678                                  
  1679                                  	;test	eax, 2
  1680                                  	; 06/08/2022
  1681 00000421 A802                    	test	al, 2
  1682 00000423 7405                    	jz	short _r_ac97codec_cold	
  1683                                  
  1684 00000425 E80E00                  	call	warm_ac97codec_reset
  1685 00000428 7306                    	jnc	short _r_ac97codec_ok
  1686                                  _r_ac97codec_cold:
  1687 0000042A E83400                          call    cold_ac97codec_reset
  1688 0000042D 7301                            jnc     short _r_ac97codec_ok
  1689                                  	
  1690                                  	; 16/04/2017
  1691                                          ;xor	eax, eax	; timeout error
  1692                                         	;stc
  1693 0000042F C3                      	retn
  1694                                  
  1695                                  _r_ac97codec_ok:
  1696 00000430 6631C0                          xor     eax, eax
  1697                                          ;mov	al, VIA_ACLINK_C00_READY ; 1
  1698 00000433 FEC0                            inc	al
  1699 00000435 C3                      	retn
  1700                                  
  1701                                  warm_ac97codec_reset:
  1702                                  	; 11/11/2023
  1703                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  1704                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1705 00000436 66B806000000            	mov	eax, 6
  1706 0000043C BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1707 0000043F 0316[5210]              	add	dx, [NABMBAR]
  1708 00000443 66EF                    	out	dx, eax
  1709                                  
  1710 00000445 B90A00                  	mov	cx, 10	; total 1s
  1711                                  _warm_ac97c_rst_wait:
  1712 00000448 E84D00                  	call	delay_100ms
  1713                                  
  1714 0000044B BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1715 0000044E 0316[5210]              	add	dx, [NABMBAR]
  1716 00000452 66ED                    	in	eax, dx
  1717                                  
  1718 00000454 66A900030010            	test	eax, CTRL_ST_CREADY
  1719 0000045A 7504                    	jnz	short _warm_ac97c_rst_ok
  1720                                  
  1721 0000045C 49                              dec     cx
  1722 0000045D 75E9                            jnz     short _warm_ac97c_rst_wait
  1723                                  
  1724                                  _warm_ac97c_rst_fail:
  1725 0000045F F9                              stc
  1726                                  _warm_ac97c_rst_ok:
  1727 00000460 C3                      	retn
  1728                                  
  1729                                  cold_ac97codec_reset:
  1730                                  	; 11/11/2023
  1731                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  1732                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1733 00000461 66B802000000                    mov	eax, 2
  1734 00000467 BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1735 0000046A 0316[5210]              	add	dx, [NABMBAR]
  1736 0000046E 66EF                    	out	dx, eax
  1737                                  
  1738 00000470 E82500                  	call	delay_100ms 	; wait 100 ms
  1739 00000473 E82200                  	call	delay_100ms 	; wait 100 ms
  1740 00000476 E81F00                  	call	delay_100ms 	; wait 100 ms
  1741 00000479 E81C00                  	call	delay_100ms 	; wait 100 ms
  1742                                  
  1743 0000047C B91000                  	mov	cx, 16	; total 20*100 ms = 2s
  1744                                  
  1745                                  _cold_ac97c_rst_wait:
  1746 0000047F BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1747 00000482 0316[5210]              	add	dx, [NABMBAR]
  1748 00000486 66ED                    	in	eax, dx
  1749                                  
  1750 00000488 66A900030010            	test	eax, CTRL_ST_CREADY
  1751 0000048E 7507                    	jnz	short _cold_ac97c_rst_ok
  1752                                  
  1753 00000490 E80500                  	call	delay_100ms
  1754                                  
  1755 00000493 49                              dec     cx
  1756 00000494 75E9                            jnz     short _cold_ac97c_rst_wait
  1757                                  
  1758                                  _cold_ac97c_rst_fail:
  1759 00000496 F9                              stc
  1760                                  _cold_ac97c_rst_ok:
  1761 00000497 C3                      	retn
  1762                                  
  1763                                  delay_100ms:
  1764                                  	; 11/11/2023
  1765                                  	; 29/05/2017
  1766                                  	; 24/03/2017 ('codec.asm')
  1767                                  	; wait 100 ms
  1768 00000498 51                      	push	cx
  1769 00000499 B99001                  	mov	cx, 400  ; 400*0.25ms
  1770                                  _delay_x_ms:
  1771 0000049C E8C207                  	call	delay1_4ms
  1772 0000049F E2FB                            loop	_delay_x_ms
  1773 000004A1 59                      	pop	cx
  1774 000004A2 C3                      	retn
  1775                                  
  1776                                  ;=============================================================================
  1777                                  ;               ICH_WAV.ASM
  1778                                  ;=============================================================================
  1779                                  
  1780                                  ; DOS based .WAV player using AC'97 and codec interface.
  1781                                  ; ---------------------------------------------------------------
  1782                                  ; NASM version: Erdogan Tan (29/11/2016)
  1783                                  ; Last Update: 17/02/2017 (by Erdogan Tan)
  1784                                  
  1785                                  ; ICHWAV.ASM
  1786                                  ; PLAYMOD.ASM
  1787                                  ; player internal variables and other equates.
  1788                                  ;BUFFERSIZE	equ	2048*4		; 8K half buffer size. 18/02/2017
  1789                                  ; 15/05/2024
  1790                                  ;BUFFERSIZE	equ	2560*4
  1791                                  ; 16/05/2024
  1792                                  BUFFERSIZE	equ	3840*4
  1793                                  ;ENDOFFILE	equ	BIT0		; flag for knowing end of file
  1794                                  
  1795                                  ;===========================================================================
  1796                                  ; entry: none.  File is already open and [filehandle] filled.
  1797                                  ; exit:  not until the song is finished or the user aborts.
  1798                                  ;
  1799                                  ; 18/02/2017
  1800                                  ModPlay: ; 13/02/2017  ; ModPlay Polling!
  1801                                  	;cld
  1802                                  	; clear (half) buffer 2
  1803                                         	;mov	di, [DMA_BUFFER2]
  1804                                  	;sub	ax, ax
  1805                                  	;mov	cx, (BUFFERSIZE/2)
  1806                                  	;rep	stosw
  1807                                  
  1808                                  	; 15/05/2024
  1809 000004A3 06                      	push	es
  1810 000004A4 1E                      	push	ds
  1811 000004A5 07                      	pop	es
  1812 000004A6 B94001                  	mov	cx, 320
  1813 000004A9 BF[82EC]                	mov	di, MOD_BUFFER
  1814 000004AC B88080                  	mov	ax, 8080h
  1815 000004AF F3AB                    	rep	stosw
  1816 000004B1 B900A0                  	mov	cx, 0A000h
  1817 000004B4 8EC1                    	mov	es, cx
  1818 000004B6 E8FF00                  	call	ScopeLoop
  1819 000004B9 07                      	pop	es
  1820                                  	
  1821                                          ; load 2048 bytes into buffer 1
  1822 000004BA 8B36[6010]              	mov	si, [DMA_BUFFER1]
  1823                                  	; 11/05/2024
  1824                                  	;mov	cx, BUFFERSIZE
  1825                                  	;push	ds ; segment
  1826                                  	;push	si ; offset
  1827                                  	;push	cx ; count
  1828 000004BE E87A06                  	call    GetSamples_ICH ; 18/02/2017
  1829                                  
  1830                                          ; load 2048 bytes into buffer  2
  1831 000004C1 8B36[6210]              	mov	si, [DMA_BUFFER2]
  1832                                  	; 11/05/2024
  1833                                  	;mov	cx, BUFFERSIZE
  1834                                  	;push	ds ; segment
  1835                                  	;push	si ; offset
  1836                                  	;push	cx ; count
  1837 000004C5 E87306                  	call	GetSamples_ICH ; 18/02/2017
  1838                                  
  1839                                  ; register reset the DMA engine. This may cause a pop noise on the output
  1840                                  ; lines when the device is reset. Prolly a better idea to mute output, then
  1841                                  ; reset.
  1842                                  
  1843                                  	; 08/05/2024
  1844                                          ;mov    dx, [NABMBAR]
  1845                                          ;add    dx, PO_CR_REG		; set pointer to Ctrl reg
  1846                                          ;mov    al, RR			; set reset
  1847                                  	;out    dx, al			; self clearing bit
  1848                                  
  1849                                  ; write last valid index to 31 to start with.
  1850                                  ; The Last Valid Index register tells the DMA engine when to stop playing.
  1851                                  ; 
  1852                                  ; As we progress through the song we change the last valid index to always be
  1853                                  ; something other than the index we're currently playing.
  1854                                  ;
  1855                                          ;;mov   al, 1
  1856                                          ;mov	al, 31
  1857                                  	;call   setLastValidIndex
  1858                                  
  1859                                  ; create Buffer Descriptor List
  1860                                  ;
  1861                                  ; A buffer descriptor list is a list of pointers and control bits that the
  1862                                  ; DMA engine uses to know where to get the .wav data and how to play it.
  1863                                  ;
  1864                                  ; I set it up to use only 2 buffers of .wav data, and whenever 1 buffer is
  1865                                  ; playing, I refresh the other one with good data.
  1866                                  ;
  1867                                  ;
  1868                                  ; For the control bits, you can specify that the DMA engine fire an interrupt
  1869                                  ; after a buffer has been processed, but I poll the current index register
  1870                                  ; to know when it's safe to update the other buffer.
  1871                                  ;
  1872                                  ; I set the BUP bit, which tells the DMA engine to just play 0's (silence)
  1873                                  ; if it ever runs out of data to play. Good for safety.
  1874                                  ;
  1875                                  	; 14/02/2017
  1876 000004C8 8B3E[5E10]                      mov     di, [BDL_BUFFER]		; get BDL address
  1877 000004CC B91000                          mov     cx, 32 / 2                      ; make 32 entries in BDL
  1878 000004CF 6631D2                  	xor	edx, edx
  1879 000004D2 8CDA                    	mov	dx, ds
  1880 000004D4 66C1E204                	shl	edx, 4 ; segment*16 (linear/physical address of the segment)
  1881                                  _0:
  1882                                  
  1883                                  ; set buffer descriptor 0 to start of data file in memory
  1884                                  	; 14/02/2017
  1885 000004D8 660FB706[6010]                  movzx   eax, word [DMA_BUFFER1]
  1886 000004DE 6601D0                  	add	eax, edx ; linear/physical address of the buffer (seg*16+off)
  1887 000004E1 66AB                            stosd					; store dmabuffer1 address
  1888                                  
  1889                                  ;
  1890                                  ; set length to 32k samples. 1 sample is 16bits or 2bytes.
  1891                                  ; Set control (bits 31:16) to BUP, bits 15:0=number of samples.
  1892                                  ; 
  1893                                  
  1894                                  ; 17/02/2017 (Erdogan Tan)
  1895                                  ; Intel 82801AA (ICH) & Intel 82801AB (ICH0) I/O Controller Hub AC 97
  1896                                  ; Programmers Reference Manual
  1897                                  
  1898                                  ; 2.2.1 Buffer Descriptor List  (on Page 13)
  1899                                  	;
  1900                                  	;  Generic Form of Buffer Descriptor
  1901                                  	;  ---------------------------------
  1902                                  	;  63   62    61-48    47-32   31-0
  1903                                  	;  ---  ---  --------  ------- -----
  1904                                  	;  IOC  BUP -reserved- Buffer  Buffer
  1905                                  	;		      Length   Pointer
  1906                                  	;		      [15:0]   [31:0]
  1907                                  	;
  1908                                  	;  IOC:	Interrupt On Completion. 
  1909                                  	;	1 = Enabled. 
  1910                                  	;	    When this is set, it means that the controller should
  1911                                  	;	    issue an interrupt upon completion of this buffer.
  1912                                  	;	    It should also set the IOC bit in the status register
  1913                                  	;	0 = Disabled	
  1914                                  	;
  1915                                  	;  BUP: Buffer Underrun Policy.
  1916                                  	;       0 = When this buffer is complete,
  1917                                  	;	    if the next buffer is not yet ready 
  1918                                  	;	    (i.e., the last valid buffer has been processed),
  1919                                  	;	    then continue to transmit the last valid sample.
  1920                                  	;	1 = When this buffer is complete,
  1921                                  	;     	    if this is the last valid buffer, transmit zeros after
  1922                                  	;	    this buffer has been processed completely.
  1923                                  	;	    This bit typically is set only if this is the last 
  1924                                  	;	    buffer in the current stream.
  1925                                  	;
  1926                                  	; [31:0]: Buffer pointer. This field points to the location of
  1927                                  	;	  the data buffer. Since samples can be as wide as one
  1928                                  	;	  word, the buffer must be aligned with word boundaries,
  1929                                  	;	  to prevent samples from straddling DWord boundaries.
  1930                                  	;
  1931                                  	; [15:0]: Buffer Length: This is the length of the data buffer,
  1932                                  	;	  in number of samples. The controller uses this data
  1933                                  	;	  to determine the length of the buffer, in bytes.
  1934                                  	;	  "0" indicates no sample to process.
  1935                                  
  1936                                  ; ICH2AC97.INC
  1937                                  
  1938                                  ;	IOC	equ     BIT31   ; Fire an interrupt whenever this
  1939                                  				; buffer is complete.
  1940                                  
  1941                                  ;	BUP	equ     BIT30   ; Buffer Underrun Policy.
  1942                                  				; if this buffer is the last buffer
  1943                                  				; in a playback, fill the remaining
  1944                                  				; samples with 0 (silence) or not.
  1945                                  				; It's a good idea to set this to 1
  1946                                  				; for the last buffer in playback,
  1947                                  				; otherwise you're likely to get a lot
  1948                                  				; of noise at the end of the sound.
  1949                                  ;
  1950                                  ; Bits 15:0 contain the length of the buffer, in number of samples, which
  1951                                  ; are 16 bits each, coupled in left and right pairs, or 32bits each.
  1952                                  ; Luckily for us, that's the same format as .wav files.
  1953                                  ;
  1954                                  ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
  1955                                  ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
  1956                                  ;
  1957                                  ; A value of 0 in these bits means play no samples.
  1958                                  ;
  1959                                  	; 08/12/2016 - Erdogan Tan
  1960                                  	;mov	eax, BUFFERSIZE
  1961                                  	; 12/05/2024
  1962 000004E3 66B8001E0000            	mov	eax, BUFFERSIZE/2
  1963 000004E9 660D000000C0            	or	eax, IOC + BUP
  1964 000004EF 66AB                    	stosd
  1965                                  
  1966                                  ; 2nd buffer:
  1967                                  	; 14/02/2017
  1968 000004F1 660FB706[6210]                  movzx   eax, word [DMA_BUFFER2]
  1969 000004F7 6601D0                  	add	eax, edx ; linear/physical address of the buffer (seg*16+off)
  1970 000004FA 66AB                            stosd					; store dmabuffer2 address
  1971                                  
  1972                                  ; set length to 64k (32k of two 16 bit samples)
  1973                                  ; Set control (bits 31:16) to BUP, bits 15:0=number of samples
  1974                                  ; 
  1975                                  	; 08/12/2016 - Erdogan Tan
  1976                                  	;mov	eax, BUFFERSIZE
  1977                                  	; 12/05/2024
  1978 000004FC 66B8001E0000            	mov	eax, BUFFERSIZE/2
  1979 00000502 660D000000C0            	or	eax, IOC + BUP
  1980 00000508 66AB                    	stosd
  1981 0000050A E2CC                            loop    _0
  1982                                  ;
  1983                                  ; tell the DMA engine where to find our list of Buffer Descriptors.
  1984                                  ; this 32bit value is a flat mode memory offset (ie no segment:offset)
  1985                                  ;
  1986                                  ; write NABMBAR+10h with offset of buffer descriptor list
  1987                                  ;
  1988 0000050C 660FB706[5E10]                  movzx   eax, word [BDL_BUFFER]
  1989                                  	; 14/02/2017
  1990 00000512 6601D0                  	add	eax, edx ; linear/physical address of the BDL
  1991                                    	; 18/02/2017
  1992 00000515 8B16[5210]                      mov     dx, [NABMBAR]
  1993 00000519 83C210                          add     dx, PO_BDBAR_REG                ; set pointer to BDL
  1994 0000051C 66EF                            out     dx, eax                         ; write to AC97 controller
  1995                                  
  1996                                  	; 15/05/2024
  1997 0000051E E84007                  	call	delay1_4ms
  1998                                  ;
  1999                                  ; All set. Let's play some music.
  2000                                  ;
  2001                                  	; 08/12/2016
  2002                                  	; 07/10/2016
  2003                                          ;mov    al, 1
  2004 00000521 B01F                            mov	al, 31
  2005                                  
  2006                                  	; 13/05/2024
  2007                                  	; 08/05/2024
  2008                                  	;mov	[LVI], al ; 10/11/2023
  2009                                  	;call   setLastValidIndex
  2010                                  
  2011                                  	;input AL = index # to stop on
  2012                                  setLastValidIndex:
  2013 00000523 8B16[5210]              	mov	dx, [NABMBAR]
  2014 00000527 83C215                  	add	dx, PO_LVI_REG
  2015 0000052A EE                              out     dx, al
  2016                                  
  2017 0000052B C606[5710]01            	mov	byte [tLoop], 1 ; 30/11/2016
  2018                                  
  2019                                  	; 15/05/2024
  2020 00000530 E82E07                  	call	delay1_4ms
  2021                                  
  2022                                  	; 12/05/2024	
  2023                                  	; 17/02/2017
  2024 00000533 8B16[5210]                      mov	dx, [NABMBAR]
  2025 00000537 83C21B                          add	dx, PO_CR_REG			; PCM out Control Register
  2026 0000053A B011                            mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
  2027                                  				; (LVBI interrupt will not be enabled)
  2028 0000053C EE                              out	dx, al				; Start bus master operation.
  2029                                  
  2030                                  	; 15/05/2024
  2031 0000053D E82107                  	call	delay1_4ms
  2032 00000540 E81E07                  	call	delay1_4ms
  2033 00000543 E81B07                  	call	delay1_4ms
  2034 00000546 E81807                  	call	delay1_4ms
  2035                                  
  2036                                  ; while DMA engine is running, examine current index and wait until it hits 1
  2037                                  ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
  2038                                  ; 64k.  Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
  2039                                     
  2040                                  	; 18/02/2017
  2041                                  	; 14/02/2017
  2042                                  	; 13/02/2017
  2043                                  	; 08/12/2016
  2044                                  	; 28/11/2016
  2045                                  
  2046 00000549 06                      	push	es
  2047 0000054A B800A0                  	mov	ax, 0A000h
  2048 0000054D 8EC0                    	mov	es, ax
  2049                                  	;mov	bp, DmaBuffer ; 14/02/2017
  2050                                  p_loop:
  2051 0000054F B401                    	mov     ah, 1			; any key pressed?
  2052                                  	;mov	ah, 11h
  2053 00000551 CD16                    	int     16h			; no, Loop.
  2054 00000553 7445                    	jz	short q_loop
  2055                                  
  2056 00000555 B400                    	mov	ah, 0
  2057                                  	;mov    ah, 10h			; flush key buffer...
  2058 00000557 CD16                    	int     16h
  2059                                  
  2060                                  	; 12/05/2024 (change PCM out volume)
  2061 00000559 3C2B                    	cmp	al, '+'
  2062 0000055B 750B                    	jne	short p_1
  2063                                  	
  2064 0000055D A0[6F10]                	mov	al, [volume]
  2065 00000560 3C00                    	cmp	al, 0
  2066 00000562 7636                    	jna	short q_loop
  2067 00000564 FEC8                    	dec	al
  2068 00000566 EB0D                    	jmp	short p_2
  2069                                  p_1:
  2070 00000568 3C2D                    	cmp	al, '-'
  2071 0000056A 7524                    	jne	short p_return
  2072                                  
  2073 0000056C A0[6F10]                	mov	al, [volume]
  2074 0000056F 3C1F                    	cmp	al, 31
  2075 00000571 7327                    	jnb	short q_loop
  2076 00000573 FEC0                    	inc	al
  2077                                  p_2:
  2078 00000575 A2[6F10]                	mov	[volume], al
  2079 00000578 88C4                    	mov	ah, al
  2080 0000057A 8B16[5010]              	mov     dx, [NAMBAR]
  2081                                    	;add    dx, CODEC_MASTER_VOL_REG
  2082 0000057E 83C218                  	add	dx, CODEC_PCM_OUT_REG
  2083 00000581 EF                      	out     dx, ax
  2084                                  
  2085                                  	; 12/05/2024
  2086 00000582 E8DC06                  	call    delay1_4ms
  2087 00000585 E8D906                          call    delay1_4ms
  2088 00000588 E8D606                          call    delay1_4ms
  2089 0000058B E8D306                          call    delay1_4ms
  2090                                  
  2091 0000058E EB0A                    	jmp	short q_loop
  2092                                  
  2093                                  p_return:
  2094 00000590 C606[5710]00            	mov	byte [tLoop], 0	; 13/02/2017
  2095                                  	; 16/05/2024
  2096 00000595 E8A206                  	call	StopPlaying
  2097 00000598 07                      	pop	es
  2098 00000599 C3                      	retn
  2099                                  
  2100                                  q_loop:
  2101                                  	; 10/05/2024
  2102 0000059A 31C0                    	xor	ax, ax
  2103 0000059C 8606[5410]              	xchg	al, [tBuff] ; AL = [tBuff], [tBuff] = 0
  2104 000005A0 3C01                    	cmp	al, 1
  2105 000005A2 7708                    	ja	short r_loop
  2106                                  	;jb	short ScopeLoop
  2107                                  	; 15/05/2024
  2108 000005A4 720D                    	jb	short x_loop
  2109                                  	;
  2110 000005A6 8B36[6010]                   	mov	si, [DMA_BUFFER1] ; [tBuff]=1 (from tuneLoop)
  2111 000005AA EB04                           	jmp	short s_loop 
  2112                                  r_loop:
  2113                                  	; 13/02/2017
  2114 000005AC 8B36[6210]                      mov     si, [DMA_BUFFER2] ; [tBuff]=2 (from tuneLoop)
  2115                                  s_loop:
  2116                                  	; 14/02/2017
  2117                                  	;mov	bp, si ; save current buffer addres in bp register
  2118                                  	; 11/05/2024
  2119                                  	;mov	cx, BUFFERSIZE ; 2048*4 byte
  2120                                  	;push	ds ; segment
  2121                                  	;push	si ; offset
  2122                                  	;push	cx ; count
  2123 000005B0 E88805                  	call    GetSamples_ICH ; 18/02/2017
  2124                                  
  2125                                  	; 15/05/2024
  2126                                  x_loop:
  2127 000005B3 E80200                  	call	ScopeLoop
  2128 000005B6 EB97                    	jmp	short p_loop
  2129                                  
  2130                                  ScopeLoop:
  2131                                  	;mov    si, bp			; get current samples
  2132 000005B8 BE[82EC]                	mov	si, MOD_BUFFER ; 18/02/2017
  2133 000005BB 31C9                    	xor     cx, cx			; to be drawed ...
  2134 000005BD 31D2                    	xor     dx, dx
  2135                                  DrawLoop:       
  2136 000005BF 89D3                    	mov     bx, dx			; (save Index)
  2137 000005C1 8BBF[00E8]              	mov     di, [Scope+bx]		; get old SCOPE pixel address
  2138 000005C5 26C60500                	mov     byte [es:di], 0		; erase it!
  2139 000005C9 AC                      	lodsb				; get a sample (8-bit)
  2140 000005CA 88C3                    	mov     bl, al			; calc new pixel address...
  2141 000005CC 30FF                    	xor     bh, bh
  2142 000005CE D1E3                    	shl     bx, 1
  2143 000005D0 8BBF[80EA]              	mov     di, [RowOfs+bx]
  2144 000005D4 01CF                    	add     di, cx
  2145 000005D6 89D3                    	mov     bx, dx			; (restore Index)
  2146 000005D8 89BF[00E8]              	mov     [Scope+bx], di		; save new address...
  2147 000005DC 26C6050A                	mov     byte [es:di], 10 ; 0Ah	; and DRAW.
  2148 000005E0 83C202                  	add     dx, 2			; the next pixel...
  2149 000005E3 41                      	inc     cx
  2150 000005E4 81F94001                	cmp     cx, 320			; 320 pixels drawed?
  2151 000005E8 72D5                    	jb      short DrawLoop
  2152                                  	; 15/05/2024
  2153                                  	;jmp	p_loop
  2154 000005EA C3                      	retn
  2155                                  
  2156                                  ; 13/05/2024
  2157                                  %if 0
  2158                                  
  2159                                  tuneLoop:
  2160                                  	; 11/05/2024
  2161                                  	; 11/11/2023
  2162                                  	; 10/11/2023
  2163                                  	; 18/02/2017
  2164                                  	; 08/12/2016
  2165                                  	; 28/11/2016 - Erdogan Tan
  2166                                  
  2167                                  	; 11/05/2024
  2168                                  	cmp	byte [tLoop], 1
  2169                                  	jb	short tL3
  2170                                  	
  2171                                  	call    getCurrentIndex
  2172                                  
  2173                                  	; 10/11/2023
  2174                                  	cmp	al, [LVI]
  2175                                  	jne	short tL1
  2176                                  
  2177                                  	dec	ax
  2178                                  	and	al, 1Fh 
  2179                                  	call	setLastValidIndex
  2180                                  	xchg	al, [LVI]
  2181                                  tL1:
  2182                                  	test	al, BIT0
  2183                                  	jz	short tL2
  2184                                  
  2185                                  	; 11/05/2024
  2186                                  	mov	byte [tBuff], 1
  2187                                  	retn
  2188                                  tL2:	
  2189                                  	mov	byte [tBuff], 2
  2190                                  tL3:
  2191                                  	retn
  2192                                  
  2193                                  ; returns AL = current index value
  2194                                  getCurrentIndex:
  2195                                  	;push	dx
  2196                                  	mov	dx, [NABMBAR]
  2197                                  	add	dx, PO_CIV_REG
  2198                                  	in	al, dx
  2199                                  	;pop	dx
  2200                                  	retn
  2201                                  
  2202                                  ;input AL = index # to stop on
  2203                                  setLastValidIndex:
  2204                                  	;push	dx
  2205                                  	mov	dx, [NABMBAR]
  2206                                  	add	dx, PO_LVI_REG
  2207                                          out     dx, al
  2208                                  	;pop	dx
  2209                                  	retn
  2210                                  
  2211                                  %endif
  2212                                  
  2213                                  ;=============================================================================
  2214                                  ;               MODLOAD.ASM
  2215                                  ;=============================================================================
  2216                                  
  2217                                  ; Amiga Module Loader v0.1b by Carlos Hasan.
  2218                                  ;		July 10th, 1993.
  2219                                  
  2220                                  ; STRUCTURES
  2221                                  
  2222                                  struc ModSample
  2223 00000000 <res 16h>               .msName:	resb 22
  2224 00000016 ????                    .msLength:	resw 1
  2225 00000018 ??                      .msFinetune:	resb 1
  2226 00000019 ??                      .msVolume:	resb 1
  2227 0000001A ????                    .msRepeat:	resw 1
  2228 0000001C ????                    .msRepLen:	resw 1
  2229                                  .size:
  2230                                  endstruc
  2231                                  
  2232                                  struc ModHeader
  2233 00000000 <res 14h>               .mhName:	resb 20
  2234 00000014 <res 3A2h>              .mhSamples:	resb ModSample.size*31
  2235 000003B6 ??                      .mhOrderLen:	resb 1
  2236 000003B7 ??                      .mhReStart:	resb 1
  2237 000003B8 <res 80h>               .mhOrder:	resb 128
  2238 00000438 ????????                .mhSign:	resw 2
  2239                                  .size:	
  2240                                  endstruc
  2241                                  
  2242                                  struc ModInfoRec
  2243 00000000 ??                      .OrderLen:	resb 1
  2244 00000001 ??                      .ReStart:	resb 1
  2245 00000002 <res 80h>               .Order:		resb 128
  2246 00000082 ????????                .Patterns:	resd 1
  2247 00000086 <res 3Eh>               .SampOfs:	resw 31
  2248 000000C4 <res 3Eh>               .SampSeg:	resw 31
  2249 00000102 <res 3Eh>               .SampLen:	resw 31
  2250 00000140 <res 3Eh>               .SampRep:	resw 31
  2251 0000017E <res 3Eh>               .SampRepLen:	resw 31
  2252 000001BC <res 3Eh>               .SampVol:	resw 31
  2253                                  .size:	
  2254                                  endstruc
  2255                                  
  2256                                  ; CODE
  2257                                  
  2258                                  LoadModule:
  2259                                  		;es:di = filename
  2260                                  
  2261                                  		;[sp+4] = es
  2262                                  		;[sp+2] = di
  2263                                  
  2264                                  		FileName equ 4
  2265                                  
  2266 000005EB 55                      		push    bp
  2267 000005EC 89E5                    		mov     bp, sp
  2268 000005EE 60                      		pusha
  2269 000005EF 1E                      		push    ds
  2270 000005F0 06                      		push    es
  2271                                  
  2272 000005F1 C706[7289]0100          		mov	word [ErrorInfo], 1
  2273                                  
  2274 000005F7 E85101                  		call    ClearModInfo
  2275                                  OpenFile:       
  2276 000005FA 1E                      		push    ds
  2277 000005FB B8003D                  		mov     ax, 3D00h
  2278 000005FE C55604                  		lds     dx, [bp+FileName]
  2279 00000601 CD21                    		int     21h
  2280 00000603 1F                      		pop     ds
  2281 00000604 0F823C01                		jc      Failed
  2282 00000608 A3[7089]                		mov     [FileHandle], ax
  2283                                  
  2284                                  ReadHeader:     
  2285 0000060B B8003F                  		mov     ax, 3F00h
  2286 0000060E 8B1E[7089]              		mov     bx, [FileHandle]
  2287 00000612 B93C04                  		mov     cx, ModHeader.size
  2288                                  		;lea    dx, [Header]
  2289 00000615 BA[7489]                		mov	dx, Header
  2290 00000618 CD21                    		int     21h
  2291 0000061A 0F821D01                		jc      CloseFile
  2292                                  CheckMK:        
  2293 0000061E 813E[AC8D]4D2E          		cmp     word [Header+ModHeader.mhSign], 'M.'
  2294 00000624 7508                    		jne     short CheckFLT4
  2295 00000626 813E[AE8D]4B2E          		cmp     word [Header+ModHeader.mhSign+2], 'K.'
  2296 0000062C 7439                    		je      short IsModFile
  2297                                  CheckFLT4:
  2298 0000062E 813E[AC8D]464C          		cmp     word [Header+ModHeader.mhSign], 'FL'
  2299 00000634 7508                    		jne     short Is15Inst
  2300 00000636 813E[AE8D]5434          		cmp     word [Header+ModHeader.mhSign+2], 'T4'
  2301 0000063C 7429                    		je      short IsModFile
  2302                                  Is15Inst:
  2303 0000063E BE[4A8B]                		mov     si, (Header+ModHeader.mhSamples) + (15*ModSample.size)
  2304 00000641 BF[2A8D]                		mov     di, Header+ModHeader.mhOrderLen
  2305 00000644 8CD8                    		mov     ax, ds
  2306 00000646 8EC0                    		mov     es, ax
  2307 00000648 FC                      		cld
  2308 00000649 B98200                  		mov     cx, 130
  2309 0000064C F3A4                    		rep     movsb
  2310 0000064E BF[4A8B]                		mov     di, Header+ModHeader.mhSamples + (15*ModSample.size)
  2311 00000651 31C0                    		xor     ax, ax
  2312 00000653 B9E001                  		mov     cx, 16*ModSample.size
  2313 00000656 F3AA                    		rep     stosb
  2314                                  SeekPatterns:   
  2315 00000658 B80042                  		mov     ax, 4200h
  2316 0000065B 8B1E[7089]              		mov     bx, [FileHandle]
  2317 0000065F B90000                  		mov     cx, 0
  2318 00000662 BA5802                  		mov     dx, 600
  2319 00000665 CD21                    		int     21h
  2320                                  IsModFile:  
  2321 00000667 A0[2A8D]                		mov     al, [Header+ModHeader.mhOrderLen]
  2322 0000066A A2[B28D]                		mov     [ModInfo.OrderLen], al
  2323                                  
  2324 0000066D A0[2B8D]                		mov     al, [Header+ModHeader.mhReStart]
  2325 00000670 3A06[2A8D]              		cmp     al, [Header+ModHeader.mhOrderLen]
  2326 00000674 7202                    		jb      short SetReStart
  2327 00000676 B07F                    		mov     al, 7Fh
  2328                                  SetReStart:
  2329 00000678 A2[B38D]                		mov     [ModInfo.ReStart], al
  2330                                  
  2331 0000067B B98000                  		mov     cx, 128
  2332 0000067E 31C0                    		xor     ax, ax
  2333 00000680 31DB                    		xor     bx, bx
  2334                                  CopyOrder:
  2335 00000682 8AA7[2C8D]              		mov     ah, [Header+ModHeader.mhOrder+bx]
  2336 00000686 88A7[B48D]              		mov     [ModInfo.Order+bx], ah
  2337 0000068A 38C4                    		cmp     ah, al
  2338 0000068C 7202                    		jb      short NextOrder
  2339 0000068E 88E0                    		mov     al, ah
  2340                                  NextOrder:
  2341 00000690 43                      		inc     bx
  2342 00000691 E2EF                    		loop    CopyOrder
  2343                                  AllocPatterns:  
  2344                                  		; Erdogan Tan (13/02/2017)
  2345 00000693 30E4                    		xor	ah, ah
  2346 00000695 FEC0                    		inc	al
  2347                                  		; al = count of 1024 bytes
  2348 00000697 89C3                    		mov	bx, ax
  2349                                  		; count of paragraphs = al*64 
  2350 00000699 C1E006                  		shl	ax, 6 ; *64
  2351 0000069C 89C5                    		mov	bp, ax
  2352 0000069E 8CCA                    		mov	dx, cs ; current (code) segment
  2353 000006A0 81C20010                		add	dx, 1000h ; next 64K (4096*16)
  2354                                  		;
  2355 000006A4 C706[348E]0000          		mov	word [ModInfo.Patterns], 0
  2356 000006AA 8916[368E]              		mov	[ModInfo.Patterns+2], dx
  2357                                  		;
  2358 000006AE 01D5                    		add	bp, dx ; next segment for samples
  2359                                  ReadPatterns:   
  2360 000006B0 1E                      		push    ds
  2361 000006B1 B8003F                  		mov     ax, 3F00h
  2362 000006B4 89D9                    		mov     cx, bx ; count of 1024 bytes
  2363 000006B6 C1E10A                  		shl     cx, 10 ; byte count (cx*1024)
  2364 000006B9 8B1E[7089]              		mov     bx, [FileHandle]
  2365                                  		;lds    dx, [ModInfo.Patterns]
  2366 000006BD 8EDA                    		mov	ds, dx
  2367 000006BF 31D2                    		xor	dx, dx
  2368 000006C1 CD21                    		int     21h
  2369 000006C3 1F                      		pop     ds
  2370 000006C4 7275                    		jc      CloseFile
  2371                                  
  2372                                  		;lea	si, [Header+ModHeader.mhSamples]
  2373 000006C6 BE[8889]                		mov	si, Header+ModHeader.mhSamples
  2374 000006C9 31FF                    		xor     di, di
  2375                                  CopySamples:
  2376 000006CB 8B4416                  		mov     ax, [si+ModSample.msLength]
  2377 000006CE 86C4                    		xchg    al, ah
  2378 000006D0 D1E0                    		shl     ax, 1
  2379 000006D2 8985[B48E]              		mov     [ModInfo.SampLen+di], ax
  2380 000006D6 8A4419                  		mov     al, [si+ModSample.msVolume]
  2381 000006D9 30E4                    		xor     ah, ah
  2382 000006DB 8985[6E8F]              		mov     [ModInfo.SampVol+di], ax
  2383 000006DF 8B441A                  		mov     ax, [si+ModSample.msRepeat]
  2384 000006E2 86C4                    		xchg    al, ah
  2385 000006E4 D1E0                    		shl     ax, 1
  2386 000006E6 8985[F28E]              		mov     [ModInfo.SampRep+di], ax
  2387 000006EA 8B441C                  		mov     ax, [si+ModSample.msRepLen]
  2388 000006ED 86C4                    		xchg    al, ah
  2389 000006EF D1E0                    		shl     ax, 1
  2390 000006F1 8985[308F]              		mov     [ModInfo.SampRepLen+di], ax
  2391 000006F5 83C61E                  		add     si, ModSample.size
  2392 000006F8 83C702                  		add     di, 2
  2393 000006FB 83FF3E                  		cmp     di, 2*31
  2394 000006FE 72CB                    		jb      short CopySamples
  2395                                  
  2396 00000700 31F6                    		xor     si, si
  2397                                  AllocSamples:
  2398                                  		; Erdogan Tan (13/02/2017)
  2399                                  		;mov	bx, [ModInfo.SampLen+si]
  2400 00000702 8B8C[B48E]              		mov	cx, [ModInfo.SampLen+si]
  2401 00000706 89CB                    		mov	bx, cx
  2402 00000708 C1EB04                  		shr     bx, 4 ; byte count / 16
  2403 0000070B 7420                    		jz      short NextSample
  2404 0000070D 43                      		inc	bx ; number of paragraphs
  2405 0000070E C784[388E]0000          		mov	word [ModInfo.SampOfs+si], 0
  2406 00000714 89AC[768E]              		mov     [ModInfo.SampSeg+si], bp
  2407 00000718 89EA                    		mov	dx, bp
  2408 0000071A 01DD                    		add	bp, bx ; next segment for sample 
  2409                                  ReadSample:
  2410 0000071C 1E                      		push    ds
  2411 0000071D B8003F                  		mov     ax, 3F00h
  2412 00000720 8B1E[7089]              		mov     bx, [FileHandle]
  2413                                  		;mov    cx, [ModInfo.SampLen+si]
  2414                                  		;mov    dx, [ModInfo.SampOfs+si]
  2415                                  		;mov    ds, [ModInfo.SampSeg+si]
  2416 00000724 8EDA                    		mov	ds, dx
  2417 00000726 31D2                    		xor	dx, dx
  2418 00000728 CD21                    		int     21h
  2419 0000072A 1F                      		pop     ds
  2420 0000072B 720E                    		jc      short CloseFile
  2421                                  NextSample:
  2422 0000072D 83C602                  		add     si, 2
  2423 00000730 83FE3E                  		cmp     si, 2*31
  2424 00000733 72CD                    		jb      short AllocSamples
  2425                                  
  2426 00000735 C706[7289]0000          		mov     word [ErrorInfo], 0
  2427                                  CloseFile:      
  2428 0000073B B8003E                  		mov     ax, 3E00h
  2429 0000073E 8B1E[7089]              		mov     bx, [FileHandle]
  2430 00000742 CD21                    		int     21h
  2431                                  Failed:         
  2432 00000744 07                      		pop     es
  2433 00000745 1F                      		pop     ds
  2434 00000746 61                      		popa
  2435 00000747 5D                      		pop     bp
  2436 00000748 C20400                  		ret	4
  2437                                  
  2438                                  FreeModule:
  2439                                  		; Erdogan Tan (13/02/2017)
  2440                                  		; nothing to do here for memory de-allocation
  2441                                  ClearModInfo:
  2442 0000074B 60                      		pusha
  2443 0000074C 06                      		push    es
  2444 0000074D 8CD8                    		mov     ax, ds
  2445 0000074F 8EC0                    		mov     es, ax
  2446                                  		;lea    di, [ModInfo]
  2447 00000751 BF[B28D]                		mov	di, ModInfo
  2448 00000754 B9FA01                  		mov     cx, ModInfoRec.size
  2449 00000757 FC                      		cld
  2450 00000758 31C0                    		xor     ax, ax
  2451 0000075A F3AA                    		rep     stosb
  2452 0000075C 07                      		pop     es
  2453 0000075D 61                      		popa
  2454 0000075E C3                      		retn
  2455                                  
  2456                                  ;=============================================================================
  2457                                  ;               MODPLAY.ASM
  2458                                  ;=============================================================================
  2459                                  
  2460                                  ; Amiga Module Player v0.3b by Carlos Hasan.
  2461                                  ;		July 23th, 1993.
  2462                                  
  2463                                  ; EQUATES
  2464                                  
  2465                                  NumTracks       equ 4
  2466                                  DefTempo        equ 6
  2467                                  DefBpm          equ 125
  2468                                  MidCRate        equ 8448
  2469                                  MixBufSize      equ 4096
  2470                                  
  2471                                  ; STRUCTURES
  2472                                  
  2473                                  struc TrackInfo
  2474 00000000 ????????                .Samples:	resd 1
  2475 00000004 ????                    .Position:	resw 1
  2476 00000006 ????                    .Len:		resw 1
  2477 00000008 ????                    .Repeat:	resw 1
  2478 0000000A ????                    .RepLen:	resw 1
  2479 0000000C ??                      .Volume: 	resb 1
  2480 0000000D ??                      .Error:		resb 1
  2481 0000000E ????                    .Period:	resw 1
  2482 00000010 ????                    .Pitch:		resw 1
  2483 00000012 ????                    .Effect:	resw 1
  2484 00000014 ????                    .PortTo:	resw 1
  2485 00000016 ??                      .PortParm:	resb 1
  2486 00000017 ??                      .VibPos:	resb 1
  2487 00000018 ??                      .VibParm:	resb 1
  2488 00000019 ??                      .OldSampOfs:	resb 1
  2489 0000001A ????????????            .Arp:		resw 3
  2490 00000020 ????                    .ArpIndex:	resw 1
  2491                                  .size:
  2492                                  endstruc
  2493                                  
  2494                                  ; CODE
  2495                                  
  2496                                  ;--------------------------------------------------------------------------
  2497                                  ; BeatTrack:  Process the next beat in one track.
  2498                                  ;  In:
  2499                                  ;    ds:di -  Track info Address.
  2500                                  ;--------------------------------------------------------------------------
  2501                                  
  2502                                  BeatTrack:
  2503 0000075F 8B5512                  		mov     dx, [di+TrackInfo.Effect]
  2504 00000762 85D2                    		test    dx, dx
  2505 00000764 7430                    		je      short None
  2506 00000766 80FE00                  		cmp     dh, 00h
  2507 00000769 742C                    		je      short Arpeggio
  2508 0000076B 80FE01                  		cmp     dh, 01h
  2509 0000076E 743E                    		je      short PortUp
  2510 00000770 80FE02                  		cmp     dh, 02h
  2511 00000773 7455                    		je      short PortDown
  2512 00000775 80FE03                  		cmp     dh, 03h
  2513 00000778 746D                    		je      short TonePort
  2514 0000077A 80FE04                  		cmp     dh, 04h
  2515 0000077D 0F849100                		je      Vibrato
  2516 00000781 80FE05                  		cmp     dh, 05h
  2517 00000784 0F84D600                		je      PortSlide
  2518 00000788 80FE06                  		cmp     dh, 06h
  2519 0000078B 0F84D700                		je      VibSlide
  2520 0000078F 80FE0A                  		cmp     dh, 0Ah
  2521 00000792 0F84D800                		je      VolSlide
  2522                                  None:
  2523 00000796 C3                      		retn
  2524                                  Arpeggio:
  2525 00000797 8B5D20                  		mov     bx, [di+TrackInfo.ArpIndex]
  2526 0000079A 8B411A                  		mov     ax, [di+TrackInfo.Arp+bx]
  2527 0000079D 894510                  		mov     [di+TrackInfo.Pitch], ax
  2528 000007A0 83C302                  		add     bx, 2
  2529 000007A3 83FB06                  		cmp     bx, 6
  2530 000007A6 7202                    		jb      short SetArpIndex
  2531 000007A8 31DB                    		xor     bx,bx
  2532                                  SetArpIndex:
  2533 000007AA 895D20                  		mov     [di+TrackInfo.ArpIndex], bx
  2534 000007AD C3                      		retn
  2535                                  PortUp:
  2536 000007AE 30F6                    		xor     dh, dh
  2537 000007B0 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2538 000007B3 29D3                    		sub     bx, dx
  2539 000007B5 83FB71                  		cmp     bx, 113
  2540 000007B8 7D03                    		jge     short NotSmall
  2541 000007BA BB7100                  		mov     bx, 113
  2542                                  NotSmall:
  2543 000007BD 895D0E                  		mov     [di+TrackInfo.Period], bx
  2544 000007C0 01DB                    		add     bx, bx
  2545 000007C2 8B87[AC8F]              		mov     ax, [PitchTable+bx]
  2546 000007C6 894510                  		mov     [di+TrackInfo.Pitch], ax
  2547 000007C9 C3                      		retn
  2548                                  PortDown:
  2549 000007CA 30F6                    		xor     dh, dh
  2550 000007CC 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2551 000007CF 01D3                    		add     bx, dx
  2552 000007D1 81FB5803                		cmp     bx, 856
  2553 000007D5 7E03                    		jle     short NotBig
  2554 000007D7 BB5803                  		mov     bx, 856
  2555 000007DA 895D0E                  NotBig:         mov     [di+TrackInfo.Period], bx
  2556 000007DD 01DB                    		add     bx, bx
  2557 000007DF 8B87[AC8F]              		mov     ax, [PitchTable+bx]
  2558 000007E3 894510                  		mov     [di+TrackInfo.Pitch], ax
  2559 000007E6 C3                      		retn
  2560                                  TonePort:
  2561 000007E7 30F6                    		xor     dh, dh
  2562 000007E9 8B4514                  		mov     ax, [di+TrackInfo.PortTo]
  2563 000007EC 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2564 000007EF 39C3                    		cmp     bx, ax
  2565 000007F1 741E                    		je      short NoPort
  2566 000007F3 7F0A                    		jg      short PortToUp
  2567                                  PortToDown:     
  2568 000007F5 01D3                    		add     bx, dx
  2569 000007F7 39C3                    		cmp     bx, ax
  2570 000007F9 7E0A                    		jle     short SetPort
  2571                                  FixPort:        
  2572 000007FB 89C3                    		mov     bx, ax
  2573 000007FD EB06                    		jmp     short SetPort
  2574                                  PortToUp:
  2575 000007FF 29D3                    		sub     bx, dx
  2576 00000801 39C3                    		cmp     bx, ax
  2577 00000803 7CF6                    		jl      short FixPort
  2578                                  SetPort:
  2579 00000805 895D0E                  		mov     [di+TrackInfo.Period], bx
  2580 00000808 01DB                    		add     bx, bx
  2581 0000080A 8B87[AC8F]              		mov     ax, [PitchTable+bx]
  2582 0000080E 894510                  		mov     [di+TrackInfo.Pitch], ax
  2583                                  NoPort:
  2584 00000811 C3                      		retn
  2585                                  Vibrato:
  2586 00000812 88D6                    		mov     dh, dl
  2587 00000814 80E20F                  		and     dl, 0Fh
  2588 00000817 C0EE04                  		shr     dh, 4
  2589 0000081A C0E602                  		shl     dh, 2
  2590 0000081D 007517                  		add     [di+TrackInfo.VibPos], dh
  2591 00000820 8A7517                  		mov     dh, [di+TrackInfo.VibPos]
  2592 00000823 88F3                    		mov     bl, dh
  2593 00000825 C0EB02                  		shr     bl, 2
  2594 00000828 83E31F                  		and     bx, 1Fh
  2595 0000082B 8A87[D90E]              		mov     al, [SinTable+bx]
  2596 0000082F F6E2                    		mul     dl
  2597 00000831 D1C0                    		rol     ax, 1
  2598 00000833 86C4                    		xchg    al, ah
  2599 00000835 80E401                  		and     ah, 1
  2600 00000838 84F6                    		test    dh, dh
  2601 0000083A 7902                    		jns     short VibUp
  2602 0000083C F7D8                    		neg     ax
  2603                                  VibUp:
  2604 0000083E 03450E                  		add     ax, [di+TrackInfo.Period]
  2605 00000841 89C3                    		mov     bx, ax
  2606 00000843 83FB71                  		cmp     bx, 113
  2607 00000846 7D03                    		jge     short NoLoVib
  2608 00000848 BB7100                  		mov     bx, 113
  2609                                  NoLoVib:
  2610 0000084B 81FB5803                		cmp     bx, 856
  2611 0000084F 7E03                    		jle     short NoHiVib
  2612 00000851 BB5803                  		mov     bx, 856
  2613                                  NoHiVib:
  2614 00000854 01DB                    		add     bx, bx
  2615 00000856 8B87[AC8F]              		mov     ax, [PitchTable+bx]
  2616 0000085A 894510                  		mov     [di+TrackInfo.Pitch], ax
  2617 0000085D C3                      		retn
  2618                                  PortSlide:
  2619 0000085E E80D00                  		call    VolSlide
  2620 00000861 8A5516                  		mov     dl, [di+TrackInfo.PortParm]
  2621 00000864 EB81                    		jmp     short TonePort
  2622                                  VibSlide:
  2623 00000866 E80500                  		call    VolSlide
  2624 00000869 8A5518                  		mov     dl, [di+TrackInfo.VibParm]
  2625 0000086C EBA4                    		jmp     short Vibrato
  2626                                  VolSlide:
  2627 0000086E 88D6                    		mov     dh, dl
  2628 00000870 80E20F                  		and     dl, 0Fh
  2629 00000873 C0EE04                  		shr     dh, 4
  2630 00000876 8A450C                  		mov     al, [di+TrackInfo.Volume]
  2631 00000879 28D0                    		sub     al, dl
  2632 0000087B 7D02                    		jge     short NoLoVol
  2633 0000087D 30C0                    		xor     al, al
  2634                                  NoLoVol:
  2635 0000087F 00F0                    		add     al, dh
  2636 00000881 3C40                    		cmp     al, 64
  2637 00000883 7602                    		jbe     short NoHiVol
  2638 00000885 B040                    		mov     al, 64
  2639                                  NoHiVol:
  2640 00000887 88450C                  		mov     [di+TrackInfo.Volume], al
  2641 0000088A C3                      		retn
  2642                                  
  2643                                  ;--------------------------------------------------------------------------
  2644                                  ; GetTrack:   Get the next Note from a pattern.
  2645                                  ;  In:
  2646                                  ;    ds:di -  Track info Address.
  2647                                  ;    es:si -  Pattern Note Address.
  2648                                  ; Out:
  2649                                  ;    es:si -  The Next Pattern Note address.
  2650                                  ;--------------------------------------------------------------------------
  2651                                  
  2652                                  GetTrack:
  2653 0000088B 26AD                    		es lodsw
  2654 0000088D 86C4                    		xchg    al, ah
  2655 0000088F 88E3                    		mov     bl, ah
  2656 00000891 80E40F                  		and     ah, 0Fh
  2657 00000894 89C1                    		mov     cx, ax
  2658 00000896 26AD                    		es lodsw
  2659 00000898 86C4                    		xchg    al, ah
  2660 0000089A 88E7                    		mov     bh, ah
  2661 0000089C 80E40F                  		and     ah, 0Fh
  2662 0000089F 89C2                    		mov     dx, ax
  2663 000008A1 895512                  		mov     [di+TrackInfo.Effect], dx
  2664 000008A4 80E3F0                  		and     bl, 0F0h
  2665 000008A7 C0EF04                  		shr     bh, 4
  2666 000008AA 08FB                    		or      bl, bh
  2667 000008AC 742E                    		je      short SetPeriod
  2668                                  SetSample:
  2669 000008AE 30FF                    		xor     bh, bh
  2670 000008B0 4B                      		dec     bx
  2671 000008B1 01DB                    		add     bx, bx
  2672 000008B3 8B87[6E8F]              		mov     ax, [ModInfo.SampVol+bx]
  2673 000008B7 88450C                  		mov     [di+TrackInfo.Volume], al
  2674 000008BA 8B87[388E]              		mov     ax, [ModInfo.SampOfs+bx]
  2675 000008BE 8905                    		mov     [di+TrackInfo.Samples], ax
  2676 000008C0 8B87[768E]              		mov     ax, [ModInfo.SampSeg+bx]
  2677 000008C4 894502                  		mov     [di+TrackInfo.Samples+2], ax
  2678 000008C7 8B87[B48E]              		mov     ax, [ModInfo.SampLen+bx]
  2679 000008CB 894506                  		mov     [di+TrackInfo.Len], ax
  2680 000008CE 8B87[F28E]              		mov     ax, [ModInfo.SampRep+bx]
  2681 000008D2 894508                  		mov     [di+TrackInfo.Repeat], ax
  2682 000008D5 8B87[308F]              		mov     ax, [ModInfo.SampRepLen+bx]
  2683 000008D9 89450A                  		mov     [di+TrackInfo.RepLen], ax
  2684                                  SetPeriod:      
  2685 000008DC 85C9                    		test    cx, cx
  2686 000008DE 741B                    		je      short SetEffect
  2687                                  
  2688 000008E0 894D14                  		mov     [di+TrackInfo.PortTo], cx
  2689 000008E3 80FE03                  		cmp     dh, 03h
  2690 000008E6 7413                    		je      short SetEffect
  2691                                  
  2692 000008E8 894D0E                  		mov     [di+TrackInfo.Period], cx
  2693 000008EB 89CB                    		mov     bx, cx
  2694 000008ED 01DB                    		add     bx, bx
  2695 000008EF 8B87[AC8F]              		mov     ax, [PitchTable+bx]
  2696 000008F3 894510                  		mov     [di+TrackInfo.Pitch], ax
  2697 000008F6 C745040000              		mov     word [di+TrackInfo.Position], 0
  2698                                  SetEffect:
  2699 000008FB 85D2                    		test    dx, dx
  2700 000008FD 742A                    		je      short InitNone
  2701 000008FF 80FE00                  		cmp     dh, 00h
  2702 00000902 0F84C400                		je      InitArpeggio
  2703 00000906 80FE03                  		cmp     dh, 03h
  2704 00000909 741F                    		je      short InitTonePort
  2705 0000090B 80FE04                  		cmp     dh, 04h
  2706 0000090E 7428                    		je      short InitVibrato
  2707 00000910 80FE09                  		cmp     dh, 09h
  2708 00000913 744A                    		je      short SampleOfs
  2709 00000915 80FE0B                  		cmp     dh, 0Bh
  2710 00000918 7457                    		je      short PosJump
  2711 0000091A 80FE0C                  		cmp     dh, 0Ch
  2712 0000091D 745C                    		je      short SetVolume
  2713 0000091F 80FE0D                  		cmp     dh, 0Dh
  2714 00000922 7462                    		je      short Break
  2715 00000924 80FE0F                  		cmp     dh, 0Fh
  2716 00000927 7478                    		je      short SetSpeed
  2717                                  InitNone:
  2718 00000929 C3                      		retn
  2719                                  InitTonePort:
  2720 0000092A 84D2                    		test    dl, dl
  2721 0000092C 7503                    		jne     short SetPortParm
  2722 0000092E 8A5516                  		mov     dl, [di+TrackInfo.PortParm]
  2723                                  SetPortParm:
  2724 00000931 885516                  		mov     [di+TrackInfo.PortParm], dl
  2725 00000934 895512                  		mov     [di+TrackInfo.Effect], dx
  2726 00000937 C3                      		retn
  2727                                  InitVibrato:
  2728 00000938 8A4518                  		mov     al, [di+TrackInfo.VibParm]
  2729 0000093B 88C4                    		mov     ah, al
  2730 0000093D 240F                    		and     al, 0Fh
  2731 0000093F 80E4F0                  		and     ah, 0F0h
  2732 00000942 F6C20F                  		test    dl, 0Fh
  2733 00000945 7502                    		jne     short OkDepth
  2734 00000947 08C2                    		or      dl, al
  2735                                  OkDepth:
  2736 00000949 F6C2F0                  		test    dl, 0F0h
  2737 0000094C 7502                    		jne     short OkRate
  2738 0000094E 08E2                    		or      dl, ah
  2739                                  OkRate:
  2740 00000950 885518                  		mov     [di+TrackInfo.VibParm], dl
  2741 00000953 895512                  		mov     [di+TrackInfo.Effect], dx
  2742 00000956 85C9                    		test    cx, cx
  2743 00000958 7404                    		je      short OkPos
  2744 0000095A C6451700                		mov     byte [di+TrackInfo.VibPos], 0
  2745                                  OkPos:
  2746 0000095E C3                      		retn
  2747                                  SampleOfs:      
  2748 0000095F 84D2                    		test    dl, dl
  2749 00000961 7503                    		jne     short SetSampleOfs
  2750 00000963 8A5519                  		mov     dl, [di+TrackInfo.OldSampOfs]
  2751                                  SetSampleOfs:
  2752 00000966 885519                  		mov     [di+TrackInfo.OldSampOfs], dl
  2753 00000969 88D6                    		mov     dh, dl
  2754 0000096B 30D2                    		xor     dl, dl
  2755 0000096D 895504                  		mov     [di+TrackInfo.Position], dx
  2756 00000970 C3                      		retn
  2757                                  PosJump:
  2758 00000971 8816[5EE7]              		mov     [OrderPos], dl
  2759 00000975 C606[62E7]40            		mov     byte [Row], 64
  2760 0000097A C3                      		retn
  2761                                  SetVolume:
  2762 0000097B 80FA40                  		cmp     dl, 64
  2763 0000097E 7602                    		jbe     short OkVol
  2764 00000980 B240                    		mov     dl, 64
  2765                                  OkVol:
  2766 00000982 88550C                  		mov     [di+TrackInfo.Volume], dl
  2767 00000985 C3                      		retn
  2768                                  Break:
  2769 00000986 88D6                    		mov     dh, dl
  2770 00000988 80E20F                  		and     dl, 0Fh
  2771 0000098B C0EE04                  		shr     dh, 4
  2772 0000098E 00F6                    		add     dh, dh
  2773 00000990 00F2                    		add     dl, dh
  2774 00000992 C0E602                  		shl     dh, 2
  2775 00000995 00F2                    		add     dl, dh
  2776 00000997 8816[63E7]              		mov     [BreakRow], dl
  2777 0000099B C606[62E7]40            		mov     byte [Row], 64
  2778 000009A0 C3                      		retn
  2779                                  SetSpeed:
  2780 000009A1 84D2                    		test    dl,dl
  2781 000009A3 7424                    		je      Skip
  2782 000009A5 80FA1F                  		cmp     dl,31
  2783 000009A8 7709                    		ja      short SetBpm
  2784                                  SetTempo:       
  2785 000009AA 8816[5FE7]              		mov     [Tempo], dl
  2786 000009AE 8816[60E7]              		mov     [TempoWait], dl
  2787 000009B2 C3                      		retn
  2788                                  SetBpm:
  2789 000009B3 8816[61E7]              		mov     [Bpm], dl
  2790 000009B7 B067                    		mov     al, 103
  2791 000009B9 F6E2                    		mul     dl
  2792 000009BB 88E3                    		mov     bl, ah
  2793 000009BD 30FF                    		xor     bh, bh
  2794 000009BF A1[B08D]                		mov     ax, [MixSpeed]
  2795 000009C2 31D2                    		xor     dx, dx
  2796 000009C4 F7F3                    		div     bx
  2797 000009C6 A3[64E7]                		mov     [BpmSamples], ax
  2798                                  Skip:
  2799 000009C9 C3                      		retn
  2800                                  InitArpeggio:
  2801 000009CA 88D6                    		mov     dh, dl
  2802 000009CC 80E20F                  		and     dl, 0Fh
  2803 000009CF C0EE04                  		shr     dh, 4
  2804 000009D2 B92400                  		mov     cx, 36
  2805 000009D5 31DB                    		xor     bx, bx
  2806 000009D7 8B450E                  		mov     ax, [di+TrackInfo.Period]
  2807                                  gt_ScanPeriod:
  2808 000009DA 3B87[F90E]              		cmp     ax, [PeriodTable+bx]
  2809 000009DE 7305                    		jae     short SetArp
  2810 000009E0 83C302                  		add     bx, 2
  2811 000009E3 E2F5                    		loop    gt_ScanPeriod
  2812                                  SetArp:         
  2813 000009E5 01D2                    		add     dx, dx
  2814 000009E7 00DE                    		add     dh, bl
  2815 000009E9 00DA                    		add     dl, bl
  2816 000009EB 8B9F[F90E]              		mov     bx, [PeriodTable+bx]
  2817 000009EF 01DB                    		add     bx, bx
  2818 000009F1 8B87[AC8F]              		mov     ax, [PitchTable+bx]
  2819 000009F5 89451A                  		mov     [di+TrackInfo.Arp], ax
  2820 000009F8 88F3                    		mov     bl, dh
  2821 000009FA 30FF                    		xor     bh, bh
  2822 000009FC 8B9F[F90E]              		mov     bx, [PeriodTable+bx]
  2823 00000A00 01DB                    		add     bx, bx
  2824 00000A02 8B87[AC8F]              		mov     ax, [PitchTable+bx]
  2825 00000A06 89451C                  		mov     [di+TrackInfo.Arp+2], ax
  2826 00000A09 88D3                    		mov     bl, dl
  2827 00000A0B 30FF                    		xor     bh, bh
  2828 00000A0D 8B9F[F90E]              		mov     bx, [PeriodTable+bx]
  2829 00000A11 01DB                    		add     bx, bx
  2830 00000A13 8B87[AC8F]              		mov     ax, [PitchTable+bx]
  2831 00000A17 89451E                  		mov     [di+TrackInfo.Arp+4], ax
  2832 00000A1A C745200000              		mov     word [di+TrackInfo.ArpIndex], 0
  2833 00000A1F C3                      		retn
  2834                                  
  2835                                  ;--------------------------------------------------------------------------
  2836                                  ; UpdateTracks:  Main code to process the next tick to be played.
  2837                                  ;--------------------------------------------------------------------------
  2838                                  
  2839                                  UpdateTracks:
  2840 00000A20 FE0E[60E7]              		dec     byte [TempoWait]
  2841 00000A24 740F                    		jz      short GetTracks
  2842                                  
  2843 00000A26 B90400                  		mov	cx, NumTracks
  2844 00000A29 BF[70E7]                		mov	di, Tracks
  2845                                  BeatTracks:
  2846 00000A2C E830FD                  		call	BeatTrack
  2847 00000A2F 83C722                  		add	di, TrackInfo.size
  2848 00000A32 E2F8                    		loop	BeatTracks
  2849 00000A34 C3                      		retn
  2850                                  GetTracks:
  2851 00000A35 A0[5FE7]                		mov     al, [Tempo]
  2852 00000A38 A2[60E7]                		mov     [TempoWait], al
  2853                                  
  2854 00000A3B C436[6CE7]              		les     si, [Note]
  2855 00000A3F 803E[62E7]40            		cmp     byte [Row], 64
  2856 00000A44 7246                    		jb      short NoPattWrap
  2857                                  
  2858 00000A46 C436[348E]              		les     si, [ModInfo.Patterns]
  2859 00000A4A 8A1E[5EE7]              		mov     bl, [OrderPos]
  2860 00000A4E 3A1E[B28D]              		cmp     bl, [ModInfo.OrderLen]
  2861 00000A52 720E                    		jb      short NoOrderWrap
  2862 00000A54 8A1E[B38D]              		mov     bl, [ModInfo.ReStart]
  2863 00000A58 881E[5EE7]              		mov     [OrderPos], bl
  2864 00000A5C 3A1E[B28D]              		cmp     bl, [ModInfo.OrderLen]
  2865 00000A60 7343                    		jae     short NoUpdate
  2866                                  NoOrderWrap:
  2867 00000A62 30FF                    		xor     bh, bh
  2868 00000A64 8A9F[B48D]              		mov     bl, [ModInfo.Order+bx]
  2869 00000A68 C1E30A                  		shl     bx, 10
  2870 00000A6B 01DE                    		add     si, bx
  2871 00000A6D 8A1E[63E7]              		mov     bl, [BreakRow]
  2872 00000A71 881E[62E7]              		mov     [Row], bl
  2873 00000A75 30FF                    		xor     bh, bh
  2874 00000A77 883E[63E7]              		mov     [BreakRow], bh
  2875 00000A7B C1E304                  		shl     bx, 4
  2876 00000A7E 01DE                    		add     si, bx
  2877 00000A80 8936[6CE7]              		mov     [Note], si
  2878 00000A84 8C06[6EE7]              		mov     [Note+2], es
  2879 00000A88 FE06[5EE7]              		inc     byte [OrderPos]
  2880                                  NoPattWrap:
  2881 00000A8C FE06[62E7]              		inc     byte [Row]
  2882                                  
  2883 00000A90 FC                      		cld
  2884 00000A91 B90400                  		mov	cx, NumTracks
  2885 00000A94 BF[70E7]                		mov	di, Tracks
  2886                                  GetTracks_next:
  2887 00000A97 51                      		push	cx
  2888 00000A98 E8F0FD                  		call	GetTrack
  2889 00000A9B 59                      		pop	cx
  2890 00000A9C 83C722                  		add	di, TrackInfo.size
  2891 00000A9F E2F6                    		loop	GetTracks_next
  2892                                  
  2893 00000AA1 8936[6CE7]              		mov     [Note], si
  2894                                  NoUpdate:
  2895 00000AA5 C3                      		retn
  2896                                  
  2897                                  ;--------------------------------------------------------------------------
  2898                                  ; MixTrack:  Mixes one track into a CLEAN buffer.
  2899                                  ;  In:
  2900                                  ;   ds:si -  Track Info Address.
  2901                                  ;   ds:di -  Buffer Address.
  2902                                  ;    cx   -  Buffer Size.
  2903                                  ;--------------------------------------------------------------------------
  2904                                  
  2905                                  MixTrack:
  2906 00000AA6 837C0A02                		cmp     word [si+TrackInfo.RepLen], 2
  2907 00000AAA 7742                    		ja      short MixLooped
  2908                                  MixNonLooped:
  2909 00000AAC C414                    		les     dx, [si+TrackInfo.Samples]
  2910 00000AAE 8B5C04                  		mov     bx, [si+TrackInfo.Position]
  2911 00000AB1 8B6C06                  		mov     bp, [si+TrackInfo.Len]
  2912 00000AB4 52                      		push    dx
  2913 00000AB5 56                      		push    si
  2914 00000AB6 01D3                    		add     bx, dx
  2915 00000AB8 01D5                    		add     bp, dx
  2916 00000ABA 8B5410                  		mov     dx, [si+TrackInfo.Pitch]
  2917 00000ABD 8A440C                  		mov     al, [si+TrackInfo.Volume]
  2918 00000AC0 8A640D                  		mov     ah, [si+TrackInfo.Error]
  2919 00000AC3 89DE                    		mov     si, bx
  2920 00000AC5 88C7                    		mov     bh, al
  2921 00000AC7 88D0                    		mov     al, dl
  2922 00000AC9 88F2                    		mov     dl, dh
  2923 00000ACB 30F6                    		xor     dh, dh
  2924                                  nlMixSamp:
  2925 00000ACD 39EE                    		cmp     si, bp
  2926 00000ACF 7310                    		jae     short nlMixBye
  2927 00000AD1 268A1C                  		mov     bl, [es:si]
  2928 00000AD4 8A9F[5E96]              		mov     bl, [VolTable+bx]
  2929 00000AD8 001D                    		add     [di], bl
  2930 00000ADA 47                      		inc     di
  2931 00000ADB 00C4                    		add     ah, al
  2932 00000ADD 11D6                    		adc     si, dx
  2933 00000ADF E2EC                    		loop    nlMixSamp
  2934                                  nlMixBye:
  2935 00000AE1 89F3                    		mov     bx, si
  2936 00000AE3 5E                      		pop     si
  2937 00000AE4 5A                      		pop     dx
  2938 00000AE5 29D3                    		sub     bx, dx
  2939 00000AE7 895C04                  		mov     [si+TrackInfo.Position], bx
  2940 00000AEA 88640D                  		mov     [si+TrackInfo.Error], ah
  2941 00000AED C3                      		retn
  2942                                  MixLooped:
  2943 00000AEE C414                    		les     dx, [si+TrackInfo.Samples]
  2944 00000AF0 8B5C04                  		mov     bx, [si+TrackInfo.Position]
  2945 00000AF3 8B6C0A                  		mov     bp, [si+TrackInfo.RepLen]
  2946 00000AF6 892E[6AE7]              		mov     [BufRep], bp
  2947 00000AFA 036C08                  		add     bp, [si+TrackInfo.Repeat]
  2948 00000AFD 52                      		push    dx
  2949 00000AFE 56                      		push    si
  2950 00000AFF 01D3                    		add     bx, dx
  2951 00000B01 01D5                    		add     bp, dx
  2952 00000B03 8B5410                  		mov     dx, [si+TrackInfo.Pitch]
  2953 00000B06 8A440C                  		mov     al, [si+TrackInfo.Volume]
  2954 00000B09 8A640D                  		mov     ah, [si+TrackInfo.Error]
  2955 00000B0C 89DE                    		mov     si, bx
  2956 00000B0E 88C7                    		mov     bh, al
  2957 00000B10 88D0                    		mov     al, dl
  2958 00000B12 88F2                    		mov     dl, dh
  2959 00000B14 30F6                    		xor     dh, dh
  2960                                  lpMixSamp:
  2961 00000B16 39EE                    		cmp     si, bp
  2962 00000B18 7204                    		jb      short lpMixNow
  2963 00000B1A 2B36[6AE7]              		sub     si, [BufRep]
  2964                                  lpMixNow:
  2965 00000B1E 268A1C                  		mov     bl, [es:si]
  2966 00000B21 8A9F[5E96]              		mov     bl, [VolTable+bx]
  2967 00000B25 001D                    		add     [di], bl
  2968 00000B27 47                      		inc     di
  2969 00000B28 00C4                    		add     ah, al
  2970 00000B2A 11D6                    		adc     si, dx
  2971 00000B2C E2E8                    		loop    lpMixSamp
  2972                                  lpMixBye:
  2973 00000B2E 89F3                    		mov     bx, si
  2974 00000B30 5E                      		pop     si
  2975 00000B31 5A                      		pop     dx
  2976 00000B32 29D3                    		sub     bx, dx
  2977 00000B34 895C04                  		mov     [si+TrackInfo.Position], bx
  2978 00000B37 88640D                  		mov     [si+TrackInfo.Error], ah
  2979 00000B3A C3                      		retn
  2980                                  
  2981                                  GetSamples_ICH:
  2982                                  		; 11/05/2024
  2983                                  		; 18/02/2017
  2984                                  		; 8 bit mono samples 
  2985                                  		; must be converted to 16 bit, stereo samples (for ICH) !
  2986                                  		; (ICH AC97 Modification by Erdogan Tan)
  2987 00000B3B 8936[80EC]              		mov	[_si_], si ; DMA Buff Addr, [DMA_BUFFER1] or [DMA_BUFFER2]
  2988                                  		; 11/05/2024
  2989                                  		;mov	si, MOD_BUFFER
  2990                                  		;shr	cx, 2 ; mod buffer size = dma (half) buffer size / 4 (*)
  2991                                  
  2992                                  ;--------------------------------------------------------------------------
  2993                                  ; GetSamples:  Returns the next chunk of samples to be played.
  2994                                  ;  In:
  2995                                  ;    Buffer  - Buffer Address.
  2996                                  ;    Count   - Buffer Size.
  2997                                  ;--------------------------------------------------------------------------
  2998                                  
  2999                                  GetSamples:
  3000                                  		;ds:si = buffer address
  3001                                  		;cx = count
  3002                                  
  3003                                  		; 11/05/2024
  3004                                  		;
  3005                                  		;;[sp+6] = ds
  3006                                  		;;[sp+4] = si
  3007                                  		;;[sp+2] = count
  3008                                  		;
  3009                                  		;Count	equ 4
  3010                                  		;Buffer	equ 6 
  3011                                  		;
  3012                                  		;push	bp
  3013                                  		;mov	bp, sp
  3014                                  		;
  3015                                  		;push    es
  3016                                  		;;;push  ds
  3017                                  		;;;pusha
  3018                                  		;
  3019                                  		;cld
  3020                                  		;
  3021                                  		;les	di, [bp+Buffer]
  3022                                  		;mov    bx, [bp+Count]
  3023                                  
  3024                                  		; 11/05/2024
  3025                                  		; ds = cs
  3026 00000B3F 06                      		push	es ; +
  3027                                  
  3028 00000B40 1E                      		push	ds
  3029 00000B41 07                      		pop	es
  3030                                  
  3031                                  		; 11/05/2024
  3032 00000B42 BF[82EC]                		mov	di, MOD_BUFFER
  3033 00000B45 BB000F                  		mov	bx, (BUFFERSIZE/4) ; (*) ; 2048
  3034                                  NextChunk:
  3035 00000B48 833E[68E7]00            		cmp     word [BufLen], 0
  3036 00000B4D 7534                    		jne     short CopyChunk
  3037                                  
  3038                                  		; 11/05/2024
  3039 00000B4F 06                      		push	es
  3040 00000B50 53                      		push	bx
  3041 00000B51 57                      		push	di
  3042                                  MixChunk:
  3043                                  		;lea    di, [MixBuffer]
  3044 00000B52 BF[5ED7]                		mov	di, MixBuffer
  3045 00000B55 8B0E[64E7]              		mov     cx, [BpmSamples]
  3046 00000B59 893E[66E7]              		mov     [BufPtr], di
  3047 00000B5D 890E[68E7]              		mov     [BufLen], cx
  3048                                  
  3049                                  		; 12/05/2024
  3050                                  		; es = ds
  3051                                  		;mov    ax, ds
  3052                                  		;mov    es, ax
  3053                                  
  3054 00000B61 B080                    		mov    al, 80h
  3055 00000B63 F3AA                    		rep    stosb
  3056                                  
  3057 00000B65 B90400                  		mov	cx, NumTracks
  3058 00000B68 BE[4EE7]                		mov	si, Tracks - TrackInfo.size
  3059                                  GetSamples_next:
  3060 00000B6B 51                      		push	cx
  3061 00000B6C 83C622                  		add	si, TrackInfo.size
  3062 00000B6F 8B0E[68E7]              		mov	cx, [BufLen]
  3063 00000B73 8B3E[66E7]              		mov	di, [BufPtr]
  3064 00000B77 E82CFF                  		call	MixTrack
  3065 00000B7A 59                      		pop	cx
  3066 00000B7B E2EE                    		loop	GetSamples_next
  3067                                  
  3068 00000B7D E8A0FE                  		call    UpdateTracks
  3069                                  
  3070 00000B80 5F                      		pop	di
  3071 00000B81 5B                      		pop	bx
  3072 00000B82 07                      		pop	es ; es = ds ; 12/05/2024
  3073                                  CopyChunk:
  3074 00000B83 8B0E[68E7]              		mov     cx, [BufLen]
  3075 00000B87 39D9                    		cmp     cx, bx
  3076 00000B89 7602                    		jbe     short MoveChunk
  3077 00000B8B 89D9                    		mov     cx, bx
  3078                                  MoveChunk:
  3079 00000B8D 8B36[66E7]              		mov     si, [BufPtr]
  3080 00000B91 010E[66E7]              		add     [BufPtr], cx
  3081 00000B95 290E[68E7]              		sub     [BufLen], cx
  3082 00000B99 29CB                    		sub     bx, cx
  3083 00000B9B F3A4                    		rep     movsb
  3084 00000B9D 85DB                    		test    bx, bx
  3085 00000B9F 75A7                    		jnz     short NextChunk
  3086                                  
  3087                                  		;;popa
  3088                                  		;;pop	ds
  3089                                  		;pop	es
  3090                                  		;pop	bp
  3091                                  		;ret	6
  3092                                  
  3093                                  ; GetSamples_ICH_convert_samples:
  3094                                  		; 11/05/2024
  3095                                  		; es = ds = cs
  3096                                  		; 18/02/2017
  3097                                  		;mov	di, ds
  3098                                  		;mov	es, di
  3099 00000BA1 8B3E[80EC]              		mov	di, [_si_] ; DMA Buffer Address (16 bit, stereo)
  3100 00000BA5 BE[81EC]                		mov	si, MOD_BUFFER - 1 ; buffer for 8 bit mono samples
  3101 00000BA8 B9000F                  		mov	cx, (BUFFERSIZE/4) ; (*) ; 2048 ; 11/04/2024
  3102 00000BAB 30C0                    		xor	al, al
  3103                                  gscs_loop:		
  3104 00000BAD 46                      		inc	si
  3105 00000BAE 8A24                    		mov	ah, [si] ; convert 8 bit sample to 16 bit sample
  3106                                  		; 11/05/2024
  3107 00000BB0 80EC80                  		sub	ah, 80h
  3108                                  
  3109 00000BB3 AB                      		stosw	; left channel
  3110 00000BB4 AB                      		stosw	; right channel
  3111 00000BB5 E2F6                    		loop	gscs_loop
  3112                                  
  3113                                  		; 11/05/2024
  3114 00000BB7 07                      		pop	es ; +
  3115                                  		;pop	bp
  3116                                  		;ret	6
  3117 00000BB8 C3                      		retn
  3118                                  
  3119                                  ;--------------------------------------------------------------------------
  3120                                  ; StartPlaying: Initializes the Sound System.
  3121                                  ;  In:
  3122                                  ;   Module Information Resources.
  3123                                  ;--------------------------------------------------------------------------
  3124                                  
  3125                                  StartPlaying:
  3126 00000BB9 60                      		pusha
  3127 00000BBA 1E                      		push    ds
  3128 00000BBB 06                      		push    es
  3129                                  SetModParms:    
  3130 00000BBC C606[5EE7]00            		mov     byte [OrderPos], 0
  3131 00000BC1 C606[5FE7]06            		mov     byte [Tempo], DefTempo
  3132 00000BC6 C606[60E7]06            		mov     byte [TempoWait], DefTempo
  3133 00000BCB C606[61E7]7D            		mov     byte [Bpm], DefBpm
  3134 00000BD0 C606[62E7]40            		mov     byte [Row], 64
  3135 00000BD5 C606[63E7]00            		mov     byte [BreakRow], 0
  3136 00000BDA A1[B08D]                		mov     ax, [MixSpeed]
  3137 00000BDD 31D2                    		xor     dx, dx
  3138 00000BDF BB3200                  		mov     bx, 24*DefBpm/60
  3139 00000BE2 F7F3                    		div     bx
  3140 00000BE4 A3[64E7]                		mov     [BpmSamples], ax
  3141                                  ClearTracks:
  3142 00000BE7 BF[70E7]                		mov     di, Tracks
  3143 00000BEA 8CD8                    		mov     ax, ds
  3144 00000BEC 8EC0                    		mov     es, ax
  3145 00000BEE B98800                  		mov     cx, NumTracks*TrackInfo.size
  3146 00000BF1 31C0                    		xor     ax, ax
  3147 00000BF3 FC                      		cld
  3148 00000BF4 F3AA                    		rep     stosb
  3149                                  
  3150 00000BF6 A3[66E7]                		mov     [BufPtr], ax
  3151 00000BF9 A3[68E7]                		mov     [BufLen], ax
  3152                                  MakePitch:
  3153 00000BFC B80021                  		mov     ax, MidCRate
  3154 00000BFF BBAC01                  		mov     bx, 428
  3155 00000C02 F7E3                    		mul     bx
  3156 00000C04 F736[B08D]              		div     word [MixSpeed]
  3157 00000C08 30F6                    		xor     dh, dh
  3158 00000C0A 88E2                    		mov     dl, ah
  3159 00000C0C 88C4                    		mov     ah, al
  3160 00000C0E 30C0                    		xor     al, al
  3161 00000C10 B95903                  		mov     cx, 857
  3162 00000C13 31DB                    		xor     bx, bx
  3163 00000C15 BF[AC8F]                		mov     di, PitchTable
  3164                                  PitchLoop:
  3165 00000C18 50                      		push    ax
  3166 00000C19 52                      		push    dx
  3167 00000C1A 39DA                    		cmp     dx, bx
  3168 00000C1C 7302                    		jae     short NoDiv
  3169 00000C1E F7F3                    		div     bx
  3170                                  NoDiv:
  3171 00000C20 AB                      		stosw
  3172 00000C21 5A                      		pop     dx
  3173 00000C22 58                      		pop     ax
  3174 00000C23 43                      		inc     bx
  3175 00000C24 E2F2                    		loop    PitchLoop
  3176                                  MakeVolume:
  3177 00000C26 B90041                  		mov     cx, 16640
  3178 00000C29 89CB                    		mov     bx, cx
  3179                                  VolLoop:
  3180 00000C2B 4B                      		dec     bx
  3181 00000C2C 88D8                    		mov     al, bl
  3182 00000C2E F6EF                    		imul    bh
  3183 00000C30 88A7[5E96]              		mov     [VolTable+bx], ah
  3184 00000C34 E2F5                    		loop    VolLoop
  3185                                  
  3186 00000C36 07                      		pop     es
  3187 00000C37 1F                      		pop     ds
  3188 00000C38 61                      		popa
  3189 00000C39 C3                      		retn	; 12/05/2024
  3190                                  
  3191                                  ;--------------------------------------------------------------------------
  3192                                  ; StopPlaying: ShutDown the Sound System.
  3193                                  ;--------------------------------------------------------------------------
  3194                                  
  3195                                  StopPlaying:
  3196                                  	; 08/05/2024
  3197                                  	; 04/11/2023
  3198                                  	; finished with song, stop everything
  3199 00000C3A E8CB01                  	call	ac97_stop
  3200                                  
  3201                                  	; 11/11/2023
  3202                                  irq_restore:	
  3203                                  	; restore previous interrupt vector and interrupt_status
  3204 00000C3D FA                      	cli
  3205 00000C3E E4A1                    	in	al, 0A1h ; irq 8-15
  3206 00000C40 A0[5910]                	mov	al, [IRQ_status+1]
  3207 00000C43 E6A1                    	out	0A1h, al 
  3208 00000C45 E421                    	in	al, 021h ; irq 0-7
  3209 00000C47 A0[5810]                	mov	al, [IRQ_status]
  3210 00000C4A E621                    	out	21h, al 
  3211                                  	; ...
  3212 00000C4C 06                      	push	es
  3213 00000C4D 31C0                    	xor	ax, ax
  3214 00000C4F 8EC0                    	mov	es, ax
  3215 00000C51 A1[5A10]                	mov	ax, [IRQ_vector]
  3216 00000C54 268907                  	mov	[es:bx], ax
  3217 00000C57 A1[5C10]                	mov	ax, [IRQ_vector+2]
  3218 00000C5A 26894702                	mov	[es:bx+2], ax
  3219 00000C5E 07                      	pop	es
  3220                                  
  3221 00000C5F FB                      	sti
  3222                                  
  3223 00000C60 C3                      	retn
  3224                                  
  3225                                  ;=============================================================================
  3226                                  ;               PLAYER.ASM
  3227                                  ;=============================================================================
  3228                                  
  3229                                  ; UTILS.ASM
  3230                                  ;----------------------------------------------------------------------------
  3231                                  ;       delay1_4ms - Delay for 1/4 millisecond.
  3232                                  ;		    1mS = 1000us
  3233                                  ;       Entry:
  3234                                  ;         None
  3235                                  ;       Exit:
  3236                                  ;	  None
  3237                                  ;
  3238                                  ;       Modified:
  3239                                  ;         None
  3240                                  ;
  3241                                  PORTB			EQU	061h
  3242                                    REFRESH_STATUS	EQU	010h		; Refresh signal status
  3243                                  
  3244                                  delay1_4ms:
  3245 00000C61 50                              push    ax 
  3246 00000C62 51                              push    cx
  3247 00000C63 B91000                          mov     cx, 16			; close enough.
  3248 00000C66 E461                    	in	al,PORTB
  3249 00000C68 2410                    	and	al,REFRESH_STATUS
  3250 00000C6A 88C4                    	mov	ah,al			; Start toggle state
  3251 00000C6C 09C9                    	or	cx, cx
  3252 00000C6E 7401                    	jz	short _d4ms1
  3253 00000C70 41                      	inc	cx			; Throwaway first toggle
  3254                                  _d4ms1:	
  3255 00000C71 E461                    	in	al,PORTB		; Read system control port
  3256 00000C73 2410                    	and	al,REFRESH_STATUS	; Refresh toggles 15.085 microseconds
  3257 00000C75 38C4                    	cmp	ah,al
  3258 00000C77 74F8                    	je	short _d4ms1		; Wait for state change
  3259                                  
  3260 00000C79 88C4                    	mov	ah,al			; Update with new state
  3261 00000C7B 49                      	dec	cx
  3262 00000C7C 75F3                    	jnz	short _d4ms1
  3263                                  
  3264 00000C7E 59                              pop     cx
  3265 00000C7F 58                              pop     ax
  3266 00000C80 C3                              retn
  3267                                  
  3268                                  print_msg:
  3269                                  	; 13/11/2016 - Erdogan Tan 
  3270                                  	; esi = ASCIIZ text address
  3271                                  	;
  3272 00000C81 BB0700                  	mov	bx, 7h
  3273 00000C84 B40E                    	mov	ah, 0Eh
  3274                                  pm_next_char:
  3275 00000C86 AC                      	lodsb
  3276 00000C87 20C0                    	and	al, al
  3277 00000C89 7404                    	jz	short pm_retn
  3278 00000C8B CD10                    	int	10h
  3279 00000C8D EBF7                    	jmp	short pm_next_char
  3280                                  pm_retn:
  3281 00000C8F C3                      	retn
  3282                                  
  3283                                  dword2str:
  3284                                  	; 13/11/2016 - Erdogan Tan
  3285                                  	; eax = dword value
  3286                                  	;
  3287 00000C90 E84400                  	call	dwordtohex
  3288 00000C93 668916[4310]            	mov	[dword_str], edx
  3289 00000C98 66A3[4710]              	mov	[dword_str+4], eax
  3290 00000C9C BE[4310]                	mov	si, dword_str
  3291 00000C9F C3                      	retn
  3292                                  
  3293                                  	; trdos386.s (unix386.s) - 10/05/2015
  3294                                  	; Convert binary number to hexadecimal string
  3295                                  
  3296                                  bytetohex:
  3297                                  	; INPUT ->
  3298                                  	; 	AL = byte (binary number)
  3299                                  	; OUTPUT ->
  3300                                  	;	AX = hexadecimal string
  3301                                  	;
  3302 00000CA0 53                      	push	bx
  3303 00000CA1 30FF                    	xor	bh, bh
  3304 00000CA3 88C3                    	mov	bl, al
  3305 00000CA5 C0EB04                  	shr	bl, 4
  3306 00000CA8 8A9F[A50F]              	mov	bl, [bx+hex_chars]
  3307 00000CAC 86D8                    	xchg	bl, al
  3308 00000CAE 80E30F                  	and	bl, 0Fh
  3309 00000CB1 8AA7[A50F]              	mov	ah, [bx+hex_chars]
  3310 00000CB5 5B                      	pop	bx	
  3311 00000CB6 C3                      	retn
  3312                                  
  3313                                  wordtohex:
  3314                                  	; INPUT ->
  3315                                  	; 	AX = word (binary number)
  3316                                  	; OUTPUT ->
  3317                                  	;	EAX = hexadecimal string
  3318                                  	;
  3319 00000CB7 53                      	push	bx
  3320 00000CB8 30FF                    	xor	bh, bh
  3321 00000CBA 86E0                    	xchg	ah, al
  3322 00000CBC 50                      	push	ax
  3323 00000CBD 88E3                    	mov	bl, ah
  3324 00000CBF C0EB04                  	shr	bl, 4
  3325 00000CC2 8A87[A50F]              	mov	al, [bx+hex_chars]
  3326 00000CC6 88E3                    	mov	bl, ah
  3327 00000CC8 80E30F                  	and	bl, 0Fh
  3328 00000CCB 8AA7[A50F]              	mov	ah, [bx+hex_chars]
  3329 00000CCF 66C1E010                	shl	eax, 16
  3330 00000CD3 58                      	pop	ax
  3331 00000CD4 5B                      	pop	bx
  3332 00000CD5 EBC9                    	jmp	short bytetohex
  3333                                  
  3334                                  dwordtohex:
  3335                                  	; INPUT ->
  3336                                  	; 	EAX = dword (binary number)
  3337                                  	; OUTPUT ->
  3338                                  	;	EDX:EAX = hexadecimal string
  3339                                  	;
  3340 00000CD7 6650                    	push	eax
  3341 00000CD9 66C1E810                	shr	eax, 16
  3342 00000CDD E8D7FF                  	call	wordtohex
  3343 00000CE0 6689C2                  	mov	edx, eax
  3344 00000CE3 6658                    	pop	eax
  3345 00000CE5 E8CFFF                  	call	wordtohex
  3346 00000CE8 C3                      	retn
  3347                                  
  3348                                  	; 13/11/2016 - Erdogan Tan
  3349                                  write_ac97_dev_info:
  3350                                  	; BUS/DEV/FN
  3351                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  3352                                  	; DEV/VENDOR
  3353                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  3354                                  
  3355 00000CE9 30FF                    	xor	bh, bh
  3356 00000CEB 668B36[6A10]            	mov	esi, [dev_vendor]
  3357 00000CF0 89F0                    	mov	ax, si
  3358 00000CF2 88C3                    	mov	bl, al
  3359 00000CF4 88DA                    	mov	dl, bl
  3360 00000CF6 80E30F                  	and	bl, 0Fh
  3361 00000CF9 8A87[A50F]              	mov	al, [bx+hex_chars]
  3362 00000CFD A2[E80F]                	mov	[msgVendorId+3], al
  3363 00000D00 88D3                    	mov	bl, dl
  3364 00000D02 C0EB04                  	shr	bl, 4
  3365 00000D05 8A87[A50F]              	mov	al, [bx+hex_chars]
  3366 00000D09 A2[E70F]                	mov	[msgVendorId+2], al
  3367 00000D0C 88E3                    	mov	bl, ah
  3368 00000D0E 88DA                    	mov	dl, bl
  3369 00000D10 80E30F                  	and	bl, 0Fh
  3370 00000D13 8A87[A50F]              	mov	al, [bx+hex_chars]
  3371 00000D17 A2[E60F]                	mov	[msgVendorId+1], al
  3372 00000D1A 88D3                    	mov	bl, dl
  3373 00000D1C C0EB04                  	shr	bl, 4
  3374 00000D1F 8A87[A50F]              	mov	al, [bx+hex_chars]
  3375 00000D23 A2[E50F]                	mov	[msgVendorId], al
  3376 00000D26 66C1EE10                	shr	esi, 16
  3377 00000D2A 89F0                    	mov	ax, si
  3378 00000D2C 88C3                    	mov	bl, al
  3379 00000D2E 88DA                    	mov	dl, bl
  3380 00000D30 80E30F                  	and	bl, 0Fh
  3381 00000D33 8A87[A50F]              	mov	al, [bx+hex_chars]
  3382 00000D37 A2[F90F]                	mov	[msgDevId+3], al
  3383 00000D3A 88D3                    	mov	bl, dl
  3384 00000D3C C0EB04                  	shr	bl, 4
  3385 00000D3F 8A87[A50F]              	mov	al, [bx+hex_chars]
  3386 00000D43 A2[F80F]                	mov	[msgDevId+2], al
  3387 00000D46 88E3                    	mov	bl, ah
  3388 00000D48 88DA                    	mov	dl, bl
  3389 00000D4A 80E30F                  	and	bl, 0Fh
  3390 00000D4D 8A87[A50F]              	mov	al, [bx+hex_chars]
  3391 00000D51 A2[F70F]                	mov	[msgDevId+1], al
  3392 00000D54 88D3                    	mov	bl, dl
  3393 00000D56 C0EB04                  	shr	bl, 4
  3394 00000D59 8A87[A50F]              	mov	al, [bx+hex_chars]
  3395 00000D5D A2[F60F]                	mov	[msgDevId], al
  3396                                  
  3397 00000D60 668B36[6610]            	mov	esi, [bus_dev_fn]
  3398 00000D65 66C1EE08                	shr	esi, 8
  3399 00000D69 89F0                    	mov	ax, si
  3400 00000D6B 88C3                    	mov	bl, al
  3401 00000D6D 88DA                    	mov	dl, bl
  3402 00000D6F 80E307                  	and	bl, 7 ; bit 0,1,2
  3403 00000D72 8A87[A50F]              	mov	al, [bx+hex_chars]
  3404 00000D76 A2[1D10]                	mov	[msgFncNo+1], al
  3405 00000D79 88D3                    	mov	bl, dl
  3406 00000D7B C0EB03                  	shr	bl, 3
  3407 00000D7E 88DA                    	mov	dl, bl
  3408 00000D80 80E30F                  	and	bl, 0Fh
  3409 00000D83 8A87[A50F]              	mov	al, [bx+hex_chars]
  3410 00000D87 A2[0F10]                	mov	[msgDevNo+1], al
  3411 00000D8A 88D3                    	mov	bl, dl
  3412 00000D8C C0EB04                  	shr	bl, 4
  3413 00000D8F 8A87[A50F]              	mov	al, [bx+hex_chars]
  3414 00000D93 A2[0E10]                	mov	[msgDevNo], al
  3415 00000D96 88E3                    	mov	bl, ah
  3416 00000D98 88DA                    	mov	dl, bl
  3417 00000D9A 80E30F                  	and	bl, 0Fh
  3418 00000D9D 8A87[A50F]              	mov	al, [bx+hex_chars]
  3419 00000DA1 A2[0310]                	mov	[msgBusNo+1], al
  3420 00000DA4 88D3                    	mov	bl, dl
  3421 00000DA6 C0EB04                  	shr	bl, 4
  3422 00000DA9 8A87[A50F]              	mov	al, [bx+hex_chars]
  3423 00000DAD A2[0210]                	mov	[msgBusNo], al
  3424                                  
  3425                                  	;mov	ax, [ac97_io_base]
  3426                                  	; 08/05/2024
  3427 00000DB0 A1[5210]                	mov	ax, [NABMBAR]
  3428 00000DB3 88C3                    	mov	bl, al
  3429 00000DB5 88DA                    	mov	dl, bl
  3430 00000DB7 80E30F                  	and	bl, 0Fh
  3431 00000DBA 8A87[A50F]              	mov	al, [bx+hex_chars]
  3432 00000DBE A2[3610]                	mov	[msgIOBaseAddr+3], al
  3433 00000DC1 88D3                    	mov	bl, dl
  3434 00000DC3 C0EB04                  	shr	bl, 4
  3435 00000DC6 8A87[A50F]              	mov	al, [bx+hex_chars]
  3436 00000DCA A2[3510]                	mov	[msgIOBaseAddr+2], al
  3437 00000DCD 88E3                    	mov	bl, ah
  3438 00000DCF 88DA                    	mov	dl, bl
  3439 00000DD1 80E30F                  	and	bl, 0Fh
  3440 00000DD4 8A87[A50F]              	mov	al, [bx+hex_chars]
  3441 00000DD8 A2[3410]                	mov	[msgIOBaseAddr+1], al
  3442 00000DDB 88D3                    	mov	bl, dl
  3443 00000DDD C0EB04                  	shr	bl, 4
  3444 00000DE0 8A87[A50F]              	mov	al, [bx+hex_chars]
  3445 00000DE4 A2[3310]                	mov	[msgIOBaseAddr], al
  3446                                  
  3447                                  	; 24/11/2016
  3448 00000DE7 30E4                    	xor	ah, ah
  3449 00000DE9 A0[6410]                	mov	al, [ac97_int_ln_reg]
  3450 00000DEC B10A                    	mov	cl, 10
  3451 00000DEE F6F1                    	div	cl
  3452 00000DF0 0106[3E10]              	add	[msgIRQ], ax
  3453 00000DF4 20C0                    	and	al, al
  3454 00000DF6 7508                    	jnz	short _pmi
  3455 00000DF8 A0[3F10]                	mov	al, [msgIRQ+1]
  3456 00000DFB B420                    	mov	ah, ' '
  3457 00000DFD A3[3E10]                	mov	[msgIRQ], ax
  3458                                  _pmi:
  3459 00000E00 BA[B60F]                        mov	dx, msgAC97Info
  3460 00000E03 B409                            mov     ah, 9
  3461 00000E05 CD21                            int     21h
  3462 00000E07 C3                              retn
  3463                                  
  3464                                  	; 08/05/2024
  3465                                  ac97_stop:
  3466                                  	; 11/11/2023
  3467                                  	; 09/11/2023
  3468                                  	; 05/11/2023
  3469                                  	; 04/11/2023 
  3470                                  	; 28/05/2017 (TRDOS 386 v2, 'audio.s')
  3471                                  	;mov	byte [tLoop], 0 ; stop ! ; 05/11/2023
  3472                                  ;_ac97_stop:
  3473                                  
  3474                                  	; 11/11/2023
  3475 00000E08 8B16[5010]              	mov	dx, [NAMBAR]
  3476                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  3477 00000E0C EF                      	out	dx, ax
  3478                                  
  3479                                  	; 04/11/2023
  3480                                  	; 09/10/2017 (TRDOS 386 v2, 'audio.s')
  3481                                  	; 11/06/2017
  3482 00000E0D 30C0                    	xor	al, al ; 0
  3483 00000E0F E80D00                  	call	ac97_po_cmd
  3484                                  
  3485                                  	; (Ref: KolibriOS, intelac97.asm, 'stop:')
  3486                                  	; Clear FIFOE, BCIS, LVBCI (Ref: Intel ICH hub manual)
  3487 00000E12 B81C00                  	mov     ax, 1Ch
  3488 00000E15 8B16[5210]              	mov     dx, [NABMBAR]
  3489 00000E19 83C216                  	add     dx, PO_SR_REG
  3490 00000E1C EF                      	out     dx, ax
  3491                                  
  3492                                  	; 11/06/2017
  3493 00000E1D B002                    	mov     al, RR
  3494                                  ac97_po_cmd:
  3495                                  	; 11/06/2017
  3496                                  	; 29/05/2017
  3497 00000E1F 8B16[5210]              	mov     dx, [NABMBAR]
  3498 00000E23 83C21B                          add     dx, PO_CR_REG		; PCM out control register
  3499 00000E26 EE                      	out	dx, al
  3500 00000E27 C3                      	retn
  3501                                  
  3502                                  ;=============================================================================
  3503                                  ;               preinitialized data
  3504                                  ;=============================================================================
  3505                                  
  3506                                  ;=============================================================================
  3507                                  ;               PLAY.ASM - DATA
  3508                                  ;=============================================================================
  3509                                  
  3510                                  msg_2017:
  3511 00000E28 54696E79204D4F4420-     		db	'Tiny MOD Player by Erdogan Tan. May 2024.',10,13
  3511 00000E31 506C61796572206279-
  3511 00000E3A 204572646F67616E20-
  3511 00000E43 54616E2E204D617920-
  3511 00000E4C 323032342E0A0D     
  3512 00000E53 75736167653A20706C-     		db	'usage: playmod2 filename.mod', 10, 13, '$'
  3512 00000E5C 61796D6F6432206669-
  3512 00000E65 6C656E616D652E6D6F-
  3512 00000E6E 640A0D24           
  3513 00000E72 31382F30322F323031-     		db	'18/02/2017',0
  3513 00000E7B 3700               
  3514 00000E7D 31362F30352F323032-     		db	'16/05/2024',0
  3514 00000E86 3400               
  3515                                  
  3516 00000E88 54696E79204D4F4420-     Credits:	db	'Tiny MOD Player v0.1b by Carlos Hasan. July 1993.'
  3516 00000E91 506C61796572207630-
  3516 00000E9A 2E3162206279204361-
  3516 00000EA3 726C6F732048617361-
  3516 00000EAC 6E2E204A756C792031-
  3516 00000EB5 3939332E           
  3517                                  CRLF:		; 13/05/2024
  3518 00000EB9 0A0D24                  		db	10,13,'$'
  3519 00000EBC 4572726F72206C6F61-     ErrorMesg:	db	'Error loading Module file.',10,13,'$'
  3519 00000EC5 64696E67204D6F6475-
  3519 00000ECE 6C652066696C652E0A-
  3519 00000ED7 0D24               
  3520                                  
  3521                                  ;=============================================================================
  3522                                  ;               MODPLAY.ASM - DATA
  3523                                  ;=============================================================================
  3524                                  
  3525                                  ;Credits:	db	'Amiga Module Player v0.3b by Carlos Hasan.'
  3526                                  
  3527 00000ED9 0019324A62788EA2B4-     SinTable:	db	0,25,50,74,98,120,142,162,180,197,212,225
  3527 00000EE2 C5D4E1             
  3528 00000EE5 ECF4FAFEFFFEFAF4EC-     		db	236,244,250,254,255,254,250,244,236,225
  3528 00000EEE E1                 
  3529 00000EEF D4C5B4A28E78624A32-     		db	212,197,180,162,142,120,98,74,50,25
  3529 00000EF8 19                 
  3530                                  
  3531 00000EF9 58032803FA02D002A6-     PeriodTable:	dw	856,808,762,720,678,640,604,570,538,508,480,453
  3531 00000F02 0280025C023A021A02-
  3531 00000F0B FC01E001C501       
  3532 00000F11 AC0194017D01680153-     		dw	428,404,381,360,339,320,302,285,269,254,240,226
  3532 00000F1A 0140012E011D010D01-
  3532 00000F23 FE00F000E200       
  3533 00000F29 D600CA00BE00B400AA-     		dw	214,202,190,180,170,160,151,143,135,127,120,113
  3533 00000F32 00A00097008F008700-
  3533 00000F3B 7F0078007100       
  3534                                  
  3535                                  ;=============================================================================
  3536                                  ;               PLAYWAV.ASM / PLAYER.ASM - DATA
  3537                                  ;=============================================================================
  3538                                  
  3539                                  ; 24/11/2016
  3540                                  ;	       IRQ  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 
  3541 00000F41 08090A0B0C0D0E0F70-     irq_int:	db 08h,09h,0Ah,0Bh,0Ch,0Dh,0Eh,0Fh,70h,71h,72h,73h,74h,75h,76h,77h
  3541 00000F4A 71727374757677     
  3542                                  
  3543                                  ; 17/02/2017
  3544                                  ; Valid ICH device IDs
  3545                                  
  3546                                  valid_ids:
  3547 00000F51 86801524                dd	(ICH_DID << 16) + INTEL_VID  	 ; 8086h:2415h
  3548 00000F55 86802524                dd	(ICH0_DID << 16) + INTEL_VID 	 ; 8086h:2425h
  3549 00000F59 86804524                dd	(ICH2_DID << 16) + INTEL_VID 	 ; 8086h:2445h
  3550 00000F5D 86808524                dd	(ICH3_DID << 16) + INTEL_VID 	 ; 8086h:2485h
  3551 00000F61 8680C524                dd	(ICH4_DID << 16) + INTEL_VID 	 ; 8086h:24C5h
  3552 00000F65 8680D524                dd	(ICH5_DID << 16) + INTEL_VID 	 ; 8086h:24D5h
  3553 00000F69 86806E26                dd	(ICH6_DID << 16) + INTEL_VID 	 ; 8086h:266Eh
  3554 00000F6D 8680A625                dd	(ESB6300_DID << 16) + INTEL_VID  ; 8086h:25A6h
  3555 00000F71 86809826                dd	(ESB631X_DID << 16) + INTEL_VID  ; 8086h:2698h
  3556 00000F75 8680DE27                dd	(ICH7_DID << 16) + INTEL_VID 	 ; 8086h:27DEh
  3557                                  ; 03/11/2023 - Erdogan Tan
  3558 00000F79 86809571                dd	(MX82440_DID << 16) + INTEL_VID  ; 8086h:7195h
  3559 00000F7D 39101270                dd	(SI7012_DID << 16)  + SIS_VID	 ; 1039h:7012h
  3560 00000F81 DE10B101                dd 	(NFORCE_DID << 16)  + NVIDIA_VID ; 10DEh:01B1h
  3561 00000F85 DE106A00                dd 	(NFORCE2_DID << 16) + NVIDIA_VID ; 10DEh:006Ah
  3562 00000F89 22106D74                dd 	(AMD8111_DID << 16) + AMD_VID 	 ; 1022h:746Dh
  3563 00000F8D 22104574                dd 	(AMD768_DID << 16)  + AMD_VID 	 ; 1022h:7445h
  3564 00000F91 DE105900                dd 	(CK804_DID << 16) + NVIDIA_VID	 ; 10DEh:0059h
  3565 00000F95 DE103A00                dd 	(MCP04_DID << 16) + NVIDIA_VID	 ; 10DEh:003Ah
  3566 00000F99 DE108A00                dd 	(CK8_DID << 16) + NVIDIA_VID	 ; 1022h:008Ah
  3567 00000F9D DE10DA00                dd 	(NFORCE3_DID << 16) + NVIDIA_VID ; 10DEh:00DAh
  3568 00000FA1 DE10EA00                dd 	(CK8S_DID << 16) + NVIDIA_VID	 ; 10DEh:00EAh
  3569                                  
  3570                                  valid_id_count:	equ ($ - valid_ids)>>2 ; 05/11/2023
  3571                                  
  3572                                  ; 13/11/2016
  3573 00000FA5 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  3573 00000FAE 3941424344454600   
  3574 00000FB6 414339372041756469-     msgAC97Info	db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  3574 00000FBF 6F20436F6E74726F6C-
  3574 00000FC8 6C6572202620436F64-
  3574 00000FD1 656320496E666F0D0A 
  3575 00000FDA 56656E646F72204944-     		db "Vendor ID: "
  3575 00000FE3 3A20               
  3576 00000FE5 303030306820446576-     msgVendorId	db "0000h Device ID: "
  3576 00000FEE 6963652049443A20   
  3577 00000FF6 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  3578 00000FFD 4275733A20              		db "Bus: "
  3579 00001002 303068204465766963-     msgBusNo	db "00h Device: "
  3579 0000100B 653A20             
  3580 0000100E 3030682046756E6374-     msgDevNo	db "00h Function: "
  3580 00001017 696F6E3A20         
  3581 0000101C 303068                  msgFncNo	db "00h"
  3582 0000101F 0D0A                    		db 0Dh, 0Ah
  3583 00001021 492F4F204261736520-     		db "I/O Base Address: "
  3583 0000102A 416464726573733A20 
  3584 00001033 303030306820495251-     msgIOBaseAddr	db "0000h IRQ: "
  3584 0000103C 3A20               
  3585 0000103E 3030                    msgIRQ		dw 3030h
  3586 00001040 0D0A24                  		db 0Dh, 0Ah, "$"
  3587                                  
  3588                                  ;msgSampleRate	db "Sample Rate: "
  3589                                  ;msgHertz	db "00000 Hz ", "$" 
  3590                                  ;msg8Bits	db "8 bits ", "$" 
  3591                                  ;msgMono	db "Mono", 0Dh, 0Ah, "$"
  3592                                  ;msg16Bits	db "16 bits ", "$" 
  3593                                  ;msgStereo	db "Stereo", 0Dh, 0Ah, "$"
  3594                                  
  3595                                  ;; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
  3596                                  ;codec_id	dd 0
  3597                                  ;codec_chip_id	dd 0
  3598                                  ;codec_vendor_ids dw 0
  3599                                  ;codec_chip_ids	dw 0
  3600                                  
  3601 00001043 3030303030303030        dword_str	 dd 30303030h, 30303030h
  3602 0000104B 680D0A00                		 db 'h', 0Dh, 0Ah, 0
  3603                                  
  3604                                  ;=============================================================================
  3605                                  ;        	uninitialized data
  3606                                  ;=============================================================================
  3607                                  
  3608                                  bss_start:
  3609                                  
  3610                                  ABSOLUTE bss_start
  3611                                  
  3612 0000104F ??                      alignb 4
  3613                                  
  3614                                  ; 17/02/2017
  3615                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  3616                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  3617                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  3618                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  3619 00001050 ????                    NAMBAR:		resw 1			; BAR for mixer
  3620 00001052 ????                    NABMBAR         resw 1			; BAR for bus master regs
  3621                                  
  3622 00001054 ??                      tBuff:		resb	1
  3623                                  ;irq_status:	resb 	1
  3624 00001055 ??                      pcm_irq_status:	resb	1 ; 08/05/2024
  3625                                  
  3626 00001056 ??                      inside:		resb	1
  3627 00001057 ??                      tLoop:		resb 	1
  3628                                  
  3629                                  ; 08/05/2024
  3630 00001058 ????                    IRQ_status:	resw 1	; IRQ status before enabling audio interrupt
  3631 0000105A ????????                IRQ_vector:	resd 1  ; Previous interrupt handler address
  3632                                  
  3633                                  ; 256 byte buffer for descriptor list
  3634 0000105E ????                    BDL_BUFFER:	resw	1		; segment of our 256byte BDL buffer
  3635 00001060 ????                    DMA_BUFFER1:	resw 	1		; Pointer to 1st half of DMA Buffer
  3636 00001062 ????                    DMA_BUFFER2:	resw	1		; Pointer to 1st half of DMA Buffer
  3637                                  
  3638                                  ; 12/11/2016 - Erdogan Tan
  3639                                  
  3640 00001064 ??                      ac97_int_ln_reg: resb 1
  3641 00001065 ??                      err_num:	resb 1
  3642                                  
  3643 00001066 ????????                bus_dev_fn:	resd 1
  3644 0000106A ????????                dev_vendor:	resd 1
  3645                                  ; 08/05/2024
  3646                                  ;stats_cmd:	resd 1
  3647                                  ;ac97_io_base:	resw 1
  3648 0000106E ??                      LVI:		resb 1
  3649                                  ; 12/05/2024
  3650 0000106F ??                      volume:		resb 1
  3651                                  
  3652                                  ;alignb 4
  3653                                  ; 13/05/2024
  3654                                  alignb 16
  3655                                  
  3656 00001070 <res 100h>              BdlBuffer:	resb	BDL_SIZE ; 13/02/2017
  3657 00001170 <res 7800h>             DmaBuffer:	resb	2*BUFFERSIZE ; 13/02/2017
  3658                                  
  3659                                  ; MODLOAD.ASM
  3660 00008970 ????                    FileHandle:	resw	1
  3661 00008972 ????                    ErrorInfo:	resw	1
  3662 00008974 <res 43Ch>              Header:		resb	ModHeader.size
  3663                                  
  3664                                  sample_rate: ; PLAYER.ASM (22050Hz)
  3665                                  ; MODPLAY.ASM
  3666 00008DB0 ????                    MixSpeed:	resw 1
  3667                                  
  3668                                  ModInfo:
  3669 00008DB2 ??                      ModInfo.OrderLen:   resb 1
  3670 00008DB3 ??                      ModInfo.ReStart:    resb 1
  3671 00008DB4 <res 80h>               ModInfo.Order:	    resb 128
  3672 00008E34 ????????                ModInfo.Patterns:   resd 1
  3673                                  
  3674 00008E38 <res 3Eh>               ModInfo.SampOfs:    resw 31
  3675 00008E76 <res 3Eh>               ModInfo.SampSeg:    resw 31
  3676 00008EB4 <res 3Eh>               ModInfo.SampLen:    resw 31
  3677 00008EF2 <res 3Eh>               ModInfo.SampRep:    resw 31
  3678 00008F30 <res 3Eh>               ModInfo.SampRepLen: resw 31
  3679 00008F6E <res 3Eh>               ModInfo.SampVol:    resw 31
  3680                                  
  3681                                  ; MODPLAY.ASM
  3682 00008FAC <res 6B2h>              PitchTable:	resw	857
  3683 0000965E <res 4100h>             VolTable:	resb	16640
  3684 0000D75E <res 1000h>             MixBuffer       resb	MixBufSize
  3685                                  
  3686                                  ; MODPLAY.ASM
  3687 0000E75E ??                      OrderPos:	resb 1
  3688 0000E75F ??                      Tempo:		resb 1
  3689 0000E760 ??                      TempoWait:	resb 1
  3690 0000E761 ??                      Bpm:		resb 1
  3691 0000E762 ??                      Row:		resb 1
  3692 0000E763 ??                      BreakRow:	resb 1
  3693 0000E764 ????                    BpmSamples:	resw 1
  3694 0000E766 ????                    BufPtr:		resw 1
  3695 0000E768 ????                    BufLen:		resw 1
  3696 0000E76A ????                    BufRep:		resw 1
  3697 0000E76C ????????                Note:		resd 1
  3698 0000E770 <res 88h>               Tracks:		resb TrackInfo.size*NumTracks
  3699                                  
  3700 0000E7F8 ????????????????        alignb 16
  3701                                  
  3702                                  ; PLAY.ASM
  3703 0000E800 <res 280h>              Scope:		resw	320
  3704 0000EA80 <res 200h>              RowOfs:		resw	256
  3705                                  
  3706                                  ; 18/02/2017
  3707 0000EC80 ????                    _si_:		resw 1
  3708 0000EC82 <res F00h>              MOD_BUFFER:	resb BUFFERSIZE/4 ; 2048 ; 11/05/2024
  3709                                  EOF:
