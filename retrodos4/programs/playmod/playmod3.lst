     1                                  ; ****************************************************************************
     2                                  ; playmod3.asm (for MSDOS)
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; PLAYMOD3.COM ! ICH AC97 MOD PLAYER & VGA DEMO program by Erdogan TAN
     5                                  ;
     6                                  ; 18/02/2017
     7                                  ;
     8                                  ; [ Last Modification: 18/05/2024 ]
     9                                  ;
    10                                  ; Derived from source code of 'PLAYWAV.COM' ('PLAYWAV.ASM') by Erdogan Tan
    11                                  ;							      (17/02/2017)
    12                                  ; Modified from 'PLAYMOD2.COM' ('playmod2.asm') source code 
    13                                  ;		 AC97 MOD PLAYER & VGA DEMO program (tuneloop version)
    14                                  ;						by Erdogan TAN (12/05/2024)
    15                                  ;
    16                                  ; Derived from source code of 'PLAY.EXE' (TINYPLAY) by Carlos Hasan (1993)
    17                                  ;          PLAY.EXE: PLAY.ASM, MODLOAD.ASM, MODPLAY.ASM, SB.ASM
    18                                  ;
    19                                  ; Assembler: NASM 2.15
    20                                  ; ----------------------------------------------------------------------------
    21                                  ;	   nasm  playmod3.asm -l playmod3.lst -o PLAYMOD3.COM	
    22                                  ; ****************************************************************************
    23                                  
    24                                  ; Tiny MOD Player v0.1b by Carlos Hasan.
    25                                  ;		July 14th, 1993.
    26                                  
    27                                  ;=============================================================================
    28                                  ;               PLAYWAV.ASM / PLAYER.ASM / TINYPLAY.ASM
    29                                  ;=============================================================================
    30                                  ; Audio controller, codec & PCI functions are derived from '.wav file player
    31                                  ; for DOS' source code by Jeff Leyda (PLAYER.EXE), Sep 02, 2002.
    32                                  
    33                                  ; AC97 Interrupt version ; 12/05/2024
    34                                  
    35                                  [BITS 16]
    36                                  [org 100h]
    37                                  
    38                                  Start:
    39                                  	; 15/05/2024
    40                                  	; 13/05/2024
    41                                  	; Clear BSS (uninitialized data) area
    42                                  	;xor	ax, ax ; 0
    43                                  	;mov	cx, (EOF - bss_start)/2
    44                                  	;mov	di, bss_start
    45                                  	;rep	stosw
    46                                  
    47 00000000 E8C900                  	call    DetectICH		; Detect AC97 Audio Device
    48                                  GetFileName:    			; Parse  the Command line...
    49 00000003 BE8000                  	mov	si, 80h
    50 00000006 8A1C                    	mov	bl, [si]
    51 00000008 30FF                    	xor	bh, bh
    52 0000000A 43                      	inc	bx
    53 0000000B C60000                  	mov	byte [si+bx], 0		; make AsciiZ filename.
    54 0000000E 46                      	inc	si
    55                                  ScanName:       
    56 0000000F AC                      	lodsb
    57 00000010 84C0                    	test	al, al
    58 00000012 0F84AC00                	je	pmsg_2017
    59 00000016 3C20                    	cmp	al, 20h
    60 00000018 74F5                    	je	short ScanName		; scan start of name.
    61 0000001A 89F7                    	mov	di, si
    62 0000001C 4F                      	dec	di
    63                                  ScanPeriod:
    64 0000001D AC                      	lodsb
    65 0000001E 3C2E                    	cmp	al, '.'			; if period NOT found,
    66 00000020 7410                    	je	short PrintMesg		; then add a .MOD extension.
    67 00000022 84C0                    	test	al, al
    68 00000024 75F7                    	jnz	short ScanPeriod
    69 00000026 4E                      	dec	si
    70                                  SetExt:
    71                                  	;mov	byte [si+0], '.'
    72                                  	;mov	byte [si+1], 'M'
    73                                  	;mov	byte [si+2], 'O'
    74                                  	;mov	byte [si+3], 'D'
    75 00000027 66C7042E4D4F44          	mov	dword [si], '.MOD'
    76 0000002E C6440400                	mov	byte [si+4], 0
    77                                  
    78                                  PrintMesg:
    79 00000032 B80009                  	mov	ax, 0900h		; Prints the Credits Text.
    80                                  	;lea	dx, [Credits]
    81 00000035 BA[8B0E]                	mov	dx, Credits
    82 00000038 CD21                    	int	21h
    83                                  
    84                                  	; 13/05/2024
    85 0000003A E8AF0C                  	call	write_ac97_dev_info
    86 0000003D B80009                  	mov	ax, 0900h		; Prints the Credits Text.
    87 00000040 BA[BC0E]                	mov	dx, CRLF
    88 00000043 CD21                    	int	21h
    89                                  LoadMod:  
    90                                  	; es:di = Filename address
    91 00000045 06                      	push	es
    92 00000046 57                      	push	di
    93 00000047 E8A405                  	call    LoadModule		; Load the MODule...
    94                                  
    95 0000004A 833E[8289]00            	cmp     word [ErrorInfo], 0	; any error loading?
    96 0000004F 740A                    	je      short init_codec
    97                                  
    98 00000051 B80009                  	mov     ax, 0900h		; yes, print error and Exit.
    99                                  	;lea    dx, [ErrorMesg]
   100 00000054 BA[BF0E]                	mov	dx, ErrorMesg
   101 00000057 CD21                    	int     21h
   102 00000059 EB60                    	jmp     Exit
   103                                  
   104                                  init_codec:
   105                                  	; 13/05/2024
   106                                  	;call	write_ac97_dev_info
   107                                  
   108                                  	; 08/05/2024
   109                                  	; 17/02/2017
   110                                  	;mov	dx, [stats_cmd]
   111                                          ;or	dl, IO_ENA+BM_ENA		; enable IO and bus master
   112                                          ;call	pciRegWrite16 ; pciRegWrite8
   113                                  
   114                                  	; 18/02/2017
   115                                  	;mov	word [sample_rate], 22050	; Mixing at 22.050 kHz
   116                                  	; 15/05/2024
   117 0000005B C706[C08D]C05D          	mov	word [sample_rate], 24000
   118                                  	; 16/05/2024
   119                                  	;mov	word [sample_rate], 16000
   120                                  
   121                                  	; 08/05/2024
   122                                  	; (48 kHZ mixing is necessary 
   123                                  	;  if the AC97 hardware/codec has not got VRA feature)
   124                                  	; ((or frequency converting code would be needed))
   125                                  	;mov	word [sample_rate], 48000	; Mixing at 48 kHz
   126                                  
   127                                  ; setup the Codec (actually mixer registers)
   128 00000061 E87F02                          call    codecConfig			; unmute codec, set rates.
   129 00000064 731A                    	jnc	short PlayNow
   130                                  
   131                                  _codec_err:
   132 00000066 0E                      	push	cs
   133 00000067 1F                      	pop	ds
   134 00000068 BA[7100]                        mov	dx, CodecErrMsg
   135 0000006B B409                            mov     ah, 9
   136 0000006D CD21                            int     21h
   137 0000006F EB4A                            jmp     Exit
   138                                  
   139 00000071 436F64656320457272-     CodecErrMsg db "Codec Error!"
   139 0000007A 6F7221             
   140 0000007D 0D0A24                  	db	CR,LF,"$"
   141                                  PlayNow:  
   142 00000080 B8[8010]                	mov	ax, BdlBuffer
   143 00000083 A3[6210]                	mov	[BDL_BUFFER], ax
   144                                      
   145 00000086 B8[8011]                	mov	ax, DmaBuffer		; DmaBuffer (4096 bytes) buff addr
   146 00000089 A3[6410]                	mov	[DMA_BUFFER1], ax	; 2048 byte half buffer 1 
   147                                  
   148 0000008C 05003C                  	add	ax, BUFFERSIZE		; code/current segment
   149 0000008F A3[6610]                	mov	[DMA_BUFFER2], ax	; 2048 byte half buffer 2
   150                                    
   151                                  	;mov    word [MixSpeed], 22050	; Mixing at 22.050 kHz
   152                                  
   153 00000092 E8270B                  	call    StartPlaying
   154                                  
   155 00000095 B81300                  	mov     ax, 0013h		; Set Mode 320x200x256
   156 00000098 CD10                    	int     10h
   157                                  
   158 0000009A B98000                  	mov     cx, 128			; Make a lookup table
   159 0000009D 31DB                    	xor     bx, bx			; for fastest pixel
   160 0000009F BA002D                  	mov     dx, 320*(100-64)	; addressing.
   161                                  MakeOfs:        
   162 000000A2 8997[90EA]              	mov     [RowOfs+bx], dx
   163 000000A6 8997[92EA]              	mov     [RowOfs+bx+2], dx
   164 000000AA 81C24001                	add     dx, 320
   165 000000AE 83C304                  	add     bx, 4
   166 000000B1 E2EF                    	loop    MakeOfs
   167                                  
   168                                  ; Note: Normally IRQ 0 calls the ModPlay Polling at 18.2Hz thru
   169                                  ;       the software interrupt 1Ch. If the IRQ 0 is disabled, then
   170                                  ;       the INT 1Ch MUST BE CALLED at least MixSpeed/1024 times per
   171                                  ;       second, or the module will sound "looped".
   172                                  ;       Because we need better sync with the ModPlayer to draw the scope,
   173                                  ;       the polling is called from my routine, and then the irq 0 must be
   174                                  ;       disabled. The [DmaBuffer] points to the current buffer of 8-bit
   175                                  ;       samples played by the Sound Blaster. Note that some samples are
   176                                  ;       discarded in the next code, just for fun!
   177                                  
   178                                  	;in     al, 21h			; disable irq 0!
   179                                  	;or     al, 00000001b
   180                                  	;out    21h, al
   181                                  		
   182 000000B3 E8F003                  	call	ModPlay ; 13/02/2017
   183                                  
   184                                  	;in	al, 21h			; enable irq 0!
   185                                  	;and	al, 11111110b
   186                                  	;out	21h, al
   187                                  
   188 000000B6 B80300                  	mov     ax, 0003h		; Set Text Mode 80x25x16
   189 000000B9 CD10                    	int     10h
   190                                  
   191                                  	; 16/05/2024
   192                                  	;call	StopPlaying		; STOP!
   193                                  Exit:           
   194                                  	;call   FreeModule		; Free MODule core.
   195                                  error_exit:
   196 000000BB B8004C                  	mov     ax, 4C00h		; Bye!
   197 000000BE CD21                    	int     21h
   198                                  here:
   199 000000C0 EBFE                    	jmp	short here
   200                                  
   201                                  pmsg_2017:
   202 000000C2 B80009                  	mov     ax, 0900h		; Prints the Credits Text.
   203                                  	;lea    dx, [msg_2017]
   204 000000C5 BA[2B0E]                	mov	dx, msg_2017
   205 000000C8 CD21                    	int     21h
   206 000000CA EBEF                    	jmp	short Exit
   207                                  
   208                                  DetectICH:
   209                                  	; 18/02/2017
   210                                  	; Detech Intel ICH based AC97 Audio Device 
   211 000000CC E8D301                  	call    pciFindDevice 	; AC97.ASM (PLAYWAV.COM)
   212 000000CF 733F                            jnc     short _1
   213                                  
   214                                  ; couldn't find the audio device!
   215                                  	;push	cs
   216                                  	;pop	ds
   217 000000D1 BA[DA00]                        mov     dx, noDevMsg
   218 000000D4 B409                            mov     ah, 9
   219 000000D6 CD21                            int     21h
   220 000000D8 EBE1                            jmp     short error_exit
   221                                  
   222 000000DA 4572726F723A20556E-     noDevMsg db "Error: Unable to find Intel ICH based audio device!",CR,LF,"$"
   222 000000E3 61626C6520746F2066-
   222 000000EC 696E6420496E74656C-
   222 000000F5 204943482062617365-
   222 000000FE 6420617564696F2064-
   222 00000107 6576696365210D0A24 
   223                                  
   224                                  _1:
   225                                  	; 18/02/2017
   226                                  	; eax = BUS/DEV/FN
   227                                  	;	00000000BBBBBBBBDDDDDFFF00000000
   228                                  	; edx = DEV/VENDOR
   229                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
   230                                  
   231 00000110 66A3[6A10]              	mov	[bus_dev_fn], eax
   232 00000114 668916[6E10]            	mov	[dev_vendor], edx
   233                                  
   234                                  	; get ICH base address regs for mixer and bus master
   235                                  
   236 00000119 B010                            mov     al, NAMBAR_REG
   237 0000011B E8F600                          call    pciRegRead16			; read PCI registers 10-11
   238                                          ;and    dx, IO_ADDR_MASK 		; mask off BIT0
   239                                  	; 14/05/2024
   240 0000011E 80E2FE                  	and	dl, 0FEh
   241                                  
   242 00000121 8916[5410]                      mov     [NAMBAR], dx			; save audio mixer base addr
   243                                  
   244 00000125 B014                    	mov     al, NABMBAR_REG
   245 00000127 E8EA00                          call    pciRegRead16
   246                                          ;and    dx, IO_ADDR_MASK
   247                                  	; 14/05/2024
   248 0000012A 80E2C0                  	and	dl, 0C0h
   249                                  
   250 0000012D 8916[5610]                      mov     [NABMBAR], dx			; save bus master base addr
   251                                  
   252                                  	; 08/05/2024
   253                                  	; 06/11/2023
   254                                  	;; init controller
   255                                  	;; 17/02/2017
   256                                  	;mov	al, PCI_CMD_REG ; command register (04h)
   257                                  	;call	pciRegRead16 ; pciRegRead8
   258                                  	;
   259                                  	;; eax = BUS/DEV/FN/REG
   260                                  	;;  dx = PCI Command Register Content ; 17/02/2017
   261                                  	;; 	00000000CCCCCCCC
   262                                  	;mov	[stats_cmd], dx
   263                                  	;
   264                                  	; 06/11/2023
   265                                  	;mov	al, PCI_IO_BASE ; IO base address register (10h)
   266                                  	;call	pciRegRead32
   267                                  	;
   268                                  	;and	dx, 0FFC0h	; IO_ADDR_MASK (0FFFE) ?
   269                                          ;mov	[ac97_io_base], dx
   270                                  
   271 00000131 B03C                    	mov	al, AC97_INT_LINE ; Interrupt line register (3Ch)
   272 00000133 E8D600                  	call	pciRegRead8 ; 17/02/2017
   273                                  
   274 00000136 8816[6810]              	mov     [ac97_int_ln_reg], dl
   275                                  
   276                                  	; 28/11/2016
   277                                  	;mov	bx, 1	; 08/05/2024
   278 0000013A 30F6                    	xor	dh, dh	; 17/02/2017
   279                                  	; 10/11/2023
   280                                  	;mov	cx, dx
   281                                  	;shl	bx, cl
   282                                  
   283                                  	; 04/11/2023
   284 0000013C FA                      	cli
   285                                  
   286                                  	;not	bx
   287 0000013D E4A1                    	in	al, 0A1h ; irq 8-15
   288 0000013F 88C4                            mov	ah, al
   289 00000141 E421                            in	al, 21h  ; irq 0-7
   290                                  
   291                                  	; 04/11/2023
   292                                  	; save IRQ status
   293 00000143 A3[5C10]                	mov	[IRQ_status], ax
   294                                  
   295                                  	; 12/05/2024 (enable AC97 IRQ)
   296                                  	;mov	cl, dl
   297                                  	;mov	bx, 1
   298                                  	;shl	bx, cl
   299                                  	;not	bx
   300                                  	;and	ax, bx
   301                                  	;out	21h, al
   302                                  	;mov	al, ah
   303                                  	;out	0A1h, al
   304                                  
   305                                  	; 15/05/2024
   306                                  	;and	ax, bx   ; unmask
   307 00000146 0FB3D0                   	btr	ax, dx	 ; unmask
   308 00000149 E621                    	out	21h, al  ; enable interrupt (if irq <= 7)
   309 0000014B 88E0                    	mov	al, ah
   310 0000014D E6A1                    	out	0A1h, al ; enable interrupt (if irq > 7)
   311                                  	;not	bx
   312                                  
   313                                  	; 08/05/2024
   314                                  	;mov	dx, 4D1h			;8259 ELCR1
   315                                          ;in	al, dx
   316                                  	;mov	ah, al
   317                                  	;mov	dx, 4D0h
   318                                          ;in	al, dx
   319                                  	;;or	ax, bx
   320                                  	;bts	ax, cx
   321                                  	;mov	dx, 4D0h
   322                                  	;out	dx, al                          ;set level-triggered mode
   323                                  	;mov	al, ah
   324                                  	;mov	dx, 4D1h
   325                                  	;out	dx, al                          ;set level-triggered mode
   326                                  
   327                                  	; 24/11/2016 - Erdogan Tan
   328                                  	;mov	bx, cx
   329                                  	; 10/11/2023
   330 0000014F 89D3                    	mov	bx, dx
   331 00000151 8A9F[440F]              	mov	bl, [bx+irq_int]
   332 00000155 C1E302                  	shl	bx, 2 ; * 4
   333                                  
   334                                  	; set up interrupt vector
   335                                  	; 30/11/2016
   336 00000158 06                      	push	es
   337 00000159 31C0                    	xor	ax, ax
   338 0000015B 8EC0                    	mov	es, ax
   339                                  	; 04/11/2023
   340                                  	; save interrupt vector
   341                                  	;mov	ax, [es:bx]
   342                                  	; 13/05/2024
   343 0000015D B8[7201]                	mov	ax, ac97_int_handler
   344 00000160 268707                  	xchg	ax, [es:bx]
   345 00000163 A3[5E10]                	mov	[IRQ_vector], ax
   346                                  	;mov	ax, [es:bx+2]
   347                                  	; 13/05/2024
   348 00000166 8CC8                    	mov	ax, cs
   349 00000168 26874702                	xchg	ax, [es:bx+2]
   350 0000016C A3[6010]                	mov	[IRQ_vector+2], ax
   351                                  
   352                                  	; 13/05/2024
   353                                  	;mov	word [es:bx], ac97_int_handler
   354                                  	;mov	ax, cs
   355                                  	;mov	[es:bx+2], ax
   356                                  	
   357 0000016F 07                      	pop	es
   358                                  
   359                                  	; 04/11/2023
   360 00000170 FB                      	sti
   361                                  
   362 00000171 C3                      	retn
   363                                  
   364                                  ; 16/05/2024
   365                                  %if 0
   366                                  	; 15/05/2024
   367                                  ac97_int_handler:
   368                                  	; 13/05/2024
   369                                  	; 12/05/2024
   370                                  	; 11/05/2024
   371                                  	; 11/11/2023
   372                                  	; 10/11/2023
   373                                  	; 17/02/2016
   374                                  	push	eax	; 11/11/2023
   375                                  	push	dx
   376                                  	; 05/11/2023
   377                                  	;push	cx
   378                                  	;push	bx
   379                                  	;push	si
   380                                  	;push	di
   381                                  
   382                                  	; 10/11/2023
   383                                  	; EOI at first
   384                                  	mov	al, 20h
   385                                  	test	byte [ac97_int_ln_reg], 8
   386                                  	jz	short _ih_0
   387                                  	out 	0A0h, al ; 20h	; EOI
   388                                  _ih_0:
   389                                  	out	20h, al  ; 20h	; EOI
   390                                  
   391                                  	; 11/11/2023
   392                                  	; 09/11/2023
   393                                  	mov	dx, GLOB_STS_REG
   394                                          add	dx, [NABMBAR]
   395                                  	in	eax, dx
   396                                  
   397                                  	; 12/05/2024
   398                                  	; 09/11/2023
   399                                  	;cmp	eax, 0FFFFFFFFh ; -1
   400                                  	;je	short _ih_3
   401                                  	; 15/05/2024
   402                                  	inc	eax	; 0FFFFFFFFh
   403                                  	jz	short _ih_3
   404                                  	dec	eax	; 0
   405                                  	jz	short _ih_3
   406                                  
   407                                  	; 15/05/2024
   408                                  	cmp	byte [tLoop], 1
   409                                  	jb	short _ih_2
   410                                  
   411                                  	; 12/05/2024
   412                                  	;test	al, 40h		; PCM Out Interrupt
   413                                  	; 15/05/2024
   414                                  	test	al, PCM_OUT_IRQ
   415                                  	jnz	short _ih_1
   416                                  
   417                                  	; 15/05/2024
   418                                  	;test	eax, eax
   419                                  	;jz	short _ih_3
   420                                  
   421                                  	; 12/05/2024
   422                                  	;test	ax, PCM_OUT_IRQ
   423                                  	;jnz	short _ih_1
   424                                  
   425                                   	;mov	dx, GLOB_STS_REG
   426                                          ;add	dx, [NABMBAR]
   427                                  	; 12/05/2024
   428                                  	;out	dx, eax
   429                                  	jmp	short _ih_2
   430                                  	;jmp	short _ih_3
   431                                  
   432                                  	; .....
   433                                  	;mov	al, 1
   434                                  	; 10/11/2023
   435                                  	;mov	[tLoop], al  ; 1
   436                                  
   437                                  	;cmp	[inside], al ; 1
   438                                  	;jnb	short _ih_2	; busy
   439                                  
   440                                  	;mov	[inside], al ; 1
   441                                  	;
   442                                  	;; 09/11/2023
   443                                          ;mov	dx, [NABMBAR]
   444                                          ;add	dx, PO_SR_REG	; set pointer to Status reg
   445                                  	;in	al, dx
   446                                  	;; 10/11/2023
   447                                  	;;;out	dx, eax
   448                                  	;;out	dx, al		; clear interrupt event
   449                                  	;			; (by writing 1 to same bits)
   450                                  	;
   451                                  	;;mov	[pcm_irq_status], al ; 05/11/2023
   452                                  	;test	al, BCIS ; Buffer Completion Interrupt Status (Bit 3)
   453                                  	;jz	short _ih_3
   454                                  	; .....
   455                                  
   456                                  _ih_1:
   457                                  	; 11/11/2023
   458                                  	;push	eax
   459                                  	; 15/05/2024
   460                                  	push	ax
   461                                  
   462                                  	; 13/05/2024
   463                                  	mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   464                                  	mov	dx, PO_SR_REG
   465                                          add	dx, [NABMBAR]
   466                                  	out	dx, ax
   467                                  
   468                                  	; 13/05/2024
   469                                  	mov	dx, PO_CIV_REG
   470                                          add	dx, [NABMBAR]
   471                                  	in	al, dx
   472                                  	mov	ah, al
   473                                  	dec	al
   474                                  	and	al, 1Fh
   475                                          mov     dx, PO_LVI_REG
   476                                          add	dx, [NABMBAR]
   477                                          out	dx, al
   478                                  	and	ah, 1
   479                                  	; 13/05/2024
   480                                  	inc	ah
   481                                  	mov	[tBuff], ah ; 1 = Buffer 1, 2 = Buffer 2
   482                                  
   483                                  	; 13/05/2024
   484                                  	; 10/11/2023
   485                                  	; 28/11/2016 - Erdogan Tan
   486                                  	;call	tuneLoop
   487                                  
   488                                  	; 11/11/2023
   489                                  	;pop	eax
   490                                  	; 15/05/2024
   491                                  	pop	ax
   492                                  
   493                                  	mov	dx, GLOB_STS_REG
   494                                          add	dx, [NABMBAR]
   495                                  _ih_2:			; 12/05/2024
   496                                  	out	dx, eax
   497                                  
   498                                  	; 12/05/2024
   499                                  _ih_3:
   500                                  	; 11/11/2023
   501                                  	;mov	dx, [NABMBAR]
   502                                  	;add	dx, PO_SR_REG	; set pointer to Status reg
   503                                  	;mov	ax, 1Ch
   504                                  	;out	dx, ax
   505                                  
   506                                  ;	; 10/11/2023
   507                                  ;	mov	al, 20h
   508                                  ;	test	byte [ac97_int_ln_reg], 8
   509                                  ;	jz	short _ih_3
   510                                  ;	out 	0A0h, al ; 20h	; EOI
   511                                  ;_ih_3:
   512                                  ;	out	20h, al  ; 20h	; EOI
   513                                  ;_ih_4:
   514                                  	;mov	byte [inside], 0
   515                                  	;pop	di
   516                                  	;pop	si
   517                                  	;pop	bx
   518                                  	;pop	cx
   519                                  	pop	dx
   520                                  	pop	eax ; 11/11/2023
   521                                  	iret
   522                                  %else
   523                                  	; 16/05/2024
   524                                  	; 15/05/2024
   525                                  ac97_int_handler:
   526                                  	; 13/05/2024
   527                                  	; 12/05/2024
   528                                  	; 11/05/2024
   529                                  	; 11/11/2023
   530                                  	; 10/11/2023
   531                                  	; 17/02/2016
   532 00000172 50                      	push	ax ; +	; 16/05/2024
   533                                  	;push	eax ; *	; 11/11/2023
   534 00000173 52                      	push	dx ; **
   535                                  	; 05/11/2023
   536                                  	;push	cx
   537                                  	;push	bx
   538                                  	;push	si
   539                                  	;push	di
   540                                  
   541                                  	; 16/05/2024
   542                                  	; 10/11/2023
   543                                  	; EOI at first
   544 00000174 B020                    	mov	al, 20h
   545 00000176 F606[6810]08            	test	byte [ac97_int_ln_reg], 8
   546 0000017B 7402                    	jz	short _ih_0
   547 0000017D E6A0                    	out 	0A0h, al ; 20h	; EOI
   548                                  _ih_0:
   549 0000017F E620                    	out	20h, al  ; 20h	; EOI
   550                                  
   551                                  	; 16/05/2024
   552                                  ;	mov	dx, GLOB_STS_REG
   553                                  ;	add	dx, [NABMBAR]
   554                                  ;	in	eax, dx
   555                                  ;
   556                                  ;	inc	eax	; 0FFFFFFFFh
   557                                  ;	jz	short _ih_3
   558                                  ;	dec	eax	; 0
   559                                  ;	;jz	short _ih_3
   560                                  ;_ih_3:
   561                                  ;	; 16/05/2024
   562                                  ;	push	eax ; ***
   563                                  
   564                                  	; 16/05/2024
   565                                  	; 24/11/2023 (TRDOS386 'audio.s')
   566 00000181 8B16[5610]                      mov	dx, [NABMBAR]
   567 00000185 83C216                  	add	dx, PO_SR_REG
   568 00000188 ED                      	in	ax, dx
   569                                  
   570 00000189 A808                    	test	al, BCIS ; bit 3, 8
   571 0000018B 7428                    	jz	short _ih_2
   572                                  
   573                                  	; 15/05/2024
   574 0000018D 803E[5B10]01            	cmp	byte [tLoop], 1
   575 00000192 7221                    	jb	short _ih_2
   576                                  _ih_1:
   577                                  	; 16/05/2024
   578                                  	; 13/05/2024
   579                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   580                                  	;add	dx, PO_SR_REG
   581                                          ;add	dx, [NABMBAR]
   582                                  	;out	dx, ax
   583                                  
   584                                  	; 16/05/2024
   585 00000194 50                      	push	ax ; ****
   586                                  
   587                                  	; 13/05/2024
   588 00000195 BA1400                  	mov	dx, PO_CIV_REG
   589 00000198 0316[5610]                      add	dx, [NABMBAR]
   590 0000019C EC                      	in	al, dx
   591 0000019D 88C4                    	mov	ah, al
   592 0000019F FEC8                    	dec	al
   593 000001A1 241F                    	and	al, 1Fh
   594 000001A3 BA1500                          mov     dx, PO_LVI_REG
   595 000001A6 0316[5610]                      add	dx, [NABMBAR]
   596 000001AA EE                              out	dx, al
   597 000001AB 80E401                  	and	ah, 1
   598                                  	; 13/05/2024
   599 000001AE FEC4                    	inc	ah
   600 000001B0 8826[5810]              	mov	[tBuff], ah ; 1 = Buffer 1, 2 = Buffer 2
   601                                  
   602                                  	; 13/05/2024
   603                                  	; 10/11/2023
   604                                  	; 28/11/2016 - Erdogan Tan
   605                                  	;call	tuneLoop
   606                                  
   607                                  	; 16/05/2024
   608 000001B4 58                      	pop	ax ; ****
   609                                  
   610                                  	; 16/05/2024
   611                                  _ih_2:
   612                                  	;mov	ax, 1Ch ; FIFOE(=16)+BCIS(=8)+LVBCI(=4)
   613 000001B5 8B16[5610]              	mov	dx, [NABMBAR]
   614 000001B9 83C216                  	add	dx, PO_SR_REG
   615 000001BC EF                      	out	dx, ax
   616                                  
   617                                  ;	; 16/05/2024
   618                                  ;	pop	eax ; ***
   619                                  ;	
   620                                  ;	or	eax, eax
   621                                  ;	jz	short _ih_4
   622                                  ;	
   623                                  ;	mov	dx, GLOB_STS_REG
   624                                  ;	add	dx, [NABMBAR]
   625                                  ;	out	dx, eax
   626                                  
   627                                  	; 16/05/2024
   628                                  _ih_4:
   629                                  	; 10/11/2023
   630                                  	;mov	al, 20h
   631                                  	;test	byte [ac97_int_ln_reg], 8
   632                                  	;jz	short _ih_5
   633                                  	;out 	0A0h, al ; 20h	; EOI
   634                                  ;_ih_5:
   635                                  	;out	20h, al  ; 20h	; EOI
   636                                  ;_ih_6:
   637                                  	;pop	di
   638                                  	;pop	si
   639                                  	;pop	bx
   640                                  	;pop	cx
   641 000001BD 5A                      	pop	dx ; **
   642                                  	;pop	eax ; *	; 11/11/2023
   643 000001BE 58                      	pop	ax ; + ; 16/05/2024
   644 000001BF CF                      	iret
   645                                  %endif
   646                                  
   647                                  ;=============================================================================
   648                                  ;               PCI.ASM
   649                                  ;=============================================================================
   650                                  
   651                                  ; EQUATES
   652                                  
   653                                  ;constants of stuff that seem hard to remember at times.
   654                                  
   655                                  TRUE  EQU 1
   656                                  FALSE EQU 0
   657                                  
   658                                  ENABLED  EQU 1
   659                                  DISABLED EQU 0
   660                                  
   661                                  BIT0  EQU 1
   662                                  BIT1  EQU 2
   663                                  BIT2  EQU 4
   664                                  BIT3  EQU 8
   665                                  BIT4  EQU 10h
   666                                  BIT5  EQU 20h
   667                                  BIT6  EQU 40h
   668                                  BIT7  EQU 80h
   669                                  BIT8  EQU 100h
   670                                  BIT9  EQU 200h
   671                                  BIT10 EQU 400h
   672                                  BIT11 EQU 800h
   673                                  BIT12 EQU 1000h
   674                                  BIT13 EQU 2000h
   675                                  BIT14 EQU 4000h
   676                                  BIT15 EQU 8000h
   677                                  BIT16 EQU 10000h
   678                                  BIT17 EQU 20000h
   679                                  BIT18 EQU 40000h
   680                                  BIT19 EQU 80000h
   681                                  BIT20 EQU 100000h
   682                                  BIT21 EQU 200000h
   683                                  BIT22 EQU 400000h
   684                                  BIT23 EQU 800000h
   685                                  BIT24 EQU 1000000h
   686                                  BIT25 EQU 2000000h
   687                                  BIT26 EQU 4000000h
   688                                  BIT27 EQU 8000000h
   689                                  BIT28 EQU 10000000h
   690                                  BIT29 EQU 20000000h
   691                                  BIT30 EQU 40000000h
   692                                  BIT31 EQU 80000000h
   693                                  
   694                                  ;special characters
   695                                  NUL     EQU 0
   696                                  NULL    EQU 0
   697                                  BELL    EQU 07
   698                                  BS      EQU 08
   699                                  TAB     EQU 09
   700                                  LF      EQU 10
   701                                  CR      EQU 13
   702                                  ESCAPE  EQU 27           ;ESC is a reserved word....
   703                                  
   704                                  
   705                                  ;file stuff
   706                                  READONLY  EQU   BIT0
   707                                  HIDDEN    EQU   BIT1
   708                                  SYSTEM    EQU   BIT2
   709                                  VOLUME    EQU   BIT3         ;ignored for file access
   710                                  DIRECTORY EQU   BIT4         ;must be 0 for file access
   711                                  ARCHIVE   EQU   BIT5
   712                                  SHAREABLE EQU   BIT7         ;for novell networks
   713                                  OPEN	EQU	2		; open existing file
   714                                  CREATE	EQU	1		; create new file
   715                                  
   716                                  ; PCI equates
   717                                  ; PCI function address (PFA)
   718                                  ; bit 31 = 1
   719                                  ; bit 23:16 = bus number     (0-255)
   720                                  ; bit 15:11 = device number  (0-31)
   721                                  ; bit 10:8 = function number (0-7)
   722                                  ; bit 7:0 = register number  (0-255)
   723                                  
   724                                  IO_ADDR_MASK    EQU     0FFFEh          ; mask off bit 0 for reading BARs
   725                                  PCI_INDEX_PORT  EQU     0CF8h
   726                                  PCI_DATA_PORT   EQU     0CFCh
   727                                  PCI32           EQU     BIT31           ; bitflag to signal 32bit access
   728                                  PCI16           EQU     BIT30           ; bitflag for 16bit access
   729                                  
   730                                  PCI_FN0         EQU     0 << 8
   731                                  PCI_FN1         EQU     1 << 8
   732                                  PCI_FN2         EQU     2 << 8
   733                                  PCI_FN3         EQU     3 << 8
   734                                  PCI_FN4         EQU     4 << 8
   735                                  PCI_FN5         EQU     5 << 8
   736                                  PCI_FN6         EQU     6 << 8
   737                                  PCI_FN7         EQU     7 << 8
   738                                  
   739                                  PCI_CMD_REG		EQU	04h		; reg 04, command reg
   740                                   IO_ENA			EQU	BIT0		; i/o decode enable
   741                                   MEM_ENA		EQU	BIT1		; memory decode enable
   742                                   BM_ENA                 EQU     BIT2		; bus master enable
   743                                  
   744                                  ; CODE
   745                                  
   746                                  ; AC97.ASM
   747                                  ; PCI device register reader/writers.
   748                                  ; NASM version: Erdogan Tan (29/11/2016)
   749                                  ; 		Last Update: 17/02/2017
   750                                  
   751                                  ;===============================================================
   752                                  ; 8/16/32bit PCI reader
   753                                  ;
   754                                  ; Entry: EAX=PCI Bus/Device/fn/register number
   755                                  ;           BIT30 set if 32 bit access requested
   756                                  ;           BIT29 set if 16 bit access requested
   757                                  ;           otherwise defaults to 8bit read
   758                                  ;
   759                                  ; Exit:  DL,DX,EDX register data depending on requested read size
   760                                  ;
   761                                  ; Note: this routine is meant to be called via pciRegRead8, pciRegread16,
   762                                  ;	or pciRegRead32, listed below.
   763                                  ;
   764                                  ; Note2: don't attempt to read 32bits of data from a non dword aligned reg
   765                                  ;	 number.  Likewise, don't do 16bit reads from non word aligned reg #
   766                                  ; 
   767                                  pciRegRead:
   768 000001C0 6653                    	push	ebx
   769 000001C2 51                      	push	cx
   770 000001C3 6689C3                          mov     ebx, eax                        ; save eax, dh
   771 000001C6 88F1                            mov     cl, dh
   772 000001C8 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   773 000001CE 660D00000080                    or      eax, BIT31                      ; make a PCI access request
   774 000001D4 24FC                            and     al, ~3 ; NOT 3                  ; force index to be dword
   775                                  
   776 000001D6 BAF80C                          mov     dx, PCI_INDEX_PORT
   777 000001D9 66EF                            out     dx, eax                         ; write PCI selector
   778                                  
   779 000001DB BAFC0C                          mov     dx, PCI_DATA_PORT
   780 000001DE 88D8                            mov     al, bl
   781 000001E0 2403                            and     al, 3                           ; figure out which port to
   782 000001E2 00C2                            add     dl, al                          ; read to
   783                                  
   784 000001E4 66ED                    	in      eax, dx                         ; do 32bit read
   785 000001E6 66F7C300000080                  test    ebx, PCI32
   786 000001ED 7403                            jz      short _pregr1
   787                                  
   788 000001EF 6689C2                          mov     edx, eax                        ; return 32bits of data
   789                                  _pregr1:
   790 000001F2 89C2                    	mov     dx, ax                          ; return 16bits of data
   791 000001F4 66F7C3000000C0                  test    ebx, PCI32+PCI16
   792 000001FB 7502                            jnz     short _pregr2
   793 000001FD 88CE                            mov     dh, cl                          ; restore dh for 8 bit read
   794                                  _pregr2:
   795 000001FF 6689D8                          mov     eax, ebx                        ; restore eax
   796 00000202 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   797 00000208 59                      	pop	cx
   798 00000209 665B                    	pop	ebx
   799 0000020B C3                      	retn
   800                                  
   801                                  pciRegRead8:
   802 0000020C 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32             ; set up 8 bit read size
   803 00000212 EBAC                            jmp     short pciRegRead		; call generic PCI access
   804                                  
   805                                  pciRegRead16:
   806 00000214 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 16 bit read size
   807 0000021A 660D00000040                    or      eax, PCI16			; call generic PCI access
   808 00000220 EB9E                            jmp     short pciRegRead
   809                                  
   810                                  pciRegRead32:
   811 00000222 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 32 bit read size
   812 00000228 660D00000080                    or      eax, PCI32			; call generic PCI access
   813 0000022E EB90                            jmp     short pciRegRead
   814                                  
   815                                  ;===============================================================
   816                                  ; 8/16/32bit PCI writer
   817                                  ;
   818                                  ; Entry: EAX=PCI Bus/Device/fn/register number
   819                                  ;           BIT31 set if 32 bit access requested
   820                                  ;           BIT30 set if 16 bit access requested
   821                                  ;           otherwise defaults to 8bit read
   822                                  ;        DL/DX/EDX data to write depending on size
   823                                  ;
   824                                  ;
   825                                  ; note: this routine is meant to be called via pciRegWrite8, pciRegWrite16,
   826                                  ; 	or pciRegWrite32 as detailed below.
   827                                  ;
   828                                  ; Note2: don't attempt to write 32bits of data from a non dword aligned reg
   829                                  ;	 number.  Likewise, don't do 16bit writes from non word aligned reg #
   830                                  ;
   831                                  pciRegWrite:
   832 00000230 6653                    	push	ebx
   833 00000232 51                      	push	cx
   834 00000233 6689C3                          mov     ebx, eax                        ; save eax, dx
   835 00000236 89D1                            mov     cx, dx
   836 00000238 660D00000080                    or      eax, BIT31                      ; make a PCI access request
   837 0000023E 6625FFFFFFBF                    and     eax, ~PCI16 ; NOT PCI16         ; clear out data size request
   838 00000244 24FC                            and     al, ~3 ; NOT 3                  ; force index to be dword
   839                                  
   840 00000246 BAF80C                          mov     dx, PCI_INDEX_PORT
   841 00000249 66EF                            out     dx, eax                         ; write PCI selector
   842                                  
   843 0000024B BAFC0C                          mov     dx, PCI_DATA_PORT
   844 0000024E 88D8                            mov     al, bl
   845 00000250 2403                            and     al, 3                           ; figure out which port to
   846 00000252 00C2                            add     dl, al                          ; write to
   847                                  
   848 00000254 6689D0                          mov     eax, edx                        ; put data into eax
   849 00000257 89C8                            mov     ax, cx
   850                                  
   851 00000259 EE                              out     dx, al
   852 0000025A 66F7C3000000C0                  test    ebx, PCI16+PCI32                ; only 8bit access? bail
   853 00000261 740C                            jz      short _pregw1
   854                                  
   855 00000263 EF                              out     dx, ax                          ; write 16 bit value
   856 00000264 66F7C300000040                  test    ebx, PCI16                      ; 16bit requested?  bail
   857 0000026B 7502                            jnz     short _pregw1
   858                                  
   859 0000026D 66EF                            out     dx, eax                         ; write full 32bit
   860                                  _pregw1:
   861 0000026F 6689D8                          mov     eax, ebx                        ; restore eax
   862 00000272 6625FFFFFFBF                    and     eax, (~PCI32)+PCI16             ; clear out data size request
   863 00000278 89CA                            mov     dx, cx                          ; restore dx
   864 0000027A 59                      	pop	cx
   865 0000027B 665B                    	pop	ebx
   866 0000027D C3                      	ret
   867                                  
   868                                  pciRegWrite8:
   869 0000027E 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 8 bit write size
   870 00000284 EBAA                            jmp     short pciRegWrite		; call generic PCI access
   871                                  
   872                                  pciRegWrite16:
   873 00000286 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 16 bit write size
   874 0000028C 660D00000040                    or      eax, PCI16			; call generic PCI access
   875 00000292 EB9C                            jmp     short pciRegWrite
   876                                  
   877                                  pciRegWrite32:
   878 00000294 6625FFFFFF3F                    and     eax, (~PCI16)+PCI32		; set up 32 bit write size
   879 0000029A 660D00000080                    or      eax, PCI32			; call generic PCI access
   880 000002A0 EB8E                            jmp     short pciRegWrite
   881                                  
   882                                  ; AC97.ASM (PLAYWAV.COM)
   883                                  ; 17/02/2017 (Modifed by Erdogan Tan for various ICH device IDs)
   884                                  ;===============================================================
   885                                  ; PCIFindDevice: scan through PCI space looking for a device+vendor ID
   886                                  ;
   887                                  ;  ENTRY: none
   888                                  ;; Entry: EAX=Device+Vendor ID
   889                                  ;
   890                                  ;  Exit: EAX=PCI address if device found
   891                                  ;	 EDX=Device+Vendor ID
   892                                  ;        CY clear if found, set if not found. EAX invalid if CY set.
   893                                  ;
   894                                  ; [old stackless] Destroys: ebx, esi, edi, cl
   895                                  ;
   896                                  pciFindDevice:
   897                                  	;push	cx
   898                                  	;push	eax ; *
   899                                  	;push	esi
   900                                  	;push	edi
   901                                  
   902                                   	;mov     esi, eax                ; save off vend+device ID
   903                                  
   904                                  	; 17/02/2017
   905 000002A2 BE[540F]                	mov	si, valid_ids	; address of Valid ICH (AC97) Device IDs
   906 000002A5 B91500                  	mov	cx, valid_id_count
   907                                  pfd_0:
   908 000002A8 66BF00FFFF7F                   	mov     edi, (80000000h - 100h) ; start with bus 0, dev 0 func 0
   909                                  nextPCIdevice:
   910 000002AE 6681C700010000                  add     edi, 100h
   911 000002B5 6681FF00F8FF80                  cmp     edi, 80FFF800h		; scanned all devices?
   912                                          ;stc
   913                                          ;je 	short PCIScanExit       ; not found
   914 000002BC 720D                    	jb	short pfd_1
   915 000002BE 66BF00000080            	mov     edi, 80000000h
   916 000002C4 83C604                  	add	si, 4 ; scan for next device ID
   917 000002C7 E202                    	loop	pfd_1	 
   918 000002C9 F9                      	stc	
   919                                  	;jmp 	short PCIScanExit
   920 000002CA C3                      	retn
   921                                  pfd_1:
   922 000002CB 6689F8                          mov     eax, edi                ; read PCI registers
   923 000002CE E851FF                          call    pciRegRead32
   924                                          ;cmp    edx, esi                ; found device?
   925 000002D1 663B14                          cmp	edx, dword [si]
   926 000002D4 75D8                    	jne     short nextPCIdevice
   927                                          ;clc
   928                                  PCIScanExit:
   929                                  	;pushf
   930 000002D6 66B800000080            	mov	eax, BIT31
   931 000002DC 66F7D0                  	not	eax
   932 000002DF 6621F8                  	and	eax, edi		; return only bus/dev/fn #
   933                                  	;popf
   934                                  
   935                                  	;pop	edi
   936                                  	;pop	esi
   937                                  	;pop	edx ; *
   938                                  	;pop	cx
   939 000002E2 C3                      	retn
   940                                  
   941                                  ;=============================================================================
   942                                  ;               CODEC.ASM
   943                                  ;=============================================================================
   944                                  
   945                                  ; EQUATES
   946                                  
   947                                  ;Codec registers.
   948                                  ;
   949                                  ;Not all codecs are created equal. Refer to the spec for your specific codec.
   950                                  ;
   951                                  ;All registers are 16bits wide.  Access to codec registers over the AC97 link
   952                                  ;is defined by the OEM.  
   953                                  ;
   954                                  ;Secondary codec's are accessed by ORing in BIT7 of all register accesses.
   955                                  ;
   956                                  
   957                                  ; each codec/mixer register is 16bits
   958                                  
   959                                  CODEC_RESET_REG                 equ     00      ; reset codec
   960                                  CODEC_MASTER_VOL_REG            equ     02      ; master volume
   961                                  CODEC_HP_VOL_REG                equ     04      ; headphone volume
   962                                  CODEC_MASTER_MONO_VOL_REG       equ     06      ; master mono volume
   963                                  CODEC_MASTER_TONE_REG           equ     08      ; master tone (R+L)
   964                                  CODEC_PCBEEP_VOL_REG            equ     0ah     ; PC beep volume
   965                                  CODEC_PHONE_VOL_REG             equ     0bh     ; phone volume
   966                                  CODEC_MIC_VOL_REG               equ     0eh     ; MIC volume
   967                                  CODEC_LINE_IN_VOL_REG           equ     10h     ; line input volume
   968                                  CODEC_CD_VOL_REG                equ     12h     ; CD volume
   969                                  CODEC_VID_VOL_REG               equ     14h     ; video volume
   970                                  CODEC_AUX_VOL_REG               equ     16h     ; aux volume
   971                                  CODEC_PCM_OUT_REG               equ     18h     ; PCM output volume
   972                                  CODEC_RECORD_SELECT_REG         equ     1ah     ; record select input
   973                                  CODEC_RECORD_VOL_REG            equ     1ch     ; record volume
   974                                  CODEC_RECORD_MIC_VOL_REG        equ     1eh     ; record mic volume
   975                                  CODEC_GP_REG                    equ     20h     ; general purpose
   976                                  CODEC_3D_CONTROL_REG            equ     22h     ; 3D control
   977                                  ; 24h is reserved
   978                                  CODEC_POWER_CTRL_REG            equ     26h     ; powerdown control
   979                                  CODEC_EXT_AUDIO_REG             equ     28h     ; extended audio
   980                                  CODEC_EXT_AUDIO_CTRL_REG        equ     2ah     ; extended audio control
   981                                  CODEC_PCM_FRONT_DACRATE_REG     equ     2ch     ; PCM out sample rate
   982                                  CODEC_PCM_SURND_DACRATE_REG     equ     2eh     ; surround sound sample rate
   983                                  CODEC_PCM_LFE_DACRATE_REG       equ     30h     ; LFE sample rate
   984                                  CODEC_LR_ADCRATE_REG            equ     32h     ; PCM in sample rate
   985                                  CODEC_MIC_ADCRATE_REG           equ     34h     ; mic in sample rate
   986                                  
   987                                  ; registers 36-7a are reserved on the ICH
   988                                  
   989                                  CODEC_VENDORID1_REG             equ     7ch     ; codec vendor ID 1
   990                                  CODEC_VENDORID2_REG             equ     7eh     ; codec vendor ID 2
   991                                  
   992                                  ; Mixer registers 0 through 51h reside in the ICH and are not forwarded over
   993                                  ; the AC97 link to the codec, which I think is a little weird.  Looks like
   994                                  ; the ICH makes it so you don't need a fully functional codec to play audio?
   995                                  ;
   996                                  ; whenever 2 codecs are present in the system, use BIT7 to access the 2nd
   997                                  ; set of registers, ie 80h-feh
   998                                  
   999                                  PRIMARY_CODEC                   equ     0       ; 0-7F for primary codec
  1000                                  SECONDARY_CODEC                 equ     BIT7    ; 80-8f registers for 2ndary
  1001                                  
  1002                                  SAMPLE_RATE_441khz	equ     44100   ; 44.1Khz (cd quality) rate
  1003                                  
  1004                                  ; ----------------------------------------------------------------------------
  1005                                  ; 17/02/2017
  1006                                  PCI_IO_BASE	equ 10h			; = NAMBAR register offset
  1007                                  AC97_INT_LINE   equ 3Ch			; AC97 Interrupt Line register offset
  1008                                  
  1009                                  ; ----------------------------------------------------------------------------
  1010                                  ; ICH2AC97.INC
  1011                                  ; ----------------------------------------------------------------------------
  1012                                  
  1013                                  ; PCI stuff
  1014                                  
  1015                                  ; Intel ICH2 equates. It is assumed that ICH0 and plain ole ICH are compatible.
  1016                                  
  1017                                  INTEL_VID       equ     8086h           ; Intel's PCI vendor ID
  1018                                  
  1019                                  ; 08/05/2024
  1020                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
  1021                                  SIS_VID		equ	1039h
  1022                                  NVIDIA_VID	equ	10DEh	 ; Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source c.
  1023                                  AMD_VID		equ	1022h
  1024                                  
  1025                                  ICH_DID         equ     2415h           ; ICH device ID
  1026                                  ICH0_DID        equ     2425h           ; ICH0
  1027                                  ICH2_DID        equ     2445h           ; ICH2 I think there are more ICHes.
  1028                                                                          ; they all should be compatible.
  1029                                  ; 08/05/2024
  1030                                  ; 17/02/2017 (Erdogan Tan, ref: ALSA Device IDs, ALSA project)
  1031                                  ICH3_DID	equ     2485h           ; ICH3
  1032                                  ICH4_DID        equ     24C5h           ; ICH4
  1033                                  ICH5_DID	equ     24D5h           ; ICH5 
  1034                                  ICH6_DID	equ     266Eh           ; ICH6
  1035                                  ESB6300_DID	equ     25A6h           ; 6300ESB
  1036                                  ESB631X_DID	equ     2698h           ; 631XESB
  1037                                  ICH7_DID	equ	27DEh		; ICH7
  1038                                  ; 03/11/2023 - Erdogan Tan (Ref: MenuetOS AC97 WAV Player source code, 2004)
  1039                                  MX82440_DID	equ	7195h
  1040                                  SI7012_DID	equ	7012h
  1041                                  NFORCE_DID	equ	01B1h
  1042                                  NFORCE2_DID	equ	006Ah
  1043                                  AMD8111_DID	equ	746Dh
  1044                                  AMD768_DID	equ	7445h
  1045                                  ; 03/11/2023 - Erdogan Tan - Ref: MPXPLAY/SBEMU/KOLIBRIOS AC97 source code
  1046                                  CK804_DID	equ	0059h
  1047                                  MCP04_DID	equ	003Ah
  1048                                  CK8_DID		equ	008Ah
  1049                                  NFORCE3_DID	equ	00DAh
  1050                                  CK8S_DID	equ	00EAh
  1051                                  
  1052                                  NAMBAR_REG      equ     10h             ; native audio mixer BAR
  1053                                   NAM_SIZE       equ     256             ; 256 bytes required.
  1054                                  
  1055                                  NABMBAR_REG     equ     14h             ; native audio bus mastering BAR
  1056                                   NABM_SIZE      equ     64              ; 64 bytes
  1057                                  
  1058                                  ; BUS master registers, accessed via NABMBAR+offset
  1059                                  
  1060                                  ; ICH supports 3 different types of register sets for three types of things
  1061                                  ; it can do, thus:
  1062                                  ;
  1063                                  ; PCM in (for recording) aka PI
  1064                                  ; PCM out (for playback) aka PO
  1065                                  ; MIC in (for recording) aka MC
  1066                                  
  1067                                  PI_BDBAR_REG            equ     0       ; PCM in buffer descriptor BAR
  1068                                  PO_BDBAR_REG            equ     10h     ; PCM out buffer descriptor BAR
  1069                                  MC_BDBAR_REG            equ     20h     ; MIC in buffer descriptor BAR
  1070                                  
  1071                                  ; each buffer descriptor BAR holds a pointer which has entries to the buffer
  1072                                  ; contents of the .WAV file we're going to play.  Each entry is 8 bytes long
  1073                                  ; (more on that later) and can contain 32 entries total, so each BAR is
  1074                                  ; 256 bytes in length, thus:
  1075                                  
  1076                                  BDL_SIZE                equ     32*8    ; Buffer Descriptor List size
  1077                                  INDEX_MASK              equ     31      ; indexes must be 0-31
  1078                                  
  1079                                  
  1080                                  
  1081                                  PI_CIV_REG              equ     4       ; PCM in current Index value (RO)
  1082                                  PO_CIV_REG              equ     14h     ; PCM out current Index value (RO)
  1083                                  MC_CIV_REG              equ     24h     ; MIC in current Index value (RO)
  1084                                  ;8bit read only
  1085                                  ; each current index value is simply a pointer showing us which buffer
  1086                                  ; (0-31) the codec is currently processing.  Once this counter hits 31, it
  1087                                  ; wraps back to 0.
  1088                                  ; this can be handy to know, as once it hits 31, we're almost out of data to
  1089                                  ; play back or room to record!
  1090                                  
  1091                                  
  1092                                  PI_LVI_REG              equ     5       ; PCM in Last Valid Index
  1093                                  PO_LVI_REG              equ     15h     ; PCM out Last Valid Index
  1094                                  MC_LVI_REG              equ     25h     ; MIC in Last Valid Index
  1095                                  ;8bit read/write
  1096                                  ; The Last Valid Index is a number (0-31) to let the codec know what buffer
  1097                                  ; number to stop on after processing.  It could be very nasty to play audio
  1098                                  ; from buffers that aren't filled with the audio we want to play.
  1099                                  
  1100                                  
  1101                                  PI_SR_REG               equ     6       ; PCM in Status register
  1102                                  PO_SR_REG               equ     16h     ; PCM out Status register
  1103                                  MC_SR_REG               equ     26h     ; MIC in Status register
  1104                                  ;16bit read/write
  1105                                  ; status registers.  Bitfields follow:
  1106                                  
  1107                                  FIFO_ERR                equ     BIT4    ; FIFO Over/Underrun W1TC.
  1108                                  
  1109                                  BCIS                    equ     BIT3    ; buffer completion interrupt status.
  1110                                                                          ; Set whenever the last sample in ANY
  1111                                                                          ; buffer is finished.  Bit is only
  1112                                                                          ; set when the Interrupt on Complete
  1113                                                                          ; (BIT4 of control reg) is set.
  1114                                  
  1115                                  LVBCI                   equ     BIT2    ; Set whenever the codec has processed
  1116                                                                          ; the last buffer in the buffer list.
  1117                                                                          ; Will fire an interrupt if IOC bit is
  1118                                                                          ; set. Probably set after the last
  1119                                                                          ; sample in the last buffer is
  1120                                                                          ; processed.  W1TC
  1121                                  
  1122                                                                          ; 
  1123                                  CELV                    equ     BIT1    ; Current buffer == last valid.
  1124                                                                          ; Bit is RO and remains set until LVI is
  1125                                                                          ; cleared.  Probably set up the start
  1126                                                                          ; of processing for the last buffer.
  1127                                  
  1128                                  
  1129                                  DCH                     equ     BIT0    ; DMA controller halted.
  1130                                                                          ; set whenever audio stream is stopped
  1131                                                                          ; or something else goes wrong.
  1132                                  
  1133                                  PI_PICB_REG             equ     8       ; PCM in position in current buffer(RO)
  1134                                  PO_PICB_REG             equ     18h     ; PCM out position in current buffer(RO)
  1135                                  MC_PICB_REG             equ     28h     ; MIC in position in current buffer (RO)
  1136                                  ;16bit read only
  1137                                  ; position in current buffer regs show the number of dwords left to be
  1138                                  ; processed in the current buffer.
  1139                                  ; 
  1140                                  
  1141                                  PI_PIV_REG              equ     0ah     ; PCM in Prefected index value
  1142                                  PO_PIV_REG              equ     1ah     ; PCM out Prefected index value
  1143                                  MC_PIV_REG              equ     2ah     ; MIC in Prefected index value
  1144                                  ;8bit, read only
  1145                                  ; Prefetched index value register.
  1146                                  ; tells which buffer number (0-31) has be prefetched.  I'd imagine this
  1147                                  ; value follows the current index value fairly closely. (CIV+1)
  1148                                  ;
  1149                                  
  1150                                  PI_CR_REG               equ     0bh     ; PCM in Control Register
  1151                                  PO_CR_REG               equ     1bh     ; PCM out Control Register
  1152                                  MC_CR_REG               equ     2bh     ; MIC in Control Register
  1153                                  ; 8bit
  1154                                  ; Control register *MUST* only be accessed as an 8bit value.
  1155                                  ; Control register.  See bitfields below.
  1156                                  ;
  1157                                  
  1158                                  IOCE                    equ     BIT4    ; interrupt on complete enable.
  1159                                                                          ; set this bit if you want an intrtpt
  1160                                                                          ; to fire whenever LVBCI is set.
  1161                                  FEIFE                   equ     BIT3    ; set if you want an interrupt to fire
  1162                                                                          ; whenever there is a FIFO (over or
  1163                                                                          ; under) error.
  1164                                  LVBIE                   equ     BIT2    ; last valid buffer interrupt enable.
  1165                                                                          ; set if you want an interrupt to fire
  1166                                                                          ; whenever the completion of the last
  1167                                                                          ; valid buffer.
  1168                                  RR                      equ     BIT1    ; reset registers.  Nukes all regs
  1169                                                                          ; except bits 4:2 of this register.
  1170                                                                          ; Only set this bit if BIT 0 is 0
  1171                                  RPBM                    equ     BIT0    ; Run/Pause
  1172                                                                          ; set this bit to start the codec!
  1173                                  
  1174                                  
  1175                                  GLOB_CNT_REG            equ     2ch     ; Global control register
  1176                                  SEC_RES_EN              equ     BIT5    ; secondary codec resume event 
  1177                                                                          ; interrupt enable.  Not used here.
  1178                                  PRI_RES_EN              equ     BIT4    ; ditto for primary. Not used here.
  1179                                  ACLINK_OFF              equ     BIT3    ; Turn off the AC97 link
  1180                                  ACWARM_RESET            equ     BIT2    ; Awaken the AC97 link from sleep.
  1181                                                                          ; registers preserved, bit self clears
  1182                                  ACCOLD_RESET            equ     BIT1    ; Reset everything in the AC97 and
  1183                                                                          ; reset all registers.  Not self clearing
  1184                                  
  1185                                  GPIIE                   equ     BIT0    ; GPI Interrupt enable.
  1186                                                                          ; set if you want an interrupt to
  1187                                                                          ; fire upon ANY of the bits in the
  1188                                                                          ; GPI (general pursose inputs?) not used.
  1189                                  
  1190                                  GLOB_STS_REG            equ     30h     ; Global Status register (RO)
  1191                                  
  1192                                  MD3                     equ     BIT17   ; modem powerdown status (yawn)
  1193                                  AD3                     equ     BIT16   ; Audio powerdown status (yawn)
  1194                                  RD_COMPLETE_STS         equ     BIT15   ; Codec read timed out. 0=normal
  1195                                  BIT3SLOT12              equ     BIT14   ; shadowed status of bit 3 in slot 12
  1196                                  BIT2SLOT12              equ     BIT13   ; shadowed status of bit 2 in slot 12
  1197                                  BIT1SLOT12              equ     BIT12   ; shadowed status of bit 1 in slot 12
  1198                                  SEC_RESUME_STS          equ     BIT11   ; secondary codec has resumed (and irqed)
  1199                                  PRI_RESUME_STS          equ     BIT10   ; primary codec has resumed (and irqed)
  1200                                  SEC_CODEC_RDY           equ     BIT9    ; secondary codec is ready for action
  1201                                  PRI_CODEC_RDY           equ     BIT8    ; Primary codec is ready for action
  1202                                                                          ; software must check these bits before
  1203                                                                          ; starting the codec!
  1204                                  MIC_IN_IRQ              equ     BIT7    ; MIC in caused an interrupt
  1205                                  PCM_OUT_IRQ             equ     BIT6    ; One of the PCM out channels IRQed
  1206                                  PCM_IN_IRQ              equ     BIT5    ; One of the PCM in channels IRQed
  1207                                  MODEM_OUT_IRQ           equ     BIT2    ; modem out channel IRQed
  1208                                  MODEM_IN_IRQ            equ     BIT1    ; modem in channel IRQed
  1209                                  GPI_STS_CHANGE          equ     BIT0    ; set whenever GPI's have changed.
  1210                                                                          ; BIT0 of slot 12 also reflects this.
  1211                                  
  1212                                  
  1213                                  ACC_SEMA_REG            equ     34h     ; Codec write semiphore register
  1214                                  CODEC_BUSY              equ     BIT0    ; codec register I/O is happening
  1215                                                                          ; self clearing
  1216                                  ;
  1217                                  ; Buffer Descriptors List
  1218                                  ; As stated earlier, each buffer descriptor list is a set of (up to) 32
  1219                                  ; descriptors, each 8 bytes in length.  Bytes 0-3 of a descriptor entry point
  1220                                  ; to a chunk of memory to either play from or record to.  Bytes 4-7 of an
  1221                                  ; entry describe various control things detailed below.
  1222                                  ; 
  1223                                  ; Buffer pointers must always be aligned on a Dword boundry.
  1224                                  ;
  1225                                  ;
  1226                                  
  1227                                  IOC                     equ     BIT31   ; Fire an interrupt whenever this
  1228                                                                          ; buffer is complete.
  1229                                  
  1230                                  BUP                     equ     BIT30   ; Buffer Underrun Policy.
  1231                                                                          ; if this buffer is the last buffer
  1232                                                                          ; in a playback, fill the remaining
  1233                                                                          ; samples with 0 (silence) or not.
  1234                                                                          ; It's a good idea to set this to 1
  1235                                                                          ; for the last buffer in playback,
  1236                                                                          ; otherwise you're likely to get a lot
  1237                                                                          ; of noise at the end of the sound.
  1238                                  
  1239                                  ;
  1240                                  ; Bits 15:0 contain the length of the buffer, in number of samples, which
  1241                                  ; are 16 bits each, coupled in left and right pairs, or 32bits each.
  1242                                  ; Luckily for us, that's the same format as .wav files.
  1243                                  ;
  1244                                  ; A value of FFFF is 65536 samples.  Running at 44.1Khz, that's just about
  1245                                  ; 1.5 seconds of sample time.  FFFF * 32bits is 1FFFFh bytes or 128k of data.
  1246                                  ;
  1247                                  ; A value of 0 in these bits means play no samples.
  1248                                  ;
  1249                                  
  1250                                  ; CODE
  1251                                  
  1252                                  ; AC97.ASM
  1253                                  
  1254                                  ; codec configuration code.  Not much here really.
  1255                                  ; NASM version: Erdogan Tan (29/11/2016)
  1256                                  
  1257                                  ; enable codec, unmute stuff, set output rate to 44.1
  1258                                  ; entry: ax = desired sample rate
  1259                                  ;
  1260                                  	
  1261                                  	; 15/05/2024
  1262                                  	; 12/05/2024
  1263                                  	; 08/05/2024
  1264                                  	; (ac97_vra.asm, 19/11/2023, Erdogan Tan, playwav3.asm)
  1265                                  codecConfig:
  1266                                  	; 02/12/2023
  1267                                  	; 26/11/2023
  1268                                  	; 21/11/2023
  1269                                  	; 20/11/2023
  1270                                  	; 19/11/2023 (TRDOS 386 v2.0.7)
  1271                                  	; 15/11/2023
  1272                                  	; 04/11/2023
  1273                                  	; 17/02/2017 
  1274                                  	; 07/11/2016 (Erdogan Tan)
  1275                                  	;PORT_NABM_GLB_CTRL_STAT equ 60h
  1276                                  
  1277                                  	; 03/11/2023 (MPXPLAY, 'SC_ICH.C', ac97_init)
  1278                                   	; 'AC97_DEF.H'
  1279                                  	;AC97_EXTENDED_STATUS equ 002Ah
  1280                                  	AC97_EA_SPDIF	equ 0002h
  1281                                  	AC97_EA_VRA	equ 0001h
  1282                                  	; 04/11/2023
  1283                                  	ICH_PO_CR_RESET equ 0002h  ; reset codec
  1284                                  	ICH_PCM_20BIT	equ 400000h ; 20-bit samples (ICH4)
  1285                                  	ICH_PCM_246_MASK equ 300000h ; 6 channels
  1286                                  
  1287                                  	; 08/05/2024
  1288                                  	; 11/11/2023
  1289                                  	CTRL_ST_CREADY	equ	BIT8+BIT9+BIT28 ; Primary Codec Ready
  1290                                  	CODEC_REG_POWERDOWN equ	26h
  1291                                  
  1292                                  	; 04/11/2023
  1293                                  init_ac97_controller:
  1294 000002E3 66A1[6A10]              	mov	eax, [bus_dev_fn]
  1295 000002E7 B004                    	mov	al, PCI_CMD_REG
  1296 000002E9 E828FF                  	call	pciRegRead16		; read PCI command register
  1297 000002EC 80CA05                  	or      dl, IO_ENA+BM_ENA	; enable IO and bus master
  1298 000002EF E894FF                  	call	pciRegWrite16
  1299                                  
  1300                                  	; 14/05/2024
  1301                                  	; 02/12/2023
  1302 000002F2 E8A601                  	call	delay_100ms ; 29/05/2017
  1303                                  
  1304                                  	; 02/12/2023
  1305                                  	;call	delay1_4ms
  1306                                  	;call	delay1_4ms
  1307                                  	;call	delay1_4ms
  1308                                  	;call	delay1_4ms
  1309                                  
  1310                                  init_ac97_codec:
  1311                                  	; 18/11/2023
  1312 000002F5 BD2800                  	mov	bp, 40
  1313                                  	; 14/05/2024
  1314                                  	;mov	bp, 100
  1315                                  _initc_1:
  1316                                  	; 11/11/2023
  1317                                  	; (TRDOS 386 v2.0.5, 'audio.s')
  1318 000002F8 BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1319 000002FB 0316[5610]              	add	dx, [NABMBAR]
  1320 000002FF 66ED                    	in	eax, dx
  1321                                  
  1322                                  	; 02/12/2023
  1323 00000301 E86009                  	call	delay1_4ms
  1324                                  
  1325                                  	; ?
  1326                                  	;; 15/11/2023
  1327                                  	;;mov	cx, 40
  1328                                  	;mov	bp, 40 ; 18/11/2023
  1329                                  ;_initc_1:
  1330 00000304 BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1331 00000307 0316[5610]              	add	dx, [NABMBAR]
  1332 0000030B 66ED                    	in	eax, dx
  1333                                  
  1334                                  	; 02/12/2023
  1335 0000030D E85409                  	call	delay1_4ms
  1336                                  
  1337 00000310 6683F8FF                	cmp	eax, 0FFFFFFFFh ; -1
  1338                                  	;je	short init_ac97_codec_err1
  1339                                  	; 15/11/2023
  1340 00000314 7508                    	jne	short _initc_3
  1341                                  _initc_2:
  1342                                  	;dec	cx
  1343 00000316 4D                      	dec	bp	; 18/11/2023
  1344                                  	;jz	short init_ac97_codec_err1
  1345                                  	; 19/11/2023
  1346 00000317 7412                    	jz	short _ac97_codec_ready
  1347                                  
  1348 00000319 E87F01                  	call	delay_100ms
  1349 0000031C EBDA                    	jmp	short _initc_1
  1350                                  _initc_3:
  1351 0000031E 66A900030010            	test	eax, CTRL_ST_CREADY
  1352 00000324 7505                    	jnz	short _ac97_codec_ready
  1353                                  
  1354 00000326 E8F200                  	call	reset_ac97_codec
  1355                                  	; 11/11/2023
  1356                                  	;jc	short init_ac97_codec_err2
  1357                                  	; 15/11/2023
  1358                                  	;jc	short _initc_2
  1359                                  	; 26/11/2023
  1360 00000329 EBEB                    	jmp	short _initc_2
  1361                                  
  1362                                  _ac97_codec_ready:
  1363 0000032B 8B16[5410]              	mov	dx, [NAMBAR]
  1364                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  1365 0000032F EF                      	out	dx, ax
  1366                                  
  1367 00000330 E86801                  	call	delay_100ms
  1368                                  
  1369                                  	; 19/11/2023
  1370 00000333 09ED                    	or	bp, bp
  1371 00000335 7522                    	jnz	short _ac97_codec_init_ok
  1372                                  
  1373 00000337 6631C0                  	xor	eax, eax ; 0
  1374 0000033A 8B16[5410]              	mov	dx, [NAMBAR]
  1375 0000033E 83C226                  	add	dx, CODEC_REG_POWERDOWN
  1376 00000341 EF                      	out	dx, ax
  1377                                  	
  1378                                  	; 19/11/2023
  1379                                  	; wait for 1 second
  1380                                  	; 15/05/2024
  1381 00000342 66B9E8030000            	mov	ecx, 1000 ; 1000*4*0.25ms = 1s
  1382                                  	;mov	cx, 10
  1383                                  _ac97_codec_rloop:
  1384                                  	;call	delay1_4ms
  1385                                  	;call	delay1_4ms
  1386                                  	;call	delay1_4ms
  1387                                  	;call	delay1_4ms
  1388 00000348 E85001                  	call	delay_100ms
  1389                                  
  1390                                  	;mov	dx, [NAMBAR]
  1391                                  	;add	dx, CODEC_REG_POWERDOWN
  1392 0000034B ED                      	in	ax, dx
  1393                                  
  1394                                  	; 14/05/2024
  1395                                  	; 02/12/2023
  1396 0000034C E81509                  	call	delay1_4ms
  1397                                  	
  1398 0000034F 83E00F                  	and	ax, 0Fh
  1399 00000352 3C0F                    	cmp	al, 0Fh
  1400 00000354 7403                    	je	short _ac97_codec_init_ok
  1401 00000356 E2F0                    	loop	_ac97_codec_rloop 
  1402                                  
  1403                                  	; 12/05/2024
  1404                                  	; cf = 1
  1405                                  init_ac97_codec_err1:
  1406                                  	;stc	; 12/05/2024
  1407                                  init_ac97_codec_err2:
  1408 00000358 C3                      	retn
  1409                                  
  1410                                  _ac97_codec_init_ok:
  1411                                          ; 11/11/2023
  1412                                  	;mov	al, 2 ; force set 16-bit 2-channel PCM
  1413                                  	;mov	dx, GLOB_CNT_REG ; 2Ch
  1414                                  	;add	dx, [NABMBAR]
  1415                                  	;out	dx, eax
  1416                                  
  1417                                  	;;call	delay1_4ms
  1418                                  
  1419 00000359 E87800                  	call 	reset_ac97_controller
  1420                                  
  1421                                  	; 11/11/2023
  1422                                  	;call	delay1_4ms
  1423                                  	; 21/11/2023 - temporary
  1424 0000035C E83C01                  	call	delay_100ms
  1425                                  
  1426                                  	;call 	setup_ac97_codec
  1427                                  
  1428                                  setup_ac97_codec:
  1429                                  	; 08/05/2028
  1430                                  	; [sample_rate] = 22050
  1431                                  	; 12/11/2023
  1432                                  	;cmp	word [sample_rate], 48000
  1433                                  	;je	short skip_rate
  1434                                  
  1435                                  ; 11/11/2023
  1436                                  ; 05/11/2023
  1437                                  ;%if 1
  1438                                  	AC97_EA_VRA equ BIT0 ; 11/11/2023
  1439                                  
  1440                                  	; 18/05/2024
  1441 0000035F E80209                  	call	delay1_4ms
  1442                                  
  1443                                  	; 16/05/2024
  1444 00000362 8B16[5410]              	mov	dx, [NAMBAR]
  1445 00000366 83C228                  	add	dx, CODEC_EXT_AUDIO_REG	; 28h
  1446 00000369 ED                      	in	ax, dx
  1447                                  
  1448                                  	; 18/05/2024
  1449                                  	; 16/05/2024
  1450 0000036A E8F708                  	call	delay1_4ms
  1451                                  	; 17/05/2024
  1452                                  	;call	delay1_4ms
  1453                                  	;call	delay1_4ms
  1454                                  	;call	delay1_4ms
  1455                                  
  1456                                  	; 17/05/2024
  1457                                  	;call	delay_100ms
  1458                                  
  1459                                  	; 14/05/2024
  1460 0000036D A801                    	test	al, 1 ; BIT0 ; Variable Rate Audio bit
  1461 0000036F 741D                    	jz	short vra_not_supported
  1462                                  
  1463                                  	; 11/11/2023
  1464 00000371 8B16[5410]              	mov    	dx, [NAMBAR]
  1465 00000375 83C22A                  	add    	dx, CODEC_EXT_AUDIO_CTRL_REG ; 2Ah
  1466 00000378 ED                      	in     	ax, dx
  1467                                  
  1468                                  	; 14/05/2024
  1469                                  	; 02/12/2023
  1470 00000379 E8E808                  	call	delay1_4ms
  1471                                  
  1472 0000037C 24FD                    	and	al, ~BIT1 ; Clear DRA
  1473 0000037E 0C01                    	or	al, AC97_EA_VRA ; 1 ; 04/11/2023
  1474 00000380 EF                      	out	dx, ax			; Enable variable rate audio
  1475                                  	
  1476 00000381 B90A00                  	mov	cx, 10
  1477                                  check_vra:
  1478 00000384 E81401                  	call	delay_100ms
  1479                                  
  1480                                  	; 11/11/2023
  1481 00000387 ED                      	in	ax, dx
  1482 00000388 A801                    	test	al, AC97_EA_VRA ; 1
  1483 0000038A 750A                    	jnz	short set_rate
  1484                                  
  1485                                  	; 11/11/2023
  1486 0000038C E2F6                    	loop	check_vra
  1487                                  
  1488                                  	; 13/11/2023
  1489                                  	;mov	byte [VRA], 0
  1490                                  vra_not_supported:
  1491                                  	; 08/05/2024
  1492 0000038E C706[C08D]80BB          	mov	word [sample_rate], 48000
  1493 00000394 EB0E                    	jmp	short skip_rate	
  1494                                  
  1495                                  	; 12/11/2023
  1496                                  	;pop	ax ; discard return address to the caller
  1497                                  	;mov	dx, msg_no_vra
  1498                                  	;jmp	vra_err
  1499                                  
  1500                                  set_rate:
  1501 00000396 A1[C08D]                	mov	ax, [sample_rate] ; 17/02/2017 (Erdogan Tan)
  1502                                  	; 08/05/2024
  1503                                  	; ax = 22050 (Hz)
  1504                                  
  1505 00000399 8B16[5410]              	mov    	dx, [NAMBAR]               	
  1506 0000039D 83C22C                  	add    	dx, CODEC_PCM_FRONT_DACRATE_REG	; 2Ch
  1507 000003A0 EF                      	out	dx, ax 			; PCM Front/Center Output Sample Rate
  1508                                  
  1509 000003A1 E8F700                  	call	delay_100ms
  1510                                  
  1511                                  	; 12/11/2023
  1512                                  skip_rate:
  1513                                  	; 11/11/2023 (temporary)
  1514                                  
  1515                                  	;mov   	dx, [NAMBAR]
  1516                                  	;add   	dx, CODEC_PCM_SURND_DACRATE_REG	; 2Eh
  1517                                  	;out	dx, ax 			; PCM Surround Output Sample Rate
  1518                                  
  1519                                  	;call	delay_100ms
  1520                                  
  1521                                  	;mov   	dx, [NAMBAR]
  1522                                  	;add   	dx, CODEC_PCM_LFE_DACRATE_REG	; 30h
  1523                                  	;out	dx, ax 			; PCM LFE Output Sample Rate
  1524                                  
  1525                                  	;call	delay_100ms
  1526                                  
  1527                                  	; 05/11/2023 (temporary)
  1528                                  	;mov	dx, [NAMBAR]
  1529                                  	;add	dx, CODEC_LR_ADCRATE_REG 	; 32h
  1530                                  	;out	dx, ax 			; PCM Input Sample Rate
  1531                                  	;
  1532                                  	;call	delay_100ms
  1533                                  
  1534 000003A4 B80202                  	mov	ax, 0202h
  1535 000003A7 A2[7310]                	mov	[volume], al ; 29
  1536 000003AA 8B16[5410]              	mov     dx, [NAMBAR]
  1537 000003AE 83C202                    	add     dx, CODEC_MASTER_VOL_REG	; 02h
  1538 000003B1 EF                      	out     dx, ax
  1539                                  
  1540                                  	; 11/11/2023
  1541                                          ;call	delay1_4ms
  1542                                          ;call	delay1_4ms
  1543                                          ;call	delay1_4ms
  1544                                          ;call	delay1_4ms
  1545                                   	;
  1546                                    	;mov	dx, [NAMBAR]
  1547                                    	;add	dx, CODEC_MASTER_MONO_VOL_REG	; 06h
  1548                                    	;out	dx, ax
  1549                                  
  1550                                  	; 11/11/2023
  1551                                          ;call	delay1_4ms
  1552                                          ;call	delay1_4ms
  1553                                          ;call	delay1_4ms
  1554                                          ;call	delay1_4ms
  1555                                  	;
  1556                                  	;mov	ax, 02h
  1557                                    	;mov	dx, [NAMBAR]
  1558                                    	;add	dx, CODEC_PCBEEP_VOL_REG	; 0Ah
  1559                                    	;out	dx, ax
  1560                                  
  1561                                  	; 14/05/2024
  1562                                  	; 20/11/2023
  1563 000003B2 E8AF08                          call	delay1_4ms
  1564 000003B5 E8AC08                          call	delay1_4ms
  1565 000003B8 E8A908                          call	delay1_4ms
  1566 000003BB E8A608                          call	delay1_4ms
  1567                                  
  1568                                  	; 21/11/2023 temporary
  1569                                  	;call	delay_100ms
  1570                                  
  1571                                  	;mov	ax, 0202h
  1572 000003BE 8B16[5410]                	mov     dx, [NAMBAR]
  1573 000003C2 83C218                    	add     dx, CODEC_PCM_OUT_REG		; 18h
  1574 000003C5 EF                        	out     dx, ax
  1575                                  
  1576                                  	; 14/05/2024
  1577                                  	; 20/11/2023
  1578 000003C6 E89B08                          call	delay1_4ms
  1579 000003C9 E89808                          call	delay1_4ms
  1580 000003CC E89508                          call	delay1_4ms
  1581 000003CF E89208                          call	delay1_4ms
  1582                                  
  1583                                  	; 14/05/2024
  1584                                  	; 21/11/2023 - temporary
  1585                                  	;call	delay_100ms
  1586                                  
  1587                                  	; 11/11/2023
  1588                                  	;mov	ax, 8008h ; Mute
  1589                                    	;mov	dx, [NAMBAR]
  1590                                  	;add	dx, CODEC_PHONE_VOL_REG		; 0Ch
  1591                                  	;			 ; AC97_PHONE_VOL ; TAD Input (Mono)
  1592                                    	;out	dx, ax
  1593                                  	;
  1594                                          ;call	delay1_4ms
  1595                                          ;call	delay1_4ms
  1596                                          ;call	delay1_4ms
  1597                                  	;call	delay1_4ms
  1598                                  
  1599                                  	;mov	ax, 0808h
  1600                                  	;mov	dx, [NAMBAR]
  1601                                  	;add	dx, CODEC_LINE_IN_VOL_REG ;10h ; Line Input (Stereo)
  1602                                  	;out	dx, ax
  1603                                  	;
  1604                                          ;call	delay1_4ms
  1605                                          ;call	delay1_4ms
  1606                                          ;call	delay1_4ms
  1607                                  	;call	delay1_4ms
  1608                                  
  1609                                    	;mov	dx, [NAMBAR]
  1610                                          ;add	dx, CODEC_CD_VOL_REG ;12h ; CD Input (Stereo)
  1611                                    	;out	dx, ax
  1612                                  	;
  1613                                    	;mov	dx, [NAMBAR]
  1614                                          ;add	dx, CODEC_AUX_VOL_REG ;16h ; Aux Input (Stereo)
  1615                                    	;out	dx, ax
  1616                                  	;
  1617                                          ;call	delay1_4ms
  1618                                          ;call	delay1_4ms
  1619                                          ;call	delay1_4ms
  1620                                  	;call	delay1_4ms
  1621                                  
  1622                                  	; 14/05/2024
  1623                                  	;call	delay_100ms
  1624                                  
  1625                                  	; 14/05/2024
  1626 000003D2 F8                      	clc
  1627                                  
  1628                                  ;detect_ac97_codec:
  1629 000003D3 C3                              retn
  1630                                  
  1631                                  reset_ac97_controller:
  1632                                  	; 11/11/2023
  1633                                  	; 10/06/2017
  1634                                  	; 29/05/2017
  1635                                  	; 28/05/2017
  1636                                  	; reset AC97 audio controller registers
  1637 000003D4 31C0                    	xor     ax, ax
  1638 000003D6 BA0B00                          mov	dx, PI_CR_REG
  1639 000003D9 0316[5610]              	add	dx, [NABMBAR]
  1640 000003DD EE                      	out     dx, al
  1641                                  
  1642                                  	; 14/05/2024
  1643 000003DE E88308                  	call	delay1_4ms
  1644                                  
  1645 000003E1 BA1B00                          mov     dx, PO_CR_REG
  1646 000003E4 0316[5610]              	add	dx, [NABMBAR]
  1647 000003E8 EE                      	out     dx, al
  1648                                  
  1649                                  	; 14/05/2024
  1650 000003E9 E87808                  	call	delay1_4ms
  1651                                  
  1652 000003EC BA2B00                          mov     dx, MC_CR_REG
  1653 000003EF 0316[5610]              	add	dx, [NABMBAR]
  1654 000003F3 EE                      	out     dx, al
  1655                                  
  1656                                  	; 14/05/2024
  1657 000003F4 E86D08                  	call	delay1_4ms
  1658                                  
  1659 000003F7 B002                            mov     al, RR
  1660 000003F9 BA0B00                          mov     dx, PI_CR_REG
  1661 000003FC 0316[5610]              	add	dx, [NABMBAR]
  1662 00000400 EE                      	out     dx, al
  1663                                  
  1664                                  	; 14/05/2024
  1665 00000401 E86008                  	call	delay1_4ms
  1666                                  
  1667 00000404 BA1B00                          mov     dx, PO_CR_REG
  1668 00000407 0316[5610]              	add	dx, [NABMBAR]
  1669 0000040B EE                      	out     dx, al
  1670                                  
  1671                                  	; 14/05/2024
  1672 0000040C E85508                  	call	delay1_4ms
  1673                                  
  1674 0000040F BA2B00                          mov     dx, MC_CR_REG
  1675 00000412 0316[5610]              	add	dx, [NABMBAR]
  1676 00000416 EE                      	out     dx, al
  1677                                  
  1678                                  	; 14/05/2024
  1679 00000417 E84A08                  	call	delay1_4ms
  1680                                  
  1681 0000041A C3                      	retn
  1682                                  
  1683                                  reset_ac97_codec:
  1684                                  	; 11/11/2023
  1685                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1686 0000041B BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1687 0000041E 0316[5610]              	add	dx, [NABMBAR]
  1688 00000422 66ED                    	in	eax, dx
  1689                                  
  1690                                  	;test	eax, 2
  1691                                  	; 06/08/2022
  1692 00000424 A802                    	test	al, 2
  1693 00000426 7405                    	jz	short _r_ac97codec_cold	
  1694                                  
  1695 00000428 E80E00                  	call	warm_ac97codec_reset
  1696 0000042B 7306                    	jnc	short _r_ac97codec_ok
  1697                                  _r_ac97codec_cold:
  1698 0000042D E83400                          call    cold_ac97codec_reset
  1699 00000430 7301                            jnc     short _r_ac97codec_ok
  1700                                  	
  1701                                  	; 16/04/2017
  1702                                          ;xor	eax, eax	; timeout error
  1703                                         	;stc
  1704 00000432 C3                      	retn
  1705                                  
  1706                                  _r_ac97codec_ok:
  1707 00000433 6631C0                          xor     eax, eax
  1708                                          ;mov	al, VIA_ACLINK_C00_READY ; 1
  1709 00000436 FEC0                            inc	al
  1710 00000438 C3                      	retn
  1711                                  
  1712                                  warm_ac97codec_reset:
  1713                                  	; 11/11/2023
  1714                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  1715                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1716 00000439 66B806000000            	mov	eax, 6
  1717 0000043F BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1718 00000442 0316[5610]              	add	dx, [NABMBAR]
  1719 00000446 66EF                    	out	dx, eax
  1720                                  
  1721 00000448 B90A00                  	mov	cx, 10	; total 1s
  1722                                  _warm_ac97c_rst_wait:
  1723 0000044B E84D00                  	call	delay_100ms
  1724                                  
  1725 0000044E BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1726 00000451 0316[5610]              	add	dx, [NABMBAR]
  1727 00000455 66ED                    	in	eax, dx
  1728                                  
  1729 00000457 66A900030010            	test	eax, CTRL_ST_CREADY
  1730 0000045D 7504                    	jnz	short _warm_ac97c_rst_ok
  1731                                  
  1732 0000045F 49                              dec     cx
  1733 00000460 75E9                            jnz     short _warm_ac97c_rst_wait
  1734                                  
  1735                                  _warm_ac97c_rst_fail:
  1736 00000462 F9                              stc
  1737                                  _warm_ac97c_rst_ok:
  1738 00000463 C3                      	retn
  1739                                  
  1740                                  cold_ac97codec_reset:
  1741                                  	; 11/11/2023
  1742                                  	; 06/08/2022 - TRDOS 386 v2.0.5
  1743                                  	; 28/05/2017 - Erdogan Tan (Ref: KolibriOS, intelac97.asm)
  1744 00000464 66B802000000                    mov	eax, 2
  1745 0000046A BA2C00                  	mov	dx, GLOB_CNT_REG ; 2Ch
  1746 0000046D 0316[5610]              	add	dx, [NABMBAR]
  1747 00000471 66EF                    	out	dx, eax
  1748                                  
  1749 00000473 E82500                  	call	delay_100ms 	; wait 100 ms
  1750 00000476 E82200                  	call	delay_100ms 	; wait 100 ms
  1751 00000479 E81F00                  	call	delay_100ms 	; wait 100 ms
  1752 0000047C E81C00                  	call	delay_100ms 	; wait 100 ms
  1753                                  
  1754 0000047F B91000                  	mov	cx, 16	; total 20*100 ms = 2s
  1755                                  
  1756                                  _cold_ac97c_rst_wait:
  1757 00000482 BA3000                  	mov	dx, GLOB_STS_REG ; 30h
  1758 00000485 0316[5610]              	add	dx, [NABMBAR]
  1759 00000489 66ED                    	in	eax, dx
  1760                                  
  1761 0000048B 66A900030010            	test	eax, CTRL_ST_CREADY
  1762 00000491 7507                    	jnz	short _cold_ac97c_rst_ok
  1763                                  
  1764 00000493 E80500                  	call	delay_100ms
  1765                                  
  1766 00000496 49                              dec     cx
  1767 00000497 75E9                            jnz     short _cold_ac97c_rst_wait
  1768                                  
  1769                                  _cold_ac97c_rst_fail:
  1770 00000499 F9                              stc
  1771                                  _cold_ac97c_rst_ok:
  1772 0000049A C3                      	retn
  1773                                  
  1774                                  delay_100ms:
  1775                                  	; 11/11/2023
  1776                                  	; 29/05/2017
  1777                                  	; 24/03/2017 ('codec.asm')
  1778                                  	; wait 100 ms
  1779 0000049B 51                      	push	cx
  1780 0000049C B99001                  	mov	cx, 400  ; 400*0.25ms
  1781                                  _delay_x_ms:
  1782 0000049F E8C207                  	call	delay1_4ms
  1783 000004A2 E2FB                            loop	_delay_x_ms
  1784 000004A4 59                      	pop	cx
  1785 000004A5 C3                      	retn
  1786                                  
  1787                                  ;=============================================================================
  1788                                  ;               ICH_WAV.ASM
  1789                                  ;=============================================================================
  1790                                  
  1791                                  ; DOS based .WAV player using AC'97 and codec interface.
  1792                                  ; ---------------------------------------------------------------
  1793                                  ; NASM version: Erdogan Tan (29/11/2016)
  1794                                  ; Last Update: 17/02/2017 (by Erdogan Tan)
  1795                                  
  1796                                  ; ICHWAV.ASM
  1797                                  ; PLAYMOD.ASM
  1798                                  ; player internal variables and other equates.
  1799                                  ;BUFFERSIZE	equ	2048*4		; 8K half buffer size. 18/02/2017
  1800                                  ; 15/05/2024
  1801                                  ;BUFFERSIZE	equ	2560*4
  1802                                  ; 16/05/2024
  1803                                  BUFFERSIZE	equ	3840*4
  1804                                  ;ENDOFFILE	equ	BIT0		; flag for knowing end of file
  1805                                  
  1806                                  ;===========================================================================
  1807                                  ; entry: none.  File is already open and [filehandle] filled.
  1808                                  ; exit:  not until the song is finished or the user aborts.
  1809                                  ;
  1810                                  ; 18/02/2017
  1811                                  ModPlay: ; 13/02/2017  ; ModPlay Polling!
  1812                                  	;cld
  1813                                  	; clear (half) buffer 2
  1814                                         	;mov	di, [DMA_BUFFER2]
  1815                                  	;sub	ax, ax
  1816                                  	;mov	cx, (BUFFERSIZE/2)
  1817                                  	;rep	stosw
  1818                                  
  1819                                  	; 15/05/2024
  1820 000004A6 06                      	push	es
  1821 000004A7 1E                      	push	ds
  1822 000004A8 07                      	pop	es
  1823 000004A9 B94001                  	mov	cx, 320
  1824 000004AC BF[92EC]                	mov	di, MOD_BUFFER
  1825 000004AF B88080                  	mov	ax, 8080h
  1826 000004B2 F3AB                    	rep	stosw
  1827 000004B4 B900A0                  	mov	cx, 0A000h
  1828 000004B7 8EC1                    	mov	es, cx
  1829 000004B9 E8FF00                  	call	ScopeLoop
  1830 000004BC 07                      	pop	es
  1831                                  	
  1832                                          ; load 2048 bytes into buffer 1
  1833 000004BD 8B36[6410]              	mov	si, [DMA_BUFFER1]
  1834                                  	; 11/05/2024
  1835                                  	;mov	cx, BUFFERSIZE
  1836                                  	;push	ds ; segment
  1837                                  	;push	si ; offset
  1838                                  	;push	cx ; count
  1839 000004C1 E87A06                  	call    GetSamples_ICH ; 18/02/2017
  1840                                  
  1841                                          ; load 2048 bytes into buffer  2
  1842 000004C4 8B36[6610]              	mov	si, [DMA_BUFFER2]
  1843                                  	; 11/05/2024
  1844                                  	;mov	cx, BUFFERSIZE
  1845                                  	;push	ds ; segment
  1846                                  	;push	si ; offset
  1847                                  	;push	cx ; count
  1848 000004C8 E87306                  	call	GetSamples_ICH ; 18/02/2017
  1849                                  
  1850                                  ; register reset the DMA engine. This may cause a pop noise on the output
  1851                                  ; lines when the device is reset. Prolly a better idea to mute output, then
  1852                                  ; reset.
  1853                                  
  1854                                  	; 08/05/2024
  1855                                          ;mov    dx, [NABMBAR]
  1856                                          ;add    dx, PO_CR_REG		; set pointer to Ctrl reg
  1857                                          ;mov    al, RR			; set reset
  1858                                  	;out    dx, al			; self clearing bit
  1859                                  
  1860                                  ; write last valid index to 31 to start with.
  1861                                  ; The Last Valid Index register tells the DMA engine when to stop playing.
  1862                                  ; 
  1863                                  ; As we progress through the song we change the last valid index to always be
  1864                                  ; something other than the index we're currently playing.
  1865                                  ;
  1866                                          ;;mov   al, 1
  1867                                          ;mov	al, 31
  1868                                  	;call   setLastValidIndex
  1869                                  
  1870                                  ; create Buffer Descriptor List
  1871                                  ;
  1872                                  ; A buffer descriptor list is a list of pointers and control bits that the
  1873                                  ; DMA engine uses to know where to get the .wav data and how to play it.
  1874                                  ;
  1875                                  ; I set it up to use only 2 buffers of .wav data, and whenever 1 buffer is
  1876                                  ; playing, I refresh the other one with good data.
  1877                                  ;
  1878                                  ;
  1879                                  ; For the control bits, you can specify that the DMA engine fire an interrupt
  1880                                  ; after a buffer has been processed, but I poll the current index register
  1881                                  ; to know when it's safe to update the other buffer.
  1882                                  ;
  1883                                  ; I set the BUP bit, which tells the DMA engine to just play 0's (silence)
  1884                                  ; if it ever runs out of data to play. Good for safety.
  1885                                  ;
  1886                                  	; 14/02/2017
  1887 000004CB 8B3E[6210]                      mov     di, [BDL_BUFFER]		; get BDL address
  1888 000004CF B91000                          mov     cx, 32 / 2                      ; make 32 entries in BDL
  1889 000004D2 6631D2                  	xor	edx, edx
  1890 000004D5 8CDA                    	mov	dx, ds
  1891 000004D7 66C1E204                	shl	edx, 4 ; segment*16 (linear/physical address of the segment)
  1892                                  _0:
  1893                                  
  1894                                  ; set buffer descriptor 0 to start of data file in memory
  1895                                  	; 14/02/2017
  1896 000004DB 660FB706[6410]                  movzx   eax, word [DMA_BUFFER1]
  1897 000004E1 6601D0                  	add	eax, edx ; linear/physical address of the buffer (seg*16+off)
  1898 000004E4 66AB                            stosd					; store dmabuffer1 address
  1899                                  
  1900                                  ;
  1901                                  ; set length to 32k samples. 1 sample is 16bits or 2bytes.
  1902                                  ; Set control (bits 31:16) to BUP, bits 15:0=number of samples.
  1903                                  ; 
  1904                                  
  1905                                  ; 17/02/2017 (Erdogan Tan)
  1906                                  ; Intel 82801AA (ICH) & Intel 82801AB (ICH0) I/O Controller Hub AC 97
  1907                                  ; Programmers Reference Manual
  1908                                  
  1909                                  ; 2.2.1 Buffer Descriptor List  (on Page 13)
  1910                                  	;
  1911                                  	;  Generic Form of Buffer Descriptor
  1912                                  	;  ---------------------------------
  1913                                  	;  63   62    61-48    47-32   31-0
  1914                                  	;  ---  ---  --------  ------- -----
  1915                                  	;  IOC  BUP -reserved- Buffer  Buffer
  1916                                  	;		      Length   Pointer
  1917                                  	;		      [15:0]   [31:0]
  1918                                  	;
  1919                                  	;  IOC:	Interrupt On Completion. 
  1920                                  	;	1 = Enabled. 
  1921                                  	;	    When this is set, it means that the controller should
  1922                                  	;	    issue an interrupt upon completion of this buffer.
  1923                                  	;	    It should also set the IOC bit in the status register
  1924                                  	;	0 = Disabled	
  1925                                  	;
  1926                                  	;  BUP: Buffer Underrun Policy.
  1927                                  	;       0 = When this buffer is complete,
  1928                                  	;	    if the next buffer is not yet ready 
  1929                                  	;	    (i.e., the last valid buffer has been processed),
  1930                                  	;	    then continue to transmit the last valid sample.
  1931                                  	;	1 = When this buffer is complete,
  1932                                  	;     	    if this is the last valid buffer, transmit zeros after
  1933                                  	;	    this buffer has been processed completely.
  1934                                  	;	    This bit typically is set only if this is the last 
  1935                                  	;	    buffer in the current stream.
  1936                                  	;
  1937                                  	; [31:0]: Buffer pointer. This field points to the location of
  1938                                  	;	  the data buffer. Since samples can be as wide as one
  1939                                  	;	  word, the buffer must be aligned with word boundaries,
  1940                                  	;	  to prevent samples from straddling DWord boundaries.
  1941                                  	;
  1942                                  	; [15:0]: Buffer Length: This is the length of the data buffer,
  1943                                  	;	  in number of samples. The controller uses this data
  1944                                  	;	  to determine the length of the buffer, in bytes.
  1945                                  	;	  "0" indicates no sample to process.
  1946                                  
  1947                                  ; ICH2AC97.INC
  1948                                  
  1949                                  ;	IOC	equ     BIT31   ; Fire an interrupt whenever this
  1950                                  				; buffer is complete.
  1951                                  
  1952                                  ;	BUP	equ     BIT30   ; Buffer Underrun Policy.
  1953                                  				; if this buffer is the last buffer
  1954                                  				; in a playback, fill the remaining
  1955                                  				; samples with 0 (silence) or not.
  1956                                  				; It's a good idea to set this to 1
  1957                                  				; for the last buffer in playback,
  1958                                  				; otherwise you're likely to get a lot
  1959                                  				; of noise at the end of the sound.
  1960                                  ;
  1961                                  ; Bits 15:0 contain the length of the buffer, in number of samples, which
  1962                                  ; are 16 bits each, coupled in left and right pairs, or 32bits each.
  1963                                  ; Luckily for us, that's the same format as .wav files.
  1964                                  ;
  1965                                  ; A value of FFFF is 65536 samples. Running at 44.1Khz, that's just about
  1966                                  ; 1.5 seconds of sample time. FFFF * 32bits is 1FFFFh bytes or 128k of data.
  1967                                  ;
  1968                                  ; A value of 0 in these bits means play no samples.
  1969                                  ;
  1970                                  	; 08/12/2016 - Erdogan Tan
  1971                                  	;mov	eax, BUFFERSIZE
  1972                                  	; 12/05/2024
  1973 000004E6 66B8001E0000            	mov	eax, BUFFERSIZE/2
  1974 000004EC 660D000000C0            	or	eax, IOC + BUP
  1975 000004F2 66AB                    	stosd
  1976                                  
  1977                                  ; 2nd buffer:
  1978                                  	; 14/02/2017
  1979 000004F4 660FB706[6610]                  movzx   eax, word [DMA_BUFFER2]
  1980 000004FA 6601D0                  	add	eax, edx ; linear/physical address of the buffer (seg*16+off)
  1981 000004FD 66AB                            stosd					; store dmabuffer2 address
  1982                                  
  1983                                  ; set length to 64k (32k of two 16 bit samples)
  1984                                  ; Set control (bits 31:16) to BUP, bits 15:0=number of samples
  1985                                  ; 
  1986                                  	; 08/12/2016 - Erdogan Tan
  1987                                  	;mov	eax, BUFFERSIZE
  1988                                  	; 12/05/2024
  1989 000004FF 66B8001E0000            	mov	eax, BUFFERSIZE/2
  1990 00000505 660D000000C0            	or	eax, IOC + BUP
  1991 0000050B 66AB                    	stosd
  1992 0000050D E2CC                            loop    _0
  1993                                  ;
  1994                                  ; tell the DMA engine where to find our list of Buffer Descriptors.
  1995                                  ; this 32bit value is a flat mode memory offset (ie no segment:offset)
  1996                                  ;
  1997                                  ; write NABMBAR+10h with offset of buffer descriptor list
  1998                                  ;
  1999 0000050F 660FB706[6210]                  movzx   eax, word [BDL_BUFFER]
  2000                                  	; 14/02/2017
  2001 00000515 6601D0                  	add	eax, edx ; linear/physical address of the BDL
  2002                                    	; 18/02/2017
  2003 00000518 8B16[5610]                      mov     dx, [NABMBAR]
  2004 0000051C 83C210                          add     dx, PO_BDBAR_REG                ; set pointer to BDL
  2005 0000051F 66EF                            out     dx, eax                         ; write to AC97 controller
  2006                                  
  2007                                  	; 15/05/2024
  2008 00000521 E84007                  	call	delay1_4ms
  2009                                  ;
  2010                                  ; All set. Let's play some music.
  2011                                  ;
  2012                                  	; 08/12/2016
  2013                                  	; 07/10/2016
  2014                                          ;mov    al, 1
  2015 00000524 B01F                            mov	al, 31
  2016                                  
  2017                                  	; 13/05/2024
  2018                                  	; 08/05/2024
  2019                                  	;mov	[LVI], al ; 10/11/2023
  2020                                  	;call   setLastValidIndex
  2021                                  
  2022                                  	;input AL = index # to stop on
  2023                                  setLastValidIndex:
  2024 00000526 8B16[5610]              	mov	dx, [NABMBAR]
  2025 0000052A 83C215                  	add	dx, PO_LVI_REG
  2026 0000052D EE                              out     dx, al
  2027                                  
  2028 0000052E C606[5B10]01            	mov	byte [tLoop], 1 ; 30/11/2016
  2029                                  
  2030                                  	; 15/05/2024
  2031 00000533 E82E07                  	call	delay1_4ms
  2032                                  
  2033                                  	; 12/05/2024	
  2034                                  	; 17/02/2017
  2035 00000536 8B16[5610]                      mov	dx, [NABMBAR]
  2036 0000053A 83C21B                          add	dx, PO_CR_REG			; PCM out Control Register
  2037 0000053D B011                            mov	al, IOCE + RPBM	; Enable 'Interrupt On Completion' + run
  2038                                  				; (LVBI interrupt will not be enabled)
  2039 0000053F EE                              out	dx, al				; Start bus master operation.
  2040                                  
  2041                                  	; 15/05/2024
  2042 00000540 E82107                  	call	delay1_4ms
  2043 00000543 E81E07                  	call	delay1_4ms
  2044 00000546 E81B07                  	call	delay1_4ms
  2045 00000549 E81807                  	call	delay1_4ms
  2046                                  
  2047                                  ; while DMA engine is running, examine current index and wait until it hits 1
  2048                                  ; as soon as it's 1, we need to refresh the data in wavbuffer1 with another
  2049                                  ; 64k.  Likewise when it's playing buffer 2, refresh buffer 1 and repeat.
  2050                                     
  2051                                  	; 18/02/2017
  2052                                  	; 14/02/2017
  2053                                  	; 13/02/2017
  2054                                  	; 08/12/2016
  2055                                  	; 28/11/2016
  2056                                  
  2057 0000054C 06                      	push	es
  2058 0000054D B800A0                  	mov	ax, 0A000h
  2059 00000550 8EC0                    	mov	es, ax
  2060                                  	;mov	bp, DmaBuffer ; 14/02/2017
  2061                                  p_loop:
  2062 00000552 B401                    	mov     ah, 1			; any key pressed?
  2063                                  	;mov	ah, 11h
  2064 00000554 CD16                    	int     16h			; no, Loop.
  2065 00000556 7445                    	jz	short q_loop
  2066                                  
  2067 00000558 B400                    	mov	ah, 0
  2068                                  	;mov    ah, 10h			; flush key buffer...
  2069 0000055A CD16                    	int     16h
  2070                                  
  2071                                  	; 12/05/2024 (change PCM out volume)
  2072 0000055C 3C2B                    	cmp	al, '+'
  2073 0000055E 750B                    	jne	short p_1
  2074                                  	
  2075 00000560 A0[7310]                	mov	al, [volume]
  2076 00000563 3C00                    	cmp	al, 0
  2077 00000565 7636                    	jna	short q_loop
  2078 00000567 FEC8                    	dec	al
  2079 00000569 EB0D                    	jmp	short p_2
  2080                                  p_1:
  2081 0000056B 3C2D                    	cmp	al, '-'
  2082 0000056D 7524                    	jne	short p_return
  2083                                  
  2084 0000056F A0[7310]                	mov	al, [volume]
  2085 00000572 3C1F                    	cmp	al, 31
  2086 00000574 7327                    	jnb	short q_loop
  2087 00000576 FEC0                    	inc	al
  2088                                  p_2:
  2089 00000578 A2[7310]                	mov	[volume], al
  2090 0000057B 88C4                    	mov	ah, al
  2091 0000057D 8B16[5410]              	mov     dx, [NAMBAR]
  2092                                    	;add    dx, CODEC_MASTER_VOL_REG
  2093 00000581 83C218                  	add	dx, CODEC_PCM_OUT_REG
  2094 00000584 EF                      	out     dx, ax
  2095                                  
  2096                                  	; 12/05/2024
  2097 00000585 E8DC06                  	call    delay1_4ms
  2098 00000588 E8D906                          call    delay1_4ms
  2099 0000058B E8D606                          call    delay1_4ms
  2100 0000058E E8D306                          call    delay1_4ms
  2101                                  
  2102 00000591 EB0A                    	jmp	short q_loop
  2103                                  
  2104                                  p_return:
  2105 00000593 C606[5B10]00            	mov	byte [tLoop], 0	; 13/02/2017
  2106                                  	; 16/05/2024
  2107 00000598 E8A206                  	call	StopPlaying
  2108 0000059B 07                      	pop	es
  2109 0000059C C3                      	retn
  2110                                  
  2111                                  q_loop:
  2112                                  	; 10/05/2024
  2113 0000059D 31C0                    	xor	ax, ax
  2114 0000059F 8606[5810]              	xchg	al, [tBuff] ; AL = [tBuff], [tBuff] = 0
  2115 000005A3 3C01                    	cmp	al, 1
  2116 000005A5 7708                    	ja	short r_loop
  2117                                  	;jb	short ScopeLoop
  2118                                  	; 15/05/2024
  2119 000005A7 720D                    	jb	short x_loop
  2120                                  	;
  2121 000005A9 8B36[6410]                   	mov	si, [DMA_BUFFER1] ; [tBuff]=1 (from tuneLoop)
  2122 000005AD EB04                           	jmp	short s_loop 
  2123                                  r_loop:
  2124                                  	; 13/02/2017
  2125 000005AF 8B36[6610]                      mov     si, [DMA_BUFFER2] ; [tBuff]=2 (from tuneLoop)
  2126                                  s_loop:
  2127                                  	; 14/02/2017
  2128                                  	;mov	bp, si ; save current buffer addres in bp register
  2129                                  	; 11/05/2024
  2130                                  	;mov	cx, BUFFERSIZE ; 2048*4 byte
  2131                                  	;push	ds ; segment
  2132                                  	;push	si ; offset
  2133                                  	;push	cx ; count
  2134 000005B3 E88805                  	call    GetSamples_ICH ; 18/02/2017
  2135                                  
  2136                                  	; 15/05/2024
  2137                                  x_loop:
  2138 000005B6 E80200                  	call	ScopeLoop
  2139 000005B9 EB97                    	jmp	short p_loop
  2140                                  
  2141                                  ScopeLoop:
  2142                                  	;mov    si, bp			; get current samples
  2143 000005BB BE[92EC]                	mov	si, MOD_BUFFER ; 18/02/2017
  2144 000005BE 31C9                    	xor     cx, cx			; to be drawed ...
  2145 000005C0 31D2                    	xor     dx, dx
  2146                                  DrawLoop:       
  2147 000005C2 89D3                    	mov     bx, dx			; (save Index)
  2148 000005C4 8BBF[10E8]              	mov     di, [Scope+bx]		; get old SCOPE pixel address
  2149 000005C8 26C60500                	mov     byte [es:di], 0		; erase it!
  2150 000005CC AC                      	lodsb				; get a sample (8-bit)
  2151 000005CD 88C3                    	mov     bl, al			; calc new pixel address...
  2152 000005CF 30FF                    	xor     bh, bh
  2153 000005D1 D1E3                    	shl     bx, 1
  2154 000005D3 8BBF[90EA]              	mov     di, [RowOfs+bx]
  2155 000005D7 01CF                    	add     di, cx
  2156 000005D9 89D3                    	mov     bx, dx			; (restore Index)
  2157 000005DB 89BF[10E8]              	mov     [Scope+bx], di		; save new address...
  2158 000005DF 26C6050A                	mov     byte [es:di], 10 ; 0Ah	; and DRAW.
  2159 000005E3 83C202                  	add     dx, 2			; the next pixel...
  2160 000005E6 41                      	inc     cx
  2161 000005E7 81F94001                	cmp     cx, 320			; 320 pixels drawed?
  2162 000005EB 72D5                    	jb      short DrawLoop
  2163                                  	; 15/05/2024
  2164                                  	;jmp	p_loop
  2165 000005ED C3                      	retn
  2166                                  
  2167                                  ; 13/05/2024
  2168                                  %if 0
  2169                                  
  2170                                  tuneLoop:
  2171                                  	; 11/05/2024
  2172                                  	; 11/11/2023
  2173                                  	; 10/11/2023
  2174                                  	; 18/02/2017
  2175                                  	; 08/12/2016
  2176                                  	; 28/11/2016 - Erdogan Tan
  2177                                  
  2178                                  	; 11/05/2024
  2179                                  	cmp	byte [tLoop], 1
  2180                                  	jb	short tL3
  2181                                  	
  2182                                  	call    getCurrentIndex
  2183                                  
  2184                                  	; 10/11/2023
  2185                                  	cmp	al, [LVI]
  2186                                  	jne	short tL1
  2187                                  
  2188                                  	dec	ax
  2189                                  	and	al, 1Fh 
  2190                                  	call	setLastValidIndex
  2191                                  	xchg	al, [LVI]
  2192                                  tL1:
  2193                                  	test	al, BIT0
  2194                                  	jz	short tL2
  2195                                  
  2196                                  	; 11/05/2024
  2197                                  	mov	byte [tBuff], 1
  2198                                  	retn
  2199                                  tL2:	
  2200                                  	mov	byte [tBuff], 2
  2201                                  tL3:
  2202                                  	retn
  2203                                  
  2204                                  ; returns AL = current index value
  2205                                  getCurrentIndex:
  2206                                  	;push	dx
  2207                                  	mov	dx, [NABMBAR]
  2208                                  	add	dx, PO_CIV_REG
  2209                                  	in	al, dx
  2210                                  	;pop	dx
  2211                                  	retn
  2212                                  
  2213                                  ;input AL = index # to stop on
  2214                                  setLastValidIndex:
  2215                                  	;push	dx
  2216                                  	mov	dx, [NABMBAR]
  2217                                  	add	dx, PO_LVI_REG
  2218                                          out     dx, al
  2219                                  	;pop	dx
  2220                                  	retn
  2221                                  
  2222                                  %endif
  2223                                  
  2224                                  ;=============================================================================
  2225                                  ;               MODLOAD.ASM
  2226                                  ;=============================================================================
  2227                                  
  2228                                  ; Amiga Module Loader v0.1b by Carlos Hasan.
  2229                                  ;		July 10th, 1993.
  2230                                  
  2231                                  ; STRUCTURES
  2232                                  
  2233                                  struc ModSample
  2234 00000000 <res 16h>               .msName:	resb 22
  2235 00000016 ????                    .msLength:	resw 1
  2236 00000018 ??                      .msFinetune:	resb 1
  2237 00000019 ??                      .msVolume:	resb 1
  2238 0000001A ????                    .msRepeat:	resw 1
  2239 0000001C ????                    .msRepLen:	resw 1
  2240                                  .size:
  2241                                  endstruc
  2242                                  
  2243                                  struc ModHeader
  2244 00000000 <res 14h>               .mhName:	resb 20
  2245 00000014 <res 3A2h>              .mhSamples:	resb ModSample.size*31
  2246 000003B6 ??                      .mhOrderLen:	resb 1
  2247 000003B7 ??                      .mhReStart:	resb 1
  2248 000003B8 <res 80h>               .mhOrder:	resb 128
  2249 00000438 ????????                .mhSign:	resw 2
  2250                                  .size:	
  2251                                  endstruc
  2252                                  
  2253                                  struc ModInfoRec
  2254 00000000 ??                      .OrderLen:	resb 1
  2255 00000001 ??                      .ReStart:	resb 1
  2256 00000002 <res 80h>               .Order:		resb 128
  2257 00000082 ????????                .Patterns:	resd 1
  2258 00000086 <res 3Eh>               .SampOfs:	resw 31
  2259 000000C4 <res 3Eh>               .SampSeg:	resw 31
  2260 00000102 <res 3Eh>               .SampLen:	resw 31
  2261 00000140 <res 3Eh>               .SampRep:	resw 31
  2262 0000017E <res 3Eh>               .SampRepLen:	resw 31
  2263 000001BC <res 3Eh>               .SampVol:	resw 31
  2264                                  .size:	
  2265                                  endstruc
  2266                                  
  2267                                  ; CODE
  2268                                  
  2269                                  LoadModule:
  2270                                  		;es:di = filename
  2271                                  
  2272                                  		;[sp+4] = es
  2273                                  		;[sp+2] = di
  2274                                  
  2275                                  		FileName equ 4
  2276                                  
  2277 000005EE 55                      		push    bp
  2278 000005EF 89E5                    		mov     bp, sp
  2279 000005F1 60                      		pusha
  2280 000005F2 1E                      		push    ds
  2281 000005F3 06                      		push    es
  2282                                  
  2283 000005F4 C706[8289]0100          		mov	word [ErrorInfo], 1
  2284                                  
  2285 000005FA E85101                  		call    ClearModInfo
  2286                                  OpenFile:       
  2287 000005FD 1E                      		push    ds
  2288 000005FE B8003D                  		mov     ax, 3D00h
  2289 00000601 C55604                  		lds     dx, [bp+FileName]
  2290 00000604 CD21                    		int     21h
  2291 00000606 1F                      		pop     ds
  2292 00000607 0F823C01                		jc      Failed
  2293 0000060B A3[8089]                		mov     [FileHandle], ax
  2294                                  
  2295                                  ReadHeader:     
  2296 0000060E B8003F                  		mov     ax, 3F00h
  2297 00000611 8B1E[8089]              		mov     bx, [FileHandle]
  2298 00000615 B93C04                  		mov     cx, ModHeader.size
  2299                                  		;lea    dx, [Header]
  2300 00000618 BA[8489]                		mov	dx, Header
  2301 0000061B CD21                    		int     21h
  2302 0000061D 0F821D01                		jc      CloseFile
  2303                                  CheckMK:        
  2304 00000621 813E[BC8D]4D2E          		cmp     word [Header+ModHeader.mhSign], 'M.'
  2305 00000627 7508                    		jne     short CheckFLT4
  2306 00000629 813E[BE8D]4B2E          		cmp     word [Header+ModHeader.mhSign+2], 'K.'
  2307 0000062F 7439                    		je      short IsModFile
  2308                                  CheckFLT4:
  2309 00000631 813E[BC8D]464C          		cmp     word [Header+ModHeader.mhSign], 'FL'
  2310 00000637 7508                    		jne     short Is15Inst
  2311 00000639 813E[BE8D]5434          		cmp     word [Header+ModHeader.mhSign+2], 'T4'
  2312 0000063F 7429                    		je      short IsModFile
  2313                                  Is15Inst:
  2314 00000641 BE[5A8B]                		mov     si, (Header+ModHeader.mhSamples) + (15*ModSample.size)
  2315 00000644 BF[3A8D]                		mov     di, Header+ModHeader.mhOrderLen
  2316 00000647 8CD8                    		mov     ax, ds
  2317 00000649 8EC0                    		mov     es, ax
  2318 0000064B FC                      		cld
  2319 0000064C B98200                  		mov     cx, 130
  2320 0000064F F3A4                    		rep     movsb
  2321 00000651 BF[5A8B]                		mov     di, Header+ModHeader.mhSamples + (15*ModSample.size)
  2322 00000654 31C0                    		xor     ax, ax
  2323 00000656 B9E001                  		mov     cx, 16*ModSample.size
  2324 00000659 F3AA                    		rep     stosb
  2325                                  SeekPatterns:   
  2326 0000065B B80042                  		mov     ax, 4200h
  2327 0000065E 8B1E[8089]              		mov     bx, [FileHandle]
  2328 00000662 B90000                  		mov     cx, 0
  2329 00000665 BA5802                  		mov     dx, 600
  2330 00000668 CD21                    		int     21h
  2331                                  IsModFile:  
  2332 0000066A A0[3A8D]                		mov     al, [Header+ModHeader.mhOrderLen]
  2333 0000066D A2[C28D]                		mov     [ModInfo.OrderLen], al
  2334                                  
  2335 00000670 A0[3B8D]                		mov     al, [Header+ModHeader.mhReStart]
  2336 00000673 3A06[3A8D]              		cmp     al, [Header+ModHeader.mhOrderLen]
  2337 00000677 7202                    		jb      short SetReStart
  2338 00000679 B07F                    		mov     al, 7Fh
  2339                                  SetReStart:
  2340 0000067B A2[C38D]                		mov     [ModInfo.ReStart], al
  2341                                  
  2342 0000067E B98000                  		mov     cx, 128
  2343 00000681 31C0                    		xor     ax, ax
  2344 00000683 31DB                    		xor     bx, bx
  2345                                  CopyOrder:
  2346 00000685 8AA7[3C8D]              		mov     ah, [Header+ModHeader.mhOrder+bx]
  2347 00000689 88A7[C48D]              		mov     [ModInfo.Order+bx], ah
  2348 0000068D 38C4                    		cmp     ah, al
  2349 0000068F 7202                    		jb      short NextOrder
  2350 00000691 88E0                    		mov     al, ah
  2351                                  NextOrder:
  2352 00000693 43                      		inc     bx
  2353 00000694 E2EF                    		loop    CopyOrder
  2354                                  AllocPatterns:  
  2355                                  		; Erdogan Tan (13/02/2017)
  2356 00000696 30E4                    		xor	ah, ah
  2357 00000698 FEC0                    		inc	al
  2358                                  		; al = count of 1024 bytes
  2359 0000069A 89C3                    		mov	bx, ax
  2360                                  		; count of paragraphs = al*64 
  2361 0000069C C1E006                  		shl	ax, 6 ; *64
  2362 0000069F 89C5                    		mov	bp, ax
  2363 000006A1 8CCA                    		mov	dx, cs ; current (code) segment
  2364 000006A3 81C20010                		add	dx, 1000h ; next 64K (4096*16)
  2365                                  		;
  2366 000006A7 C706[448E]0000          		mov	word [ModInfo.Patterns], 0
  2367 000006AD 8916[468E]              		mov	[ModInfo.Patterns+2], dx
  2368                                  		;
  2369 000006B1 01D5                    		add	bp, dx ; next segment for samples
  2370                                  ReadPatterns:   
  2371 000006B3 1E                      		push    ds
  2372 000006B4 B8003F                  		mov     ax, 3F00h
  2373 000006B7 89D9                    		mov     cx, bx ; count of 1024 bytes
  2374 000006B9 C1E10A                  		shl     cx, 10 ; byte count (cx*1024)
  2375 000006BC 8B1E[8089]              		mov     bx, [FileHandle]
  2376                                  		;lds    dx, [ModInfo.Patterns]
  2377 000006C0 8EDA                    		mov	ds, dx
  2378 000006C2 31D2                    		xor	dx, dx
  2379 000006C4 CD21                    		int     21h
  2380 000006C6 1F                      		pop     ds
  2381 000006C7 7275                    		jc      CloseFile
  2382                                  
  2383                                  		;lea	si, [Header+ModHeader.mhSamples]
  2384 000006C9 BE[9889]                		mov	si, Header+ModHeader.mhSamples
  2385 000006CC 31FF                    		xor     di, di
  2386                                  CopySamples:
  2387 000006CE 8B4416                  		mov     ax, [si+ModSample.msLength]
  2388 000006D1 86C4                    		xchg    al, ah
  2389 000006D3 D1E0                    		shl     ax, 1
  2390 000006D5 8985[C48E]              		mov     [ModInfo.SampLen+di], ax
  2391 000006D9 8A4419                  		mov     al, [si+ModSample.msVolume]
  2392 000006DC 30E4                    		xor     ah, ah
  2393 000006DE 8985[7E8F]              		mov     [ModInfo.SampVol+di], ax
  2394 000006E2 8B441A                  		mov     ax, [si+ModSample.msRepeat]
  2395 000006E5 86C4                    		xchg    al, ah
  2396 000006E7 D1E0                    		shl     ax, 1
  2397 000006E9 8985[028F]              		mov     [ModInfo.SampRep+di], ax
  2398 000006ED 8B441C                  		mov     ax, [si+ModSample.msRepLen]
  2399 000006F0 86C4                    		xchg    al, ah
  2400 000006F2 D1E0                    		shl     ax, 1
  2401 000006F4 8985[408F]              		mov     [ModInfo.SampRepLen+di], ax
  2402 000006F8 83C61E                  		add     si, ModSample.size
  2403 000006FB 83C702                  		add     di, 2
  2404 000006FE 83FF3E                  		cmp     di, 2*31
  2405 00000701 72CB                    		jb      short CopySamples
  2406                                  
  2407 00000703 31F6                    		xor     si, si
  2408                                  AllocSamples:
  2409                                  		; Erdogan Tan (13/02/2017)
  2410                                  		;mov	bx, [ModInfo.SampLen+si]
  2411 00000705 8B8C[C48E]              		mov	cx, [ModInfo.SampLen+si]
  2412 00000709 89CB                    		mov	bx, cx
  2413 0000070B C1EB04                  		shr     bx, 4 ; byte count / 16
  2414 0000070E 7420                    		jz      short NextSample
  2415 00000710 43                      		inc	bx ; number of paragraphs
  2416 00000711 C784[488E]0000          		mov	word [ModInfo.SampOfs+si], 0
  2417 00000717 89AC[868E]              		mov     [ModInfo.SampSeg+si], bp
  2418 0000071B 89EA                    		mov	dx, bp
  2419 0000071D 01DD                    		add	bp, bx ; next segment for sample 
  2420                                  ReadSample:
  2421 0000071F 1E                      		push    ds
  2422 00000720 B8003F                  		mov     ax, 3F00h
  2423 00000723 8B1E[8089]              		mov     bx, [FileHandle]
  2424                                  		;mov    cx, [ModInfo.SampLen+si]
  2425                                  		;mov    dx, [ModInfo.SampOfs+si]
  2426                                  		;mov    ds, [ModInfo.SampSeg+si]
  2427 00000727 8EDA                    		mov	ds, dx
  2428 00000729 31D2                    		xor	dx, dx
  2429 0000072B CD21                    		int     21h
  2430 0000072D 1F                      		pop     ds
  2431 0000072E 720E                    		jc      short CloseFile
  2432                                  NextSample:
  2433 00000730 83C602                  		add     si, 2
  2434 00000733 83FE3E                  		cmp     si, 2*31
  2435 00000736 72CD                    		jb      short AllocSamples
  2436                                  
  2437 00000738 C706[8289]0000          		mov     word [ErrorInfo], 0
  2438                                  CloseFile:      
  2439 0000073E B8003E                  		mov     ax, 3E00h
  2440 00000741 8B1E[8089]              		mov     bx, [FileHandle]
  2441 00000745 CD21                    		int     21h
  2442                                  Failed:         
  2443 00000747 07                      		pop     es
  2444 00000748 1F                      		pop     ds
  2445 00000749 61                      		popa
  2446 0000074A 5D                      		pop     bp
  2447 0000074B C20400                  		ret	4
  2448                                  
  2449                                  FreeModule:
  2450                                  		; Erdogan Tan (13/02/2017)
  2451                                  		; nothing to do here for memory de-allocation
  2452                                  ClearModInfo:
  2453 0000074E 60                      		pusha
  2454 0000074F 06                      		push    es
  2455 00000750 8CD8                    		mov     ax, ds
  2456 00000752 8EC0                    		mov     es, ax
  2457                                  		;lea    di, [ModInfo]
  2458 00000754 BF[C28D]                		mov	di, ModInfo
  2459 00000757 B9FA01                  		mov     cx, ModInfoRec.size
  2460 0000075A FC                      		cld
  2461 0000075B 31C0                    		xor     ax, ax
  2462 0000075D F3AA                    		rep     stosb
  2463 0000075F 07                      		pop     es
  2464 00000760 61                      		popa
  2465 00000761 C3                      		retn
  2466                                  
  2467                                  ;=============================================================================
  2468                                  ;               MODPLAY.ASM
  2469                                  ;=============================================================================
  2470                                  
  2471                                  ; Amiga Module Player v0.3b by Carlos Hasan.
  2472                                  ;		July 23th, 1993.
  2473                                  
  2474                                  ; EQUATES
  2475                                  
  2476                                  NumTracks       equ 4
  2477                                  DefTempo        equ 6
  2478                                  DefBpm          equ 125
  2479                                  MidCRate        equ 8448
  2480                                  MixBufSize      equ 4096
  2481                                  
  2482                                  ; STRUCTURES
  2483                                  
  2484                                  struc TrackInfo
  2485 00000000 ????????                .Samples:	resd 1
  2486 00000004 ????                    .Position:	resw 1
  2487 00000006 ????                    .Len:		resw 1
  2488 00000008 ????                    .Repeat:	resw 1
  2489 0000000A ????                    .RepLen:	resw 1
  2490 0000000C ??                      .Volume: 	resb 1
  2491 0000000D ??                      .Error:		resb 1
  2492 0000000E ????                    .Period:	resw 1
  2493 00000010 ????                    .Pitch:		resw 1
  2494 00000012 ????                    .Effect:	resw 1
  2495 00000014 ????                    .PortTo:	resw 1
  2496 00000016 ??                      .PortParm:	resb 1
  2497 00000017 ??                      .VibPos:	resb 1
  2498 00000018 ??                      .VibParm:	resb 1
  2499 00000019 ??                      .OldSampOfs:	resb 1
  2500 0000001A ????????????            .Arp:		resw 3
  2501 00000020 ????                    .ArpIndex:	resw 1
  2502                                  .size:
  2503                                  endstruc
  2504                                  
  2505                                  ; CODE
  2506                                  
  2507                                  ;--------------------------------------------------------------------------
  2508                                  ; BeatTrack:  Process the next beat in one track.
  2509                                  ;  In:
  2510                                  ;    ds:di -  Track info Address.
  2511                                  ;--------------------------------------------------------------------------
  2512                                  
  2513                                  BeatTrack:
  2514 00000762 8B5512                  		mov     dx, [di+TrackInfo.Effect]
  2515 00000765 85D2                    		test    dx, dx
  2516 00000767 7430                    		je      short None
  2517 00000769 80FE00                  		cmp     dh, 00h
  2518 0000076C 742C                    		je      short Arpeggio
  2519 0000076E 80FE01                  		cmp     dh, 01h
  2520 00000771 743E                    		je      short PortUp
  2521 00000773 80FE02                  		cmp     dh, 02h
  2522 00000776 7455                    		je      short PortDown
  2523 00000778 80FE03                  		cmp     dh, 03h
  2524 0000077B 746D                    		je      short TonePort
  2525 0000077D 80FE04                  		cmp     dh, 04h
  2526 00000780 0F849100                		je      Vibrato
  2527 00000784 80FE05                  		cmp     dh, 05h
  2528 00000787 0F84D600                		je      PortSlide
  2529 0000078B 80FE06                  		cmp     dh, 06h
  2530 0000078E 0F84D700                		je      VibSlide
  2531 00000792 80FE0A                  		cmp     dh, 0Ah
  2532 00000795 0F84D800                		je      VolSlide
  2533                                  None:
  2534 00000799 C3                      		retn
  2535                                  Arpeggio:
  2536 0000079A 8B5D20                  		mov     bx, [di+TrackInfo.ArpIndex]
  2537 0000079D 8B411A                  		mov     ax, [di+TrackInfo.Arp+bx]
  2538 000007A0 894510                  		mov     [di+TrackInfo.Pitch], ax
  2539 000007A3 83C302                  		add     bx, 2
  2540 000007A6 83FB06                  		cmp     bx, 6
  2541 000007A9 7202                    		jb      short SetArpIndex
  2542 000007AB 31DB                    		xor     bx,bx
  2543                                  SetArpIndex:
  2544 000007AD 895D20                  		mov     [di+TrackInfo.ArpIndex], bx
  2545 000007B0 C3                      		retn
  2546                                  PortUp:
  2547 000007B1 30F6                    		xor     dh, dh
  2548 000007B3 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2549 000007B6 29D3                    		sub     bx, dx
  2550 000007B8 83FB71                  		cmp     bx, 113
  2551 000007BB 7D03                    		jge     short NotSmall
  2552 000007BD BB7100                  		mov     bx, 113
  2553                                  NotSmall:
  2554 000007C0 895D0E                  		mov     [di+TrackInfo.Period], bx
  2555 000007C3 01DB                    		add     bx, bx
  2556 000007C5 8B87[BC8F]              		mov     ax, [PitchTable+bx]
  2557 000007C9 894510                  		mov     [di+TrackInfo.Pitch], ax
  2558 000007CC C3                      		retn
  2559                                  PortDown:
  2560 000007CD 30F6                    		xor     dh, dh
  2561 000007CF 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2562 000007D2 01D3                    		add     bx, dx
  2563 000007D4 81FB5803                		cmp     bx, 856
  2564 000007D8 7E03                    		jle     short NotBig
  2565 000007DA BB5803                  		mov     bx, 856
  2566 000007DD 895D0E                  NotBig:         mov     [di+TrackInfo.Period], bx
  2567 000007E0 01DB                    		add     bx, bx
  2568 000007E2 8B87[BC8F]              		mov     ax, [PitchTable+bx]
  2569 000007E6 894510                  		mov     [di+TrackInfo.Pitch], ax
  2570 000007E9 C3                      		retn
  2571                                  TonePort:
  2572 000007EA 30F6                    		xor     dh, dh
  2573 000007EC 8B4514                  		mov     ax, [di+TrackInfo.PortTo]
  2574 000007EF 8B5D0E                  		mov     bx, [di+TrackInfo.Period]
  2575 000007F2 39C3                    		cmp     bx, ax
  2576 000007F4 741E                    		je      short NoPort
  2577 000007F6 7F0A                    		jg      short PortToUp
  2578                                  PortToDown:     
  2579 000007F8 01D3                    		add     bx, dx
  2580 000007FA 39C3                    		cmp     bx, ax
  2581 000007FC 7E0A                    		jle     short SetPort
  2582                                  FixPort:        
  2583 000007FE 89C3                    		mov     bx, ax
  2584 00000800 EB06                    		jmp     short SetPort
  2585                                  PortToUp:
  2586 00000802 29D3                    		sub     bx, dx
  2587 00000804 39C3                    		cmp     bx, ax
  2588 00000806 7CF6                    		jl      short FixPort
  2589                                  SetPort:
  2590 00000808 895D0E                  		mov     [di+TrackInfo.Period], bx
  2591 0000080B 01DB                    		add     bx, bx
  2592 0000080D 8B87[BC8F]              		mov     ax, [PitchTable+bx]
  2593 00000811 894510                  		mov     [di+TrackInfo.Pitch], ax
  2594                                  NoPort:
  2595 00000814 C3                      		retn
  2596                                  Vibrato:
  2597 00000815 88D6                    		mov     dh, dl
  2598 00000817 80E20F                  		and     dl, 0Fh
  2599 0000081A C0EE04                  		shr     dh, 4
  2600 0000081D C0E602                  		shl     dh, 2
  2601 00000820 007517                  		add     [di+TrackInfo.VibPos], dh
  2602 00000823 8A7517                  		mov     dh, [di+TrackInfo.VibPos]
  2603 00000826 88F3                    		mov     bl, dh
  2604 00000828 C0EB02                  		shr     bl, 2
  2605 0000082B 83E31F                  		and     bx, 1Fh
  2606 0000082E 8A87[DC0E]              		mov     al, [SinTable+bx]
  2607 00000832 F6E2                    		mul     dl
  2608 00000834 D1C0                    		rol     ax, 1
  2609 00000836 86C4                    		xchg    al, ah
  2610 00000838 80E401                  		and     ah, 1
  2611 0000083B 84F6                    		test    dh, dh
  2612 0000083D 7902                    		jns     short VibUp
  2613 0000083F F7D8                    		neg     ax
  2614                                  VibUp:
  2615 00000841 03450E                  		add     ax, [di+TrackInfo.Period]
  2616 00000844 89C3                    		mov     bx, ax
  2617 00000846 83FB71                  		cmp     bx, 113
  2618 00000849 7D03                    		jge     short NoLoVib
  2619 0000084B BB7100                  		mov     bx, 113
  2620                                  NoLoVib:
  2621 0000084E 81FB5803                		cmp     bx, 856
  2622 00000852 7E03                    		jle     short NoHiVib
  2623 00000854 BB5803                  		mov     bx, 856
  2624                                  NoHiVib:
  2625 00000857 01DB                    		add     bx, bx
  2626 00000859 8B87[BC8F]              		mov     ax, [PitchTable+bx]
  2627 0000085D 894510                  		mov     [di+TrackInfo.Pitch], ax
  2628 00000860 C3                      		retn
  2629                                  PortSlide:
  2630 00000861 E80D00                  		call    VolSlide
  2631 00000864 8A5516                  		mov     dl, [di+TrackInfo.PortParm]
  2632 00000867 EB81                    		jmp     short TonePort
  2633                                  VibSlide:
  2634 00000869 E80500                  		call    VolSlide
  2635 0000086C 8A5518                  		mov     dl, [di+TrackInfo.VibParm]
  2636 0000086F EBA4                    		jmp     short Vibrato
  2637                                  VolSlide:
  2638 00000871 88D6                    		mov     dh, dl
  2639 00000873 80E20F                  		and     dl, 0Fh
  2640 00000876 C0EE04                  		shr     dh, 4
  2641 00000879 8A450C                  		mov     al, [di+TrackInfo.Volume]
  2642 0000087C 28D0                    		sub     al, dl
  2643 0000087E 7D02                    		jge     short NoLoVol
  2644 00000880 30C0                    		xor     al, al
  2645                                  NoLoVol:
  2646 00000882 00F0                    		add     al, dh
  2647 00000884 3C40                    		cmp     al, 64
  2648 00000886 7602                    		jbe     short NoHiVol
  2649 00000888 B040                    		mov     al, 64
  2650                                  NoHiVol:
  2651 0000088A 88450C                  		mov     [di+TrackInfo.Volume], al
  2652 0000088D C3                      		retn
  2653                                  
  2654                                  ;--------------------------------------------------------------------------
  2655                                  ; GetTrack:   Get the next Note from a pattern.
  2656                                  ;  In:
  2657                                  ;    ds:di -  Track info Address.
  2658                                  ;    es:si -  Pattern Note Address.
  2659                                  ; Out:
  2660                                  ;    es:si -  The Next Pattern Note address.
  2661                                  ;--------------------------------------------------------------------------
  2662                                  
  2663                                  GetTrack:
  2664 0000088E 26AD                    		es lodsw
  2665 00000890 86C4                    		xchg    al, ah
  2666 00000892 88E3                    		mov     bl, ah
  2667 00000894 80E40F                  		and     ah, 0Fh
  2668 00000897 89C1                    		mov     cx, ax
  2669 00000899 26AD                    		es lodsw
  2670 0000089B 86C4                    		xchg    al, ah
  2671 0000089D 88E7                    		mov     bh, ah
  2672 0000089F 80E40F                  		and     ah, 0Fh
  2673 000008A2 89C2                    		mov     dx, ax
  2674 000008A4 895512                  		mov     [di+TrackInfo.Effect], dx
  2675 000008A7 80E3F0                  		and     bl, 0F0h
  2676 000008AA C0EF04                  		shr     bh, 4
  2677 000008AD 08FB                    		or      bl, bh
  2678 000008AF 742E                    		je      short SetPeriod
  2679                                  SetSample:
  2680 000008B1 30FF                    		xor     bh, bh
  2681 000008B3 4B                      		dec     bx
  2682 000008B4 01DB                    		add     bx, bx
  2683 000008B6 8B87[7E8F]              		mov     ax, [ModInfo.SampVol+bx]
  2684 000008BA 88450C                  		mov     [di+TrackInfo.Volume], al
  2685 000008BD 8B87[488E]              		mov     ax, [ModInfo.SampOfs+bx]
  2686 000008C1 8905                    		mov     [di+TrackInfo.Samples], ax
  2687 000008C3 8B87[868E]              		mov     ax, [ModInfo.SampSeg+bx]
  2688 000008C7 894502                  		mov     [di+TrackInfo.Samples+2], ax
  2689 000008CA 8B87[C48E]              		mov     ax, [ModInfo.SampLen+bx]
  2690 000008CE 894506                  		mov     [di+TrackInfo.Len], ax
  2691 000008D1 8B87[028F]              		mov     ax, [ModInfo.SampRep+bx]
  2692 000008D5 894508                  		mov     [di+TrackInfo.Repeat], ax
  2693 000008D8 8B87[408F]              		mov     ax, [ModInfo.SampRepLen+bx]
  2694 000008DC 89450A                  		mov     [di+TrackInfo.RepLen], ax
  2695                                  SetPeriod:      
  2696 000008DF 85C9                    		test    cx, cx
  2697 000008E1 741B                    		je      short SetEffect
  2698                                  
  2699 000008E3 894D14                  		mov     [di+TrackInfo.PortTo], cx
  2700 000008E6 80FE03                  		cmp     dh, 03h
  2701 000008E9 7413                    		je      short SetEffect
  2702                                  
  2703 000008EB 894D0E                  		mov     [di+TrackInfo.Period], cx
  2704 000008EE 89CB                    		mov     bx, cx
  2705 000008F0 01DB                    		add     bx, bx
  2706 000008F2 8B87[BC8F]              		mov     ax, [PitchTable+bx]
  2707 000008F6 894510                  		mov     [di+TrackInfo.Pitch], ax
  2708 000008F9 C745040000              		mov     word [di+TrackInfo.Position], 0
  2709                                  SetEffect:
  2710 000008FE 85D2                    		test    dx, dx
  2711 00000900 742A                    		je      short InitNone
  2712 00000902 80FE00                  		cmp     dh, 00h
  2713 00000905 0F84C400                		je      InitArpeggio
  2714 00000909 80FE03                  		cmp     dh, 03h
  2715 0000090C 741F                    		je      short InitTonePort
  2716 0000090E 80FE04                  		cmp     dh, 04h
  2717 00000911 7428                    		je      short InitVibrato
  2718 00000913 80FE09                  		cmp     dh, 09h
  2719 00000916 744A                    		je      short SampleOfs
  2720 00000918 80FE0B                  		cmp     dh, 0Bh
  2721 0000091B 7457                    		je      short PosJump
  2722 0000091D 80FE0C                  		cmp     dh, 0Ch
  2723 00000920 745C                    		je      short SetVolume
  2724 00000922 80FE0D                  		cmp     dh, 0Dh
  2725 00000925 7462                    		je      short Break
  2726 00000927 80FE0F                  		cmp     dh, 0Fh
  2727 0000092A 7478                    		je      short SetSpeed
  2728                                  InitNone:
  2729 0000092C C3                      		retn
  2730                                  InitTonePort:
  2731 0000092D 84D2                    		test    dl, dl
  2732 0000092F 7503                    		jne     short SetPortParm
  2733 00000931 8A5516                  		mov     dl, [di+TrackInfo.PortParm]
  2734                                  SetPortParm:
  2735 00000934 885516                  		mov     [di+TrackInfo.PortParm], dl
  2736 00000937 895512                  		mov     [di+TrackInfo.Effect], dx
  2737 0000093A C3                      		retn
  2738                                  InitVibrato:
  2739 0000093B 8A4518                  		mov     al, [di+TrackInfo.VibParm]
  2740 0000093E 88C4                    		mov     ah, al
  2741 00000940 240F                    		and     al, 0Fh
  2742 00000942 80E4F0                  		and     ah, 0F0h
  2743 00000945 F6C20F                  		test    dl, 0Fh
  2744 00000948 7502                    		jne     short OkDepth
  2745 0000094A 08C2                    		or      dl, al
  2746                                  OkDepth:
  2747 0000094C F6C2F0                  		test    dl, 0F0h
  2748 0000094F 7502                    		jne     short OkRate
  2749 00000951 08E2                    		or      dl, ah
  2750                                  OkRate:
  2751 00000953 885518                  		mov     [di+TrackInfo.VibParm], dl
  2752 00000956 895512                  		mov     [di+TrackInfo.Effect], dx
  2753 00000959 85C9                    		test    cx, cx
  2754 0000095B 7404                    		je      short OkPos
  2755 0000095D C6451700                		mov     byte [di+TrackInfo.VibPos], 0
  2756                                  OkPos:
  2757 00000961 C3                      		retn
  2758                                  SampleOfs:      
  2759 00000962 84D2                    		test    dl, dl
  2760 00000964 7503                    		jne     short SetSampleOfs
  2761 00000966 8A5519                  		mov     dl, [di+TrackInfo.OldSampOfs]
  2762                                  SetSampleOfs:
  2763 00000969 885519                  		mov     [di+TrackInfo.OldSampOfs], dl
  2764 0000096C 88D6                    		mov     dh, dl
  2765 0000096E 30D2                    		xor     dl, dl
  2766 00000970 895504                  		mov     [di+TrackInfo.Position], dx
  2767 00000973 C3                      		retn
  2768                                  PosJump:
  2769 00000974 8816[6EE7]              		mov     [OrderPos], dl
  2770 00000978 C606[72E7]40            		mov     byte [Row], 64
  2771 0000097D C3                      		retn
  2772                                  SetVolume:
  2773 0000097E 80FA40                  		cmp     dl, 64
  2774 00000981 7602                    		jbe     short OkVol
  2775 00000983 B240                    		mov     dl, 64
  2776                                  OkVol:
  2777 00000985 88550C                  		mov     [di+TrackInfo.Volume], dl
  2778 00000988 C3                      		retn
  2779                                  Break:
  2780 00000989 88D6                    		mov     dh, dl
  2781 0000098B 80E20F                  		and     dl, 0Fh
  2782 0000098E C0EE04                  		shr     dh, 4
  2783 00000991 00F6                    		add     dh, dh
  2784 00000993 00F2                    		add     dl, dh
  2785 00000995 C0E602                  		shl     dh, 2
  2786 00000998 00F2                    		add     dl, dh
  2787 0000099A 8816[73E7]              		mov     [BreakRow], dl
  2788 0000099E C606[72E7]40            		mov     byte [Row], 64
  2789 000009A3 C3                      		retn
  2790                                  SetSpeed:
  2791 000009A4 84D2                    		test    dl,dl
  2792 000009A6 7424                    		je      Skip
  2793 000009A8 80FA1F                  		cmp     dl,31
  2794 000009AB 7709                    		ja      short SetBpm
  2795                                  SetTempo:       
  2796 000009AD 8816[6FE7]              		mov     [Tempo], dl
  2797 000009B1 8816[70E7]              		mov     [TempoWait], dl
  2798 000009B5 C3                      		retn
  2799                                  SetBpm:
  2800 000009B6 8816[71E7]              		mov     [Bpm], dl
  2801 000009BA B067                    		mov     al, 103
  2802 000009BC F6E2                    		mul     dl
  2803 000009BE 88E3                    		mov     bl, ah
  2804 000009C0 30FF                    		xor     bh, bh
  2805 000009C2 A1[C08D]                		mov     ax, [MixSpeed]
  2806 000009C5 31D2                    		xor     dx, dx
  2807 000009C7 F7F3                    		div     bx
  2808 000009C9 A3[74E7]                		mov     [BpmSamples], ax
  2809                                  Skip:
  2810 000009CC C3                      		retn
  2811                                  InitArpeggio:
  2812 000009CD 88D6                    		mov     dh, dl
  2813 000009CF 80E20F                  		and     dl, 0Fh
  2814 000009D2 C0EE04                  		shr     dh, 4
  2815 000009D5 B92400                  		mov     cx, 36
  2816 000009D8 31DB                    		xor     bx, bx
  2817 000009DA 8B450E                  		mov     ax, [di+TrackInfo.Period]
  2818                                  gt_ScanPeriod:
  2819 000009DD 3B87[FC0E]              		cmp     ax, [PeriodTable+bx]
  2820 000009E1 7305                    		jae     short SetArp
  2821 000009E3 83C302                  		add     bx, 2
  2822 000009E6 E2F5                    		loop    gt_ScanPeriod
  2823                                  SetArp:         
  2824 000009E8 01D2                    		add     dx, dx
  2825 000009EA 00DE                    		add     dh, bl
  2826 000009EC 00DA                    		add     dl, bl
  2827 000009EE 8B9F[FC0E]              		mov     bx, [PeriodTable+bx]
  2828 000009F2 01DB                    		add     bx, bx
  2829 000009F4 8B87[BC8F]              		mov     ax, [PitchTable+bx]
  2830 000009F8 89451A                  		mov     [di+TrackInfo.Arp], ax
  2831 000009FB 88F3                    		mov     bl, dh
  2832 000009FD 30FF                    		xor     bh, bh
  2833 000009FF 8B9F[FC0E]              		mov     bx, [PeriodTable+bx]
  2834 00000A03 01DB                    		add     bx, bx
  2835 00000A05 8B87[BC8F]              		mov     ax, [PitchTable+bx]
  2836 00000A09 89451C                  		mov     [di+TrackInfo.Arp+2], ax
  2837 00000A0C 88D3                    		mov     bl, dl
  2838 00000A0E 30FF                    		xor     bh, bh
  2839 00000A10 8B9F[FC0E]              		mov     bx, [PeriodTable+bx]
  2840 00000A14 01DB                    		add     bx, bx
  2841 00000A16 8B87[BC8F]              		mov     ax, [PitchTable+bx]
  2842 00000A1A 89451E                  		mov     [di+TrackInfo.Arp+4], ax
  2843 00000A1D C745200000              		mov     word [di+TrackInfo.ArpIndex], 0
  2844 00000A22 C3                      		retn
  2845                                  
  2846                                  ;--------------------------------------------------------------------------
  2847                                  ; UpdateTracks:  Main code to process the next tick to be played.
  2848                                  ;--------------------------------------------------------------------------
  2849                                  
  2850                                  UpdateTracks:
  2851 00000A23 FE0E[70E7]              		dec     byte [TempoWait]
  2852 00000A27 740F                    		jz      short GetTracks
  2853                                  
  2854 00000A29 B90400                  		mov	cx, NumTracks
  2855 00000A2C BF[80E7]                		mov	di, Tracks
  2856                                  BeatTracks:
  2857 00000A2F E830FD                  		call	BeatTrack
  2858 00000A32 83C722                  		add	di, TrackInfo.size
  2859 00000A35 E2F8                    		loop	BeatTracks
  2860 00000A37 C3                      		retn
  2861                                  GetTracks:
  2862 00000A38 A0[6FE7]                		mov     al, [Tempo]
  2863 00000A3B A2[70E7]                		mov     [TempoWait], al
  2864                                  
  2865 00000A3E C436[7CE7]              		les     si, [Note]
  2866 00000A42 803E[72E7]40            		cmp     byte [Row], 64
  2867 00000A47 7246                    		jb      short NoPattWrap
  2868                                  
  2869 00000A49 C436[448E]              		les     si, [ModInfo.Patterns]
  2870 00000A4D 8A1E[6EE7]              		mov     bl, [OrderPos]
  2871 00000A51 3A1E[C28D]              		cmp     bl, [ModInfo.OrderLen]
  2872 00000A55 720E                    		jb      short NoOrderWrap
  2873 00000A57 8A1E[C38D]              		mov     bl, [ModInfo.ReStart]
  2874 00000A5B 881E[6EE7]              		mov     [OrderPos], bl
  2875 00000A5F 3A1E[C28D]              		cmp     bl, [ModInfo.OrderLen]
  2876 00000A63 7343                    		jae     short NoUpdate
  2877                                  NoOrderWrap:
  2878 00000A65 30FF                    		xor     bh, bh
  2879 00000A67 8A9F[C48D]              		mov     bl, [ModInfo.Order+bx]
  2880 00000A6B C1E30A                  		shl     bx, 10
  2881 00000A6E 01DE                    		add     si, bx
  2882 00000A70 8A1E[73E7]              		mov     bl, [BreakRow]
  2883 00000A74 881E[72E7]              		mov     [Row], bl
  2884 00000A78 30FF                    		xor     bh, bh
  2885 00000A7A 883E[73E7]              		mov     [BreakRow], bh
  2886 00000A7E C1E304                  		shl     bx, 4
  2887 00000A81 01DE                    		add     si, bx
  2888 00000A83 8936[7CE7]              		mov     [Note], si
  2889 00000A87 8C06[7EE7]              		mov     [Note+2], es
  2890 00000A8B FE06[6EE7]              		inc     byte [OrderPos]
  2891                                  NoPattWrap:
  2892 00000A8F FE06[72E7]              		inc     byte [Row]
  2893                                  
  2894 00000A93 FC                      		cld
  2895 00000A94 B90400                  		mov	cx, NumTracks
  2896 00000A97 BF[80E7]                		mov	di, Tracks
  2897                                  GetTracks_next:
  2898 00000A9A 51                      		push	cx
  2899 00000A9B E8F0FD                  		call	GetTrack
  2900 00000A9E 59                      		pop	cx
  2901 00000A9F 83C722                  		add	di, TrackInfo.size
  2902 00000AA2 E2F6                    		loop	GetTracks_next
  2903                                  
  2904 00000AA4 8936[7CE7]              		mov     [Note], si
  2905                                  NoUpdate:
  2906 00000AA8 C3                      		retn
  2907                                  
  2908                                  ;--------------------------------------------------------------------------
  2909                                  ; MixTrack:  Mixes one track into a CLEAN buffer.
  2910                                  ;  In:
  2911                                  ;   ds:si -  Track Info Address.
  2912                                  ;   ds:di -  Buffer Address.
  2913                                  ;    cx   -  Buffer Size.
  2914                                  ;--------------------------------------------------------------------------
  2915                                  
  2916                                  MixTrack:
  2917 00000AA9 837C0A02                		cmp     word [si+TrackInfo.RepLen], 2
  2918 00000AAD 7742                    		ja      short MixLooped
  2919                                  MixNonLooped:
  2920 00000AAF C414                    		les     dx, [si+TrackInfo.Samples]
  2921 00000AB1 8B5C04                  		mov     bx, [si+TrackInfo.Position]
  2922 00000AB4 8B6C06                  		mov     bp, [si+TrackInfo.Len]
  2923 00000AB7 52                      		push    dx
  2924 00000AB8 56                      		push    si
  2925 00000AB9 01D3                    		add     bx, dx
  2926 00000ABB 01D5                    		add     bp, dx
  2927 00000ABD 8B5410                  		mov     dx, [si+TrackInfo.Pitch]
  2928 00000AC0 8A440C                  		mov     al, [si+TrackInfo.Volume]
  2929 00000AC3 8A640D                  		mov     ah, [si+TrackInfo.Error]
  2930 00000AC6 89DE                    		mov     si, bx
  2931 00000AC8 88C7                    		mov     bh, al
  2932 00000ACA 88D0                    		mov     al, dl
  2933 00000ACC 88F2                    		mov     dl, dh
  2934 00000ACE 30F6                    		xor     dh, dh
  2935                                  nlMixSamp:
  2936 00000AD0 39EE                    		cmp     si, bp
  2937 00000AD2 7310                    		jae     short nlMixBye
  2938 00000AD4 268A1C                  		mov     bl, [es:si]
  2939 00000AD7 8A9F[6E96]              		mov     bl, [VolTable+bx]
  2940 00000ADB 001D                    		add     [di], bl
  2941 00000ADD 47                      		inc     di
  2942 00000ADE 00C4                    		add     ah, al
  2943 00000AE0 11D6                    		adc     si, dx
  2944 00000AE2 E2EC                    		loop    nlMixSamp
  2945                                  nlMixBye:
  2946 00000AE4 89F3                    		mov     bx, si
  2947 00000AE6 5E                      		pop     si
  2948 00000AE7 5A                      		pop     dx
  2949 00000AE8 29D3                    		sub     bx, dx
  2950 00000AEA 895C04                  		mov     [si+TrackInfo.Position], bx
  2951 00000AED 88640D                  		mov     [si+TrackInfo.Error], ah
  2952 00000AF0 C3                      		retn
  2953                                  MixLooped:
  2954 00000AF1 C414                    		les     dx, [si+TrackInfo.Samples]
  2955 00000AF3 8B5C04                  		mov     bx, [si+TrackInfo.Position]
  2956 00000AF6 8B6C0A                  		mov     bp, [si+TrackInfo.RepLen]
  2957 00000AF9 892E[7AE7]              		mov     [BufRep], bp
  2958 00000AFD 036C08                  		add     bp, [si+TrackInfo.Repeat]
  2959 00000B00 52                      		push    dx
  2960 00000B01 56                      		push    si
  2961 00000B02 01D3                    		add     bx, dx
  2962 00000B04 01D5                    		add     bp, dx
  2963 00000B06 8B5410                  		mov     dx, [si+TrackInfo.Pitch]
  2964 00000B09 8A440C                  		mov     al, [si+TrackInfo.Volume]
  2965 00000B0C 8A640D                  		mov     ah, [si+TrackInfo.Error]
  2966 00000B0F 89DE                    		mov     si, bx
  2967 00000B11 88C7                    		mov     bh, al
  2968 00000B13 88D0                    		mov     al, dl
  2969 00000B15 88F2                    		mov     dl, dh
  2970 00000B17 30F6                    		xor     dh, dh
  2971                                  lpMixSamp:
  2972 00000B19 39EE                    		cmp     si, bp
  2973 00000B1B 7204                    		jb      short lpMixNow
  2974 00000B1D 2B36[7AE7]              		sub     si, [BufRep]
  2975                                  lpMixNow:
  2976 00000B21 268A1C                  		mov     bl, [es:si]
  2977 00000B24 8A9F[6E96]              		mov     bl, [VolTable+bx]
  2978 00000B28 001D                    		add     [di], bl
  2979 00000B2A 47                      		inc     di
  2980 00000B2B 00C4                    		add     ah, al
  2981 00000B2D 11D6                    		adc     si, dx
  2982 00000B2F E2E8                    		loop    lpMixSamp
  2983                                  lpMixBye:
  2984 00000B31 89F3                    		mov     bx, si
  2985 00000B33 5E                      		pop     si
  2986 00000B34 5A                      		pop     dx
  2987 00000B35 29D3                    		sub     bx, dx
  2988 00000B37 895C04                  		mov     [si+TrackInfo.Position], bx
  2989 00000B3A 88640D                  		mov     [si+TrackInfo.Error], ah
  2990 00000B3D C3                      		retn
  2991                                  
  2992                                  GetSamples_ICH:
  2993                                  		; 11/05/2024
  2994                                  		; 18/02/2017
  2995                                  		; 8 bit mono samples 
  2996                                  		; must be converted to 16 bit, stereo samples (for ICH) !
  2997                                  		; (ICH AC97 Modification by Erdogan Tan)
  2998 00000B3E 8936[90EC]              		mov	[_si_], si ; DMA Buff Addr, [DMA_BUFFER1] or [DMA_BUFFER2]
  2999                                  		; 11/05/2024
  3000                                  		;mov	si, MOD_BUFFER
  3001                                  		;shr	cx, 2 ; mod buffer size = dma (half) buffer size / 4 (*)
  3002                                  
  3003                                  ;--------------------------------------------------------------------------
  3004                                  ; GetSamples:  Returns the next chunk of samples to be played.
  3005                                  ;  In:
  3006                                  ;    Buffer  - Buffer Address.
  3007                                  ;    Count   - Buffer Size.
  3008                                  ;--------------------------------------------------------------------------
  3009                                  
  3010                                  GetSamples:
  3011                                  		;ds:si = buffer address
  3012                                  		;cx = count
  3013                                  
  3014                                  		; 11/05/2024
  3015                                  		;
  3016                                  		;;[sp+6] = ds
  3017                                  		;;[sp+4] = si
  3018                                  		;;[sp+2] = count
  3019                                  		;
  3020                                  		;Count	equ 4
  3021                                  		;Buffer	equ 6 
  3022                                  		;
  3023                                  		;push	bp
  3024                                  		;mov	bp, sp
  3025                                  		;
  3026                                  		;push    es
  3027                                  		;;;push  ds
  3028                                  		;;;pusha
  3029                                  		;
  3030                                  		;cld
  3031                                  		;
  3032                                  		;les	di, [bp+Buffer]
  3033                                  		;mov    bx, [bp+Count]
  3034                                  
  3035                                  		; 11/05/2024
  3036                                  		; ds = cs
  3037 00000B42 06                      		push	es ; +
  3038                                  
  3039 00000B43 1E                      		push	ds
  3040 00000B44 07                      		pop	es
  3041                                  
  3042                                  		; 11/05/2024
  3043 00000B45 BF[92EC]                		mov	di, MOD_BUFFER
  3044 00000B48 BB000F                  		mov	bx, (BUFFERSIZE/4) ; (*) ; 2048
  3045                                  NextChunk:
  3046 00000B4B 833E[78E7]00            		cmp     word [BufLen], 0
  3047 00000B50 7534                    		jne     short CopyChunk
  3048                                  
  3049                                  		; 11/05/2024
  3050 00000B52 06                      		push	es
  3051 00000B53 53                      		push	bx
  3052 00000B54 57                      		push	di
  3053                                  MixChunk:
  3054                                  		;lea    di, [MixBuffer]
  3055 00000B55 BF[6ED7]                		mov	di, MixBuffer
  3056 00000B58 8B0E[74E7]              		mov     cx, [BpmSamples]
  3057 00000B5C 893E[76E7]              		mov     [BufPtr], di
  3058 00000B60 890E[78E7]              		mov     [BufLen], cx
  3059                                  
  3060                                  		; 12/05/2024
  3061                                  		; es = ds
  3062                                  		;mov    ax, ds
  3063                                  		;mov    es, ax
  3064                                  
  3065 00000B64 B080                    		mov    al, 80h
  3066 00000B66 F3AA                    		rep    stosb
  3067                                  
  3068 00000B68 B90400                  		mov	cx, NumTracks
  3069 00000B6B BE[5EE7]                		mov	si, Tracks - TrackInfo.size
  3070                                  GetSamples_next:
  3071 00000B6E 51                      		push	cx
  3072 00000B6F 83C622                  		add	si, TrackInfo.size
  3073 00000B72 8B0E[78E7]              		mov	cx, [BufLen]
  3074 00000B76 8B3E[76E7]              		mov	di, [BufPtr]
  3075 00000B7A E82CFF                  		call	MixTrack
  3076 00000B7D 59                      		pop	cx
  3077 00000B7E E2EE                    		loop	GetSamples_next
  3078                                  
  3079 00000B80 E8A0FE                  		call    UpdateTracks
  3080                                  
  3081 00000B83 5F                      		pop	di
  3082 00000B84 5B                      		pop	bx
  3083 00000B85 07                      		pop	es ; es = ds ; 12/05/2024
  3084                                  CopyChunk:
  3085 00000B86 8B0E[78E7]              		mov     cx, [BufLen]
  3086 00000B8A 39D9                    		cmp     cx, bx
  3087 00000B8C 7602                    		jbe     short MoveChunk
  3088 00000B8E 89D9                    		mov     cx, bx
  3089                                  MoveChunk:
  3090 00000B90 8B36[76E7]              		mov     si, [BufPtr]
  3091 00000B94 010E[76E7]              		add     [BufPtr], cx
  3092 00000B98 290E[78E7]              		sub     [BufLen], cx
  3093 00000B9C 29CB                    		sub     bx, cx
  3094 00000B9E F3A4                    		rep     movsb
  3095 00000BA0 85DB                    		test    bx, bx
  3096 00000BA2 75A7                    		jnz     short NextChunk
  3097                                  
  3098                                  		;;popa
  3099                                  		;;pop	ds
  3100                                  		;pop	es
  3101                                  		;pop	bp
  3102                                  		;ret	6
  3103                                  
  3104                                  ; GetSamples_ICH_convert_samples:
  3105                                  		; 11/05/2024
  3106                                  		; es = ds = cs
  3107                                  		; 18/02/2017
  3108                                  		;mov	di, ds
  3109                                  		;mov	es, di
  3110 00000BA4 8B3E[90EC]              		mov	di, [_si_] ; DMA Buffer Address (16 bit, stereo)
  3111 00000BA8 BE[91EC]                		mov	si, MOD_BUFFER - 1 ; buffer for 8 bit mono samples
  3112 00000BAB B9000F                  		mov	cx, (BUFFERSIZE/4) ; (*) ; 2048 ; 11/04/2024
  3113 00000BAE 30C0                    		xor	al, al
  3114                                  gscs_loop:		
  3115 00000BB0 46                      		inc	si
  3116 00000BB1 8A24                    		mov	ah, [si] ; convert 8 bit sample to 16 bit sample
  3117                                  		; 11/05/2024
  3118 00000BB3 80EC80                  		sub	ah, 80h
  3119                                  
  3120 00000BB6 AB                      		stosw	; left channel
  3121 00000BB7 AB                      		stosw	; right channel
  3122 00000BB8 E2F6                    		loop	gscs_loop
  3123                                  
  3124                                  		; 11/05/2024
  3125 00000BBA 07                      		pop	es ; +
  3126                                  		;pop	bp
  3127                                  		;ret	6
  3128 00000BBB C3                      		retn
  3129                                  
  3130                                  ;--------------------------------------------------------------------------
  3131                                  ; StartPlaying: Initializes the Sound System.
  3132                                  ;  In:
  3133                                  ;   Module Information Resources.
  3134                                  ;--------------------------------------------------------------------------
  3135                                  
  3136                                  StartPlaying:
  3137 00000BBC 60                      		pusha
  3138 00000BBD 1E                      		push    ds
  3139 00000BBE 06                      		push    es
  3140                                  SetModParms:    
  3141 00000BBF C606[6EE7]00            		mov     byte [OrderPos], 0
  3142 00000BC4 C606[6FE7]06            		mov     byte [Tempo], DefTempo
  3143 00000BC9 C606[70E7]06            		mov     byte [TempoWait], DefTempo
  3144 00000BCE C606[71E7]7D            		mov     byte [Bpm], DefBpm
  3145 00000BD3 C606[72E7]40            		mov     byte [Row], 64
  3146 00000BD8 C606[73E7]00            		mov     byte [BreakRow], 0
  3147 00000BDD A1[C08D]                		mov     ax, [MixSpeed]
  3148 00000BE0 31D2                    		xor     dx, dx
  3149 00000BE2 BB3200                  		mov     bx, 24*DefBpm/60
  3150 00000BE5 F7F3                    		div     bx
  3151 00000BE7 A3[74E7]                		mov     [BpmSamples], ax
  3152                                  ClearTracks:
  3153 00000BEA BF[80E7]                		mov     di, Tracks
  3154 00000BED 8CD8                    		mov     ax, ds
  3155 00000BEF 8EC0                    		mov     es, ax
  3156 00000BF1 B98800                  		mov     cx, NumTracks*TrackInfo.size
  3157 00000BF4 31C0                    		xor     ax, ax
  3158 00000BF6 FC                      		cld
  3159 00000BF7 F3AA                    		rep     stosb
  3160                                  
  3161 00000BF9 A3[76E7]                		mov     [BufPtr], ax
  3162 00000BFC A3[78E7]                		mov     [BufLen], ax
  3163                                  MakePitch:
  3164 00000BFF B80021                  		mov     ax, MidCRate
  3165 00000C02 BBAC01                  		mov     bx, 428
  3166 00000C05 F7E3                    		mul     bx
  3167 00000C07 F736[C08D]              		div     word [MixSpeed]
  3168 00000C0B 30F6                    		xor     dh, dh
  3169 00000C0D 88E2                    		mov     dl, ah
  3170 00000C0F 88C4                    		mov     ah, al
  3171 00000C11 30C0                    		xor     al, al
  3172 00000C13 B95903                  		mov     cx, 857
  3173 00000C16 31DB                    		xor     bx, bx
  3174 00000C18 BF[BC8F]                		mov     di, PitchTable
  3175                                  PitchLoop:
  3176 00000C1B 50                      		push    ax
  3177 00000C1C 52                      		push    dx
  3178 00000C1D 39DA                    		cmp     dx, bx
  3179 00000C1F 7302                    		jae     short NoDiv
  3180 00000C21 F7F3                    		div     bx
  3181                                  NoDiv:
  3182 00000C23 AB                      		stosw
  3183 00000C24 5A                      		pop     dx
  3184 00000C25 58                      		pop     ax
  3185 00000C26 43                      		inc     bx
  3186 00000C27 E2F2                    		loop    PitchLoop
  3187                                  MakeVolume:
  3188 00000C29 B90041                  		mov     cx, 16640
  3189 00000C2C 89CB                    		mov     bx, cx
  3190                                  VolLoop:
  3191 00000C2E 4B                      		dec     bx
  3192 00000C2F 88D8                    		mov     al, bl
  3193 00000C31 F6EF                    		imul    bh
  3194 00000C33 88A7[6E96]              		mov     [VolTable+bx], ah
  3195 00000C37 E2F5                    		loop    VolLoop
  3196                                  
  3197 00000C39 07                      		pop     es
  3198 00000C3A 1F                      		pop     ds
  3199 00000C3B 61                      		popa
  3200 00000C3C C3                      		retn	; 12/05/2024
  3201                                  
  3202                                  ;--------------------------------------------------------------------------
  3203                                  ; StopPlaying: ShutDown the Sound System.
  3204                                  ;--------------------------------------------------------------------------
  3205                                  
  3206                                  StopPlaying:
  3207                                  	; 08/05/2024
  3208                                  	; 04/11/2023
  3209                                  	; finished with song, stop everything
  3210 00000C3D E8CB01                  	call	ac97_stop
  3211                                  
  3212                                  	; 11/11/2023
  3213                                  irq_restore:	
  3214                                  	; restore previous interrupt vector and interrupt_status
  3215 00000C40 FA                      	cli
  3216 00000C41 E4A1                    	in	al, 0A1h ; irq 8-15
  3217 00000C43 A0[5D10]                	mov	al, [IRQ_status+1]
  3218 00000C46 E6A1                    	out	0A1h, al 
  3219 00000C48 E421                    	in	al, 021h ; irq 0-7
  3220 00000C4A A0[5C10]                	mov	al, [IRQ_status]
  3221 00000C4D E621                    	out	21h, al 
  3222                                  	; ...
  3223 00000C4F 06                      	push	es
  3224 00000C50 31C0                    	xor	ax, ax
  3225 00000C52 8EC0                    	mov	es, ax
  3226 00000C54 A1[5E10]                	mov	ax, [IRQ_vector]
  3227 00000C57 268907                  	mov	[es:bx], ax
  3228 00000C5A A1[6010]                	mov	ax, [IRQ_vector+2]
  3229 00000C5D 26894702                	mov	[es:bx+2], ax
  3230 00000C61 07                      	pop	es
  3231                                  
  3232 00000C62 FB                      	sti
  3233                                  
  3234 00000C63 C3                      	retn
  3235                                  
  3236                                  ;=============================================================================
  3237                                  ;               PLAYER.ASM
  3238                                  ;=============================================================================
  3239                                  
  3240                                  ; UTILS.ASM
  3241                                  ;----------------------------------------------------------------------------
  3242                                  ;       delay1_4ms - Delay for 1/4 millisecond.
  3243                                  ;		    1mS = 1000us
  3244                                  ;       Entry:
  3245                                  ;         None
  3246                                  ;       Exit:
  3247                                  ;	  None
  3248                                  ;
  3249                                  ;       Modified:
  3250                                  ;         None
  3251                                  ;
  3252                                  PORTB			EQU	061h
  3253                                    REFRESH_STATUS	EQU	010h		; Refresh signal status
  3254                                  
  3255                                  delay1_4ms:
  3256 00000C64 50                              push    ax 
  3257 00000C65 51                              push    cx
  3258 00000C66 B91000                          mov     cx, 16			; close enough.
  3259 00000C69 E461                    	in	al,PORTB
  3260 00000C6B 2410                    	and	al,REFRESH_STATUS
  3261 00000C6D 88C4                    	mov	ah,al			; Start toggle state
  3262 00000C6F 09C9                    	or	cx, cx
  3263 00000C71 7401                    	jz	short _d4ms1
  3264 00000C73 41                      	inc	cx			; Throwaway first toggle
  3265                                  _d4ms1:	
  3266 00000C74 E461                    	in	al,PORTB		; Read system control port
  3267 00000C76 2410                    	and	al,REFRESH_STATUS	; Refresh toggles 15.085 microseconds
  3268 00000C78 38C4                    	cmp	ah,al
  3269 00000C7A 74F8                    	je	short _d4ms1		; Wait for state change
  3270                                  
  3271 00000C7C 88C4                    	mov	ah,al			; Update with new state
  3272 00000C7E 49                      	dec	cx
  3273 00000C7F 75F3                    	jnz	short _d4ms1
  3274                                  
  3275 00000C81 59                              pop     cx
  3276 00000C82 58                              pop     ax
  3277 00000C83 C3                              retn
  3278                                  
  3279                                  print_msg:
  3280                                  	; 13/11/2016 - Erdogan Tan 
  3281                                  	; esi = ASCIIZ text address
  3282                                  	;
  3283 00000C84 BB0700                  	mov	bx, 7h
  3284 00000C87 B40E                    	mov	ah, 0Eh
  3285                                  pm_next_char:
  3286 00000C89 AC                      	lodsb
  3287 00000C8A 20C0                    	and	al, al
  3288 00000C8C 7404                    	jz	short pm_retn
  3289 00000C8E CD10                    	int	10h
  3290 00000C90 EBF7                    	jmp	short pm_next_char
  3291                                  pm_retn:
  3292 00000C92 C3                      	retn
  3293                                  
  3294                                  dword2str:
  3295                                  	; 13/11/2016 - Erdogan Tan
  3296                                  	; eax = dword value
  3297                                  	;
  3298 00000C93 E84400                  	call	dwordtohex
  3299 00000C96 668916[4610]            	mov	[dword_str], edx
  3300 00000C9B 66A3[4A10]              	mov	[dword_str+4], eax
  3301 00000C9F BE[4610]                	mov	si, dword_str
  3302 00000CA2 C3                      	retn
  3303                                  
  3304                                  	; trdos386.s (unix386.s) - 10/05/2015
  3305                                  	; Convert binary number to hexadecimal string
  3306                                  
  3307                                  bytetohex:
  3308                                  	; INPUT ->
  3309                                  	; 	AL = byte (binary number)
  3310                                  	; OUTPUT ->
  3311                                  	;	AX = hexadecimal string
  3312                                  	;
  3313 00000CA3 53                      	push	bx
  3314 00000CA4 30FF                    	xor	bh, bh
  3315 00000CA6 88C3                    	mov	bl, al
  3316 00000CA8 C0EB04                  	shr	bl, 4
  3317 00000CAB 8A9F[A80F]              	mov	bl, [bx+hex_chars]
  3318 00000CAF 86D8                    	xchg	bl, al
  3319 00000CB1 80E30F                  	and	bl, 0Fh
  3320 00000CB4 8AA7[A80F]              	mov	ah, [bx+hex_chars]
  3321 00000CB8 5B                      	pop	bx	
  3322 00000CB9 C3                      	retn
  3323                                  
  3324                                  wordtohex:
  3325                                  	; INPUT ->
  3326                                  	; 	AX = word (binary number)
  3327                                  	; OUTPUT ->
  3328                                  	;	EAX = hexadecimal string
  3329                                  	;
  3330 00000CBA 53                      	push	bx
  3331 00000CBB 30FF                    	xor	bh, bh
  3332 00000CBD 86E0                    	xchg	ah, al
  3333 00000CBF 50                      	push	ax
  3334 00000CC0 88E3                    	mov	bl, ah
  3335 00000CC2 C0EB04                  	shr	bl, 4
  3336 00000CC5 8A87[A80F]              	mov	al, [bx+hex_chars]
  3337 00000CC9 88E3                    	mov	bl, ah
  3338 00000CCB 80E30F                  	and	bl, 0Fh
  3339 00000CCE 8AA7[A80F]              	mov	ah, [bx+hex_chars]
  3340 00000CD2 66C1E010                	shl	eax, 16
  3341 00000CD6 58                      	pop	ax
  3342 00000CD7 5B                      	pop	bx
  3343 00000CD8 EBC9                    	jmp	short bytetohex
  3344                                  
  3345                                  dwordtohex:
  3346                                  	; INPUT ->
  3347                                  	; 	EAX = dword (binary number)
  3348                                  	; OUTPUT ->
  3349                                  	;	EDX:EAX = hexadecimal string
  3350                                  	;
  3351 00000CDA 6650                    	push	eax
  3352 00000CDC 66C1E810                	shr	eax, 16
  3353 00000CE0 E8D7FF                  	call	wordtohex
  3354 00000CE3 6689C2                  	mov	edx, eax
  3355 00000CE6 6658                    	pop	eax
  3356 00000CE8 E8CFFF                  	call	wordtohex
  3357 00000CEB C3                      	retn
  3358                                  
  3359                                  	; 13/11/2016 - Erdogan Tan
  3360                                  write_ac97_dev_info:
  3361                                  	; BUS/DEV/FN
  3362                                  	;	00000000BBBBBBBBDDDDDFFF00000000
  3363                                  	; DEV/VENDOR
  3364                                  	;	DDDDDDDDDDDDDDDDVVVVVVVVVVVVVVVV
  3365                                  
  3366 00000CEC 30FF                    	xor	bh, bh
  3367 00000CEE 668B36[6E10]            	mov	esi, [dev_vendor]
  3368 00000CF3 89F0                    	mov	ax, si
  3369 00000CF5 88C3                    	mov	bl, al
  3370 00000CF7 88DA                    	mov	dl, bl
  3371 00000CF9 80E30F                  	and	bl, 0Fh
  3372 00000CFC 8A87[A80F]              	mov	al, [bx+hex_chars]
  3373 00000D00 A2[EB0F]                	mov	[msgVendorId+3], al
  3374 00000D03 88D3                    	mov	bl, dl
  3375 00000D05 C0EB04                  	shr	bl, 4
  3376 00000D08 8A87[A80F]              	mov	al, [bx+hex_chars]
  3377 00000D0C A2[EA0F]                	mov	[msgVendorId+2], al
  3378 00000D0F 88E3                    	mov	bl, ah
  3379 00000D11 88DA                    	mov	dl, bl
  3380 00000D13 80E30F                  	and	bl, 0Fh
  3381 00000D16 8A87[A80F]              	mov	al, [bx+hex_chars]
  3382 00000D1A A2[E90F]                	mov	[msgVendorId+1], al
  3383 00000D1D 88D3                    	mov	bl, dl
  3384 00000D1F C0EB04                  	shr	bl, 4
  3385 00000D22 8A87[A80F]              	mov	al, [bx+hex_chars]
  3386 00000D26 A2[E80F]                	mov	[msgVendorId], al
  3387 00000D29 66C1EE10                	shr	esi, 16
  3388 00000D2D 89F0                    	mov	ax, si
  3389 00000D2F 88C3                    	mov	bl, al
  3390 00000D31 88DA                    	mov	dl, bl
  3391 00000D33 80E30F                  	and	bl, 0Fh
  3392 00000D36 8A87[A80F]              	mov	al, [bx+hex_chars]
  3393 00000D3A A2[FC0F]                	mov	[msgDevId+3], al
  3394 00000D3D 88D3                    	mov	bl, dl
  3395 00000D3F C0EB04                  	shr	bl, 4
  3396 00000D42 8A87[A80F]              	mov	al, [bx+hex_chars]
  3397 00000D46 A2[FB0F]                	mov	[msgDevId+2], al
  3398 00000D49 88E3                    	mov	bl, ah
  3399 00000D4B 88DA                    	mov	dl, bl
  3400 00000D4D 80E30F                  	and	bl, 0Fh
  3401 00000D50 8A87[A80F]              	mov	al, [bx+hex_chars]
  3402 00000D54 A2[FA0F]                	mov	[msgDevId+1], al
  3403 00000D57 88D3                    	mov	bl, dl
  3404 00000D59 C0EB04                  	shr	bl, 4
  3405 00000D5C 8A87[A80F]              	mov	al, [bx+hex_chars]
  3406 00000D60 A2[F90F]                	mov	[msgDevId], al
  3407                                  
  3408 00000D63 668B36[6A10]            	mov	esi, [bus_dev_fn]
  3409 00000D68 66C1EE08                	shr	esi, 8
  3410 00000D6C 89F0                    	mov	ax, si
  3411 00000D6E 88C3                    	mov	bl, al
  3412 00000D70 88DA                    	mov	dl, bl
  3413 00000D72 80E307                  	and	bl, 7 ; bit 0,1,2
  3414 00000D75 8A87[A80F]              	mov	al, [bx+hex_chars]
  3415 00000D79 A2[2010]                	mov	[msgFncNo+1], al
  3416 00000D7C 88D3                    	mov	bl, dl
  3417 00000D7E C0EB03                  	shr	bl, 3
  3418 00000D81 88DA                    	mov	dl, bl
  3419 00000D83 80E30F                  	and	bl, 0Fh
  3420 00000D86 8A87[A80F]              	mov	al, [bx+hex_chars]
  3421 00000D8A A2[1210]                	mov	[msgDevNo+1], al
  3422 00000D8D 88D3                    	mov	bl, dl
  3423 00000D8F C0EB04                  	shr	bl, 4
  3424 00000D92 8A87[A80F]              	mov	al, [bx+hex_chars]
  3425 00000D96 A2[1110]                	mov	[msgDevNo], al
  3426 00000D99 88E3                    	mov	bl, ah
  3427 00000D9B 88DA                    	mov	dl, bl
  3428 00000D9D 80E30F                  	and	bl, 0Fh
  3429 00000DA0 8A87[A80F]              	mov	al, [bx+hex_chars]
  3430 00000DA4 A2[0610]                	mov	[msgBusNo+1], al
  3431 00000DA7 88D3                    	mov	bl, dl
  3432 00000DA9 C0EB04                  	shr	bl, 4
  3433 00000DAC 8A87[A80F]              	mov	al, [bx+hex_chars]
  3434 00000DB0 A2[0510]                	mov	[msgBusNo], al
  3435                                  
  3436                                  	;mov	ax, [ac97_io_base]
  3437                                  	; 08/05/2024
  3438 00000DB3 A1[5610]                	mov	ax, [NABMBAR]
  3439 00000DB6 88C3                    	mov	bl, al
  3440 00000DB8 88DA                    	mov	dl, bl
  3441 00000DBA 80E30F                  	and	bl, 0Fh
  3442 00000DBD 8A87[A80F]              	mov	al, [bx+hex_chars]
  3443 00000DC1 A2[3910]                	mov	[msgIOBaseAddr+3], al
  3444 00000DC4 88D3                    	mov	bl, dl
  3445 00000DC6 C0EB04                  	shr	bl, 4
  3446 00000DC9 8A87[A80F]              	mov	al, [bx+hex_chars]
  3447 00000DCD A2[3810]                	mov	[msgIOBaseAddr+2], al
  3448 00000DD0 88E3                    	mov	bl, ah
  3449 00000DD2 88DA                    	mov	dl, bl
  3450 00000DD4 80E30F                  	and	bl, 0Fh
  3451 00000DD7 8A87[A80F]              	mov	al, [bx+hex_chars]
  3452 00000DDB A2[3710]                	mov	[msgIOBaseAddr+1], al
  3453 00000DDE 88D3                    	mov	bl, dl
  3454 00000DE0 C0EB04                  	shr	bl, 4
  3455 00000DE3 8A87[A80F]              	mov	al, [bx+hex_chars]
  3456 00000DE7 A2[3610]                	mov	[msgIOBaseAddr], al
  3457                                  
  3458                                  	; 24/11/2016
  3459 00000DEA 30E4                    	xor	ah, ah
  3460 00000DEC A0[6810]                	mov	al, [ac97_int_ln_reg]
  3461 00000DEF B10A                    	mov	cl, 10
  3462 00000DF1 F6F1                    	div	cl
  3463 00000DF3 0106[4110]              	add	[msgIRQ], ax
  3464 00000DF7 20C0                    	and	al, al
  3465 00000DF9 7508                    	jnz	short _pmi
  3466 00000DFB A0[4210]                	mov	al, [msgIRQ+1]
  3467 00000DFE B420                    	mov	ah, ' '
  3468 00000E00 A3[4110]                	mov	[msgIRQ], ax
  3469                                  _pmi:
  3470 00000E03 BA[B90F]                        mov	dx, msgAC97Info
  3471 00000E06 B409                            mov     ah, 9
  3472 00000E08 CD21                            int     21h
  3473 00000E0A C3                              retn
  3474                                  
  3475                                  	; 08/05/2024
  3476                                  ac97_stop:
  3477                                  	; 11/11/2023
  3478                                  	; 09/11/2023
  3479                                  	; 05/11/2023
  3480                                  	; 04/11/2023 
  3481                                  	; 28/05/2017 (TRDOS 386 v2, 'audio.s')
  3482                                  	;mov	byte [tLoop], 0 ; stop ! ; 05/11/2023
  3483                                  ;_ac97_stop:
  3484                                  
  3485                                  	; 11/11/2023
  3486 00000E0B 8B16[5410]              	mov	dx, [NAMBAR]
  3487                                  	;add	dx, 0 ; ac_reg_0 ; reset register
  3488 00000E0F EF                      	out	dx, ax
  3489                                  
  3490                                  	; 04/11/2023
  3491                                  	; 09/10/2017 (TRDOS 386 v2, 'audio.s')
  3492                                  	; 11/06/2017
  3493 00000E10 30C0                    	xor	al, al ; 0
  3494 00000E12 E80D00                  	call	ac97_po_cmd
  3495                                  
  3496                                  	; (Ref: KolibriOS, intelac97.asm, 'stop:')
  3497                                  	; Clear FIFOE, BCIS, LVBCI (Ref: Intel ICH hub manual)
  3498 00000E15 B81C00                  	mov     ax, 1Ch
  3499 00000E18 8B16[5610]              	mov     dx, [NABMBAR]
  3500 00000E1C 83C216                  	add     dx, PO_SR_REG
  3501 00000E1F EF                      	out     dx, ax
  3502                                  
  3503                                  	; 11/06/2017
  3504 00000E20 B002                    	mov     al, RR
  3505                                  ac97_po_cmd:
  3506                                  	; 11/06/2017
  3507                                  	; 29/05/2017
  3508 00000E22 8B16[5610]              	mov     dx, [NABMBAR]
  3509 00000E26 83C21B                          add     dx, PO_CR_REG		; PCM out control register
  3510 00000E29 EE                      	out	dx, al
  3511 00000E2A C3                      	retn
  3512                                  
  3513                                  ;=============================================================================
  3514                                  ;               preinitialized data
  3515                                  ;=============================================================================
  3516                                  
  3517                                  ;=============================================================================
  3518                                  ;               PLAY.ASM - DATA
  3519                                  ;=============================================================================
  3520                                  
  3521                                  msg_2017:
  3522 00000E2B 54696E79204D4F4420-     		db	'Tiny MOD Player by Erdogan Tan. May 2024.',10,13
  3522 00000E34 506C61796572206279-
  3522 00000E3D 204572646F67616E20-
  3522 00000E46 54616E2E204D617920-
  3522 00000E4F 323032342E0A0D     
  3523 00000E56 75736167653A20706C-     		db	'usage: playmod3 filename.mod', 10, 13, '$'
  3523 00000E5F 61796D6F6433206669-
  3523 00000E68 6C656E616D652E6D6F-
  3523 00000E71 640A0D24           
  3524 00000E75 31382F30322F323031-     		db	'18/02/2017',0
  3524 00000E7E 3700               
  3525 00000E80 31382F30352F323032-     		db	'18/05/2024',0
  3525 00000E89 3400               
  3526                                  
  3527 00000E8B 54696E79204D4F4420-     Credits:	db	'Tiny MOD Player v0.1b by Carlos Hasan. July 1993.'
  3527 00000E94 506C61796572207630-
  3527 00000E9D 2E3162206279204361-
  3527 00000EA6 726C6F732048617361-
  3527 00000EAF 6E2E204A756C792031-
  3527 00000EB8 3939332E           
  3528                                  CRLF:		; 13/05/2024
  3529 00000EBC 0A0D24                  		db	10,13,'$'
  3530 00000EBF 4572726F72206C6F61-     ErrorMesg:	db	'Error loading Module file.',10,13,'$'
  3530 00000EC8 64696E67204D6F6475-
  3530 00000ED1 6C652066696C652E0A-
  3530 00000EDA 0D24               
  3531                                  
  3532                                  ;=============================================================================
  3533                                  ;               MODPLAY.ASM - DATA
  3534                                  ;=============================================================================
  3535                                  
  3536                                  ;Credits:	db	'Amiga Module Player v0.3b by Carlos Hasan.'
  3537                                  
  3538 00000EDC 0019324A62788EA2B4-     SinTable:	db	0,25,50,74,98,120,142,162,180,197,212,225
  3538 00000EE5 C5D4E1             
  3539 00000EE8 ECF4FAFEFFFEFAF4EC-     		db	236,244,250,254,255,254,250,244,236,225
  3539 00000EF1 E1                 
  3540 00000EF2 D4C5B4A28E78624A32-     		db	212,197,180,162,142,120,98,74,50,25
  3540 00000EFB 19                 
  3541                                  
  3542 00000EFC 58032803FA02D002A6-     PeriodTable:	dw	856,808,762,720,678,640,604,570,538,508,480,453
  3542 00000F05 0280025C023A021A02-
  3542 00000F0E FC01E001C501       
  3543 00000F14 AC0194017D01680153-     		dw	428,404,381,360,339,320,302,285,269,254,240,226
  3543 00000F1D 0140012E011D010D01-
  3543 00000F26 FE00F000E200       
  3544 00000F2C D600CA00BE00B400AA-     		dw	214,202,190,180,170,160,151,143,135,127,120,113
  3544 00000F35 00A00097008F008700-
  3544 00000F3E 7F0078007100       
  3545                                  
  3546                                  ;=============================================================================
  3547                                  ;               PLAYWAV.ASM / PLAYER.ASM - DATA
  3548                                  ;=============================================================================
  3549                                  
  3550                                  ; 24/11/2016
  3551                                  ;	       IRQ  0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15 
  3552 00000F44 08090A0B0C0D0E0F70-     irq_int:	db 08h,09h,0Ah,0Bh,0Ch,0Dh,0Eh,0Fh,70h,71h,72h,73h,74h,75h,76h,77h
  3552 00000F4D 71727374757677     
  3553                                  
  3554                                  ; 17/02/2017
  3555                                  ; Valid ICH device IDs
  3556                                  
  3557                                  valid_ids:
  3558 00000F54 86801524                dd	(ICH_DID << 16) + INTEL_VID  	 ; 8086h:2415h
  3559 00000F58 86802524                dd	(ICH0_DID << 16) + INTEL_VID 	 ; 8086h:2425h
  3560 00000F5C 86804524                dd	(ICH2_DID << 16) + INTEL_VID 	 ; 8086h:2445h
  3561 00000F60 86808524                dd	(ICH3_DID << 16) + INTEL_VID 	 ; 8086h:2485h
  3562 00000F64 8680C524                dd	(ICH4_DID << 16) + INTEL_VID 	 ; 8086h:24C5h
  3563 00000F68 8680D524                dd	(ICH5_DID << 16) + INTEL_VID 	 ; 8086h:24D5h
  3564 00000F6C 86806E26                dd	(ICH6_DID << 16) + INTEL_VID 	 ; 8086h:266Eh
  3565 00000F70 8680A625                dd	(ESB6300_DID << 16) + INTEL_VID  ; 8086h:25A6h
  3566 00000F74 86809826                dd	(ESB631X_DID << 16) + INTEL_VID  ; 8086h:2698h
  3567 00000F78 8680DE27                dd	(ICH7_DID << 16) + INTEL_VID 	 ; 8086h:27DEh
  3568                                  ; 03/11/2023 - Erdogan Tan
  3569 00000F7C 86809571                dd	(MX82440_DID << 16) + INTEL_VID  ; 8086h:7195h
  3570 00000F80 39101270                dd	(SI7012_DID << 16)  + SIS_VID	 ; 1039h:7012h
  3571 00000F84 DE10B101                dd 	(NFORCE_DID << 16)  + NVIDIA_VID ; 10DEh:01B1h
  3572 00000F88 DE106A00                dd 	(NFORCE2_DID << 16) + NVIDIA_VID ; 10DEh:006Ah
  3573 00000F8C 22106D74                dd 	(AMD8111_DID << 16) + AMD_VID 	 ; 1022h:746Dh
  3574 00000F90 22104574                dd 	(AMD768_DID << 16)  + AMD_VID 	 ; 1022h:7445h
  3575 00000F94 DE105900                dd 	(CK804_DID << 16) + NVIDIA_VID	 ; 10DEh:0059h
  3576 00000F98 DE103A00                dd 	(MCP04_DID << 16) + NVIDIA_VID	 ; 10DEh:003Ah
  3577 00000F9C DE108A00                dd 	(CK8_DID << 16) + NVIDIA_VID	 ; 1022h:008Ah
  3578 00000FA0 DE10DA00                dd 	(NFORCE3_DID << 16) + NVIDIA_VID ; 10DEh:00DAh
  3579 00000FA4 DE10EA00                dd 	(CK8S_DID << 16) + NVIDIA_VID	 ; 10DEh:00EAh
  3580                                  
  3581                                  valid_id_count:	equ ($ - valid_ids)>>2 ; 05/11/2023
  3582                                  
  3583                                  ; 13/11/2016
  3584 00000FA8 303132333435363738-     hex_chars	db "0123456789ABCDEF", 0
  3584 00000FB1 3941424344454600   
  3585 00000FB9 414339372041756469-     msgAC97Info	db "AC97 Audio Controller & Codec Info", 0Dh, 0Ah 
  3585 00000FC2 6F20436F6E74726F6C-
  3585 00000FCB 6C6572202620436F64-
  3585 00000FD4 656320496E666F0D0A 
  3586 00000FDD 56656E646F72204944-     		db "Vendor ID: "
  3586 00000FE6 3A20               
  3587 00000FE8 303030306820446576-     msgVendorId	db "0000h Device ID: "
  3587 00000FF1 6963652049443A20   
  3588 00000FF9 30303030680D0A          msgDevId	db "0000h", 0Dh, 0Ah
  3589 00001000 4275733A20              		db "Bus: "
  3590 00001005 303068204465766963-     msgBusNo	db "00h Device: "
  3590 0000100E 653A20             
  3591 00001011 3030682046756E6374-     msgDevNo	db "00h Function: "
  3591 0000101A 696F6E3A20         
  3592 0000101F 303068                  msgFncNo	db "00h"
  3593 00001022 0D0A                    		db 0Dh, 0Ah
  3594 00001024 492F4F204261736520-     		db "I/O Base Address: "
  3594 0000102D 416464726573733A20 
  3595 00001036 303030306820495251-     msgIOBaseAddr	db "0000h IRQ: "
  3595 0000103F 3A20               
  3596 00001041 3030                    msgIRQ		dw 3030h
  3597 00001043 0D0A24                  		db 0Dh, 0Ah, "$"
  3598                                  
  3599                                  ;msgSampleRate	db "Sample Rate: "
  3600                                  ;msgHertz	db "00000 Hz ", "$" 
  3601                                  ;msg8Bits	db "8 bits ", "$" 
  3602                                  ;msgMono	db "Mono", 0Dh, 0Ah, "$"
  3603                                  ;msg16Bits	db "16 bits ", "$" 
  3604                                  ;msgStereo	db "Stereo", 0Dh, 0Ah, "$"
  3605                                  
  3606                                  ;; 13/11/2016 - Erdogan Tan (Ref: KolibriOS, codec.inc)
  3607                                  ;codec_id	dd 0
  3608                                  ;codec_chip_id	dd 0
  3609                                  ;codec_vendor_ids dw 0
  3610                                  ;codec_chip_ids	dw 0
  3611                                  
  3612 00001046 3030303030303030        dword_str	 dd 30303030h, 30303030h
  3613 0000104E 680D0A00                		 db 'h', 0Dh, 0Ah, 0
  3614                                  
  3615                                  ;=============================================================================
  3616                                  ;        	uninitialized data
  3617                                  ;=============================================================================
  3618                                  
  3619                                  bss_start:
  3620                                  
  3621                                  ABSOLUTE bss_start
  3622                                  
  3623 00001052 ????                    alignb 4
  3624                                  
  3625                                  ; 17/02/2017
  3626                                  ; NAMBAR:  Native Audio Mixer Base Address Register
  3627                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 10h-13h
  3628                                  ; NABMBAR: Native Audio Bus Mastering Base Address register
  3629                                  ;    (ICH, Audio D31:F5, PCI Config Space) Address offset: 14h-17h
  3630 00001054 ????                    NAMBAR:		resw 1			; BAR for mixer
  3631 00001056 ????                    NABMBAR         resw 1			; BAR for bus master regs
  3632                                  
  3633 00001058 ??                      tBuff:		resb	1
  3634                                  ;irq_status:	resb 	1
  3635 00001059 ??                      pcm_irq_status:	resb	1 ; 08/05/2024
  3636                                  
  3637 0000105A ??                      inside:		resb	1
  3638 0000105B ??                      tLoop:		resb 	1
  3639                                  
  3640                                  ; 08/05/2024
  3641 0000105C ????                    IRQ_status:	resw 1	; IRQ status before enabling audio interrupt
  3642 0000105E ????????                IRQ_vector:	resd 1  ; Previous interrupt handler address
  3643                                  
  3644                                  ; 256 byte buffer for descriptor list
  3645 00001062 ????                    BDL_BUFFER:	resw	1		; segment of our 256byte BDL buffer
  3646 00001064 ????                    DMA_BUFFER1:	resw 	1		; Pointer to 1st half of DMA Buffer
  3647 00001066 ????                    DMA_BUFFER2:	resw	1		; Pointer to 1st half of DMA Buffer
  3648                                  
  3649                                  ; 12/11/2016 - Erdogan Tan
  3650                                  
  3651 00001068 ??                      ac97_int_ln_reg: resb 1
  3652 00001069 ??                      err_num:	resb 1
  3653                                  
  3654 0000106A ????????                bus_dev_fn:	resd 1
  3655 0000106E ????????                dev_vendor:	resd 1
  3656                                  ; 08/05/2024
  3657                                  ;stats_cmd:	resd 1
  3658                                  ;ac97_io_base:	resw 1
  3659 00001072 ??                      LVI:		resb 1
  3660                                  ; 12/05/2024
  3661 00001073 ??                      volume:		resb 1
  3662                                  
  3663                                  ;alignb 4
  3664                                  ; 13/05/2024
  3665 00001074 <res Ch>                alignb 16
  3666                                  
  3667 00001080 <res 100h>              BdlBuffer:	resb	BDL_SIZE ; 13/02/2017
  3668 00001180 <res 7800h>             DmaBuffer:	resb	2*BUFFERSIZE ; 13/02/2017
  3669                                  
  3670                                  ; MODLOAD.ASM
  3671 00008980 ????                    FileHandle:	resw	1
  3672 00008982 ????                    ErrorInfo:	resw	1
  3673 00008984 <res 43Ch>              Header:		resb	ModHeader.size
  3674                                  
  3675                                  sample_rate: ; PLAYER.ASM (22050Hz)
  3676                                  ; MODPLAY.ASM
  3677 00008DC0 ????                    MixSpeed:	resw 1
  3678                                  
  3679                                  ModInfo:
  3680 00008DC2 ??                      ModInfo.OrderLen:   resb 1
  3681 00008DC3 ??                      ModInfo.ReStart:    resb 1
  3682 00008DC4 <res 80h>               ModInfo.Order:	    resb 128
  3683 00008E44 ????????                ModInfo.Patterns:   resd 1
  3684                                  
  3685 00008E48 <res 3Eh>               ModInfo.SampOfs:    resw 31
  3686 00008E86 <res 3Eh>               ModInfo.SampSeg:    resw 31
  3687 00008EC4 <res 3Eh>               ModInfo.SampLen:    resw 31
  3688 00008F02 <res 3Eh>               ModInfo.SampRep:    resw 31
  3689 00008F40 <res 3Eh>               ModInfo.SampRepLen: resw 31
  3690 00008F7E <res 3Eh>               ModInfo.SampVol:    resw 31
  3691                                  
  3692                                  ; MODPLAY.ASM
  3693 00008FBC <res 6B2h>              PitchTable:	resw	857
  3694 0000966E <res 4100h>             VolTable:	resb	16640
  3695 0000D76E <res 1000h>             MixBuffer       resb	MixBufSize
  3696                                  
  3697                                  ; MODPLAY.ASM
  3698 0000E76E ??                      OrderPos:	resb 1
  3699 0000E76F ??                      Tempo:		resb 1
  3700 0000E770 ??                      TempoWait:	resb 1
  3701 0000E771 ??                      Bpm:		resb 1
  3702 0000E772 ??                      Row:		resb 1
  3703 0000E773 ??                      BreakRow:	resb 1
  3704 0000E774 ????                    BpmSamples:	resw 1
  3705 0000E776 ????                    BufPtr:		resw 1
  3706 0000E778 ????                    BufLen:		resw 1
  3707 0000E77A ????                    BufRep:		resw 1
  3708 0000E77C ????????                Note:		resd 1
  3709 0000E780 <res 88h>               Tracks:		resb TrackInfo.size*NumTracks
  3710                                  
  3711 0000E808 ????????????????        alignb 16
  3712                                  
  3713                                  ; PLAY.ASM
  3714 0000E810 <res 280h>              Scope:		resw	320
  3715 0000EA90 <res 200h>              RowOfs:		resw	256
  3716                                  
  3717                                  ; 18/02/2017
  3718 0000EC90 ????                    _si_:		resw 1
  3719 0000EC92 <res F00h>              MOD_BUFFER:	resb BUFFERSIZE/4 ; 2048 ; 11/05/2024
  3720                                  EOF:
