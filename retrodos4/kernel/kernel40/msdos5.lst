DOSCODE:3DD0 ;
DOSCODE:3DD0 ; +-------------------------------------------------------------------------+
DOSCODE:3DD0 ; |   This file has been generated by The Interactive Disassembler (IDA)    |
DOSCODE:3DD0 ; |           Copyright (c) 2013 Hex-Rays, <support@hex-rays.com>           |
DOSCODE:3DD0 ; |                      Licensed to: Freeware version                      |
DOSCODE:3DD0 ; +-------------------------------------------------------------------------+
DOSCODE:3DD0 ;
DOSCODE:3DD0 ; Input MD5   : 926BAF897B78FE053F29FC8FF8CFD7C5
DOSCODE:3DD0 ; Input CRC32 : 64D3C385
DOSCODE:3DD0
DOSCODE:3DD0 ; ---------------------------------------------------------------------------
DOSCODE:3DD0 ; File Name   : C:\Users\Erdoðan\Desktop\MSDOS5.SYS
DOSCODE:3DD0 ; Format	   : Binary file
DOSCODE:3DD0 ; Base Address: 0000h Range: 0000h	- 9212h	Loaded length: 9212h
DOSCODE:3DD0
DOSCODE:3DD0		     .386
DOSCODE:3DD0		     .model flat
DOSCODE:3DD0
DOSCODE:3DD0 ; ===========================================================================
DOSCODE:3DD0
DOSCODE:3DD0 ; Segment type: Pure code
DOSCODE:3DD0 DOSCODE	     segment byte public 'CODE' use16
DOSCODE:3DD0		     assume cs:DOSCODE
DOSCODE:3DD0		     ;org 3DD0h
DOSCODE:3DD0		     assume es:nothing,	ss:nothing, ds:nothing,	fs:nothing, gs:nothing
DOSCODE:3DD0
DOSCODE:3DD0 _$STARTCODE:			     ; ...
DOSCODE:3DD0		     jmp     DOSINIT
DOSCODE:3DD0 ; ---------------------------------------------------------------------------
DOSCODE:3DD3		     dw	offset _$STARTCODE   ; PARASTART
DOSCODE:3DD5 BioDataSeg	     dw	70h
DOSCODE:3DD7 DosDSeg	     dw	0		     ; ...
DOSCODE:3DD9 MSMAJOR	     db	5		     ; MAJOR_VERSION
DOSCODE:3DDA MSMINOR	     db	0		     ; MINOR_VERSION
DOSCODE:3DDB I21_MAP_E_TAB   db	38h, 2,	1, 2	     ; ...
DOSCODE:3DDF		     db	39h, 3,	3, 2, 5
DOSCODE:3DE4		     db	3Ah, 4,	10h, 3,	2, 5
DOSCODE:3DEA		     db	3Bh, 2,	2, 3
DOSCODE:3DEE		     db	3Ch, 4,	3, 2, 4, 5
DOSCODE:3DF4		     db	3Dh, 6,	3, 2, 0Ch, 4, 1Ah, 5
DOSCODE:3DFC		     db	3Eh, 1,	6
DOSCODE:3DFF		     db	3Fh, 2,	6, 5
DOSCODE:3E03		     db	40h, 2,	6, 5
DOSCODE:3E07		     db	41h, 3,	3, 2, 5
DOSCODE:3E0C		     db	42h, 2,	6, 1
DOSCODE:3E10		     db	43h, 4,	3, 2, 1, 5
DOSCODE:3E16		     db	44h, 5,	0Fh, 0Dh, 1, 6,	5
DOSCODE:3E1D		     db	45h, 2,	6, 4
DOSCODE:3E21		     db	46h, 2,	6, 4
DOSCODE:3E25		     db	47h, 2,	1Ah, 0Fh
DOSCODE:3E29		     db	48h, 2,	7, 8
DOSCODE:3E2D		     db	49h, 2,	7, 9
DOSCODE:3E31		     db	4Ah, 3,	7, 9, 8
DOSCODE:3E36		     db	4Bh, 8,	3, 1, 2, 4, 0Bh, 0Ah, 8, 5
DOSCODE:3E40		     db	4Eh, 3,	3, 2, 12h
DOSCODE:3E45		     db	4Fh, 1,	12h
DOSCODE:3E48		     db	56h, 5,	11h, 3,	2, 10h,	5
DOSCODE:3E4F		     db	57h, 4,	6, 8, 0Dh, 1
DOSCODE:3E55		     db	58h, 1,	1
DOSCODE:3E58		     db	5Ah, 4,	3, 2, 4, 5
DOSCODE:3E5E		     db	5Bh, 5,	50h, 3,	2, 4, 5
DOSCODE:3E65		     db	5Ch, 4,	6, 1, 24h, 21h
DOSCODE:3E6B		     db	65h, 2,	1, 2
DOSCODE:3E6F		     db	66h, 2,	1, 2
DOSCODE:3E73		     db	68h, 1,	6
DOSCODE:3E76		     db	67h, 3,	4, 8, 1
DOSCODE:3E7B		     db	6Ch, 0Ah, 3, 2,	0Ch, 4,	50h, 8,	1Ah, 0Dh, 1, 5
DOSCODE:3E87		     db	69h, 4,	0Fh, 0Dh, 1, 5,	0FFh
DOSCODE:3E8E DISPATCH	     dw	offset $ABORT	     ; ...
DOSCODE:3E90		     dw	offset $STD_CON_INPUT
DOSCODE:3E92		     dw	offset $STD_CON_OUTPUT
DOSCODE:3E94		     dw	offset $STD_AUX_INPUT
DOSCODE:3E96		     dw	offset $STD_AUX_OUTPUT
DOSCODE:3E98		     dw	offset $STD_PRINTER_OUTPUT
DOSCODE:3E9A		     dw	offset $RAW_CON_IO
DOSCODE:3E9C		     dw	offset $RAW_CON_INPUT
DOSCODE:3E9E		     dw	offset $STD_CON_INPUT_NO_ECHO
DOSCODE:3EA0		     dw	offset $STD_CON_STRING_OUTPUT
DOSCODE:3EA2		     dw	offset $STD_CON_STRING_INPUT
DOSCODE:3EA4		     dw	offset $STD_CON_INPUT_STATUS
DOSCODE:3EA6		     dw	offset $STD_CON_INPUT_FLUSH
DOSCODE:3EA8		     dw	offset $DISK_RESET
DOSCODE:3EAA		     dw	offset $SET_DEFAULT_DRIVE
DOSCODE:3EAC		     dw	offset $FCB_OPEN
DOSCODE:3EAE		     dw	offset $FCB_CLOSE
DOSCODE:3EB0		     dw	offset $DIR_SEARCH_FIRST
DOSCODE:3EB2		     dw	offset $DIR_SEARCH_NEXT
DOSCODE:3EB4		     dw	offset $FCB_DELETE
DOSCODE:3EB6		     dw	offset $FCB_SEQ_READ
DOSCODE:3EB8		     dw	offset $FCB_SEQ_WRITE
DOSCODE:3EBA		     dw	offset $FCB_CREATE
DOSCODE:3EBC		     dw	offset $FCB_RENAME
DOSCODE:3EBE		     dw	offset NO_OP
DOSCODE:3EC0		     dw	offset $GET_DEFAULT_DRIVE
DOSCODE:3EC2		     dw	offset $SET_DMA
DOSCODE:3EC4		     dw	offset $SLEAZEFUNC
DOSCODE:3EC6		     dw	offset $SLEAZEFUNCDL
DOSCODE:3EC8		     dw	offset NO_OP
DOSCODE:3ECA		     dw	offset NO_OP
DOSCODE:3ECC		     dw	offset $GET_DEFAULT_DPB
DOSCODE:3ECE		     dw	offset NO_OP
DOSCODE:3ED0		     dw	offset $FCB_RANDOM_READ
DOSCODE:3ED2		     dw	offset $FCB_RANDOM_WRITE
DOSCODE:3ED4		     dw	offset $GET_FCB_FILE_LENGTH
DOSCODE:3ED6		     dw	offset $GET_FCB_POSITION
DOSCODE:3ED8		     dw	offset $SET_INTERRUPT_VECTOR
DOSCODE:3EDA		     dw	offset $CREATE_PROCESS_DATA_BLOCK
DOSCODE:3EDC		     dw	offset $FCB_RANDOM_READ_BLOCK
DOSCODE:3EDE		     dw	offset $FCB_RANDOM_WRITE_BLOCK
DOSCODE:3EE0		     dw	offset $PARSE_FILE_DESCRIPTOR
DOSCODE:3EE2		     dw	offset $GET_DATE
DOSCODE:3EE4		     dw	offset $SET_DATE
DOSCODE:3EE6		     dw	offset $GET_TIME
DOSCODE:3EE8		     dw	offset $SET_TIME
DOSCODE:3EEA		     dw	offset $SET_VERIFY_ON_WRITE
DOSCODE:3EEC		     dw	offset $GET_DMA
DOSCODE:3EEE		     dw	offset $GET_VERSION
DOSCODE:3EF0		     dw	offset $KEEP_PROCESS
DOSCODE:3EF2		     dw	offset $GET_DPB
DOSCODE:3EF4		     dw	offset $SET_CTRL_C_TRAPPING
DOSCODE:3EF6		     dw	offset $GET_INDOS_FLAG
DOSCODE:3EF8		     dw	offset $GET_INTERRUPT_VECTOR
DOSCODE:3EFA		     dw	offset $GET_DRIVE_FREESPACE
DOSCODE:3EFC		     dw	offset $CHAR_OPER
DOSCODE:3EFE		     dw	offset $INTERNATIONAL
DOSCODE:3F00		     dw	offset $MKDIR
DOSCODE:3F02		     dw	offset $RMDIR
DOSCODE:3F04		     dw	offset $CHDIR
DOSCODE:3F06		     dw	offset $CREAT
DOSCODE:3F08		     dw	offset $OPEN
DOSCODE:3F0A		     dw	offset $CLOSE
DOSCODE:3F0C		     dw	offset $READ
DOSCODE:3F0E		     dw	offset $WRITE
DOSCODE:3F10		     dw	offset $UNLINK
DOSCODE:3F12		     dw	offset $LSEEK
DOSCODE:3F14		     dw	offset $CHMOD
DOSCODE:3F16		     dw	offset $IOCTL
DOSCODE:3F18		     dw	offset $DUP
DOSCODE:3F1A		     dw	offset $DUP2
DOSCODE:3F1C		     dw	offset $CURRENT_DIR
DOSCODE:3F1E		     dw	offset $ALLOC
DOSCODE:3F20		     dw	offset $DEALLOC
DOSCODE:3F22		     dw	offset $SETBLOCK
DOSCODE:3F24		     dw	offset $EXEC
DOSCODE:3F26		     dw	offset $EXIT
DOSCODE:3F28		     dw	offset $WAIT
DOSCODE:3F2A		     dw	offset $FIND_FIRST
DOSCODE:3F2C		     dw	offset $FIND_NEXT
DOSCODE:3F2E		     dw	offset $SET_CURRENT_PDB
DOSCODE:3F30		     dw	offset $GET_CURRENT_PDB
DOSCODE:3F32		     dw	offset $GET_IN_VARS
DOSCODE:3F34		     dw	offset $SETDPB
DOSCODE:3F36		     dw	offset $GET_VERIFY_ON_WRITE
DOSCODE:3F38		     dw	offset $DUP_PDB
DOSCODE:3F3A		     dw	offset $RENAME
DOSCODE:3F3C		     dw	offset $FILE_TIMES
DOSCODE:3F3E		     dw	offset $ALLOCOPER
DOSCODE:3F40		     dw	offset $GetExtendedError
DOSCODE:3F42		     dw	offset $CreateTempFile
DOSCODE:3F44		     dw	offset $CreateNewFile
DOSCODE:3F46		     dw	offset $LockOper
DOSCODE:3F48		     dw	offset $ServerCall
DOSCODE:3F4A		     dw	offset $UserOper
DOSCODE:3F4C		     dw	offset $AssignOper
DOSCODE:3F4E		     dw	offset $NameTrans
DOSCODE:3F50		     dw	offset NO_OP
DOSCODE:3F52		     dw	offset $GET_CURRENT_PDB
DOSCODE:3F54		     dw	offset $ECS_Call
DOSCODE:3F56		     dw	offset $SET_PRINTER_FLAG
DOSCODE:3F58		     dw	offset $GetExtCntry
DOSCODE:3F5A		     dw	offset $GetSetCdPg
DOSCODE:3F5C		     dw	offset $ExtHandle
DOSCODE:3F5E		     dw	offset $COMMIT
DOSCODE:3F60		     dw	offset $GSetMediaID
DOSCODE:3F62		     dw	offset $COMMIT
DOSCODE:3F64		     dw	offset NO_OP
DOSCODE:3F66		     dw	offset $Extended_Open
DOSCODE:3F68 FOO	     dw	offset Leave2F	     ; ...
DOSCODE:3F6A Dtab	     dw	offset DOSTable	     ; ...
DOSCODE:3F6C DOSTable	     db	48		     ; ...
DOSCODE:3F6D		     dw	offset DOSInstall
DOSCODE:3F6F		     dw	offset DOS_CLOSE
DOSCODE:3F71		     dw	offset RECSET
DOSCODE:3F73		     dw	offset DOSGetGroup
DOSCODE:3F75		     dw	offset PATHCHRCMP
DOSCODE:3F77		     dw	offset OUTT
DOSCODE:3F79		     dw	offset NET_I24_ENTRY
DOSCODE:3F7B		     dw	offset PLACEBUF
DOSCODE:3F7D		     dw	offset FREE_SFT
DOSCODE:3F7F		     dw	offset BUFWRITE
DOSCODE:3F81		     dw	offset SHARE_VIOLATION
DOSCODE:3F83		     dw	offset SHARE_ERROR
DOSCODE:3F85		     dw	offset SET_SFT_MODE
DOSCODE:3F87		     dw	offset DATE16
DOSCODE:3F89		     dw	offset Idle
DOSCODE:3F8B		     dw	offset SCANPLACE
DOSCODE:3F8D		     dw	offset Idle
DOSCODE:3F8F		     dw	offset StrCpy
DOSCODE:3F91		     dw	offset StrLen
DOSCODE:3F93		     dw	offset UCase
DOSCODE:3F95		     dw	offset POINTCOMP
DOSCODE:3F97		     dw	offset CHECKFLUSH
DOSCODE:3F99		     dw	offset SFFromSFN
DOSCODE:3F9B		     dw	offset GetCDSFromDrv
DOSCODE:3F9D		     dw	offset Get_User_Stack
DOSCODE:3F9F		     dw	offset GETTHISDRV
DOSCODE:3FA1		     dw	offset DriveFromText
DOSCODE:3FA3		     dw	offset SETYEAR
DOSCODE:3FA5		     dw	offset DSUM
DOSCODE:3FA7		     dw	offset DSLIDE
DOSCODE:3FA9		     dw	offset StrCmp
DOSCODE:3FAB		     dw	offset InitCDS
DOSCODE:3FAD		     dw	offset pJFNFromHandle
DOSCODE:3FAF		     dw	offset $NameTrans
DOSCODE:3FB1		     dw	offset CAL_LK
DOSCODE:3FB3		     dw	offset DEVNAME
DOSCODE:3FB5		     dw	offset Idle
DOSCODE:3FB7		     dw	offset DStrLen
DOSCODE:3FB9		     dw	offset NLS_OPEN
DOSCODE:3FBB		     dw	offset $CLOSE
DOSCODE:3FBD		     dw	offset NLS_LSEEK
DOSCODE:3FBF		     dw	offset $READ
DOSCODE:3FC1		     dw	offset FastInit
DOSCODE:3FC3		     dw	offset NLS_IOCTL
DOSCODE:3FC5		     dw	offset GetDevList
DOSCODE:3FC7		     dw	offset NLS_GETEXT
DOSCODE:3FC9		     dw	offset MSG_RETRIEVAL
DOSCODE:3FCB		     dw	offset NO_OP
DOSCODE:3FCD ms_copyright    db	'MS DOS Version 5.00 (C)Copyright 1981-1991 Microsoft Corp License'
DOSCODE:3FCD		     db	'd Material - Property of Microsoft All rights reserved '
DOSCODE:4045 ; ---------------------------------------------------------------------------
DOSCODE:4045
DOSCODE:4045 $SET_CTRL_C_TRAPPING:		     ; ...
DOSCODE:4045		     cmp     al, 6
DOSCODE:4047		     jbe     short scct_1
DOSCODE:4049		     mov     al, 0FFh
DOSCODE:404B		     iret
DOSCODE:404C ; ---------------------------------------------------------------------------
DOSCODE:404C
DOSCODE:404C scct_1:				     ; ...
DOSCODE:404C		     push    ds
DOSCODE:404D		     mov     ds, cs:DosDSeg
DOSCODE:4052		     push    ax
DOSCODE:4053		     push    si
DOSCODE:4054		     mov     si, offset	CNTCFLAG
DOSCODE:4057		     xor     ah, ah
DOSCODE:4059		     or	     ax, ax
DOSCODE:405B		     jnz     short scct_2
DOSCODE:405D		     mov     dl, [si]
DOSCODE:405F		     jmp     short scct_6    ; scct_9s
DOSCODE:4061 ; ---------------------------------------------------------------------------
DOSCODE:4061
DOSCODE:4061 scct_2:				     ; ...
DOSCODE:4061		     dec     ax
DOSCODE:4062		     jnz     short scct_3
DOSCODE:4064		     and     dl, 1
DOSCODE:4067		     mov     [si], dl
DOSCODE:4069		     jmp     short scct_6    ; scct_9s
DOSCODE:406B ; ---------------------------------------------------------------------------
DOSCODE:406B
DOSCODE:406B scct_3:				     ; ...
DOSCODE:406B		     dec     ax
DOSCODE:406C		     jnz     short scct_4
DOSCODE:406E		     and     dl, 1
DOSCODE:4071		     xchg    dl, [si]
DOSCODE:4073		     jmp     short scct_6    ; scct_9s
DOSCODE:4075 ; ---------------------------------------------------------------------------
DOSCODE:4075
DOSCODE:4075 scct_4:				     ; ...
DOSCODE:4075		     cmp     ax, 3
DOSCODE:4078		     jnz     short scct_5
DOSCODE:407A		     mov     dl, ds:BOOTDRIVE
DOSCODE:407E		     jmp     short scct_6    ; scct_9s
DOSCODE:4080 ; ---------------------------------------------------------------------------
DOSCODE:4080
DOSCODE:4080 scct_5:				     ; ...
DOSCODE:4080		     cmp     ax, 4
DOSCODE:4083		     jnz     short scct_6    ; scct_9s
DOSCODE:4085		     mov     bx, 5	     ; (MINOR_VERSION<<8)+MAJOR_VERSION
DOSCODE:4088		     mov     dl, 0	     ; DOSREVNM
DOSCODE:408A		     xor     dh, dh
DOSCODE:408C		     cmp     ds:DosHasHMA, 0
DOSCODE:4091		     jz	     short scct_6
DOSCODE:4093		     or	     dh, 10h	     ; DOSINHMA
DOSCODE:4096
DOSCODE:4096 scct_6:				     ; ...
DOSCODE:4096		     pop     si		     ; scct_9s
DOSCODE:4097		     pop     ax
DOSCODE:4098		     pop     ds
DOSCODE:4099		     iret
DOSCODE:409A ; ---------------------------------------------------------------------------
DOSCODE:409A
DOSCODE:409A SetCtrlShortEntry:			     ; ...
DOSCODE:409A		     jmp     short $SET_CTRL_C_TRAPPING
DOSCODE:409C ; ---------------------------------------------------------------------------
DOSCODE:409C
DOSCODE:409C $SET_CURRENT_PDB:			     ; ...
DOSCODE:409C		     push    ds
DOSCODE:409D		     mov     ds, cs:DosDSeg
DOSCODE:40A2		     mov     ds:CurrentPDB, bx
DOSCODE:40A6		     pop     ds
DOSCODE:40A7		     iret
DOSCODE:40A8 ; ---------------------------------------------------------------------------
DOSCODE:40A8
DOSCODE:40A8 $GET_CURRENT_PDB:			     ; ...
DOSCODE:40A8		     push    ds
DOSCODE:40A9		     mov     ds, cs:DosDSeg
DOSCODE:40AE		     mov     bx, ds:CurrentPDB
DOSCODE:40B2		     pop     ds
DOSCODE:40B3		     iret
DOSCODE:40B4 ; ---------------------------------------------------------------------------
DOSCODE:40B4
DOSCODE:40B4 $SET_PRINTER_FLAG:			     ; ...
DOSCODE:40B4		     push    ds
DOSCODE:40B5		     mov     ds, cs:DosDSeg
DOSCODE:40BA		     mov     ds:PRINTER_FLAG, al
DOSCODE:40BD		     pop     ds
DOSCODE:40BE		     iret
DOSCODE:40BF ; ---------------------------------------------------------------------------
DOSCODE:40BF
DOSCODE:40BF QUIT:				     ; ...
DOSCODE:40BF		     xor     ah, ah
DOSCODE:40C1		     jmp     short SAVREGS
DOSCODE:40C3 ; ---------------------------------------------------------------------------
DOSCODE:40C3
DOSCODE:40C3 BADCALL:				     ; ...
DOSCODE:40C3		     xor     al, al
DOSCODE:40C5
DOSCODE:40C5 IRETT:				     ; ...
DOSCODE:40C5		     iret
DOSCODE:40C6 ; ---------------------------------------------------------------------------
DOSCODE:40C6
DOSCODE:40C6 CALL_ENTRY:			     ; ...
DOSCODE:40C6		     push    ds
DOSCODE:40C7		     mov     ds, cs:DosDSeg
DOSCODE:40CC		     pop     ds:SAVEDS
DOSCODE:40D0		     pop     ax
DOSCODE:40D1		     pop     ax
DOSCODE:40D2		     pop     ds:USER_SP
DOSCODE:40D6		     pushf
DOSCODE:40D7		     cli
DOSCODE:40D8		     push    ax
DOSCODE:40D9		     push    ds:USER_SP
DOSCODE:40DD		     push    ds:SAVEDS
DOSCODE:40E1		     pop     ds
DOSCODE:40E2		     cmp     cl, 36	     ; MAXCALL
DOSCODE:40E5		     ja	     short BADCALL
DOSCODE:40E7		     mov     ah, cl
DOSCODE:40E9		     jmp     short SAVREGS
DOSCODE:40EB ; ---------------------------------------------------------------------------
DOSCODE:40EB
DOSCODE:40EB COMMAND:				     ; ...
DOSCODE:40EB		     cli
DOSCODE:40EC		     cmp     ah, 6Ch
DOSCODE:40EF		     ja	     short BADCALL
DOSCODE:40F1
DOSCODE:40F1 SAVREGS:				     ; ...
DOSCODE:40F1		     cmp     ah, 33h
DOSCODE:40F4		     jb	     short loc_410E
DOSCODE:40F6		     jz	     short SetCtrlShortEntry
DOSCODE:40F8		     cmp     ah, 64h
DOSCODE:40FB		     ja	     short loc_410E
DOSCODE:40FD		     jz	     short $SET_PRINTER_FLAG
DOSCODE:40FF		     cmp     ah, 51h
DOSCODE:4102		     jz	     short $GET_CURRENT_PDB
DOSCODE:4104		     cmp     ah, 62h
DOSCODE:4107		     jz	     short $GET_CURRENT_PDB
DOSCODE:4109		     cmp     ah, 50h
DOSCODE:410C		     jz	     short $SET_CURRENT_PDB
DOSCODE:410E
DOSCODE:410E loc_410E:				     ; ...
DOSCODE:410E		     push    es
DOSCODE:410F		     push    ds
DOSCODE:4110		     push    bp
DOSCODE:4111		     push    di
DOSCODE:4112		     push    si
DOSCODE:4113		     push    dx
DOSCODE:4114		     push    cx
DOSCODE:4115		     push    bx
DOSCODE:4116		     push    ax
DOSCODE:4117		     mov     ax, ds
DOSCODE:4119		     mov     ds, cs:DosDSeg
DOSCODE:411E		     mov     ds:SAVEDS,	ax
DOSCODE:4121		     mov     ds:SAVEBX,	bx
DOSCODE:4125		     mov     ax, ds:USER_SP
DOSCODE:4128		     mov     ds:NSP, ax
DOSCODE:412B		     mov     ax, ds:USER_SS
DOSCODE:412E		     mov     ds:NSS, ax
DOSCODE:4131		     xor     ax, ax
DOSCODE:4133		     mov     ds:FSHARING, al
DOSCODE:4136		     test    ds:IsWin386, 1
DOSCODE:413B		     jnz     short loc_4140
DOSCODE:413D		     mov     ds:USER_ID, ax
DOSCODE:4140
DOSCODE:4140 loc_4140:				     ; ...
DOSCODE:4140		     inc     ds:INDOS
DOSCODE:4144		     mov     ds:USER_SP, sp
DOSCODE:4148		     mov     ds:USER_SS, ss
DOSCODE:414C		     mov     ax, ds:CurrentPDB
DOSCODE:414F		     mov     ds:PROC_ID, ax
DOSCODE:4152		     mov     ds, ax
DOSCODE:4154		     pop     ax
DOSCODE:4155		     push    ax
DOSCODE:4156		     mov     ds:2Eh, sp	     ; [PDB.USER_STACK]
DOSCODE:415A		     mov     word ptr ds:30h, ss ; [PDB.USER_STACK+2]
DOSCODE:415E		     mov     ss, cs:DosDSeg
DOSCODE:4163
DOSCODE:4163 REDISP:				     ; ...
DOSCODE:4163		     mov     sp, offset	AUXSTACK
DOSCODE:4166		     sti
DOSCODE:4167		     mov     bx, ss
DOSCODE:4169		     mov     ds, bx
DOSCODE:416B		     xchg    ax, bx
DOSCODE:416C		     xor     ax, ax
DOSCODE:416E		     mov     ss:EXTOPEN_ON, al
DOSCODE:4172		     and     ss:DOS34_FLAG, 800h
DOSCODE:4179		     mov     ss:CONSWAP, al
DOSCODE:417D		     mov     ss:NoSetDir, al
DOSCODE:4181		     mov     ss:FAILERR, al
DOSCODE:4185		     inc     ax
DOSCODE:4186		     mov     ss:IDLEINT, al  ; 1
DOSCODE:418A		     xchg    ax, bx
DOSCODE:418B		     mov     bl, ah
DOSCODE:418D		     shl     bx, 1
DOSCODE:418F		     cld
DOSCODE:4190		     or	     ah, ah
DOSCODE:4192		     jz	     short DSKROUT
DOSCODE:4194		     cmp     ah, 59h	     ; GETEXTENDEDERROR
DOSCODE:4197		     jz	     short DISPCALL
DOSCODE:4199		     cmp     ah, 12	     ; STD_CON_INPUT_FLUSH
DOSCODE:419C		     ja	     short DSKROUT
DOSCODE:419E
DOSCODE:419E IOROUT:
DOSCODE:419E		     cmp     ss:ERRORMODE, 0
DOSCODE:41A4		     jnz     short DISPCALL
DOSCODE:41A6		     mov     sp, offset	PRINTER_FLAG ; IOSTACK
DOSCODE:41A9		     jmp     short DISPCALL
DOSCODE:41AB ; ---------------------------------------------------------------------------
DOSCODE:41AB
DOSCODE:41AB DSKROUT:				     ; ...
DOSCODE:41AB		     mov     ss:USER_IN_AX, ax
DOSCODE:41AF		     mov     ss:EXTERR_LOCUS, 1
DOSCODE:41B5		     mov     ss:ERRORMODE, 0
DOSCODE:41BB		     mov     ss:WPERR, 0FFh
DOSCODE:41C1		     push    ax
DOSCODE:41C2		     mov     ah, 82h
DOSCODE:41C4		     int     2Ah	     ; Microsoft Networks - END	DOS CRITICAL SECTIONS 0	THROUGH	7
DOSCODE:41C6		     pop     ax
DOSCODE:41C7		     mov     ss:IDLEINT, 0
DOSCODE:41CD		     mov     sp, offset	DSKSTACK
DOSCODE:41D0		     test    ss:CNTCFLAG, 0FFh ; -1
DOSCODE:41D6		     jz	     short DISPCALL
DOSCODE:41D8		     push    ax
DOSCODE:41D9		     call    DSKSTATCHK
DOSCODE:41DC		     pop     ax
DOSCODE:41DD
DOSCODE:41DD DISPCALL:				     ; ...
DOSCODE:41DD		     mov     bx, cs:DISPATCH[bx] ; [CS:BX+DISPATCH]
DOSCODE:41E2		     xchg    bx, ss:SAVEBX
DOSCODE:41E7		     mov     ds, ss:SAVEDS
DOSCODE:41EC		     call    ss:SAVEBX
DOSCODE:41F1		     and     ss:DOS_FLAG, 0FBh
DOSCODE:41F7
DOSCODE:41F7 LeaveDOS:				     ; ...
DOSCODE:41F7		     cli
DOSCODE:41F8		     mov     ds, cs:DosDSeg
DOSCODE:41FD		     cmp     ds:A20OFF_COUNT, 0
DOSCODE:4202		     jnz     short disa20
DOSCODE:4204
DOSCODE:4204 LeaveA20On:			     ; ...
DOSCODE:4204		     dec     ds:INDOS
DOSCODE:4208		     mov     ss, ds:USER_SS
DOSCODE:420C		     mov     sp, ds:USER_SP
DOSCODE:4210		     mov     bp, sp
DOSCODE:4212		     mov     [bp+0], al
DOSCODE:4215		     mov     ax, ds:NSP
DOSCODE:4218		     mov     ds:USER_SP, ax
DOSCODE:421B		     mov     ax, ds:NSS
DOSCODE:421E		     mov     ds:USER_SS, ax
DOSCODE:4221		     pop     ax
DOSCODE:4222		     pop     bx
DOSCODE:4223		     pop     cx
DOSCODE:4224		     pop     dx
DOSCODE:4225		     pop     si
DOSCODE:4226		     pop     di
DOSCODE:4227		     pop     bp
DOSCODE:4228		     pop     ds
DOSCODE:4229		     pop     es
DOSCODE:422A		     iret
DOSCODE:422B ; ---------------------------------------------------------------------------
DOSCODE:422B
DOSCODE:422B disa20:				     ; ...
DOSCODE:422B		     mov     bx, ds:A20OFF_PSP
DOSCODE:422F		     cmp     bx, ds:CurrentPDB
DOSCODE:4233		     jnz     short LeaveA20On
DOSCODE:4235		     dec     ds:A20OFF_COUNT
DOSCODE:4239		     push    ds
DOSCODE:423A		     mov     bx, offset	disa20_iret
DOSCODE:423D		     push    bx
DOSCODE:423E		     retf
DOSCODE:423F ; ---------------------------------------------------------------------------
DOSCODE:423F
DOSCODE:423F restore_world:			     ; ...
DOSCODE:423F		     mov     es, cs:DosDSeg
DOSCODE:4244		     pop     es:RESTORE_TMP
DOSCODE:4249		     pop     ax
DOSCODE:424A		     pop     bx
DOSCODE:424B		     pop     cx
DOSCODE:424C		     pop     dx
DOSCODE:424D		     pop     si
DOSCODE:424E		     pop     di
DOSCODE:424F		     pop     bp
DOSCODE:4250		     pop     ds
DOSCODE:4251		     jmp     es:RESTORE_TMP
DOSCODE:4256 ; ---------------------------------------------------------------------------
DOSCODE:4256
DOSCODE:4256 save_world:			     ; ...
DOSCODE:4256		     mov     es, cs:DosDSeg
DOSCODE:425B		     pop     es:RESTORE_TMP
DOSCODE:4260		     push    ds
DOSCODE:4261		     push    bp
DOSCODE:4262		     push    di
DOSCODE:4263		     push    si
DOSCODE:4264		     push    dx
DOSCODE:4265		     push    cx
DOSCODE:4266		     push    bx
DOSCODE:4267		     push    ax
DOSCODE:4268		     push    es:RESTORE_TMP
DOSCODE:426D		     push    bp
DOSCODE:426E		     mov     bp, sp
DOSCODE:4270		     mov     es, word ptr [bp+20]
DOSCODE:4273		     pop     bp
DOSCODE:4274		     retn
DOSCODE:4275
DOSCODE:4275 ; =============== S U B R O U T I N E =======================================
DOSCODE:4275
DOSCODE:4275
DOSCODE:4275 Get_User_Stack  proc near		     ; ...
DOSCODE:4275		     mov     ds, cs:DosDSeg
DOSCODE:427A		     lds     si, dword ptr ds:USER_SP
DOSCODE:427E		     retn
DOSCODE:427E Get_User_Stack  endp
DOSCODE:427E
DOSCODE:427E ; ---------------------------------------------------------------------------
DOSCODE:427F ERRIN	     db	2		     ; ...
DOSCODE:4280		     db	6
DOSCODE:4281		     db	12
DOSCODE:4282		     db	4
DOSCODE:4283		     db	8
DOSCODE:4284		     db	0
DOSCODE:4285 ERROUT	     db	80h
DOSCODE:4286		     db	40h
DOSCODE:4287		     db	2
DOSCODE:4288		     db	10h
DOSCODE:4289		     db	4
DOSCODE:428A		     db	3
DOSCODE:428B
DOSCODE:428B ; =============== S U B R O U T I N E =======================================
DOSCODE:428B
DOSCODE:428B
DOSCODE:428B AbsSetup	     proc near		     ; ...
DOSCODE:428B		     inc     ss:INDOS
DOSCODE:4290		     sti
DOSCODE:4291		     cld
DOSCODE:4292		     push    ds
DOSCODE:4293		     push    ss
DOSCODE:4294		     pop     ds
DOSCODE:4295		     call    GETBP
DOSCODE:4298		     jb	     short errdriv
DOSCODE:429A		     mov     word ptr es:[bp+1Fh], -1 ;	[ES:BP+DPB.FREE_CNT]
DOSCODE:42A0
DOSCODE:42A0 errdriv:				     ; ...
DOSCODE:42A0		     pop     ds
DOSCODE:42A1		     jnb     short AbsSetup2
DOSCODE:42A3
DOSCODE:42A3 AbsSetup_retn:			     ; ...
DOSCODE:42A3		     retn
DOSCODE:42A4 ; ---------------------------------------------------------------------------
DOSCODE:42A4
DOSCODE:42A4 AbsSetup2:				     ; ...
DOSCODE:42A4		     mov     ss:HIGH_SECTOR, 0
DOSCODE:42AB		     call    RW32_CONVERT
DOSCODE:42AE		     jb	     short AbsSetup_retn
DOSCODE:42B0		     call    SET_RQ_SC_PARMS
DOSCODE:42B3		     push    ds
DOSCODE:42B4		     push    si
DOSCODE:42B5		     push    ax
DOSCODE:42B6		     push    ss
DOSCODE:42B7		     pop     ds
DOSCODE:42B8		     mov     si, offset	OPENBUF
DOSCODE:42BB		     mov     [si], al
DOSCODE:42BD		     add     byte ptr [si], 'A' ; 41h
DOSCODE:42C0		     mov     word ptr [si+1], ':' ; 3Ah
DOSCODE:42C5		     mov     ax, 300h
DOSCODE:42C8		     clc
DOSCODE:42C9		     int     2Ah	     ; Microsoft Networks - CHECK DIRECT I/O
DOSCODE:42C9					     ; DS:SI ->	ASCIZ disk device name (may be full path or only drive
DOSCODE:42C9					     ; specifier--must include the colon)
DOSCODE:42C9					     ; Return: CF clear	if absolute disk access	allowed
DOSCODE:42CB		     pop     ax
DOSCODE:42CC		     pop     si
DOSCODE:42CD		     pop     ds
DOSCODE:42CE		     jnb     short AbsSetup_retn
DOSCODE:42D0		     mov     ss:EXTERR,	32h
DOSCODE:42D7		     retn
DOSCODE:42D7 AbsSetup	     endp
DOSCODE:42D7
DOSCODE:42D8 ; ---------------------------------------------------------------------------
DOSCODE:42D8
DOSCODE:42D8 ABSDRD:				     ; ...
DOSCODE:42D8		     cli
DOSCODE:42D9		     push    ax
DOSCODE:42DA		     mov     ax, ds
DOSCODE:42DC		     mov     ds, cs:DosDSeg
DOSCODE:42E1		     mov     ds:TEMPSEG, ax
DOSCODE:42E4		     pop     ax
DOSCODE:42E5		     push    es
DOSCODE:42E6		     mov     ds:AbsRdWr_SS, ss
DOSCODE:42EA		     mov     ds:AbsRdWr_SP, sp
DOSCODE:42EE		     mov     ss, cs:DosDSeg
DOSCODE:42F3		     mov     sp, offset	DSKSTACK
DOSCODE:42F6		     mov     ds, ds:TEMPSEG
DOSCODE:42FA		     push    es
DOSCODE:42FB		     call    save_world
DOSCODE:42FE		     push    es
DOSCODE:42FF		     call    AbsSetup
DOSCODE:4302		     jb	     short ILEAVE
DOSCODE:4304		     call    ECritDisk
DOSCODE:4307		     mov     ss:CurSC_DRIVE, 0FFh ; -1
DOSCODE:430D		     call    LCritDisk
DOSCODE:4310		     call    DSKREAD
DOSCODE:4313		     jnz     short ERR_LEAVE
DOSCODE:4315		     mov     cx, di
DOSCODE:4317		     mov     ss:TEMP_VAR2, ds
DOSCODE:431C		     mov     ss:TEMP_VAR, bx
DOSCODE:4321		     call    DskRdBufScan
DOSCODE:4324		     jmp     short ILEAVE
DOSCODE:4326 ; ---------------------------------------------------------------------------
DOSCODE:4326
DOSCODE:4326 TLEAVE:				     ; ...
DOSCODE:4326		     jz	     short ILEAVE
DOSCODE:4328
DOSCODE:4328 ERR_LEAVE:				     ; ...
DOSCODE:4328		     push    es
DOSCODE:4329		     push    cs
DOSCODE:432A		     pop     es
DOSCODE:432B		     xor     ah, ah
DOSCODE:432D		     mov     cx, 6	     ; NUMERR
DOSCODE:4330		     mov     di, offset	ERRIN
DOSCODE:4333		     repne scasb
DOSCODE:4335		     jnz     short LEAVECODE
DOSCODE:4337		     mov     ah, es:[di+5]
DOSCODE:433B
DOSCODE:433B LEAVECODE:				     ; ...
DOSCODE:433B		     pop     es
DOSCODE:433C		     mov     ss:AbsDskErr, ax
DOSCODE:4340		     stc
DOSCODE:4341
DOSCODE:4341 ILEAVE:				     ; ...
DOSCODE:4341		     pop     es
DOSCODE:4342		     call    restore_world
DOSCODE:4345		     pop     es
DOSCODE:4346		     cli
DOSCODE:4347		     mov     ax, ss:AbsDskErr
DOSCODE:434B		     dec     ss:INDOS
DOSCODE:4350		     push    ss
DOSCODE:4351		     pop     es
DOSCODE:4352		     mov     ss, es:AbsRdWr_SS
DOSCODE:4357		     mov     sp, es:AbsRdWr_SP
DOSCODE:435C		     pop     es
DOSCODE:435D		     sti
DOSCODE:435E		     retf
DOSCODE:435F ; ---------------------------------------------------------------------------
DOSCODE:435F
DOSCODE:435F ABSDWRT:				     ; ...
DOSCODE:435F		     cli
DOSCODE:4360		     push    ax
DOSCODE:4361		     mov     ax, ds
DOSCODE:4363		     mov     ds, cs:DosDSeg
DOSCODE:4368		     mov     ds:TEMPSEG, ax
DOSCODE:436B		     pop     ax
DOSCODE:436C		     push    es
DOSCODE:436D		     mov     ds:AbsRdWr_SS, ss
DOSCODE:4371		     mov     ds:AbsRdWr_SP, sp
DOSCODE:4375		     mov     ss, cs:DosDSeg
DOSCODE:437A		     mov     sp, offset	DSKSTACK
DOSCODE:437D		     mov     ds, ds:TEMPSEG
DOSCODE:4381		     push    es
DOSCODE:4382		     call    save_world
DOSCODE:4385		     push    es
DOSCODE:4386		     call    AbsSetup
DOSCODE:4389		     jb	     short ILEAVE
DOSCODE:438B		     call    ECritDisk
DOSCODE:438E		     mov     ss:CurSC_DRIVE, 0FFh ; -1
DOSCODE:4394		     call    Fastxxx_Purge
DOSCODE:4397		     call    LCritDisk
DOSCODE:439A		     push    ds
DOSCODE:439B		     call    DskWrtBufPurge
DOSCODE:439E		     pop     ds
DOSCODE:439F		     call    DSKWRITE
DOSCODE:43A2		     jmp     short TLEAVE
DOSCODE:43A4
DOSCODE:43A4 ; =============== S U B R O U T I N E =======================================
DOSCODE:43A4
DOSCODE:43A4
DOSCODE:43A4 GETBP	     proc near		     ; ...
DOSCODE:43A4		     push    ax
DOSCODE:43A5		     add     al, 1
DOSCODE:43A7		     jb	     short SKIPGET
DOSCODE:43A9		     call    GETTHISDRV
DOSCODE:43AC		     jnb     short SKIPGET
DOSCODE:43AE		     xor     ah, ah
DOSCODE:43B0		     cmp     ax, 1Ah	     ; error_not_DOS_disk
DOSCODE:43B3		     jz	     short SKIPGET
DOSCODE:43B5		     stc
DOSCODE:43B6		     mov     ds:EXTERR,	ax
DOSCODE:43B9		     mov     ds:AbsDskErr, 201h
DOSCODE:43BF
DOSCODE:43BF SKIPGET:				     ; ...
DOSCODE:43BF		     pop     ax
DOSCODE:43C0		     jnb     short getbp_t
DOSCODE:43C2		     retn
DOSCODE:43C3 ; ---------------------------------------------------------------------------
DOSCODE:43C3
DOSCODE:43C3 getbp_t:				     ; ...
DOSCODE:43C3		     les     bp, ds:THISCDS
DOSCODE:43C7		     test    word ptr es:[bp+43h], 8000h ; [ES:BP+curdir.flags],
DOSCODE:43C7					     ; curdir_isnet
DOSCODE:43CD		     jz	     short GETBP_CDS
DOSCODE:43CF		     mov     ds:EXTERR,	32h ; '2' ; error_not_supported
DOSCODE:43D5		     stc
DOSCODE:43D6
DOSCODE:43D6 GETBP_RETN:
DOSCODE:43D6		     retn
DOSCODE:43D7 ; ---------------------------------------------------------------------------
DOSCODE:43D7
DOSCODE:43D7 GETBP_CDS:				     ; ...
DOSCODE:43D7		     les     bp, es:[bp+45h] ; [ES:BP+curdir.devptr]
DOSCODE:43DB
DOSCODE:43DB GOTDPB:				     ; ...
DOSCODE:43DB		     mov     word ptr ds:THISDPB, bp
DOSCODE:43DF		     mov     word ptr ds:THISDPB+2, es
DOSCODE:43E3		     retn
DOSCODE:43E3 GETBP	     endp
DOSCODE:43E3
DOSCODE:43E4 ; ---------------------------------------------------------------------------
DOSCODE:43E4 ; START OF	FUNCTION CHUNK FOR $CLOSE
DOSCODE:43E4
DOSCODE:43E4 SYS_RETURN:			     ; ...
DOSCODE:43E4		     call    Get_User_Stack  ; SYS_RETURN_OK
DOSCODE:43E7		     and     word ptr [si+16h],	0FFFEh ; [SI+user_env.user_F],
DOSCODE:43E7					     ; ~f_Carry
DOSCODE:43EB		     jmp     short DO_RET
DOSCODE:43ED ; ---------------------------------------------------------------------------
DOSCODE:43ED
DOSCODE:43ED SYS_RET_ERR:			     ; ...
DOSCODE:43ED		     xor     ah, ah
DOSCODE:43EF		     call    ETAB_LK
DOSCODE:43F2		     call    ErrorMap
DOSCODE:43F5
DOSCODE:43F5 From_GetSet:			     ; ...
DOSCODE:43F5		     call    Get_User_Stack
DOSCODE:43F8		     or	     word ptr [si+16h],	1 ; [SI+user_env.user_F],
DOSCODE:43F8					     ; f_Carry
DOSCODE:43FC		     stc
DOSCODE:43FD
DOSCODE:43FD DO_RET:				     ; ...
DOSCODE:43FD		     mov     [si], ax
DOSCODE:43FF		     retn
DOSCODE:43FF ; END OF FUNCTION CHUNK FOR $CLOSE
DOSCODE:4400 ; ---------------------------------------------------------------------------
DOSCODE:4400
DOSCODE:4400 NO_OP:				     ; ...
DOSCODE:4400		     xor     al, al
DOSCODE:4402		     retn
DOSCODE:4403
DOSCODE:4403 ; =============== S U B R O U T I N E =======================================
DOSCODE:4403
DOSCODE:4403
DOSCODE:4403 FCB_RET_ER	     proc near		     ; ...
DOSCODE:4403		     xor     ah, ah
DOSCODE:4405		     mov     ss:EXTERR,	ax
DOSCODE:4409		     call    ErrorMap
DOSCODE:440C		     mov     al, 0FFh	     ; -1
DOSCODE:440E		     retn
DOSCODE:440E FCB_RET_ER	     endp
DOSCODE:440E
DOSCODE:440F
DOSCODE:440F ; =============== S U B R O U T I N E =======================================
DOSCODE:440F
DOSCODE:440F
DOSCODE:440F ErrorMap	     proc near		     ; ...
DOSCODE:440F		     push    si
DOSCODE:4410		     mov     si, offset	ERR_TABLE_21
DOSCODE:4413		     cmp     ss:FAILERR, 0
DOSCODE:4419		     jz	     short EXTENDED_NORMAL
DOSCODE:441B		     mov     ss:EXTERR,	53h  ; error_FAIL_I24
DOSCODE:4422
DOSCODE:4422 EXTENDED_NORMAL:			     ; ...
DOSCODE:4422		     call    CAL_LK
DOSCODE:4425		     pop     si
DOSCODE:4426		     retn
DOSCODE:4426 ErrorMap	     endp
DOSCODE:4426
DOSCODE:4427
DOSCODE:4427 ; =============== S U B R O U T I N E =======================================
DOSCODE:4427
DOSCODE:4427
DOSCODE:4427 CAL_LK	     proc near		     ; ...
DOSCODE:4427		     push    ds
DOSCODE:4428		     push    ax
DOSCODE:4429		     push    bx
DOSCODE:442A		     mov     ds, cs:DosDSeg
DOSCODE:442F		     mov     bx, ds:EXTERR
DOSCODE:4433
DOSCODE:4433 TABLK1:				     ; ...
DOSCODE:4433		     lodsb
DOSCODE:4434		     cmp     al, 0FFh
DOSCODE:4436		     jz	     short GOT_VALS
DOSCODE:4438		     cmp     al, bl
DOSCODE:443A		     jz	     short GOT_VALS
DOSCODE:443C		     add     si, 3
DOSCODE:443F		     jmp     short TABLK1
DOSCODE:4441 ; ---------------------------------------------------------------------------
DOSCODE:4441
DOSCODE:4441 GOT_VALS:				     ; ...
DOSCODE:4441		     lodsw
DOSCODE:4442		     cmp     ah, 0FFh
DOSCODE:4445		     jz	     short NO_SET_ACT
DOSCODE:4447		     mov     ds:EXTERR_ACTION, ah
DOSCODE:444B
DOSCODE:444B NO_SET_ACT:			     ; ...
DOSCODE:444B		     cmp     al, 0FFh
DOSCODE:444D		     jz	     short NO_SET_CLS
DOSCODE:444F		     mov     ds:EXTERR_CLASS, al
DOSCODE:4452
DOSCODE:4452 NO_SET_CLS:			     ; ...
DOSCODE:4452		     lodsb
DOSCODE:4453		     cmp     al, 0FFh
DOSCODE:4455		     jz	     short NO_SET_LOC
DOSCODE:4457		     mov     ds:EXTERR_LOCUS, al
DOSCODE:445A
DOSCODE:445A NO_SET_LOC:			     ; ...
DOSCODE:445A		     pop     bx
DOSCODE:445B		     pop     ax
DOSCODE:445C		     pop     ds
DOSCODE:445D		     retn
DOSCODE:445D CAL_LK	     endp
DOSCODE:445D
DOSCODE:445E
DOSCODE:445E ; =============== S U B R O U T I N E =======================================
DOSCODE:445E
DOSCODE:445E
DOSCODE:445E ETAB_LK	     proc near		     ; ...
DOSCODE:445E		     push    ds
DOSCODE:445F		     push    si
DOSCODE:4460		     push    cx
DOSCODE:4461		     push    bx
DOSCODE:4462		     push    ss
DOSCODE:4463		     pop     ds
DOSCODE:4464		     mov     ds:EXTERR,	ax
DOSCODE:4467		     mov     si, offset	I21_MAP_E_TAB
DOSCODE:446A		     mov     bh, al
DOSCODE:446C		     mov     bl, byte ptr ds:USER_IN_AX+1
DOSCODE:4470
DOSCODE:4470 TABLK2:				     ; ...
DOSCODE:4470		     lods    word ptr cs:[si] ;	cs lodsw
DOSCODE:4472		     cmp     al, 0FFh
DOSCODE:4474		     jz	     short NOT_IN_TABLE
DOSCODE:4476		     cmp     al, bl
DOSCODE:4478		     jz	     short GOT_CALL
DOSCODE:447A		     xchg    ah, al
DOSCODE:447C		     xor     ah, ah
DOSCODE:447E		     add     si, ax
DOSCODE:4480		     jmp     short TABLK2
DOSCODE:4482 ; ---------------------------------------------------------------------------
DOSCODE:4482
DOSCODE:4482 NOT_IN_TABLE:			     ; ...
DOSCODE:4482		     mov     al, bh
DOSCODE:4484		     jmp     short NO_MAP
DOSCODE:4486 ; ---------------------------------------------------------------------------
DOSCODE:4486
DOSCODE:4486 GOT_CALL:				     ; ...
DOSCODE:4486		     mov     cl, ah
DOSCODE:4488		     xor     ch, ch
DOSCODE:448A
DOSCODE:448A CHECK_CODE:			     ; ...
DOSCODE:448A		     lods    byte ptr cs:[si] ;	cs lodsb
DOSCODE:448C		     cmp     al, bh
DOSCODE:448E		     jz	     short NO_MAP
DOSCODE:4490		     loop    CHECK_CODE
DOSCODE:4492
DOSCODE:4492 NO_MAP:				     ; ...
DOSCODE:4492		     xor     ah, ah
DOSCODE:4494		     pop     bx
DOSCODE:4495		     pop     cx
DOSCODE:4496		     pop     si
DOSCODE:4497		     pop     ds
DOSCODE:4498		     retn
DOSCODE:4498 ETAB_LK	     endp
DOSCODE:4498
DOSCODE:4499
DOSCODE:4499 ; =============== S U B R O U T I N E =======================================
DOSCODE:4499
DOSCODE:4499
DOSCODE:4499 SetBad	     proc near		     ; ...
DOSCODE:4499		     mov     ax, 1	     ; error_invalid_function
DOSCODE:449C		     push    ds
DOSCODE:449D		     mov     ds, cs:DosDSeg
DOSCODE:44A2		     mov     ds:EXTERR_LOCUS, 1	; errLOC_Unk
DOSCODE:44A7		     pop     ds
DOSCODE:44A8		     stc
DOSCODE:44A9		     retn
DOSCODE:44A9 SetBad	     endp
DOSCODE:44A9
DOSCODE:44AA
DOSCODE:44AA ; =============== S U B R O U T I N E =======================================
DOSCODE:44AA
DOSCODE:44AA
DOSCODE:44AA BadCall	     proc far		     ; ...
DOSCODE:44AA		     call    SetBad
DOSCODE:44AD		     retf
DOSCODE:44AD BadCall	     endp
DOSCODE:44AD
DOSCODE:44AE ; ---------------------------------------------------------------------------
DOSCODE:44AE
DOSCODE:44AE OKCall:
DOSCODE:44AE		     clc
DOSCODE:44AF		     retf
DOSCODE:44B0 ; ---------------------------------------------------------------------------
DOSCODE:44B0
DOSCODE:44B0 INT2F:				     ; ...
DOSCODE:44B0		     sti
DOSCODE:44B1		     cmp     ah, 11h	     ; MultNET
DOSCODE:44B4		     jnz     short INT2FSHR
DOSCODE:44B6
DOSCODE:44B6 TestInstall:			     ; ...
DOSCODE:44B6		     or	     al, al
DOSCODE:44B8		     jz	     short Leave2F
DOSCODE:44BA
DOSCODE:44BA BadFunc:				     ; ...
DOSCODE:44BA		     call    SetBad
DOSCODE:44BD
DOSCODE:44BD Leave2F:				     ; ...
DOSCODE:44BD		     retf    2
DOSCODE:44C0 ; ---------------------------------------------------------------------------
DOSCODE:44C0
DOSCODE:44C0 INT2FSHR:				     ; ...
DOSCODE:44C0		     cmp     ah, 10h	     ; MultSHARE
DOSCODE:44C3		     jz	     short TestInstall
DOSCODE:44C5		     cmp     ah, 14h	     ; NLSFUNC
DOSCODE:44C8		     jz	     short TestInstall
DOSCODE:44CA		     cmp     ah, 12h	     ; MultDOS
DOSCODE:44CD		     jnz     short check_win
DOSCODE:44CF		     jmp     DispatchDOS
DOSCODE:44D2 ; ---------------------------------------------------------------------------
DOSCODE:44D2
DOSCODE:44D2 check_win:				     ; ...
DOSCODE:44D2		     cmp     ah, 16h	     ; MultWin386
DOSCODE:44D5		     jz	     short Win386_Msg
DOSCODE:44D7		     cmp     ah, 46h	     ; WINOLDAP
DOSCODE:44DA		     jnz     short next_i2f
DOSCODE:44DC		     jmp     winold_swap
DOSCODE:44DF ; ---------------------------------------------------------------------------
DOSCODE:44DF
DOSCODE:44DF next_i2f:				     ; ...
DOSCODE:44DF		     jmp     far ptr 70h:5
DOSCODE:44E4 ; ---------------------------------------------------------------------------
DOSCODE:44E4
DOSCODE:44E4 Win386_Msg:			     ; ...
DOSCODE:44E4		     push    ds
DOSCODE:44E5		     mov     ds, cs:DosDSeg
DOSCODE:44EA		     cmp     al, 3
DOSCODE:44EC		     jnz     short Win386_Msg_exit
DOSCODE:44EE		     jmp     OldWin386Init
DOSCODE:44F1 ; ---------------------------------------------------------------------------
DOSCODE:44F1
DOSCODE:44F1 Win386_Msg_exit:			     ; ...
DOSCODE:44F1		     cmp     al, 6
DOSCODE:44F3		     jnz     short Win386_Msg_devcall
DOSCODE:44F5		     jmp     Win386_Leaving
DOSCODE:44F8 ; ---------------------------------------------------------------------------
DOSCODE:44F8
DOSCODE:44F8 Win386_Msg_devcall:		     ; ...
DOSCODE:44F8		     cmp     al, 7
DOSCODE:44FA		     jnz     short Win386_Msg_init
DOSCODE:44FC		     jmp     Win386_Query
DOSCODE:44FF ; ---------------------------------------------------------------------------
DOSCODE:44FF
DOSCODE:44FF Win386_Msg_init:			     ; ...
DOSCODE:44FF		     cmp     al, 5
DOSCODE:4501		     jz	     short Win386_Starting
DOSCODE:4503		     jmp     win_nexti2f
DOSCODE:4506 ; ---------------------------------------------------------------------------
DOSCODE:4506
DOSCODE:4506 Win386_Starting:			     ; ...
DOSCODE:4506		     test    dx, 1
DOSCODE:450A		     jz	     short Win386_vchk
DOSCODE:450C		     jmp     win_nexti2f
DOSCODE:450F ; ---------------------------------------------------------------------------
DOSCODE:450F
DOSCODE:450F Win386_vchk:			     ; ...
DOSCODE:450F		     mov     word ptr ds:Win386_Info+6,	0 ; [Win386_Info+Win386_SIS.Virt_Dev_File_Ptr]
DOSCODE:4515		     mov     word ptr ds:Win386_Info+8,	0 ; [Win386_Info+Win386_SIS.Virt_Dev_File_Ptr+2]
DOSCODE:451B		     cmp     di, 30Ah	     ; version 3.10
DOSCODE:451F		     jb	     short Win386_vxd
DOSCODE:4521		     jmp     noVxD31
DOSCODE:4524 ; ---------------------------------------------------------------------------
DOSCODE:4524
DOSCODE:4524 Win386_vxd:			     ; ...
DOSCODE:4524		     push    ax
DOSCODE:4525		     push    bx
DOSCODE:4526		     push    cx
DOSCODE:4527		     push    dx
DOSCODE:4528		     push    si
DOSCODE:4529		     push    di
DOSCODE:452A		     mov     bx, ds:UMB_HEAD
DOSCODE:452E		     cmp     bx, 0FFFFh
DOSCODE:4531		     jz	     short Vxd31
DOSCODE:4533		     mov     ds:UmbSaveFlag, 1
DOSCODE:4538		     push    ds
DOSCODE:4539		     push    es
DOSCODE:453A		     mov     ax, ds
DOSCODE:453C		     mov     es, ax
DOSCODE:453E		     mov     ds, bx
DOSCODE:4540		     xor     si, si
DOSCODE:4542		     cld
DOSCODE:4543		     mov     di, offset	UmbSave1
DOSCODE:4546		     mov     cx, 11
DOSCODE:4549		     rep movsb
DOSCODE:454B		     mov     di, offset	UmbSave2
DOSCODE:454E		     mov     cx, 5
DOSCODE:4551		     rep movsb
DOSCODE:4553		     pop     es
DOSCODE:4554		     pop     ds
DOSCODE:4555
DOSCODE:4555 Vxd31:				     ; ...
DOSCODE:4555		     test    ds:DOS_FLAG, 2
DOSCODE:455A		     jz	     short Dont_Supress
DOSCODE:455C		     pop     di
DOSCODE:455D		     pop     si
DOSCODE:455E		     pop     dx
DOSCODE:455F		     pop     cx
DOSCODE:4560		     pop     bx
DOSCODE:4561		     pop     ax
DOSCODE:4562		     jmp     short noVxD31
DOSCODE:4564 ; ---------------------------------------------------------------------------
DOSCODE:4564
DOSCODE:4564 Dont_Supress:			     ; ...
DOSCODE:4564		     mov     al, ds:BOOTDRIVE
DOSCODE:4567		     add     al, 40h ; '@'   ; 'A' - 1
DOSCODE:4569		     mov     byte ptr ds:VxDpath, al ; "c:\\wina20.386"
DOSCODE:456C		     mov     ah, 6Ch	     ; ExtOpen
DOSCODE:456E		     mov     al, 0
DOSCODE:4570		     mov     bx, 2080h
DOSCODE:4573		     mov     cx, 7
DOSCODE:4576		     mov     dx, 1
DOSCODE:4579		     mov     si, offset	VxDpath	; "c:\\wina20.386"
DOSCODE:457C		     mov     di, 0FFFFh
DOSCODE:457F		     int     21h	     ; DOS - 4.0 - EXTENDED OPEN/CREATE
DOSCODE:457F					     ; BL = open mode as in AL for normal open (INT 21h/AH=3Dh)
DOSCODE:457F					     ; BH = flags, CX =	create attribute, DL = action if file exists/does not exists
DOSCODE:457F					     ; DH = 00h	(reserved), DS:SI -> ASCIZ file	name
DOSCODE:4581		     pop     di
DOSCODE:4582		     pop     si
DOSCODE:4583		     pop     dx
DOSCODE:4584		     pop     cx
DOSCODE:4585		     jnb     short VxDthere
DOSCODE:4587		     push    dx
DOSCODE:4588		     push    ds
DOSCODE:4589		     push    si
DOSCODE:458A		     mov     si, offset	NoVxDErrMsg ; "You must	have the file WINA20.386 in th"...
DOSCODE:458D		     push    cs
DOSCODE:458E		     pop     ds
DOSCODE:458F		     mov     cx, 99
DOSCODE:4592		     mov     ah, 2
DOSCODE:4594		     cld
DOSCODE:4595
DOSCODE:4595 vxdlp:				     ; ...
DOSCODE:4595		     lodsb
DOSCODE:4596		     xchg    dl, al
DOSCODE:4598		     int     21h	     ; DOS - DISPLAY OUTPUT
DOSCODE:4598					     ; DL = character to send to standard output
DOSCODE:459A		     loop    vxdlp
DOSCODE:459C		     pop     si
DOSCODE:459D		     pop     ds
DOSCODE:459E		     pop     dx
DOSCODE:459F		     pop     bx
DOSCODE:45A0		     pop     ax
DOSCODE:45A1		     inc     cx
DOSCODE:45A2		     jmp     win_nexti2f
DOSCODE:45A5 ; ---------------------------------------------------------------------------
DOSCODE:45A5
DOSCODE:45A5 VxDthere:				     ; ...
DOSCODE:45A5		     mov     bx, ax
DOSCODE:45A7		     mov     ah, 3Eh
DOSCODE:45A9		     int     21h	     ; DOS - 2+	- CLOSE	A FILE WITH HANDLE
DOSCODE:45A9					     ; BX = file handle
DOSCODE:45AB		     mov     bx, offset	Win386_Info
DOSCODE:45AE		     mov     word ptr [bx+6], offset VxDpath ; [Win386_Info+Win386_SIS.Virt_Dev_File_Ptr],
DOSCODE:45AE					     ; VxDpath
DOSCODE:45B3		     mov     word ptr [bx+8], ds ; [Win386_Info+Win386_SIS.Virt_Dev_File_Ptr+2]
DOSCODE:45B6		     pop     bx
DOSCODE:45B7		     pop     ax
DOSCODE:45B8
DOSCODE:45B8 noVxD31:				     ; ...
DOSCODE:45B8		     or	     ds:IsWin386, 1
DOSCODE:45BD		     or	     ds:redir_patch, 1
DOSCODE:45C2		     push    dx
DOSCODE:45C3		     mov     dx, bx
DOSCODE:45C5		     mov     bx, offset	Win386_Info
DOSCODE:45C8		     mov     [bx+2], dx
DOSCODE:45CB		     mov     word ptr [bx+4], es
DOSCODE:45CE		     pop     dx
DOSCODE:45CF		     push    ds
DOSCODE:45D0		     pop     es
DOSCODE:45D1		     jmp     win_nexti2f
DOSCODE:45D4 ; ---------------------------------------------------------------------------
DOSCODE:45D4
DOSCODE:45D4 Win386_Leaving:			     ; ...
DOSCODE:45D4		     test    dx, 1
DOSCODE:45D8		     jz	     short Win386_Leaving_c
DOSCODE:45DA		     jmp     win_nexti2f
DOSCODE:45DD ; ---------------------------------------------------------------------------
DOSCODE:45DD
DOSCODE:45DD Win386_Leaving_c:			     ; ...
DOSCODE:45DD		     cmp     ds:UmbSaveFlag, 1
DOSCODE:45E2		     jnz     short noumb
DOSCODE:45E4		     mov     ds:UmbSaveFlag, 0
DOSCODE:45E9		     push    ax
DOSCODE:45EA		     push    es
DOSCODE:45EB		     push    cx
DOSCODE:45EC		     push    si
DOSCODE:45ED		     push    di
DOSCODE:45EE		     mov     ax, ds:UMB_HEAD
DOSCODE:45F1		     mov     es, ax
DOSCODE:45F3		     xor     di, di
DOSCODE:45F5		     cld
DOSCODE:45F6		     mov     si, offset	UmbSave1
DOSCODE:45F9		     mov     cx, 11
DOSCODE:45FC		     rep movsb
DOSCODE:45FE		     mov     si, offset	UmbSave2
DOSCODE:4601		     mov     cx, 5
DOSCODE:4604		     rep movsb
DOSCODE:4606		     pop     di
DOSCODE:4607		     pop     si
DOSCODE:4608		     pop     cx
DOSCODE:4609		     pop     es
DOSCODE:460A		     pop     ax
DOSCODE:460B
DOSCODE:460B noumb:				     ; ...
DOSCODE:460B		     and     ds:IsWin386, 0
DOSCODE:4610		     and     ds:redir_patch, 0
DOSCODE:4615		     jmp     short win_nexti2f
DOSCODE:4617 ; ---------------------------------------------------------------------------
DOSCODE:4617
DOSCODE:4617 Win386_Query:			     ; ...
DOSCODE:4617		     cmp     bx, 15h	     ; Win386_DOSMGR
DOSCODE:461A		     jnz     short win_nexti2f
DOSCODE:461C		     or	     cx, cx
DOSCODE:461E		     jnz     short dosmgr_func
DOSCODE:4620		     inc     cx
DOSCODE:4621		     mov     bx, offset	Win386_DOSVars
DOSCODE:4624		     push    ds
DOSCODE:4625		     pop     es
DOSCODE:4626		     jmp     short PopIret
DOSCODE:4628 ; ---------------------------------------------------------------------------
DOSCODE:4628
DOSCODE:4628 OldWin386Init:			     ; ...
DOSCODE:4628		     pop     ax
DOSCODE:4629		     mov     si, offset	OldInstanceJunk
DOSCODE:462C		     mov     ax, 5248h	     ; 'HR'
DOSCODE:462F		     jmp     next_i2f
DOSCODE:4632 ; ---------------------------------------------------------------------------
DOSCODE:4632
DOSCODE:4632 dosmgr_func:			     ; ...
DOSCODE:4632		     dec     cx
DOSCODE:4633		     jz	     short win386_patch
DOSCODE:4635		     dec     cx
DOSCODE:4636		     jz	     short PopIret
DOSCODE:4638		     dec     cx
DOSCODE:4639		     jz	     short win386_size
DOSCODE:463B		     dec     cx
DOSCODE:463C		     jz	     short win386_inst
DOSCODE:463E		     dec     cx
DOSCODE:463F		     jnz     short PopIret
DOSCODE:4641		     mov     ax, es
DOSCODE:4643		     dec     ax
DOSCODE:4644		     push    es
DOSCODE:4645		     mov     es, ax
DOSCODE:4647		     cmp     byte ptr es:[di], 'D'
DOSCODE:464B		     jnz     short cantsize
DOSCODE:464D		     inc     ax
DOSCODE:464E		     cmp     es:[di+1],	ax
DOSCODE:4652		     jnz     short cantsize
DOSCODE:4654		     mov     ax, es:[di+3]
DOSCODE:4658		     pop     es
DOSCODE:4659		     mov     bx, 16
DOSCODE:465C		     mul     bx
DOSCODE:465E		     mov     cx, ax
DOSCODE:4660		     mov     bx, dx
DOSCODE:4662		     jmp     short win386_done
DOSCODE:4664 ; ---------------------------------------------------------------------------
DOSCODE:4664
DOSCODE:4664 cantsize:				     ; ...
DOSCODE:4664		     pop     es
DOSCODE:4665		     xor     ax, ax
DOSCODE:4667		     xor     dx, dx
DOSCODE:4669		     jmp     short PopIret
DOSCODE:466B ; ---------------------------------------------------------------------------
DOSCODE:466B
DOSCODE:466B win386_patch:			     ; ...
DOSCODE:466B		     mov     bx, dx
DOSCODE:466D		     jmp     short win386_done
DOSCODE:466F ; ---------------------------------------------------------------------------
DOSCODE:466F
DOSCODE:466F win386_size:			     ; ...
DOSCODE:466F		     test    dx, 1
DOSCODE:4673		     jz	     short PopIret
DOSCODE:4675		     mov     cx, 88	     ; curdirLen
DOSCODE:4678		     jmp     short win386_done
DOSCODE:467A ; ---------------------------------------------------------------------------
DOSCODE:467A
DOSCODE:467A win386_inst:			     ; ...
DOSCODE:467A		     xor     dx, dx
DOSCODE:467C		     jmp     short PopIret
DOSCODE:467E ; ---------------------------------------------------------------------------
DOSCODE:467E
DOSCODE:467E win386_done:			     ; ...
DOSCODE:467E		     mov     ax, 0B97Ch	     ; WIN_OP_DONE
DOSCODE:4681		     mov     dx, 0A2ABh	     ; DOSMGR_OP_DONE
DOSCODE:4684
DOSCODE:4684 PopIret:				     ; ...
DOSCODE:4684		     pop     ds
DOSCODE:4685		     iret
DOSCODE:4686 ; ---------------------------------------------------------------------------
DOSCODE:4686
DOSCODE:4686 win_nexti2f:			     ; ...
DOSCODE:4686		     pop     ds
DOSCODE:4687		     jmp     next_i2f
DOSCODE:468A ; ---------------------------------------------------------------------------
DOSCODE:468A
DOSCODE:468A getwinlast:			     ; ...
DOSCODE:468A		     mov     si, ds:CurrentPDB
DOSCODE:468E		     dec     si
DOSCODE:468F		     mov     es, si
DOSCODE:4691		     add     si, es:3
DOSCODE:4696		     retn
DOSCODE:4697 ; ---------------------------------------------------------------------------
DOSCODE:4697
DOSCODE:4697 winold_swap:			     ; ...
DOSCODE:4697		     push    ds
DOSCODE:4698		     push    es
DOSCODE:4699		     push    si
DOSCODE:469A		     push    di
DOSCODE:469B		     push    cx
DOSCODE:469C		     mov     ds, cs:DosDSeg
DOSCODE:46A1		     cmp     al, 1
DOSCODE:46A3		     jnz     short swapin
DOSCODE:46A5		     call    getwinlast
DOSCODE:46A8		     push    ds
DOSCODE:46A9		     pop     es
DOSCODE:46AA		     mov     ds, si
DOSCODE:46AC		     xor     si, si
DOSCODE:46AE		     mov     di, offset	WinoldPatch1
DOSCODE:46B1		     mov     cx, 8
DOSCODE:46B4		     cld
DOSCODE:46B5		     push    cx
DOSCODE:46B6		     rep movsb
DOSCODE:46B8		     pop     cx
DOSCODE:46B9		     mov     di, offset	WinoldPatch2
DOSCODE:46BC		     rep movsb
DOSCODE:46BE		     jmp     short winold_done
DOSCODE:46C0 ; ---------------------------------------------------------------------------
DOSCODE:46C0
DOSCODE:46C0 swapin:				     ; ...
DOSCODE:46C0		     cmp     al, 2
DOSCODE:46C2		     jnz     short winold_done
DOSCODE:46C4		     call    getwinlast
DOSCODE:46C7		     mov     es, si
DOSCODE:46C9		     xor     di, di
DOSCODE:46CB		     mov     si, 6
DOSCODE:46CE		     mov     cx, 8
DOSCODE:46D1		     cld
DOSCODE:46D2		     push    cx
DOSCODE:46D3		     rep movsb
DOSCODE:46D5		     pop     cx
DOSCODE:46D6		     mov     si, offset	WinoldPatch2
DOSCODE:46D9		     rep movsb
DOSCODE:46DB
DOSCODE:46DB winold_done:			     ; ...
DOSCODE:46DB		     pop     cx
DOSCODE:46DC		     pop     di
DOSCODE:46DD		     pop     si
DOSCODE:46DE		     pop     es
DOSCODE:46DF		     pop     ds
DOSCODE:46E0		     jmp     next_i2f
DOSCODE:46E3 ; ---------------------------------------------------------------------------
DOSCODE:46E3
DOSCODE:46E3 DispatchDOS:			     ; ...
DOSCODE:46E3		     push    cs:FOO
DOSCODE:46E8		     push    cs:Dtab
DOSCODE:46ED		     push    ax
DOSCODE:46EE		     push    bp
DOSCODE:46EF		     mov     bp, sp
DOSCODE:46F1		     mov     ax, [bp+0Eh]
DOSCODE:46F4		     pop     bp
DOSCODE:46F5		     call    TableDispatch
DOSCODE:46F8		     jmp     BadFunc
DOSCODE:46FB ; ---------------------------------------------------------------------------
DOSCODE:46FB
DOSCODE:46FB DOSGetGroup:			     ; ...
DOSCODE:46FB		     mov     ds, cs:DosDSeg
DOSCODE:4700		     retn
DOSCODE:4701 ; ---------------------------------------------------------------------------
DOSCODE:4701
DOSCODE:4701 DOSInstall:			     ; ...
DOSCODE:4701		     mov     al, 0FFh
DOSCODE:4703		     retn
DOSCODE:4704
DOSCODE:4704 ; =============== S U B R O U T I N E =======================================
DOSCODE:4704
DOSCODE:4704
DOSCODE:4704 RW32_CONVERT    proc near		     ; ...
DOSCODE:4704		     cmp     cx, 0FFFFh
DOSCODE:4707		     jz	     short new32format
DOSCODE:4709		     push    ax
DOSCODE:470A		     push    dx
DOSCODE:470B		     mov     ax, es:[bp+0Dh] ; [ES:BP+DPB.MAX_CLUSTER]
DOSCODE:470F		     mov     dl, es:[bp+4]   ; [ES:BP+DPB.CLUSTER_MASK]
DOSCODE:4713		     cmp     dl, 0FEh	     ; Sectors/cluster - 1
DOSCODE:4716		     jz	     short letold
DOSCODE:4718		     inc     dl
DOSCODE:471A		     xor     dh, dh
DOSCODE:471C		     mul     dx
DOSCODE:471E		     or	     dx, dx
DOSCODE:4720
DOSCODE:4720 letold:				     ; ...
DOSCODE:4720		     pop     dx
DOSCODE:4721		     pop     ax
DOSCODE:4722		     jz	     short old_style
DOSCODE:4724		     push    ds
DOSCODE:4725		     mov     ds, cs:DosDSeg
DOSCODE:472A		     mov     ds:AbsDskErr, 207h
DOSCODE:4730		     pop     ds
DOSCODE:4731		     stc
DOSCODE:4732		     retn
DOSCODE:4733 ; ---------------------------------------------------------------------------
DOSCODE:4733
DOSCODE:4733 new32format:			     ; ...
DOSCODE:4733		     mov     dx, [bx+2]	     ; [BX+ABS_32RW.SECTOR_RBA+2]
DOSCODE:4736		     push    ds
DOSCODE:4737		     mov     ds, cs:DosDSeg
DOSCODE:473C		     mov     ds:HIGH_SECTOR, dx
DOSCODE:4740		     pop     ds
DOSCODE:4741		     mov     dx, [bx]	     ; [BX+ABS_32RW.SECTOR_RBA]
DOSCODE:4743		     mov     cx, [bx+4]	     ; [BX+ABS_32RW.ABS_RW_COUNT]
DOSCODE:4746		     lds     bx, [bx+6]	     ; [BX+ABS_32RW.BUFFER_ADDR]
DOSCODE:4749
DOSCODE:4749 old_style:				     ; ...
DOSCODE:4749		     clc
DOSCODE:474A		     retn
DOSCODE:474A RW32_CONVERT    endp
DOSCODE:474A
DOSCODE:474B
DOSCODE:474B ; =============== S U B R O U T I N E =======================================
DOSCODE:474B
DOSCODE:474B
DOSCODE:474B Fastxxx_Purge   proc near		     ; ...
DOSCODE:474B		     push    ax
DOSCODE:474C		     push    si
DOSCODE:474D		     push    dx
DOSCODE:474E		     push    ds
DOSCODE:474F		     mov     ds, cs:DosDSeg
DOSCODE:4754		     test    ds:FastOpenFlg, 80h ; Fast_yes
DOSCODE:4759		     pop     ds
DOSCODE:475A		     jz	     short nofast
DOSCODE:475C		     mov     ah, 1	     ; FastOpen_ID
DOSCODE:475E		     mov     al, 5	     ; FONC_purge
DOSCODE:4760		     mov     dl, es:[bp+0]
DOSCODE:4764		     call    Fast_Dispatch
DOSCODE:4767
DOSCODE:4767 nofast:				     ; ...
DOSCODE:4767		     pop     dx
DOSCODE:4768		     pop     si
DOSCODE:4769		     pop     ax
DOSCODE:476A		     retn
DOSCODE:476A Fastxxx_Purge   endp
DOSCODE:476A
DOSCODE:476A ; ---------------------------------------------------------------------------
DOSCODE:476B DIVMES	     db	0Dh,0Ah		     ; ...
DOSCODE:476B		     db	'Divide overflow',0Dh,0Ah
DOSCODE:477E DivMesLen	     dw	19		     ; ...
DOSCODE:4780 NoVxDErrMsg     db	'You must have the file WINA20.386 in the root of your boot drive',0Dh ; ...
DOSCODE:4780		     db	0Ah
DOSCODE:4780		     db	'to run Windows in Enhanced Mode',0Dh,0Ah
DOSCODE:47E3 NLS_YES	     db	'Y'                  ; ...
DOSCODE:47E4 NLS_NO	     db	'N'                  ; ...
DOSCODE:47E5 NLS_yes2	     db	'y'                  ; ...
DOSCODE:47E6 NLS_no2	     db	'n'                  ; ...
DOSCODE:47E7 CANCHAR	     db	1Bh		     ; ...
DOSCODE:47E8 ESCCHAR	     db	0		     ; ...
DOSCODE:47E9 ESCTAB	     db	64		     ; ...
DOSCODE:47EA		     db	77
DOSCODE:47EB		     db	59
DOSCODE:47EC		     db	83
DOSCODE:47ED		     db	60
DOSCODE:47EE		     db	62
DOSCODE:47EF		     db	61
DOSCODE:47F0		     db	61
DOSCODE:47F1		     db	63
DOSCODE:47F2		     db	75
DOSCODE:47F3		     db	82
DOSCODE:47F4		     db	82
DOSCODE:47F5		     db	65
DOSCODE:47F6		     db	65
DOSCODE:47F7 ESCFUNC	     dw	offset GETCH	     ; ...
DOSCODE:47F9		     dw	offset TWOESC
DOSCODE:47FB		     dw	offset EXITINS
DOSCODE:47FD		     dw	offset EXITINS	     ; ENTERINS
DOSCODE:47FF		     dw	offset BACKSP
DOSCODE:4801		     dw	offset REEDIT
DOSCODE:4803		     dw	offset KILNEW
DOSCODE:4805		     dw	offset COPYLIN
DOSCODE:4807		     dw	offset SKIPSTR
DOSCODE:4809		     dw	offset COPYSTR
DOSCODE:480B		     dw	offset SKIPONE
DOSCODE:480D		     dw	offset COPYONE
DOSCODE:480F		     dw	offset COPYONE
DOSCODE:4811		     dw	offset CTRLZ
DOSCODE:4813 ; ---------------------------------------------------------------------------
DOSCODE:4813 ; START OF	FUNCTION CHUNK FOR $STD_CON_STRING_INPUT
DOSCODE:4813
DOSCODE:4813 OEMFunctionKey:			     ; ...
DOSCODE:4813		     call    $STD_CON_INPUT_NO_ECHO
DOSCODE:4816		     mov     cl, 14	     ; ESCTABLEN
DOSCODE:4818		     push    di
DOSCODE:4819		     mov     di, offset	ESCTAB
DOSCODE:481C		     push    es
DOSCODE:481D		     push    cs
DOSCODE:481E		     pop     es
DOSCODE:481F		     repne scasb
DOSCODE:4821		     pop     es
DOSCODE:4822		     pop     di
DOSCODE:4823		     shl     cx, 1
DOSCODE:4825		     mov     bp, cx
DOSCODE:4827		     jmp     cs:ESCFUNC[bp]  ; [CS:BP+ESCFUNC]
DOSCODE:4827 ; END OF FUNCTION CHUNK FOR $STD_CON_STRING_INPUT
DOSCODE:482C ; ---------------------------------------------------------------------------
DOSCODE:482C
DOSCODE:482C $GET_DATE:				     ; ...
DOSCODE:482C		     push    ss
DOSCODE:482D		     pop     ds
DOSCODE:482E		     call    READTIME
DOSCODE:4831		     mov     ax, ds:YEAR
DOSCODE:4834		     mov     bx, word ptr ds:DAY
DOSCODE:4838		     call    Get_User_Stack
DOSCODE:483B		     mov     [si+6], bx	     ; [SI+user_env.user_DX]
DOSCODE:483E		     add     ax, 1980
DOSCODE:4841		     mov     [si+4], ax	     ; [SI+user_env.user_CX]
DOSCODE:4844		     mov     al, ss:WEEKDAY
DOSCODE:4848
DOSCODE:4848 RET20:				     ; ...
DOSCODE:4848		     retn
DOSCODE:4849 ; ---------------------------------------------------------------------------
DOSCODE:4849
DOSCODE:4849 $SET_DATE:				     ; ...
DOSCODE:4849		     mov     al, -1	     ; 0FFh
DOSCODE:484B		     sub     cx, 1980
DOSCODE:484F		     jb	     short RET20
DOSCODE:4851		     cmp     cx, 119
DOSCODE:4854		     ja	     short RET24
DOSCODE:4856		     or	     dh, dh
DOSCODE:4858		     jz	     short RET20
DOSCODE:485A		     or	     dl, dl
DOSCODE:485C		     jz	     short RET20
DOSCODE:485E		     cmp     dh, 0Ch
DOSCODE:4861		     ja	     short RET24
DOSCODE:4863		     push    ss
DOSCODE:4864		     pop     ds
DOSCODE:4865		     call    DODATE
DOSCODE:4868
DOSCODE:4868 RET24:				     ; ...
DOSCODE:4868		     retn
DOSCODE:4869 ; ---------------------------------------------------------------------------
DOSCODE:4869
DOSCODE:4869 $GET_TIME:				     ; ...
DOSCODE:4869		     push    ss
DOSCODE:486A		     pop     ds
DOSCODE:486B		     call    READTIME
DOSCODE:486E		     call    Get_User_Stack
DOSCODE:4871		     mov     [si+6], dx	     ; [SI+user_env.user_DX]
DOSCODE:4874		     mov     [si+4], cx	     ; [SI+user_env.user_CX]
DOSCODE:4877		     xor     al, al
DOSCODE:4879
DOSCODE:4879 RET26:				     ; ...
DOSCODE:4879		     retn
DOSCODE:487A ; ---------------------------------------------------------------------------
DOSCODE:487A
DOSCODE:487A $SET_TIME:				     ; ...
DOSCODE:487A		     mov     al, -1
DOSCODE:487C		     cmp     ch, 24
DOSCODE:487F		     jnb     short RET26
DOSCODE:4881		     cmp     cl, 60
DOSCODE:4884		     jnb     short RET26
DOSCODE:4886		     cmp     dh, 60
DOSCODE:4889		     jnb     short RET26
DOSCODE:488B		     cmp     dl, 100
DOSCODE:488E		     jnb     short RET26
DOSCODE:4890		     push    cx
DOSCODE:4891		     push    dx
DOSCODE:4892		     push    ss
DOSCODE:4893		     pop     ds
DOSCODE:4894		     mov     bx, offset	TIMEBUF
DOSCODE:4897		     mov     cx, 6
DOSCODE:489A		     xor     dx, dx
DOSCODE:489C		     mov     ax, dx
DOSCODE:489E		     push    bx
DOSCODE:489F		     call    SETREAD
DOSCODE:48A2		     push    ds
DOSCODE:48A3		     lds     si, ds:BCLOCK
DOSCODE:48A7		     call    DEVIOCALL2
DOSCODE:48AA		     pop     ds
DOSCODE:48AB		     pop     bx
DOSCODE:48AC		     call    SETWRITE
DOSCODE:48AF		     pop     ds:TIMEBUF+4
DOSCODE:48B3		     pop     ds:TIMEBUF+2
DOSCODE:48B7		     lds     si, ds:BCLOCK
DOSCODE:48BB		     call    DEVIOCALL2
DOSCODE:48BE		     xor     al, al
DOSCODE:48C0		     retn
DOSCODE:48C1
DOSCODE:48C1 ; =============== S U B R O U T I N E =======================================
DOSCODE:48C1
DOSCODE:48C1
DOSCODE:48C1 DATE16	     proc near		     ; ...
DOSCODE:48C1		     mov     ds, cs:DosDSeg
DOSCODE:48C6		     push    cx
DOSCODE:48C7		     push    es
DOSCODE:48C8		     call    READTIME
DOSCODE:48CB		     pop     es
DOSCODE:48CC		     shl     cl, 1
DOSCODE:48CE		     shl     cl, 1
DOSCODE:48D0		     shl     cx, 1
DOSCODE:48D2		     shl     cx, 1
DOSCODE:48D4		     shl     cx, 1
DOSCODE:48D6		     shr     dh, 1
DOSCODE:48D8		     or	     cl, dh
DOSCODE:48DA		     mov     dx, cx
DOSCODE:48DC		     mov     ax, word ptr ds:MONTH
DOSCODE:48DF		     mov     cl, 4
DOSCODE:48E1		     shl     al, cl
DOSCODE:48E3		     shl     ax, 1
DOSCODE:48E5		     pop     cx
DOSCODE:48E6		     or	     al, ds:DAY
DOSCODE:48EA
DOSCODE:48EA RET21:				     ; ...
DOSCODE:48EA		     retn
DOSCODE:48EA DATE16	     endp
DOSCODE:48EA
DOSCODE:48EB
DOSCODE:48EB ; =============== S U B R O U T I N E =======================================
DOSCODE:48EB
DOSCODE:48EB
DOSCODE:48EB READTIME	     proc near		     ; ...
DOSCODE:48EB		     mov     ds:DATE_FLAG, 0
DOSCODE:48F1		     push    si
DOSCODE:48F2		     push    bx
DOSCODE:48F3		     mov     bx, offset	TIMEBUF
DOSCODE:48F6		     mov     cx, 6
DOSCODE:48F9		     xor     dx, dx
DOSCODE:48FB		     mov     ax, dx
DOSCODE:48FD		     call    SETREAD
DOSCODE:4900		     push    ds
DOSCODE:4901		     lds     si, ds:BCLOCK
DOSCODE:4905		     call    DEVIOCALL2
DOSCODE:4908		     pop     ds
DOSCODE:4909		     pop     bx
DOSCODE:490A		     pop     si
DOSCODE:490B		     mov     ax, ds:TIMEBUF
DOSCODE:490E		     mov     cx, ds:TIMEBUF+2
DOSCODE:4912		     mov     dx, ds:TIMEBUF+4
DOSCODE:4916		     cmp     ax, ds:DAYCNT
DOSCODE:491A		     jz	     short RET21
DOSCODE:491C		     cmp     ax, 43830	     ; FOURYEARS*30
DOSCODE:491F		     jnb     short RET22
DOSCODE:4921		     mov     ds:DAYCNT,	ax
DOSCODE:4924		     push    si
DOSCODE:4925		     push    cx
DOSCODE:4926		     push    dx
DOSCODE:4927		     xor     dx, dx
DOSCODE:4929		     mov     cx, 1461	     ; FOURYEARS
DOSCODE:492C		     div     cx
DOSCODE:492E		     shl     ax, 1
DOSCODE:4930		     shl     ax, 1
DOSCODE:4932		     shl     ax, 1
DOSCODE:4934		     mov     cx, ax
DOSCODE:4936		     mov     si, offset	YRTAB
DOSCODE:4939		     call    DSLIDE
DOSCODE:493C		     shr     cx, 1
DOSCODE:493E		     jnb     short SK
DOSCODE:4940		     add     dx, 200
DOSCODE:4944
DOSCODE:4944 SK:				     ; ...
DOSCODE:4944		     call    SETYEAR
DOSCODE:4947		     mov     cl, 1
DOSCODE:4949		     mov     si, offset	MONTAB
DOSCODE:494C		     call    DSLIDE
DOSCODE:494F		     mov     ds:MONTH, cl
DOSCODE:4953		     inc     dx
DOSCODE:4954		     mov     ds:DAY, dl
DOSCODE:4958		     call    WKDAY
DOSCODE:495B		     pop     dx
DOSCODE:495C		     pop     cx
DOSCODE:495D		     pop     si
DOSCODE:495E
DOSCODE:495E RET22:				     ; ...
DOSCODE:495E		     retn
DOSCODE:495E READTIME	     endp
DOSCODE:495E
DOSCODE:495F
DOSCODE:495F ; =============== S U B R O U T I N E =======================================
DOSCODE:495F
DOSCODE:495F
DOSCODE:495F DSLIDE	     proc near		     ; ...
DOSCODE:495F		     mov     ah, 0
DOSCODE:4961
DOSCODE:4961 DSLIDE1:				     ; ...
DOSCODE:4961		     lodsb
DOSCODE:4962		     cmp     dx, ax
DOSCODE:4964		     jb	     short RET22
DOSCODE:4966		     sub     dx, ax
DOSCODE:4968		     inc     cx
DOSCODE:4969		     jmp     short DSLIDE1
DOSCODE:4969 DSLIDE	     endp
DOSCODE:4969
DOSCODE:496B
DOSCODE:496B ; =============== S U B R O U T I N E =======================================
DOSCODE:496B
DOSCODE:496B
DOSCODE:496B SETYEAR	     proc near		     ; ...
DOSCODE:496B		     mov     ds, cs:DosDSeg
DOSCODE:4970		     mov     byte ptr ds:YEAR, cl
DOSCODE:4974
DOSCODE:4974 CHKYR:				     ; ...
DOSCODE:4974		     test    cl, 3
DOSCODE:4977		     mov     al, 28
DOSCODE:4979		     jnz     short SAVFEB
DOSCODE:497B		     inc     al
DOSCODE:497D
DOSCODE:497D SAVFEB:				     ; ...
DOSCODE:497D		     mov     ds:february, al ; [MONTAB+1]
DOSCODE:4980
DOSCODE:4980 RET23:				     ; ...
DOSCODE:4980		     retn
DOSCODE:4980 SETYEAR	     endp
DOSCODE:4980
DOSCODE:4981
DOSCODE:4981 ; =============== S U B R O U T I N E =======================================
DOSCODE:4981
DOSCODE:4981
DOSCODE:4981 DODATE	     proc near		     ; ...
DOSCODE:4981		     call    CHKYR
DOSCODE:4984		     mov     al, dh
DOSCODE:4986		     mov     bx, (offset YRTAB+7) ; offset MONTAB-1
DOSCODE:4989		     xlat
DOSCODE:498A		     cmp     al, dl
DOSCODE:498C		     mov     al, -1
DOSCODE:498E		     jb	     short RET23
DOSCODE:4990		     call    SETYEAR
DOSCODE:4993		     mov     word ptr ds:DAY, dx
DOSCODE:4997		     shr     cx, 1
DOSCODE:4999		     shr     cx, 1
DOSCODE:499B		     mov     ax, 1461	     ; FOURYEARS
DOSCODE:499E		     mov     bx, dx
DOSCODE:49A0		     mul     cx
DOSCODE:49A2		     mov     cl, byte ptr ds:YEAR
DOSCODE:49A6		     and     cl, 3
DOSCODE:49A9		     mov     si, offset	YRTAB
DOSCODE:49AC		     mov     dx, ax
DOSCODE:49AE		     shl     cx, 1
DOSCODE:49B0		     call    DSUM
DOSCODE:49B3		     mov     cl, bh
DOSCODE:49B5		     mov     si, offset	MONTAB
DOSCODE:49B8		     dec     cx
DOSCODE:49B9		     call    DSUM
DOSCODE:49BC		     mov     cl, bl
DOSCODE:49BE		     dec     cx
DOSCODE:49BF		     add     dx, cx
DOSCODE:49C1		     xchg    ax, dx
DOSCODE:49C2		     mov     ds:DAYCNT,	ax
DOSCODE:49C5		     push    si
DOSCODE:49C6		     push    bx
DOSCODE:49C7		     push    ax
DOSCODE:49C8		     mov     bx, offset	TIMEBUF
DOSCODE:49CB		     mov     cx, 6
DOSCODE:49CE		     xor     dx, dx
DOSCODE:49D0		     mov     ax, dx
DOSCODE:49D2		     push    bx
DOSCODE:49D3		     call    SETREAD
DOSCODE:49D6		     push    ds
DOSCODE:49D7		     lds     si, ds:BCLOCK
DOSCODE:49DB		     call    DEVIOCALL2
DOSCODE:49DE		     pop     ds
DOSCODE:49DF		     pop     bx
DOSCODE:49E0		     call    SETWRITE
DOSCODE:49E3		     pop     ds:TIMEBUF
DOSCODE:49E7		     push    ds
DOSCODE:49E8		     lds     si, ds:BCLOCK
DOSCODE:49EC		     call    DEVIOCALL2
DOSCODE:49EF		     pop     ds
DOSCODE:49F0		     pop     bx
DOSCODE:49F1		     pop     si
DOSCODE:49F2
DOSCODE:49F2 WKDAY:				     ; ...
DOSCODE:49F2		     mov     ax, ds:DAYCNT
DOSCODE:49F5		     xor     dx, dx
DOSCODE:49F7		     mov     cx, 7
DOSCODE:49FA		     inc     ax
DOSCODE:49FB		     inc     ax
DOSCODE:49FC		     div     cx
DOSCODE:49FE		     mov     ds:WEEKDAY, dl
DOSCODE:4A02		     xor     al, al
DOSCODE:4A04		     retn
DOSCODE:4A04 DODATE	     endp
DOSCODE:4A04
DOSCODE:4A05
DOSCODE:4A05 ; =============== S U B R O U T I N E =======================================
DOSCODE:4A05
DOSCODE:4A05
DOSCODE:4A05 DSUM	     proc near		     ; ...
DOSCODE:4A05		     mov     ah, 0
DOSCODE:4A07		     jcxz    short DUSUM9
DOSCODE:4A09
DOSCODE:4A09 DSUM1:				     ; ...
DOSCODE:4A09		     lodsb
DOSCODE:4A0A		     add     dx, ax
DOSCODE:4A0C		     loop    DSUM1
DOSCODE:4A0E
DOSCODE:4A0E DUSUM9:				     ; ...
DOSCODE:4A0E		     retn
DOSCODE:4A0E DSUM	     endp
DOSCODE:4A0E
DOSCODE:4A0F ; ---------------------------------------------------------------------------
DOSCODE:4A0F
DOSCODE:4A0F $GET_VERSION:			     ; ...
DOSCODE:4A0F		     push    ss
DOSCODE:4A10		     pop     ds
DOSCODE:4A11		     mov     bx, word ptr ds:USERNUM+2
DOSCODE:4A15		     mov     cx, word ptr ds:USERNUM
DOSCODE:4A19		     cmp     al, 1
DOSCODE:4A1B		     jnz     short Norm_Vers
DOSCODE:4A1D		     xor     bh, bh
DOSCODE:4A1F
DOSCODE:4A1F Norm_Vers:				     ; ...
DOSCODE:4A1F		     push    ds
DOSCODE:4A20		     mov     ds, ds:CurrentPDB
DOSCODE:4A24		     mov     ax, ds:40h	     ; [PDB.Version]
DOSCODE:4A27		     pop     ds
DOSCODE:4A28		     call    Get_User_Stack
DOSCODE:4A2B		     mov     [si], ax	     ; [SI+user_env.user_AX]
DOSCODE:4A2D		     mov     [si+2], bx	     ; [SI+user_env.user_BX]
DOSCODE:4A30		     mov     [si+4], cx	     ; [SI+user_env.user_CX]
DOSCODE:4A33		     retn
DOSCODE:4A34 ; ---------------------------------------------------------------------------
DOSCODE:4A34
DOSCODE:4A34 $GET_VERIFY_ON_WRITE:		     ; ...
DOSCODE:4A34		     mov     al, ss:VERFLG
DOSCODE:4A38		     retn
DOSCODE:4A39 ; ---------------------------------------------------------------------------
DOSCODE:4A39
DOSCODE:4A39 $SET_VERIFY_ON_WRITE:		     ; ...
DOSCODE:4A39		     and     al, 1
DOSCODE:4A3B		     mov     ss:VERFLG,	al
DOSCODE:4A3F
DOSCODE:4A3F RET27:				     ; ...
DOSCODE:4A3F		     retn
DOSCODE:4A40 ; ---------------------------------------------------------------------------
DOSCODE:4A40
DOSCODE:4A40 $INTERNATIONAL:			     ; ...
DOSCODE:4A40		     cmp     al, 0FFh
DOSCODE:4A42		     jz	     short BX_HAS_CODE
DOSCODE:4A44		     mov     bl, al
DOSCODE:4A46		     xor     bh, bh
DOSCODE:4A48
DOSCODE:4A48 BX_HAS_CODE:			     ; ...
DOSCODE:4A48		     push    ds
DOSCODE:4A49		     pop     es
DOSCODE:4A4A		     push    dx
DOSCODE:4A4B		     pop     di
DOSCODE:4A4C		     push    ss
DOSCODE:4A4D		     pop     ds
DOSCODE:4A4E		     cmp     di, 0FFFFh	     ; -1
DOSCODE:4A51		     jz	     short international_set
DOSCODE:4A53		     or	     bx, bx
DOSCODE:4A55		     jnz     short international_find
DOSCODE:4A57		     mov     si, offset	COUNTRY_CDPG
DOSCODE:4A5A		     jmp     short international_copy
DOSCODE:4A5C ; ---------------------------------------------------------------------------
DOSCODE:4A5C
DOSCODE:4A5C international_find:		     ; ...
DOSCODE:4A5C		     mov     bp, 0
DOSCODE:4A5F		     call    international_get
DOSCODE:4A62		     jb	     short errtn
DOSCODE:4A64		     cmp     bx, 0
DOSCODE:4A67		     jnz     short international_copy
DOSCODE:4A69		     mov     bx, dx
DOSCODE:4A6B		     jmp     short international_ok3
DOSCODE:4A6D
DOSCODE:4A6D ; =============== S U B R O U T I N E =======================================
DOSCODE:4A6D
DOSCODE:4A6D
DOSCODE:4A6D international_get proc near	     ; ...
DOSCODE:4A6D		     mov     si, offset	COUNTRY_CDPG
DOSCODE:4A70		     cmp     bx, ss:[si+68h] ; [SI+DOS_CCDPG.ccDosCountry]
DOSCODE:4A74		     jz	     short RET27
DOSCODE:4A76		     mov     dx, bx
DOSCODE:4A78		     xor     bx, bx
DOSCODE:4A7A		     mov     ax, 1400h
DOSCODE:4A7D		     int     2Fh	     ; - Multiplex - NLSFUNC.COM - INSTALLATION	CHECK
DOSCODE:4A7D					     ; Return: AL = 00h	not installed, OK to install
DOSCODE:4A7D					     ; 01h not installed, not OK
DOSCODE:4A7D					     ; FFh installed
DOSCODE:4A7F		     cmp     al, 0FFh
DOSCODE:4A81		     jnz     short interr
DOSCODE:4A83		     or	     bp, bp
DOSCODE:4A85		     jnz     short stcdpg
DOSCODE:4A87		     mov     ax, 1404h
DOSCODE:4A8A		     int     2Fh	     ; - Multiplex - NLSFUNC.COM - GET COUNTRY INFO
DOSCODE:4A8A					     ; BX = code page, DX = country code, DS:SI	-> internal code page structure
DOSCODE:4A8A					     ; ES:DI ->	user buffer
DOSCODE:4A8A					     ; Return: AL = status
DOSCODE:4A8C		     jmp     short chkok
DOSCODE:4A8E ; ---------------------------------------------------------------------------
DOSCODE:4A8E
DOSCODE:4A8E stcdpg:				     ; ...
DOSCODE:4A8E		     mov     ax, 1403h
DOSCODE:4A91		     int     2Fh	     ; - Multiplex - NLSFUNC.COM - SET COUNTRY INFO
DOSCODE:4A91					     ; DS:SI ->	internal code page structure
DOSCODE:4A91					     ; BX = code page, DX = country code
DOSCODE:4A91					     ; Return: AL = status
DOSCODE:4A93
DOSCODE:4A93 chkok:				     ; ...
DOSCODE:4A93		     or	     al, al
DOSCODE:4A95		     jz	     short RET27
DOSCODE:4A97
DOSCODE:4A97 setcarry:				     ; ...
DOSCODE:4A97		     stc
DOSCODE:4A98		     retn
DOSCODE:4A99 ; ---------------------------------------------------------------------------
DOSCODE:4A99
DOSCODE:4A99 interr:				     ; ...
DOSCODE:4A99		     mov     al, 0FFh
DOSCODE:4A9B		     jmp     short setcarry
DOSCODE:4A9B international_get endp
DOSCODE:4A9B
DOSCODE:4A9D ; ---------------------------------------------------------------------------
DOSCODE:4A9D
DOSCODE:4A9D international_copy:		     ; ...
DOSCODE:4A9D		     mov     bx, ss:[si+68h] ; [ss:SI+DOS_CCDPG.ccDosCountry]
DOSCODE:4AA1		     mov     si, offset	COUNTRY_CDPG_108 ; COUNTRY_CDPG	+ 108
DOSCODE:4AA4		     mov     cx, 24	     ; OLD_COUNTRY_SIZE
DOSCODE:4AA7		     push    ds
DOSCODE:4AA8		     push    ss
DOSCODE:4AA9		     pop     ds
DOSCODE:4AAA		     rep movsb
DOSCODE:4AAC		     pop     ds
DOSCODE:4AAD
DOSCODE:4AAD international_ok3:			     ; ...
DOSCODE:4AAD		     call    Get_User_Stack
DOSCODE:4AB0		     mov     [si+2], bx	     ; [SI+user_env.user_BX]
DOSCODE:4AB3
DOSCODE:4AB3 international_ok:			     ; ...
DOSCODE:4AB3		     mov     ax, bx
DOSCODE:4AB5
DOSCODE:4AB5 SYS_RET_OK_jmp:			     ; ...
DOSCODE:4AB5		     jmp     SYS_RETURN	     ; SYS_RET_OK
DOSCODE:4AB8 ; ---------------------------------------------------------------------------
DOSCODE:4AB8
DOSCODE:4AB8 international_set:			     ; ...
DOSCODE:4AB8		     mov     bp, 1
DOSCODE:4ABB		     call    international_get
DOSCODE:4ABE		     jnb     short international_ok
DOSCODE:4AC0
DOSCODE:4AC0 errtn:				     ; ...
DOSCODE:4AC0		     cmp     al, 0FFh
DOSCODE:4AC2		     jz	     short errtn2
DOSCODE:4AC4
DOSCODE:4AC4 errtn1:				     ; ...
DOSCODE:4AC4		     jmp     SYS_RET_ERR
DOSCODE:4AC7 ; ---------------------------------------------------------------------------
DOSCODE:4AC7
DOSCODE:4AC7 errtn2:				     ; ...
DOSCODE:4AC7		     mov     al, 1	     ; error_invalid_function
DOSCODE:4AC9		     jmp     short errtn1
DOSCODE:4ACB ; ---------------------------------------------------------------------------
DOSCODE:4ACB
DOSCODE:4ACB $GetExtCntry:			     ; ...
DOSCODE:4ACB		     cmp     al, 20h	     ; CAP_ONE_CHAR
DOSCODE:4ACD		     jb	     short notcap
DOSCODE:4ACF		     test    al, 80h	     ; UPPER_TABLE
DOSCODE:4AD1		     jnz     short fileupper
DOSCODE:4AD3		     mov     bx, offset	UCASE_TAB_2 ; UCASE_TAB+2
DOSCODE:4AD6		     jmp     short capit
DOSCODE:4AD8 ; ---------------------------------------------------------------------------
DOSCODE:4AD8
DOSCODE:4AD8 fileupper:				     ; ...
DOSCODE:4AD8		     mov     bx, offset	FILE_UCASE_TAB_2 ; FILE_UCASE_TAB+2
DOSCODE:4ADB
DOSCODE:4ADB capit:				     ; ...
DOSCODE:4ADB		     cmp     al, 20h	     ; CAP_ONE_CHAR
DOSCODE:4ADD		     jnz     short chkyes
DOSCODE:4ADF		     mov     al, dl
DOSCODE:4AE1		     call    GETLET3
DOSCODE:4AE4		     call    Get_User_Stack
DOSCODE:4AE7		     mov     [si+6], al	     ; [SI+user_env.user_DX]
DOSCODE:4AEA		     jmp     short nono
DOSCODE:4AEC ; ---------------------------------------------------------------------------
DOSCODE:4AEC
DOSCODE:4AEC chkyes:				     ; ...
DOSCODE:4AEC		     cmp     al, 23h	     ; CHECK_YES_NO
DOSCODE:4AEE		     jnz     short capstring
DOSCODE:4AF0		     xor     ax, ax
DOSCODE:4AF2		     cmp     dl, cs:NLS_YES  ; 'Y'
DOSCODE:4AF7		     jz	     short yesyes
DOSCODE:4AF9		     cmp     dl, cs:NLS_yes2 ; 'y'
DOSCODE:4AFE		     jz	     short yesyes
DOSCODE:4B00		     cmp     dl, cs:NLS_NO   ; 'n'
DOSCODE:4B05		     jz	     short nono
DOSCODE:4B07		     cmp     dl, cs:NLS_no2
DOSCODE:4B0C		     jz	     short nono
DOSCODE:4B0E		     inc     ax
DOSCODE:4B0F
DOSCODE:4B0F yesyes:				     ; ...
DOSCODE:4B0F		     inc     ax
DOSCODE:4B10
DOSCODE:4B10 nono:				     ; ...
DOSCODE:4B10		     jmp     short SYS_RET_OK_jmp
DOSCODE:4B12 ; ---------------------------------------------------------------------------
DOSCODE:4B12
DOSCODE:4B12 capstring:				     ; ...
DOSCODE:4B12		     mov     si, dx
DOSCODE:4B14		     cmp     al, 21h	     ; CAP_STRING
DOSCODE:4B16		     jnz     short capascii
DOSCODE:4B18		     or	     cx, cx
DOSCODE:4B1A		     jz	     short nono
DOSCODE:4B1C
DOSCODE:4B1C concap:				     ; ...
DOSCODE:4B1C		     lodsb
DOSCODE:4B1D		     call    GETLET3
DOSCODE:4B20		     mov     [si-1], al
DOSCODE:4B23		     loop    concap
DOSCODE:4B25		     jmp     short nono
DOSCODE:4B27 ; ---------------------------------------------------------------------------
DOSCODE:4B27
DOSCODE:4B27 capascii:				     ; ...
DOSCODE:4B27		     cmp     al, 22h	     ; CAP_ASCIIZ
DOSCODE:4B29		     jnz     short capinval
DOSCODE:4B2B
DOSCODE:4B2B concap2:				     ; ...
DOSCODE:4B2B		     lodsb
DOSCODE:4B2C		     or	     al, al
DOSCODE:4B2E		     jz	     short nono
DOSCODE:4B30		     call    GETLET3
DOSCODE:4B33		     mov     [si-1], al
DOSCODE:4B36		     jmp     short concap2
DOSCODE:4B38 ; ---------------------------------------------------------------------------
DOSCODE:4B38
DOSCODE:4B38 notcap:				     ; ...
DOSCODE:4B38		     cmp     cx, 5
DOSCODE:4B3B		     jb	     short sizeerror
DOSCODE:4B3D		     push    ss
DOSCODE:4B3E		     pop     ds
DOSCODE:4B3F		     mov     si, offset	COUNTRY_CDPG
DOSCODE:4B42		     cmp     dx, 0FFFFh	     ; -1
DOSCODE:4B45		     jnz     short GETCDPG
DOSCODE:4B47		     mov     dx, [si+68h]    ; [SI+DOS_CCDPG.ccDosCountry]
DOSCODE:4B4A
DOSCODE:4B4A GETCDPG:				     ; ...
DOSCODE:4B4A		     cmp     bx, 0FFFFh	     ; -1
DOSCODE:4B4D		     jnz     short CHKAGAIN
DOSCODE:4B4F		     mov     bx, [si+6Ah]    ; [SI+DOS_CCDPG.ccDosCodePage]
DOSCODE:4B52
DOSCODE:4B52 CHKAGAIN:				     ; ...
DOSCODE:4B52		     cmp     dx, [si+68h]    ; [SI+DOS_CCDPG.ccDosCountry]
DOSCODE:4B55		     jnz     short CHKNLS
DOSCODE:4B57		     cmp     bx, [si+6Ah]    ; [SI+DOS_CCDPG.ccDosCodePage]
DOSCODE:4B5A		     jnz     short CHKNLS
DOSCODE:4B5C		     mov     bx, [si+48h]    ; [SI+DOS_CCDPG.ccSysCodePage]
DOSCODE:4B5F		     push    cx
DOSCODE:4B60		     mov     cx, [si+4Ah]    ; [SI+DOS_CCDPG.ccNumber_of_entries]
DOSCODE:4B63		     mov     si, offset	COUNTRY_CDPG_76	; COUNTRY_CDPG+76
DOSCODE:4B63					     ; COUNTRY_CDPG+DOS_CCDPG.ccSetUcase
DOSCODE:4B66
DOSCODE:4B66 NXTENTRY:				     ; ...
DOSCODE:4B66		     cmp     al, [si]
DOSCODE:4B68		     jz	     short FOUNDIT
DOSCODE:4B6A		     add     si, 5
DOSCODE:4B6D		     loop    NXTENTRY
DOSCODE:4B6F		     pop     cx
DOSCODE:4B70
DOSCODE:4B70 capinval:				     ; ...
DOSCODE:4B70		     mov     al, 1
DOSCODE:4B72
DOSCODE:4B72 SYS_RET_ERR_jmp:			     ; ...
DOSCODE:4B72		     jmp     SYS_RET_ERR
DOSCODE:4B75 ; ---------------------------------------------------------------------------
DOSCODE:4B75
DOSCODE:4B75 FOUNDIT:				     ; ...
DOSCODE:4B75		     movsb
DOSCODE:4B76		     pop     cx
DOSCODE:4B77		     cmp     al, 1	     ; SetCountryInfo
DOSCODE:4B79		     jz	     short setsize
DOSCODE:4B7B		     mov     cx, 4
DOSCODE:4B7E		     mov     ax, 5
DOSCODE:4B81
DOSCODE:4B81 OK_RETN:				     ; ...
DOSCODE:4B81		     rep movsb
DOSCODE:4B83		     mov     cx, ax
DOSCODE:4B85		     mov     ax, bx
DOSCODE:4B87
DOSCODE:4B87 GETDONE:				     ; ...
DOSCODE:4B87		     call    Get_User_Stack
DOSCODE:4B8A		     mov     [si+4], cx	     ; [SI+user_env.user_CX]
DOSCODE:4B8D
DOSCODE:4B8D nono_jmp:				     ; ...
DOSCODE:4B8D		     jmp     short nono
DOSCODE:4B8F ; ---------------------------------------------------------------------------
DOSCODE:4B8F
DOSCODE:4B8F setsize:				     ; ...
DOSCODE:4B8F		     sub     cx, 3
DOSCODE:4B92		     cmp     [si], cx
DOSCODE:4B94		     jnb     short setsize2
DOSCODE:4B96		     mov     cx, [si]
DOSCODE:4B98
DOSCODE:4B98 setsize2:				     ; ...
DOSCODE:4B98		     mov     es:[di], cx
DOSCODE:4B9B		     add     di, 2
DOSCODE:4B9E		     add     si, 2
DOSCODE:4BA1		     mov     ax, cx
DOSCODE:4BA3		     add     ax, 3
DOSCODE:4BA6		     jmp     short OK_RETN
DOSCODE:4BA8 ; ---------------------------------------------------------------------------
DOSCODE:4BA8
DOSCODE:4BA8 CHKNLS:				     ; ...
DOSCODE:4BA8		     xor     ah, ah
DOSCODE:4BAA		     push    ax
DOSCODE:4BAB		     pop     bp
DOSCODE:4BAC		     mov     ax, 1400h
DOSCODE:4BAF		     int     2Fh	     ; - Multiplex - NLSFUNC.COM - INSTALLATION	CHECK
DOSCODE:4BAF					     ; Return: AL = 00h	not installed, OK to install
DOSCODE:4BAF					     ; 01h not installed, not OK
DOSCODE:4BAF					     ; FFh installed
DOSCODE:4BB1		     cmp     al, 0FFh
DOSCODE:4BB3		     jz	     short NLSNXT
DOSCODE:4BB5
DOSCODE:4BB5 sizeerror:				     ; ...
DOSCODE:4BB5		     mov     al, 1	     ; error_invalid_function
DOSCODE:4BB7
DOSCODE:4BB7 sys_ret_err_jmp2:			     ; ...
DOSCODE:4BB7		     jmp     short SYS_RET_ERR_jmp
DOSCODE:4BB9 ; ---------------------------------------------------------------------------
DOSCODE:4BB9
DOSCODE:4BB9 NLSNXT:				     ; ...
DOSCODE:4BB9		     mov     ax, 1402h
DOSCODE:4BBC		     int     2Fh	     ; - Multiplex - NLSFUNC.COM - GET COUNTRY INFO
DOSCODE:4BBC					     ; BP = subfunction, BX = code page
DOSCODE:4BBC					     ; DX = country code, DS:SI	-> internal code page structure
DOSCODE:4BBC					     ; ES:DI ->	user buffer, CX	= size of user buffer
DOSCODE:4BBC					     ; Return: AL = status
DOSCODE:4BBC					     ; 00h successful
DOSCODE:4BBC					     ; else DOS	error code
DOSCODE:4BBE		     cmp     al, 0
DOSCODE:4BC0		     jnz     short NLSERROR
DOSCODE:4BC2		     mov     ax, [si+48h]    ; [SI+DOS_CCDPG.ccSysCodePage]
DOSCODE:4BC5		     jmp     short GETDONE
DOSCODE:4BC7 ; ---------------------------------------------------------------------------
DOSCODE:4BC7
DOSCODE:4BC7 NLSERROR:				     ; ...
DOSCODE:4BC7		     jmp     short sys_ret_err_jmp2
DOSCODE:4BC9 ; ---------------------------------------------------------------------------
DOSCODE:4BC9
DOSCODE:4BC9 $GetSetCdPg:			     ; ...
DOSCODE:4BC9		     push    ss
DOSCODE:4BCA		     pop     ds
DOSCODE:4BCB		     mov     si, offset	COUNTRY_CDPG
DOSCODE:4BCE		     cmp     al, 1
DOSCODE:4BD0		     jnz     short setglpg
DOSCODE:4BD2		     mov     bx, [si+6Ah]    ; [SI+DOS_CCDPG.ccDosCodePage]
DOSCODE:4BD5		     mov     dx, [si+48h]    ; [SI+DOS_CCDPG.ccSysCodePage]
DOSCODE:4BD8		     call    Get_User_Stack
DOSCODE:4BDB		     mov     [si+2], bx
DOSCODE:4BDE		     mov     [si+6], dx
DOSCODE:4BE1
DOSCODE:4BE1 OK_RETURN:				     ; ...
DOSCODE:4BE1		     jmp     short nono_jmp
DOSCODE:4BE3 ; ---------------------------------------------------------------------------
DOSCODE:4BE3
DOSCODE:4BE3 setglpg:				     ; ...
DOSCODE:4BE3		     cmp     al, 2
DOSCODE:4BE5		     jnz     short nomem
DOSCODE:4BE7		     mov     dx, [si+68h]    ; [SI+DOS_CCDPG.ccDosCountry]
DOSCODE:4BEA		     mov     ax, 1400h
DOSCODE:4BED		     int     2Fh	     ; - Multiplex - NLSFUNC.COM - INSTALLATION	CHECK
DOSCODE:4BED					     ; Return: AL = 00h	not installed, OK to install
DOSCODE:4BED					     ; 01h not installed, not OK
DOSCODE:4BED					     ; FFh installed
DOSCODE:4BEF		     cmp     al, 0FFh
DOSCODE:4BF1		     jnz     short nomem
DOSCODE:4BF3		     mov     ax, 1401h
DOSCODE:4BF6		     int     2Fh	     ; - Multiplex - NLSFUNC.COM - CHANGE CODE PAGE
DOSCODE:4BF6					     ; DS:SI ->	internal code page structure
DOSCODE:4BF6					     ; BX = new	code page, DX =	country	code???
DOSCODE:4BF6					     ; Return: AL = status
DOSCODE:4BF6					     ; 00h successful
DOSCODE:4BF6					     ; else DOS	error code
DOSCODE:4BF8		     or	     al, al
DOSCODE:4BFA		     jz	     short OK_RETURN
DOSCODE:4BFC		     cmp     al, 65
DOSCODE:4BFE		     jnz     short seterr
DOSCODE:4C00		     mov     ax, 65
DOSCODE:4C03		     mov     ds:EXTERR,	ax
DOSCODE:4C06		     mov     ds:EXTERR_ACTION, 6 ; errACT_Ignore
DOSCODE:4C0B		     mov     ds:EXTERR_CLASS, 5	; errCLASS_HrdFail
DOSCODE:4C10		     mov     ds:EXTERR_LOCUS, 4	; errLOC_SerDev
DOSCODE:4C15		     jmp     From_GetSet
DOSCODE:4C18 ; ---------------------------------------------------------------------------
DOSCODE:4C18
DOSCODE:4C18 seterr:				     ; ...
DOSCODE:4C18		     jmp     short NLSERROR
DOSCODE:4C1A ; ---------------------------------------------------------------------------
DOSCODE:4C1A
DOSCODE:4C1A nomem:				     ; ...
DOSCODE:4C1A		     mov     al, 1	     ; error_invalid_function
DOSCODE:4C1C		     jmp     short seterr
DOSCODE:4C1E ; ---------------------------------------------------------------------------
DOSCODE:4C1E
DOSCODE:4C1E $GET_DRIVE_FREESPACE:		     ; ...
DOSCODE:4C1E		     push    ss
DOSCODE:4C1F		     pop     ds
DOSCODE:4C20		     mov     al, dl
DOSCODE:4C22		     call    GETTHISDRV
DOSCODE:4C25
DOSCODE:4C25 SET_AX_RET:			     ; ...
DOSCODE:4C25		     jb	     short BADFDRV
DOSCODE:4C27		     call    DISK_INFO
DOSCODE:4C2A		     xchg    dx, bx
DOSCODE:4C2C		     jb	     short SET_AX_RET
DOSCODE:4C2E		     xor     ah, ah
DOSCODE:4C30
DOSCODE:4C30 DoSt:				     ; ...
DOSCODE:4C30		     call    Get_User_Stack
DOSCODE:4C33		     mov     [si+6], dx	     ; [SI+user_env.user_DX]
DOSCODE:4C36		     mov     [si+4], cx	     ; [SI+user_env.user_CX]
DOSCODE:4C39		     mov     [si+2], bx	     ; [SI+user_env.user_BX]
DOSCODE:4C3C		     mov     [si], ax	     ; [SI+user_env.user_AX]
DOSCODE:4C3E		     retn
DOSCODE:4C3F ; ---------------------------------------------------------------------------
DOSCODE:4C3F
DOSCODE:4C3F BADFDRV:				     ; ...
DOSCODE:4C3F		     call    FCB_RET_ER
DOSCODE:4C42		     mov     ax, 0FFFFh	     ; -1
DOSCODE:4C45		     jmp     short DoSt
DOSCODE:4C47 ; ---------------------------------------------------------------------------
DOSCODE:4C47
DOSCODE:4C47 $GET_DMA:				     ; ...
DOSCODE:4C47		     mov     bx, word ptr ss:DMAADD
DOSCODE:4C4C		     mov     cx, word ptr ss:DMAADD+2
DOSCODE:4C51		     call    Get_User_Stack
DOSCODE:4C54		     mov     [si+2], bx	     ; [SI+user_env.user_BX]
DOSCODE:4C57		     mov     [si+10h], cx    ; [SI+user_env.user_ES]
DOSCODE:4C5A		     retn
DOSCODE:4C5B ; ---------------------------------------------------------------------------
DOSCODE:4C5B
DOSCODE:4C5B $SET_DMA:				     ; ...
DOSCODE:4C5B		     mov     word ptr ss:DMAADD, dx
DOSCODE:4C60		     mov     word ptr ss:DMAADD+2, ds
DOSCODE:4C65		     retn
DOSCODE:4C66 ; ---------------------------------------------------------------------------
DOSCODE:4C66
DOSCODE:4C66 $GET_DEFAULT_DRIVE:		     ; ...
DOSCODE:4C66		     mov     al, ss:CURDRV
DOSCODE:4C6A		     retn
DOSCODE:4C6B ; ---------------------------------------------------------------------------
DOSCODE:4C6B
DOSCODE:4C6B $SET_DEFAULT_DRIVE:		     ; ...
DOSCODE:4C6B		     mov     al, dl
DOSCODE:4C6D		     inc     al
DOSCODE:4C6F		     call    GetVisDrv
DOSCODE:4C72		     jb	     short SETRET
DOSCODE:4C74		     mov     ss:CURDRV,	al
DOSCODE:4C78
DOSCODE:4C78 SETRET:				     ; ...
DOSCODE:4C78		     mov     al, ss:CDSCOUNT
DOSCODE:4C7C		     retn
DOSCODE:4C7D
DOSCODE:4C7D ; =============== S U B R O U T I N E =======================================
DOSCODE:4C7D
DOSCODE:4C7D
DOSCODE:4C7D $GET_INTERRUPT_VECTOR proc	near	     ; ...
DOSCODE:4C7D		     call    RECSET
DOSCODE:4C80		     les     bx, es:[bx]
DOSCODE:4C83		     call    Get_User_Stack
DOSCODE:4C86		     mov     [si+2], bx	     ; [SI+user_env.user_BX]
DOSCODE:4C89		     mov     word ptr [si+10h],	es ; [SI+user_env.user_ES]
DOSCODE:4C8C		     retn
DOSCODE:4C8C $GET_INTERRUPT_VECTOR endp
DOSCODE:4C8C
DOSCODE:4C8D ; ---------------------------------------------------------------------------
DOSCODE:4C8D
DOSCODE:4C8D $SET_INTERRUPT_VECTOR:		     ; ...
DOSCODE:4C8D		     call    RECSET
DOSCODE:4C90		     cli
DOSCODE:4C91		     mov     es:[bx], dx
DOSCODE:4C94		     mov     word ptr es:[bx+2], ds
DOSCODE:4C98		     sti
DOSCODE:4C99		     test    ss:DOS_FLAG, 4  ; EXECA20OFF
DOSCODE:4C9F		     jnz     short siv_1
DOSCODE:4CA1		     retn
DOSCODE:4CA2 ; ---------------------------------------------------------------------------
DOSCODE:4CA2
DOSCODE:4CA2 siv_1:				     ; ...
DOSCODE:4CA2		     cmp     ss:A20OFF_COUNT, 0
DOSCODE:4CA8		     jnz     short siv_2
DOSCODE:4CAA		     mov     ss:A20OFF_COUNT, 1
DOSCODE:4CB0
DOSCODE:4CB0 siv_2:				     ; ...
DOSCODE:4CB0		     retn
DOSCODE:4CB1
DOSCODE:4CB1 ; =============== S U B R O U T I N E =======================================
DOSCODE:4CB1
DOSCODE:4CB1
DOSCODE:4CB1 RECSET	     proc near		     ; ...
DOSCODE:4CB1		     xor     bx, bx
DOSCODE:4CB3		     mov     es, bx
DOSCODE:4CB5		     mov     bl, al
DOSCODE:4CB7		     shl     bx, 1
DOSCODE:4CB9		     shl     bx, 1
DOSCODE:4CBB		     retn
DOSCODE:4CBB RECSET	     endp
DOSCODE:4CBB
DOSCODE:4CBC ; ---------------------------------------------------------------------------
DOSCODE:4CBC
DOSCODE:4CBC $CHAR_OPER:			     ; ...
DOSCODE:4CBC		     or	     al, al
DOSCODE:4CBE		     mov     dl, '/'
DOSCODE:4CC0		     jz	     short chop_1
DOSCODE:4CC2		     cmp     al, 2
DOSCODE:4CC4		     mov     dl, 0FFh	     ; -1
DOSCODE:4CC6		     jz	     short chop_1
DOSCODE:4CC8		     retn
DOSCODE:4CC9 ; ---------------------------------------------------------------------------
DOSCODE:4CC9
DOSCODE:4CC9 chop_1:				     ; ...
DOSCODE:4CC9		     call    Get_User_Stack
DOSCODE:4CCC		     mov     [si+6], dx	     ; [SI+user_env.user_DX]
DOSCODE:4CCF		     retn
DOSCODE:4CD0 ; ---------------------------------------------------------------------------
DOSCODE:4CD0
DOSCODE:4CD0 $GetExtendedError:			     ; ...
DOSCODE:4CD0		     push    ss
DOSCODE:4CD1		     pop     ds
DOSCODE:4CD2		     mov     ax, ds:EXTERR
DOSCODE:4CD5		     les     di, ds:EXTERRPT
DOSCODE:4CD9		     mov     bx, word ptr ds:EXTERR_ACTION ; BL	= Action
DOSCODE:4CD9					     ; BH = Class
DOSCODE:4CDD		     mov     ch, ds:EXTERR_LOCUS
DOSCODE:4CE1		     call    Get_User_Stack
DOSCODE:4CE4		     mov     [si+0Ah], di    ; [SI+user_env.user_DI]
DOSCODE:4CE7		     mov     word ptr [si+10h],	es ; [SI+user_env.user_ES]
DOSCODE:4CEA		     mov     [si+2], bx	     ; [SI+user_env.user_BX]
DOSCODE:4CED		     mov     [si+4], cx	     ; [SI+user_env.user_CX]
DOSCODE:4CF0
DOSCODE:4CF0 jmp_SYS_RET_OK:			     ; ...
DOSCODE:4CF0		     jmp     SYS_RETURN
DOSCODE:4CF3 ; ---------------------------------------------------------------------------
DOSCODE:4CF3		     push    si
DOSCODE:4CF4		     mov     si, offset	COUNTRY_CDPG
DOSCODE:4CF7		     mov     ax, ss:[si+6Ah] ; [SI+DOS_CCDPG.ccDosCodePage]
DOSCODE:4CFB		     pop     si
DOSCODE:4CFC		     retn
DOSCODE:4CFD ; ---------------------------------------------------------------------------
DOSCODE:4CFD
DOSCODE:4CFD $ECS_Call:				     ; ...
DOSCODE:4CFD		     or	     al, al
DOSCODE:4CFF		     jnz     short _okok
DOSCODE:4D01		     call    Get_User_Stack
DOSCODE:4D04		     mov     word ptr [si+8], (offset DBCS_TAB+2) ;
DOSCODE:4D04					     ; [si+user_env.user_SI]
DOSCODE:4D09		     push    es
DOSCODE:4D0A		     mov     es, cs:DosDSeg
DOSCODE:4D0F		     mov     word ptr [si+0Eh],	es ; [SI+user_env.user_DS]
DOSCODE:4D12		     pop     es
DOSCODE:4D13
DOSCODE:4D13 _okok:				     ; ...
DOSCODE:4D13		     jmp     short jmp_SYS_RET_OK
DOSCODE:4D15 ; ---------------------------------------------------------------------------
DOSCODE:4D15
DOSCODE:4D15 $PARSE_FILE_DESCRIPTOR:		     ; ...
DOSCODE:4D15		     call    MAKEFCB
DOSCODE:4D18		     push    si
DOSCODE:4D19		     call    Get_User_Stack
DOSCODE:4D1C		     pop     word ptr [si+8] ; [SI+user_env.user_SI]
DOSCODE:4D1F		     retn
DOSCODE:4D20 ; ---------------------------------------------------------------------------
DOSCODE:4D20
DOSCODE:4D20 $SLEAZEFUNC:			     ; ...
DOSCODE:4D20		     mov     dl, 0
DOSCODE:4D22
DOSCODE:4D22 $SLEAZEFUNCDL:			     ; ...
DOSCODE:4D22		     push    ss
DOSCODE:4D23		     pop     ds
DOSCODE:4D24		     mov     al, dl
DOSCODE:4D26		     call    GETTHISDRV
DOSCODE:4D29
DOSCODE:4D29 SET_AL_RET:			     ; ...
DOSCODE:4D29		     jb	     short BADSLDRIVE
DOSCODE:4D2B		     call    DISK_INFO
DOSCODE:4D2E		     jb	     short SET_AL_RET
DOSCODE:4D30		     mov     ds:FATBYTE, ah
DOSCODE:4D34		     mov     di, offset	FATBYTE
DOSCODE:4D37		     xor     ah, ah
DOSCODE:4D39		     call    Get_User_Stack
DOSCODE:4D3C		     mov     [si+4], cx	     ; [SI+user_env.user_CX]
DOSCODE:4D3F		     mov     [si+6], bx	     ; [SI+user_env.user_DCX]
DOSCODE:4D42		     mov     [si+2], di	     ; [SI+user_env.user_BX]
DOSCODE:4D45		     mov     word ptr [si+0Eh],	ss ; [SI+user_env.user_DS]
DOSCODE:4D48		     retn
DOSCODE:4D49 ; ---------------------------------------------------------------------------
DOSCODE:4D49
DOSCODE:4D49 BADSLDRIVE:			     ; ...
DOSCODE:4D49		     jmp     FCB_RET_ER
DOSCODE:4D4C ; ---------------------------------------------------------------------------
DOSCODE:4D4C
DOSCODE:4D4C $GET_INDOS_FLAG:			     ; ...
DOSCODE:4D4C		     call    Get_User_Stack
DOSCODE:4D4F		     mov     word ptr [si+2], offset INDOS ; word [SI+user_env.user_BX]
DOSCODE:4D54		     mov     word ptr [si+10h],	ss ; [SI+user_env.user_ES]
DOSCODE:4D57		     retn
DOSCODE:4D58 ; ---------------------------------------------------------------------------
DOSCODE:4D58
DOSCODE:4D58 $GET_IN_VARS:			     ; ...
DOSCODE:4D58		     call    Get_User_Stack
DOSCODE:4D5B		     mov     word ptr [si+2], offset SYSINITVARS ;
DOSCODE:4D5B					     ; [SI+user_env.user_BX]
DOSCODE:4D60		     mov     word ptr [si+10h],	ss ; [SI+user_env.user_ES]
DOSCODE:4D63		     retn
DOSCODE:4D64 ; ---------------------------------------------------------------------------
DOSCODE:4D64
DOSCODE:4D64 $GET_DEFAULT_DPB:			     ; ...
DOSCODE:4D64		     mov     dl, 0
DOSCODE:4D66
DOSCODE:4D66 $GET_DPB:				     ; ...
DOSCODE:4D66		     push    ss
DOSCODE:4D67		     pop     ds
DOSCODE:4D68		     mov     al, dl
DOSCODE:4D6A		     call    GETTHISDRV
DOSCODE:4D6D		     jb	     short ISNODRV
DOSCODE:4D6F		     les     di, ds:THISCDS
DOSCODE:4D73		     test    byte ptr es:[di+44h], 80h ; [ES:DI+curdir.flags+1],
DOSCODE:4D73					     ; (curdir_isnet>>8)
DOSCODE:4D78		     jnz     short ISNODRV
DOSCODE:4D7A		     call    ECritDisk
DOSCODE:4D7D		     call    FATREAD_CDS
DOSCODE:4D80		     call    LCritDisk
DOSCODE:4D83		     jb	     short ISNODRV
DOSCODE:4D85		     call    Get_User_Stack
DOSCODE:4D88		     mov     [si+2], bp	     ; [SI+user_env.user_BX]
DOSCODE:4D8B		     mov     word ptr [si+0Eh],	es ; [SI+user_env.user_DS]
DOSCODE:4D8E		     xor     al, al
DOSCODE:4D90		     retn
DOSCODE:4D91 ; ---------------------------------------------------------------------------
DOSCODE:4D91
DOSCODE:4D91 ISNODRV:				     ; ...
DOSCODE:4D91		     mov     al, 0FFh	     ; -1
DOSCODE:4D93		     retn
DOSCODE:4D94 ; ---------------------------------------------------------------------------
DOSCODE:4D94
DOSCODE:4D94 $DISK_RESET:			     ; ...
DOSCODE:4D94		     mov     al, -1	     ; 0FFh
DOSCODE:4D96		     push    ss
DOSCODE:4D97		     pop     ds
DOSCODE:4D98		     call    ECritDisk
DOSCODE:4D9B		     or	     ds:DOS34_FLAG, 4 ;	FROM_DISK_RESET
DOSCODE:4DA0		     call    FLUSHBUF
DOSCODE:4DA3		     and     ds:DOS34_FLAG, 0FFFBh ; NO_FROM_DISK_RESET
DOSCODE:4DA8		     mov     ds:SC_STATUS, 0
DOSCODE:4DAE		     mov     bx, -1
DOSCODE:4DB1		     mov     word ptr ds:LastBuffer+2, bx
DOSCODE:4DB5		     mov     word ptr ds:LastBuffer, bx
DOSCODE:4DB9		     call    LCritDisk
DOSCODE:4DBC		     mov     ax, -1	     ; 0FFFFh
DOSCODE:4DBF		     push    ax
DOSCODE:4DC0		     mov     ax, 1120h
DOSCODE:4DC3		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	FLUSH ALL DISK BUFFERS
DOSCODE:4DC3					     ; DS = DOS	CS
DOSCODE:4DC3					     ; Return: CF clear	(successful)
DOSCODE:4DC5		     pop     ax
DOSCODE:4DC6		     retn
DOSCODE:4DC6 ; ---------------------------------------------------------------------------
DOSCODE:4DC7 _word_3	     dw	3		     ; ...
DOSCODE:4DC9 ; ---------------------------------------------------------------------------
DOSCODE:4DC9
DOSCODE:4DC9 $SETDPB:				     ; ...
DOSCODE:4DC9		     mov     di, bp
DOSCODE:4DCB		     add     di, 2
DOSCODE:4DCE		     lodsw
DOSCODE:4DCF		     stosw
DOSCODE:4DD0		     cmp     byte ptr [si+3], 0	; [SI+A_BPB.BPB_NUMBEROFFATS-2]
DOSCODE:4DD4		     jnz     short yesfat
DOSCODE:4DD6		     mov     byte ptr es:[di+4], 0 ; [ES:DI+DPB.FAT_COUNT-4]
DOSCODE:4DDB		     jmp     short setend
DOSCODE:4DDD ; ---------------------------------------------------------------------------
DOSCODE:4DDD
DOSCODE:4DDD yesfat:				     ; ...
DOSCODE:4DDD		     mov     dx, ax
DOSCODE:4DDF		     lodsb
DOSCODE:4DE0		     dec     al
DOSCODE:4DE2		     stosb
DOSCODE:4DE3		     inc     al
DOSCODE:4DE5		     xor     ah, ah
DOSCODE:4DE7
DOSCODE:4DE7 LOG2LOOP:				     ; ...
DOSCODE:4DE7		     test    al, 1
DOSCODE:4DE9		     jnz     short SAVLOG
DOSCODE:4DEB		     inc     ah
DOSCODE:4DED		     shr     al, 1
DOSCODE:4DEF		     jmp     short LOG2LOOP
DOSCODE:4DF1 ; ---------------------------------------------------------------------------
DOSCODE:4DF1
DOSCODE:4DF1 SAVLOG:				     ; ...
DOSCODE:4DF1		     mov     al, ah
DOSCODE:4DF3		     stosb
DOSCODE:4DF4		     mov     bl, al
DOSCODE:4DF6		     movsw
DOSCODE:4DF7		     lodsb
DOSCODE:4DF8		     stosb
DOSCODE:4DF9		     mov     bh, al
DOSCODE:4DFB		     lodsw
DOSCODE:4DFC		     stosw
DOSCODE:4DFD		     mov     cl, 5
DOSCODE:4DFF		     shr     dx, cl
DOSCODE:4E01		     dec     ax
DOSCODE:4E02		     add     ax, dx
DOSCODE:4E04		     mov     cx, dx
DOSCODE:4E06		     xor     dx, dx
DOSCODE:4E08		     div     cx
DOSCODE:4E0A		     mov     cx, ax
DOSCODE:4E0C		     inc     di
DOSCODE:4E0D		     inc     di
DOSCODE:4E0E		     movsw
DOSCODE:4E0F		     lodsb
DOSCODE:4E10		     mov     es:[bp+17h], al ; [ES:BP+DPB.MEDIA]
DOSCODE:4E14		     lodsw
DOSCODE:4E15		     stosw
DOSCODE:4E16		     mov     dl, bh
DOSCODE:4E18		     xor     dh, dh
DOSCODE:4E1A		     mul     dx
DOSCODE:4E1C		     add     ax, es:[bp+6]   ; [ES:BP+DPB.FIRST_FAT]
DOSCODE:4E20		     stosw
DOSCODE:4E21		     add     ax, cx
DOSCODE:4E23		     mov     es:[bp+0Bh], ax ; [ES:BP+DPB.FIRST_SECTOR]
DOSCODE:4E27		     mov     cl, bl
DOSCODE:4E29		     cmp     word ptr es:[bp+0Dh], 0
DOSCODE:4E2E		     jnz     short normal_dpb
DOSCODE:4E30		     xor     ch, ch
DOSCODE:4E32		     mov     bx, [si+8]	     ; [SI+A_BPB.BPB_BIGTOTALSECTORS-A_BPB.BPB_SECTORSPERTRACK]
DOSCODE:4E35		     mov     dx, [si+0Ah]    ; [SI+A_BPB.BPB_BIGTOTALSECTORS-A_BPB.BPB_SECTORSPERTRACK+2]
DOSCODE:4E38		     sub     bx, ax
DOSCODE:4E3A		     sbb     dx, 0
DOSCODE:4E3D		     or	     cx, cx
DOSCODE:4E3F		     jz	     short norot
DOSCODE:4E41
DOSCODE:4E41 rott:				     ; ...
DOSCODE:4E41		     clc
DOSCODE:4E42		     rcr     dx, 1
DOSCODE:4E44		     rcr     bx, 1
DOSCODE:4E46		     loop    rott
DOSCODE:4E48
DOSCODE:4E48 norot:				     ; ...
DOSCODE:4E48		     mov     ax, bx
DOSCODE:4E4A		     jmp     short setend
DOSCODE:4E4C ; ---------------------------------------------------------------------------
DOSCODE:4E4C
DOSCODE:4E4C normal_dpb:			     ; ...
DOSCODE:4E4C		     sub     ax, es:[bp+0Dh]
DOSCODE:4E50		     neg     ax
DOSCODE:4E52		     shr     ax, cl
DOSCODE:4E54
DOSCODE:4E54 setend:				     ; ...
DOSCODE:4E54		     inc     ax
DOSCODE:4E55		     mov     bx, ax
DOSCODE:4E57		     mov     ax, es:[bp+0Fh] ; [ES:BP+DPB.FAT_SIZE]
DOSCODE:4E5B		     mul     word ptr es:[bp+2]	; [ES:BP+DPB.SECTOR_SIZE]
DOSCODE:4E5F		     cmp     bx, 0FF6h	     ; 4096-10
DOSCODE:4E63		     jb	     short setend_fat12
DOSCODE:4E65		     shr     dx, 1
DOSCODE:4E67		     rcr     ax, 1
DOSCODE:4E69		     cmp     ax, 0FF7h	     ; 4096-10+1
DOSCODE:4E6C		     jb	     short setend_faterr
DOSCODE:4E6E		     jmp     short setend_fat16
DOSCODE:4E70 ; ---------------------------------------------------------------------------
DOSCODE:4E70
DOSCODE:4E70 setend_fat12:			     ; ...
DOSCODE:4E70		     add     ax, ax
DOSCODE:4E72		     adc     dx, dx
DOSCODE:4E74		     div     cs:_word_3
DOSCODE:4E79
DOSCODE:4E79 setend_fat16:			     ; ...
DOSCODE:4E79		     dec     ax
DOSCODE:4E7A		     cmp     ax, bx
DOSCODE:4E7C		     jbe     short setend_fat
DOSCODE:4E7E
DOSCODE:4E7E setend_faterr:			     ; ...
DOSCODE:4E7E		     mov     ax, bx
DOSCODE:4E80
DOSCODE:4E80 setend_fat:			     ; ...
DOSCODE:4E80		     mov     es:[bp+0Dh], ax ; [ES:BP+DPB.MAX_CLUSTER]
DOSCODE:4E84		     mov     word ptr es:[bp+1Dh], 0 ; [ES:BP+DPB.NEXT_FREE]
DOSCODE:4E8A		     mov     word ptr es:[bp+1Fh], -1 ;	[ES:BP+DPB.FREE_CNT]
DOSCODE:4E90		     retn
DOSCODE:4E91
DOSCODE:4E91 ; =============== S U B R O U T I N E =======================================
DOSCODE:4E91
DOSCODE:4E91
DOSCODE:4E91 $DUP_PDB	     proc near		     ; ...
DOSCODE:4E91		     mov     ds, cs:DosDSeg
DOSCODE:4E96		     mov     ds:CreatePDB, 0FFh
DOSCODE:4E9B		     mov     ds, ds:CurrentPDB
DOSCODE:4E9F		     push    si
DOSCODE:4EA0		     jmp     short CreateCopy
DOSCODE:4EA2 ; ---------------------------------------------------------------------------
DOSCODE:4EA2
DOSCODE:4EA2 $CREATE_PROCESS_DATA_BLOCK:	     ; ...
DOSCODE:4EA2		     call    Get_User_Stack
DOSCODE:4EA5		     mov     ds, word ptr [si+14h] ; [SI+user_env.user_CS]
DOSCODE:4EA8		     push    word ptr ds:2   ; [PDB.BLOCK_LEN]
DOSCODE:4EAC
DOSCODE:4EAC CreateCopy:			     ; ...
DOSCODE:4EAC		     mov     es, dx
DOSCODE:4EAE		     xor     si, si
DOSCODE:4EB0		     mov     di, si
DOSCODE:4EB2		     mov     cx, 128
DOSCODE:4EB5		     rep movsw
DOSCODE:4EB7		     mov     cx, 20	     ; FILPERPROC
DOSCODE:4EBA		     mov     di, 18h	     ; PDB.JFN_TABLE
DOSCODE:4EBD		     push    ds
DOSCODE:4EBE		     lds     si, ds:34h	     ; [PDB.JFN_Pointer]
DOSCODE:4EC2		     rep movsb
DOSCODE:4EC4		     pop     ds
DOSCODE:4EC5		     mov     ds, cs:DosDSeg
DOSCODE:4ECA		     cmp     ds:CreatePDB, 0
DOSCODE:4ECF		     jz	     short Create_PDB_cont
DOSCODE:4ED1		     mov     ds, cs:DosDSeg
DOSCODE:4ED6		     xor     bx, bx
DOSCODE:4ED8		     mov     cx, 20
DOSCODE:4EDB
DOSCODE:4EDB Create_dup_jfn:			     ; ...
DOSCODE:4EDB		     push    es
DOSCODE:4EDC		     call    SFFromHandle
DOSCODE:4EDF		     mov     al, -1	     ; 0FFh
DOSCODE:4EE1		     jb	     short CreateStash
DOSCODE:4EE3		     test    byte ptr es:[di+6], 10h ; [ES:DI+SF_ENTRY.sf_flags+1],
DOSCODE:4EE3					     ; (sf_no_inherit>>8)
DOSCODE:4EE8		     jnz     short CreateStash
DOSCODE:4EEA		     mov     ah, es:[di+2]   ; [ES:DI+SF_ENTRY.sf_mode]
DOSCODE:4EEE		     and     ah, 0F0h	     ; SHARING_MASK
DOSCODE:4EF1		     cmp     ah, 70h	     ; SHARING_NET_FCB
DOSCODE:4EF4		     jz	     short CreateStash
DOSCODE:4EF6		     mov     word ptr ds:THISSFT, di
DOSCODE:4EFA		     mov     word ptr ds:THISSFT+2, es
DOSCODE:4EFE		     call    DOS_DUP
DOSCODE:4F01		     call    pJFNFromHandle
DOSCODE:4F04		     mov     al, es:[di]
DOSCODE:4F07
DOSCODE:4F07 CreateStash:			     ; ...
DOSCODE:4F07		     pop     es
DOSCODE:4F08		     mov     es:[bx+18h], al ; [ES:BX+PDB.JFN_TABLE]
DOSCODE:4F0C		     inc     bx
DOSCODE:4F0D		     loop    Create_dup_jfn
DOSCODE:4F0F		     mov     bx, ds:CurrentPDB
DOSCODE:4F13		     mov     es:16h, bx	     ; [ES:PDB.PARENT_PID]
DOSCODE:4F18		     mov     ds:CurrentPDB, es
DOSCODE:4F1C		     mov     ds, bx
DOSCODE:4F1E
DOSCODE:4F1E Create_PDB_cont:			     ; ...
DOSCODE:4F1E		     push    ds
DOSCODE:4F1F		     mov     ds, cs:DosDSeg
DOSCODE:4F24		     mov     ds:CreatePDB, 0
DOSCODE:4F29		     pop     ds
DOSCODE:4F2A		     pop     ax
DOSCODE:4F2B
DOSCODE:4F2B SETMEM:				     ; ...
DOSCODE:4F2B		     xor     cx, cx
DOSCODE:4F2D		     mov     ds, cx
DOSCODE:4F2F		     mov     es, dx
DOSCODE:4F31		     mov     si, 88h	     ; addr_int_terminate
DOSCODE:4F34		     mov     di, 0Ah	     ; SAVEXIT
DOSCODE:4F37		     mov     cx, 6
DOSCODE:4F3A		     rep movsw
DOSCODE:4F3C		     mov     es:2, ax
DOSCODE:4F40		     sub     ax, dx
DOSCODE:4F42		     cmp     ax, 0FFFh	     ; MAXDIF
DOSCODE:4F45		     jbe     short HAVDIF
DOSCODE:4F47		     mov     ax, 0FFFh
DOSCODE:4F4A
DOSCODE:4F4A HAVDIF:				     ; ...
DOSCODE:4F4A		     sub     ax, 10h
DOSCODE:4F4D		     mov     bx, 0Ch	     ; ENTRYPOINTSEG
DOSCODE:4F50		     sub     bx, ax
DOSCODE:4F52		     mov     cl, 4
DOSCODE:4F54		     shl     ax, cl
DOSCODE:4F56		     mov     ds, dx
DOSCODE:4F58		     mov     ds:6, ax	     ; [PDB.CPM_CALL+1]
DOSCODE:4F5B		     mov     ds:8, bx	     ; [PDB.CPM_CALL+3]
DOSCODE:4F5F		     cmp     ax, 0FEF0h	     ; WRAPOFFSET
DOSCODE:4F62		     jz	     short addr_ok
DOSCODE:4F64		     mov     word ptr ds:6, 0C0h
DOSCODE:4F6A		     mov     word ptr ds:8, 0
DOSCODE:4F70
DOSCODE:4F70 addr_ok:				     ; ...
DOSCODE:4F70		     mov     word ptr ds:0, 20CDh ; [PDB.EXIT_CALL],
DOSCODE:4F70					     ; (int_abort*256) + mi_INT
DOSCODE:4F76		     mov     byte ptr ds:5, 9Ah	; [PDB.CPM_CALL],mi_Long_CALL
DOSCODE:4F7B		     mov     word ptr ds:50h, 21CDh ; [PDB.CALL_SYSTEM],
DOSCODE:4F7B					     ; (int_command*256) + mi_INT
DOSCODE:4F81		     mov     byte ptr ds:52h, 0CBh ; [PDB.CALL_SYSTEM+2],mi_Long_RET
DOSCODE:4F86		     mov     word ptr ds:34h, 18h ; [PDB.JFN_Pointer],PDB.JFN_TABLE
DOSCODE:4F8C		     mov     word ptr ds:36h, ds ; [PDB.JFN_Pointer+2]
DOSCODE:4F90		     mov     word ptr ds:32h, 20 ; [PDB.JFN_Length],FILPERPROC
DOSCODE:4F96		     mov     word ptr ds:38h, 0FFFFh ; [PDB.Next_PDB],-1
DOSCODE:4F9C		     mov     word ptr ds:3Ah, 0FFFFh ; [PDB.Next_PDB+2],-1
DOSCODE:4FA2		     mov     word ptr es:40h, 5	; [ES:PDB.Version],
DOSCODE:4FA2					     ; (MINOR_VERSION*256)+MAJOR_VERSION
DOSCODE:4FA9		     retn
DOSCODE:4FA9 $DUP_PDB	     endp
DOSCODE:4FA9
DOSCODE:4FAA ; ---------------------------------------------------------------------------
DOSCODE:4FAA
DOSCODE:4FAA $GSetMediaID:			     ; ...
DOSCODE:4FAA		     mov     cx, 866h	     ; RAWIO - GET_MEDIA_ID
DOSCODE:4FAD		     cmp     al, 0	     ; get ?
DOSCODE:4FAF		     jz	     short doioctl   ; yes
DOSCODE:4FB1		     cmp     al, 1	     ; set ?
DOSCODE:4FB3		     jnz     short errorfunc ; no, error
DOSCODE:4FB5		     mov     cx, 846h	     ; RAWIO - SET_MEDIA_ID
DOSCODE:4FB8
DOSCODE:4FB8 doioctl:				     ; ...
DOSCODE:4FB8		     mov     al, 0Dh	     ; generic IOCTL
DOSCODE:4FBA		     call    $IOCTL
DOSCODE:4FBD		     retn
DOSCODE:4FBE ; ---------------------------------------------------------------------------
DOSCODE:4FBE
DOSCODE:4FBE errorfunc:				     ; ...
DOSCODE:4FBE		     mov     al, 1	     ; error_invalid_function
DOSCODE:4FC0		     jmp     SYS_RET_ERR
DOSCODE:4FC3
DOSCODE:4FC3 ; =============== S U B R O U T I N E =======================================
DOSCODE:4FC3
DOSCODE:4FC3
DOSCODE:4FC3 StrCmp	     proc near		     ; ...
DOSCODE:4FC3		     push    si
DOSCODE:4FC4		     push    di
DOSCODE:4FC5		     push    ax
DOSCODE:4FC6
DOSCODE:4FC6 Cmplp:				     ; ...
DOSCODE:4FC6		     lodsb
DOSCODE:4FC7		     call    UCase
DOSCODE:4FCA		     call    PATHCHRCMP
DOSCODE:4FCD		     mov     ah, al
DOSCODE:4FCF		     mov     al, es:[di]
DOSCODE:4FD2		     inc     di
DOSCODE:4FD3		     call    UCase
DOSCODE:4FD6		     call    PATHCHRCMP
DOSCODE:4FD9		     cmp     ah, al
DOSCODE:4FDB		     jnz     short PopRet
DOSCODE:4FDD		     or	     al, al
DOSCODE:4FDF		     jnz     short Cmplp
DOSCODE:4FE1
DOSCODE:4FE1 PopRet:				     ; ...
DOSCODE:4FE1		     pop     ax
DOSCODE:4FE2		     pop     di
DOSCODE:4FE3		     pop     si
DOSCODE:4FE4		     retn
DOSCODE:4FE4 StrCmp	     endp
DOSCODE:4FE4
DOSCODE:4FE5
DOSCODE:4FE5 ; =============== S U B R O U T I N E =======================================
DOSCODE:4FE5
DOSCODE:4FE5
DOSCODE:4FE5 StrCpy	     proc near		     ; ...
DOSCODE:4FE5		     push    ax
DOSCODE:4FE6
DOSCODE:4FE6 CPYLoop:				     ; ...
DOSCODE:4FE6		     lodsb
DOSCODE:4FE7		     call    UCase
DOSCODE:4FEA		     call    PATHCHRCMP
DOSCODE:4FED		     stosb
DOSCODE:4FEE		     or	     al, al
DOSCODE:4FF0		     jnz     short CPYLoop
DOSCODE:4FF2		     pop     ax
DOSCODE:4FF3		     retn
DOSCODE:4FF3 StrCpy	     endp
DOSCODE:4FF3
DOSCODE:4FF4
DOSCODE:4FF4 ; =============== S U B R O U T I N E =======================================
DOSCODE:4FF4
DOSCODE:4FF4
DOSCODE:4FF4 FStrCpy	     proc near		     ; ...
DOSCODE:4FF4		     push    ax
DOSCODE:4FF5
DOSCODE:4FF5 FCPYLoop:				     ; ...
DOSCODE:4FF5		     lodsb
DOSCODE:4FF6		     stosb
DOSCODE:4FF7		     or	     al, al
DOSCODE:4FF9		     jnz     short FCPYLoop
DOSCODE:4FFB		     pop     ax
DOSCODE:4FFC		     retn
DOSCODE:4FFC FStrCpy	     endp
DOSCODE:4FFC
DOSCODE:4FFD
DOSCODE:4FFD ; =============== S U B R O U T I N E =======================================
DOSCODE:4FFD
DOSCODE:4FFD
DOSCODE:4FFD StrLen	     proc near		     ; ...
DOSCODE:4FFD		     push    di
DOSCODE:4FFE		     push    ax
DOSCODE:4FFF		     mov     cx, 65535
DOSCODE:5002		     xor     al, al
DOSCODE:5004		     repne scasb
DOSCODE:5006		     not     cx
DOSCODE:5008		     pop     ax
DOSCODE:5009		     pop     di
DOSCODE:500A		     retn
DOSCODE:500A StrLen	     endp
DOSCODE:500A
DOSCODE:500B
DOSCODE:500B ; =============== S U B R O U T I N E =======================================
DOSCODE:500B
DOSCODE:500B
DOSCODE:500B DStrLen	     proc near		     ; ...
DOSCODE:500B		     call    XCHGP
DOSCODE:500E		     call    StrLen
DOSCODE:5011		     call    XCHGP
DOSCODE:5014		     retn
DOSCODE:5014 DStrLen	     endp
DOSCODE:5014
DOSCODE:5015
DOSCODE:5015 ; =============== S U B R O U T I N E =======================================
DOSCODE:5015
DOSCODE:5015
DOSCODE:5015 XCHGP	     proc near		     ; ...
DOSCODE:5015		     push    ds
DOSCODE:5016		     push    es
DOSCODE:5017		     pop     ds
DOSCODE:5018		     pop     es
DOSCODE:5019		     xchg    si, di
DOSCODE:501B
DOSCODE:501B xchgp_retn:			     ; ...
DOSCODE:501B		     retn
DOSCODE:501B XCHGP	     endp
DOSCODE:501B
DOSCODE:501C
DOSCODE:501C ; =============== S U B R O U T I N E =======================================
DOSCODE:501C
DOSCODE:501C
DOSCODE:501C Idle	     proc near		     ; ...
DOSCODE:501C		     cmp     ss:FSHARING, 0
DOSCODE:5022		     jnz     short xchgp_retn
DOSCODE:5024		     push    cx
DOSCODE:5025		     mov     cx, ss:RetryLoop
DOSCODE:502A		     jcxz    short Idle3
DOSCODE:502C
DOSCODE:502C Idle1:				     ; ...
DOSCODE:502C		     push    cx
DOSCODE:502D		     xor     cx, cx
DOSCODE:502F
DOSCODE:502F Idle2:				     ; ...
DOSCODE:502F		     loop    Idle2
DOSCODE:5031		     pop     cx
DOSCODE:5032		     loop    Idle1
DOSCODE:5034
DOSCODE:5034 Idle3:				     ; ...
DOSCODE:5034		     pop     cx
DOSCODE:5035		     retn
DOSCODE:5035 Idle	     endp
DOSCODE:5035
DOSCODE:5036 ; ---------------------------------------------------------------------------
DOSCODE:5036
DOSCODE:5036 TableDispatch:			     ; ...
DOSCODE:5036		     push    bp
DOSCODE:5037		     mov     bp, sp
DOSCODE:5039		     push    bx
DOSCODE:503A		     mov     bx, [bp+6]	     ; [BP+TFrame.Tab]
DOSCODE:503D		     mov     bl, cs:[bx]
DOSCODE:5040		     cmp     [bp+4], bl	     ; [BP+TFrame.Index]
DOSCODE:5043		     jnb     short TableError
DOSCODE:5045		     mov     bl, [bp+4]	     ; [BP+TFrame.Index]
DOSCODE:5048		     xor     bh, bh
DOSCODE:504A		     shl     bx, 1
DOSCODE:504C		     inc     bx
DOSCODE:504D		     add     bx, [bp+6]	     ; [BP+TFrame.Tab]
DOSCODE:5050		     mov     bx, cs:[bx]
DOSCODE:5053		     mov     [bp+6], bx	     ; [BP+TFrame.Tab]
DOSCODE:5056		     pop     bx
DOSCODE:5057		     pop     bp
DOSCODE:5058		     add     sp, 4
DOSCODE:505B		     retn
DOSCODE:505C ; ---------------------------------------------------------------------------
DOSCODE:505C
DOSCODE:505C TableError:			     ; ...
DOSCODE:505C		     pop     bx
DOSCODE:505D		     pop     bp
DOSCODE:505E		     retn    6
DOSCODE:5061
DOSCODE:5061 ; =============== S U B R O U T I N E =======================================
DOSCODE:5061
DOSCODE:5061
DOSCODE:5061 TestNet	     proc near		     ; ...
DOSCODE:5061		     mov     es, cs:DosDSeg
DOSCODE:5066		     les     di, es:THISCDS
DOSCODE:506B		     cmp     di, -1
DOSCODE:506E		     jz	     short CMCRet
DOSCODE:5070		     test    byte ptr es:[di+44h], 80h ; [ES:DI+curdir.flags+1],
DOSCODE:5070					     ; (curdir_isnet>>8)
DOSCODE:5075		     jnz     short CMCRet
DOSCODE:5077		     retn
DOSCODE:5078 ; ---------------------------------------------------------------------------
DOSCODE:5078
DOSCODE:5078 CMCRet:				     ; ...
DOSCODE:5078		     cmc
DOSCODE:5079		     retn
DOSCODE:5079 TestNet	     endp
DOSCODE:5079
DOSCODE:507A
DOSCODE:507A ; =============== S U B R O U T I N E =======================================
DOSCODE:507A
DOSCODE:507A
DOSCODE:507A IsSFTNet	     proc near		     ; ...
DOSCODE:507A		     test    byte ptr es:[di+6], 80h ; [ES:DI+SF_ENTRY.sf_flags+1],
DOSCODE:507A					     ; (sf_isnet>>8)
DOSCODE:507F		     retn
DOSCODE:507F IsSFTNet	     endp
DOSCODE:507F
DOSCODE:5080 ; ---------------------------------------------------------------------------
DOSCODE:5080
DOSCODE:5080 FastInit:				     ; ...
DOSCODE:5080		     push    es
DOSCODE:5081		     mov     es, cs:DosDSeg
DOSCODE:5086		     mov     di, offset	FastOpenTable_2	; FastTable+2
DOSCODE:5089		     dec     bx
DOSCODE:508A		     mov     dx, bx
DOSCODE:508C		     shl     bx, 1
DOSCODE:508E		     shl     bx, 1
DOSCODE:5090		     add     di, bx
DOSCODE:5092		     mov     ax, es:[di+2]
DOSCODE:5096		     mov     cx, cs
DOSCODE:5098		     cmp     ax, cx
DOSCODE:509A		     jz	     short ok_install
DOSCODE:509C		     or	     ax, ax
DOSCODE:509E		     jz	     short ok_install
DOSCODE:50A0		     stc
DOSCODE:50A1		     jmp     short FSret
DOSCODE:50A3 ; ---------------------------------------------------------------------------
DOSCODE:50A3
DOSCODE:50A3 ok_install:			     ; ...
DOSCODE:50A3		     cmp     si, -1
DOSCODE:50A6		     jz	     short FSret
DOSCODE:50A8		     mov     cx, ds
DOSCODE:50AA		     mov     es:[di+2],	cx
DOSCODE:50AE		     mov     es:[di], si
DOSCODE:50B1		     mov     di, offset	FastOpenFlg ; FastFlg
DOSCODE:50B4		     add     di, dx
DOSCODE:50B6		     or	     byte ptr es:[di], 80h ; Fast_yes
DOSCODE:50BA
DOSCODE:50BA FSret:				     ; ...
DOSCODE:50BA		     pop     es
DOSCODE:50BB		     retn
DOSCODE:50BC ; ---------------------------------------------------------------------------
DOSCODE:50BC
DOSCODE:50BC FastRet:				     ; ...
DOSCODE:50BC		     stc
DOSCODE:50BD		     sbb     ax, ax
DOSCODE:50BF		     retf
DOSCODE:50C0 ; ---------------------------------------------------------------------------
DOSCODE:50C0
DOSCODE:50C0 NLS_OPEN:				     ; ...
DOSCODE:50C0		     mov     al, cl
DOSCODE:50C2		     call    $OPEN
DOSCODE:50C5		     retn
DOSCODE:50C6 ; ---------------------------------------------------------------------------
DOSCODE:50C6
DOSCODE:50C6 NLS_LSEEK:				     ; ...
DOSCODE:50C6		     push    ss:USER_SP
DOSCODE:50CB		     push    ss:USER_SS
DOSCODE:50D0		     call    Fake_User_Stack
DOSCODE:50D3		     mov     ax, bp
DOSCODE:50D5		     call    $LSEEK
DOSCODE:50D8		     pop     ss:USER_SS
DOSCODE:50DD		     pop     ss:USER_SP
DOSCODE:50E2		     retn
DOSCODE:50E3
DOSCODE:50E3 ; =============== S U B R O U T I N E =======================================
DOSCODE:50E3
DOSCODE:50E3
DOSCODE:50E3 Fake_User_Stack proc near		     ; ...
DOSCODE:50E3		     mov     ax, ss:USER_SP_2F
DOSCODE:50E7		     mov     ss:USER_SP, ax
DOSCODE:50EB		     mov     ax, ss
DOSCODE:50ED		     mov     ss:USER_SS, ax
DOSCODE:50F1		     retn
DOSCODE:50F1 Fake_User_Stack endp
DOSCODE:50F1
DOSCODE:50F2 ; ---------------------------------------------------------------------------
DOSCODE:50F2
DOSCODE:50F2 GetDevList:			     ; ...
DOSCODE:50F2		     mov     si, offset	SysInitTable
DOSCODE:50F5		     mov     ds, cs:DosDSeg
DOSCODE:50FA		     lds     si, [si]
DOSCODE:50FC		     mov     ax, [si+22h]    ; [SI+SYSI.DEV]
DOSCODE:50FF		     mov     bx, [si+24h]    ; [SI+SYSI.DEV+2]
DOSCODE:5102		     retn
DOSCODE:5103 ; ---------------------------------------------------------------------------
DOSCODE:5103
DOSCODE:5103 NLS_IOCTL:				     ; ...
DOSCODE:5103		     push    ss:USER_SP
DOSCODE:5108		     push    ss:USER_SS
DOSCODE:510D		     call    Fake_User_Stack
DOSCODE:5110		     mov     ax, bp
DOSCODE:5112		     call    $IOCTL
DOSCODE:5115		     pop     ss:USER_SS
DOSCODE:511A		     pop     ss:USER_SP
DOSCODE:511F		     retn
DOSCODE:5120 ; ---------------------------------------------------------------------------
DOSCODE:5120
DOSCODE:5120 NLS_GETEXT:			     ; ...
DOSCODE:5120		     mov     ax, ss:EXTERR
DOSCODE:5124		     retn
DOSCODE:5125 ; ---------------------------------------------------------------------------
DOSCODE:5125
DOSCODE:5125 MSG_RETRIEVAL:			     ; ...
DOSCODE:5125		     retn
DOSCODE:5126
DOSCODE:5126 ; =============== S U B R O U T I N E =======================================
DOSCODE:5126
DOSCODE:5126
DOSCODE:5126 ECritDisk	     proc near		     ; ...
DOSCODE:5126		     pushf		     ; ECritMEM
DOSCODE:5126					     ; ECritSFT
DOSCODE:5127		     cmp     ss:redir_patch, 0
DOSCODE:512D		     jz	     short ECritDisk_2
DOSCODE:512F		     jmp     short ECritDisk_1
DOSCODE:5131 ; ---------------------------------------------------------------------------
DOSCODE:5131
DOSCODE:5131 ECritDisk_iret:			     ; ...
DOSCODE:5131		     iret
DOSCODE:5132 ; ---------------------------------------------------------------------------
DOSCODE:5132
DOSCODE:5132 ECritDisk_1:			     ; ...
DOSCODE:5132		     push    cs
DOSCODE:5133		     call    ECritDisk_iret
DOSCODE:5136
DOSCODE:5136 ECritDisk_0:
DOSCODE:5136		     push    ax
DOSCODE:5137		     mov     ax, 8001h
DOSCODE:513A		     int     2Ah	     ; Microsoft Networks - BEGIN DOS CRITICAL SECTION
DOSCODE:513A					     ; AL = critical section number (00h-0Fh)
DOSCODE:513C		     pop     ax
DOSCODE:513D		     retn
DOSCODE:513E ; ---------------------------------------------------------------------------
DOSCODE:513E
DOSCODE:513E ECritDisk_2:			     ; ...
DOSCODE:513E		     jmp     short ECritDisk_3
DOSCODE:5140 ; ---------------------------------------------------------------------------
DOSCODE:5140
DOSCODE:5140 ECritDisk_iret2:			     ; ...
DOSCODE:5140		     iret
DOSCODE:5141 ; ---------------------------------------------------------------------------
DOSCODE:5141
DOSCODE:5141 ECritDisk_3:			     ; ...
DOSCODE:5141		     push    cs
DOSCODE:5142		     call    ECritDisk_iret2
DOSCODE:5145		     retn
DOSCODE:5145 ECritDisk	     endp
DOSCODE:5145
DOSCODE:5146
DOSCODE:5146 ; =============== S U B R O U T I N E =======================================
DOSCODE:5146
DOSCODE:5146
DOSCODE:5146 LCritDisk	     proc near		     ; ...
DOSCODE:5146		     pushf		     ; LCritMEM
DOSCODE:5146					     ; LCritSFT
DOSCODE:5147		     cmp     ss:redir_patch, 0
DOSCODE:514D		     jz	     short LCritDisk_2
DOSCODE:514F		     jmp     short LCritDisk_1
DOSCODE:5151 ; ---------------------------------------------------------------------------
DOSCODE:5151
DOSCODE:5151 LCritDisk_iret:			     ; ...
DOSCODE:5151		     iret
DOSCODE:5152 ; ---------------------------------------------------------------------------
DOSCODE:5152
DOSCODE:5152 LCritDisk_1:			     ; ...
DOSCODE:5152		     push    cs
DOSCODE:5153		     call    LCritDisk_iret
DOSCODE:5156		     push    ax
DOSCODE:5157		     mov     ax, 8101h
DOSCODE:515A		     int     2Ah	     ; Microsoft Networks - END	DOS CRITICAL SECTION
DOSCODE:515A					     ; AL = critical section number (00h-0Fh)
DOSCODE:515C		     pop     ax
DOSCODE:515D		     retn
DOSCODE:515E ; ---------------------------------------------------------------------------
DOSCODE:515E
DOSCODE:515E LCritDisk_2:			     ; ...
DOSCODE:515E		     jmp     short LCritDisk_3
DOSCODE:5160 ; ---------------------------------------------------------------------------
DOSCODE:5160
DOSCODE:5160 LCritDisk_iret2:			     ; ...
DOSCODE:5160		     iret
DOSCODE:5161 ; ---------------------------------------------------------------------------
DOSCODE:5161
DOSCODE:5161 LCritDisk_3:			     ; ...
DOSCODE:5161		     push    cs
DOSCODE:5162		     call    LCritDisk_iret2
DOSCODE:5165		     retn
DOSCODE:5165 LCritDisk	     endp
DOSCODE:5165
DOSCODE:5166
DOSCODE:5166 ; =============== S U B R O U T I N E =======================================
DOSCODE:5166
DOSCODE:5166
DOSCODE:5166 ECritDevice     proc near		     ; ...
DOSCODE:5166		     pushf
DOSCODE:5167		     cmp     ss:redir_patch, 0
DOSCODE:516D		     jz	     short ECritDevice_2
DOSCODE:516F		     jmp     short ECritDevice_1
DOSCODE:5171 ; ---------------------------------------------------------------------------
DOSCODE:5171
DOSCODE:5171 ECritDevice_iret:			     ; ...
DOSCODE:5171		     iret
DOSCODE:5172 ; ---------------------------------------------------------------------------
DOSCODE:5172
DOSCODE:5172 ECritDevice_1:			     ; ...
DOSCODE:5172		     push    cs
DOSCODE:5173		     call    ECritDevice_iret
DOSCODE:5176		     push    ax
DOSCODE:5177		     mov     ax, 8002h
DOSCODE:517A		     int     2Ah	     ; Microsoft Networks - BEGIN DOS CRITICAL SECTION
DOSCODE:517A					     ; AL = critical section number (00h-0Fh)
DOSCODE:517C		     pop     ax
DOSCODE:517D		     retn
DOSCODE:517E ; ---------------------------------------------------------------------------
DOSCODE:517E
DOSCODE:517E ECritDevice_2:			     ; ...
DOSCODE:517E		     jmp     short ECritDevice_3
DOSCODE:5180 ; ---------------------------------------------------------------------------
DOSCODE:5180
DOSCODE:5180 ECritDevice_iret2:			     ; ...
DOSCODE:5180		     iret
DOSCODE:5181 ; ---------------------------------------------------------------------------
DOSCODE:5181
DOSCODE:5181 ECritDevice_3:			     ; ...
DOSCODE:5181		     push    cs
DOSCODE:5182		     call    ECritDevice_iret2
DOSCODE:5185		     retn
DOSCODE:5185 ECritDevice     endp
DOSCODE:5185
DOSCODE:5186
DOSCODE:5186 ; =============== S U B R O U T I N E =======================================
DOSCODE:5186
DOSCODE:5186
DOSCODE:5186 LCritDevice     proc near		     ; ...
DOSCODE:5186		     pushf		     ; LCritMEM
DOSCODE:5186					     ; LCritSFT
DOSCODE:5187		     cmp     ss:redir_patch, 0
DOSCODE:518D		     jz	     short LCritDevice_2
DOSCODE:518F		     jmp     short LCritDevice_1
DOSCODE:5191 ; ---------------------------------------------------------------------------
DOSCODE:5191
DOSCODE:5191 LCritDevice_iret:			     ; ...
DOSCODE:5191		     iret
DOSCODE:5192 ; ---------------------------------------------------------------------------
DOSCODE:5192
DOSCODE:5192 LCritDevice_1:			     ; ...
DOSCODE:5192		     push    cs
DOSCODE:5193		     call    LCritDevice_iret
DOSCODE:5196		     push    ax
DOSCODE:5197		     mov     ax, 8102h
DOSCODE:519A		     int     2Ah	     ; Microsoft Networks - END	DOS CRITICAL SECTION
DOSCODE:519A					     ; AL = critical section number (00h-0Fh)
DOSCODE:519C		     pop     ax
DOSCODE:519D		     retn
DOSCODE:519E ; ---------------------------------------------------------------------------
DOSCODE:519E
DOSCODE:519E LCritDevice_2:			     ; ...
DOSCODE:519E		     jmp     short LCritDevice_3
DOSCODE:51A0 ; ---------------------------------------------------------------------------
DOSCODE:51A0
DOSCODE:51A0 LCritDevice_iret2:			     ; ...
DOSCODE:51A0		     iret
DOSCODE:51A1 ; ---------------------------------------------------------------------------
DOSCODE:51A1
DOSCODE:51A1 LCritDevice_3:			     ; ...
DOSCODE:51A1		     push    cs
DOSCODE:51A2		     call    LCritDevice_iret2
DOSCODE:51A5		     retn
DOSCODE:51A5 LCritDevice     endp
DOSCODE:51A5
DOSCODE:51A6
DOSCODE:51A6 ; =============== S U B R O U T I N E =======================================
DOSCODE:51A6
DOSCODE:51A6
DOSCODE:51A6 $STD_CON_INPUT_NO_ECHO proc near	     ; ...
DOSCODE:51A6		     push    ds
DOSCODE:51A7		     push    si
DOSCODE:51A8
DOSCODE:51A8 INTEST:				     ; ...
DOSCODE:51A8		     call    STATCHK
DOSCODE:51AB		     jnz     short GET
DOSCODE:51AD		     cmp     ss:PRINTER_FLAG, 0
DOSCODE:51B3		     jnz     short no_sys_wait
DOSCODE:51B5		     mov     ah, 5
DOSCODE:51B7		     call    IOFUNC
DOSCODE:51BA
DOSCODE:51BA no_sys_wait:			     ; ...
DOSCODE:51BA		     mov     ah, 84h
DOSCODE:51BC		     int     2Ah	     ; Microsoft Networks - KEYBOARD BUSY LOOP
DOSCODE:51BE		     cmp     byte ptr ss:DATE_FLAG, 0FFh ; -1
DOSCODE:51C4		     jnz     short NoUpdate
DOSCODE:51C6		     push    ax
DOSCODE:51C7		     push    bx
DOSCODE:51C8		     push    cx
DOSCODE:51C9		     push    dx
DOSCODE:51CA		     push    ds
DOSCODE:51CB		     push    ss
DOSCODE:51CC		     pop     ds
DOSCODE:51CD		     mov     ax, 0
DOSCODE:51D0		     call    Save_Restore_Packet
DOSCODE:51D3		     call    READTIME
DOSCODE:51D6		     mov     ax, 1
DOSCODE:51D9		     call    Save_Restore_Packet
DOSCODE:51DC		     pop     ds
DOSCODE:51DD		     pop     dx
DOSCODE:51DE		     pop     cx
DOSCODE:51DF		     pop     bx
DOSCODE:51E0		     pop     ax
DOSCODE:51E1
DOSCODE:51E1 NoUpdate:				     ; ...
DOSCODE:51E1		     inc     ss:DATE_FLAG
DOSCODE:51E6		     jmp     short INTEST
DOSCODE:51E8 ; ---------------------------------------------------------------------------
DOSCODE:51E8
DOSCODE:51E8 GET:				     ; ...
DOSCODE:51E8		     xor     ah, ah
DOSCODE:51EA		     call    IOFUNC
DOSCODE:51ED		     pop     si
DOSCODE:51EE		     pop     ds
DOSCODE:51EF		     mov     ss:SCAN_FLAG, 0
DOSCODE:51F5		     cmp     al, 0
DOSCODE:51F7		     jnz     short noscan
DOSCODE:51F9		     mov     ss:SCAN_FLAG, 1
DOSCODE:51FF
DOSCODE:51FF noscan:				     ; ...
DOSCODE:51FF		     retn
DOSCODE:51FF $STD_CON_INPUT_NO_ECHO endp
DOSCODE:51FF
DOSCODE:5200 ; ---------------------------------------------------------------------------
DOSCODE:5200
DOSCODE:5200 $STD_CON_STRING_OUTPUT:		     ; ...
DOSCODE:5200		     mov     si, dx
DOSCODE:5202
DOSCODE:5202 STRING_OUT1:			     ; ...
DOSCODE:5202		     lodsb
DOSCODE:5203		     cmp     al, '$'
DOSCODE:5205		     jz	     short noscan
DOSCODE:5207		     call    OUTT
DOSCODE:520A		     jmp     short STRING_OUT1
DOSCODE:520C
DOSCODE:520C ; =============== S U B R O U T I N E =======================================
DOSCODE:520C
DOSCODE:520C
DOSCODE:520C $STD_CON_STRING_INPUT proc	near	     ; ...
DOSCODE:520C
DOSCODE:520C ; FUNCTION	CHUNK AT DOSCODE:4813 SIZE 00000019 BYTES
DOSCODE:520C
DOSCODE:520C		     mov     ax, ss
DOSCODE:520E		     mov     es, ax
DOSCODE:5210		     mov     si, dx
DOSCODE:5212		     xor     ch, ch
DOSCODE:5214		     lodsw
DOSCODE:5215		     or	     al, al
DOSCODE:5217		     jz	     short noscan
DOSCODE:5219		     mov     bl, ah
DOSCODE:521B		     mov     bh, ch
DOSCODE:521D		     cmp     al, bl
DOSCODE:521F		     jbe     short NOEDIT
DOSCODE:5221		     cmp     byte ptr [bx+si], 0Dh ; c_CR
DOSCODE:5224		     jz	     short EDITON
DOSCODE:5226
DOSCODE:5226 NOEDIT:				     ; ...
DOSCODE:5226		     mov     bl, ch
DOSCODE:5228
DOSCODE:5228 EDITON:				     ; ...
DOSCODE:5228		     mov     dl, al
DOSCODE:522A		     dec     dx
DOSCODE:522B
DOSCODE:522B NEWLIN:				     ; ...
DOSCODE:522B		     mov     al, ss:CARPOS
DOSCODE:522F		     mov     ss:STARTPOS, al
DOSCODE:5233		     push    si
DOSCODE:5234		     mov     di, offset	INBUF
DOSCODE:5237		     mov     ss:INSMODE, ch
DOSCODE:523C		     mov     bh, ch
DOSCODE:523E		     mov     dh, ch
DOSCODE:5240		     call    $STD_CON_INPUT_NO_ECHO
DOSCODE:5243		     cmp     al, 0Ah	     ; c_LF
DOSCODE:5245		     jnz     short GOTCH
DOSCODE:5247
DOSCODE:5247 GETCH:				     ; ...
DOSCODE:5247		     call    $STD_CON_INPUT_NO_ECHO
DOSCODE:524A
DOSCODE:524A GOTCH:				     ; ...
DOSCODE:524A		     cmp     al, 6	     ; "F"-"@"
DOSCODE:524C		     jz	     short GETCH
DOSCODE:524E		     cmp     al, cs:ESCCHAR
DOSCODE:5253		     jz	     short ESCAPE
DOSCODE:5255		     cmp     al, 7Fh	     ; c_DEL
DOSCODE:5257		     jz	     short BACKSPJ
DOSCODE:5259		     cmp     al, 8	     ; c_BS
DOSCODE:525B		     jz	     short BACKSPJ
DOSCODE:525D		     cmp     al, 17h	     ; W"-"@"
DOSCODE:525F		     nop
DOSCODE:5260		     nop
DOSCODE:5261		     cmp     al, 15h	     ; "U"-"@"
DOSCODE:5263		     nop
DOSCODE:5264		     nop
DOSCODE:5265		     cmp     al, 0Dh	     ; c_CR
DOSCODE:5267		     jz	     short ENDLIN
DOSCODE:5269		     cmp     al, 0Ah	     ; c_LF
DOSCODE:526B		     jz	     short PHYCRLF
DOSCODE:526D		     cmp     al, cs:CANCHAR  ; 1Bh
DOSCODE:5272		     jz	     short KILNEW
DOSCODE:5274
DOSCODE:5274 SAVCH:				     ; ...
DOSCODE:5274		     cmp     dh, dl
DOSCODE:5276		     jnb     short BUFFUL
DOSCODE:5278		     stosb
DOSCODE:5279		     inc     dh
DOSCODE:527B		     call    BUFOUT
DOSCODE:527E		     cmp     ss:INSMODE, 0
DOSCODE:5284		     jnz     short GETCH
DOSCODE:5286		     cmp     bh, bl
DOSCODE:5288		     jnb     short GETCH
DOSCODE:528A		     inc     si
DOSCODE:528B		     inc     bh
DOSCODE:528D		     jmp     short GETCH
DOSCODE:528F ; ---------------------------------------------------------------------------
DOSCODE:528F
DOSCODE:528F BACKSPJ:				     ; ...
DOSCODE:528F		     jmp     short BACKSP
DOSCODE:5291 ; ---------------------------------------------------------------------------
DOSCODE:5291
DOSCODE:5291 BUFFUL:				     ; ...
DOSCODE:5291		     mov     al, 7
DOSCODE:5293		     call    OUTT
DOSCODE:5296		     jmp     short GETCH
DOSCODE:5298 ; ---------------------------------------------------------------------------
DOSCODE:5298
DOSCODE:5298 ESCAPE:				     ; ...
DOSCODE:5298		     jmp     OEMFunctionKey
DOSCODE:529B ; ---------------------------------------------------------------------------
DOSCODE:529B
DOSCODE:529B ENDLIN:				     ; ...
DOSCODE:529B		     stosb
DOSCODE:529C		     call    OUTT
DOSCODE:529F		     pop     di
DOSCODE:52A0		     mov     [di-1], dh
DOSCODE:52A3		     inc     dh
DOSCODE:52A5
DOSCODE:52A5 COPYNEW:				     ; ...
DOSCODE:52A5		     push    ds
DOSCODE:52A6		     push    es
DOSCODE:52A7		     pop     ds
DOSCODE:52A8		     pop     es
DOSCODE:52A9		     mov     si, offset	INBUF
DOSCODE:52AC		     mov     cl, dh
DOSCODE:52AE		     rep movsb
DOSCODE:52B0
DOSCODE:52B0 OLDBAK_RETN:			     ; ...
DOSCODE:52B0		     retn
DOSCODE:52B1 ; ---------------------------------------------------------------------------
DOSCODE:52B1
DOSCODE:52B1 PHYCRLF:				     ; ...
DOSCODE:52B1		     call    CRLF
DOSCODE:52B4		     jmp     short GETCH
DOSCODE:52B6 ; ---------------------------------------------------------------------------
DOSCODE:52B6
DOSCODE:52B6 LineDel:				     ; ...
DOSCODE:52B6		     or	     dh, dh
DOSCODE:52B8		     jz	     short GETCH
DOSCODE:52BA		     call    BackSpace
DOSCODE:52BD		     jmp     short LineDel
DOSCODE:52BF ; ---------------------------------------------------------------------------
DOSCODE:52BF
DOSCODE:52BF WordDel:				     ; ...
DOSCODE:52BF		     call    BackSpace	     ; WordLoop
DOSCODE:52C2		     or	     dh, dh
DOSCODE:52C4		     jz	     short GetChJ
DOSCODE:52C6		     mov     al, es:[di-1]
DOSCODE:52CA		     cmp     al, '0'
DOSCODE:52CC		     jb	     short GetChJ
DOSCODE:52CE		     cmp     al, '9'
DOSCODE:52D0		     jbe     short WordDel
DOSCODE:52D2		     or	     al, 20h
DOSCODE:52D4		     cmp     al, 'a'
DOSCODE:52D6		     jb	     short GetChJ
DOSCODE:52D8		     cmp     al, 'z'
DOSCODE:52DA		     jbe     short WordDel
DOSCODE:52DC
DOSCODE:52DC GetChJ:				     ; ...
DOSCODE:52DC		     jmp     GETCH
DOSCODE:52DF ; ---------------------------------------------------------------------------
DOSCODE:52DF
DOSCODE:52DF KILNEW:				     ; ...
DOSCODE:52DF		     mov     al, '\'
DOSCODE:52E1		     call    OUTT
DOSCODE:52E4		     pop     si
DOSCODE:52E5
DOSCODE:52E5 PUTNEW:				     ; ...
DOSCODE:52E5		     call    CRLF
DOSCODE:52E8		     mov     al, ss:STARTPOS
DOSCODE:52EC		     call    TAB
DOSCODE:52EF		     jmp     NEWLIN
DOSCODE:52F2 ; ---------------------------------------------------------------------------
DOSCODE:52F2
DOSCODE:52F2 BACKSP:				     ; ...
DOSCODE:52F2		     call    BackSpace
DOSCODE:52F5		     jmp     GETCH
DOSCODE:52F5 $STD_CON_STRING_INPUT endp
DOSCODE:52F5
DOSCODE:52F8
DOSCODE:52F8 ; =============== S U B R O U T I N E =======================================
DOSCODE:52F8
DOSCODE:52F8
DOSCODE:52F8 BackSpace	     proc near		     ; ...
DOSCODE:52F8		     or	     dh, dh
DOSCODE:52FA		     jz	     short OLDBAK
DOSCODE:52FC		     call    BACKUP
DOSCODE:52FF		     mov     al, es:[di]
DOSCODE:5302		     cmp     al, 20h ; ' '
DOSCODE:5304		     jnb     short OLDBAK
DOSCODE:5306		     cmp     al, 9	     ; c_HT
DOSCODE:5308		     jz	     short BAKTAB
DOSCODE:530A		     cmp     al, 15h	     ; "U"-"@"
DOSCODE:530C		     jz	     short OLDBAK
DOSCODE:530E		     cmp     al, 14h	     ; "T"-"@"
DOSCODE:5310		     jz	     short OLDBAK
DOSCODE:5312		     call    BACKMES
DOSCODE:5315
DOSCODE:5315 OLDBAK:				     ; ...
DOSCODE:5315		     cmp     ss:INSMODE, 0
DOSCODE:531B		     jnz     short OLDBAK_RETN
DOSCODE:531D		     or	     bh, bh
DOSCODE:531F		     jz	     short OLDBAK_RETN
DOSCODE:5321		     dec     bh
DOSCODE:5323		     dec     si
DOSCODE:5324		     retn
DOSCODE:5325 ; ---------------------------------------------------------------------------
DOSCODE:5325
DOSCODE:5325 BAKTAB:				     ; ...
DOSCODE:5325		     push    di
DOSCODE:5326		     dec     di
DOSCODE:5327		     std
DOSCODE:5328		     mov     cl, dh
DOSCODE:532A		     mov     al, 20h ; ' '
DOSCODE:532C		     push    bx
DOSCODE:532D		     mov     bl, 7
DOSCODE:532F		     jcxz    short FIGTAB
DOSCODE:5331
DOSCODE:5331 FNDPOS:				     ; ...
DOSCODE:5331		     scasb
DOSCODE:5332		     jbe     short CHKCNT
DOSCODE:5334		     cmp     byte ptr es:[di+1], 9
DOSCODE:5339		     jz	     short HAVTAB
DOSCODE:533B		     dec     bl
DOSCODE:533D
DOSCODE:533D CHKCNT:				     ; ...
DOSCODE:533D		     loop    FNDPOS
DOSCODE:533F
DOSCODE:533F FIGTAB:				     ; ...
DOSCODE:533F		     sub     bl, ss:STARTPOS
DOSCODE:5344
DOSCODE:5344 HAVTAB:				     ; ...
DOSCODE:5344		     sub     bl, dh
DOSCODE:5346		     add     cl, bl
DOSCODE:5348		     and     cl, 7
DOSCODE:534B		     cld
DOSCODE:534C		     pop     bx
DOSCODE:534D		     pop     di
DOSCODE:534E		     jz	     short OLDBAK
DOSCODE:5350
DOSCODE:5350 TABBAK:				     ; ...
DOSCODE:5350		     call    BACKMES
DOSCODE:5353		     loop    TABBAK
DOSCODE:5355		     jmp     short OLDBAK
DOSCODE:5355 BackSpace	     endp
DOSCODE:5355
DOSCODE:5357 ; ---------------------------------------------------------------------------
DOSCODE:5357
DOSCODE:5357 BACKUP:				     ; ...
DOSCODE:5357		     dec     dh
DOSCODE:5359		     dec     di
DOSCODE:535A
DOSCODE:535A BACKMES:				     ; ...
DOSCODE:535A		     mov     al, 8	     ; c_BS
DOSCODE:535C		     call    OUTT
DOSCODE:535F		     mov     al, 20h ; ' '
DOSCODE:5361		     call    OUTT
DOSCODE:5364		     mov     al, 8
DOSCODE:5366		     jmp     OUTT
DOSCODE:5369 ; ---------------------------------------------------------------------------
DOSCODE:5369
DOSCODE:5369 TWOESC:				     ; ...
DOSCODE:5369		     mov     al, cs:ESCCHAR
DOSCODE:536D		     jmp     SAVCH
DOSCODE:5370 ; ---------------------------------------------------------------------------
DOSCODE:5370
DOSCODE:5370 COPYLIN:				     ; ...
DOSCODE:5370		     mov     cl, bl
DOSCODE:5372		     sub     cl, bh
DOSCODE:5374		     jmp     short COPYEACH
DOSCODE:5376 ; ---------------------------------------------------------------------------
DOSCODE:5376
DOSCODE:5376 COPYSTR:				     ; ...
DOSCODE:5376		     call    FINDOLD
DOSCODE:5379		     jmp     short COPYEACH
DOSCODE:537B ; ---------------------------------------------------------------------------
DOSCODE:537B
DOSCODE:537B COPYONE:				     ; ...
DOSCODE:537B		     mov     cl, 1
DOSCODE:537D
DOSCODE:537D COPYEACH:				     ; ...
DOSCODE:537D		     mov     ss:INSMODE, 0
DOSCODE:5383		     cmp     dh, dl
DOSCODE:5385		     jz	     short GETCH2
DOSCODE:5387		     cmp     bh, bl
DOSCODE:5389		     jz	     short GETCH2
DOSCODE:538B		     lodsb
DOSCODE:538C		     stosb
DOSCODE:538D		     call    BUFOUT
DOSCODE:5390		     inc     bh
DOSCODE:5392		     inc     dh
DOSCODE:5394		     loop    COPYEACH
DOSCODE:5396
DOSCODE:5396 GETCH2:				     ; ...
DOSCODE:5396		     jmp     GETCH
DOSCODE:5399 ; ---------------------------------------------------------------------------
DOSCODE:5399
DOSCODE:5399 SKIPONE:				     ; ...
DOSCODE:5399		     cmp     bh, bl
DOSCODE:539B		     jz	     short GETCH2
DOSCODE:539D		     inc     bh
DOSCODE:539F		     inc     si
DOSCODE:53A0		     jmp     GETCH
DOSCODE:53A3 ; ---------------------------------------------------------------------------
DOSCODE:53A3
DOSCODE:53A3 SKIPSTR:				     ; ...
DOSCODE:53A3		     call    FINDOLD
DOSCODE:53A6		     add     si, cx
DOSCODE:53A8		     add     bh, cl
DOSCODE:53AA		     jmp     GETCH
DOSCODE:53AD ; ---------------------------------------------------------------------------
DOSCODE:53AD
DOSCODE:53AD FINDOLD:				     ; ...
DOSCODE:53AD		     call    $STD_CON_INPUT_NO_ECHO
DOSCODE:53B0		     cmp     al, cs:ESCCHAR
DOSCODE:53B5		     jnz     short FINDSETUP
DOSCODE:53B7		     call    $STD_CON_INPUT_NO_ECHO
DOSCODE:53BA		     jmp     short NOTFND
DOSCODE:53BC ; ---------------------------------------------------------------------------
DOSCODE:53BC
DOSCODE:53BC FINDSETUP:				     ; ...
DOSCODE:53BC		     mov     cl, bl
DOSCODE:53BE		     sub     cl, bh
DOSCODE:53C0		     jz	     short NOTFND
DOSCODE:53C2		     dec     cx
DOSCODE:53C3		     jz	     short NOTFND
DOSCODE:53C5		     push    es
DOSCODE:53C6		     push    ds
DOSCODE:53C7		     pop     es
DOSCODE:53C8		     push    di
DOSCODE:53C9		     mov     di, si
DOSCODE:53CB		     inc     di
DOSCODE:53CC		     repne scasb
DOSCODE:53CE		     pop     di
DOSCODE:53CF		     pop     es
DOSCODE:53D0		     jnz     short NOTFND
DOSCODE:53D2		     not     cl
DOSCODE:53D4		     add     cl, bl
DOSCODE:53D6		     sub     cl, bh
DOSCODE:53D8
DOSCODE:53D8 ; =============== S U B R O U T I N E =======================================
DOSCODE:53D8
DOSCODE:53D8
DOSCODE:53D8 FINDOLD_RETN    proc near		     ; ...
DOSCODE:53D8		     retn
DOSCODE:53D8 FINDOLD_RETN    endp
DOSCODE:53D8
DOSCODE:53D9 ; ---------------------------------------------------------------------------
DOSCODE:53D9
DOSCODE:53D9 NOTFND:				     ; ...
DOSCODE:53D9		     pop     bp
DOSCODE:53DA		     jmp     GETCH
DOSCODE:53DD ; ---------------------------------------------------------------------------
DOSCODE:53DD
DOSCODE:53DD REEDIT:				     ; ...
DOSCODE:53DD		     mov     al, '@'
DOSCODE:53DF		     call    OUTT
DOSCODE:53E2		     pop     di
DOSCODE:53E3		     push    di
DOSCODE:53E4		     push    es
DOSCODE:53E5		     push    ds
DOSCODE:53E6		     call    COPYNEW
DOSCODE:53E9		     pop     ds
DOSCODE:53EA		     pop     es
DOSCODE:53EB		     pop     si
DOSCODE:53EC		     mov     bl, dh
DOSCODE:53EE		     jmp     PUTNEW
DOSCODE:53F1 ; ---------------------------------------------------------------------------
DOSCODE:53F1
DOSCODE:53F1 EXITINS:				     ; ...
DOSCODE:53F1		     not     ss:INSMODE	     ; ENTERINS
DOSCODE:53F6		     jmp     GETCH
DOSCODE:53F9 ; ---------------------------------------------------------------------------
DOSCODE:53F9
DOSCODE:53F9 CTRLZ:				     ; ...
DOSCODE:53F9		     mov     al, 1Ah	     ; "Z"-"@"
DOSCODE:53FB		     jmp     SAVCH
DOSCODE:53FE
DOSCODE:53FE ; =============== S U B R O U T I N E =======================================
DOSCODE:53FE
DOSCODE:53FE
DOSCODE:53FE CRLF	     proc near		     ; ...
DOSCODE:53FE		     mov     al, 0Dh	     ; c_CR
DOSCODE:5400		     call    OUTT
DOSCODE:5403		     mov     al, 0Ah	     ; c_LF
DOSCODE:5405		     jmp     OUTT
DOSCODE:5405 CRLF	     endp
DOSCODE:5405
DOSCODE:5408
DOSCODE:5408 ; =============== S U B R O U T I N E =======================================
DOSCODE:5408
DOSCODE:5408
DOSCODE:5408 $RAW_CON_IO     proc near		     ; ...
DOSCODE:5408		     mov     al, dl
DOSCODE:540A		     cmp     al, 0FFh
DOSCODE:540C		     jz	     short rci1
DOSCODE:540E		     jmp     short RAWOUT
DOSCODE:5410 ; ---------------------------------------------------------------------------
DOSCODE:5410		     nop		     ; db 90h ;	align 2
DOSCODE:5411
DOSCODE:5411 rci1:				     ; ...
DOSCODE:5411		     les     di, dword ptr ss:USER_SP
DOSCODE:5416		     xor     bx, bx
DOSCODE:5418		     call    GET_IO_SFT
DOSCODE:541B		     jb	     short FINDOLD_RETN
DOSCODE:541D		     mov     ah, 1
DOSCODE:541F		     call    IOFUNC
DOSCODE:5422		     jnz     short RESFLG
DOSCODE:5424		     call    SPOOLINT
DOSCODE:5427		     or	     byte ptr es:[di+16h], 40h ; [ES:DI+user_env.user_F]
DOSCODE:542C		     xor     al, al
DOSCODE:542E
DOSCODE:542E RET17:				     ; ...
DOSCODE:542E		     retn
DOSCODE:542F ; ---------------------------------------------------------------------------
DOSCODE:542F
DOSCODE:542F RESFLG:				     ; ...
DOSCODE:542F		     and     byte ptr es:[di+16h], 0BFh
DOSCODE:5434
DOSCODE:5434 rci0:				     ; ...
DOSCODE:5434		     call    SPOOLINT
DOSCODE:5437
DOSCODE:5437 $RAW_CON_INPUT:			     ; ...
DOSCODE:5437		     push    bx
DOSCODE:5438		     xor     bx, bx
DOSCODE:543A		     call    GET_IO_SFT
DOSCODE:543D		     pop     bx
DOSCODE:543E		     jb	     short RET17
DOSCODE:5440		     mov     ah, 1
DOSCODE:5442		     call    IOFUNC
DOSCODE:5445		     jnz     short rci5
DOSCODE:5447		     mov     ah, 84h
DOSCODE:5449		     int     2Ah	     ; Microsoft Networks - KEYBOARD BUSY LOOP
DOSCODE:544B		     jmp     short rci0
DOSCODE:544D ; ---------------------------------------------------------------------------
DOSCODE:544D
DOSCODE:544D rci5:				     ; ...
DOSCODE:544D		     xor     ah, ah
DOSCODE:544F		     call    IOFUNC
DOSCODE:5452		     retn
DOSCODE:5452 $RAW_CON_IO     endp
DOSCODE:5452
DOSCODE:5453
DOSCODE:5453 ; =============== S U B R O U T I N E =======================================
DOSCODE:5453
DOSCODE:5453
DOSCODE:5453 RAWOUT	     proc near		     ; ...
DOSCODE:5453		     push    bx
DOSCODE:5454		     mov     bx, 1
DOSCODE:5457		     call    GET_IO_SFT
DOSCODE:545A		     jb	     short RAWRET1
DOSCODE:545C		     mov     bx, [si+5]	     ; [SI+SF_ENTRY.sf_flags]
DOSCODE:545F		     and     bx, 8080h	     ; sf_isnet+devid_device
DOSCODE:5463		     cmp     bx, 80h
DOSCODE:5467		     jnz     short RAWNORM
DOSCODE:5469		     push    ds
DOSCODE:546A		     lds     bx, [si+7]	     ; [SI+SF_ENTRY.sf_devptr]
DOSCODE:546D		     test    byte ptr [bx+4], 10h ; [BX+SYSDEV.ATT],
DOSCODE:546D					     ; ISSPEC
DOSCODE:5471		     pop     ds
DOSCODE:5472		     jz	     short RAWNORM
DOSCODE:5474		     int     29h	     ; DOS 2+ internal - FAST PUTCHAR
DOSCODE:5474					     ; AL = character to display
DOSCODE:5476
DOSCODE:5476 RAWRET:				     ; ...
DOSCODE:5476		     clc
DOSCODE:5477
DOSCODE:5477 RAWRET1:				     ; ...
DOSCODE:5477		     pop     bx
DOSCODE:5478
DOSCODE:5478 RAWRET2:				     ; ...
DOSCODE:5478		     retn
DOSCODE:5479 ; ---------------------------------------------------------------------------
DOSCODE:5479
DOSCODE:5479 RAWNORM:				     ; ...
DOSCODE:5479		     call    RAWOUT3
DOSCODE:547C		     jmp     short RAWRET
DOSCODE:547C RAWOUT	     endp
DOSCODE:547C
DOSCODE:547E ; ---------------------------------------------------------------------------
DOSCODE:547E
DOSCODE:547E RAWOUT2:				     ; ...
DOSCODE:547E		     call    GET_IO_SFT
DOSCODE:5481		     jb	     short RAWRET2
DOSCODE:5483
DOSCODE:5483 ; =============== S U B R O U T I N E =======================================
DOSCODE:5483
DOSCODE:5483
DOSCODE:5483 RAWOUT3	     proc near		     ; ...
DOSCODE:5483		     push    ax
DOSCODE:5484		     jmp     short RAWOSTRTRAWOSTRT
DOSCODE:5486 ; ---------------------------------------------------------------------------
DOSCODE:5486
DOSCODE:5486 ROLP:				     ; ...
DOSCODE:5486		     call    SPOOLINT
DOSCODE:5489		     or	     ss:DOS34_FLAG, 200h ; CTRL_BREAK_FLAG
DOSCODE:5490		     call    DSKSTATCHK
DOSCODE:5493
DOSCODE:5493 RAWOSTRTRAWOSTRT:			     ; ...
DOSCODE:5493		     mov     ah, 3
DOSCODE:5495		     call    IOFUNC
DOSCODE:5498		     jz	     short ROLP
DOSCODE:549A		     inc     ax
DOSCODE:549B		     pop     ax
DOSCODE:549C		     jz	     short nosend
DOSCODE:549E		     mov     ah, 2
DOSCODE:54A0		     call    IOFUNC
DOSCODE:54A3
DOSCODE:54A3 nosend:				     ; ...
DOSCODE:54A3		     clc
DOSCODE:54A4		     retn
DOSCODE:54A4 RAWOUT3	     endp
DOSCODE:54A4
DOSCODE:54A5
DOSCODE:54A5 ; =============== S U B R O U T I N E =======================================
DOSCODE:54A5
DOSCODE:54A5
DOSCODE:54A5 Save_Restore_Packet proc near	     ; ...
DOSCODE:54A5		     push    ds
DOSCODE:54A6		     push    es
DOSCODE:54A7		     push    si
DOSCODE:54A8		     push    di
DOSCODE:54A9		     cmp     ax, 0
DOSCODE:54AC		     jz	     short save_packet
DOSCODE:54AE		     mov     si, offset	FAKE_STACK_2F
DOSCODE:54B1		     mov     di, offset	DEVCALL
DOSCODE:54B4		     jmp     short set_seg
DOSCODE:54B6 ; ---------------------------------------------------------------------------
DOSCODE:54B6
DOSCODE:54B6 save_packet:			     ; ...
DOSCODE:54B6		     mov     di, offset	FAKE_STACK_2F
DOSCODE:54B9		     mov     si, offset	DEVCALL
DOSCODE:54BC
DOSCODE:54BC set_seg:				     ; ...
DOSCODE:54BC		     mov     ax, ss
DOSCODE:54BE		     mov     ds, ax
DOSCODE:54C0		     mov     es, ax
DOSCODE:54C2		     mov     cx, 11
DOSCODE:54C5		     rep movsw
DOSCODE:54C7		     pop     di
DOSCODE:54C8		     pop     si
DOSCODE:54C9		     pop     es
DOSCODE:54CA		     pop     ds
DOSCODE:54CB		     retn
DOSCODE:54CB Save_Restore_Packet endp
DOSCODE:54CB
DOSCODE:54CC
DOSCODE:54CC ; =============== S U B R O U T I N E =======================================
DOSCODE:54CC
DOSCODE:54CC
DOSCODE:54CC $STD_CON_INPUT  proc near		     ; ...
DOSCODE:54CC		     call    $STD_CON_INPUT_NO_ECHO
DOSCODE:54CF		     push    ax
DOSCODE:54D0		     call    OUTT
DOSCODE:54D3		     pop     ax
DOSCODE:54D4
DOSCODE:54D4 CON_INPUT_RETN:			     ; ...
DOSCODE:54D4		     retn
DOSCODE:54D4 $STD_CON_INPUT  endp
DOSCODE:54D4
DOSCODE:54D5 ; ---------------------------------------------------------------------------
DOSCODE:54D5
DOSCODE:54D5 $STD_CON_OUTPUT:			     ; ...
DOSCODE:54D5		     mov     al, dl
DOSCODE:54D7
DOSCODE:54D7 OUTT:				     ; ...
DOSCODE:54D7		     cmp     al, 20h ; ' '
DOSCODE:54D9		     jb	     short CTRLOUT
DOSCODE:54DB		     cmp     al, 7Fh	     ; c_DEL ; 127
DOSCODE:54DD		     jz	     short OUTCH
DOSCODE:54DF
DOSCODE:54DF OUTCHA:
DOSCODE:54DF		     inc     ss:CARPOS
DOSCODE:54E4
DOSCODE:54E4 OUTCH:				     ; ...
DOSCODE:54E4		     push    ds
DOSCODE:54E5		     push    si
DOSCODE:54E6		     inc     ss:CHARCO
DOSCODE:54EB		     and     ss:CHARCO,	3Fh  ; 00111111b
DOSCODE:54F1		     jnz     short OUTSKIP
DOSCODE:54F3		     push    ax
DOSCODE:54F4		     call    STATCHK
DOSCODE:54F7		     pop     ax
DOSCODE:54F8
DOSCODE:54F8 OUTSKIP:				     ; ...
DOSCODE:54F8		     call    RAWOUT
DOSCODE:54FB		     pop     si
DOSCODE:54FC		     pop     ds
DOSCODE:54FD		     test    ss:PFLAG, 0FFh  ; -1
DOSCODE:5503		     jz	     short CON_INPUT_RETN
DOSCODE:5505		     push    bx
DOSCODE:5506		     push    ds
DOSCODE:5507		     push    si
DOSCODE:5508		     mov     bx, 1
DOSCODE:550B		     call    GET_IO_SFT
DOSCODE:550E		     jb	     short TRIPOPJ
DOSCODE:5510		     mov     bx, [si+5]	     ; [SI+SF_ENTRY.sf_flags]
DOSCODE:5513		     test    bh, 80h	     ; (sf_isnet>>8)
DOSCODE:5516		     jnz     short TRIPOPJ
DOSCODE:5518		     test    bl, 80h	     ; devid_device
DOSCODE:551B		     jz	     short TRIPOPJ
DOSCODE:551D		     mov     bx, 4
DOSCODE:5520		     call    GET_IO_SFT
DOSCODE:5523		     jb	     short TRIPOPJ
DOSCODE:5525		     test    byte ptr [si+6], 8	; [SI+SF_ENTRY.sf_flags+1],
DOSCODE:5525					     ; (sf_net_spool>>8)
DOSCODE:5529		     jz	     short LISSTRT2J
DOSCODE:552B		     mov     ss:PFLAG, 0
DOSCODE:5531
DOSCODE:5531 TRIPOPJ:				     ; ...
DOSCODE:5531		     jmp     TRIPOP
DOSCODE:5534 ; ---------------------------------------------------------------------------
DOSCODE:5534
DOSCODE:5534 LISSTRT2J:				     ; ...
DOSCODE:5534		     jmp     LISSTRT2
DOSCODE:5537 ; ---------------------------------------------------------------------------
DOSCODE:5537
DOSCODE:5537 CTRLOUT:				     ; ...
DOSCODE:5537		     cmp     al, 0Dh	     ; c_CR
DOSCODE:5539		     jz	     short ZERPOS
DOSCODE:553B		     cmp     al, 8	     ; c_BS
DOSCODE:553D		     jz	     short BACKPOS
DOSCODE:553F		     cmp     al, 9	     ; c_HT
DOSCODE:5541		     jnz     short OUTCH
DOSCODE:5543		     mov     al, ss:CARPOS
DOSCODE:5547		     or	     al, 0F8h
DOSCODE:5549		     neg     al
DOSCODE:554B
DOSCODE:554B TAB:				     ; ...
DOSCODE:554B		     push    cx
DOSCODE:554C		     mov     cl, al
DOSCODE:554E		     mov     ch, 0
DOSCODE:5550		     jcxz    short POPTAB
DOSCODE:5552
DOSCODE:5552 TABLP:				     ; ...
DOSCODE:5552		     mov     al, 20h ; ' '
DOSCODE:5554		     call    OUTT
DOSCODE:5557		     loop    TABLP
DOSCODE:5559
DOSCODE:5559 POPTAB:				     ; ...
DOSCODE:5559		     pop     cx
DOSCODE:555A		     retn
DOSCODE:555B ; ---------------------------------------------------------------------------
DOSCODE:555B
DOSCODE:555B ZERPOS:				     ; ...
DOSCODE:555B		     mov     ss:CARPOS,	0
DOSCODE:5561		     jmp     short OUTCH
DOSCODE:5563 ; ---------------------------------------------------------------------------
DOSCODE:5563
DOSCODE:5563 OUTJ:				     ; ...
DOSCODE:5563		     jmp     OUTT
DOSCODE:5566 ; ---------------------------------------------------------------------------
DOSCODE:5566
DOSCODE:5566 BACKPOS:				     ; ...
DOSCODE:5566		     dec     ss:CARPOS
DOSCODE:556B		     jmp     OUTCH
DOSCODE:556E
DOSCODE:556E ; =============== S U B R O U T I N E =======================================
DOSCODE:556E
DOSCODE:556E
DOSCODE:556E BUFOUT	     proc near		     ; ...
DOSCODE:556E		     cmp     al, 20h ; ' '
DOSCODE:5570		     jnb     short OUTJ
DOSCODE:5572		     cmp     al, 9
DOSCODE:5574		     jz	     short OUTJ
DOSCODE:5576		     cmp     al, 15h	     ; "U"-"@"
DOSCODE:5578		     jz	     short CTRLU
DOSCODE:557A		     cmp     al, 14h	     ; "T"-"@"
DOSCODE:557C		     jz	     short CTRLU
DOSCODE:557E
DOSCODE:557E NOT_CTRLU:
DOSCODE:557E		     push    ax
DOSCODE:557F		     mov     al, '^'
DOSCODE:5581		     call    OUTT
DOSCODE:5584		     pop     ax
DOSCODE:5585		     or	     al, 40h
DOSCODE:5587
DOSCODE:5587 CTRLU:				     ; ...
DOSCODE:5587		     call    OUTT
DOSCODE:558A
DOSCODE:558A BUFOUT_RETN:			     ; ...
DOSCODE:558A		     retn
DOSCODE:558A BUFOUT	     endp
DOSCODE:558A
DOSCODE:558B ; ---------------------------------------------------------------------------
DOSCODE:558B
DOSCODE:558B $STD_AUX_INPUT:			     ; ...
DOSCODE:558B		     call    STATCHK
DOSCODE:558E		     mov     bx, 3
DOSCODE:5591		     call    GET_IO_SFT
DOSCODE:5594		     jb	     short BUFOUT_RETN
DOSCODE:5596		     jmp     short TAISTRT
DOSCODE:5598 ; ---------------------------------------------------------------------------
DOSCODE:5598
DOSCODE:5598 AUXILP:				     ; ...
DOSCODE:5598		     call    SPOOLINT
DOSCODE:559B
DOSCODE:559B TAISTRT:				     ; ...
DOSCODE:559B		     mov     ah, 1
DOSCODE:559D		     call    IOFUNC
DOSCODE:55A0		     jz	     short AUXILP
DOSCODE:55A2		     xor     ah, ah
DOSCODE:55A4		     call    IOFUNC
DOSCODE:55A7		     retn
DOSCODE:55A8 ; ---------------------------------------------------------------------------
DOSCODE:55A8
DOSCODE:55A8 $STD_AUX_OUTPUT:			     ; ...
DOSCODE:55A8		     push    bx
DOSCODE:55A9		     mov     bx, 3
DOSCODE:55AC		     jmp     short SENDOUT
DOSCODE:55AE ; ---------------------------------------------------------------------------
DOSCODE:55AE
DOSCODE:55AE $STD_PRINTER_OUTPUT:		     ; ...
DOSCODE:55AE		     push    bx
DOSCODE:55AF		     mov     bx, 4
DOSCODE:55B2
DOSCODE:55B2 SENDOUT:				     ; ...
DOSCODE:55B2		     mov     al, dl
DOSCODE:55B4		     push    ax
DOSCODE:55B5		     call    STATCHK
DOSCODE:55B8		     pop     ax
DOSCODE:55B9		     push    ds
DOSCODE:55BA		     push    si
DOSCODE:55BB
DOSCODE:55BB LISSTRT2:				     ; ...
DOSCODE:55BB		     call    RAWOUT2
DOSCODE:55BE
DOSCODE:55BE TRIPOP:				     ; ...
DOSCODE:55BE		     pop     si
DOSCODE:55BF		     pop     ds
DOSCODE:55C0		     pop     bx
DOSCODE:55C1
DOSCODE:55C1 SCIS_RETN:				     ; ...
DOSCODE:55C1		     retn
DOSCODE:55C2 ; ---------------------------------------------------------------------------
DOSCODE:55C2
DOSCODE:55C2 $STD_CON_INPUT_STATUS:		     ; ...
DOSCODE:55C2		     call    STATCHK
DOSCODE:55C5		     mov     al, 0
DOSCODE:55C7		     jz	     short SCIS_RETN
DOSCODE:55C9		     or	     al, 0FFh	     ; -1
DOSCODE:55CB		     retn
DOSCODE:55CC ; ---------------------------------------------------------------------------
DOSCODE:55CC
DOSCODE:55CC $STD_CON_INPUT_FLUSH:		     ; ...
DOSCODE:55CC		     push    ax
DOSCODE:55CD		     push    dx
DOSCODE:55CE		     xor     bx, bx
DOSCODE:55D0		     call    GET_IO_SFT
DOSCODE:55D3		     jb	     short BADJFNCON
DOSCODE:55D5		     mov     ah, 4
DOSCODE:55D7		     call    IOFUNC
DOSCODE:55DA
DOSCODE:55DA BADJFNCON:				     ; ...
DOSCODE:55DA		     pop     dx
DOSCODE:55DB		     pop     ax
DOSCODE:55DC		     mov     ah, al
DOSCODE:55DE		     cmp     al, 1
DOSCODE:55E0		     jz	     short REDISPJ
DOSCODE:55E2		     cmp     al, 6
DOSCODE:55E4		     jz	     short REDISPJ
DOSCODE:55E6		     cmp     al, 7
DOSCODE:55E8		     jz	     short REDISPJ
DOSCODE:55EA		     cmp     al, 8
DOSCODE:55EC		     jz	     short REDISPJ
DOSCODE:55EE		     cmp     al, 10
DOSCODE:55F0		     jz	     short REDISPJ
DOSCODE:55F2		     mov     al, 0
DOSCODE:55F4		     retn
DOSCODE:55F5 ; ---------------------------------------------------------------------------
DOSCODE:55F5
DOSCODE:55F5 REDISPJ:				     ; ...
DOSCODE:55F5		     cli
DOSCODE:55F6		     jmp     REDISP
DOSCODE:55F9 ; ---------------------------------------------------------------------------
DOSCODE:55F9
DOSCODE:55F9 $GET_FCB_POSITION:			     ; ...
DOSCODE:55F9		     call    GetExtended
DOSCODE:55FC		     call    GetExtent
DOSCODE:55FF		     mov     [si+21h], ax    ; [SI+SYS_FCB.RR]
DOSCODE:5602		     mov     [si+23h], dl    ; [SI+SYS_FCB.RR+2]
DOSCODE:5605		     cmp     word ptr [si+0Eh],	64 ; [SI+SYS_FCB.RECSIZ]
DOSCODE:5609		     jnb     short GetFCBBye
DOSCODE:560B		     mov     [si+24h], dh    ; [SI+SYS_FCB.RR+2+1]
DOSCODE:560E
DOSCODE:560E GetFCBBye:				     ; ...
DOSCODE:560E		     jmp     NO_OP
DOSCODE:5611 ; ---------------------------------------------------------------------------
DOSCODE:5611
DOSCODE:5611 $FCB_DELETE:			     ; ...
DOSCODE:5611		     mov     di, offset	OPENBUF
DOSCODE:5614		     call    TransFCB
DOSCODE:5617		     jb	     short BadPath
DOSCODE:5619		     push    ss
DOSCODE:561A		     pop     ds
DOSCODE:561B		     call    DOS_DELETE
DOSCODE:561E		     jb	     short BadPath
DOSCODE:5620
DOSCODE:5620 GoodPath:				     ; ...
DOSCODE:5620		     jmp     short GetFCBBye
DOSCODE:5622 ; ---------------------------------------------------------------------------
DOSCODE:5622
DOSCODE:5622 BadPath:				     ; ...
DOSCODE:5622		     jmp     FCB_RET_ER
DOSCODE:5625 ; ---------------------------------------------------------------------------
DOSCODE:5625
DOSCODE:5625 $GET_FCB_FILE_LENGTH:		     ; ...
DOSCODE:5625		     call    GetExtended
DOSCODE:5628		     mov     di, offset	OPENBUF
DOSCODE:562B		     push    ds
DOSCODE:562C		     push    si
DOSCODE:562D		     call    TransFCB
DOSCODE:5630		     pop     si
DOSCODE:5631		     pop     ds
DOSCODE:5632		     jb	     short BadPath
DOSCODE:5634		     push    ds
DOSCODE:5635		     push    si
DOSCODE:5636		     push    ss
DOSCODE:5637		     pop     ds
DOSCODE:5638		     call    GET_FILE_INFO
DOSCODE:563B		     pop     si
DOSCODE:563C		     pop     ds
DOSCODE:563D		     jb	     short BadPath
DOSCODE:563F		     mov     dx, bx
DOSCODE:5641		     mov     ax, di
DOSCODE:5643		     mov     bx, [si+0Eh]    ; [SI+SYS_FCB.RECSIZ]
DOSCODE:5646		     or	     bx, bx
DOSCODE:5648		     jnz     short GetSize
DOSCODE:564A		     mov     bx, 128
DOSCODE:564D
DOSCODE:564D GetSize:				     ; ...
DOSCODE:564D		     mov     di, ax
DOSCODE:564F		     mov     ax, dx
DOSCODE:5651		     xor     dx, dx
DOSCODE:5653		     div     bx
DOSCODE:5655		     push    ax
DOSCODE:5656		     mov     ax, di
DOSCODE:5658		     div     bx
DOSCODE:565A		     mov     cx, dx
DOSCODE:565C		     pop     dx
DOSCODE:565D		     jcxz    short LengthStore
DOSCODE:565F		     add     ax, 1
DOSCODE:5662		     adc     dx, 0
DOSCODE:5665
DOSCODE:5665 LengthStore:			     ; ...
DOSCODE:5665		     mov     [si+21h], ax    ; [SI+SYS_FCB.RR]
DOSCODE:5668		     mov     [si+23h], dl    ; [SI+SYS_FCB.RR+2]
DOSCODE:566B		     or	     dh, dh
DOSCODE:566D		     jz	     short GoodPath
DOSCODE:566F		     mov     [si+24h], dh    ; [SI+SYS_FCB.RR+3]
DOSCODE:5672
DOSCODE:5672 GoodRet:				     ; ...
DOSCODE:5672		     jmp     short GoodPath
DOSCODE:5674 ; ---------------------------------------------------------------------------
DOSCODE:5674
DOSCODE:5674 $FCB_CLOSE:			     ; ...
DOSCODE:5674		     xor     al, al
DOSCODE:5676		     call    GetExtended
DOSCODE:5679		     jz	     short NoAttr
DOSCODE:567B		     mov     al, [si-1]
DOSCODE:567E
DOSCODE:567E NoAttr:				     ; ...
DOSCODE:567E		     mov     ss:ATTRIB,	al
DOSCODE:5682		     call    SFTFromFCB
DOSCODE:5685		     jb	     short GoodRet
DOSCODE:5687		     mov     al, es:[di+4]   ; [ES:DI+SF_ENTRY.sf_attr]
DOSCODE:568B		     xor     ah, ah
DOSCODE:568D		     push    ax
DOSCODE:568E		     call    CheckShare
DOSCODE:5691		     jnz     short NoStash
DOSCODE:5693		     mov     al, ss:ATTRIB
DOSCODE:5697		     mov     es:[di+4],	al   ; [ES:DI+SF_ENTRY.sf_attr]
DOSCODE:569B
DOSCODE:569B NoStash:				     ; ...
DOSCODE:569B		     mov     ax, [si+14h]    ; [SI+SYS_FCB.FDATE]
DOSCODE:569E		     mov     es:[di+0Fh], ax ; [ES:DI+SF_ENTRY.sf_date]
DOSCODE:56A2		     mov     ax, [si+16h]    ; [SI+SYS_FCB.FTIME]
DOSCODE:56A5		     mov     es:[di+0Dh], ax ; [ES:DI+SF_ENTRY.sf_time]
DOSCODE:56A9		     mov     ax, [si+10h]    ; [SI+SYS_FCB.FILSIZ]
DOSCODE:56AC		     mov     es:[di+11h], ax ; [ES:DI+SF_ENTRY.sf_size]
DOSCODE:56B0		     mov     ax, [si+12h]    ; [SI+SYS_FCB.FILSIZ+2]
DOSCODE:56B3		     mov     es:[di+13h], ax ; [ES:DI+SF_ENTRY.sf_size+2]
DOSCODE:56B7		     or	     word ptr es:[di+5], 4000h ; [ES:DI+SF_ENTRY.sf_flags],
DOSCODE:56B7					     ; sf_close_nodate
DOSCODE:56BD		     push    ss
DOSCODE:56BE		     pop     ds
DOSCODE:56BF		     call    DOS_CLOSE
DOSCODE:56C2		     les     di, ds:THISSFT
DOSCODE:56C6		     pop     cx
DOSCODE:56C7		     mov     es:[di+4],	cl   ; [ES:DI+SF_ENTRY.sf_attr]
DOSCODE:56CB		     pushf
DOSCODE:56CC		     cmp     word ptr es:[di], 0 ; [ES:DI+SF_ENTRY.sf_ref_count]
DOSCODE:56D0		     jnz     short CloseOK
DOSCODE:56D2		     push    ax
DOSCODE:56D3		     mov     al, 'M'         ; 4Dh
DOSCODE:56D5		     call    BlastSFT
DOSCODE:56D8		     pop     ax
DOSCODE:56D9
DOSCODE:56D9 CloseOK:				     ; ...
DOSCODE:56D9		     popf
DOSCODE:56DA		     jnb     short GoodRet
DOSCODE:56DC		     cmp     al, 6	     ; error_invalid_handle
DOSCODE:56DE		     jz	     short GoodRet
DOSCODE:56E0		     mov     al, 2	     ; error_file_not_found
DOSCODE:56E2
DOSCODE:56E2 fcb_close_err:			     ; ...
DOSCODE:56E2		     jmp     FCB_RET_ER
DOSCODE:56E5 ; ---------------------------------------------------------------------------
DOSCODE:56E5
DOSCODE:56E5 $FCB_RENAME:			     ; ...
DOSCODE:56E5		     call    GetExtended
DOSCODE:56E8		     push    dx
DOSCODE:56E9		     mov     al, [si]
DOSCODE:56EB		     add     si, 10h
DOSCODE:56EE		     mov     di, offset	RENBUF
DOSCODE:56F1		     push    word ptr [si]
DOSCODE:56F3		     push    ds
DOSCODE:56F4		     push    si
DOSCODE:56F5		     mov     [si], al
DOSCODE:56F7		     mov     dx, si
DOSCODE:56F9		     call    TransFCB
DOSCODE:56FC		     pop     si
DOSCODE:56FD		     pop     ds
DOSCODE:56FE		     pop     word ptr [si]
DOSCODE:5700		     pop     dx
DOSCODE:5701		     jb	     short fren90
DOSCODE:5703		     mov     si, ss:WFP_START
DOSCODE:5708		     mov     ss:REN_WFP, si
DOSCODE:570D		     mov     di, offset	OPENBUF
DOSCODE:5710		     call    TransFCB
DOSCODE:5713		     jb	     short fren90
DOSCODE:5715		     call    DOS_RENAME
DOSCODE:5718		     jb	     short fren90
DOSCODE:571A		     jmp     NO_OP	     ; FCB_RET_OK
DOSCODE:571D ; ---------------------------------------------------------------------------
DOSCODE:571D
DOSCODE:571D fren90:				     ; ...
DOSCODE:571D		     jmp     short fcb_close_err
DOSCODE:571F
DOSCODE:571F ; =============== S U B R O U T I N E =======================================
DOSCODE:571F
DOSCODE:571F
DOSCODE:571F SaveFCBInfo     proc near		     ; ...
DOSCODE:571F		     les     di, ss:THISSFT
DOSCODE:5724		     call    IsSFTNet
DOSCODE:5727		     jz	     short SaveLocal
DOSCODE:5729		     mov     ax, es:[di+0Bh] ; [ES:DI+sf_serial_ID]
DOSCODE:572D		     mov     [si+1Ch], ax    ; [SI+fcb_netID]
DOSCODE:5730		     mov     bl, 80h	     ; FCBNETWORK
DOSCODE:5732		     jmp     short SaveSFN
DOSCODE:5734 ; ---------------------------------------------------------------------------
DOSCODE:5734
DOSCODE:5734 SaveLocal:				     ; ...
DOSCODE:5734		     call    CheckShare
DOSCODE:5737		     jz	     short SaveNoShare
DOSCODE:5739		     jmp     short SaveShare
DOSCODE:573B ; ---------------------------------------------------------------------------
DOSCODE:573B
DOSCODE:573B SaveNoShare:			     ; ...
DOSCODE:573B		     test    byte ptr es:[di+5], 80h ; [ES:DI+SF_ENTRY.sf_flags],
DOSCODE:573B					     ; devid_device
DOSCODE:5740		     jnz     short SaveNoShareDev
DOSCODE:5742		     mov     ax, es:[di+1Bh] ; [ES:DI+SF_ENTRY.sf_dirsec]
DOSCODE:5746		     mov     [si+1Dh], ax    ; [SI+fcb_nsl_dirsec]
DOSCODE:5749		     mov     ax, es:[di+1Dh] ; [es:di+SF_ENTRY.sf_dirsec+2]
DOSCODE:574D		     mov     bl, es:[di+4]   ; [es:di+SF_ENTRY.sf_attr]
DOSCODE:5751		     mov     bh, bl
DOSCODE:5753		     ror     bl, 1
DOSCODE:5755		     shl     bh, 1
DOSCODE:5757		     or	     bl, bh
DOSCODE:5759		     and     bl, 0C0h
DOSCODE:575C		     or	     al, bl
DOSCODE:575E		     mov     [si+18h], al    ; [si+fcb_sfn]
DOSCODE:5761		     mov     al, es:[di+1Fh] ; [ES:DI+SF_ENTRY.sf_dirpos]
DOSCODE:5765		     mov     [si+1Fh], al    ; [SI+fcb_nsl_dirpos]
DOSCODE:5768		     mov     ax, es:[di+0Bh] ; [ES:DI+SF_ENTRY.sf_firclus]
DOSCODE:576C		     mov     [si+1Bh], ax    ; [SI+fcb_nsl_firclus]
DOSCODE:576F		     mov     bl, 0
DOSCODE:5771
DOSCODE:5771 SetFCBBits:			     ; ...
DOSCODE:5771		     mov     ax, es:[di+5]   ; [ES:DI+SF_ENTRY.sf_flags]
DOSCODE:5775		     and     al, 0C0h
DOSCODE:5777		     or	     al, es:[di+2]   ; [ES:DI+SF_ENTRY.sf_mode]
DOSCODE:577B		     mov     [si+1Ah], al    ; [SI+fcb_nsl_bits]
DOSCODE:577E		     or	     bl, bl
DOSCODE:5780		     jz	     short SaveNoSFN
DOSCODE:5782		     jmp     short SaveSFN
DOSCODE:5784 ; ---------------------------------------------------------------------------
DOSCODE:5784
DOSCODE:5784 SaveNoShareDev:			     ; ...
DOSCODE:5784		     mov     ax, es:[di+7]   ; [ES:DI+SF_ENTRY.sf_devptr]
DOSCODE:5788		     mov     [si+1Ah], ax    ; [SI+fcb_nsld_drvptr]
DOSCODE:578B		     mov     ax, es:[di+9]   ; [ES:DI+SF_ENTRY.sf_devptr+2]
DOSCODE:578F		     mov     [si+1Ch], ax    ; [SI+fcb_nsld_drvptr+2]
DOSCODE:5792		     mov     bl, 40h	     ; FCBDEVICE
DOSCODE:5794		     jmp     short SetFCBBits
DOSCODE:5796 ; ---------------------------------------------------------------------------
DOSCODE:5796
DOSCODE:5796 SaveShare:				     ; ...
DOSCODE:5796		     call    dword ptr ss:ShSave ; Call	far [ss:JShare+(10*4)]
DOSCODE:579B
DOSCODE:579B SaveSFN:				     ; ...
DOSCODE:579B		     lea     ax, [di-6]	     ; [DI-SFT.SFTable]
DOSCODE:579E		     sub     ax, word ptr ss:SFTFCB
DOSCODE:57A3		     push    bx
DOSCODE:57A4		     mov     bl, 59	     ; SF_ENTRY.size
DOSCODE:57A6		     div     bl
DOSCODE:57A8		     mov     [si+18h], al    ; [SI+fcb_sfn]
DOSCODE:57AB		     pop     bx
DOSCODE:57AC
DOSCODE:57AC SaveNoSFN:				     ; ...
DOSCODE:57AC		     mov     ax, es:[di+5]   ; [ES:DI+SF_ENTRY.sf_flags]
DOSCODE:57B0		     and     al, 3Fh
DOSCODE:57B2		     or	     al, bl
DOSCODE:57B4		     mov     [si+19h], al    ; [SI+fcb_l_drive]
DOSCODE:57B7		     mov     ax, ss:FCBLRU
DOSCODE:57BB		     inc     ax
DOSCODE:57BC		     mov     es:[di+15h], ax ; [ES:DI+sf_LRU]
DOSCODE:57C0		     jnz     short SimpleStuff
DOSCODE:57C2		     mov     bx, 15h	     ; SF_ENTRY.sf_position
DOSCODE:57C5		     call    ResetLRU
DOSCODE:57C8
DOSCODE:57C8 SimpleStuff:			     ; ...
DOSCODE:57C8		     mov     ss:FCBLRU,	ax
DOSCODE:57CC		     retn
DOSCODE:57CC SaveFCBInfo     endp
DOSCODE:57CC
DOSCODE:57CD
DOSCODE:57CD ; =============== S U B R O U T I N E =======================================
DOSCODE:57CD
DOSCODE:57CD
DOSCODE:57CD ResetLRU	     proc near		     ; ...
DOSCODE:57CD		     mov     ax, 8000h
DOSCODE:57D0		     push    es
DOSCODE:57D1		     push    di
DOSCODE:57D2		     les     di, ss:SFTFCB
DOSCODE:57D7		     mov     cx, es:[di+4]   ; [ES:DI+SFT.SFCount]
DOSCODE:57DB		     lea     di, [di+6]	     ; [DI+SFT.SFTable]
DOSCODE:57DE
DOSCODE:57DE ovScan:				     ; ...
DOSCODE:57DE		     sub     es:[bx+di], ax
DOSCODE:57E1		     ja	     short ovLoop
DOSCODE:57E3		     mov     es:[bx+di], ax
DOSCODE:57E6
DOSCODE:57E6 ovLoop:				     ; ...
DOSCODE:57E6		     add     di, 59	     ; SF_ENTRY.size
DOSCODE:57E9		     loop    ovScan
DOSCODE:57EB		     pop     di
DOSCODE:57EC		     pop     es
DOSCODE:57ED		     mov     es:[bx+di], ax
DOSCODE:57F0		     retn
DOSCODE:57F0 ResetLRU	     endp
DOSCODE:57F0
DOSCODE:57F1
DOSCODE:57F1 ; =============== S U B R O U T I N E =======================================
DOSCODE:57F1
DOSCODE:57F1
DOSCODE:57F1 LRUFCB	     proc near		     ; ...
DOSCODE:57F1		     push    es
DOSCODE:57F2		     call    save_world
DOSCODE:57F5		     mov     ds, cs:DosDSeg
DOSCODE:57FA		     or	     al, al
DOSCODE:57FC		     jnz     short lru1
DOSCODE:57FE		     mov     di, word ptr ds:LocalSFT
DOSCODE:5802		     or	     di, word ptr ds:LocalSFT+2
DOSCODE:5806		     jz	     short lru1
DOSCODE:5808		     les     di, ds:LocalSFT
DOSCODE:580C
DOSCODE:580C gotlocalSFT:			     ; ...
DOSCODE:580C		     mov     word ptr ds:THISSFT, di
DOSCODE:5810		     mov     word ptr ds:THISSFT+2, es
DOSCODE:5814		     clc
DOSCODE:5815		     jmp     LRUDone
DOSCODE:5818 ; ---------------------------------------------------------------------------
DOSCODE:5818
DOSCODE:5818 lru1:				     ; ...
DOSCODE:5818		     les     di, ds:SFTFCB
DOSCODE:581C		     mov     cx, es:[di+4]   ; [es:di+SFT.SFCount]
DOSCODE:5820		     lea     di, [di+6]	     ; [di+SFT.SFTable]
DOSCODE:5823		     mov     bx, 0FFFFh	     ; -1
DOSCODE:5826		     mov     si, bx
DOSCODE:5828		     mov     dx, bx
DOSCODE:582A		     mov     bp, bx
DOSCODE:582C
DOSCODE:582C findSFT:				     ; ...
DOSCODE:582C		     or	     word ptr es:[di], 0 ; [es:di+SF_ENTRY.sf_ref_count]
DOSCODE:5830		     jz	     short gotSFT
DOSCODE:5832		     cmp     word ptr es:[di], 0FFFFh ;	[es:di+SF_ENTRY.sf_ref_count],
DOSCODE:5832					     ; sf_busy
DOSCODE:5836		     jz	     short gotSFT
DOSCODE:5838		     test    word ptr es:[di+5], 8000h ; [ES:DI+SF_ENTRY.sf_flags],
DOSCODE:5838					     ; sf_isnet
DOSCODE:583E		     jnz     short lru5
DOSCODE:5840		     call    CheckShare
DOSCODE:5843		     jnz     short lru5
DOSCODE:5845
DOSCODE:5845 hackpoint:				     ; ...
DOSCODE:5845		     mov     word ptr ds:LocalSFT, di
DOSCODE:5849		     mov     word ptr ds:LocalSFT+2, es
DOSCODE:584D		     or	     al, al
DOSCODE:584F		     jz	     short gotlocalSFT
DOSCODE:5851		     cmp     es:[di+15h], bx ; [es:di+sf_LRU]
DOSCODE:5855		     jnb     short lru4
DOSCODE:5857		     mov     bx, es:[di+15h] ; [es:di+sf_LRU]
DOSCODE:585B		     mov     si, di
DOSCODE:585D
DOSCODE:585D lru4:				     ; ...
DOSCODE:585D		     add     di, 59	     ; SF_ENTRY.size
DOSCODE:5860		     loop    findSFT
DOSCODE:5862		     mov     di, si
DOSCODE:5864		     cmp     si, -1
DOSCODE:5867		     jnz     short gotSFT
DOSCODE:5869		     mov     di, bp
DOSCODE:586B		     cmp     bp, -1
DOSCODE:586E		     jnz     short gotnetSFT
DOSCODE:5870
DOSCODE:5870 noSFT:
DOSCODE:5870		     jmp     short errorbadSFT
DOSCODE:5872 ; ---------------------------------------------------------------------------
DOSCODE:5872
DOSCODE:5872 lru5:				     ; ...
DOSCODE:5872		     cmp     es:[di+15h], dx ; [es:di+sf_LRU]
DOSCODE:5876		     jnb     short lru4
DOSCODE:5878		     mov     dx, es:[di+15h] ; [es:di+sf_LRU]
DOSCODE:587C		     mov     bp, di
DOSCODE:587E		     jmp     short lru4
DOSCODE:5880 ; ---------------------------------------------------------------------------
DOSCODE:5880
DOSCODE:5880 gotSFT:				     ; ...
DOSCODE:5880		     or	     al, al
DOSCODE:5882		     jz	     short hackpoint
DOSCODE:5884		     mov     ax, es
DOSCODE:5886		     cmp     word ptr ds:LocalSFT, di
DOSCODE:588A		     jnz     short notinvalid
DOSCODE:588C		     cmp     word ptr ds:LocalSFT+2, ax
DOSCODE:5890		     jz	     short zerolocalSFT
DOSCODE:5892
DOSCODE:5892 notinvalid:			     ; ...
DOSCODE:5892		     jmp     gotlocalSFT
DOSCODE:5895 ; ---------------------------------------------------------------------------
DOSCODE:5895
DOSCODE:5895 zerolocalSFT:			     ; ...
DOSCODE:5895		     xor     ax, ax
DOSCODE:5897		     mov     word ptr ds:LocalSFT, ax
DOSCODE:589A		     mov     word ptr ds:LocalSFT+2, ax
DOSCODE:589D		     jmp     gotlocalSFT
DOSCODE:58A0 ; ---------------------------------------------------------------------------
DOSCODE:58A0
DOSCODE:58A0 gotnetSFT:				     ; ...
DOSCODE:58A0		     or	     al, al
DOSCODE:58A2		     jnz     short closenet
DOSCODE:58A4		     mov     word ptr ds:LocalSFT, di
DOSCODE:58A8		     mov     word ptr ds:LocalSFT+2, es
DOSCODE:58AC
DOSCODE:58AC closenet:				     ; ...
DOSCODE:58AC		     mov     word ptr ds:THISSFT, di
DOSCODE:58B0		     mov     word ptr ds:THISSFT+2, es
DOSCODE:58B4
DOSCODE:58B4 LRUClose:				     ; ...
DOSCODE:58B4		     cmp     word ptr es:[di], 0 ; [es:di+SF_ENTRY.sf_ref_count]
DOSCODE:58B8		     jz	     short LRUDone
DOSCODE:58BA		     call    DOS_CLOSE
DOSCODE:58BD		     jnb     short LRUClose
DOSCODE:58BF		     cmp     al, 6
DOSCODE:58C1		     jz	     short LRUClose
DOSCODE:58C3
DOSCODE:58C3 errorbadSFT:			     ; ...
DOSCODE:58C3		     stc
DOSCODE:58C4		     jmp     short LRUDead
DOSCODE:58C6 ; ---------------------------------------------------------------------------
DOSCODE:58C6
DOSCODE:58C6 LRUDone:				     ; ...
DOSCODE:58C6		     xor     al, al
DOSCODE:58C8		     call    BlastSFT
DOSCODE:58CB
DOSCODE:58CB LRUDead:				     ; ...
DOSCODE:58CB		     call    restore_world
DOSCODE:58CE		     pop     es
DOSCODE:58CF		     mov     es, cs:DosDSeg
DOSCODE:58D4		     les     di, es:THISSFT
DOSCODE:58D9		     jb	     short LruFCB_err
DOSCODE:58DB		     retn
DOSCODE:58DC ; ---------------------------------------------------------------------------
DOSCODE:58DC
DOSCODE:58DC LruFCB_err:			     ; ...
DOSCODE:58DC		     mov     al, 23h	     ; error_FCB_unavailable
DOSCODE:58DE		     retn
DOSCODE:58DE LRUFCB	     endp
DOSCODE:58DE
DOSCODE:58DF
DOSCODE:58DF ; =============== S U B R O U T I N E =======================================
DOSCODE:58DF
DOSCODE:58DF
DOSCODE:58DF RegenCopyName   proc near		     ; ...
DOSCODE:58DF		     lodsb
DOSCODE:58E0		     call    UCase
DOSCODE:58E3
DOSCODE:58E3 StuffChar2:
DOSCODE:58E3		     stosb
DOSCODE:58E4		     loop    RegenCopyName   ; CopyName
DOSCODE:58E6		     retn
DOSCODE:58E6 RegenCopyName   endp
DOSCODE:58E6
DOSCODE:58E7
DOSCODE:58E7 ; =============== S U B R O U T I N E =======================================
DOSCODE:58E7
DOSCODE:58E7
DOSCODE:58E7 FCBRegen	     proc near		     ; ...
DOSCODE:58E7		     mov     al, [si+19h]    ; [SI+fcb_l_drive]
DOSCODE:58EA		     test    al, 80h
DOSCODE:58EC		     jz	     short RegenNoSharing
DOSCODE:58EE		     call    CheckShare
DOSCODE:58F1		     jnz     short RegenFail
DOSCODE:58F3		     mov     ax, 1100h
DOSCODE:58F6		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	INSTALLATION CHECK
DOSCODE:58F6					     ; Return: AL = 00h	 not installed,	OK to install
DOSCODE:58F6					     ; 01h  not	installed, not OK to install
DOSCODE:58F6					     ; FFh  installed
DOSCODE:58F8		     or	     al, al
DOSCODE:58FA		     jz	     short RegenDead
DOSCODE:58FC
DOSCODE:58FC RegenFail:				     ; ...
DOSCODE:58FC		     mov     ax, ss:USER_IN_AX
DOSCODE:5900		     cmp     ah, 10h
DOSCODE:5903		     jz	     short RegenDead
DOSCODE:5905		     call    FCBHardErr
DOSCODE:5908
DOSCODE:5908 RegenDead:				     ; ...
DOSCODE:5908		     stc
DOSCODE:5909
DOSCODE:5909 FCBRegen_retn:			     ; ...
DOSCODE:5909		     retn
DOSCODE:590A ; ---------------------------------------------------------------------------
DOSCODE:590A
DOSCODE:590A RegenNoSharing:			     ; ...
DOSCODE:590A		     call    CheckShare
DOSCODE:590D		     jnz     short RegenFail
DOSCODE:590F		     push    ax
DOSCODE:5910		     mov     al, 0
DOSCODE:5912		     call    LRUFCB
DOSCODE:5915		     pop     ax
DOSCODE:5916		     jb	     short FCBRegen_retn
DOSCODE:5918		     mov     word ptr es:[di+2], 8002h ; [ES:DI+SF_ENTRY.sf_mode],
DOSCODE:5918					     ; sf_isFCB+open_for_both+SHARING_COMP
DOSCODE:591E		     and     al, 3Fh
DOSCODE:5920		     cbw
DOSCODE:5921		     or	     ax, 4000h	     ; sf_close_nodate
DOSCODE:5924		     mov     cl, [si+1Ah]    ; [SI+fcb_nsl_bits]
DOSCODE:5927		     mov     ch, cl
DOSCODE:5929		     and     ch, 0C0h
DOSCODE:592C		     or	     al, ch
DOSCODE:592E		     and     cl, 0Fh	     ; access_mask
DOSCODE:5931		     mov     es:[di+2],	cl   ; ES:DI+SF_ENTRY.sf_mode]
DOSCODE:5935		     mov     es:[di+5],	ax   ; [ES:DI+SF_ENTRY.sf_flags]
DOSCODE:5939		     mov     ax, ss:PROC_ID
DOSCODE:593D		     mov     es:[di+31h], ax ; [ES:DI+SF_ENTRY.sf_PID]
DOSCODE:5941		     push    ds
DOSCODE:5942		     push    si
DOSCODE:5943		     push    es
DOSCODE:5944		     push    di
DOSCODE:5945		     push    ss
DOSCODE:5946		     pop     es
DOSCODE:5947		     mov     di, offset	NAME1
DOSCODE:594A		     mov     cx, 8
DOSCODE:594D		     inc     si
DOSCODE:594E		     call    RegenCopyName
DOSCODE:5951		     push    ss
DOSCODE:5952		     pop     ds
DOSCODE:5953		     mov     ds:ATTRIB,	16h  ; attr_hidden+attr_system+attr_directory
DOSCODE:5958		     call    DEVNAME
DOSCODE:595B		     pop     di
DOSCODE:595C		     pop     es
DOSCODE:595D		     pop     si
DOSCODE:595E		     pop     ds
DOSCODE:595F		     jb	     short RegenFileNoSharing
DOSCODE:5961		     mov     es:[di+5],	bh   ; [ES:DI+SF_ENTRY.sf_flags]
DOSCODE:5965		     mov     byte ptr es:[di+4], 0 ; [ES:DI+SF_ENTRY.sf_attr]
DOSCODE:596A		     lds     si, ss:DEVPT
DOSCODE:596F		     mov     es:[di+7],	si   ; [ES:DI+SF_ENTRY.sf_devptr]
DOSCODE:5973		     mov     word ptr es:[di+9], ds ; [ES:DI+SF_ENTRY.sf_devptr+2]
DOSCODE:5977		     retn
DOSCODE:5978 ; ---------------------------------------------------------------------------
DOSCODE:5978
DOSCODE:5978 RegenDeadJ:			     ; ...
DOSCODE:5978		     jmp     short RegenDead
DOSCODE:597A ; ---------------------------------------------------------------------------
DOSCODE:597A
DOSCODE:597A RegenFileNoSharing:		     ; ...
DOSCODE:597A		     mov     ax, es:[di+5]   ; [ES:DI+SF_ENTRY.sf_flags]
DOSCODE:597E		     and     ax, 3Fh
DOSCODE:5981		     push    ds
DOSCODE:5982		     push    si
DOSCODE:5983		     call    FIND_DPB
DOSCODE:5986		     mov     es:[di+7],	si   ; [ES:DI+SF_ENTRY.sf_devptr]
DOSCODE:598A		     mov     word ptr es:[di+9], ds ; [ES:DI+SF_ENTRY.sf_devptr+2]
DOSCODE:598E		     pop     si
DOSCODE:598F		     pop     ds
DOSCODE:5990		     jb	     short RegenDeadJ
DOSCODE:5992		     mov     ax, [si+1Dh]    ; [SI+fcb_nsl_dirsec]
DOSCODE:5995		     mov     es:[di+1Bh], ax ; [ES:DI+SF_ENTRY.sf_dirsec]
DOSCODE:5999		     mov     al, [si+18h]    ; [si+fcb_sfn]
DOSCODE:599C		     and     al, 0C0h
DOSCODE:599E		     mov     ah, al
DOSCODE:59A0		     rol     ah, 1
DOSCODE:59A2		     shr     al, 1
DOSCODE:59A4		     or	     al, ah
DOSCODE:59A6		     and     al, 3Fh
DOSCODE:59A8		     mov     es:[di+4],	al   ; [es:di+SF_ENTRY.sf_attr]
DOSCODE:59AC		     mov     al, [si+18h]    ; [si+fcb_sfn]
DOSCODE:59AF		     and     al, 3Fh
DOSCODE:59B1		     sub     ah, ah
DOSCODE:59B3		     mov     es:[di+1Dh], ax ; [es:di+SF_ENTRY.sf_dirsec+2]
DOSCODE:59B7		     mov     ax, [si+1Bh]    ; [SI+fcb_nsl_firclus]
DOSCODE:59BA		     mov     es:[di+0Bh], ax ; [ES:DI+SF_ENTRY.sf_firclus]
DOSCODE:59BE		     mov     es:[di+35h], ax ; [ES:DI+SF_ENTRY.sf_lstclus]
DOSCODE:59C2		     mov     al, [si+1Fh]    ; SI+fcb_nsl_dirpos]
DOSCODE:59C5		     mov     es:[di+1Fh], al ; [ES:DI+SF_ENTRY.sf_dirpos]
DOSCODE:59C9		     inc     word ptr es:[di] ;	[ES:DI+SF_ENTRY.sf_ref_count]
DOSCODE:59CC		     lea     si, [si+1]	     ; [SI+SYS_FCB.name]
DOSCODE:59CF		     lea     di, [di+20h]    ; [DI+SF_ENTRY.sf_name]
DOSCODE:59D2		     mov     cx, 11	     ; SYS_FCB.EXTENT-SYS_FCB.name ; 12-1
DOSCODE:59D5		     call    RegenCopyName
DOSCODE:59D8		     clc
DOSCODE:59D9		     retn
DOSCODE:59D9 FCBRegen	     endp
DOSCODE:59D9
DOSCODE:59DA
DOSCODE:59DA ; =============== S U B R O U T I N E =======================================
DOSCODE:59DA
DOSCODE:59DA
DOSCODE:59DA BlastSFT	     proc near		     ; ...
DOSCODE:59DA		     push    di
DOSCODE:59DB		     mov     cx, 59	     ; SF_ENTRY.size
DOSCODE:59DE		     rep stosb
DOSCODE:59E0		     pop     di
DOSCODE:59E1		     sub     ax, ax
DOSCODE:59E3		     mov     es:[di], ax     ; [es:di+SFT_ENTRY.sf_ref_count]
DOSCODE:59E6		     mov     es:[di+15h], ax ; [es:di+sf_LRU]
DOSCODE:59EA		     dec     ax
DOSCODE:59EB		     mov     es:[di+17h], ax ; [es:di+sf_OpenAge]
DOSCODE:59EF		     retn
DOSCODE:59EF BlastSFT	     endp
DOSCODE:59EF
DOSCODE:59F0
DOSCODE:59F0 ; =============== S U B R O U T I N E =======================================
DOSCODE:59F0
DOSCODE:59F0
DOSCODE:59F0 CheckFCB	     proc near		     ; ...
DOSCODE:59F0		     test    byte ptr [si+19h],	0C0h ; [si+fcb_l_drive],
DOSCODE:59F0					     ; FCBNETWORK|FCBSHARE|FCBDEVICE
DOSCODE:59F4		     jz	     short BadSFT
DOSCODE:59F6		     les     di, ss:SFTFCB
DOSCODE:59FB		     cmp     es:[di+4],	al   ; [ES:DI+SFT.SFCount]
DOSCODE:59FF		     jb	     short BadSFT
DOSCODE:5A01		     mov     bl, 59	     ; SF_ENTRY.size
DOSCODE:5A03		     mul     bl
DOSCODE:5A05		     lea     di, [di+6]	     ; [DI+SFT.SFTable]
DOSCODE:5A08		     add     di, ax
DOSCODE:5A0A		     mov     ax, ss:PROC_ID
DOSCODE:5A0E		     cmp     es:[di+31h], ax ; [ES:DI+SF_ENTRY.sf_PID]
DOSCODE:5A12		     jnz     short BadSFT
DOSCODE:5A14		     cmp     word ptr es:[di], 0 ; [ES:DI+SF_ENTRY.sf_ref_count]
DOSCODE:5A18		     jz	     short BadSFT
DOSCODE:5A1A		     mov     al, [si+19h]    ; [SI+fcb_l_drive]
DOSCODE:5A1D		     test    al, 80h	     ; FCBSPECIAL
DOSCODE:5A1F		     jz	     short CheckNoShare
DOSCODE:5A21		     push    ax
DOSCODE:5A22		     and     al, 0C0h	     ; FCBMASK
DOSCODE:5A24		     cmp     al, 0C0h	     ; FCBSHARE
DOSCODE:5A26		     pop     ax
DOSCODE:5A27		     jnz     short CheckNet
DOSCODE:5A29		     call    dword ptr ss:ShChk	; Call far [ss:JShare+(11*4)]
DOSCODE:5A2E		     jb	     short BadSFT
DOSCODE:5A30		     jmp     short CheckD
DOSCODE:5A32 ; ---------------------------------------------------------------------------
DOSCODE:5A32
DOSCODE:5A32 CheckFirClus:			     ; [ES:DI+SF_ENTRY.sf_firclus]
DOSCODE:5A32		     cmp     bx, es:[di+0Bh]
DOSCODE:5A36		     jnz     short BadSFT
DOSCODE:5A38
DOSCODE:5A38 CheckD:				     ; ...
DOSCODE:5A38		     and     al, 3Fh
DOSCODE:5A3A		     mov     ah, es:[di+5]
DOSCODE:5A3E		     and     ah, 3Fh
DOSCODE:5A41		     cmp     ah, al
DOSCODE:5A43		     jnz     short BadSFT
DOSCODE:5A45
DOSCODE:5A45 CheckD_retn:			     ; ...
DOSCODE:5A45		     retn
DOSCODE:5A46 ; ---------------------------------------------------------------------------
DOSCODE:5A46
DOSCODE:5A46 BadSFT:				     ; ...
DOSCODE:5A46		     stc
DOSCODE:5A47		     retn
DOSCODE:5A48 ; ---------------------------------------------------------------------------
DOSCODE:5A48
DOSCODE:5A48 CheckNet:				     ; ...
DOSCODE:5A48		     mov     ax, [si+1Ch]    ; [SI+fcb_netID]
DOSCODE:5A4B		     cmp     ax, es:[di+0Bh] ; [ES:DI+sf_serial_ID]
DOSCODE:5A4F		     jnz     short BadSFT
DOSCODE:5A51		     retn
DOSCODE:5A52 ; ---------------------------------------------------------------------------
DOSCODE:5A52
DOSCODE:5A52 CheckNoShare:			     ; ...
DOSCODE:5A52		     test    al, 40h	     ; FCBDEVICE
DOSCODE:5A54		     jnz     short $+2	     ; CheckNoShareDev
DOSCODE:5A56
DOSCODE:5A56 CheckNoShareDev:			     ; ...
DOSCODE:5A56		     mov     bx, [si+1Ah]    ; [SI+fcb_nsld_drvptr]
DOSCODE:5A59		     cmp     bx, es:[di+7]   ; [ES:DI+SF_ENTRY.sf_devptr]
DOSCODE:5A5D		     jnz     short BadSFT
DOSCODE:5A5F		     mov     bx, [si+1Ch]    ; [SI+fcb_nsld_drvptr+2]
DOSCODE:5A62		     cmp     bx, es:[di+9]   ; [ES:DI+SF_ENTRY.sf_devptr+2]
DOSCODE:5A66		     jnz     short BadSFT
DOSCODE:5A68		     jmp     short CheckD
DOSCODE:5A68 CheckFCB	     endp
DOSCODE:5A68
DOSCODE:5A6A
DOSCODE:5A6A ; =============== S U B R O U T I N E =======================================
DOSCODE:5A6A
DOSCODE:5A6A
DOSCODE:5A6A SFTFromFCB	     proc near		     ; ...
DOSCODE:5A6A		     push    ax
DOSCODE:5A6B		     push    bx
DOSCODE:5A6C		     mov     al, [si+18h]    ; [SI+fcb_sfn]
DOSCODE:5A6F		     call    CheckFCB
DOSCODE:5A72		     pop     bx
DOSCODE:5A73		     pop     ax
DOSCODE:5A74		     mov     word ptr ss:THISSFT, di
DOSCODE:5A79		     mov     word ptr ss:THISSFT+2, es
DOSCODE:5A7E		     jnb     short Set_SFT
DOSCODE:5A80		     push    es
DOSCODE:5A81		     call    save_world
DOSCODE:5A84		     call    FCBRegen
DOSCODE:5A87		     call    restore_world
DOSCODE:5A8A		     pop     es
DOSCODE:5A8B		     mov     ax, ss:EXTERR
DOSCODE:5A8F		     jb	     short CheckD_retn
DOSCODE:5A91
DOSCODE:5A91 Set_SFT:				     ; ...
DOSCODE:5A91		     les     di, ss:THISSFT
DOSCODE:5A96		     push    ss:PROC_ID
DOSCODE:5A9B		     pop     word ptr es:[di+31h] ; [ES:DI+SF_ENTRY.sf_PID]
DOSCODE:5A9F		     retn
DOSCODE:5A9F SFTFromFCB	     endp
DOSCODE:5A9F
DOSCODE:5AA0
DOSCODE:5AA0 ; =============== S U B R O U T I N E =======================================
DOSCODE:5AA0
DOSCODE:5AA0
DOSCODE:5AA0 FCBHardErr	     proc near		     ; ...
DOSCODE:5AA0		     mov     es, cs:DosDSeg
DOSCODE:5AA5		     mov     ax, 23h	     ; error_FCB_unavailable
DOSCODE:5AA8		     mov     es:ALLOWED, 8   ; Allowed_FAIL
DOSCODE:5AAE		     les     bp, es:THISDPB
DOSCODE:5AB3		     mov     di, 1
DOSCODE:5AB6		     mov     cx, di
DOSCODE:5AB8		     mov     dx, es:[bp+0Bh] ; [ES:BP+DPB.FIRST_SECTOR]
DOSCODE:5ABC		     call    HARDERR
DOSCODE:5ABF		     stc
DOSCODE:5AC0		     retn
DOSCODE:5AC0 FCBHardErr	     endp
DOSCODE:5AC0
DOSCODE:5AC1
DOSCODE:5AC1 ; =============== S U B R O U T I N E =======================================
DOSCODE:5AC1
DOSCODE:5AC1
DOSCODE:5AC1 GetRR	     proc near		     ; ...
DOSCODE:5AC1		     mov     ax, [si+21h]    ; [SI+SYS_FCB.RR]
DOSCODE:5AC4		     mov     dx, [si+23h]    ; [SI+SYS_FCB.RR+2]
DOSCODE:5AC7		     cmp     bx, 64
DOSCODE:5ACA		     jb	     short GetRRBye
DOSCODE:5ACC		     xor     dh, dh
DOSCODE:5ACE
DOSCODE:5ACE GetRRBye:				     ; ...
DOSCODE:5ACE		     retn
DOSCODE:5ACE GetRR	     endp
DOSCODE:5ACE
DOSCODE:5ACF
DOSCODE:5ACF ; =============== S U B R O U T I N E =======================================
DOSCODE:5ACF
DOSCODE:5ACF
DOSCODE:5ACF GetExtent	     proc near		     ; ...
DOSCODE:5ACF		     mov     al, [si+20h]    ; [SI+SYS_FCB.NR]
DOSCODE:5AD2		     mov     dx, [si+0Ch]    ; [SI+SYS_FCB.EXTENT]
DOSCODE:5AD5		     shl     al, 1
DOSCODE:5AD7		     shr     dx, 1
DOSCODE:5AD9		     rcr     al, 1
DOSCODE:5ADB		     mov     ah, dl
DOSCODE:5ADD		     mov     dl, dh
DOSCODE:5ADF		     xor     dh, dh
DOSCODE:5AE1		     retn
DOSCODE:5AE1 GetExtent	     endp
DOSCODE:5AE1
DOSCODE:5AE2
DOSCODE:5AE2 ; =============== S U B R O U T I N E =======================================
DOSCODE:5AE2
DOSCODE:5AE2
DOSCODE:5AE2 SetExtent	     proc near		     ; ...
DOSCODE:5AE2		     push    ax
DOSCODE:5AE3		     push    dx
DOSCODE:5AE4		     mov     cx, ax
DOSCODE:5AE6		     and     al, 7Fh
DOSCODE:5AE8		     mov     [si+20h], al    ; [SI+SYS_FCB.NR]
DOSCODE:5AEB		     and     cl, 80h
DOSCODE:5AEE		     shl     cx, 1
DOSCODE:5AF0		     rcl     dx, 1
DOSCODE:5AF2		     mov     al, ch
DOSCODE:5AF4		     mov     ah, dl
DOSCODE:5AF6		     mov     [si+0Ch], ax    ; [SI+SYS_FCB.EXTENT]
DOSCODE:5AF9		     pop     dx
DOSCODE:5AFA		     pop     ax
DOSCODE:5AFB		     retn
DOSCODE:5AFB SetExtent	     endp
DOSCODE:5AFB
DOSCODE:5AFC
DOSCODE:5AFC ; =============== S U B R O U T I N E =======================================
DOSCODE:5AFC
DOSCODE:5AFC
DOSCODE:5AFC GetExtended     proc near		     ; ...
DOSCODE:5AFC		     mov     si, dx
DOSCODE:5AFE		     cmp     byte ptr [si], 0FFh ; -1
DOSCODE:5B01		     jnz     short GetBye
DOSCODE:5B03		     add     si, 7
DOSCODE:5B06
DOSCODE:5B06 GetBye:				     ; ...
DOSCODE:5B06		     cmp     si, dx
DOSCODE:5B08
DOSCODE:5B08 getextd_retn:			     ; ...
DOSCODE:5B08		     retn
DOSCODE:5B08 GetExtended     endp
DOSCODE:5B08
DOSCODE:5B09
DOSCODE:5B09 ; =============== S U B R O U T I N E =======================================
DOSCODE:5B09
DOSCODE:5B09
DOSCODE:5B09 GetRecSize	     proc near		     ; ...
DOSCODE:5B09		     mov     bx, [si+0Eh]    ; [SI+SYS_FCB.RECSIZ]
DOSCODE:5B0C		     or	     bx, bx
DOSCODE:5B0E		     jnz     short getextd_retn
DOSCODE:5B10		     mov     bx, 128
DOSCODE:5B13		     mov     [si+0Eh], bx    ; [SI+SYS_FCB.RECSIZ]
DOSCODE:5B16		     retn
DOSCODE:5B16 GetRecSize	     endp
DOSCODE:5B16
DOSCODE:5B17 ; ---------------------------------------------------------------------------
DOSCODE:5B17
DOSCODE:5B17 FCBIO:				     ; ...
DOSCODE:5B17		     push    bp
DOSCODE:5B18		     mov     bp, sp
DOSCODE:5B1A		     sub     sp, 14h
DOSCODE:5B1D		     mov     [bp-14h], al    ; FCBOp
DOSCODE:5B20		     mov     byte ptr [bp-1], 0	; FCBErr
DOSCODE:5B24		     call    GetExtended
DOSCODE:5B27		     test    byte ptr [bp-14h],	8 ; FCBOp,BLOCK
DOSCODE:5B2B		     jnz     short GetPos
DOSCODE:5B2D		     mov     cx, 1
DOSCODE:5B30
DOSCODE:5B30 GetPos:				     ; ...
DOSCODE:5B30		     mov     [bp-3], cx	     ; cRec
DOSCODE:5B33		     call    GetExtent
DOSCODE:5B36		     call    GetRecSize
DOSCODE:5B39		     mov     [bp-9], bx	     ; RecSize
DOSCODE:5B3C		     test    byte ptr [bp-14h],	2 ; FCBOp,RANDOM
DOSCODE:5B40		     jz	     short GetRec
DOSCODE:5B42		     call    GetRR
DOSCODE:5B45
DOSCODE:5B45 GetRec:				     ; ...
DOSCODE:5B45		     mov     [bp-7], ax	     ; RecPosL
DOSCODE:5B48		     mov     [bp-5], dx	     ; RecPosH
DOSCODE:5B4B		     call    SetExtent
DOSCODE:5B4E		     mov     ax, [bp-5]	     ; RecPosH
DOSCODE:5B51		     mul     bx
DOSCODE:5B53		     mov     di, ax
DOSCODE:5B55		     mov     ax, [bp-7]	     ; RecPosL
DOSCODE:5B58		     mul     bx
DOSCODE:5B5A		     add     dx, di
DOSCODE:5B5C		     mov     [bp-0Dh], ax    ; bPosL
DOSCODE:5B5F		     mov     [bp-0Bh], dx    ; bPosH
DOSCODE:5B62		     mov     ax, [bp-3]	     ; cRec
DOSCODE:5B65		     mul     bx
DOSCODE:5B67		     mov     [bp-0Fh], ax    ; cByte
DOSCODE:5B6A		     add     ax, word ptr ss:DMAADD
DOSCODE:5B6F		     adc     dx, 0
DOSCODE:5B72		     jz	     short DoOper
DOSCODE:5B74		     mov     byte ptr [bp-1], 2	; FCBErr,FTRIM
DOSCODE:5B78		     mov     ax, word ptr ss:DMAADD
DOSCODE:5B7C		     neg     ax
DOSCODE:5B7E		     jnz     short DoDiv
DOSCODE:5B80		     dec     ax
DOSCODE:5B81
DOSCODE:5B81 DoDiv:				     ; ...
DOSCODE:5B81		     xor     dx, dx
DOSCODE:5B83		     div     bx
DOSCODE:5B85		     mov     [bp-3], ax	     ; cRec
DOSCODE:5B88		     mul     bx
DOSCODE:5B8A		     mov     [bp-0Fh], ax    ; cByte
DOSCODE:5B8D
DOSCODE:5B8D DoOper:				     ; ...
DOSCODE:5B8D		     xor     bx, bx
DOSCODE:5B8F		     mov     [bp-11h], bx    ; cResult
DOSCODE:5B92		     cmp     [bp-0Fh], bx    ; cByte
DOSCODE:5B95		     jnz     short DoGetExt
DOSCODE:5B97		     test    byte ptr [bp-1], 2	; FCBErr,FTRIM
DOSCODE:5B9B		     jz	     short DoGetExt
DOSCODE:5B9D		     jmp     short SkipOp
DOSCODE:5B9F ; ---------------------------------------------------------------------------
DOSCODE:5B9F
DOSCODE:5B9F DoGetExt:				     ; ...
DOSCODE:5B9F		     call    SFTFromFCB
DOSCODE:5BA2		     jnb     short ContinueOp
DOSCODE:5BA4
DOSCODE:5BA4 FCBDeath:				     ; ...
DOSCODE:5BA4		     call    FCB_RET_ER
DOSCODE:5BA7		     mov     word ptr [bp-13h],	0 ; cRecRes
DOSCODE:5BAC		     mov     byte ptr [bp-1], 1	; FCBErr,FEOF
DOSCODE:5BB0		     jmp     FCBSave
DOSCODE:5BB3 ; ---------------------------------------------------------------------------
DOSCODE:5BB3
DOSCODE:5BB3 ContinueOp:			     ; ...
DOSCODE:5BB3		     mov     ax, [si+10h]    ; [SI+SYS_FCB.FILSIZ]
DOSCODE:5BB6		     mov     es:[di+11h], ax ; [ES:DI+SF_ENTRY.sf_size]
DOSCODE:5BBA		     mov     ax, [si+12h]    ; [SI+SYS_FCB.FILSIZ+2]
DOSCODE:5BBD		     mov     es:[di+13h], ax ; [ES:DI+SF_ENTRY.sf_size+2]
DOSCODE:5BC1		     mov     ax, [bp-0Dh]    ; bPosL
DOSCODE:5BC4		     mov     dx, [bp-0Bh]    ; bPosH
DOSCODE:5BC7		     mov     es:[di+15h], ax ; [ES:DI+SF_ENTRY.sf_position]
DOSCODE:5BCB		     xchg    dx, es:[di+17h] ; [ES:DI+SF_ENTRY.sf_position+2]
DOSCODE:5BCF		     push    dx
DOSCODE:5BD0		     mov     cx, [bp-0Fh]    ; cByte
DOSCODE:5BD3		     mov     di, offset	DOS_READ
DOSCODE:5BD6		     test    byte ptr [bp-14h],	4 ; FCBOp,FCBREAD
DOSCODE:5BDA		     jnz     short DoContext
DOSCODE:5BDC		     mov     di, offset	DOS_WRITE
DOSCODE:5BDF
DOSCODE:5BDF DoContext:				     ; ...
DOSCODE:5BDF		     push    bp
DOSCODE:5BE0		     push    ds
DOSCODE:5BE1		     push    si
DOSCODE:5BE2		     push    ss
DOSCODE:5BE3		     pop     ds
DOSCODE:5BE4		     call    di	; DOS_READ   ; or DOS_WRITE
DOSCODE:5BE6		     pop     si
DOSCODE:5BE7		     pop     ds
DOSCODE:5BE8		     pop     bp
DOSCODE:5BE9		     jb	     short FCBDeath
DOSCODE:5BEB		     cmp     ss:DISK_FULL, 0
DOSCODE:5BF1		     jz	     short NODSKFULL
DOSCODE:5BF3		     mov     ss:DISK_FULL, 0
DOSCODE:5BF9		     mov     byte ptr [bp-1], 1	; FCBErr,FEOF
DOSCODE:5BFD
DOSCODE:5BFD NODSKFULL:				     ; ...
DOSCODE:5BFD		     mov     [bp-11h], cx    ; cResult
DOSCODE:5C00		     call    SaveFCBInfo
DOSCODE:5C03		     pop     word ptr es:[di+17h] ; [ES:DI+SF_ENTRY.sf_position+2]
DOSCODE:5C07		     mov     ax, es:[di+11h] ; [ES:DI+SF_ENTRY.sf_size]
DOSCODE:5C0B		     mov     [si+10h], ax    ; [SI+SYS_FCB.FILSIZ]
DOSCODE:5C0E		     mov     ax, es:[di+13h] ; [ES:DI+SF_ENTRY.sf_size+2]
DOSCODE:5C12		     mov     [si+12h], ax    ; [SI+SYS_FCB.FILSIZ+2]
DOSCODE:5C15
DOSCODE:5C15 SkipOp:				     ; ...
DOSCODE:5C15		     mov     ax, [bp-11h]    ; cResult
DOSCODE:5C18		     xor     dx, dx
DOSCODE:5C1A		     div     word ptr [bp-9] ; RecSize
DOSCODE:5C1D		     mov     [bp-13h], ax    ; cRecRes
DOSCODE:5C20		     add     [bp-7], ax	     ; RecPosL
DOSCODE:5C23		     adc     word ptr [bp-5], 0	; RecPosH
DOSCODE:5C27		     cmp     ax, [bp-3]	     ; cRec
DOSCODE:5C2A		     jz	     short TryBlank
DOSCODE:5C2C		     test    byte ptr [bp-14h],	4 ; FCBOp,FCBREAD
DOSCODE:5C30		     jnz     short SetEOF
DOSCODE:5C32		     test    byte ptr es:[di+5], 80h
DOSCODE:5C37		     jnz     short TryBlank
DOSCODE:5C39
DOSCODE:5C39 SetEOF:				     ; ...
DOSCODE:5C39		     mov     byte ptr [bp-1], 1	; FCBErr,FEOF
DOSCODE:5C3D
DOSCODE:5C3D TryBlank:				     ; ...
DOSCODE:5C3D		     or	     dx, dx
DOSCODE:5C3F		     jz	     short SetExt
DOSCODE:5C41		     add     word ptr [bp-7], 1	; RecPosL
DOSCODE:5C45		     adc     word ptr [bp-5], 0	; RecPosH
DOSCODE:5C49		     test    byte ptr [bp-14h],	4 ; FCBOp,FCBREAD
DOSCODE:5C4D		     jz	     short SetExt
DOSCODE:5C4F		     inc     word ptr [bp-13h] ; cRecRes
DOSCODE:5C52		     mov     byte ptr [bp-1], 3	; FCBErr,FTRIM+FEOF
DOSCODE:5C56		     mov     cx, [bp-9]	     ; RecSize
DOSCODE:5C59		     sub     cx, dx
DOSCODE:5C5B		     xor     al, al
DOSCODE:5C5D		     les     di, ss:DMAADD
DOSCODE:5C62		     add     di, [bp-11h]    ; cResult
DOSCODE:5C65		     rep stosb
DOSCODE:5C67
DOSCODE:5C67 SetExt:				     ; ...
DOSCODE:5C67		     mov     dx, [bp-5]	     ; RecPosH
DOSCODE:5C6A		     mov     ax, [bp-7]	     ; RecPosL
DOSCODE:5C6D		     test    byte ptr [bp-14h],	2 ; FCBOp,RANDOM
DOSCODE:5C71		     jz	     short DoSetExt
DOSCODE:5C73		     test    byte ptr [bp-14h],	8 ; FCBOp,BLOCK
DOSCODE:5C77		     jz	     short TrySetRR
DOSCODE:5C79
DOSCODE:5C79 DoSetExt:				     ; ...
DOSCODE:5C79		     call    SetExtent
DOSCODE:5C7C
DOSCODE:5C7C TrySetRR:				     ; ...
DOSCODE:5C7C		     test    byte ptr [bp-14h],	8 ; FCBOp,BLOCK
DOSCODE:5C80		     jz	     short TryReturn
DOSCODE:5C82		     mov     [si+21h], ax    ; [SI+SYS_FCB.RR]
DOSCODE:5C85		     mov     [si+23h], dl    ; [SI+SYS_FCB.RR+2]
DOSCODE:5C88		     cmp     word ptr [si+0Eh],	64 ; [SI+SYS_FCB.RECSIZ]
DOSCODE:5C8C		     jnb     short TryReturn
DOSCODE:5C8E		     mov     [si+24h], dh    ; [SI+SYS_FCB.RR+2+1]
DOSCODE:5C91
DOSCODE:5C91 TryReturn:				     ; ...
DOSCODE:5C91		     test    byte ptr [bp-14h],	4 ; FCBOp,FCBREAD
DOSCODE:5C95		     jnz     short FCBSave
DOSCODE:5C97		     push    ds
DOSCODE:5C98		     call    DATE16
DOSCODE:5C9B		     pop     ds
DOSCODE:5C9C		     mov     [si+14h], ax    ; [SI+SYS_FCB.FDATE]
DOSCODE:5C9F		     mov     [si+16h], dx    ; [SI+SYS_FCB.FTIME]
DOSCODE:5CA2
DOSCODE:5CA2 FCBSave:				     ; ...
DOSCODE:5CA2		     test    byte ptr [bp-14h],	8 ; FCBOp,BLOCK
DOSCODE:5CA6		     jz	     short DoReturn
DOSCODE:5CA8		     mov     cx, [bp-13h]    ; cRecRes
DOSCODE:5CAB		     call    Get_User_Stack
DOSCODE:5CAE		     mov     [si+4], cx	     ; [SI+user_env.user_CX]
DOSCODE:5CB1
DOSCODE:5CB1 DoReturn:				     ; ...
DOSCODE:5CB1		     mov     al, [bp-1]	     ; FCBErr
DOSCODE:5CB4		     mov     sp, bp
DOSCODE:5CB6		     pop     bp
DOSCODE:5CB7		     retn
DOSCODE:5CB8
DOSCODE:5CB8 ; =============== S U B R O U T I N E =======================================
DOSCODE:5CB8
DOSCODE:5CB8
DOSCODE:5CB8 $FCB_OPEN	     proc near		     ; ...
DOSCODE:5CB8		     mov     ax, 2	     ; SHARING_COMPAT+open_for_both
DOSCODE:5CBB		     mov     cx, offset	DOS_OPEN
DOSCODE:5CBE
DOSCODE:5CBE DoAccess:				     ; ...
DOSCODE:5CBE		     push    ds
DOSCODE:5CBF		     push    dx
DOSCODE:5CC0		     push    cx
DOSCODE:5CC1		     push    ax
DOSCODE:5CC2		     mov     di, offset	OPENBUF
DOSCODE:5CC5		     call    TransFCB
DOSCODE:5CC8		     pop     ax
DOSCODE:5CC9		     pop     cx
DOSCODE:5CCA		     pop     dx
DOSCODE:5CCB		     pop     ds
DOSCODE:5CCC		     jnb     short FindFCB
DOSCODE:5CCE
DOSCODE:5CCE FCBOpenErr:			     ; ...
DOSCODE:5CCE		     jmp     FCB_RET_ER
DOSCODE:5CD1 ; ---------------------------------------------------------------------------
DOSCODE:5CD1
DOSCODE:5CD1 FindFCB:				     ; ...
DOSCODE:5CD1		     call    GetExtended
DOSCODE:5CD4		     push    ax
DOSCODE:5CD5		     mov     al, 1
DOSCODE:5CD7		     call    LRUFCB
DOSCODE:5CDA		     pop     ax
DOSCODE:5CDB		     jb	     short HardMessage
DOSCODE:5CDD		     mov     word ptr es:[di+2], 8000h ; [es:di+SF_ENTRY.sf_mode],
DOSCODE:5CDD					     ; sf_isFCB
DOSCODE:5CE3		     push    ds
DOSCODE:5CE4		     push    si
DOSCODE:5CE5		     push    bx
DOSCODE:5CE6		     mov     si, cx
DOSCODE:5CE8		     push    ss
DOSCODE:5CE9		     pop     ds
DOSCODE:5CEA		     call    si
DOSCODE:5CEC		     pop     bx
DOSCODE:5CED		     pop     si
DOSCODE:5CEE		     pop     ds
DOSCODE:5CEF		     les     di, ss:THISSFT
DOSCODE:5CF4		     jnb     short FCBOK
DOSCODE:5CF6		     push    ax
DOSCODE:5CF7		     mov     al, 'R'         ; 52h
DOSCODE:5CF9		     call    BlastSFT
DOSCODE:5CFC		     pop     ax
DOSCODE:5CFD		     cmp     ax, 4	     ; error_too_many_open_files
DOSCODE:5D00		     jz	     short HardMessage
DOSCODE:5D02		     cmp     ax, 24h	     ; error_sharing_buffer_exceeded
DOSCODE:5D05		     jnz     short DeadFCB
DOSCODE:5D07
DOSCODE:5D07 HardMessage:			     ; ...
DOSCODE:5D07		     push    ax
DOSCODE:5D08		     call    FCBHardErr
DOSCODE:5D0B		     pop     ax
DOSCODE:5D0C
DOSCODE:5D0C DeadFCB:				     ; ...
DOSCODE:5D0C		     jmp     short FCBOpenErr
DOSCODE:5D0E ; ---------------------------------------------------------------------------
DOSCODE:5D0E
DOSCODE:5D0E FCBOK:				     ; ...
DOSCODE:5D0E		     call    IsSFTNet
DOSCODE:5D11		     jnz     short FCBOK2
DOSCODE:5D13		     call    CheckShare
DOSCODE:5D16		     jnz     short FCBOK2
DOSCODE:5D18		     mov     word ptr ss:LocalSFT, di
DOSCODE:5D1D		     mov     word ptr ss:LocalSFT+2, es
DOSCODE:5D22
DOSCODE:5D22 FCBOK2:				     ; ...
DOSCODE:5D22		     inc     word ptr es:[di] ;	[ES:DI+SF_ENTRY.sf_ref_count]
DOSCODE:5D25		     call    SaveFCBInfo
DOSCODE:5D28		     test    byte ptr es:[di+5], 80h ; [ES:DI+SF_ENTRY.sf_flags],
DOSCODE:5D28					     ; devid_device
DOSCODE:5D2D		     jnz     short FCBNoDrive
DOSCODE:5D2F		     mov     al, [si]
DOSCODE:5D31		     call    GETTHISDRV
DOSCODE:5D34		     inc     al
DOSCODE:5D36		     mov     [si], al
DOSCODE:5D38
DOSCODE:5D38 FCBNoDrive:			     ; ...
DOSCODE:5D38		     mov     word ptr [si+0Eh],	128 ; [SI+SYS_FCB.RECSIZ]
DOSCODE:5D3D		     mov     ax, es:[di+0Dh] ; [ES:DI+SF_ENTRY.sf_time]
DOSCODE:5D41		     mov     [si+16h], ax    ; [SI+SYS_FCB.FTIME]
DOSCODE:5D44		     mov     ax, es:[di+0Fh] ; [ES:DI+SF_ENTRY.sf_date]
DOSCODE:5D48		     mov     [si+14h], ax    ; [SI+SYS_FCB.FDATE]
DOSCODE:5D4B		     mov     ax, es:[di+11h] ; [ES:DI+SF_ENTRY.sf_size]
DOSCODE:5D4F		     mov     [si+10h], ax    ; [SI+SYS_FCB.FILSIZ]
DOSCODE:5D52		     mov     ax, es:[di+13h] ; [ES:DI+SF_ENTRY.sf_size+2]
DOSCODE:5D56		     mov     [si+12h], ax    ; [SI+SYS_FCB.FILSIZ+2]
DOSCODE:5D59		     xor     ax, ax
DOSCODE:5D5B		     mov     [si+0Ch], ax    ; [SI+SYS_FCB.EXTENT]
DOSCODE:5D5E		     les     di, ss:SFTFCB
DOSCODE:5D63		     mov     ah, es:[di+4]   ; [ES:DI+SFT.SFCount]
DOSCODE:5D67
DOSCODE:5D67 OpenScan:				     ; ...
DOSCODE:5D67		     cmp     al, [si+18h]    ; [SI+fcb_sfn]
DOSCODE:5D6A		     jz	     short SkipCheck
DOSCODE:5D6C		     push    ax
DOSCODE:5D6D		     call    CheckFCB
DOSCODE:5D70		     pop     ax
DOSCODE:5D71		     jnb     short OpenFound
DOSCODE:5D73
DOSCODE:5D73 SkipCheck:				     ; ...
DOSCODE:5D73		     inc     al
DOSCODE:5D75		     cmp     al, ah
DOSCODE:5D77		     jnz     short OpenScan
DOSCODE:5D79
DOSCODE:5D79 OpenDone:				     ; ...
DOSCODE:5D79		     xor     al, al
DOSCODE:5D7B		     retn
DOSCODE:5D7C ; ---------------------------------------------------------------------------
DOSCODE:5D7C
DOSCODE:5D7C OpenFound:				     ; ...
DOSCODE:5D7C		     mov     [si+18h], al    ; [SI+fcb_sfn]
DOSCODE:5D7F		     inc     word ptr es:[di] ;	[ES:DI+SF_ENTRY.sf_ref_count]
DOSCODE:5D82		     mov     ax, ss:FCBLRU
DOSCODE:5D86		     mov     es:[di+15h], ax ; [ES:DI+sf_LRU]
DOSCODE:5D8A		     push    ss
DOSCODE:5D8B		     pop     ds
DOSCODE:5D8C		     les     di, ds:THISSFT
DOSCODE:5D90		     dec     word ptr es:[di] ;	[ES:DI+SF_ENTRY.sf_ref_count]
DOSCODE:5D93		     call    ShareEnd
DOSCODE:5D96		     mov     al, 'C'         ; 43h
DOSCODE:5D98		     call    BlastSFT
DOSCODE:5D9B		     jmp     short OpenDone
DOSCODE:5D9B $FCB_OPEN	     endp
DOSCODE:5D9B
DOSCODE:5D9D ; ---------------------------------------------------------------------------
DOSCODE:5D9D
DOSCODE:5D9D $FCB_CREATE:			     ; ...
DOSCODE:5D9D		     mov     cx, offset	DOS_CREATE
DOSCODE:5DA0		     xor     ax, ax
DOSCODE:5DA2		     call    GetExtended
DOSCODE:5DA5		     jz	     short DoAccessJ
DOSCODE:5DA7		     mov     al, [si-1]
DOSCODE:5DAA
DOSCODE:5DAA DoAccessJ:				     ; ...
DOSCODE:5DAA		     jmp     DoAccess
DOSCODE:5DAD ; ---------------------------------------------------------------------------
DOSCODE:5DAD
DOSCODE:5DAD $FCB_RANDOM_WRITE_BLOCK:		     ; ...
DOSCODE:5DAD		     mov     al, 0Ah	     ; RANDOM+BLOCK
DOSCODE:5DAF		     jmp     FCBIO
DOSCODE:5DB2 ; ---------------------------------------------------------------------------
DOSCODE:5DB2
DOSCODE:5DB2 $FCB_RANDOM_READ_BLOCK:		     ; ...
DOSCODE:5DB2		     mov     al, 0Eh	     ; RANDOM+FCBREAD+BLOCK
DOSCODE:5DB4		     jmp     FCBIO
DOSCODE:5DB7 ; ---------------------------------------------------------------------------
DOSCODE:5DB7
DOSCODE:5DB7 $FCB_SEQ_READ:			     ; ...
DOSCODE:5DB7		     mov     al, 4	     ; FCBREAD
DOSCODE:5DB9		     jmp     FCBIO
DOSCODE:5DBC ; ---------------------------------------------------------------------------
DOSCODE:5DBC
DOSCODE:5DBC $FCB_SEQ_WRITE:			     ; ...
DOSCODE:5DBC		     mov     al, 0
DOSCODE:5DBE		     jmp     FCBIO
DOSCODE:5DC1 ; ---------------------------------------------------------------------------
DOSCODE:5DC1
DOSCODE:5DC1 $FCB_RANDOM_READ:			     ; ...
DOSCODE:5DC1		     mov     al, 6	     ; RANDOM+FCBREAD
DOSCODE:5DC3		     jmp     FCBIO
DOSCODE:5DC6 ; ---------------------------------------------------------------------------
DOSCODE:5DC6
DOSCODE:5DC6 $FCB_RANDOM_WRITE:			     ; ...
DOSCODE:5DC6		     mov     al, 2	     ; RANDOM
DOSCODE:5DC8		     jmp     FCBIO
DOSCODE:5DCB ; ---------------------------------------------------------------------------
DOSCODE:5DCB
DOSCODE:5DCB $DIR_SEARCH_FIRST:			     ; ...
DOSCODE:5DCB		     mov     word ptr ss:THISFCB, dx
DOSCODE:5DD0		     mov     word ptr ss:THISFCB+2, ds
DOSCODE:5DD5		     mov     si, dx
DOSCODE:5DD7		     cmp     byte ptr [si], 0FFh
DOSCODE:5DDA		     jnz     short NORMFCB4
DOSCODE:5DDC		     add     si, 7
DOSCODE:5DDF
DOSCODE:5DDF NORMFCB4:				     ; ...
DOSCODE:5DDF		     push    word ptr [si]
DOSCODE:5DE1		     push    ss
DOSCODE:5DE2		     pop     es
DOSCODE:5DE3		     mov     di, offset	OPENBUF
DOSCODE:5DE6		     call    TransFCB
DOSCODE:5DE9		     jnb     short SearchIt
DOSCODE:5DEB		     pop     bx
DOSCODE:5DEC
DOSCODE:5DEC dcf_errj:				     ; ...
DOSCODE:5DEC		     jmp     FCB_RET_ER
DOSCODE:5DEF ; ---------------------------------------------------------------------------
DOSCODE:5DEF
DOSCODE:5DEF SearchIt:				     ; ...
DOSCODE:5DEF		     push    ss
DOSCODE:5DF0		     pop     ds
DOSCODE:5DF1		     push    word ptr ds:DMAADD
DOSCODE:5DF5		     push    word ptr ds:DMAADD+2
DOSCODE:5DF9		     mov     word ptr ds:DMAADD, offset	SEARCHBUF
DOSCODE:5DFF		     mov     word ptr ds:DMAADD+2, ds
DOSCODE:5E03		     call    GET_FAST_SEARCH
DOSCODE:5E06		     pop     word ptr ds:DMAADD+2
DOSCODE:5E0A		     pop     word ptr ds:DMAADD
DOSCODE:5E0E		     jnb     short SearchSet
DOSCODE:5E10		     pop     bx
DOSCODE:5E11		     jmp     short dcf_errj
DOSCODE:5E13 ; ---------------------------------------------------------------------------
DOSCODE:5E13
DOSCODE:5E13 SearchSet:				     ; ...
DOSCODE:5E13		     mov     si, offset	SEARCHBUF
DOSCODE:5E16		     les     di, ds:THISFCB
DOSCODE:5E1A		     test    ds:EXTFCB,	0FFh
DOSCODE:5E1F		     jz	     short NORMFCB1
DOSCODE:5E21		     add     di, 7
DOSCODE:5E24
DOSCODE:5E24 NORMFCB1:				     ; ...
DOSCODE:5E24		     pop     bx
DOSCODE:5E25		     or	     bl, bl
DOSCODE:5E27		     jnz     short SearchDrv
DOSCODE:5E29		     mov     bl, ds:CURDRV
DOSCODE:5E2D		     inc     bl
DOSCODE:5E2F
DOSCODE:5E2F SearchDrv:				     ; ...
DOSCODE:5E2F		     lodsb
DOSCODE:5E30		     xchg    al, bl
DOSCODE:5E32		     inc     di
DOSCODE:5E33		     mov     cx, 10	     ; 20/2
DOSCODE:5E36		     rep movsw
DOSCODE:5E38		     xchg    al, bl
DOSCODE:5E3A		     stosb
DOSCODE:5E3B		     les     di, ds:DMAADD
DOSCODE:5E3F		     test    ds:EXTFCB,	0FFh
DOSCODE:5E44		     jz	     short NORMFCB2
DOSCODE:5E46		     mov     al, 0FFh
DOSCODE:5E48		     stosb
DOSCODE:5E49		     inc     al
DOSCODE:5E4B		     mov     cx, 5
DOSCODE:5E4E		     rep stosb
DOSCODE:5E50		     mov     al, ds:SATTRIB
DOSCODE:5E53		     stosb
DOSCODE:5E54
DOSCODE:5E54 NORMFCB2:				     ; ...
DOSCODE:5E54		     mov     al, bl
DOSCODE:5E56		     stosb
DOSCODE:5E57		     mov     cx, 16
DOSCODE:5E5A		     rep movsw
DOSCODE:5E5C		     jmp     NO_OP	     ; FCB_RET_OK
DOSCODE:5E5F ; ---------------------------------------------------------------------------
DOSCODE:5E5F
DOSCODE:5E5F $DIR_SEARCH_NEXT:			     ; ...
DOSCODE:5E5F		     mov     word ptr ss:THISFCB, dx
DOSCODE:5E64		     mov     word ptr ss:THISFCB+2, ds
DOSCODE:5E69		     mov     ss:SATTRIB, 0
DOSCODE:5E6F		     mov     ss:EXTFCB,	0
DOSCODE:5E75		     push    ss
DOSCODE:5E76		     pop     es
DOSCODE:5E77		     mov     di, offset	SEARCHBUF
DOSCODE:5E7A		     mov     si, dx
DOSCODE:5E7C		     cmp     byte ptr [si], 0FFh
DOSCODE:5E7F		     jnz     short NORMFCB6
DOSCODE:5E81		     add     si, 6
DOSCODE:5E84		     lodsb
DOSCODE:5E85		     mov     ss:SATTRIB, al
DOSCODE:5E89		     dec     ss:EXTFCB
DOSCODE:5E8E
DOSCODE:5E8E NORMFCB6:				     ; ...
DOSCODE:5E8E		     lodsb
DOSCODE:5E8F		     push    ax
DOSCODE:5E90		     mov     al, [si+20]
DOSCODE:5E93		     stosb
DOSCODE:5E94		     mov     cx, 10	     ; 20/2
DOSCODE:5E97		     rep movsw
DOSCODE:5E99		     push    ss
DOSCODE:5E9A		     pop     ds
DOSCODE:5E9B		     push    word ptr ds:DMAADD
DOSCODE:5E9F		     push    word ptr ds:DMAADD+2
DOSCODE:5EA3		     mov     word ptr ds:DMAADD, offset	SEARCHBUF
DOSCODE:5EA9		     mov     word ptr ds:DMAADD+2, ds
DOSCODE:5EAD		     call    DOS_SEARCH_NEXT
DOSCODE:5EB0		     pop     word ptr ds:DMAADD+2
DOSCODE:5EB4		     pop     word ptr ds:DMAADD
DOSCODE:5EB8		     jb	     short SearchNoMore
DOSCODE:5EBA		     jmp     SearchSet
DOSCODE:5EBD ; ---------------------------------------------------------------------------
DOSCODE:5EBD
DOSCODE:5EBD SearchNoMore:			     ; ...
DOSCODE:5EBD		     les     di, ds:THISFCB
DOSCODE:5EC1		     test    ds:EXTFCB,	0FFh
DOSCODE:5EC6		     jz	     short NORMFCB8
DOSCODE:5EC8		     add     di, 7
DOSCODE:5ECB
DOSCODE:5ECB NORMFCB8:				     ; ...
DOSCODE:5ECB		     pop     bx
DOSCODE:5ECC		     mov     es:[di], bl
DOSCODE:5ECF		     jmp     FCB_RET_ER
DOSCODE:5ED2 ; ---------------------------------------------------------------------------
DOSCODE:5ED2
DOSCODE:5ED2 $FIND_FIRST:			     ; ...
DOSCODE:5ED2		     mov     si, dx
DOSCODE:5ED4		     mov     ss:SATTRIB, cl
DOSCODE:5ED9		     mov     di, offset	OPENBUF
DOSCODE:5EDC		     call    TransPathSet
DOSCODE:5EDF		     jnb     short Find_it
DOSCODE:5EE1
DOSCODE:5EE1 FindError:
DOSCODE:5EE1		     mov     al, 3
DOSCODE:5EE3
DOSCODE:5EE3 FF_errj:				     ; ...
DOSCODE:5EE3		     jmp     SYS_RET_ERR
DOSCODE:5EE6 ; ---------------------------------------------------------------------------
DOSCODE:5EE6
DOSCODE:5EE6 Find_it:				     ; ...
DOSCODE:5EE6		     push    ss
DOSCODE:5EE7		     pop     ds
DOSCODE:5EE8		     push    word ptr ds:DMAADD
DOSCODE:5EEC		     push    word ptr ds:DMAADD+2
DOSCODE:5EF0		     mov     word ptr ds:DMAADD, offset	SEARCHBUF
DOSCODE:5EF6		     mov     word ptr ds:DMAADD+2, ds
DOSCODE:5EFA		     call    GET_FAST_SEARCH
DOSCODE:5EFD		     pop     word ptr ds:DMAADD+2
DOSCODE:5F01		     pop     word ptr ds:DMAADD
DOSCODE:5F05		     jnb     short FindSet
DOSCODE:5F07
DOSCODE:5F07 FFF_errj:				     ; ...
DOSCODE:5F07		     jmp     short FF_errj
DOSCODE:5F09 ; ---------------------------------------------------------------------------
DOSCODE:5F09
DOSCODE:5F09 FindSet:				     ; ...
DOSCODE:5F09		     mov     si, offset	SEARCHBUF
DOSCODE:5F0C		     les     di, ds:DMAADD
DOSCODE:5F10		     mov     cx, 21
DOSCODE:5F13		     rep movsb
DOSCODE:5F15		     push    si
DOSCODE:5F16		     mov     al, [si+0Bh]    ; [SI+dir_entry.dir_attr]
DOSCODE:5F19		     stosb
DOSCODE:5F1A		     add     si, 16h	     ; dir_entry.dir_time
DOSCODE:5F1D		     movsw
DOSCODE:5F1E		     movsw
DOSCODE:5F1F		     inc     si
DOSCODE:5F20		     inc     si
DOSCODE:5F21		     movsw
DOSCODE:5F22		     movsw
DOSCODE:5F23		     pop     si
DOSCODE:5F24		     call    PackName
DOSCODE:5F27		     jmp     SYS_RETURN	     ; SYS_RET_OK
DOSCODE:5F2A ; ---------------------------------------------------------------------------
DOSCODE:5F2A
DOSCODE:5F2A $FIND_NEXT:			     ; ...
DOSCODE:5F2A		     push    ss
DOSCODE:5F2B		     pop     es
DOSCODE:5F2C		     mov     di, offset	SEARCHBUF
DOSCODE:5F2F		     lds     si, ss:DMAADD
DOSCODE:5F34		     mov     cx, 21
DOSCODE:5F37		     rep movsb
DOSCODE:5F39		     push    ss
DOSCODE:5F3A		     pop     ds
DOSCODE:5F3B		     push    word ptr ds:DMAADD
DOSCODE:5F3F		     push    word ptr ds:DMAADD+2
DOSCODE:5F43		     mov     word ptr ds:DMAADD, offset	SEARCHBUF
DOSCODE:5F49		     mov     word ptr ds:DMAADD+2, ds
DOSCODE:5F4D		     call    DOS_SEARCH_NEXT
DOSCODE:5F50		     pop     word ptr ds:DMAADD+2
DOSCODE:5F54		     pop     word ptr ds:DMAADD
DOSCODE:5F58		     jnb     short FindSet
DOSCODE:5F5A		     jmp     short FFF_errj
DOSCODE:5F5C
DOSCODE:5F5C ; =============== S U B R O U T I N E =======================================
DOSCODE:5F5C
DOSCODE:5F5C
DOSCODE:5F5C PackName	     proc near		     ; ...
DOSCODE:5F5C		     mov     cx, 8
DOSCODE:5F5F		     rep movsb
DOSCODE:5F61
DOSCODE:5F61 main_kill_tail:			     ; ...
DOSCODE:5F61		     cmp     byte ptr es:[di-1], 20h ; ' '
DOSCODE:5F66		     jnz     short find_check_dot
DOSCODE:5F68		     dec     di
DOSCODE:5F69		     inc     cx
DOSCODE:5F6A		     cmp     cx, 8
DOSCODE:5F6D		     jb	     short main_kill_tail
DOSCODE:5F6F
DOSCODE:5F6F find_check_dot:			     ; ...
DOSCODE:5F6F		     cmp     word ptr [si], 2020h ; (" " << 8) | " "
DOSCODE:5F73		     jnz     short got_ext
DOSCODE:5F75		     cmp     byte ptr [si+2], 20h ; ' '
DOSCODE:5F79		     jz	     short find_done
DOSCODE:5F7B
DOSCODE:5F7B got_ext:				     ; ...
DOSCODE:5F7B		     mov     al, '.'         ; 2Eh
DOSCODE:5F7D		     stosb
DOSCODE:5F7E		     mov     cx, 3
DOSCODE:5F81		     rep movsb
DOSCODE:5F83
DOSCODE:5F83 ext_kill_tail:			     ; ...
DOSCODE:5F83		     cmp     byte ptr es:[di-1], 20h ; ' '
DOSCODE:5F88		     jnz     short find_done
DOSCODE:5F8A		     dec     di
DOSCODE:5F8B		     jmp     short ext_kill_tail
DOSCODE:5F8D ; ---------------------------------------------------------------------------
DOSCODE:5F8D
DOSCODE:5F8D find_done:				     ; ...
DOSCODE:5F8D		     xor     ax, ax
DOSCODE:5F8F		     stosb
DOSCODE:5F90		     retn
DOSCODE:5F90 PackName	     endp
DOSCODE:5F90
DOSCODE:5F91
DOSCODE:5F91 ; =============== S U B R O U T I N E =======================================
DOSCODE:5F91
DOSCODE:5F91
DOSCODE:5F91 GET_FAST_SEARCH proc near		     ; ...
DOSCODE:5F91		     or	     ss:DOS34_FLAG, 400h ; SEARCH_FASTOPEN
DOSCODE:5F98		     call    DOS_SEARCH_FIRST
DOSCODE:5F9B		     retn
DOSCODE:5F9B GET_FAST_SEARCH endp
DOSCODE:5F9B
DOSCODE:5F9C ; ---------------------------------------------------------------------------
DOSCODE:5F9C
DOSCODE:5F9C $CURRENT_DIR:			     ; ...
DOSCODE:5F9C		     call    ECritDisk
DOSCODE:5F9F		     mov     al, dl
DOSCODE:5FA1		     call    GetVisDrv
DOSCODE:5FA4		     jnb     short CurrentValidate
DOSCODE:5FA6
DOSCODE:5FA6 CurdirErr:				     ; ...
DOSCODE:5FA6		     call    LCritDisk
DOSCODE:5FA9		     push    ds
DOSCODE:5FAA		     mov     ds, cs:DosDSeg
DOSCODE:5FAF		     mov     al, ds:DrvErr
DOSCODE:5FB2		     pop     ds
DOSCODE:5FB3
DOSCODE:5FB3 curdir_errj:			     ; ...
DOSCODE:5FB3		     jmp     SYS_RET_ERR
DOSCODE:5FB6 ; ---------------------------------------------------------------------------
DOSCODE:5FB6
DOSCODE:5FB6 CurrentValidate:			     ; ...
DOSCODE:5FB6		     push    ds
DOSCODE:5FB7		     push    si
DOSCODE:5FB8		     mov     ds, cs:DosDSeg
DOSCODE:5FBD		     lds     si, ds:THISCDS
DOSCODE:5FC1		     test    word ptr [si+43h],	8000h ;	[SI+curdir.flags],
DOSCODE:5FC1					     ; curdir_isnet
DOSCODE:5FC6		     jnz     short $+2
DOSCODE:5FC8
DOSCODE:5FC8 DoCheck:				     ; ...
DOSCODE:5FC8		     push    ds
DOSCODE:5FC9		     mov     ds, cs:DosDSeg
DOSCODE:5FCE		     mov     ds:NoSetDir, 0
DOSCODE:5FD3		     pop     ds
DOSCODE:5FD4		     mov     di, offset	OPENBUF
DOSCODE:5FD7		     call    ValidateCDS
DOSCODE:5FDA		     push    es
DOSCODE:5FDB		     push    di
DOSCODE:5FDC		     pop     si
DOSCODE:5FDD		     pop     ds
DOSCODE:5FDE		     pop     di
DOSCODE:5FDF		     pop     es
DOSCODE:5FE0		     jb	     short CurdirErr
DOSCODE:5FE2		     add     si, 0	     ; curdir.text
DOSCODE:5FE5		     add     si, [si+4Fh]    ; [SI+curdir.end]
DOSCODE:5FE8		     cmp     byte ptr [si], '\' ; 5Ch
DOSCODE:5FEB		     jnz     short CurrentCopy
DOSCODE:5FED		     inc     si
DOSCODE:5FEE
DOSCODE:5FEE CurrentCopy:			     ; ...
DOSCODE:5FEE		     push    ax
DOSCODE:5FEF		     lodsb
DOSCODE:5FF0		     or	     al, al
DOSCODE:5FF2		     jz	     short FOK
DOSCODE:5FF4		     cmp     al, 5
DOSCODE:5FF6		     jz	     short FCHANGE
DOSCODE:5FF8		     jmp     short FFF
DOSCODE:5FFA ; ---------------------------------------------------------------------------
DOSCODE:5FFA
DOSCODE:5FFA FCPYNEXT:				     ; ...
DOSCODE:5FFA		     lodsb
DOSCODE:5FFB
DOSCODE:5FFB FFF:				     ; ...
DOSCODE:5FFB		     cmp     al, '\'
DOSCODE:5FFD		     jnz     short FOK
DOSCODE:5FFF		     stosb
DOSCODE:6000		     lodsb
DOSCODE:6001		     cmp     al, 5
DOSCODE:6003		     jnz     short FOK
DOSCODE:6005
DOSCODE:6005 FCHANGE:				     ; ...
DOSCODE:6005		     mov     al, 0E5h
DOSCODE:6007
DOSCODE:6007 FOK:				     ; ...
DOSCODE:6007		     stosb
DOSCODE:6008		     or	     al, al
DOSCODE:600A		     jnz     short FCPYNEXT
DOSCODE:600C		     pop     ax
DOSCODE:600D		     xor     al, al
DOSCODE:600F		     call    LCritDisk
DOSCODE:6012		     jmp     SYS_RETURN
DOSCODE:6015 ; ---------------------------------------------------------------------------
DOSCODE:6015
DOSCODE:6015 $RMDIR:				     ; ...
DOSCODE:6015		     push    dx
DOSCODE:6016		     push    ds
DOSCODE:6017		     mov     si, dx
DOSCODE:6019		     mov     di, offset	OPENBUF
DOSCODE:601C		     push    di
DOSCODE:601D		     call    TransPathNoSet
DOSCODE:6020		     pop     di
DOSCODE:6021		     jnb     short rmlset
DOSCODE:6023		     pop     ds
DOSCODE:6024		     pop     dx
DOSCODE:6025		     mov     al, 3
DOSCODE:6027
DOSCODE:6027 rmdir_errj:			     ; ...
DOSCODE:6027		     jmp     short curdir_errj
DOSCODE:6029 ; ---------------------------------------------------------------------------
DOSCODE:6029
DOSCODE:6029 rmlset:				     ; ...
DOSCODE:6029		     cmp     ss:CMETA, 0FFh  ; -1
DOSCODE:602F		     jnz     short rmerr
DOSCODE:6031		     push    ss
DOSCODE:6032		     pop     es
DOSCODE:6033		     xor     al, al
DOSCODE:6035
DOSCODE:6035 rmloop:				     ; ...
DOSCODE:6035		     call    GetCDSFromDrv
DOSCODE:6038		     jb	     short rmcont
DOSCODE:603A		     call    StrCmp
DOSCODE:603D		     jz	     short rmerr
DOSCODE:603F		     inc     al
DOSCODE:6041		     jmp     short rmloop
DOSCODE:6043 ; ---------------------------------------------------------------------------
DOSCODE:6043
DOSCODE:6043 rmerr:				     ; ...
DOSCODE:6043		     pop     ds
DOSCODE:6044		     pop     dx
DOSCODE:6045		     mov     al, 10h	     ; error_current_directory
DOSCODE:6047
DOSCODE:6047 chdir_errj:			     ; ...
DOSCODE:6047		     jmp     short rmdir_errj
DOSCODE:6049 ; ---------------------------------------------------------------------------
DOSCODE:6049
DOSCODE:6049 rmcont:				     ; ...
DOSCODE:6049		     pop     ds
DOSCODE:604A		     pop     dx
DOSCODE:604B		     mov     si, offset	DOS_RMDIR
DOSCODE:604E		     jmp     DoDirCall
DOSCODE:6051 ; ---------------------------------------------------------------------------
DOSCODE:6051
DOSCODE:6051 $CHDIR:				     ; ...
DOSCODE:6051		     mov     di, offset	OPENBUF
DOSCODE:6054		     mov     si, dx
DOSCODE:6056		     call    TransPath
DOSCODE:6059		     jnb     short ChDirCrack
DOSCODE:605B
DOSCODE:605B ChDirErrP:				     ; ...
DOSCODE:605B		     mov     al, 3	     ; error_path_not_found
DOSCODE:605D
DOSCODE:605D ChDirErr:				     ; ...
DOSCODE:605D		     jmp     short chdir_errj
DOSCODE:605F ; ---------------------------------------------------------------------------
DOSCODE:605F
DOSCODE:605F ChDirCrack:			     ; ...
DOSCODE:605F		     cmp     ds:CMETA, 0FFh  ; -1
DOSCODE:6064		     jnz     short ChDirErrP
DOSCODE:6066		     les     di, ds:THISCDS
DOSCODE:606A		     cmp     di, 0FFFFh	     ; -1
DOSCODE:606D		     jz	     short ChDirErrP
DOSCODE:606F		     call    DOS_CHDIR
DOSCODE:6072		     jb	     short ChDirErr
DOSCODE:6074		     les     di, ds:THISCDS
DOSCODE:6078		     test    word ptr es:[di+43h], 2000h ; [ES:DI+curdir.flags],
DOSCODE:6078					     ; curdir_splice
DOSCODE:607E		     jz	     short GotCDS
DOSCODE:6080		     push    es
DOSCODE:6081		     push    di
DOSCODE:6082		     push    cx
DOSCODE:6083		     call    Get_User_Stack
DOSCODE:6086		     mov     di, [si+6]	     ; [SI+user_env.user_DX]
DOSCODE:6089		     mov     ds, word ptr [si+0Eh] ; [SI+user_env.user_DS]
DOSCODE:608C		     mov     si, offset	OPENBUF
DOSCODE:608F		     xchg    si, di
DOSCODE:6091		     xor     al, al
DOSCODE:6093		     push    di
DOSCODE:6094		     call    TransPathNoSet
DOSCODE:6097		     pop     si
DOSCODE:6098		     les     di, ds:THISCDS
DOSCODE:609C		     mov     word ptr es:[di+49h], 0FFFFh ; [ES:DI+curdir.ID]
DOSCODE:60A2		     pop     cx
DOSCODE:60A3		     pop     di
DOSCODE:60A4		     pop     es
DOSCODE:60A5
DOSCODE:60A5 GotCDS:				     ; ...
DOSCODE:60A5		     call    Check_PathLen
DOSCODE:60A8		     ja	     short ChDirErrP
DOSCODE:60AA		     test    word ptr es:[di+43h], 8000h ; [ES:DI+curdir.flags],
DOSCODE:60AA					     ; curdir_isnet
DOSCODE:60B0		     jnz     short SkipRecency
DOSCODE:60B2		     test    word ptr es:[di+43h], 2000h ; [ES:DI+curdir.flags],
DOSCODE:60B2					     ; curdir_splice
DOSCODE:60B8		     jz	     short setdirclus
DOSCODE:60BA		     mov     cx, 0FFFFh	     ; -1
DOSCODE:60BD
DOSCODE:60BD setdirclus:			     ; ...
DOSCODE:60BD		     mov     es:[di+49h], cx ; [ES:DI+curdir.ID]
DOSCODE:60C1		     les     di, ds:THISCDS
DOSCODE:60C5
DOSCODE:60C5 SkipRecency:			     ; ...
DOSCODE:60C5		     call    FStrCpy
DOSCODE:60C8		     xor     al, al
DOSCODE:60CA
DOSCODE:60CA mkdir_ok:				     ; ...
DOSCODE:60CA		     jmp     SYS_RETURN
DOSCODE:60CD ; ---------------------------------------------------------------------------
DOSCODE:60CD
DOSCODE:60CD $MKDIR:				     ; ...
DOSCODE:60CD		     mov     si, offset	DOS_MKDIR
DOSCODE:60D0
DOSCODE:60D0 DoDirCall:				     ; ...
DOSCODE:60D0		     mov     di, offset	OPENBUF
DOSCODE:60D3		     push    si
DOSCODE:60D4		     mov     si, dx
DOSCODE:60D6		     call    TransPath
DOSCODE:60D9		     pop     si
DOSCODE:60DA		     jnb     short MkDirCrack
DOSCODE:60DC
DOSCODE:60DC MkErrP:				     ; ...
DOSCODE:60DC		     mov     al, 3	     ; error_path_not_found
DOSCODE:60DE
DOSCODE:60DE MkErr:				     ; ...
DOSCODE:60DE		     jmp     SYS_RET_ERR
DOSCODE:60E1 ; ---------------------------------------------------------------------------
DOSCODE:60E1
DOSCODE:60E1 MkDirCrack:			     ; ...
DOSCODE:60E1		     cmp     ss:CMETA, 0FFh  ; -1
DOSCODE:60E7		     jnz     short MkErrP
DOSCODE:60E9		     push    si
DOSCODE:60EA		     call    Check_PathLen
DOSCODE:60ED		     pop     si
DOSCODE:60EE		     jbe     short pathok
DOSCODE:60F0		     mov     al, 5	     ; error_access_denied
DOSCODE:60F2		     jmp     short MkErr
DOSCODE:60F4 ; ---------------------------------------------------------------------------
DOSCODE:60F4
DOSCODE:60F4 pathok:				     ; ...
DOSCODE:60F4		     call    si
DOSCODE:60F6		     jb	     short MkErr
DOSCODE:60F8		     jmp     short mkdir_ok
DOSCODE:60FA
DOSCODE:60FA ; =============== S U B R O U T I N E =======================================
DOSCODE:60FA
DOSCODE:60FA
DOSCODE:60FA Check_PathLen   proc near		     ; ...
DOSCODE:60FA		     mov     si, ss:WFP_START
DOSCODE:60FF
DOSCODE:60FF Check_PathLen2:			     ; ...
DOSCODE:60FF		     push    ss
DOSCODE:6100		     pop     ds
DOSCODE:6101		     push    cx
DOSCODE:6102		     call    DStrLen
DOSCODE:6105		     cmp     cx, 67	     ; DIRSTRLEN
DOSCODE:6108		     pop     cx
DOSCODE:6109		     retn
DOSCODE:6109 Check_PathLen   endp
DOSCODE:6109
DOSCODE:6109 ; ---------------------------------------------------------------------------
DOSCODE:610A IOCTLJMPTABLE   dw	offset ioctl_getset_data ; ...
DOSCODE:610C		     dw	offset ioctl_getset_data
DOSCODE:610E		     dw	offset ioctl_control_string
DOSCODE:6110		     dw	offset ioctl_control_string
DOSCODE:6112		     dw	offset ioctl_get_dev
DOSCODE:6114		     dw	offset ioctl_get_dev
DOSCODE:6116		     dw	offset ioctl_status
DOSCODE:6118		     dw	offset ioctl_status
DOSCODE:611A		     dw	offset ioctl_rem_media
DOSCODE:611C		     dw	offset ioctl_drive_attr
DOSCODE:611E		     dw	offset ioctl_handle_redir
DOSCODE:6120		     dw	offset Set_Retry_Parameters
DOSCODE:6122		     dw	offset GENERICIOCTLHANDLE
DOSCODE:6124		     dw	offset GENERICIOCTL
DOSCODE:6126		     dw	offset ioctl_drive_owner
DOSCODE:6128		     dw	offset ioctl_drive_owner
DOSCODE:612A		     dw	offset GENERICIOCTLHANDLE
DOSCODE:612C		     dw	offset GENERICIOCTL
DOSCODE:612E
DOSCODE:612E ; =============== S U B R O U T I N E =======================================
DOSCODE:612E
DOSCODE:612E
DOSCODE:612E $IOCTL	     proc near		     ; ...
DOSCODE:612E
DOSCODE:612E ; FUNCTION	CHUNK AT DOSCODE:628F SIZE 00000003 BYTES
DOSCODE:612E ; FUNCTION	CHUNK AT DOSCODE:62DF SIZE 00000002 BYTES
DOSCODE:612E ; FUNCTION	CHUNK AT DOSCODE:62E3 SIZE 00000003 BYTES
DOSCODE:612E ; FUNCTION	CHUNK AT DOSCODE:62F4 SIZE 00000003 BYTES
DOSCODE:612E ; FUNCTION	CHUNK AT DOSCODE:62FC SIZE 0000005E BYTES
DOSCODE:612E
DOSCODE:612E		     mov     si, ds
DOSCODE:6130		     push    ss
DOSCODE:6131		     pop     ds
DOSCODE:6132		     cmp     al, 11h
DOSCODE:6134		     ja	     short ioctl_bad_funj2
DOSCODE:6136		     push    ax
DOSCODE:6137		     mov     di, ax
DOSCODE:6139		     and     di, 0FFh
DOSCODE:613D		     shl     di, 1
DOSCODE:613F		     pop     ax
DOSCODE:6140		     jmp     cs:IOCTLJMPTABLE[di]
DOSCODE:6145 ; ---------------------------------------------------------------------------
DOSCODE:6145
DOSCODE:6145 ioctl_bad_funj2:			     ; ...
DOSCODE:6145		     jmp     ioctl_bad_fun
DOSCODE:6148 ; ---------------------------------------------------------------------------
DOSCODE:6148
DOSCODE:6148 ioctl_getset_data:			     ; ...
DOSCODE:6148		     call    SFFromHandle
DOSCODE:614B		     jnb     short ioctl_check_permissions
DOSCODE:614D
DOSCODE:614D ioctl_bad_handle:			     ; ...
DOSCODE:614D		     mov     al, 6	     ; error_invalid_handle
DOSCODE:614F
DOSCODE:614F ioctl_error:			     ; ...
DOSCODE:614F		     jmp     SYS_RET_ERR
DOSCODE:6152 ; ---------------------------------------------------------------------------
DOSCODE:6152
DOSCODE:6152 ioctl_check_permissions:		     ; ...
DOSCODE:6152		     cmp     al, 0
DOSCODE:6154		     mov     al, es:[di+5]   ; [ES:DI+SF_ENTRY.sf_flags]
DOSCODE:6158		     jz	     short ioctl_read
DOSCODE:615A		     or	     dh, dh
DOSCODE:615C		     jz	     short ioctl_check_device
DOSCODE:615E		     mov     al, 0Dh	     ; error_invalid_data
DOSCODE:6160		     jmp     short ioctl_error
DOSCODE:6162 ; ---------------------------------------------------------------------------
DOSCODE:6162
DOSCODE:6162 ioctl_check_device:		     ; ...
DOSCODE:6162		     test    al, 80h	     ; devid_device
DOSCODE:6164		     jz	     short ioctl_bad_funj2
DOSCODE:6166		     or	     dl, 80h	     ; devid_device
DOSCODE:6169		     mov     ds:EXTERR_LOCUS, 4	; errLOC_SerDev
DOSCODE:616E		     mov     es:[di+5],	dl   ; [ES:DI+SF_ENTRY.sf_flags]
DOSCODE:6172
DOSCODE:6172 ioctl_ok:				     ; ...
DOSCODE:6172		     jmp     SYS_RETURN	     ; SYS_RET_OK
DOSCODE:6175 ; ---------------------------------------------------------------------------
DOSCODE:6175
DOSCODE:6175 ioctl_read:			     ; ...
DOSCODE:6175		     mov     ds:EXTERR_LOCUS, 2
DOSCODE:617A		     xor     ah, ah
DOSCODE:617C		     test    al, 80h	     ; devid_device
DOSCODE:617E		     jz	     short ioctl_no_high
DOSCODE:6180		     mov     ds:EXTERR_LOCUS, 4	; errLOC_SerDev
DOSCODE:6185		     les     di, es:[di+7]   ; [ES:DI+SF_ENTRY.sf_devptr]
DOSCODE:6189		     mov     ah, es:[di+5]   ; [ES:DI+SYSDEV.ATT+1]
DOSCODE:618D
DOSCODE:618D ioctl_no_high:			     ; ...
DOSCODE:618D		     mov     dx, ax
DOSCODE:618F		     call    Get_User_Stack
DOSCODE:6192		     mov     [si+6], dx	     ; [SI+user_env.user_DX]
DOSCODE:6195
DOSCODE:6195 ioctl_ok_j:			     ; ...
DOSCODE:6195		     jmp     short ioctl_ok
DOSCODE:6197 ; ---------------------------------------------------------------------------
DOSCODE:6197
DOSCODE:6197 ioctl_control_string:		     ; ...
DOSCODE:6197		     call    SFFromHandle
DOSCODE:619A		     jb	     short ioctl_bad_handle
DOSCODE:619C		     test    byte ptr es:[di+5], 80h ; [ES:DI+SF_ENTRY.sf_flags],
DOSCODE:619C					     ; devid_device
DOSCODE:61A1		     jz	     short ioctl_bad_funj2
DOSCODE:61A3		     mov     ds:EXTERR_LOCUS, 4	; [EXTERR_LOCUS],errLOC_SerDev
DOSCODE:61A8		     les     di, es:[di+7]   ; [ES:DI+SF_ENTRY.sf_devptr]
DOSCODE:61AC		     xor     bl, bl
DOSCODE:61AE		     jmp     ioctl_do_string
DOSCODE:61B1 ; ---------------------------------------------------------------------------
DOSCODE:61B1
DOSCODE:61B1 ioctl_status:			     ; ...
DOSCODE:61B1		     mov     ah, 1
DOSCODE:61B3		     sub     al, 6
DOSCODE:61B5		     jz	     short ioctl_get_status
DOSCODE:61B7		     mov     ah, 3
DOSCODE:61B9
DOSCODE:61B9 ioctl_get_status:			     ; ...
DOSCODE:61B9		     push    ax
DOSCODE:61BA		     call    GET_IO_SFT
DOSCODE:61BD		     pop     ax
DOSCODE:61BE		     jnb     short DO_IOFUNC
DOSCODE:61C0		     jmp     short ioctl_bad_handle
DOSCODE:61C2 ; ---------------------------------------------------------------------------
DOSCODE:61C2
DOSCODE:61C2 DO_IOFUNC:				     ; ...
DOSCODE:61C2		     call    IOFUNC
DOSCODE:61C5		     mov     ah, al
DOSCODE:61C7		     mov     al, 0FFh
DOSCODE:61C9		     jnz     short ioctl_status_ret
DOSCODE:61CB		     inc     al
DOSCODE:61CD
DOSCODE:61CD ioctl_status_ret:			     ; ...
DOSCODE:61CD		     jmp     short ioctl_ok_j
DOSCODE:61CF ; ---------------------------------------------------------------------------
DOSCODE:61CF
DOSCODE:61CF Set_Retry_Parameters:		     ; ...
DOSCODE:61CF		     mov     ds:RetryLoop, cx
DOSCODE:61D3		     or	     dx, dx
DOSCODE:61D5		     jz	     short ioctl_bad_fun
DOSCODE:61D7		     mov     ds:RetryCount, dx
DOSCODE:61DB		     jmp     short ioctl_status_ret
DOSCODE:61DD ; ---------------------------------------------------------------------------
DOSCODE:61DD
DOSCODE:61DD GENERICIOCTLHANDLE:		     ; ...
DOSCODE:61DD		     call    SFFromHandle
DOSCODE:61E0		     jb	     short ioctl_bad_handlej
DOSCODE:61E2		     test    byte ptr es:[di+6], 80h ; [ES:DI+SF_ENTRY.sf_flags+1],
DOSCODE:61E2					     ; (sf_isnet>>8)
DOSCODE:61E7		     jnz     short ioctl_bad_fun
DOSCODE:61E9		     mov     ds:EXTERR_LOCUS, 4	; errLOC_SerDev
DOSCODE:61EE		     les     di, es:[di+7]   ; [es:di+SF_ENTRY.sf_devptr]
DOSCODE:61F2		     jmp     short Do_GenIOCTL
DOSCODE:61F4 ; ---------------------------------------------------------------------------
DOSCODE:61F4
DOSCODE:61F4 GENERICIOCTL:			     ; ...
DOSCODE:61F4		     mov     ds:EXTERR_LOCUS, 2	; errLOC_Disk
DOSCODE:61F9		     cmp     ch, 8	     ; IOC_DC
DOSCODE:61FC		     jnz     short ioctl_bad_fun
DOSCODE:61FE		     call    Check_If_Net
DOSCODE:6201		     jnz     short ioctl_bad_fun
DOSCODE:6203
DOSCODE:6203 Do_GenIOCTL:			     ; ...
DOSCODE:6203		     test    byte ptr es:[di+4], 40h ; [ES:DI+SYSDEV.ATT],
DOSCODE:6203					     ; DEV320
DOSCODE:6208		     jz	     short ioctl_bad_fun
DOSCODE:620A		     mov     ds:IOCALL_REQFUNC,	13h ; GENIOCTL
DOSCODE:620F		     cmp     al, 10h	     ; IOCTL_QUERY_HANDLE
DOSCODE:6211		     jl	     short SetIOCtlBlock
DOSCODE:6213		     test    byte ptr es:[di+4], 80h ; [ES:DI+SYSDEV.ATT],IOQUERY
DOSCODE:6218		     jz	     short ioctl_bad_fun
DOSCODE:621A		     mov     ds:IOCALL_REQFUNC,	19h ; IOCTL_QUERY
DOSCODE:621F
DOSCODE:621F SetIOCtlBlock:			     ; ...
DOSCODE:621F		     push    es
DOSCODE:6220		     push    di
DOSCODE:6221		     mov     ds:IOCALL_REQLEN, 17h ; IOCTL_REQ.size
DOSCODE:6226		     mov     ds:IOCALL_REQUNIT,	bl
DOSCODE:622A		     mov     ds:IOCTL_REQ_MAJORFUNCTION, ch ; [IOCALL+IOCTL_REQ.MAJORFUNCTION]
DOSCODE:622E		     mov     ds:IOCTL_REQ_MINORFUNCTION, cl ; [IOCALL+IOCTL_REQ.MINORFUNCTION]
DOSCODE:6232		     mov     word ptr ds:IOCTL_REQ_REG_SI, si ;	[IOCALL+IOCTL_REQ.REG_SI]
DOSCODE:6236		     mov     word ptr ds:IOCTL_REQ_REG_DI, di ;	[IOCALL+IOCTL_REQ.REG_DI]
DOSCODE:623A		     mov     ds:IOCTL_REQ_GENERICIOCTL_PACKET, dx ; [IOCALL+IOCTL_REQ.GENERICIOCTL_PACKET]
DOSCODE:623E		     mov     word ptr ds:IOCTL_REQ_GENERICIOCTL_PACKET_2, si ; [IOCALL+IOCTL_REQ.GENERICIOCTL_PACKET+2]
DOSCODE:6242		     mov     bx, offset	IOCALL_REQLEN ;	IOCALL
DOSCODE:6245		     push    ss
DOSCODE:6246		     pop     es
DOSCODE:6247		     pop     si
DOSCODE:6248		     pop     ds
DOSCODE:6249		     jmp     ioctl_do_IO
DOSCODE:624C ; ---------------------------------------------------------------------------
DOSCODE:624C
DOSCODE:624C ioctl_bad_fun:			     ; ...
DOSCODE:624C		     mov     al, 1	     ; error_invalid_function
DOSCODE:624E		     jmp     SYS_RET_ERR
DOSCODE:6251 ; ---------------------------------------------------------------------------
DOSCODE:6251
DOSCODE:6251 ioctl_bad_handlej:			     ; ...
DOSCODE:6251		     jmp     ioctl_bad_handle
DOSCODE:6251 $IOCTL	     endp
DOSCODE:6251
DOSCODE:6254 ; ---------------------------------------------------------------------------
DOSCODE:6254
DOSCODE:6254 ioctl_rem_media:			     ; ...
DOSCODE:6254		     call    Check_If_Net
DOSCODE:6257		     jnz     short ioctl_bad_fun
DOSCODE:6259		     test    byte ptr es:[di+5], 8 ; [es:di+SYSDEV.ATT+1],
DOSCODE:6259					     ; (DEVOPCL>>8)
DOSCODE:625E		     jz	     short ioctl_bad_fun
DOSCODE:6260		     mov     ss:IOCALL_REQFUNC,	0Fh ; DEVRMD ; 15
DOSCODE:6266		     mov     al, 0Dh	     ; REMHL ; 13
DOSCODE:6268		     mov     ah, bl
DOSCODE:626A		     mov     word ptr ss:IOCALL_REQLEN,	ax
DOSCODE:626E		     xor     ax, ax
DOSCODE:6270		     mov     word ptr ss:IOCALL_REQSTAT, ax
DOSCODE:6274		     push    es
DOSCODE:6275		     pop     ds
DOSCODE:6276		     mov     si, di
DOSCODE:6278		     push    ss
DOSCODE:6279		     pop     es
DOSCODE:627A		     mov     bx, offset	IOCALL_REQLEN ;	IOCALL
DOSCODE:627D		     push    ds
DOSCODE:627E		     push    si
DOSCODE:627F		     call    DEVIOCALL2
DOSCODE:6282		     pop     si
DOSCODE:6283		     pop     ds
DOSCODE:6284		     mov     ax, word ptr ss:IOCALL_REQSTAT
DOSCODE:6288		     and     ax, 200h	     ; STBUI
DOSCODE:628B		     mov     cl, 9
DOSCODE:628D		     shr     ax, cl
DOSCODE:628F ; START OF	FUNCTION CHUNK FOR $IOCTL
DOSCODE:628F
DOSCODE:628F ioctl_da_ok_j:			     ; ...
DOSCODE:628F		     jmp     SYS_RETURN	     ; SYS_RET_OK
DOSCODE:628F ; END OF FUNCTION CHUNK FOR $IOCTL
DOSCODE:6292 ; ---------------------------------------------------------------------------
DOSCODE:6292
DOSCODE:6292 ioctl_drive_attr:			     ; ...
DOSCODE:6292		     mov     al, bl
DOSCODE:6294		     call    GETTHISDRV
DOSCODE:6297		     jb	     short ioctl_drv_err
DOSCODE:6299		     call    Get_Driver_BL
DOSCODE:629C		     jb	     short ioctl_drv_err
DOSCODE:629E		     mov     dx, es:[di+4]   ; [es:di+SYSDEV.ATT]
DOSCODE:62A2		     mov     bl, al
DOSCODE:62A4		     les     di, ss:THISCDS
DOSCODE:62A9		     test    byte ptr es:[di+44h], 80h ; [ES:DI+curdir.flags+1],
DOSCODE:62A9					     ; (curdir_isnet>>8)
DOSCODE:62AE		     jz	     short IOCTLShare
DOSCODE:62B0		     mov     dx, 1000h
DOSCODE:62B3
DOSCODE:62B3 IOCTLShare:			     ; ...
DOSCODE:62B3		     push    ss
DOSCODE:62B4		     pop     ds
DOSCODE:62B5		     mov     si, offset	OPENBUF
DOSCODE:62B8		     add     bl, 'A'         ; 41h
DOSCODE:62BB		     mov     [si], bl
DOSCODE:62BD		     mov     word ptr [si+1], 3Ah ; ':'
DOSCODE:62C2		     mov     ax, 300h
DOSCODE:62C5		     clc
DOSCODE:62C6		     int     2Ah	     ; Microsoft Networks - CHECK DIRECT I/O
DOSCODE:62C6					     ; DS:SI ->	ASCIZ disk device name (may be full path or only drive
DOSCODE:62C6					     ; specifier--must include the colon)
DOSCODE:62C6					     ; Return: CF clear	if absolute disk access	allowed
DOSCODE:62C8		     jnb     short IOCTLLocal
DOSCODE:62CA		     or	     dx, 200h
DOSCODE:62CE
DOSCODE:62CE IOCTLLocal:			     ; ...
DOSCODE:62CE		     test    byte ptr es:[di+44h], 10h ; [ES:DI+curdir.flags+1],
DOSCODE:62CE					     ; (curdir_local>>8)
DOSCODE:62D3		     jz	     short ioctl_set_DX
DOSCODE:62D5		     or	     dx, 8000h
DOSCODE:62D9
DOSCODE:62D9 ioctl_set_DX:			     ; ...
DOSCODE:62D9		     call    Get_User_Stack
DOSCODE:62DC		     mov     [si+6], dx	     ; [SI+user_env.user_DX]
DOSCODE:62DF ; START OF	FUNCTION CHUNK FOR $IOCTL
DOSCODE:62DF
DOSCODE:62DF ioctl_gd_ok_j:			     ; ...
DOSCODE:62DF		     jmp     short ioctl_da_ok_j
DOSCODE:62DF ; END OF FUNCTION CHUNK FOR $IOCTL
DOSCODE:62E1 ; ---------------------------------------------------------------------------
DOSCODE:62E1
DOSCODE:62E1 ioctl_drv_err:			     ; ...
DOSCODE:62E1		     mov     al, 0Fh	     ; error_invalid_drive
DOSCODE:62E3 ; START OF	FUNCTION CHUNK FOR $IOCTL
DOSCODE:62E3
DOSCODE:62E3 ioctl_gd_err_j:			     ; ...
DOSCODE:62E3		     jmp     SYS_RET_ERR
DOSCODE:62E3 ; END OF FUNCTION CHUNK FOR $IOCTL
DOSCODE:62E6 ; ---------------------------------------------------------------------------
DOSCODE:62E6
DOSCODE:62E6 ioctl_handle_redir:		     ; ...
DOSCODE:62E6		     call    SFFromHandle
DOSCODE:62E9		     jnb     short ioctl_got_sft
DOSCODE:62EB		     jmp     ioctl_bad_handle
DOSCODE:62EE ; ---------------------------------------------------------------------------
DOSCODE:62EE
DOSCODE:62EE ioctl_got_sft:			     ; ...
DOSCODE:62EE		     mov     dx, es:[di+5]   ; [ES:DI+SF_ENTRY.sf_flags]
DOSCODE:62F2		     jmp     short ioctl_set_DX
DOSCODE:62F4 ; ---------------------------------------------------------------------------
DOSCODE:62F4 ; START OF	FUNCTION CHUNK FOR $IOCTL
DOSCODE:62F4
DOSCODE:62F4 ioctl_bad_funj:			     ; ...
DOSCODE:62F4		     jmp     ioctl_bad_fun
DOSCODE:62F4 ; END OF FUNCTION CHUNK FOR $IOCTL
DOSCODE:62F7 ; ---------------------------------------------------------------------------
DOSCODE:62F7
DOSCODE:62F7 ioctl_get_dev:			     ; ...
DOSCODE:62F7		     call    Check_If_Net
DOSCODE:62FA		     jnz     short ioctl_bad_funj
DOSCODE:62FC ; START OF	FUNCTION CHUNK FOR $IOCTL
DOSCODE:62FC
DOSCODE:62FC ioctl_do_string:			     ; ...
DOSCODE:62FC		     test    byte ptr es:[di+5], 40h ; [ES:DI+SYSDEV.ATT+1],
DOSCODE:62FC					     ; (DEVIOCTL>>8)
DOSCODE:6301		     jz	     short ioctl_bad_funj
DOSCODE:6303		     mov     ds:IOCALL_REQFUNC,	3 ; DEVRDIOCTL
DOSCODE:6308		     test    al, 1
DOSCODE:630A		     jz	     short ioctl_control_call
DOSCODE:630C		     mov     ds:IOCALL_REQFUNC,	12 ; [IOCALL_REQFUNC],
DOSCODE:630C					     ; DEVWRIOCTL
DOSCODE:6311
DOSCODE:6311 ioctl_control_call:		     ; ...
DOSCODE:6311		     mov     al, 22	     ; DRDWRHL
DOSCODE:6313		     mov     ah, bl
DOSCODE:6315		     mov     word ptr ds:IOCALL_REQLEN,	ax
DOSCODE:6318		     xor     ax, ax
DOSCODE:631A		     mov     word ptr ds:IOCALL_REQSTAT, ax
DOSCODE:631D		     mov     ds:IOCTL_REQ_MAJORFUNCTION, al ; [IOMED]
DOSCODE:6320		     mov     word ptr ds:IOCTL_IOSCNT, cx ; [IOSCNT]
DOSCODE:6324		     mov     word ptr ds:IOCTL_REQ_MINORFUNCTION, dx ; [IOXAD]
DOSCODE:6328		     mov     word ptr ds:IOCTL_IOXAD_2,	si ; [IOXAD+2]
DOSCODE:632C		     push    es
DOSCODE:632D		     pop     ds
DOSCODE:632E		     mov     si, di
DOSCODE:6330		     push    ss
DOSCODE:6331		     pop     es
DOSCODE:6332		     mov     bx, offset	IOCALL_REQLEN ;	IOCALL
DOSCODE:6335
DOSCODE:6335 ioctl_do_IO:			     ; ...
DOSCODE:6335		     call    DEVIOCALL2
DOSCODE:6338		     test    ss:IOCALL_REQSTAT+1, 80h ;	[SS:IOCALL_REQSTAT+1],
DOSCODE:6338					     ; (STERR>>8)
DOSCODE:633E		     jnz     short ioctl_string_err
DOSCODE:6340		     mov     ax, word ptr ss:IOCTL_IOSCNT ; [SS:IOSCNT]
DOSCODE:6344		     jmp     short ioctl_gd_ok_j
DOSCODE:6346 ; ---------------------------------------------------------------------------
DOSCODE:6346
DOSCODE:6346 ioctl_string_err:			     ; ...
DOSCODE:6346		     mov     di, word ptr ss:IOCALL_REQSTAT
DOSCODE:634B
DOSCODE:634B device_err:			     ;
DOSCODE:634B		     and     di, 0FFh	     ; STECODE
DOSCODE:634F		     mov     ax, di
DOSCODE:6351		     call    SET_I24_EXTENDED_ERROR
DOSCODE:6354		     mov     ax, ss:EXTERR
DOSCODE:6358		     jmp     short ioctl_gd_err_j
DOSCODE:6358 ; END OF FUNCTION CHUNK FOR $IOCTL
DOSCODE:635A
DOSCODE:635A ; =============== S U B R O U T I N E =======================================
DOSCODE:635A
DOSCODE:635A
DOSCODE:635A Get_Driver_BL   proc near		     ; ...
DOSCODE:635A		     push    ax
DOSCODE:635B		     mov     al, bl
DOSCODE:635D		     call    GETTHISDRV
DOSCODE:6360		     jb	     short ioctl_bad_drv
DOSCODE:6362		     xor     bl, bl
DOSCODE:6364		     mov     ds:EXTERR_LOCUS, 3	; errLOC_Net
DOSCODE:6369		     les     di, ds:THISCDS
DOSCODE:636D		     test    byte ptr es:[di+44h], 80h ; [ES:DI+curdir.flags+1],
DOSCODE:636D					     ; (curdir_isnet>>8)
DOSCODE:6372		     les     di, es:[di+45h] ; [ES:DI+curdir.devptr]
DOSCODE:6376		     jnz     short got_dev_ptr
DOSCODE:6378		     mov     ds:EXTERR_LOCUS, 2	; errLOC_Disk
DOSCODE:637D		     mov     bl, es:[di+1]   ; [ES:DI+DPB.UNIT]
DOSCODE:6381		     les     di, es:[di+13h] ; [ES:DI+DPB.DRIVER_ADDR]
DOSCODE:6385
DOSCODE:6385 got_dev_ptr:			     ; ...
DOSCODE:6385		     clc
DOSCODE:6386
DOSCODE:6386 ioctl_bad_drv:			     ; ...
DOSCODE:6386		     pop     ax
DOSCODE:6387		     retn
DOSCODE:6387 Get_Driver_BL   endp
DOSCODE:6387
DOSCODE:6388 ; ---------------------------------------------------------------------------
DOSCODE:6388
DOSCODE:6388 Check_If_Net:			     ; ...
DOSCODE:6388		     call    Get_Driver_BL
DOSCODE:638B		     jb	     short ioctl_drv_err_pop
DOSCODE:638D		     push    es
DOSCODE:638E		     push    di
DOSCODE:638F		     les     di, ds:THISCDS
DOSCODE:6393		     test    byte ptr es:[di+44h], 80h ; [ES:DI+curdir.flags+1],
DOSCODE:6393					     ; (curdir_isnet>>8)
DOSCODE:6398		     pop     di
DOSCODE:6399		     pop     es
DOSCODE:639A		     retn
DOSCODE:639B ; ---------------------------------------------------------------------------
DOSCODE:639B
DOSCODE:639B ioctl_drv_err_pop:			     ; ...
DOSCODE:639B		     pop     ax
DOSCODE:639C		     jmp     ioctl_drv_err
DOSCODE:639F ; ---------------------------------------------------------------------------
DOSCODE:639F
DOSCODE:639F ioctl_bad_funj3:			     ; ...
DOSCODE:639F		     jmp     ioctl_bad_fun
DOSCODE:63A2 ; ---------------------------------------------------------------------------
DOSCODE:63A2
DOSCODE:63A2 ioctl_string_errj:			     ; ...
DOSCODE:63A2		     jmp     short ioctl_string_err
DOSCODE:63A4 ; ---------------------------------------------------------------------------
DOSCODE:63A4
DOSCODE:63A4 ioctl_drive_owner:			     ; ...
DOSCODE:63A4		     call    Check_If_Net
DOSCODE:63A7		     jnz     short ioctl_bad_funj3
DOSCODE:63A9		     test    byte ptr es:[di+4], 40h ; [ES:DI+SYSDEV.ATT],
DOSCODE:63A9					     ; DEV320
DOSCODE:63AE		     jz	     short ioctl_bad_funj3
DOSCODE:63B0		     mov     ds:IOCALL_REQFUNC,	23 ; DEVGETOWN
DOSCODE:63B5		     cmp     al, 0Eh
DOSCODE:63B7		     jz	     short GetOwner
DOSCODE:63B9
DOSCODE:63B9 SetOwner:				     ; DEVSETOWN
DOSCODE:63B9		     mov     ds:IOCALL_REQFUNC,	24
DOSCODE:63BE
DOSCODE:63BE GetOwner:				     ; ...
DOSCODE:63BE		     mov     al, 13	     ; OWNHL
DOSCODE:63C0		     mov     ah, bl
DOSCODE:63C2		     mov     word ptr ds:IOCALL_REQLEN,	ax
DOSCODE:63C5		     xor     ax, ax
DOSCODE:63C7		     mov     word ptr ds:IOCALL_REQSTAT, ax
DOSCODE:63CA		     push    es
DOSCODE:63CB		     pop     ds
DOSCODE:63CC		     mov     si, di
DOSCODE:63CE		     push    ss
DOSCODE:63CF		     pop     es
DOSCODE:63D0		     mov     bx, offset	IOCALL_REQLEN ;	IOCALL
DOSCODE:63D3		     push    ds
DOSCODE:63D4		     push    si
DOSCODE:63D5		     call    DEVIOCALL2
DOSCODE:63D8		     pop     si
DOSCODE:63D9		     pop     ds
DOSCODE:63DA		     test    ss:IOCALL_REQSTAT+1, 80h ;	(STERR>>8)
DOSCODE:63E0		     jnz     short ioctl_string_errj
DOSCODE:63E2		     mov     al, ss:IOCALL_REQUNIT
DOSCODE:63E6		     jmp     SYS_RETURN	     ; SYS_RET_OK
DOSCODE:63E9
DOSCODE:63E9 ; =============== S U B R O U T I N E =======================================
DOSCODE:63E9
DOSCODE:63E9
DOSCODE:63E9 DOS_DELETE	     proc near		     ; ...
DOSCODE:63E9		     call    TestNet
DOSCODE:63EC		     jnb     short LOCAL_DELETE
DOSCODE:63EE		     mov     ax, 1113h
DOSCODE:63F1		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	DELETE REMOTE FILE
DOSCODE:63F1					     ; SS = DS = DOS CS, SDA first filename pointer -> fully-qualified filename	in DOS CS
DOSCODE:63F1					     ; SDA CDS pointer -> current directory structure for drive	with file
DOSCODE:63F1					     ; Return: CF set on error
DOSCODE:63F3		     retn
DOSCODE:63F4 ; ---------------------------------------------------------------------------
DOSCODE:63F4
DOSCODE:63F4 LOCAL_DELETE:			     ; ...
DOSCODE:63F4		     mov     ds:FOUNDDEL, 0
DOSCODE:63F9		     call    ECritDisk
DOSCODE:63FC		     mov     word ptr ds:CREATING, 0E500h ; DIRFREE*256+0
DOSCODE:6402		     mov     si, ds:WFP_START
DOSCODE:6406
DOSCODE:6406 SKPNUL:				     ; ...
DOSCODE:6406		     lodsb
DOSCODE:6407		     or	     al, al
DOSCODE:6409		     jnz     short SKPNUL
DOSCODE:640B		     sub     si, 4
DOSCODE:640E		     cmp     word ptr [si], 2E2Ah ; "*."
DOSCODE:6412		     jnz     short TEST_QUEST
DOSCODE:6414		     cmp     byte ptr [si+2], '*'
DOSCODE:6418		     jz	     short CHECK_ATTS
DOSCODE:641A
DOSCODE:641A TEST_QUEST:			     ; ...
DOSCODE:641A		     sub     si, 9
DOSCODE:641D		     xchg    di, si
DOSCODE:641F		     push    ss
DOSCODE:6420		     pop     es
DOSCODE:6421		     mov     ax, '??'        ; 3F3Fh
DOSCODE:6424		     mov     cx, 4
DOSCODE:6427		     repe scasw
DOSCODE:6429		     jnz     short NOT_ALL
DOSCODE:642B		     xchg    di, si
DOSCODE:642D		     lodsw
DOSCODE:642E		     cmp     ax, 3F2Eh	     ; ".?"
DOSCODE:6431		     jnz     short NOT_ALL
DOSCODE:6433		     lodsw
DOSCODE:6434		     cmp     ax, '??'
DOSCODE:6437		     jnz     short NOT_ALL
DOSCODE:6439
DOSCODE:6439 CHECK_ATTS:			     ; ...
DOSCODE:6439		     mov     al, ds:SATTRIB
DOSCODE:643C		     and     al, 1Fh	     ; attr_hidden+attr_system+attr_directory
DOSCODE:643C					     ; +attr_volume_id+attr_read_only
DOSCODE:643E		     cmp     al, 1Fh
DOSCODE:6440		     jnz     short NOT_ALL
DOSCODE:6442		     mov     ds:DELALL,	0
DOSCODE:6447
DOSCODE:6447 NOT_ALL:				     ; ...
DOSCODE:6447		     mov     ds:NoSetDir, 1
DOSCODE:644C		     call    GetPathNoSet
DOSCODE:644F		     jnb     short Del_found
DOSCODE:6451		     jnz     short _bad_path
DOSCODE:6453		     or	     cl, cl
DOSCODE:6455		     jz	     short _bad_path
DOSCODE:6457
DOSCODE:6457 No_file:				     ; ...
DOSCODE:6457		     mov     ax, 2	     ; error_file_not_found
DOSCODE:645A
DOSCODE:645A ErrorReturn:			     ; ...
DOSCODE:645A		     stc
DOSCODE:645B		     call    LCritDisk
DOSCODE:645E		     retn
DOSCODE:645F ; ---------------------------------------------------------------------------
DOSCODE:645F
DOSCODE:645F _bad_path:				     ; ...
DOSCODE:645F		     mov     ax, 3	     ; error_path_not_found
DOSCODE:6462		     jmp     short ErrorReturn
DOSCODE:6464 ; ---------------------------------------------------------------------------
DOSCODE:6464
DOSCODE:6464 Del_found:				     ; ...
DOSCODE:6464		     jnz     short NOT_DIR
DOSCODE:6466		     cmp     ds:DELALL,	0
DOSCODE:646B		     jz	     short NOT_DIR
DOSCODE:646D
DOSCODE:646D Del_access_err:			     ; ...
DOSCODE:646D		     mov     ax, 5	     ; error_access_denied
DOSCODE:6470		     jmp     short ErrorReturn
DOSCODE:6472 ; ---------------------------------------------------------------------------
DOSCODE:6472
DOSCODE:6472 NOT_DIR:				     ; ...
DOSCODE:6472		     or	     ah, ah
DOSCODE:6474		     js	     short Del_access_err
DOSCODE:6476
DOSCODE:6476 DELFILE:				     ; ...
DOSCODE:6476		     or	     ds:FOUNDDEL, 1  ; FILEFOUND
DOSCODE:647B		     push    ds
DOSCODE:647C		     mov     ah, ds:DELALL
DOSCODE:6480		     lds     di, ds:CURBUF
DOSCODE:6484		     test    ss:ATTRIB,	1    ; attr_read_only
DOSCODE:648A		     jnz     short DoDelete
DOSCODE:648C		     test    byte ptr [bx+0Bh],	1 ; [BX+dir_entry.dir_attr],
DOSCODE:648C					     ; attr_read_only
DOSCODE:6490		     jz	     short DoDelete
DOSCODE:6492		     pop     ds
DOSCODE:6493		     jmp     short DELNXT
DOSCODE:6495 ; ---------------------------------------------------------------------------
DOSCODE:6495
DOSCODE:6495 DoDelete:				     ; ...
DOSCODE:6495		     call    REN_DEL_Check
DOSCODE:6498		     jnb     short DEL_SHARE_OK
DOSCODE:649A		     pop     ds
DOSCODE:649B		     jmp     short DELNXT
DOSCODE:649D ; ---------------------------------------------------------------------------
DOSCODE:649D
DOSCODE:649D DEL_SHARE_OK:			     ; ...
DOSCODE:649D		     test    byte ptr [di+5], 40h ; [DI+BUFFINFO.buf_flags],buf_dirty
DOSCODE:64A1		     jnz     short yesdirty
DOSCODE:64A3		     call    INC_DIRTY_COUNT
DOSCODE:64A6		     or	     byte ptr [di+5], 40h
DOSCODE:64AA
DOSCODE:64AA yesdirty:				     ; ...
DOSCODE:64AA		     mov     [bx], ah	     ; [BX+dir_entry.dir_name]
DOSCODE:64AC		     mov     bx, [si]
DOSCODE:64AE		     pop     ds
DOSCODE:64AF		     or	     ds:FOUNDDEL, 10h ;	FILEDELETED
DOSCODE:64B4		     cmp     bx, 2
DOSCODE:64B7		     jb	     short DELNXT
DOSCODE:64B9		     cmp     bx, es:[bp+0Dh] ; [ES:BP+DPB.MAX_CLUSTER]
DOSCODE:64BD		     ja	     short DELNXT
DOSCODE:64BF		     call    RELEASE
DOSCODE:64C2		     jb	     short No_fileJ
DOSCODE:64C4		     call    FastOpen_Delete
DOSCODE:64C7
DOSCODE:64C7 DELNXT:				     ; ...
DOSCODE:64C7		     les     bp, ds:THISDPB
DOSCODE:64CB		     call    GETENTRY
DOSCODE:64CE		     jb	     short No_fileJ
DOSCODE:64D0		     call    NEXTENT
DOSCODE:64D3		     jnb     short DELFILE
DOSCODE:64D5		     les     bp, ds:THISDPB
DOSCODE:64D9		     mov     al, es:[bp+0]
DOSCODE:64DD		     call    FLUSHBUF
DOSCODE:64E0		     jb	     short No_fileJ
DOSCODE:64E2		     test    ds:FOUNDDEL, 10h ;	FILEDELETED
DOSCODE:64E7		     jz	     short DelError
DOSCODE:64E9		     test    ds:ATTRIB,	8    ; attr_volume_id
DOSCODE:64EE		     jz	     short No_Set_Flag
DOSCODE:64F0		     push    ax
DOSCODE:64F1		     push    es
DOSCODE:64F2		     push    di
DOSCODE:64F3		     les     di, ds:THISCDS
DOSCODE:64F7		     mov     ah, es:[di]
DOSCODE:64FA		     sub     ah, 'A'
DOSCODE:64FD		     mov     ds:VOLCHNG_FLAG, ah
DOSCODE:6501		     xor     bh, bh
DOSCODE:6503		     call    Set_Media_ID
DOSCODE:6506		     call    FATREAD_CDS
DOSCODE:6509		     pop     di
DOSCODE:650A		     pop     es
DOSCODE:650B		     pop     ax
DOSCODE:650C
DOSCODE:650C No_Set_Flag:			     ; ...
DOSCODE:650C		     call    LCritDisk
DOSCODE:650F		     retn
DOSCODE:6510 ; ---------------------------------------------------------------------------
DOSCODE:6510
DOSCODE:6510 DelError:				     ; ...
DOSCODE:6510		     test    ds:FOUNDDEL, 1  ; FILEFOUND
DOSCODE:6515		     jnz     short Del_access_errJ
DOSCODE:6517
DOSCODE:6517 No_fileJ:				     ; ...
DOSCODE:6517		     jmp     No_file
DOSCODE:651A ; ---------------------------------------------------------------------------
DOSCODE:651A
DOSCODE:651A Del_access_errJ:			     ; ...
DOSCODE:651A		     jmp     Del_access_err
DOSCODE:651A DOS_DELETE	     endp
DOSCODE:651A
DOSCODE:651D
DOSCODE:651D ; =============== S U B R O U T I N E =======================================
DOSCODE:651D
DOSCODE:651D
DOSCODE:651D REN_DEL_Check   proc near		     ; ...
DOSCODE:651D		     push    ds
DOSCODE:651E		     push    di
DOSCODE:651F		     push    ax
DOSCODE:6520		     push    bx
DOSCODE:6521		     push    si
DOSCODE:6522		     push    ss
DOSCODE:6523		     pop     es
DOSCODE:6524		     mov     di, ss:WFP_START
DOSCODE:6529		     mov     si, bx
DOSCODE:652B		     mov     ds, word ptr ss:CURBUF+2
DOSCODE:6530		     mov     bx, di
DOSCODE:6532		     add     bx, 2
DOSCODE:6535		     call    StrLen
DOSCODE:6538		     dec     cx
DOSCODE:6539		     add     di, cx
DOSCODE:653B		     call    SkipBack
DOSCODE:653E		     inc     di
DOSCODE:653F		     mov     ss:SAVE_BX, di
DOSCODE:6544		     call    PackName
DOSCODE:6547		     pop     si
DOSCODE:6548		     pop     bx
DOSCODE:6549		     push    bx
DOSCODE:654A		     push    si
DOSCODE:654B		     push    ss
DOSCODE:654C		     pop     ds
DOSCODE:654D		     call    dword ptr ds:ShCloseFile ;	Call far [JShare+(13*4)]
DOSCODE:6551		     mov     word ptr ds:THISSFT+2, ds
DOSCODE:6555		     mov     word ptr ds:THISSFT, 765h ; AUXSTACK-SF_ENTRY.size
DOSCODE:655B		     xor     ah, ah
DOSCODE:655D		     call    DOOPEN
DOSCODE:6560		     les     di, ds:THISSFT
DOSCODE:6564		     mov     word ptr es:[di+2], 10h ; [ES:DI+SF_ENTRY.sf_mode],
DOSCODE:6564					     ; SHARING_DENY_BOTH
DOSCODE:656A		     mov     word ptr es:[di], 1 ; [ES:DI+SF_ENTRY.sf_ref_count]
DOSCODE:656F		     call    ShareEnter
DOSCODE:6572		     jb	     short CheckDone
DOSCODE:6574		     les     di, ds:THISSFT
DOSCODE:6578		     mov     word ptr es:[di], 0
DOSCODE:657D		     call    ShareEnd
DOSCODE:6580		     clc
DOSCODE:6581
DOSCODE:6581 CheckDone:				     ; ...
DOSCODE:6581		     les     bp, ds:THISDPB
DOSCODE:6585		     pop     si
DOSCODE:6586		     pop     bx
DOSCODE:6587		     pop     ax
DOSCODE:6588		     pop     di
DOSCODE:6589		     pop     ds
DOSCODE:658A		     retn
DOSCODE:658A REN_DEL_Check   endp
DOSCODE:658A
DOSCODE:658B ; ---------------------------------------------------------------------------
DOSCODE:658B
DOSCODE:658B FastOpen_Delete:			     ; ...
DOSCODE:658B		     pushf
DOSCODE:658C		     push    si
DOSCODE:658D		     push    bx
DOSCODE:658E		     push    ax
DOSCODE:658F		     mov     si, ss:WFP_START
DOSCODE:6594		     mov     al, 3	     ; FONC_delete
DOSCODE:6596 ; START OF	FUNCTION CHUNK FOR FastOpen_Update
DOSCODE:6596
DOSCODE:6596 fastinvoke:			     ; ...
DOSCODE:6596		     mov     bx, offset	FastOpenTable_2	; FastTable+2
DOSCODE:6599		     call    dword ptr [bx]  ; CALL far	[BX]
DOSCODE:659B		     pop     ax
DOSCODE:659C		     pop     bx
DOSCODE:659D		     pop     si
DOSCODE:659E		     popf
DOSCODE:659F		     retn
DOSCODE:659F ; END OF FUNCTION CHUNK FOR FastOpen_Update
DOSCODE:65A0
DOSCODE:65A0 ; =============== S U B R O U T I N E =======================================
DOSCODE:65A0
DOSCODE:65A0
DOSCODE:65A0 FastOpen_Rename proc near		     ; ...
DOSCODE:65A0		     pushf
DOSCODE:65A1		     push    si
DOSCODE:65A2		     push    di
DOSCODE:65A3		     push    bx
DOSCODE:65A4		     push    ax
DOSCODE:65A5		     mov     si, ss:REN_WFP
DOSCODE:65AA		     mov     di, offset	NAME1
DOSCODE:65AD		     mov     al, 6	     ; FONC_Rename
DOSCODE:65AF		     mov     bx, offset	FastOpenTable_2
DOSCODE:65B2		     call    dword ptr [bx]  ; CALL far	[BX]
DOSCODE:65B4		     pop     ax
DOSCODE:65B5		     pop     bx
DOSCODE:65B6		     pop     di
DOSCODE:65B7		     pop     si
DOSCODE:65B8		     popf
DOSCODE:65B9		     retn
DOSCODE:65B9 FastOpen_Rename endp
DOSCODE:65B9
DOSCODE:65BA
DOSCODE:65BA ; =============== S U B R O U T I N E =======================================
DOSCODE:65BA
DOSCODE:65BA
DOSCODE:65BA FastOpen_Update proc near		     ; ...
DOSCODE:65BA
DOSCODE:65BA ; FUNCTION	CHUNK AT DOSCODE:6596 SIZE 0000000A BYTES
DOSCODE:65BA
DOSCODE:65BA		     pushf
DOSCODE:65BB		     push    si
DOSCODE:65BC		     push    bx
DOSCODE:65BD		     push    ax
DOSCODE:65BE		     mov     al, 4	     ; FONC_update
DOSCODE:65C0		     jmp     short fastinvoke
DOSCODE:65C0 FastOpen_Update endp
DOSCODE:65C0
DOSCODE:65C2
DOSCODE:65C2 ; =============== S U B R O U T I N E =======================================
DOSCODE:65C2
DOSCODE:65C2
DOSCODE:65C2 Fast_Dispatch   proc near		     ; ...
DOSCODE:65C2		     mov     si, offset	FastOpenTable_2	; FastTable+2
DOSCODE:65C5		     call    dword ptr ss:[si] ; CALL far [SS:SI]
DOSCODE:65C8		     retn
DOSCODE:65C8 Fast_Dispatch   endp
DOSCODE:65C8
DOSCODE:65C9
DOSCODE:65C9 ; =============== S U B R O U T I N E =======================================
DOSCODE:65C9
DOSCODE:65C9
DOSCODE:65C9 DOS_RENAME	     proc near		     ; ...
DOSCODE:65C9		     call    TestNet
DOSCODE:65CC		     jnb     short LOCAL_RENAME
DOSCODE:65CE		     mov     ax, 1111h
DOSCODE:65D1		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	RENAME REMOTE FILE
DOSCODE:65D1					     ; SS = DS = DOS CS, SDA first filename pointer = offset of	fully-qualified	old name
DOSCODE:65D1					     ; SDA CDS pointer -> current directory
DOSCODE:65D1					     ; Return: CF set on error
DOSCODE:65D3		     retn
DOSCODE:65D4 ; ---------------------------------------------------------------------------
DOSCODE:65D4
DOSCODE:65D4 LOCAL_RENAME:			     ; ...
DOSCODE:65D4		     mov     ds:EXTERR_LOCUS, 2	; errLOC_Disk
DOSCODE:65D9		     mov     si, ds:WFP_START
DOSCODE:65DD		     mov     di, ds:REN_WFP
DOSCODE:65E1		     mov     al, [si]
DOSCODE:65E3		     mov     ah, [di]
DOSCODE:65E5		     or	     ax, 2020h	     ; Lower case
DOSCODE:65E8		     cmp     al, ah
DOSCODE:65EA		     jz	     short SAMEDRV
DOSCODE:65EC		     mov     ax, 11h	     ; error_not_same_device
DOSCODE:65EF		     stc
DOSCODE:65F0		     retn
DOSCODE:65F1 ; ---------------------------------------------------------------------------
DOSCODE:65F1
DOSCODE:65F1 SAMEDRV:				     ; ...
DOSCODE:65F1		     push    word ptr ds:DMAADD+2
DOSCODE:65F5		     push    word ptr ds:DMAADD
DOSCODE:65F9		     mov     word ptr ds:DMAADD+2, ds
DOSCODE:65FD		     mov     word ptr ds:DMAADD, offset	RENAMEDMA
DOSCODE:6603		     mov     ds:FOUND_DEV, 0
DOSCODE:6608		     call    ECritDisk
DOSCODE:660B		     call    DOS_SEARCH_FIRST
DOSCODE:660E		     jnb     short Check_Dev
DOSCODE:6610		     cmp     ax, 12h	     ; error_no_more_files
DOSCODE:6613		     jnz     short GOTERR
DOSCODE:6615		     mov     ax, 2	     ; error_file_not_found
DOSCODE:6618
DOSCODE:6618 GOTERR:				     ; ...
DOSCODE:6618		     stc
DOSCODE:6619
DOSCODE:6619 RENAME_POP:			     ; ...
DOSCODE:6619		     pop     word ptr ds:DMAADD
DOSCODE:661D		     pop     word ptr ds:DMAADD+2
DOSCODE:6621		     call    LCritDisk
DOSCODE:6624		     retn
DOSCODE:6625 ; ---------------------------------------------------------------------------
DOSCODE:6625
DOSCODE:6625 Check_Dev:				     ; ...
DOSCODE:6625		     mov     ax, 5	     ; error_access_denied
DOSCODE:6628		     push    ds
DOSCODE:6629		     lds     si, ds:DMAADD
DOSCODE:662D		     add     si, 21	     ; find_buf.attr
DOSCODE:6630		     test    byte ptr [si+11], 10h ; [SI+dir_entry.dir_attr],
DOSCODE:6630					     ; attr_directory
DOSCODE:6634		     jz	     short notdir
DOSCODE:6636		     mov     si, ds:REN_WFP
DOSCODE:663A		     call    Check_PathLen2
DOSCODE:663D
DOSCODE:663D notdir:				     ; ...
DOSCODE:663D		     pop     ds
DOSCODE:663E		     ja	     short GOTERR
DOSCODE:6640		     cmp     ds:FOUND_DEV, 0
DOSCODE:6645		     jnz     short GOTERR
DOSCODE:6647		     mov     si, bx
DOSCODE:6649		     add     si, 26	     ; dir_entry.dir_first
DOSCODE:664C		     call    REN_DEL_Check
DOSCODE:664F		     jnb     short REN_OK1
DOSCODE:6651		     mov     ax, 20h	     ; error_sharing_violation
DOSCODE:6654		     jmp     short RENAME_POP
DOSCODE:6656 ; ---------------------------------------------------------------------------
DOSCODE:6656
DOSCODE:6656 REN_OK1:				     ; ...
DOSCODE:6656		     push    si
DOSCODE:6657		     lds     si, ds:DMAADD
DOSCODE:665B		     add     si, 21
DOSCODE:665E		     test    byte ptr [si+11], 10h ; [SI+dir_entry.dir_attr],
DOSCODE:665E					     ; attr_directory
DOSCODE:6662		     jz	     short NOT_DIR1
DOSCODE:6664		     pop     si
DOSCODE:6665		     jmp     short SWAP_SOURCE
DOSCODE:6667 ; ---------------------------------------------------------------------------
DOSCODE:6667
DOSCODE:6667 NOT_DIR1:				     ; ...
DOSCODE:6667		     pop     si
DOSCODE:6668		     call    FastOpen_Delete
DOSCODE:666B
DOSCODE:666B SWAP_SOURCE:			     ; ...
DOSCODE:666B		     mov     ax, ds:WFP_START
DOSCODE:666E		     mov     si, ds:REN_WFP
DOSCODE:6672		     mov     ds:WFP_START, si
DOSCODE:6676		     mov     ds:REN_WFP, ax
DOSCODE:6679		     mov     ds:CURR_DIR_END, 0FFFFh ; -1
DOSCODE:667F		     mov     word ptr ds:CREATING, 0E5FFh ; DIRFREE*256+0FFh
DOSCODE:6685		     call    GetPathNoSet
DOSCODE:6688		     jb	     short NODEST
DOSCODE:668A		     or	     ah, ah
DOSCODE:668C		     jns     short SAVEDEST
DOSCODE:668E
DOSCODE:668E BAD_ACC:				     ; ...
DOSCODE:668E		     mov     ax, 5	     ; error_access_denied
DOSCODE:6691		     stc
DOSCODE:6692
DOSCODE:6692 RENAME_CLEAN:			     ; ...
DOSCODE:6692		     pushf
DOSCODE:6693		     push    ax
DOSCODE:6694		     mov     al, ds:THISDRV
DOSCODE:6697		     call    FLUSHBUF
DOSCODE:669A		     pop     ax
DOSCODE:669B		     cmp     ds:FAILERR, 0
DOSCODE:66A0		     jnz     short BAD_ERR
DOSCODE:66A2		     popf
DOSCODE:66A3		     jmp     RENAME_POP
DOSCODE:66A6 ; ---------------------------------------------------------------------------
DOSCODE:66A6
DOSCODE:66A6 BAD_ERR:				     ; ...
DOSCODE:66A6		     pop     ax
DOSCODE:66A7
DOSCODE:66A7 _BAD_PATH:				     ; error_path_not_found
DOSCODE:66A7		     mov     ax, 3
DOSCODE:66AA		     jmp     GOTERR
DOSCODE:66AD ; ---------------------------------------------------------------------------
DOSCODE:66AD
DOSCODE:66AD NODEST:				     ; ...
DOSCODE:66AD		     jnz     short BAD_PATH
DOSCODE:66AF		     cmp     ds:FAILERR, 0
DOSCODE:66B4		     jnz     short BAD_PATH
DOSCODE:66B6		     or	     cl, cl
DOSCODE:66B8		     jnz     short SAVEDEST
DOSCODE:66BA
DOSCODE:66BA BAD_PATH:				     ; ...
DOSCODE:66BA		     mov     ax, 3	     ; error_path_not_found
DOSCODE:66BD		     stc
DOSCODE:66BE		     jmp     RENAME_POP
DOSCODE:66C1 ; ---------------------------------------------------------------------------
DOSCODE:66C1
DOSCODE:66C1 SAVEDEST:				     ; ...
DOSCODE:66C1		     push    ss
DOSCODE:66C2		     pop     es
DOSCODE:66C3		     mov     di, offset	NAME2
DOSCODE:66C6		     mov     si, offset	NAME1
DOSCODE:66C9		     mov     cx, 11
DOSCODE:66CC		     rep movsb
DOSCODE:66CE		     mov     ax, ds:DIRSTART
DOSCODE:66D1		     mov     ds:DESTSTART, ax
DOSCODE:66D4
DOSCODE:66D4 BUILDDEST:				     ; ...
DOSCODE:66D4		     push    ss
DOSCODE:66D5		     pop     es
DOSCODE:66D6		     mov     bx, (offset RENAMEDMA+15h)	; RENAMEDMA+21
DOSCODE:66D9		     mov     di, offset	NAME1
DOSCODE:66DC		     mov     si, offset	NAME2
DOSCODE:66DF		     mov     cx, 11
DOSCODE:66E2		     call    NEW_RENAME
DOSCODE:66E5		     mov     ds:ATTRIB,	16h  ; attr_all
DOSCODE:66EA		     mov     ds:CREATING, 0FFh
DOSCODE:66EF		     call    DEVNAME
DOSCODE:66F2		     jnb     short BAD_ACC
DOSCODE:66F4		     mov     bx, ds:DESTSTART
DOSCODE:66F8		     les     bp, ds:THISDPB
DOSCODE:66FC		     call    SETDIRSRCH
DOSCODE:66FF		     jb	     short BAD_ACC
DOSCODE:6701		     call    FINDENTRY
DOSCODE:6704		     jnb     short BAD_ACC
DOSCODE:6706		     cmp     ds:FAILERR, 0
DOSCODE:670B		     jnz     short BAD_ACCJ
DOSCODE:670D		     mov     ax, ds:DESTSTART
DOSCODE:6710		     cmp     ax, word ptr ds:RENAMEDMA+0Fh ; [RENAMEDMA+15]
DOSCODE:6714		     jz	     short SIMPLE_RENAME
DOSCODE:6716		     mov     al, ds:RENAMEDMA+20h ; [RENAMEDMA+32]
DOSCODE:6716					     ; [RENAMEDMA+21+dir_entry.dir_attr]
DOSCODE:6719		     test    al, 10h	     ; attr_directory
DOSCODE:671B		     jnz     short BAD_ACCJ
DOSCODE:671D		     mov     ds:ATTRIB,	al
DOSCODE:6720		     mov     word ptr ds:THISSFT+2, ds
DOSCODE:6724		     mov     si, (offset RENAMEDMA+145h) ; [RENAMEDMA+325]
DOSCODE:6724					     ; AUXSTACK-SF_ENTRY.size
DOSCODE:6727		     mov     word ptr ds:THISSFT, si
DOSCODE:672B		     mov     word ptr [si+2], 2	; [SI+SF_ENTRY.sf_mode],
DOSCODE:672B					     ; SHARING_COMPAT+open_for_both
DOSCODE:6730		     xor     cx, cx
DOSCODE:6732		     call    RENAME_MAKE
DOSCODE:6735		     jnb     short GOT_DEST
DOSCODE:6737
DOSCODE:6737 BAD_ACCJ:				     ; ...
DOSCODE:6737		     jmp     BAD_ACC
DOSCODE:673A ; ---------------------------------------------------------------------------
DOSCODE:673A
DOSCODE:673A GOT_DEST:				     ; ...
DOSCODE:673A		     push    bx
DOSCODE:673B		     les     di, ds:THISSFT
DOSCODE:673F		     call    ShareEnd
DOSCODE:6742		     pop     bx
DOSCODE:6743		     les     di, ds:CURBUF
DOSCODE:6747		     test    byte ptr es:[di+5], 40h ; [ES:DI+BUFFINFO.buf_flags],
DOSCODE:6747					     ; buf_dirty
DOSCODE:674C		     jnz     short yesdirty1
DOSCODE:674E		     call    INC_DIRTY_COUNT
DOSCODE:6751		     or	     byte ptr es:[di+5], 40h ; [ES:DI+BUFFINFO.buf_flags],
DOSCODE:6751					     ; buf_dirty
DOSCODE:6756
DOSCODE:6756 yesdirty1:				     ; ...
DOSCODE:6756		     mov     di, bx
DOSCODE:6758		     add     di, 11	     ; dir_entry.dir_attr
DOSCODE:675B		     mov     si, (offset RENAMEDMA+20h)
DOSCODE:675E		     mov     cx, 21	     ; dir_entry.size-dir_entry.dir_attr
DOSCODE:6761		     rep movsb
DOSCODE:6763		     call    GET_SOURCE
DOSCODE:6766		     jb	     short RENAME_OVER
DOSCODE:6768		     mov     di, bx
DOSCODE:676A		     mov     es, word ptr ds:CURBUF+2
DOSCODE:676E		     mov     al, 0E5h	     ; DIRFREE
DOSCODE:6770		     stosb
DOSCODE:6771		     jmp     short DIRTY_IT
DOSCODE:6773 ; ---------------------------------------------------------------------------
DOSCODE:6773
DOSCODE:6773 SIMPLE_RENAME:			     ; ...
DOSCODE:6773		     call    GET_SOURCE
DOSCODE:6776		     jb	     short RENAME_OVER
DOSCODE:6778		     mov     di, bx
DOSCODE:677A		     mov     es, word ptr ds:CURBUF+2
DOSCODE:677E		     mov     si, offset	NAME1
DOSCODE:6781		     mov     cx, 11
DOSCODE:6784		     rep movsb
DOSCODE:6786
DOSCODE:6786 DIRTY_IT:				     ; ...
DOSCODE:6786		     mov     di, word ptr ds:CURBUF
DOSCODE:678A		     test    byte ptr es:[di+5], 40h ; [ES:DI+BUFFINFO.buf_flags],
DOSCODE:678A					     ; buf_dirty
DOSCODE:678F		     jnz     short yesdirty2
DOSCODE:6791		     call    INC_DIRTY_COUNT
DOSCODE:6794		     or	     byte ptr es:[di+5], 40h ; [ES:DI+BUFFINFO.buf_flags],
DOSCODE:6794					     ; buf_dirty
DOSCODE:6799
DOSCODE:6799 yesdirty2:				     ; ...
DOSCODE:6799		     push    si
DOSCODE:679A		     lds     si, ds:DMAADD
DOSCODE:679E		     add     si, 21	     ; find_buf.attr
DOSCODE:67A1		     test    byte ptr [si+11], 10h ; [SI+dir_entry.dir_attr],
DOSCODE:67A1					     ; attr_directory
DOSCODE:67A5		     jz	     short NOT_DIR2
DOSCODE:67A7		     call    FastOpen_Rename
DOSCODE:67AA		     pop     si
DOSCODE:67AB		     jmp     short NOT_DIRTY1
DOSCODE:67AD ; ---------------------------------------------------------------------------
DOSCODE:67AD
DOSCODE:67AD NOT_DIR2:				     ; ...
DOSCODE:67AD		     pop     si
DOSCODE:67AE
DOSCODE:67AE NOT_DIRTY1:			     ; ...
DOSCODE:67AE		     mov     si, (offset RENAMEDMA+1)
DOSCODE:67B1		     call    ECritDisk
DOSCODE:67B4		     mov     ds:CREATING, 0
DOSCODE:67B9		     call    RENAME_NEXT
DOSCODE:67BC		     jb	     short RENAME_OVER
DOSCODE:67BE		     lea     si, [bx+26]     ; [BX+dir_entry.dir_first]
DOSCODE:67C1		     call    REN_DEL_Check
DOSCODE:67C4		     jnb     short REN_OK2
DOSCODE:67C6		     mov     ax, 20h	     ; error_sharing_violation
DOSCODE:67C9		     jmp     RENAME_CLEAN
DOSCODE:67CC ; ---------------------------------------------------------------------------
DOSCODE:67CC
DOSCODE:67CC REN_OK2:				     ; ...
DOSCODE:67CC		     mov     al, ds:RENAMEDMA+20h ; [RENAMEDMA+21+dir_entry.dir_attr]
DOSCODE:67CF		     test    al, 10h	     ; attr_directory
DOSCODE:67D1		     jz	     short Ren_Directory
DOSCODE:67D3		     call    FastOpen_Delete
DOSCODE:67D6		     jmp     BUILDDEST
DOSCODE:67D9 ; ---------------------------------------------------------------------------
DOSCODE:67D9
DOSCODE:67D9 Ren_Directory:			     ; ...
DOSCODE:67D9		     call    FastOpen_Rename
DOSCODE:67DC		     jmp     BUILDDEST
DOSCODE:67DF ; ---------------------------------------------------------------------------
DOSCODE:67DF
DOSCODE:67DF RENAME_OVER:			     ; ...
DOSCODE:67DF		     clc
DOSCODE:67E0		     jmp     RENAME_CLEAN
DOSCODE:67E0 DOS_RENAME	     endp
DOSCODE:67E0
DOSCODE:67E3
DOSCODE:67E3 ; =============== S U B R O U T I N E =======================================
DOSCODE:67E3
DOSCODE:67E3
DOSCODE:67E3 GET_SOURCE	     proc near		     ; ...
DOSCODE:67E3		     mov     bx, word ptr ds:RENAMEDMA+0Fh
DOSCODE:67E7		     les     bp, ds:THISDPB
DOSCODE:67EB		     call    SETDIRSRCH
DOSCODE:67EE		     jb	     short gs_ret_label
DOSCODE:67F0		     call    STARTSRCH
DOSCODE:67F3		     mov     ax, word ptr ds:RENAMEDMA+0Dh
DOSCODE:67F6		     call    GETENT
DOSCODE:67F9
DOSCODE:67F9 gs_ret_label:			     ; ...
DOSCODE:67F9		     retn
DOSCODE:67F9 GET_SOURCE	     endp
DOSCODE:67F9
DOSCODE:67FA
DOSCODE:67FA ; =============== S U B R O U T I N E =======================================
DOSCODE:67FA
DOSCODE:67FA
DOSCODE:67FA NEW_RENAME	     proc near		     ; ...
DOSCODE:67FA		     lodsb
DOSCODE:67FB		     cmp     al, '?'         ; 3Fh
DOSCODE:67FD		     jnz     short NOCHG
DOSCODE:67FF		     mov     al, [bx]
DOSCODE:6801
DOSCODE:6801 NOCHG:				     ; ...
DOSCODE:6801		     stosb
DOSCODE:6802		     inc     bx
DOSCODE:6803		     loop    NEW_RENAME
DOSCODE:6805		     retn
DOSCODE:6805 NEW_RENAME	     endp
DOSCODE:6805
DOSCODE:6806
DOSCODE:6806 ; =============== S U B R O U T I N E =======================================
DOSCODE:6806
DOSCODE:6806
DOSCODE:6806 GET_FILE_INFO   proc near		     ; ...
DOSCODE:6806		     call    TestNet
DOSCODE:6809		     jnb     short LOCAL_INFO
DOSCODE:680B		     mov     ax, 110Fh	     ; (MultNET	SHL 8) OR 15
DOSCODE:680E		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	GET REMOTE FILE'S ATTRIBUTES
DOSCODE:680E					     ; SS = DOS	CS, SDA	first filename pointer -> fully-qualified name of file
DOSCODE:680E					     ; SDA CDS pointer -> current directory
DOSCODE:680E					     ; Return: CF set on error,	AX = file attributes
DOSCODE:6810		     retn
DOSCODE:6811 ; ---------------------------------------------------------------------------
DOSCODE:6811
DOSCODE:6811 LOCAL_INFO:			     ; ...
DOSCODE:6811		     call    ECritDisk
DOSCODE:6814		     mov     ds:NoSetDir, 1
DOSCODE:6819		     call    GET_FAST_PATH
DOSCODE:681C		     jnb     short info_check_dev
DOSCODE:681E
DOSCODE:681E NO_PATH:				     ; ...
DOSCODE:681E		     jnz     short bad_path1
DOSCODE:6820		     or	     cl, cl
DOSCODE:6822		     jz	     short bad_path1
DOSCODE:6824
DOSCODE:6824 info_no_file:			     ; ...
DOSCODE:6824		     mov     ax, 2	     ; error_file_not_found
DOSCODE:6827
DOSCODE:6827 BadRet:				     ; ...
DOSCODE:6827		     stc
DOSCODE:6828
DOSCODE:6828 JustRet:				     ; ...
DOSCODE:6828		     call    LCritDisk
DOSCODE:682B		     retn
DOSCODE:682C ; ---------------------------------------------------------------------------
DOSCODE:682C
DOSCODE:682C bad_path1:				     ; ...
DOSCODE:682C		     mov     ax, 3	     ; error_path_not_found
DOSCODE:682F		     jmp     short BadRet
DOSCODE:6831 ; ---------------------------------------------------------------------------
DOSCODE:6831
DOSCODE:6831 info_check_dev:			     ; ...
DOSCODE:6831		     or	     ah, ah
DOSCODE:6833		     js	     short info_no_file
DOSCODE:6835		     cmp     word ptr ds:CURBUF, 0FFFFh	; -1
DOSCODE:683A		     jnz     short not_root
DOSCODE:683C		     xor     ah, ah
DOSCODE:683E		     mov     al, 10h	     ; attr_directory
DOSCODE:6840		     clc
DOSCODE:6841		     jmp     short JustRet
DOSCODE:6843 ; ---------------------------------------------------------------------------
DOSCODE:6843
DOSCODE:6843 not_root:				     ; ...
DOSCODE:6843		     push    ds
DOSCODE:6844		     mov     ds, word ptr ds:CURBUF+2
DOSCODE:6848		     mov     si, bx
DOSCODE:684A		     xor     bx, bx
DOSCODE:684C		     mov     di, bx
DOSCODE:684E		     mov     cx, [si+16h]    ; [SI+dir_entry.dir_time]
DOSCODE:6851		     mov     dx, [si+18h]    ; [SI+dir_entry.dir_date]
DOSCODE:6854		     xor     ah, ah
DOSCODE:6856		     mov     al, [si+0Bh]    ; [SI+dir_entry.dir_attr]
DOSCODE:6859		     test    al, 10h	     ; attr_directory
DOSCODE:685B		     jnz     short NO_SIZE
DOSCODE:685D		     mov     di, [si+1Ch]    ; [SI+dir_entry.dir_size_l]
DOSCODE:6860		     mov     bx, [si+1Eh]    ; [SI+dir_entry.dir_size_h]
DOSCODE:6863
DOSCODE:6863 NO_SIZE:				     ; ...
DOSCODE:6863		     pop     ds
DOSCODE:6864		     clc
DOSCODE:6865		     jmp     short JustRet
DOSCODE:6865 GET_FILE_INFO   endp
DOSCODE:6865
DOSCODE:6867
DOSCODE:6867 ; =============== S U B R O U T I N E =======================================
DOSCODE:6867
DOSCODE:6867
DOSCODE:6867 SET_FILE_ATTRIBUTE	proc near	     ; ...
DOSCODE:6867		     test    ax, 0FFD8h	     ; ~attr_changeable
DOSCODE:686A		     jz	     short set_look
DOSCODE:686C
DOSCODE:686C _BAD_ACC:				     ; ...
DOSCODE:686C		     mov     ds:EXTERR_LOCUS, 1	; errLOC_Unk
DOSCODE:6871		     mov     ds:EXTERR_CLASS, 7	; errCLASS_Apperr
DOSCODE:6876		     mov     ds:EXTERR_ACTION, 4 ; errACT_Abort
DOSCODE:687B		     mov     ax, 5	     ; error_access_denied
DOSCODE:687E		     stc
DOSCODE:687F		     retn
DOSCODE:6880 ; ---------------------------------------------------------------------------
DOSCODE:6880
DOSCODE:6880 set_look:				     ; ...
DOSCODE:6880		     call    TestNet
DOSCODE:6883		     jnb     short LOCAL_SET
DOSCODE:6885		     push    ax
DOSCODE:6886		     mov     ax, 110Eh	     ; (MultNET	SHL 8) OR 14
DOSCODE:6889		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	SET REMOTE FILE'S ATTRIBUTES
DOSCODE:6889					     ; SS = DOS	CS, SDA	first filename pointer -> fully-qualified name of file
DOSCODE:6889					     ; SDA CDS pointer -> current directory
DOSCODE:6889					     ; STACK: WORD new file attributes
DOSCODE:6889					     ; Return: CF set on error
DOSCODE:688B		     pop     bx
DOSCODE:688C		     retn
DOSCODE:688D ; ---------------------------------------------------------------------------
DOSCODE:688D
DOSCODE:688D LOCAL_SET:				     ; ...
DOSCODE:688D		     call    ECritDisk
DOSCODE:6890		     push    ax
DOSCODE:6891		     mov     ds:NoSetDir, 1
DOSCODE:6896		     call    GETPATH
DOSCODE:6899		     jnb     short set_check_device
DOSCODE:689B		     pop     bx
DOSCODE:689C		     jmp     short NO_PATH
DOSCODE:689E ; ---------------------------------------------------------------------------
DOSCODE:689E
DOSCODE:689E set_check_device:			     ; ...
DOSCODE:689E		     or	     ah, ah
DOSCODE:68A0		     jns     short set_check_share
DOSCODE:68A2		     pop     ax
DOSCODE:68A3		     call    LCritDisk
DOSCODE:68A6		     jmp     short _BAD_ACC
DOSCODE:68A8 ; ---------------------------------------------------------------------------
DOSCODE:68A8
DOSCODE:68A8 set_check_share:			     ; ...
DOSCODE:68A8		     pop     ax
DOSCODE:68A9		     cmp     word ptr ds:CURBUF, -1 ; 0FFFFh
DOSCODE:68AE		     jz	     short cannot_set_root
DOSCODE:68B0		     call    REN_DEL_Check
DOSCODE:68B3		     jnb     short set_do
DOSCODE:68B5		     mov     ax, 20h	     ; error_sharing_violation
DOSCODE:68B8		     jmp     short OK_BYE
DOSCODE:68BA ; ---------------------------------------------------------------------------
DOSCODE:68BA
DOSCODE:68BA cannot_set_root:			     ; ...
DOSCODE:68BA		     mov     ax, 5	     ; error_access_denied
DOSCODE:68BD		     stc
DOSCODE:68BE		     jmp     short OK_BYE
DOSCODE:68C0 ; ---------------------------------------------------------------------------
DOSCODE:68C0
DOSCODE:68C0 set_do:				     ; ...
DOSCODE:68C0		     les     di, ds:CURBUF
DOSCODE:68C4		     and     byte ptr es:[bx+0Bh], 0D8h	; [ES:BX+dir_entry.dir_attr],~attr_changeable
DOSCODE:68C9		     or	     es:[bx+0Bh], al ; [ES:BX+dir_entry.dir_attr]
DOSCODE:68CD		     test    byte ptr es:[di+5], 40h ; [ES:DI+BUFFINFO.buf_flags],buf_dirty
DOSCODE:68D2		     jnz     short yesdirty3
DOSCODE:68D4		     call    INC_DIRTY_COUNT
DOSCODE:68D7		     or	     byte ptr es:[di+5], 40h ; [ES:DI+BUFFINFO.buf_flags],buf_dirty
DOSCODE:68DC
DOSCODE:68DC yesdirty3:				     ; ...
DOSCODE:68DC		     mov     al, ds:THISDRV
DOSCODE:68DF		     push    dx
DOSCODE:68E0		     push    di
DOSCODE:68E1		     mov     ah, 0
DOSCODE:68E3		     mov     dl, al
DOSCODE:68E5		     mov     di, bx
DOSCODE:68E7		     call    FastOpen_Update
DOSCODE:68EA		     pop     di
DOSCODE:68EB		     pop     dx
DOSCODE:68EC		     call    FLUSHBUF
DOSCODE:68EF		     jnb     short OK_BYE
DOSCODE:68F1		     mov     ax, 2	     ; error_file_not_found
DOSCODE:68F4
DOSCODE:68F4 OK_BYE:				     ; ...
DOSCODE:68F4		     call    LCritDisk
DOSCODE:68F7		     retn
DOSCODE:68F7 SET_FILE_ATTRIBUTE	endp
DOSCODE:68F7
DOSCODE:68F8
DOSCODE:68F8 ; =============== S U B R O U T I N E =======================================
DOSCODE:68F8
DOSCODE:68F8
DOSCODE:68F8 GET_FAST_PATH   proc near		     ; ...
DOSCODE:68F8		     or	     ss:FastOpenFlg, 1 ; FastOpen_Set
DOSCODE:68FE		     call    GETPATH
DOSCODE:6901		     pushf
DOSCODE:6902		     and     ss:FastOpenFlg, 80h ; Fast_yes
DOSCODE:6908		     popf
DOSCODE:6909		     retn
DOSCODE:6909 GET_FAST_PATH   endp
DOSCODE:6909
DOSCODE:690A
DOSCODE:690A ; =============== S U B R O U T I N E =======================================
DOSCODE:690A
DOSCODE:690A
DOSCODE:690A DOS_DUP	     proc near		     ; ...
DOSCODE:690A		     mov     es, cs:DosDSeg
DOSCODE:690F		     les     di, es:THISSFT
DOSCODE:6914
DOSCODE:6914 DOS_Dup_Direct:			     ; ...
DOSCODE:6914		     call    IsSFTNet
DOSCODE:6917		     jnz     short DO_INC
DOSCODE:6919		     call    DEV_OPEN_SFT
DOSCODE:691C
DOSCODE:691C DO_INC:				     ; ...
DOSCODE:691C		     inc     word ptr es:[di] ;	[ES:DI+SF_ENTRY.sf_ref_count]
DOSCODE:691F		     retn
DOSCODE:691F DOS_DUP	     endp
DOSCODE:691F
DOSCODE:6920 ; ---------------------------------------------------------------------------
DOSCODE:6920
DOSCODE:6920 DOS_CREATE:			     ; ...
DOSCODE:6920		     xor     ah, ah
DOSCODE:6922
DOSCODE:6922 Create_inter:			     ; ...
DOSCODE:6922		     test    al, 80h	     ; ~(attr_all+attr_ignore+attr_volume_id)
DOSCODE:6924		     jnz     short AttErr
DOSCODE:6926		     test    al, 8	     ; attr_volume_id
DOSCODE:6928		     jz	     short NoReset
DOSCODE:692A		     or	     ds:DOS34_FLAG, 80h	; DBCS_VOLID
DOSCODE:6930		     mov     al, 8	     ; attr_volume_id
DOSCODE:6932
DOSCODE:6932 NoReset:				     ; ...
DOSCODE:6932		     or	     al, 20h	     ; attr_archive
DOSCODE:6934		     test    al, 50h	     ; attr_directory+attr_device
DOSCODE:6936		     jz	     short ATT_OK
DOSCODE:6938
DOSCODE:6938 AttErr:				     ; ...
DOSCODE:6938		     mov     ax, 5	     ; Attribute problem
DOSCODE:693B		     mov     ds:EXTERR_LOCUS, 1	; errLOC_Unk
DOSCODE:6940		     jmp     short SET_MKND_ERR
DOSCODE:6942 ; ---------------------------------------------------------------------------
DOSCODE:6942
DOSCODE:6942 ATT_OK:				     ; ...
DOSCODE:6942		     les     di, ds:THISSFT
DOSCODE:6946		     push    es
DOSCODE:6947		     les     si, ds:THISCDS
DOSCODE:694B		     cmp     si, -1	     ; 0FFFFh
DOSCODE:694E		     jnz     short TEST_RE_NET
DOSCODE:6950		     pop     es
DOSCODE:6951		     test    ds:EXTOPEN_ON, 1 ;	EXT_OPEN_ON
DOSCODE:6956		     jz	     short NOEXTOP
DOSCODE:6958
DOSCODE:6958 IFS_extopen:			     ; ...
DOSCODE:6958		     push    ax
DOSCODE:6959		     mov     ax, 112Eh	     ; (MultNET	SHL 8) OR 46
DOSCODE:695C		     int     2Fh	     ; Multiplex - DOS 4 IFSFUNC.EXE - ???
DOSCODE:695C					     ; SS = DS = DOS CS, STACK:	WORD ???   low byte = ???
DOSCODE:695C					     ; Return: CF set on error
DOSCODE:695C					     ; CF clear	if successful
DOSCODE:695E		     pop     bx
DOSCODE:695F		     mov     ds:EXTOPEN_ON, 0
DOSCODE:6964		     retn
DOSCODE:6965 ; ---------------------------------------------------------------------------
DOSCODE:6965
DOSCODE:6965 NOEXTOP:				     ; ...
DOSCODE:6965		     push    ax
DOSCODE:6966		     mov     ax, 1118h
DOSCODE:6969		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	CREATE/TRUNCATE	FILE
DOSCODE:6969					     ; ES:DI ->	uninitialized SFT, SS =	DOS CS
DOSCODE:6969					     ; SDA first filename pointer -> fully-qualified name of file
DOSCODE:6969					     ; STACK: WORD file	creation mode???
DOSCODE:696B		     pop     bx
DOSCODE:696C		     retn
DOSCODE:696D ; ---------------------------------------------------------------------------
DOSCODE:696D
DOSCODE:696D TEST_RE_NET:			     ; ...
DOSCODE:696D		     test    word ptr es:[si+43h], 8000h ; [ES:SI+curdir.flags],
DOSCODE:696D					     ; curdir_isnet
DOSCODE:6973		     pop     es
DOSCODE:6974		     jz	     short LOCAL_CREATE
DOSCODE:6976		     call    Set_EXT_mode
DOSCODE:6979		     jb	     short dochk
DOSCODE:697B		     or	     word ptr es:[di+2], 2 ; [ES:DI+SF_ENTRY.sf_mode],
DOSCODE:697B					     ; SHARING_COMPAT+open_for_both
DOSCODE:6980
DOSCODE:6980 dochk:				     ; ...
DOSCODE:6980		     test    ds:EXTOPEN_ON, 1
DOSCODE:6985		     jnz     short IFS_extopen
DOSCODE:6987		     push    ax
DOSCODE:6988		     mov     ax, 1117h	     ; (MultNET	SHL 8) OR 23
DOSCODE:698B		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	CREATE/TRUNCATE	REMOTE FILE
DOSCODE:698B					     ; ES:DI ->	uninitialized SFT, SS =	DOS CS
DOSCODE:698B					     ; SDA first filename pointer -> fully-qualified name of file to open
DOSCODE:698B					     ; SDA CDS pointer -> current directory
DOSCODE:698B					     ; Return: CF set on error
DOSCODE:698D		     pop     bx
DOSCODE:698E		     retn
DOSCODE:698F ; ---------------------------------------------------------------------------
DOSCODE:698F
DOSCODE:698F LOCAL_CREATE:			     ; ...
DOSCODE:698F		     call    Set_EXT_mode
DOSCODE:6992		     jb	     short setdone
DOSCODE:6994		     or	     word ptr es:[di+2], 2 ; [ES:DI+SF_ENTRY.sf_mode],
DOSCODE:6994					     ; SHARING_COMPAT+open_for_both
DOSCODE:6999
DOSCODE:6999 setdone:				     ; ...
DOSCODE:6999		     call    ECritDisk
DOSCODE:699C		     call    MakeNode
DOSCODE:699F		     jnb     short Create_ok
DOSCODE:69A1		     mov     ds:VOLCHNG_FLAG, 0FFh ; -1
DOSCODE:69A6		     call    LCritDisk
DOSCODE:69A9
DOSCODE:69A9 SET_MKND_ERR:			     ; ...
DOSCODE:69A9		     mov     bx, offset	CRTERRTAB
DOSCODE:69AC		     xlat    byte ptr cs:[bx] ;	CS XLAT
DOSCODE:69AE		     stc
DOSCODE:69AF		     retn
DOSCODE:69AF ; ---------------------------------------------------------------------------
DOSCODE:69B0 CRTERRTAB	     db	0		     ; ...
DOSCODE:69B1		     db	5		     ; error_access_denied
DOSCODE:69B2		     db	52h		     ; error_cannot_make
DOSCODE:69B3		     db	50h		     ; error_file_exists
DOSCODE:69B4		     db	3		     ; error_path_not_found
DOSCODE:69B5		     db	5		     ; error_access_denied
DOSCODE:69B6		     db	20h		     ; error_sharing_violation
DOSCODE:69B7		     db	2		     ; error_file_not_found
DOSCODE:69B8 ; ---------------------------------------------------------------------------
DOSCODE:69B8
DOSCODE:69B8 Create_ok:				     ; ...
DOSCODE:69B8		     call    FastOpen_Delete
DOSCODE:69BB		     mov     al, ds:SATTRIB
DOSCODE:69BE		     test    al, 8	     ; attr_volume_id
DOSCODE:69C0		     jz	     short NoVolLabel
DOSCODE:69C2		     les     di, ds:THISCDS
DOSCODE:69C6		     mov     ah, es:[di]     ; [ES:DI+curdir.text]
DOSCODE:69C9		     sub     ah, 'A'         ; 41h
DOSCODE:69CC		     mov     ds:VOLCHNG_FLAG, ah
DOSCODE:69D0		     mov     bh, 1
DOSCODE:69D2		     call    Set_Media_ID
DOSCODE:69D5		     call    ECritDisk
DOSCODE:69D8		     call    FATREAD_CDS
DOSCODE:69DB		     call    LCritDisk
DOSCODE:69DE
DOSCODE:69DE NoVolLabel:			     ; ...
DOSCODE:69DE		     mov     ax, 2
DOSCODE:69E1		     les     di, ds:THISSFT
DOSCODE:69E5		     call    dword ptr ds:ShSU ; call far [JShare+(14*4)]
DOSCODE:69E9		     call    LCritDisk
DOSCODE:69EC		     jmp     SET_SFT_MODE
DOSCODE:69EF ; ---------------------------------------------------------------------------
DOSCODE:69EF
DOSCODE:69EF DOS_Create_New:			     ; ...
DOSCODE:69EF		     mov     ah, 1
DOSCODE:69F1		     jmp     Create_inter
DOSCODE:69F4
DOSCODE:69F4 ; =============== S U B R O U T I N E =======================================
DOSCODE:69F4
DOSCODE:69F4
DOSCODE:69F4 Set_Media_ID    proc near		     ; ...
DOSCODE:69F4		     push    ax
DOSCODE:69F5		     push    es
DOSCODE:69F6		     push    di
DOSCODE:69F7		     inc     ah
DOSCODE:69F9		     mov     bl, ah
DOSCODE:69FB		     mov     al, 0Dh	     ; generic IOCTL
DOSCODE:69FD		     mov     cx, 866h	     ; get media id
DOSCODE:6A00		     mov     dx, offset	FAKE_STACK_2F ;	Packet_Temp
DOSCODE:6A03		     push    bx
DOSCODE:6A04		     push    dx
DOSCODE:6A05		     xor     bh, bh
DOSCODE:6A07		     call    $IOCTL
DOSCODE:6A0A		     pop     dx
DOSCODE:6A0B		     pop     bx
DOSCODE:6A0C		     jb	     short geterr
DOSCODE:6A0E		     or	     bh, bh
DOSCODE:6A10		     jz	     short NoName    ; delete volume id
DOSCODE:6A12		     mov     si, offset	NAME1 ;	set volume id
DOSCODE:6A15		     jmp     short doset
DOSCODE:6A17 ; ---------------------------------------------------------------------------
DOSCODE:6A17
DOSCODE:6A17 NoName:				     ; ...
DOSCODE:6A17		     mov     si, offset	NO_NAME_ID ; "NO NAME	 "
DOSCODE:6A1A
DOSCODE:6A1A doset:				     ; ...
DOSCODE:6A1A		     mov     di, dx
DOSCODE:6A1C		     add     di, 6	     ; MEDIA_ID_INFO.MEDIA_Label
DOSCODE:6A1F		     push    ss
DOSCODE:6A20		     pop     ds
DOSCODE:6A21		     push    ss
DOSCODE:6A22		     pop     es
DOSCODE:6A23		     mov     cx, 11
DOSCODE:6A26		     rep movsb
DOSCODE:6A28		     mov     cx, 846h	     ; set volume id
DOSCODE:6A2B		     mov     al, 0Dh
DOSCODE:6A2D		     xor     bh, bh
DOSCODE:6A2F		     call    $IOCTL
DOSCODE:6A32
DOSCODE:6A32 geterr:				     ; ...
DOSCODE:6A32		     push    ss
DOSCODE:6A33		     pop     ds
DOSCODE:6A34		     pop     di
DOSCODE:6A35		     pop     es
DOSCODE:6A36		     pop     ax
DOSCODE:6A37		     retn
DOSCODE:6A37 Set_Media_ID    endp
DOSCODE:6A37
DOSCODE:6A38
DOSCODE:6A38 ; =============== S U B R O U T I N E =======================================
DOSCODE:6A38
DOSCODE:6A38
DOSCODE:6A38 Set_EXT_mode    proc near		     ; ...
DOSCODE:6A38		     test    ss:EXTOPEN_ON, 1 ;	[ss:EXTOPEN_ON],EXT_OPEN_ON
DOSCODE:6A3E		     jz	     short NOTEX
DOSCODE:6A40		     push    ax
DOSCODE:6A41		     mov     ax, ss:SAVE_BX
DOSCODE:6A45		     or	     es:[di+2],	ax   ; [ES:DI+SF_ENTRY.sf_mode]
DOSCODE:6A49		     pop     ax
DOSCODE:6A4A		     stc
DOSCODE:6A4B
DOSCODE:6A4B NOTEX:				     ; ...
DOSCODE:6A4B		     retn
DOSCODE:6A4B Set_EXT_mode    endp
DOSCODE:6A4B
DOSCODE:6A4C ; ---------------------------------------------------------------------------
DOSCODE:6A4C
DOSCODE:6A4C DOS_OPEN:				     ; ...
DOSCODE:6A4C		     mov     ds:NoSetDir, 0
DOSCODE:6A51		     call    Check_Access_AX
DOSCODE:6A54		     jb	     short do_ret_label
DOSCODE:6A56		     les     di, ds:THISSFT
DOSCODE:6A5A		     xor     ah, ah
DOSCODE:6A5C		     mov     es:[di+2],	al   ; [ES:DI+SF_ENTRY.sf_mode]
DOSCODE:6A60		     push    es
DOSCODE:6A61		     les     si, ds:THISCDS
DOSCODE:6A65		     cmp     si, -1
DOSCODE:6A68		     jnz     short TEST_RE_NET1
DOSCODE:6A6A		     pop     es
DOSCODE:6A6B		     test    ds:EXTOPEN_ON, 1 ;	EXT_OPEN_ON
DOSCODE:6A70		     jz	     short _NOEXTOP
DOSCODE:6A72
DOSCODE:6A72 _IFS_extopen:			     ; ...
DOSCODE:6A72		     mov     al, byte ptr ds:SAVE_BX
DOSCODE:6A75		     push    ax
DOSCODE:6A76		     mov     ax, 112Eh	     ; (MultNET*256)+46
DOSCODE:6A79		     int     2Fh	     ; Multiplex - DOS 4 IFSFUNC.EXE - ???
DOSCODE:6A79					     ; SS = DS = DOS CS, STACK:	WORD ???   low byte = ???
DOSCODE:6A79					     ; Return: CF set on error
DOSCODE:6A79					     ; CF clear	if successful
DOSCODE:6A7B		     pop     bx
DOSCODE:6A7C		     mov     ds:EXTOPEN_ON, 0
DOSCODE:6A81
DOSCODE:6A81 do_ret_label:			     ; ...
DOSCODE:6A81		     retn
DOSCODE:6A82 ; ---------------------------------------------------------------------------
DOSCODE:6A82
DOSCODE:6A82 _NOEXTOP:				     ; ...
DOSCODE:6A82		     test    ds:DOS_FLAG, 1  ; EXECOPEN
DOSCODE:6A87		     jz	     short not_exec_open
DOSCODE:6A89		     test    byte ptr ds:DOS34_FLAG+1, 8 ; (EXEC_AWARE_REDIR>>8)
DOSCODE:6A8E		     jz	     short not_exec_open
DOSCODE:6A90		     mov     al, 23h	     ; SHARING_DENY_WRITE+EXEC_OPEN
DOSCODE:6A92
DOSCODE:6A92 not_exec_open:			     ; ...
DOSCODE:6A92		     push    ax
DOSCODE:6A93		     mov     ax, 1116h	     ; (MultNET	SHL 8) OR 22
DOSCODE:6A96		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	OPEN EXISTING REMOTE FILE
DOSCODE:6A96					     ; ES:DI ->	uninitialized SFT, SS =	DOS CS
DOSCODE:6A96					     ; SDA first filename pointer -> fully-qualified name of file to open
DOSCODE:6A96					     ; STACK: WORD file	open mode
DOSCODE:6A96					     ; Return: CF set on error
DOSCODE:6A98		     pop     bx
DOSCODE:6A99		     retn
DOSCODE:6A9A ; ---------------------------------------------------------------------------
DOSCODE:6A9A
DOSCODE:6A9A TEST_RE_NET1:			     ; ...
DOSCODE:6A9A		     test    word ptr es:[si+43h], 8000h ; [ES:SI+curdir.flags],
DOSCODE:6A9A					     ; curdir_isnet
DOSCODE:6AA0		     pop     es
DOSCODE:6AA1		     jz	     short LOCAL_OPEN
DOSCODE:6AA3		     test    ds:EXTOPEN_ON, 1
DOSCODE:6AA8		     jnz     short _IFS_extopen
DOSCODE:6AAA		     jmp     short _NOEXTOP
DOSCODE:6AAC ; ---------------------------------------------------------------------------
DOSCODE:6AAC
DOSCODE:6AAC LOCAL_OPEN:			     ; ...
DOSCODE:6AAC		     call    ECritDisk
DOSCODE:6AAF		     or	     ds:FastOpenFlg, 5 ; FastOpen_Set+Special_Fill_Set
DOSCODE:6AB4		     call    GETPATH
DOSCODE:6AB7		     jnb     short Open_found
DOSCODE:6AB9		     jnz     short bad_path2
DOSCODE:6ABB		     or	     cl, cl
DOSCODE:6ABD		     jz	     short bad_path2
DOSCODE:6ABF		     mov     ax, 2	     ; error_file_not_found
DOSCODE:6AC2
DOSCODE:6AC2 OpenBadRet:			     ; ...
DOSCODE:6AC2		     and     ss:FastOpenFlg, 80h ; Fast_yes
DOSCODE:6AC8		     stc
DOSCODE:6AC9		     call    LCritDisk
DOSCODE:6ACC		     jmp     Clear_FastOpen
DOSCODE:6ACF ; ---------------------------------------------------------------------------
DOSCODE:6ACF
DOSCODE:6ACF bad_path2:				     ; ...
DOSCODE:6ACF		     mov     ax, 3	     ; error_path_not_found
DOSCODE:6AD2		     jmp     short OpenBadRet
DOSCODE:6AD4 ; ---------------------------------------------------------------------------
DOSCODE:6AD4
DOSCODE:6AD4 Open_Bad_Access:			     ; ...
DOSCODE:6AD4		     mov     ax, 5	     ; error_access_denied
DOSCODE:6AD7		     jmp     short OpenBadRet
DOSCODE:6AD9 ; ---------------------------------------------------------------------------
DOSCODE:6AD9
DOSCODE:6AD9 Open_found:			     ; ...
DOSCODE:6AD9		     jz	     short Open_Bad_Access
DOSCODE:6ADB		     or	     ah, ah
DOSCODE:6ADD		     js	     short open_ok
DOSCODE:6ADF		     mov     es, word ptr ds:CURBUF+2
DOSCODE:6AE3		     mov     al, es:[bx+0Bh] ; [ES:BX+dir_entry.dir_attr]
DOSCODE:6AE7		     test    al, 8	     ; attr_volume_id
DOSCODE:6AE9		     jnz     short Open_Bad_Access
DOSCODE:6AEB		     test    al, 1	     ; attr_read_only
DOSCODE:6AED		     jz	     short open_ok
DOSCODE:6AEF		     push    ds
DOSCODE:6AF0		     push    si
DOSCODE:6AF1		     lds     si, ds:THISSFT
DOSCODE:6AF5		     mov     cx, [si+2]	     ; [SI+SF_ENTRY.sf_mode]
DOSCODE:6AF8		     test    cx, 8000h	     ; sf_isFCB
DOSCODE:6AFC		     jnz     short ResetAccess
DOSCODE:6AFE		     mov     dl, cl
DOSCODE:6B00		     and     dl, 0F0h	     ; SHARING_MASK
DOSCODE:6B03		     cmp     dl, 70h	     ; SHARING_NET_FCB
DOSCODE:6B06		     jnz     short NormalOpen
DOSCODE:6B08
DOSCODE:6B08 ResetAccess:			     ; ...
DOSCODE:6B08		     and     cx, 0FFF0h	     ; ~access_mask
DOSCODE:6B0B		     mov     [si+2], cx	     ; [SI+SF_ENTRY.sf_mode]
DOSCODE:6B0E		     jmp     short FillSFT
DOSCODE:6B10 ; ---------------------------------------------------------------------------
DOSCODE:6B10
DOSCODE:6B10 NormalOpen:			     ; ...
DOSCODE:6B10		     and     cl, 0Fh	     ; access_mask
DOSCODE:6B13		     cmp     cl, 0	     ; open_for_read
DOSCODE:6B16		     jz	     short FillSFT
DOSCODE:6B18		     pop     si
DOSCODE:6B19		     pop     ds
DOSCODE:6B1A		     jmp     short Open_Bad_Access
DOSCODE:6B1C ; ---------------------------------------------------------------------------
DOSCODE:6B1C
DOSCODE:6B1C FillSFT:				     ; ...
DOSCODE:6B1C		     pop     si
DOSCODE:6B1D		     pop     ds
DOSCODE:6B1E
DOSCODE:6B1E open_ok:				     ; ...
DOSCODE:6B1E		     call    DOOPEN
DOSCODE:6B21		     and     ss:FastOpenFlg, 80h ; Fast_yes
DOSCODE:6B27		     call    DO_SHARE_CHECK
DOSCODE:6B2A		     jnb     short SHARE_OK
DOSCODE:6B2C		     call    LCritDisk
DOSCODE:6B2F		     jmp     short Clear_FastOpen
DOSCODE:6B31 ; ---------------------------------------------------------------------------
DOSCODE:6B31
DOSCODE:6B31 SHARE_OK:				     ; ...
DOSCODE:6B31		     mov     ax, 3
DOSCODE:6B34		     les     di, ds:THISSFT
DOSCODE:6B38		     call    dword ptr ds:ShSU ; call far [JShare+(14*4)]
DOSCODE:6B3C		     call    LCritDisk
DOSCODE:6B3F
DOSCODE:6B3F SET_SFT_MODE:			     ; ...
DOSCODE:6B3F		     les     di, ds:THISSFT
DOSCODE:6B43		     call    DEV_OPEN_SFT
DOSCODE:6B46		     test    word ptr es:[di+2], 8000h ; ES:DI+SF_ENTRY.sf_mode],
DOSCODE:6B46					     ; sf_isFCB
DOSCODE:6B4C		     jz	     short Clear_FastOpen
DOSCODE:6B4E		     mov     ax, ds:CurrentPDB
DOSCODE:6B51		     mov     es:[di+31h], ax ; [ES:DI+SF_ENTRY.sf_PID]
DOSCODE:6B55
DOSCODE:6B55 Clear_FastOpen:			     ; ...
DOSCODE:6B55		     retn
DOSCODE:6B56
DOSCODE:6B56 ; =============== S U B R O U T I N E =======================================
DOSCODE:6B56
DOSCODE:6B56
DOSCODE:6B56 SHARE_ERROR     proc near		     ; ...
DOSCODE:6B56		     test    word ptr es:[di+2], 8000h ; [ES:DI+SF_ENTRY.sf_mode],
DOSCODE:6B56					     ; sf_isFCB
DOSCODE:6B5C		     jnz     short _HARD_ERR
DOSCODE:6B5E		     mov     cl, es:[di+2]   ; [ES:DI+SF_ENTRY.sf_mode]
DOSCODE:6B62		     and     cl, 0F0h	     ; SHARING_MASK
DOSCODE:6B65		     cmp     cl, 0	     ; SHARING_COMPAT
DOSCODE:6B68		     jnz     short _NO_HARD_ERR
DOSCODE:6B6A
DOSCODE:6B6A _HARD_ERR:				     ; ...
DOSCODE:6B6A		     call    SHARE_VIOLATION
DOSCODE:6B6D		     jnb     short Clear_FastOpen
DOSCODE:6B6F
DOSCODE:6B6F _NO_HARD_ERR:			     ; ...
DOSCODE:6B6F		     mov     ax, 20h	     ; error_sharing_violation
DOSCODE:6B72		     stc
DOSCODE:6B73		     retn
DOSCODE:6B73 SHARE_ERROR     endp
DOSCODE:6B73
DOSCODE:6B74
DOSCODE:6B74 ; =============== S U B R O U T I N E =======================================
DOSCODE:6B74
DOSCODE:6B74
DOSCODE:6B74 DO_SHARE_CHECK  proc near		     ; ...
DOSCODE:6B74		     call    ECritDisk
DOSCODE:6B77
DOSCODE:6B77 OPN_RETRY:				     ; ...
DOSCODE:6B77		     mov     cx, ds:RetryCount
DOSCODE:6B7B
DOSCODE:6B7B OpenShareRetry:			     ; ...
DOSCODE:6B7B		     push    cx
DOSCODE:6B7C		     call    SHARE_CHECK
DOSCODE:6B7F		     pop     cx
DOSCODE:6B80		     jnb     short Share_Ok2
DOSCODE:6B82		     call    Idle
DOSCODE:6B85		     loop    OpenShareRetry
DOSCODE:6B87		     les     di, ds:THISSFT
DOSCODE:6B8B		     call    SHARE_ERROR
DOSCODE:6B8E		     jnb     short OPN_RETRY
DOSCODE:6B90
DOSCODE:6B90 Share_Ok2:				     ; ...
DOSCODE:6B90		     call    LCritDisk
DOSCODE:6B93		     retn
DOSCODE:6B93 DO_SHARE_CHECK  endp
DOSCODE:6B93
DOSCODE:6B94
DOSCODE:6B94 ; =============== S U B R O U T I N E =======================================
DOSCODE:6B94
DOSCODE:6B94
DOSCODE:6B94 Check_Access_AX proc near		     ; ...
DOSCODE:6B94		     mov     ds:OPEN_ACCESS, al
DOSCODE:6B97		     push    bx
DOSCODE:6B98		     mov     bl, al
DOSCODE:6B9A		     and     bl, 0F0h	     ; SHARING_MASK
DOSCODE:6B9D		     cmp     ds:FSHARING, -1
DOSCODE:6BA2		     jnz     short CheckShareMode
DOSCODE:6BA4		     cmp     bl, 70h	     ; SHARING_NET_FCB
DOSCODE:6BA7		     jz	     short CheckAccessMode
DOSCODE:6BA9
DOSCODE:6BA9 CheckShareMode:			     ; ...
DOSCODE:6BA9		     cmp     bl, 40h
DOSCODE:6BAC		     ja	     short Make_Bad_Access
DOSCODE:6BAE
DOSCODE:6BAE CheckAccessMode:			     ; ...
DOSCODE:6BAE		     mov     bl, al
DOSCODE:6BB0		     and     bl, 0Fh	     ; access_mask
DOSCODE:6BB3		     cmp     bl, 2
DOSCODE:6BB6		     ja	     short Make_Bad_Access
DOSCODE:6BB8		     pop     bx
DOSCODE:6BB9		     clc
DOSCODE:6BBA		     retn
DOSCODE:6BBB ; ---------------------------------------------------------------------------
DOSCODE:6BBB
DOSCODE:6BBB Make_Bad_Access:			     ; ...
DOSCODE:6BBB		     mov     ax, 0Ch	     ; error_invalid_access
DOSCODE:6BBE		     pop     bx
DOSCODE:6BBF		     stc
DOSCODE:6BC0		     retn
DOSCODE:6BC0 Check_Access_AX endp
DOSCODE:6BC0
DOSCODE:6BC1
DOSCODE:6BC1 ; =============== S U B R O U T I N E =======================================
DOSCODE:6BC1
DOSCODE:6BC1
DOSCODE:6BC1 DISK_INFO	     proc near		     ; ...
DOSCODE:6BC1		     call    TestNet
DOSCODE:6BC4		     jnb     short LOCAL_DSK_INFO
DOSCODE:6BC6		     mov     ax, 110Ch
DOSCODE:6BC9		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	GET DISK SPACE
DOSCODE:6BC9					     ; ES:DI ->	current	directory
DOSCODE:6BC9					     ; Return: AL = sectors per	cluster, BX = total clusters
DOSCODE:6BC9					     ; CX = bytes per sector, DX = number of available clusters
DOSCODE:6BCB		     retn
DOSCODE:6BCC ; ---------------------------------------------------------------------------
DOSCODE:6BCC
DOSCODE:6BCC LOCAL_DSK_INFO:			     ; ...
DOSCODE:6BCC		     mov     ds:EXTERR_LOCUS, 2	; errLOC_Disk
DOSCODE:6BD1		     call    ECritDisk
DOSCODE:6BD4		     call    FATREAD_CDS
DOSCODE:6BD7		     jb	     short CRIT_LEAVE
DOSCODE:6BD9		     mov     bx, 2
DOSCODE:6BDC		     call    UNPACK
DOSCODE:6BDF		     jb	     short CRIT_LEAVE
DOSCODE:6BE1		     lds     si, ds:CURBUF
DOSCODE:6BE5		     mov     ah, [si+14h]    ; [SI+BUFINSIZ]
DOSCODE:6BE8		     push    ss
DOSCODE:6BE9		     pop     ds
DOSCODE:6BEA		     mov     cx, es:[bp+0Dh] ; [ES:BP+DPB.MAX_CLUSTER]
DOSCODE:6BEE		     mov     dx, es:[bp+1Fh] ; [ES:BP+DPB.FREE_CNT]
DOSCODE:6BF2		     cmp     dx, -1	     ; 0FFFFh
DOSCODE:6BF5		     jz	     short DoScan
DOSCODE:6BF7		     cmp     dx, cx
DOSCODE:6BF9		     jb	     short GotVal
DOSCODE:6BFB
DOSCODE:6BFB DoScan:				     ; ...
DOSCODE:6BFB		     xor     dx, dx
DOSCODE:6BFD		     dec     cx
DOSCODE:6BFE
DOSCODE:6BFE SCANFREE:				     ; ...
DOSCODE:6BFE		     call    UNPACK
DOSCODE:6C01		     jb	     short CRIT_LEAVE
DOSCODE:6C03		     jnz     short NOTFREECLUS
DOSCODE:6C05		     inc     dx
DOSCODE:6C06
DOSCODE:6C06 NOTFREECLUS:			     ; ...
DOSCODE:6C06		     inc     bx
DOSCODE:6C07		     loop    SCANFREE
DOSCODE:6C09		     dec     bx
DOSCODE:6C0A
DOSCODE:6C0A ReturnVals:			     ; ...
DOSCODE:6C0A		     dec     bx
DOSCODE:6C0B		     mov     al, es:[bp+4]   ; [ES:BP+DPB.CLUSTER_MASK]
DOSCODE:6C0F		     inc     al
DOSCODE:6C11		     mov     cx, es:[bp+2]   ; [ES:BP+DPB.SECTOR_SIZE]
DOSCODE:6C15		     mov     es:[bp+1Fh], dx ; [ES:BP+DPB.FREE_CNT]
DOSCODE:6C19		     clc
DOSCODE:6C1A
DOSCODE:6C1A CRIT_LEAVE:			     ; ...
DOSCODE:6C1A		     call    LCritDisk
DOSCODE:6C1D		     retn
DOSCODE:6C1E ; ---------------------------------------------------------------------------
DOSCODE:6C1E
DOSCODE:6C1E GotVal:				     ; ...
DOSCODE:6C1E		     mov     bx, cx
DOSCODE:6C20		     jmp     short ReturnVals
DOSCODE:6C20 DISK_INFO	     endp
DOSCODE:6C20
DOSCODE:6C22
DOSCODE:6C22 ; =============== S U B R O U T I N E =======================================
DOSCODE:6C22
DOSCODE:6C22
DOSCODE:6C22 DOS_SEARCH_FIRST proc near		     ; ...
DOSCODE:6C22		     les     di, ds:THISCDS
DOSCODE:6C26		     cmp     di, 0FFFFh	     ; -1
DOSCODE:6C29		     jnz     short TEST_RE_NET2
DOSCODE:6C2B		     mov     ax, 1119h
DOSCODE:6C2E		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	???
DOSCODE:6C30		     retn
DOSCODE:6C31 ; ---------------------------------------------------------------------------
DOSCODE:6C31
DOSCODE:6C31 TEST_RE_NET2:			     ; ...
DOSCODE:6C31		     test    word ptr es:[di+43h], 8000h ; [ES:DI+curdir.flags],
DOSCODE:6C31					     ; curdir_isnet
DOSCODE:6C37		     jz	     short LOCAL_SEARCH_FIRST
DOSCODE:6C39		     mov     ax, 111Bh	     ; (MultNET<<8)|27
DOSCODE:6C3C		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	FINDFIRST
DOSCODE:6C3C					     ; SS = DS = DOS CS, [DTA] = uninitialized 21-byte findfirst search	data
DOSCODE:6C3C					     ; SDA first filename pointer -> fully-qualified search template
DOSCODE:6C3C					     ; SDA CDS pointer -> current directory
DOSCODE:6C3C					     ; Return: CF set on error
DOSCODE:6C3E		     retn
DOSCODE:6C3F ; ---------------------------------------------------------------------------
DOSCODE:6C3F
DOSCODE:6C3F LOCAL_SEARCH_FIRST:		     ; ...
DOSCODE:6C3F		     call    ECritDisk
DOSCODE:6C42		     test    ds:DOS34_FLAG, 400h ; SEARCH_FASTOPEN
DOSCODE:6C48		     jz	     short NOFN
DOSCODE:6C4A		     or	     ds:FastOpenFlg, 1 ; FastOpen_Set
DOSCODE:6C4F
DOSCODE:6C4F NOFN:				     ; ...
DOSCODE:6C4F		     mov     ds:NoSetDir, 1
DOSCODE:6C54		     call    CHECK_QUESTION
DOSCODE:6C57		     jnb     short norm_GETPATH
DOSCODE:6C59		     and     ds:FastOpenFlg, 80h ; Fast_yes
DOSCODE:6C5E
DOSCODE:6C5E norm_GETPATH:			     ; ...
DOSCODE:6C5E		     call    GETPATH
DOSCODE:6C61		     jnb     short find_check_dev
DOSCODE:6C63		     jnz     short bad_path3
DOSCODE:6C65		     or	     cl, cl
DOSCODE:6C67		     jz	     short bad_path3
DOSCODE:6C69
DOSCODE:6C69 find_no_more:			     ; ...
DOSCODE:6C69		     mov     ax, 12h	     ; error_no_more_files
DOSCODE:6C6C
DOSCODE:6C6C BadBye:				     ; ...
DOSCODE:6C6C		     and     ss:FastOpenFlg, 80h ; Fast_yes
DOSCODE:6C72		     stc
DOSCODE:6C73		     call    LCritDisk
DOSCODE:6C76		     retn
DOSCODE:6C77 ; ---------------------------------------------------------------------------
DOSCODE:6C77
DOSCODE:6C77 bad_path3:				     ; ...
DOSCODE:6C77		     mov     ax, 3
DOSCODE:6C7A		     jmp     short BadBye
DOSCODE:6C7C ; ---------------------------------------------------------------------------
DOSCODE:6C7C
DOSCODE:6C7C find_check_dev:			     ; ...
DOSCODE:6C7C		     or	     ah, ah
DOSCODE:6C7E		     jns     short found_entry
DOSCODE:6C80		     mov     ds:LASTENT, 0FFFFh	; -1
DOSCODE:6C86		     inc     ds:FOUND_DEV
DOSCODE:6C8A
DOSCODE:6C8A found_entry:			     ; ...
DOSCODE:6C8A		     les     di, ds:DMAADD
DOSCODE:6C8E		     mov     si, ds:WFP_START
DOSCODE:6C92		     lodsb
DOSCODE:6C93		     sub     al, 40h	     ; 'A'-1
DOSCODE:6C95		     stosb
DOSCODE:6C96
DOSCODE:6C96 found_it:				     ; ...
DOSCODE:6C96		     les     di, ds:DMAADD
DOSCODE:6C9A		     inc     di
DOSCODE:6C9B		     push    ds
DOSCODE:6C9C		     test    ds:FastOpenFlg, 10h ; Set_For_Search
DOSCODE:6CA1		     jz	     short notfast
DOSCODE:6CA3		     mov     si, bx
DOSCODE:6CA5		     mov     ds, word ptr ds:CURBUF+2
DOSCODE:6CA9		     jmp     short movmov
DOSCODE:6CAB ; ---------------------------------------------------------------------------
DOSCODE:6CAB
DOSCODE:6CAB notfast:				     ; ...
DOSCODE:6CAB		     mov     si, offset	NAME1
DOSCODE:6CAE
DOSCODE:6CAE movmov:				     ; ...
DOSCODE:6CAE		     movsb
DOSCODE:6CAF		     cmp     byte ptr es:[di-1], 5
DOSCODE:6CB4		     jnz     short NOTKANJB
DOSCODE:6CB6		     mov     byte ptr es:[di-1], 0E5h
DOSCODE:6CBB
DOSCODE:6CBB NOTKANJB:				     ; ...
DOSCODE:6CBB		     mov     cx, 10
DOSCODE:6CBE		     rep movsb
DOSCODE:6CC0		     pop     ds
DOSCODE:6CC1		     mov     al, ds:ATTRIB
DOSCODE:6CC4		     stosb
DOSCODE:6CC5		     push    ax
DOSCODE:6CC6		     mov     ax, ds:LASTENT
DOSCODE:6CC9		     stosw
DOSCODE:6CCA		     mov     ax, ds:DIRSTART
DOSCODE:6CCD		     stosw
DOSCODE:6CCE		     add     di, 4
DOSCODE:6CD1		     pop     ax
DOSCODE:6CD2		     or	     ah, ah
DOSCODE:6CD4		     js	     short DOSREL
DOSCODE:6CD6		     cmp     word ptr ds:CURBUF, -1 ; 0FFFFh
DOSCODE:6CDB		     jnz     short OKSTORE
DOSCODE:6CDD		     test    ds:FastOpenFlg, 10h ; Set_For_Search
DOSCODE:6CE2		     jnz     short OKSTORE
DOSCODE:6CE4		     mov     word ptr es:[di-8], 0FFFFh	; -1
DOSCODE:6CEA		     jmp     find_no_more
DOSCODE:6CED ; ---------------------------------------------------------------------------
DOSCODE:6CED
DOSCODE:6CED OKSTORE:				     ; ...
DOSCODE:6CED		     mov     ds, word ptr ds:CURBUF+2
DOSCODE:6CF1
DOSCODE:6CF1 DOSREL:				     ; ...
DOSCODE:6CF1		     mov     si, bx
DOSCODE:6CF3		     mov     cx, 32	     ; dir_entry.size
DOSCODE:6CF6		     mov     ax, di
DOSCODE:6CF8		     rep movsb
DOSCODE:6CFA		     mov     di, ax
DOSCODE:6CFC		     cmp     byte ptr es:[di], 5
DOSCODE:6D00		     jnz     short NO05
DOSCODE:6D02		     mov     byte ptr es:[di], 0E5h
DOSCODE:6D06
DOSCODE:6D06 NO05:				     ; ...
DOSCODE:6D06		     and     ss:FastOpenFlg, 80h ; Fast_yes
DOSCODE:6D0C		     push    ss
DOSCODE:6D0D		     pop     ds
DOSCODE:6D0E		     clc
DOSCODE:6D0F		     call    LCritDisk
DOSCODE:6D12		     retn
DOSCODE:6D12 DOS_SEARCH_FIRST endp
DOSCODE:6D12
DOSCODE:6D13
DOSCODE:6D13 ; =============== S U B R O U T I N E =======================================
DOSCODE:6D13
DOSCODE:6D13
DOSCODE:6D13 DOS_SEARCH_NEXT proc near		     ; ...
DOSCODE:6D13		     les     di, ds:DMAADD
DOSCODE:6D17		     mov     al, es:[di]
DOSCODE:6D1A		     test    al, 80h
DOSCODE:6D1C		     jz	     short LOCAL_SEARCH_NEXT
DOSCODE:6D1E		     mov     ax, 111Ch
DOSCODE:6D21		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	FINDNEXT
DOSCODE:6D21					     ; SS = DS = DOS CS, [DTA] = 21-byte findfirst search data
DOSCODE:6D21					     ; Return: CF set on error,	AX = DOS error code
DOSCODE:6D21					     ; CF clear	if successful
DOSCODE:6D23		     retn
DOSCODE:6D24 ; ---------------------------------------------------------------------------
DOSCODE:6D24
DOSCODE:6D24 LOCAL_SEARCH_NEXT:			     ; ...
DOSCODE:6D24		     mov     ds:EXTERR_LOCUS, 2	; errLOC_Disk
DOSCODE:6D29		     call    ECritDisk
DOSCODE:6D2C		     mov     word ptr ds:THISCDS, offset DUMMYCDS
DOSCODE:6D32		     mov     word ptr ds:THISCDS+2, ds
DOSCODE:6D36		     add     al, 40h	     ; 'A'-1
DOSCODE:6D38		     call    InitCDS
DOSCODE:6D3B		     jb	     short No_files
DOSCODE:6D3D		     les     di, ds:THISCDS
DOSCODE:6D41		     les     bp, es:[di+45h] ; [ES:DI+curdir.devptr]
DOSCODE:6D45		     call    GOTDPB
DOSCODE:6D48		     mov     al, es:[bp+0]   ; [ES:BP+DPB.DRIVE]
DOSCODE:6D4C		     mov     ds:THISDRV, al
DOSCODE:6D4F		     mov     word ptr ds:CREATING, 0E500h ; (DIRFREE*256)+0
DOSCODE:6D55		     mov     ds:NoSetDir, 1
DOSCODE:6D5A		     lds     si, ds:DMAADD
DOSCODE:6D5E		     lodsb
DOSCODE:6D5F
DOSCODE:6D5F RENAME_NEXT:			     ; ...
DOSCODE:6D5F		     push    ss
DOSCODE:6D60		     pop     es
DOSCODE:6D61		     mov     di, offset	NAME1
DOSCODE:6D64		     mov     cx, 11
DOSCODE:6D67		     rep movsb
DOSCODE:6D69		     lodsb
DOSCODE:6D6A		     mov     ss:ATTRIB,	al
DOSCODE:6D6E		     lodsw
DOSCODE:6D6F		     or	     ax, ax
DOSCODE:6D71		     jns     short cont_load
DOSCODE:6D73
DOSCODE:6D73 No_files:				     ; ...
DOSCODE:6D73		     jmp     find_no_more
DOSCODE:6D76 ; ---------------------------------------------------------------------------
DOSCODE:6D76
DOSCODE:6D76 cont_load:				     ; ...
DOSCODE:6D76		     push    ax
DOSCODE:6D77		     lodsw
DOSCODE:6D78		     mov     bx, ax
DOSCODE:6D7A		     push    ss
DOSCODE:6D7B		     pop     ds
DOSCODE:6D7C		     les     bp, ds:THISDPB
DOSCODE:6D80		     call    SETDIRSRCH
DOSCODE:6D83		     jnb     short SEARCH_GOON
DOSCODE:6D85		     pop     ax
DOSCODE:6D86		     jmp     short No_files
DOSCODE:6D88 ; ---------------------------------------------------------------------------
DOSCODE:6D88
DOSCODE:6D88 SEARCH_GOON:			     ; ...
DOSCODE:6D88		     call    STARTSRCH
DOSCODE:6D8B		     pop     ax
DOSCODE:6D8C		     call    GETENT
DOSCODE:6D8F		     jb	     short No_files
DOSCODE:6D91		     call    NEXTENT
DOSCODE:6D94		     jb	     short No_files
DOSCODE:6D96		     xor     ah, ah
DOSCODE:6D98		     jmp     found_it
DOSCODE:6D98 DOS_SEARCH_NEXT endp
DOSCODE:6D98
DOSCODE:6D9B
DOSCODE:6D9B ; =============== S U B R O U T I N E =======================================
DOSCODE:6D9B
DOSCODE:6D9B
DOSCODE:6D9B CHECK_QUESTION  proc near		     ; ...
DOSCODE:6D9B		     push    ss
DOSCODE:6D9C		     pop     ds
DOSCODE:6D9D		     mov     si, ss:WFP_START
DOSCODE:6DA2
DOSCODE:6DA2 getnext:				     ; ...
DOSCODE:6DA2		     lodsb
DOSCODE:6DA3		     or	     al, al
DOSCODE:6DA5		     jz	     short NO_Question
DOSCODE:6DA7		     cmp     al, '?'
DOSCODE:6DA9		     jnz     short getnext
DOSCODE:6DAB		     stc
DOSCODE:6DAC
DOSCODE:6DAC NO_Question:			     ; ...
DOSCODE:6DAC		     retn
DOSCODE:6DAC CHECK_QUESTION  endp
DOSCODE:6DAC
DOSCODE:6DAD
DOSCODE:6DAD ; =============== S U B R O U T I N E =======================================
DOSCODE:6DAD
DOSCODE:6DAD
DOSCODE:6DAD DOS_ABORT	     proc near		     ; ...
DOSCODE:6DAD		     mov     es, ss:CurrentPDB
DOSCODE:6DB2		     mov     cx, es:32h	     ; [ES:PDB.JFN_Length]
DOSCODE:6DB7
DOSCODE:6DB7 reset_free_jfn:			     ; ...
DOSCODE:6DB7		     mov     bx, cx
DOSCODE:6DB9		     push    cx
DOSCODE:6DBA		     dec     bx
DOSCODE:6DBB		     call    $CLOSE
DOSCODE:6DBE		     pop     cx
DOSCODE:6DBF		     loop    reset_free_jfn
DOSCODE:6DC1		     push    ss
DOSCODE:6DC2		     pop     ds
DOSCODE:6DC3		     mov     ax, 111Dh	     ; Net_Abort, MultNET, 29
DOSCODE:6DC6		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	CLOSE ALL REMOTE FILES FOR PROCESS
DOSCODE:6DC6					     ; DS???, SS = DOS CS
DOSCODE:6DC8		     call    dword ptr ds:MFTCloseP ; call far [JShare+(4*4)]
DOSCODE:6DCC		     les     di, ss:SFTFCB
DOSCODE:6DD1		     mov     cx, es:[di+4]   ; [es:di+SFT.SFCount]
DOSCODE:6DD5		     jcxz    short FCBScanDone
DOSCODE:6DD7		     lea     di, [di+6]	     ; [DI+SFT.SFTable]
DOSCODE:6DDA		     mov     ax, ss:PROC_ID
DOSCODE:6DDE
DOSCODE:6DDE FCBTest:				     ; ...
DOSCODE:6DDE		     cmp     es:[di+31h], ax ; [es:di+SF_ENTRY.sf_PID]
DOSCODE:6DE2		     jnz     short FCBNext
DOSCODE:6DE4		     mov     word ptr es:[di], 0 ; [es:di+SF_ENTRY.sf_ref_count]
DOSCODE:6DE9
DOSCODE:6DE9 FCBNext:				     ; ...
DOSCODE:6DE9		     add     di, 3Bh ; ';'
DOSCODE:6DEC		     loop    FCBTest
DOSCODE:6DEE
DOSCODE:6DEE FCBScanDone:			     ; ...
DOSCODE:6DEE		     xor     bx, bx
DOSCODE:6DF0
DOSCODE:6DF0 Scan:				     ; ...
DOSCODE:6DF0		     push    bx
DOSCODE:6DF1		     call    SFFromSFN
DOSCODE:6DF4		     pop     bx
DOSCODE:6DF5		     jnb     short Scan1
DOSCODE:6DF7		     retn
DOSCODE:6DF8 ; ---------------------------------------------------------------------------
DOSCODE:6DF8
DOSCODE:6DF8 Scan1:				     ; ...
DOSCODE:6DF8		     cmp     word ptr es:[di], 0FFFFh ;	[es:di+SF_ENTRY.sf_ref_count],
DOSCODE:6DF8					     ; sf_busy
DOSCODE:6DFC		     jnz     short scan_next
DOSCODE:6DFE		     mov     ax, ss:PROC_ID
DOSCODE:6E02		     cmp     es:[di+31h], ax ; [es:di+SF_ENTRY.sf_PID]
DOSCODE:6E06		     jnz     short scan_next
DOSCODE:6E08		     mov     ax, ss:USER_ID
DOSCODE:6E0C		     cmp     es:[di+2Fh], ax ; [es:di+SF_ENTRY.sf_UID]
DOSCODE:6E10		     jnz     short scan_next
DOSCODE:6E12		     mov     word ptr es:[di], 0 ; [es:di+SF_ENTRY.sf_ref_count]
DOSCODE:6E17
DOSCODE:6E17 scan_next:				     ; ...
DOSCODE:6E17		     inc     bx
DOSCODE:6E18		     jmp     short Scan
DOSCODE:6E18 DOS_ABORT	     endp
DOSCODE:6E18
DOSCODE:6E1A
DOSCODE:6E1A ; =============== S U B R O U T I N E =======================================
DOSCODE:6E1A
DOSCODE:6E1A
DOSCODE:6E1A DOS_CLOSE	     proc near		     ; ...
DOSCODE:6E1A		     les     di, ds:THISSFT
DOSCODE:6E1E		     mov     bx, es:[di+5]   ; [ES:DI+SF_ENTRY.sf_flags]
DOSCODE:6E22		     test    bx, 8000h	     ; sf_isnet
DOSCODE:6E26		     jz	     short LocalClose
DOSCODE:6E28		     mov     ax, 1106h
DOSCODE:6E2B		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	CLOSE REMOTE FILE
DOSCODE:6E2B					     ; ES:DI ->	SFT
DOSCODE:6E2B					     ; SFT DPB field ->	DPB of drive containing	file
DOSCODE:6E2B					     ; Return: CF set on error,	AX = DOS error code
DOSCODE:6E2B					     ; CF clear	if successful
DOSCODE:6E2D		     retn
DOSCODE:6E2E ; ---------------------------------------------------------------------------
DOSCODE:6E2E
DOSCODE:6E2E LocalClose:			     ; ...
DOSCODE:6E2E		     call    ECritDisk
DOSCODE:6E31		     call    SetSFTTimes
DOSCODE:6E34		     call    FREE_SFT
DOSCODE:6E37		     push    ss
DOSCODE:6E38		     pop     ds
DOSCODE:6E39		     push    ax
DOSCODE:6E3A		     push    bx
DOSCODE:6E3B		     call    ShareEnd
DOSCODE:6E3E		     pop     bx
DOSCODE:6E3F		     pop     ax
DOSCODE:6E40
DOSCODE:6E40 CloseEntry:			     ; ...
DOSCODE:6E40		     push    ax
DOSCODE:6E41		     test    bx, 0C0h	     ; devid_file_clean+devid_device
DOSCODE:6E45		     jz	     short rdir
DOSCODE:6E47		     jmp     FREE_SFT_OK
DOSCODE:6E4A ; ---------------------------------------------------------------------------
DOSCODE:6E4A
DOSCODE:6E4A rdir:				     ; ...
DOSCODE:6E4A		     call    DirFromSFT
DOSCODE:6E4D		     mov     al, 5	     ; error_access_denied
DOSCODE:6E4F		     jnb     short clook
DOSCODE:6E51		     jmp     CloseFinish
DOSCODE:6E54 ; ---------------------------------------------------------------------------
DOSCODE:6E54
DOSCODE:6E54 clook:				     ; ...
DOSCODE:6E54		     push    di
DOSCODE:6E55		     push    si
DOSCODE:6E56		     lea     si, [si+20h]    ; [SI+SF_ENTRY.sf_name]
DOSCODE:6E59		     call    XCHGP
DOSCODE:6E5C		     call    MetaCompare
DOSCODE:6E5F		     call    XCHGP
DOSCODE:6E62		     pop     si
DOSCODE:6E63		     pop     di
DOSCODE:6E64		     jz	     short CLOSE_GO
DOSCODE:6E66		     mov     di, si
DOSCODE:6E68		     push    ds
DOSCODE:6E69		     pop     es
DOSCODE:6E6A		     push    ss
DOSCODE:6E6B		     pop     ds
DOSCODE:6E6C		     stc
DOSCODE:6E6D		     mov     al, 2
DOSCODE:6E6F		     jmp     CloseFinish
DOSCODE:6E72 ; ---------------------------------------------------------------------------
DOSCODE:6E72
DOSCODE:6E72 CLOSE_GO:				     ; ...
DOSCODE:6E72		     test    word ptr [si+2], 8000h ; [SI+SF_ENTRY.sf_mode],
DOSCODE:6E72					     ; sf_isFCB
DOSCODE:6E77		     jz	     short nofcb
DOSCODE:6E79		     mov     ch, es:[di+0Bh] ; [ES:DI+dir_entry.dir_attr]
DOSCODE:6E7D		     mov     al, [si+4]	     ; [SI+SF_ENTRY.sf_attr]
DOSCODE:6E80		     mov     ss:ATTRIB,	al
DOSCODE:6E84		     jmp     short setattr
DOSCODE:6E86 ; ---------------------------------------------------------------------------
DOSCODE:6E86
DOSCODE:6E86 nofcb:				     ; ...
DOSCODE:6E86		     mov     al, [si+4]	     ; [SI+SF_ENTRY.sf_attr]
DOSCODE:6E89		     mov     es:[di+0Bh], al ; [ES:DI+dir_entry.dir_attr]
DOSCODE:6E8D
DOSCODE:6E8D setattr:				     ; ...
DOSCODE:6E8D		     or	     byte ptr es:[di+0Bh], 20h ; [ES:DI+dir_entry.dir_attr],
DOSCODE:6E8D					     ; attr_archive
DOSCODE:6E92		     mov     ax, es:[di+1Ah] ; [ES:DI+dir_entry.dir_first]
DOSCODE:6E96		     mov     ss:OLD_FIRSTCLUS, ax
DOSCODE:6E9A		     mov     ax, [si+0Bh]    ; [SI+SF_ENTRY.sf_firclus]
DOSCODE:6E9D		     mov     es:[di+1Ah], ax ; [ES:DI+dir_entry.dir_first]
DOSCODE:6EA1		     mov     ax, [si+11h]    ; [SI+SF_ENTRY.sf_size]
DOSCODE:6EA4		     mov     es:[di+1Ch], ax ; [ES:DI+dir_entry.dir_size_l]
DOSCODE:6EA8		     mov     ax, [si+13h]    ; [SI+SF_ENTRY.sf_size+2]
DOSCODE:6EAB		     mov     es:[di+1Eh], ax ; [ES:DI+dir_entry.dir_size_h]
DOSCODE:6EAF		     mov     ax, [si+0Fh]    ; [SI+SF_ENTRY.sf_date]
DOSCODE:6EB2		     mov     es:[di+18h], ax ; [ES:DI+dir_entry.dir_date]
DOSCODE:6EB6		     mov     ax, [si+0Dh]    ; [SI+SF_ENTRY.sf_time]
DOSCODE:6EB9		     mov     es:[di+16h], ax ; [ES:DI+dir_entry.dir_time]
DOSCODE:6EBD		     test    byte ptr es:[bx+5], 40h ; [ES:BX+BUFFINFO.buf_flags],
DOSCODE:6EBD					     ; buf_dirty
DOSCODE:6EC2		     jnz     short yesdirty4
DOSCODE:6EC4		     call    INC_DIRTY_COUNT
DOSCODE:6EC7		     or	     byte ptr es:[bx+5], 40h ; [ES:BX+BUFFINFO.buf_flags],
DOSCODE:6EC7					     ; buf_dirty
DOSCODE:6ECC
DOSCODE:6ECC yesdirty4:				     ; ...
DOSCODE:6ECC		     push    ds
DOSCODE:6ECD		     push    si
DOSCODE:6ECE		     mov     cx, [si+0Bh]    ; [SF_ENTRY.sf_firclus]
DOSCODE:6ED1		     mov     al, ss:THISDRV
DOSCODE:6ED5		     push    dx
DOSCODE:6ED6		     mov     ah, 0
DOSCODE:6ED8		     mov     dl, al
DOSCODE:6EDA		     or	     cx, cx
DOSCODE:6EDC		     jnz     short do_update2
DOSCODE:6EDE		     mov     ah, 3
DOSCODE:6EE0		     mov     di, [si+1Bh]    ; [SI+SF_ENTRY.sf_dirsec]
DOSCODE:6EE3		     mov     cx, [si+1Dh]    ; [SI+SF_ENTRY.sf_dirsec+2]
DOSCODE:6EE6		     mov     dh, [si+1Fh]    ; [SI+SF_ENTRY.sf_dirpos]
DOSCODE:6EE9		     jmp     short do_update
DOSCODE:6EEB ; ---------------------------------------------------------------------------
DOSCODE:6EEB
DOSCODE:6EEB do_update2:			     ; ...
DOSCODE:6EEB		     cmp     cx, ss:OLD_FIRSTCLUS
DOSCODE:6EF0		     jz	     short do_update
DOSCODE:6EF2		     mov     ah, 2
DOSCODE:6EF4		     mov     cx, ss:OLD_FIRSTCLUS
DOSCODE:6EF9
DOSCODE:6EF9 do_update:				     ; ...
DOSCODE:6EF9		     push    ss
DOSCODE:6EFA		     pop     ds
DOSCODE:6EFB		     call    FastOpen_Update
DOSCODE:6EFE		     pop     dx
DOSCODE:6EFF		     call    FLUSHBUF
DOSCODE:6F02		     pop     di
DOSCODE:6F03		     pop     es
DOSCODE:6F04		     mov     al, 5	     ; error_access_denied
DOSCODE:6F06		     jb	     short CloseFinish
DOSCODE:6F08
DOSCODE:6F08 FREE_SFT_OK:			     ; ...
DOSCODE:6F08		     clc
DOSCODE:6F09
DOSCODE:6F09 CloseFinish:			     ; ...
DOSCODE:6F09		     pushf
DOSCODE:6F0A		     call    DEV_CLOSE_SFT
DOSCODE:6F0D		     popf
DOSCODE:6F0E		     pop     cx
DOSCODE:6F0F		     pushf
DOSCODE:6F10		     dec     cx
DOSCODE:6F11		     jnz     short NoFree
DOSCODE:6F13		     mov     es:[di], cx     ; [ES:DI+SF_ENTRY.sf_ref_Count]
DOSCODE:6F16
DOSCODE:6F16 NoFree:				     ; ...
DOSCODE:6F16		     call    LCritDisk
DOSCODE:6F19		     popf
DOSCODE:6F1A		     retn
DOSCODE:6F1A DOS_CLOSE	     endp
DOSCODE:6F1A
DOSCODE:6F1B
DOSCODE:6F1B ; =============== S U B R O U T I N E =======================================
DOSCODE:6F1B
DOSCODE:6F1B
DOSCODE:6F1B FREE_SFT	     proc near		     ; ...
DOSCODE:6F1B		     pushf
DOSCODE:6F1C		     mov     ax, es:[di]     ; [ES:DI+SF_ENTRY.sf_ref_count]
DOSCODE:6F1F		     dec     ax
DOSCODE:6F20		     jnz     short SetCount
DOSCODE:6F22		     dec     ax
DOSCODE:6F23
DOSCODE:6F23 SetCount:				     ; ...
DOSCODE:6F23		     xchg    ax, es:[di]     ; [ES:DI+SF_ENTRY.sf_ref_count]
DOSCODE:6F26		     popf
DOSCODE:6F27		     retn
DOSCODE:6F27 FREE_SFT	     endp
DOSCODE:6F27
DOSCODE:6F28
DOSCODE:6F28 ; =============== S U B R O U T I N E =======================================
DOSCODE:6F28
DOSCODE:6F28
DOSCODE:6F28 DirFromSFT	     proc near		     ; ...
DOSCODE:6F28		     mov     ds:EXTERR_LOCUS, 2	; errLOC_Disk
DOSCODE:6F2D		     push    es
DOSCODE:6F2E		     push    di
DOSCODE:6F2F		     mov     dx, es:[di+1Dh] ; [ES:DI+SF_ENTRY.sf_dirsec+2]
DOSCODE:6F33		     mov     ds:HIGH_SECTOR, dx
DOSCODE:6F37		     mov     dx, es:[di+1Bh] ; [ES:DI+SF_ENTRY.sf_dirsec]
DOSCODE:6F3B		     push    ds:HIGH_SECTOR
DOSCODE:6F3F		     push    dx
DOSCODE:6F40		     call    FATREAD_SFT
DOSCODE:6F43		     pop     dx
DOSCODE:6F44		     pop     ds:HIGH_SECTOR
DOSCODE:6F48		     jb	     short PopDone
DOSCODE:6F4A		     xor     al, al
DOSCODE:6F4C		     mov     ds:ALLOWED, 18h ; Allowed_FAIL+Allowed_RETRY
DOSCODE:6F51		     call    GETBUFFR
DOSCODE:6F54		     jb	     short PopDone
DOSCODE:6F56		     pop     si
DOSCODE:6F57		     pop     ds
DOSCODE:6F58		     les     di, ss:5E2h
DOSCODE:6F5D		     or	     byte ptr es:[di+5], 4
DOSCODE:6F62		     mov     bx, di
DOSCODE:6F64		     lea     di, [di+14h]
DOSCODE:6F67		     mov     al, 20h ; ' '
DOSCODE:6F69		     mul     byte ptr [si+1Fh]
DOSCODE:6F6C		     add     di, ax
DOSCODE:6F6E		     retn
DOSCODE:6F6F ; ---------------------------------------------------------------------------
DOSCODE:6F6F
DOSCODE:6F6F PopDone:				     ; ...
DOSCODE:6F6F		     pop     di
DOSCODE:6F70		     pop     es
DOSCODE:6F71
DOSCODE:6F71 PopDone_retn:			     ; ...
DOSCODE:6F71		     retn
DOSCODE:6F71 DirFromSFT	     endp
DOSCODE:6F71
DOSCODE:6F72
DOSCODE:6F72 ; =============== S U B R O U T I N E =======================================
DOSCODE:6F72
DOSCODE:6F72
DOSCODE:6F72 DOS_COMMIT	     proc near		     ; ...
DOSCODE:6F72		     les     di, ds:THISSFT
DOSCODE:6F76		     mov     bx, es:[di+5]   ; [ES:DI+SF_ENTRY.sf_flags]
DOSCODE:6F7A		     test    bx, 0C0h	     ; devid_file_clean+devid_device
DOSCODE:6F7E		     jnz     short PopDone_retn
DOSCODE:6F80		     test    bx, 8000h	     ; sf_isnet
DOSCODE:6F84		     jz	     short LOCAL_COMMIT
DOSCODE:6F86		     mov     ax, 1107h
DOSCODE:6F89		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	COMMIT REMOTE FILE
DOSCODE:6F89					     ; ES:DI ->	SFT
DOSCODE:6F89					     ; SFT DPB field ->	DPB of drive containing	file
DOSCODE:6F89					     ; Return: CF set on error,	AX = DOS error code
DOSCODE:6F89					     ; CF clear	if successful
DOSCODE:6F8B		     retn
DOSCODE:6F8C ; ---------------------------------------------------------------------------
DOSCODE:6F8C
DOSCODE:6F8C LOCAL_COMMIT:			     ; ...
DOSCODE:6F8C		     call    ECritDisk
DOSCODE:6F8F		     call    ECritDisk
DOSCODE:6F92		     call    SetSFTTimes
DOSCODE:6F95		     mov     ax, -1
DOSCODE:6F98		     call    CloseEntry
DOSCODE:6F9B		     pushf
DOSCODE:6F9C		     call    DEV_OPEN_SFT
DOSCODE:6F9F		     popf
DOSCODE:6FA0		     call    LCritDisk
DOSCODE:6FA3
DOSCODE:6FA3 localcommit_retn:			     ; ...
DOSCODE:6FA3		     retn
DOSCODE:6FA3 DOS_COMMIT	     endp
DOSCODE:6FA3
DOSCODE:6FA4
DOSCODE:6FA4 ; =============== S U B R O U T I N E =======================================
DOSCODE:6FA4
DOSCODE:6FA4
DOSCODE:6FA4 SetSFTTimes     proc near		     ; ...
DOSCODE:6FA4		     test    bx, 0C0h	     ; devid_file_clean+devid_device
DOSCODE:6FA8		     jnz     short localcommit_retn
DOSCODE:6FAA		     test    bx, 4000h	     ; sf_close_nodate
DOSCODE:6FAE		     jnz     short localcommit_retn
DOSCODE:6FB0		     push    ax
DOSCODE:6FB1		     push    bx
DOSCODE:6FB2		     call    DATE16
DOSCODE:6FB5		     mov     es:[di+0Fh], ax ; [ES:DI+SF_ENTRY.sf_date]
DOSCODE:6FB9		     mov     es:[di+0Dh], dx ; [ES:DI+SF_ENTRY.sf_time]
DOSCODE:6FBD		     xor     ax, ax
DOSCODE:6FBF		     call    dword ptr ds:ShSU ; call far [JShare+(14*4)]
DOSCODE:6FC3		     pop     bx
DOSCODE:6FC4		     pop     ax
DOSCODE:6FC5		     retn
DOSCODE:6FC5 SetSFTTimes     endp
DOSCODE:6FC5
DOSCODE:6FC6 ; ---------------------------------------------------------------------------
DOSCODE:6FC6
DOSCODE:6FC6 DOS_MKDIR:				     ; ...
DOSCODE:6FC6		     call    TestNet
DOSCODE:6FC9		     jnb     short LOCAL_MKDIR
DOSCODE:6FCB		     mov     ax, 1103h
DOSCODE:6FCE		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	MAKE REMOTE DIRECTORY
DOSCODE:6FCE					     ; SS = DOS	CS
DOSCODE:6FCE					     ; SDA first filename pointer -> fully-qualified directory name
DOSCODE:6FCE					     ; SDA CDS pointer -> current directory
DOSCODE:6FCE					     ; Return: CF set on error,	AX = DOS error code
DOSCODE:6FCE					     ; CF clear	if successful
DOSCODE:6FD0		     retn
DOSCODE:6FD1 ; ---------------------------------------------------------------------------
DOSCODE:6FD1 ; START OF	FUNCTION CHUNK FOR DOS_CHDIR
DOSCODE:6FD1
DOSCODE:6FD1 NODEACCERRJ:			     ; ...
DOSCODE:6FD1		     mov     ax, 5	     ; error_access_denied
DOSCODE:6FD4
DOSCODE:6FD4 _BadRet:				     ; ...
DOSCODE:6FD4		     stc
DOSCODE:6FD5		     call    LCritDisk
DOSCODE:6FD8		     retn
DOSCODE:6FD8 ; END OF FUNCTION CHUNK FOR DOS_CHDIR
DOSCODE:6FD9 ; ---------------------------------------------------------------------------
DOSCODE:6FD9
DOSCODE:6FD9 PATHNFJ:				     ; ...
DOSCODE:6FD9		     call    LCritDisk
DOSCODE:6FDC		     jmp     SET_MKND_ERR
DOSCODE:6FDF ; ---------------------------------------------------------------------------
DOSCODE:6FDF
DOSCODE:6FDF LOCAL_MKDIR:			     ; ...
DOSCODE:6FDF		     call    ECritDisk
DOSCODE:6FE2		     mov     word ptr ds:THISSFT+2, ss
DOSCODE:6FE6		     mov     word ptr ds:THISSFT, offset RENBUF
DOSCODE:6FEC		     mov     word ptr ds:RENBUF+33h, 0 ; [RENBUF+SF_ENTRY.sf_MFT]
DOSCODE:6FF2		     mov     al, 10h	     ; attr_directory
DOSCODE:6FF4		     call    MakeNode
DOSCODE:6FF7		     jb	     short PATHNFJ
DOSCODE:6FF9		     cmp     ax, 3
DOSCODE:6FFC		     jz	     short NODEACCERRJ
DOSCODE:6FFE		     les     bp, ds:THISDPB
DOSCODE:7002		     lds     di, ds:CURBUF
DOSCODE:7006		     sub     si, di
DOSCODE:7008		     push    si
DOSCODE:7009		     push    word ptr [di+8] ; [DI+BUFFINFO.buf_sector+2]
DOSCODE:700C		     push    word ptr [di+6] ; [DI+BUFFINFO.buf_sector]
DOSCODE:700F		     push    ss
DOSCODE:7010		     pop     ds
DOSCODE:7011		     push    ds:DIRSTART
DOSCODE:7015		     xor     ax, ax
DOSCODE:7017		     mov     ds:DIRSTART, ax
DOSCODE:701A		     call    NEWDIR
DOSCODE:701D		     jb	     short NODEEXISTSPOPDEL
DOSCODE:701F		     call    GETENT
DOSCODE:7022		     jb	     short NODEEXISTSPOPDEL
DOSCODE:7024		     les     di, ds:CURBUF
DOSCODE:7028		     test    byte ptr es:[di+5], 40h ; [ES:DI+BUFFINFO.buf_flags],
DOSCODE:7028					     ; buf_dirty
DOSCODE:702D		     jnz     short yesdirty5
DOSCODE:702F		     call    INC_DIRTY_COUNT
DOSCODE:7032		     or	     byte ptr es:[di+5], 40h ; [ES:DI+BUFFINFO.buf_flags],buf_dirty
DOSCODE:7037
DOSCODE:7037 yesdirty5:				     ; ...
DOSCODE:7037		     add     di, 20	     ; BUFINSIZ
DOSCODE:703A		     mov     ax, 202Eh	     ; ". "
DOSCODE:703D		     mov     dx, ds:DIRSTART
DOSCODE:7041		     call    SETDOTENT
DOSCODE:7044		     mov     ax, 2E2Eh	     ; ".."
DOSCODE:7047		     pop     dx
DOSCODE:7048		     call    SETDOTENT
DOSCODE:704B		     les     bp, ds:THISDPB
DOSCODE:704F		     mov     ds:ALLOWED, 18h ; Allowed_FAIL+Allowed_RETRY
DOSCODE:7054		     pop     dx
DOSCODE:7055		     pop     ds:HIGH_SECTOR
DOSCODE:7059		     xor     al, al
DOSCODE:705B		     call    GETBUFFR
DOSCODE:705E		     jb	     short NODEEXISTSP
DOSCODE:7060		     mov     dx, ds:5C2h
DOSCODE:7064		     lds     di, ds:5E2h
DOSCODE:7068		     or	     byte ptr [di+5], 4
DOSCODE:706C		     pop     si
DOSCODE:706D		     add     si, di
DOSCODE:706F		     mov     [si], dx
DOSCODE:7071		     xor     dx, dx
DOSCODE:7073		     mov     [si+2], dx
DOSCODE:7076		     mov     [si+4], dx
DOSCODE:7079
DOSCODE:7079 ; =============== S U B R O U T I N E =======================================
DOSCODE:7079
DOSCODE:7079
DOSCODE:7079 DIRUP	     proc near		     ; ...
DOSCODE:7079		     test    byte ptr [di+5], 40h ; [DI+BUFFINFO.buf_flags],buf_dirty
DOSCODE:707D		     jnz     short yesdirty6
DOSCODE:707F		     call    INC_DIRTY_COUNT
DOSCODE:7082		     or	     byte ptr [di+5], 40h ; [DI+BUFFINFO.buf_flags],buf_dirty
DOSCODE:7086
DOSCODE:7086 yesdirty6:				     ; ...
DOSCODE:7086		     push    ss
DOSCODE:7087		     pop     ds
DOSCODE:7088		     mov     al, es:[bp+0]
DOSCODE:708C		     call    FLUSHBUF
DOSCODE:708F		     mov     ax, 5
DOSCODE:7092		     call    LCritDisk
DOSCODE:7095		     retn
DOSCODE:7095 DIRUP	     endp
DOSCODE:7095
DOSCODE:7096 ; ---------------------------------------------------------------------------
DOSCODE:7096
DOSCODE:7096 NODEEXISTSPOPDEL:			     ; ...
DOSCODE:7096		     pop     dx
DOSCODE:7097		     pop     dx
DOSCODE:7098		     pop     ds:HIGH_SECTOR
DOSCODE:709C		     les     bp, ds:THISDPB
DOSCODE:70A0		     mov     ds:ALLOWED, 18h ; Allowed_FAIL+Allowed_RETRY
DOSCODE:70A5		     xor     al, al
DOSCODE:70A7		     call    GETBUFFR
DOSCODE:70AA		     jb	     short NODEEXISTSP
DOSCODE:70AC		     lds     di, ds:5E2h
DOSCODE:70B0		     or	     byte ptr [di+5], 4
DOSCODE:70B4		     pop     si
DOSCODE:70B5		     add     si, di
DOSCODE:70B7		     sub     si, 1Ah
DOSCODE:70BA		     mov     byte ptr [si], 0E5h ; 'å'
DOSCODE:70BD		     call    DIRUP
DOSCODE:70C0
DOSCODE:70C0 NODEEXISTS:			     ; ...
DOSCODE:70C0		     jmp     NODEACCERRJ
DOSCODE:70C3 ; ---------------------------------------------------------------------------
DOSCODE:70C3
DOSCODE:70C3 NODEEXISTSP:			     ; ...
DOSCODE:70C3		     pop     si
DOSCODE:70C4		     jmp     short NODEEXISTS
DOSCODE:70C6
DOSCODE:70C6 ; =============== S U B R O U T I N E =======================================
DOSCODE:70C6
DOSCODE:70C6
DOSCODE:70C6 DOS_CHDIR	     proc near		     ; ...
DOSCODE:70C6
DOSCODE:70C6 arg_7E	     = byte ptr	 80h
DOSCODE:70C6
DOSCODE:70C6 ; FUNCTION	CHUNK AT DOSCODE:6FD1 SIZE 00000008 BYTES
DOSCODE:70C6 ; FUNCTION	CHUNK AT DOSCODE:713D SIZE 00000003 BYTES
DOSCODE:70C6
DOSCODE:70C6		     call    TestNet
DOSCODE:70C9		     jnb     short LOCAL_CHDIR
DOSCODE:70CB		     mov     ax, 1105h
DOSCODE:70CE		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	CHDIR
DOSCODE:70CE					     ; SS = DOS	CS
DOSCODE:70CE					     ; SDA first filename pointer -> fully-qualified directory name
DOSCODE:70CE					     ; SDA CDS pointer -> current directory
DOSCODE:70CE					     ; Return: CF set on error,	AX = DOS error code
DOSCODE:70CE					     ; CF clear	if successful
DOSCODE:70D0		     retn
DOSCODE:70D1 ; ---------------------------------------------------------------------------
DOSCODE:70D1
DOSCODE:70D1 LOCAL_CHDIR:			     ; ...
DOSCODE:70D1		     call    ECritDisk
DOSCODE:70D4		     test    word ptr es:[di+43h], 2000h ; [ES:DI+curdir.flags],curdir_splice
DOSCODE:70DA		     jz	     short nojoin
DOSCODE:70DC		     mov     word ptr es:[di+49h], 0FFFFh ; [ES:DI+curdir.ID]
DOSCODE:70E2
DOSCODE:70E2 nojoin:				     ; ...
DOSCODE:70E2		     mov     ds:NoSetDir, 0
DOSCODE:70E7		     mov     ds:SATTRIB, 16h ; attr_directory+attr_system+attr_hidden
DOSCODE:70EC		     or	     ds:FastOpenFlg, 1 ; FastOpen_Set
DOSCODE:70F1		     call    GETPATH
DOSCODE:70F4		     pushf
DOSCODE:70F5		     and     ds:FastOpenFlg, 80h ; Fast_yes
DOSCODE:70FA		     popf
DOSCODE:70FB		     mov     ax, 3	     ; error_path_not_found
DOSCODE:70FE		     jb	     short ChDirDone
DOSCODE:7100		     jnz     short NOTDIRPATH
DOSCODE:7102		     mov     cx, ds:DIRSTART
DOSCODE:7106		     clc
DOSCODE:7107
DOSCODE:7107 ChDirDone:				     ; ...
DOSCODE:7107		     call    LCritDisk
DOSCODE:710A		     retn
DOSCODE:710A DOS_CHDIR	     endp
DOSCODE:710A
DOSCODE:710B ; ---------------------------------------------------------------------------
DOSCODE:710B
DOSCODE:710B DOS_RMDIR:				     ; ...
DOSCODE:710B		     call    TestNet
DOSCODE:710E		     jnb     short LOCAL_RMDIR
DOSCODE:7110		     mov     ax, 1101h
DOSCODE:7113		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	REMOVE REMOTE DIRECTORY
DOSCODE:7113					     ; SS = DOS	CS
DOSCODE:7113					     ; SDA first filename pointer -> fully-qualified directory name
DOSCODE:7113					     ; SDA CDS pointer -> current directory
DOSCODE:7113					     ; Return: CF set on error,	AX = DOS error code
DOSCODE:7113					     ; CF clear	if successful
DOSCODE:7115		     retn
DOSCODE:7116 ; ---------------------------------------------------------------------------
DOSCODE:7116
DOSCODE:7116 LOCAL_RMDIR:			     ; ...
DOSCODE:7116		     call    ECritDisk
DOSCODE:7119		     mov     ds:NoSetDir, 0
DOSCODE:711E		     mov     ds:SATTRIB, 16h ; attr_directory+attr_system+attr_hidden
DOSCODE:7123		     call    GETPATH
DOSCODE:7126		     jb	     short NOPATH
DOSCODE:7128		     jnz     short NOTDIRPATH
DOSCODE:712A		     mov     di, ds:DIRSTART
DOSCODE:712E		     or	     di, di
DOSCODE:7130		     jnz     short rmdir_get_buf
DOSCODE:7132		     jmp     short NOTDIRPATH
DOSCODE:7134 ; ---------------------------------------------------------------------------
DOSCODE:7134
DOSCODE:7134 NOPATH:				     ; ...
DOSCODE:7134		     mov     ax, 3	     ; error_path_not_found
DOSCODE:7137		     jmp     _BadRet
DOSCODE:713A ; ---------------------------------------------------------------------------
DOSCODE:713A
DOSCODE:713A NOTDIRPATHPOP:			     ; ...
DOSCODE:713A		     pop     ax
DOSCODE:713B		     pop     ax
DOSCODE:713C
DOSCODE:713C NOTDIRPATHPOP2:			     ; ...
DOSCODE:713C		     pop     ax
DOSCODE:713D ; START OF	FUNCTION CHUNK FOR DOS_CHDIR
DOSCODE:713D
DOSCODE:713D NOTDIRPATH:			     ; ...
DOSCODE:713D		     jmp     NODEACCERRJ
DOSCODE:713D ; END OF FUNCTION CHUNK FOR DOS_CHDIR
DOSCODE:7140 ; ---------------------------------------------------------------------------
DOSCODE:7140
DOSCODE:7140 rmdir_get_buf:			     ; ...
DOSCODE:7140		     lds     di, ds:CURBUF
DOSCODE:7144		     sub     bx, di
DOSCODE:7146		     push    bx
DOSCODE:7147		     push    word ptr [di+8] ; [DI+BUFFINFO.buf_sector+2]
DOSCODE:714A		     push    word ptr [di+6] ; [DI+BUFFINFO.buf_sector]
DOSCODE:714D		     push    ss
DOSCODE:714E		     pop     ds
DOSCODE:714F		     push    ss
DOSCODE:7150		     pop     es
DOSCODE:7151		     mov     di, offset	NAME1
DOSCODE:7154		     mov     al, '?'
DOSCODE:7156		     mov     cx, 11
DOSCODE:7159		     rep stosb
DOSCODE:715B		     xor     al, al
DOSCODE:715D		     stosb
DOSCODE:715E		     call    STARTSRCH
DOSCODE:7161		     call    GETENTRY
DOSCODE:7164		     jb	     short NOTDIRPATHPOP
DOSCODE:7166		     mov     ds, word ptr ds:CURBUF+2
DOSCODE:716A		     mov     si, bx
DOSCODE:716C		     lodsw
DOSCODE:716D		     cmp     ax, 202Eh	     ; (' ' SHL 8) OR '.'
DOSCODE:7170		     jnz     short NOTDIRPATHPOP
DOSCODE:7172		     add     si, 30	     ; dir_entry.size-2
DOSCODE:7175		     lodsw
DOSCODE:7176		     cmp     ax, 2E2Eh	     ; ('.' SHL 8) OR '.'
DOSCODE:7179		     jnz     short NOTDIRPATHPOP
DOSCODE:717B		     push    ss
DOSCODE:717C		     pop     ds
DOSCODE:717D		     mov     ds:LASTENT, 2
DOSCODE:7183		     call    GETENTRY
DOSCODE:7186		     jb	     short NOTDIRPATHPOP
DOSCODE:7188		     mov     ds:ATTRIB,	16h  ; attr_directory+attr_hidden+attr_system
DOSCODE:718D		     call    SRCH
DOSCODE:7190		     jnb     short NOTDIRPATHPOP
DOSCODE:7192		     cmp     ds:FAILERR, 0
DOSCODE:7197		     jnz     short NOTDIRPATHPOP
DOSCODE:7199		     les     bp, ds:THISDPB
DOSCODE:719D		     mov     bx, ds:DIRSTART
DOSCODE:71A1		     call    RELEASE
DOSCODE:71A4		     jb	     short NOTDIRPATHPOP
DOSCODE:71A6		     pop     dx
DOSCODE:71A7		     pop     ds:HIGH_SECTOR
DOSCODE:71AB		     mov     ds:ALLOWED, 18h ; Allowed_FAIL+Allowed_RETRY
DOSCODE:71B0		     xor     al, al
DOSCODE:71B2		     call    GETBUFFR
DOSCODE:71B5		     jb	     short NOTDIRPATHPOP2
DOSCODE:71B7		     lds     di, ds:5E2h
DOSCODE:71BB		     or	     byte ptr [di+5], 4
DOSCODE:71BF		     pop     bx
DOSCODE:71C0		     add     bx, di
DOSCODE:71C2		     mov     byte ptr [bx], 0E5h ; 'å'
DOSCODE:71C5		     push    ds
DOSCODE:71C6		     push    ss
DOSCODE:71C7		     pop     ds
DOSCODE:71C8		     call    FastOpen_Delete
DOSCODE:71CB		     pop     ds
DOSCODE:71CC		     jmp     DIRUP
DOSCODE:71CF
DOSCODE:71CF ; =============== S U B R O U T I N E =======================================
DOSCODE:71CF
DOSCODE:71CF
DOSCODE:71CF SWAPBACK	     proc near		     ; ...
DOSCODE:71CF		     mov     ds:CONSWAP, 0
DOSCODE:71D4		     retn
DOSCODE:71D4 SWAPBACK	     endp
DOSCODE:71D4
DOSCODE:71D5
DOSCODE:71D5 ; =============== S U B R O U T I N E =======================================
DOSCODE:71D5
DOSCODE:71D5
DOSCODE:71D5 SWAPCON	     proc near		     ; ...
DOSCODE:71D5		     mov     ds:CONSWAP, 1
DOSCODE:71DA		     push    ax
DOSCODE:71DB		     mov     ax, word ptr ds:THISSFT
DOSCODE:71DE		     mov     word ptr ds:CONSFT, ax
DOSCODE:71E1		     mov     ax, word ptr ds:THISSFT+2
DOSCODE:71E4		     mov     word ptr ds:CONSFT+2, ax
DOSCODE:71E7		     pop     ax
DOSCODE:71E8		     retn
DOSCODE:71E8 SWAPCON	     endp
DOSCODE:71E8
DOSCODE:71E9
DOSCODE:71E9 ; =============== S U B R O U T I N E =======================================
DOSCODE:71E9
DOSCODE:71E9
DOSCODE:71E9 DOS_READ	     proc near		     ; ...
DOSCODE:71E9		     les     di, ds:THISSFT
DOSCODE:71ED		     mov     al, es:[di+2]   ; [ES:DI+SF_ENTRY.sf_mode]
DOSCODE:71F1		     and     al, 0Fh	     ; access_mask
DOSCODE:71F3		     cmp     al, 1
DOSCODE:71F5		     jnz     short READ_NO_MODE
DOSCODE:71F7		     jmp     SET_ACC_ERR
DOSCODE:71FA ; ---------------------------------------------------------------------------
DOSCODE:71FA
DOSCODE:71FA READ_NO_MODE:			     ; ...
DOSCODE:71FA		     call    SETUP
DOSCODE:71FD		     jcxz    short NoIORet
DOSCODE:71FF		     call    IsSFTNet
DOSCODE:7202		     jz	     short LOCAL_READ
DOSCODE:7204		     mov     ax, 1108h	     ; (MultNET<<8)|8
DOSCODE:7207		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	READ FROM REMOTE FILE
DOSCODE:7207					     ; ES:DI ->	SFT
DOSCODE:7207					     ; SFT DPB field ->	DPB of drive containing	file
DOSCODE:7207					     ; CX = number of bytes, SS	= DOS CS, SDA DTA field	-> user	buffer
DOSCODE:7207					     ; Return: CF set on error,	CX = bytes read
DOSCODE:7209		     retn
DOSCODE:720A ; ---------------------------------------------------------------------------
DOSCODE:720A
DOSCODE:720A NoIORet:				     ; ...
DOSCODE:720A		     clc
DOSCODE:720B		     retn
DOSCODE:720C ; ---------------------------------------------------------------------------
DOSCODE:720C
DOSCODE:720C LOCAL_READ:			     ; ...
DOSCODE:720C		     test    byte ptr es:[di+5], 80h ; [ES:DI+SF_ENTRY.sf_flags],devid_device
DOSCODE:7211		     jnz     short READDEV
DOSCODE:7213		     mov     ds:EXTERR_LOCUS, 2	; errLOC_Disk
DOSCODE:7218		     call    ECritDisk
DOSCODE:721B		     call    DISKREAD
DOSCODE:721E		     call    LCritDisk
DOSCODE:7221		     retn
DOSCODE:7222 ; ---------------------------------------------------------------------------
DOSCODE:7222
DOSCODE:7222 READDEV:				     ; ...
DOSCODE:7222		     mov     ds:EXTERR_LOCUS, 4	; errLOC_SerDev
DOSCODE:7227		     mov     bl, es:[di+5]   ; [ES:DI+SF_ENTRY.sf_flags]
DOSCODE:722B		     les     di, ds:DMAADD
DOSCODE:722F		     test    bl, 40h	     ; devid_device_EOF
DOSCODE:7232		     jz	     short ENDRDDEVJ3
DOSCODE:7234		     test    bl, 4	     ; devid_device_null
DOSCODE:7237		     jz	     short TESTRAW
DOSCODE:7239		     xor     al, al
DOSCODE:723B
DOSCODE:723B ENDRDDEVJ3:			     ; ...
DOSCODE:723B		     jmp     ENDRDDEVJ2
DOSCODE:723E ; ---------------------------------------------------------------------------
DOSCODE:723E
DOSCODE:723E TESTRAW:				     ; ...
DOSCODE:723E		     test    bl, 20h	     ; devid_device_raw
DOSCODE:7241		     jnz     short DVRDRAW
DOSCODE:7243		     test    bl, 1
DOSCODE:7246		     jz	     short NOTRDCON
DOSCODE:7248		     jmp     READCON
DOSCODE:724B ; ---------------------------------------------------------------------------
DOSCODE:724B
DOSCODE:724B DVRDRAW:				     ; ...
DOSCODE:724B		     push    es
DOSCODE:724C		     pop     ds
DOSCODE:724D		     test    ss:IsWin386, 1
DOSCODE:7253		     jz	     short ReadRawRetry
DOSCODE:7255		     test    bl, 1	     ; devid_device_con_in
DOSCODE:7258		     jz	     short ReadRawRetry
DOSCODE:725A		     jmp     do_polling
DOSCODE:725D ; ---------------------------------------------------------------------------
DOSCODE:725D
DOSCODE:725D ReadRawRetry:			     ; ...
DOSCODE:725D		     mov     bx, di
DOSCODE:725F		     xor     ax, ax
DOSCODE:7261		     mov     dx, ax
DOSCODE:7263		     call    SETREAD
DOSCODE:7266		     push    ds
DOSCODE:7267		     lds     si, ss:THISSFT
DOSCODE:726C		     call    DEVIOCALL
DOSCODE:726F		     mov     dx, di
DOSCODE:7271		     mov     ah, 86h
DOSCODE:7273		     mov     di, ss:DEVCALL_REQSTAT
DOSCODE:7278		     or	     di, di
DOSCODE:727A		     jns     short CRDROK
DOSCODE:727C		     call    CHARHARD
DOSCODE:727F		     mov     di, dx
DOSCODE:7281		     add     di, ss:CALLSCNT
DOSCODE:7286		     sub     cx, ss:CALLSCNT
DOSCODE:728B		     or	     al, al
DOSCODE:728D		     jz	     short CRDROK
DOSCODE:728F		     cmp     al, 3
DOSCODE:7291		     jz	     short CRDFERR
DOSCODE:7293		     pop     ds
DOSCODE:7294		     jmp     short ReadRawRetry
DOSCODE:7296 ; ---------------------------------------------------------------------------
DOSCODE:7296
DOSCODE:7296 CRDFERR:				     ; ...
DOSCODE:7296		     pop     di
DOSCODE:7297
DOSCODE:7297 DEVIOFERR:				     ; ...
DOSCODE:7297		     les     di, ss:THISSFT
DOSCODE:729C		     jmp     SET_ACC_ERR_DS
DOSCODE:729F ; ---------------------------------------------------------------------------
DOSCODE:729F
DOSCODE:729F CRDROK:				     ; ...
DOSCODE:729F		     pop     di
DOSCODE:72A0		     mov     di, dx
DOSCODE:72A2		     add     di, ss:CALLSCNT
DOSCODE:72A7		     jmp     short ENDRDDEVJ3
DOSCODE:72A9 ; ---------------------------------------------------------------------------
DOSCODE:72A9
DOSCODE:72A9 NOTRDCON:				     ; ...
DOSCODE:72A9		     mov     ax, es
DOSCODE:72AB		     mov     ds, ax
DOSCODE:72AD		     mov     bx, di
DOSCODE:72AF		     xor     dx, dx
DOSCODE:72B1		     mov     ax, dx
DOSCODE:72B3		     push    cx
DOSCODE:72B4		     mov     cx, 1
DOSCODE:72B7		     call    SETREAD
DOSCODE:72BA		     pop     cx
DOSCODE:72BB		     lds     si, ss:THISSFT
DOSCODE:72C0		     lds     si, [si+7]	     ; [SI+SF_ENTRY.sf_devptr]
DOSCODE:72C3
DOSCODE:72C3 DVRDLP:				     ; ...
DOSCODE:72C3		     call    DSKSTATCHK
DOSCODE:72C6		     call    DEVIOCALL2
DOSCODE:72C9		     push    di
DOSCODE:72CA		     mov     ah, 86h
DOSCODE:72CC		     mov     di, ss:DEVCALL_REQSTAT
DOSCODE:72D1		     or	     di, di
DOSCODE:72D3		     jns     short CRDOK
DOSCODE:72D5		     call    CHARHARD
DOSCODE:72D8		     pop     di
DOSCODE:72D9		     mov     ss:CALLSCNT, 1
DOSCODE:72E0		     cmp     al, 1
DOSCODE:72E2		     jz	     short DVRDLP
DOSCODE:72E4		     cmp     al, 3
DOSCODE:72E6		     jz	     short DEVIOFERR
DOSCODE:72E8		     xor     al, al
DOSCODE:72EA		     jmp     short DVRDIGN
DOSCODE:72EC ; ---------------------------------------------------------------------------
DOSCODE:72EC
DOSCODE:72EC CRDOK:				     ; ...
DOSCODE:72EC		     pop     di
DOSCODE:72ED		     cmp     ss:CALLSCNT, 1
DOSCODE:72F3		     jnz     short ENDRDDEVJ2
DOSCODE:72F5		     push    ds
DOSCODE:72F6		     mov     ds, word ptr ss:CALLXADD+2
DOSCODE:72FB		     mov     al, [di]
DOSCODE:72FD		     pop     ds
DOSCODE:72FE
DOSCODE:72FE DVRDIGN:				     ; ...
DOSCODE:72FE		     inc     word ptr ss:CALLXADD
DOSCODE:7303		     mov     ss:DEVCALL_REQSTAT, 0
DOSCODE:730A		     inc     di
DOSCODE:730B		     cmp     al, 1Ah	     ; ^Z?
DOSCODE:730D		     jz	     short ENDRDDEVJ2
DOSCODE:730F		     cmp     al, 0Dh	     ; c_CR
DOSCODE:7311		     loopne  DVRDLP
DOSCODE:7313		     inc     ax
DOSCODE:7314
DOSCODE:7314 ENDRDDEVJ2:			     ; ...
DOSCODE:7314		     jmp     ENDRDDEV
DOSCODE:7317 ; ---------------------------------------------------------------------------
DOSCODE:7317
DOSCODE:7317 do_polling:			     ; ...
DOSCODE:7317		     mov     bx, di
DOSCODE:7319		     xor     ax, ax
DOSCODE:731B		     mov     dx, ax
DOSCODE:731D		     call    SETREAD
DOSCODE:7320
DOSCODE:7320 do_io:				     ; ...
DOSCODE:7320		     mov     byte ptr es:[bx+2], 5 ; DEVRDND
DOSCODE:7325		     push    ds
DOSCODE:7326		     lds     si, ss:THISSFT
DOSCODE:732B		     call    DEVIOCALL
DOSCODE:732E		     pop     ds
DOSCODE:732F		     test    word ptr es:[bx+3], 8000h ; [es:bx+SRHEAD.REQSTAT],STERR
DOSCODE:7335		     jz	     short check_busy
DOSCODE:7337		     push    ds
DOSCODE:7338		     mov     dx, di
DOSCODE:733A		     call    CHARHARD
DOSCODE:733D		     mov     di, dx
DOSCODE:733F		     or	     al, al
DOSCODE:7341		     jz	     short pop_done_read
DOSCODE:7343		     cmp     al, 3
DOSCODE:7345		     jz	     short devrderr
DOSCODE:7347		     pop     ds
DOSCODE:7348		     jmp     short do_io
DOSCODE:734A ; ---------------------------------------------------------------------------
DOSCODE:734A
DOSCODE:734A check_busy:			     ; ...
DOSCODE:734A		     test    word ptr es:[bx+3], 200h ;	[es:bx+SRHEAD.REQSTAT]
DOSCODE:7350		     jnz     short no_char
DOSCODE:7352		     mov     byte ptr es:[bx+2], 4 ; DEVRD
DOSCODE:7357		     mov     word ptr es:[bx+12h], 1
DOSCODE:735D		     push    ds
DOSCODE:735E		     lds     si, ss:THISSFT
DOSCODE:7363		     call    DEVIOCALL
DOSCODE:7366		     mov     dx, di
DOSCODE:7368		     mov     ah, 86h
DOSCODE:736A		     mov     di, es:[bx+3]
DOSCODE:736E		     test    di, 8000h	     ; STERR
DOSCODE:7372		     jz	     short next_char
DOSCODE:7374		     call    CHARHARD
DOSCODE:7377		     mov     di, dx
DOSCODE:7379		     or	     al, al
DOSCODE:737B		     jz	     short pop_done_read
DOSCODE:737D		     cmp     al, 3
DOSCODE:737F		     jz	     short devrderr
DOSCODE:7381		     pop     ds
DOSCODE:7382		     jmp     short do_io
DOSCODE:7384 ; ---------------------------------------------------------------------------
DOSCODE:7384
DOSCODE:7384 next_char:				     ; ...
DOSCODE:7384		     pop     ds
DOSCODE:7385		     mov     di, dx
DOSCODE:7387		     dec     cx
DOSCODE:7388		     jcxz    short done_read
DOSCODE:738A		     inc     word ptr es:[bx+14]
DOSCODE:738E		     jmp     short do_io
DOSCODE:7390 ; ---------------------------------------------------------------------------
DOSCODE:7390
DOSCODE:7390 devrderr:				     ; ...
DOSCODE:7390		     pop     di
DOSCODE:7391		     les     di, ss:THISSFT
DOSCODE:7396		     jmp     SET_ACC_ERR_DS
DOSCODE:7399 ; ---------------------------------------------------------------------------
DOSCODE:7399
DOSCODE:7399 no_char:				     ; ...
DOSCODE:7399		     push    ax
DOSCODE:739A		     mov     ah, 84h
DOSCODE:739C		     int     2Ah	     ; Microsoft Networks - KEYBOARD BUSY LOOP
DOSCODE:739E		     pop     ax
DOSCODE:739F		     jmp     do_io
DOSCODE:73A2 ; ---------------------------------------------------------------------------
DOSCODE:73A2
DOSCODE:73A2 pop_done_read:			     ; ...
DOSCODE:73A2		     pop     ds
DOSCODE:73A3
DOSCODE:73A3 done_read:				     ; ...
DOSCODE:73A3		     add     di, ss:CALLSCNT
DOSCODE:73A8		     jmp     ENDRDDEVJ3
DOSCODE:73AB ; ---------------------------------------------------------------------------
DOSCODE:73AB
DOSCODE:73AB TRANBUF:				     ; ...
DOSCODE:73AB		     lodsb
DOSCODE:73AC		     stosb
DOSCODE:73AD		     cmp     al, 0Dh	     ; c_CR
DOSCODE:73AF		     jnz     short NORMCH
DOSCODE:73B1		     mov     byte ptr [si], 0Ah	; c_LF
DOSCODE:73B4
DOSCODE:73B4 NORMCH:				     ; ...
DOSCODE:73B4		     cmp     al, 0Ah	     ; c_LF
DOSCODE:73B6		     loopne  TRANBUF
DOSCODE:73B8		     jnz     short ENDRDCON
DOSCODE:73BA		     xor     si, si
DOSCODE:73BC		     call    OUTT
DOSCODE:73BF		     or	     al, 1
DOSCODE:73C1
DOSCODE:73C1 ENDRDCON:				     ; ...
DOSCODE:73C1		     push    ss
DOSCODE:73C2		     pop     ds
DOSCODE:73C3		     call    SWAPBACK
DOSCODE:73C6		     mov     ds:CONTPOS, si
DOSCODE:73CA
DOSCODE:73CA ENDRDDEV:				     ; ...
DOSCODE:73CA		     push    ss
DOSCODE:73CB		     pop     ds
DOSCODE:73CC		     mov     ds:NEXTADD, di
DOSCODE:73D0		     jnz     short SETSFTC
DOSCODE:73D2		     les     di, ds:THISSFT
DOSCODE:73D6		     and     byte ptr es:[di+5], 0BFh ;	[ES:DI+SF_ENTRY.sf_flags],
DOSCODE:73D6					     ; ~devid_device_EOF
DOSCODE:73DB
DOSCODE:73DB SETSFTC:				     ; ...
DOSCODE:73DB		     call    SETSFT
DOSCODE:73DE		     retn
DOSCODE:73DF ; ---------------------------------------------------------------------------
DOSCODE:73DF
DOSCODE:73DF READCON:				     ; ...
DOSCODE:73DF		     call    SWAPCON
DOSCODE:73E2		     mov     si, ds:CONTPOS
DOSCODE:73E6		     or	     si, si
DOSCODE:73E8		     jnz     short TRANBUF
DOSCODE:73EA		     cmp     ds:CONBUF,	128  ; 80h
DOSCODE:73EF		     jz	     short GETBUF
DOSCODE:73F1		     mov     word ptr ds:CONBUF, 0FF80h
DOSCODE:73F7
DOSCODE:73F7 GETBUF:				     ; ...
DOSCODE:73F7		     push    cx
DOSCODE:73F8		     push    es
DOSCODE:73F9		     push    di
DOSCODE:73FA		     mov     dx, offset	CONBUF
DOSCODE:73FD		     call    $STD_CON_STRING_INPUT
DOSCODE:7400		     pop     di
DOSCODE:7401		     pop     es
DOSCODE:7402		     pop     cx
DOSCODE:7403		     mov     si, (offset CONBUF+2)
DOSCODE:7406		     cmp     byte ptr [si], 1Ah
DOSCODE:7409		     jnz     short TRANBUF
DOSCODE:740B		     mov     al, 1Ah
DOSCODE:740D		     stosb
DOSCODE:740E		     dec     di
DOSCODE:740F		     mov     al, 0Ah	     ; c_LF
DOSCODE:7411		     call    OUTT
DOSCODE:7414		     xor     si, si
DOSCODE:7416		     jmp     short ENDRDCON
DOSCODE:7416 DOS_READ	     endp
DOSCODE:7416
DOSCODE:7418
DOSCODE:7418 ; =============== S U B R O U T I N E =======================================
DOSCODE:7418
DOSCODE:7418
DOSCODE:7418 DOS_WRITE	     proc near		     ; ...
DOSCODE:7418		     les     di, ds:THISSFT
DOSCODE:741C		     mov     al, es:[di+2]   ; [ES:DI+SF_ENTRY.sf_mode]
DOSCODE:7420		     and     al, 0Fh	     ; access_mask
DOSCODE:7422		     cmp     al, 0	     ; open_for_read
DOSCODE:7424		     jnz     short Check_FCB_RO
DOSCODE:7426
DOSCODE:7426 BadMode:				     ; ...
DOSCODE:7426		     jmp     SET_ACC_ERR
DOSCODE:7429 ; ---------------------------------------------------------------------------
DOSCODE:7429
DOSCODE:7429 Check_FCB_RO:			     ; ...
DOSCODE:7429		     test    byte ptr es:[di+3], 80h ; [ES:DI+SF_ENTRY.sf_mode+1],(sf_isFCB>>8)
DOSCODE:742E		     jz	     short WRITE_NO_MODE
DOSCODE:7430		     test    byte ptr es:[di+4], 1 ; [ES:DI+SF_ENTRY.sf_attr],attr_read_only
DOSCODE:7435		     jnz     short BadMode
DOSCODE:7437
DOSCODE:7437 WRITE_NO_MODE:			     ; ...
DOSCODE:7437		     call    SETUP
DOSCODE:743A		     call    IsSFTNet
DOSCODE:743D		     jz	     short LOCAL_WRITE
DOSCODE:743F		     mov     ax, 1109h	     ; (MultNET<<8)|9
DOSCODE:7442		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	WRITE TO REMOTE	FILE
DOSCODE:7442					     ; ES:DI ->	SFT
DOSCODE:7442					     ; SFT DPB field ->	DPB of drive containing	file
DOSCODE:7442					     ; CX = number of bytes, SS	= DOS CS, SDA DTA field	-> user	buffer
DOSCODE:7442					     ; Return: CF set on error,	CX = bytes written
DOSCODE:7444		     retn
DOSCODE:7445 ; ---------------------------------------------------------------------------
DOSCODE:7445
DOSCODE:7445 LOCAL_WRITE:			     ; ...
DOSCODE:7445		     test    byte ptr es:[di+5], 80h ; [ES:DI+SF_ENTRY.sf_flags],
DOSCODE:7445					     ; devid_device
DOSCODE:744A		     jnz     short WRTDEV
DOSCODE:744C		     mov     ds:EXTERR_LOCUS, 2
DOSCODE:7451		     call    ECritDisk
DOSCODE:7454		     call    DISKWRITE
DOSCODE:7457		     jb	     short nocommit
DOSCODE:7459		     les     di, ds:THISSFT
DOSCODE:745D		     test    byte ptr es:[di+3], 40h ; [ES:DI+SF_ENTRY.sf_mode],
DOSCODE:745D					     ; auto_commit_write
DOSCODE:7462		     jz	     short nocommit
DOSCODE:7464		     push    cx
DOSCODE:7465		     call    DOS_COMMIT
DOSCODE:7468		     pop     cx
DOSCODE:7469
DOSCODE:7469 nocommit:				     ; ...
DOSCODE:7469		     call    LCritDisk
DOSCODE:746C		     retn
DOSCODE:746D ; ---------------------------------------------------------------------------
DOSCODE:746D
DOSCODE:746D DVWRTRAW:				     ; ...
DOSCODE:746D		     xor     ax, ax
DOSCODE:746F		     call    SETWRITE
DOSCODE:7472		     push    ds
DOSCODE:7473		     lds     si, ss:THISSFT
DOSCODE:7478		     call    DEVIOCALL
DOSCODE:747B		     mov     dx, di
DOSCODE:747D		     mov     ah, 87h
DOSCODE:747F		     mov     di, ss:DEVCALL_REQSTAT
DOSCODE:7484		     or	     di, di
DOSCODE:7486		     jns     short CWRTROK
DOSCODE:7488		     call    CHARHARD
DOSCODE:748B		     sub     cx, ss:CALLSCNT
DOSCODE:7490		     mov     bx, dx
DOSCODE:7492		     add     bx, ss:CALLSCNT
DOSCODE:7497		     mov     di, bx
DOSCODE:7499		     or	     al, al
DOSCODE:749B		     jz	     short CWRTROK
DOSCODE:749D		     cmp     al, 3
DOSCODE:749F		     jz	     short CWRFERR
DOSCODE:74A1		     pop     ds
DOSCODE:74A2		     jmp     short DVWRTRAW
DOSCODE:74A4 ; ---------------------------------------------------------------------------
DOSCODE:74A4
DOSCODE:74A4 CWRFERR:				     ; ...
DOSCODE:74A4		     pop     ax
DOSCODE:74A5		     jmp     CRDFERR
DOSCODE:74A8 ; ---------------------------------------------------------------------------
DOSCODE:74A8
DOSCODE:74A8 CWRTROK:				     ; ...
DOSCODE:74A8		     pop     ax
DOSCODE:74A9		     pop     ds
DOSCODE:74AA		     mov     ax, ds:CALLSCNT
DOSCODE:74AD
DOSCODE:74AD ENDWRDEV:				     ; ...
DOSCODE:74AD		     les     di, ds:THISSFT
DOSCODE:74B1		     mov     cx, ax
DOSCODE:74B3		     call    ADDREC
DOSCODE:74B6		     retn
DOSCODE:74B7 ; ---------------------------------------------------------------------------
DOSCODE:74B7
DOSCODE:74B7 WRTNUL:				     ; ...
DOSCODE:74B7		     mov     dx, cx
DOSCODE:74B9
DOSCODE:74B9 WRTCOOKJ:				     ; ...
DOSCODE:74B9		     jmp     WRTCOOKDONE
DOSCODE:74BC ; ---------------------------------------------------------------------------
DOSCODE:74BC
DOSCODE:74BC WRTDEV:				     ; ...
DOSCODE:74BC		     mov     ds:EXTERR_LOCUS, 4	; errLOC_SerDev
DOSCODE:74C1		     or	     byte ptr es:[di+5], 40h ; [ES:DI+SF_ENTRY.sf_flags],
DOSCODE:74C1					     ; devid_device_EOF
DOSCODE:74C6		     mov     bl, es:[di+5]   ; [ES:DI+SF_ENTRY.sf_flags]
DOSCODE:74CA		     xor     ax, ax
DOSCODE:74CC		     jcxz    short ENDWRDEV
DOSCODE:74CE		     push    ds
DOSCODE:74CF		     mov     al, bl
DOSCODE:74D1		     lds     bx, ds:DMAADD
DOSCODE:74D5		     mov     di, bx
DOSCODE:74D7		     xor     dx, dx
DOSCODE:74D9		     test    al, 20h	     ; devid_device_raw
DOSCODE:74DB		     jz	     short TEST_DEV_CON
DOSCODE:74DD		     jmp     short DVWRTRAW
DOSCODE:74DF ; ---------------------------------------------------------------------------
DOSCODE:74DF
DOSCODE:74DF TEST_DEV_CON:			     ; ...
DOSCODE:74DF		     test    al, 2	     ; devid_device_con_out
DOSCODE:74E1		     jnz     short WRITECON
DOSCODE:74E3		     test    al, 4	     ; devid_device_null
DOSCODE:74E5		     jnz     short WRTNUL
DOSCODE:74E7		     mov     ax, dx
DOSCODE:74E9		     cmp     byte ptr [bx], 1Ah	; ^Z?
DOSCODE:74EC		     jz	     short WRTCOOKJ
DOSCODE:74EE		     push    cx
DOSCODE:74EF		     mov     cx, 1
DOSCODE:74F2		     call    SETWRITE
DOSCODE:74F5		     pop     cx
DOSCODE:74F6		     lds     si, ss:THISSFT
DOSCODE:74FB		     lds     si, [si+7]	     ; [SI+SF_ENTRY.sf_devptr]
DOSCODE:74FE
DOSCODE:74FE DVWRTLP:				     ; ...
DOSCODE:74FE		     call    DSKSTATCHK
DOSCODE:7501		     call    DEVIOCALL2
DOSCODE:7504		     push    di
DOSCODE:7505		     mov     ah, 87h
DOSCODE:7507		     mov     di, ss:DEVCALL_REQSTAT
DOSCODE:750C		     or	     di, di
DOSCODE:750E		     jns     short CWROK
DOSCODE:7510		     call    CHARHARD
DOSCODE:7513		     pop     di
DOSCODE:7514		     mov     ss:CALLSCNT, 1
DOSCODE:751B		     cmp     al, 1
DOSCODE:751D		     jz	     short DVWRTLP
DOSCODE:751F		     or	     al, al
DOSCODE:7521		     jz	     short DVWRTIGN
DOSCODE:7523		     jmp     CRDFERR
DOSCODE:7526 ; ---------------------------------------------------------------------------
DOSCODE:7526
DOSCODE:7526 CWROK:				     ; ...
DOSCODE:7526		     pop     di
DOSCODE:7527		     cmp     ss:CALLSCNT, 0
DOSCODE:752D		     jz	     short WRTCOOKDONE
DOSCODE:752F
DOSCODE:752F DVWRTIGN:				     ; ...
DOSCODE:752F		     inc     dx
DOSCODE:7530		     inc     word ptr ss:CALLXADD
DOSCODE:7535		     inc     di
DOSCODE:7536		     push    ds
DOSCODE:7537		     mov     ds, word ptr ss:CALLXADD+2
DOSCODE:753C		     cmp     byte ptr [di], 1Ah	; ^Z?
DOSCODE:753F		     pop     ds
DOSCODE:7540		     jz	     short WRTCOOKDONE
DOSCODE:7542		     mov     ss:DEVCALL_REQSTAT, 0
DOSCODE:7549		     loop    DVWRTLP
DOSCODE:754B
DOSCODE:754B WRTCOOKDONE:			     ; ...
DOSCODE:754B		     mov     ax, dx
DOSCODE:754D		     pop     ds
DOSCODE:754E		     jmp     ENDWRDEV
DOSCODE:7551 ; ---------------------------------------------------------------------------
DOSCODE:7551
DOSCODE:7551 WRITECON:				     ; ...
DOSCODE:7551		     push    ds
DOSCODE:7552		     push    ss
DOSCODE:7553		     pop     ds
DOSCODE:7554		     call    SWAPCON
DOSCODE:7557		     pop     ds
DOSCODE:7558		     mov     si, bx
DOSCODE:755A		     push    cx
DOSCODE:755B
DOSCODE:755B WRCONLP:				     ; ...
DOSCODE:755B		     lodsb
DOSCODE:755C		     cmp     al, 1Ah	     ; ^Z?
DOSCODE:755E		     jz	     short CONEOF
DOSCODE:7560		     call    OUTT
DOSCODE:7563		     loop    WRCONLP
DOSCODE:7565
DOSCODE:7565 CONEOF:				     ; ...
DOSCODE:7565		     pop     ax
DOSCODE:7566		     sub     ax, cx
DOSCODE:7568		     pop     ds
DOSCODE:7569		     call    SWAPBACK
DOSCODE:756C		     jmp     ENDWRDEV
DOSCODE:756C DOS_WRITE	     endp
DOSCODE:756C
DOSCODE:756F
DOSCODE:756F ; =============== S U B R O U T I N E =======================================
DOSCODE:756F
DOSCODE:756F
DOSCODE:756F GET_IO_SFT	     proc near		     ; ...
DOSCODE:756F		     cmp     ss:CONSWAP, 0
DOSCODE:7575		     jnz     short GetRedir
DOSCODE:7577
DOSCODE:7577 GetNormal:				     ; ...
DOSCODE:7577		     push    ss
DOSCODE:7578		     pop     ds
DOSCODE:7579		     push    es
DOSCODE:757A		     push    di
DOSCODE:757B		     call    SFFromHandle
DOSCODE:757E		     jb	     short RET44P
DOSCODE:7580		     mov     si, es
DOSCODE:7582		     mov     ds, si
DOSCODE:7584		     mov     si, di
DOSCODE:7586
DOSCODE:7586 RET44P:				     ; ...
DOSCODE:7586		     pop     di
DOSCODE:7587		     pop     es
DOSCODE:7588		     retn
DOSCODE:7589 ; ---------------------------------------------------------------------------
DOSCODE:7589
DOSCODE:7589 GetRedir:				     ; ...
DOSCODE:7589		     cmp     bx, 1
DOSCODE:758C		     ja	     short GetNormal
DOSCODE:758E		     lds     si, ss:CONSFT
DOSCODE:7593		     clc
DOSCODE:7594
DOSCODE:7594 get_io_sft_retn:			     ; ...
DOSCODE:7594		     retn
DOSCODE:7594 GET_IO_SFT	     endp
DOSCODE:7594
DOSCODE:7595
DOSCODE:7595 ; =============== S U B R O U T I N E =======================================
DOSCODE:7595
DOSCODE:7595
DOSCODE:7595 DIRREAD	     proc near		     ; ...
DOSCODE:7595		     xor     dx, dx
DOSCODE:7597		     cmp     ds:DIRSTART, 0
DOSCODE:759C		     jnz     short SubDir
DOSCODE:759E		     xchg    ax, dx
DOSCODE:759F		     jmp     short DoRead
DOSCODE:75A1 ; ---------------------------------------------------------------------------
DOSCODE:75A1
DOSCODE:75A1 SubDir:				     ; ...
DOSCODE:75A1		     mov     dl, al
DOSCODE:75A3		     and     dl, es:[bp+4]   ; [ES:BP+DPB.CLUSTER_MASK]
DOSCODE:75A7		     mov     cl, es:[bp+5]   ; [ES:BP+DPB.CLUSTER_SHIFT]
DOSCODE:75AB		     shr     ax, cl
DOSCODE:75AD
DOSCODE:75AD DoRead:				     ; ...
DOSCODE:75AD		     mov     ds:SECCLUSPOS, dl
DOSCODE:75B1		     mov     cx, ax
DOSCODE:75B3		     mov     ah, dl
DOSCODE:75B5		     mov     dx, word ptr ds:DIRSEC+2
DOSCODE:75B9		     mov     ds:HIGH_SECTOR, dx
DOSCODE:75BD		     mov     dx, word ptr ds:DIRSEC
DOSCODE:75C1		     add     dl, ah
DOSCODE:75C3		     adc     dh, 0
DOSCODE:75C6		     adc     ds:HIGH_SECTOR, 0
DOSCODE:75CB		     mov     bx, ds:CLUSNUM
DOSCODE:75CF		     mov     ds:NXTCLUSNUM, bx
DOSCODE:75D3		     jcxz    short FIRSTCLUSTER
DOSCODE:75D5
DOSCODE:75D5 SKPCLLP:				     ; ...
DOSCODE:75D5		     call    UNPACK
DOSCODE:75D8		     jb	     short get_io_sft_retn
DOSCODE:75DA		     xchg    bx, di
DOSCODE:75DC		     call    IsEOF
DOSCODE:75DF		     jnb     short HAVESKIPPED
DOSCODE:75E1		     loop    SKPCLLP
DOSCODE:75E3
DOSCODE:75E3 HAVESKIPPED:			     ; ...
DOSCODE:75E3		     mov     ds:NXTCLUSNUM, bx
DOSCODE:75E7		     mov     dx, di
DOSCODE:75E9		     mov     bl, ah
DOSCODE:75EB		     call    FIGREC
DOSCODE:75EE
DOSCODE:75EE FIRSTCLUSTER:			     ; ...
DOSCODE:75EE		     mov     ds:ALLOWED, 18h ; Allowed_RETRY+Allowed_FAIL
DOSCODE:75F3		     xor     al, al
DOSCODE:75F5		     call    GETBUFFR
DOSCODE:75F8		     jb	     short get_io_sft_retn
DOSCODE:75FA
DOSCODE:75FA SET_BUF_AS_DIR:			     ; ...
DOSCODE:75FA		     push    ds
DOSCODE:75FB		     push    si
DOSCODE:75FC		     lds     si, ds:CURBUF
DOSCODE:7600		     or	     byte ptr [si+5], 4	; [SI+BUFFINFO.buf_flags],buf_isDIR
DOSCODE:7604		     pop     si
DOSCODE:7605		     pop     ds
DOSCODE:7606
DOSCODE:7606 dirread_retn:			     ; ...
DOSCODE:7606		     retn
DOSCODE:7606 DIRREAD	     endp
DOSCODE:7606
DOSCODE:7607
DOSCODE:7607 ; =============== S U B R O U T I N E =======================================
DOSCODE:7607
DOSCODE:7607
DOSCODE:7607 FATSECRD	     proc near		     ; ...
DOSCODE:7607		     mov     ss:ALLOWED, 18h ; Allowed_RETRY+Allowed_FAIL
DOSCODE:760D		     mov     di, cx
DOSCODE:760F		     mov     cl, es:[bp+8]   ; [ES:BP+DPB.FAT_COUNT]
DOSCODE:7613		     mov     ax, es:[bp+0Fh] ; [ES:BP+DPB.FAT_SIZE]
DOSCODE:7617		     xor     ch, ch
DOSCODE:7619		     push    dx
DOSCODE:761A
DOSCODE:761A NXTFAT:				     ; ...
DOSCODE:761A		     mov     ss:HIGH_SECTOR, 0
DOSCODE:7621		     push    cx
DOSCODE:7622		     push    ax
DOSCODE:7623		     mov     cx, di
DOSCODE:7625		     call    DSKREAD
DOSCODE:7628		     pop     ax
DOSCODE:7629		     pop     cx
DOSCODE:762A		     jz	     short RET41P
DOSCODE:762C		     add     dx, ax
DOSCODE:762E		     loop    NXTFAT
DOSCODE:7630		     pop     dx
DOSCODE:7631		     mov     cx, di
DOSCODE:7633
DOSCODE:7633 DREAD:				     ; ...
DOSCODE:7633		     call    DSKREAD
DOSCODE:7636		     jz	     short dirread_retn
DOSCODE:7638		     mov     ss:READOP,	0
DOSCODE:763E		     call    HARDERRRW
DOSCODE:7641		     cmp     al, 1
DOSCODE:7643		     jz	     short DREAD
DOSCODE:7645		     cmp     al, 3
DOSCODE:7647		     clc
DOSCODE:7648		     jnz     short NO_CAR
DOSCODE:764A		     stc
DOSCODE:764B
DOSCODE:764B NO_CAR:				     ; ...
DOSCODE:764B		     retn
DOSCODE:764C ; ---------------------------------------------------------------------------
DOSCODE:764C
DOSCODE:764C RET41P:				     ; ...
DOSCODE:764C		     pop     dx
DOSCODE:764D		     retn
DOSCODE:764D FATSECRD	     endp
DOSCODE:764D
DOSCODE:764E
DOSCODE:764E ; =============== S U B R O U T I N E =======================================
DOSCODE:764E
DOSCODE:764E
DOSCODE:764E CHECK_WRITE_LOCK proc near		     ; ...
DOSCODE:764E		     test    byte ptr es:[di+4], 8 ; [ES:DI+SF_ENTRY.sf_attr],
DOSCODE:764E					     ; attr_volume_id
DOSCODE:7653		     jz	     short write_cont
DOSCODE:7655		     call    SET_ACC_ERR_DS
DOSCODE:7658		     retn
DOSCODE:7659 ; ---------------------------------------------------------------------------
DOSCODE:7659
DOSCODE:7659 write_cont:			     ; ...
DOSCODE:7659		     push    cx
DOSCODE:765A		     or	     cx, cx
DOSCODE:765C		     jnz     short Not_Truncate
DOSCODE:765E		     dec     cx
DOSCODE:765F
DOSCODE:765F Not_Truncate:			     ; ...
DOSCODE:765F		     mov     al, 80h
DOSCODE:7661		     call    LOCK_CHECK
DOSCODE:7664		     pop     cx
DOSCODE:7665		     jnb     short WRITE_OK
DOSCODE:7667		     call    WRITE_LOCK_VIOLATION
DOSCODE:766A		     jnb     short write_cont
DOSCODE:766C
DOSCODE:766C WRITE_OK:				     ; ...
DOSCODE:766C		     retn
DOSCODE:766C CHECK_WRITE_LOCK endp
DOSCODE:766C
DOSCODE:766D
DOSCODE:766D ; =============== S U B R O U T I N E =======================================
DOSCODE:766D
DOSCODE:766D
DOSCODE:766D CHECK_READ_LOCK proc near		     ; ...
DOSCODE:766D		     test    byte ptr es:[di+4], 8 ; [ES:DI+SF_ENTRY.sf_attr],
DOSCODE:766D					     ; attr_volume_id
DOSCODE:7672		     jz	     short do_retry
DOSCODE:7674		     call    SET_ACC_ERR
DOSCODE:7677		     retn
DOSCODE:7678 ; ---------------------------------------------------------------------------
DOSCODE:7678
DOSCODE:7678 do_retry:				     ; ...
DOSCODE:7678		     xor     al, al
DOSCODE:767A		     call    LOCK_CHECK
DOSCODE:767D		     jnb     short READLOCK_OK
DOSCODE:767F		     call    READ_LOCK_VIOLATION
DOSCODE:7682		     jnb     short do_retry
DOSCODE:7684
DOSCODE:7684 READLOCK_OK:			     ; ...
DOSCODE:7684		     retn
DOSCODE:7684 CHECK_READ_LOCK endp
DOSCODE:7684
DOSCODE:7685
DOSCODE:7685 ; =============== S U B R O U T I N E =======================================
DOSCODE:7685
DOSCODE:7685
DOSCODE:7685 DSKREAD	     proc near		     ; ...
DOSCODE:7685		     push    cx
DOSCODE:7686		     mov     ah, es:[bp+17h] ; [ES:BP+DPB.MEDIA]
DOSCODE:768A		     mov     al, es:[bp+1]   ; [ES:BP+DPB.UNIT]
DOSCODE:768E		     push    bx
DOSCODE:768F		     push    es
DOSCODE:7690		     call    SETREAD
DOSCODE:7693		     jmp     short DODSKOP
DOSCODE:7693 DSKREAD	     endp
DOSCODE:7693
DOSCODE:7695
DOSCODE:7695 ; =============== S U B R O U T I N E =======================================
DOSCODE:7695
DOSCODE:7695
DOSCODE:7695 DWRITE	     proc near		     ; ...
DOSCODE:7695		     call    DSKWRITE
DOSCODE:7698		     jz	     short dw_ret_label
DOSCODE:769A		     mov     ss:READOP,	1
DOSCODE:76A0		     call    HARDERRRW
DOSCODE:76A3		     cmp     al, 1
DOSCODE:76A5		     jz	     short DWRITE
DOSCODE:76A7		     cmp     al, 3
DOSCODE:76A9		     clc
DOSCODE:76AA		     jnz     short dw_ret_label	; NO_CAR2
DOSCODE:76AC		     stc
DOSCODE:76AD
DOSCODE:76AD dw_ret_label:			     ; ...
DOSCODE:76AD		     retn		     ; NO_CAR2
DOSCODE:76AD DWRITE	     endp
DOSCODE:76AD
DOSCODE:76AE
DOSCODE:76AE ; =============== S U B R O U T I N E =======================================
DOSCODE:76AE
DOSCODE:76AE
DOSCODE:76AE DSKWRITE	     proc near		     ; ...
DOSCODE:76AE		     push    cx
DOSCODE:76AF		     mov     ah, es:[bp+17h] ; [ES:BP+DPB.MEDIA]
DOSCODE:76B3		     mov     al, es:[bp+1]   ; [ES:BP+DPB.UNIT]
DOSCODE:76B7		     push    bx
DOSCODE:76B8		     push    es
DOSCODE:76B9		     call    SETWRITE
DOSCODE:76BC
DOSCODE:76BC DODSKOP:				     ; ...
DOSCODE:76BC		     mov     cx, ds
DOSCODE:76BE		     pop     ds
DOSCODE:76BF		     push    ds
DOSCODE:76C0		     lds     si, ds:[bp+13h] ; LDS SI,[DS:BP+DPB.DRIVER_ADDR]
DOSCODE:76C4		     call    DEVIOCALL2
DOSCODE:76C7		     mov     ds, cx
DOSCODE:76C9		     pop     es
DOSCODE:76CA		     pop     bx
DOSCODE:76CB		     mov     cx, ss:CALLSCNT
DOSCODE:76D0		     pop     di
DOSCODE:76D1		     sub     cx, di
DOSCODE:76D3		     neg     cx
DOSCODE:76D5		     mov     ax, ss:DEVCALL_REQSTAT
DOSCODE:76D9		     test    ax, 8000h	     ; STERR
DOSCODE:76DC		     retn
DOSCODE:76DC DSKWRITE	     endp
DOSCODE:76DC
DOSCODE:76DD
DOSCODE:76DD ; =============== S U B R O U T I N E =======================================
DOSCODE:76DD
DOSCODE:76DD
DOSCODE:76DD HARDERRRW	     proc near		     ; ...
DOSCODE:76DD		     cmp     al, 0Fh	     ; error_I24_wrong_disk
DOSCODE:76DF		     jnz     short DO_ERR
DOSCODE:76E1		     push    ax
DOSCODE:76E2		     mov     ax, word ptr ss:CALLVIDRW
DOSCODE:76E6		     mov     word ptr ss:EXTERRPT, ax
DOSCODE:76EA		     mov     ax, word ptr ss:CALLVIDRW+2
DOSCODE:76EE		     mov     word ptr ss:EXTERRPT+2, ax
DOSCODE:76F2		     pop     ax
DOSCODE:76F3
DOSCODE:76F3 DO_ERR:				     ; ...
DOSCODE:76F3		     call    HARDERR
DOSCODE:76F6		     retn
DOSCODE:76F6 HARDERRRW	     endp
DOSCODE:76F6
DOSCODE:76F7 ; ---------------------------------------------------------------------------
DOSCODE:76F7
DOSCODE:76F7 SETUP:				     ; ...
DOSCODE:76F7		     lds     si, es:[di+7]   ; [ES:DI+SF_ENTRY.sf_devptr]
DOSCODE:76FB		     mov     word ptr ss:THISDPB+2, ds
DOSCODE:7700		     push    ss
DOSCODE:7701		     pop     ds
DOSCODE:7702		     mov     word ptr ds:THISDPB, si
DOSCODE:7706		     mov     bx, word ptr ds:DMAADD
DOSCODE:770A		     mov     ds:NEXTADD, bx
DOSCODE:770E		     mov     ds:TRANS, 0
DOSCODE:7713		     mov     ax, es:[di+15h] ; [ES:DI+SF_ENTRY.sf_position]
DOSCODE:7717		     mov     dx, es:[di+17h] ; [ES:DI+SF_ENTRY.sf_position+2]
DOSCODE:771B		     mov     word ptr ds:BYTPOS+2, dx
DOSCODE:771F		     mov     word ptr ds:BYTPOS, ax
DOSCODE:7722		     test    word ptr es:[di+5], 8080h ; [ES:DI+SF_ENTRY.sf_flags],
DOSCODE:7722					     ; sf_isnet+devid_device
DOSCODE:7728		     jnz     short NOSETSTUFF
DOSCODE:772A		     push    es
DOSCODE:772B		     les     bp, ds:THISDPB
DOSCODE:772F		     mov     bl, es:[bp+0]   ; [ES:BP+DPB.drive]
DOSCODE:7733		     mov     ds:THISDRV, bl
DOSCODE:7737		     mov     bx, es:[bp+2]   ; [ES:BP+DPB.SECTOR_SIZE]
DOSCODE:773B		     push    cx
DOSCODE:773C		     call    DIV32
DOSCODE:773F		     mov     ds:BYTSECPOS, dx
DOSCODE:7743		     mov     word ptr ds:SECPOS, ax
DOSCODE:7746		     mov     word ptr ds:SECPOS+2, cx
DOSCODE:774A		     mov     dx, cx
DOSCODE:774C		     mov     bx, ax
DOSCODE:774E		     and     bl, es:[bp+4]   ; [ES:BP+DPB.CLUSTER_MASK]
DOSCODE:7752		     mov     ds:SECCLUSPOS, bl
DOSCODE:7756		     call    SHR32
DOSCODE:7759		     pop     cx
DOSCODE:775A		     jnz     short EOFERR
DOSCODE:775C		     cmp     ax, es:[bp+0Dh] ; [ES:BP+DPB.MAX_CLUSTER]
DOSCODE:7760		     ja	     short EOFERR
DOSCODE:7762		     mov     ds:CLUSNUM, ax
DOSCODE:7765		     pop     es
DOSCODE:7766
DOSCODE:7766 NOSETSTUFF:			     ; ...
DOSCODE:7766		     mov     ax, cx
DOSCODE:7768		     add     ax, word ptr ds:DMAADD
DOSCODE:776C		     jnb     short setup_OK
DOSCODE:776E		     mov     ax, word ptr ds:DMAADD
DOSCODE:7771		     neg     ax
DOSCODE:7773		     jnz     short NoDec
DOSCODE:7775		     dec     ax
DOSCODE:7776
DOSCODE:7776 NoDec:				     ; ...
DOSCODE:7776		     mov     cx, ax
DOSCODE:7778		     jcxz    short NOROOM
DOSCODE:777A
DOSCODE:777A setup_OK:				     ; ...
DOSCODE:777A		     retn
DOSCODE:777B ; ---------------------------------------------------------------------------
DOSCODE:777B
DOSCODE:777B EOFERR:				     ; ...
DOSCODE:777B		     pop     es
DOSCODE:777C		     xor     cx, cx
DOSCODE:777E
DOSCODE:777E NOROOM:				     ; ...
DOSCODE:777E		     pop     bx
DOSCODE:777F		     clc
DOSCODE:7780		     retn
DOSCODE:7781
DOSCODE:7781 ; =============== S U B R O U T I N E =======================================
DOSCODE:7781
DOSCODE:7781
DOSCODE:7781 BREAKDOWN	     proc near		     ; ...
DOSCODE:7781		     mov     ax, ds:BYTSECPOS
DOSCODE:7784		     mov     bx, cx
DOSCODE:7786		     or	     ax, ax
DOSCODE:7788		     jz	     short SAVFIR
DOSCODE:778A		     sub     ax, es:[bp+2]   ; [ES:BP+DPB.SECTOR_SIZE]
DOSCODE:778E		     neg     ax
DOSCODE:7790		     sub     bx, ax
DOSCODE:7792		     jnb     short SAVFIR
DOSCODE:7794		     add     ax, bx
DOSCODE:7796		     xor     bx, bx
DOSCODE:7798
DOSCODE:7798 SAVFIR:				     ; ...
DOSCODE:7798		     mov     ds:BYTCNT1, ax
DOSCODE:779B		     mov     ax, bx
DOSCODE:779D		     xor     dx, dx
DOSCODE:779F		     div     word ptr es:[bp+2]	; [ES:BP+DPB.SECTOR_SIZE]
DOSCODE:77A3		     mov     ds:SECCNT,	ax
DOSCODE:77A6		     mov     ds:BYTCNT2, dx
DOSCODE:77AA
DOSCODE:77AA _RET45:				     ; ...
DOSCODE:77AA		     retn
DOSCODE:77AA BREAKDOWN	     endp
DOSCODE:77AA
DOSCODE:77AB
DOSCODE:77AB ; =============== S U B R O U T I N E =======================================
DOSCODE:77AB
DOSCODE:77AB
DOSCODE:77AB READ_LOCK_VIOLATION proc near	     ; ...
DOSCODE:77AB		     mov     ds:READOP,	0
DOSCODE:77B0
DOSCODE:77B0 ERR_ON_CHECK:			     ; ...
DOSCODE:77B0		     test    byte ptr es:[di+3], 80h ; [ES:DI+SF_ENTRY.sf_mode+1],
DOSCODE:77B0					     ; (sf_isFCB>>8)
DOSCODE:77B5		     jnz     short HARD_ERR
DOSCODE:77B7		     push    cx
DOSCODE:77B8		     mov     cl, es:[di+2]   ; [ES:DI+SF_ENTRY.sf_mode]
DOSCODE:77BC		     and     cl, 0F0h	     ; SHARING_MASK
DOSCODE:77BF		     cmp     cl, 0	     ; SHARING_COMPAT
DOSCODE:77C2		     pop     cx
DOSCODE:77C3		     jnz     short NO_HARD_ERR
DOSCODE:77C5
DOSCODE:77C5 HARD_ERR:				     ; ...
DOSCODE:77C5		     call    LOCK_VIOLATION
DOSCODE:77C8		     jnb     short _RET45
DOSCODE:77CA
DOSCODE:77CA NO_HARD_ERR:			     ; ...
DOSCODE:77CA		     xor     cx, cx
DOSCODE:77CC		     mov     ax, 21h	     ; error_lock_violation
DOSCODE:77CF		     stc
DOSCODE:77D0		     retn
DOSCODE:77D0 READ_LOCK_VIOLATION endp
DOSCODE:77D0
DOSCODE:77D1
DOSCODE:77D1 ; =============== S U B R O U T I N E =======================================
DOSCODE:77D1
DOSCODE:77D1
DOSCODE:77D1 WRITE_LOCK_VIOLATION proc near	     ; ...
DOSCODE:77D1		     mov     ds:READOP,	1
DOSCODE:77D6		     jmp     short ERR_ON_CHECK
DOSCODE:77D6 WRITE_LOCK_VIOLATION endp
DOSCODE:77D6
DOSCODE:77D8 ; ---------------------------------------------------------------------------
DOSCODE:77D8
DOSCODE:77D8 DISKREAD:				     ; ...
DOSCODE:77D8		     mov     ax, es:[di+11h] ; [ES:DI+SF_ENTRY.sf_size]
DOSCODE:77DC		     mov     bx, es:[di+13h] ; [ES:DI+SF_ENTRY.sf_size+2]
DOSCODE:77E0		     sub     ax, word ptr ds:BYTPOS
DOSCODE:77E4		     sbb     bx, word ptr ds:BYTPOS+2
DOSCODE:77E8		     jb	     short RDERR
DOSCODE:77EA		     jnz     short ENUF
DOSCODE:77EC		     or	     ax, ax
DOSCODE:77EE		     jz	     short RDERR
DOSCODE:77F0		     cmp     ax, cx
DOSCODE:77F2		     jnb     short ENUF
DOSCODE:77F4		     mov     cx, ax
DOSCODE:77F6
DOSCODE:77F6 ENUF:				     ; ...
DOSCODE:77F6		     call    CHECK_READ_LOCK
DOSCODE:77F9		     jnb     short _READ_OK
DOSCODE:77FB		     retn
DOSCODE:77FC ; ---------------------------------------------------------------------------
DOSCODE:77FC
DOSCODE:77FC _READ_OK:				     ; ...
DOSCODE:77FC		     les     bp, ds:THISDPB
DOSCODE:7800		     call    BREAKDOWN
DOSCODE:7803		     mov     cx, ds:CLUSNUM
DOSCODE:7807		     call    FNDCLUS
DOSCODE:780A		     jb	     short SET_ACC_ERR_DS
DOSCODE:780C		     or	     cx, cx
DOSCODE:780E		     jz	     short SKIPERR
DOSCODE:7810
DOSCODE:7810 RDERR:				     ; ...
DOSCODE:7810		     mov     ah, 0Eh
DOSCODE:7812		     jmp     WRTERR22
DOSCODE:7815 ; ---------------------------------------------------------------------------
DOSCODE:7815
DOSCODE:7815 SETSFTJ2:				     ; ...
DOSCODE:7815		     jmp     SETSFT
DOSCODE:7818 ; ---------------------------------------------------------------------------
DOSCODE:7818
DOSCODE:7818 CANOT_READ:			     ; ...
DOSCODE:7818		     pop     cx
DOSCODE:7819		     pop     bx
DOSCODE:781A
DOSCODE:781A SET_ACC_ERR_DS:			     ; ...
DOSCODE:781A		     push    ss
DOSCODE:781B		     pop     ds
DOSCODE:781C
DOSCODE:781C SET_ACC_ERR:			     ; ...
DOSCODE:781C		     xor     cx, cx
DOSCODE:781E		     mov     ax, 5	     ; error_access_denied
DOSCODE:7821		     stc
DOSCODE:7822		     retn
DOSCODE:7823 ; ---------------------------------------------------------------------------
DOSCODE:7823
DOSCODE:7823 SKIPERR:				     ; ...
DOSCODE:7823		     mov     ds:LASTPOS, dx
DOSCODE:7827		     mov     ds:CLUSNUM, bx
DOSCODE:782B		     cmp     ds:BYTCNT1, 0
DOSCODE:7830		     jz	     short RDMID
DOSCODE:7832		     call    BUFRD
DOSCODE:7835 ; ---------------------------------------------------------------------------
DOSCODE:7835		     jb	     short SET_ACC_ERR_DS
DOSCODE:7837
DOSCODE:7837 RDMID:				     ; ...
DOSCODE:7837		     cmp     ds:SECCNT,	0
DOSCODE:783C		     jz	     short RDLAST
DOSCODE:783E		     call    NEXTSEC
DOSCODE:7841		     jb	     short SETSFTJ2
DOSCODE:7843		     mov     ds:TRANS, 1
DOSCODE:7848		     mov     dl, ds:SECCLUSPOS
DOSCODE:784C		     mov     cx, ds:SECCNT
DOSCODE:7850		     mov     bx, ds:CLUSNUM
DOSCODE:7854
DOSCODE:7854 RDLP:				     ; ...
DOSCODE:7854		     call    OPTIMIZE
DOSCODE:7857		     jb	     short SET_ACC_ERR_DS
DOSCODE:7859		     push    di
DOSCODE:785A		     push    ax
DOSCODE:785B		     push    bx
DOSCODE:785C		     mov     ds:ALLOWED, 38h ; Allowed_RETRY+Allowed_FAIL+Allowed_IGNORE
DOSCODE:7861		     mov     ds, word ptr ds:DMAADD+2
DOSCODE:7865		     push    dx
DOSCODE:7866		     push    cx
DOSCODE:7867		     call    SET_RQ_SC_PARMS
DOSCODE:786A		     call    DREAD
DOSCODE:786D		     pop     cx
DOSCODE:786E		     pop     dx
DOSCODE:786F		     pop     ss:TEMP_VAR
DOSCODE:7874		     jb	     short CANOT_READ
DOSCODE:7876		     mov     ss:TEMP_VAR2, ds
DOSCODE:787B		     call    DskRdBufScan
DOSCODE:787E		     push    ss
DOSCODE:787F		     pop     ds
DOSCODE:7880		     pop     cx
DOSCODE:7881		     pop     bx
DOSCODE:7882		     jcxz    short RDLAST
DOSCODE:7884		     call    IsEOF
DOSCODE:7887		     jnb     short SETSFT
DOSCODE:7889		     mov     dl, 0
DOSCODE:788B		     inc     ds:LASTPOS
DOSCODE:788F		     jmp     short RDLP
DOSCODE:7891 ; ---------------------------------------------------------------------------
DOSCODE:7891
DOSCODE:7891 RDLAST:				     ; ...
DOSCODE:7891		     mov     ax, ds:BYTCNT2
DOSCODE:7894		     or	     ax, ax
DOSCODE:7896		     jz	     short SETSFT
DOSCODE:7898		     mov     ds:BYTCNT1, ax
DOSCODE:789B		     call    NEXTSEC
DOSCODE:789E		     jb	     short SETSFT
DOSCODE:78A0		     mov     ds:BYTSECPOS, 0
DOSCODE:78A6		     call    BUFRD
DOSCODE:78A6 ; ---------------------------------------------------------------------------
DOSCODE:78A9		     db	 73h ; s
DOSCODE:78AA		     db	   3
DOSCODE:78AB		     db	0E9h ; é
DOSCODE:78AC		     db	 6Ch ; l
DOSCODE:78AD		     db	0FFh
DOSCODE:78AE
DOSCODE:78AE ; =============== S U B R O U T I N E =======================================
DOSCODE:78AE
DOSCODE:78AE
DOSCODE:78AE SETSFT	     proc near		     ; ...
DOSCODE:78AE		     les     di, ds:THISSFT
DOSCODE:78B2
DOSCODE:78B2 SETCLUS:				     ; ...
DOSCODE:78B2		     mov     cx, ds:NEXTADD
DOSCODE:78B6		     sub     cx, word ptr ds:DMAADD
DOSCODE:78BA		     test    byte ptr es:[di+5], 80h ; [ES:DI+SF_ENTRY.sf_flags],
DOSCODE:78BA					     ; devid_device
DOSCODE:78BF		     jnz     short ADDREC
DOSCODE:78C1		     mov     ax, ds:CLUSNUM
DOSCODE:78C4		     mov     es:[di+35h], ax ; [ES:DI+SF_ENTRY.sf_lstclus]
DOSCODE:78C8		     mov     ax, ds:LASTPOS
DOSCODE:78CB		     mov     es:[di+19h], ax ; [ES:DI+SF_ENTRY.sf_cluspos]
DOSCODE:78CF
DOSCODE:78CF ADDREC:				     ; ...
DOSCODE:78CF		     jcxz    short RET28
DOSCODE:78D1		     add     es:[di+15h], cx ; [ES:DI+SF_ENTRY.sf_position]
DOSCODE:78D5		     adc     word ptr es:[di+17h], 0 ; [ES:DI+SF_ENTRY.sf_position+2]
DOSCODE:78DA
DOSCODE:78DA RET28:				     ; ...
DOSCODE:78DA		     clc
DOSCODE:78DB		     retn
DOSCODE:78DB SETSFT	     endp
DOSCODE:78DB
DOSCODE:78DC
DOSCODE:78DC ; =============== S U B R O U T I N E =======================================
DOSCODE:78DC
DOSCODE:78DC
DOSCODE:78DC DskRdBufScan    proc near		     ; ...
DOSCODE:78DC		     cmp     ss:DirtyBufferCount, 0
DOSCODE:78E2		     jz	     short bufx
DOSCODE:78E4		     mov     bx, ss:HIGH_SECTOR
DOSCODE:78E9		     mov     si, bx
DOSCODE:78EB		     add     cx, dx
DOSCODE:78ED		     adc     si, 0
DOSCODE:78F0		     call    GETCURHEAD
DOSCODE:78F3		     mov     ax, [di+2]	     ; [di+BUFFINFO.buf_prev]
DOSCODE:78F6		     mov     ss:FIRST_BUFF_ADDR, ax
DOSCODE:78FA		     mov     al, es:[bp+0]
DOSCODE:78FE
DOSCODE:78FE bufq:				     ; ...
DOSCODE:78FE		     cmp     al, [di+4]	     ; [di+BUFFINFO.buf_ID]
DOSCODE:7901		     jnz     short bufq1
DOSCODE:7903		     cmp     bx, [di+8]	     ; [di+BUFFINFO.buf_sector+2]
DOSCODE:7906		     jnz     short bufq01
DOSCODE:7908		     cmp     dx, [di+6]	     ; [di+BUFFINFO.buf_sector]
DOSCODE:790B
DOSCODE:790B bufq01:				     ; ...
DOSCODE:790B		     ja	     short bufq1
DOSCODE:790D		     cmp     si, [di+8]
DOSCODE:7910		     jnz     short bufq02
DOSCODE:7912		     cmp     cx, [di+6]
DOSCODE:7915
DOSCODE:7915 bufq02:				     ; ...
DOSCODE:7915		     ja	     short bufq2
DOSCODE:7917
DOSCODE:7917 bufq1:				     ; ...
DOSCODE:7917		     cmp     di, ss:FIRST_BUFF_ADDR
DOSCODE:791C		     mov     di, [di]	     ; [di+BUFFINFO.buf_next]
DOSCODE:791E		     jnz     short bufq
DOSCODE:7920
DOSCODE:7920 bufx:				     ; ...
DOSCODE:7920		     retn
DOSCODE:7921 ; ---------------------------------------------------------------------------
DOSCODE:7921
DOSCODE:7921 bufq2:				     ; ...
DOSCODE:7921		     push    ax
DOSCODE:7922		     test    byte ptr [di+5], 40h ; [di+BUFFINFO.buf_flags],
DOSCODE:7922					     ; buf_dirty
DOSCODE:7926		     jz	     short bufq3
DOSCODE:7928		     push    cx
DOSCODE:7929		     push    dx
DOSCODE:792A		     push    si
DOSCODE:792B		     push    di
DOSCODE:792C		     push    es
DOSCODE:792D		     mov     ax, dx
DOSCODE:792F		     sub     ax, [di+6]	     ; [di+BUFFINFO.buf_sector]
DOSCODE:7932		     neg     ax
DOSCODE:7934		     lea     si, [di+20]     ; [di+BUFINSIZ]
DOSCODE:7937		     mov     cx, es:[bp+2]   ; [es:bp+DPB.SECTOR_SIZE]
DOSCODE:793B		     mul     cx
DOSCODE:793D		     mov     di, ss:TEMP_VAR
DOSCODE:7942		     add     di, ax
DOSCODE:7944		     mov     es, ss:TEMP_VAR2
DOSCODE:7949		     shr     cx, 1
DOSCODE:794B		     rep movsw
DOSCODE:794D		     adc     cx, 0
DOSCODE:7950		     rep movsb
DOSCODE:7952		     pop     es
DOSCODE:7953		     pop     di
DOSCODE:7954		     pop     si
DOSCODE:7955		     pop     dx
DOSCODE:7956		     pop     cx
DOSCODE:7957
DOSCODE:7957 bufq3:				     ; ...
DOSCODE:7957		     mov     ax, di
DOSCODE:7959		     call    SCANPLACE
DOSCODE:795C		     cmp     ax, ss:FIRST_BUFF_ADDR
DOSCODE:7961		     pop     ax
DOSCODE:7962		     jnz     short bufq
DOSCODE:7964		     jmp     short bufx
DOSCODE:7964 DskRdBufScan    endp
DOSCODE:7964
DOSCODE:7966
DOSCODE:7966 ; =============== S U B R O U T I N E =======================================
DOSCODE:7966
DOSCODE:7966
DOSCODE:7966 DISKWRITE	     proc near		     ; ...
DOSCODE:7966		     call    CHECK_WRITE_LOCK
DOSCODE:7969		     jnb     short _WRITE_OK
DOSCODE:796B		     retn
DOSCODE:796C ; ---------------------------------------------------------------------------
DOSCODE:796C
DOSCODE:796C WRTEOFJ:				     ; ...
DOSCODE:796C		     jmp     WRTEOF
DOSCODE:796F ; ---------------------------------------------------------------------------
DOSCODE:796F
DOSCODE:796F _WRITE_OK:				     ; ...
DOSCODE:796F		     and     word ptr es:[di+5], 0BFBFh	; [ES:DI+SF_ENTRY.sf_flags],
DOSCODE:796F					     ; ~(sf_close_nodate|devid_file_clean)
DOSCODE:7975		     mov     ax, es:[di+11h] ; [ES:DI+SF_ENTRY.sf_size]
DOSCODE:7979		     mov     ds:TEMP_VAR, ax
DOSCODE:797C		     mov     ax, es:[di+13h] ; [ES:DI+SF_ENTRY.sf_size+2]
DOSCODE:7980		     mov     ds:TEMP_VAR2, ax
DOSCODE:7983		     les     bp, ds:THISDPB
DOSCODE:7987		     call    BREAKDOWN
DOSCODE:798A		     mov     ax, word ptr ds:BYTPOS
DOSCODE:798D		     mov     dx, word ptr ds:BYTPOS+2
DOSCODE:7991		     jcxz    short WRTEOFJ
DOSCODE:7993		     add     ax, cx
DOSCODE:7995		     adc     dx, 0
DOSCODE:7998		     mov     bx, es:[bp+2]   ; [ES:BP+DPB.SECTOR_SIZE]
DOSCODE:799C		     call    DIV32
DOSCODE:799F		     mov     si, ax
DOSCODE:79A1		     mov     ds:HIGH_SECTOR, cx
DOSCODE:79A5		     or	     dx, dx
DOSCODE:79A7		     push    dx
DOSCODE:79A8		     mov     dx, cx
DOSCODE:79AA		     jnz     short CALCLUS
DOSCODE:79AC		     sub     ax, 1
DOSCODE:79AF		     sbb     dx, 0
DOSCODE:79B2
DOSCODE:79B2 CALCLUS:				     ; ...
DOSCODE:79B2		     call    SHR32
DOSCODE:79B5		     pop     dx
DOSCODE:79B6		     push    ax
DOSCODE:79B7		     push    dx
DOSCODE:79B8		     mov     dx, ds:TEMP_VAR2
DOSCODE:79BC		     mov     ax, ds:TEMP_VAR
DOSCODE:79BF		     call    DIV32
DOSCODE:79C2		     mov     ds:TEMP_VAR2, cx
DOSCODE:79C6		     mov     word ptr ds:VALSEC+2, cx
DOSCODE:79CA		     mov     cx, ax
DOSCODE:79CC		     mov     bx, si
DOSCODE:79CE		     or	     dx, dx
DOSCODE:79D0		     jz	     short NORND
DOSCODE:79D2		     add     ax, 1
DOSCODE:79D5		     adc     word ptr ds:VALSEC+2, 0
DOSCODE:79DA
DOSCODE:79DA NORND:				     ; ...
DOSCODE:79DA		     mov     word ptr ds:VALSEC, ax
DOSCODE:79DD		     xor     ax, ax
DOSCODE:79DF		     mov     word ptr ds:GROWCNT, ax
DOSCODE:79E2		     mov     word ptr ds:GROWCNT+2, ax
DOSCODE:79E5		     pop     ax
DOSCODE:79E6		     mov     di, ds:HIGH_SECTOR
DOSCODE:79EA		     cmp     di, ds:TEMP_VAR2
DOSCODE:79EE		     jb	     short NOGROW
DOSCODE:79F0		     jz	     short lowsec
DOSCODE:79F2		     sub     bx, cx
DOSCODE:79F4		     sbb     di, ds:TEMP_VAR2
DOSCODE:79F8		     jmp     short yesgrow
DOSCODE:79FA ; ---------------------------------------------------------------------------
DOSCODE:79FA
DOSCODE:79FA lowsec:				     ; ...
DOSCODE:79FA		     mov     di, 0
DOSCODE:79FD		     sub     bx, cx
DOSCODE:79FF		     jb	     short NOGROW
DOSCODE:7A01		     jz	     short TESTTAIL
DOSCODE:7A03
DOSCODE:7A03 yesgrow:				     ; ...
DOSCODE:7A03		     mov     cx, dx
DOSCODE:7A05		     xchg    ax, bx
DOSCODE:7A06		     mul     word ptr es:[bp+2]	; [ES:BP+DPB.SECTOR_SIZE]
DOSCODE:7A0A		     mov     ds:HIGH_SECTOR, dx
DOSCODE:7A0E		     mov     ds:TEMP_VAR2, ax
DOSCODE:7A11		     mov     ax, di
DOSCODE:7A13		     mul     word ptr es:[bp+2]	; [ES:BP+DPB.SECTOR_SIZE]
DOSCODE:7A17		     add     ax, ds:HIGH_SECTOR
DOSCODE:7A1B		     mov     dx, ax
DOSCODE:7A1D		     mov     ax, ds:TEMP_VAR2
DOSCODE:7A20		     sub     ax, cx
DOSCODE:7A22		     sbb     dx, 0
DOSCODE:7A25		     add     ax, bx
DOSCODE:7A27		     adc     dx, 0
DOSCODE:7A2A		     jmp     short SETGRW
DOSCODE:7A2C ; ---------------------------------------------------------------------------
DOSCODE:7A2C
DOSCODE:7A2C HAVSTART:				     ; ...
DOSCODE:7A2C		     mov     cx, ax
DOSCODE:7A2E		     call    SKPCLP
DOSCODE:7A31		     jcxz    short DOWRTJ
DOSCODE:7A33		     call    ALLOCATE
DOSCODE:7A36		     jnb     short DOWRTJ
DOSCODE:7A38
DOSCODE:7A38 WRTERR:				     ; ...
DOSCODE:7A38		     mov     ah, 0Fh
DOSCODE:7A3A
DOSCODE:7A3A WRTERR22:				     ; ...
DOSCODE:7A3A		     mov     al, ds:THISDRV
DOSCODE:7A3D		     xor     cx, cx
DOSCODE:7A3F		     les     di, ds:THISSFT
DOSCODE:7A43		     clc
DOSCODE:7A44		     retn
DOSCODE:7A45 ; ---------------------------------------------------------------------------
DOSCODE:7A45
DOSCODE:7A45 DOWRTJ:				     ; ...
DOSCODE:7A45		     jmp     short DOWRT
DOSCODE:7A47 ; ---------------------------------------------------------------------------
DOSCODE:7A47
DOSCODE:7A47 ACC_ERRWJ:				     ; ...
DOSCODE:7A47		     jmp     SET_ACC_ERRW
DOSCODE:7A4A ; ---------------------------------------------------------------------------
DOSCODE:7A4A
DOSCODE:7A4A TESTTAIL:				     ; ...
DOSCODE:7A4A		     sub     ax, dx
DOSCODE:7A4C		     jbe     short NOGROW
DOSCODE:7A4E		     xor     dx, dx
DOSCODE:7A50
DOSCODE:7A50 SETGRW:				     ; ...
DOSCODE:7A50		     mov     word ptr ds:GROWCNT, ax
DOSCODE:7A53		     mov     word ptr ds:GROWCNT+2, dx
DOSCODE:7A57
DOSCODE:7A57 NOGROW:				     ; ...
DOSCODE:7A57		     pop     ax
DOSCODE:7A58		     mov     cx, ds:CLUSNUM
DOSCODE:7A5C		     call    FNDCLUS
DOSCODE:7A5F		     jb	     short ACC_ERRWJ
DOSCODE:7A61		     mov     ds:CLUSNUM, bx
DOSCODE:7A65		     mov     ds:LASTPOS, dx
DOSCODE:7A69		     sub     ax, dx
DOSCODE:7A6B		     jz	     short DOWRT
DOSCODE:7A6D		     jcxz    short HAVSTART
DOSCODE:7A6F		     push    cx
DOSCODE:7A70		     mov     cx, ax
DOSCODE:7A72		     call    ALLOCATE
DOSCODE:7A75		     pop     cx
DOSCODE:7A76		     jb	     short WRTERR
DOSCODE:7A78		     mov     dx, ds:LASTPOS
DOSCODE:7A7C		     inc     dx
DOSCODE:7A7D		     dec     cx
DOSCODE:7A7E		     jz	     short NOSKIP
DOSCODE:7A80		     call    SKPCLP
DOSCODE:7A83		     jb	     short ACC_ERRWJ
DOSCODE:7A85
DOSCODE:7A85 NOSKIP:				     ; ...
DOSCODE:7A85		     mov     ds:CLUSNUM, bx
DOSCODE:7A89		     mov     ds:LASTPOS, dx
DOSCODE:7A8D
DOSCODE:7A8D DOWRT:				     ; ...
DOSCODE:7A8D		     cmp     ds:BYTCNT1, 0
DOSCODE:7A92		     jz	     short WRTMID
DOSCODE:7A94		     mov     bx, ds:CLUSNUM
DOSCODE:7A98		     call    BUFWRT
DOSCODE:7A98 ; ---------------------------------------------------------------------------
DOSCODE:7A9B		     db	 72h ; r
DOSCODE:7A9C		     db	0AAh ; ª
DOSCODE:7A9D ; ---------------------------------------------------------------------------
DOSCODE:7A9D
DOSCODE:7A9D WRTMID:				     ; ...
DOSCODE:7A9D		     mov     ax, ds:SECCNT
DOSCODE:7AA0		     or	     ax, ax
DOSCODE:7AA2		     jz	     short WRTLAST
DOSCODE:7AA4		     add     word ptr ds:SECPOS, ax
DOSCODE:7AA8		     adc     word ptr ds:SECPOS+2, 0
DOSCODE:7AAD		     call    NEXTSEC
DOSCODE:7AB0		     jb	     short SET_ACC_ERRW
DOSCODE:7AB2		     mov     ds:TRANS, 1
DOSCODE:7AB7		     mov     dl, ds:SECCLUSPOS
DOSCODE:7ABB		     mov     bx, ds:CLUSNUM
DOSCODE:7ABF		     mov     cx, ds:SECCNT
DOSCODE:7AC3
DOSCODE:7AC3 WRTLP:				     ; ...
DOSCODE:7AC3		     call    OPTIMIZE
DOSCODE:7AC6		     jb	     short SET_ACC_ERRW
DOSCODE:7AC8		     push    di
DOSCODE:7AC9		     push    ax
DOSCODE:7ACA		     call    DskWrtBufPurge
DOSCODE:7ACD		     mov     ds, word ptr ss:DMAADD+2
DOSCODE:7AD2		     mov     ss:ALLOWED, 38h ; Allowed_RETRY+Allowed_FAIL+Allowed_IGNORE
DOSCODE:7AD8		     call    DWRITE
DOSCODE:7ADB		     pop     cx
DOSCODE:7ADC		     pop     bx
DOSCODE:7ADD		     push    ss
DOSCODE:7ADE		     pop     ds
DOSCODE:7ADF		     jb	     short SET_ACC_ERRW
DOSCODE:7AE1		     jcxz    short WRTLAST
DOSCODE:7AE3		     mov     dl, 0
DOSCODE:7AE5		     inc     ds:LASTPOS
DOSCODE:7AE9		     jmp     short WRTLP
DOSCODE:7AEB ; ---------------------------------------------------------------------------
DOSCODE:7AEB
DOSCODE:7AEB WRTLAST:				     ; ...
DOSCODE:7AEB		     mov     ax, ds:BYTCNT2
DOSCODE:7AEE		     or	     ax, ax
DOSCODE:7AF0		     jz	     short FINWRT
DOSCODE:7AF2		     mov     ds:BYTCNT1, ax
DOSCODE:7AF5		     call    NEXTSEC
DOSCODE:7AF8		     jb	     short SET_ACC_ERRW
DOSCODE:7AFA		     mov     ds:BYTSECPOS, 0
DOSCODE:7B00		     call    BUFWRT
DOSCODE:7B00 ; ---------------------------------------------------------------------------
DOSCODE:7B03		     db	 72h ; r
DOSCODE:7B04		     db	 23h ; #
DOSCODE:7B05 ; ---------------------------------------------------------------------------
DOSCODE:7B05
DOSCODE:7B05 FINWRT:				     ; ...
DOSCODE:7B05		     les     di, ds:THISSFT
DOSCODE:7B09		     mov     ax, word ptr ds:GROWCNT
DOSCODE:7B0C		     mov     cx, word ptr ds:GROWCNT+2
DOSCODE:7B10		     or	     ax, ax
DOSCODE:7B12		     jnz     short UPDATE_size
DOSCODE:7B14		     jcxz    short SAMSIZ
DOSCODE:7B16
DOSCODE:7B16 UPDATE_size:			     ; ...
DOSCODE:7B16		     add     es:[di+11h], ax ; [ES:DI+SF_ENTRY.sf_size]
DOSCODE:7B1A		     adc     es:[di+13h], cx ; [ES:DI+SF_ENTRY.sf_size+2]
DOSCODE:7B1E		     mov     ax, 1
DOSCODE:7B21		     call    dword ptr ds:ShSU ; call far [JShare+(14*4)]  ; 14	= ShSU
DOSCODE:7B25
DOSCODE:7B25 SAMSIZ:				     ; ...
DOSCODE:7B25		     jmp     SETCLUS
DOSCODE:7B28 ; ---------------------------------------------------------------------------
DOSCODE:7B28
DOSCODE:7B28 SET_ACC_ERRW:			     ; ...
DOSCODE:7B28		     jmp     SET_ACC_ERR_DS
DOSCODE:7B2B ; ---------------------------------------------------------------------------
DOSCODE:7B2B
DOSCODE:7B2B WRTEOF:				     ; ...
DOSCODE:7B2B		     mov     cx, ax
DOSCODE:7B2D		     or	     cx, dx
DOSCODE:7B2F		     jz	     short KILLFIL
DOSCODE:7B31		     sub     ax, 1
DOSCODE:7B34		     sbb     dx, 0
DOSCODE:7B37		     push    bx
DOSCODE:7B38		     mov     bx, es:[bp+2]   ; [ES:BP+DPB.SECTOR_SIZE]
DOSCODE:7B3C		     call    DIV32
DOSCODE:7B3F		     pop     bx
DOSCODE:7B40		     mov     dx, cx
DOSCODE:7B42		     mov     ds:HIGH_SECTOR, cx
DOSCODE:7B46		     call    SHR32
DOSCODE:7B49		     mov     cx, ax
DOSCODE:7B4B		     call    FNDCLUS
DOSCODE:7B4E
DOSCODE:7B4E SET_ACC_ERRWJ2:			     ; ...
DOSCODE:7B4E		     jb	     short SET_ACC_ERRW
DOSCODE:7B50		     jcxz    short RELFILE
DOSCODE:7B52		     call    ALLOCATE
DOSCODE:7B55		     jb	     short WRTERRJ
DOSCODE:7B57
DOSCODE:7B57 UPDATE:				     ; ...
DOSCODE:7B57		     les     di, ds:THISSFT
DOSCODE:7B5B		     mov     ax, word ptr ds:BYTPOS
DOSCODE:7B5E		     mov     es:[di+11h], ax ; [ES:DI+SF_ENTRY.sf_size]
DOSCODE:7B62		     mov     ax, word ptr ds:BYTPOS+2
DOSCODE:7B65		     mov     es:[di+13h], ax ; [ES:DI+SF_ENTRY.sf_size+2]
DOSCODE:7B69		     mov     ax, 2
DOSCODE:7B6C		     call    dword ptr ds:ShSU ; call far [JShare+(14*4)]
DOSCODE:7B70		     xor     cx, cx
DOSCODE:7B72		     jmp     ADDREC
DOSCODE:7B75 ; ---------------------------------------------------------------------------
DOSCODE:7B75
DOSCODE:7B75 WRTERRJ:				     ; ...
DOSCODE:7B75		     jmp     WRTERR
DOSCODE:7B78 ; ---------------------------------------------------------------------------
DOSCODE:7B78
DOSCODE:7B78 RELFILE:				     ; ...
DOSCODE:7B78		     push    es
DOSCODE:7B79		     les     di, ds:THISSFT
DOSCODE:7B7D		     cmp     dx, es:[di+19h] ; [ES:DI+SF_ENTRY.sf_cluspos]
DOSCODE:7B81		     jnb     short SKIPRESET
DOSCODE:7B83		     mov     word ptr es:[di+19h], 0
DOSCODE:7B89		     mov     dx, es:[di+0Bh] ; [ES:DI+SF_ENTRY.sf_firclus]
DOSCODE:7B8D		     mov     es:[di+35h], dx ; [ES:DI+SF_ENTRY.sf_lstclus]
DOSCODE:7B91
DOSCODE:7B91 SKIPRESET:				     ; ...
DOSCODE:7B91		     pop     es
DOSCODE:7B92		     mov     dx, 0FFFFh
DOSCODE:7B95		     call    RELBLKS
DOSCODE:7B98
DOSCODE:7B98 SET_ACC_ERRWJJ:			     ; ...
DOSCODE:7B98		     jb	     short SET_ACC_ERRWJ2
DOSCODE:7B9A		     jmp     short UPDATE
DOSCODE:7B9C ; ---------------------------------------------------------------------------
DOSCODE:7B9C
DOSCODE:7B9C KILLFIL:				     ; ...
DOSCODE:7B9C		     xor     bx, bx
DOSCODE:7B9E		     push    es
DOSCODE:7B9F		     les     di, ds:THISSFT
DOSCODE:7BA3		     mov     es:[di+19h], bx ; [ES:DI+SF_ENTRY.sf_cluspos]
DOSCODE:7BA7		     mov     es:[di+35h], bx ; [ES:DI+SF_ENTRY.sf_lstclus]
DOSCODE:7BAB		     xchg    bx, es:[di+0Bh] ; [ES:DI+SF_ENTRY.sf_firclus]
DOSCODE:7BAF		     pop     es
DOSCODE:7BB0		     or	     bx, bx
DOSCODE:7BB2		     jz	     short UPDATEJ
DOSCODE:7BB4		     push    es
DOSCODE:7BB5		     push    bp
DOSCODE:7BB6		     push    ax
DOSCODE:7BB7		     push    cx
DOSCODE:7BB8		     push    dx
DOSCODE:7BB9		     les     bp, ds:THISDPB
DOSCODE:7BBD		     mov     dl, es:[bp+0]
DOSCODE:7BC1		     mov     cx, bx
DOSCODE:7BC3		     mov     ah, 2
DOSCODE:7BC5		     call    FastOpen_Update
DOSCODE:7BC8		     pop     dx
DOSCODE:7BC9		     pop     cx
DOSCODE:7BCA		     pop     ax
DOSCODE:7BCB		     pop     bp
DOSCODE:7BCC		     pop     es
DOSCODE:7BCD		     call    RELEASE
DOSCODE:7BD0		     jb	     short SET_ACC_ERRWJJ
DOSCODE:7BD2
DOSCODE:7BD2 UPDATEJ:				     ; ...
DOSCODE:7BD2		     jmp     short UPDATE
DOSCODE:7BD2 DISKWRITE	     endp
DOSCODE:7BD2
DOSCODE:7BD4
DOSCODE:7BD4 ; =============== S U B R O U T I N E =======================================
DOSCODE:7BD4
DOSCODE:7BD4
DOSCODE:7BD4 DskWrtBufPurge  proc near		     ; ...
DOSCODE:7BD4		     push    bx
DOSCODE:7BD5		     push    cx
DOSCODE:7BD6		     mov     bx, ss:HIGH_SECTOR
DOSCODE:7BDB		     mov     si, bx
DOSCODE:7BDD		     add     cx, dx
DOSCODE:7BDF		     adc     si, 0
DOSCODE:7BE2		     mov     al, es:[bp+0]
DOSCODE:7BE6		     cmp     ss:SC_CACHE_COUNT,	0
DOSCODE:7BEC		     jz	     short nosc
DOSCODE:7BEE		     cmp     al, ss:CurSC_DRIVE
DOSCODE:7BF3		     jnz     short nosc
DOSCODE:7BF5		     push    ax
DOSCODE:7BF6		     mov     ax, word ptr ss:CurSC_SECTOR
DOSCODE:7BFA		     mov     di, word ptr ss:CurSC_SECTOR+2
DOSCODE:7BFF		     cmp     si, di
DOSCODE:7C01		     jnz     short sc01
DOSCODE:7C03		     cmp     cx, ax
DOSCODE:7C05
DOSCODE:7C05 sc01:				     ; ...
DOSCODE:7C05		     jbe     short sc5
DOSCODE:7C07		     add     ax, ss:SC_CACHE_COUNT
DOSCODE:7C0C		     adc     di, 0
DOSCODE:7C0F		     cmp     bx, di
DOSCODE:7C11		     jnz     short sc02
DOSCODE:7C13		     cmp     dx, ax
DOSCODE:7C15
DOSCODE:7C15 sc02:				     ; ...
DOSCODE:7C15		     jnb     short sc5
DOSCODE:7C17		     mov     ss:SC_STATUS, 0
DOSCODE:7C1E
DOSCODE:7C1E sc5:				     ; ...
DOSCODE:7C1E		     pop     ax
DOSCODE:7C1F
DOSCODE:7C1F nosc:				     ; ...
DOSCODE:7C1F		     call    GETCURHEAD
DOSCODE:7C22
DOSCODE:7C22 _bufq:				     ; ...
DOSCODE:7C22		     cmp     al, [di+4]	     ; [di+BUFFINFO.buf_ID]
DOSCODE:7C25		     jnz     short bufq5
DOSCODE:7C27		     cmp     bx, [di+8]	     ; [di+BUFFINFO.buf_sector+2]
DOSCODE:7C2A		     jnz     short bufq04
DOSCODE:7C2C		     cmp     dx, [di+6]	     ; [di+BUFFINFO.buf_sector]
DOSCODE:7C2F
DOSCODE:7C2F bufq04:				     ; ...
DOSCODE:7C2F		     ja	     short bufq5
DOSCODE:7C31		     cmp     si, [di+8]
DOSCODE:7C34		     jnz     short bufq05
DOSCODE:7C36		     cmp     cx, [di+6]
DOSCODE:7C39
DOSCODE:7C39 bufq05:				     ; ...
DOSCODE:7C39		     jbe     short bufq5
DOSCODE:7C3B		     test    byte ptr [di+5], 40h ; [di+BUFFINFO.buf_flags],
DOSCODE:7C3B					     ; buf_dirty
DOSCODE:7C3F		     jz	     short bufq4
DOSCODE:7C41		     call    DEC_DIRTY_COUNT
DOSCODE:7C44
DOSCODE:7C44 bufq4:				     ; ...
DOSCODE:7C44		     mov     word ptr [di+4], 20FFh ; [di+BUFFINFO.buf_ID],
DOSCODE:7C44					     ; ((buf_visit<<8)|0FFh)
DOSCODE:7C49		     call    SCANPLACE
DOSCODE:7C4C		     jmp     short bufq6
DOSCODE:7C4E ; ---------------------------------------------------------------------------
DOSCODE:7C4E
DOSCODE:7C4E bufq5:				     ; ...
DOSCODE:7C4E		     mov     di, [di]	     ; [di+BUFFINFO.buf_next]
DOSCODE:7C50
DOSCODE:7C50 bufq6:				     ; ...
DOSCODE:7C50		     cmp     di, ss:FIRST_BUFF_ADDR
DOSCODE:7C55		     jnz     short _bufq
DOSCODE:7C57		     pop     cx
DOSCODE:7C58		     pop     bx
DOSCODE:7C59		     retn
DOSCODE:7C59 DskWrtBufPurge  endp
DOSCODE:7C59
DOSCODE:7C5A
DOSCODE:7C5A ; =============== S U B R O U T I N E =======================================
DOSCODE:7C5A
DOSCODE:7C5A
DOSCODE:7C5A DIV32	     proc near		     ; ...
DOSCODE:7C5A		     cmp     bx, 512
DOSCODE:7C5E		     jnz     short div5
DOSCODE:7C60		     mov     cx, dx
DOSCODE:7C62		     mov     dx, ax	     ; CX:AX = Dividend
DOSCODE:7C62					     ; DX = Remainder
DOSCODE:7C64		     and     dx, 1FFh	     ; 511
DOSCODE:7C68		     mov     al, ah
DOSCODE:7C6A		     mov     ah, cl
DOSCODE:7C6C		     mov     cl, ch
DOSCODE:7C6E		     xor     ch, ch
DOSCODE:7C70		     shr     cx, 1
DOSCODE:7C72		     rcr     ax, 1
DOSCODE:7C74		     retn
DOSCODE:7C75 ; ---------------------------------------------------------------------------
DOSCODE:7C75
DOSCODE:7C75 div5:				     ; ...
DOSCODE:7C75		     mov     cx, ax
DOSCODE:7C77		     mov     ax, dx
DOSCODE:7C79		     xor     dx, dx
DOSCODE:7C7B		     div     bx		     ; 0:AX/BX
DOSCODE:7C7D		     xchg    ax, cx
DOSCODE:7C7E		     div     bx		     ; DX:AX/BX
DOSCODE:7C80		     retn
DOSCODE:7C80 DIV32	     endp
DOSCODE:7C80
DOSCODE:7C81
DOSCODE:7C81 ; =============== S U B R O U T I N E =======================================
DOSCODE:7C81
DOSCODE:7C81
DOSCODE:7C81 SHR32	     proc near		     ; ...
DOSCODE:7C81		     mov     cl, es:[bp+5]   ; [ES:BP+DPB.CLUSTER_SHIFT]
DOSCODE:7C85		     xor     ch, ch
DOSCODE:7C87		     jcxz    short norota
DOSCODE:7C89
DOSCODE:7C89 rotashft2:				     ; ...
DOSCODE:7C89		     shr     dx, 1
DOSCODE:7C8B		     rcr     ax, 1
DOSCODE:7C8D		     loop    rotashft2
DOSCODE:7C8F
DOSCODE:7C8F norota:				     ; ...
DOSCODE:7C8F		     retn
DOSCODE:7C8F SHR32	     endp
DOSCODE:7C8F
DOSCODE:7C90
DOSCODE:7C90 ; =============== S U B R O U T I N E =======================================
DOSCODE:7C90
DOSCODE:7C90
DOSCODE:7C90 FINDENTRY	     proc near		     ; ...
DOSCODE:7C90		     call    STARTSRCH
DOSCODE:7C93		     mov     al, ds:ATTRIB
DOSCODE:7C96		     and     al, 9Eh	     ; ~attr_ignore
DOSCODE:7C98		     cmp     al, 8	     ; attr_volume_id
DOSCODE:7C9A		     jnz     short NOTVOLSRCH
DOSCODE:7C9C		     call    SETROOTSRCH
DOSCODE:7C9F
DOSCODE:7C9F NOTVOLSRCH:			     ; ...
DOSCODE:7C9F		     call    GETENTRY
DOSCODE:7CA2		     jnb     short SRCH
DOSCODE:7CA4		     jmp     SETESRET
DOSCODE:7CA7 ; ---------------------------------------------------------------------------
DOSCODE:7CA7
DOSCODE:7CA7 SRCH:				     ; ...
DOSCODE:7CA7		     push    ds
DOSCODE:7CA8		     mov     ds, word ptr ds:CURBUF+2
DOSCODE:7CAC		     mov     ah, [bx]	     ; [BX+dir_entry.dir_name] ; mov ah,[bx+0]
DOSCODE:7CAE		     or	     ah, ah
DOSCODE:7CB0		     jz	     short FREE
DOSCODE:7CB2		     cmp     ah, ss:DELALL
DOSCODE:7CB7		     jz	     short FREE
DOSCODE:7CB9		     test    byte ptr [bx+0Bh],	8 ; [BX+dir_entry.dir_attr],
DOSCODE:7CB9					     ; attr_volume_id
DOSCODE:7CBD		     jz	     short CHKFNAM
DOSCODE:7CBF		     inc     ss:VOLID
DOSCODE:7CC4
DOSCODE:7CC4 CHKFNAM:				     ; ...
DOSCODE:7CC4		     mov     si, ss
DOSCODE:7CC6		     mov     es, si
DOSCODE:7CC8		     mov     si, bx
DOSCODE:7CCA		     mov     di, offset	NAME1
DOSCODE:7CCD		     cmp     ss:NAME1, 0E5h
DOSCODE:7CD3		     jnz     short NO_E5
DOSCODE:7CD5		     mov     ss:NAME1, 5
DOSCODE:7CDB
DOSCODE:7CDB NO_E5:				     ; ...
DOSCODE:7CDB		     call    MetaCompare
DOSCODE:7CDE		     jz	     short FOUND
DOSCODE:7CE0		     pop     ds
DOSCODE:7CE1
DOSCODE:7CE1 NEXTENT:				     ; ...
DOSCODE:7CE1		     les     bp, ds:THISDPB
DOSCODE:7CE5		     call    NEXTENTRY
DOSCODE:7CE8		     jnb     short SRCH
DOSCODE:7CEA		     jmp     short SETESRET
DOSCODE:7CEC ; ---------------------------------------------------------------------------
DOSCODE:7CEC
DOSCODE:7CEC FREE:				     ; ...
DOSCODE:7CEC		     pop     ds
DOSCODE:7CED		     mov     cx, ds:LASTENT
DOSCODE:7CF1		     cmp     cx, ds:ENTFREE
DOSCODE:7CF5		     jnb     short TSTALL
DOSCODE:7CF7		     mov     ds:ENTFREE, cx
DOSCODE:7CFB
DOSCODE:7CFB TSTALL:				     ; ...
DOSCODE:7CFB		     cmp     ah, ds:DELALL
DOSCODE:7CFF
DOSCODE:7CFF NEXTENTJ:				     ; ...
DOSCODE:7CFF		     jz	     short NEXTENT
DOSCODE:7D01		     mov     ds:ENTLAST, cx
DOSCODE:7D05		     stc
DOSCODE:7D06		     jmp     short SETESRET
DOSCODE:7D08 ; ---------------------------------------------------------------------------
DOSCODE:7D08
DOSCODE:7D08 FOUND:				     ; ...
DOSCODE:7D08		     mov     ch, [si]
DOSCODE:7D0A		     pop     ds
DOSCODE:7D0B		     mov     ah, ds:ATTRIB
DOSCODE:7D0F		     and     ah, 9Eh	     ; ~attr_ignore
DOSCODE:7D12		     lea     si, [si+15]     ; [SI+dir_entry.dir_first-dir_entry.dir_attr]
DOSCODE:7D15		     test    ch, 8	     ; attr_volume_id
DOSCODE:7D18		     jz	     short check_one_volume_id
DOSCODE:7D1A		     test    ah, 8	     ; attr_volume_id
DOSCODE:7D1D		     jz	     short NEXTENTJ
DOSCODE:7D1F		     xor     ah, ah
DOSCODE:7D21		     jmp     short RETFF
DOSCODE:7D23 ; ---------------------------------------------------------------------------
DOSCODE:7D23
DOSCODE:7D23 check_one_volume_id:		     ; ...
DOSCODE:7D23		     cmp     ah, 8
DOSCODE:7D26		     jz	     short NEXTENTJ
DOSCODE:7D28		     call    MatchAttributes
DOSCODE:7D2B		     jz	     short RETFF
DOSCODE:7D2D		     test    ds:CREATING, 0FFh ; -1
DOSCODE:7D32		     jz	     short NEXTENTJ
DOSCODE:7D34
DOSCODE:7D34 RETFF:				     ; ...
DOSCODE:7D34		     les     bp, ds:THISDPB
DOSCODE:7D38		     mov     ah, es:[bp+0]   ; [ES:BP+DPB.DRIVE]
DOSCODE:7D3C
DOSCODE:7D3C SETESRET:				     ; ...
DOSCODE:7D3C		     push    ss
DOSCODE:7D3D		     pop     es
DOSCODE:7D3E		     retn
DOSCODE:7D3E FINDENTRY	     endp
DOSCODE:7D3E
DOSCODE:7D3F
DOSCODE:7D3F ; =============== S U B R O U T I N E =======================================
DOSCODE:7D3F
DOSCODE:7D3F
DOSCODE:7D3F MetaCompare     proc near		     ; ...
DOSCODE:7D3F		     mov     cx, 11
DOSCODE:7D42
DOSCODE:7D42 WILDCRD:				     ; ...
DOSCODE:7D42		     repe cmpsb
DOSCODE:7D44		     jz	     short MetaRet
DOSCODE:7D46
DOSCODE:7D46 CHECK_META:			     ; 3Fh
DOSCODE:7D46		     cmp     byte ptr es:[di-1], '?'
DOSCODE:7D4B		     jz	     short WILDCRD
DOSCODE:7D4D
DOSCODE:7D4D MetaRet:				     ; ...
DOSCODE:7D4D		     retn
DOSCODE:7D4D MetaCompare     endp
DOSCODE:7D4D
DOSCODE:7D4E
DOSCODE:7D4E ; =============== S U B R O U T I N E =======================================
DOSCODE:7D4E
DOSCODE:7D4E
DOSCODE:7D4E NEXTENTRY	     proc near		     ; ...
DOSCODE:7D4E		     mov     ax, ds:LASTENT
DOSCODE:7D51		     cmp     ax, ds:ENTLAST
DOSCODE:7D55		     jz	     short NONE
DOSCODE:7D57		     inc     ax
DOSCODE:7D58		     lea     bx, [bx+32]
DOSCODE:7D5B		     cmp     bx, dx
DOSCODE:7D5D		     jb	     short HAVIT
DOSCODE:7D5F		     mov     bl, ds:SECCLUSPOS
DOSCODE:7D63		     inc     bl
DOSCODE:7D65		     cmp     bl, ds:CLUSFAC
DOSCODE:7D69		     jb	     short SAMECLUS
DOSCODE:7D6B		     mov     bx, ds:NXTCLUSNUM
DOSCODE:7D6F		     call    IsEOF
DOSCODE:7D72		     jnb     short NONE
DOSCODE:7D74		     cmp     bx, 2
DOSCODE:7D77		     jb	     short NONE
DOSCODE:7D79		     jmp     short GETENT
DOSCODE:7D7B ; ---------------------------------------------------------------------------
DOSCODE:7D7B
DOSCODE:7D7B NONE:				     ; ...
DOSCODE:7D7B		     stc
DOSCODE:7D7C		     retn
DOSCODE:7D7D ; ---------------------------------------------------------------------------
DOSCODE:7D7D
DOSCODE:7D7D HAVIT:				     ; ...
DOSCODE:7D7D		     mov     ds:LASTENT, ax
DOSCODE:7D80		     clc
DOSCODE:7D81
DOSCODE:7D81 nextentry_retn:			     ; ...
DOSCODE:7D81		     retn
DOSCODE:7D82 ; ---------------------------------------------------------------------------
DOSCODE:7D82
DOSCODE:7D82 SAMECLUS:				     ; ...
DOSCODE:7D82		     mov     ds:SECCLUSPOS, bl
DOSCODE:7D86		     mov     ds:LASTENT, ax
DOSCODE:7D89		     push    ds
DOSCODE:7D8A		     lds     di, ds:CURBUF
DOSCODE:7D8E		     mov     dx, [di+8]	     ; [DI+BUFFINFO.buf_sector+2]
DOSCODE:7D91		     mov     ss:HIGH_SECTOR, dx
DOSCODE:7D96		     mov     dx, [di+6]	     ; [DI+BUFFINFO.buf_sector]
DOSCODE:7D99		     add     dx, 1
DOSCODE:7D9C		     adc     ss:HIGH_SECTOR, 0
DOSCODE:7DA2		     pop     ds
DOSCODE:7DA3		     call    FIRSTCLUSTER
DOSCODE:7DA6		     xor     bx, bx
DOSCODE:7DA8		     jmp     short SETENTRY
DOSCODE:7DA8 NEXTENTRY	     endp
DOSCODE:7DA8
DOSCODE:7DAA
DOSCODE:7DAA ; =============== S U B R O U T I N E =======================================
DOSCODE:7DAA
DOSCODE:7DAA
DOSCODE:7DAA GETENTRY	     proc near		     ; ...
DOSCODE:7DAA		     mov     ax, ds:LASTENT
DOSCODE:7DAD
DOSCODE:7DAD GETENT:				     ; ...
DOSCODE:7DAD		     mov     ds:LASTENT, ax
DOSCODE:7DB0		     mov     cl, 5
DOSCODE:7DB2		     rol     ax, cl	     ; * 32
DOSCODE:7DB4		     mov     dx, ax
DOSCODE:7DB6		     and     ax, 0FFE0h	     ; ~(32-1)
DOSCODE:7DB9		     and     dx, 1Fh	     ; 32-1
DOSCODE:7DBC		     mov     bx, es:[bp+2]   ; [ES:BP+DPB.SECTOR_SIZE]
DOSCODE:7DC0		     and     bl, 0E0h	     ; 255-31
DOSCODE:7DC3		     div     bx
DOSCODE:7DC5		     mov     bx, dx
DOSCODE:7DC7		     push    bx
DOSCODE:7DC8		     call    DIRREAD
DOSCODE:7DCB		     pop     bx
DOSCODE:7DCC		     jb	     short nextentry_retn
DOSCODE:7DCE
DOSCODE:7DCE SETENTRY:				     ; ...
DOSCODE:7DCE		     mov     dx, word ptr ds:CURBUF
DOSCODE:7DD2		     add     dx, 20	     ; BUFINSIZ
DOSCODE:7DD5		     add     bx, dx
DOSCODE:7DD7		     add     dx, es:[bp+2]   ; [ES:BP+DPB.SECTOR_SIZE]
DOSCODE:7DDB		     retn
DOSCODE:7DDB GETENTRY	     endp
DOSCODE:7DDB
DOSCODE:7DDC
DOSCODE:7DDC ; =============== S U B R O U T I N E =======================================
DOSCODE:7DDC
DOSCODE:7DDC
DOSCODE:7DDC SETDIRSRCH	     proc near		     ; ...
DOSCODE:7DDC		     or	     bx, bx
DOSCODE:7DDE		     jz	     short SETROOTSRCH
DOSCODE:7DE0		     mov     ds:DIRSTART, bx
DOSCODE:7DE4		     mov     al, es:[bp+4]   ; [ES:BP+DPB.CLUSTER_MASK]
DOSCODE:7DE8		     inc     al
DOSCODE:7DEA		     mov     ds:CLUSFAC, al
DOSCODE:7DED		     push    si
DOSCODE:7DEE		     test    ds:FastOpenFlg, 2 ; Lookup_Success
DOSCODE:7DF3		     jnz     short UNP_OK
DOSCODE:7DF5		     call    UNPACK
DOSCODE:7DF8		     jnb     short UNP_OK
DOSCODE:7DFA		     pop     si
DOSCODE:7DFB		     retn
DOSCODE:7DFC ; ---------------------------------------------------------------------------
DOSCODE:7DFC
DOSCODE:7DFC UNP_OK:				     ; ...
DOSCODE:7DFC		     mov     ds:CLUSNUM, di
DOSCODE:7E00		     mov     dx, bx
DOSCODE:7E02		     xor     bl, bl
DOSCODE:7E04		     mov     ds:SECCLUSPOS, bl
DOSCODE:7E08		     call    FIGREC
DOSCODE:7E0B		     pop     si
DOSCODE:7E0C		     push    dx
DOSCODE:7E0D		     mov     dx, ds:HIGH_SECTOR
DOSCODE:7E11		     mov     word ptr ds:DIRSEC+2, dx
DOSCODE:7E15		     pop     dx
DOSCODE:7E16		     mov     word ptr ds:DIRSEC, dx
DOSCODE:7E1A		     clc
DOSCODE:7E1B		     retn
DOSCODE:7E1B SETDIRSRCH	     endp
DOSCODE:7E1B
DOSCODE:7E1C
DOSCODE:7E1C ; =============== S U B R O U T I N E =======================================
DOSCODE:7E1C
DOSCODE:7E1C
DOSCODE:7E1C SETROOTSRCH     proc near		     ; ...
DOSCODE:7E1C		     xor     ax, ax
DOSCODE:7E1E		     mov     ds:DIRSTART, ax
DOSCODE:7E21		     mov     ds:SECCLUSPOS, al
DOSCODE:7E24		     dec     ax
DOSCODE:7E25		     mov     ds:CLUSNUM, ax
DOSCODE:7E28		     mov     ax, es:[bp+0Bh] ; [ES:BP+DPB.FIRST_SECTOR]
DOSCODE:7E2C		     mov     dx, es:[bp+11h] ; [ES:BP+DPB.DIR_SECTOR]
DOSCODE:7E30		     sub     ax, dx
DOSCODE:7E32		     mov     ds:CLUSFAC, al
DOSCODE:7E35		     mov     word ptr ds:DIRSEC, dx
DOSCODE:7E39		     mov     word ptr ds:DIRSEC+2, 0
DOSCODE:7E3F		     clc
DOSCODE:7E40		     retn
DOSCODE:7E40 SETROOTSRCH     endp
DOSCODE:7E40
DOSCODE:7E41
DOSCODE:7E41 ; =============== S U B R O U T I N E =======================================
DOSCODE:7E41
DOSCODE:7E41
DOSCODE:7E41 GETPATH	     proc near		     ; ...
DOSCODE:7E41
DOSCODE:7E41 ; FUNCTION	CHUNK AT DOSCODE:7F47 SIZE 000001A5 BYTES
DOSCODE:7E41
DOSCODE:7E41		     mov     word ptr ds:CREATING, 0E500h ; DIRFREE*256+0
DOSCODE:7E47
DOSCODE:7E47 GetPathNoSet:			     ; ...
DOSCODE:7E47		     mov     ds:EXTERR_LOCUS, 2	; errLOC_Disk
DOSCODE:7E4C		     mov     word ptr ds:CURBUF, -1 ; 0FFFFh
DOSCODE:7E52		     mov     di, ds:WFP_START
DOSCODE:7E56		     cmp     word ptr [di+1], 5C3Ah ; '\' << 8 + ':'
DOSCODE:7E5B		     jz	     short CrackIt
DOSCODE:7E5D		     add     di, 3
DOSCODE:7E60		     mov     si, di
DOSCODE:7E62		     call    CHKDEV
DOSCODE:7E65		     jb	     short InternalError
DOSCODE:7E67
DOSCODE:7E67 Build_devJ:			     ; ...
DOSCODE:7E67		     mov     al, ds:SATTRIB
DOSCODE:7E6A		     mov     ds:ATTRIB,	al
DOSCODE:7E6D		     mov     ds:EXTERR_LOCUS, 1	; errLOC_Unk
DOSCODE:7E72		     push    ss
DOSCODE:7E73		     pop     es
DOSCODE:7E74		     mov     si, offset	NAME1
DOSCODE:7E77		     mov     di, ds:WFP_START
DOSCODE:7E7B		     mov     dx, di
DOSCODE:7E7D		     mov     cx, 8
DOSCODE:7E80
DOSCODE:7E80 MoveLoop:				     ; ...
DOSCODE:7E80		     lodsb
DOSCODE:7E81		     stosb
DOSCODE:7E82		     cmp     al, 20h ; ' '
DOSCODE:7E84		     jz	     short NoSave
DOSCODE:7E86		     mov     dx, di
DOSCODE:7E88
DOSCODE:7E88 NoSave:				     ; ...
DOSCODE:7E88		     loop    MoveLoop
DOSCODE:7E8A		     mov     di, dx
DOSCODE:7E8C		     mov     byte ptr [di], 0
DOSCODE:7E8F		     call    Build_device_ent
DOSCODE:7E92		     inc     al
DOSCODE:7E94		     retn
DOSCODE:7E95 ; ---------------------------------------------------------------------------
DOSCODE:7E95
DOSCODE:7E95 InternalError:			     ; ...
DOSCODE:7E95		     jmp     short InternalError
DOSCODE:7E97 ; ---------------------------------------------------------------------------
DOSCODE:7E97
DOSCODE:7E97 CrackIt:				     ; ...
DOSCODE:7E97		     mov     si, ds:CURR_DIR_END
DOSCODE:7E9B		     cmp     si, -1	     ; 0FFFFh
DOSCODE:7E9E		     jnz     short LOOK_SING
DOSCODE:7EA0		     lea     si, [di+3]
DOSCODE:7EA3
DOSCODE:7EA3 LOOK_SING:				     ; ...
DOSCODE:7EA3		     mov     ds:ATTRIB,	16h  ; attr_directory+attr_system+attr_hidden
DOSCODE:7EA8		     les     di, ds:THISCDS
DOSCODE:7EAC		     mov     ax, 0FFFFh	     ; -1
DOSCODE:7EAF		     mov     bx, es:[di+49h] ; [ES:DI+curdir.ID]
DOSCODE:7EB3		     mov     si, ds:CURR_DIR_END
DOSCODE:7EB7		     cmp     si, ax
DOSCODE:7EB9		     jz	     short NO_CURR_D
DOSCODE:7EBB		     cmp     bx, ax
DOSCODE:7EBD		     jz	     short NO_CURR_D
DOSCODE:7EBF		     test    ds:FastOpenFlg, 1 ; FastOpen_Set
DOSCODE:7EC4		     jz	     short GOT_SEARCH_CLUSTER
DOSCODE:7EC6		     push    es
DOSCODE:7EC7		     push    di
DOSCODE:7EC8		     push    cx
DOSCODE:7EC9		     push    word ptr [si-1]
DOSCODE:7ECC		     push    si
DOSCODE:7ECD		     push    bx
DOSCODE:7ECE		     mov     byte ptr [si-1], 0
DOSCODE:7ED2		     mov     si, ds:WFP_START
DOSCODE:7ED6		     mov     bx, offset	FastOpenTable
DOSCODE:7ED9		     mov     di, offset	Dir_Info_Buff
DOSCODE:7EDC		     mov     cx, offset	FastOpen_Ext_Info
DOSCODE:7EDF		     mov     al, 1	     ; FONC_Look_up
DOSCODE:7EE1		     push    ds
DOSCODE:7EE2		     pop     es
DOSCODE:7EE3		     call    dword ptr [bx+2] ;	CALL far [BX+fastopen_entry.name_caching]
DOSCODE:7EE6		     jb	     short GO_Chk_end1
DOSCODE:7EE8		     cmp     byte ptr [si], 0
DOSCODE:7EEB		     jz	     short GO_Chk_end
DOSCODE:7EED		     stc
DOSCODE:7EEE		     jmp     short GO_Chk_end
DOSCODE:7EF0 ; ---------------------------------------------------------------------------
DOSCODE:7EF0
DOSCODE:7EF0 GO_Chk_end1:			     ; ...
DOSCODE:7EF0		     clc
DOSCODE:7EF1
DOSCODE:7EF1 GO_Chk_end:			     ; ...
DOSCODE:7EF1		     pop     bx
DOSCODE:7EF2		     pop     si
DOSCODE:7EF3		     pop     word ptr [si-1]
DOSCODE:7EF6		     pop     cx
DOSCODE:7EF7		     pop     di
DOSCODE:7EF8		     pop     es
DOSCODE:7EF9		     jnb     short GOT_SEARCH_CLUSTER
DOSCODE:7EFB
DOSCODE:7EFB NO_CURR_D:				     ; ...
DOSCODE:7EFB		     mov     si, ds:WFP_START
DOSCODE:7EFF		     lea     si, [si+3]
DOSCODE:7F02		     les     bp, ds:THISDPB
DOSCODE:7F06		     jmp     short ROOTPATH
DOSCODE:7F08 ; ---------------------------------------------------------------------------
DOSCODE:7F08
DOSCODE:7F08 GOT_SEARCH_CLUSTER:		     ; ...
DOSCODE:7F08		     les     bp, ds:THISDPB
DOSCODE:7F0C		     call    SETDIRSRCH
DOSCODE:7F0F		     jb	     short SETFERR
DOSCODE:7F11		     jmp     short FINDPATH
DOSCODE:7F13 ; ---------------------------------------------------------------------------
DOSCODE:7F13
DOSCODE:7F13 SETFERR:				     ; ...
DOSCODE:7F13		     xor     cl, cl
DOSCODE:7F15		     stc
DOSCODE:7F16		     retn
DOSCODE:7F16 GETPATH	     endp
DOSCODE:7F16
DOSCODE:7F17
DOSCODE:7F17 ; =============== S U B R O U T I N E =======================================
DOSCODE:7F17
DOSCODE:7F17
DOSCODE:7F17 CHKDEV	     proc near		     ; ...
DOSCODE:7F17		     mov     si, di
DOSCODE:7F19		     mov     di, ss
DOSCODE:7F1B		     mov     es, di
DOSCODE:7F1D		     mov     di, offset	NAME1
DOSCODE:7F20		     mov     cx, 9
DOSCODE:7F23
DOSCODE:7F23 TESTLOOP:				     ; ...
DOSCODE:7F23		     call    GETLET
DOSCODE:7F26		     cmp     al, 2Eh ; '.'
DOSCODE:7F28		     jz	     short TESTDEVICE
DOSCODE:7F2A		     call    PATHCHRCMP
DOSCODE:7F2D		     jz	     short NOTDEV
DOSCODE:7F2F		     or	     al, al
DOSCODE:7F31		     jz	     short TESTDEVICE
DOSCODE:7F33		     stosb
DOSCODE:7F34		     loop    TESTLOOP
DOSCODE:7F36
DOSCODE:7F36 NOTDEV:				     ; ...
DOSCODE:7F36		     stc
DOSCODE:7F37		     retn
DOSCODE:7F38 ; ---------------------------------------------------------------------------
DOSCODE:7F38
DOSCODE:7F38 TESTDEVICE:			     ; ...
DOSCODE:7F38		     add     cx, 2
DOSCODE:7F3B		     mov     al, 20h ; ' '
DOSCODE:7F3D		     rep stosb
DOSCODE:7F3F		     mov     ax, ss
DOSCODE:7F41		     mov     ds, ax
DOSCODE:7F43		     call    DEVNAME
DOSCODE:7F46		     retn
DOSCODE:7F46 CHKDEV	     endp
DOSCODE:7F46
DOSCODE:7F47 ; ---------------------------------------------------------------------------
DOSCODE:7F47 ; START OF	FUNCTION CHUNK FOR GETPATH
DOSCODE:7F47
DOSCODE:7F47 ROOTPATH:				     ; ...
DOSCODE:7F47		     call    SETROOTSRCH
DOSCODE:7F4A		     cmp     byte ptr [si], 0
DOSCODE:7F4D		     jnz     short FINDPATH
DOSCODE:7F4F		     mov     al, ds:SATTRIB
DOSCODE:7F52		     mov     ds:ATTRIB,	al
DOSCODE:7F55		     xor     ah, ah
DOSCODE:7F57		     retn
DOSCODE:7F58 ; ---------------------------------------------------------------------------
DOSCODE:7F58
DOSCODE:7F58 FINDPATH:				     ; ...
DOSCODE:7F58		     push    es
DOSCODE:7F59		     push    si
DOSCODE:7F5A		     mov     di, si
DOSCODE:7F5C		     mov     cx, ds:DIRSTART
DOSCODE:7F60		     cmp     ds:CURR_DIR_END, 0FFFFh ; -1
DOSCODE:7F65		     jz	     short NOIDS
DOSCODE:7F67		     cmp     di, ds:CURR_DIR_END
DOSCODE:7F6B		     jnz     short NOIDS
DOSCODE:7F6D		     les     di, ds:THISCDS
DOSCODE:7F71		     mov     es:[di+49h], cx ; [ES:DI+curdir.ID]
DOSCODE:7F75
DOSCODE:7F75 NOIDS:				     ; ...
DOSCODE:7F75		     mov     ax, ss
DOSCODE:7F77		     mov     es, ax
DOSCODE:7F79		     mov     di, offset	NAME1
DOSCODE:7F7C		     mov     ax, 2020h	     ; '  '
DOSCODE:7F7F		     stosb
DOSCODE:7F80		     stosw
DOSCODE:7F81		     stosw
DOSCODE:7F82		     stosw
DOSCODE:7F83		     stosw
DOSCODE:7F84		     stosw
DOSCODE:7F85		     mov     di, offset	NAME1
DOSCODE:7F88		     xor     ah, ah
DOSCODE:7F8A
DOSCODE:7F8A GetNam:				     ; ...
DOSCODE:7F8A		     inc     cl
DOSCODE:7F8C		     lodsb
DOSCODE:7F8D		     cmp     al, 2Eh ; '.'
DOSCODE:7F8F		     jz	     short _SetExt
DOSCODE:7F91		     or	     al, al
DOSCODE:7F93		     jz	     short _GetDone
DOSCODE:7F95		     cmp     al, 5Ch ; '\'
DOSCODE:7F97		     jz	     short _GetDone
DOSCODE:7F99		     cmp     al, 3Fh ; '?'
DOSCODE:7F9B		     jnz     short StoNam
DOSCODE:7F9D		     or	     ah, 1
DOSCODE:7FA0
DOSCODE:7FA0 StoNam:				     ; ...
DOSCODE:7FA0		     stosb
DOSCODE:7FA1		     jmp     short GetNam
DOSCODE:7FA3 ; ---------------------------------------------------------------------------
DOSCODE:7FA3
DOSCODE:7FA3 _SetExt:				     ; ...
DOSCODE:7FA3		     mov     di, (offset NAME1+8)
DOSCODE:7FA6
DOSCODE:7FA6 GetExt:				     ; ...
DOSCODE:7FA6		     lodsb
DOSCODE:7FA7		     or	     al, al
DOSCODE:7FA9		     jz	     short _GetDone
DOSCODE:7FAB		     cmp     al, 5Ch ; '\'
DOSCODE:7FAD		     jz	     short _GetDone
DOSCODE:7FAF		     cmp     al, 3Fh ; '?'
DOSCODE:7FB1		     jnz     short StoExt
DOSCODE:7FB3		     or	     ah, 1
DOSCODE:7FB6
DOSCODE:7FB6 StoExt:				     ; ...
DOSCODE:7FB6		     stosb
DOSCODE:7FB7		     jmp     short GetExt
DOSCODE:7FB9 ; ---------------------------------------------------------------------------
DOSCODE:7FB9
DOSCODE:7FB9 _GetDone:				     ; ...
DOSCODE:7FB9		     dec     si
DOSCODE:7FBA		     mov     cl, ah
DOSCODE:7FBC		     or	     cl, 80h
DOSCODE:7FBF		     pop     di
DOSCODE:7FC0		     pop     es
DOSCODE:7FC1		     cmp     si, di
DOSCODE:7FC3		     jnz     short check_device
DOSCODE:7FC5		     jmp     _BADPATH
DOSCODE:7FC8 ; ---------------------------------------------------------------------------
DOSCODE:7FC8
DOSCODE:7FC8 check_device:			     ; ...
DOSCODE:7FC8		     push    si
DOSCODE:7FC9		     mov     al, [si]
DOSCODE:7FCB		     or	     al, al
DOSCODE:7FCD		     jnz     short NOT_LAST
DOSCODE:7FCF		     mov     bh, ds:SATTRIB
DOSCODE:7FD3		     mov     ds:ATTRIB,	bh
DOSCODE:7FD7
DOSCODE:7FD7 NOT_LAST:				     ; ...
DOSCODE:7FD7		     push    es
DOSCODE:7FD8		     push    ss
DOSCODE:7FD9		     pop     es
DOSCODE:7FDA		     call    DEVNAME
DOSCODE:7FDD		     pop     es
DOSCODE:7FDE		     jb	     short FindFile
DOSCODE:7FE0		     or	     al, al
DOSCODE:7FE2		     jz	     short GO_BDEV
DOSCODE:7FE4		     jmp     FILEINPATH
DOSCODE:7FE7 ; ---------------------------------------------------------------------------
DOSCODE:7FE7
DOSCODE:7FE7 GO_BDEV:				     ; ...
DOSCODE:7FE7		     pop     si
DOSCODE:7FE8		     jmp     Build_devJ
DOSCODE:7FEB ; ---------------------------------------------------------------------------
DOSCODE:7FEB
DOSCODE:7FEB FindFile:				     ; ...
DOSCODE:7FEB		     cmp     ds:NAME1, 0E5h
DOSCODE:7FF0		     jnz     short NOE5
DOSCODE:7FF2		     mov     ds:NAME1, 5
DOSCODE:7FF7
DOSCODE:7FF7 NOE5:				     ; ...
DOSCODE:7FF7		     push    di
DOSCODE:7FF8		     push    es
DOSCODE:7FF9		     push    cx
DOSCODE:7FFA		     call    LookupPath
DOSCODE:7FFD		     jnb     short DIR_FOUND
DOSCODE:7FFF		     call    FINDENTRY
DOSCODE:8002
DOSCODE:8002 DIR_FOUND:				     ; ...
DOSCODE:8002		     pop     cx
DOSCODE:8003		     pop     es
DOSCODE:8004		     pop     di
DOSCODE:8005		     jnb     short LOAD_BUF
DOSCODE:8007		     jmp     BADPATHPOP
DOSCODE:800A ; ---------------------------------------------------------------------------
DOSCODE:800A
DOSCODE:800A LOAD_BUF:				     ; ...
DOSCODE:800A		     lds     di, ds:CURBUF
DOSCODE:800E		     test    byte ptr [bx+0Bh],	10h ; [BX+dir_entry.dir_attr],
DOSCODE:800E					     ; attr_directory
DOSCODE:8012		     jnz     short GO_NEXT
DOSCODE:8014		     jmp     FILEINPATH
DOSCODE:8017 ; ---------------------------------------------------------------------------
DOSCODE:8017
DOSCODE:8017 GO_NEXT:				     ; ...
DOSCODE:8017		     cmp     ss:NoSetDir, 0
DOSCODE:801D		     jz	     short SetDir
DOSCODE:801F		     mov     dx, di
DOSCODE:8021		     mov     cx, ds
DOSCODE:8023		     push    ss
DOSCODE:8024		     pop     ds
DOSCODE:8025		     pop     di
DOSCODE:8026		     test    ds:FastOpenFlg, 1 ; FastOpen_Set
DOSCODE:802B		     jz	     short _nofast
DOSCODE:802D		     test    ds:FastOpenFlg, 2 ; Lookup_Success
DOSCODE:8032		     jz	     short _nofast
DOSCODE:8034		     mov     di, ds:Next_Element_Start
DOSCODE:8038
DOSCODE:8038 _nofast:				     ; ...
DOSCODE:8038		     cmp     byte ptr [di], 0
DOSCODE:803B		     jnz     short NEXT_ONE
DOSCODE:803D		     jmp     _SETRET
DOSCODE:8040 ; ---------------------------------------------------------------------------
DOSCODE:8040
DOSCODE:8040 NEXT_ONE:				     ; ...
DOSCODE:8040		     push    di
DOSCODE:8041		     mov     di, dx
DOSCODE:8043		     mov     ds, cx
DOSCODE:8045
DOSCODE:8045 SetDir:				     ; ...
DOSCODE:8045		     mov     dx, [si]
DOSCODE:8047		     push    ds
DOSCODE:8048		     push    ss
DOSCODE:8049		     pop     ds
DOSCODE:804A		     test    ds:FastOpenFlg, 2 ; Lookup_Success
DOSCODE:804F		     jz	     short DO_NORMAL
DOSCODE:8051		     mov     bx, dx
DOSCODE:8053		     mov     di, ds:CLUSNUM
DOSCODE:8057		     push    ax
DOSCODE:8058		     call    SETDIRSRCH
DOSCODE:805B		     pop     ax
DOSCODE:805C		     add     sp, 2
DOSCODE:805F		     jmp     short FAST_OPEN_SKIP
DOSCODE:8061 ; ---------------------------------------------------------------------------
DOSCODE:8061
DOSCODE:8061 DO_NORMAL:				     ; ...
DOSCODE:8061		     pop     ds
DOSCODE:8062		     sub     bx, di
DOSCODE:8064		     sub     si, di
DOSCODE:8066		     push    bx
DOSCODE:8067		     push    ax
DOSCODE:8068		     push    si
DOSCODE:8069		     push    cx
DOSCODE:806A		     push    word ptr [di+6] ; [DI+BUFFINFO.buf_sector]
DOSCODE:806D		     push    word ptr [di+8] ; [DI+BUFFINFO.buf_sector+2]
DOSCODE:8070		     mov     bx, dx
DOSCODE:8072		     push    ss
DOSCODE:8073		     pop     ds
DOSCODE:8074		     call    SETDIRSRCH
DOSCODE:8077		     pop     ds:HIGH_SECTOR
DOSCODE:807B		     pop     dx
DOSCODE:807C		     jb	     short SKIP_GETB
DOSCODE:807E		     mov     ds:ALLOWED, 18h ; Allowed_RETRY+Allowed_FAIL
DOSCODE:8083		     xor     al, al
DOSCODE:8085		     call    GETBUFFR
DOSCODE:8088
DOSCODE:8088 SKIP_GETB:				     ; ...
DOSCODE:8088		     pop     cx
DOSCODE:8089		     pop     si
DOSCODE:808A		     pop     ax
DOSCODE:808B		     pop     bx
DOSCODE:808C		     jnb     short SET_THE_BUF
DOSCODE:808E		     pop     di
DOSCODE:808F		     mov     si, di
DOSCODE:8091		     jmp     short _BADPATH
DOSCODE:8093 ; ---------------------------------------------------------------------------
DOSCODE:8093
DOSCODE:8093 SET_THE_BUF:			     ; ...
DOSCODE:8093		     call    SET_BUF_AS_DIR
DOSCODE:8096		     mov     di, word ptr ds:CURBUF
DOSCODE:809A		     add     si, di
DOSCODE:809C		     add     bx, di
DOSCODE:809E
DOSCODE:809E FAST_OPEN_SKIP:			     ; ...
DOSCODE:809E		     pop     di
DOSCODE:809F		     call    InsertPath
DOSCODE:80A2		     mov     al, [di]
DOSCODE:80A4		     or	     al, al
DOSCODE:80A6		     jz	     short _SETRET
DOSCODE:80A8		     inc     di
DOSCODE:80A9		     mov     si, di
DOSCODE:80AB		     call    PATHCHRCMP
DOSCODE:80AE		     jnz     short find_bad_name
DOSCODE:80B0		     jmp     FINDPATH
DOSCODE:80B3 ; ---------------------------------------------------------------------------
DOSCODE:80B3
DOSCODE:80B3 find_bad_name:			     ; ...
DOSCODE:80B3		     dec     si
DOSCODE:80B4
DOSCODE:80B4 _BADPATH:				     ; ...
DOSCODE:80B4		     xor     cl, cl
DOSCODE:80B6		     jmp     short BADPRET
DOSCODE:80B8 ; ---------------------------------------------------------------------------
DOSCODE:80B8
DOSCODE:80B8 FILEINPATH:			     ; ...
DOSCODE:80B8		     pop     di
DOSCODE:80B9		     push    ss
DOSCODE:80BA		     pop     ds
DOSCODE:80BB		     test    ds:FastOpenFlg, 1 ; FastOpen_Set
DOSCODE:80C0		     jz	     short NO_FAST
DOSCODE:80C2		     test    ds:FastOpenFlg, 2 ; Lookup_Success
DOSCODE:80C7		     jz	     short NO_FAST
DOSCODE:80C9		     mov     di, ds:Next_Element_Start
DOSCODE:80CD
DOSCODE:80CD NO_FAST:				     ; ...
DOSCODE:80CD		     mov     al, [di]
DOSCODE:80CF		     or	     al, al
DOSCODE:80D1		     jz	     short INCRET
DOSCODE:80D3		     mov     si, di
DOSCODE:80D5		     jmp     short BADPRET
DOSCODE:80D7 ; ---------------------------------------------------------------------------
DOSCODE:80D7
DOSCODE:80D7 INCRET:				     ; ...
DOSCODE:80D7		     call    InsertPath
DOSCODE:80DA		     inc     al
DOSCODE:80DC
DOSCODE:80DC _SETRET:				     ; ...
DOSCODE:80DC		     retn
DOSCODE:80DD ; ---------------------------------------------------------------------------
DOSCODE:80DD
DOSCODE:80DD BADPATHPOP:			     ; ...
DOSCODE:80DD		     pop     si
DOSCODE:80DE		     mov     al, [si]
DOSCODE:80E0		     mov     si, di
DOSCODE:80E2		     or	     al, al
DOSCODE:80E4
DOSCODE:80E4 BADPRET:				     ; ...
DOSCODE:80E4		     mov     al, ds:SATTRIB
DOSCODE:80E7		     mov     ds:ATTRIB,	al
DOSCODE:80EA		     stc
DOSCODE:80EB		     retn
DOSCODE:80EB ; END OF FUNCTION CHUNK FOR GETPATH
DOSCODE:80EC
DOSCODE:80EC ; =============== S U B R O U T I N E =======================================
DOSCODE:80EC
DOSCODE:80EC
DOSCODE:80EC STARTSRCH	     proc near		     ; ...
DOSCODE:80EC		     les     bp, ds:THISDPB
DOSCODE:80F0		     xor     ax, ax
DOSCODE:80F2		     mov     ds:LASTENT, ax
DOSCODE:80F5		     mov     ds:VOLID, al
DOSCODE:80F8		     dec     ax
DOSCODE:80F9		     mov     ds:ENTFREE, ax
DOSCODE:80FC		     mov     ds:ENTLAST, ax
DOSCODE:80FF		     retn
DOSCODE:80FF STARTSRCH	     endp
DOSCODE:80FF
DOSCODE:8100
DOSCODE:8100 ; =============== S U B R O U T I N E =======================================
DOSCODE:8100
DOSCODE:8100
DOSCODE:8100 MatchAttributes proc near		     ; ...
DOSCODE:8100		     push    ax
DOSCODE:8101		     mov     al, ss:ATTRIB
DOSCODE:8105		     not     al
DOSCODE:8107		     and     al, ch
DOSCODE:8109		     and     al, 16h	     ; attr_all
DOSCODE:810B		     pop     ax
DOSCODE:810C		     retn
DOSCODE:810C MatchAttributes endp
DOSCODE:810C
DOSCODE:810D
DOSCODE:810D ; =============== S U B R O U T I N E =======================================
DOSCODE:810D
DOSCODE:810D
DOSCODE:810D DEVNAME	     proc near		     ; ...
DOSCODE:810D		     push    si
DOSCODE:810E		     push    di
DOSCODE:810F		     push    cx
DOSCODE:8110		     push    ax
DOSCODE:8111		     push    word ptr ds:NAME1
DOSCODE:8115		     cmp     ds:NAME1, 5
DOSCODE:811A		     jnz     short NOKTR
DOSCODE:811C		     mov     ds:NAME1, 0E5h
DOSCODE:8121
DOSCODE:8121 NOKTR:				     ; ...
DOSCODE:8121		     test    ds:ATTRIB,	8    ; attr_volume_id
DOSCODE:8126		     jnz     short RET31
DOSCODE:8128		     mov     si, offset	NULDEV
DOSCODE:812B
DOSCODE:812B LOOKIO:				     ; ...
DOSCODE:812B		     test    word ptr [si+4], 8000h ; [SI+SYSDEV.ATT],DEVTYP
DOSCODE:8130		     jz	     short SKIPDEV
DOSCODE:8132		     mov     ax, si
DOSCODE:8134		     add     si, 10	     ; SYSDEV.NAME
DOSCODE:8137		     mov     di, offset	NAME1
DOSCODE:813A		     mov     cx, 4
DOSCODE:813D		     repe cmpsw
DOSCODE:813F		     mov     si, ax
DOSCODE:8141		     jz	     short IOCHK
DOSCODE:8143
DOSCODE:8143 SKIPDEV:				     ; ...
DOSCODE:8143		     lds     si, [si]
DOSCODE:8145		     cmp     si, 0FFFFh	     ; -1
DOSCODE:8148		     jnz     short LOOKIO
DOSCODE:814A
DOSCODE:814A RET31:				     ; ...
DOSCODE:814A		     stc
DOSCODE:814B
DOSCODE:814B RETNV:				     ; ...
DOSCODE:814B		     mov     cx, ss
DOSCODE:814D		     mov     ds, cx
DOSCODE:814F		     pop     word ptr ds:NAME1
DOSCODE:8153		     pop     ax
DOSCODE:8154		     pop     cx
DOSCODE:8155		     pop     di
DOSCODE:8156		     pop     si
DOSCODE:8157		     retn
DOSCODE:8158 ; ---------------------------------------------------------------------------
DOSCODE:8158
DOSCODE:8158 IOCHK:				     ; ...
DOSCODE:8158		     mov     word ptr ss:DEVPT+2, ds
DOSCODE:815D		     mov     bh, [si+4]	     ; [SI+SYSDEV.ATT]
DOSCODE:8160		     or	     bh, 0C0h
DOSCODE:8163		     and     bh, 0DFh	     ; ~20h
DOSCODE:8166		     mov     word ptr ss:DEVPT,	si
DOSCODE:816B		     jmp     short RETNV
DOSCODE:816B DEVNAME	     endp
DOSCODE:816B
DOSCODE:816D
DOSCODE:816D ; =============== S U B R O U T I N E =======================================
DOSCODE:816D
DOSCODE:816D
DOSCODE:816D Build_device_ent proc near		     ; ...
DOSCODE:816D		     mov     ax, 2020h	     ; '  '
DOSCODE:8170		     mov     di, (offset NAME1+8) ; DEVFCB+8
DOSCODE:8173		     stosw
DOSCODE:8174		     stosb
DOSCODE:8175		     mov     al, 40h	     ; attr_device
DOSCODE:8177		     stosb
DOSCODE:8178		     xor     ax, ax
DOSCODE:817A		     mov     cx, 10
DOSCODE:817D		     rep stosw
DOSCODE:817F		     call    DATE16
DOSCODE:8182		     mov     di, (offset NAME2+0Ah) ; DEVFCB+dir_entry.dir_time
DOSCODE:8185		     xchg    ax, dx
DOSCODE:8186		     stosw
DOSCODE:8187		     xchg    ax, dx
DOSCODE:8188		     stosw
DOSCODE:8189		     mov     si, di
DOSCODE:818B		     mov     ax, word ptr ds:DEVPT
DOSCODE:818E		     stosw
DOSCODE:818F		     mov     ax, word ptr ds:DEVPT+2
DOSCODE:8192		     stosw
DOSCODE:8193		     mov     ah, bh
DOSCODE:8195		     mov     bx, offset	NAME1 ;	DEVFCB
DOSCODE:8198		     xor     al, al
DOSCODE:819A		     retn
DOSCODE:819A Build_device_ent endp
DOSCODE:819A
DOSCODE:819B
DOSCODE:819B ; =============== S U B R O U T I N E =======================================
DOSCODE:819B
DOSCODE:819B ; Attributes: bp-based frame
DOSCODE:819B
DOSCODE:819B ValidateCDS     proc near		     ; ...
DOSCODE:819B
DOSCODE:819B SaveCDS	     = dword ptr -6
DOSCODE:819B Temp	     = word ptr	-2
DOSCODE:819B
DOSCODE:819B		     push    bp
DOSCODE:819C		     mov     bp, sp
DOSCODE:819E		     sub     sp, 6
DOSCODE:81A1		     mov     [bp+Temp],	di   ; [bp-2]
DOSCODE:81A4		     lds     si, ss:THISCDS
DOSCODE:81A9		     mov     word ptr [bp+SaveCDS], si ; [bp-6]
DOSCODE:81AC		     mov     word ptr [bp+SaveCDS+2], ds ; [bp-4]
DOSCODE:81AF		     call    ECritDisk
DOSCODE:81B2		     test    word ptr [si+67], 8000h ; [SI+curdir.flags],
DOSCODE:81B2					     ; curdir_isnet
DOSCODE:81B7		     jz	     short _DoSplice
DOSCODE:81B9		     jmp     FatFail
DOSCODE:81BC ; ---------------------------------------------------------------------------
DOSCODE:81BC
DOSCODE:81BC _DoSplice:				     ; ...
DOSCODE:81BC		     xor     dl, dl
DOSCODE:81BE		     xchg    dl, ss:NoSetDir
DOSCODE:81C3		     push    ss
DOSCODE:81C4		     pop     es
DOSCODE:81C5		     call    FStrCpy
DOSCODE:81C8		     mov     si, [bp+Temp]   ; [bp-2]
DOSCODE:81CB		     push    ss
DOSCODE:81CC		     pop     ds
DOSCODE:81CD		     call    Splice
DOSCODE:81D0		     push    ss
DOSCODE:81D1		     pop     ds
DOSCODE:81D2		     mov     ds:NoSetDir, dl
DOSCODE:81D6		     les     di, ds:THISCDS
DOSCODE:81DA		     push    bp
DOSCODE:81DB		     call    FATREAD_CDS
DOSCODE:81DE		     pop     bp
DOSCODE:81DF		     jb	     short FatFail
DOSCODE:81E1		     lds     si, ds:THISCDS
DOSCODE:81E5		     cmp     word ptr [si+49h],	0FFFFh ; [SI+curdir.ID],-1
DOSCODE:81E9		     jnz     short RestoreCDS
DOSCODE:81EB		     push    ss
DOSCODE:81EC		     pop     es
DOSCODE:81ED		     push    ss:WFP_START
DOSCODE:81F2		     cmp     si, word ptr [bp+SaveCDS] ; [bp-6]	; SaveCDSL
DOSCODE:81F5		     jnz     short DoChdir
DOSCODE:81F7		     mov     di, [bp+Temp]   ; [bp-2]
DOSCODE:81FA		     mov     ss:WFP_START, di
DOSCODE:81FF		     call    FStrCpy
DOSCODE:8202
DOSCODE:8202 DoChdir:				     ; ...
DOSCODE:8202		     push    ss
DOSCODE:8203		     pop     ds
DOSCODE:8204		     push    word ptr ds:SATTRIB
DOSCODE:8208		     push    bp
DOSCODE:8209		     call    DOS_CHDIR
DOSCODE:820C		     pop     bp
DOSCODE:820D		     pop     bx
DOSCODE:820E		     pop     ds:WFP_START
DOSCODE:8212		     mov     ds:SATTRIB, bl
DOSCODE:8216		     lds     si, [bp+SaveCDS] ;	[bp-6]
DOSCODE:8219		     jnb     short SetCluster
DOSCODE:821B		     mov     word ptr ss:THISCDS, si
DOSCODE:8220		     mov     word ptr ss:THISCDS+2, ds
DOSCODE:8225		     xor     cx, cx
DOSCODE:8227		     mov     [si+3], cl
DOSCODE:822A
DOSCODE:822A SetCluster:			     ; ...
DOSCODE:822A		     mov     word ptr [si+49h],	0FFFFh ; [SI+curdir.ID],-1
DOSCODE:822F		     lds     si, ss:THISCDS
DOSCODE:8234		     test    word ptr [si+43h],	2000h ;	SI+curdir.flags],
DOSCODE:8234					     ; curdir_splice
DOSCODE:8239		     jz	     short _setdirclus
DOSCODE:823B		     mov     cx, -1	     ; 0FFFFh ;	65535
DOSCODE:823E
DOSCODE:823E _setdirclus:			     ; ...
DOSCODE:823E		     mov     [si+49h], cx    ; [SI+curdir.ID]
DOSCODE:8241
DOSCODE:8241 RestoreCDS:			     ; ...
DOSCODE:8241		     les     di, [bp+SaveCDS] ;	[bp-6]
DOSCODE:8244		     mov     word ptr ss:THISCDS, di
DOSCODE:8249		     mov     word ptr ss:THISCDS+2, es
DOSCODE:824E		     clc
DOSCODE:824F
DOSCODE:824F FatFail:				     ; ...
DOSCODE:824F		     call    LCritDisk
DOSCODE:8252		     les     di, [bp+SaveCDS] ;	[bp-6]
DOSCODE:8255		     mov     sp, bp
DOSCODE:8257		     pop     bp
DOSCODE:8258		     retn
DOSCODE:8258 ValidateCDS     endp
DOSCODE:8258
DOSCODE:8259
DOSCODE:8259 ; =============== S U B R O U T I N E =======================================
DOSCODE:8259
DOSCODE:8259
DOSCODE:8259 CheckThisDevice proc near		     ; ...
DOSCODE:8259		     push    di
DOSCODE:825A		     push    si
DOSCODE:825B		     mov     di, si
DOSCODE:825D		     mov     al, [si]
DOSCODE:825F		     call    PATHCHRCMP
DOSCODE:8262		     jnz     short ParseDev
DOSCODE:8264		     inc     si
DOSCODE:8265		     lodsw
DOSCODE:8266		     or	     ax, 2020h
DOSCODE:8269		     cmp     ax, 6564h	     ; 'dev'
DOSCODE:826C		     jnz     short NotDevice
DOSCODE:826E		     lodsb
DOSCODE:826F		     or	     al, 20h
DOSCODE:8271		     cmp     al, 'v'
DOSCODE:8273		     jnz     short NotDevice
DOSCODE:8275		     lodsb
DOSCODE:8276		     call    PATHCHRCMP
DOSCODE:8279		     jnz     short NotDevice
DOSCODE:827B
DOSCODE:827B ParseDev:				     ; ...
DOSCODE:827B		     push    ds
DOSCODE:827C		     push    si
DOSCODE:827D		     call    NameTrans
DOSCODE:8280		     cmp     byte ptr [si], 0
DOSCODE:8283		     stc
DOSCODE:8284		     jnz     short SkipSearch
DOSCODE:8286		     push    ss
DOSCODE:8287		     pop     ds
DOSCODE:8288		     mov     al, ds:SATTRIB
DOSCODE:828B		     mov     ds:ATTRIB,	al
DOSCODE:828E		     call    DEVNAME
DOSCODE:8291
DOSCODE:8291 SkipSearch:			     ; ...
DOSCODE:8291		     pop     si
DOSCODE:8292		     pop     ds
DOSCODE:8293
DOSCODE:8293 CheckReturn:			     ; ...
DOSCODE:8293		     pop     di
DOSCODE:8294		     jnb     short Check_Done
DOSCODE:8296		     mov     si, di
DOSCODE:8298
DOSCODE:8298 Check_Done:			     ; ...
DOSCODE:8298		     pop     di
DOSCODE:8299		     cmc
DOSCODE:829A		     retn
DOSCODE:829B ; ---------------------------------------------------------------------------
DOSCODE:829B
DOSCODE:829B NotDevice:				     ; ...
DOSCODE:829B		     stc
DOSCODE:829C		     jmp     short CheckReturn
DOSCODE:829C CheckThisDevice endp
DOSCODE:829C
DOSCODE:829E
DOSCODE:829E ; =============== S U B R O U T I N E =======================================
DOSCODE:829E
DOSCODE:829E
DOSCODE:829E LookupPath	     proc near		     ; ...
DOSCODE:829E		     test    ss:FastOpenFlg, 1 ; FastOpen_Set
DOSCODE:82A4		     jnz     short FASTINST
DOSCODE:82A6
DOSCODE:82A6 NOLOOK:				     ; ...
DOSCODE:82A6		     jmp     NOLOOKUP
DOSCODE:82A9 ; ---------------------------------------------------------------------------
DOSCODE:82A9
DOSCODE:82A9 FASTINST:				     ; ...
DOSCODE:82A9		     test    ss:FastOpenFlg, 8 ; No_Lookup
DOSCODE:82AF		     jnz     short NOLOOK
DOSCODE:82B1		     mov     bx, offset	FastOpenTable
DOSCODE:82B4		     mov     si, ss:WFP_START
DOSCODE:82B9		     mov     di, offset	Dir_Info_Buff
DOSCODE:82BC		     mov     cx, offset	FastOpen_Ext_Info
DOSCODE:82BF		     mov     al, 1
DOSCODE:82C1		     push    ds
DOSCODE:82C2		     pop     es
DOSCODE:82C3		     call    dword ptr [bx+2] ;	CALL far [BX+fastopen_entry.name_caching]
DOSCODE:82C6		     jb	     short NOTFOUND
DOSCODE:82C8		     lea     bx, [si-2]
DOSCODE:82CB		     cmp     bx, ss:WFP_START
DOSCODE:82D0		     jz	     short NOTFOUND
DOSCODE:82D2		     cmp     byte ptr [si], 0
DOSCODE:82D5		     jnz     short parfnd
DOSCODE:82D7		     push    cx
DOSCODE:82D8		     mov     cl, ss:ATTRIB
DOSCODE:82DD		     mov     ch, ss:SATTRIB
DOSCODE:82E2		     mov     ss:ATTRIB,	ch
DOSCODE:82E7		     mov     ch, es:[di+0Bh] ; [ES:DI+dir_entry.dir_attr]
DOSCODE:82EB		     call    MatchAttributes
DOSCODE:82EE		     pop     cx
DOSCODE:82EF		     jnz     short NOLOOKUP
DOSCODE:82F1
DOSCODE:82F1 parfnd:				     ; ...
DOSCODE:82F1		     mov     ss:Next_Element_Start, si
DOSCODE:82F6		     mov     bx, cx
DOSCODE:82F8		     mov     ax, [bx+7]	     ; [BX+FEI.lastent]
DOSCODE:82FB		     mov     ss:LASTENT, ax
DOSCODE:82FF		     mov     ax, [bx+9]	     ; [BX+FEI.dirstart]
DOSCODE:8302		     mov     ss:DIRSTART, ax
DOSCODE:8306		     mov     ax, [bx+5]	     ; [BX+FEI.clusnum]
DOSCODE:8309		     mov     ss:CLUSNUM, ax
DOSCODE:830D		     push    es
DOSCODE:830E		     les     bx, ss:THISDPB
DOSCODE:8313		     mov     ah, es:[bx]     ; [ES:BX+DPB.DRIVE]
DOSCODE:8316		     pop     es
DOSCODE:8317		     mov     word ptr ss:CURBUF, 0
DOSCODE:831E		     mov     word ptr ss:CURBUF+2, es
DOSCODE:8323		     mov     bx, di
DOSCODE:8325		     lea     si, [di+1Ah]    ; [DI+dir_entry.dir_first]
DOSCODE:8328		     or	     ss:FastOpenFlg, 12h ; Lookup_Success+Set_For_Search
DOSCODE:832E		     retn
DOSCODE:832F ; ---------------------------------------------------------------------------
DOSCODE:832F
DOSCODE:832F NOTFOUND:				     ; ...
DOSCODE:832F		     cmp     ax, 0FFFFh	     ; -1
DOSCODE:8332		     jnz     short Partial_Success
DOSCODE:8334		     mov     ss:FastOpenFlg, 0
DOSCODE:833A
DOSCODE:833A Partial_Success:			     ; ...
DOSCODE:833A		     and     ss:FastOpenFlg, 0FBh ; Special_Fill_Reset
DOSCODE:8340
DOSCODE:8340 NOLOOKUP:				     ; ...
DOSCODE:8340		     stc
DOSCODE:8341		     retn
DOSCODE:8341 LookupPath	     endp
DOSCODE:8341
DOSCODE:8342
DOSCODE:8342 ; =============== S U B R O U T I N E =======================================
DOSCODE:8342
DOSCODE:8342
DOSCODE:8342 InsertPath	     proc near		     ; ...
DOSCODE:8342		     pushf
DOSCODE:8343		     test    ss:FastOpenFlg, 1 ; FastOpen_Set
DOSCODE:8349		     jz	     short GET_NEXT_ELEMENT
DOSCODE:834B		     test    ss:FastOpenFlg, 2 ; Lookup_Success
DOSCODE:8351		     jz	     short INSERT_DIR_INFO
DOSCODE:8353		     and     ss:FastOpenFlg, 0FDh ; Lookup_Reset
DOSCODE:8359		     mov     di, ss:Next_Element_Start
DOSCODE:835E		     jmp     short GET_NEXT2
DOSCODE:8360 ; ---------------------------------------------------------------------------
DOSCODE:8360
DOSCODE:8360 INSERT_DIR_INFO:			     ; ...
DOSCODE:8360		     push    ds
DOSCODE:8361		     push    es
DOSCODE:8362		     push    bx
DOSCODE:8363		     push    si
DOSCODE:8364		     push    di
DOSCODE:8365		     push    cx
DOSCODE:8366		     push    ax
DOSCODE:8367		     lds     di, ss:CURBUF
DOSCODE:836C		     mov     si, offset	FastOpen_Ext_Info
DOSCODE:836F		     mov     ax, [di+6]	     ; [DI+BUFFINFO.buf_sector]
DOSCODE:8372		     mov     ss:[si+1],	ax   ; [SS:SI+FEI.dirsec]
DOSCODE:8376		     mov     ax, [di+8]	     ; [DI+BUFFINFO.buf_sector+2]
DOSCODE:8379		     push    ss
DOSCODE:837A		     pop     ds
DOSCODE:837B		     mov     [si+3], ax	     ; [SI+FEI.dirsec+2]
DOSCODE:837E		     mov     ax, ds:CLUSNUM
DOSCODE:8381		     mov     [si+5], ax	     ; [SI+FEI.clusnum]
DOSCODE:8384		     mov     ax, ds:LASTENT
DOSCODE:8387		     mov     [si+7], ax	     ; [SI+FEI.lastent]
DOSCODE:838A		     mov     ax, ds:DIRSTART
DOSCODE:838D		     mov     [si+9], ax	     ; [SI+FEI.dirstart]
DOSCODE:8390		     mov     ax, bx
DOSCODE:8392		     add     di, 20	     ; BUFINSIZ
DOSCODE:8395		     sub     ax, di
DOSCODE:8397		     mov     cl, 32	     ; dir_entry.size
DOSCODE:8399		     div     cl
DOSCODE:839B		     mov     [si], al	     ; [SI+FEI.dirpos]
DOSCODE:839D		     push    ds
DOSCODE:839E		     pop     es
DOSCODE:839F		     mov     ds, word ptr ds:CURBUF+2
DOSCODE:83A3		     mov     di, bx
DOSCODE:83A5		     cmp     word ptr [di+26], 0 ; [DI+dir_entry.dir_first]
DOSCODE:83A9		     jz	     short SKIP_INSERT
DOSCODE:83AB		     push    si
DOSCODE:83AC		     pop     bx
DOSCODE:83AD		     mov     al, 2	     ; FONC_insert
DOSCODE:83AF		     mov     si, offset	FastOpenTable
DOSCODE:83B2		     call    dword ptr es:[si+2] ; CALL	far [SI+fastopen_entry.name_caching]
DOSCODE:83B6		     clc
DOSCODE:83B7
DOSCODE:83B7 SKIP_INSERT:			     ; ...
DOSCODE:83B7		     pop     ax
DOSCODE:83B8		     pop     cx
DOSCODE:83B9		     pop     di
DOSCODE:83BA		     pop     si
DOSCODE:83BB		     pop     bx
DOSCODE:83BC		     pop     es
DOSCODE:83BD		     pop     ds
DOSCODE:83BE
DOSCODE:83BE GET_NEXT2:				     ; ...
DOSCODE:83BE		     or	     ss:FastOpenFlg, 8 ; No_Lookup
DOSCODE:83C4
DOSCODE:83C4 GET_NEXT_ELEMENT:			     ; ...
DOSCODE:83C4		     popf
DOSCODE:83C5		     retn
DOSCODE:83C5 InsertPath	     endp
DOSCODE:83C5
DOSCODE:83C5 ; ---------------------------------------------------------------------------
DOSCODE:83C6 LenTab	     db	22, 14,	22, 13,	15, 14 ; ...
DOSCODE:83C6					     ; DRDWRHL,	DRDNDHL, DRDWRHL,
DOSCODE:83C6					     ; DSTATHL,	DFLSHL,	DRDNDHL
DOSCODE:83CC CmdTab	     db	86h, 4		     ; ...
DOSCODE:83CC					     ; DEVRD   ; 0 input
DOSCODE:83CE		     db	86h, 5		     ; DEVRDND ; 1 input status
DOSCODE:83D0		     db	87h, 8		     ; DEVWRT  ; 2 output
DOSCODE:83D2		     db	87h, 0Ah	     ; DEVOST  ; 3 output status
DOSCODE:83D4		     db	86h, 7		     ; DEVIFL  ; 4 input flush
DOSCODE:83D6		     db	86h, 5		     ; 5 input status with system WAIT
DOSCODE:83D8
DOSCODE:83D8 ; =============== S U B R O U T I N E =======================================
DOSCODE:83D8
DOSCODE:83D8
DOSCODE:83D8 IOFUNC	     proc near		     ; ...
DOSCODE:83D8		     mov     word ptr ss:IOCTL_IOXAD_2,	ss ; [SS:IOXAD+2]
DOSCODE:83DD		     mov     word ptr ss:IOCTL_REQ_MINORFUNCTION, offset DEVIOBUF ;
DOSCODE:83DD					     ; [SS:IOXAD],DEVIOBUF
DOSCODE:83E4		     mov     word ptr ss:IOCTL_IOSCNT, 1 ; [SS:IOSCNT]
DOSCODE:83EB		     mov     ss:DEVIOBUF, ax
DOSCODE:83EF		     test    byte ptr [si+6], 80h ; [SI+SF_ENTRY.sf_flags+1],
DOSCODE:83EF					     ; (sf_isnet>>8)
DOSCODE:83F3		     jz	     short IOTO22
DOSCODE:83F5		     jmp     IOTOFILE
DOSCODE:83F8 ; ---------------------------------------------------------------------------
DOSCODE:83F8
DOSCODE:83F8 IOTO22:				     ; ...
DOSCODE:83F8		     test    byte ptr [si+5], 80h ; [SI+SF_ENTRY.sf_flags],
DOSCODE:83F8					     ; devid_device
DOSCODE:83FC		     jnz     short IOTO33
DOSCODE:83FE		     jmp     IOTOFILE
DOSCODE:8401 ; ---------------------------------------------------------------------------
DOSCODE:8401
DOSCODE:8401 IOTO33:				     ; ...
DOSCODE:8401		     push    es
DOSCODE:8402		     call    save_world
DOSCODE:8405		     mov     dx, ds
DOSCODE:8407		     mov     bx, ss
DOSCODE:8409		     mov     ds, bx
DOSCODE:840B		     mov     es, bx
DOSCODE:840D		     xor     bx, bx
DOSCODE:840F		     cmp     ah, 5
DOSCODE:8412		     jnz     short no_sys_wait
DOSCODE:8414		     or	     bx, 400h
DOSCODE:8418
DOSCODE:8418 no_sys_wait:			     ; ...
DOSCODE:8418		     mov     word ptr ds:IOCALL_REQSTAT, bx
DOSCODE:841C		     xor     bx, bx
DOSCODE:841E		     mov     ds:IOCTL_REQ_MAJORFUNCTION, bl ; [IOMED]
DOSCODE:8422		     mov     bl, ah
DOSCODE:8424		     mov     ah, cs:LenTab[bx] ; [cs:BX+LenTab]
DOSCODE:8429		     shl     bx, 1
DOSCODE:842B		     mov     cx, word ptr cs:CmdTab[bx]	; [cs:BX+CmdTab]
DOSCODE:8430		     mov     bx, offset	IOCALL_REQLEN ;	IOCALL ; DOSDATA:037Ch
DOSCODE:8433		     mov     ds:IOCALL_REQLEN, ah
DOSCODE:8437		     mov     ds:IOCALL_REQFUNC,	ch
DOSCODE:843B		     mov     ds, dx
DOSCODE:843D		     call    DEVIOCALL
DOSCODE:8440		     mov     di, word ptr ss:IOCALL_REQSTAT
DOSCODE:8445		     and     di, di
DOSCODE:8447		     js	     short DevErr
DOSCODE:8449
DOSCODE:8449 OKDevIO:				     ; ...
DOSCODE:8449		     mov     ax, ss
DOSCODE:844B		     mov     ds, ax
DOSCODE:844D		     cmp     ch, 5	     ; DEVRDND
DOSCODE:8450		     jnz     short DNODRD
DOSCODE:8452		     mov     al, ds:IOCTL_REQ_MAJORFUNCTION ; [IORCHR]
DOSCODE:8455		     mov     byte ptr ds:DEVIOBUF, al
DOSCODE:8458
DOSCODE:8458 DNODRD:				     ; ...
DOSCODE:8458		     mov     ah, ds:IOCALL_REQSTAT+1
DOSCODE:845C		     not     ah
DOSCODE:845E		     and     ah, 2	     ; STBUI>>8
DOSCODE:8461		     call    restore_world
DOSCODE:8464		     pop     es
DOSCODE:8465		     pushf
DOSCODE:8466		     mov     al, ss:IoStatFail
DOSCODE:846A		     cbw
DOSCODE:846B		     cmp     ax, -1	     ; 0FFFFh
DOSCODE:846E		     jnz     short not_fail_ret
DOSCODE:8470		     inc     ss:IoStatFail
DOSCODE:8475		     popf
DOSCODE:8476		     retn
DOSCODE:8477 ; ---------------------------------------------------------------------------
DOSCODE:8477
DOSCODE:8477 not_fail_ret:			     ; ...
DOSCODE:8477		     mov     ax, ss:DEVIOBUF
DOSCODE:847B		     popf
DOSCODE:847C		     retn
DOSCODE:847D ; ---------------------------------------------------------------------------
DOSCODE:847D
DOSCODE:847D DevErr:				     ; ...
DOSCODE:847D		     mov     ah, cl
DOSCODE:847F		     call    CHARHARD
DOSCODE:8482		     cmp     al, 1
DOSCODE:8484		     jnz     short NO_RETRY
DOSCODE:8486		     call    restore_world
DOSCODE:8489		     pop     es
DOSCODE:848A		     jmp     IOFUNC
DOSCODE:848D ; ---------------------------------------------------------------------------
DOSCODE:848D
DOSCODE:848D NO_RETRY:				     ; ...
DOSCODE:848D		     and     ss:IOCALL_REQSTAT+1, 0FDh ; ~(STBUI>>8)
DOSCODE:8493		     cmp     al, 3
DOSCODE:8495		     jnz     short not_fail
DOSCODE:8497		     dec     ss:IoStatFail
DOSCODE:849C
DOSCODE:849C not_fail:				     ; ...
DOSCODE:849C		     jmp     short OKDevIO
DOSCODE:849E ; ---------------------------------------------------------------------------
DOSCODE:849E
DOSCODE:849E IOTOFILE:				     ; ...
DOSCODE:849E		     or	     ah, ah
DOSCODE:84A0		     jz	     short IOIN
DOSCODE:84A2		     dec     ah
DOSCODE:84A4		     jz	     short IOIST
DOSCODE:84A6		     dec     ah
DOSCODE:84A8		     jz	     short IOUT
DOSCODE:84AA		     retn
DOSCODE:84AB ; ---------------------------------------------------------------------------
DOSCODE:84AB
DOSCODE:84AB IOIST:				     ; ...
DOSCODE:84AB		     push    word ptr [si+15h] ; [SI+SF_ENTRY.sf_position]
DOSCODE:84AE		     push    word ptr [si+17h] ; [SI+SF_ENTRY.sf_position+2]
DOSCODE:84B1		     call    IOIN
DOSCODE:84B4		     pop     word ptr [si+17h]
DOSCODE:84B7		     pop     word ptr [si+15h]
DOSCODE:84BA		     retn
DOSCODE:84BB ; ---------------------------------------------------------------------------
DOSCODE:84BB
DOSCODE:84BB IOUT:				     ; ...
DOSCODE:84BB		     call    SETXADDR
DOSCODE:84BE		     call    DOS_WRITE
DOSCODE:84C1		     call    RESTXADDR
DOSCODE:84C4
DOSCODE:84C4 IOUT_retn:				     ; ...
DOSCODE:84C4		     retn
DOSCODE:84C5 ; ---------------------------------------------------------------------------
DOSCODE:84C5
DOSCODE:84C5 IOIN:				     ; ...
DOSCODE:84C5		     call    SETXADDR
DOSCODE:84C8		     or	     ss:DOS34_FLAG, 40h	; Disable_EOF_I24
DOSCODE:84CE		     call    DOS_READ
DOSCODE:84D1		     and     ss:DOS34_FLAG, 0FFBFh ; NO_Disable_EOF_I24
DOSCODE:84D7		     or	     cx, cx
DOSCODE:84D9		     call    RESTXADDR
DOSCODE:84DC		     mov     al, byte ptr ss:DEVIOBUF
DOSCODE:84E0		     jnz     short IOUT_retn
DOSCODE:84E2		     mov     al, 1Ah	     ; ^Z
DOSCODE:84E4		     retn
DOSCODE:84E4 IOFUNC	     endp
DOSCODE:84E4
DOSCODE:84E5
DOSCODE:84E5 ; =============== S U B R O U T I N E =======================================
DOSCODE:84E5
DOSCODE:84E5
DOSCODE:84E5 SETXADDR	     proc near		     ; ...
DOSCODE:84E5
DOSCODE:84E5 ; FUNCTION	CHUNK AT DOSCODE:8529 SIZE 00000005 BYTES
DOSCODE:84E5
DOSCODE:84E5		     pop     ss:CALLSCNT
DOSCODE:84EA		     push    es
DOSCODE:84EB		     call    save_world
DOSCODE:84EE		     push    word ptr ss:DMAADD
DOSCODE:84F3		     push    word ptr ss:DMAADD+2
DOSCODE:84F8		     mov     word ptr ss:THISSFT+2, ds
DOSCODE:84FD		     push    ss
DOSCODE:84FE		     pop     ds
DOSCODE:84FF		     mov     word ptr ds:THISSFT, si
DOSCODE:8503		     mov     cx, word ptr ds:IOCTL_IOXAD_2 ; [IOXAD+2]
DOSCODE:8507		     mov     word ptr ds:DMAADD+2, cx
DOSCODE:850B		     mov     cx, word ptr ds:IOCTL_REQ_MINORFUNCTION ; [IOXAD]
DOSCODE:850F		     mov     word ptr ds:DMAADD, cx
DOSCODE:8513		     mov     cx, word ptr ds:IOCTL_IOSCNT ; [IOCNT]
DOSCODE:8517		     jmp     short RESTRET
DOSCODE:8517 SETXADDR	     endp
DOSCODE:8517
DOSCODE:8519 ; ---------------------------------------------------------------------------
DOSCODE:8519
DOSCODE:8519 RESTXADDR:				     ; ...
DOSCODE:8519		     pop     ds:CALLSCNT
DOSCODE:851D		     pop     word ptr ds:DMAADD+2
DOSCODE:8521		     pop     word ptr ds:DMAADD
DOSCODE:8525		     call    restore_world
DOSCODE:8528		     pop     es
DOSCODE:8529 ; START OF	FUNCTION CHUNK FOR SETXADDR
DOSCODE:8529
DOSCODE:8529 RESTRET:				     ; ...
DOSCODE:8529		     jmp     ss:CALLSCNT     ; JMP WORD	[SS:CALLSCNT]
DOSCODE:8529 ; END OF FUNCTION CHUNK FOR SETXADDR
DOSCODE:852E
DOSCODE:852E ; =============== S U B R O U T I N E =======================================
DOSCODE:852E
DOSCODE:852E
DOSCODE:852E DEV_OPEN_SFT    proc near		     ; ...
DOSCODE:852E		     push    es
DOSCODE:852F		     call    save_world
DOSCODE:8532		     mov     al, 0Dh	     ; DEVOPN
DOSCODE:8534		     jmp     short DO_OPCLS
DOSCODE:8534 DEV_OPEN_SFT    endp
DOSCODE:8534
DOSCODE:8536
DOSCODE:8536 ; =============== S U B R O U T I N E =======================================
DOSCODE:8536
DOSCODE:8536
DOSCODE:8536 DEV_CLOSE_SFT   proc near		     ; ...
DOSCODE:8536		     push    es
DOSCODE:8537		     call    save_world
DOSCODE:853A		     mov     al, 0Eh
DOSCODE:853C
DOSCODE:853C DO_OPCLS:				     ; ...
DOSCODE:853C		     test    byte ptr es:[di+6], 80h ; [es:di+SF_ENTRY.sf_flags+1],
DOSCODE:853C					     ; (sf_isnet>>8)
DOSCODE:8541		     jnz     short OPCLS_DONE
DOSCODE:8543		     xor     ah, ah
DOSCODE:8545		     test    byte ptr es:[di+5], 80h ; [ES:DI+SF_ENTRY.sf_flags],
DOSCODE:8545					     ; devid_device
DOSCODE:854A		     les     di, es:[di+7]   ; [ES:DI+SF_ENTRY.sf_devptr]
DOSCODE:854E		     jnz     short GOT_DEV_ADDR
DOSCODE:8550		     cmp     ss:fShare,	1
DOSCODE:8556		     jbe     short OPCLS_DONE
DOSCODE:8558		     mov     ah, es:[di+1]   ; [ES:DI+DPB.UNIT]
DOSCODE:855C		     mov     cl, es:[di]     ; [ES:DI+DPB.DRIVE]
DOSCODE:855F		     les     di, es:[di+13h] ; [ES:DI+DPB.DRIVER_ADDR]
DOSCODE:8563
DOSCODE:8563 GOT_DEV_ADDR:			     ; ...
DOSCODE:8563		     test    byte ptr es:[di+5], 8 ; [ES:DI+SYSDEV.ATT+1],
DOSCODE:8563					     ; (DEVOPCL>>8)
DOSCODE:8568		     jz	     short OPCLS_DONE
DOSCODE:856A		     push    es
DOSCODE:856B		     pop     ds
DOSCODE:856C		     mov     si, di
DOSCODE:856E
DOSCODE:856E OPCLS_RETRY:			     ; ...
DOSCODE:856E		     push    ss
DOSCODE:856F		     pop     es
DOSCODE:8570		     mov     di, offset	DEVCALL
DOSCODE:8573		     mov     bx, di
DOSCODE:8575		     push    ax
DOSCODE:8576		     mov     al, 13	     ; DOPCLHL
DOSCODE:8578		     stosb
DOSCODE:8579		     pop     ax
DOSCODE:857A		     xchg    ah, al
DOSCODE:857C		     stosb
DOSCODE:857D		     xchg    ah, al
DOSCODE:857F		     stosb
DOSCODE:8580		     mov     word ptr es:[di], 0
DOSCODE:8585		     push    ax
DOSCODE:8586		     call    DEVIOCALL2
DOSCODE:8589		     mov     di, es:[bx+3]   ; [ES:BX+SRHEAD.REQSTAT]
DOSCODE:858D		     and     di, di
DOSCODE:858F		     jns     short OPCLS_DONEP
DOSCODE:8591		     test    byte ptr [si+5], 80h ; [ES:DI+SYSDEV.ATT+1],
DOSCODE:8591					     ; (DEVTYP>>8)
DOSCODE:8595		     jz	     short BLKDEV
DOSCODE:8597		     mov     ah, 86h
DOSCODE:8599		     jmp     short HRDERR
DOSCODE:859B ; ---------------------------------------------------------------------------
DOSCODE:859B
DOSCODE:859B BLKDEV:				     ; ...
DOSCODE:859B		     mov     al, cl
DOSCODE:859D		     mov     ah, 6
DOSCODE:859F
DOSCODE:859F HRDERR:				     ; ...
DOSCODE:859F		     call    CHARHARD
DOSCODE:85A2		     cmp     al, 1
DOSCODE:85A4		     jnz     short OPCLS_DONEP
DOSCODE:85A6		     pop     ax
DOSCODE:85A7		     jmp     short OPCLS_RETRY
DOSCODE:85A9 ; ---------------------------------------------------------------------------
DOSCODE:85A9
DOSCODE:85A9 OPCLS_DONEP:			     ; ...
DOSCODE:85A9		     pop     ax
DOSCODE:85AA
DOSCODE:85AA OPCLS_DONE:			     ; ...
DOSCODE:85AA		     call    restore_world
DOSCODE:85AD		     pop     es
DOSCODE:85AE		     retn
DOSCODE:85AE DEV_CLOSE_SFT   endp
DOSCODE:85AE
DOSCODE:85AF
DOSCODE:85AF ; =============== S U B R O U T I N E =======================================
DOSCODE:85AF
DOSCODE:85AF
DOSCODE:85AF DEVIOCALL	     proc near		     ; ...
DOSCODE:85AF		     lds     si, [si+7]	     ; [SI+SF_ENTRY.sf_devptr]
DOSCODE:85B2
DOSCODE:85B2 DEVIOCALL2:			     ; ...
DOSCODE:85B2		     call    ECritDevice
DOSCODE:85B5		     test    byte ptr [si+5], 80h ; [si+SYSDEV.ATT+1],(DEVTYP>>8)
DOSCODE:85B9		     jnz     short chardev2
DOSCODE:85BB		     cmp     byte ptr es:[bx+2], 4 ; [ES:BX+SRHEAD.REQFUNC],DEVRD
DOSCODE:85C0		     jz	     short chkext
DOSCODE:85C2		     cmp     byte ptr es:[bx+2], 8 ; [ES:BX+SRHEAD.REQFUNC],DEVWRT
DOSCODE:85C7		     jz	     short chkext
DOSCODE:85C9		     cmp     byte ptr es:[bx+2], 9 ; [ES:BX+SRHEAD.REQFUNC],DEVWRTV
DOSCODE:85CE		     jnz     short chardev2
DOSCODE:85D0
DOSCODE:85D0 chkext:				     ; ...
DOSCODE:85D0		     call    RW_SC
DOSCODE:85D3		     jb	     short dev_exit
DOSCODE:85D5		     test    byte ptr [si+4], 2	; [SI+SYSDEV.ATT],EXTDRVR
DOSCODE:85D9		     jz	     short chksector
DOSCODE:85DB		     add     byte ptr es:[bx], 8
DOSCODE:85DF		     mov     ax, ss:CALLSSEC
DOSCODE:85E3		     mov     ss:CALLSSEC, 0FFFFh ; -1
DOSCODE:85EA		     mov     word ptr ss:CALLNEWSC, ax
DOSCODE:85EE		     mov     ax, ss:HIGH_SECTOR
DOSCODE:85F2		     mov     word ptr ss:CALLNEWSC+2, ax
DOSCODE:85F6		     jmp     short chardev2
DOSCODE:85F8 ; ---------------------------------------------------------------------------
DOSCODE:85F8
DOSCODE:85F8 chksector:				     ; ...
DOSCODE:85F8		     cmp     ss:HIGH_SECTOR, 0
DOSCODE:85FE		     jz	     short chardev2
DOSCODE:8600		     mov     word ptr es:[bx+3], 8107h ; [ES:BX+SRHEAD.REQSTAT],
DOSCODE:8600					     ; STERR+STDON+error_I24_not_DOS_disk
DOSCODE:8606		     jmp     short dev_exit
DOSCODE:8608 ; ---------------------------------------------------------------------------
DOSCODE:8608
DOSCODE:8608 chardev2:				     ; ...
DOSCODE:8608		     mov     ax, [si+6]	     ; [SI+SYSDEV.STRAT]
DOSCODE:860B		     mov     word ptr ss:CALLDEVAD, ax
DOSCODE:860F		     mov     word ptr ss:CALLDEVAD+2, ds
DOSCODE:8614		     call    ss:CALLDEVAD
DOSCODE:8619		     mov     ax, [si+8]	     ; [SI+SYSDEV.INT]
DOSCODE:861C		     mov     word ptr ss:CALLDEVAD, ax
DOSCODE:8620		     call    ss:CALLDEVAD
DOSCODE:8625		     call    VIRREAD
DOSCODE:8628		     jb	     short chardev2
DOSCODE:862A
DOSCODE:862A dev_exit:				     ; ...
DOSCODE:862A		     call    LCritDevice
DOSCODE:862D		     retn
DOSCODE:862D DEVIOCALL	     endp
DOSCODE:862D
DOSCODE:862E
DOSCODE:862E ; =============== S U B R O U T I N E =======================================
DOSCODE:862E
DOSCODE:862E
DOSCODE:862E SETREAD	     proc near		     ; ...
DOSCODE:862E		     push    di
DOSCODE:862F		     push    cx
DOSCODE:8630		     push    ax
DOSCODE:8631		     mov     cl, 4	     ; DEVRD
DOSCODE:8633
DOSCODE:8633 SETCALLHEAD:			     ; ...
DOSCODE:8633		     mov     al, 16h	     ; DRDWRHL
DOSCODE:8635		     push    ss
DOSCODE:8636		     pop     es
DOSCODE:8637		     mov     di, offset	DEVCALL
DOSCODE:863A		     stosb
DOSCODE:863B		     pop     ax
DOSCODE:863C		     stosb
DOSCODE:863D		     push    ax
DOSCODE:863E		     mov     al, cl
DOSCODE:8640		     stosb
DOSCODE:8641		     xor     ax, ax
DOSCODE:8643		     stosw
DOSCODE:8644		     add     di, 8
DOSCODE:8647		     pop     ax
DOSCODE:8648		     xchg    ah, al
DOSCODE:864A		     stosb
DOSCODE:864B		     xchg    al, ah
DOSCODE:864D		     push    ax
DOSCODE:864E		     mov     ax, bx
DOSCODE:8650		     stosw
DOSCODE:8651		     mov     ax, ds
DOSCODE:8653		     stosw
DOSCODE:8654		     pop     cx
DOSCODE:8655		     pop     ax
DOSCODE:8656		     stosw
DOSCODE:8657		     xchg    ax, dx
DOSCODE:8658		     stosw
DOSCODE:8659		     xchg    ax, cx
DOSCODE:865A		     xchg    dx, cx
DOSCODE:865C		     pop     di
DOSCODE:865D		     mov     bx, offset	DEVCALL
DOSCODE:8660		     retn
DOSCODE:8660 SETREAD	     endp
DOSCODE:8660
DOSCODE:8661
DOSCODE:8661 ; =============== S U B R O U T I N E =======================================
DOSCODE:8661
DOSCODE:8661
DOSCODE:8661 SETWRITE	     proc near		     ; ...
DOSCODE:8661		     push    di
DOSCODE:8662		     push    cx
DOSCODE:8663		     push    ax
DOSCODE:8664		     mov     cl, 8	     ; DEVWRT
DOSCODE:8666		     add     cl, ss:VERFLG
DOSCODE:866B		     jmp     short SETCALLHEAD
DOSCODE:866B SETWRITE	     endp
DOSCODE:866B
DOSCODE:866D
DOSCODE:866D ; =============== S U B R O U T I N E =======================================
DOSCODE:866D
DOSCODE:866D
DOSCODE:866D RW_SC	     proc near		     ; ...
DOSCODE:866D		     cmp     ss:SC_CACHE_COUNT,	0
DOSCODE:8673		     jz	     short scexit4
DOSCODE:8675		     cmp     ss:CALLSCNT, 1
DOSCODE:867B		     jnz     short scexit4
DOSCODE:867D		     push    cx
DOSCODE:867E		     push    dx
DOSCODE:867F		     push    ds
DOSCODE:8680		     push    si
DOSCODE:8681		     push    es
DOSCODE:8682		     push    di
DOSCODE:8683		     mov     dx, ss:CALLSSEC
DOSCODE:8688		     cmp     ss:DEVCALL_REQFUNC, 4 ; DEVRD
DOSCODE:868E		     jz	     short doread
DOSCODE:8690		     call    INVALIDATE_SC
DOSCODE:8693		     jmp     scexit2
DOSCODE:8696 ; ---------------------------------------------------------------------------
DOSCODE:8696
DOSCODE:8696 scexit4:				     ; ...
DOSCODE:8696		     clc
DOSCODE:8697		     retn
DOSCODE:8698 ; ---------------------------------------------------------------------------
DOSCODE:8698
DOSCODE:8698 doread:				     ; ...
DOSCODE:8698		     call    SC2BUF
DOSCODE:869B		     jb	     short readSC
DOSCODE:869D		     mov     ss:DEVCALL_REQSTAT, 100h ;	STDON
DOSCODE:86A4		     stc
DOSCODE:86A5		     jmp     short saveseq
DOSCODE:86A7 ; ---------------------------------------------------------------------------
DOSCODE:86A7
DOSCODE:86A7 readSC:				     ; ...
DOSCODE:86A7		     mov     ax, ss:HIGH_SECTOR
DOSCODE:86AB		     mov     cx, ss:CALLSSEC
DOSCODE:86B0		     sub     cx, word ptr ss:SEQ_SECTOR
DOSCODE:86B5		     sbb     ax, word ptr ss:SEQ_SECTOR+2
DOSCODE:86BA		     cmp     ax, 0
DOSCODE:86BD		     jnz     short saveseq2
DOSCODE:86BF		     cmp     cx, 1
DOSCODE:86C2		     ja	     short saveseq2
DOSCODE:86C4		     mov     ss:SC_STATUS, 0FFFFh
DOSCODE:86CB		     mov     ax, ss:SC_CACHE_COUNT
DOSCODE:86CF		     mov     ss:CALLSCNT, ax
DOSCODE:86D3		     mov     ax, word ptr ss:CALLXADD+2
DOSCODE:86D7		     mov     ss:TEMP_VAR2, ax
DOSCODE:86DB		     mov     ax, word ptr ss:CALLXADD
DOSCODE:86DF		     mov     ss:TEMP_VAR, ax
DOSCODE:86E3		     mov     ax, word ptr ss:SC_CACHE_PTR
DOSCODE:86E7		     mov     word ptr ss:CALLXADD, ax
DOSCODE:86EB		     mov     ax, word ptr ss:SC_CACHE_PTR+2
DOSCODE:86EF		     mov     word ptr ss:CALLXADD+2, ax
DOSCODE:86F3		     mov     ss:SC_FLAG, 1
DOSCODE:86F9		     mov     al, ss:SC_DRIVE
DOSCODE:86FD		     mov     ss:CurSC_DRIVE, al
DOSCODE:8701		     mov     ax, ss:CALLSSEC
DOSCODE:8705		     mov     word ptr ss:CurSC_SECTOR, ax
DOSCODE:8709		     mov     ax, ss:HIGH_SECTOR
DOSCODE:870D		     mov     word ptr ss:CurSC_SECTOR+2, ax
DOSCODE:8711
DOSCODE:8711 saveseq2:				     ; ...
DOSCODE:8711		     clc
DOSCODE:8712
DOSCODE:8712 saveseq:				     ; ...
DOSCODE:8712		     mov     ax, ss:HIGH_SECTOR
DOSCODE:8716		     mov     word ptr ss:SEQ_SECTOR+2, ax
DOSCODE:871A		     mov     ax, ss:CALLSSEC
DOSCODE:871E		     mov     word ptr ss:SEQ_SECTOR, ax
DOSCODE:8722		     jmp     short scexit
DOSCODE:8724 ; ---------------------------------------------------------------------------
DOSCODE:8724
DOSCODE:8724 scexit2:				     ; ...
DOSCODE:8724		     clc
DOSCODE:8725
DOSCODE:8725 scexit:				     ; ...
DOSCODE:8725		     pop     di
DOSCODE:8726		     pop     es
DOSCODE:8727		     pop     si
DOSCODE:8728		     pop     ds
DOSCODE:8729		     pop     dx
DOSCODE:872A		     pop     cx
DOSCODE:872B		     retn
DOSCODE:872B RW_SC	     endp
DOSCODE:872B
DOSCODE:872C
DOSCODE:872C ; =============== S U B R O U T I N E =======================================
DOSCODE:872C
DOSCODE:872C
DOSCODE:872C IN_SC	     proc near		     ; ...
DOSCODE:872C		     mov     al, ss:SC_DRIVE
DOSCODE:8730		     cmp     al, ss:CurSC_DRIVE
DOSCODE:8735		     jnz     short outrange2
DOSCODE:8737		     mov     ax, ss:HIGH_SECTOR
DOSCODE:873B		     mov     cx, dx
DOSCODE:873D		     sub     cx, word ptr ss:CurSC_SECTOR
DOSCODE:8742		     sbb     ax, word ptr ss:CurSC_SECTOR+2
DOSCODE:8747		     cmp     ax, 0
DOSCODE:874A		     jnz     short outrange2
DOSCODE:874C		     cmp     cx, ss:SC_CACHE_COUNT
DOSCODE:8751		     jnb     short outrange2
DOSCODE:8753		     clc
DOSCODE:8754		     jmp     short inexit
DOSCODE:8756 ; ---------------------------------------------------------------------------
DOSCODE:8756
DOSCODE:8756 outrange2:				     ; ...
DOSCODE:8756		     stc
DOSCODE:8757
DOSCODE:8757 inexit:				     ; ...
DOSCODE:8757		     retn
DOSCODE:8757 IN_SC	     endp
DOSCODE:8757
DOSCODE:8758
DOSCODE:8758 ; =============== S U B R O U T I N E =======================================
DOSCODE:8758
DOSCODE:8758
DOSCODE:8758 INVALIDATE_SC   proc near		     ; ...
DOSCODE:8758		     call    IN_SC
DOSCODE:875B		     jb	     short outrange
DOSCODE:875D		     mov     ax, 1
DOSCODE:8760		     shl     ax, cl
DOSCODE:8762		     not     ax
DOSCODE:8764		     and     ss:SC_STATUS, ax
DOSCODE:8769
DOSCODE:8769 outrange:				     ; ...
DOSCODE:8769		     retn
DOSCODE:8769 INVALIDATE_SC   endp
DOSCODE:8769
DOSCODE:876A
DOSCODE:876A ; =============== S U B R O U T I N E =======================================
DOSCODE:876A
DOSCODE:876A
DOSCODE:876A VIRREAD	     proc near		     ; ...
DOSCODE:876A		     cmp     ss:SC_FLAG, 0
DOSCODE:8770		     jz	     short sc2end
DOSCODE:8772		     mov     ax, ss:TEMP_VAR2
DOSCODE:8776		     mov     word ptr ss:CALLXADD+2, ax
DOSCODE:877A		     mov     ax, ss:TEMP_VAR
DOSCODE:877E		     mov     word ptr ss:CALLXADD, ax
DOSCODE:8782		     mov     ss:SC_FLAG, 0
DOSCODE:8788		     mov     ss:CALLSCNT, 1
DOSCODE:878F		     test    byte ptr ss:DEVCALL_REQSTAT+1, 80h	; (STERR>>8)
DOSCODE:8795		     jnz     short scerror
DOSCODE:8797		     push    ds
DOSCODE:8798		     push    si
DOSCODE:8799		     push    es
DOSCODE:879A		     push    di
DOSCODE:879B		     push    dx
DOSCODE:879C		     push    cx
DOSCODE:879D		     xor     cx, cx
DOSCODE:879F		     call    SC2BUF2
DOSCODE:87A2		     pop     cx
DOSCODE:87A3		     pop     dx
DOSCODE:87A4		     pop     di
DOSCODE:87A5		     pop     es
DOSCODE:87A6		     pop     si
DOSCODE:87A7		     pop     ds
DOSCODE:87A8		     jmp     short sc2end
DOSCODE:87AA ; ---------------------------------------------------------------------------
DOSCODE:87AA
DOSCODE:87AA scerror:				     ; ...
DOSCODE:87AA		     mov     ss:CALLSCNT, 1
DOSCODE:87B1		     mov     ss:SC_STATUS, 0
DOSCODE:87B8		     mov     ss:CurSC_DRIVE, 0FFh ; -1
DOSCODE:87BE		     stc
DOSCODE:87BF		     retn
DOSCODE:87C0 ; ---------------------------------------------------------------------------
DOSCODE:87C0
DOSCODE:87C0 sc2end:				     ; ...
DOSCODE:87C0		     clc
DOSCODE:87C1		     retn
DOSCODE:87C1 VIRREAD	     endp
DOSCODE:87C1
DOSCODE:87C2 ; ---------------------------------------------------------------------------
DOSCODE:87C2
DOSCODE:87C2 SC2BUF:				     ; ...
DOSCODE:87C2		     call    IN_SC
DOSCODE:87C5		     jb	     short noSC
DOSCODE:87C7		     mov     ax, 1
DOSCODE:87CA		     shl     ax, cl
DOSCODE:87CC		     test    ss:SC_STATUS, ax
DOSCODE:87D1		     jz	     short noSC
DOSCODE:87D3
DOSCODE:87D3 SC2BUF2:				     ; ...
DOSCODE:87D3		     mov     ax, cx
DOSCODE:87D5		     mul     ss:SC_SECTOR_SIZE
DOSCODE:87DA		     add     ax, word ptr ss:SC_CACHE_PTR
DOSCODE:87DF		     adc     dx, word ptr ss:SC_CACHE_PTR+2
DOSCODE:87E4		     mov     ds, dx
DOSCODE:87E6		     mov     si, ax
DOSCODE:87E8		     mov     es, word ptr ss:CALLXADD+2
DOSCODE:87ED		     mov     di, word ptr ss:CALLXADD
DOSCODE:87F2		     mov     cx, ss:SC_SECTOR_SIZE
DOSCODE:87F7		     shr     cx, 1
DOSCODE:87F9		     cmp     ss:DDMOVE,	0
DOSCODE:87FF		     jz	     short nodd
DOSCODE:8801		     shr     cx, 1
DOSCODE:8801 ; ---------------------------------------------------------------------------
DOSCODE:8803		     db	66h		     ; rep movsd (dword	move prefix)
DOSCODE:8804 ; ---------------------------------------------------------------------------
DOSCODE:8804
DOSCODE:8804 nodd:				     ; ...
DOSCODE:8804		     rep movsw
DOSCODE:8806		     clc
DOSCODE:8807		     retn
DOSCODE:8808 ; ---------------------------------------------------------------------------
DOSCODE:8808
DOSCODE:8808 noSC:				     ; ...
DOSCODE:8808		     stc
DOSCODE:8809		     retn
DOSCODE:880A
DOSCODE:880A ; =============== S U B R O U T I N E =======================================
DOSCODE:880A
DOSCODE:880A
DOSCODE:880A BUILDDIR	     proc near		     ; ...
DOSCODE:880A		     mov     ax, ds:ENTFREE
DOSCODE:880D		     cmp     ax, 0FFFFh	     ; -1
DOSCODE:8810		     jz	     short CHECK_IF_ROOT
DOSCODE:8812		     clc
DOSCODE:8813		     retn
DOSCODE:8814 ; ---------------------------------------------------------------------------
DOSCODE:8814
DOSCODE:8814 CHECK_IF_ROOT:			     ; ...
DOSCODE:8814		     cmp     ds:DIRSTART, 0
DOSCODE:8819		     jnz     short NEWDIR
DOSCODE:881B		     stc
DOSCODE:881C
DOSCODE:881C builddir_retn:			     ; ...
DOSCODE:881C		     retn
DOSCODE:881D ; ---------------------------------------------------------------------------
DOSCODE:881D
DOSCODE:881D NEWDIR:				     ; ...
DOSCODE:881D		     mov     bx, ds:DIRSTART
DOSCODE:8821		     or	     bx, bx
DOSCODE:8823		     jz	     short NULLDIR
DOSCODE:8825		     call    GETEOF
DOSCODE:8828		     jb	     short builddir_retn
DOSCODE:882A
DOSCODE:882A NULLDIR:				     ; ...
DOSCODE:882A		     mov     cx, 1
DOSCODE:882D		     call    ALLOCATE
DOSCODE:8830		     jb	     short builddir_retn
DOSCODE:8832		     mov     dx, ds:DIRSTART
DOSCODE:8836		     or	     dx, dx
DOSCODE:8838		     jnz     short ADDINGDIR
DOSCODE:883A		     call    SETDIRSRCH
DOSCODE:883D		     jb	     short builddir_retn
DOSCODE:883F		     mov     ds:LASTENT, 0FFFFh	; -1
DOSCODE:8845		     jmp     short GOTDIRREC
DOSCODE:8847 ; ---------------------------------------------------------------------------
DOSCODE:8847
DOSCODE:8847 ADDINGDIR:				     ; ...
DOSCODE:8847		     push    bx
DOSCODE:8848		     mov     bx, ds:CLUSNUM
DOSCODE:884C		     call    IsEOF
DOSCODE:884F		     pop     bx
DOSCODE:8850		     jb	     short NOTFIRSTGROW
DOSCODE:8852		     mov     ds:CLUSNUM, bx
DOSCODE:8856		     push    cx
DOSCODE:8857		     push    ax
DOSCODE:8858		     push    bp
DOSCODE:8859		     mov     ah, 1
DOSCODE:885B		     mov     dl, es:[bp+0]   ; [ES:BP+DPB.DRIVE]
DOSCODE:885F		     mov     cx, ds:DIRSTART
DOSCODE:8863		     mov     bp, bx
DOSCODE:8865		     call    FastOpen_Update
DOSCODE:8868		     pop     bp
DOSCODE:8869		     pop     ax
DOSCODE:886A		     pop     cx
DOSCODE:886B
DOSCODE:886B NOTFIRSTGROW:			     ; ...
DOSCODE:886B		     mov     dx, bx
DOSCODE:886D		     xor     bl, bl
DOSCODE:886F		     call    FIGREC
DOSCODE:8872
DOSCODE:8872 GOTDIRREC:				     ; ...
DOSCODE:8872		     mov     cl, es:[bp+4]   ; [ES:BP+DPB.CLUSTER_MASK]
DOSCODE:8876		     inc     cl
DOSCODE:8878		     xor     ch, ch
DOSCODE:887A
DOSCODE:887A ZERODIR:				     ; ...
DOSCODE:887A		     push    cx
DOSCODE:887B		     mov     ds:ALLOWED, 18h ; Allowed_FAIL+Allowed_RETRY
DOSCODE:8880		     mov     al, 0FFh
DOSCODE:8882		     call    GETBUFFR
DOSCODE:8885		     jnb     short GET_SSIZE
DOSCODE:8887		     pop     cx
DOSCODE:8888		     retn
DOSCODE:8889 ; ---------------------------------------------------------------------------
DOSCODE:8889
DOSCODE:8889 GET_SSIZE:				     ; ...
DOSCODE:8889		     mov     cx, es:[bp+2]   ; [ES:BP+DPB.SECTOR_SIZE]
DOSCODE:888D		     push    es
DOSCODE:888E		     les     di, ds:CURBUF
DOSCODE:8892		     or	     byte ptr es:[di+5], 4 ; [ES:DI+BUFFINFO.buf_flags],
DOSCODE:8892					     ; buf_isDIR
DOSCODE:8897		     push    di
DOSCODE:8898		     add     di, 20	     ; BUFINSIZ
DOSCODE:889B		     xor     ax, ax
DOSCODE:889D		     shr     cx, 1
DOSCODE:889F		     rep stosw
DOSCODE:88A1		     jnb     short EVENZ
DOSCODE:88A3		     stosb
DOSCODE:88A4
DOSCODE:88A4 EVENZ:				     ; ...
DOSCODE:88A4		     pop     di
DOSCODE:88A5		     test    byte ptr es:[di+5], 40h ; [ES:DI+BUFFINFO.buf_flags],
DOSCODE:88A5					     ; buf_dirty
DOSCODE:88AA		     jnz     short yesdirty7
DOSCODE:88AC		     call    INC_DIRTY_COUNT
DOSCODE:88AF		     or	     byte ptr es:[di+5], 40h
DOSCODE:88B4
DOSCODE:88B4 yesdirty7:				     ; ...
DOSCODE:88B4		     pop     es
DOSCODE:88B5		     pop     cx
DOSCODE:88B6		     add     dx, 1
DOSCODE:88B9		     adc     ds:HIGH_SECTOR, 0
DOSCODE:88BE		     loop    ZERODIR
DOSCODE:88C0		     mov     ax, ds:LASTENT
DOSCODE:88C3		     inc     ax
DOSCODE:88C4		     clc
DOSCODE:88C5		     retn
DOSCODE:88C5 BUILDDIR	     endp
DOSCODE:88C5
DOSCODE:88C6
DOSCODE:88C6 ; =============== S U B R O U T I N E =======================================
DOSCODE:88C6
DOSCODE:88C6
DOSCODE:88C6 SETDOTENT	     proc near		     ; ...
DOSCODE:88C6		     stosw
DOSCODE:88C7		     mov     cx, 4
DOSCODE:88CA		     mov     ax, 2020h	     ; '  '
DOSCODE:88CD		     rep stosw
DOSCODE:88CF		     stosb
DOSCODE:88D0		     mov     al, 10h	     ; attr_directory
DOSCODE:88D2		     stosb
DOSCODE:88D3		     add     di, 10
DOSCODE:88D6		     mov     si, word ptr ds:THISSFT
DOSCODE:88DA		     mov     ax, [si+0Dh]    ; [SI+SF_ENTRY.sf_time]
DOSCODE:88DD		     stosw
DOSCODE:88DE		     mov     ax, [si+0Fh]    ; [SI+SF_ENTRY.sf_date]
DOSCODE:88E1		     stosw
DOSCODE:88E2		     mov     ax, dx
DOSCODE:88E4		     stosw
DOSCODE:88E5		     xor     ax, ax
DOSCODE:88E7		     stosw
DOSCODE:88E8		     stosw
DOSCODE:88E9		     retn
DOSCODE:88E9 SETDOTENT	     endp
DOSCODE:88E9
DOSCODE:88EA ; ---------------------------------------------------------------------------
DOSCODE:88EA
DOSCODE:88EA MakeNode:				     ; ...
DOSCODE:88EA		     mov     word ptr ds:CREATING, 0E5FFh ; DIRFREE*256	+ 0FFh
DOSCODE:88F0		     push    ax
DOSCODE:88F1		     mov     ds:NoSetDir, 0
DOSCODE:88F6		     mov     ds:SATTRIB, al
DOSCODE:88F9		     call    GetPathNoSet
DOSCODE:88FC		     mov     dl, cl
DOSCODE:88FE		     mov     cx, ax
DOSCODE:8900		     pop     ax
DOSCODE:8901		     jnb     short make_exists
DOSCODE:8903		     jnz     short make_err_4
DOSCODE:8905		     cmp     dl, 80h
DOSCODE:8908		     jz	     short RENAME_MAKE ; make_type
DOSCODE:890A
DOSCODE:890A make_err_4:			     ; ...
DOSCODE:890A		     mov     al, 4
DOSCODE:890C
DOSCODE:890C make_err_ret:			     ; ...
DOSCODE:890C		     xor     ah, ah
DOSCODE:890E		     stc
DOSCODE:890F		     retn
DOSCODE:8910 ; ---------------------------------------------------------------------------
DOSCODE:8910
DOSCODE:8910 RENAME_MAKE:			     ; ...
DOSCODE:8910		     test    ds:EXTOPEN_ON, 1 ;	make_type
DOSCODE:8910					     ; EXT_OPEN_ON
DOSCODE:8915		     jz	     short make_type2
DOSCODE:8917		     or	     ds:EXTOPEN_ON, 4 ;	EXT_FILE_NOT_EXISTS
DOSCODE:891C		     test    byte ptr ds:EXTOPEN_FLAG, 0F0h
DOSCODE:8921		     jnz     short make_type2
DOSCODE:8923		     stc
DOSCODE:8924		     mov     ax, 7
DOSCODE:8927
DOSCODE:8927 ; =============== S U B R O U T I N E =======================================
DOSCODE:8927
DOSCODE:8927
DOSCODE:8927 make_retn	     proc near		     ; ...
DOSCODE:8927		     retn
DOSCODE:8927 make_retn	     endp
DOSCODE:8927
DOSCODE:8928 ; ---------------------------------------------------------------------------
DOSCODE:8928
DOSCODE:8928 make_type2:			     ; ...
DOSCODE:8928		     les     di, ds:THISSFT
DOSCODE:892C		     xor     ax, ax
DOSCODE:892E		     stc
DOSCODE:892F		     jmp     short make_new
DOSCODE:8931 ; ---------------------------------------------------------------------------
DOSCODE:8931
DOSCODE:8931 make_exists:			     ; ...
DOSCODE:8931		     jz	     short make_exists_dir
DOSCODE:8933		     mov     al, 3
DOSCODE:8935		     test    ds:ATTRIB,	18h  ; attr_volume_id+attr_directory
DOSCODE:893A		     jnz     short make_err_ret_5
DOSCODE:893C		     or	     ch, ch
DOSCODE:893E		     js	     short make_share
DOSCODE:8940		     or	     ah, ah
DOSCODE:8942		     jnz     short make_err_ret
DOSCODE:8944		     push    cx
DOSCODE:8945		     mov     es, word ptr ds:CURBUF+2
DOSCODE:8949		     mov     ch, es:[bx+0Bh] ; [ES:BX+dir_entry.dir_attr]
DOSCODE:894D		     test    ch, 1
DOSCODE:8950		     jnz     short make_err_ret_5P
DOSCODE:8952		     call    MatchAttributes
DOSCODE:8955		     pop     cx
DOSCODE:8956		     jnz     short make_err_ret_5
DOSCODE:8958		     xor     al, al
DOSCODE:895A
DOSCODE:895A make_share:			     ; ...
DOSCODE:895A		     xor     ah, ah
DOSCODE:895C		     push    ax
DOSCODE:895D		     push    cx
DOSCODE:895E		     mov     ah, ch
DOSCODE:8960		     call    DOOPEN
DOSCODE:8963		     les     di, ds:THISSFT
DOSCODE:8967		     push    si
DOSCODE:8968		     push    bx
DOSCODE:8969		     call    ShareEnter
DOSCODE:896C		     jnb     short MakeEndShare
DOSCODE:896E		     pop     bx
DOSCODE:896F		     pop     si
DOSCODE:8970		     pop     cx
DOSCODE:8971		     pop     ax
DOSCODE:8972
DOSCODE:8972 Make_Share_ret:			     ; ...
DOSCODE:8972		     mov     al, 6
DOSCODE:8974		     jmp     short make_err_ret
DOSCODE:8976 ; ---------------------------------------------------------------------------
DOSCODE:8976
DOSCODE:8976 make_err_ret_5P:			     ; ...
DOSCODE:8976		     pop     cx
DOSCODE:8977
DOSCODE:8977 make_err_ret_5:			     ; ...
DOSCODE:8977		     mov     al, 5
DOSCODE:8979		     jmp     short make_err_ret
DOSCODE:897B ; ---------------------------------------------------------------------------
DOSCODE:897B
DOSCODE:897B make_exists_dir:			     ; ...
DOSCODE:897B		     mov     al, 1
DOSCODE:897D		     jmp     short make_err_ret
DOSCODE:897F
DOSCODE:897F ; =============== S U B R O U T I N E =======================================
DOSCODE:897F
DOSCODE:897F
DOSCODE:897F make_save	     proc near		     ; ...
DOSCODE:897F		     push    ax
DOSCODE:8980		     mov     ax, cx
DOSCODE:8982		     call    NEWENTRY
DOSCODE:8985		     pop     ax
DOSCODE:8986		     jnb     short make_retn
DOSCODE:8988		     mov     al, 2
DOSCODE:898A
DOSCODE:898A make_save_retn:			     ; ...
DOSCODE:898A		     retn
DOSCODE:898A make_save	     endp
DOSCODE:898A
DOSCODE:898B ; ---------------------------------------------------------------------------
DOSCODE:898B
DOSCODE:898B make_new:				     ; ...
DOSCODE:898B		     call    make_save
DOSCODE:898E		     jb	     short make_save_retn
DOSCODE:8990		     test    ds:ATTRIB,	10h  ; attr_directory
DOSCODE:8995		     jnz     short make_save_retn
DOSCODE:8997		     push    ax
DOSCODE:8998		     push    bx
DOSCODE:8999		     push    si
DOSCODE:899A		     call    ShareEnter
DOSCODE:899D		     pop     si
DOSCODE:899E		     pop     bx
DOSCODE:899F		     pop     ax
DOSCODE:89A0		     jnb     short make_save_retn
DOSCODE:89A2		     push    ax
DOSCODE:89A3		     les     di, ds:CURBUF
DOSCODE:89A7		     mov     byte ptr es:[bx], 0E5h ; DIRFREE
DOSCODE:89AB		     test    byte ptr es:[di+5], 40h ; [ES:DI+BUFFINFO.buf_flags],
DOSCODE:89AB					     ; buf_dirty
DOSCODE:89B0		     jnz     short yesdirty8
DOSCODE:89B2		     call    INC_DIRTY_COUNT
DOSCODE:89B5		     or	     byte ptr es:[di+5], 40h
DOSCODE:89BA
DOSCODE:89BA yesdirty8:				     ; ...
DOSCODE:89BA		     les     bp, ds:THISDPB
DOSCODE:89BE		     mov     al, es:[bp+0]   ; [ES:BP+DPB.DRIVE]
DOSCODE:89C2		     call    FLUSHBUF
DOSCODE:89C5		     pop     ax
DOSCODE:89C6		     jmp     short Make_Share_ret
DOSCODE:89C8 ; ---------------------------------------------------------------------------
DOSCODE:89C8
DOSCODE:89C8 MakeEndShare:			     ; ...
DOSCODE:89C8		     les     di, ds:THISSFT
DOSCODE:89CC		     xor     ax, ax
DOSCODE:89CE		     call    ECritDisk	     ; call ECritSFT
DOSCODE:89D1		     xchg    ax, es:[di]     ; [ES:DI+SF_ENTRY.sf_ref_count]
DOSCODE:89D4		     push    ax
DOSCODE:89D5		     push    di
DOSCODE:89D6		     push    es
DOSCODE:89D7		     pushf
DOSCODE:89D8		     call    ShareEnd
DOSCODE:89DB		     popf
DOSCODE:89DC		     pop     es
DOSCODE:89DD		     pop     di
DOSCODE:89DE		     pop     word ptr es:[di] ;	[ES:DI+SF_ENTRY.sf_ref_count]
DOSCODE:89E1		     call    LCritDisk	     ; call LCritSFT
DOSCODE:89E4		     pop     bx
DOSCODE:89E5		     pop     si
DOSCODE:89E6		     pop     cx
DOSCODE:89E7		     pop     ax
DOSCODE:89E8		     call    make_save
DOSCODE:89EB		     jb	     short make_save_retn
DOSCODE:89ED		     push    ax
DOSCODE:89EE		     push    bx
DOSCODE:89EF		     push    si
DOSCODE:89F0		     pushf
DOSCODE:89F1		     call    ShareEnter
DOSCODE:89F4		     popf
DOSCODE:89F5		     pop     si
DOSCODE:89F6		     pop     bx
DOSCODE:89F7		     pop     ax
DOSCODE:89F8
DOSCODE:89F8 makeendshare_retn:			     ; ...
DOSCODE:89F8		     retn
DOSCODE:89F9
DOSCODE:89F9 ; =============== S U B R O U T I N E =======================================
DOSCODE:89F9
DOSCODE:89F9
DOSCODE:89F9 NEWENTRY	     proc near		     ; ...
DOSCODE:89F9		     les     bp, ds:THISDPB
DOSCODE:89FD		     jnb     short EXISTENT
DOSCODE:89FF		     cmp     ds:FAILERR, 0
DOSCODE:8A04		     stc
DOSCODE:8A05		     jnz     short makeendshare_retn
DOSCODE:8A07		     call    BUILDDIR
DOSCODE:8A0A		     jb	     short makeendshare_retn
DOSCODE:8A0C		     call    GETENT
DOSCODE:8A0F		     jb	     short makeendshare_retn
DOSCODE:8A11		     jmp     short FREESPOT
DOSCODE:8A13 ; ---------------------------------------------------------------------------
DOSCODE:8A13
DOSCODE:8A13 ERRRET3:				     ; ...
DOSCODE:8A13		     stc
DOSCODE:8A14
DOSCODE:8A14 newentry_retn:			     ; ...
DOSCODE:8A14		     retn
DOSCODE:8A15 ; ---------------------------------------------------------------------------
DOSCODE:8A15
DOSCODE:8A15 EXISTENT:				     ; ...
DOSCODE:8A15		     or	     ah, ah
DOSCODE:8A17		     jns     short NOT_DEV1
DOSCODE:8A19		     jmp     DOOPEN
DOSCODE:8A1C ; ---------------------------------------------------------------------------
DOSCODE:8A1C
DOSCODE:8A1C NOT_DEV1:				     ; ...
DOSCODE:8A1C		     call    FREEENT
DOSCODE:8A1F		     jb	     short newentry_retn
DOSCODE:8A21
DOSCODE:8A21 FREESPOT:				     ; ...
DOSCODE:8A21		     test    ds:ATTRIB,	8    ; attr_volume_id
DOSCODE:8A26		     jz	     short NOTVOLID
DOSCODE:8A28		     cmp     ds:VOLID, 0
DOSCODE:8A2D		     jnz     short ERRRET3
DOSCODE:8A2F
DOSCODE:8A2F NOTVOLID:				     ; ...
DOSCODE:8A2F		     mov     es, word ptr ds:CURBUF+2
DOSCODE:8A33		     mov     di, bx
DOSCODE:8A35		     mov     si, offset	NAME1
DOSCODE:8A38		     mov     cx, 5
DOSCODE:8A3B		     rep movsw
DOSCODE:8A3D		     movsb
DOSCODE:8A3E		     mov     al, ds:ATTRIB
DOSCODE:8A41		     stosb
DOSCODE:8A42		     mov     cl, 5
DOSCODE:8A44		     xor     ax, ax
DOSCODE:8A46		     rep stosw
DOSCODE:8A48		     call    DATE16
DOSCODE:8A4B		     xchg    ax, dx
DOSCODE:8A4C		     stosw
DOSCODE:8A4D		     xchg    ax, dx
DOSCODE:8A4E		     stosw
DOSCODE:8A4F		     xor     ax, ax
DOSCODE:8A51		     push    di
DOSCODE:8A52		     stosw
DOSCODE:8A53		     stosw
DOSCODE:8A54		     stosw
DOSCODE:8A55		     mov     si, word ptr ds:CURBUF
DOSCODE:8A59		     test    byte ptr es:[si+5], 40h ; [ES:SI+BUFFINFO.buf_flags],
DOSCODE:8A59					     ; buf_dirty
DOSCODE:8A5E		     jnz     short yesdirty9
DOSCODE:8A60		     call    INC_DIRTY_COUNT
DOSCODE:8A63		     or	     byte ptr es:[si+5], 40h
DOSCODE:8A68
DOSCODE:8A68 yesdirty9:				     ; ...
DOSCODE:8A68		     les     bp, ds:THISDPB
DOSCODE:8A6C		     mov     al, es:[bp+0]   ; [ES:BP+DPB.DRIVE]
DOSCODE:8A70		     push    ax
DOSCODE:8A71		     push    bx
DOSCODE:8A72		     push    es
DOSCODE:8A73		     push    di
DOSCODE:8A74		     les     di, ds:THISSFT
DOSCODE:8A78		     test    byte ptr es:[di+5], 80h ; [ES:DI+SF_ENTRY.sf_flags],
DOSCODE:8A78					     ; devid_device
DOSCODE:8A7D		     jnz     short GotADevice
DOSCODE:8A7F		     push    ds
DOSCODE:8A80		     push    bx
DOSCODE:8A81		     lds     bx, ds:THISDPB
DOSCODE:8A85		     mov     es:[di+7],	bx   ; [ES:DI+SF_ENTRY.sf_devptr]
DOSCODE:8A89		     mov     bx, ds
DOSCODE:8A8B		     mov     es:[di+9],	bx   ; [ES:DI+SF_ENTRY.sf_devptr+2]
DOSCODE:8A8F		     pop     bx
DOSCODE:8A90		     pop     ds
DOSCODE:8A91		     call    DEV_OPEN_SFT
DOSCODE:8A94		     mov     ds:VIRTUAL_OPEN, 1
DOSCODE:8A99
DOSCODE:8A99 GotADevice:			     ; ...
DOSCODE:8A99		     pop     di
DOSCODE:8A9A		     pop     es
DOSCODE:8A9B		     call    FLUSHBUF
DOSCODE:8A9E		     call    CHECK_VIRT_OPEN
DOSCODE:8AA1		     pop     bx
DOSCODE:8AA2		     pop     ax
DOSCODE:8AA3		     pop     si
DOSCODE:8AA4		     mov     ah, al
DOSCODE:8AA6		     jnb     short DOOPEN
DOSCODE:8AA8		     retn
DOSCODE:8AA8 NEWENTRY	     endp
DOSCODE:8AA8
DOSCODE:8AA9
DOSCODE:8AA9 ; =============== S U B R O U T I N E =======================================
DOSCODE:8AA9
DOSCODE:8AA9
DOSCODE:8AA9 DOOPEN	     proc near		     ; ...
DOSCODE:8AA9		     mov     dh, ah
DOSCODE:8AAB		     les     di, ds:THISSFT
DOSCODE:8AAF		     add     di, 4	     ; SF_ENTRY.sf_attr
DOSCODE:8AB2		     xor     al, al
DOSCODE:8AB4		     or	     dh, dh
DOSCODE:8AB6		     js	     short DEV_SFT
DOSCODE:8AB8		     mov     ds, word ptr ds:CURBUF+2
DOSCODE:8ABC		     mov     al, [bx+0Bh]    ; [BX+dir_entry.dir_attr]
DOSCODE:8ABF
DOSCODE:8ABF DEV_SFT:				     ; ...
DOSCODE:8ABF		     stosb
DOSCODE:8AC0		     xor     ax, ax
DOSCODE:8AC2		     mov     al, dh
DOSCODE:8AC4		     or	     al, 40h	     ; devid_file_clean
DOSCODE:8AC6		     stosw
DOSCODE:8AC7		     push    ds
DOSCODE:8AC8		     lds     ax, [bx+1Ah]    ; [BX+dir_entry.dir_first]
DOSCODE:8ACB		     or	     dh, dh
DOSCODE:8ACD		     js	     short DEV_SFT2
DOSCODE:8ACF		     lds     ax, ss:THISDPB
DOSCODE:8AD4
DOSCODE:8AD4 DEV_SFT2:				     ; ...
DOSCODE:8AD4		     stosw
DOSCODE:8AD5		     mov     ax, ds
DOSCODE:8AD7		     pop     ds
DOSCODE:8AD8		     stosw
DOSCODE:8AD9		     push    si
DOSCODE:8ADA		     movsw
DOSCODE:8ADB		     sub     si, 6	     ; dir_entry.dir_size_l - dir_entry.dir_time
DOSCODE:8ADE		     movsw
DOSCODE:8ADF		     movsw
DOSCODE:8AE0		     lodsw
DOSCODE:8AE1		     lodsw
DOSCODE:8AE2		     mov     cx, ax
DOSCODE:8AE4		     lodsw
DOSCODE:8AE5		     or	     dh, dh
DOSCODE:8AE7		     jns     short FILE_SFT1
DOSCODE:8AE9		     xor     ax, ax
DOSCODE:8AEB		     mov     cx, ax
DOSCODE:8AED
DOSCODE:8AED FILE_SFT1:				     ; ...
DOSCODE:8AED		     xchg    ax, cx
DOSCODE:8AEE		     stosw
DOSCODE:8AEF		     xchg    ax, cx
DOSCODE:8AF0		     stosw
DOSCODE:8AF1		     xor     ax, ax
DOSCODE:8AF3		     stosw
DOSCODE:8AF4		     stosw
DOSCODE:8AF5		     or	     dh, dh
DOSCODE:8AF7		     js	     short DEV_SFT3
DOSCODE:8AF9		     stosw
DOSCODE:8AFA		     mov     ax, [bx+1Ah]    ; [BX+dir_entry.dir_first]
DOSCODE:8AFD		     push    di
DOSCODE:8AFE		     sub     di, 1Bh	     ; SF_ENTRY.sf_dirsec
DOSCODE:8B01		     mov     es:[di+35h], ax ; [ES:DI+SF_ENTRY.sf_lstclus]
DOSCODE:8B05		     pop     di
DOSCODE:8B06		     push    ds
DOSCODE:8B07		     push    ss
DOSCODE:8B08		     pop     ds
DOSCODE:8B09		     test    ds:FastOpenFlg, 4 ; Special_Fill_Set
DOSCODE:8B0E		     jz	     short Not_FastOpen
DOSCODE:8B10		     mov     si, offset	FastOpen_Ext_Info
DOSCODE:8B13		     mov     ax, [si+1]	     ; [SI+FEI.dirsec]
DOSCODE:8B16		     stosw
DOSCODE:8B17		     mov     ax, [si+3]	     ; [SI+FEI.dirsec+2]
DOSCODE:8B1A		     stosw
DOSCODE:8B1B		     mov     al, [si]	     ; [SI+FEI.dirpos]
DOSCODE:8B1D		     stosb
DOSCODE:8B1E		     pop     ds
DOSCODE:8B1F		     jmp     short Next_Name
DOSCODE:8B21 ; ---------------------------------------------------------------------------
DOSCODE:8B21
DOSCODE:8B21 Not_FastOpen:			     ; ...
DOSCODE:8B21		     pop     ds
DOSCODE:8B22		     mov     si, word ptr ss:CURBUF
DOSCODE:8B27		     mov     ax, [si+6]	     ; [SI+BUFFINFO.buf_sector]
DOSCODE:8B2A		     stosw
DOSCODE:8B2B		     mov     ax, [si+8]	     ; [SI+BUFFINFO.buf_sector+2]
DOSCODE:8B2E		     stosw
DOSCODE:8B2F		     mov     ax, bx
DOSCODE:8B31		     add     si, 20	     ; BUFINSIZ
DOSCODE:8B34		     sub     ax, si
DOSCODE:8B36		     mov     cl, 32	     ; dir_entry.size
DOSCODE:8B38		     div     cl
DOSCODE:8B3A		     stosb
DOSCODE:8B3B
DOSCODE:8B3B Next_Name:				     ; ...
DOSCODE:8B3B		     jmp     short FILE_SFT2
DOSCODE:8B3D ; ---------------------------------------------------------------------------
DOSCODE:8B3D
DOSCODE:8B3D DEV_SFT3:				     ; ...
DOSCODE:8B3D		     add     di, 7	     ; SF_ENTRY.sf_name-SF_ENTRY.sf_cluspos
DOSCODE:8B40
DOSCODE:8B40 FILE_SFT2:				     ; ...
DOSCODE:8B40		     mov     si, bx
DOSCODE:8B42		     mov     cx, 11
DOSCODE:8B45		     rep movsb
DOSCODE:8B47		     pop     si
DOSCODE:8B48		     push    ss
DOSCODE:8B49		     pop     ds
DOSCODE:8B4A		     clc
DOSCODE:8B4B		     retn
DOSCODE:8B4B DOOPEN	     endp
DOSCODE:8B4B
DOSCODE:8B4C
DOSCODE:8B4C ; =============== S U B R O U T I N E =======================================
DOSCODE:8B4C
DOSCODE:8B4C
DOSCODE:8B4C FREEENT	     proc near		     ; ...
DOSCODE:8B4C		     push    ds
DOSCODE:8B4D		     lds     di, ds:CURBUF
DOSCODE:8B51		     mov     cx, [si]
DOSCODE:8B53		     mov     dx, [di+8]	     ; [DI+BUFFINFO.buf_sector+2]
DOSCODE:8B56		     mov     ss:HIGH_SECTOR, dx
DOSCODE:8B5B		     mov     dx, [di+6]	     ; [DI+BUFFINFO.buf_sector]
DOSCODE:8B5E		     pop     ds
DOSCODE:8B5F		     cmp     cx, 2
DOSCODE:8B62		     jb	     short RET1
DOSCODE:8B64		     cmp     cx, es:[bp+0Dh] ; [ES:BP+DPB.MAX_CLUSTER]
DOSCODE:8B68		     ja	     short RET1
DOSCODE:8B6A		     sub     bx, di
DOSCODE:8B6C		     push    bx
DOSCODE:8B6D		     push    ds:HIGH_SECTOR
DOSCODE:8B71		     push    dx
DOSCODE:8B72		     mov     bx, cx
DOSCODE:8B74		     call    RELEASE
DOSCODE:8B77		     pop     dx
DOSCODE:8B78		     pop     ds:HIGH_SECTOR
DOSCODE:8B7C		     jnb     short GET_BUF_BACK
DOSCODE:8B7E		     pop     bx
DOSCODE:8B7F
DOSCODE:8B7F freeent_retn:			     ; ...
DOSCODE:8B7F		     retn
DOSCODE:8B80 ; ---------------------------------------------------------------------------
DOSCODE:8B80
DOSCODE:8B80 GET_BUF_BACK:			     ; ...
DOSCODE:8B80		     mov     ds:ALLOWED, 18h ; Allowed_RETRY+Allowed_FAIL
DOSCODE:8B85		     xor     al, al
DOSCODE:8B87		     call    GETBUFFR
DOSCODE:8B8A		     pop     bx
DOSCODE:8B8B		     jb	     short freeent_retn
DOSCODE:8B8D		     call    SET_BUF_AS_DIR
DOSCODE:8B90		     add     bx, ds:5E2h
DOSCODE:8B94		     mov     si, bx
DOSCODE:8B96		     add     si, 1Ah
DOSCODE:8B99
DOSCODE:8B99 RET1:				     ; ...
DOSCODE:8B99		     clc
DOSCODE:8B9A		     retn
DOSCODE:8B9A FREEENT	     endp
DOSCODE:8B9A
DOSCODE:8B9B
DOSCODE:8B9B ; =============== S U B R O U T I N E =======================================
DOSCODE:8B9B
DOSCODE:8B9B
DOSCODE:8B9B CHECK_VIRT_OPEN proc near		     ; ...
DOSCODE:8B9B		     push    ax
DOSCODE:8B9C		     lahf
DOSCODE:8B9D		     cmp     ds:VIRTUAL_OPEN, 0
DOSCODE:8BA2		     jz	     short ALL_CLOSED
DOSCODE:8BA4		     mov     ds:VIRTUAL_OPEN, 0
DOSCODE:8BA9		     push    es
DOSCODE:8BAA		     push    di
DOSCODE:8BAB		     les     di, ds:THISSFT
DOSCODE:8BAF		     call    DEV_CLOSE_SFT
DOSCODE:8BB2		     pop     di
DOSCODE:8BB3		     pop     es
DOSCODE:8BB4
DOSCODE:8BB4 ALL_CLOSED:			     ; ...
DOSCODE:8BB4		     sahf
DOSCODE:8BB5		     pop     ax
DOSCODE:8BB6		     retn
DOSCODE:8BB6 CHECK_VIRT_OPEN endp
DOSCODE:8BB6
DOSCODE:8BB7
DOSCODE:8BB7 ; =============== S U B R O U T I N E =======================================
DOSCODE:8BB7
DOSCODE:8BB7
DOSCODE:8BB7 FNDCLUS	     proc near		     ; ...
DOSCODE:8BB7		     push    es
DOSCODE:8BB8		     les     di, ds:THISSFT
DOSCODE:8BBC		     mov     bx, es:[di+35h] ; [ES:DI+SF_ENTRY.sf_lstclus]
DOSCODE:8BC0		     mov     dx, es:[di+19h] ; [ES:DI+SF_ENTRY.sf_cluspos]
DOSCODE:8BC4		     or	     bx, bx
DOSCODE:8BC6		     jz	     short NOCLUS
DOSCODE:8BC8		     sub     cx, dx
DOSCODE:8BCA		     jnb     short FINDIT
DOSCODE:8BCC		     add     cx, dx
DOSCODE:8BCE		     xor     dx, dx
DOSCODE:8BD0		     mov     bx, es:[di+0Bh] ; [ES:DI+SF_ENTRY.sf_firclus]
DOSCODE:8BD4
DOSCODE:8BD4 FINDIT:				     ; ...
DOSCODE:8BD4		     pop     es
DOSCODE:8BD5		     jcxz    short RET9
DOSCODE:8BD7
DOSCODE:8BD7 SKPCLP:				     ; ...
DOSCODE:8BD7		     call    UNPACK
DOSCODE:8BDA		     jb	     short fndclus_retn
DOSCODE:8BDC		     xchg    bx, di
DOSCODE:8BDE		     call    IsEOF
DOSCODE:8BE1		     xchg    bx, di
DOSCODE:8BE3		     jnb     short RET9
DOSCODE:8BE5		     xchg    bx, di
DOSCODE:8BE7		     inc     dx
DOSCODE:8BE8		     loop    SKPCLP
DOSCODE:8BEA
DOSCODE:8BEA RET9:				     ; ...
DOSCODE:8BEA		     clc
DOSCODE:8BEB		     retn
DOSCODE:8BEC ; ---------------------------------------------------------------------------
DOSCODE:8BEC
DOSCODE:8BEC NOCLUS:				     ; ...
DOSCODE:8BEC		     pop     es
DOSCODE:8BED		     inc     cx
DOSCODE:8BEE		     dec     dx
DOSCODE:8BEF		     clc
DOSCODE:8BF0
DOSCODE:8BF0 fndclus_retn:			     ; ...
DOSCODE:8BF0		     retn
DOSCODE:8BF0 FNDCLUS	     endp
DOSCODE:8BF0
DOSCODE:8BF1
DOSCODE:8BF1 ; =============== S U B R O U T I N E =======================================
DOSCODE:8BF1
DOSCODE:8BF1 ; Attributes: noreturn
DOSCODE:8BF1
DOSCODE:8BF1 BUFSEC	     proc near		     ; ...
DOSCODE:8BF1		     mov     dx, ds:CLUSNUM
DOSCODE:8BF5		     mov     bl, ds:SECCLUSPOS
DOSCODE:8BF9		     mov     ds:ALLOWED, 38h ; Allowed_FAIL+Allowed_RETRY+Allowed_IGNORE
DOSCODE:8BFE		     call    FIGREC
DOSCODE:8C01		     call    GETBUFFR
DOSCODE:8C04		     jb	     short fndclus_retn
DOSCODE:8C06		     mov     ds:TRANS, 1
DOSCODE:8C0B		     mov     si, ds:NEXTADD
DOSCODE:8C0F		     mov     di, si
DOSCODE:8C11		     mov     cx, ds:BYTCNT1
DOSCODE:8C15		     add     di, cx
DOSCODE:8C17		     mov     ds:NEXTADD, di
DOSCODE:8C1B		     les     di, ds:CURBUF
DOSCODE:8C1F		     or	     byte ptr es:[di+5], 8 ; [ES:DI+BUFFINFO.buf_flags],
DOSCODE:8C1F					     ; buf_isDATA
DOSCODE:8C24		     lea     di, [di+20]     ;	LEA DI,[DI+BUFINSIZ]
DOSCODE:8C27		     add     di, ds:BYTSECPOS
DOSCODE:8C2B		     clc
DOSCODE:8C2C		     retn
DOSCODE:8C2C BUFSEC	     endp
DOSCODE:8C2C
DOSCODE:8C2D
DOSCODE:8C2D ; =============== S U B R O U T I N E =======================================
DOSCODE:8C2D
DOSCODE:8C2D ; Attributes: noreturn
DOSCODE:8C2D
DOSCODE:8C2D BUFRD	     proc near		     ; ...
DOSCODE:8C2D		     push    es
DOSCODE:8C2E		     xor     ax, ax
DOSCODE:8C30		     call    BUFSEC
DOSCODE:8C30 BUFRD	     endp
DOSCODE:8C30
DOSCODE:8C33 ; ---------------------------------------------------------------------------
DOSCODE:8C33		     jnb     short BUF_OK
DOSCODE:8C35 ; START OF	FUNCTION CHUNK FOR BUFWRT
DOSCODE:8C35
DOSCODE:8C35 BUF_IO_FAIL:			     ; ...
DOSCODE:8C35		     pop     es
DOSCODE:8C36		     jmp     short RBUFPLACED
DOSCODE:8C36 ; END OF FUNCTION CHUNK FOR BUFWRT
DOSCODE:8C38 ; ---------------------------------------------------------------------------
DOSCODE:8C38
DOSCODE:8C38 BUF_OK:				     ; ...
DOSCODE:8C38		     mov     bx, es
DOSCODE:8C3A		     mov     es, word ptr ds:DMAADD+2
DOSCODE:8C3E		     mov     ds, bx
DOSCODE:8C40		     xchg    di, si
DOSCODE:8C42		     shr     cx, 1
DOSCODE:8C44		     rep movsw
DOSCODE:8C46		     adc     cx, 0
DOSCODE:8C49		     rep movsb
DOSCODE:8C4B
DOSCODE:8C4B EVENRD:
DOSCODE:8C4B		     pop     es
DOSCODE:8C4C		     lds     di, ss:CURBUF
DOSCODE:8C51		     lea     bx, [di+20]     ; LEA BX,[DI+BUFINSIZ]
DOSCODE:8C54		     sub     si, bx
DOSCODE:8C56		     call    PLACEBUF
DOSCODE:8C59		     cmp     si, es:[bp+2]   ; [ES:BP+DPB.SECTOR_SIZE]
DOSCODE:8C5D		     jb	     short RBUFPLACEDC
DOSCODE:8C5F		     mov     word ptr ss:BufferQueue, di
DOSCODE:8C64
DOSCODE:8C64 RBUFPLACEDC:			     ; ...
DOSCODE:8C64		     clc
DOSCODE:8C65 ; START OF	FUNCTION CHUNK FOR BUFWRT
DOSCODE:8C65
DOSCODE:8C65 RBUFPLACED:			     ; ...
DOSCODE:8C65		     push    ss
DOSCODE:8C66		     pop     ds
DOSCODE:8C67		     retn
DOSCODE:8C67 ; END OF FUNCTION CHUNK FOR BUFWRT
DOSCODE:8C68
DOSCODE:8C68 ; =============== S U B R O U T I N E =======================================
DOSCODE:8C68
DOSCODE:8C68 ; Attributes: noreturn
DOSCODE:8C68
DOSCODE:8C68 BUFWRT	     proc near		     ; ...
DOSCODE:8C68
DOSCODE:8C68 ; FUNCTION	CHUNK AT DOSCODE:8C35 SIZE 00000003 BYTES
DOSCODE:8C68 ; FUNCTION	CHUNK AT DOSCODE:8C65 SIZE 00000003 BYTES
DOSCODE:8C68
DOSCODE:8C68		     mov     ax, word ptr ds:SECPOS
DOSCODE:8C6B		     add     ax, 1
DOSCODE:8C6E		     mov     word ptr ds:SECPOS, ax
DOSCODE:8C71		     adc     word ptr ds:SECPOS+2, 0
DOSCODE:8C76		     mov     ax, word ptr ds:SECPOS+2
DOSCODE:8C79		     cmp     ax, word ptr ds:VALSEC+2
DOSCODE:8C7D		     mov     al, 1
DOSCODE:8C7F		     ja	     short NOREAD
DOSCODE:8C81		     jb	     short _doread
DOSCODE:8C83		     mov     ax, word ptr ds:SECPOS
DOSCODE:8C86		     cmp     ax, word ptr ds:VALSEC
DOSCODE:8C8A		     mov     al, 1
DOSCODE:8C8C		     ja	     short NOREAD
DOSCODE:8C8E
DOSCODE:8C8E _doread:				     ; ...
DOSCODE:8C8E		     xor     al, al
DOSCODE:8C90
DOSCODE:8C90 NOREAD:				     ; ...
DOSCODE:8C90		     push    es
DOSCODE:8C91		     call    BUFSEC
DOSCODE:8C94 ; ---------------------------------------------------------------------------
DOSCODE:8C94		     jb	     short BUF_IO_FAIL
DOSCODE:8C96		     mov     ds, word ptr ds:DMAADD+2
DOSCODE:8C9A		     shr     cx, 1
DOSCODE:8C9C		     rep movsw
DOSCODE:8C9E		     adc     cx, 0
DOSCODE:8CA1		     rep movsb
DOSCODE:8CA3
DOSCODE:8CA3 EVENWRT:
DOSCODE:8CA3		     pop     es
DOSCODE:8CA4		     lds     bx, ss:CURBUF
DOSCODE:8CA9		     test    byte ptr [bx+5], 40h
DOSCODE:8CAD		     jnz     short yesdirty10
DOSCODE:8CAF		     call    INC_DIRTY_COUNT
DOSCODE:8CB2		     or	     byte ptr [bx+5], 40h ; [BX+BUFFINFO.buf_flags],
DOSCODE:8CB2					     ; buf_dirty
DOSCODE:8CB6
DOSCODE:8CB6 yesdirty10:			     ; ...
DOSCODE:8CB6		     lea     si, [bx+20]     ; LEA BX,[BX+BUFINSIZ]
DOSCODE:8CB9		     sub     di, si
DOSCODE:8CBB		     cmp     di, es:[bp+2]   ; [ES:BP+DPB.SECTOR_SIZE]
DOSCODE:8CBF		     jb	     short WBUFPLACED
DOSCODE:8CC1		     mov     word ptr ss:BufferQueue, bx
DOSCODE:8CC6
DOSCODE:8CC6 WBUFPLACED:			     ; ...
DOSCODE:8CC6		     clc
DOSCODE:8CC7		     push    ss
DOSCODE:8CC8		     pop     ds
DOSCODE:8CC9		     retn
DOSCODE:8CC9 BUFWRT	     endp
DOSCODE:8CC9
DOSCODE:8CCA
DOSCODE:8CCA ; =============== S U B R O U T I N E =======================================
DOSCODE:8CCA
DOSCODE:8CCA
DOSCODE:8CCA NEXTSEC	     proc near		     ; ...
DOSCODE:8CCA		     test    ds:TRANS, 0FFh  ; -1
DOSCODE:8CCF		     jz	     short CLRET
DOSCODE:8CD1		     mov     al, ds:SECCLUSPOS
DOSCODE:8CD4		     inc     al
DOSCODE:8CD6		     cmp     al, es:[bp+4]   ; [ES:BP+DPB.CLUSTER_MASK]
DOSCODE:8CDA		     jbe     short SAVPOS
DOSCODE:8CDC		     mov     bx, ds:CLUSNUM
DOSCODE:8CE0		     call    IsEOF
DOSCODE:8CE3		     jnb     short NONEXT
DOSCODE:8CE5		     call    UNPACK
DOSCODE:8CE8		     jb	     short NONEXT
DOSCODE:8CEA		     mov     ds:CLUSNUM, di
DOSCODE:8CEE		     inc     ds:LASTPOS
DOSCODE:8CF2		     mov     al, 0
DOSCODE:8CF4
DOSCODE:8CF4 SAVPOS:				     ; ...
DOSCODE:8CF4		     mov     ds:SECCLUSPOS, al
DOSCODE:8CF7
DOSCODE:8CF7 CLRET:				     ; ...
DOSCODE:8CF7		     clc
DOSCODE:8CF8		     retn
DOSCODE:8CF9 ; ---------------------------------------------------------------------------
DOSCODE:8CF9
DOSCODE:8CF9 NONEXT:				     ; ...
DOSCODE:8CF9		     stc
DOSCODE:8CFA		     retn
DOSCODE:8CFA NEXTSEC	     endp
DOSCODE:8CFA
DOSCODE:8CFB
DOSCODE:8CFB ; =============== S U B R O U T I N E =======================================
DOSCODE:8CFB
DOSCODE:8CFB
DOSCODE:8CFB OPTIMIZE	     proc near		     ; ...
DOSCODE:8CFB		     push    dx
DOSCODE:8CFC		     push    bx
DOSCODE:8CFD		     mov     al, es:[bp+4]   ; [ES:BP+DPB.CLUSTER_MASK]
DOSCODE:8D01		     inc     al
DOSCODE:8D03		     mov     ah, al
DOSCODE:8D05		     sub     al, dl
DOSCODE:8D07		     mov     dx, cx
DOSCODE:8D09		     mov     cx, 0
DOSCODE:8D0C
DOSCODE:8D0C do_norm3:				     ; ...
DOSCODE:8D0C		     call    UNPACK	     ; OPTCLUS
DOSCODE:8D0F		     jb	     short OP_ERR
DOSCODE:8D11		     add     cl, al
DOSCODE:8D13		     adc     ch, 0
DOSCODE:8D16		     cmp     cx, dx
DOSCODE:8D18		     jnb     short BLKDON
DOSCODE:8D1A		     mov     al, ah
DOSCODE:8D1C		     inc     bx
DOSCODE:8D1D		     cmp     di, bx
DOSCODE:8D1F		     jz	     short do_norm3  ; OPTCLUS
DOSCODE:8D21		     dec     bx
DOSCODE:8D22
DOSCODE:8D22 FINCLUS:				     ; ...
DOSCODE:8D22		     mov     ds:CLUSNUM, bx
DOSCODE:8D26		     sub     dx, cx
DOSCODE:8D28		     push    dx
DOSCODE:8D29		     mov     ax, cx
DOSCODE:8D2B		     mul     word ptr es:[bp+2]	; [ES:BP+DPB.SECTOR_SIZE]
DOSCODE:8D2F		     mov     si, ds:NEXTADD
DOSCODE:8D33		     add     ax, si
DOSCODE:8D35		     mov     ds:NEXTADD, ax
DOSCODE:8D38		     pop     ax
DOSCODE:8D39		     pop     dx
DOSCODE:8D3A		     sub     bx, dx
DOSCODE:8D3C		     add     ds:LASTPOS, bx
DOSCODE:8D40		     pop     bx
DOSCODE:8D41		     call    FIGREC
DOSCODE:8D44		     mov     bx, si
DOSCODE:8D46		     clc
DOSCODE:8D47		     retn
DOSCODE:8D48 ; ---------------------------------------------------------------------------
DOSCODE:8D48
DOSCODE:8D48 OP_ERR:				     ; ...
DOSCODE:8D48		     add     sp, 4
DOSCODE:8D4B		     stc
DOSCODE:8D4C		     retn
DOSCODE:8D4D ; ---------------------------------------------------------------------------
DOSCODE:8D4D
DOSCODE:8D4D BLKDON:				     ; ...
DOSCODE:8D4D		     sub     cx, dx
DOSCODE:8D4F		     sub     ah, cl
DOSCODE:8D51		     dec     ah
DOSCODE:8D53		     mov     ds:SECCLUSPOS, ah
DOSCODE:8D57		     mov     cx, dx
DOSCODE:8D59		     jmp     short FINCLUS
DOSCODE:8D59 OPTIMIZE	     endp
DOSCODE:8D59
DOSCODE:8D5B
DOSCODE:8D5B ; =============== S U B R O U T I N E =======================================
DOSCODE:8D5B
DOSCODE:8D5B
DOSCODE:8D5B FIGREC	     proc near		     ; ...
DOSCODE:8D5B		     push    cx
DOSCODE:8D5C		     mov     cl, es:[bp+5]   ; [ES:BP+DPB.CLUSTER_SHIFT]
DOSCODE:8D60		     dec     dx
DOSCODE:8D61		     dec     dx
DOSCODE:8D62		     mov     ss:HIGH_SECTOR, 0
DOSCODE:8D69		     or	     cl, cl
DOSCODE:8D6B		     jz	     short noshift
DOSCODE:8D6D		     xor     ch, ch
DOSCODE:8D6F
DOSCODE:8D6F rotleft:				     ; ...
DOSCODE:8D6F		     clc
DOSCODE:8D70		     rcl     dx, 1
DOSCODE:8D72		     rcl     ss:HIGH_SECTOR, 1
DOSCODE:8D77		     loop    rotleft
DOSCODE:8D79
DOSCODE:8D79 noshift:				     ; ...
DOSCODE:8D79		     or	     dl, bl
DOSCODE:8D7B		     add     dx, es:[bp+0Bh] ; [ES:BP+DPB.FIRST_SECTOR]
DOSCODE:8D7F		     adc     ss:HIGH_SECTOR, 0
DOSCODE:8D85		     pop     cx
DOSCODE:8D86
DOSCODE:8D86 figrec_retn:			     ; ...
DOSCODE:8D86		     retn
DOSCODE:8D86 FIGREC	     endp
DOSCODE:8D86
DOSCODE:8D87
DOSCODE:8D87 ; =============== S U B R O U T I N E =======================================
DOSCODE:8D87
DOSCODE:8D87
DOSCODE:8D87 ALLOCATE	     proc near		     ; ...
DOSCODE:8D87		     push    bx
DOSCODE:8D88		     xor     bx, bx
DOSCODE:8D8A		     call    UNPACK
DOSCODE:8D8D		     mov     ds:FATBYT,	di
DOSCODE:8D91		     pop     bx
DOSCODE:8D92		     jb	     short figrec_retn
DOSCODE:8D94		     push    cx
DOSCODE:8D95		     push    bx
DOSCODE:8D96		     mov     dx, bx
DOSCODE:8D98		     mov     bx, es:[bp+1Dh] ; [ES:BP+DPB.NEXT_FREE]
DOSCODE:8D9C		     cmp     bx, 2
DOSCODE:8D9F		     ja	     short FINDFRE
DOSCODE:8DA1
DOSCODE:8DA1 ads1:				     ; ...
DOSCODE:8DA1		     mov     word ptr es:[bp+1Dh], 2 ; [ES:BP+DPB.NEXT_FREE]
DOSCODE:8DA7		     mov     bx, 1
DOSCODE:8DAA
DOSCODE:8DAA FINDFRE:				     ; ...
DOSCODE:8DAA		     inc     bx
DOSCODE:8DAB		     cmp     bx, es:[bp+0Dh] ; [ES:BP+DPB.MAX_CLUSTER]
DOSCODE:8DAF		     ja	     short ads7
DOSCODE:8DB1		     call    UNPACK
DOSCODE:8DB4		     jb	     short ads4
DOSCODE:8DB6		     jnz     short FINDFRE
DOSCODE:8DB8		     mov     es:[bp+1Dh], bx ; [ES:BP+DPB.NEXT_FREE]
DOSCODE:8DBC		     xchg    ax, dx
DOSCODE:8DBD		     mov     dx, 1
DOSCODE:8DC0		     call    PACK
DOSCODE:8DC3		     jb	     short ads4
DOSCODE:8DC5		     cmp     word ptr es:[bp+1Fh], 0FFFFh ; [ES:BP+DPB.FREE_CNT],-1
DOSCODE:8DCA		     jz	     short NO_ALLOC
DOSCODE:8DCC		     dec     word ptr es:[bp+1Fh] ; [ES:BP+DPB.FREE_CNT]
DOSCODE:8DD0
DOSCODE:8DD0 NO_ALLOC:				     ; ...
DOSCODE:8DD0		     xchg    ax, dx
DOSCODE:8DD1		     xchg    bx, dx
DOSCODE:8DD3		     mov     ax, dx
DOSCODE:8DD5		     call    PACK
DOSCODE:8DD8		     jb	     short ads4
DOSCODE:8DDA		     xchg    ax, bx
DOSCODE:8DDB		     mov     dx, bx
DOSCODE:8DDD		     loop    FINDFRE
DOSCODE:8DDF		     mov     dx, 0FFFFh
DOSCODE:8DE2		     call    PACK
DOSCODE:8DE5
DOSCODE:8DE5 ads4:				     ; ...
DOSCODE:8DE5		     pop     bx
DOSCODE:8DE6		     pop     cx
DOSCODE:8DE7		     jb	     short figrec_retn
DOSCODE:8DE9		     call    UNPACK
DOSCODE:8DEC		     jb	     short figrec_retn
DOSCODE:8DEE		     call    RESTFATBYT
DOSCODE:8DF1		     jb	     short figrec_retn
DOSCODE:8DF3		     xchg    bx, di
DOSCODE:8DF5		     or	     di, di
DOSCODE:8DF7		     jnz     short figrec_retn
DOSCODE:8DF9		     push    dx
DOSCODE:8DFA		     mov     dl, es:[bp+0]   ; [ES:BP+DPB.DRIVE]
DOSCODE:8DFE		     push    es
DOSCODE:8DFF		     les     di, ds:THISSFT
DOSCODE:8E03		     mov     es:[di+0Bh], bx ; [ES:DI+SF_ENTRY.sf_firclus]
DOSCODE:8E07		     mov     es:[di+35h], bx ; [ES:DI+SF_ENTRY.sf_lstclus]
DOSCODE:8E0B		     pop     es
DOSCODE:8E0C		     pop     dx
DOSCODE:8E0D		     retn
DOSCODE:8E0E ; ---------------------------------------------------------------------------
DOSCODE:8E0E
DOSCODE:8E0E ads7:				     ; ...
DOSCODE:8E0E		     cmp     word ptr es:[bp+1Dh], 2 ; [ES:BP+DPB.NEXT_FREE]
DOSCODE:8E13		     jnz     short ads1
DOSCODE:8E15		     pop     bx
DOSCODE:8E16		     mov     dx, 0FFFFh
DOSCODE:8E19		     call    RELBLKS
DOSCODE:8E1C		     pop     ax
DOSCODE:8E1D		     sub     ax, cx
DOSCODE:8E1F		     call    RESTFATBYT
DOSCODE:8E22		     mov     ds:DISK_FULL, 1
DOSCODE:8E27		     stc
DOSCODE:8E28		     retn
DOSCODE:8E28 ALLOCATE	     endp
DOSCODE:8E28
DOSCODE:8E29
DOSCODE:8E29 ; =============== S U B R O U T I N E =======================================
DOSCODE:8E29
DOSCODE:8E29
DOSCODE:8E29 RESTFATBYT	     proc near		     ; ...
DOSCODE:8E29		     push    bx
DOSCODE:8E2A		     push    dx
DOSCODE:8E2B		     push    di
DOSCODE:8E2C		     xor     bx, bx
DOSCODE:8E2E		     mov     dx, ds:FATBYT
DOSCODE:8E32		     call    PACK
DOSCODE:8E35		     pop     di
DOSCODE:8E36		     pop     dx
DOSCODE:8E37		     pop     bx
DOSCODE:8E38
DOSCODE:8E38 RELEASE_flush:			     ; ...
DOSCODE:8E38		     retn
DOSCODE:8E38 RESTFATBYT	     endp
DOSCODE:8E38
DOSCODE:8E39
DOSCODE:8E39 ; =============== S U B R O U T I N E =======================================
DOSCODE:8E39
DOSCODE:8E39
DOSCODE:8E39 RELEASE	     proc near		     ; ...
DOSCODE:8E39		     xor     dx, dx
DOSCODE:8E3B
DOSCODE:8E3B RELBLKS:				     ; ...
DOSCODE:8E3B		     call    UNPACK
DOSCODE:8E3E		     jb	     short RELEASE_flush
DOSCODE:8E40		     jz	     short RELEASE_flush
DOSCODE:8E42		     mov     ax, di
DOSCODE:8E44		     push    dx
DOSCODE:8E45		     call    PACK
DOSCODE:8E48		     pop     dx
DOSCODE:8E49		     jb	     short RELEASE_flush
DOSCODE:8E4B		     or	     dx, dx
DOSCODE:8E4D		     jnz     short NO_DEALLOC
DOSCODE:8E4F		     cmp     word ptr es:[bp+1Fh], 0FFFFh
DOSCODE:8E54		     jz	     short NO_DEALLOC
DOSCODE:8E56		     inc     word ptr es:[bp+1Fh]
DOSCODE:8E5A
DOSCODE:8E5A NO_DEALLOC:			     ; ...
DOSCODE:8E5A		     mov     bx, ax
DOSCODE:8E5C		     dec     ax
DOSCODE:8E5D		     jz	     short RELEASE_flush
DOSCODE:8E5F		     call    IsEOF
DOSCODE:8E62		     jb	     short RELEASE
DOSCODE:8E64
DOSCODE:8E64 RET12:				     ; ...
DOSCODE:8E64		     retn
DOSCODE:8E64 RELEASE	     endp
DOSCODE:8E64
DOSCODE:8E65
DOSCODE:8E65 ; =============== S U B R O U T I N E =======================================
DOSCODE:8E65
DOSCODE:8E65
DOSCODE:8E65 GETEOF	     proc near		     ; ...
DOSCODE:8E65		     call    UNPACK
DOSCODE:8E68		     jb	     short RET12
DOSCODE:8E6A		     push    bx
DOSCODE:8E6B		     mov     bx, di
DOSCODE:8E6D		     call    IsEOF
DOSCODE:8E70		     pop     bx
DOSCODE:8E71		     jnb     short RET12
DOSCODE:8E73		     mov     bx, di
DOSCODE:8E75		     jmp     short GETEOF
DOSCODE:8E75 GETEOF	     endp
DOSCODE:8E75
DOSCODE:8E77
DOSCODE:8E77 ; =============== S U B R O U T I N E =======================================
DOSCODE:8E77
DOSCODE:8E77
DOSCODE:8E77 MAKEFCB	     proc near		     ; ...
DOSCODE:8E77		     mov     ss:SpaceFlag, 0
DOSCODE:8E7D		     xor     dl, dl
DOSCODE:8E7F		     test    al, 2	     ; DRVBIT
DOSCODE:8E81		     jnz     short DEFDRV
DOSCODE:8E83		     mov     byte ptr es:[di], 0
DOSCODE:8E87
DOSCODE:8E87 DEFDRV:				     ; ...
DOSCODE:8E87		     inc     di
DOSCODE:8E88		     mov     cx, 8
DOSCODE:8E8B		     test    al, 4	     ; NAMBIT
DOSCODE:8E8D		     xchg    ax, bx
DOSCODE:8E8E		     mov     al, 20h ; ' '
DOSCODE:8E90		     jz	     short FILLB
DOSCODE:8E92		     add     di, cx
DOSCODE:8E94		     xor     cx, cx
DOSCODE:8E96
DOSCODE:8E96 FILLB:				     ; ...
DOSCODE:8E96		     rep stosb
DOSCODE:8E98		     mov     cl, 3
DOSCODE:8E9A		     test    bl, 8	     ; EXTBIT
DOSCODE:8E9D		     jz	     short FILLB2
DOSCODE:8E9F		     add     di, cx
DOSCODE:8EA1		     xor     cx, cx
DOSCODE:8EA3
DOSCODE:8EA3 FILLB2:				     ; ...
DOSCODE:8EA3		     rep stosb
DOSCODE:8EA5		     xchg    ax, cx
DOSCODE:8EA6		     stosw
DOSCODE:8EA7		     stosw
DOSCODE:8EA8		     sub     di, 16
DOSCODE:8EAB		     test    bl, 1	     ; SCANSEPARATOR
DOSCODE:8EAE		     jz	     short SKPSPC
DOSCODE:8EB0		     call    SCANB
DOSCODE:8EB3		     call    DELIM
DOSCODE:8EB6		     jnz     short NOSCAN
DOSCODE:8EB8		     inc     si
DOSCODE:8EB9
DOSCODE:8EB9 SKPSPC:				     ; ...
DOSCODE:8EB9		     call    SCANB
DOSCODE:8EBC
DOSCODE:8EBC NOSCAN:				     ; ...
DOSCODE:8EBC		     call    GETLET
DOSCODE:8EBF		     jbe     short NODRV
DOSCODE:8EC1		     cmp     byte ptr [si], ':'
DOSCODE:8EC4		     jnz     short NODRV
DOSCODE:8EC6		     inc     si
DOSCODE:8EC7		     sub     al, '@'
DOSCODE:8EC9		     jbe     short BADDRV
DOSCODE:8ECB		     push    ax
DOSCODE:8ECC		     call    GetVisDrv
DOSCODE:8ECF		     pop     ax
DOSCODE:8ED0		     jnb     short HAVDRV
DOSCODE:8ED2		     cmp     ss:DrvErr,	1Ah  ; error_not_DOS_disk
DOSCODE:8ED8		     jz	     short HAVDRV
DOSCODE:8EDA
DOSCODE:8EDA BADDRV:				     ; ...
DOSCODE:8EDA		     mov     dl, 0FFh	     ; -1
DOSCODE:8EDC
DOSCODE:8EDC HAVDRV:				     ; ...
DOSCODE:8EDC		     stosb
DOSCODE:8EDD		     inc     si
DOSCODE:8EDE		     dec     di
DOSCODE:8EDF
DOSCODE:8EDF NODRV:				     ; ...
DOSCODE:8EDF		     dec     si
DOSCODE:8EE0		     inc     di
DOSCODE:8EE1
DOSCODE:8EE1 NORMSCAN:				     ; ...
DOSCODE:8EE1		     mov     cx, 8
DOSCODE:8EE4		     call    GETWORD
DOSCODE:8EE7		     cmp     byte ptr [si], '.'
DOSCODE:8EEA		     jnz     short NODOT
DOSCODE:8EEC		     inc     si
DOSCODE:8EED		     test    byte ptr ss:DOS34_FLAG+1, 1 ; (DBCS_VOLID2>>8)
DOSCODE:8EF3		     jz	     short VOLOK
DOSCODE:8EF5		     movsb
DOSCODE:8EF6		     mov     cx, 2
DOSCODE:8EF9		     jmp     short contvol
DOSCODE:8EFB ; ---------------------------------------------------------------------------
DOSCODE:8EFB
DOSCODE:8EFB VOLOK:				     ; ...
DOSCODE:8EFB		     mov     cx, 3
DOSCODE:8EFE
DOSCODE:8EFE contvol:				     ; ...
DOSCODE:8EFE		     call    MUSTGETWORD
DOSCODE:8F01
DOSCODE:8F01 NODOT:				     ; ...
DOSCODE:8F01		     mov     al, dl
DOSCODE:8F03		     and     ss:DOS34_FLAG, 0FEFFh ; ~DBCS_VOLID2
DOSCODE:8F0A		     retn
DOSCODE:8F0A MAKEFCB	     endp
DOSCODE:8F0A
DOSCODE:8F0B ; ---------------------------------------------------------------------------
DOSCODE:8F0B ; START OF	FUNCTION CHUNK FOR GETWORD
DOSCODE:8F0B
DOSCODE:8F0B NONAM:				     ; ...
DOSCODE:8F0B		     add     di, cx
DOSCODE:8F0D		     dec     si
DOSCODE:8F0E		     retn
DOSCODE:8F0E ; END OF FUNCTION CHUNK FOR GETWORD
DOSCODE:8F0F
DOSCODE:8F0F ; =============== S U B R O U T I N E =======================================
DOSCODE:8F0F
DOSCODE:8F0F
DOSCODE:8F0F GETWORD	     proc near		     ; ...
DOSCODE:8F0F
DOSCODE:8F0F ; FUNCTION	CHUNK AT DOSCODE:8F0B SIZE 00000004 BYTES
DOSCODE:8F0F
DOSCODE:8F0F		     call    GETLET
DOSCODE:8F12		     jbe     short NONAM
DOSCODE:8F14		     dec     si
DOSCODE:8F15
DOSCODE:8F15 MUSTGETWORD:			     ; ...
DOSCODE:8F15		     call    GETLET
DOSCODE:8F18		     jnz     short MustCheckCX
DOSCODE:8F1A		     test    ss:SpaceFlag, 0FFh
DOSCODE:8F20		     jz	     short FILLNAM
DOSCODE:8F22		     cmp     al, 20h ; ' '
DOSCODE:8F24		     jnz     short FILLNAM
DOSCODE:8F26
DOSCODE:8F26 MustCheckCX:			     ; ...
DOSCODE:8F26		     jcxz    short MUSTGETWORD
DOSCODE:8F28		     dec     cx
DOSCODE:8F29		     cmp     al, 2Ah ; '*'
DOSCODE:8F2B		     jnz     short NOSTAR
DOSCODE:8F2D		     mov     al, 3Fh ; '?'
DOSCODE:8F2F		     rep stosb
DOSCODE:8F31
DOSCODE:8F31 NOSTAR:				     ; ...
DOSCODE:8F31		     stosb
DOSCODE:8F32		     cmp     al, 3Fh ; '?'
DOSCODE:8F34		     jnz     short MUSTGETWORD
DOSCODE:8F36		     or	     dl, 1
DOSCODE:8F39		     jmp     short MUSTGETWORD
DOSCODE:8F3B ; ---------------------------------------------------------------------------
DOSCODE:8F3B
DOSCODE:8F3B FILLNAM:				     ; ...
DOSCODE:8F3B		     mov     al, 20h ; ' '
DOSCODE:8F3D		     rep stosb
DOSCODE:8F3F		     dec     si
DOSCODE:8F40		     retn
DOSCODE:8F40 GETWORD	     endp
DOSCODE:8F40
DOSCODE:8F41
DOSCODE:8F41 ; =============== S U B R O U T I N E =======================================
DOSCODE:8F41
DOSCODE:8F41
DOSCODE:8F41 SCANB	     proc near		     ; ...
DOSCODE:8F41		     lodsb
DOSCODE:8F42		     call    SPCHK
DOSCODE:8F45		     jz	     short SCANB
DOSCODE:8F47		     dec     si
DOSCODE:8F48
DOSCODE:8F48 scanb_retn:			     ; ...
DOSCODE:8F48		     retn
DOSCODE:8F48 SCANB	     endp
DOSCODE:8F48
DOSCODE:8F49
DOSCODE:8F49 ; =============== S U B R O U T I N E =======================================
DOSCODE:8F49
DOSCODE:8F49
DOSCODE:8F49 NameTrans	     proc near		     ; ...
DOSCODE:8F49		     mov     ss:SpaceFlag, 1
DOSCODE:8F4F		     push    ss
DOSCODE:8F50		     pop     es
DOSCODE:8F51		     mov     di, offset	NAME1
DOSCODE:8F54		     push    di
DOSCODE:8F55		     mov     ax, 2020h	     ; '  '
DOSCODE:8F58		     mov     cx, 5
DOSCODE:8F5B		     stosb
DOSCODE:8F5C		     rep stosw
DOSCODE:8F5E		     xor     al, al
DOSCODE:8F60		     mov     dl, al
DOSCODE:8F62		     stosb
DOSCODE:8F63		     pop     di
DOSCODE:8F64		     call    NORMSCAN
DOSCODE:8F67		     cmp     ss:NAME1, 0E5h
DOSCODE:8F6D		     jnz     short scanb_retn
DOSCODE:8F6F		     mov     ss:NAME1, 5
DOSCODE:8F75		     retn
DOSCODE:8F75 NameTrans	     endp
DOSCODE:8F75
DOSCODE:8F75 ; ---------------------------------------------------------------------------
DOSCODE:8F76 CharType	     db	66h,66h,66h,66h, 6,66h,66h,66h ; ...
DOSCODE:8F76		     db	66h,66h,66h,66h,66h,66h,66h,66h
DOSCODE:8F76		     db	0F8h,0F6h,0FFh,0FFh,0FFh,4Fh,0F4h,6Eh
DOSCODE:8F76		     db	0FFh,0FFh,0FFh,0FFh,0FFh,44h,44h,0F4h
DOSCODE:8F76		     db	0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
DOSCODE:8F76		     db	0FFh,0FFh,0FFh,0FFh,0FFh,6Fh,66h,0FFh
DOSCODE:8F76		     db	0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0FFh
DOSCODE:8F76		     db	0FFh,0FFh,0FFh,0FFh,0FFh,0FFh,0F4h
DOSCODE:8FB5 ; ---------------------------------------------------------------------------
DOSCODE:8FB5
DOSCODE:8FB5 GETLET:				     ; ...
DOSCODE:8FB5		     lodsb
DOSCODE:8FB6
DOSCODE:8FB6 ; =============== S U B R O U T I N E =======================================
DOSCODE:8FB6
DOSCODE:8FB6
DOSCODE:8FB6 UCase	     proc near		     ; ...
DOSCODE:8FB6		     push    bx
DOSCODE:8FB7		     mov     bx, offset	FILE_UCASE_TAB_2 ; FILE_UCASE_TAB+2
DOSCODE:8FBA
DOSCODE:8FBA gl_0:				     ; ...
DOSCODE:8FBA		     cmp     al, 'a'         ; 61h
DOSCODE:8FBC		     jb	     short gl_2
DOSCODE:8FBE		     cmp     al, 'z'         ; 7Ah
DOSCODE:8FC0		     ja	     short gl_1
DOSCODE:8FC2		     sub     al, 20h
DOSCODE:8FC4
DOSCODE:8FC4 gl_1:				     ; ...
DOSCODE:8FC4		     cmp     al, 80h
DOSCODE:8FC6		     jb	     short gl_2
DOSCODE:8FC8		     sub     al, 80h
DOSCODE:8FCA		     push    ds
DOSCODE:8FCB		     mov     ds, cs:DosDSeg
DOSCODE:8FD0		     xlat
DOSCODE:8FD1		     pop     ds
DOSCODE:8FD2
DOSCODE:8FD2 gl_2:				     ; ...
DOSCODE:8FD2		     push    ax
DOSCODE:8FD3		     call    GetCharType
DOSCODE:8FD6		     test    al, 1	     ; FCHK
DOSCODE:8FD8		     pop     ax
DOSCODE:8FD9		     pop     bx
DOSCODE:8FDA		     retn
DOSCODE:8FDA UCase	     endp
DOSCODE:8FDA
DOSCODE:8FDB
DOSCODE:8FDB ; =============== S U B R O U T I N E =======================================
DOSCODE:8FDB
DOSCODE:8FDB
DOSCODE:8FDB GETLET3	     proc near		     ; ...
DOSCODE:8FDB		     push    bx
DOSCODE:8FDC		     jmp     short gl_0
DOSCODE:8FDC GETLET3	     endp
DOSCODE:8FDC
DOSCODE:8FDE
DOSCODE:8FDE ; =============== S U B R O U T I N E =======================================
DOSCODE:8FDE
DOSCODE:8FDE
DOSCODE:8FDE DELIM	     proc near		     ; ...
DOSCODE:8FDE		     push    ax
DOSCODE:8FDF		     call    GetCharType
DOSCODE:8FE2		     test    al, 2	     ; FDELIM
DOSCODE:8FE4		     pop     ax
DOSCODE:8FE5		     retn
DOSCODE:8FE5 DELIM	     endp
DOSCODE:8FE5
DOSCODE:8FE6
DOSCODE:8FE6 ; =============== S U B R O U T I N E =======================================
DOSCODE:8FE6
DOSCODE:8FE6
DOSCODE:8FE6 SPCHK	     proc near		     ; ...
DOSCODE:8FE6		     push    ax
DOSCODE:8FE7		     call    GetCharType
DOSCODE:8FEA		     test    al, 4	     ; FSPCHK
DOSCODE:8FEC		     pop     ax
DOSCODE:8FED		     retn
DOSCODE:8FED SPCHK	     endp
DOSCODE:8FED
DOSCODE:8FEE
DOSCODE:8FEE ; =============== S U B R O U T I N E =======================================
DOSCODE:8FEE
DOSCODE:8FEE
DOSCODE:8FEE GetCharType     proc near		     ; ...
DOSCODE:8FEE		     cmp     al, 7Eh ; '~'   ; CharType_last
DOSCODE:8FF0		     jnb     short gct_90
DOSCODE:8FF2		     push    bx
DOSCODE:8FF3		     mov     bx, offset	CharType
DOSCODE:8FF6		     shr     al, 1
DOSCODE:8FF8		     xlat    byte ptr cs:[bx] ;	cs xlat
DOSCODE:8FFA		     pop     bx
DOSCODE:8FFB		     jnb     short gct_80
DOSCODE:8FFD		     shr     al, 1
DOSCODE:8FFF		     shr     al, 1
DOSCODE:9001		     shr     al, 1
DOSCODE:9003		     shr     al, 1
DOSCODE:9005
DOSCODE:9005 gct_80:				     ; ...
DOSCODE:9005		     and     al, 0Fh
DOSCODE:9007		     retn
DOSCODE:9008 ; ---------------------------------------------------------------------------
DOSCODE:9008
DOSCODE:9008 gct_90:				     ; ...
DOSCODE:9008		     mov     al, 0Fh
DOSCODE:900A		     retn
DOSCODE:900A GetCharType     endp
DOSCODE:900A
DOSCODE:900B
DOSCODE:900B ; =============== S U B R O U T I N E =======================================
DOSCODE:900B
DOSCODE:900B
DOSCODE:900B PATHCHRCMP	     proc near		     ; ...
DOSCODE:900B		     cmp     al, 2Fh ; '/'
DOSCODE:900D		     jbe     short PathRet
DOSCODE:900F		     cmp     al, 5Ch ; '\'
DOSCODE:9011		     retn
DOSCODE:9012 ; ---------------------------------------------------------------------------
DOSCODE:9012
DOSCODE:9012 GotFor:				     ; ...
DOSCODE:9012		     mov     al, 5Ch ; '\'
DOSCODE:9014		     retn
DOSCODE:9015 ; ---------------------------------------------------------------------------
DOSCODE:9015
DOSCODE:9015 PathRet:				     ; ...
DOSCODE:9015		     jz	     short GotFor
DOSCODE:9017		     retn
DOSCODE:9017 PATHCHRCMP	     endp
DOSCODE:9017
DOSCODE:9017 ; ---------------------------------------------------------------------------
DOSCODE:9018 LowInt23Addr    dw	offset LowInt23	     ; ...
DOSCODE:901A LowInt23Seg     dw	0		     ; ...
DOSCODE:901C LowInt24Addr    dw	offset LowInt24	     ; ...
DOSCODE:901E LowInt24Seg     dw	0		     ; ...
DOSCODE:9020 LowInt28Addr    dw	offset LowInt28	     ; ...
DOSCODE:9022 LowInt28Seg     dw	0		     ; ...
DOSCODE:9024
DOSCODE:9024 ; =============== S U B R O U T I N E =======================================
DOSCODE:9024
DOSCODE:9024
DOSCODE:9024 DSKSTATCHK	     proc near		     ; ...
DOSCODE:9024		     cmp     ss:INDOS, 1
DOSCODE:902A		     jz	     short _RET37
DOSCODE:902C		     retn
DOSCODE:902D ; ---------------------------------------------------------------------------
DOSCODE:902D
DOSCODE:902D _RET37:				     ; ...
DOSCODE:902D		     push    cx
DOSCODE:902E		     push    es
DOSCODE:902F		     push    bx
DOSCODE:9030		     push    ds
DOSCODE:9031		     push    si
DOSCODE:9032		     mov     bx, ss
DOSCODE:9034		     mov     es, bx
DOSCODE:9036		     mov     ds, bx
DOSCODE:9038		     mov     ss:DSKSTCOM, 5  ; DEVRDND
DOSCODE:903E		     mov     ss:DSKSTCALL, 14 ;	DRDNDHL
DOSCODE:9044		     mov     ss:DSKSTST, 0
DOSCODE:904B		     mov     bx, offset	DSKSTCALL
DOSCODE:904E		     lds     si, ss:BCON
DOSCODE:9053		     call    DEVIOCALL2
DOSCODE:9056		     test    byte ptr ss:DSKSTST+1, 2 ;	(STBUI>>8)
DOSCODE:905C		     jz	     short _GotCh
DOSCODE:905E		     xor     al, al
DOSCODE:9060
DOSCODE:9060 RET36:				     ; ...
DOSCODE:9060		     pop     si
DOSCODE:9061		     pop     ds
DOSCODE:9062		     pop     bx
DOSCODE:9063		     pop     es
DOSCODE:9064		     pop     cx
DOSCODE:9065		     retn
DOSCODE:9066 ; ---------------------------------------------------------------------------
DOSCODE:9066
DOSCODE:9066 _GotCh:				     ; ...
DOSCODE:9066		     mov     al, ss:DSKCHRET
DOSCODE:906A		     cmp     al, 3	     ; "C"-"@"
DOSCODE:906C		     jnz     short RET36
DOSCODE:906E		     mov     ss:DSKSTCOM, 4  ; DEVRD
DOSCODE:9074		     mov     ss:DSKSTCALL, 22 ;	DRDWRHL
DOSCODE:907A		     mov     ss:DSKCHRET, cl
DOSCODE:907F		     mov     ss:DSKSTST, 0
DOSCODE:9086		     mov     ss:DSKSTCNT, 1
DOSCODE:908D		     call    DEVIOCALL2
DOSCODE:9090		     pop     si
DOSCODE:9091		     pop     ds
DOSCODE:9092		     pop     bx
DOSCODE:9093		     pop     es
DOSCODE:9094		     pop     cx
DOSCODE:9095		     jmp     CNTCHAND
DOSCODE:9095 DSKSTATCHK	     endp
DOSCODE:9095
DOSCODE:9098 ; ---------------------------------------------------------------------------
DOSCODE:9098
DOSCODE:9098 NOSTOP:				     ; ...
DOSCODE:9098		     cmp     al, 10h	     ; "P"-"@"
DOSCODE:909A		     jnz     short check_next
DOSCODE:909C		     cmp     ss:SCAN_FLAG, 0
DOSCODE:90A2		     jz	     short INCHKJ
DOSCODE:90A4		     retn
DOSCODE:90A5 ; ---------------------------------------------------------------------------
DOSCODE:90A5
DOSCODE:90A5 check_next:			     ; ...
DOSCODE:90A5		     cmp     al, 3	     ; "C"-"@"
DOSCODE:90A7		     jz	     short INCHKJ
DOSCODE:90A9
DOSCODE:90A9 check_end:				     ; ...
DOSCODE:90A9		     retn
DOSCODE:90AA ; ---------------------------------------------------------------------------
DOSCODE:90AA
DOSCODE:90AA INCHKJ:				     ; ...
DOSCODE:90AA		     jmp     INCHK
DOSCODE:90AD
DOSCODE:90AD ; =============== S U B R O U T I N E =======================================
DOSCODE:90AD
DOSCODE:90AD
DOSCODE:90AD SPOOLINT	     proc near		     ; ...
DOSCODE:90AD		     pushf
DOSCODE:90AE		     cmp     ss:IDLEINT, 0
DOSCODE:90B4		     jz	     short POPFRET
DOSCODE:90B6		     cmp     ss:ERRORMODE, 0
DOSCODE:90BC		     jnz     short POPFRET
DOSCODE:90BE		     push    word ptr ss:IDLEINT
DOSCODE:90C3		     cmp     ss:DosHasHMA, 0
DOSCODE:90C9		     jnz     short do_low_int28
DOSCODE:90CB		     int     28h	     ; DOS 2+ internal - KEYBOARD BUSY LOOP
DOSCODE:90CD		     jmp     short spool_ret_addr
DOSCODE:90CF ; ---------------------------------------------------------------------------
DOSCODE:90CF
DOSCODE:90CF do_low_int28:			     ; ...
DOSCODE:90CF		     call    dword ptr cs:LowInt28Addr ; call far [cs:LowInt28Addr]
DOSCODE:90D4
DOSCODE:90D4 spool_ret_addr:			     ; ...
DOSCODE:90D4		     pop     word ptr ss:IDLEINT
DOSCODE:90D9
DOSCODE:90D9 POPFRET:				     ; ...
DOSCODE:90D9		     popf
DOSCODE:90DA
DOSCODE:90DA _RET18:				     ; ...
DOSCODE:90DA		     retn
DOSCODE:90DA SPOOLINT	     endp
DOSCODE:90DA
DOSCODE:90DB ; ---------------------------------------------------------------------------
DOSCODE:90DB
DOSCODE:90DB STATCHK:				     ; ...
DOSCODE:90DB		     call    DSKSTATCHK
DOSCODE:90DE		     push    bx
DOSCODE:90DF		     xor     bx, bx
DOSCODE:90E1		     call    GET_IO_SFT
DOSCODE:90E4		     pop     bx
DOSCODE:90E5		     jb	     short _RET18
DOSCODE:90E7		     mov     ah, 1
DOSCODE:90E9		     call    IOFUNC
DOSCODE:90EC		     jz	     short SPOOLINT
DOSCODE:90EE		     cmp     al, 13h	     ; 'S'-'@'
DOSCODE:90F0		     jnz     short NOSTOP
DOSCODE:90F2		     cmp     ss:SCAN_FLAG, 0
DOSCODE:90F8		     jnz     short check_end
DOSCODE:90FA		     xor     ah, ah
DOSCODE:90FC		     call    IOFUNC
DOSCODE:90FF		     jmp     short PAUSOSTRT
DOSCODE:9101 ; ---------------------------------------------------------------------------
DOSCODE:9101
DOSCODE:9101 PRINT_ON_OFF:			     ; ...
DOSCODE:9101		     not     ss:PFLAG
DOSCODE:9106		     push    bx
DOSCODE:9107		     mov     bx, 4
DOSCODE:910A		     call    GET_IO_SFT
DOSCODE:910D		     pop     bx
DOSCODE:910E		     jb	     short _RET18
DOSCODE:9110		     push    es
DOSCODE:9111		     push    di
DOSCODE:9112		     push    ds
DOSCODE:9113		     pop     es
DOSCODE:9114		     mov     di, si
DOSCODE:9116		     test    byte ptr es:[di+6], 8 ; [ES:DI+SF_ENTRY.sf_flags+1],
DOSCODE:9116					     ; (sf_net_spool>>8)
DOSCODE:911B		     jz	     short NORM_PR
DOSCODE:911D		     push    ax
DOSCODE:911E		     mov     ax, 1126h
DOSCODE:9121		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	???
DOSCODE:9121					     ; Return: CF set on error,	AX = error code
DOSCODE:9121					     ; STACK unchanged
DOSCODE:9123		     pop     ax
DOSCODE:9124		     jnb     short NORM_PR
DOSCODE:9126		     mov     ss:PFLAG, 0
DOSCODE:912C		     push    ax
DOSCODE:912D		     mov     ax, 1124h
DOSCODE:9130		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	???
DOSCODE:9130					     ; ES:DI ->	SFT, SS	= DOS CS
DOSCODE:9132		     pop     ax
DOSCODE:9133		     jmp     short RETP6
DOSCODE:9135 ; ---------------------------------------------------------------------------
DOSCODE:9135
DOSCODE:9135 NORM_PR:				     ; ...
DOSCODE:9135		     cmp     ss:PFLAG, 0
DOSCODE:913B		     jnz     short PRNOPN
DOSCODE:913D		     call    DEV_CLOSE_SFT
DOSCODE:9140		     jmp     short RETP6
DOSCODE:9142 ; ---------------------------------------------------------------------------
DOSCODE:9142
DOSCODE:9142 PRNOPN:				     ; ...
DOSCODE:9142		     call    DEV_OPEN_SFT
DOSCODE:9145
DOSCODE:9145 RETP6:				     ; ...
DOSCODE:9145		     pop     di
DOSCODE:9146		     pop     es
DOSCODE:9147
DOSCODE:9147 STATCHK_RETN:			     ; ...
DOSCODE:9147		     retn
DOSCODE:9148 ; ---------------------------------------------------------------------------
DOSCODE:9148
DOSCODE:9148 PAUSOLP:				     ; ...
DOSCODE:9148		     call    SPOOLINT
DOSCODE:914B
DOSCODE:914B PAUSOSTRT:				     ; ...
DOSCODE:914B		     mov     ah, 1
DOSCODE:914D		     call    IOFUNC
DOSCODE:9150		     jz	     short PAUSOLP
DOSCODE:9152
DOSCODE:9152 INCHK:				     ; ...
DOSCODE:9152		     push    bx
DOSCODE:9153		     xor     bx, bx
DOSCODE:9155		     call    GET_IO_SFT
DOSCODE:9158		     pop     bx
DOSCODE:9159		     jb	     short STATCHK_RETN
DOSCODE:915B		     xor     ah, ah
DOSCODE:915D		     call    IOFUNC
DOSCODE:9160		     cmp     al, 10h	     ; "P"-"@"
DOSCODE:9162		     jz	     short PRINT_ON_OFF	; PRINTON
DOSCODE:9164		     cmp     al, 3	     ; "C"-"@"
DOSCODE:9166		     jnz     short STATCHK_RETN
DOSCODE:9168
DOSCODE:9168 CNTCHAND:				     ; ...
DOSCODE:9168		     test    byte ptr ss:DOS34_FLAG+1, 2 ; (CTRL_BREAK_FLAG>>8)
DOSCODE:916E		     jnz     short around_deadlock
DOSCODE:9170		     mov     al, 3
DOSCODE:9172		     call    BUFOUT
DOSCODE:9175		     call    CRLF
DOSCODE:9178
DOSCODE:9178 around_deadlock:			     ; ...
DOSCODE:9178		     push    ss
DOSCODE:9179		     pop     ds
DOSCODE:917A		     cmp     ds:CONSWAP, 0
DOSCODE:917F		     jz	     short NOSWAP
DOSCODE:9181		     call    SWAPBACK
DOSCODE:9184
DOSCODE:9184 NOSWAP:				     ; ...
DOSCODE:9184		     cli
DOSCODE:9185		     mov     ss, ds:USER_SS
DOSCODE:9189		     mov     sp, ds:USER_SP
DOSCODE:918D		     call    restore_world
DOSCODE:9190		     pop     es
DOSCODE:9191		     push    ds
DOSCODE:9192		     mov     ds, cs:DosDSeg
DOSCODE:9197		     mov     ds:INDOS, 0
DOSCODE:919C		     mov     ds:ERRORMODE, 0
DOSCODE:91A1		     mov     ds:ConC_Spsave, sp
DOSCODE:91A5		     add     ds:ConC_Spsave, 2
DOSCODE:91AA		     cmp     ds:DosHasHMA, 0
DOSCODE:91AF		     pop     ds
DOSCODE:91B0		     jnz     short do_low_int23
DOSCODE:91B2		     clc
DOSCODE:91B3		     int     23h	     ; DOS - CONTROL "C" EXIT ADDRESS
DOSCODE:91B3					     ; Return: return via RETF 2 with CF set
DOSCODE:91B3					     ; DOS will	abort program with errorlevel 0
DOSCODE:91B3					     ; else
DOSCODE:91B3					     ; interrupted DOS call continues
DOSCODE:91B5		     jmp     short ctrlc_ret_addr
DOSCODE:91B7 ; ---------------------------------------------------------------------------
DOSCODE:91B7
DOSCODE:91B7 do_low_int23:			     ; ...
DOSCODE:91B7		     clc
DOSCODE:91B8		     call    dword ptr cs:LowInt23Addr ; call far [cs:LowInt23Addr]
DOSCODE:91BD
DOSCODE:91BD ctrlc_ret_addr:			     ; ...
DOSCODE:91BD		     cli
DOSCODE:91BE		     push    ax
DOSCODE:91BF		     mov     ax, ds
DOSCODE:91C1		     mov     ds, cs:DosDSeg
DOSCODE:91C6		     mov     ds:TEMPSEG, ax
DOSCODE:91C9		     pop     ax
DOSCODE:91CA		     mov     ds:USER_IN_AX, ax
DOSCODE:91CD		     pushf
DOSCODE:91CE		     pop     ax
DOSCODE:91CF		     cmp     sp, ds:ConC_Spsave
DOSCODE:91D3		     jnz     short ctrlc_try_new
DOSCODE:91D5
DOSCODE:91D5 ctrlc_repeat:			     ; ...
DOSCODE:91D5		     mov     ax, ds:USER_IN_AX
DOSCODE:91D8		     mov     ds, ds:TEMPSEG
DOSCODE:91DC
DOSCODE:91DC COMMANDJ:				     ; ...
DOSCODE:91DC		     jmp     COMMAND
DOSCODE:91DF ; ---------------------------------------------------------------------------
DOSCODE:91DF
DOSCODE:91DF ctrlc_try_new:			     ; ...
DOSCODE:91DF		     add     sp, 2
DOSCODE:91E2		     test    al, 1	     ; f_Carry
DOSCODE:91E4		     jz	     short ctrlc_repeat
DOSCODE:91E6		     mov     ds, ds:TEMPSEG
DOSCODE:91EA
DOSCODE:91EA ctrlc_abort:			     ; ...
DOSCODE:91EA		     mov     ax, 4C00h	     ; (EXIT<<8)+0
DOSCODE:91ED		     push    ds
DOSCODE:91EE		     mov     ds, cs:DosDSeg
DOSCODE:91F3		     mov     ds:DidCTRLC, 0FFh ; -1
DOSCODE:91F8		     pop     ds
DOSCODE:91F9		     jmp     short COMMANDJ
DOSCODE:91FB ; ---------------------------------------------------------------------------
DOSCODE:91FB
DOSCODE:91FB DIVOV:				     ; ...
DOSCODE:91FB		     mov     si, offset	DIVMES ; "\r\nDivide overflow\r\n"
DOSCODE:91FE		     mov     bx, cs:DivMesLen
DOSCODE:9203		     mov     ss, cs:DosDSeg
DOSCODE:9208		     mov     sp, offset	AUXSTACK
DOSCODE:920B		     call    _OUTMES	     ; RealDivOv
DOSCODE:920E		     jmp     short ctrlc_abort
DOSCODE:9210
DOSCODE:9210 ; =============== S U B R O U T I N E =======================================
DOSCODE:9210
DOSCODE:9210
DOSCODE:9210 _OUTMES	     proc near		     ; ...
DOSCODE:9210		     push    ss
DOSCODE:9211		     pop     es
DOSCODE:9212		     push    ss
DOSCODE:9213		     pop     ds
DOSCODE:9214		     mov     ds:DSKSTCOM, 8  ; DEVWRT
DOSCODE:9219		     mov     ds:DSKSTCALL, 16h ; DRDWRHL
DOSCODE:921E		     mov     ds:DSKSTST, 0
DOSCODE:9224		     mov     ds:DSKSTCNT, bx
DOSCODE:9228		     mov     bx, offset	DSKSTCALL
DOSCODE:922B		     mov     ds:DSKCHRET_1, si ; [DSKCHRET+1]
DOSCODE:922F		     mov     ds:DSKCHRET_3, cs ; [DSKCHRET+3]
DOSCODE:9233		     lds     si, ds:BCON
DOSCODE:9237		     call    DEVIOCALL2
DOSCODE:923A		     mov     es:DSKCHRET_1, offset DEVIOBUF ; [ES:DSKCHRET+1]
DOSCODE:9241		     mov     es:DSKSTCNT, 1
DOSCODE:9248		     retn
DOSCODE:9248 _OUTMES	     endp
DOSCODE:9248
DOSCODE:9249
DOSCODE:9249 ; =============== S U B R O U T I N E =======================================
DOSCODE:9249
DOSCODE:9249
DOSCODE:9249 CHARHARD	     proc near		     ; ...
DOSCODE:9249		     cmp     ss:ERRORMODE, 0
DOSCODE:924F		     jnz     short chard1
DOSCODE:9251		     or	     ah, 10h
DOSCODE:9254		     test    ss:PFLAG, 0FFh  ; -1
DOSCODE:925A		     jnz     short ctrlp
DOSCODE:925C
DOSCODE:925C chard1:				     ; ...
DOSCODE:925C		     or	     ah, 38h	     ; Allowed_IGNORE+Allowed_RETRY+Allowed_FAIL
DOSCODE:925F
DOSCODE:925F ctrlp:				     ; ...
DOSCODE:925F		     mov     ss:ALLOWED, ah
DOSCODE:9264		     mov     word ptr ss:EXITHOLD+2, es
DOSCODE:9269		     mov     word ptr ss:EXITHOLD, bp
DOSCODE:926E		     push    si
DOSCODE:926F		     and     di, 0FFh	     ; STECODE
DOSCODE:9273		     mov     bp, ds
DOSCODE:9275		     call    FATALC
DOSCODE:9278		     pop     si
DOSCODE:9279		     retn
DOSCODE:9279 CHARHARD	     endp
DOSCODE:9279
DOSCODE:927A ; ---------------------------------------------------------------------------
DOSCODE:927A
DOSCODE:927A HARDERR:				     ; ...
DOSCODE:927A		     xchg    ax, di
DOSCODE:927B		     and     di, 0FFh	     ; STECODE
DOSCODE:927F		     cmp     di, 0	     ; error_I24_write_protect
DOSCODE:9282		     jnz     short NOSETWRPERR
DOSCODE:9284		     push    ax
DOSCODE:9285		     mov     al, es:[bp+0]
DOSCODE:9289		     mov     ss:WPERR, al
DOSCODE:928D		     pop     ax
DOSCODE:928E
DOSCODE:928E NOSETWRPERR:			     ; ...
DOSCODE:928E		     sub     ax, cx
DOSCODE:9290		     add     dx, ax
DOSCODE:9292		     push    dx
DOSCODE:9293		     mul     word ptr es:[bp+2]	; [ES:BP+DPB.SECTOR_SIZE]
DOSCODE:9297		     pop     dx
DOSCODE:9298		     add     bx, ax
DOSCODE:929A		     xor     ah, ah
DOSCODE:929C		     cmp     dx, es:[bp+6]   ; [ES:BP+DPB.FIRST_FAT]
DOSCODE:92A0		     jb	     short ERRINT
DOSCODE:92A2		     inc     ah
DOSCODE:92A4		     cmp     dx, es:[bp+11h] ; [ES:BP+DPB.DIR_SECTOR]
DOSCODE:92A8		     jnb     short TESTDIR
DOSCODE:92AA		     mov     word ptr es:[bp+1Fh], 0FFFFh ; [ES:BP+DPB.FREE_CNT],-1
DOSCODE:92B0		     jmp     short ERRINT
DOSCODE:92B2 ; ---------------------------------------------------------------------------
DOSCODE:92B2
DOSCODE:92B2 TESTDIR:				     ; ...
DOSCODE:92B2		     inc     ah
DOSCODE:92B4		     cmp     dx, es:[bp+0Bh] ; [ES:BP+DPB.FIRST_SECTOR]
DOSCODE:92B8		     jb	     short ERRINT
DOSCODE:92BA		     inc     ah
DOSCODE:92BC
DOSCODE:92BC ERRINT:				     ; ...
DOSCODE:92BC		     shl     ah, 1
DOSCODE:92BE		     or	     ah, ss:READOP
DOSCODE:92C3		     or	     ah, ss:ALLOWED
DOSCODE:92C8
DOSCODE:92C8 FATAL:				     ; ...
DOSCODE:92C8		     mov     al, es:[bp+0]
DOSCODE:92CC
DOSCODE:92CC FATAL1:				     ; ...
DOSCODE:92CC		     mov     word ptr ss:EXITHOLD+2, es
DOSCODE:92D1		     mov     word ptr ss:EXITHOLD, bp
DOSCODE:92D6		     les     si, es:[bp+13h] ; [ES:BP+DPB.DRIVER_ADDR]
DOSCODE:92DA		     mov     bp, es
DOSCODE:92DC
DOSCODE:92DC FATALC:				     ; ...
DOSCODE:92DC		     call    SET_I24_EXTENDED_ERROR
DOSCODE:92DF		     cmp     di, 0Ch	     ; error_I24_gen_failure
DOSCODE:92E2		     jbe     short NET_I24_ENTRY
DOSCODE:92E4		     mov     di, 0Ch
DOSCODE:92E7
DOSCODE:92E7 NET_I24_ENTRY:			     ; ...
DOSCODE:92E7		     cmp     ss:ERRORMODE, 0 ; GOT_RIGHT_CODE
DOSCODE:92ED		     jz	     short NoSetFail
DOSCODE:92EF		     mov     al, 3
DOSCODE:92F1		     jmp     short FailRet
DOSCODE:92F3 ; ---------------------------------------------------------------------------
DOSCODE:92F3
DOSCODE:92F3 NoSetFail:				     ; ...
DOSCODE:92F3		     mov     ss:CONTSTK, sp
DOSCODE:92F8		     push    ss
DOSCODE:92F9		     pop     es
DOSCODE:92FA		     cmp     ss:SFN, 0FFFFh  ; -1
DOSCODE:9300		     jz	     short _NoFree
DOSCODE:9302		     push    ds
DOSCODE:9303		     push    si
DOSCODE:9304		     lds     si, ss:PJFN
DOSCODE:9309		     mov     byte ptr [si], 0FFh
DOSCODE:930C		     pop     si
DOSCODE:930D		     pop     ds
DOSCODE:930E
DOSCODE:930E _NoFree:				     ; ...
DOSCODE:930E		     cli
DOSCODE:930F		     inc     ss:ERRORMODE
DOSCODE:9314		     dec     ss:INDOS
DOSCODE:9319		     test    ss:EXTOPEN_ON, 2 ;	EXT_OPEN_I24_OFF
DOSCODE:931F		     jz	     short i24yes
DOSCODE:9321		     mov     al, 3
DOSCODE:9323		     jmp     short passi24
DOSCODE:9325 ; ---------------------------------------------------------------------------
DOSCODE:9325
DOSCODE:9325 i24yes:				     ; ...
DOSCODE:9325		     mov     ss, ss:USER_SS
DOSCODE:932A		     mov     sp, es:USER_SP
DOSCODE:932F		     cmp     es:DosHasHMA, 0
DOSCODE:9335		     jnz     short do_low_int24
DOSCODE:9337		     int     24h	     ; DOS - FATAL ERROR HANDLER ADDRESS
DOSCODE:9337					     ; Automatically called upon detection of unrecoverable I/O	error.
DOSCODE:9339		     jmp     short criterr_ret_addr
DOSCODE:933B ; ---------------------------------------------------------------------------
DOSCODE:933B
DOSCODE:933B do_low_int24:			     ; ...
DOSCODE:933B		     call    dword ptr cs:LowInt24Addr ; call far [cs:LowInt24Addr]
DOSCODE:9340
DOSCODE:9340 criterr_ret_addr:			     ; ...
DOSCODE:9340		     mov     es:USER_SP, sp
DOSCODE:9345		     mov     es:USER_SS, ss
DOSCODE:934A		     mov     bp, es
DOSCODE:934C		     mov     ss, bp
DOSCODE:934E
DOSCODE:934E passi24:				     ; ...
DOSCODE:934E		     mov     sp, ss:CONTSTK
DOSCODE:9353		     inc     ss:INDOS
DOSCODE:9358		     mov     ss:ERRORMODE, 0
DOSCODE:935E		     sti
DOSCODE:935F
DOSCODE:935F FailRet:				     ; ...
DOSCODE:935F		     les     bp, ss:EXITHOLD
DOSCODE:9364		     cmp     al, 1
DOSCODE:9366		     jb	     short CheckIgnore
DOSCODE:9368		     jz	     short CheckRetry
DOSCODE:936A		     cmp     al, 3
DOSCODE:936C		     jnz     short DoAbort
DOSCODE:936E		     test    ss:ALLOWED, 8
DOSCODE:9374		     jz	     short DoAbort
DOSCODE:9376
DOSCODE:9376 DoFail:				     ; ...
DOSCODE:9376		     mov     al, 3
DOSCODE:9378		     test    ss:EXTOPEN_ON, 2 ;	EXT_OPEN_I24_OFF
DOSCODE:937E		     jnz     short CleanUp
DOSCODE:9380		     inc     ss:FAILERR
DOSCODE:9385
DOSCODE:9385 CleanUp:				     ; ...
DOSCODE:9385		     mov     ss:WPERR, 0FFh  ; -1
DOSCODE:938B		     cmp     ss:SFN, 0FFFFh  ; -1
DOSCODE:9391		     jnz     short CleanUp2
DOSCODE:9393		     retn
DOSCODE:9394 ; ---------------------------------------------------------------------------
DOSCODE:9394
DOSCODE:9394 CleanUp2:				     ; ...
DOSCODE:9394		     push    ds
DOSCODE:9395		     push    si
DOSCODE:9396		     push    ax
DOSCODE:9397		     mov     ax, ss:SFN
DOSCODE:939B		     lds     si, ss:PJFN
DOSCODE:93A0		     mov     [si], al
DOSCODE:93A2		     pop     ax
DOSCODE:93A3		     pop     si
DOSCODE:93A4		     pop     ds
DOSCODE:93A5		     retn
DOSCODE:93A6 ; ---------------------------------------------------------------------------
DOSCODE:93A6
DOSCODE:93A6 CheckIgnore:			     ; ...
DOSCODE:93A6		     test    ss:ALLOWED, 20h ; Allowed_IGNORE
DOSCODE:93AC		     jz	     short DoFail
DOSCODE:93AE		     jmp     short CleanUp
DOSCODE:93B0 ; ---------------------------------------------------------------------------
DOSCODE:93B0
DOSCODE:93B0 CheckRetry:			     ; ...
DOSCODE:93B0		     test    ss:ALLOWED, 10h ; Allowed_RETRY
DOSCODE:93B6		     jz	     short DoFail
DOSCODE:93B8		     jmp     short CleanUp
DOSCODE:93BA ; ---------------------------------------------------------------------------
DOSCODE:93BA
DOSCODE:93BA DoAbort:				     ; ...
DOSCODE:93BA		     push    ss
DOSCODE:93BB		     pop     ds
DOSCODE:93BC		     cmp     ds:CONSWAP, 0
DOSCODE:93C1		     jz	     short NOSWAP2
DOSCODE:93C3		     call    SWAPBACK
DOSCODE:93C6
DOSCODE:93C6 NOSWAP2:				     ; ...
DOSCODE:93C6		     cmp     ds:fAborting, 0
DOSCODE:93CB		     jnz     short DoFail
DOSCODE:93CD		     mov     ds:EXIT_TYPE, 2 ; EXIT_HARD_ERROR
DOSCODE:93D2		     xor     al, al
DOSCODE:93D4		     jmp     exit_inner
DOSCODE:93D7 ; ---------------------------------------------------------------------------
DOSCODE:93D7
DOSCODE:93D7 reset_environment:			     ; ...
DOSCODE:93D7		     push    ds
DOSCODE:93D8		     mov     ah, 82h
DOSCODE:93DA		     int     2Ah	     ; Microsoft Networks - END	DOS CRITICAL SECTIONS 0	THROUGH	7
DOSCODE:93DC		     mov     ss:fAborting, 0FFh	; -1
DOSCODE:93E2		     mov     ax, 1122h
DOSCODE:93E5		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	PROCESS	TERMINATION HOOK
DOSCODE:93E5					     ; SS = DOS	CS
DOSCODE:93E7		     mov     al, 22h	     ; int_terminate
DOSCODE:93E9		     call    $GET_INTERRUPT_VECTOR
DOSCODE:93EC		     pop     cx
DOSCODE:93ED		     push    es
DOSCODE:93EE		     push    bx
DOSCODE:93EF		     mov     bx, ss:CurrentPDB
DOSCODE:93F4		     mov     ds, bx
DOSCODE:93F6		     mov     ax, ds:16h	     ; [PDB.PARENT_PID]
DOSCODE:93F9		     cmp     ax, bx
DOSCODE:93FB		     jz	     short reset_return
DOSCODE:93FD		     cmp     bx, cx
DOSCODE:93FF		     jnz     short reset_return
DOSCODE:9401		     push    ax
DOSCODE:9402		     cmp     ss:EXIT_TYPE, 3 ; EXIT_KEEP_PROCESS
DOSCODE:9408		     jz	     short reset_to_parent
DOSCODE:940A		     call    arena_free_process
DOSCODE:940D		     call    DOS_ABORT
DOSCODE:9410
DOSCODE:9410 reset_to_parent:			     ; ...
DOSCODE:9410		     pop     ss:CurrentPDB
DOSCODE:9415
DOSCODE:9415 reset_return:			     ; ...
DOSCODE:9415		     push    ss
DOSCODE:9416		     pop     ds
DOSCODE:9417		     mov     al, 0FFh	     ; -1
DOSCODE:9419		     call    ECritDisk
DOSCODE:941C		     call    FLUSHBUF
DOSCODE:941F		     call    LCritDisk
DOSCODE:9422		     call    CHECK_VIRT_OPEN
DOSCODE:9425		     cli
DOSCODE:9426		     mov     ds:INDOS, 0
DOSCODE:942B		     mov     ds:WPERR, 0FFh
DOSCODE:9430		     mov     ds:fAborting, 0
DOSCODE:9435		     pop     word ptr ds:EXITHOLD
DOSCODE:9439		     pop     word ptr ds:EXITHOLD+2
DOSCODE:943D		     mov     ds, ds:CurrentPDB
DOSCODE:9441		     mov     ss, word ptr ds:BCLOCK+2
DOSCODE:9445		     mov     sp, word ptr ds:BCLOCK
DOSCODE:9449		     call    restore_world
DOSCODE:944C		     pop     es
DOSCODE:944D		     push    ax
DOSCODE:944E		     mov     ax, ds
DOSCODE:9450		     mov     ds, cs:DosDSeg
DOSCODE:9455		     mov     ds:TEMPSEG, ax
DOSCODE:9458		     pop     ax
DOSCODE:9459		     mov     ds:USER_SP, ax
DOSCODE:945C		     pop     ax
DOSCODE:945D		     pop     ax
DOSCODE:945E		     pop     ax
DOSCODE:945F		     lahf
DOSCODE:9460		     xchg    ah, al
DOSCODE:9462		     and     al, 2
DOSCODE:9464		     mov     ah, 0F2h
DOSCODE:9466		     push    ax
DOSCODE:9467		     push    word ptr ds:EXITHOLD+2
DOSCODE:946B		     push    word ptr ds:EXITHOLD
DOSCODE:946F		     mov     ax, ds:USER_SP
DOSCODE:9472		     mov     ds, ds:TEMPSEG
DOSCODE:9476		     iret
DOSCODE:9477
DOSCODE:9477 ; =============== S U B R O U T I N E =======================================
DOSCODE:9477
DOSCODE:9477
DOSCODE:9477 SET_I24_EXTENDED_ERROR proc near	     ; ...
DOSCODE:9477		     push    ax
DOSCODE:9478		     mov     ax, offset	FIRST_BUFF_ADDR	; ErrMap24End
DOSCODE:947B		     sub     ax, offset	ErrMap24
DOSCODE:947E		     push    ds
DOSCODE:947F		     mov     ds, cs:DosDSeg
DOSCODE:9484		     cmp     di, ax
DOSCODE:9486		     mov     ax, di
DOSCODE:9488		     jnb     short NoTrans
DOSCODE:948A		     mov     al, ds:ErrMap24[di] ; [ErrMap24+di]
DOSCODE:948E		     xor     ah, ah
DOSCODE:9490
DOSCODE:9490 NoTrans:				     ; ...
DOSCODE:9490		     mov     ds:EXTERR,	ax
DOSCODE:9493		     pop     ds
DOSCODE:9494		     pop     ax
DOSCODE:9495		     push    si
DOSCODE:9496		     mov     si, offset	ERR_TABLE_24
DOSCODE:9499		     call    CAL_LK
DOSCODE:949C		     pop     si
DOSCODE:949D		     retn
DOSCODE:949D SET_I24_EXTENDED_ERROR endp
DOSCODE:949D
DOSCODE:949E
DOSCODE:949E ; =============== S U B R O U T I N E =======================================
DOSCODE:949E
DOSCODE:949E
DOSCODE:949E IsEOF	     proc near		     ; ...
DOSCODE:949E		     cmp     word ptr es:[bp+0Dh], 0FF6h ; [ES:BP+DPB.MAX_CLUSTER],
DOSCODE:949E					     ; 4096-10
DOSCODE:94A4		     jnb     short EOF16
DOSCODE:94A6		     cmp     bx, 0FF0h
DOSCODE:94AA		     jz	     short IsEOF_other
DOSCODE:94AC		     cmp     bx, 0FF8h
DOSCODE:94B0
DOSCODE:94B0 IsEOF_other:			     ; ...
DOSCODE:94B0		     retn
DOSCODE:94B1 ; ---------------------------------------------------------------------------
DOSCODE:94B1
DOSCODE:94B1 EOF16:				     ; ...
DOSCODE:94B1		     cmp     bx, 0FFF8h
DOSCODE:94B4		     retn
DOSCODE:94B4 IsEOF	     endp
DOSCODE:94B4
DOSCODE:94B5
DOSCODE:94B5 ; =============== S U B R O U T I N E =======================================
DOSCODE:94B5
DOSCODE:94B5
DOSCODE:94B5 UNPACK	     proc near		     ; ...
DOSCODE:94B5		     or	     bx, bx
DOSCODE:94B7		     jnz     short up_cont
DOSCODE:94B9		     mov     di, ds:CL0FATENTRY
DOSCODE:94BD		     or	     di, di
DOSCODE:94BF		     retn
DOSCODE:94C0 ; ---------------------------------------------------------------------------
DOSCODE:94C0
DOSCODE:94C0 up_cont:				     ; ...
DOSCODE:94C0		     cmp     bx, es:[bp+0Dh] ; [ES:BP+DPB.MAX_CLUSTER]
DOSCODE:94C4		     ja	     short HURTFAT
DOSCODE:94C6		     call    MAPCLUSTER
DOSCODE:94C9		     jb	     short _DoContext
DOSCODE:94CB		     mov     di, [di]
DOSCODE:94CD		     jnz     short High12
DOSCODE:94CF		     mov     si, es:[bp+0Dh] ; [ES:BP+DPB.MAX_CLUSTER]
DOSCODE:94D3		     cmp     si, 0FF6h	     ; 4096-10
DOSCODE:94D7		     jb	     short Unpack12
DOSCODE:94D9		     or	     di, di
DOSCODE:94DB		     jmp     short _DoContext
DOSCODE:94DD ; ---------------------------------------------------------------------------
DOSCODE:94DD
DOSCODE:94DD High12:				     ; ...
DOSCODE:94DD		     shr     di, 1
DOSCODE:94DF		     shr     di, 1
DOSCODE:94E1		     shr     di, 1
DOSCODE:94E3		     shr     di, 1
DOSCODE:94E5
DOSCODE:94E5 Unpack12:				     ; ...
DOSCODE:94E5		     and     di, 0FFFh
DOSCODE:94E9
DOSCODE:94E9 _DoContext:			     ; ...
DOSCODE:94E9		     push    ss
DOSCODE:94EA		     pop     ds
DOSCODE:94EB		     retn
DOSCODE:94EC ; ---------------------------------------------------------------------------
DOSCODE:94EC
DOSCODE:94EC HURTFAT:				     ; ...
DOSCODE:94EC		     mov     word ptr es:[bp+1Fh], 0FFFFh ; [ES:BP+DPB.FREE_CNT],-1
DOSCODE:94F2		     push    ax
DOSCODE:94F3		     mov     ah, 88h	     ; Allowed_FAIL+80h
DOSCODE:94F5		     mov     ss:ALLOWED, 8   ; Allowed_FAIL
DOSCODE:94FB		     mov     di, 0FFFh
DOSCODE:94FE		     call    FATAL
DOSCODE:9501		     cmp     al, 3
DOSCODE:9503		     clc
DOSCODE:9504		     jnz     short OKU_RET
DOSCODE:9506		     stc
DOSCODE:9507
DOSCODE:9507 OKU_RET:				     ; ...
DOSCODE:9507		     pop     ax
DOSCODE:9508
DOSCODE:9508 hurtfat_retn:			     ; ...
DOSCODE:9508		     retn
DOSCODE:9508 UNPACK	     endp
DOSCODE:9508
DOSCODE:9509
DOSCODE:9509 ; =============== S U B R O U T I N E =======================================
DOSCODE:9509
DOSCODE:9509
DOSCODE:9509 PACK	     proc near		     ; ...
DOSCODE:9509		     or	     bx, bx
DOSCODE:950B		     jnz     short p_cont
DOSCODE:950D		     mov     ds:CL0FATENTRY, dx
DOSCODE:9511		     retn
DOSCODE:9512 ; ---------------------------------------------------------------------------
DOSCODE:9512
DOSCODE:9512 p_cont:				     ; ...
DOSCODE:9512		     call    MAPCLUSTER
DOSCODE:9515		     jb	     short _DoContext
DOSCODE:9517		     mov     si, [di]
DOSCODE:9519		     jz	     short ALIGNED
DOSCODE:951B		     push    cx
DOSCODE:951C		     mov     cl, 4
DOSCODE:951E		     shl     dx, cl
DOSCODE:9520		     pop     cx
DOSCODE:9521		     and     si, 0Fh
DOSCODE:9524		     jmp     short PACKIN
DOSCODE:9526 ; ---------------------------------------------------------------------------
DOSCODE:9526
DOSCODE:9526 ALIGNED:				     ; ...
DOSCODE:9526		     cmp     word ptr es:[bp+0Dh], 0FF6h ; [ES:BP+DPB.MAX_CLUSTER],
DOSCODE:9526					     ; 4096-10
DOSCODE:952C		     jnb     short Pack16
DOSCODE:952E		     and     si, 0F000h
DOSCODE:9532		     and     dx, 0FFFh
DOSCODE:9536		     jmp     short PACKIN
DOSCODE:9538 ; ---------------------------------------------------------------------------
DOSCODE:9538
DOSCODE:9538 Pack16:				     ; ...
DOSCODE:9538		     xor     si, si
DOSCODE:953A
DOSCODE:953A PACKIN:				     ; ...
DOSCODE:953A		     or	     si, dx
DOSCODE:953C		     mov     [di], si
DOSCODE:953E		     lds     si, ss:CURBUF
DOSCODE:9543		     test    byte ptr [si+5], 40h ; [SI+BUFFINFO.buf_flags],buf_dirty
DOSCODE:9547		     jnz     short yesdirty11
DOSCODE:9549		     call    INC_DIRTY_COUNT
DOSCODE:954C		     or	     byte ptr [si+5], 40h
DOSCODE:9550
DOSCODE:9550 yesdirty11:			     ; ...
DOSCODE:9550		     cmp     ss:CLUSSPLIT, 0
DOSCODE:9556		     push    ss
DOSCODE:9557		     pop     ds
DOSCODE:9558		     jz	     short hurtfat_retn
DOSCODE:955A		     push    ax
DOSCODE:955B		     push    bx
DOSCODE:955C		     push    cx
DOSCODE:955D		     mov     ax, ds:CLUSSAVE
DOSCODE:9560		     mov     ds, word ptr ds:CURBUF+2
DOSCODE:9564		     add     si, 20	     ; BUFINSIZ
DOSCODE:9567		     mov     [si], ah
DOSCODE:9569		     push    ss
DOSCODE:956A		     pop     ds
DOSCODE:956B		     push    ax
DOSCODE:956C		     mov     dx, word ptr ds:CLUSSEC+2
DOSCODE:9570		     mov     ds:HIGH_SECTOR, dx
DOSCODE:9574		     mov     dx, word ptr ds:CLUSSEC
DOSCODE:9578		     mov     si, 1
DOSCODE:957B		     xor     al, al
DOSCODE:957D		     call    GETBUFFRB
DOSCODE:9580		     pop     ax
DOSCODE:9581		     jb	     short POPP_RET
DOSCODE:9583		     lds     di, ds:CURBUF
DOSCODE:9587		     test    byte ptr [di+5], 40h
DOSCODE:958B		     jnz     short yesdirty12
DOSCODE:958D		     call    INC_DIRTY_COUNT
DOSCODE:9590		     or	     byte ptr [di+5], 40h ; [DI+BUFFINFO.buf_flags],buf_dirty
DOSCODE:9594
DOSCODE:9594 yesdirty12:			     ; ...
DOSCODE:9594		     add     di, 20	     ; BUFINSIZ
DOSCODE:9597		     dec     di
DOSCODE:9598		     add     di, es:[bp+2]   ; [ES:BP+DPB.SECTOR_SIZE]
DOSCODE:959C		     mov     [di], al
DOSCODE:959E		     clc
DOSCODE:959F
DOSCODE:959F POPP_RET:				     ; ...
DOSCODE:959F		     push    ss
DOSCODE:95A0		     pop     ds
DOSCODE:95A1		     pop     cx
DOSCODE:95A2		     pop     bx
DOSCODE:95A3		     pop     ax
DOSCODE:95A4		     retn
DOSCODE:95A4 PACK	     endp
DOSCODE:95A4
DOSCODE:95A5
DOSCODE:95A5 ; =============== S U B R O U T I N E =======================================
DOSCODE:95A5
DOSCODE:95A5
DOSCODE:95A5 MAPCLUSTER	     proc near		     ; ...
DOSCODE:95A5		     mov     ds:CLUSSPLIT, 0
DOSCODE:95AA		     push    ax
DOSCODE:95AB		     push    bx
DOSCODE:95AC		     push    cx
DOSCODE:95AD		     push    dx
DOSCODE:95AE		     mov     ax, bx
DOSCODE:95B0		     cmp     word ptr es:[bp+0Dh], 0FF6h ; [ES:BP+DPB.MAX_CLUSTER],
DOSCODE:95B0					     ; 4096-10
DOSCODE:95B6		     jnb     short Map16
DOSCODE:95B8		     shr     ax, 1
DOSCODE:95BA
DOSCODE:95BA Map16:				     ; ...
DOSCODE:95BA		     xor     di, di
DOSCODE:95BC		     add     ax, bx
DOSCODE:95BE		     adc     di, di
DOSCODE:95C0		     mov     cx, es:[bp+2]   ; [ES:BP+DPB.SECTOR_SIZE]
DOSCODE:95C4		     cmp     cx, 512
DOSCODE:95C8		     jnz     short _DoDiv
DOSCODE:95CA		     mov     dx, ax
DOSCODE:95CC		     and     dx, 1FFh
DOSCODE:95D0		     mov     al, ah
DOSCODE:95D2		     shr     di, 1
DOSCODE:95D4		     rcr     al, 1
DOSCODE:95D6		     xor     ah, ah
DOSCODE:95D8		     jmp     short DivDone
DOSCODE:95DA ; ---------------------------------------------------------------------------
DOSCODE:95DA
DOSCODE:95DA _DoDiv:				     ; ...
DOSCODE:95DA		     mov     dx, di
DOSCODE:95DC		     div     cx
DOSCODE:95DE
DOSCODE:95DE DivDone:				     ; ...
DOSCODE:95DE		     add     ax, es:[bp+6]   ; ES:BP+DPB.FIRST_FAT]
DOSCODE:95E2		     dec     cx
DOSCODE:95E3		     push    ax
DOSCODE:95E4		     push    dx
DOSCODE:95E5		     push    cx
DOSCODE:95E6		     mov     dx, ax
DOSCODE:95E8		     mov     ds:HIGH_SECTOR, 0
DOSCODE:95EE		     xor     al, al
DOSCODE:95F0		     mov     si, 1
DOSCODE:95F3		     call    GETBUFFRB
DOSCODE:95F6		     pop     cx
DOSCODE:95F7		     pop     ax
DOSCODE:95F8		     pop     dx
DOSCODE:95F9		     jb	     short MAP_POP
DOSCODE:95FB		     lds     si, ds:CURBUF
DOSCODE:95FF		     lea     di, [si+20]     ; [SI+BUFINSIZ]
DOSCODE:9602		     add     di, ax
DOSCODE:9604		     cmp     ax, cx
DOSCODE:9606		     jnz     short MAPRET
DOSCODE:9608		     mov     al, [di]
DOSCODE:960A		     push    ss
DOSCODE:960B		     pop     ds
DOSCODE:960C		     inc     ds:CLUSSPLIT
DOSCODE:9610		     mov     byte ptr ds:CLUSSAVE, al
DOSCODE:9613		     mov     word ptr ds:CLUSSEC, dx
DOSCODE:9617		     mov     word ptr ds:CLUSSEC+2, 0
DOSCODE:961D		     inc     dx
DOSCODE:961E		     mov     ds:HIGH_SECTOR, 0
DOSCODE:9624		     xor     al, al
DOSCODE:9626		     mov     si, 1
DOSCODE:9629		     call    GETBUFFRB
DOSCODE:962C		     jb	     short MAP_POP
DOSCODE:962E		     lds     si, ds:CURBUF
DOSCODE:9632		     lea     di, [si+20]     ; [SI+BUFINSIZ]
DOSCODE:9635		     mov     al, [di]
DOSCODE:9637		     push    ss
DOSCODE:9638		     pop     ds
DOSCODE:9639		     mov     byte ptr ds:CLUSSAVE+1, al
DOSCODE:963C		     mov     di, offset	CLUSSAVE
DOSCODE:963F
DOSCODE:963F MAPRET:				     ; ...
DOSCODE:963F		     pop     dx
DOSCODE:9640		     pop     cx
DOSCODE:9641		     pop     bx
DOSCODE:9642		     xor     ax, ax
DOSCODE:9644		     cmp     word ptr es:[bp+0Dh], 0FF6h ; [ES:BP+DPB.MAX_CLUSTER],
DOSCODE:9644					     ; 4096-10
DOSCODE:964A		     jnb     short MapSet
DOSCODE:964C		     mov     ax, bx
DOSCODE:964E
DOSCODE:964E MapSet:				     ; ...
DOSCODE:964E		     test    al, 1
DOSCODE:9650		     pop     ax
DOSCODE:9651		     retn
DOSCODE:9652 ; ---------------------------------------------------------------------------
DOSCODE:9652
DOSCODE:9652 MAP_POP:				     ; ...
DOSCODE:9652		     pop     dx
DOSCODE:9653		     pop     cx
DOSCODE:9654		     pop     bx
DOSCODE:9655		     pop     ax
DOSCODE:9656		     retn
DOSCODE:9656 MAPCLUSTER	     endp
DOSCODE:9656
DOSCODE:9657
DOSCODE:9657 ; =============== S U B R O U T I N E =======================================
DOSCODE:9657
DOSCODE:9657
DOSCODE:9657 FATREAD_SFT     proc near		     ; ...
DOSCODE:9657		     les     bp, es:[di+7]   ; [ES:DI+SF_ENTRY.sf_devptr]
DOSCODE:965B		     mov     al, es:[bp+0]
DOSCODE:965F		     mov     ds:THISDRV, al
DOSCODE:9662		     call    GOTDPB
DOSCODE:9665		     call    FAT_GOT_DPB
DOSCODE:9668
DOSCODE:9668 fatread_sft_retn:			     ; ...
DOSCODE:9668		     retn
DOSCODE:9668 FATREAD_SFT     endp
DOSCODE:9668
DOSCODE:9669
DOSCODE:9669 ; =============== S U B R O U T I N E =======================================
DOSCODE:9669
DOSCODE:9669
DOSCODE:9669 FATREAD_CDS     proc near		     ; ...
DOSCODE:9669		     push    es
DOSCODE:966A		     push    di
DOSCODE:966B		     les     bp, es:[di+45h] ; [ES:DI+curdir.devptr]
DOSCODE:966F		     mov     al, es:[bp+0]
DOSCODE:9673		     mov     ds:THISDRV, al
DOSCODE:9676		     call    GOTDPB
DOSCODE:9679		     call    FAT_GOT_DPB
DOSCODE:967C		     pop     di
DOSCODE:967D		     pop     es
DOSCODE:967E		     jb	     short fatread_sft_retn
DOSCODE:9680		     jnz     short NO_CHANGE
DOSCODE:9682		     xor     ax, ax
DOSCODE:9684		     dec     ax
DOSCODE:9685		     push    ds
DOSCODE:9686		     mov     cl, ds:CDSCOUNT
DOSCODE:968A		     xor     ch, ch
DOSCODE:968C		     lds     si, es:[di+45h] ; [ES:DI+curdir.devptr]
DOSCODE:9690		     les     di, ss:CDSADDR
DOSCODE:9695
DOSCODE:9695 frcd20:				     ; ...
DOSCODE:9695		     test    byte ptr es:[di+44h], 80h ; [ES:DI+curdir.flags+1],
DOSCODE:9695					     ; (curdir_isnet>>8)
DOSCODE:969A		     jnz     short frcd25
DOSCODE:969C		     cmp     si, es:[di+45h] ; [ES:DI+curdir.devptr]
DOSCODE:96A0		     jnz     short frcd25
DOSCODE:96A2		     mov     bx, ds
DOSCODE:96A4		     cmp     bx, es:[di+47h] ; [ES:DI+curdir.devptr+2]
DOSCODE:96A8		     jnz     short frcd25
DOSCODE:96AA		     test    es:[di+49h], ax ; [ES:DI+curdir.ID]
DOSCODE:96AE		     jz	     short frcd25
DOSCODE:96B0		     mov     es:[di+49h], ax
DOSCODE:96B4
DOSCODE:96B4 frcd25:				     ; ...
DOSCODE:96B4		     add     di, 88	     ; curdir.size
DOSCODE:96B7		     loop    frcd20
DOSCODE:96B9		     pop     ds
DOSCODE:96BA
DOSCODE:96BA NO_CHANGE:				     ; ...
DOSCODE:96BA		     les     bp, ds:THISDPB
DOSCODE:96BE		     clc
DOSCODE:96BF		     retn
DOSCODE:96BF FATREAD_CDS     endp
DOSCODE:96BF
DOSCODE:96C0 ; ---------------------------------------------------------------------------
DOSCODE:96C0 ; START OF	FUNCTION CHUNK FOR FAT_GOT_DPB
DOSCODE:96C0
DOSCODE:96C0 FAT_operation:			     ; ...
DOSCODE:96C0		     mov     word ptr es:[bp+1Fh], 0FFFFh ; [ES:BP+DPB.FREE_CNT],-1
DOSCODE:96C6		     and     di, 0FFh	     ; STECODE
DOSCODE:96CA		     mov     ds:ALLOWED, 18h ; Allowed_FAIL+Allowed_RETRY
DOSCODE:96CF		     mov     ah, 1Ah	     ; 2+Allowed_FAIL+Allowed_RETRY
DOSCODE:96D1		     mov     al, ds:THISDRV
DOSCODE:96D4		     call    FATAL1
DOSCODE:96D7		     les     bp, ds:THISDPB
DOSCODE:96DB		     cmp     al, 3
DOSCODE:96DD		     jnz     short FAT_GOT_DPB
DOSCODE:96DF		     stc
DOSCODE:96E0		     retn
DOSCODE:96E0 ; END OF FUNCTION CHUNK FOR FAT_GOT_DPB
DOSCODE:96E1
DOSCODE:96E1 ; =============== S U B R O U T I N E =======================================
DOSCODE:96E1
DOSCODE:96E1
DOSCODE:96E1 FAT_GOT_DPB     proc near		     ; ...
DOSCODE:96E1
DOSCODE:96E1 ; FUNCTION	CHUNK AT DOSCODE:96C0 SIZE 00000021 BYTES
DOSCODE:96E1
DOSCODE:96E1		     push    ss
DOSCODE:96E2		     pop     ds
DOSCODE:96E3		     mov     al, 0Fh	     ; DMEDHL
DOSCODE:96E5		     mov     ah, es:[bp+1]   ; [ES:BP+DPB.UNIT]
DOSCODE:96E9		     mov     ds:DEVCALL, ax
DOSCODE:96EC		     mov     ds:DEVCALL_REQFUNC, 1 ; DEVMDCH
DOSCODE:96F1		     mov     ds:DEVCALL_REQSTAT, 0
DOSCODE:96F7		     mov     al, es:[bp+17h] ; [ES:BP+DPB.MEDIA]
DOSCODE:96FB		     mov     ds:CALLMED, al
DOSCODE:96FE		     push    es
DOSCODE:96FF		     push    ds
DOSCODE:9700		     mov     bx, offset	DEVCALL
DOSCODE:9703		     lds     si, es:[bp+13h] ; [ES:BP+DPB.DRIVER_ADDR]
DOSCODE:9707		     pop     es
DOSCODE:9708		     call    DEVIOCALL2
DOSCODE:970B		     push    ss
DOSCODE:970C		     pop     ds
DOSCODE:970D		     pop     es
DOSCODE:970E		     mov     di, ds:DEVCALL_REQSTAT
DOSCODE:9712		     or	     di, di
DOSCODE:9714		     js	     short FAT_operation
DOSCODE:9716		     xor     ah, ah
DOSCODE:9718		     xchg    ah, es:[bp+18h] ; [ES:BP+DPB.FIRST_ACCESS]
DOSCODE:971C		     mov     al, ds:THISDRV
DOSCODE:971F		     cmp     ds:VOLCHNG_FLAG, al
DOSCODE:9723		     jnz     short CHECK_BYT
DOSCODE:9725		     mov     ds:VOLCHNG_FLAG, 0FFh ; -1
DOSCODE:972A		     jmp     GOGETBPB
DOSCODE:972D ; ---------------------------------------------------------------------------
DOSCODE:972D
DOSCODE:972D CHECK_BYT:				     ; ...
DOSCODE:972D		     or	     ah, ds:CALLXADD
DOSCODE:9731		     jns     short CHECK_ZR
DOSCODE:9733		     jmp     short NEWDSK
DOSCODE:9735 ; ---------------------------------------------------------------------------
DOSCODE:9735
DOSCODE:9735 CHECK_ZR:				     ; ...
DOSCODE:9735		     jz	     short CHKBUFFDIRT
DOSCODE:9737		     clc
DOSCODE:9738		     retn
DOSCODE:9739 ; ---------------------------------------------------------------------------
DOSCODE:9739
DOSCODE:9739 DISK_CHNG_ERR:			     ; ...
DOSCODE:9739		     push    es
DOSCODE:973A		     push    bp
DOSCODE:973B		     les     bp, es:[bp+13h] ; [ES:BP+DPB.DRIVER_ADDR]
DOSCODE:973F		     test    byte ptr es:[bp+5], 8 ; [es:bp+SYSDEV.ATT+1],
DOSCODE:973F					     ; (DEVOPCL>>8)
DOSCODE:9744		     pop     bp
DOSCODE:9745		     pop     es
DOSCODE:9746		     jz	     short FAIL_OPJ2
DOSCODE:9748		     push    ds
DOSCODE:9749		     push    di
DOSCODE:974A		     push    ss
DOSCODE:974B		     pop     ds
DOSCODE:974C		     mov     ds:ALLOWED, 18h
DOSCODE:9751		     push    es
DOSCODE:9752		     les     di, dword ptr ds:CALLXADD+1 ; les di,[CALLVIDM]
DOSCODE:9756		     mov     word ptr ds:EXTERRPT+2, es
DOSCODE:975A		     pop     es
DOSCODE:975B		     mov     word ptr ds:EXTERRPT, di
DOSCODE:975F		     mov     ax, 0Fh	     ; error_I24_wrong_disk
DOSCODE:9762		     mov     ds:READOP,	1
DOSCODE:9767		     call    HARDERR
DOSCODE:976A		     pop     di
DOSCODE:976B		     pop     ds
DOSCODE:976C		     cmp     al, 3
DOSCODE:976E
DOSCODE:976E FAIL_OPJ2:				     ; ...
DOSCODE:976E		     jz	     short FAIL_OP
DOSCODE:9770		     jmp     FAT_GOT_DPB
DOSCODE:9773 ; ---------------------------------------------------------------------------
DOSCODE:9773
DOSCODE:9773 CHKBUFFDIRT:			     ; ...
DOSCODE:9773		     cmp     ss:DirtyBufferCount, 0
DOSCODE:9779		     jz	     short NEWDSK
DOSCODE:977B		     call    GETCURHEAD
DOSCODE:977E
DOSCODE:977E nbuffer:				     ; ...
DOSCODE:977E		     cmp     [di+4], al	     ; [di+BUFFINFO.buf_ID]
DOSCODE:9781		     jnz     short lfnxt
DOSCODE:9783		     test    byte ptr [di+5], 40h ; [di+BUFFINFO.buf_flags],
DOSCODE:9783					     ; buf_dirty
DOSCODE:9787		     jz	     short lfnxt
DOSCODE:9789		     push    ss
DOSCODE:978A		     pop     ds
DOSCODE:978B		     clc
DOSCODE:978C		     retn
DOSCODE:978D ; ---------------------------------------------------------------------------
DOSCODE:978D
DOSCODE:978D FAIL_OP:				     ; ...
DOSCODE:978D		     push    ss
DOSCODE:978E		     pop     ds
DOSCODE:978F		     stc
DOSCODE:9790		     retn
DOSCODE:9791 ; ---------------------------------------------------------------------------
DOSCODE:9791
DOSCODE:9791 lfnxt:				     ; ...
DOSCODE:9791		     mov     di, [di]	     ; [di+BUFFINFO.buf_next]
DOSCODE:9793		     cmp     ss:FIRST_BUFF_ADDR, di
DOSCODE:9798		     jnz     short nbuffer
DOSCODE:979A
DOSCODE:979A NEWDSK:				     ; ...
DOSCODE:979A		     mov     word ptr es:[bp+1Fh], 0FFFFh ; [ES:BP+DPB.FREE_CNT],-1
DOSCODE:97A0		     call    GETCURHEAD
DOSCODE:97A3
DOSCODE:97A3 nxbuffer:				     ; ...
DOSCODE:97A3		     cmp     [di+4], al	     ; [DI+BUFFINFO.buf_ID]
DOSCODE:97A6		     jnz     short lfnxt2
DOSCODE:97A8		     test    byte ptr [di+5], 40h ; [DI+BUFFINFO.buf_flags],buf_dirty
DOSCODE:97AC		     jnz     short DISK_CHNG_ERR
DOSCODE:97AE		     mov     word ptr [di+4], 20FFh ; [DI+BUFFINFO.buf_ID],
DOSCODE:97AE					     ; (buf_visit*256)+0FFh
DOSCODE:97B3		     call    SCANPLACE
DOSCODE:97B6		     jmp     short skpbuff
DOSCODE:97B8 ; ---------------------------------------------------------------------------
DOSCODE:97B8
DOSCODE:97B8 lfnxt2:				     ; ...
DOSCODE:97B8		     mov     di, [di]	     ; [di+BUFFINFO.buf_next]
DOSCODE:97BA
DOSCODE:97BA skpbuff:				     ; ...
DOSCODE:97BA		     cmp     di, ss:FIRST_BUFF_ADDR
DOSCODE:97BF		     jnz     short nxbuffer
DOSCODE:97C1		     cmp     ss:SC_CACHE_COUNT,	0
DOSCODE:97C7		     jz	     short GOGETBPB
DOSCODE:97C9		     cmp     al, ss:CurSC_DRIVE
DOSCODE:97CE		     jnz     short GOGETBPB
DOSCODE:97D0		     mov     ss:CurSC_DRIVE, 0FFh ; -1
DOSCODE:97D6
DOSCODE:97D6 GOGETBPB:				     ; ...
DOSCODE:97D6		     lds     di, es:[bp+13h] ; [ES:BP+DPB.DRIVER_ADDR]
DOSCODE:97DA		     test    byte ptr [di+5], 20h ; [DI+SYSDEV.ATT+1],
DOSCODE:97DA					     ; (ISFATBYDEV>>8)
DOSCODE:97DE		     jnz     short GETFREEBUF
DOSCODE:97E0		     push    ss
DOSCODE:97E1		     pop     ds
DOSCODE:97E2		     mov     bx, 2
DOSCODE:97E5		     call    UNPACK
DOSCODE:97E8
DOSCODE:97E8 FAIL_OPJ:				     ; ...
DOSCODE:97E8		     jb	     short FAIL_OP
DOSCODE:97EA		     lds     di, ds:CURBUF
DOSCODE:97EE		     jmp     short GOTGETBUF
DOSCODE:97F0 ; ---------------------------------------------------------------------------
DOSCODE:97F0
DOSCODE:97F0 GETFREEBUF:			     ; ...
DOSCODE:97F0		     push    es
DOSCODE:97F1		     push    bp
DOSCODE:97F2		     xor     dx, dx
DOSCODE:97F4		     mov     ss:HIGH_SECTOR, dx
DOSCODE:97F9		     call    GETCURHEAD
DOSCODE:97FC		     call    BUFWRITE
DOSCODE:97FF		     pop     bp
DOSCODE:9800		     pop     es
DOSCODE:9801		     jb	     short FAIL_OPJ
DOSCODE:9803
DOSCODE:9803 GOTGETBUF:				     ; ...
DOSCODE:9803		     add     di, 20	     ; BUFINSIZ
DOSCODE:9806		     mov     word ptr ss:CALLXADD+2, ds
DOSCODE:980B		     push    ss
DOSCODE:980C		     pop     ds
DOSCODE:980D		     mov     word ptr ds:CALLXADD, di
DOSCODE:9811		     mov     al, 16h	     ; DBPBHL
DOSCODE:9813		     mov     ah, es:[bp+1]   ; [ES:BP+DPB.UNIT]
DOSCODE:9817		     mov     ds:DEVCALL, ax  ; [DEVCALL_REQLEN]
DOSCODE:981A		     mov     ds:DEVCALL_REQFUNC, 2 ; DEVBPB
DOSCODE:981F		     mov     ds:DEVCALL_REQSTAT, 0
DOSCODE:9825		     mov     al, es:[bp+17h] ; [ES:BP+DPB.MEDIA]
DOSCODE:9829		     mov     ds:CALLMED, al
DOSCODE:982C		     push    es
DOSCODE:982D		     push    ds
DOSCODE:982E		     push    word ptr es:[bp+15h] ; [ES:BP+DPB.DRIVER_ADDR+2]
DOSCODE:9832		     push    word ptr es:[bp+13h] ; [ES:BP+DPB.DRIVER_ADDR]
DOSCODE:9836		     mov     bx, offset	DEVCALL
DOSCODE:9839		     pop     si
DOSCODE:983A		     pop     ds
DOSCODE:983B		     pop     es
DOSCODE:983C		     call    DEVIOCALL2
DOSCODE:983F		     pop     es
DOSCODE:9840		     push    ss
DOSCODE:9841		     pop     ds
DOSCODE:9842		     mov     di, ds:DEVCALL_REQSTAT
DOSCODE:9846		     or	     di, di
DOSCODE:9848		     js	     short FATERRJ
DOSCODE:984A		     mov     al, es:[bp+17h] ; [ES:BP+DPB.MEDIA]
DOSCODE:984E		     lds     si, dword ptr ds:CALLSCNT ; lds si,[CALLBPB]
DOSCODE:9852		     mov     word ptr es:[bp+1Dh], 0 ; [ES:BP+DPB.NEXT_FREE]
DOSCODE:9858		     call    $SETDPB
DOSCODE:985B		     lds     di, dword ptr ss:CALLXADD
DOSCODE:9860		     mov     al, es:[bp+8]   ; [ES:BP+DPB.FAT_COUNT]
DOSCODE:9864		     mov     [di-0Ah], al    ; [DI+BUFFINFO.buf_wrtcnt-BUFINSIZ]
DOSCODE:9867		     mov     ax, es:[bp+0Fh] ; [ES:BP+DPB.FAT_SIZE]
DOSCODE:986B		     mov     [di-9], ax	     ; [DI+BUFFINFO.buf_wrtcntinc-BUFINSIZ]
DOSCODE:986E		     push    ss
DOSCODE:986F		     pop     ds
DOSCODE:9870		     xor     al, al
DOSCODE:9872		     retn
DOSCODE:9873 ; ---------------------------------------------------------------------------
DOSCODE:9873
DOSCODE:9873 FATERRJ:				     ; ...
DOSCODE:9873		     jmp     FAT_operation
DOSCODE:9873 FAT_GOT_DPB     endp
DOSCODE:9873
DOSCODE:9876
DOSCODE:9876 ; =============== S U B R O U T I N E =======================================
DOSCODE:9876
DOSCODE:9876
DOSCODE:9876 GETCURHEAD	     proc near		     ; ...
DOSCODE:9876		     lds     di, ss:BufferQueue
DOSCODE:987B		     mov     word ptr ss:LastBuffer, 0FFFFh ; -1
DOSCODE:9882		     mov     ss:FIRST_BUFF_ADDR, di
DOSCODE:9887		     retn
DOSCODE:9887 GETCURHEAD	     endp
DOSCODE:9887
DOSCODE:9888
DOSCODE:9888 ; =============== S U B R O U T I N E =======================================
DOSCODE:9888
DOSCODE:9888
DOSCODE:9888 SCANPLACE	     proc near		     ; ...
DOSCODE:9888		     push    word ptr [di]   ; [di+BUFFINFO.buf_next]
DOSCODE:988A		     call    PLACEBUF
DOSCODE:988D		     pop     di
DOSCODE:988E		     retn
DOSCODE:988E SCANPLACE	     endp
DOSCODE:988E
DOSCODE:988F
DOSCODE:988F ; =============== S U B R O U T I N E =======================================
DOSCODE:988F
DOSCODE:988F
DOSCODE:988F PLACEBUF	     proc near		     ; ...
DOSCODE:988F		     push    ax
DOSCODE:9890		     push    bx
DOSCODE:9891		     push    si
DOSCODE:9892		     mov     ax, [di]	     ; [di+BUFFINFO.buf_next]
DOSCODE:9894		     mov     bx, word ptr ss:BufferQueue
DOSCODE:9899		     cmp     ax, bx
DOSCODE:989B		     jz	     short nret
DOSCODE:989D		     cmp     di, bx
DOSCODE:989F		     jnz     short not_first
DOSCODE:98A1		     mov     word ptr ss:BufferQueue, ax
DOSCODE:98A5		     jmp     short nret
DOSCODE:98A7 ; ---------------------------------------------------------------------------
DOSCODE:98A7
DOSCODE:98A7 not_first:				     ; ...
DOSCODE:98A7		     mov     si, [di+2]	     ; [DI+BUFFINFO.buf_prev]
DOSCODE:98AA		     mov     [si], ax	     ; [SI+BUFFINFO.buf_next]
DOSCODE:98AC		     xchg    ax, si
DOSCODE:98AD		     mov     [si+2], ax	     ; [SI+BUFFINFO.buf_prev]
DOSCODE:98B0		     mov     si, [bx+2]	     ; [BX+BUFFINFO.buf_prev]
DOSCODE:98B3		     mov     [si], di
DOSCODE:98B5		     mov     [bx+2], di
DOSCODE:98B8		     mov     [di+2], si
DOSCODE:98BB		     mov     [di], bx	     ; [DI+BUFFINFO.buf_next]
DOSCODE:98BD
DOSCODE:98BD nret:				     ; ...
DOSCODE:98BD		     pop     si
DOSCODE:98BE		     pop     bx
DOSCODE:98BF		     pop     ax
DOSCODE:98C0		     cmp     byte ptr [di+4], 0FFh ; [di+BUFFINFO.buf_ID],-1
DOSCODE:98C4		     jnz     short pbx
DOSCODE:98C6		     mov     word ptr ss:BufferQueue, di
DOSCODE:98CB
DOSCODE:98CB pbx:				     ; ...
DOSCODE:98CB		     retn
DOSCODE:98CB PLACEBUF	     endp
DOSCODE:98CB
DOSCODE:98CC ; ---------------------------------------------------------------------------
DOSCODE:98CC
DOSCODE:98CC POINTCOMP:				     ; ...
DOSCODE:98CC		     cmp     si, di
DOSCODE:98CE		     jnz     short placehead_retn
DOSCODE:98D0		     push    cx
DOSCODE:98D1		     push    dx
DOSCODE:98D2		     mov     cx, ds
DOSCODE:98D4		     mov     dx, es
DOSCODE:98D6		     cmp     cx, dx
DOSCODE:98D8		     pop     dx
DOSCODE:98D9		     pop     cx
DOSCODE:98DA
DOSCODE:98DA placehead_retn:			     ; ...
DOSCODE:98DA		     retn
DOSCODE:98DB ; ---------------------------------------------------------------------------
DOSCODE:98DB
DOSCODE:98DB GETBUFFR:				     ; ...
DOSCODE:98DB		     xor     si, si
DOSCODE:98DD
DOSCODE:98DD GETBUFFRB:				     ; ...
DOSCODE:98DD		     mov     ds:PREREAD, ax
DOSCODE:98E0		     mov     al, es:[bp+0]   ; [ES:BP+DPB.DRIVE]
DOSCODE:98E4		     lds     di, ds:LastBuffer
DOSCODE:98E8		     mov     cx, ss:HIGH_SECTOR
DOSCODE:98ED		     cmp     di, 0FFFFh	     ; -1
DOSCODE:98F0		     jz	     short getb5
DOSCODE:98F2		     cmp     dx, [di+6]	     ; [DI+BUFFINFO.buf_sector]
DOSCODE:98F5		     jnz     short getb5
DOSCODE:98F7		     cmp     cx, [di+8]	     ; [DI+BUFFINFO.buf_sector+2]
DOSCODE:98FA		     jnz     short getb5
DOSCODE:98FC		     cmp     al, [di+4]	     ; [DI+BUFFINFO.buf_ID]
DOSCODE:98FF		     jnz     short getb5
DOSCODE:9901		     jmp     getb35
DOSCODE:9904 ; ---------------------------------------------------------------------------
DOSCODE:9904
DOSCODE:9904 getb5:				     ; ...
DOSCODE:9904		     call    GETCURHEAD
DOSCODE:9907
DOSCODE:9907 getb10:				     ; ...
DOSCODE:9907		     cmp     dx, [di+6]	     ; [DI+BUFFINFO.buf_sector]
DOSCODE:990A		     jnz     short getb12
DOSCODE:990C		     cmp     cx, [di+8]	     ; [DI+BUFFINFO.buf_sector+2]
DOSCODE:990F		     jnz     short getb12
DOSCODE:9911		     cmp     al, [di+4]	     ; [DI+BUFFINFO.buf_ID]
DOSCODE:9914		     jnz     short getb12
DOSCODE:9916		     jmp     getb25
DOSCODE:9919 ; ---------------------------------------------------------------------------
DOSCODE:9919
DOSCODE:9919 getb12:				     ; ...
DOSCODE:9919		     mov     di, [di]	     ; [DI+BUFFINFO.BUF_NEXT]
DOSCODE:991B		     cmp     di, ss:FIRST_BUFF_ADDR
DOSCODE:9920		     jnz     short getb10
DOSCODE:9922		     push    cx
DOSCODE:9923		     push    si
DOSCODE:9924		     push    dx
DOSCODE:9925		     push    bp
DOSCODE:9926		     push    es
DOSCODE:9927		     call    BUFWRITE
DOSCODE:992A		     pop     es
DOSCODE:992B		     pop     bp
DOSCODE:992C		     pop     dx
DOSCODE:992D		     pop     si
DOSCODE:992E		     pop     ss:HIGH_SECTOR
DOSCODE:9933		     jnb     short getb13
DOSCODE:9935		     jmp     getbx
DOSCODE:9938 ; ---------------------------------------------------------------------------
DOSCODE:9938
DOSCODE:9938 getb13:				     ; ...
DOSCODE:9938		     call    SET_RQ_SC_PARMS
DOSCODE:993B		     xor     ah, ah
DOSCODE:993D		     cmp     byte ptr ss:PREREAD, ah
DOSCODE:9942		     jnz     short getb20
DOSCODE:9944		     lea     bx, [di+20]     ; [DI+BUFINSIZ]
DOSCODE:9947		     mov     cx, 1
DOSCODE:994A		     push    si
DOSCODE:994B		     push    di
DOSCODE:994C		     push    dx
DOSCODE:994D		     push    es
DOSCODE:994E		     cmp     ss:BuffInHMA, 0
DOSCODE:9954		     jz	     short getb14
DOSCODE:9956		     push    ds
DOSCODE:9957		     push    bx
DOSCODE:9958		     lds     bx, ss:LoMemBuff
DOSCODE:995D
DOSCODE:995D getb14:				     ; ...
DOSCODE:995D		     or	     si, si
DOSCODE:995F		     jz	     short getb15
DOSCODE:9961		     call    FATSECRD
DOSCODE:9964		     mov     ah, 2	     ; buf_isFAT
DOSCODE:9966		     jmp     short getb17
DOSCODE:9968 ; ---------------------------------------------------------------------------
DOSCODE:9968
DOSCODE:9968 getb15:				     ; ...
DOSCODE:9968		     call    DREAD
DOSCODE:996B		     mov     ah, 0
DOSCODE:996D
DOSCODE:996D getb17:				     ; ...
DOSCODE:996D		     pushf
DOSCODE:996E		     cmp     ss:BuffInHMA, 0
DOSCODE:9974		     jz	     short not_in_hma
DOSCODE:9976		     popf
DOSCODE:9977		     mov     cx, es:[bp+2]   ; [ES:BP+DPB.SECTOR_SIZE]
DOSCODE:997B		     shr     cx, 1
DOSCODE:997D		     mov     si, bx
DOSCODE:997F		     pop     di
DOSCODE:9980		     pop     es
DOSCODE:9981		     cld
DOSCODE:9982		     rep movsw
DOSCODE:9984		     push    es
DOSCODE:9985		     pop     ds
DOSCODE:9986		     jmp     short getb19
DOSCODE:9988 ; ---------------------------------------------------------------------------
DOSCODE:9988
DOSCODE:9988 not_in_hma:			     ; ...
DOSCODE:9988		     popf
DOSCODE:9989
DOSCODE:9989 getb19:				     ; ...
DOSCODE:9989		     pop     es
DOSCODE:998A		     pop     dx
DOSCODE:998B		     pop     di
DOSCODE:998C		     pop     si
DOSCODE:998D		     jb	     short getbx
DOSCODE:998F
DOSCODE:998F getb20:				     ; ...
DOSCODE:998F		     mov     cx, ss:HIGH_SECTOR
DOSCODE:9994		     mov     [di+8], cx	     ; [DI+BUFFINFO.buf_sector+2]
DOSCODE:9997		     mov     [di+6], dx	     ; [DI+BUFFINFO.buf_sector]
DOSCODE:999A		     mov     [di+0Dh], bp    ; [DI+BUFFINFO.buf_DPB]
DOSCODE:999D		     mov     word ptr [di+0Fh],	es ; [DI+BUFFINFO.buf_DPB+2]
DOSCODE:99A0		     mov     al, es:[bp+0]   ; [ES:BP+DPB.DRIVE]
DOSCODE:99A4		     mov     [di+4], ax	     ; [DI+BUFFINFO.buf_ID]
DOSCODE:99A7
DOSCODE:99A7 getb25:				     ; ...
DOSCODE:99A7		     mov     byte ptr [di+0Ah],	1 ;  [DI+BUFFINFO.buf_wrtcnt]
DOSCODE:99AB		     xor     ax, ax
DOSCODE:99AD		     or	     si, si
DOSCODE:99AF		     jz	     short getb30
DOSCODE:99B1		     mov     al, es:[bp+8]   ; [ES:BP+DPB.FAT_COUNT]
DOSCODE:99B5		     mov     [di+0Ah], al    ; [DI+BUFFINFO.buf_wrtcnt]
DOSCODE:99B8		     mov     ax, es:[bp+0Fh] ; [ES:BP+DPB.FAT_SIZE]
DOSCODE:99BC
DOSCODE:99BC getb30:				     ; ...
DOSCODE:99BC		     mov     [di+0Bh], ax    ; [DI+BUFFINFO.buf_wrtcntinc]
DOSCODE:99BF		     call    PLACEBUF
DOSCODE:99C2
DOSCODE:99C2 getb35:				     ; ...
DOSCODE:99C2		     mov     word ptr ss:CURBUF+2, ds
DOSCODE:99C7		     mov     word ptr ss:LastBuffer+2, ds
DOSCODE:99CC		     mov     word ptr ss:CURBUF, di
DOSCODE:99D1		     mov     word ptr ss:LastBuffer, di
DOSCODE:99D6		     clc
DOSCODE:99D7
DOSCODE:99D7 getbx:				     ; ...
DOSCODE:99D7		     push    ss
DOSCODE:99D8		     pop     ds
DOSCODE:99D9
DOSCODE:99D9 getbuffrb_retn:			     ; ...
DOSCODE:99D9		     retn
DOSCODE:99DA
DOSCODE:99DA ; =============== S U B R O U T I N E =======================================
DOSCODE:99DA
DOSCODE:99DA
DOSCODE:99DA FLUSHBUF	     proc near		     ; ...
DOSCODE:99DA		     call    GETCURHEAD
DOSCODE:99DD		     test    byte ptr ss:DOS34_FLAG, 4 ; FROM_DISK_RESET
DOSCODE:99E3		     jnz     short scan_buf_queue
DOSCODE:99E5		     cmp     ss:DirtyBufferCount, 0
DOSCODE:99EB		     jz	     short end_scan
DOSCODE:99ED
DOSCODE:99ED scan_buf_queue:			     ; ...
DOSCODE:99ED		     call    CHECKFLUSH
DOSCODE:99F0		     mov     ah, [di+4]	     ; [DI+BUFFINFO.buf_ID]
DOSCODE:99F3		     cmp     ss:WPERR, ah
DOSCODE:99F8		     jz	     short free_the_buf
DOSCODE:99FA		     test    byte ptr ss:DOS34_FLAG, 4 ; FROM_DISK_RESET
DOSCODE:9A00		     jz	     short dont_free_the_buf
DOSCODE:9A02
DOSCODE:9A02 free_the_buf:			     ; ...
DOSCODE:9A02		     mov     word ptr [di+4], 0FFh ; [DI+BUFFINFO.buf_ID],00FFh
DOSCODE:9A07
DOSCODE:9A07 dont_free_the_buf:			     ; ...
DOSCODE:9A07		     mov     di, [di]	     ; [DI+BUFFINFO.buf_next]
DOSCODE:9A09		     cmp     di, ss:FIRST_BUFF_ADDR
DOSCODE:9A0E		     jnz     short scan_buf_queue
DOSCODE:9A10
DOSCODE:9A10 end_scan:				     ; ...
DOSCODE:9A10		     push    ss
DOSCODE:9A11		     pop     ds
DOSCODE:9A12		     cmp     ds:FAILERR, 0
DOSCODE:9A17		     jnz     short bad_flush
DOSCODE:9A19		     retn
DOSCODE:9A1A ; ---------------------------------------------------------------------------
DOSCODE:9A1A
DOSCODE:9A1A bad_flush:				     ; ...
DOSCODE:9A1A		     stc
DOSCODE:9A1B		     retn
DOSCODE:9A1B FLUSHBUF	     endp
DOSCODE:9A1B
DOSCODE:9A1C
DOSCODE:9A1C ; =============== S U B R O U T I N E =======================================
DOSCODE:9A1C
DOSCODE:9A1C
DOSCODE:9A1C CHECKFLUSH	     proc near		     ; ...
DOSCODE:9A1C		     mov     ah, 0FFh	     ; -1
DOSCODE:9A1E		     cmp     [di+4], ah	     ; [DI+BUFFINFO.buf_ID]
DOSCODE:9A21		     jz	     short getbuffrb_retn ; flushbuf_retn
DOSCODE:9A23		     cmp     ah, al
DOSCODE:9A25		     jz	     short DOBUFFER
DOSCODE:9A27		     cmp     al, [di+4]
DOSCODE:9A2A		     clc
DOSCODE:9A2B		     jnz     short getbuffrb_retn ; flushbuf_retn
DOSCODE:9A2D
DOSCODE:9A2D DOBUFFER:				     ; ...
DOSCODE:9A2D		     test    byte ptr [di+5], 40h ; [DI+BUFFINFO.buf_flags],
DOSCODE:9A2D					     ; buf_dirty
DOSCODE:9A31		     jz	     short getbuffrb_retn ; flushbuf_retn
DOSCODE:9A33		     push    ax
DOSCODE:9A34		     push    word ptr [di+4] ; [DI+BUFFINFO.buf_ID]
DOSCODE:9A37		     call    BUFWRITE
DOSCODE:9A3A		     pop     ax
DOSCODE:9A3B		     jb	     short LEAVE_BUF
DOSCODE:9A3D		     and     ah, 0BFh	     ; ~buf_dirty
DOSCODE:9A40		     mov     [di+4], ax
DOSCODE:9A43
DOSCODE:9A43 LEAVE_BUF:				     ; ...
DOSCODE:9A43		     pop     ax
DOSCODE:9A44
DOSCODE:9A44 checkflush_retn:			     ; ...
DOSCODE:9A44		     retn
DOSCODE:9A44 CHECKFLUSH	     endp
DOSCODE:9A44
DOSCODE:9A45
DOSCODE:9A45 ; =============== S U B R O U T I N E =======================================
DOSCODE:9A45
DOSCODE:9A45
DOSCODE:9A45 BUFWRITE	     proc near		     ; ...
DOSCODE:9A45		     mov     ax, 0FFh
DOSCODE:9A48		     xchg    ax, [di+4]	     ; [DI+BUFFINFO.buf_ID]
DOSCODE:9A4B		     cmp     al, 0FFh
DOSCODE:9A4D		     jz	     short checkflush_retn
DOSCODE:9A4F		     test    ah, 40h	     ; buf_dirty
DOSCODE:9A52		     jz	     short checkflush_retn
DOSCODE:9A54		     call    DEC_DIRTY_COUNT
DOSCODE:9A57		     cmp     al, ss:WPERR
DOSCODE:9A5C		     jz	     short checkflush_retn
DOSCODE:9A5E		     mov     ss:SC_DRIVE, al
DOSCODE:9A62		     les     bp, [di+13]     ; [DI+BUFFINFO.buf_DPB]
DOSCODE:9A65		     lea     bx, [di+20]     ; [DI+BUFINSIZ]
DOSCODE:9A68		     mov     dx, [di+6]	     ; [DI+BUFFINFO.buf_sector]
DOSCODE:9A6B		     mov     cx, [di+8]	     ; [DI+BUFFINFO.buf_sector+2]
DOSCODE:9A6E		     mov     ss:HIGH_SECTOR, cx
DOSCODE:9A73		     mov     cl, [di+10]     ; [DI+BUFFINFO.buf_wrtcnt]
DOSCODE:9A76		     xor     ch, ch
DOSCODE:9A78		     mov     ss:ALLOWED, 18h ; Allowed_RETRY+Allowed_FAIL
DOSCODE:9A7E		     test    ah, 8	     ; buf_isDATA
DOSCODE:9A81		     jz	     short NO_IGNORE
DOSCODE:9A83		     or	     ss:ALLOWED, 20h ; Allowed_IGNORE
DOSCODE:9A89
DOSCODE:9A89 NO_IGNORE:				     ; ...
DOSCODE:9A89		     mov     ax, [di+11]     ; [DI+BUFFINFO.buf_wrtcntinc]
DOSCODE:9A8C		     push    di
DOSCODE:9A8D		     xor     di, di
DOSCODE:9A8F		     push    ds
DOSCODE:9A90		     push    bx
DOSCODE:9A91
DOSCODE:9A91 WRTAGAIN:				     ; ...
DOSCODE:9A91		     push    di
DOSCODE:9A92		     push    cx
DOSCODE:9A93		     push    ax
DOSCODE:9A94		     mov     cx, 1
DOSCODE:9A97		     push    bx
DOSCODE:9A98		     push    dx
DOSCODE:9A99		     push    ds
DOSCODE:9A9A		     cmp     ss:BuffInHMA, 0
DOSCODE:9AA0		     jz	     short NBUFFINHMA
DOSCODE:9AA2		     push    cx
DOSCODE:9AA3		     push    es
DOSCODE:9AA4		     mov     si, bx
DOSCODE:9AA6		     mov     cx, es:[bp+2]   ; [es:bp+DPB.SECTOR_SIZE]
DOSCODE:9AAA		     shr     cx, 1
DOSCODE:9AAC		     les     di, ss:LoMemBuff
DOSCODE:9AB1		     mov     bx, di
DOSCODE:9AB3		     cld
DOSCODE:9AB4		     rep movsw
DOSCODE:9AB6		     push    es
DOSCODE:9AB7		     pop     ds
DOSCODE:9AB8		     pop     es
DOSCODE:9AB9		     pop     cx
DOSCODE:9ABA
DOSCODE:9ABA NBUFFINHMA:			     ; ...
DOSCODE:9ABA		     call    DWRITE
DOSCODE:9ABD		     pop     ds
DOSCODE:9ABE		     pop     dx
DOSCODE:9ABF		     pop     bx
DOSCODE:9AC0		     pop     ax
DOSCODE:9AC1		     pop     cx
DOSCODE:9AC2		     pop     di
DOSCODE:9AC3		     jb	     short NOSET
DOSCODE:9AC5		     inc     di
DOSCODE:9AC6
DOSCODE:9AC6 NOSET:				     ; ...
DOSCODE:9AC6		     add     dx, ax
DOSCODE:9AC8		     loop    WRTAGAIN
DOSCODE:9ACA		     pop     bx
DOSCODE:9ACB		     pop     ds
DOSCODE:9ACC		     or	     di, di
DOSCODE:9ACE		     jnz     short BWROK
DOSCODE:9AD0		     stc
DOSCODE:9AD1
DOSCODE:9AD1 BWROK:				     ; ...
DOSCODE:9AD1		     pop     di
DOSCODE:9AD2		     retn
DOSCODE:9AD2 BUFWRITE	     endp
DOSCODE:9AD2
DOSCODE:9AD3
DOSCODE:9AD3 ; =============== S U B R O U T I N E =======================================
DOSCODE:9AD3
DOSCODE:9AD3
DOSCODE:9AD3 SET_RQ_SC_PARMS proc near		     ; ...
DOSCODE:9AD3		     push    ax
DOSCODE:9AD4		     mov     ax, es:[bp+2]   ; [ES:BP+DPB.SECTOR_SIZE]
DOSCODE:9AD8		     mov     ss:SC_SECTOR_SIZE,	ax
DOSCODE:9ADC		     mov     al, es:[bp+0]
DOSCODE:9AE0		     mov     ss:SC_DRIVE, al
DOSCODE:9AE4		     pop     ax
DOSCODE:9AE5		     retn
DOSCODE:9AE5 SET_RQ_SC_PARMS endp
DOSCODE:9AE5
DOSCODE:9AE6
DOSCODE:9AE6 ; =============== S U B R O U T I N E =======================================
DOSCODE:9AE6
DOSCODE:9AE6
DOSCODE:9AE6 INC_DIRTY_COUNT proc near		     ; ...
DOSCODE:9AE6		     inc     ss:DirtyBufferCount
DOSCODE:9AEB		     retn
DOSCODE:9AEB INC_DIRTY_COUNT endp
DOSCODE:9AEB
DOSCODE:9AEC
DOSCODE:9AEC ; =============== S U B R O U T I N E =======================================
DOSCODE:9AEC
DOSCODE:9AEC
DOSCODE:9AEC DEC_DIRTY_COUNT proc near		     ; ...
DOSCODE:9AEC		     cmp     ss:DirtyBufferCount, 0
DOSCODE:9AF2		     jz	     short ddcx
DOSCODE:9AF4		     dec     ss:DirtyBufferCount
DOSCODE:9AF9
DOSCODE:9AF9 ddcx:				     ; ...
DOSCODE:9AF9		     retn
DOSCODE:9AF9 DEC_DIRTY_COUNT endp
DOSCODE:9AF9
DOSCODE:9AFA ; ---------------------------------------------------------------------------
DOSCODE:9AFA
DOSCODE:9AFA $WAIT:				     ; ...
DOSCODE:9AFA		     xor     ax, ax
DOSCODE:9AFC		     xchg    ax, ss:exit_code
DOSCODE:9B01		     jmp     SYS_RETURN	     ; SYS_RET_OK
DOSCODE:9B04 ; ---------------------------------------------------------------------------
DOSCODE:9B04
DOSCODE:9B04 $EXEC:				     ; ...
DOSCODE:9B04		     mov     ss:A20OFF_COUNT, 0
DOSCODE:9B0A		     cmp     al, 5
DOSCODE:9B0C		     jnz     short Exec_@f
DOSCODE:9B0E		     pop     cx
DOSCODE:9B0F		     mov     cx, offset	LeaveDOS
DOSCODE:9B12		     push    cx
DOSCODE:9B13
DOSCODE:9B13 Exec_@f:				     ; ...
DOSCODE:9B13		     push    bp
DOSCODE:9B14		     mov     bp, sp
DOSCODE:9B16		     sub     sp, 29
DOSCODE:9B19		     cmp     al, 5
DOSCODE:9B1B		     jbe     short Exec_Check_2
DOSCODE:9B1D
DOSCODE:9B1D Exec_Bad_Fun:			     ; ...
DOSCODE:9B1D		     mov     ss:EXTERR_LOCUS, 1	; errLOC_Unk
DOSCODE:9B23		     mov     al, 1	     ; error_invalid_function
DOSCODE:9B25
DOSCODE:9B25 Exec_Ret_Err:			     ; ...
DOSCODE:9B25		     mov     sp, bp
DOSCODE:9B27		     pop     bp
DOSCODE:9B28		     jmp     SYS_RET_ERR
DOSCODE:9B2B ; ---------------------------------------------------------------------------
DOSCODE:9B2B
DOSCODE:9B2B ExecReadyJ:			     ; ...
DOSCODE:9B2B		     call    ExecReady
DOSCODE:9B2E		     jmp     norm_ovl
DOSCODE:9B31 ; ---------------------------------------------------------------------------
DOSCODE:9B31
DOSCODE:9B31 Exec_Check_2:			     ; ...
DOSCODE:9B31		     cmp     al, 2
DOSCODE:9B33		     jz	     short Exec_Bad_Fun
DOSCODE:9B35		     cmp     al, 4
DOSCODE:9B37		     jz	     short Exec_Bad_Fun
DOSCODE:9B39		     cmp     al, 5
DOSCODE:9B3B		     jz	     short ExecReadyJ
DOSCODE:9B3D		     mov     [bp-4], bx	     ; Exec_BlkL
DOSCODE:9B40		     mov     word ptr [bp-2], es
DOSCODE:9B43		     mov     [bp-5], al	     ; Exec_Func
DOSCODE:9B46		     mov     byte ptr [bp-6], 0	; Exec_Load_High
DOSCODE:9B4A		     mov     [bp-26], dx     ; ExecNameL
DOSCODE:9B4D		     mov     word ptr [bp-24], ds ; ExecNameH
DOSCODE:9B50		     mov     si, dx
DOSCODE:9B52		     call    DStrLen
DOSCODE:9B55		     mov     [bp-22], cx     ; ExecNameLen
DOSCODE:9B58		     mov     al, ss:AllocMethod
DOSCODE:9B5C		     mov     ss:ALLOCMSAVE, al
DOSCODE:9B60		     xor     al, al
DOSCODE:9B62		     push    bp
DOSCODE:9B63		     or	     ss:DOS_FLAG, 1  ; EXECOPEN
DOSCODE:9B69		     call    $OPEN
DOSCODE:9B6C		     pushf
DOSCODE:9B6D		     and     ss:DOS_FLAG, 0FEh ; ~EXECOPEN
DOSCODE:9B73		     popf
DOSCODE:9B74		     pop     bp
DOSCODE:9B75		     jb	     short Exec_Ret_Err
DOSCODE:9B77		     mov     [bp-8], ax	     ; Exec_FH
DOSCODE:9B7A		     mov     bx, ax
DOSCODE:9B7C		     xor     al, al
DOSCODE:9B7E		     call    $IOCTL
DOSCODE:9B81		     jb	     short Exec_BombJ
DOSCODE:9B83		     test    dl, 80h	     ; devid_ISDEV
DOSCODE:9B86		     jz	     short Exec_Check_Environ
DOSCODE:9B88		     mov     al, 2	     ; error_file_not_found
DOSCODE:9B8A
DOSCODE:9B8A Exec_BombJ:			     ; ...
DOSCODE:9B8A		     jmp     Exec_Bomb
DOSCODE:9B8D ; ---------------------------------------------------------------------------
DOSCODE:9B8D
DOSCODE:9B8D BadEnv:				     ; ...
DOSCODE:9B8D		     mov     al, 0Ah	     ; error_bad_environment
DOSCODE:9B8F		     jmp     Exec_Bomb
DOSCODE:9B92 ; ---------------------------------------------------------------------------
DOSCODE:9B92
DOSCODE:9B92 Exec_Check_Environ:		     ; ...
DOSCODE:9B92		     mov     word ptr [bp-18], 0 ; Exec_Load_Block
DOSCODE:9B97		     mov     word ptr [bp-14], 0 ; Exec_Environ
DOSCODE:9B9C		     test    byte ptr [bp-5], 2	; Exec_Func,exec_func_overlay
DOSCODE:9BA0		     jnz     short Exec_Read_Header
DOSCODE:9BA2		     lds     si, [bp-4]	     ; Exec_Blk
DOSCODE:9BA5		     mov     ax, [si]	     ; [SI+EXEC1.ENVIRON]
DOSCODE:9BA7		     or	     ax, ax
DOSCODE:9BA9		     jnz     short Exec_Scan_Env
DOSCODE:9BAB		     mov     ds, ss:CurrentPDB
DOSCODE:9BB0		     mov     ax, ds:2Ch	     ; [PDB.ENVIRON]
DOSCODE:9BB3		     or	     ax, ax
DOSCODE:9BB5		     jz	     short Exec_Read_Header
DOSCODE:9BB7
DOSCODE:9BB7 Exec_Scan_Env:			     ; ...
DOSCODE:9BB7		     mov     es, ax
DOSCODE:9BB9		     xor     di, di
DOSCODE:9BBB		     mov     cx, 8000h
DOSCODE:9BBE		     xor     al, al
DOSCODE:9BC0
DOSCODE:9BC0 Exec_Get_Environ_Len:		     ; ...
DOSCODE:9BC0		     repne scasb
DOSCODE:9BC2		     jnz     short BadEnv
DOSCODE:9BC4		     dec     cx
DOSCODE:9BC5		     js	     short BadEnv
DOSCODE:9BC7		     scasb
DOSCODE:9BC8		     jnz     short Exec_Get_Environ_Len
DOSCODE:9BCA		     push    di
DOSCODE:9BCB		     lea     bx, [di+11h]    ; [DI+0Fh+2]
DOSCODE:9BCE		     add     bx, [bp-22]     ; ExecNameLen
DOSCODE:9BD1		     mov     cl, 4
DOSCODE:9BD3		     shr     bx, cl
DOSCODE:9BD5		     push    es
DOSCODE:9BD6		     call    $ALLOC
DOSCODE:9BD9		     pop     ds
DOSCODE:9BDA		     pop     cx
DOSCODE:9BDB		     jnb     short Exec_Save_Environ
DOSCODE:9BDD		     jmp     short Exec_No_Mem
DOSCODE:9BDF ; ---------------------------------------------------------------------------
DOSCODE:9BDF
DOSCODE:9BDF Exec_Save_Environ:			     ; ...
DOSCODE:9BDF		     mov     es, ax
DOSCODE:9BE1		     mov     [bp-14], ax     ; Exec_Environ
DOSCODE:9BE4		     xor     si, si
DOSCODE:9BE6		     mov     di, si
DOSCODE:9BE8		     rep movsb
DOSCODE:9BEA		     mov     ax, 1
DOSCODE:9BED		     stosw
DOSCODE:9BEE		     lds     si, [bp-26]     ; ExecName
DOSCODE:9BF1		     mov     cx, [bp-22]     ; ExecNameLen
DOSCODE:9BF4		     rep movsb
DOSCODE:9BF6
DOSCODE:9BF6 Exec_Read_Header:			     ; ...
DOSCODE:9BF6		     push    ss
DOSCODE:9BF7		     pop     ds
DOSCODE:9BF8		     mov     cx, 26	     ; exec_header_len
DOSCODE:9BFB		     mov     dx, offset	exec_signature
DOSCODE:9BFE		     push    es
DOSCODE:9BFF		     push    ds
DOSCODE:9C00		     call    ExecRead
DOSCODE:9C03		     pop     ds
DOSCODE:9C04		     pop     es
DOSCODE:9C05		     jb	     short Exec_Bad_File
DOSCODE:9C07		     or	     ax, ax
DOSCODE:9C09		     jz	     short Exec_Bad_File
DOSCODE:9C0B		     cmp     ax, 26	     ; exec_header_len
DOSCODE:9C0E		     jnz     short Exec_Com_Filej
DOSCODE:9C10		     test    ds:exec_max_BSS, 0FFFFh ; -1
DOSCODE:9C16		     jnz     short Exec_Check_Sig
DOSCODE:9C18		     mov     byte ptr [bp-6], 0FFh ; Exec_Load_High,-1
DOSCODE:9C1C
DOSCODE:9C1C Exec_Check_Sig:			     ; ...
DOSCODE:9C1C		     mov     ax, ds:exec_signature
DOSCODE:9C1F		     cmp     ax, 5A4Dh	     ; 'MZ'
DOSCODE:9C22		     jz	     short Exec_Save_Start
DOSCODE:9C24		     cmp     ax, 4D5Ah	     ; 'ZM'
DOSCODE:9C27		     jz	     short Exec_Save_Start
DOSCODE:9C29
DOSCODE:9C29 Exec_Com_Filej:			     ; ...
DOSCODE:9C29		     jmp     Exec_Com_File
DOSCODE:9C2C ; ---------------------------------------------------------------------------
DOSCODE:9C2C
DOSCODE:9C2C Exec_Save_Start:			     ; ...
DOSCODE:9C2C		     mov     ax, ds:exec_pages
DOSCODE:9C2F		     mov     cl, 5
DOSCODE:9C31		     shl     ax, cl
DOSCODE:9C33		     sub     ax, ds:exec_par_dir
DOSCODE:9C37		     mov     [bp-12], ax     ; Exec_Res_Len_Para
DOSCODE:9C3A		     test    byte ptr [bp-5], 2	; Exec_Func,exec_func_overlay
DOSCODE:9C3E		     jz	     short Exec_Allocate
DOSCODE:9C40		     les     di, [bp-4]	     ; Exec_Blk
DOSCODE:9C43		     mov     ax, es:[di]     ; [ES:DI+EXEC3.load_addr]
DOSCODE:9C46		     mov     [bp-20], ax     ; Exec_DMA
DOSCODE:9C49		     mov     ax, es:[di+2]   ; [ES:DI+EXEC3.reloc_fac]
DOSCODE:9C4D		     mov     [bp-10], ax     ; Exec_Rel_Fac
DOSCODE:9C50		     jmp     Exec_Find_Res
DOSCODE:9C53 ; ---------------------------------------------------------------------------
DOSCODE:9C53
DOSCODE:9C53 Exec_No_Mem:			     ; ...
DOSCODE:9C53		     mov     al, 8	     ; error_not_enough_memory
DOSCODE:9C55		     jmp     short Exec_Bomb
DOSCODE:9C57 ; ---------------------------------------------------------------------------
DOSCODE:9C57
DOSCODE:9C57 Exec_Bad_File:			     ; ...
DOSCODE:9C57		     mov     al, 0Bh	     ; error_bad_format
DOSCODE:9C59
DOSCODE:9C59 Exec_Bomb:				     ; ...
DOSCODE:9C59		     mov     bx, [bp-8]	     ; Exec_FH
DOSCODE:9C5C		     call    Exec_Dealloc
DOSCODE:9C5F		     call    LCritDisk	     ; call LCritMEM
DOSCODE:9C62		     push    ax
DOSCODE:9C63		     push    bp
DOSCODE:9C64		     call    $CLOSE
DOSCODE:9C67		     pop     bp
DOSCODE:9C68		     pop     ax
DOSCODE:9C69		     jmp     Exec_Ret_Err
DOSCODE:9C6C ; ---------------------------------------------------------------------------
DOSCODE:9C6C
DOSCODE:9C6C Exec_Chk_Mem:			     ; ...
DOSCODE:9C6C		     mov     al, ss:AllocMethod
DOSCODE:9C70		     mov     bl, ss:ALLOCMSAVE
DOSCODE:9C75		     mov     ss:AllocMethod, bl
DOSCODE:9C7A		     test    bl, 40h	     ; HIGH_ONLY
DOSCODE:9C7D		     jnz     short Exec_No_Mem
DOSCODE:9C7F		     test    al, 40h
DOSCODE:9C81		     jz	     short Exec_No_Mem
DOSCODE:9C83		     mov     ax, ss:SAVE_AX
DOSCODE:9C87		     jmp     short Exec_Norm_Alloc
DOSCODE:9C89 ; ---------------------------------------------------------------------------
DOSCODE:9C89
DOSCODE:9C89 Exec_Allocate:			     ; ...
DOSCODE:9C89		     mov     byte ptr [bp-29], 0 ; Exec_NoStack
DOSCODE:9C8D		     cmp     ds:exec_SS, 0
DOSCODE:9C92		     jnz     short ea1
DOSCODE:9C94		     cmp     ds:exec_SP, 0
DOSCODE:9C99		     jnz     short ea1
DOSCODE:9C9B		     inc     byte ptr [bp-29]
DOSCODE:9C9E		     cmp     ax, 0FF0h	     ; 1000h-10h
DOSCODE:9CA1		     jnb     short ea1
DOSCODE:9CA3		     add     ax, 10h
DOSCODE:9CA6
DOSCODE:9CA6 ea1:				     ; ...
DOSCODE:9CA6		     test    ds:AllocMethod, 80h ; HIGH_FIRST
DOSCODE:9CAB		     jz	     short Exec_Norm_Alloc
DOSCODE:9CAD		     or	     ds:AllocMethod, 40h ; HIGH_ONLY
DOSCODE:9CB2
DOSCODE:9CB2 Exec_Norm_Alloc:			     ; ...
DOSCODE:9CB2		     mov     ds:SAVE_AX, ax
DOSCODE:9CB5		     mov     bx, 0FFFFh
DOSCODE:9CB8		     push    ds
DOSCODE:9CB9		     call    $ALLOC
DOSCODE:9CBC		     pop     ds
DOSCODE:9CBD		     mov     ax, ds:SAVE_AX
DOSCODE:9CC0		     add     ax, 10h
DOSCODE:9CC3		     cmp     bx, 11h
DOSCODE:9CC6		     jb	     short Exec_Chk_Mem
DOSCODE:9CC8		     cmp     ax, bx
DOSCODE:9CCA		     ja	     short Exec_Chk_Mem
DOSCODE:9CCC		     test    byte ptr [bp-6], 0FFh ; Exec_Load_High,-1
DOSCODE:9CD0		     jnz     short Exec_BX_Max
DOSCODE:9CD2		     add     ax, ds:exec_min_BSS
DOSCODE:9CD6		     jb	     short Exec_Chk_Mem
DOSCODE:9CD8		     cmp     ax, bx
DOSCODE:9CDA		     ja	     short Exec_Chk_Mem
DOSCODE:9CDC		     sub     ax, ds:exec_min_BSS
DOSCODE:9CE0		     add     ax, ds:exec_max_BSS
DOSCODE:9CE4		     jb	     short Exec_BX_Max
DOSCODE:9CE6		     cmp     ax, bx
DOSCODE:9CE8		     jbe     short Exec_Got_Block
DOSCODE:9CEA
DOSCODE:9CEA Exec_BX_Max:			     ; ...
DOSCODE:9CEA		     mov     ax, bx
DOSCODE:9CEC
DOSCODE:9CEC Exec_Got_Block:			     ; ...
DOSCODE:9CEC		     push    ds
DOSCODE:9CED		     mov     bx, ax
DOSCODE:9CEF		     mov     [bp-16], bx     ; Exec_Size
DOSCODE:9CF2		     call    $ALLOC
DOSCODE:9CF5		     pop     ds
DOSCODE:9CF6		     jnb     short ea0
DOSCODE:9CF8		     jmp     Exec_Chk_Mem
DOSCODE:9CFB ; ---------------------------------------------------------------------------
DOSCODE:9CFB
DOSCODE:9CFB ea0:				     ; ...
DOSCODE:9CFB		     mov     cl, ds:ALLOCMSAVE
DOSCODE:9CFF		     mov     ds:AllocMethod, cl
DOSCODE:9D03		     cmp     byte ptr [bp-29], 0 ; Exec_NoStack
DOSCODE:9D07		     jz	     short ea2
DOSCODE:9D09		     cmp     bx, 1000h
DOSCODE:9D0D		     jnb     short ea2
DOSCODE:9D0F		     mov     cl, 4
DOSCODE:9D11		     shl     bx, cl
DOSCODE:9D13		     sub     bx, 100h
DOSCODE:9D17		     mov     ds:exec_SP, bx
DOSCODE:9D1B
DOSCODE:9D1B ea2:				     ; ...
DOSCODE:9D1B		     mov     [bp-18], ax     ; Exec_Load_Block
DOSCODE:9D1E		     add     ax, 10h
DOSCODE:9D21		     test    byte ptr [bp-6], 0FFh ; Exec_Load_High,-1
DOSCODE:9D25		     jz	     short Exec_Use_AX
DOSCODE:9D27		     add     ax, [bp-16]     ; Exec_Size
DOSCODE:9D2A		     sub     ax, [bp-12]     ; Exec_Res_Len_Para
DOSCODE:9D2D		     sub     ax, 10h
DOSCODE:9D30
DOSCODE:9D30 Exec_Use_AX:			     ; ...
DOSCODE:9D30		     mov     [bp-10], ax     ; Exec_Rel_Fac
DOSCODE:9D33		     mov     [bp-20], ax     ; Exec_DMA
DOSCODE:9D36
DOSCODE:9D36 Exec_Find_Res:			     ; ...
DOSCODE:9D36		     mov     dx, [bp-20]     ; Exec_DMA
DOSCODE:9D39		     mov     [bp-28], dx     ; Exec_DMA_Save
DOSCODE:9D3C		     mov     dx, ds:exec_par_dir
DOSCODE:9D40		     push    dx
DOSCODE:9D41		     mov     cl, 4
DOSCODE:9D43		     shl     dx, cl
DOSCODE:9D45		     pop     ax
DOSCODE:9D46		     mov     cl, 12
DOSCODE:9D48		     shr     ax, cl
DOSCODE:9D4A		     mov     cx, ax
DOSCODE:9D4C		     mov     bx, [bp-8]	     ; Exec_FH
DOSCODE:9D4F		     push    ds
DOSCODE:9D50		     xor     al, al
DOSCODE:9D52		     call    $LSEEK
DOSCODE:9D55		     pop     ds
DOSCODE:9D56		     jnb     short Exec_Big_Read
DOSCODE:9D58		     jmp     Exec_Bomb
DOSCODE:9D5B ; ---------------------------------------------------------------------------
DOSCODE:9D5B
DOSCODE:9D5B Exec_Big_Read:			     ; ...
DOSCODE:9D5B		     mov     bx, [bp-12]     ; Exec_Res_Len_Para
DOSCODE:9D5E		     cmp     bx, 1000h
DOSCODE:9D62		     jb	     short Exec_Read_OK
DOSCODE:9D64		     mov     bx, 0FE0h
DOSCODE:9D67
DOSCODE:9D67 Exec_Read_OK:			     ; ...
DOSCODE:9D67		     sub     [bp-12], bx     ; Exec_Res_Len_Para
DOSCODE:9D6A		     push    bx
DOSCODE:9D6B		     mov     cl, 4
DOSCODE:9D6D		     shl     bx, cl
DOSCODE:9D6F		     mov     cx, bx
DOSCODE:9D71		     push    ds
DOSCODE:9D72		     mov     ds, word ptr [bp-20] ; Exec_DMA
DOSCODE:9D75		     xor     dx, dx
DOSCODE:9D77		     push    cx
DOSCODE:9D78		     call    ExecRead
DOSCODE:9D7B		     pop     cx
DOSCODE:9D7C		     pop     ds
DOSCODE:9D7D		     jb	     short Exec_Bad_FileJ
DOSCODE:9D7F		     cmp     cx, ax
DOSCODE:9D81		     pop     bx
DOSCODE:9D82		     jz	     short ExecCheckEnd
DOSCODE:9D84		     sub     cx, ax
DOSCODE:9D86		     cmp     cx, 512
DOSCODE:9D8A		     jnb     short Exec_Bad_FileJ
DOSCODE:9D8C
DOSCODE:9D8C ExecCheckEnd:			     ; ...
DOSCODE:9D8C		     add     [bp-20], bx     ; Exec_DMA
DOSCODE:9D8F		     test    word ptr [bp-0Ch],	0FFFFh ; Exec_Res_Len_Para,-1
DOSCODE:9D94		     jnz     short Exec_Big_Read
DOSCODE:9D96		     mov     cx, [bp-10]     ; Exec_Rel_Fac
DOSCODE:9D99		     mov     ax, ds:exec_SS
DOSCODE:9D9C		     add     ax, cx
DOSCODE:9D9E		     mov     ds:exec_init_SS, ax
DOSCODE:9DA1		     mov     ax, ds:exec_SP
DOSCODE:9DA4		     mov     ds:exec_init_SP, ax
DOSCODE:9DA7		     les     ax, dword ptr ds:exec_IP ;	les ax,[exec_IP]
DOSCODE:9DAB		     mov     ds:exec_init_IP, ax
DOSCODE:9DAE		     mov     ax, es
DOSCODE:9DB0		     add     ax, cx
DOSCODE:9DB2		     mov     ds:exec_init_CS, ax
DOSCODE:9DB5		     xor     cx, cx
DOSCODE:9DB7		     mov     dx, ds:exec_rle_table
DOSCODE:9DBB		     mov     bx, [bp-8]	     ; Exec_FH
DOSCODE:9DBE		     push    ds
DOSCODE:9DBF		     xor     ax, ax
DOSCODE:9DC1		     call    $LSEEK
DOSCODE:9DC4		     pop     ds
DOSCODE:9DC5		     jnb     short exec_get_entries
DOSCODE:9DC7
DOSCODE:9DC7 Exec_Bad_FileJ:			     ; ...
DOSCODE:9DC7		     jmp     Exec_Bad_File
DOSCODE:9DCA ; ---------------------------------------------------------------------------
DOSCODE:9DCA
DOSCODE:9DCA exec_get_entries:			     ; ...
DOSCODE:9DCA		     mov     dx, ds:exec_rle_count
DOSCODE:9DCE
DOSCODE:9DCE exec_read_reloc:			     ; ...
DOSCODE:9DCE		     push    dx
DOSCODE:9DCF		     mov     dx, offset	OPENBUF
DOSCODE:9DD2		     mov     cx, 396	     ; ((Exec_Internal_Buffer_Size)/4)*4
DOSCODE:9DD2					     ; (397>>2)<<2
DOSCODE:9DD5		     push    ds
DOSCODE:9DD6		     call    ExecRead
DOSCODE:9DD9		     pop     es
DOSCODE:9DDA		     pop     dx
DOSCODE:9DDB		     jb	     short Exec_Bad_FileJ
DOSCODE:9DDD		     mov     cx, 99	     ; (Exec_Internal_Buffer_Size)/4 ; (397>>2)
DOSCODE:9DE0		     mov     di, offset	OPENBUF	; Exec_Internal_Buffer
DOSCODE:9DE3		     mov     si, [bp-10]     ; Exec_Rel_Fac
DOSCODE:9DE6
DOSCODE:9DE6 exec_reloc_one:			     ; ...
DOSCODE:9DE6		     or	     dx, dx
DOSCODE:9DE8		     jz	     short Exec_Set_PDBJ
DOSCODE:9DEA
DOSCODE:9DEA exec_get_addr:
DOSCODE:9DEA		     lds     bx, es:[di]
DOSCODE:9DED		     mov     ax, ds
DOSCODE:9DEF		     add     ax, [bp-28]     ; Exec_DMA_Save
DOSCODE:9DF2		     mov     ds, ax
DOSCODE:9DF4		     add     [bx], si
DOSCODE:9DF6		     add     di, 4
DOSCODE:9DF9		     dec     dx
DOSCODE:9DFA		     loop    exec_reloc_one
DOSCODE:9DFC		     push    es
DOSCODE:9DFD		     pop     ds
DOSCODE:9DFE		     jmp     short exec_read_reloc
DOSCODE:9E00 ; ---------------------------------------------------------------------------
DOSCODE:9E00
DOSCODE:9E00 Exec_Set_PDBJ:			     ; ...
DOSCODE:9E00		     push    es
DOSCODE:9E01		     push    ax
DOSCODE:9E02		     push    cx
DOSCODE:9E03		     mov     es, word ptr [bp-28] ; Exec_DMA_Save
DOSCODE:9E06		     mov     ax, ss:exec_init_CS
DOSCODE:9E0A		     mov     cx, ss:exec_init_IP
DOSCODE:9E0F		     call    ss:FixExePatch  ; call word [ss:FixExePatch]
DOSCODE:9E14		     pop     cx
DOSCODE:9E15		     pop     ax
DOSCODE:9E16		     pop     es
DOSCODE:9E17		     jmp     Exec_Set_PDB
DOSCODE:9E1A ; ---------------------------------------------------------------------------
DOSCODE:9E1A
DOSCODE:9E1A Exec_No_Memj:			     ; ...
DOSCODE:9E1A		     jmp     Exec_No_Mem
DOSCODE:9E1D ; ---------------------------------------------------------------------------
DOSCODE:9E1D
DOSCODE:9E1D Exec_Com_File:			     ; ...
DOSCODE:9E1D		     test    byte ptr [bp-5], 2	; Exec_Func,exec_func_overlay
DOSCODE:9E21		     jz	     short Exec_Alloc_Com_File
DOSCODE:9E23		     lds     si, [bp-4]	     ; lds si,Exec_Blk
DOSCODE:9E26		     lodsw
DOSCODE:9E27		     mov     [bp-14h], ax    ; mov Exec_DMA,ax
DOSCODE:9E2A		     mov     ax, 0FFFFh
DOSCODE:9E2D		     jmp     short Exec_Read_Block
DOSCODE:9E2F ; ---------------------------------------------------------------------------
DOSCODE:9E2F
DOSCODE:9E2F Exec_Chk_Com_Mem:			     ; ...
DOSCODE:9E2F		     mov     al, ss:AllocMethod
DOSCODE:9E33		     mov     bl, ss:ALLOCMSAVE
DOSCODE:9E38		     mov     ss:AllocMethod, bl
DOSCODE:9E3D		     test    bl, 40h	     ; HIGH_ONLY
DOSCODE:9E40		     jnz     short Exec_No_Memj
DOSCODE:9E42		     test    al, 40h
DOSCODE:9E44		     jz	     short Exec_No_Memj
DOSCODE:9E46		     mov     ax, [bp-18]     ; Exec_Load_Block
DOSCODE:9E49		     xor     bx, bx
DOSCODE:9E4B		     call    ChangeOwner
DOSCODE:9E4E		     jmp     short Exec_Norm_Com_Alloc
DOSCODE:9E50 ; ---------------------------------------------------------------------------
DOSCODE:9E50
DOSCODE:9E50 Exec_Alloc_Com_File:		     ; ...
DOSCODE:9E50		     test    ss:AllocMethod, 80h ; HIGH_FIRST
DOSCODE:9E56		     jz	     short Exec_Norm_Com_Alloc
DOSCODE:9E58		     or	     ss:AllocMethod, 40h ; HIGH_ONLY
DOSCODE:9E5E
DOSCODE:9E5E Exec_Norm_Com_Alloc:		     ; ...
DOSCODE:9E5E		     mov     bx, 0FFFFh
DOSCODE:9E61		     call    $ALLOC
DOSCODE:9E64		     or	     bx, bx
DOSCODE:9E66		     jz	     short Exec_Chk_Com_Mem
DOSCODE:9E68		     mov     [bp-16], bx     ; Exec_Size
DOSCODE:9E6B		     push    bx
DOSCODE:9E6C		     call    $ALLOC
DOSCODE:9E6F		     pop     bx
DOSCODE:9E70		     mov     [bp-18], ax     ; Exec_Load_Block
DOSCODE:9E73		     add     ax, 10h
DOSCODE:9E76		     mov     [bp-20], ax     ; Exec_DMA
DOSCODE:9E79		     xor     ax, ax
DOSCODE:9E7B		     cmp     bx, 1000h
DOSCODE:9E7F		     jnb     short Exec_Read_Com
DOSCODE:9E81		     mov     ax, bx
DOSCODE:9E83		     mov     cl, 4
DOSCODE:9E85		     shl     ax, cl
DOSCODE:9E87		     cmp     ax, 100h
DOSCODE:9E8A		     jbe     short Exec_Chk_Com_Mem
DOSCODE:9E8C		     sub     ax, 100h
DOSCODE:9E8F
DOSCODE:9E8F Exec_Read_Com:			     ; ...
DOSCODE:9E8F		     sub     ax, 100h
DOSCODE:9E92
DOSCODE:9E92 Exec_Read_Block:			     ; ...
DOSCODE:9E92		     push    ax
DOSCODE:9E93		     mov     bx, [bp-8]	     ; Exec_FH
DOSCODE:9E96		     xor     cx, cx
DOSCODE:9E98		     mov     dx, cx
DOSCODE:9E9A		     xor     ax, ax
DOSCODE:9E9C		     call    $LSEEK
DOSCODE:9E9F		     pop     cx
DOSCODE:9EA0		     mov     ds, word ptr [bp-20] ; Exec_DMA
DOSCODE:9EA3		     xor     dx, dx
DOSCODE:9EA5		     push    cx
DOSCODE:9EA6		     call    ExecRead
DOSCODE:9EA9		     pop     si
DOSCODE:9EAA		     jnb     short OkRead
DOSCODE:9EAC		     jmp     Exec_Bad_File
DOSCODE:9EAF ; ---------------------------------------------------------------------------
DOSCODE:9EAF
DOSCODE:9EAF OkRead:				     ; ...
DOSCODE:9EAF		     cmp     ax, si
DOSCODE:9EB1		     jnz     short OkRead2
DOSCODE:9EB3		     jmp     Exec_Chk_Com_Mem
DOSCODE:9EB6 ; ---------------------------------------------------------------------------
DOSCODE:9EB6
DOSCODE:9EB6 OkRead2:				     ; ...
DOSCODE:9EB6		     mov     bl, ss:ALLOCMSAVE
DOSCODE:9EBB		     mov     ss:AllocMethod, bl
DOSCODE:9EC0		     test    byte ptr [bp-5], 2	; Exec_Func,exec_func_overlay
DOSCODE:9EC4		     jnz     short Exec_Set_PDB
DOSCODE:9EC6		     mov     ax, [bp-20]     ; Exec_DMA
DOSCODE:9EC9		     sub     ax, 10h
DOSCODE:9ECC		     mov     ss:exec_init_CS, ax
DOSCODE:9ED0		     mov     ss:exec_init_IP, 100h
DOSCODE:9ED7		     add     si, 0FEh
DOSCODE:9EDB		     cmp     si, 0FFFEh
DOSCODE:9EDE		     jz	     short Exec_St_Ok
DOSCODE:9EE0		     add     si, 100h
DOSCODE:9EE4
DOSCODE:9EE4 Exec_St_Ok:			     ; ...
DOSCODE:9EE4		     mov     ss:exec_init_SP, si
DOSCODE:9EE9		     mov     ss:exec_init_SS, ax
DOSCODE:9EED		     mov     ds, ax
DOSCODE:9EEF		     mov     word ptr [si], 0
DOSCODE:9EF3		     call    ss:ChkCopyProt  ; call word [ss:ChkCopyProt]
DOSCODE:9EF8
DOSCODE:9EF8 Exec_Set_PDB:			     ; ...
DOSCODE:9EF8		     mov     bx, [bp-8]	     ; Exec_FH
DOSCODE:9EFB		     call    Exec_Dealloc
DOSCODE:9EFE		     push    bp
DOSCODE:9EFF		     call    $CLOSE
DOSCODE:9F02		     pop     bp
DOSCODE:9F03		     call    Exec_Alloc
DOSCODE:9F06		     test    byte ptr [bp-5], 2	; Exec_Func,exec_func_overlay
DOSCODE:9F0A		     jz	     short Exec_Build_Header
DOSCODE:9F0C		     call    Scan_Execname
DOSCODE:9F0F		     call    Scan_Special_Entries
DOSCODE:9F12		     cmp     ss:DriverLoad, 0
DOSCODE:9F18		     jz	     short norm_ovl
DOSCODE:9F1A		     push    si
DOSCODE:9F1B		     push    es
DOSCODE:9F1C		     les     si, ss:BiosDataPtr
DOSCODE:9F21		     cmp     byte ptr es:[si], 0
DOSCODE:9F25		     jz	     short sysinit_done
DOSCODE:9F27		     mov     es, ss:CurrentPDB
DOSCODE:9F2C		     push    ss:SPECIAL_VERSION	; push word [ss:SPECIAL_VERSION]
DOSCODE:9F31		     pop     word ptr es:SFTFCB	; pop word [es:PDB.Version]
DOSCODE:9F36		     jmp     short setver_done
DOSCODE:9F38 ; ---------------------------------------------------------------------------
DOSCODE:9F38
DOSCODE:9F38 sysinit_done:			     ; ...
DOSCODE:9F38		     mov     ss:DriverLoad, 0
DOSCODE:9F3E
DOSCODE:9F3E setver_done:			     ; ...
DOSCODE:9F3E		     pop     es
DOSCODE:9F3F		     pop     si
DOSCODE:9F40
DOSCODE:9F40 norm_ovl:				     ; ...
DOSCODE:9F40		     mov     sp, bp
DOSCODE:9F42		     pop     bp
DOSCODE:9F43		     jmp     SYS_RETURN	     ; SYS_RET_OK
DOSCODE:9F46 ; ---------------------------------------------------------------------------
DOSCODE:9F46
DOSCODE:9F46 Exec_Build_Header:			     ; ...
DOSCODE:9F46		     mov     dx, [bp-18]     ; Exec_Load_Block
DOSCODE:9F49		     mov     si, 1	     ; ARENA.OWNER
DOSCODE:9F4C		     mov     ax, [bp-14]     ; Exec_Environ
DOSCODE:9F4F		     or	     ax, ax
DOSCODE:9F51		     jz	     short No_Owner
DOSCODE:9F53		     dec     ax
DOSCODE:9F54		     mov     ds, ax
DOSCODE:9F56		     mov     [si], dx
DOSCODE:9F58
DOSCODE:9F58 No_Owner:				     ; ...
DOSCODE:9F58		     mov     ax, [bp-18]     ; Exec_Load_Block
DOSCODE:9F5B		     dec     ax
DOSCODE:9F5C		     mov     ds, ax
DOSCODE:9F5E		     mov     [si], dx
DOSCODE:9F60		     push    ds
DOSCODE:9F61		     pop     es
DOSCODE:9F62		     mov     di, 8	     ; ARENA.NAME
DOSCODE:9F65		     call    Scan_Execname
DOSCODE:9F68		     push    cx
DOSCODE:9F69		     push    si
DOSCODE:9F6A
DOSCODE:9F6A MoveName:				     ; ...
DOSCODE:9F6A		     lodsb
DOSCODE:9F6B		     cmp     al, '.'         ; 2Eh
DOSCODE:9F6D		     jz	     short Mem_Done
DOSCODE:9F6F		     stosb
DOSCODE:9F70		     cmp     di, 16	     ; ARENAHEADERSIZE
DOSCODE:9F73		     jnb     short Mem_Done
DOSCODE:9F75		     loop    MoveName
DOSCODE:9F77
DOSCODE:9F77 Mem_Done:				     ; ...
DOSCODE:9F77		     xor     al, al
DOSCODE:9F79		     cmp     di, 16	     ; ARENAHEADERSIZE
DOSCODE:9F7C		     jnb     short Fill8
DOSCODE:9F7E		     stosb
DOSCODE:9F7F
DOSCODE:9F7F Fill8:				     ; ...
DOSCODE:9F7F		     pop     si
DOSCODE:9F80		     pop     cx
DOSCODE:9F81		     call    Scan_Special_Entries
DOSCODE:9F84		     push    dx
DOSCODE:9F85		     mov     si, [bp-16]     ; Exec_Size
DOSCODE:9F88		     add     si, dx
DOSCODE:9F8A		     call    $DUP_PDB
DOSCODE:9F8D		     pop     dx
DOSCODE:9F8E		     push    word ptr [bp-14] ;	Exec_Environ
DOSCODE:9F91		     pop     word ptr es:2Ch ; [ES:PDB.ENVIRON]
DOSCODE:9F96		     push    ss:SPECIAL_VERSION
DOSCODE:9F9B		     pop     word ptr es:SFTFCB	; [ES:PDB.Version]
DOSCODE:9FA0		     lds     si, [bp-4]	     ; Exec_Blk
DOSCODE:9FA3		     push    ds
DOSCODE:9FA4		     push    si
DOSCODE:9FA5		     lds     si, [si+6]	     ; [SI+EXEC0.5C_FCB]
DOSCODE:9FA8		     mov     cx, 12
DOSCODE:9FAB		     push    cx
DOSCODE:9FAC		     mov     di, 5Ch
DOSCODE:9FAF		     mov     bl, [si]
DOSCODE:9FB1		     rep movsb
DOSCODE:9FB3		     xor     ax, ax
DOSCODE:9FB5		     stosw
DOSCODE:9FB6		     stosw
DOSCODE:9FB7		     pop     cx
DOSCODE:9FB8		     pop     si
DOSCODE:9FB9		     pop     ds
DOSCODE:9FBA		     push    ds
DOSCODE:9FBB		     push    si
DOSCODE:9FBC		     lds     si, [si+0Ah]    ; [SI+EXEC0.6C_FCB]
DOSCODE:9FBF		     mov     bh, [si]
DOSCODE:9FC1		     rep movsb
DOSCODE:9FC3		     stosw
DOSCODE:9FC4		     stosw
DOSCODE:9FC5		     pop     si
DOSCODE:9FC6		     pop     ds
DOSCODE:9FC7		     lds     si, [si+2]	     ; [SI+EXEC0.COM_LINE]
DOSCODE:9FCA		     or	     cl, 80h
DOSCODE:9FCD		     mov     di, cx
DOSCODE:9FCF		     rep movsb
DOSCODE:9FD1		     dec     cl
DOSCODE:9FD3		     mov     al, bh
DOSCODE:9FD5		     xor     bh, bh
DOSCODE:9FD7		     call    GetVisDrv
DOSCODE:9FDA		     jnb     short Exec_BL
DOSCODE:9FDC		     mov     bh, cl
DOSCODE:9FDE
DOSCODE:9FDE Exec_BL:				     ; ...
DOSCODE:9FDE		     mov     al, bl
DOSCODE:9FE0		     xor     bl, bl
DOSCODE:9FE2		     call    GetVisDrv
DOSCODE:9FE5		     jnb     short Exec_Set_Return
DOSCODE:9FE7		     mov     bl, cl
DOSCODE:9FE9
DOSCODE:9FE9 Exec_Set_Return:			     ; ...
DOSCODE:9FE9		     call    Get_User_Stack
DOSCODE:9FEC		     push    word ptr [si+14h] ; [SI+user_env.user_CS]
DOSCODE:9FEF		     push    word ptr [si+12h] ; [SI+user_env.user_IP]
DOSCODE:9FF2		     push    word ptr [si+14h] ; [SI+user_env.user_CS]
DOSCODE:9FF5		     push    word ptr [si+12h] ; [SI+user_env.user_IP]
DOSCODE:9FF8		     pop     word ptr es:0Ah ; [ES:PDB.EXIT]
DOSCODE:9FFD		     pop     word ptr es:0Ch ; [ES:PDB.EXIT+2]
DOSCODE:A002		     xor     ax, ax
DOSCODE:A004		     mov     ds, ax
DOSCODE:A006		     pop     word ptr ds:88h ; [addr_int_terminate] ; 22h*4
DOSCODE:A00A		     pop     word ptr ds:8Ah ; [addr_int_terminate+2] ;	(22h*4)+2
DOSCODE:A00E		     mov     word ptr ss:DMAADD, 80h
DOSCODE:A015		     mov     ds, ss:CurrentPDB
DOSCODE:A01A		     mov     word ptr ss:DMAADD+2, ds
DOSCODE:A01F		     test    byte ptr [bp-5], 1	; Exec_Func,exec_func_no_execute
DOSCODE:A023		     jz	     short exec_go
DOSCODE:A025		     lds     si, dword ptr ss:exec_init_SP
DOSCODE:A02A		     les     di, [bp-4]	     ; Exec_Blk
DOSCODE:A02D		     mov     word ptr es:[di+10h], ds ;	[ES:DI+EXEC1.SS]
DOSCODE:A031		     dec     si
DOSCODE:A032		     dec     si
DOSCODE:A033		     mov     [si], bx
DOSCODE:A035		     mov     es:[di+0Eh], si ; [ES:DI+EXEC1.SP]
DOSCODE:A039		     lds     ax, dword ptr ss:exec_init_IP
DOSCODE:A03E		     mov     word ptr es:[di+14h], ds ;	[ES:DI+EXEC1.CS]
DOSCODE:A042		     mov     es:[di+12h], ax ; [ES:DI+EXEC1.IP]
DOSCODE:A046		     mov     sp, bp
DOSCODE:A048		     pop     bp
DOSCODE:A049		     jmp     SYS_RETURN	     ; SYS_RET_OK
DOSCODE:A04C ; ---------------------------------------------------------------------------
DOSCODE:A04C
DOSCODE:A04C exec_go:				     ; ...
DOSCODE:A04C		     lds     si, dword ptr ss:exec_init_IP
DOSCODE:A051		     les     di, dword ptr ss:exec_init_SP
DOSCODE:A056		     mov     ax, es
DOSCODE:A058		     cmp     ss:DosHasHMA, 0
DOSCODE:A05E		     jz	     short Xfer_To_User
DOSCODE:A060		     push    ds
DOSCODE:A061		     mov     ds, cs:DosDSeg
DOSCODE:A066		     or	     ds:DOS_FLAG, 4  ; EXECA20OFF
DOSCODE:A06B		     mov     ds:A20OFF_PSP, dx
DOSCODE:A06F		     mov     ax, ds
DOSCODE:A071		     pop     ds
DOSCODE:A072		     push    ax
DOSCODE:A073		     mov     ax, offset	disa20_xfer
DOSCODE:A076		     push    ax
DOSCODE:A077		     mov     ax, es
DOSCODE:A079		     retf
DOSCODE:A07A ; ---------------------------------------------------------------------------
DOSCODE:A07A
DOSCODE:A07A Xfer_To_User:			     ; ...
DOSCODE:A07A		     cli
DOSCODE:A07B		     mov     ss:INDOS, 0
DOSCODE:A081		     mov     ss, ax
DOSCODE:A083		     mov     sp, di
DOSCODE:A085		     sti
DOSCODE:A086		     push    ds
DOSCODE:A087		     push    si
DOSCODE:A088		     mov     es, dx
DOSCODE:A08A		     mov     ds, dx
DOSCODE:A08C		     mov     ax, bx
DOSCODE:A08E		     retf
DOSCODE:A08F
DOSCODE:A08F ; =============== S U B R O U T I N E =======================================
DOSCODE:A08F
DOSCODE:A08F
DOSCODE:A08F ExecRead	     proc near		     ; ...
DOSCODE:A08F		     call    Exec_Dealloc
DOSCODE:A092		     mov     bx, [bp-8]	     ; Exec_FH
DOSCODE:A095		     push    bp
DOSCODE:A096		     call    $READ
DOSCODE:A099		     pop     bp
DOSCODE:A09A		     call    Exec_Alloc
DOSCODE:A09D		     retn
DOSCODE:A09D ExecRead	     endp
DOSCODE:A09D
DOSCODE:A09E
DOSCODE:A09E ; =============== S U B R O U T I N E =======================================
DOSCODE:A09E
DOSCODE:A09E
DOSCODE:A09E Exec_Dealloc    proc near		     ; ...
DOSCODE:A09E		     push    bx
DOSCODE:A09F		     sub     bx, bx
DOSCODE:A0A1		     call    ECritDisk	     ; call ECritMEM
DOSCODE:A0A4		     call    ChangeOwners
DOSCODE:A0A7		     pop     bx
DOSCODE:A0A8		     retn
DOSCODE:A0A8 Exec_Dealloc    endp
DOSCODE:A0A8
DOSCODE:A0A9
DOSCODE:A0A9 ; =============== S U B R O U T I N E =======================================
DOSCODE:A0A9
DOSCODE:A0A9
DOSCODE:A0A9 Exec_Alloc	     proc near		     ; ...
DOSCODE:A0A9		     push    bx
DOSCODE:A0AA		     mov     bx, ss:CurrentPDB
DOSCODE:A0AF		     call    ChangeOwners
DOSCODE:A0B2		     call    LCritDisk	     ; call LCritMEM
DOSCODE:A0B5		     pop     bx
DOSCODE:A0B6		     retn
DOSCODE:A0B6 Exec_Alloc	     endp
DOSCODE:A0B6
DOSCODE:A0B7
DOSCODE:A0B7 ; =============== S U B R O U T I N E =======================================
DOSCODE:A0B7
DOSCODE:A0B7
DOSCODE:A0B7 ChangeOwners    proc near		     ; ...
DOSCODE:A0B7		     pushf
DOSCODE:A0B8		     push    ax
DOSCODE:A0B9		     mov     ax, [bp-14]     ; Exec_Environ
DOSCODE:A0BC		     call    ChangeOwner
DOSCODE:A0BF		     mov     ax, [bp-18]     ; Exec_Load_Block
DOSCODE:A0C2		     call    ChangeOwner
DOSCODE:A0C5		     pop     ax
DOSCODE:A0C6		     popf
DOSCODE:A0C7
DOSCODE:A0C7 chgown_retn:			     ; ...
DOSCODE:A0C7		     retn
DOSCODE:A0C7 ChangeOwners    endp
DOSCODE:A0C7
DOSCODE:A0C8
DOSCODE:A0C8 ; =============== S U B R O U T I N E =======================================
DOSCODE:A0C8
DOSCODE:A0C8
DOSCODE:A0C8 ChangeOwner     proc near		     ; ...
DOSCODE:A0C8		     or	     ax, ax
DOSCODE:A0CA		     jz	     short chgown_retn
DOSCODE:A0CC		     dec     ax
DOSCODE:A0CD		     push    ds
DOSCODE:A0CE		     mov     ds, ax
DOSCODE:A0D0		     mov     ds:1, bx	     ; [ARENA.OWNER]
DOSCODE:A0D4		     pop     ds
DOSCODE:A0D5		     retn
DOSCODE:A0D5 ChangeOwner     endp
DOSCODE:A0D5
DOSCODE:A0D6
DOSCODE:A0D6 ; =============== S U B R O U T I N E =======================================
DOSCODE:A0D6
DOSCODE:A0D6
DOSCODE:A0D6 Scan_Execname   proc near		     ; ...
DOSCODE:A0D6		     lds     si, [bp-26]     ; ExecName
DOSCODE:A0D9
DOSCODE:A0D9 Save_Begin:			     ; ...
DOSCODE:A0D9		     mov     cx, si
DOSCODE:A0DB
DOSCODE:A0DB Scan0:				     ; ...
DOSCODE:A0DB		     lodsb
DOSCODE:A0DC		     cmp     al, ':'         ; 3Ah
DOSCODE:A0DE		     jz	     short Save_Begin
DOSCODE:A0E0		     cmp     al, '\'         ; 5Ch
DOSCODE:A0E2		     jz	     short Save_Begin
DOSCODE:A0E4		     cmp     al, 0
DOSCODE:A0E6		     jnz     short Scan0
DOSCODE:A0E8		     sub     si, cx
DOSCODE:A0EA		     xchg    si, cx
DOSCODE:A0EC		     retn
DOSCODE:A0EC Scan_Execname   endp
DOSCODE:A0EC
DOSCODE:A0ED
DOSCODE:A0ED ; =============== S U B R O U T I N E =======================================
DOSCODE:A0ED
DOSCODE:A0ED
DOSCODE:A0ED Scan_Special_Entries proc near	     ; ...
DOSCODE:A0ED		     dec     cx
DOSCODE:A0EE		     mov     ss:SPECIAL_VERSION, 5
DOSCODE:A0F5		     les     di, ss:UU_IFS_DOS_CALL
DOSCODE:A0FA		     mov     ax, es
DOSCODE:A0FC		     or	     ax, di
DOSCODE:A0FE		     jz	     short End_List
DOSCODE:A100
DOSCODE:A100 GetEntries:			     ; ...
DOSCODE:A100		     mov     al, es:[di]
DOSCODE:A103		     or	     al, al
DOSCODE:A105		     jz	     short End_List
DOSCODE:A107		     mov     ss:TEMP_VAR2, di
DOSCODE:A10C		     cmp     al, cl
DOSCODE:A10E		     jnz     short SkipOne
DOSCODE:A110		     inc     di
DOSCODE:A111		     push    cx
DOSCODE:A112		     push    si
DOSCODE:A113		     push    ax
DOSCODE:A114
DOSCODE:A114 sse_next_char:			     ; ...
DOSCODE:A114		     lodsb
DOSCODE:A115		     call    UCase
DOSCODE:A118		     scasb
DOSCODE:A119		     jnz     short Not_Matched
DOSCODE:A11B		     loop    sse_next_char
DOSCODE:A11D		     pop     ax
DOSCODE:A11E		     mov     ax, es:[di]
DOSCODE:A121		     mov     ss:SPECIAL_VERSION, ax
DOSCODE:A125		     pop     si
DOSCODE:A126		     pop     cx
DOSCODE:A127		     jmp     short End_List
DOSCODE:A129 ; ---------------------------------------------------------------------------
DOSCODE:A129
DOSCODE:A129 Not_Matched:			     ; ...
DOSCODE:A129		     pop     ax
DOSCODE:A12A		     pop     si
DOSCODE:A12B		     pop     cx
DOSCODE:A12C
DOSCODE:A12C SkipOne:				     ; ...
DOSCODE:A12C		     mov     di, ss:TEMP_VAR2
DOSCODE:A131		     xor     ah, ah
DOSCODE:A133		     add     di, ax
DOSCODE:A135		     add     di, 3
DOSCODE:A138		     jmp     short GetEntries
DOSCODE:A13A ; ---------------------------------------------------------------------------
DOSCODE:A13A
DOSCODE:A13A End_List:				     ; ...
DOSCODE:A13A		     retn
DOSCODE:A13A Scan_Special_Entries endp
DOSCODE:A13A
DOSCODE:A13B ; ---------------------------------------------------------------------------
DOSCODE:A13B
DOSCODE:A13B $KEEP_PROCESS:			     ; ...
DOSCODE:A13B		     push    ax
DOSCODE:A13C		     mov     ss:EXIT_TYPE, 3 ; EXIT_KEEP_PROCESS
DOSCODE:A142		     mov     es, ss:CurrentPDB
DOSCODE:A147		     cmp     dx, 6
DOSCODE:A14A		     jnb     short Keep_Shrink
DOSCODE:A14C		     mov     dx, 6
DOSCODE:A14F
DOSCODE:A14F Keep_Shrink:			     ; ...
DOSCODE:A14F		     mov     bx, dx
DOSCODE:A151		     push    bx
DOSCODE:A152		     push    es
DOSCODE:A153		     call    $SETBLOCK
DOSCODE:A156		     pop     ds
DOSCODE:A157		     pop     bx
DOSCODE:A158		     jb	     short Keep_Done
DOSCODE:A15A		     mov     ax, ds
DOSCODE:A15C		     add     ax, bx
DOSCODE:A15E		     mov     ds:2, ax	     ; [PDB.BLOCK_LEN]
DOSCODE:A161
DOSCODE:A161 Keep_Done:				     ; ...
DOSCODE:A161		     pop     ax
DOSCODE:A162		     jmp     short exit_inner
DOSCODE:A164 ; ---------------------------------------------------------------------------
DOSCODE:A164
DOSCODE:A164 STAY_RESIDENT:			     ; ...
DOSCODE:A164		     mov     ax, 3100h	     ; (KEEP_PROCESS<<8)+0
DOSCODE:A167		     add     dx, 15
DOSCODE:A16A		     rcr     dx, 1
DOSCODE:A16C		     mov     cl, 3
DOSCODE:A16E		     shr     dx, cl
DOSCODE:A170		     jmp     COMMAND
DOSCODE:A173 ; ---------------------------------------------------------------------------
DOSCODE:A173
DOSCODE:A173 $EXIT:				     ; ...
DOSCODE:A173		     xor     ah, ah
DOSCODE:A175		     xchg    ah, ss:DidCTRLC
DOSCODE:A17A		     or	     ah, ah
DOSCODE:A17C		     mov     ss:EXIT_TYPE, 0 ; EXIT_TERMINATE
DOSCODE:A182		     jz	     short exit_inner
DOSCODE:A184		     mov     ss:EXIT_TYPE, 1 ; EXIT_CTRL_C
DOSCODE:A18A
DOSCODE:A18A exit_inner:			     ; ...
DOSCODE:A18A		     call    Get_User_Stack
DOSCODE:A18D		     push    ss:CurrentPDB
DOSCODE:A192		     pop     word ptr [si+14h] ; [SI+user_env.user_CS]
DOSCODE:A195		     jmp     short abort_inner
DOSCODE:A197 ; ---------------------------------------------------------------------------
DOSCODE:A197
DOSCODE:A197 $ABORT:				     ; ...
DOSCODE:A197		     xor     al, al
DOSCODE:A199		     mov     ss:EXIT_TYPE, 0 ; EXIT_ABORT
DOSCODE:A19F
DOSCODE:A19F abort_inner:			     ; ...
DOSCODE:A19F		     mov     ah, ss:EXIT_TYPE
DOSCODE:A1A4		     mov     ss:exit_code, ax
DOSCODE:A1A8		     call    Get_User_Stack
DOSCODE:A1AB		     mov     ds, word ptr [si+14h] ; [SI+user_env.user_CS]
DOSCODE:A1AE		     xor     ax, ax
DOSCODE:A1B0		     mov     es, ax
DOSCODE:A1B2		     mov     si, 10	     ; SAVEXIT
DOSCODE:A1B5		     mov     di, 88h	     ; addr_int_terminate
DOSCODE:A1B8		     movsw
DOSCODE:A1B9		     movsw
DOSCODE:A1BA		     movsw
DOSCODE:A1BB		     movsw
DOSCODE:A1BC		     movsw
DOSCODE:A1BD		     movsw
DOSCODE:A1BE		     jmp     reset_environment
DOSCODE:A1C1 ; ---------------------------------------------------------------------------
DOSCODE:A1C1
DOSCODE:A1C1 RetExePatch:			     ; ...
DOSCODE:A1C1		     retn
DOSCODE:A1C2
DOSCODE:A1C2 ; =============== S U B R O U T I N E =======================================
DOSCODE:A1C2
DOSCODE:A1C2
DOSCODE:A1C2 arena_free_process	proc near	     ; ...
DOSCODE:A1C2		     mov     ax, ss:arena_head
DOSCODE:A1C6
DOSCODE:A1C6 arena_free_process_start:		     ; ...
DOSCODE:A1C6		     mov     di, 0	     ; ARENA.SIGNATURE
DOSCODE:A1C9		     call    check_signature
DOSCODE:A1CC
DOSCODE:A1CC arena_free_process_loop:		     ; ...
DOSCODE:A1CC		     jb	     short AFP_RETN
DOSCODE:A1CE		     push    es
DOSCODE:A1CF		     pop     ds
DOSCODE:A1D0		     cmp     ds:1, bx	     ; [ARENA.OWNER]
DOSCODE:A1D4		     jnz     short arena_free_next
DOSCODE:A1D6		     mov     ds:1, di
DOSCODE:A1DA
DOSCODE:A1DA arena_free_next:			     ; ...
DOSCODE:A1DA		     cmp     byte ptr [di], 5Ah	; 'Z' ; arena_signature_end
DOSCODE:A1DD		     jz	     short arena_chk_umbs
DOSCODE:A1DF		     call    arena_next
DOSCODE:A1E2		     jmp     short arena_free_process_loop
DOSCODE:A1E4 ; ---------------------------------------------------------------------------
DOSCODE:A1E4
DOSCODE:A1E4 arena_chk_umbs:			     ; ...
DOSCODE:A1E4		     mov     ax, ss:UMB_HEAD
DOSCODE:A1E8		     cmp     ax, 0FFFFh
DOSCODE:A1EB		     jz	     short AFP_RETN
DOSCODE:A1ED		     mov     di, ds
DOSCODE:A1EF		     cmp     di, ax
DOSCODE:A1F1		     jnb     short AFP_RETN
DOSCODE:A1F3		     jmp     short arena_free_process_start
DOSCODE:A1F3 arena_free_process	endp
DOSCODE:A1F3
DOSCODE:A1F5 ; ---------------------------------------------------------------------------
DOSCODE:A1F5
DOSCODE:A1F5 arena_next:			     ; ...
DOSCODE:A1F5		     mov     ax, ds
DOSCODE:A1F7		     add     ax, ds:3	     ; [ARENA.SIZE]
DOSCODE:A1FB		     inc     ax
DOSCODE:A1FC
DOSCODE:A1FC ; =============== S U B R O U T I N E =======================================
DOSCODE:A1FC
DOSCODE:A1FC
DOSCODE:A1FC check_signature proc near		     ; ...
DOSCODE:A1FC		     mov     es, ax
DOSCODE:A1FE		     cmp     byte ptr es:[di], 4Dh ; 'M' ; arena_signature_normal
DOSCODE:A202		     jz	     short AFP_RETN
DOSCODE:A204		     cmp     byte ptr es:[di], 5Ah ; 'Z' ; arena_signature_end
DOSCODE:A208		     jz	     short AFP_RETN
DOSCODE:A20A		     stc
DOSCODE:A20B
DOSCODE:A20B AFP_RETN:				     ; ...
DOSCODE:A20B		     retn		     ; COALESCE_RETN
DOSCODE:A20B check_signature endp
DOSCODE:A20B
DOSCODE:A20C
DOSCODE:A20C ; =============== S U B R O U T I N E =======================================
DOSCODE:A20C
DOSCODE:A20C
DOSCODE:A20C Coalesce	     proc near		     ; ...
DOSCODE:A20C		     cmp     byte ptr [di], 5Ah	; 'Z' ; arena_signature_end
DOSCODE:A20F		     jz	     short AFP_RETN  ; COALESCE_RETN
DOSCODE:A211		     call    arena_next
DOSCODE:A214		     jb	     short AFP_RETN  ; COALESCE_RETN
DOSCODE:A216		     cmp     es:1, di	     ; [ES:ARENA.OWNER]
DOSCODE:A21B		     jnz     short AFP_RETN  ; COALESCE_RETN
DOSCODE:A21D		     mov     cx, es:3	     ; [ES:ARENA.SIZE]
DOSCODE:A222		     inc     cx
DOSCODE:A223		     add     ds:3, cx	     ; [ARENA.SIZE]
DOSCODE:A227		     mov     cl, es:[di]
DOSCODE:A22A		     mov     [di], cl
DOSCODE:A22C		     jmp     short Coalesce
DOSCODE:A22C Coalesce	     endp
DOSCODE:A22C
DOSCODE:A22E ; ---------------------------------------------------------------------------
DOSCODE:A22E
DOSCODE:A22E $ALLOC:				     ; ...
DOSCODE:A22E		     call    ECritDisk	     ; call ECritMEM
DOSCODE:A231		     mov     ax, ss:arena_head
DOSCODE:A235		     mov     ss:START_ARENA, ax
DOSCODE:A239		     test    ss:AllocMethod, 0C0h ; HIGH_FIRST+HIGH_ONLY
DOSCODE:A23F		     jz	     short norm_alloc
DOSCODE:A241		     test    ss:UMBFLAG, 1   ; LINKSTATE
DOSCODE:A247		     jz	     short norm_alloc
DOSCODE:A249		     mov     ax, ss:UMB_HEAD
DOSCODE:A24D		     mov     ss:START_ARENA, ax
DOSCODE:A251
DOSCODE:A251 norm_alloc:			     ; ...
DOSCODE:A251		     xor     ax, ax
DOSCODE:A253		     mov     di, ax
DOSCODE:A255		     mov     ss:FirstArena, ax
DOSCODE:A259		     mov     ss:BestArena, ax
DOSCODE:A25D		     mov     ss:LastArena, ax
DOSCODE:A261		     push    ax
DOSCODE:A262
DOSCODE:A262 start_scan:			     ; ...
DOSCODE:A262		     mov     ax, ss:START_ARENA
DOSCODE:A266		     call    check_signature
DOSCODE:A269		     jb	     short alloc_err
DOSCODE:A26B
DOSCODE:A26B alloc_scan:			     ; ...
DOSCODE:A26B		     push    es
DOSCODE:A26C		     pop     ds
DOSCODE:A26D		     cmp     ds:1, di	     ; [ARENA.OWNER]
DOSCODE:A271		     jz	     short alloc_free
DOSCODE:A273
DOSCODE:A273 alloc_next:			     ; ...
DOSCODE:A273		     test    ss:UMBFLAG, 1   ; LINKSTATE
DOSCODE:A279		     jz	     short norm_strat
DOSCODE:A27B		     test    ss:AllocMethod, 80h ; HIGH_FIRST
DOSCODE:A281		     jz	     short norm_strat
DOSCODE:A283		     mov     ax, ss:START_ARENA
DOSCODE:A287		     cmp     ax, ss:arena_head
DOSCODE:A28C		     jnz     short norm_strat
DOSCODE:A28E		     mov     ax, ds
DOSCODE:A290		     cmp     ax, ss:UMB_HEAD
DOSCODE:A295		     jmp     short alloc_chk_end
DOSCODE:A297 ; ---------------------------------------------------------------------------
DOSCODE:A297
DOSCODE:A297 norm_strat:			     ; ...
DOSCODE:A297		     cmp     byte ptr [di], 5Ah	; 'Z' ; arena_signature_end
DOSCODE:A29A
DOSCODE:A29A alloc_chk_end:			     ; ...
DOSCODE:A29A		     jz	     short alloc_end
DOSCODE:A29C		     call    arena_next
DOSCODE:A29F		     jnb     short alloc_scan
DOSCODE:A2A1
DOSCODE:A2A1 alloc_err:				     ; ...
DOSCODE:A2A1		     pop     ax
DOSCODE:A2A2 ; START OF	FUNCTION CHUNK FOR $SETBLOCK
DOSCODE:A2A2
DOSCODE:A2A2 alloc_trashed:			     ; ...
DOSCODE:A2A2		     call    LCritDisk	     ; call LCritMEM
DOSCODE:A2A5		     mov     al, 7	     ; error_arena_trashed
DOSCODE:A2A7
DOSCODE:A2A7 alloc_errj:			     ; ...
DOSCODE:A2A7		     jmp     SYS_RET_ERR
DOSCODE:A2A7 ; END OF FUNCTION CHUNK FOR $SETBLOCK
DOSCODE:A2AA ; ---------------------------------------------------------------------------
DOSCODE:A2AA
DOSCODE:A2AA alloc_end:				     ; ...
DOSCODE:A2AA		     cmp     ss:FirstArena, 0
DOSCODE:A2B0		     jz	     short alloc_chk
DOSCODE:A2B2		     jmp     alloc_do_split
DOSCODE:A2B5 ; ---------------------------------------------------------------------------
DOSCODE:A2B5
DOSCODE:A2B5 alloc_chk:				     ; ...
DOSCODE:A2B5		     mov     ax, ss:arena_head
DOSCODE:A2B9		     cmp     ax, ss:START_ARENA
DOSCODE:A2BE		     jz	     short alloc_fail
DOSCODE:A2C0		     test    ss:AllocMethod, 40h ; HIGH_ONLY
DOSCODE:A2C6		     jnz     short alloc_fail
DOSCODE:A2C8		     mov     ss:START_ARENA, ax
DOSCODE:A2CC		     jmp     short start_scan
DOSCODE:A2CE ; ---------------------------------------------------------------------------
DOSCODE:A2CE ; START OF	FUNCTION CHUNK FOR $SETBLOCK
DOSCODE:A2CE
DOSCODE:A2CE alloc_fail:			     ; ...
DOSCODE:A2CE		     call    Get_User_Stack
DOSCODE:A2D1		     pop     bx
DOSCODE:A2D2		     mov     [si+2], bx	     ; [SI+user_env.user_BX]
DOSCODE:A2D5		     call    LCritDisk	     ; call LCritMEM
DOSCODE:A2D8		     mov     al, 8	     ; error_not_enough_memory
DOSCODE:A2DA		     jmp     short alloc_errj
DOSCODE:A2DA ; END OF FUNCTION CHUNK FOR $SETBLOCK
DOSCODE:A2DC ; ---------------------------------------------------------------------------
DOSCODE:A2DC
DOSCODE:A2DC alloc_free:			     ; ...
DOSCODE:A2DC		     call    Coalesce
DOSCODE:A2DF		     jb	     short alloc_err
DOSCODE:A2E1		     mov     cx, ds:3	     ; [ARENA.SIZE]
DOSCODE:A2E5		     pop     dx
DOSCODE:A2E6		     cmp     cx, dx
DOSCODE:A2E8		     jbe     short alloc_test
DOSCODE:A2EA		     mov     dx, cx
DOSCODE:A2EC
DOSCODE:A2EC alloc_test:			     ; ...
DOSCODE:A2EC		     push    dx
DOSCODE:A2ED		     cmp     bx, cx
DOSCODE:A2EF		     ja	     short alloc_next
DOSCODE:A2F1		     cmp     ss:FirstArena, 0
DOSCODE:A2F7		     jnz     short alloc_best
DOSCODE:A2F9		     mov     ss:FirstArena, ds
DOSCODE:A2FE
DOSCODE:A2FE alloc_best:			     ; ...
DOSCODE:A2FE		     cmp     ss:BestArena, 0
DOSCODE:A304		     jz	     short alloc_make_best
DOSCODE:A306		     push    es
DOSCODE:A307		     mov     es, ss:BestArena
DOSCODE:A30C		     cmp     es:3, cx	     ; [ES:ARENA.SIZE]
DOSCODE:A311		     pop     es
DOSCODE:A312		     jbe     short alloc_last
DOSCODE:A314
DOSCODE:A314 alloc_make_best:			     ; ...
DOSCODE:A314		     mov     ss:BestArena, ds
DOSCODE:A319
DOSCODE:A319 alloc_last:			     ; ...
DOSCODE:A319		     mov     ss:LastArena, ds
DOSCODE:A31E		     jmp     alloc_next
DOSCODE:A321 ; ---------------------------------------------------------------------------
DOSCODE:A321
DOSCODE:A321 alloc_do_split_high:		     ; ...
DOSCODE:A321		     mov     ds, ss:LastArena
DOSCODE:A326		     mov     cx, ds:3	     ; [ARENA.SIZE]
DOSCODE:A32A		     sub     cx, bx
DOSCODE:A32C		     mov     dx, ds
DOSCODE:A32E		     jz	     short alloc_set_owner
DOSCODE:A330		     add     dx, cx
DOSCODE:A332		     mov     es, dx
DOSCODE:A334		     dec     cx
DOSCODE:A335		     xchg    bx, cx
DOSCODE:A337		     jmp     short alloc_set_sizes
DOSCODE:A339 ; ---------------------------------------------------------------------------
DOSCODE:A339
DOSCODE:A339 alloc_do_split:			     ; ...
DOSCODE:A339		     xor     cx, cx
DOSCODE:A33B		     mov     cl, ss:AllocMethod
DOSCODE:A340		     and     cx, 0FF3Fh	     ; STRAT_MASK
DOSCODE:A344		     cmp     cx, 1	     ; BEST_FIT
DOSCODE:A347		     ja	     short alloc_do_split_high
DOSCODE:A349		     mov     ds, ss:FirstArena
DOSCODE:A34E		     jb	     short alloc_get_size
DOSCODE:A350		     mov     ds, ss:BestArena
DOSCODE:A355 ; START OF	FUNCTION CHUNK FOR $SETBLOCK
DOSCODE:A355
DOSCODE:A355 alloc_get_size:			     ; ...
DOSCODE:A355		     mov     cx, ds:3	     ; [ARENA.SIZE]
DOSCODE:A359		     sub     cx, bx
DOSCODE:A35B		     mov     ax, ds
DOSCODE:A35D		     mov     dx, ax
DOSCODE:A35F		     jz	     short alloc_set_owner
DOSCODE:A361		     add     ax, bx
DOSCODE:A363		     inc     ax
DOSCODE:A364		     mov     es, ax
DOSCODE:A366		     dec     cx
DOSCODE:A367
DOSCODE:A367 alloc_set_sizes:			     ; ...
DOSCODE:A367		     mov     ds:3, bx	     ; [ARENA.SIZE]
DOSCODE:A36B		     mov     es:3, cx	     ; [ES:ARENA.SIZE]
DOSCODE:A370		     mov     bl, 4Dh ; 'M'   ; arena_signature_normal
DOSCODE:A372		     xchg    bl, [di]
DOSCODE:A374		     mov     es:[di], bl
DOSCODE:A377		     mov     es:1, di	     ; [ES:ARENA.OWNER]
DOSCODE:A37C
DOSCODE:A37C alloc_set_owner:			     ; ...
DOSCODE:A37C		     mov     ds, dx
DOSCODE:A37E		     mov     ax, ss:CurrentPDB
DOSCODE:A382		     mov     ds:1, ax	     ; [ARENA.OWNER]
DOSCODE:A385		     mov     ax, ds
DOSCODE:A387		     inc     ax
DOSCODE:A388		     pop     bx
DOSCODE:A389		     call    LCritDisk	     ; call LCritMEM
DOSCODE:A38C
DOSCODE:A38C alloc_ok:				     ; ...
DOSCODE:A38C		     jmp     SYS_RETURN	     ; SYS_RET_OK
DOSCODE:A38C ; END OF FUNCTION CHUNK FOR $SETBLOCK
DOSCODE:A38F
DOSCODE:A38F ; =============== S U B R O U T I N E =======================================
DOSCODE:A38F
DOSCODE:A38F
DOSCODE:A38F $SETBLOCK	     proc near		     ; ...
DOSCODE:A38F
DOSCODE:A38F ; FUNCTION	CHUNK AT DOSCODE:A2A2 SIZE 00000008 BYTES
DOSCODE:A38F ; FUNCTION	CHUNK AT DOSCODE:A2CE SIZE 0000000E BYTES
DOSCODE:A38F ; FUNCTION	CHUNK AT DOSCODE:A355 SIZE 0000003A BYTES
DOSCODE:A38F
DOSCODE:A38F		     call    ECritDisk	     ; call ECritMEM
DOSCODE:A392		     mov     di, 0	     ; ARENA.SIGNATURE
DOSCODE:A395		     mov     ax, es
DOSCODE:A397		     dec     ax
DOSCODE:A398		     call    check_signature
DOSCODE:A39B		     jnb     short setblock_grab
DOSCODE:A39D
DOSCODE:A39D setblock_bad:			     ; ...
DOSCODE:A39D		     jmp     alloc_trashed
DOSCODE:A3A0 ; ---------------------------------------------------------------------------
DOSCODE:A3A0
DOSCODE:A3A0 setblock_grab:			     ; ...
DOSCODE:A3A0		     mov     ds, ax
DOSCODE:A3A2		     call    Coalesce
DOSCODE:A3A5		     jb	     short setblock_bad
DOSCODE:A3A7		     mov     cx, ds:3	     ; [ARENA.SIZE]
DOSCODE:A3AB		     push    cx
DOSCODE:A3AC		     cmp     bx, cx
DOSCODE:A3AE		     jbe     short alloc_get_size
DOSCODE:A3B0		     jmp     alloc_fail
DOSCODE:A3B0 $SETBLOCK	     endp
DOSCODE:A3B0
DOSCODE:A3B3
DOSCODE:A3B3 ; =============== S U B R O U T I N E =======================================
DOSCODE:A3B3
DOSCODE:A3B3
DOSCODE:A3B3 $DEALLOC	     proc near		     ; ...
DOSCODE:A3B3		     call    ECritDisk	     ; call ECritMEM
DOSCODE:A3B6		     test    ss:DOS_FLAG, 4  ; EXECA20OFF
DOSCODE:A3BC		     jz	     short deallocate
DOSCODE:A3BE		     cmp     ss:A20OFF_COUNT, 0
DOSCODE:A3C4		     jnz     short deallocate
DOSCODE:A3C6		     mov     ss:A20OFF_COUNT, 1
DOSCODE:A3CC
DOSCODE:A3CC deallocate:			     ; ...
DOSCODE:A3CC		     mov     di, 0	     ; ARENA.SIGNATURE
DOSCODE:A3CF		     mov     ax, es
DOSCODE:A3D1		     dec     ax
DOSCODE:A3D2		     call    check_signature
DOSCODE:A3D5		     jb	     short dealloc_err
DOSCODE:A3D7		     mov     es:1, di	     ; [ES:ARENA.OWNER]
DOSCODE:A3DC		     call    LCritDisk	     ; call LCritMEM
DOSCODE:A3DF
DOSCODE:A3DF dealloc_ok:			     ; ...
DOSCODE:A3DF		     jmp     short alloc_ok
DOSCODE:A3E1 ; ---------------------------------------------------------------------------
DOSCODE:A3E1
DOSCODE:A3E1 dealloc_err:			     ; ...
DOSCODE:A3E1		     call    LCritDisk	     ; call LCritMEM
DOSCODE:A3E4		     mov     al, 9	     ; error_invalid_block
DOSCODE:A3E6
DOSCODE:A3E6 dealloc_errj:			     ; ...
DOSCODE:A3E6		     jmp     SYS_RET_ERR
DOSCODE:A3E6 $DEALLOC	     endp
DOSCODE:A3E6
DOSCODE:A3E9 ; ---------------------------------------------------------------------------
DOSCODE:A3E9
DOSCODE:A3E9 $ALLOCOPER:			     ; ...
DOSCODE:A3E9		     or	     al, al
DOSCODE:A3EB		     jz	     short AllocGetStrat
DOSCODE:A3ED		     cmp     al, 1
DOSCODE:A3EF		     jz	     short AllocSetStrat
DOSCODE:A3F1		     cmp     al, 2
DOSCODE:A3F3		     jz	     short AllocGetLink
DOSCODE:A3F5		     cmp     al, 3
DOSCODE:A3F7		     jz	     short AllocSetLink
DOSCODE:A3F9
DOSCODE:A3F9 AllocOperError:			     ; ...
DOSCODE:A3F9		     mov     ss:EXTERR_LOCUS, 5	; errLOC_Mem
DOSCODE:A3FF		     mov     al, 1	     ; error_invalid_function
DOSCODE:A401
DOSCODE:A401 AllocOperErrj:			     ; ...
DOSCODE:A401		     jmp     short dealloc_errj
DOSCODE:A403 ; ---------------------------------------------------------------------------
DOSCODE:A403
DOSCODE:A403 AllocArenaError:			     ; ...
DOSCODE:A403		     mov     ss:EXTERR_LOCUS, 5	; errLOC_Mem
DOSCODE:A409		     mov     al, 7	     ; error_arena_trashed
DOSCODE:A40B		     jmp     short AllocOperErrj
DOSCODE:A40D ; ---------------------------------------------------------------------------
DOSCODE:A40D
DOSCODE:A40D AllocGetStrat:			     ; ...
DOSCODE:A40D		     mov     al, ss:AllocMethod
DOSCODE:A411		     xor     ah, ah
DOSCODE:A413
DOSCODE:A413 AllocOperOk:			     ; ...
DOSCODE:A413		     jmp     short dealloc_ok
DOSCODE:A415 ; ---------------------------------------------------------------------------
DOSCODE:A415
DOSCODE:A415 AllocSetStrat:			     ; ...
DOSCODE:A415		     push    bx
DOSCODE:A416		     and     bx, 0FF3Fh
DOSCODE:A41A		     cmp     bx, 2
DOSCODE:A41D		     pop     bx
DOSCODE:A41E		     ja	     short AllocOperError
DOSCODE:A420		     mov     ss:AllocMethod, bl
DOSCODE:A425
DOSCODE:A425 AllocOperOkj:			     ; ...
DOSCODE:A425		     jmp     short AllocOperOk
DOSCODE:A427 ; ---------------------------------------------------------------------------
DOSCODE:A427
DOSCODE:A427 AllocGetLink:			     ; ...
DOSCODE:A427		     mov     al, ss:UMBFLAG
DOSCODE:A42B		     and     al, 1	     ; LINKSTATE
DOSCODE:A42D
DOSCODE:A42D AllocOperOkj2:			     ; ...
DOSCODE:A42D		     jmp     short AllocOperOkj
DOSCODE:A42F ; ---------------------------------------------------------------------------
DOSCODE:A42F
DOSCODE:A42F AllocSetLink:			     ; ...
DOSCODE:A42F		     mov     cx, ss:UMB_HEAD
DOSCODE:A434		     cmp     cx, 0FFFFh
DOSCODE:A437		     jz	     short AllocOperError
DOSCODE:A439		     cmp     bx, 1
DOSCODE:A43C		     jb	     short UnlinkUmbs
DOSCODE:A43E		     jz	     short LinkUmbs
DOSCODE:A440		     jmp     short AllocOperError
DOSCODE:A442 ; ---------------------------------------------------------------------------
DOSCODE:A442
DOSCODE:A442 UnlinkUmbs:			     ; ...
DOSCODE:A442		     test    ss:UMBFLAG, 1   ; LINKSTATE
DOSCODE:A448		     jz	     short unlinked
DOSCODE:A44A		     call    GetLastArena
DOSCODE:A44D		     jb	     short AllocArenaError
DOSCODE:A44F		     mov     byte ptr ds:0, 5Ah	; 'Z' ; arena_signature_end
DOSCODE:A454		     and     ss:UMBFLAG, 0FEh ;	~LINKSTATE
DOSCODE:A45A
DOSCODE:A45A unlinked:				     ; ...
DOSCODE:A45A		     jmp     short AllocOperOkj2
DOSCODE:A45C ; ---------------------------------------------------------------------------
DOSCODE:A45C
DOSCODE:A45C LinkUmbs:				     ; ...
DOSCODE:A45C		     test    ss:UMBFLAG, 1   ; LINKSTATE
DOSCODE:A462		     jnz     short linked
DOSCODE:A464		     call    GetLastArena
DOSCODE:A467		     jb	     short AllocArenaError
DOSCODE:A469		     mov     byte ptr ds:0, 4Dh	; 'M' ; arena_signature_normal
DOSCODE:A46E		     or	     ss:UMBFLAG, 1   ; LINKSTATE
DOSCODE:A474
DOSCODE:A474 linked:				     ; ...
DOSCODE:A474		     jmp     short unlinked
DOSCODE:A476
DOSCODE:A476 ; =============== S U B R O U T I N E =======================================
DOSCODE:A476
DOSCODE:A476
DOSCODE:A476 GetLastArena    proc near		     ; ...
DOSCODE:A476		     push    ax
DOSCODE:A477		     mov     ax, ss:arena_head
DOSCODE:A47B		     mov     es, ax
DOSCODE:A47D		     xor     di, di
DOSCODE:A47F		     cmp     byte ptr es:[di], 5Ah ; 'Z' ; arena_signature_end
DOSCODE:A483		     jz	     short GLA_done
DOSCODE:A485
DOSCODE:A485 GLA_next:				     ; ...
DOSCODE:A485		     mov     ds, ax
DOSCODE:A487		     call    arena_next
DOSCODE:A48A		     jb	     short GLA_err
DOSCODE:A48C		     test    ss:UMBFLAG, 1   ; LINKSTATE
DOSCODE:A492		     jnz     short GLA_chkumb
DOSCODE:A494		     cmp     byte ptr es:[di], 5Ah ; 'Z'
DOSCODE:A498		     jmp     short GLA_@f
DOSCODE:A49A ; ---------------------------------------------------------------------------
DOSCODE:A49A
DOSCODE:A49A GLA_chkumb:			     ; ...
DOSCODE:A49A		     cmp     ax, cx
DOSCODE:A49C
DOSCODE:A49C GLA_@f:				     ; ...
DOSCODE:A49C		     jnz     short GLA_next
DOSCODE:A49E
DOSCODE:A49E GLA_done:				     ; ...
DOSCODE:A49E		     test    ss:UMBFLAG, 1
DOSCODE:A4A4		     jnz     short GLA_ret
DOSCODE:A4A6		     mov     ds, ax
DOSCODE:A4A8		     call    arena_next
DOSCODE:A4AB		     jb	     short GLA_err
DOSCODE:A4AD		     cmp     ax, cx
DOSCODE:A4AF		     jnz     short GLA_err
DOSCODE:A4B1
DOSCODE:A4B1 GLA_ret:				     ; ...
DOSCODE:A4B1		     clc
DOSCODE:A4B2		     pop     ax
DOSCODE:A4B3		     retn
DOSCODE:A4B4 ; ---------------------------------------------------------------------------
DOSCODE:A4B4
DOSCODE:A4B4 GLA_err:				     ; ...
DOSCODE:A4B4		     stc
DOSCODE:A4B5		     pop     ax
DOSCODE:A4B6		     retn
DOSCODE:A4B6 GetLastArena    endp
DOSCODE:A4B6
DOSCODE:A4B6 ; ---------------------------------------------------------------------------
DOSCODE:A4B7 SERVERTAB	     dw	offset SERVER_DISP   ; ...
DOSCODE:A4B7					     ; SRVC001S
DOSCODE:A4B9 SERVERLEAVE     dw	offset SERVERRETURN  ; ...
DOSCODE:A4BB SERVER_DISP     db	11		     ; ...
DOSCODE:A4BB					     ; (SERVER_DISP_END-SERVER_DISP-1)/2
DOSCODE:A4BB					     ; ; = 11
DOSCODE:A4BC		     dw	offset SRV_CALL	     ; 0
DOSCODE:A4BE		     dw	offset COMMIT_ALL    ; 1
DOSCODE:A4C0		     dw	offset CLOSE_NAME    ; 2
DOSCODE:A4C2		     dw	offset CLOSE_UID     ; 3
DOSCODE:A4C4		     dw	offset CLOSE_UID_PID ; 4
DOSCODE:A4C6		     dw	offset GET_LIST	     ; 5
DOSCODE:A4C8		     dw	offset GET_DOS_DATA  ; 6
DOSCODE:A4CA		     dw	offset SPOOL_OPER    ; 7
DOSCODE:A4CC		     dw	offset SPOOL_OPER    ; 8
DOSCODE:A4CE		     dw	offset SPOOL_OPER    ; 9
DOSCODE:A4D0		     dw	offset _$SetExtendedError ; 10
DOSCODE:A4D2 ; ---------------------------------------------------------------------------
DOSCODE:A4D2
DOSCODE:A4D2 $ServerCall:			     ; ...
DOSCODE:A4D2		     cmp     al, 7
DOSCODE:A4D4		     jb	     short SET_STUFF
DOSCODE:A4D6		     cmp     al, 9
DOSCODE:A4D8		     jbe     short NO_SET_ID
DOSCODE:A4DA
DOSCODE:A4DA SET_STUFF:				     ; ...
DOSCODE:A4DA		     mov     si, dx
DOSCODE:A4DC		     mov     bx, [si+12h]    ; [SI+DPL.UID]
DOSCODE:A4DF		     test    ss:IsWin386, 1
DOSCODE:A4E5		     jnz     short skip_win386
DOSCODE:A4E7		     mov     ss:USER_ID, bx
DOSCODE:A4EC
DOSCODE:A4EC skip_win386:			     ; ...
DOSCODE:A4EC		     mov     bx, [si+14h]    ; [SI+DPL.PID]
DOSCODE:A4EF		     mov     ss:PROC_ID, bx
DOSCODE:A4F4
DOSCODE:A4F4 NO_SET_ID:				     ; ...
DOSCODE:A4F4		     push    cs:SERVERLEAVE
DOSCODE:A4F9		     push    cs:SERVERTAB
DOSCODE:A4FE		     push    ax
DOSCODE:A4FF		     call    TableDispatch
DOSCODE:A502		     mov     ss:EXTERR_LOCUS, 1	; errLOC_Unk
DOSCODE:A508		     mov     al, 1	     ; error_invalid_function
DOSCODE:A50A
DOSCODE:A50A servercall_error:			     ; ...
DOSCODE:A50A		     jmp     SYS_RET_ERR
DOSCODE:A50D ; ---------------------------------------------------------------------------
DOSCODE:A50D
DOSCODE:A50D SERVERRETURN:			     ; ...
DOSCODE:A50D		     retn
DOSCODE:A50E ; ---------------------------------------------------------------------------
DOSCODE:A50E
DOSCODE:A50E COMMIT_ALL:			     ; ...
DOSCODE:A50E		     xor     bx, bx
DOSCODE:A510		     push    ss
DOSCODE:A511		     pop     ds
DOSCODE:A512		     call    ECritDisk	     ; call ECritSFT
DOSCODE:A515
DOSCODE:A515 CommitLoop:			     ; ...
DOSCODE:A515		     push    bx
DOSCODE:A516		     call    SFFromSFN
DOSCODE:A519		     jb	     short CommitDone
DOSCODE:A51B		     cmp     word ptr es:[di], 0 ; [ES:DI+SF_ENTRY.sf_Ref_Count]
DOSCODE:A51F		     jz	     short CommitNext
DOSCODE:A521		     cmp     word ptr es:[di], 0FFFFh ;	[ES:DI+SF_ENTRY.sf_Ref_Count],
DOSCODE:A521					     ; sf_busy
DOSCODE:A525		     jz	     short CommitNext
DOSCODE:A527		     test    word ptr es:[di+5], 8000h ; [ES:DI+SF_ENTRY.sf_flags],
DOSCODE:A527					     ; sf_isnet
DOSCODE:A52D		     jnz     short CommitNext
DOSCODE:A52F		     mov     word ptr ds:THISSFT, di
DOSCODE:A533		     mov     word ptr ds:THISSFT+2, es
DOSCODE:A537		     call    DOS_COMMIT
DOSCODE:A53A
DOSCODE:A53A CommitNext:			     ; ...
DOSCODE:A53A		     pop     bx
DOSCODE:A53B		     inc     bx
DOSCODE:A53C		     jmp     short CommitLoop
DOSCODE:A53E ; ---------------------------------------------------------------------------
DOSCODE:A53E
DOSCODE:A53E CommitDone:			     ; ...
DOSCODE:A53E		     call    LCritDisk	     ; call LCritSFT
DOSCODE:A541		     pop     bx
DOSCODE:A542
DOSCODE:A542 Commit_Ok:				     ; ...
DOSCODE:A542		     jmp     SYS_RETURN	     ; SYS_RET_OK
DOSCODE:A545 ; ---------------------------------------------------------------------------
DOSCODE:A545
DOSCODE:A545 CLOSE_NAME:			     ; ...
DOSCODE:A545		     call    dword ptr ss:MFTcloN ; Call far [SS:JShare+(5*4)] ; 5 = MFTcloN
DOSCODE:A54A
DOSCODE:A54A CheckReturns:			     ; ...
DOSCODE:A54A		     jb	     short func_err
DOSCODE:A54C
DOSCODE:A54C Commit_Okj:			     ; ...
DOSCODE:A54C		     jmp     short Commit_Ok
DOSCODE:A54E ; ---------------------------------------------------------------------------
DOSCODE:A54E
DOSCODE:A54E func_err:				     ; ...
DOSCODE:A54E		     jmp     short servercall_error
DOSCODE:A550 ; ---------------------------------------------------------------------------
DOSCODE:A550
DOSCODE:A550 CLOSE_UID:				     ; ...
DOSCODE:A550		     call    ss:MFTclU	     ; Call far	[SS:JShare+(3*4)] ; 3 =	MTFTclu
DOSCODE:A555		     jmp     short CheckReturns
DOSCODE:A557 ; ---------------------------------------------------------------------------
DOSCODE:A557
DOSCODE:A557 CLOSE_UID_PID:			     ; ...
DOSCODE:A557		     call    dword ptr ss:MFTCloseP
DOSCODE:A55C		     jmp     short CheckReturns
DOSCODE:A55E ; ---------------------------------------------------------------------------
DOSCODE:A55E
DOSCODE:A55E GET_LIST:				     ; ...
DOSCODE:A55E		     call    ss:MFT_get	     ; Call far	[SS:JShare+(9*4)] ; 9 =	MFT_get
DOSCODE:A563		     jb	     short func_err
DOSCODE:A565		     call    Get_User_Stack
DOSCODE:A568		     mov     [si+2], bx	     ; [SI+user_env.user_BX]
DOSCODE:A56B		     mov     [si+10], di     ; [SI+user_env.user_DI]
DOSCODE:A56E		     mov     word ptr [si+16], es ; [SI+user_env.user_ES]
DOSCODE:A571
DOSCODE:A571 SetCXOK:				     ; ...
DOSCODE:A571		     mov     [si+4], cx	     ; [SI+user_env.user_CX]
DOSCODE:A574
DOSCODE:A574 Commit_Okj2:			     ; ...
DOSCODE:A574		     jmp     short Commit_Okj
DOSCODE:A576 ; ---------------------------------------------------------------------------
DOSCODE:A576
DOSCODE:A576 SRV_CALL:				     ; ...
DOSCODE:A576		     pop     ax
DOSCODE:A577		     push    ds
DOSCODE:A578		     push    si
DOSCODE:A579		     call    Get_User_Stack
DOSCODE:A57C		     pop     di
DOSCODE:A57D		     pop     es
DOSCODE:A57E		     call    XCHGP
DOSCODE:A581		     push    si
DOSCODE:A582		     mov     cx, 6
DOSCODE:A585		     rep movsw
DOSCODE:A587		     inc     di
DOSCODE:A588		     inc     di
DOSCODE:A589		     movsw
DOSCODE:A58A		     movsw
DOSCODE:A58B		     pop     si
DOSCODE:A58C		     mov     ax, [si]	     ; [SI+DPL.AX]
DOSCODE:A58E		     mov     bx, [si+2]	     ; [SI+DPL.BX]
DOSCODE:A591		     mov     cx, [si+4]	     ; [SI+DPL.CX]
DOSCODE:A594		     mov     dx, [si+6]	     ; [SI+DPL.DX]
DOSCODE:A597		     mov     di, [si+10]     ; [SI+DPL.DI]
DOSCODE:A59A		     mov     es, word ptr [si+14] ; [SI+DPL.ES]
DOSCODE:A59D		     push    word ptr [si+8] ; [SI+DPL.SI]
DOSCODE:A5A0		     mov     ds, word ptr [si+12] ; [SI+DPL.DS]
DOSCODE:A5A3		     pop     si
DOSCODE:A5A4		     mov     ss:SAVEDS,	ds
DOSCODE:A5A9		     mov     ss:SAVEBX,	bx
DOSCODE:A5AE		     mov     ss:FSHARING, 0FFh ; -1
DOSCODE:A5B4		     jmp     REDISP
DOSCODE:A5B7 ; ---------------------------------------------------------------------------
DOSCODE:A5B7
DOSCODE:A5B7 GET_DOS_DATA:			     ; ...
DOSCODE:A5B7		     push    ss
DOSCODE:A5B8		     pop     es
DOSCODE:A5B9		     mov     di, offset	ERRORMODE ; SWAP_START
DOSCODE:A5BC		     mov     cx, offset	SWAP_END
DOSCODE:A5BF		     mov     dx, offset	USER_IN_AX ; SWAP_ALWAYS
DOSCODE:A5C2		     sub     cx, di
DOSCODE:A5C4		     sub     dx, di
DOSCODE:A5C6		     shr     cx, 1
DOSCODE:A5C8		     adc     cx, 0
DOSCODE:A5CB		     shl     cx, 1
DOSCODE:A5CD		     call    Get_User_Stack
DOSCODE:A5D0		     mov     word ptr [si+14], es ; [SI+user_env.user_DS]
DOSCODE:A5D3		     mov     [si+8], di	     ; [SI+user_env.user_SI]
DOSCODE:A5D6		     mov     [si+6], dx	     ; [SI+user_env.user_DX]
DOSCODE:A5D9		     jmp     short SetCXOK
DOSCODE:A5DB ; ---------------------------------------------------------------------------
DOSCODE:A5DB
DOSCODE:A5DB SPOOL_OPER:			     ; ...
DOSCODE:A5DB		     push    ax
DOSCODE:A5DC		     mov     ax, 1125h
DOSCODE:A5DF		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	REDIRECTED PRINTER MODE
DOSCODE:A5DF					     ; STACK: WORD subfunction
DOSCODE:A5DF					     ; Return: CF set on error,	AX = error code
DOSCODE:A5DF					     ; STACK unchanged
DOSCODE:A5E1		     pop     bx
DOSCODE:A5E2		     jb	     short func_err2
DOSCODE:A5E4		     jmp     short Commit_Okj2
DOSCODE:A5E6 ; ---------------------------------------------------------------------------
DOSCODE:A5E6
DOSCODE:A5E6 func_err2:				     ; ...
DOSCODE:A5E6		     jmp     SYS_RET_ERR
DOSCODE:A5E9 ; ---------------------------------------------------------------------------
DOSCODE:A5E9
DOSCODE:A5E9 _$SetExtendedError:		     ; ...
DOSCODE:A5E9		     mov     ax, [si]	     ; [SI+DPL.AX]
DOSCODE:A5EB		     mov     ss:EXTERR,	ax
DOSCODE:A5EF		     mov     ax, [si+10]     ; [SI+DPL.DI]
DOSCODE:A5F2		     mov     word ptr ss:EXTERRPT, ax
DOSCODE:A5F6		     mov     ax, [si+14]     ; [SI+DPL.ES]
DOSCODE:A5F9		     mov     word ptr ss:EXTERRPT+2, ax
DOSCODE:A5FD		     mov     ax, [si+2]	     ; [SI+DPL.BX]
DOSCODE:A600		     mov     word ptr ss:EXTERR_ACTION,	ax
DOSCODE:A604		     mov     ax, [si+4]	     ; [SI+DPL.CX]
DOSCODE:A607		     mov     ss:EXTERR_LOCUS, ah
DOSCODE:A60C		     retn
DOSCODE:A60D
DOSCODE:A60D ; =============== S U B R O U T I N E =======================================
DOSCODE:A60D
DOSCODE:A60D
DOSCODE:A60D pJFNFromHandle  proc near		     ; ...
DOSCODE:A60D		     mov     es, cs:DosDSeg
DOSCODE:A612		     mov     es, es:CurrentPDB
DOSCODE:A617		     cmp     bx, es:32h	     ; [ES:PDB.JFN_Length]
DOSCODE:A61C		     jb	     short pjfn10
DOSCODE:A61E		     mov     al, 6	     ; error_invalid_handle
DOSCODE:A620
DOSCODE:A620 ReturnCarry:			     ; ...
DOSCODE:A620		     stc
DOSCODE:A621		     retn
DOSCODE:A622 ; ---------------------------------------------------------------------------
DOSCODE:A622
DOSCODE:A622 pjfn10:				     ; ...
DOSCODE:A622		     les     di, es:34h	     ; [ES:PDB.JFN_Pointer]
DOSCODE:A627		     add     di, bx
DOSCODE:A629
DOSCODE:A629 pJFNFromHandle_error:		     ; ...
DOSCODE:A629		     retn
DOSCODE:A629 pJFNFromHandle  endp
DOSCODE:A629
DOSCODE:A62A
DOSCODE:A62A ; =============== S U B R O U T I N E =======================================
DOSCODE:A62A
DOSCODE:A62A
DOSCODE:A62A SFFromHandle    proc near		     ; ...
DOSCODE:A62A		     call    pJFNFromHandle
DOSCODE:A62D		     jb	     short pJFNFromHandle_error
DOSCODE:A62F		     cmp     byte ptr es:[di], 0FFh ; -1
DOSCODE:A633		     jnz     short GetSF
DOSCODE:A635		     mov     al, 6
DOSCODE:A637		     jmp     short ReturnCarry
DOSCODE:A639 ; ---------------------------------------------------------------------------
DOSCODE:A639
DOSCODE:A639 GetSF:				     ; ...
DOSCODE:A639		     push    bx
DOSCODE:A63A		     mov     bl, es:[di]
DOSCODE:A63D		     xor     bh, bh
DOSCODE:A63F		     call    SFFromSFN
DOSCODE:A642		     pop     bx
DOSCODE:A643		     retn
DOSCODE:A643 SFFromHandle    endp
DOSCODE:A643
DOSCODE:A644
DOSCODE:A644 ; =============== S U B R O U T I N E =======================================
DOSCODE:A644
DOSCODE:A644
DOSCODE:A644 SFFromSFN	     proc near		     ; ...
DOSCODE:A644		     mov     es, cs:DosDSeg
DOSCODE:A649		     les     di, es:SFT_ADDR
DOSCODE:A64E
DOSCODE:A64E sfsfn5:				     ; ...
DOSCODE:A64E		     cmp     bx, es:[di+4]   ; [ES:DI+SFT.SFCount]
DOSCODE:A652		     jb	     short sfsfn7
DOSCODE:A654		     sub     bx, es:[di+4]
DOSCODE:A658		     les     di, es:[di]     ; [ES:DI+SFT.SFLink]
DOSCODE:A65B		     cmp     di, 0FFFFh	     ; -1
DOSCODE:A65E		     jnz     short sfsfn5
DOSCODE:A660		     stc
DOSCODE:A661		     retn
DOSCODE:A662 ; ---------------------------------------------------------------------------
DOSCODE:A662
DOSCODE:A662 sfsfn7:				     ; ...
DOSCODE:A662		     push    ax
DOSCODE:A663		     mov     ax, 59	     ; SF_ENTRY.size
DOSCODE:A666		     mul     bl
DOSCODE:A668		     add     di, ax
DOSCODE:A66A		     pop     ax
DOSCODE:A66B		     add     di, 6	     ; SFT.SFTable
DOSCODE:A66E		     retn
DOSCODE:A66E SFFromSFN	     endp
DOSCODE:A66E
DOSCODE:A66F
DOSCODE:A66F ; =============== S U B R O U T I N E =======================================
DOSCODE:A66F
DOSCODE:A66F
DOSCODE:A66F JFNFree	     proc near		     ; ...
DOSCODE:A66F		     xor     bx, bx
DOSCODE:A671
DOSCODE:A671 jfnf1:				     ; ...
DOSCODE:A671		     call    pJFNFromHandle
DOSCODE:A674		     jb	     short jfnf5
DOSCODE:A676		     cmp     byte ptr es:[di], 0FFh ; -1
DOSCODE:A67A		     jz	     short jfnfx
DOSCODE:A67C		     inc     bx
DOSCODE:A67D		     jmp     short jfnf1
DOSCODE:A67F ; ---------------------------------------------------------------------------
DOSCODE:A67F
DOSCODE:A67F jfnf5:				     ; ...
DOSCODE:A67F		     mov     al, 4	     ; error_too_many_open_files
DOSCODE:A681
DOSCODE:A681 jfnfx:				     ; ...
DOSCODE:A681		     retn
DOSCODE:A681 JFNFree	     endp
DOSCODE:A681
DOSCODE:A682
DOSCODE:A682 ; =============== S U B R O U T I N E =======================================
DOSCODE:A682
DOSCODE:A682
DOSCODE:A682 SFNFree	     proc near		     ; ...
DOSCODE:A682		     push    ax
DOSCODE:A683		     xor     bx, bx
DOSCODE:A685
DOSCODE:A685 sfnf5:				     ; ...
DOSCODE:A685		     push    bx
DOSCODE:A686		     call    SFFromSFN
DOSCODE:A689		     pop     bx
DOSCODE:A68A		     jb	     short sfnf95
DOSCODE:A68C		     cmp     word ptr es:[di], 0 ; [ES:DI+SF_ENTRY.sf_Ref_Count]
DOSCODE:A690		     jz	     short sfnf20
DOSCODE:A692		     cmp     word ptr es:[di], 0FFFFh ;	[ES:DI+SF_ENTRY.sf_ref_count],
DOSCODE:A692					     ; sf_busy
DOSCODE:A696		     jz	     short sfnf10
DOSCODE:A698
DOSCODE:A698 sfnf7:				     ; ...
DOSCODE:A698		     inc     bx
DOSCODE:A699		     jmp     short sfnf5
DOSCODE:A69B ; ---------------------------------------------------------------------------
DOSCODE:A69B
DOSCODE:A69B sfnf10:				     ; ...
DOSCODE:A69B		     mov     ax, ss:USER_ID
DOSCODE:A69F		     cmp     es:[di+2Fh], ax ; [ES:DI+SF_ENTRY.sf_UID]
DOSCODE:A6A3		     jnz     short sfnf7
DOSCODE:A6A5		     mov     ax, ss:PROC_ID
DOSCODE:A6A9		     cmp     es:[di+31h], ax ; [ES:DI+SF_ENTRY.sf_PID]
DOSCODE:A6AD		     jnz     short sfnf7
DOSCODE:A6AF
DOSCODE:A6AF sfnf20:				     ; ...
DOSCODE:A6AF		     mov     word ptr es:[di], 0FFFFh ;	sf_busy
DOSCODE:A6B4		     mov     ax, ss:USER_ID
DOSCODE:A6B8		     mov     es:[di+2Fh], ax ; [ES:DI+SF_ENTRY.sf_UID]
DOSCODE:A6BC		     mov     ax, ss:PROC_ID
DOSCODE:A6C0		     mov     es:[di+31h], ax ; [ES:DI+SF_ENTRY.sf_PID]
DOSCODE:A6C4		     pop     ax
DOSCODE:A6C5		     clc
DOSCODE:A6C6		     retn
DOSCODE:A6C7 ; ---------------------------------------------------------------------------
DOSCODE:A6C7
DOSCODE:A6C7 sfnf95:				     ; ...
DOSCODE:A6C7		     pop     ax
DOSCODE:A6C8		     mov     al, 4	     ; error_too_many_open_files
DOSCODE:A6CA		     retn
DOSCODE:A6CA SFNFree	     endp
DOSCODE:A6CA
DOSCODE:A6CB
DOSCODE:A6CB ; =============== S U B R O U T I N E =======================================
DOSCODE:A6CB
DOSCODE:A6CB
DOSCODE:A6CB $CLOSE	     proc near		     ; ...
DOSCODE:A6CB
DOSCODE:A6CB ; FUNCTION	CHUNK AT DOSCODE:43E4 SIZE 0000001C BYTES
DOSCODE:A6CB
DOSCODE:A6CB		     call    CheckOwner
DOSCODE:A6CE		     jb	     short CloseError
DOSCODE:A6D0		     push    ss
DOSCODE:A6D1		     pop     ds
DOSCODE:A6D2		     mov     word ptr ds:THISSFT, di
DOSCODE:A6D6		     mov     word ptr ds:THISSFT+2, es
DOSCODE:A6DA		     cmp     word ptr es:[di], 1 ; [ES:DI+SF_ENTRY.sf_ref_count]
DOSCODE:A6DE		     jz	     short FreeJFN
DOSCODE:A6E0		     mov     al, es:[di+2]   ; [ES:DI+SF_ENTRY.sf_mode]
DOSCODE:A6E4		     and     al, 0F0h	     ; SHARING_MASK
DOSCODE:A6E6		     cmp     al, 70h	     ; SHARING_NET_FCB
DOSCODE:A6E8		     jz	     short PostFree
DOSCODE:A6EA
DOSCODE:A6EA FreeJFN:				     ; ...
DOSCODE:A6EA		     call    pJFNFromHandle
DOSCODE:A6ED		     mov     byte ptr es:[di], 0FFh
DOSCODE:A6F1
DOSCODE:A6F1 PostFree:				     ; ...
DOSCODE:A6F1		     call    DOS_CLOSE
DOSCODE:A6F4		     jb	     short CloseError
DOSCODE:A6F6		     mov     ah, 3Eh	     ; CLOSE
DOSCODE:A6F8
DOSCODE:A6F8 CloseOk:				     ; ...
DOSCODE:A6F8		     jmp     SYS_RETURN	     ; SYS_RET_OK
DOSCODE:A6FB ; ---------------------------------------------------------------------------
DOSCODE:A6FB
DOSCODE:A6FB CloseError:			     ; ...
DOSCODE:A6FB		     jmp     SYS_RET_ERR
DOSCODE:A6FB $CLOSE	     endp
DOSCODE:A6FB
DOSCODE:A6FE ; ---------------------------------------------------------------------------
DOSCODE:A6FE
DOSCODE:A6FE $COMMIT:				     ; ...
DOSCODE:A6FE		     call    CheckOwner
DOSCODE:A701		     jb	     short CommitError
DOSCODE:A703		     push    ss
DOSCODE:A704		     pop     ds
DOSCODE:A705		     mov     word ptr ds:THISSFT, di
DOSCODE:A709		     mov     word ptr ds:THISSFT+2, es
DOSCODE:A70D		     call    DOS_COMMIT
DOSCODE:A710		     jb	     short CommitError
DOSCODE:A712		     mov     ah, 68h	     ; COMMIT
DOSCODE:A714 ; START OF	FUNCTION CHUNK FOR $READ
DOSCODE:A714
DOSCODE:A714 CommitOk:				     ; ...
DOSCODE:A714		     jmp     short CloseOk
DOSCODE:A716 ; ---------------------------------------------------------------------------
DOSCODE:A716
DOSCODE:A716 CommitError:			     ; ...
DOSCODE:A716		     jmp     short CloseError
DOSCODE:A716 ; END OF FUNCTION CHUNK FOR $READ
DOSCODE:A718 ; ---------------------------------------------------------------------------
DOSCODE:A718
DOSCODE:A718 $ExtHandle:			     ; ...
DOSCODE:A718		     xor     bp, bp
DOSCODE:A71A		     cmp     bx, 20	     ; FILPERPROC
DOSCODE:A71D		     jnb     short exth2
DOSCODE:A71F		     mov     bx, 20
DOSCODE:A722
DOSCODE:A722 exth2:				     ; ...
DOSCODE:A722		     mov     es, ss:CurrentPDB
DOSCODE:A727		     mov     cx, es:32h	     ; [ES:PDB.JFN_Length]
DOSCODE:A72C		     cmp     bx, cx
DOSCODE:A72E		     jz	     short ok_done
DOSCODE:A730		     ja	     short larger
DOSCODE:A732		     mov     bp, 1
DOSCODE:A735		     mov     ds, word ptr es:36h ; [ES:PDB.JFN_Pointer+2]
DOSCODE:A73A		     mov     si, bx
DOSCODE:A73C		     sub     cx, bx
DOSCODE:A73E
DOSCODE:A73E chck_handles:			     ; ...
DOSCODE:A73E		     cmp     byte ptr [si], 0FFh ; -1
DOSCODE:A741		     jnz     short too_many_files
DOSCODE:A743		     inc     si
DOSCODE:A744		     loop    chck_handles
DOSCODE:A746		     cmp     bx, 20	     ; FILPERPROC
DOSCODE:A749		     ja	     short larger
DOSCODE:A74B		     mov     bp, 2
DOSCODE:A74E		     mov     di, 24	     ; PDB.JFN_TABLE
DOSCODE:A751		     push    bx
DOSCODE:A752		     jmp     short movhandl
DOSCODE:A754 ; ---------------------------------------------------------------------------
DOSCODE:A754
DOSCODE:A754 larger:				     ; ...
DOSCODE:A754		     cmp     bx, 0FFFFh	     ; -1
DOSCODE:A757		     jz	     short invalid_func
DOSCODE:A759		     clc
DOSCODE:A75A		     push    bx
DOSCODE:A75B		     add     bx, 0Fh
DOSCODE:A75E		     mov     cl, 4
DOSCODE:A760		     rcr     bx, cl
DOSCODE:A762		     and     bx, 1FFFh
DOSCODE:A766		     push    bp
DOSCODE:A767		     call    $ALLOC
DOSCODE:A76A		     pop     bp
DOSCODE:A76B		     jb	     short no_memory
DOSCODE:A76D		     mov     es, ax
DOSCODE:A76F		     xor     di, di
DOSCODE:A771
DOSCODE:A771 movhandl:				     ; ...
DOSCODE:A771		     mov     ds, ss:CurrentPDB
DOSCODE:A776		     test    bp, 3
DOSCODE:A77A		     jz	     short enlarge
DOSCODE:A77C		     pop     cx
DOSCODE:A77D		     push    cx
DOSCODE:A77E		     jmp     short copy_hand
DOSCODE:A780 ; ---------------------------------------------------------------------------
DOSCODE:A780 ; START OF	FUNCTION CHUNK FOR $READ
DOSCODE:A780
DOSCODE:A780 ok_done:				     ; ...
DOSCODE:A780		     jmp     short CommitOk
DOSCODE:A780 ; END OF FUNCTION CHUNK FOR $READ
DOSCODE:A782 ; ---------------------------------------------------------------------------
DOSCODE:A782
DOSCODE:A782 too_many_files:			     ; ...
DOSCODE:A782		     mov     al, 4	     ; error_too_many_open_files
DOSCODE:A784 ; START OF	FUNCTION CHUNK FOR $READ
DOSCODE:A784
DOSCODE:A784 CommitErrorj:			     ; ...
DOSCODE:A784		     jmp     short CommitError
DOSCODE:A784 ; END OF FUNCTION CHUNK FOR $READ
DOSCODE:A786 ; ---------------------------------------------------------------------------
DOSCODE:A786
DOSCODE:A786 enlarge:				     ; ...
DOSCODE:A786		     mov     cx, ds:32h	     ; [PDB.JFN_Length]
DOSCODE:A78A
DOSCODE:A78A copy_hand:				     ; ...
DOSCODE:A78A		     mov     dx, cx
DOSCODE:A78C		     lds     si, ds:34h	     ; [PDB.JFN_Pointer]
DOSCODE:A790		     rep movsb
DOSCODE:A792		     pop     cx
DOSCODE:A793		     push    cx
DOSCODE:A794		     sub     cx, dx
DOSCODE:A796		     mov     al, 0FFh	     ; -1
DOSCODE:A798		     rep stosb
DOSCODE:A79A		     mov     ds, ss:CurrentPDB
DOSCODE:A79F		     cmp     word ptr ds:34h, 0	; [PDB.JFN_Pointer]
DOSCODE:A7A4		     jnz     short update_info
DOSCODE:A7A6		     push    bp
DOSCODE:A7A7		     push    ds
DOSCODE:A7A8		     push    es
DOSCODE:A7A9		     mov     es, word ptr ds:36h ; [PDB.JFN_Pointer+2]
DOSCODE:A7AD		     call    $DEALLOC
DOSCODE:A7B0		     pop     es
DOSCODE:A7B1		     pop     ds
DOSCODE:A7B2		     pop     bp
DOSCODE:A7B3
DOSCODE:A7B3 update_info:			     ; ...
DOSCODE:A7B3		     test    bp, 2
DOSCODE:A7B7		     jz	     short non_psp
DOSCODE:A7B9		     mov     word ptr ds:34h, 18h ; [PDB.JFN_Pointer],PDB.JFN_TABLE
DOSCODE:A7BF		     jmp     short final
DOSCODE:A7C1 ; ---------------------------------------------------------------------------
DOSCODE:A7C1
DOSCODE:A7C1 non_psp:				     ; ...
DOSCODE:A7C1		     mov     word ptr ds:34h, 0	; [PDB.JFN_Pointer]
DOSCODE:A7C7
DOSCODE:A7C7 final:				     ; ...
DOSCODE:A7C7		     mov     word ptr ds:36h, es ; [PDB.JFN_Pointer+2]
DOSCODE:A7CB		     pop     word ptr ds:32h ; [PDB.JFN_Length]
DOSCODE:A7CF ; START OF	FUNCTION CHUNK FOR $READ
DOSCODE:A7CF
DOSCODE:A7CF ok_done_j:				     ; ...
DOSCODE:A7CF		     jmp     short ok_done
DOSCODE:A7CF ; END OF FUNCTION CHUNK FOR $READ
DOSCODE:A7D1 ; ---------------------------------------------------------------------------
DOSCODE:A7D1
DOSCODE:A7D1 no_memory:				     ; ...
DOSCODE:A7D1		     pop     bx
DOSCODE:A7D2		     mov     al, 8	     ; error_not_enough_memory
DOSCODE:A7D4 ; START OF	FUNCTION CHUNK FOR $READ
DOSCODE:A7D4
DOSCODE:A7D4 CommitErrorj2:			     ; ...
DOSCODE:A7D4		     jmp     short CommitErrorj
DOSCODE:A7D4 ; END OF FUNCTION CHUNK FOR $READ
DOSCODE:A7D6 ; ---------------------------------------------------------------------------
DOSCODE:A7D6
DOSCODE:A7D6 invalid_func:			     ; ...
DOSCODE:A7D6		     mov     al, 1	     ; error_invalid_function
DOSCODE:A7D8 ; START OF	FUNCTION CHUNK FOR $READ
DOSCODE:A7D8
DOSCODE:A7D8 CommitErrorj3:			     ; ...
DOSCODE:A7D8		     jmp     short CommitErrorj2
DOSCODE:A7D8 ; END OF FUNCTION CHUNK FOR $READ
DOSCODE:A7DA
DOSCODE:A7DA ; =============== S U B R O U T I N E =======================================
DOSCODE:A7DA
DOSCODE:A7DA
DOSCODE:A7DA $READ	     proc near		     ; ...
DOSCODE:A7DA
DOSCODE:A7DA ; FUNCTION	CHUNK AT DOSCODE:A714 SIZE 00000004 BYTES
DOSCODE:A7DA ; FUNCTION	CHUNK AT DOSCODE:A780 SIZE 00000002 BYTES
DOSCODE:A7DA ; FUNCTION	CHUNK AT DOSCODE:A784 SIZE 00000002 BYTES
DOSCODE:A7DA ; FUNCTION	CHUNK AT DOSCODE:A7CF SIZE 00000002 BYTES
DOSCODE:A7DA ; FUNCTION	CHUNK AT DOSCODE:A7D4 SIZE 00000002 BYTES
DOSCODE:A7DA ; FUNCTION	CHUNK AT DOSCODE:A7D8 SIZE 00000002 BYTES
DOSCODE:A7DA
DOSCODE:A7DA		     mov     si, offset	DOS_READ
DOSCODE:A7DD
DOSCODE:A7DD ReadDo:				     ; ...
DOSCODE:A7DD		     call    pJFNFromHandle
DOSCODE:A7E0		     jb	     short ReadError
DOSCODE:A7E2		     mov     al, es:[di]
DOSCODE:A7E5		     call    CheckOwner
DOSCODE:A7E8		     jnb     short ReadSetup
DOSCODE:A7EA
DOSCODE:A7EA ReadError:				     ; ...
DOSCODE:A7EA		     jmp     short CommitErrorj3
DOSCODE:A7EC ; ---------------------------------------------------------------------------
DOSCODE:A7EC
DOSCODE:A7EC ReadSetup:				     ; ...
DOSCODE:A7EC		     mov     word ptr ss:THISSFT, di
DOSCODE:A7F1		     mov     word ptr ss:THISSFT+2, es
DOSCODE:A7F6		     test    byte ptr es:[di+3], 20h ; [ES:DI+SF_ENTRY.sf_mode+1],
DOSCODE:A7F6					     ; (INT_24_ERROR>>8)
DOSCODE:A7FB		     jz	     short needi24
DOSCODE:A7FD		     or	     ss:EXTOPEN_ON, 2 ;	EXT_OPEN_I24_OFF
DOSCODE:A803
DOSCODE:A803 needi24:				     ; ...
DOSCODE:A803		     push    word ptr ss:DMAADD
DOSCODE:A808		     push    word ptr ss:DMAADD+2
DOSCODE:A80D		     call    Align_Buffer
DOSCODE:A810		     push    ss
DOSCODE:A811		     pop     ds
DOSCODE:A812		     call    si	; DOS_READ
DOSCODE:A814		     pop     word ptr ds:DMAADD+2
DOSCODE:A818		     pop     word ptr ds:DMAADD
DOSCODE:A81C		     jnb     short READ_OK
DOSCODE:A81E		     jmp     short ReadError
DOSCODE:A820 ; ---------------------------------------------------------------------------
DOSCODE:A820
DOSCODE:A820 READ_OK:				     ; ...
DOSCODE:A820		     mov     ax, cx
DOSCODE:A822
DOSCODE:A822 Read_Okj:				     ; ...
DOSCODE:A822		     jmp     short ok_done_j
DOSCODE:A822 $READ	     endp
DOSCODE:A822
DOSCODE:A824
DOSCODE:A824 ; =============== S U B R O U T I N E =======================================
DOSCODE:A824
DOSCODE:A824
DOSCODE:A824 Align_Buffer    proc near		     ; ...
DOSCODE:A824		     mov     bx, dx
DOSCODE:A826		     push    cx
DOSCODE:A827		     mov     cl, 4
DOSCODE:A829		     shr     bx, cl
DOSCODE:A82B		     pop     cx
DOSCODE:A82C		     mov     ax, ds
DOSCODE:A82E		     add     ax, bx
DOSCODE:A830		     mov     ds, ax
DOSCODE:A832		     and     dx, 0Fh
DOSCODE:A835		     mov     word ptr ss:DMAADD, dx
DOSCODE:A83A		     mov     word ptr ss:DMAADD+2, ds
DOSCODE:A83F		     retn
DOSCODE:A83F Align_Buffer    endp
DOSCODE:A83F
DOSCODE:A840 ; ---------------------------------------------------------------------------
DOSCODE:A840
DOSCODE:A840 $WRITE:				     ; ...
DOSCODE:A840		     mov     si, offset	DOS_WRITE
DOSCODE:A843		     jmp     short ReadDo
DOSCODE:A845
DOSCODE:A845 ; =============== S U B R O U T I N E =======================================
DOSCODE:A845
DOSCODE:A845
DOSCODE:A845 $LSEEK	     proc near		     ; ...
DOSCODE:A845		     call    CheckOwner
DOSCODE:A848
DOSCODE:A848 LSeekError:			     ; ...
DOSCODE:A848		     jnb     short CHKOWN_OK
DOSCODE:A84A		     jmp     short ReadError
DOSCODE:A84C ; ---------------------------------------------------------------------------
DOSCODE:A84C
DOSCODE:A84C CHKOWN_OK:				     ; ...
DOSCODE:A84C		     cmp     al, 2
DOSCODE:A84E		     jbe     short LSeekDisp
DOSCODE:A850		     mov     ss:EXTERR_LOCUS, 1	; errLOC_Unk
DOSCODE:A856		     mov     al, 1	     ; error_invalid_function
DOSCODE:A858
DOSCODE:A858 LSeekError2:			     ; ...
DOSCODE:A858		     jmp     short ReadError
DOSCODE:A85A ; ---------------------------------------------------------------------------
DOSCODE:A85A
DOSCODE:A85A LSeekDisp:				     ; ...
DOSCODE:A85A		     cmp     al, 1
DOSCODE:A85C		     jb	     short LSeekStore
DOSCODE:A85E		     ja	     short LSeekEOF
DOSCODE:A860		     add     dx, es:[di+21]  ; [ES:DI+SF_ENTRY.sf_position]
DOSCODE:A864		     adc     cx, es:[di+23]  ; [ES:DI+SF_ENTRY.sf_position+2]
DOSCODE:A868
DOSCODE:A868 LSeekStore:			     ; ...
DOSCODE:A868		     mov     ax, cx
DOSCODE:A86A		     xchg    ax, dx
DOSCODE:A86B
DOSCODE:A86B LSeekSetpos:			     ; ...
DOSCODE:A86B		     mov     es:[di+21], ax
DOSCODE:A86F		     mov     es:[di+23], dx
DOSCODE:A873		     call    Get_User_Stack
DOSCODE:A876		     mov     [si+6], dx
DOSCODE:A879
DOSCODE:A879 LSeekOk:				     ; ...
DOSCODE:A879		     jmp     short Read_Okj
DOSCODE:A87B ; ---------------------------------------------------------------------------
DOSCODE:A87B
DOSCODE:A87B LSeekEOF:				     ; ...
DOSCODE:A87B		     test    byte ptr es:[di+6], 80h ; [ES:DI+SF_ENTRY.sf_flags+1],
DOSCODE:A87B					     ; (sf_isnet>>8)
DOSCODE:A880		     jnz     short Check_LSeek_Mode
DOSCODE:A882
DOSCODE:A882 LOCAL_LSeek:			     ; ...
DOSCODE:A882		     add     dx, es:[di+17]  ; [ES:DI+SF_ENTRY.sf_size]
DOSCODE:A886		     adc     cx, es:[di+19]  ; [ES:DI+SF_ENTRY.sf_size+2]
DOSCODE:A88A		     jmp     short LSeekStore
DOSCODE:A88C ; ---------------------------------------------------------------------------
DOSCODE:A88C
DOSCODE:A88C Check_LSeek_Mode:			     ; ...
DOSCODE:A88C		     test    byte ptr es:[di+3], 80h ; [ES:DI+SF_ENTRY.sf_mode+1],
DOSCODE:A88C					     ; (sf_isFCB>>8)
DOSCODE:A891		     jnz     short LOCAL_LSeek
DOSCODE:A893		     mov     ax, es:[di+2]   ; [ES:DI+SF_ENTRY.sf_mode]
DOSCODE:A897		     and     ax, 0F0h
DOSCODE:A89A		     cmp     ax, 40h	     ; SHARING_MASK
DOSCODE:A89D		     jz	     short NET_LSEEK
DOSCODE:A89F		     cmp     ax, 30h	     ; SHARING_DENY_READ
DOSCODE:A8A2		     jnz     short LOCAL_LSeek
DOSCODE:A8A4
DOSCODE:A8A4 NET_LSEEK:				     ; ...
DOSCODE:A8A4		     mov     ax, 1121h
DOSCODE:A8A7		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	SEEK FROM END OF REMOTE	FILE
DOSCODE:A8A7					     ; CX:DX = offset (in bytes) from end
DOSCODE:A8A7					     ; ES:DI ->	SFT, SFT DPB field -> DPB of drive with	file
DOSCODE:A8A7					     ; SS = DOS	CS
DOSCODE:A8A7					     ; Return: CF set on error
DOSCODE:A8A7					     ; CF clear	if successful, DX:AX = new file	position
DOSCODE:A8A9		     jnb     short LSeekSetpos
DOSCODE:A8AB
DOSCODE:A8AB LSeekError3:			     ; ...
DOSCODE:A8AB		     jmp     short LSeekError2
DOSCODE:A8AB $LSEEK	     endp
DOSCODE:A8AB
DOSCODE:A8AD ; ---------------------------------------------------------------------------
DOSCODE:A8AD
DOSCODE:A8AD $FILE_TIMES:			     ; ...
DOSCODE:A8AD		     cmp     al, 2
DOSCODE:A8AF		     jnb     short inval_func
DOSCODE:A8B1		     call    CheckOwner
DOSCODE:A8B4		     jb	     short LSeekError
DOSCODE:A8B6		     or	     al, al
DOSCODE:A8B8		     jnz     short ft_set_time
DOSCODE:A8BA		     cli
DOSCODE:A8BB		     mov     cx, es:[di+13]  ; [es:di+SF_ENTRY.sf_time]
DOSCODE:A8BF		     mov     dx, es:[di+15]  ; [es:di+SF_ENTRY.sf_date]
DOSCODE:A8C3		     sti
DOSCODE:A8C4		     call    Get_User_Stack
DOSCODE:A8C7		     mov     [si+4], cx
DOSCODE:A8CA		     mov     [si+6], dx
DOSCODE:A8CD		     jmp     short ok_ret
DOSCODE:A8CF ; ---------------------------------------------------------------------------
DOSCODE:A8CF
DOSCODE:A8CF ft_set_time:			     ; ...
DOSCODE:A8CF		     call    ECritDisk	     ; call ECritSFT
DOSCODE:A8D2		     mov     es:[di+13], cx  ; [es:di+SF_ENTRY.sf_time]
DOSCODE:A8D6		     mov     es:[di+15], dx  ; [es:di+SF_ENTRY.sf_date]
DOSCODE:A8DA		     xor     ax, ax
DOSCODE:A8DC		     call    dword ptr ss:ShSU ; call far [ss:JShare+(14*4)] ; 14 = ShSU
DOSCODE:A8E1		     and     word ptr es:[di+5], 0FFBFh	; ~devid_file_clean
DOSCODE:A8E6		     or	     word ptr es:[di+5], 4000h ; sf_close_nodate
DOSCODE:A8EC		     call    LCritDisk	     ; call ECritSFT
DOSCODE:A8EF
DOSCODE:A8EF ok_ret:				     ; ...
DOSCODE:A8EF		     jmp     short LSeekOk
DOSCODE:A8F1 ; ---------------------------------------------------------------------------
DOSCODE:A8F1
DOSCODE:A8F1 inval_func:			     ; ...
DOSCODE:A8F1		     mov     ss:EXTERR_LOCUS, 1	; errLOC_Unk
DOSCODE:A8F7		     mov     al, 1	     ; error_invalid_function
DOSCODE:A8F9
DOSCODE:A8F9 ft_error:				     ; ...
DOSCODE:A8F9		     jmp     short LSeekError3
DOSCODE:A8FB ; ---------------------------------------------------------------------------
DOSCODE:A8FB
DOSCODE:A8FB $DUP:				     ; ...
DOSCODE:A8FB		     mov     ax, bx
DOSCODE:A8FD		     call    JFNFree
DOSCODE:A900
DOSCODE:A900 DupErrorCheck:			     ; ...
DOSCODE:A900		     jb	     short DupErr
DOSCODE:A902		     push    es
DOSCODE:A903		     push    di
DOSCODE:A904		     pop     si
DOSCODE:A905		     pop     ds
DOSCODE:A906		     xchg    ax, bx
DOSCODE:A907		     call    CheckOwner
DOSCODE:A90A		     jb	     short DupErr
DOSCODE:A90C		     call    DOS_Dup_Direct
DOSCODE:A90F		     call    pJFNFromHandle
DOSCODE:A912		     mov     bl, es:[di]
DOSCODE:A915		     mov     [si], bl
DOSCODE:A917		     jmp     short ok_ret
DOSCODE:A919 ; ---------------------------------------------------------------------------
DOSCODE:A919
DOSCODE:A919 DupErr:				     ; ...
DOSCODE:A919		     jmp     short ft_error
DOSCODE:A91B ; ---------------------------------------------------------------------------
DOSCODE:A91B
DOSCODE:A91B $DUP2:				     ; ...
DOSCODE:A91B		     push    bx
DOSCODE:A91C		     push    cx
DOSCODE:A91D		     mov     bx, cx
DOSCODE:A91F		     call    $CLOSE
DOSCODE:A922		     pop     bx
DOSCODE:A923		     pop     ax
DOSCODE:A924		     call    pJFNFromHandle
DOSCODE:A927		     jmp     short DupErrorCheck
DOSCODE:A929
DOSCODE:A929 ; =============== S U B R O U T I N E =======================================
DOSCODE:A929
DOSCODE:A929
DOSCODE:A929 CheckOwner	     proc near		     ; ...
DOSCODE:A929		     call    SFFromHandle
DOSCODE:A92C		     jb	     short co_ret_label
DOSCODE:A92E		     push    ax
DOSCODE:A92F		     test    ss:IsWin386, 1
DOSCODE:A935		     jz	     short no_win386
DOSCODE:A937		     xor     ax, ax
DOSCODE:A939		     jmp     short _skip_win386
DOSCODE:A93B ; ---------------------------------------------------------------------------
DOSCODE:A93B
DOSCODE:A93B no_win386:				     ; ...
DOSCODE:A93B		     mov     ax, ss:USER_ID
DOSCODE:A93F		     cmp     ax, es:[di+2Fh] ; [es:di+SF_ENTRY.sf_UID]
DOSCODE:A943
DOSCODE:A943 _skip_win386:			     ; ...
DOSCODE:A943		     pop     ax
DOSCODE:A944		     jnz     short CheckOwner_err
DOSCODE:A946		     retn
DOSCODE:A947 ; ---------------------------------------------------------------------------
DOSCODE:A947
DOSCODE:A947 CheckOwner_err:			     ; ...
DOSCODE:A947		     mov     al, 6
DOSCODE:A949		     stc
DOSCODE:A94A
DOSCODE:A94A co_ret_label:			     ; ...
DOSCODE:A94A		     retn
DOSCODE:A94A CheckOwner	     endp
DOSCODE:A94A
DOSCODE:A94B ; ---------------------------------------------------------------------------
DOSCODE:A94B
DOSCODE:A94B $AssignOper:			     ; ...
DOSCODE:A94B		     cmp     al, 7
DOSCODE:A94D		     jnz     short chk08
DOSCODE:A94F
DOSCODE:A94F srinuse:				     ; ...
DOSCODE:A94F		     push    ax
DOSCODE:A950		     mov     al, dl
DOSCODE:A952		     call    GetCDSFromDrv
DOSCODE:A955		     pop     ax
DOSCODE:A956		     jb	     short baddrv
DOSCODE:A958		     cmp     word ptr [si+45h],	0 ; [SI+curdir.devptr]
DOSCODE:A95C		     jz	     short baddrv
DOSCODE:A95E		     cmp     al, 7
DOSCODE:A960		     jnz     short resetdrv
DOSCODE:A962		     or	     word ptr [si+43h],	4000h ;	[SI+curdir.flags],
DOSCODE:A962					     ; curdir_inuse
DOSCODE:A967		     jmp     short okdone
DOSCODE:A969 ; ---------------------------------------------------------------------------
DOSCODE:A969
DOSCODE:A969 resetdrv:				     ; ...
DOSCODE:A969		     and     word ptr [si+43h],	0BFFFh ; ~curdir_inuse
DOSCODE:A96E		     jmp     short okdone
DOSCODE:A970 ; ---------------------------------------------------------------------------
DOSCODE:A970
DOSCODE:A970 baddrv:				     ; ...
DOSCODE:A970		     mov     ax, 0Fh	     ; error_invalid_drive
DOSCODE:A973		     jmp     short ASS_ERR
DOSCODE:A975 ; ---------------------------------------------------------------------------
DOSCODE:A975
DOSCODE:A975 chk08:				     ; ...
DOSCODE:A975		     cmp     al, 8
DOSCODE:A977		     jz	     short srinuse
DOSCODE:A979		     push    ax
DOSCODE:A97A		     mov     ax, 111Eh	     ; (MultNET	SHL 8) OR 30
DOSCODE:A97D		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	DO REDIRECTION
DOSCODE:A97D					     ; SS = DOS	CS
DOSCODE:A97D					     ; STACK: WORD function to execute
DOSCODE:A97D					     ; Return: CF set on error,	AX = error code
DOSCODE:A97D					     ; STACK unchanged
DOSCODE:A97F		     pop     bx
DOSCODE:A980		     jb	     short ASS_ERR
DOSCODE:A982
DOSCODE:A982 okdone:				     ; ...
DOSCODE:A982		     jmp     SYS_RETURN	     ; SYS_RET_OK
DOSCODE:A985 ; ---------------------------------------------------------------------------
DOSCODE:A985
DOSCODE:A985 ASS_ERR:				     ; ...
DOSCODE:A985		     jmp     SYS_RET_ERR
DOSCODE:A988
DOSCODE:A988 ; =============== S U B R O U T I N E =======================================
DOSCODE:A988
DOSCODE:A988
DOSCODE:A988 FIND_DPB	     proc near		     ; ...
DOSCODE:A988		     lds     si, ss:SYSINITVARS	; [SS:DPBHEAD]
DOSCODE:A98D
DOSCODE:A98D fdpb5:				     ; ...
DOSCODE:A98D		     cmp     si, 0FFFFh	     ; -1
DOSCODE:A990		     jz	     short fdpb10
DOSCODE:A992		     cmp     al, [si]	     ; [SI+DPB.DRIVE]
DOSCODE:A994		     jz	     short ret_label15
DOSCODE:A996		     lds     si, [si+19h]    ; [SI+DPB.NEXT_DPB]
DOSCODE:A999		     jmp     short fdpb5
DOSCODE:A99B ; ---------------------------------------------------------------------------
DOSCODE:A99B
DOSCODE:A99B fdpb10:				     ; ...
DOSCODE:A99B		     stc
DOSCODE:A99C
DOSCODE:A99C ret_label15:			     ; ...
DOSCODE:A99C		     retn
DOSCODE:A99C FIND_DPB	     endp
DOSCODE:A99C
DOSCODE:A99D
DOSCODE:A99D ; =============== S U B R O U T I N E =======================================
DOSCODE:A99D
DOSCODE:A99D
DOSCODE:A99D InitCDS	     proc near		     ; ...
DOSCODE:A99D		     push    ax
DOSCODE:A99E		     les     di, ss:THISCDS
DOSCODE:A9A3		     mov     word ptr es:[di+43h], 0 ; [ES:DI+curdir.flags]
DOSCODE:A9A9		     sub     al, 40h ; '@'   ; 'A'-1
DOSCODE:A9AB		     cmp     ss:NUMIO, al
DOSCODE:A9B0		     jb	     short icdsx
DOSCODE:A9B2		     dec     ax
DOSCODE:A9B3		     push    ax
DOSCODE:A9B4		     add     al, 41h ; 'A'
DOSCODE:A9B6		     mov     ah, 3Ah ; ':'
DOSCODE:A9B8		     mov     es:[di], ax     ; [ES:DI+curdir.text]
DOSCODE:A9BB		     mov     word ptr es:[di+2], 5Ch ; '\' ; [ES:DI+curdir.text+2]
DOSCODE:A9C1		     or	     byte ptr es:[di+44h], 40h ; [ES:DI+curdir.flags+1],
DOSCODE:A9C1					     ; (curdir_inuse>>8)
DOSCODE:A9C6		     sub     ax, ax
DOSCODE:A9C8		     mov     es:[di+49h], ax ; [ES:DI+curdir.ID]
DOSCODE:A9CC		     mov     es:[di+4Bh], ax ; [ES:DI+curdir.ID+2]
DOSCODE:A9D0		     mov     al, 2
DOSCODE:A9D2		     mov     es:[di+4Fh], ax ; [ES:DI+curdir.end]
DOSCODE:A9D6		     pop     ax
DOSCODE:A9D7		     push    ds
DOSCODE:A9D8		     push    si
DOSCODE:A9D9		     call    FIND_DPB
DOSCODE:A9DC		     jb	     short icds5
DOSCODE:A9DE		     mov     es:[di+45h], si ; [ES:DI+curdir.devptr]
DOSCODE:A9E2		     mov     word ptr es:[di+47h], ds ;	[ES:DI+curdir.devptr+2]
DOSCODE:A9E6
DOSCODE:A9E6 icds5:				     ; ...
DOSCODE:A9E6		     pop     si
DOSCODE:A9E7		     pop     ds
DOSCODE:A9E8
DOSCODE:A9E8 icdsx:				     ; ...
DOSCODE:A9E8		     pop     ax
DOSCODE:A9E9
DOSCODE:A9E9 RET45:				     ; ...
DOSCODE:A9E9		     retn
DOSCODE:A9E9 InitCDS	     endp
DOSCODE:A9E9
DOSCODE:A9EA ; ---------------------------------------------------------------------------
DOSCODE:A9EA
DOSCODE:A9EA $UserOper:				     ; ...
DOSCODE:A9EA		     push    ax
DOSCODE:A9EB		     sub     al, 1
DOSCODE:A9ED		     pop     ax
DOSCODE:A9EE		     jb	     short UserGet
DOSCODE:A9F0		     jz	     short UserSet
DOSCODE:A9F2		     cmp     al, 5
DOSCODE:A9F4		     jbe     short UserPrint
DOSCODE:A9F6		     mov     ss:EXTERR_LOCUS, 1	; errLOC_Unk
DOSCODE:A9FC		     mov     al, 1	     ; error_invalid_function
DOSCODE:A9FE
DOSCODE:A9FE useroper_error:			     ; ...
DOSCODE:A9FE		     jmp     short ASS_ERR
DOSCODE:AA00 ; ---------------------------------------------------------------------------
DOSCODE:AA00
DOSCODE:AA00 UserGet:				     ; ...
DOSCODE:AA00		     push    ds
DOSCODE:AA01		     pop     es
DOSCODE:AA02		     mov     di, dx
DOSCODE:AA04		     mov     cx, ss:MYNUM
DOSCODE:AA09		     call    Get_User_Stack
DOSCODE:AA0C		     mov     [si+4], cx	     ; [SI+user_env.user_CX]
DOSCODE:AA0F		     push    ss
DOSCODE:AA10		     pop     ds
DOSCODE:AA11		     mov     si, offset	MYNAME
DOSCODE:AA14
DOSCODE:AA14 UserMove:				     ; ...
DOSCODE:AA14		     mov     cx, 15
DOSCODE:AA17		     rep movsb
DOSCODE:AA19		     xor     ax, ax
DOSCODE:AA1B		     stosb
DOSCODE:AA1C
DOSCODE:AA1C UserBye:				     ; ...
DOSCODE:AA1C		     jmp     SYS_RETURN	     ; SYS_RET_OK
DOSCODE:AA1F ; ---------------------------------------------------------------------------
DOSCODE:AA1F
DOSCODE:AA1F UserSet:				     ; ...
DOSCODE:AA1F		     mov     ss:MYNUM, cx
DOSCODE:AA24		     mov     si, dx
DOSCODE:AA26		     push    ss
DOSCODE:AA27		     pop     es
DOSCODE:AA28		     mov     di, offset	MYNAME
DOSCODE:AA2B		     inc     ss:DIFFNAM
DOSCODE:AA30		     jmp     short UserMove
DOSCODE:AA32 ; ---------------------------------------------------------------------------
DOSCODE:AA32
DOSCODE:AA32 UserPrint:				     ; ...
DOSCODE:AA32		     push    ax
DOSCODE:AA33		     mov     ax, 111Fh	     ; (MultNET	SHL 8) OR 31
DOSCODE:AA36		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	PRINTER	SETUP
DOSCODE:AA36					     ; STACK: WORD function
DOSCODE:AA36					     ; Return: CF set on error,	AX = error code
DOSCODE:AA36					     ; STACK unchanged
DOSCODE:AA38		     pop     dx
DOSCODE:AA39		     jnb     short OKPA
DOSCODE:AA3B		     jmp     short useroper_error
DOSCODE:AA3D ; ---------------------------------------------------------------------------
DOSCODE:AA3D
DOSCODE:AA3D OKPA:				     ; ...
DOSCODE:AA3D		     jmp     short UserBye
DOSCODE:AA3F
DOSCODE:AA3F ; =============== S U B R O U T I N E =======================================
DOSCODE:AA3F
DOSCODE:AA3F
DOSCODE:AA3F GetVisDrv	     proc near		     ; ...
DOSCODE:AA3F		     call    GETTHISDRV
DOSCODE:AA42		     jb	     short RET45
DOSCODE:AA44		     push    ds
DOSCODE:AA45		     push    si
DOSCODE:AA46		     lds     si, ss:THISCDS
DOSCODE:AA4B		     test    word ptr [si+43h],	2000h ;	[SI+curdir.flags],
DOSCODE:AA4B					     ; curdir_splice
DOSCODE:AA50		     pop     si
DOSCODE:AA51		     pop     ds
DOSCODE:AA52		     jz	     short RET45
DOSCODE:AA54		     mov     ss:DrvErr,	0Fh  ; error_invalid_drive
DOSCODE:AA5A		     stc
DOSCODE:AA5B		     retn
DOSCODE:AA5B GetVisDrv	     endp
DOSCODE:AA5B
DOSCODE:AA5C
DOSCODE:AA5C ; =============== S U B R O U T I N E =======================================
DOSCODE:AA5C
DOSCODE:AA5C
DOSCODE:AA5C GETTHISDRV	     proc near		     ; ...
DOSCODE:AA5C		     or	     al, al
DOSCODE:AA5E		     jnz     short GTD10
DOSCODE:AA60		     mov     al, ss:CURDRV
DOSCODE:AA64		     inc     ax
DOSCODE:AA65
DOSCODE:AA65 GTD10:				     ; ...
DOSCODE:AA65		     dec     ax
DOSCODE:AA66		     push    ds
DOSCODE:AA67		     push    si
DOSCODE:AA68		     mov     ss:EXTERR_LOCUS, 2	; errLOC_Disk
DOSCODE:AA6E		     test    ss:FSHARING, 0FFh ; -1
DOSCODE:AA74		     jz	     short GTD20
DOSCODE:AA76		     push    ax
DOSCODE:AA77		     push    es
DOSCODE:AA78		     push    di
DOSCODE:AA79		     mov     word ptr ss:THISCDS, offset DUMMYCDS
DOSCODE:AA80		     mov     word ptr ss:THISCDS+2, ss
DOSCODE:AA85		     add     al, 41h ; 'A'
DOSCODE:AA87		     call    InitCDS
DOSCODE:AA8A		     test    word ptr es:[di+43h], 4000h ; [ES:DI+curdir.flags],
DOSCODE:AA8A					     ; curdir_inuse
DOSCODE:AA90		     pop     di
DOSCODE:AA91		     pop     es
DOSCODE:AA92		     pop     ax
DOSCODE:AA93		     jz	     short GTD30
DOSCODE:AA95		     jmp     short GTDX
DOSCODE:AA97 ; ---------------------------------------------------------------------------
DOSCODE:AA97
DOSCODE:AA97 GTD20:				     ; ...
DOSCODE:AA97		     call    GetCDSFromDrv
DOSCODE:AA9A		     jb	     short GTD30
DOSCODE:AA9C		     test    word ptr [si+43h],	4000h ;	[SI+curdir.flags],
DOSCODE:AA9C					     ; curdir_inuse
DOSCODE:AAA1		     jnz     short GTDX
DOSCODE:AAA3
DOSCODE:AAA3 GTD30:				     ; ...
DOSCODE:AAA3		     mov     al, 0Fh	     ; error_invalid_drive
DOSCODE:AAA5		     mov     ss:DrvErr,	al
DOSCODE:AAA9		     mov     ss:EXTERR_LOCUS, 1	; errLOC_Unk
DOSCODE:AAAF		     stc
DOSCODE:AAB0
DOSCODE:AAB0 GTDX:				     ; ...
DOSCODE:AAB0		     pop     si
DOSCODE:AAB1		     pop     ds
DOSCODE:AAB2		     retn
DOSCODE:AAB2 GETTHISDRV	     endp
DOSCODE:AAB2
DOSCODE:AAB3
DOSCODE:AAB3 ; =============== S U B R O U T I N E =======================================
DOSCODE:AAB3
DOSCODE:AAB3
DOSCODE:AAB3 GetCDSFromDrv   proc near		     ; ...
DOSCODE:AAB3		     cmp     al, ss:CDSCOUNT
DOSCODE:AAB8		     jb	     short GetCDS
DOSCODE:AABA		     stc
DOSCODE:AABB		     retn
DOSCODE:AABC ; ---------------------------------------------------------------------------
DOSCODE:AABC
DOSCODE:AABC GetCDS:				     ; ...
DOSCODE:AABC		     push    bx
DOSCODE:AABD		     push    ax
DOSCODE:AABE		     lds     si, ss:CDSADDR
DOSCODE:AAC3		     mov     bl, 88	     ; curdir.size
DOSCODE:AAC5		     mul     bl
DOSCODE:AAC7		     add     si, ax
DOSCODE:AAC9		     mov     word ptr ss:THISCDS, si
DOSCODE:AACE		     mov     word ptr ss:THISCDS+2, ds
DOSCODE:AAD3		     pop     ax
DOSCODE:AAD4		     pop     bx
DOSCODE:AAD5		     clc
DOSCODE:AAD6		     retn
DOSCODE:AAD6 GetCDSFromDrv   endp
DOSCODE:AAD6
DOSCODE:AAD7 ; ---------------------------------------------------------------------------
DOSCODE:AAD7
DOSCODE:AAD7 TransFCB:				     ; ...
DOSCODE:AAD7		     push    bp
DOSCODE:AAD8		     mov     bp, sp
DOSCODE:AADA		     sub     sp, 16
DOSCODE:AADD		     push    ss
DOSCODE:AADE		     pop     es
DOSCODE:AADF		     push    es
DOSCODE:AAE0		     push    di
DOSCODE:AAE1		     lea     di, [bp-16]     ; FCBTmp
DOSCODE:AAE4		     mov     ss:EXTFCB,	0
DOSCODE:AAEA		     mov     ss:SATTRIB, 0
DOSCODE:AAF0		     call    GetExtended
DOSCODE:AAF3		     jz	     short GetDrive
DOSCODE:AAF5		     mov     al, [si-1]
DOSCODE:AAF8		     mov     ss:SATTRIB, al
DOSCODE:AAFC		     mov     ss:EXTFCB,	0FFh ; -1
DOSCODE:AB02
DOSCODE:AB02 GetDrive:				     ; ...
DOSCODE:AB02		     lodsb
DOSCODE:AB03		     call    GETTHISDRV
DOSCODE:AB06		     jb	     short BadPack
DOSCODE:AB08		     call    TextFromDrive
DOSCODE:AB0B		     mov     cx, 11
DOSCODE:AB0E		     push    si
DOSCODE:AB0F
DOSCODE:AB0F FCBScan:				     ; ...
DOSCODE:AB0F		     lodsb
DOSCODE:AB10		     call    GetCharType
DOSCODE:AB13		     test    al, 8	     ; FFCB
DOSCODE:AB15		     jz	     short BadPack
DOSCODE:AB17		     loop    FCBScan
DOSCODE:AB19		     pop     si
DOSCODE:AB1A		     mov     bx, di
DOSCODE:AB1C		     call    PackName
DOSCODE:AB1F		     pop     di
DOSCODE:AB20		     pop     es
DOSCODE:AB21		     push    ss
DOSCODE:AB22		     pop     ds
DOSCODE:AB23		     lea     si, [bp-16]     ; FCBTmp
DOSCODE:AB26		     cmp     byte ptr [bx], 0
DOSCODE:AB29		     jz	     short BadPack
DOSCODE:AB2B		     push    bp
DOSCODE:AB2C		     call    TransPathSet
DOSCODE:AB2F		     pop     bp
DOSCODE:AB30		     jnb     short FCBRet
DOSCODE:AB32
DOSCODE:AB32 BadPack:				     ; ...
DOSCODE:AB32		     stc
DOSCODE:AB33		     mov     al, 3	     ; error_path_not_found
DOSCODE:AB35
DOSCODE:AB35 FCBRet:				     ; ...
DOSCODE:AB35		     mov     sp, bp
DOSCODE:AB37		     pop     bp
DOSCODE:AB38
DOSCODE:AB38 TransPath_retn:			     ; ...
DOSCODE:AB38		     retn
DOSCODE:AB39
DOSCODE:AB39 ; =============== S U B R O U T I N E =======================================
DOSCODE:AB39
DOSCODE:AB39
DOSCODE:AB39 TransPath	     proc near		     ; ...
DOSCODE:AB39		     xor     al, al
DOSCODE:AB3B		     jmp     short SetSplice
DOSCODE:AB3D ; ---------------------------------------------------------------------------
DOSCODE:AB3D
DOSCODE:AB3D TransPathSet:			     ; ...
DOSCODE:AB3D		     mov     al, 0FFh	     ; -1
DOSCODE:AB3F
DOSCODE:AB3F SetSplice:				     ; ...
DOSCODE:AB3F		     mov     ss:NoSetDir, al
DOSCODE:AB43		     mov     al, 0FFh	     ; -1
DOSCODE:AB45
DOSCODE:AB45 TransPathNoSet:			     ; ...
DOSCODE:AB45		     mov     ss:FSPLICE, al
DOSCODE:AB49		     mov     ss:CMETA, 0FFh  ; -1
DOSCODE:AB4F		     mov     ss:WFP_START, di
DOSCODE:AB54		     mov     ss:CURR_DIR_END, 0FFFFh ; -1
DOSCODE:AB5B		     push    ss
DOSCODE:AB5C		     pop     es
DOSCODE:AB5D		     lea     bp, [di+134]    ; [DI+TEMPLEN]
DOSCODE:AB61		     test    ss:FSHARING, 0FFh ; -1
DOSCODE:AB67		     jz	     short CheckUNC
DOSCODE:AB69		     call    DriveFromText
DOSCODE:AB6C		     call    GETTHISDRV
DOSCODE:AB6F		     jb	     short NoPath
DOSCODE:AB71		     call    TextFromDrive
DOSCODE:AB74		     lea     bx, [di+1]
DOSCODE:AB77		     call    Canonicalize
DOSCODE:AB7A		     jb	     short TransPath_retn
DOSCODE:AB7C		     push    ss
DOSCODE:AB7D		     pop     ds
DOSCODE:AB7E		     mov     si, ds:WFP_START
DOSCODE:AB82		     test    ds:FSPLICE, 0FFh ;	-1
DOSCODE:AB87		     jz	     short NoServerSplice
DOSCODE:AB89		     call    Splice
DOSCODE:AB8C
DOSCODE:AB8C NoServerSplice:			     ; ...
DOSCODE:AB8C		     push    ss
DOSCODE:AB8D		     pop     ds
DOSCODE:AB8E		     les     di, ds:THISCDS
DOSCODE:AB92		     call    ECritDisk
DOSCODE:AB95		     call    FATREAD_CDS
DOSCODE:AB98		     call    LCritDisk
DOSCODE:AB9B
DOSCODE:AB9B NoPath:				     ; ...
DOSCODE:AB9B		     mov     al, 3	     ; error_path_not_found
DOSCODE:AB9D		     retn
DOSCODE:AB9E ; ---------------------------------------------------------------------------
DOSCODE:AB9E
DOSCODE:AB9E CheckUNC:				     ; ...
DOSCODE:AB9E		     mov     word ptr ss:THISCDS, 0FFFFh
DOSCODE:ABA5		     mov     ax, 1123h
DOSCODE:ABA8		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	QUALIFY	REMOTE FILENAME
DOSCODE:ABA8					     ; DS:SI ->	ASCIZ filename to canonicalize
DOSCODE:ABA8					     ; ES:DI ->	128-byte buffer	for qualified name
DOSCODE:ABA8					     ; Return: CF set if not resolved
DOSCODE:ABAA		     jnb     short UNCDone
DOSCODE:ABAC		     call    DriveFromText
DOSCODE:ABAF		     push    ax
DOSCODE:ABB0		     mov     ax, [si]
DOSCODE:ABB2		     call    PATHCHRCMP
DOSCODE:ABB5		     xchg    ah, al
DOSCODE:ABB7		     call    PATHCHRCMP
DOSCODE:ABBA		     jnz     short CheckDevice
DOSCODE:ABBC		     cmp     ah, al
DOSCODE:ABBE		     jnz     short CheckDevice
DOSCODE:ABC0		     pop     ax
DOSCODE:ABC1		     movsw
DOSCODE:ABC2
DOSCODE:ABC2 UNCCpy:				     ; ...
DOSCODE:ABC2		     lodsb
DOSCODE:ABC3		     call    UCase
DOSCODE:ABC6		     or	     al, al
DOSCODE:ABC8		     jz	     short UNCTerm
DOSCODE:ABCA		     call    PATHCHRCMP
DOSCODE:ABCD		     mov     bx, di
DOSCODE:ABCF		     stosb
DOSCODE:ABD0		     jnz     short UNCCpy
DOSCODE:ABD2		     call    Canonicalize
DOSCODE:ABD5
DOSCODE:ABD5 UNCDone:				     ; ...
DOSCODE:ABD5		     push    ss
DOSCODE:ABD6		     pop     ds
DOSCODE:ABD7		     retn
DOSCODE:ABD8 ; ---------------------------------------------------------------------------
DOSCODE:ABD8
DOSCODE:ABD8 UNCTerm:				     ; ...
DOSCODE:ABD8		     stosb
DOSCODE:ABD9		     jmp     short UNCDone
DOSCODE:ABDB ; ---------------------------------------------------------------------------
DOSCODE:ABDB
DOSCODE:ABDB CheckDevice:			     ; ...
DOSCODE:ABDB		     pop     ax
DOSCODE:ABDC		     cmp     byte ptr [si], 0
DOSCODE:ABDF		     jnz     short CheckPath
DOSCODE:ABE1		     mov     al, 2	     ; error_file_not_found
DOSCODE:ABE3		     stc
DOSCODE:ABE4		     retn
DOSCODE:ABE5 ; ---------------------------------------------------------------------------
DOSCODE:ABE5
DOSCODE:ABE5 CheckPath:				     ; ...
DOSCODE:ABE5		     push    ax
DOSCODE:ABE6		     push    bp
DOSCODE:ABE7		     call    CheckThisDevice
DOSCODE:ABEA		     pop     bp
DOSCODE:ABEB		     pop     ax
DOSCODE:ABEC		     jnb     short DoFile
DOSCODE:ABEE		     mov     ss:FSHARING, 0FFh ; -1
DOSCODE:ABF4		     call    GETTHISDRV
DOSCODE:ABF7		     mov     ss:FSHARING, 0
DOSCODE:ABFD		     call    TextFromDrive
DOSCODE:AC00		     mov     al, '/'
DOSCODE:AC02		     stosb
DOSCODE:AC03		     call    StrCpy
DOSCODE:AC06		     clc
DOSCODE:AC07		     push    ss
DOSCODE:AC08		     pop     ds
DOSCODE:AC09
DOSCODE:AC09 DoFile_retn:			     ; ...
DOSCODE:AC09		     retn
DOSCODE:AC0A ; ---------------------------------------------------------------------------
DOSCODE:AC0A
DOSCODE:AC0A DoFile:				     ; ...
DOSCODE:AC0A		     call    GetVisDrv
DOSCODE:AC0D		     mov     al, 3	     ; error_path_not_found
DOSCODE:AC0F		     jb	     short DoFile_retn
DOSCODE:AC11		     push    ds
DOSCODE:AC12		     push    si
DOSCODE:AC13		     push    es
DOSCODE:AC14		     push    di
DOSCODE:AC15		     call    ValidateCDS
DOSCODE:AC18		     pop     di
DOSCODE:AC19		     pop     es
DOSCODE:AC1A		     pop     si
DOSCODE:AC1B		     pop     ds
DOSCODE:AC1C		     mov     al, 3
DOSCODE:AC1E		     jb	     short DoFile_retn
DOSCODE:AC20		     push    ds
DOSCODE:AC21		     push    si
DOSCODE:AC22		     lds     si, ss:THISCDS
DOSCODE:AC27		     mov     bx, di
DOSCODE:AC29		     add     bx, [si+79]     ; [SI+curdir.end]
DOSCODE:AC2C		     lea     bp, [di+134]    ; [DI+TEMPLEN]
DOSCODE:AC30		     call    FStrCpy
DOSCODE:AC33		     dec     di
DOSCODE:AC34		     mov     al, '\'
DOSCODE:AC36		     cmp     es:[di-1],	al
DOSCODE:AC3A		     jz	     short GetOrig
DOSCODE:AC3C		     stosb
DOSCODE:AC3D
DOSCODE:AC3D GetOrig:				     ; ...
DOSCODE:AC3D		     dec     di
DOSCODE:AC3E		     pop     si
DOSCODE:AC3F		     pop     ds
DOSCODE:AC40		     call    PathSep
DOSCODE:AC43		     jnz     short PathAssure
DOSCODE:AC45		     or	     al, al
DOSCODE:AC47		     jz	     short DoCanon
DOSCODE:AC49		     mov     di, bx
DOSCODE:AC4B
DOSCODE:AC4B SkipPath:				     ; ...
DOSCODE:AC4B		     lodsb
DOSCODE:AC4C		     call    PATHCHRCMP
DOSCODE:AC4F		     jz	     short SkipPath
DOSCODE:AC51		     dec     si
DOSCODE:AC52		     or	     al, al
DOSCODE:AC54		     jz	     short DoCanon
DOSCODE:AC56
DOSCODE:AC56 PathAssure:			     ; ...
DOSCODE:AC56		     mov     al, 5Ch ; '\'
DOSCODE:AC58		     stosb
DOSCODE:AC59
DOSCODE:AC59 DoCanon:				     ; ...
DOSCODE:AC59		     call    Canonicalize
DOSCODE:AC5C		     jb	     short DoFile_retn
DOSCODE:AC5E		     push    ss
DOSCODE:AC5F		     pop     ds
DOSCODE:AC60		     mov     di, ds:WFP_START
DOSCODE:AC64		     lds     si, ds:THISCDS
DOSCODE:AC68		     call    PathPref
DOSCODE:AC6B		     jnz     short DoSplice
DOSCODE:AC6D		     mov     al, [si-1]
DOSCODE:AC70		     call    PATHCHRCMP
DOSCODE:AC73		     jz	     short DoSplice
DOSCODE:AC75		     cmp     byte ptr es:[di], 0
DOSCODE:AC79		     jz	     short DoSplice
DOSCODE:AC7B		     inc     di
DOSCODE:AC7C		     mov     ss:CURR_DIR_END, di
DOSCODE:AC81
DOSCODE:AC81 DoSplice:				     ; ...
DOSCODE:AC81		     push    ss
DOSCODE:AC82		     pop     ds
DOSCODE:AC83		     mov     si, ds:WFP_START
DOSCODE:AC87		     xor     cx, cx
DOSCODE:AC89		     test    ds:FSPLICE, 0FFh ;	-1
DOSCODE:AC8E		     jz	     short SkipSplice
DOSCODE:AC90		     call    Splice
DOSCODE:AC93
DOSCODE:AC93 SkipSplice:			     ; ...
DOSCODE:AC93		     push    ss
DOSCODE:AC94		     pop     ds
DOSCODE:AC95		     les     di, ds:THISCDS
DOSCODE:AC99		     test    word ptr es:[di+67], 8000h	; [ES:DI+curdir.flags],
DOSCODE:AC99					     ; curdir_isnet
DOSCODE:AC9F		     jnz     short Done
DOSCODE:ACA1		     jcxz    short Done
DOSCODE:ACA3		     call    ECritDisk
DOSCODE:ACA6		     call    FATREAD_CDS
DOSCODE:ACA9		     call    LCritDisk
DOSCODE:ACAC		     mov     al, 3	     ; error_path_not_found
DOSCODE:ACAE
DOSCODE:ACAE Done:				     ; ...
DOSCODE:ACAE		     retn
DOSCODE:ACAE TransPath	     endp
DOSCODE:ACAE
DOSCODE:ACAF
DOSCODE:ACAF ; =============== S U B R O U T I N E =======================================
DOSCODE:ACAF
DOSCODE:ACAF
DOSCODE:ACAF Canonicalize    proc near		     ; ...
DOSCODE:ACAF		     lodsb
DOSCODE:ACB0		     call    PATHCHRCMP
DOSCODE:ACB3		     jnz     short CanonDec
DOSCODE:ACB5		     cmp     di, bp
DOSCODE:ACB7		     jnb     short CanonBad
DOSCODE:ACB9		     stosb
DOSCODE:ACBA		     jmp     short Canonicalize
DOSCODE:ACBC ; ---------------------------------------------------------------------------
DOSCODE:ACBC
DOSCODE:ACBC CanonDec:				     ; ...
DOSCODE:ACBC		     dec     si
DOSCODE:ACBD
DOSCODE:ACBD CanonLoop:				     ; ...
DOSCODE:ACBD		     xor     ax, ax
DOSCODE:ACBF		     cmp     [si], al
DOSCODE:ACC1		     jnz     short DoComponent
DOSCODE:ACC3		     cmp     byte ptr es:[di-1], ':'
DOSCODE:ACC8		     jnz     short DoTerminate
DOSCODE:ACCA		     mov     al, '\'
DOSCODE:ACCC		     stosb
DOSCODE:ACCD		     mov     al, ah
DOSCODE:ACCF
DOSCODE:ACCF DoTerminate:			     ; ...
DOSCODE:ACCF		     stosb
DOSCODE:ACD0		     clc
DOSCODE:ACD1		     retn
DOSCODE:ACD2 ; ---------------------------------------------------------------------------
DOSCODE:ACD2
DOSCODE:ACD2 CanonBad:				     ; ...
DOSCODE:ACD2		     call    ScanPathChar
DOSCODE:ACD5		     mov     al, 3	     ; error_path_not_found
DOSCODE:ACD7		     jz	     short PathEnc
DOSCODE:ACD9		     mov     al, 2	     ; error_file_not_found
DOSCODE:ACDB
DOSCODE:ACDB PathEnc:				     ; ...
DOSCODE:ACDB		     stc
DOSCODE:ACDC
DOSCODE:ACDC CanonBad_retn:			     ; ...
DOSCODE:ACDC		     retn
DOSCODE:ACDD ; ---------------------------------------------------------------------------
DOSCODE:ACDD
DOSCODE:ACDD DoComponent:			     ; ...
DOSCODE:ACDD		     call    CopyComponent
DOSCODE:ACE0		     jb	     short CanonBad_retn
DOSCODE:ACE2		     cmp     word ptr es:[di], 2Eh ; '.'
DOSCODE:ACE6		     jz	     short Skip1
DOSCODE:ACE8		     cmp     word ptr es:[di], 2E2Eh
DOSCODE:ACED		     jnz     short CanonNormal
DOSCODE:ACEF		     dec     di
DOSCODE:ACF0
DOSCODE:ACF0 Skip1:				     ; ...
DOSCODE:ACF0		     call    SkipBack
DOSCODE:ACF3		     mov     al, 3	     ; error_path_not_found
DOSCODE:ACF5		     jb	     short CanonBad_retn
DOSCODE:ACF7		     jmp     short CanonPath
DOSCODE:ACF9 ; ---------------------------------------------------------------------------
DOSCODE:ACF9
DOSCODE:ACF9 CanonNormal:			     ; ...
DOSCODE:ACF9		     add     di, cx
DOSCODE:ACFB
DOSCODE:ACFB CanonPath:				     ; ...
DOSCODE:ACFB		     call    PathSep
DOSCODE:ACFE		     jnz     short CanonBad
DOSCODE:AD00		     lodsb
DOSCODE:AD01		     call    PATHCHRCMP
DOSCODE:AD04		     jnz     short CanonDec
DOSCODE:AD06		     cmp     di, bp
DOSCODE:AD08		     jnb     short CanonBad
DOSCODE:AD0A		     stosb
DOSCODE:AD0B
DOSCODE:AD0B CanonPathLoop:			     ; ...
DOSCODE:AD0B		     lodsb
DOSCODE:AD0C		     call    PATHCHRCMP
DOSCODE:AD0F		     jz	     short CanonPathLoop
DOSCODE:AD11		     dec     si
DOSCODE:AD12		     jmp     short CanonLoop
DOSCODE:AD12 Canonicalize    endp
DOSCODE:AD12
DOSCODE:AD14
DOSCODE:AD14 ; =============== S U B R O U T I N E =======================================
DOSCODE:AD14
DOSCODE:AD14
DOSCODE:AD14 PathSep	     proc near		     ; ...
DOSCODE:AD14		     mov     al, [si]
DOSCODE:AD16
DOSCODE:AD16 PathSepGotCh:			     ; ...
DOSCODE:AD16		     or	     al, al
DOSCODE:AD18		     jz	     short CanonBad_retn
DOSCODE:AD1A		     call    PATHCHRCMP
DOSCODE:AD1D		     retn
DOSCODE:AD1D PathSep	     endp
DOSCODE:AD1D
DOSCODE:AD1E
DOSCODE:AD1E ; =============== S U B R O U T I N E =======================================
DOSCODE:AD1E
DOSCODE:AD1E
DOSCODE:AD1E SkipBack	     proc near		     ; ...
DOSCODE:AD1E		     cmp     di, bx
DOSCODE:AD20		     jb	     short SkipBad
DOSCODE:AD22		     dec     di
DOSCODE:AD23		     mov     al, es:[di]
DOSCODE:AD26		     call    PATHCHRCMP
DOSCODE:AD29		     jnz     short SkipBack
DOSCODE:AD2B		     clc
DOSCODE:AD2C		     retn
DOSCODE:AD2D ; ---------------------------------------------------------------------------
DOSCODE:AD2D
DOSCODE:AD2D SkipBad:				     ; ...
DOSCODE:AD2D		     mov     al, 3	     ; error_path_not_found
DOSCODE:AD2F		     stc
DOSCODE:AD30		     retn
DOSCODE:AD30 SkipBack	     endp
DOSCODE:AD30
DOSCODE:AD31
DOSCODE:AD31 ; =============== S U B R O U T I N E =======================================
DOSCODE:AD31
DOSCODE:AD31
DOSCODE:AD31 CopyComponent   proc near		     ; ...
DOSCODE:AD31		     sub     sp, 14
DOSCODE:AD34		     push    ds
DOSCODE:AD35		     push    si
DOSCODE:AD36		     push    es
DOSCODE:AD37		     push    di
DOSCODE:AD38		     push    bp
DOSCODE:AD39		     mov     bp, sp
DOSCODE:AD3B		     mov     ah, '.'
DOSCODE:AD3D		     lodsb
DOSCODE:AD3E		     stosb
DOSCODE:AD3F		     cmp     al, ah
DOSCODE:AD41		     jnz     short NormalComp
DOSCODE:AD43		     call    PathSep
DOSCODE:AD46		     jz	     short NulTerm
DOSCODE:AD48
DOSCODE:AD48 TryTwoDot:
DOSCODE:AD48		     lodsb
DOSCODE:AD49		     stosb
DOSCODE:AD4A		     cmp     al, ah
DOSCODE:AD4C		     jnz     short CopyBad
DOSCODE:AD4E		     call    PathSep
DOSCODE:AD51		     jnz     short CopyBad
DOSCODE:AD53
DOSCODE:AD53 NulTerm:				     ; ...
DOSCODE:AD53		     xor     al, al
DOSCODE:AD55		     stosb
DOSCODE:AD56		     mov     [bp+6], si	     ; CopySoff
DOSCODE:AD59		     jmp     short _GoodRet
DOSCODE:AD5B ; ---------------------------------------------------------------------------
DOSCODE:AD5B
DOSCODE:AD5B NormalComp:			     ; ...
DOSCODE:AD5B		     mov     si, [bp+6]	     ; CopySoff
DOSCODE:AD5E		     call    NameTrans
DOSCODE:AD61		     cmp     si, [bp+6]
DOSCODE:AD64		     jz	     short CopyBad
DOSCODE:AD66		     test    ss:FSHARING, 0FFh ; -1
DOSCODE:AD6C		     jnz     short DoPack
DOSCODE:AD6E		     and     dl, 1
DOSCODE:AD71		     add     ss:CMETA, dl
DOSCODE:AD76		     jg	     short CopyBad
DOSCODE:AD78		     jnz     short DoPack
DOSCODE:AD7A		     or	     dl, dl
DOSCODE:AD7C		     jz	     short CopyBadPath
DOSCODE:AD7E
DOSCODE:AD7E DoPack:				     ; ...
DOSCODE:AD7E		     mov     [bp+6], si
DOSCODE:AD81		     push    ss
DOSCODE:AD82		     pop     ds
DOSCODE:AD83		     mov     si, offset	NAME1
DOSCODE:AD86		     lea     di, [bp+10]     ; CopyTemp
DOSCODE:AD89		     push    di
DOSCODE:AD8A		     call    PackName
DOSCODE:AD8D		     pop     di
DOSCODE:AD8E		     call    StrLen
DOSCODE:AD91		     dec     cx
DOSCODE:AD92		     add     cx, [bp+2]	     ; CopyDoff
DOSCODE:AD95		     cmp     cx, [bp+0]	     ; CopyBP
DOSCODE:AD98		     jnb     short CopyBad
DOSCODE:AD9A		     mov     si, di
DOSCODE:AD9C		     les     di, [bp+2]	     ; CopyD
DOSCODE:AD9F		     call    FStrCpy
DOSCODE:ADA2
DOSCODE:ADA2 _GoodRet:				     ; ...
DOSCODE:ADA2		     clc
DOSCODE:ADA3		     jmp     short CopyEnd
DOSCODE:ADA5 ; ---------------------------------------------------------------------------
DOSCODE:ADA5
DOSCODE:ADA5 CopyBad:				     ; ...
DOSCODE:ADA5		     stc
DOSCODE:ADA6		     call    ScanPathChar
DOSCODE:ADA9		     mov     al, 2	     ; error_file_not_found
DOSCODE:ADAB		     jnz     short CopyEnd
DOSCODE:ADAD
DOSCODE:ADAD CopyBadPath:			     ; ...
DOSCODE:ADAD		     stc
DOSCODE:ADAE		     mov     al, 3	     ; error_path_not_found
DOSCODE:ADB0
DOSCODE:ADB0 CopyEnd:				     ; ...
DOSCODE:ADB0		     pop     bp
DOSCODE:ADB1		     pop     di
DOSCODE:ADB2		     pop     es
DOSCODE:ADB3		     pop     si
DOSCODE:ADB4		     pop     ds
DOSCODE:ADB5		     lahf
DOSCODE:ADB6		     add     sp, 14
DOSCODE:ADB9		     call    StrLen
DOSCODE:ADBC		     dec     cx
DOSCODE:ADBD		     sahf
DOSCODE:ADBE		     retn
DOSCODE:ADBE CopyComponent   endp
DOSCODE:ADBE
DOSCODE:ADBF
DOSCODE:ADBF ; =============== S U B R O U T I N E =======================================
DOSCODE:ADBF
DOSCODE:ADBF
DOSCODE:ADBF Splice	     proc near		     ; ...
DOSCODE:ADBF		     test    ss:SPLICES, 0FFh ;	-1
DOSCODE:ADC5		     jz	     short AllDone
DOSCODE:ADC7		     push    word ptr ss:THISCDS
DOSCODE:ADCC		     push    word ptr ss:THISCDS+2
DOSCODE:ADD1		     push    ds
DOSCODE:ADD2		     push    si
DOSCODE:ADD3		     pop     di
DOSCODE:ADD4		     pop     es
DOSCODE:ADD5		     xor     ax, ax
DOSCODE:ADD7
DOSCODE:ADD7 SpliceScan:			     ; ...
DOSCODE:ADD7		     call    GetCDSFromDrv
DOSCODE:ADDA		     jb	     short SpliceDone
DOSCODE:ADDC		     inc     al
DOSCODE:ADDE		     test    word ptr [si+67], 2000h ; [SI+curdir.flags],
DOSCODE:ADDE					     ; curdir_splice
DOSCODE:ADE3		     jz	     short SpliceScan
DOSCODE:ADE5		     push    di
DOSCODE:ADE6		     call    PathPref
DOSCODE:ADE9		     jz	     short SpliceFound
DOSCODE:ADEB
DOSCODE:ADEB SpliceSkip:			     ; ...
DOSCODE:ADEB		     pop     di
DOSCODE:ADEC		     jmp     short SpliceScan
DOSCODE:ADEE ; ---------------------------------------------------------------------------
DOSCODE:ADEE
DOSCODE:ADEE SpliceFound:			     ; ...
DOSCODE:ADEE		     cmp     byte ptr es:[di], 0
DOSCODE:ADF2		     jnz     short SpliceDo
DOSCODE:ADF4		     test    ss:NoSetDir, 0FFh ; -1
DOSCODE:ADFA		     jnz     short SpliceSkip
DOSCODE:ADFC
DOSCODE:ADFC SpliceDo:				     ; ...
DOSCODE:ADFC		     mov     si, di
DOSCODE:ADFE		     push    es
DOSCODE:ADFF		     pop     ds
DOSCODE:AE00		     pop     di
DOSCODE:AE01		     call    TextFromDrive1
DOSCODE:AE04		     mov     ax, ss:CURR_DIR_END
DOSCODE:AE08		     or	     ax, ax
DOSCODE:AE0A		     js	     short NoPoke
DOSCODE:AE0C		     add     ax, di
DOSCODE:AE0E		     sub     ax, si
DOSCODE:AE10		     mov     ss:CURR_DIR_END, ax
DOSCODE:AE14
DOSCODE:AE14 NoPoke:				     ; ...
DOSCODE:AE14		     cmp     byte ptr [si], 0
DOSCODE:AE17		     jnz     short SpliceCopy
DOSCODE:AE19		     mov     al, '\'
DOSCODE:AE1B		     stosb
DOSCODE:AE1C
DOSCODE:AE1C SpliceCopy:			     ; ...
DOSCODE:AE1C		     call    FStrCpy
DOSCODE:AE1F		     add     sp, 4
DOSCODE:AE22		     or	     cl, 1
DOSCODE:AE25		     jmp     short DoSet
DOSCODE:AE27 ; ---------------------------------------------------------------------------
DOSCODE:AE27
DOSCODE:AE27 SpliceDone:			     ; ...
DOSCODE:AE27		     pop     word ptr ss:THISCDS+2
DOSCODE:AE2C		     pop     word ptr ss:THISCDS
DOSCODE:AE31
DOSCODE:AE31 AllDone:				     ; ...
DOSCODE:AE31		     xor     cx, cx
DOSCODE:AE33
DOSCODE:AE33 DoSet:				     ; ...
DOSCODE:AE33		     lds     si, ss:THISCDS
DOSCODE:AE38		     les     di, [si+69]     ; [SI+curdir.devptr]
DOSCODE:AE3B		     mov     word ptr ss:THISDPB, di
DOSCODE:AE40		     mov     word ptr ss:THISDPB+2, es
DOSCODE:AE45
DOSCODE:AE45 Splice_retn:			     ; ...
DOSCODE:AE45		     retn
DOSCODE:AE45 Splice	     endp
DOSCODE:AE45
DOSCODE:AE46 ; ---------------------------------------------------------------------------
DOSCODE:AE46
DOSCODE:AE46 $NameTrans:			     ; ...
DOSCODE:AE46		     push    ds
DOSCODE:AE47		     push    si
DOSCODE:AE48		     push    es
DOSCODE:AE49		     push    di
DOSCODE:AE4A		     push    cx
DOSCODE:AE4B		     mov     ch, 16h	     ; attr_hidden+attr_system+attr_directory
DOSCODE:AE4D		     call    SetAttrib
DOSCODE:AE50		     mov     di, offset	OPENBUF
DOSCODE:AE53		     call    TransPath
DOSCODE:AE56		     pop     cx
DOSCODE:AE57		     pop     di
DOSCODE:AE58		     pop     es
DOSCODE:AE59		     pop     si
DOSCODE:AE5A		     pop     ds
DOSCODE:AE5B		     jnb     short TransOK
DOSCODE:AE5D		     jmp     SYS_RET_ERR
DOSCODE:AE60 ; ---------------------------------------------------------------------------
DOSCODE:AE60
DOSCODE:AE60 TransOK:				     ; ...
DOSCODE:AE60		     mov     si, offset	OPENBUF
DOSCODE:AE63		     push    ss
DOSCODE:AE64		     pop     ds
DOSCODE:AE65		     call    FStrCpy
DOSCODE:AE68		     jmp     SYS_RETURN	     ; SYS_RET_OK
DOSCODE:AE6B
DOSCODE:AE6B ; =============== S U B R O U T I N E =======================================
DOSCODE:AE6B
DOSCODE:AE6B
DOSCODE:AE6B DriveFromText   proc near		     ; ...
DOSCODE:AE6B		     xor     al, al
DOSCODE:AE6D		     cmp     byte ptr [si], 0
DOSCODE:AE70		     jz	     short Splice_retn
DOSCODE:AE72		     cmp     byte ptr [si+1], ':'
DOSCODE:AE76		     jnz     short Splice_retn
DOSCODE:AE78		     lodsw
DOSCODE:AE79		     or	     al, 20h
DOSCODE:AE7B		     sub     al, 60h	     ; 'a'-1
DOSCODE:AE7D		     jnz     short Splice_retn
DOSCODE:AE7F		     mov     al, 0FFh	     ; -1
DOSCODE:AE81		     retn
DOSCODE:AE81 DriveFromText   endp
DOSCODE:AE81
DOSCODE:AE82
DOSCODE:AE82 ; =============== S U B R O U T I N E =======================================
DOSCODE:AE82
DOSCODE:AE82
DOSCODE:AE82 TextFromDrive   proc near		     ; ...
DOSCODE:AE82		     inc     al
DOSCODE:AE84
DOSCODE:AE84 TextFromDrive1:			     ; ...
DOSCODE:AE84		     add     al, 40h	     ; 'A'-1
DOSCODE:AE86		     mov     ah, ':'         ; 3Ah
DOSCODE:AE88		     stosw
DOSCODE:AE89
DOSCODE:AE89 PathPref_retn:			     ; ...
DOSCODE:AE89		     retn
DOSCODE:AE89 TextFromDrive   endp
DOSCODE:AE89
DOSCODE:AE8A
DOSCODE:AE8A ; =============== S U B R O U T I N E =======================================
DOSCODE:AE8A
DOSCODE:AE8A
DOSCODE:AE8A PathPref	     proc near		     ; ...
DOSCODE:AE8A		     call    DStrLen
DOSCODE:AE8D		     dec     cx
DOSCODE:AE8E		     repe cmpsb
DOSCODE:AE90		     jnz     short PathPref_retn
DOSCODE:AE92		     push    ax
DOSCODE:AE93		     mov     al, [si-1]
DOSCODE:AE96		     call    PATHCHRCMP
DOSCODE:AE99		     jz	     short Prefix
DOSCODE:AE9B		     mov     al, es:[di]
DOSCODE:AE9E		     call    PathSepGotCh
DOSCODE:AEA1
DOSCODE:AEA1 Prefix:				     ; ...
DOSCODE:AEA1		     pop     ax
DOSCODE:AEA2		     retn
DOSCODE:AEA2 PathPref	     endp
DOSCODE:AEA2
DOSCODE:AEA3
DOSCODE:AEA3 ; =============== S U B R O U T I N E =======================================
DOSCODE:AEA3
DOSCODE:AEA3
DOSCODE:AEA3 ScanPathChar    proc near		     ; ...
DOSCODE:AEA3		     lodsb
DOSCODE:AEA4		     call    PathSepGotCh
DOSCODE:AEA7		     jnz     short ScanPathChar
DOSCODE:AEA9		     call    PATHCHRCMP
DOSCODE:AEAC		     retn
DOSCODE:AEAC ScanPathChar    endp
DOSCODE:AEAC
DOSCODE:AEAD
DOSCODE:AEAD ; =============== S U B R O U T I N E =======================================
DOSCODE:AEAD
DOSCODE:AEAD
DOSCODE:AEAD $OPEN	     proc near		     ; ...
DOSCODE:AEAD		     xor     ah, ah
DOSCODE:AEAF
DOSCODE:AEAF _$Open2:				     ; ...
DOSCODE:AEAF		     mov     ch, 16h	     ; attr_hidden+attr_system+attr_directory
DOSCODE:AEB1		     call    SetAttrib
DOSCODE:AEB4		     mov     cx, offset	DOS_OPEN
DOSCODE:AEB7		     push    ax
DOSCODE:AEB8
DOSCODE:AEB8 AccessFile:			     ; ...
DOSCODE:AEB8		     call    ECritDisk	     ; call ECritSFT
DOSCODE:AEBB		     call    SFNFree
DOSCODE:AEBE		     call    LCritDisk	     ; call LCritSFT
DOSCODE:AEC1		     jb	     short OpenFailJ
DOSCODE:AEC3		     mov     ss:SFN, bx
DOSCODE:AEC8		     mov     word ptr ss:THISSFT, di
DOSCODE:AECD		     mov     word ptr ss:THISSFT+2, es
DOSCODE:AED2		     call    JFNFree
DOSCODE:AED5		     jnb     short SaveJFN
DOSCODE:AED7
DOSCODE:AED7 OpenFailJ:				     ; ...
DOSCODE:AED7		     jmp     OpenFail
DOSCODE:AEDA ; ---------------------------------------------------------------------------
DOSCODE:AEDA
DOSCODE:AEDA SaveJFN:				     ; ...
DOSCODE:AEDA		     mov     word ptr ss:PJFN, di
DOSCODE:AEDF		     mov     word ptr ss:PJFN+2, es
DOSCODE:AEE4		     mov     ss:JFN, bx
DOSCODE:AEE9		     mov     bx, ss:SFN
DOSCODE:AEEE		     mov     es:[di], bl
DOSCODE:AEF1		     mov     si, dx
DOSCODE:AEF3		     mov     di, offset	OPENBUF
DOSCODE:AEF6		     push    cx
DOSCODE:AEF7		     call    TransPath
DOSCODE:AEFA		     pop     bx
DOSCODE:AEFB		     lds     si, ss:THISSFT
DOSCODE:AF00		     jb	     short OpenCleanJ
DOSCODE:AF02		     cmp     ss:CMETA, 0FFh  ; -1
DOSCODE:AF08		     jz	     short SetSearch
DOSCODE:AF0A		     mov     al, 2
DOSCODE:AF0C
DOSCODE:AF0C OpenCleanJ:			     ; ...
DOSCODE:AF0C		     jmp     short OpenClean
DOSCODE:AF0E ; ---------------------------------------------------------------------------
DOSCODE:AF0E
DOSCODE:AF0E SetSearch:				     ; ...
DOSCODE:AF0E		     pop     ax
DOSCODE:AF0F		     xor     cx, cx
DOSCODE:AF11		     mov     [si+2], cx	     ; [SI+SF_ENTRY.sf_mode]
DOSCODE:AF14		     mov     [si+33h], cx    ; [SI+SF_ENTRY.sf_MFT]
DOSCODE:AF17		     cmp     bx, offset	DOS_OPEN
DOSCODE:AF1B		     jnz     short _DoOper
DOSCODE:AF1D		     test    al, 80h
DOSCODE:AF1F		     jz	     short _DoOper
DOSCODE:AF21		     and     al, 7Fh
DOSCODE:AF23		     mov     cx, 1000h	     ; sf_no_inherit
DOSCODE:AF26
DOSCODE:AF26 _DoOper:				     ; ...
DOSCODE:AF26		     push    di
DOSCODE:AF27		     push    es
DOSCODE:AF28		     push    ds
DOSCODE:AF29		     pop     es
DOSCODE:AF2A		     push    si
DOSCODE:AF2B		     pop     di
DOSCODE:AF2C		     call    Set_EXT_mode
DOSCODE:AF2F		     pop     es
DOSCODE:AF30		     pop     di
DOSCODE:AF31		     push    ss
DOSCODE:AF32		     pop     ds
DOSCODE:AF33		     push    cx
DOSCODE:AF34		     call    bx
DOSCODE:AF36		     pop     cx
DOSCODE:AF37		     lds     si, ds:THISSFT
DOSCODE:AF3B		     jb	     short OpenE2
DOSCODE:AF3D		     mov     word ptr [si], 1
DOSCODE:AF41		     or	     [si+5], cx	     ; [SI+SF_ENTRY.sf_flags]
DOSCODE:AF44		     mov     ax, ss:JFN
DOSCODE:AF48		     call    ss:ShCol	     ; Call far	[ss:JShare+(12*4)] ; 12	= ShCol
DOSCODE:AF4D		     mov     ss:SFN, 0FFFFh  ; -1
DOSCODE:AF54
DOSCODE:AF54 OpenOkj:				     ; ...
DOSCODE:AF54		     jmp     SYS_RETURN	     ; SYS_RET_OK
DOSCODE:AF57 ; ---------------------------------------------------------------------------
DOSCODE:AF57
DOSCODE:AF57 OpenE2:				     ; ...
DOSCODE:AF57		     cmp     ax, 57h	     ; error_invalid_parameter
DOSCODE:AF5A		     jnz     short OpenE
DOSCODE:AF5C		     jmp     short OpenCritLeave
DOSCODE:AF5E ; ---------------------------------------------------------------------------
DOSCODE:AF5E
DOSCODE:AF5E OpenClean:				     ; ...
DOSCODE:AF5E		     pop     bx
DOSCODE:AF5F
DOSCODE:AF5F OpenE:				     ; ...
DOSCODE:AF5F		     mov     word ptr [si], 0
DOSCODE:AF63		     lds     si, ss:PJFN
DOSCODE:AF68		     mov     byte ptr [si], 0FFh ; -1
DOSCODE:AF6B		     jmp     short OpenCritLeave
DOSCODE:AF6D ; ---------------------------------------------------------------------------
DOSCODE:AF6D
DOSCODE:AF6D OpenFail:				     ; ...
DOSCODE:AF6D		     sti
DOSCODE:AF6E		     pop     cx
DOSCODE:AF6F
DOSCODE:AF6F OpenCritLeave:			     ; ...
DOSCODE:AF6F		     mov     ss:SFN, 0FFFFh  ; -1
DOSCODE:AF76		     cmp     ss:EXTERR,	25h  ; error_Code_Page_Mismatched
DOSCODE:AF7C		     jnz     short NORERR
DOSCODE:AF7E		     jmp     From_GetSet
DOSCODE:AF81 ; ---------------------------------------------------------------------------
DOSCODE:AF81
DOSCODE:AF81 NORERR:				     ; ...
DOSCODE:AF81		     jmp     SYS_RET_ERR
DOSCODE:AF81 $OPEN	     endp
DOSCODE:AF81
DOSCODE:AF84 ; ---------------------------------------------------------------------------
DOSCODE:AF84
DOSCODE:AF84 $CREAT:				     ; ...
DOSCODE:AF84		     push    cx
DOSCODE:AF85		     mov     cx, offset	DOS_CREATE
DOSCODE:AF88 ; START OF	FUNCTION CHUNK FOR $CreateNewFile
DOSCODE:AF88
DOSCODE:AF88 AccessSet:				     ; ...
DOSCODE:AF88		     mov     ss:SATTRIB, 6   ; attr_hidden+attr_system
DOSCODE:AF8E		     jmp     AccessFile
DOSCODE:AF8E ; END OF FUNCTION CHUNK FOR $CreateNewFile
DOSCODE:AF91 ; ---------------------------------------------------------------------------
DOSCODE:AF91
DOSCODE:AF91 $CHMOD:				     ; ...
DOSCODE:AF91		     mov     di, offset	OPENBUF
DOSCODE:AF94		     push    ax
DOSCODE:AF95		     push    cx
DOSCODE:AF96		     mov     si, dx
DOSCODE:AF98		     call    TransPathSet
DOSCODE:AF9B		     pop     cx
DOSCODE:AF9C		     pop     ax
DOSCODE:AF9D		     jb	     short ChModErr
DOSCODE:AF9F		     push    ss
DOSCODE:AFA0		     pop     ds
DOSCODE:AFA1		     cmp     ds:CMETA, 0FFh  ; -1
DOSCODE:AFA6		     jnz     short ChModErr
DOSCODE:AFA8		     mov     ds:SATTRIB, 16h ; attr_hidden+attr_system+attr_directory
DOSCODE:AFAD		     sub     al, 1
DOSCODE:AFAF		     jb	     short ChModGet
DOSCODE:AFB1		     jz	     short ChModSet
DOSCODE:AFB3		     mov     ds:EXTERR_LOCUS, 1	; errLOC_Unk
DOSCODE:AFB8		     mov     al, 1	     ; error_invalid_function
DOSCODE:AFBA ; START OF	FUNCTION CHUNK FOR $UNLINK
DOSCODE:AFBA
DOSCODE:AFBA chmod_errj:			     ; ...
DOSCODE:AFBA		     jmp     short NORERR
DOSCODE:AFBA ; END OF FUNCTION CHUNK FOR $UNLINK
DOSCODE:AFBC ; ---------------------------------------------------------------------------
DOSCODE:AFBC
DOSCODE:AFBC ChModGet:				     ; ...
DOSCODE:AFBC		     call    GET_FILE_INFO
DOSCODE:AFBF		     jb	     short ChModE
DOSCODE:AFC1		     call    Get_User_Stack
DOSCODE:AFC4		     mov     [si+4], ax	     ; [SI+user_env.user_CX]
DOSCODE:AFC7 ; START OF	FUNCTION CHUNK FOR $UNLINK
DOSCODE:AFC7
DOSCODE:AFC7 OpenOkj2:				     ; ...
DOSCODE:AFC7		     jmp     short OpenOkj
DOSCODE:AFC7 ; END OF FUNCTION CHUNK FOR $UNLINK
DOSCODE:AFC9 ; ---------------------------------------------------------------------------
DOSCODE:AFC9
DOSCODE:AFC9 ChModSet:				     ; ...
DOSCODE:AFC9		     mov     ax, cx
DOSCODE:AFCB		     call    SET_FILE_ATTRIBUTE
DOSCODE:AFCE		     jb	     short ChModE
DOSCODE:AFD0 ; START OF	FUNCTION CHUNK FOR $UNLINK
DOSCODE:AFD0
DOSCODE:AFD0 OpenOkj3:				     ; ...
DOSCODE:AFD0		     jmp     short OpenOkj2
DOSCODE:AFD2 ; ---------------------------------------------------------------------------
DOSCODE:AFD2
DOSCODE:AFD2 ChModErr:				     ; ...
DOSCODE:AFD2		     mov     al, 3
DOSCODE:AFD4
DOSCODE:AFD4 ChModE:				     ; ...
DOSCODE:AFD4		     jmp     short chmod_errj
DOSCODE:AFD4 ; END OF FUNCTION CHUNK FOR $UNLINK
DOSCODE:AFD6
DOSCODE:AFD6 ; =============== S U B R O U T I N E =======================================
DOSCODE:AFD6
DOSCODE:AFD6
DOSCODE:AFD6 $UNLINK	     proc near		     ; ...
DOSCODE:AFD6
DOSCODE:AFD6 ; FUNCTION	CHUNK AT DOSCODE:AFBA SIZE 00000002 BYTES
DOSCODE:AFD6 ; FUNCTION	CHUNK AT DOSCODE:AFC7 SIZE 00000002 BYTES
DOSCODE:AFD6 ; FUNCTION	CHUNK AT DOSCODE:AFD0 SIZE 00000006 BYTES
DOSCODE:AFD6
DOSCODE:AFD6		     push    cx
DOSCODE:AFD7		     mov     si, dx
DOSCODE:AFD9		     mov     di, offset	OPENBUF
DOSCODE:AFDC		     call    TransPathSet
DOSCODE:AFDF		     pop     cx
DOSCODE:AFE0		     jb	     short ChModErr
DOSCODE:AFE2		     cmp     ss:CMETA, 0FFh  ; -1
DOSCODE:AFE8		     jnz     short NotFound
DOSCODE:AFEA		     push    ss
DOSCODE:AFEB		     pop     ds
DOSCODE:AFEC		     mov     ch, 6	     ; attr_hidden+attr_system
DOSCODE:AFEE		     call    SetAttrib
DOSCODE:AFF1		     call    DOS_DELETE
DOSCODE:AFF4		     jb	     short UnlinkE
DOSCODE:AFF6
DOSCODE:AFF6 UnlinkOk:				     ; ...
DOSCODE:AFF6		     jmp     short OpenOkj3
DOSCODE:AFF8 ; ---------------------------------------------------------------------------
DOSCODE:AFF8
DOSCODE:AFF8 NotFound:				     ; ...
DOSCODE:AFF8		     mov     al, 3
DOSCODE:AFFA
DOSCODE:AFFA UnlinkE:				     ; ...
DOSCODE:AFFA		     jmp     short ChModE
DOSCODE:AFFA $UNLINK	     endp
DOSCODE:AFFA
DOSCODE:AFFC ; ---------------------------------------------------------------------------
DOSCODE:AFFC
DOSCODE:AFFC $RENAME:				     ; ...
DOSCODE:AFFC		     push    cx
DOSCODE:AFFD		     push    ds
DOSCODE:AFFE		     push    dx
DOSCODE:AFFF		     push    es
DOSCODE:B000		     pop     ds
DOSCODE:B001		     mov     si, di
DOSCODE:B003		     mov     di, offset	RENBUF
DOSCODE:B006		     call    TransPathSet
DOSCODE:B009		     push    ss:WFP_START
DOSCODE:B00E		     pop     ss:REN_WFP
DOSCODE:B013		     pop     si
DOSCODE:B014		     pop     ds
DOSCODE:B015		     pop     cx
DOSCODE:B016
DOSCODE:B016 epjc2:				     ; ...
DOSCODE:B016		     jb	     short ChModErr
DOSCODE:B018		     cmp     ss:CMETA, 0FFh  ; -1
DOSCODE:B01E		     jnz     short NotFound
DOSCODE:B020		     push    cx
DOSCODE:B021		     mov     di, offset	OPENBUF
DOSCODE:B024		     call    TransPathSet
DOSCODE:B027		     pop     cx
DOSCODE:B028		     jb	     short epjc2
DOSCODE:B02A		     push    ss
DOSCODE:B02B		     pop     ds
DOSCODE:B02C		     cmp     ds:CMETA, 0FFh
DOSCODE:B031		     jb	     short NotFound
DOSCODE:B033		     push    word ptr ds:THISCDS
DOSCODE:B037		     push    word ptr ds:THISCDS+2
DOSCODE:B03B		     mov     di, offset	OPENBUF
DOSCODE:B03E		     push    ss
DOSCODE:B03F		     pop     es
DOSCODE:B040		     xor     al, al
DOSCODE:B042
DOSCODE:B042 rnloop:				     ; ...
DOSCODE:B042		     call    GetCDSFromDrv
DOSCODE:B045		     jb	     short dorn
DOSCODE:B047		     call    StrCmp
DOSCODE:B04A		     jz	     short rnerr
DOSCODE:B04C		     inc     al
DOSCODE:B04E		     jmp     short rnloop
DOSCODE:B050 ; ---------------------------------------------------------------------------
DOSCODE:B050
DOSCODE:B050 rnerr:				     ; ...
DOSCODE:B050		     add     sp, 4
DOSCODE:B053		     mov     al, 10h	     ; error_current_directory
DOSCODE:B055		     jmp     short UnlinkE
DOSCODE:B057 ; ---------------------------------------------------------------------------
DOSCODE:B057
DOSCODE:B057 dorn:				     ; ...
DOSCODE:B057		     pop     word ptr ss:THISCDS+2
DOSCODE:B05C		     pop     word ptr ss:THISCDS
DOSCODE:B061		     push    ss
DOSCODE:B062		     pop     ds
DOSCODE:B063		     mov     ch, 16h	     ; attr_directory+attr_hidden+attr_system
DOSCODE:B065		     call    SetAttrib
DOSCODE:B068		     call    DOS_RENAME
DOSCODE:B06B		     jb	     short UnlinkE
DOSCODE:B06D		     jmp     short UnlinkOk
DOSCODE:B06F
DOSCODE:B06F ; =============== S U B R O U T I N E =======================================
DOSCODE:B06F
DOSCODE:B06F
DOSCODE:B06F $CreateNewFile  proc near		     ; ...
DOSCODE:B06F
DOSCODE:B06F ; FUNCTION	CHUNK AT DOSCODE:AF88 SIZE 00000009 BYTES
DOSCODE:B06F
DOSCODE:B06F		     push    cx
DOSCODE:B070		     mov     cx, offset	DOS_Create_New
DOSCODE:B073		     jmp     AccessSet
DOSCODE:B073 $CreateNewFile  endp
DOSCODE:B073
DOSCODE:B076
DOSCODE:B076 ; =============== S U B R O U T I N E =======================================
DOSCODE:B076
DOSCODE:B076
DOSCODE:B076 BinToAscii	     proc near		     ; ...
DOSCODE:B076		     mov     cx, 404h
DOSCODE:B079
DOSCODE:B079 bta5:				     ; ...
DOSCODE:B079		     rol     ax, cl
DOSCODE:B07B		     push    ax
DOSCODE:B07C		     and     al, 0Fh
DOSCODE:B07E		     add     al, 'A'
DOSCODE:B080		     stosb
DOSCODE:B081		     pop     ax
DOSCODE:B082		     dec     ch
DOSCODE:B084		     jnz     short bta5
DOSCODE:B086		     retn
DOSCODE:B086 BinToAscii	     endp
DOSCODE:B086
DOSCODE:B087 ; ---------------------------------------------------------------------------
DOSCODE:B087
DOSCODE:B087 $CreateTempFile:			     ; ...
DOSCODE:B087		     push    bp
DOSCODE:B088		     mov     bp, sp
DOSCODE:B08A		     sub     sp, 10
DOSCODE:B08D		     test    cx, 0FFD8h	     ; ~attr_changeable
DOSCODE:B091		     jz	     short OKatts
DOSCODE:B093		     mov     ax, 5	     ; error_access_denied
DOSCODE:B096		     jmp     short SETTMPERR
DOSCODE:B098 ; ---------------------------------------------------------------------------
DOSCODE:B098
DOSCODE:B098 OKatts:				     ; ...
DOSCODE:B098		     mov     [bp-10], cx     ; attr
DOSCODE:B09B		     mov     [bp-8], dx	     ; FilPtrL
DOSCODE:B09E		     mov     word ptr [bp-6], ds ; FilPtrH
DOSCODE:B0A1		     mov     word ptr [bp-2], ds ; EndPtrH
DOSCODE:B0A4		     push    ds
DOSCODE:B0A5		     pop     es
DOSCODE:B0A6		     mov     di, dx
DOSCODE:B0A8		     mov     cx, di
DOSCODE:B0AA		     neg     cx
DOSCODE:B0AC		     or	     cx, cx
DOSCODE:B0AE		     jnz     short okok
DOSCODE:B0B0		     mov     cx, 0FFFFh
DOSCODE:B0B3
DOSCODE:B0B3 okok:				     ; ...
DOSCODE:B0B3		     xor     ax, ax
DOSCODE:B0B5		     repne scasb
DOSCODE:B0B7		     dec     di
DOSCODE:B0B8		     mov     al, es:[di-1]
DOSCODE:B0BC		     call    PATHCHRCMP
DOSCODE:B0BF		     jz	     short SETENDPTR
DOSCODE:B0C1
DOSCODE:B0C1 STOREPTH:
DOSCODE:B0C1		     mov     al, '\'
DOSCODE:B0C3		     stosb
DOSCODE:B0C4
DOSCODE:B0C4 SETENDPTR:				     ; ...
DOSCODE:B0C4		     mov     [bp-4], di	     ; EndPtrL
DOSCODE:B0C7
DOSCODE:B0C7 CreateLoop:			     ; ...
DOSCODE:B0C7		     push    ss
DOSCODE:B0C8		     pop     ds
DOSCODE:B0C9		     push    bp
DOSCODE:B0CA		     call    READTIME
DOSCODE:B0CD		     pop     bp
DOSCODE:B0CE		     les     di, [bp-4]	     ; EndPtr
DOSCODE:B0D1		     mov     ax, cx
DOSCODE:B0D3		     call    BinToAscii
DOSCODE:B0D6		     mov     ax, dx
DOSCODE:B0D8		     call    BinToAscii
DOSCODE:B0DB		     xor     al, al
DOSCODE:B0DD		     stosb
DOSCODE:B0DE		     lds     dx, [bp-8]	     ; FilPtr
DOSCODE:B0E1		     mov     cx, [bp-10]     ; Attr
DOSCODE:B0E4		     push    bp
DOSCODE:B0E5		     call    $CreateNewFile
DOSCODE:B0E8		     pop     bp
DOSCODE:B0E9		     jnb     short CreateDone
DOSCODE:B0EB		     cmp     al, 50h	     ; error_file_exists
DOSCODE:B0ED		     jz	     short CreateLoop
DOSCODE:B0EF		     cmp     al, 5	     ; error_access_denied
DOSCODE:B0F1		     jnz     short SETTMPERR
DOSCODE:B0F3		     cmp     ss:EXTERR,	41h  ; error_net_access_denied
DOSCODE:B0F9		     jz	     short SETTMPERR
DOSCODE:B0FB		     cmp     ss:EXTERR,	53h  ; error_FAIL_I24
DOSCODE:B101		     jz	     short SETTMPERR
DOSCODE:B103		     jmp     short CreateLoop
DOSCODE:B105 ; ---------------------------------------------------------------------------
DOSCODE:B105
DOSCODE:B105 SETTMPERR:				     ; ...
DOSCODE:B105		     stc
DOSCODE:B106
DOSCODE:B106 CreateDone:			     ; ...
DOSCODE:B106		     mov     sp, bp
DOSCODE:B108		     pop     bp
DOSCODE:B109		     jb	     short CreateFail
DOSCODE:B10B		     jmp     SYS_RETURN	     ; SYS_RET_OK
DOSCODE:B10E ; ---------------------------------------------------------------------------
DOSCODE:B10E
DOSCODE:B10E CreateFail:			     ; ...
DOSCODE:B10E		     jmp     SYS_RET_ERR
DOSCODE:B111
DOSCODE:B111 ; =============== S U B R O U T I N E =======================================
DOSCODE:B111
DOSCODE:B111
DOSCODE:B111 SetAttrib	     proc near		     ; ...
DOSCODE:B111		     test    ss:FSHARING, 0FFh ; -1
DOSCODE:B117		     jnz     short Set
DOSCODE:B119		     mov     cl, ch
DOSCODE:B11B
DOSCODE:B11B Set:				     ; ...
DOSCODE:B11B		     mov     ss:SATTRIB, cl
DOSCODE:B120		     retn
DOSCODE:B120 SetAttrib	     endp
DOSCODE:B120
DOSCODE:B121 ; ---------------------------------------------------------------------------
DOSCODE:B121
DOSCODE:B121 $Extended_Open:			     ; ...
DOSCODE:B121		     mov     ss:EXTOPEN_FLAG, dx
DOSCODE:B126		     mov     ss:EXTOPEN_IO_MODE, 0
DOSCODE:B12D		     test    dx, 0FE00h	     ; RESERVED_BITS_MASK
DOSCODE:B131		     jnz     short ext_inval2
DOSCODE:B133		     mov     ah, dl
DOSCODE:B135		     cmp     dl, 0
DOSCODE:B138		     jz	     short ext_inval2
DOSCODE:B13A		     and     dl, 0Fh
DOSCODE:B13D		     cmp     dl, 2
DOSCODE:B140		     ja	     short ext_inval2
DOSCODE:B142		     and     ah, 0F0h	     ; NOT_EXISTS_MASK
DOSCODE:B145		     cmp     ah, 10h
DOSCODE:B148		     ja	     short ext_inval2
DOSCODE:B14A		     mov     ss:SAVE_ES, es
DOSCODE:B14F		     mov     ss:SAVE_DI, di
DOSCODE:B154		     push    ss:EXTOPEN_FLAG
DOSCODE:B159		     pop     ss:SAVE_DX
DOSCODE:B15E		     mov     ss:SAVE_CX, cx
DOSCODE:B163		     mov     ss:SAVE_BX, bx
DOSCODE:B168		     mov     ss:SAVE_DS, ds
DOSCODE:B16D		     mov     ss:SAVE_SI, si
DOSCODE:B172		     mov     dx, si
DOSCODE:B174		     mov     ax, bx
DOSCODE:B176		     jmp     short goopen2
DOSCODE:B178 ; ---------------------------------------------------------------------------
DOSCODE:B178
DOSCODE:B178 ext_inval2:			     ; ...
DOSCODE:B178		     mov     al, 1	     ; error_invalid_function
DOSCODE:B17A
DOSCODE:B17A eo_err:				     ; ...
DOSCODE:B17A		     jmp     short CreateFail
DOSCODE:B17C ; ---------------------------------------------------------------------------
DOSCODE:B17C		     pop     cx
DOSCODE:B17D		     pop     si
DOSCODE:B17E		     mov     al, 13	     ; error_invalid_data
DOSCODE:B180		     jmp     short eo_err
DOSCODE:B182 ; ---------------------------------------------------------------------------
DOSCODE:B182
DOSCODE:B182 error_return:			     ; ...
DOSCODE:B182		     retn
DOSCODE:B183 ; ---------------------------------------------------------------------------
DOSCODE:B183
DOSCODE:B183 goopen2:				     ; ...
DOSCODE:B183		     test    bx, 2000h
DOSCODE:B187		     jz	     short goopen
DOSCODE:B189		     or	     ss:EXTOPEN_ON, 2 ;	EXT_OPEN_I24_OFF
DOSCODE:B18F
DOSCODE:B18F goopen:				     ; ...
DOSCODE:B18F		     or	     ss:EXTOPEN_ON, 1 ;	EXT_OPEN_ON
DOSCODE:B195		     and     ss:EXTOPEN_FLAG, 0FFh
DOSCODE:B19C		     cmp     ss:EXTOPEN_FLAG, 10h ; EXT_EXISTS_FAIL+EXT_NEXISTS_CREATE
DOSCODE:B1A2		     jnz     short chknext
DOSCODE:B1A4		     call    $CreateNewFile
DOSCODE:B1A7		     jb	     short error_return
DOSCODE:B1A9		     cmp     ss:EXTOPEN_ON, 0
DOSCODE:B1AF		     jz	     short ok_return2
DOSCODE:B1B1		     mov     ss:EXTOPEN_FLAG, 2	; ACTION_CREATED_OPENED
DOSCODE:B1B8		     jmp     setXAttr
DOSCODE:B1BB ; ---------------------------------------------------------------------------
DOSCODE:B1BB
DOSCODE:B1BB ok_return2:			     ; ...
DOSCODE:B1BB		     jmp     SYS_RETURN	     ; SYS_RET_OK
DOSCODE:B1BE ; ---------------------------------------------------------------------------
DOSCODE:B1BE
DOSCODE:B1BE chknext:				     ; ...
DOSCODE:B1BE		     test    ss:EXTOPEN_FLAG, 1	; EXT_EXISTS_OPEN
DOSCODE:B1C5		     jnz     short exist_open
DOSCODE:B1C7		     call    $CREAT
DOSCODE:B1CA		     jb	     short error_return
DOSCODE:B1CC		     cmp     ss:EXTOPEN_ON, 0
DOSCODE:B1D2		     jz	     short ok_return2
DOSCODE:B1D4		     mov     ss:EXTOPEN_FLAG, 2	; ACTION_CREATED_OPENED
DOSCODE:B1DB		     test    ss:EXTOPEN_ON, 4 ;	EXT_FILE_NOT_EXISTS
DOSCODE:B1E1		     jnz     short setXAttr
DOSCODE:B1E3		     mov     ss:EXTOPEN_FLAG, 3	; ACTION_REPLACED_OPENED
DOSCODE:B1EA		     jmp     short setXAttr
DOSCODE:B1EC ; ---------------------------------------------------------------------------
DOSCODE:B1EC
DOSCODE:B1EC error_return2:			     ; ...
DOSCODE:B1EC		     stc
DOSCODE:B1ED		     retn
DOSCODE:B1EE ; ---------------------------------------------------------------------------
DOSCODE:B1EE
DOSCODE:B1EE exist_open:			     ; ...
DOSCODE:B1EE		     test    ss:FSHARING, 0FFh ; -1
DOSCODE:B1F4		     jz	     short noserver
DOSCODE:B1F6		     mov     cl, ch
DOSCODE:B1F8
DOSCODE:B1F8 noserver:				     ; ...
DOSCODE:B1F8		     call    _$Open2
DOSCODE:B1FB		     jnb     short ext_ok
DOSCODE:B1FD		     cmp     ss:EXTOPEN_ON, 0
DOSCODE:B203		     jz	     short error_return2
DOSCODE:B205		     cmp     ax, 2	     ; error_file_not_found
DOSCODE:B208		     jnz     short error_return2
DOSCODE:B20A		     test    ss:EXTOPEN_FLAG, 10h ; EXT_NEXISTS_CREATE
DOSCODE:B211		     jnz     short do_creat
DOSCODE:B213		     jmp     short extexit
DOSCODE:B215 ; ---------------------------------------------------------------------------
DOSCODE:B215
DOSCODE:B215 do_creat:				     ; ...
DOSCODE:B215		     mov     cx, ss:SAVE_CX
DOSCODE:B21A		     lds     si, dword ptr ss:SAVE_SI
DOSCODE:B21F		     mov     dx, si
DOSCODE:B221		     call    $CREAT
DOSCODE:B224		     jb	     short extexit
DOSCODE:B226		     mov     ss:EXTOPEN_FLAG, 2	; ACTION_CREATED_OPENED
DOSCODE:B22D		     jmp     short setXAttr
DOSCODE:B22F ; ---------------------------------------------------------------------------
DOSCODE:B22F
DOSCODE:B22F ext_ok:				     ; ...
DOSCODE:B22F		     cmp     ss:EXTOPEN_ON, 0
DOSCODE:B235		     jz	     short ok_return
DOSCODE:B237		     mov     ss:EXTOPEN_FLAG, 1	; ACTION_OPENED
DOSCODE:B23E
DOSCODE:B23E setXAttr:				     ; ...
DOSCODE:B23E		     push    ax
DOSCODE:B23F		     call    Get_User_Stack
DOSCODE:B242		     mov     ax, ss:EXTOPEN_FLAG
DOSCODE:B246		     mov     [si+4], ax	     ; [SI+user_env.user_CX]
DOSCODE:B249		     pop     ax
DOSCODE:B24A		     mov     [si], ax	     ; [SI+user_env.user_AX]
DOSCODE:B24C
DOSCODE:B24C ok_return:				     ; ...
DOSCODE:B24C		     jmp     SYS_RETURN	     ; SYS_RET_OK
DOSCODE:B24F ; ---------------------------------------------------------------------------
DOSCODE:B24F		     pop     bx
DOSCODE:B250		     push    ax
DOSCODE:B251		     cmp     ss:EXTOPEN_FLAG, 2	; ACTION_CREATED_OPENED
DOSCODE:B257		     jnz     short justopen
DOSCODE:B259		     lds     si, dword ptr ss:SAVE_SI
DOSCODE:B25E		     lds     dx, [si]
DOSCODE:B260		     call    $UNLINK
DOSCODE:B263		     jmp     short reserror
DOSCODE:B265 ; ---------------------------------------------------------------------------
DOSCODE:B265
DOSCODE:B265 justopen:				     ; ...
DOSCODE:B265		     call    $CLOSE
DOSCODE:B268
DOSCODE:B268 reserror:				     ; ...
DOSCODE:B268		     pop     ax
DOSCODE:B269		     jmp     short extexit
DOSCODE:B26B ; ---------------------------------------------------------------------------
DOSCODE:B26B		     mov     ax, 2	     ; error_file_not_found
DOSCODE:B26E		     jmp     short extexit
DOSCODE:B270 ; ---------------------------------------------------------------------------
DOSCODE:B270		     mov     ax, 1	     ; error_invalid_function
DOSCODE:B273
DOSCODE:B273 extexit:				     ; ...
DOSCODE:B273		     jmp     SYS_RET_ERR
DOSCODE:B276 ; ---------------------------------------------------------------------------
DOSCODE:B276
DOSCODE:B276 $LockOper:				     ; ...
DOSCODE:B276		     cmp     al, 1
DOSCODE:B278		     ja	     short lock_bad_func
DOSCODE:B27A		     push    di
DOSCODE:B27B		     call    SFFromHandle
DOSCODE:B27E		     jnb     short lock_do
DOSCODE:B280		     pop     di
DOSCODE:B281		     mov     al, 6	     ; error_invalid_handle
DOSCODE:B283
DOSCODE:B283 lockoperr:				     ; ...
DOSCODE:B283		     jmp     SYS_RET_ERR
DOSCODE:B286 ; ---------------------------------------------------------------------------
DOSCODE:B286
DOSCODE:B286 lock_bad_func:			     ; ...
DOSCODE:B286		     mov     ss:EXTERR_LOCUS, 1	; errLOC_Unk
DOSCODE:B28C		     mov     al, 1	     ; error_invalid_function
DOSCODE:B28E
DOSCODE:B28E lockoperrj:			     ; ...
DOSCODE:B28E		     jmp     short lockoperr
DOSCODE:B290 ; ---------------------------------------------------------------------------
DOSCODE:B290
DOSCODE:B290 lock_do:				     ; ...
DOSCODE:B290		     mov     bx, ax
DOSCODE:B292		     mov     bp, offset	Lock_Buffer
DOSCODE:B295		     mov     [bp+0], dx	     ; [BP+LockBuf.Lock_position]
DOSCODE:B298		     mov     [bp+2], cx	     ; [BP+LockBuf.Lock_position+2]
DOSCODE:B29B		     pop     cx
DOSCODE:B29C		     mov     [bp+4], cx	     ; [BP+LockBuf.Lock_length]
DOSCODE:B29F		     mov     [bp+6], si	     ; [BP+LockBuf.Lock_length+2]
DOSCODE:B2A2		     mov     cx, 1
DOSCODE:B2A5		     push    ss
DOSCODE:B2A6		     pop     ds
DOSCODE:B2A7		     mov     dx, bp
DOSCODE:B2A9		     test    al, 1	     ; UNLOCK_ALL
DOSCODE:B2AB		     jnz     short DOS_Unlock
DOSCODE:B2AD		     jmp     short DOS_Lock
DOSCODE:B2AF ; ---------------------------------------------------------------------------
DOSCODE:B2AF
DOSCODE:B2AF DOS_Unlock:			     ; ...
DOSCODE:B2AF		     test    byte ptr es:[di+6], 80h ; [ES:DI+SF_ENTRY.sf_flags+1],
DOSCODE:B2AF					     ; (sf_isnet>>8)
DOSCODE:B2B4		     jz	     short LOCAL_UNLOCK
DOSCODE:B2B6		     mov     ax, 110Ah
DOSCODE:B2B9		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	LOCK REGION OF FILE
DOSCODE:B2B9					     ; BX = file handle, CX:DX = starting offset, SI = high word of size
DOSCODE:B2B9					     ; STACK: WORD low word of size, ES:DI -> SFT
DOSCODE:B2B9					     ; SFT DPB field ->	DPB of drive containing	file, SS = DOS CS
DOSCODE:B2B9					     ; Return: CF set error
DOSCODE:B2BB		     jmp     short ValChk
DOSCODE:B2BD ; ---------------------------------------------------------------------------
DOSCODE:B2BD
DOSCODE:B2BD LOCAL_UNLOCK:			     ; ...
DOSCODE:B2BD		     call    ds:clr_block    ; Call far	[JShare+(7*4)] ; 7 = clr_block
DOSCODE:B2C1
DOSCODE:B2C1 ValChk:				     ; ...
DOSCODE:B2C1		     jnb     short Lock_OK
DOSCODE:B2C3		     jmp     short lockoperrj
DOSCODE:B2C5 ; ---------------------------------------------------------------------------
DOSCODE:B2C5
DOSCODE:B2C5 Lock_OK:				     ; ...
DOSCODE:B2C5		     mov     ax, ds:TEMP_VAR
DOSCODE:B2C8		     jmp     SYS_RETURN	     ; SYS_RET_OK
DOSCODE:B2CB ; ---------------------------------------------------------------------------
DOSCODE:B2CB
DOSCODE:B2CB DOS_Lock:				     ; ...
DOSCODE:B2CB		     test    byte ptr es:[di+6], 80h
DOSCODE:B2D0		     jz	     short LOCAL_LOCK
DOSCODE:B2D2		     mov     ax, 110Ah
DOSCODE:B2D5		     int     2Fh	     ; Multiplex - NETWORK REDIRECTOR -	LOCK REGION OF FILE
DOSCODE:B2D5					     ; BX = file handle, CX:DX = starting offset, SI = high word of size
DOSCODE:B2D5					     ; STACK: WORD low word of size, ES:DI -> SFT
DOSCODE:B2D5					     ; SFT DPB field ->	DPB of drive containing	file, SS = DOS CS
DOSCODE:B2D5					     ; Return: CF set error
DOSCODE:B2D7		     jmp     short ValChk
DOSCODE:B2D9 ; ---------------------------------------------------------------------------
DOSCODE:B2D9
DOSCODE:B2D9 LOCAL_LOCK:			     ; ...
DOSCODE:B2D9		     call    ds:set_block    ; Call far	[JShare+(6*4)] ; 6 = Set_Block
DOSCODE:B2DD		     jmp     short ValChk
DOSCODE:B2DF
DOSCODE:B2DF ; =============== S U B R O U T I N E =======================================
DOSCODE:B2DF
DOSCODE:B2DF
DOSCODE:B2DF LOCK_CHECK	     proc near		     ; ...
DOSCODE:B2DF		     mov     bx, ds:RetryCount
DOSCODE:B2E3
DOSCODE:B2E3 LockRetry:				     ; ...
DOSCODE:B2E3		     push    bx
DOSCODE:B2E4		     push    ax
DOSCODE:B2E5		     call    ds:chk_block    ; Call far	[JShare+(8*4)] ; 8 = chk_block
DOSCODE:B2E9		     pop     ax
DOSCODE:B2EA		     pop     bx
DOSCODE:B2EB		     jnb     short lc_ret_label
DOSCODE:B2ED		     call    Idle
DOSCODE:B2F0		     dec     bx
DOSCODE:B2F1		     jnz     short LockRetry
DOSCODE:B2F3		     stc
DOSCODE:B2F4
DOSCODE:B2F4 lc_ret_label:			     ; ...
DOSCODE:B2F4		     retn
DOSCODE:B2F4 LOCK_CHECK	     endp
DOSCODE:B2F4
DOSCODE:B2F5
DOSCODE:B2F5 ; =============== S U B R O U T I N E =======================================
DOSCODE:B2F5
DOSCODE:B2F5
DOSCODE:B2F5 LOCK_VIOLATION  proc near		     ; ...
DOSCODE:B2F5		     push    ds
DOSCODE:B2F6		     push    es
DOSCODE:B2F7		     push    di
DOSCODE:B2F8		     push    cx
DOSCODE:B2F9		     mov     ax, 21h	     ; error_lock_violation
DOSCODE:B2FC		     mov     ds:ALLOWED, 18h ; Allowed_FAIL+Allowed_RETRY
DOSCODE:B301		     les     bp, ds:THISDPB
DOSCODE:B305		     mov     di, 1
DOSCODE:B308		     mov     cx, di
DOSCODE:B30A		     mov     dx, es:[bp+11]  ; [ES:BP+DPB.FIRST_SECTOR]
DOSCODE:B30E		     call    HARDERR
DOSCODE:B311		     pop     cx
DOSCODE:B312		     pop     di
DOSCODE:B313		     pop     es
DOSCODE:B314		     pop     ds
DOSCODE:B315		     cmp     al, 1
DOSCODE:B317		     jz	     short lc_ret_label
DOSCODE:B319		     stc
DOSCODE:B31A		     retn
DOSCODE:B31A LOCK_VIOLATION  endp
DOSCODE:B31A
DOSCODE:B31B
DOSCODE:B31B ; =============== S U B R O U T I N E =======================================
DOSCODE:B31B
DOSCODE:B31B
DOSCODE:B31B CheckShare	     proc near		     ; ...
DOSCODE:B31B		     push    ds
DOSCODE:B31C		     mov     ds, cs:DosDSeg
DOSCODE:B321		     cmp     ds:fShare,	0
DOSCODE:B326		     pop     ds
DOSCODE:B327		     retn
DOSCODE:B327 CheckShare	     endp
DOSCODE:B327
DOSCODE:B328
DOSCODE:B328 ; =============== S U B R O U T I N E =======================================
DOSCODE:B328
DOSCODE:B328
DOSCODE:B328 SHARE_CHECK     proc near		     ; ...
DOSCODE:B328		     call    ds:MFT_enter    ; call far	[JShare+(1*4)] ; 1 = MFT_Enter
DOSCODE:B32C
DOSCODE:B32C shchk_retn:			     ; ...
DOSCODE:B32C		     retn
DOSCODE:B32C SHARE_CHECK     endp
DOSCODE:B32C
DOSCODE:B32D
DOSCODE:B32D ; =============== S U B R O U T I N E =======================================
DOSCODE:B32D
DOSCODE:B32D
DOSCODE:B32D SHARE_VIOLATION proc near		     ; ...
DOSCODE:B32D		     push    ds
DOSCODE:B32E		     push    es
DOSCODE:B32F		     push    di
DOSCODE:B330		     mov     ds:READOP,	0
DOSCODE:B335		     mov     ds:ALLOWED, 18h ; Allowed_FAIL+Allowed_RETRY
DOSCODE:B33A		     les     bp, ds:THISDPB
DOSCODE:B33E		     mov     di, 1
DOSCODE:B341		     mov     cx, di
DOSCODE:B343		     mov     dx, es:[bp+17]  ; [ES:BP+DPB.DIR_SECTOR]
DOSCODE:B347		     call    HARDERR
DOSCODE:B34A		     pop     di
DOSCODE:B34B		     pop     es
DOSCODE:B34C		     pop     ds
DOSCODE:B34D		     cmp     al, 1
DOSCODE:B34F		     jz	     short shchk_retn
DOSCODE:B351		     stc
DOSCODE:B352		     retn
DOSCODE:B352 SHARE_VIOLATION endp
DOSCODE:B352
DOSCODE:B353
DOSCODE:B353 ; =============== S U B R O U T I N E =======================================
DOSCODE:B353
DOSCODE:B353
DOSCODE:B353 ShareEnd	     proc near		     ; ...
DOSCODE:B353		     call    ds:MFTClose     ; call far	[JShare+(2*4)] ; 2 = MFTClose
DOSCODE:B357		     retn
DOSCODE:B357 ShareEnd	     endp
DOSCODE:B357
DOSCODE:B358
DOSCODE:B358 ; =============== S U B R O U T I N E =======================================
DOSCODE:B358
DOSCODE:B358
DOSCODE:B358 ShareEnter	     proc near		     ; ...
DOSCODE:B358		     push    cx
DOSCODE:B359
DOSCODE:B359 retry:				     ; ...
DOSCODE:B359		     mov     cx, ds:RetryCount
DOSCODE:B35D
DOSCODE:B35D attempt:				     ; ...
DOSCODE:B35D		     les     di, ds:THISSFT
DOSCODE:B361		     xor     ax, ax
DOSCODE:B363		     mov     es:[di+51], ax  ; [ES:DI+SF_ENTRY.sf_MFT]
DOSCODE:B367		     push    cx
DOSCODE:B368		     call    SHARE_CHECK
DOSCODE:B36B		     pop     cx
DOSCODE:B36C		     jnb     short done
DOSCODE:B36E		     call    Idle
DOSCODE:B371		     loop    attempt
DOSCODE:B373		     call    SHARE_VIOLATION
DOSCODE:B376		     jnb     short retry
DOSCODE:B378
DOSCODE:B378 done:				     ; ...
DOSCODE:B378		     pop     cx
DOSCODE:B379		     retn
DOSCODE:B379 ShareEnter	     endp
DOSCODE:B379
DOSCODE:B37A
DOSCODE:B37A ; =============== S U B R O U T I N E =======================================
DOSCODE:B37A
DOSCODE:B37A
DOSCODE:B37A ExecReady	     proc near		     ; ...
DOSCODE:B37A		     mov     si, dx
DOSCODE:B37C		     test    word ptr [si+2], 1	; [si+ERStruc.ER_Flags],ER_EXE
DOSCODE:B381		     jz	     short er_setver
DOSCODE:B383		     mov     ax, [si+8]	     ; [si+ERStruc.ER_PSP]
DOSCODE:B386		     add     ax, 10h
DOSCODE:B389		     mov     es, ax
DOSCODE:B38B		     mov     cx, [si+10]     ; [si+ERStruc.ER_StartAddr]
DOSCODE:B38E		     mov     ax, [si+12]     ; [si+ERStruc.ER_StartAddr+2]
DOSCODE:B391		     call    ss:FixExePatch
DOSCODE:B396
DOSCODE:B396 er_setver:				     ; ...
DOSCODE:B396		     test    word ptr [si+2], 2	; [si+ERStruc.ER_Flags],ER_OVERLAY
DOSCODE:B39B		     jnz     short er_chkdoshi
DOSCODE:B39D		     push    ds
DOSCODE:B39E		     push    si
DOSCODE:B39F		     lds     si, [si+4]	     ; [si+ERStruc.ER_ProgName]
DOSCODE:B3A2		     call    Save_Begin	     ; call Scan_Execname1
DOSCODE:B3A5		     call    Scan_Special_Entries
DOSCODE:B3A8		     pop     si
DOSCODE:B3A9		     pop     ds
DOSCODE:B3AA		     mov     es, word ptr [si+8] ; [si+ERStruc.ER_PSP]
DOSCODE:B3AD		     mov     ax, ss:SPECIAL_VERSION
DOSCODE:B3B1		     mov     word ptr es:SFTFCB, ax ; [es:PDB.Version]
DOSCODE:B3B5
DOSCODE:B3B5 er_chkdoshi:			     ; ...
DOSCODE:B3B5		     cmp     ss:DosHasHMA, 0
DOSCODE:B3BB		     jz	     short er_done
DOSCODE:B3BD		     mov     ax, [si+8]	     ; [si+ERStruc.ER_PSP]
DOSCODE:B3C0		     or	     ss:DOS_FLAG, 4
DOSCODE:B3C6		     test    word ptr [si+2], 1	; EXECA20OFF
DOSCODE:B3CB		     jnz     short er_setA20
DOSCODE:B3CD		     push    ds
DOSCODE:B3CE		     mov     ds, ax
DOSCODE:B3D0		     call    IsCopyProt
DOSCODE:B3D3		     pop     ds
DOSCODE:B3D4
DOSCODE:B3D4 er_setA20:				     ; ...
DOSCODE:B3D4		     inc     ss:A20OFF_COUNT
DOSCODE:B3D9		     mov     ss:A20OFF_PSP, ax
DOSCODE:B3DD
DOSCODE:B3DD er_done:				     ; ...
DOSCODE:B3DD		     xor     ax, ax
DOSCODE:B3DF		     retn
DOSCODE:B3DF ExecReady	     endp
DOSCODE:B3DF
DOSCODE:B3DF ; ---------------------------------------------------------------------------
DOSCODE:B3E0 exepatch_start  db	6		     ; ...
DOSCODE:B3E1		     db	8Ch,0D8h
DOSCODE:B3E3 _first_stop     db	2Bh,0C2h
DOSCODE:B3E5		     db	8Eh,0D8h
DOSCODE:B3E7		     db	8Eh,0C0h
DOSCODE:B3E9		     db	0BFh,0Fh,0
DOSCODE:B3EC		     db	57h
DOSCODE:B3ED		     db	0B9h,10h,0
DOSCODE:B3F0		     db	0B0h,0FFh
DOSCODE:B3F2		     db	0F3h,0AEh
DOSCODE:B3F4		     db	47h
DOSCODE:B3F5		     db	8Bh,0F7h
DOSCODE:B3F7		     db	5Fh,58h
DOSCODE:B3F9 _second_stop    db	2Bh,0C2h
DOSCODE:B3FB second	     db	8Eh,0C0h
DOSCODE:B3FD		     db	0B9h,4,2
DOSCODE:B400		     db	8Bh,0C6h
DOSCODE:B402		     db	0F7h,0D0h
DOSCODE:B404		     db	0D3h,0E8h
DOSCODE:B406		     db	74h,13h
DOSCODE:B408		     db	8Ch,0DAh
DOSCODE:B40A		     db	83h,0CEh,0F0h
DOSCODE:B40D		     db	2Bh,0D0h
DOSCODE:B40F		     db	73h,8
DOSCODE:B411		     db	0F7h,0DAh
DOSCODE:B413		     db	0D3h,0E2h
DOSCODE:B415		     db	2Bh,0F2h
DOSCODE:B417		     db	33h,0D2h
DOSCODE:B419		     db	8Eh,0DAh
DOSCODE:B41B		     db	87h,0F7h
DOSCODE:B41D		     db	1Eh
DOSCODE:B41E		     db	6
DOSCODE:B41F		     db	1Fh
DOSCODE:B420		     db	7
DOSCODE:B421		     db	0FEh,0CDh
DOSCODE:B423		     db	75h,0DBh
DOSCODE:B425		     db	0ACh
DOSCODE:B426		     db	92h
DOSCODE:B427		     db	4Eh
DOSCODE:B428		     db	0ADh
DOSCODE:B429		     db	8Bh,0C8h
DOSCODE:B42B		     db	46h
DOSCODE:B42C		     db	8Ah,0C2h
DOSCODE:B42E		     db	24h,0FEh
DOSCODE:B430		     db	3Ch,0B0h
DOSCODE:B432		     db	75h,5
DOSCODE:B434		     db	0ACh
DOSCODE:B435		     db	0F3h,0AAh
DOSCODE:B437		     db	0EBh,6
DOSCODE:B439		     db	3Ch,0B2h
DOSCODE:B43B		     db	75h,6Ch
DOSCODE:B43D		     db	0F3h,0A4h
DOSCODE:B43F		     db	92h
DOSCODE:B440		     db	0A8h,1
DOSCODE:B442		     db	74h,0B9h
DOSCODE:B444		     db	90h,90h
DOSCODE:B446 scan_patch1     db	8Ch,0C3h	     ; ...
DOSCODE:B448		     db	8Ch,0D8h
DOSCODE:B44A		     db	2Bh,0C2h
DOSCODE:B44C		     db	8Eh,0D8h
DOSCODE:B44E		     db	8Eh,0C0h
DOSCODE:B450		     db	0BFh,0Fh,0
DOSCODE:B453		     db	0B9h,10h,0
DOSCODE:B456		     db	0B0h,0FFh
DOSCODE:B458		     db	0F3h,0AEh
DOSCODE:B45A		     db	47h
DOSCODE:B45B		     db	8Bh,0F7h
DOSCODE:B45D		     db	8Bh,0C3h
DOSCODE:B45F		     db	2Bh,0C2h
DOSCODE:B461		     db	8Eh,0C0h
DOSCODE:B463		     db	0BFh,0Fh,0
DOSCODE:B466		     db	0B1h,4
DOSCODE:B468		     db	8Bh,0C6h
DOSCODE:B46A		     db	0F7h,0D0h
DOSCODE:B46C		     db	0D3h,0E8h
DOSCODE:B46E		     db	74h,9
DOSCODE:B470		     db	8Ch,0DAh
DOSCODE:B472		     db	2Bh,0D0h
DOSCODE:B474		     db	8Eh,0DAh
DOSCODE:B476		     db	83h,0CEh,0F0h
DOSCODE:B479		     db	8Bh,0C7h
DOSCODE:B47B		     db	0F7h,0D0h
DOSCODE:B47D		     db	0D3h,0E8h
DOSCODE:B47F		     db	74h,9
DOSCODE:B481		     db	8Ch,0C2h
DOSCODE:B483		     db	2Bh,0D0h
DOSCODE:B485		     db	8Eh,0C2h
DOSCODE:B487		     db	83h,0CFh,0F0h
DOSCODE:B48A scan_patch2     db	8Ch,0C3h	     ; ...
DOSCODE:B48C		     db	8Ch,0D8h
DOSCODE:B48E		     db	48h
DOSCODE:B48F		     db	8Eh,0D8h
DOSCODE:B491		     db	8Eh,0C0h
DOSCODE:B493		     db	0BFh,0Fh,0
DOSCODE:B496		     db	0B9h,10h,0
DOSCODE:B499		     db	0B0h,0FFh
DOSCODE:B49B		     db	0F3h,0AEh
DOSCODE:B49D		     db	47h
DOSCODE:B49E		     db	8Bh,0F7h
DOSCODE:B4A0		     db	8Bh,0C3h
DOSCODE:B4A2		     db	48h
DOSCODE:B4A3		     db	8Eh,0C0h
DOSCODE:B4A5		     db	0BFh,0Fh,0
DOSCODE:B4A8		     db	0B1h,4
DOSCODE:B4AA		     db	8Bh,0C6h
DOSCODE:B4AC		     db	0F7h,0D0h
DOSCODE:B4AE		     db	0D3h,0E8h
DOSCODE:B4B0		     db	74h,0Ah
DOSCODE:B4B2		     db	8Ch,0DAh
DOSCODE:B4B4		     db	2Bh,0D0h
DOSCODE:B4B6		     db	8Eh,0DAh
DOSCODE:B4B8		     db	81h,0CEh,0F0h,0FFh
DOSCODE:B4BC		     db	8Bh,0C7h
DOSCODE:B4BE		     db	0F7h,0D0h
DOSCODE:B4C0		     db	0D3h,0E8h
DOSCODE:B4C2		     db	74h,0Ah
DOSCODE:B4C4		     db	8Ch,0C2h
DOSCODE:B4C6		     db	2Bh,0D0h
DOSCODE:B4C8		     db	8Eh,0C2h
DOSCODE:B4CA		     db	81h,0CFh,0F0h,0FFh
DOSCODE:B4CE scan_patch3     db	8Ch,0C3h	     ; ...
DOSCODE:B4D0		     db	8Ch,0D8h
DOSCODE:B4D2		     db	48h
DOSCODE:B4D3		     db	8Eh,0D8h
DOSCODE:B4D5		     db	8Eh,0C0h
DOSCODE:B4D7		     db	0BFh,0Fh,0
DOSCODE:B4DA		     db	0B9h,10h,0
DOSCODE:B4DD		     db	0B0h,0FFh
DOSCODE:B4DF		     db	0F3h,0AEh
DOSCODE:B4E1		     db	47h
DOSCODE:B4E2		     db	8Bh,0F7h
DOSCODE:B4E4		     db	8Bh,0C3h
DOSCODE:B4E6		     db	48h
DOSCODE:B4E7		     db	8Eh,0C0h
DOSCODE:B4E9		     db	0BFh,0Fh,0
DOSCODE:B4EC		     db	0B1h,4
DOSCODE:B4EE		     db	8Bh,0C6h
DOSCODE:B4F0		     db	0F7h,0D0h
DOSCODE:B4F2		     db	0D3h,0E8h
DOSCODE:B4F4		     db	74h,9
DOSCODE:B4F6		     db	8Ch,0DAh
DOSCODE:B4F8		     db	2Bh,0D0h
DOSCODE:B4FA		     db	8Eh,0DAh
DOSCODE:B4FC		     db	83h,0CEh,0F0h
DOSCODE:B4FF		     db	8Bh,0C7h
DOSCODE:B501		     db	0F7h,0D0h
DOSCODE:B503		     db	0D3h,0E8h
DOSCODE:B505		     db	74h,9
DOSCODE:B507		     db	8Ch,0C2h
DOSCODE:B509		     db	2Bh,0D0h
DOSCODE:B50B		     db	8Eh,0C2h
DOSCODE:B50D		     db	83h,0CFh,0F0h
DOSCODE:B510 scan_com	     db	0ACh		     ; ...
DOSCODE:B511		     db	8Ah,0D0h
DOSCODE:B513		     db	4Eh
DOSCODE:B514		     db	0ADh
DOSCODE:B515		     db	8Bh,0C8h
DOSCODE:B517		     db	46h
DOSCODE:B518		     db	8Ah,0C2h
DOSCODE:B51A		     db	24h,0FEh
DOSCODE:B51C		     db	3Ch,0B0h
DOSCODE:B51E		     db	75h,6
DOSCODE:B520		     db	0ACh
DOSCODE:B521		     db	0F3h,0AAh
DOSCODE:B523		     db	0EBh,7,90h
DOSCODE:B526		     db	3Ch,0B2h
DOSCODE:B528		     db	75h,6Bh
DOSCODE:B52A		     db	0F3h,0A4h
DOSCODE:B52C		     db	8Ah,0C2h
DOSCODE:B52E		     db	0A8h,1
DOSCODE:B530
DOSCODE:B530 ; =============== S U B R O U T I N E =======================================
DOSCODE:B530
DOSCODE:B530
DOSCODE:B530 ExePatch	     proc near		     ; ...
DOSCODE:B530		     call    ExePackPatch
DOSCODE:B533		     call    ss:RationalPatchPtr
DOSCODE:B538		     retn
DOSCODE:B538 ExePatch	     endp
DOSCODE:B538
DOSCODE:B539
DOSCODE:B539 ; =============== S U B R O U T I N E =======================================
DOSCODE:B539
DOSCODE:B539
DOSCODE:B539 ExePackPatch    proc near		     ; ...
DOSCODE:B539		     push    bx
DOSCODE:B53A		     mov     bx, es
DOSCODE:B53C		     cmp     bx, 0FFFh
DOSCODE:B540		     jbe     short ep_cont
DOSCODE:B542		     pop     bx
DOSCODE:B543		     retn
DOSCODE:B544 ; ---------------------------------------------------------------------------
DOSCODE:B544
DOSCODE:B544 ep_cont:				     ; ...
DOSCODE:B544		     push    ds
DOSCODE:B545		     push    es
DOSCODE:B546		     push    ax
DOSCODE:B547		     push    cx
DOSCODE:B548		     push    si
DOSCODE:B549		     push    di
DOSCODE:B54A		     sub     cx, 2
DOSCODE:B54D		     jnb     short epp_1
DOSCODE:B54F		     jmp     ep_notpacked
DOSCODE:B552 ; ---------------------------------------------------------------------------
DOSCODE:B552
DOSCODE:B552 epp_1:				     ; ...
DOSCODE:B552		     mov     di, cx
DOSCODE:B554		     mov     es, ax
DOSCODE:B556		     assume ds:nothing
DOSCODE:B556		     mov     ss:UNPACK_OFFSET, di
DOSCODE:B55B		     cmp     word ptr es:[di], 4252h ; 'RB'
DOSCODE:B560		     jz	     short epp_2
DOSCODE:B562		     jmp     ep_notpacked
DOSCODE:B565 ; ---------------------------------------------------------------------------
DOSCODE:B565
DOSCODE:B565 epp_2:				     ; ...
DOSCODE:B565		     push    cs
DOSCODE:B566		     pop     ds
DOSCODE:B567		     assume ds:nothing
DOSCODE:B567		     add     di, 6Ch	     ; PATCH1_COM_OFFSET
DOSCODE:B56A		     call    chk_common_str
DOSCODE:B56D		     jnz     short ep_chkpatch2
DOSCODE:B56F		     mov     si, offset	scan_patch1
DOSCODE:B572		     mov     di, ss:UNPACK_OFFSET
DOSCODE:B577		     add     di, 28h	     ; PATCH1_OFFSET
DOSCODE:B57A		     mov     cx, 68	     ; size_scan_patch1
DOSCODE:B57A					     ; = scan_patch2 - scan_patch1
DOSCODE:B57D		     mov     bx, 142
DOSCODE:B580		     mov     ax, 0EF4Eh	     ; PATCH1_CHKSUM
DOSCODE:B583		     call    chk_patchsum
DOSCODE:B586		     jb	     short ep_done1
DOSCODE:B588		     mov     si, offset	exepatch_start ; str1
DOSCODE:B58B		     mov     cx, 102
DOSCODE:B58E		     rep movsb
DOSCODE:B590
DOSCODE:B590 ep_done1:				     ; ...
DOSCODE:B590		     jmp     ep_notpacked    ; ep_done
DOSCODE:B593 ; ---------------------------------------------------------------------------
DOSCODE:B593
DOSCODE:B593 ep_chkpatch2:			     ; ...
DOSCODE:B593		     mov     di, 76h	     ; PATCH2_COM_OFFSET
DOSCODE:B596		     call    chk_common_str
DOSCODE:B599		     jnz     short ep_chkpatch3
DOSCODE:B59B		     mov     si, offset	scan_patch2
DOSCODE:B59E		     mov     di, 32h	     ; PATCH2_OFFSET
DOSCODE:B5A1		     mov     cx, 68	     ; size_scan_patch2
DOSCODE:B5A4		     mov     bx, 140	     ; CHKSUM2_LEN
DOSCODE:B5A7		     mov     ax, 78B2h	     ; PATCH2_CHKSUM
DOSCODE:B5AA		     call    chk_patchsum
DOSCODE:B5AD		     jnb     short ep_patchcode2
DOSCODE:B5AF		     mov     si, offset	scan_patch2
DOSCODE:B5B2		     mov     cx, 68	     ; size_scan_patch2
DOSCODE:B5B2					     ; = scan_patch3 - scan_patch2
DOSCODE:B5B5		     mov     bx, 129	     ; CHKSUM2A_LEN
DOSCODE:B5B8		     mov     ax, 1C47h	     ; PATCH2A_CHKSUM
DOSCODE:B5BB		     call    chk_patchsum
DOSCODE:B5BE		     jb	     short ep_notpacked
DOSCODE:B5C0
DOSCODE:B5C0 ep_patchcode2:			     ; ...
DOSCODE:B5C0		     mov     si, offset	exepatch_start ; str1
DOSCODE:B5C3		     mov     cx, 3	     ; first_stop =
DOSCODE:B5C3					     ; _first_stop - exepact_start (str1)
DOSCODE:B5C6		     rep movsb
DOSCODE:B5C8		     mov     ax, 4890h	     ; dec ax, nop
DOSCODE:B5CB		     stosw
DOSCODE:B5CC		     add     si, 2
DOSCODE:B5CF		     mov     cx, 20	     ; second_stop =
DOSCODE:B5CF					     ; _secondstop - _first_stop
DOSCODE:B5D2		     rep movsb
DOSCODE:B5D4		     stosw		     ; dec ax, nop
DOSCODE:B5D5		     add     si, 2
DOSCODE:B5D8		     mov     cx, 75	     ; last_stop =
DOSCODE:B5D8					     ; scan_patch1 - second
DOSCODE:B5DB		     rep movsb
DOSCODE:B5DD		     jmp     short ep_notpacked	; ep_done
DOSCODE:B5DF ; ---------------------------------------------------------------------------
DOSCODE:B5DF
DOSCODE:B5DF ep_chkpatch3:			     ; ...
DOSCODE:B5DF		     mov     di, 74h	     ; PATCH3_COM_OFFSET
DOSCODE:B5E2		     call    chk_common_str
DOSCODE:B5E5		     jnz     short ep_notpacked
DOSCODE:B5E7		     mov     si, offset	scan_patch3
DOSCODE:B5EA		     mov     di, 32h	     ; PATCH3_OFFSET
DOSCODE:B5ED		     mov     cx, 66	     ; size_scan_patch3
DOSCODE:B5ED					     ; = scan_com - scan_patch3
DOSCODE:B5F0		     mov     bx, 139	     ; CHKSUM3_LEN
DOSCODE:B5F3		     mov     ax, 4EDEh	     ; PATCH3_CHKSUM
DOSCODE:B5F6		     call    chk_patchsum
DOSCODE:B5F9		     jb	     short ep_notpacked
DOSCODE:B5FB		     mov     si, offset	exepatch_start ; str1
DOSCODE:B5FE		     mov     cx, 3	     ; first_stop
DOSCODE:B601		     rep movsb
DOSCODE:B603		     mov     al, 48h	     ; dec ax
DOSCODE:B605		     stosb
DOSCODE:B606		     add     si, 2
DOSCODE:B609		     mov     cx, 20	     ; second_stop
DOSCODE:B60C		     rep movsb
DOSCODE:B60E		     stosb		     ; dec ax
DOSCODE:B60F		     add     si, 2
DOSCODE:B612		     mov     cx, 75	     ; last_stop
DOSCODE:B615		     rep movsb
DOSCODE:B617
DOSCODE:B617 ep_notpacked:			     ; ...
DOSCODE:B617		     pop     di
DOSCODE:B618		     pop     si
DOSCODE:B619		     pop     cx
DOSCODE:B61A		     pop     ax
DOSCODE:B61B		     pop     es
DOSCODE:B61C		     pop     ds
DOSCODE:B61D		     pop     bx
DOSCODE:B61E		     retn
DOSCODE:B61E ExePackPatch    endp
DOSCODE:B61E
DOSCODE:B61F
DOSCODE:B61F ; =============== S U B R O U T I N E =======================================
DOSCODE:B61F
DOSCODE:B61F
DOSCODE:B61F chk_common_str  proc near		     ; ...
DOSCODE:B61F		     mov     si, offset	scan_com
DOSCODE:B622		     mov     cx, 32	     ; size_scan_com
DOSCODE:B622					     ; = offset	ExePatch - offset scan_com
DOSCODE:B625		     repe cmpsb
DOSCODE:B627		     jz	     short ccs_done
DOSCODE:B629		     cmp     byte ptr es:[di-1], 56h
DOSCODE:B62E		     jnz     short ccs_done
DOSCODE:B630		     repe cmpsb
DOSCODE:B632
DOSCODE:B632 ccs_done:				     ; ...
DOSCODE:B632		     retn
DOSCODE:B632 chk_common_str  endp
DOSCODE:B632
DOSCODE:B633 ; ---------------------------------------------------------------------------
DOSCODE:B633
DOSCODE:B633 chk_patchsum:			     ; ...
DOSCODE:B633		     push    di
DOSCODE:B634		     repe cmpsb
DOSCODE:B636		     jnz     short cp_fail
DOSCODE:B638		     mov     di, ss:UNPACK_OFFSET
DOSCODE:B63D		     mov     cx, bx
DOSCODE:B63F		     mov     bx, ax
DOSCODE:B641		     xor     ax, ax
DOSCODE:B643
DOSCODE:B643 ep_chksum:				     ; ...
DOSCODE:B643		     add     ax, es:[di]
DOSCODE:B646		     add     di, 2
DOSCODE:B649		     loop    ep_chksum
DOSCODE:B64B		     pop     di
DOSCODE:B64C		     cmp     ax, bx
DOSCODE:B64E		     jnz     short cp_fail
DOSCODE:B650		     clc
DOSCODE:B651		     retn
DOSCODE:B652 ; ---------------------------------------------------------------------------
DOSCODE:B652
DOSCODE:B652 cp_fail:				     ; ...
DOSCODE:B652		     stc
DOSCODE:B653		     retn
DOSCODE:B653 ; ---------------------------------------------------------------------------
DOSCODE:B654 RScanPattern1   db	0, 0, 20h, 0, 0, 0, 40h, 0, 1, 0 ; ...
DOSCODE:B65E RScanPattern2   db	8Bh, 0Eh, 10h, 0, 90h, 0E2h, 0FEh, 0E8h	; ...
DOSCODE:B666 RScanPattern3   db	8Bh, 0Eh, 10h, 0, 0E2h,	0FEh, 0E8h ; ...
DOSCODE:B66D
DOSCODE:B66D ; =============== S U B R O U T I N E =======================================
DOSCODE:B66D
DOSCODE:B66D
DOSCODE:B66D RationalPatch   proc near		     ; ...
DOSCODE:B66D		     cld
DOSCODE:B66E		     push    ax
DOSCODE:B66F		     push    bx
DOSCODE:B670		     push    cx
DOSCODE:B671		     push    dx
DOSCODE:B672		     push    si
DOSCODE:B673		     push    di
DOSCODE:B674		     push    es
DOSCODE:B675		     push    ds
DOSCODE:B676		     mov     di, 0Ah
DOSCODE:B679		     push    cs
DOSCODE:B67A		     pop     ds
DOSCODE:B67B		     mov     si, offset	RScanPattern1
DOSCODE:B67E		     mov     cx, 10	     ; RLen1
DOSCODE:B681		     repe cmpsb
DOSCODE:B683		     jnz     short rpexit
DOSCODE:B685		     mov     ax, es:0
DOSCODE:B689		     cmp     ax, 348
DOSCODE:B68C		     jb	     short rpexit
DOSCODE:B68E		     cmp     ax, 383
DOSCODE:B691		     ja	     short rpexit
DOSCODE:B693		     call    VerifyVersion
DOSCODE:B696		     jnz     short rpexit
DOSCODE:B698		     mov     cx, es:16h
DOSCODE:B69D		     sub     cx, 200h
DOSCODE:B6A1		     mov     es, word ptr es:20h
DOSCODE:B6A6		     mov     si, offset	RScanPattern2
DOSCODE:B6A9		     mov     dx, 8	     ; RLen2
DOSCODE:B6AC		     call    ScanCodeSeq
DOSCODE:B6AF		     jz	     short rpfound
DOSCODE:B6B1		     mov     si, offset	RScanPattern3
DOSCODE:B6B4		     mov     dx, 15	     ; RLen3
DOSCODE:B6B7		     call    ScanCodeSeq
DOSCODE:B6BA		     jnz     short rpexit
DOSCODE:B6BC
DOSCODE:B6BC rpfound:				     ; ...
DOSCODE:B6BC		     mov     al, 9Ah	     ; far call	opcode
DOSCODE:B6BE		     stosb
DOSCODE:B6BF		     mov     ax, offset	RatBugCode
DOSCODE:B6C2		     stosw
DOSCODE:B6C3		     mov     ax, ss
DOSCODE:B6C5		     stosw
DOSCODE:B6C6		     mov     cx, dx
DOSCODE:B6C8		     sub     cx, 6
DOSCODE:B6CB		     mov     al, 90h	     ; NOPs
DOSCODE:B6CD		     rep stosb
DOSCODE:B6CF
DOSCODE:B6CF rpexit:				     ; ...
DOSCODE:B6CF		     pop     ds
DOSCODE:B6D0		     pop     es
DOSCODE:B6D1		     pop     di
DOSCODE:B6D2		     pop     si
DOSCODE:B6D3		     pop     dx
DOSCODE:B6D4		     pop     cx
DOSCODE:B6D5		     pop     bx
DOSCODE:B6D6		     pop     ax
DOSCODE:B6D7		     retn
DOSCODE:B6D7 RationalPatch   endp
DOSCODE:B6D7
DOSCODE:B6D8
DOSCODE:B6D8 ; =============== S U B R O U T I N E =======================================
DOSCODE:B6D8
DOSCODE:B6D8
DOSCODE:B6D8 ScanCodeSeq     proc near		     ; ...
DOSCODE:B6D8		     push    cx
DOSCODE:B6D9		     sub     cx, dx
DOSCODE:B6DB		     inc     cx
DOSCODE:B6DC		     mov     di, 200h
DOSCODE:B6DF
DOSCODE:B6DF scsagain:				     ; ...
DOSCODE:B6DF		     push    si
DOSCODE:B6E0		     push    di
DOSCODE:B6E1		     push    cx
DOSCODE:B6E2		     mov     cx, dx
DOSCODE:B6E4		     repe cmpsb
DOSCODE:B6E6		     pop     cx
DOSCODE:B6E7		     pop     di
DOSCODE:B6E8		     pop     si
DOSCODE:B6E9		     jz	     short scsfound
DOSCODE:B6EB		     inc     di
DOSCODE:B6EC		     loop    scsagain
DOSCODE:B6EE
DOSCODE:B6EE scsfound:				     ; ...
DOSCODE:B6EE		     pop     cx
DOSCODE:B6EF		     retn
DOSCODE:B6EF ScanCodeSeq     endp
DOSCODE:B6EF
DOSCODE:B6F0
DOSCODE:B6F0 ; =============== S U B R O U T I N E =======================================
DOSCODE:B6F0
DOSCODE:B6F0
DOSCODE:B6F0 VerifyVersion   proc near		     ; ...
DOSCODE:B6F0		     mov     si, es:2Ah
DOSCODE:B6F5		     mov     bl, 10
DOSCODE:B6F7		     add     si, 3
DOSCODE:B6FA		     call    VVDigit
DOSCODE:B6FD		     jnz     short vvexit
DOSCODE:B6FF		     call    VVDigit
DOSCODE:B702		     jnz     short vvexit
DOSCODE:B704		     cmp     byte ptr es:[si], '.' ; 2Eh
DOSCODE:B708		     jnz     short vvexit
DOSCODE:B70A		     dec     si
DOSCODE:B70B		     call    VVDigit
DOSCODE:B70E
DOSCODE:B70E vvexit:				     ; ...
DOSCODE:B70E		     retn
DOSCODE:B70E VerifyVersion   endp
DOSCODE:B70E
DOSCODE:B70F
DOSCODE:B70F ; =============== S U B R O U T I N E =======================================
DOSCODE:B70F
DOSCODE:B70F
DOSCODE:B70F VVDigit	     proc near		     ; ...
DOSCODE:B70F		     div     bl
DOSCODE:B711		     add     ah, '0'         ; 30h
DOSCODE:B714		     dec     si
DOSCODE:B715		     cmp     es:[si+1],	ah
DOSCODE:B719		     mov     ah, 0
DOSCODE:B71B		     retn
DOSCODE:B71B VVDigit	     endp
DOSCODE:B71B
DOSCODE:B71B ; ---------------------------------------------------------------------------
DOSCODE:B71C CPScanPattern   db	89h, 26h, 48h, 1     ; ...
DOSCODE:B71C					     ; mov [148],sp
DOSCODE:B720		     db	8Ch, 0Eh, 4Ch, 1     ; mov [14C],cs
DOSCODE:B724		     db	0C7h, 6, 4Ah, 1, 0, 1 ;	mov [14A],100h
DOSCODE:B72A		     db	8Ch, 0Eh, 13h, 1     ; mov [113],cs
DOSCODE:B72E		     db	0B8h, 20h, 1	     ; mov ax,120h
DOSCODE:B731		     db	0BEh, 0, 1	     ; mov si,100h
DOSCODE:B734
DOSCODE:B734 ; =============== S U B R O U T I N E =======================================
DOSCODE:B734
DOSCODE:B734
DOSCODE:B734 IsCopyProt	     proc near		     ; ...
DOSCODE:B734		     cmp     word ptr ds:11Bh, 5343h ; [CPID1Offset], ID1
DOSCODE:B73A		     jnz     short CP_done
DOSCODE:B73C		     cmp     word ptr ds:173h, 5044h ; [CPID2Offset], ID2
DOSCODE:B742		     jnz     short CP_done
DOSCODE:B744		     cmp     word ptr ds:146h, 0F413h ;	[CPID3Offset], ID3
DOSCODE:B74A		     jnz     short CP_done
DOSCODE:B74C		     cmp     word ptr ds:124h, 8000h ; [CPID4Offset], ID4
DOSCODE:B752		     jnz     short CP_done
DOSCODE:B754		     push    cs
DOSCODE:B755		     pop     es
DOSCODE:B756		     mov     di, offset	CPScanPattern
DOSCODE:B759		     mov     si, 175h	     ; CPStartOffset
DOSCODE:B75C		     mov     cx, 24	     ; CPSPlen
DOSCODE:B75F		     repe cmpsb
DOSCODE:B761		     jnz     short CP_done
DOSCODE:B763		     mov     ss:A20OFF_COUNT, 0Ah
DOSCODE:B769
DOSCODE:B769 CP_done:				     ; ...
DOSCODE:B769		     retn
DOSCODE:B769 IsCopyProt	     endp
DOSCODE:B769
DOSCODE:B76A ; ---------------------------------------------------------------------------
DOSCODE:B76A
DOSCODE:B76A SYSBUF:				     ; ...
DOSCODE:B76A		     iret		     ; initiret
DOSCODE:B76A ; ---------------------------------------------------------------------------
DOSCODE:B76B InitBioDataSeg  dw	70h		     ; ...
DOSCODE:B76D
DOSCODE:B76D ; =============== S U B R O U T I N E =======================================
DOSCODE:B76D
DOSCODE:B76D
DOSCODE:B76D ParaRound	     proc near		     ; ...
DOSCODE:B76D		     add     ax, 0Fh	     ; add ax, 15
DOSCODE:B770		     rcr     ax, 1
DOSCODE:B772		     shr     ax, 1
DOSCODE:B774		     shr     ax, 1
DOSCODE:B776		     shr     ax, 1
DOSCODE:B778		     retn
DOSCODE:B778 ParaRound	     endp
DOSCODE:B778
DOSCODE:B779 ; ---------------------------------------------------------------------------
DOSCODE:B779
DOSCODE:B779 DOSINIT:				     ; ...
DOSCODE:B779		     cli
DOSCODE:B77A		     cld
DOSCODE:B77B		     push    dx
DOSCODE:B77C		     push    si
DOSCODE:B77D		     push    ds
DOSCODE:B77E		     push    di
DOSCODE:B77F		     mov     bx, es
DOSCODE:B781		     mov     ax, offset	DOSCODE_END ; MEMSTRT
DOSCODE:B784		     add     ax, 15
DOSCODE:B787		     and     ax, 0FFF0h	     ; ~15
DOSCODE:B78A		     mov     si, ax
DOSCODE:B78C		     mov     ax, cs
DOSCODE:B78E		     mov     ds, ax
DOSCODE:B790		     mov     es, cs:InitBioDataSeg
DOSCODE:B795		     assume es:nothing
DOSCODE:B795		     mov     es, word ptr es:3
DOSCODE:B79A		     assume es:nothing
DOSCODE:B79A		     xor     di, di
DOSCODE:B79C		     mov     cx, 4962	     ; MSDAT001E ; size	of DOSDATA
DOSCODE:B79F		     rep movsb
DOSCODE:B7A1		     pop     di
DOSCODE:B7A2		     pop     ds
DOSCODE:B7A3		     pop     si
DOSCODE:B7A4		     pop     dx
DOSCODE:B7A5		     push    es
DOSCODE:B7A6		     push    ds
DOSCODE:B7A7		     pop     es
DOSCODE:B7A8		     pop     ds
DOSCODE:B7A9		     mov     word ptr ds:BiosDataPtr, di
DOSCODE:B7AD		     mov     word ptr ds:BiosDataPtr+2,	bx
DOSCODE:B7B1		     mov     cs:DosDSeg, ds
DOSCODE:B7B6		     mov     cs:LowInt23Seg, ds
DOSCODE:B7BB		     mov     cs:LowInt24Seg, ds
DOSCODE:B7C0		     mov     cs:LowInt28Seg, ds
DOSCODE:B7C5		     mov     ds:ENDMEM,	dx
DOSCODE:B7C9		     mov     ds:USER_SP, sp
DOSCODE:B7CD		     mov     ds:USER_SS, ss
DOSCODE:B7D1		     mov     ax, ds
DOSCODE:B7D3		     mov     ss, ax
DOSCODE:B7D5		     mov     sp, offset	DSKSTACK
DOSCODE:B7D8		     mov     ds:FixExePatch, offset RetExePatch
DOSCODE:B7DE		     mov     ds:RationalPatchPtr, offset RetExePatch
DOSCODE:B7E4		     mov     ds:ChkCopyProt, offset RetExePatch
DOSCODE:B7EA		     mov     ax, cs
DOSCODE:B7EC		     mov     ds:TEMP_DOSLOC, ax
DOSCODE:B7EF		     mov     word ptr ds:NULDEV+2, es
DOSCODE:B7F3		     mov     word ptr ds:NULDEV, si
DOSCODE:B7F7		     mov     ds:Win386_Info_16,	ds ; [Win386_Info+16]
DOSCODE:B7F7					     ; [Win386_Info+Win386_SIS.Instance_Data_Ptr+2]
DOSCODE:B7FB		     push    si
DOSCODE:B7FC		     mov     cx, 7
DOSCODE:B7FF		     mov     si, offset	Instance_Table_2 ; Instance_Table+2
DOSCODE:B802
DOSCODE:B802 Instance_init_loop:		     ; ...
DOSCODE:B802		     mov     word ptr [si], ds
DOSCODE:B804		     add     si, 6	     ; size_of_Win386_IIS
DOSCODE:B807		     loop    Instance_init_loop
DOSCODE:B809		     mov     cx, 5
DOSCODE:B80C		     mov     si, offset	OldInstanceJunk_6 ; OldInstanceJunk+6
DOSCODE:B80F
DOSCODE:B80F OldInstance_init_loop:		     ; ...
DOSCODE:B80F		     mov     word ptr [si], ds
DOSCODE:B811		     add     si, 6
DOSCODE:B814		     loop    OldInstance_init_loop
DOSCODE:B816		     pop     si
DOSCODE:B817		     push    es
DOSCODE:B818		     pop     ds
DOSCODE:B819		     push    ds
DOSCODE:B81A		     xor     ax, ax
DOSCODE:B81C		     mov     ds, ax
DOSCODE:B81E		     mov     ax, offset	SYSBUF ; initiret
DOSCODE:B821		     mov     ds:0A8h, ax     ; [2Ah*4] ; [addr_int_ibm]
DOSCODE:B824		     mov     ax, cs
DOSCODE:B826		     mov     ds:0AAh, ax     ; [(2Ah*4)+2] ; [addr_int_ibm+2]
DOSCODE:B829		     pop     ds
DOSCODE:B82A		     call    CHARINIT
DOSCODE:B82D		     push    si
DOSCODE:B82E		     push    ss
DOSCODE:B82F		     pop     es
DOSCODE:B830		     mov     di, offset	SFTABL_6 ; SFTABL+6
DOSCODE:B830					     ; SFTABL+SFT.SFTable
DOSCODE:B833		     mov     ax, 3
DOSCODE:B836		     stosw
DOSCODE:B837		     dec     al
DOSCODE:B839		     stosw
DOSCODE:B83A		     xor     al, al
DOSCODE:B83C		     stosb
DOSCODE:B83D		     mov     al, 0C3h	     ; devid_device_EOF|devid_device|ISCIN|ISCOUT
DOSCODE:B83F		     stosw
DOSCODE:B840		     mov     ax, si
DOSCODE:B842		     stosw
DOSCODE:B843		     mov     ax, ds
DOSCODE:B845		     stosw
DOSCODE:B846		     xor     ax, ax	     ; 0
DOSCODE:B848		     stosw
DOSCODE:B849		     stosw
DOSCODE:B84A		     stosw
DOSCODE:B84B		     dec     ax		     ; -1
DOSCODE:B84C		     stosw
DOSCODE:B84D		     stosw
DOSCODE:B84E		     inc     ax		     ; 0
DOSCODE:B84F		     stosw
DOSCODE:B850		     stosw
DOSCODE:B851		     add     di, 7	     ; SF_ENTRY.sf_name-SF_ENTRY.sf_cluspos
DOSCODE:B854		     add     si, 10	     ; SYSDEV.NAME
DOSCODE:B857		     mov     cx, 4
DOSCODE:B85A		     rep movsw
DOSCODE:B85C		     mov     cl, 3
DOSCODE:B85E		     mov     al, 20h ; ' '
DOSCODE:B860		     rep stosb
DOSCODE:B862		     pop     si
DOSCODE:B863		     or	     byte ptr [si+4], 3	; [SI+SYSDEV.ATT],ISCIN|ISCOUT
DOSCODE:B867		     mov     word ptr ss:BCON, si
DOSCODE:B86C		     mov     word ptr ss:BCON+2, ds
DOSCODE:B871
DOSCODE:B871 CHAR_INIT_LOOP:			     ; ...
DOSCODE:B871		     lds     si, [si]
DOSCODE:B873		     call    CHARINIT
DOSCODE:B876		     test    byte ptr [si+4], 8	; [SI+SYSDEV.ATT],ISCLOCK
DOSCODE:B87A		     jz	     short CHAR_INIT_LOOP
DOSCODE:B87C		     mov     word ptr ss:BCLOCK, si
DOSCODE:B881		     mov     word ptr ss:BCLOCK+2, ds
DOSCODE:B886		     mov     bp, 4962	     ; MSDAT001E
DOSCODE:B889		     mov     word ptr ss:SYSINITVARS, bp ; [ss:DPBHEAD]
DOSCODE:B88E		     mov     word ptr ss:SYSINITVARS+2,	es ; [ss:DPBHEAD+2]
DOSCODE:B893
DOSCODE:B893 PERDRV:				     ; ...
DOSCODE:B893		     lds     si, [si]	     ; [SI+SYSDEV.NEXT]
DOSCODE:B895		     cmp     si, 0FFFFh	     ; -1
DOSCODE:B898		     jz	     short CONTINIT
DOSCODE:B89A		     call    CHARINIT
DOSCODE:B89D		     test    word ptr [si+4], 8000h ; [SI+SYSDEV.ATT],DEVTYP
DOSCODE:B8A2		     jnz     short PERDRV
DOSCODE:B8A4		     mov     cl, ss:CALLMED  ; [SS:CALLUNIT]
DOSCODE:B8A9		     xor     ch, ch
DOSCODE:B8AB		     mov     [si+10], cl     ; [si+SYSDEV.NAME]
DOSCODE:B8AE		     mov     dl, ss:NUMIO
DOSCODE:B8B3		     xor     dh, dh
DOSCODE:B8B5		     add     ss:NUMIO, cl
DOSCODE:B8BA		     push    ds
DOSCODE:B8BB		     push    si
DOSCODE:B8BC		     lds     bx, dword ptr ss:CALLSCNT ; [SS:CALLBPB]
DOSCODE:B8C1
DOSCODE:B8C1 PERUNIT:				     ; ...
DOSCODE:B8C1		     mov     si, [bx]
DOSCODE:B8C3		     inc     bx
DOSCODE:B8C4		     inc     bx
DOSCODE:B8C5		     mov     es:[bp+0],	dl   ; [ES:BP+DPB.DRIVE]
DOSCODE:B8C9		     mov     es:[bp+1],	dh   ; [ES:BP+DPB.UNIT]
DOSCODE:B8CD		     push    bx
DOSCODE:B8CE		     push    cx
DOSCODE:B8CF		     push    dx
DOSCODE:B8D0		     call    $SETDPB
DOSCODE:B8D3		     mov     ax, es:[bp+2]   ; [ES:BP+DPB.SECTOR_SIZE]
DOSCODE:B8D7		     cmp     ax, ss:MAXSEC
DOSCODE:B8DC		     jbe     short NOTMAX
DOSCODE:B8DE		     mov     ss:MAXSEC,	ax
DOSCODE:B8E2
DOSCODE:B8E2 NOTMAX:				     ; ...
DOSCODE:B8E2		     mov     ax, bp
DOSCODE:B8E4		     add     ax, 33	     ; DPBSIZ
DOSCODE:B8E7		     mov     es:[bp+25], ax  ; [ES:BP+DPB.NEXT_DPB]
DOSCODE:B8EB		     mov     word ptr es:[bp+27], es ; [ES:BP+DPB.NEXT_DPB+2]
DOSCODE:B8EF		     mov     byte ptr es:[bp+24], 0FFh ; [ES:BP+DPB.FIRST_ACCESS],-1
DOSCODE:B8F4		     pop     dx
DOSCODE:B8F5		     pop     cx
DOSCODE:B8F6		     pop     bx
DOSCODE:B8F7		     mov     ax, ds
DOSCODE:B8F9		     pop     si
DOSCODE:B8FA		     pop     ds
DOSCODE:B8FB		     mov     es:[bp+19], si  ; [ES:BP+DPB.DRIVER_ADDR]
DOSCODE:B8FF		     mov     word ptr es:[bp+21], ds ; [ES:BP+DPB.DRIVER_ADDR+2]
DOSCODE:B903		     push    ds
DOSCODE:B904		     push    si
DOSCODE:B905		     inc     dh
DOSCODE:B907		     inc     dl
DOSCODE:B909		     mov     ds, ax
DOSCODE:B90B		     add     bp, 33	     ; DPBSIZ
DOSCODE:B90E		     loop    PERUNIT
DOSCODE:B910		     pop     si
DOSCODE:B911		     pop     ds
DOSCODE:B912		     jmp     PERDRV
DOSCODE:B915 ; ---------------------------------------------------------------------------
DOSCODE:B915
DOSCODE:B915 CONTINIT:				     ; ...
DOSCODE:B915		     sub     bp, 33	     ; DPBSIZ
DOSCODE:B918		     mov     word ptr [bp+25], 0FFFFh ;	-1
DOSCODE:B91D		     mov     word ptr [bp+27], 0FFFFh ;	-1
DOSCODE:B922		     add     bp, 33
DOSCODE:B925		     push    ss
DOSCODE:B926		     pop     ds
DOSCODE:B927		     mov     ax, bp
DOSCODE:B929		     call    ParaRound
DOSCODE:B92C		     mov     dx, ds
DOSCODE:B92E		     add     dx, ax
DOSCODE:B930		     mov     bx, 0Fh
DOSCODE:B933		     mov     cx, ds:ENDMEM
DOSCODE:B937		     mov     ds:DSKCHRET_3, ds ; [DSKCHRET+3] ;	[DOSSEG_INIT]
DOSCODE:B93B		     push    dx
DOSCODE:B93C		     mov     ax, ds:TEMP_DOSLOC
DOSCODE:B93F		     mov     es, ax
DOSCODE:B941		     mov     ds:TEMP_DOSLOC, 0FFFFh ; -1
DOSCODE:B947		     call    patch_vec_segments
DOSCODE:B94A		     call    patch_misc_segments
DOSCODE:B94D		     mov     ds:TEMP_DOSLOC, es
DOSCODE:B951		     pop     dx
DOSCODE:B952		     xor     ax, ax
DOSCODE:B954		     mov     ds, ax
DOSCODE:B956		     mov     es, ax
DOSCODE:B958		     mov     di, 90h	     ; addr_int_fatal_abort
DOSCODE:B958					     ; 4*int_fatal_abort
DOSCODE:B95B		     mov     ax, ss:TEMP_DOSLOC
DOSCODE:B95F		     mov     [di+2], ax
DOSCODE:B962		     mov     di, 82h	     ; INTBASE+2
DOSCODE:B965		     mov     word ptr ds:0, offset DIVOV
DOSCODE:B96B		     mov     di, 80h	     ; INTBASE
DOSCODE:B96E		     mov     ax, offset	IRETT
DOSCODE:B971		     mov     cx, 9
DOSCODE:B974
DOSCODE:B974 iset1:				     ; ...
DOSCODE:B974		     stosw
DOSCODE:B975		     add     di, 2
DOSCODE:B978		     loop    iset1
DOSCODE:B97A		     add     di, 4
DOSCODE:B97D		     mov     cx, 6
DOSCODE:B980
DOSCODE:B980 iset2:				     ; ...
DOSCODE:B980		     stosw
DOSCODE:B981		     add     di, 2
DOSCODE:B984		     loop    iset2
DOSCODE:B986		     add     di, 8
DOSCODE:B989		     mov     cx, 14
DOSCODE:B98C
DOSCODE:B98C iset3:				     ; ...
DOSCODE:B98C		     stosw
DOSCODE:B98D		     add     di, 2
DOSCODE:B990		     loop    iset3
DOSCODE:B992		     mov     word ptr ds:0BCh, offset INT2F ; [02Fh*4],INT2F
DOSCODE:B998		     mov     ax, ss:TEMP_DOSLOC
DOSCODE:B99C		     mov     ds:0BEh, ax     ; [(02Fh*4)+2]
DOSCODE:B99F		     mov     byte ptr ds:0C0h, 0EAh ; [ENTRYPOINT],mi_long_jmp
DOSCODE:B9A4		     mov     word ptr ds:0C1h, offset CALL_ENTRY ;  [ENTRYPOINT+1]
DOSCODE:B9AA		     mov     word ptr ds:80h, offset QUIT ; [addr_int_abort]
DOSCODE:B9B0		     mov     word ptr ds:84h, offset COMMAND ; [addr_int_command]
DOSCODE:B9B6		     mov     word ptr ds:88h, 100h ; [addr_int_terminate]
DOSCODE:B9BC		     mov     ds:8Ah, dx	     ; [addr_int_terminate+2]
DOSCODE:B9C0		     mov     word ptr ds:94h, offset ABSDRD ; [addr_int_disk_read]
DOSCODE:B9C6		     mov     word ptr ds:98h, offset ABSDWRT ; [addr_int_disk_write]
DOSCODE:B9CC		     mov     word ptr ds:9Ch, offset STAY_RESIDENT ; [addr_int_keep_process]
DOSCODE:B9D2		     push    ss
DOSCODE:B9D3		     pop     ds
DOSCODE:B9D4		     push    ss
DOSCODE:B9D5		     pop     es
DOSCODE:B9D6		     push    dx
DOSCODE:B9D7		     inc     dx
DOSCODE:B9D8		     mov     ds:CurrentPDB, dx
DOSCODE:B9DC		     xor     di, di
DOSCODE:B9DE		     mov     es, dx
DOSCODE:B9E0		     xor     ax, ax
DOSCODE:B9E2		     mov     cx, 128
DOSCODE:B9E5		     rep stosw
DOSCODE:B9E7		     mov     ax, ds:ENDMEM
DOSCODE:B9EA		     call    SETMEM
DOSCODE:B9ED		     push    ss
DOSCODE:B9EE		     pop     ds
DOSCODE:B9EF		     mov     di, 24	     ; PDB.JFN_TABLE
DOSCODE:B9F2		     xor     ax, ax
DOSCODE:B9F4		     stosw
DOSCODE:B9F5		     stosb
DOSCODE:B9F6		     mov     al, 0FFh
DOSCODE:B9F8		     mov     cx, 17	     ; FILPERPROC-3
DOSCODE:B9FB		     rep stosb
DOSCODE:B9FD		     push    ss
DOSCODE:B9FE		     pop     es
DOSCODE:B9FF		     mov     word ptr ds:SFT_ADDR+2, ds
DOSCODE:BA03		     mov     si, offset	SysInitTable
DOSCODE:BA06		     mov     word ptr es:[si+6], es ; [es:si+SYSI_EXT.Country_Tab+2]
DOSCODE:BA0A		     mov     word ptr es:[si+2], es ; [es:si+SYSI_EXT.SysInitVars+2]
DOSCODE:BA0E		     mov     word ptr es:BUFFHEAD+2, es
DOSCODE:BA13		     mov     si, offset	BufferQueue ; HASHINITVAR
DOSCODE:BA16		     mov     word ptr es:BUFFHEAD, si
DOSCODE:BA1B		     pop     dx
DOSCODE:BA1C		     mov     word ptr ds:DMAADD+2, dx
DOSCODE:BA20		     mov     es:arena_head, dx
DOSCODE:BA25		     mov     ds, dx
DOSCODE:BA27		     mov     byte ptr ds:0, 5Ah	; 'Z' ; [ARENA.SIGNATURE],
DOSCODE:BA27					     ; arena_signature_end
DOSCODE:BA2C		     mov     word ptr ds:1, 0 ;	[ARENA.OWNER],
DOSCODE:BA2C					     ; arena_owner_system
DOSCODE:BA32		     mov     ax, ss:ENDMEM
DOSCODE:BA36		     sub     ax, dx
DOSCODE:BA38		     dec     ax
DOSCODE:BA39		     mov     ds:3, ax	     ; [ARENA.SIZE]
DOSCODE:BA3C		     mov     di, offset	SFTABL_6 ; SFTABL+6
DOSCODE:BA3C					     ; SFTABL+SFT.SFTable
DOSCODE:BA3F		     mov     ax, 3
DOSCODE:BA42		     stosw
DOSCODE:BA43		     mov     di, offset	SysInitTable
DOSCODE:BA46		     inc     dx
DOSCODE:BA47		     mov     ds, dx
DOSCODE:BA49		     mov     dx, offset	_seg_reinit
DOSCODE:BA4C		     mov     cx, offset	exepatch_start
DOSCODE:BA4F		     sub     cx, offset	_$STARTCODE
DOSCODE:BA53		     mov     ax, offset	SYSBUF
DOSCODE:BA56		     sub     ax, offset	_$STARTCODE
DOSCODE:BA59		     mov     sp, ss:USER_SP
DOSCODE:BA5E		     mov     ss, ss:USER_SS
DOSCODE:BA63		     retf
DOSCODE:BA64
DOSCODE:BA64 ; =============== S U B R O U T I N E =======================================
DOSCODE:BA64
DOSCODE:BA64
DOSCODE:BA64 CHARINIT	     proc near		     ; ...
DOSCODE:BA64		     mov     byte ptr ss:DEVCALL, 1Ah ;	[SS:DEVCALL_REQLEN],DINITHL
DOSCODE:BA6A		     mov     byte ptr ss:DEVCALL+1, 0 ;	[SS:DEVCALL_REQUNIT],0
DOSCODE:BA70		     mov     ss:DEVCALL_REQFUNC, 0 ; [SS:DEVCALL_REQFUNC],DEVINIT
DOSCODE:BA76		     mov     ss:DEVCALL_REQSTAT, 0 ; [SS:DEVCALL_REQSTAT],0
DOSCODE:BA7D		     push    es
DOSCODE:BA7E		     push    bx
DOSCODE:BA7F		     push    ax
DOSCODE:BA80		     mov     bx, offset	DEVCALL
DOSCODE:BA83		     push    ss
DOSCODE:BA84		     pop     es
DOSCODE:BA85		     call    DEVIOCALL2
DOSCODE:BA88		     pop     ax
DOSCODE:BA89		     pop     bx
DOSCODE:BA8A		     pop     es
DOSCODE:BA8B		     retn
DOSCODE:BA8B CHARINIT	     endp
DOSCODE:BA8B
DOSCODE:BA8C
DOSCODE:BA8C ; =============== S U B R O U T I N E =======================================
DOSCODE:BA8C
DOSCODE:BA8C
DOSCODE:BA8C check_XMM	     proc near		     ; ...
DOSCODE:BA8C		     push    ax
DOSCODE:BA8D		     mov     ax, 4300h	     ; (XMM_MULTIPLEX<<8)+XMM_INSTALL_CHECK
DOSCODE:BA90		     int     2Fh	     ; - Multiplex - XMS - INSTALLATION	CHECK
DOSCODE:BA90					     ; Return: AL = 80h	XMS driver installed
DOSCODE:BA90					     ; AL <> 80h no driver
DOSCODE:BA92		     cmp     al, 80h
DOSCODE:BA94		     jnz     short cXMM_no_driver
DOSCODE:BA96		     push    bx
DOSCODE:BA97		     push    dx
DOSCODE:BA98		     push    ds
DOSCODE:BA99		     push    es
DOSCODE:BA9A		     mov     ax, 4310h	     ; (XMM_MULTIPLEX<<8)+XMM_FUNCTION_ADDR
DOSCODE:BA9D		     int     2Fh	     ; - Multiplex - XMS - GET DRIVER ADDRESS
DOSCODE:BA9D					     ; Return: ES:BX ->	driver entry point
DOSCODE:BA9F		     mov     ds, cs:DosDSeg
DOSCODE:BAA4		     mov     word ptr ds:XMMcontrol, bx
DOSCODE:BAA8		     mov     word ptr ds:XMMcontrol+2, es
DOSCODE:BAAC
DOSCODE:BAAC cXMMexit:
DOSCODE:BAAC		     clc
DOSCODE:BAAD		     pop     es
DOSCODE:BAAE		     pop     ds
DOSCODE:BAAF		     pop     dx
DOSCODE:BAB0		     pop     bx
DOSCODE:BAB1		     pop     ax
DOSCODE:BAB2		     retn
DOSCODE:BAB3 ; ---------------------------------------------------------------------------
DOSCODE:BAB3
DOSCODE:BAB3 cXMM_no_driver:			     ; ...
DOSCODE:BAB3		     stc
DOSCODE:BAB4		     pop     ax
DOSCODE:BAB5		     retn
DOSCODE:BAB5 check_XMM	     endp
DOSCODE:BAB5
DOSCODE:BAB5 ; ---------------------------------------------------------------------------
DOSCODE:BAB6 num_entry	     db	0		     ; ...
DOSCODE:BAB7 ; ---------------------------------------------------------------------------
DOSCODE:BAB7
DOSCODE:BAB7 _seg_reinit:			     ; ...
DOSCODE:BAB7		     push    ds
DOSCODE:BAB8		     mov     ds, cs:DosDSeg
DOSCODE:BABD		     call    patch_misc_segments
DOSCODE:BAC0		     cmp     ax, 0
DOSCODE:BAC3		     jnz     short patch_vec_seg
DOSCODE:BAC5		     cmp     cs:num_entry, 0
DOSCODE:BACB		     jnz     short second_entry
DOSCODE:BACD		     mov     ax, ds
DOSCODE:BACF		     call    patch_vec_segments
DOSCODE:BAD2		     call    patch_offset
DOSCODE:BAD5
DOSCODE:BAD5 second_entry:			     ; ...
DOSCODE:BAD5		     mov     ax, es
DOSCODE:BAD7		     mov     di, offset	DOSINTTABLE
DOSCODE:BADA		     mov     cx, 9
DOSCODE:BADD		     push    ds
DOSCODE:BADE		     pop     es
DOSCODE:BADF
DOSCODE:BADF dosinttabloop:			     ; ...
DOSCODE:BADF		     add     di, 2
DOSCODE:BAE2		     stosw
DOSCODE:BAE3		     loop    dosinttabloop
DOSCODE:BAE5		     cmp     ax, 0F000h
DOSCODE:BAE8		     jb	     short sr_done
DOSCODE:BAEA		     call    check_XMM
DOSCODE:BAED		     jb	     short sr_done
DOSCODE:BAEF		     call    patch_in_nops
DOSCODE:BAF2		     mov     ds:DosHasHMA, 1
DOSCODE:BAF7		     mov     ds:FixExePatch, offset ExePatch
DOSCODE:BAFD		     mov     ds:ChkCopyProt, offset IsCopyProt
DOSCODE:BB03
DOSCODE:BB03 Get_CPU_Type:			     ; WhatCPUType
DOSCODE:BB03		     pushf
DOSCODE:BB04		     push    bx
DOSCODE:BB05		     xor     bx, bx
DOSCODE:BB07		     xor     ax, ax
DOSCODE:BB09		     push    ax
DOSCODE:BB0A		     popf
DOSCODE:BB0B		     pushf
DOSCODE:BB0C		     pop     ax
DOSCODE:BB0D		     and     ax, 0F000h
DOSCODE:BB10		     cmp     ax, 0F000h
DOSCODE:BB13		     jz	     short cpu_8086
DOSCODE:BB15		     mov     ax, 0F000h
DOSCODE:BB18		     push    ax
DOSCODE:BB19		     popf
DOSCODE:BB1A		     pushf
DOSCODE:BB1B		     pop     ax
DOSCODE:BB1C		     and     ax, 0F000h
DOSCODE:BB1F		     jz	     short cpu_286
DOSCODE:BB21		     inc     bx
DOSCODE:BB22
DOSCODE:BB22 cpu_286:				     ; ...
DOSCODE:BB22		     inc     bx
DOSCODE:BB23
DOSCODE:BB23 cpu_8086:				     ; ...
DOSCODE:BB23		     mov     ax, bx
DOSCODE:BB25		     pop     bx
DOSCODE:BB26		     popf
DOSCODE:BB27		     cmp     al, 1
DOSCODE:BB29		     jnz     short sr_done
DOSCODE:BB2B		     mov     ds:RationalPatchPtr, offset RationalPatch
DOSCODE:BB31		     jmp     short sr_done
DOSCODE:BB33 ; ---------------------------------------------------------------------------
DOSCODE:BB33
DOSCODE:BB33 patch_vec_seg:			     ; ...
DOSCODE:BB33		     mov     ax, es
DOSCODE:BB35		     call    patch_vec_segments
DOSCODE:BB38
DOSCODE:BB38 sr_done:				     ; ...
DOSCODE:BB38		     mov     cs:num_entry, 1
DOSCODE:BB3E		     pop     ds
DOSCODE:BB3F		     retf
DOSCODE:BB40
DOSCODE:BB40 ; =============== S U B R O U T I N E =======================================
DOSCODE:BB40
DOSCODE:BB40
DOSCODE:BB40 patch_vec_segments	proc near	     ; ...
DOSCODE:BB40		     push    es
DOSCODE:BB41		     xor     cx, cx
DOSCODE:BB43		     mov     es, cx
DOSCODE:BB45		     mov     di, 82h	     ; INTBASE+2
DOSCODE:BB45					     ; di -> segment of	int 20 vector
DOSCODE:BB48		     mov     es:2, ax
DOSCODE:BB4C		     mov     cx, 2
DOSCODE:BB4F
DOSCODE:BB4F ps_set1:				     ; ...
DOSCODE:BB4F		     stosw
DOSCODE:BB50		     add     di, 2
DOSCODE:BB53		     loop    ps_set1
DOSCODE:BB55		     add     di, 4
DOSCODE:BB58		     stosw
DOSCODE:BB59		     add     di, 6
DOSCODE:BB5C		     mov     cx, 4
DOSCODE:BB5F
DOSCODE:BB5F ps_set2:				     ; ...
DOSCODE:BB5F		     stosw
DOSCODE:BB60		     add     di, 2
DOSCODE:BB63		     loop    ps_set2
DOSCODE:BB65		     add     di, 4
DOSCODE:BB68		     mov     cx, 6
DOSCODE:BB6B
DOSCODE:BB6B ps_set3:				     ; ...
DOSCODE:BB6B		     stosw
DOSCODE:BB6C		     add     di, 2
DOSCODE:BB6F		     loop    ps_set3
DOSCODE:BB71		     add     di, 8
DOSCODE:BB74		     mov     cx, 14
DOSCODE:BB77
DOSCODE:BB77 ps_set4:				     ; ...
DOSCODE:BB77		     stosw
DOSCODE:BB78		     add     di, 2
DOSCODE:BB7B		     loop    ps_set4
DOSCODE:BB7D		     mov     es:0C3h, ax     ; [es:ENTRYPOINT+3]
DOSCODE:BB81		     pop     es
DOSCODE:BB82		     retn
DOSCODE:BB82 patch_vec_segments	endp
DOSCODE:BB82
DOSCODE:BB83
DOSCODE:BB83 ; =============== S U B R O U T I N E =======================================
DOSCODE:BB83
DOSCODE:BB83
DOSCODE:BB83 patch_misc_segments proc near	     ; ...
DOSCODE:BB83		     push    bx
DOSCODE:BB84		     push    es
DOSCODE:BB85		     push    ax
DOSCODE:BB86		     mov     ax, es
DOSCODE:BB88		     push    ds
DOSCODE:BB89		     pop     es
DOSCODE:BB8A		     mov     di, offset	JShare
DOSCODE:BB8D		     mov     bx, ds:TEMP_DOSLOC
DOSCODE:BB91		     mov     cx, 15
DOSCODE:BB94
DOSCODE:BB94 jumptabloop:			     ; ...
DOSCODE:BB94		     add     di, 2
DOSCODE:BB97		     cmp     bx, -1
DOSCODE:BB9A		     jz	     short share_patch
DOSCODE:BB9C		     cmp     bx, es:[di]
DOSCODE:BB9F		     jnz     short no_share_patch
DOSCODE:BBA1
DOSCODE:BBA1 share_patch:			     ; ...
DOSCODE:BBA1		     stosw
DOSCODE:BBA2
DOSCODE:BBA2 no_share_patch:			     ; ...
DOSCODE:BBA2		     loop    jumptabloop
DOSCODE:BBA4		     mov     si, offset	COUNTRY_CDPG
DOSCODE:BBA7		     mov     word ptr [si+4Fh],	ds ; [si+DOS_CCDPG.ccUcase_ptr+2]
DOSCODE:BBAA		     mov     word ptr [si+54h],	ds ; [si+DOS_CCDPG.ccFileUcase_ptr+2]
DOSCODE:BBAD		     mov     word ptr [si+59h],	ds ; [si+DOS_CCDPG.ccFileChar_ptr+2]
DOSCODE:BBB0		     mov     word ptr [si+5Eh],	ds ; [si+DOS_CCDPG.ccCollate_ptr+2]
DOSCODE:BBB3		     mov     word ptr [si+80h],	ds ; [si+DOS_CCDPG.ccMono_ptr+2]
DOSCODE:BBB7		     mov     word ptr [si+63h],	ds ; [si+DOS_CCDPG.ccDBCS_ptr+2]
DOSCODE:BBBA		     mov     si, offset	FastOpenTable
DOSCODE:BBBD		     cmp     ds:TEMP_DOSLOC, 0FFFFh ; -1
DOSCODE:BBC2		     jz	     short fast_patch
DOSCODE:BBC4		     mov     cx, ds:TEMP_DOSLOC
DOSCODE:BBC8		     cmp     cx, [si+4]	     ; [si+fastopen_entry.name_caching+2]
DOSCODE:BBCB		     jnz     short no_fast_patch
DOSCODE:BBCD
DOSCODE:BBCD fast_patch:			     ; ...
DOSCODE:BBCD		     mov     [si+4], ax
DOSCODE:BBD0
DOSCODE:BBD0 no_fast_patch:			     ; ...
DOSCODE:BBD0		     pop     ax
DOSCODE:BBD1		     pop     es
DOSCODE:BBD2		     pop     bx
DOSCODE:BBD3		     retn
DOSCODE:BBD3 patch_misc_segments endp
DOSCODE:BBD3
DOSCODE:BBD4
DOSCODE:BBD4 ; =============== S U B R O U T I N E =======================================
DOSCODE:BBD4
DOSCODE:BBD4
DOSCODE:BBD4 patch_offset    proc near		     ; ...
DOSCODE:BBD4		     push    es
DOSCODE:BBD5		     xor     ax, ax
DOSCODE:BBD7		     mov     es, ax
DOSCODE:BBD9		     mov     word ptr es:0, offset ldivov
DOSCODE:BBE0		     mov     di, 80h	     ; INTBASE
DOSCODE:BBE0					     ; di-> offset of int 20 handler
DOSCODE:BBE3		     mov     ax, offset	lirett
DOSCODE:BBE6		     mov     cx, 2
DOSCODE:BBE9
DOSCODE:BBE9 po_iset1:				     ; ...
DOSCODE:BBE9		     stosw
DOSCODE:BBEA		     add     di, 2
DOSCODE:BBED		     loop    po_iset1
DOSCODE:BBEF		     add     di, 4
DOSCODE:BBF2		     stosw
DOSCODE:BBF3		     add     di, 6
DOSCODE:BBF6		     mov     cx, 4
DOSCODE:BBF9
DOSCODE:BBF9 po_iset2:				     ; ...
DOSCODE:BBF9		     stosw
DOSCODE:BBFA		     add     di, 2
DOSCODE:BBFD		     loop    po_iset2
DOSCODE:BBFF		     add     di, 4
DOSCODE:BC02		     mov     cx, 6
DOSCODE:BC05
DOSCODE:BC05 po_iset3:				     ; ...
DOSCODE:BC05		     stosw
DOSCODE:BC06		     add     di, 2
DOSCODE:BC09		     loop    po_iset3
DOSCODE:BC0B		     add     di, 8
DOSCODE:BC0E		     mov     cx, 14
DOSCODE:BC11
DOSCODE:BC11 po_iset4:				     ; ...
DOSCODE:BC11		     stosw
DOSCODE:BC12		     add     di, 2
DOSCODE:BC15		     loop    po_iset4
DOSCODE:BC17		     mov     word ptr es:0BCh, offset lint2f
DOSCODE:BC1E		     mov     byte ptr es:0C0h, 0EAh ; [es:ENTRYPOINT],mi_long_jmp
DOSCODE:BC24		     mov     word ptr es:0C1h, offset lcall_entry
DOSCODE:BC2B		     mov     word ptr es:80h, offset lquit ; [es:addr_int_abort]
DOSCODE:BC32		     mov     word ptr es:84h, offset lcommand ;	[es:addr_int_command]
DOSCODE:BC39		     mov     word ptr es:94h, offset labsdrd ; [es:addr_int_disk_read]
DOSCODE:BC40		     mov     word ptr es:98h, offset labsdwrt ;	[es:addr_int_disk_write]
DOSCODE:BC47		     mov     word ptr es:9Ch, offset lstay_resident ; [es:addr_int_keep_process]
DOSCODE:BC4E		     pop     es
DOSCODE:BC4F		     retn
DOSCODE:BC4F patch_offset    endp
DOSCODE:BC4F
DOSCODE:BC4F ; ---------------------------------------------------------------------------
DOSCODE:BC50 patch_table     dw	offset ldivov	     ; ...
DOSCODE:BC50					     ; i0patch
DOSCODE:BC52		     dw	offset lquit	     ; i20patch
DOSCODE:BC54		     dw	offset lcommand	     ; i21patch
DOSCODE:BC56		     dw	offset labsdrd	     ; i25patch
DOSCODE:BC58		     dw	offset labsdwrt	     ; i26patch
DOSCODE:BC5A		     dw	offset lstay_resident ;	i27patch
DOSCODE:BC5C		     dw	offset lint2f	     ; i2fpatch
DOSCODE:BC5E		     dw	offset lcall_entry   ; cpmpatch
DOSCODE:BC60 ; ---------------------------------------------------------------------------
DOSCODE:BC60
DOSCODE:BC60 patch_in_nops:			     ; ...
DOSCODE:BC60		     push    ax
DOSCODE:BC61		     push    si
DOSCODE:BC62		     mov     si, offset	patch_table
DOSCODE:BC65		     mov     ax, 9090h	     ; nop, nop
DOSCODE:BC68		     mov     cx, 8	     ; patch_table_size
DOSCODE:BC6B
DOSCODE:BC6B pin_loop:				     ; ...
DOSCODE:BC6B		     mov     di, cs:[si]
DOSCODE:BC6E		     stosw
DOSCODE:BC6F		     add     si, 2
DOSCODE:BC72		     loop    pin_loop
DOSCODE:BC74		     pop     si
DOSCODE:BC75		     pop     ax
DOSCODE:BC76		     retn
DOSCODE:BC76 ; ---------------------------------------------------------------------------
DOSCODE:BC77 DOSCODE_END     db	9 dup(0)	     ; ...
DOSCODE:BC77 DOSCODE	     ends
DOSCODE:BC77
DOSDATA:0000 ; ===========================================================================
DOSDATA:0000
DOSDATA:0000 ; Segment type: Pure data
DOSDATA:0000 DOSDATA	     segment byte public 'DATA' use16
DOSDATA:0000		     assume cs:DOSDATA
DOSDATA:0000 DATASTART	     db	4 dup(0)
DOSDATA:0004 DataVersion     dw	1
DOSDATA:0006 WinoldPatch1    db	8 dup(0)	     ; ...
DOSDATA:000E MYNUM	     dw	0		     ; ...
DOSDATA:0010 FCBLRU	     dw	0		     ; ...
DOSDATA:0012 OpenLRU	     dw	0
DOSDATA:0014 OEM_HANDLER     dd	0FFFFFFFFh
DOSDATA:0018 LeaveAddr	     dw	offset LeaveDOS	     ; DOSCODE:LeaveDOS
DOSDATA:001A RetryCount	     dw	3		     ; ...
DOSDATA:001C RetryLoop	     dw	1		     ; ...
DOSDATA:001E LastBuffer	     dd	0FFFFFFFFh	     ; ...
DOSDATA:0022 CONTPOS	     dw	0		     ; ...
DOSDATA:0024 arena_head	     dw	0		     ; ...
DOSDATA:0026 SYSINITVARS     dd	0		     ; ...
DOSDATA:0026					     ; DPBHEAD
DOSDATA:002A SFT_ADDR	     dd	0CCh		     ; ...
DOSDATA:002E BCLOCK	     dd	0		     ; ...
DOSDATA:0032 BCON	     dd	0		     ; ...
DOSDATA:0036 MAXSEC	     dw	128		     ; ...
DOSDATA:0038 BUFFHEAD	     dd	0		     ; ...
DOSDATA:003C CDSADDR	     dd	0		     ; ...
DOSDATA:0040 SFTFCB	     dd	0		     ; ...
DOSDATA:0044 KEEPCOUNT	     dw	0
DOSDATA:0046 NUMIO	     db	0		     ; ...
DOSDATA:0047 CDSCOUNT	     db	0		     ; ...
DOSDATA:0048 NULDEV	     dd	0		     ; ...
DOSDATA:004C		     dw	8004h		     ; DEVTYP|ISNULL
DOSDATA:004E		     dw	offset SNULDEV
DOSDATA:0050		     dw	offset INULDEV
DOSDATA:0052		     db	'NUL     '
DOSDATA:005A SPLICES	     db	0		     ; ...
DOSDATA:005B Special_Entries dw	0
DOSDATA:005D UU_IFS_DOS_CALL dd	0		     ; ...
DOSDATA:0061 ChkCopyProt     dw	0		     ; ...
DOSDATA:0063 A20OFF_PSP	     dw	0		     ; ...
DOSDATA:0065 BUFFERS_PARM1   dw	0
DOSDATA:0067 BUFFERS_PARM2   dw	0
DOSDATA:0069 BOOTDRIVE	     db	0		     ; ...
DOSDATA:006A DDMOVE	     db	0		     ; ...
DOSDATA:006B EXT_MEM_SIZE    dw	0
DOSDATA:006D BufferQueue     dd	0		     ; ...
DOSDATA:0071 DirtyBufferCount dw 0		     ; ...
DOSDATA:0073 SC_CACHE_PTR    dd	0		     ; ...
DOSDATA:0077 SC_CACHE_COUNT  dw	0		     ; ...
DOSDATA:0079 BuffInHMA	     db	0		     ; ...
DOSDATA:007A LoMemBuff	     dd	0		     ; ...
DOSDATA:007E UU_BUF_EMS_FIRST_PAGE db 3	dup(0)
DOSDATA:0081 CL0FATENTRY     dw	-1		     ; ...
DOSDATA:0083 IoStatFail	     db	0		     ; ...
DOSDATA:0084 ALLOCMSAVE	     db	0		     ; ...
DOSDATA:0085 A20OFF_COUNT    db	0		     ; ...
DOSDATA:0086 DOS_FLAG	     db	0		     ; ...
DOSDATA:0087 UNPACK_OFFSET   dw	0		     ; ...
DOSDATA:0089 UMBFLAG	     db	0		     ; ...
DOSDATA:008A SAVE_AX	     dw	0		     ; ...
DOSDATA:008C UMB_HEAD	     dw	-1		     ; ...
DOSDATA:008E START_ARENA     dw	1		     ; ...
DOSDATA:0090 JShare	     dw	offset BadCall	     ; ...
DOSDATA:0092		     dw	0
DOSDATA:0094 MFT_enter	     dd	44AEh		     ; ...
DOSDATA:0098 MFTClose	     dd	44AEh		     ; ...
DOSDATA:009C MFTclU	     dd	44AAh		     ; ...
DOSDATA:00A0 MFTCloseP	     dw	offset BadCall	     ; ...
DOSDATA:00A2		     dw	0
DOSDATA:00A4 MFTcloN	     dw	offset BadCall	     ; ...
DOSDATA:00A6		     dw	0
DOSDATA:00A8 set_block	     dd	44AAh		     ; ...
DOSDATA:00AC clr_block	     dd	44AAh		     ; ...
DOSDATA:00B0 chk_block	     dd	44AEh		     ; ...
DOSDATA:00B4 MFT_get	     dd	44AAh		     ; ...
DOSDATA:00B8 ShSave	     dw	offset BadCall	     ; ...
DOSDATA:00BA		     dw	0
DOSDATA:00BC ShChk	     dw	offset BadCall	     ; ...
DOSDATA:00BE		     dw	0
DOSDATA:00C0 ShCol	     dd	44AEh		     ; ...
DOSDATA:00C4 ShCloseFile     dw	offset BadCall	     ; ...
DOSDATA:00C6		     dw	0
DOSDATA:00C8 ShSU	     dw	offset BadCall	     ; ...
DOSDATA:00CA		     dw	0
DOSDATA:00CC SFTABL	     dw	-1
DOSDATA:00CE		     dw	-1
DOSDATA:00D0		     dw	5
DOSDATA:00D2 SFTABL_6	     db	295 dup(0)	     ; ...
DOSDATA:01F9 CARPOS	     db	0		     ; ...
DOSDATA:01FA STARTPOS	     db	0		     ; ...
DOSDATA:01FB INBUF	     db	128 dup(0)	     ; ...
DOSDATA:027B CONBUF	     db	131 dup(0)	     ; ...
DOSDATA:02FE PFLAG	     db	0		     ; ...
DOSDATA:02FF VERFLG	     db	0		     ; ...
DOSDATA:0300 CHARCO	     db	11b		     ; ...
DOSDATA:0301 chSwitch	     db	'/'
DOSDATA:0302 AllocMethod     db	0		     ; ...
DOSDATA:0303 fShare	     db	0		     ; ...
DOSDATA:0304 DIFFNAM	     db	1		     ; ...
DOSDATA:0305 MYNAME	     db	16 dup(32)	     ; ...
DOSDATA:0315 CritPatch	     dw	offset redir_patch   ; ...
DOSDATA:0317		     dw	offset redir_patch
DOSDATA:0319		     dw	offset redir_patch
DOSDATA:031B		     dw	offset redir_patch
DOSDATA:031D		     dw	0
DOSDATA:031F		     db	90h		     ; align 2
DOSDATA:0320 ERRORMODE	     db	0		     ; ...
DOSDATA:0320					     ; SWAP_START
DOSDATA:0321 INDOS	     db	0		     ; ...
DOSDATA:0322 WPERR	     db	-1		     ; ...
DOSDATA:0323 EXTERR_LOCUS    db	0		     ; ...
DOSDATA:0324 EXTERR	     dw	0		     ; ...
DOSDATA:0326 EXTERR_ACTION   db	0		     ; ...
DOSDATA:0327 EXTERR_CLASS    db	0		     ; ...
DOSDATA:0328 EXTERRPT	     dd	0		     ; ...
DOSDATA:032C DMAADD	     dd	80h		     ; ...
DOSDATA:0330 CurrentPDB	     dw	0		     ; ...
DOSDATA:0332 ConC_Spsave     dw	0		     ; ...
DOSDATA:0334 exit_code	     dw	0		     ; ...
DOSDATA:0336 CURDRV	     db	0		     ; ...
DOSDATA:0337 CNTCFLAG	     db	0		     ; ...
DOSDATA:0338 CPSWFLAG	     db	0
DOSDATA:0339 CPSWSAVE	     db	0
DOSDATA:033A USER_IN_AX	     dw	0		     ; ...
DOSDATA:033A					     ; SWAP_ALWAYS
DOSDATA:033C PROC_ID	     dw	0		     ; ...
DOSDATA:033E USER_ID	     dw	0		     ; ...
DOSDATA:0340 FirstArena	     dw	0		     ; ...
DOSDATA:0342 BestArena	     dw	0		     ; ...
DOSDATA:0344 LastArena	     dw	0		     ; ...
DOSDATA:0346 ENDMEM	     dw	0		     ; ...
DOSDATA:0348 LASTENT	     dw	0		     ; ...
DOSDATA:034A FAILERR	     db	0		     ; ...
DOSDATA:034B ALLOWED	     db	0		     ; ...
DOSDATA:034C NoSetDir	     db	0		     ; ...
DOSDATA:034D DidCTRLC	     db	0		     ; ...
DOSDATA:034E SpaceFlag	     db	0		     ; ...
DOSDATA:034F		     db	90h		     ; align 2
DOSDATA:0350 DAY	     db	0		     ; ...
DOSDATA:0351 MONTH	     db	0		     ; ...
DOSDATA:0352 YEAR	     dw	0		     ; ...
DOSDATA:0354 DAYCNT	     dw	0FFFFh		     ; ...
DOSDATA:0356 WEEKDAY	     db	0		     ; ...
DOSDATA:0357 CONSWAP	     db	0		     ; ...
DOSDATA:0358 IDLEINT	     db	1		     ; ...
DOSDATA:0359 fAborting	     db	0		     ; ...
DOSDATA:035A DEVCALL	     dw	0		     ; ...
DOSDATA:035C DEVCALL_REQFUNC db	0		     ; ...
DOSDATA:035D DEVCALL_REQSTAT dw	0		     ; ...
DOSDATA:035F		     db	   0
DOSDATA:0360		     db	   0
DOSDATA:0361		     db	   0
DOSDATA:0362		     db	   0
DOSDATA:0363		     db	   0
DOSDATA:0364		     db	   0
DOSDATA:0365		     db	   0
DOSDATA:0366		     db	   0
DOSDATA:0367 CALLMED	     db	0		     ; ...
DOSDATA:0368 CALLXADD	     db	0,0,0,0		     ; ...
DOSDATA:036C CALLSCNT	     dw	0		     ; ...
DOSDATA:036E CALLSSEC	     dw	0		     ; ...
DOSDATA:0370 CALLVIDRW	     dd	0		     ; ...
DOSDATA:0374 CALLNEWSC	     dd	0		     ; ...
DOSDATA:0378 CALLDEVAD	     dd	0		     ; ...
DOSDATA:037C IOCALL_REQLEN   db	0		     ; ...
DOSDATA:037C					     ; IOCALL
DOSDATA:037D IOCALL_REQUNIT  db	0		     ; ...
DOSDATA:037E IOCALL_REQFUNC  db	0		     ; ...
DOSDATA:037F IOCALL_REQSTAT  db	2 dup(0)	     ; ...
DOSDATA:0381		     db	8 dup(0)
DOSDATA:0389 IOCTL_REQ_MAJORFUNCTION db	0	     ; ...
DOSDATA:038A IOCTL_REQ_MINORFUNCTION db	0	     ; ...
DOSDATA:038B IOCTL_REQ_REG_SI db 0		     ; ...
DOSDATA:038C IOCTL_IOXAD_2   db	0		     ; ...
DOSDATA:038D IOCTL_REQ_REG_DI db 0		     ; ...
DOSDATA:038E IOCTL_IOSCNT    db	0		     ; ...
DOSDATA:038F IOCTL_REQ_GENERICIOCTL_PACKET dw 0	     ; ...
DOSDATA:0391 IOCTL_REQ_GENERICIOCTL_PACKET_2 db	0    ; ...
DOSDATA:0392 DSKSTCALL	     db	14		     ; ...
DOSDATA:0392					     ; DRDNDHL
DOSDATA:0393		     db	0
DOSDATA:0394 DSKSTCOM	     db	5		     ; ...
DOSDATA:0394					     ; DEVRDND
DOSDATA:0395 DSKSTST	     dw	0		     ; ...
DOSDATA:0397		     db	8 dup(0)
DOSDATA:039F DSKCHRET	     db	0		     ; ...
DOSDATA:03A0 DSKCHRET_1	     dw	offset DEVIOBUF	     ; ...
DOSDATA:03A2 DSKCHRET_3	     dw	0		     ; ...
DOSDATA:03A4 DSKSTCNT	     dw	1		     ; ...
DOSDATA:03A6		     dw	0
DOSDATA:03A8 CreatePDB	     db	0		     ; ...
DOSDATA:03A9 Lock_Buffer     db	8 dup(0)	     ; ...
DOSDATA:03B1		     db	 90h ; 
DOSDATA:03B2 USERNUM	     dd	0FF000000h	     ; ...
DOSDATA:03B6 TIMEBUF	     dw	3 dup(0)	     ; ...
DOSDATA:03BC DEVIOBUF	     dw	0		     ; ...
DOSDATA:03BE OPENBUF	     db	128 dup(0)	     ; ...
DOSDATA:043E RENBUF	     db	128 dup(0)	     ; ...
DOSDATA:04BE SEARCHBUF	     db	53 dup(0)	     ; ...
DOSDATA:04F3 DUMMYCDS	     db	88 dup(0)	     ; ...
DOSDATA:054B NAME1	     db	12 dup(0)	     ; ...
DOSDATA:0557 NAME2	     db	13 dup(0)	     ; ...
DOSDATA:0564 DESTSTART	     dw	0		     ; ...
DOSDATA:0566		     db	5 dup(0)
DOSDATA:056B ATTRIB	     db	0		     ; ...
DOSDATA:056C EXTFCB	     db	0		     ; ...
DOSDATA:056D SATTRIB	     db	0		     ; ...
DOSDATA:056E OPEN_ACCESS     db	0		     ; ...
DOSDATA:056F FOUNDDEL	     db	0		     ; ...
DOSDATA:0570 FOUND_DEV	     db	0		     ; ...
DOSDATA:0571 FSPLICE	     db	0		     ; ...
DOSDATA:0572 FSHARING	     db	0		     ; ...
DOSDATA:0573 SECCLUSPOS	     db	0		     ; ...
DOSDATA:0574 TRANS	     db	0		     ; ...
DOSDATA:0575 READOP	     db	0		     ; ...
DOSDATA:0576 THISDRV	     db	0		     ; ...
DOSDATA:0577 CLUSFAC	     db	0		     ; ...
DOSDATA:0578 CLUSSPLIT	     db	0		     ; ...
DOSDATA:0579 INSMODE	     db	0		     ; ...
DOSDATA:057A CMETA	     db	0		     ; ...
DOSDATA:057B VOLID	     db	0		     ; ...
DOSDATA:057C EXIT_TYPE	     db	0		     ; ...
DOSDATA:057D		     db	90h
DOSDATA:057E CREATING	     db	0		     ; ...
DOSDATA:057F DELALL	     db	0		     ; ...
DOSDATA:0580 EXITHOLD	     dd	0		     ; ...
DOSDATA:0584 USER_SP	     dw	0		     ; ...
DOSDATA:0586 USER_SS	     dw	0		     ; ...
DOSDATA:0588 CONTSTK	     dw	0		     ; ...
DOSDATA:058A THISDPB	     dd	0		     ; ...
DOSDATA:058E CLUSSAVE	     dw	0		     ; ...
DOSDATA:0590 CLUSSEC	     dd	0		     ; ...
DOSDATA:0594 PREREAD	     dw	0		     ; ...
DOSDATA:0596 FATBYT	     dw	0		     ; ...
DOSDATA:0598 FATBYTE	     db	0		     ; ...
DOSDATA:0599		     db	0
DOSDATA:059A DEVPT	     dd	0		     ; ...
DOSDATA:059E THISSFT	     dd	0		     ; ...
DOSDATA:05A2 THISCDS	     dd	0		     ; ...
DOSDATA:05A6 THISFCB	     dd	0		     ; ...
DOSDATA:05AA SFN	     dw	0FFFFh		     ; ...
DOSDATA:05AC JFN	     dw	0		     ; ...
DOSDATA:05AE PJFN	     dd	0		     ; ...
DOSDATA:05B2 WFP_START	     dw	0		     ; ...
DOSDATA:05B4 REN_WFP	     dw	0		     ; ...
DOSDATA:05B6 CURR_DIR_END    dw	0		     ; ...
DOSDATA:05B8 NEXTADD	     dw	0		     ; ...
DOSDATA:05BA LASTPOS	     dw	0		     ; ...
DOSDATA:05BC CLUSNUM	     dw	0		     ; ...
DOSDATA:05BE DIRSEC	     dd	0		     ; ...
DOSDATA:05C2 DIRSTART	     dw	0		     ; ...
DOSDATA:05C4 SECPOS	     dd	0		     ; ...
DOSDATA:05C8 VALSEC	     dd	0		     ; ...
DOSDATA:05CC BYTSECPOS	     dw	0		     ; ...
DOSDATA:05CE BYTPOS	     dd	0		     ; ...
DOSDATA:05D2 BYTCNT1	     dw	0		     ; ...
DOSDATA:05D4 BYTCNT2	     dw	0		     ; ...
DOSDATA:05D6 SECCNT	     dw	0		     ; ...
DOSDATA:05D8 ENTFREE	     dw	0		     ; ...
DOSDATA:05DA ENTLAST	     dw	0		     ; ...
DOSDATA:05DC NXTCLUSNUM	     dw	0		     ; ...
DOSDATA:05DE GROWCNT	     dd	0		     ; ...
DOSDATA:05E2 CURBUF	     dd	0		     ; ...
DOSDATA:05E6 CONSFT	     dd	0		     ; ...
DOSDATA:05EA SAVEBX	     dw	0		     ; ...
DOSDATA:05EC SAVEDS	     dw	0		     ; ...
DOSDATA:05EE RESTORE_TMP     dw	0		     ; ...
DOSDATA:05F0 NSS	     dw	0		     ; ...
DOSDATA:05F2 NSP	     dw	0		     ; ...
DOSDATA:05F4 EXTOPEN_FLAG    dw	0		     ; ...
DOSDATA:05F6 EXTOPEN_ON	     db	0		     ; ...
DOSDATA:05F7 EXTOPEN_IO_MODE dw	0		     ; ...
DOSDATA:05F9 SAVE_DI	     dw	0		     ; ...
DOSDATA:05FB SAVE_ES	     dw	0		     ; ...
DOSDATA:05FD SAVE_DX	     dw	0		     ; ...
DOSDATA:05FF SAVE_CX	     dw	0		     ; ...
DOSDATA:0601 SAVE_BX	     dw	0		     ; ...
DOSDATA:0603 SAVE_SI	     dw	0		     ; ...
DOSDATA:0605 SAVE_DS	     dw	0		     ; ...
DOSDATA:0607 HIGH_SECTOR     dw	0		     ; ...
DOSDATA:0609		     dw	0
DOSDATA:060B DISK_FULL	     db	0		     ; ...
DOSDATA:060C TEMP_VAR	     dw	0		     ; ...
DOSDATA:060E TEMP_VAR2	     dw	0		     ; ...
DOSDATA:0610 DrvErr	     db	0		     ; ...
DOSDATA:0611 DOS34_FLAG	     dw	0		     ; ...
DOSDATA:0613		     db	8 dup(0)
DOSDATA:061B AbsRdWr_SS	     dw	0		     ; ...
DOSDATA:061D AbsRdWr_SP	     dw	0		     ; ...
DOSDATA:061F		     db	   0
DOSDATA:0620 RENAMEDMA	     db	384 dup(0)	     ; ...
DOSDATA:07A0 AUXSTACK	     db	384 dup(0)	     ; ...
DOSDATA:0920 DSKSTACK	     db	384 dup(0)	     ; ...
DOSDATA:0AA0 PRINTER_FLAG    db	0		     ; ...
DOSDATA:0AA0					     ; IOSTACK
DOSDATA:0AA1 VOLCHNG_FLAG    db	0		     ; ...
DOSDATA:0AA2 VIRTUAL_OPEN    db	0		     ; ...
DOSDATA:0AA3 FSeek_drive     db	0
DOSDATA:0AA4 FSeek_firclus   dw	0
DOSDATA:0AA6 FSeek_logclus   dw	0
DOSDATA:0AA8 FSeek_logsave   dw	0
DOSDATA:0AAA TEMP_DOSLOC     dw	-1		     ; ...
DOSDATA:0AAC SWAP_END	     db	0		     ; ...
DOSDATA:0AAD UCASE_TAB	     dw	128		     ; ...
DOSDATA:0AAF UCASE_TAB_2     db	128,154,069,065,142,065,143,128	; ...
DOSDATA:0AAF		     db	069,069,069,073,073,073,142,143
DOSDATA:0AAF		     db	144,146,146,079,153,079,085,085
DOSDATA:0AAF		     db	089,153,154,155,156,157,158,159
DOSDATA:0AAF		     db	065,073,079,085,165,165,166,167
DOSDATA:0AAF		     db	168,169,170,171,172,173,174,175
DOSDATA:0AAF		     db	176,177,178,179,180,181,182,183
DOSDATA:0AAF		     db	184,185,186,187,188,189,190,191
DOSDATA:0AAF		     db	192,193,194,195,196,197,198,199
DOSDATA:0AAF		     db	200,201,202,203,204,205,206,207
DOSDATA:0AAF		     db	208,209,210,211,212,213,214,215
DOSDATA:0AAF		     db	216,217,218,219,220,221,222,223
DOSDATA:0AAF		     db	224,225,226,227,228,229,230,231
DOSDATA:0AAF		     db	232,233,234,235,236,237,238,239
DOSDATA:0AAF		     db	240,241,242,243,244,245,246,247
DOSDATA:0AAF		     db	248,249,250,251,252,253,254,255
DOSDATA:0B2F FILE_UCASE_TAB  dw	128		     ; ...
DOSDATA:0B31 FILE_UCASE_TAB_2 db 128,154,069,065,142,065,143,128 ; ...
DOSDATA:0B31		     db	069,069,069,073,073,073,142,143
DOSDATA:0B31		     db	144,146,146,079,153,079,085,085
DOSDATA:0B31		     db	089,153,154,155,156,157,158,159
DOSDATA:0B31		     db	065,073,079,085,165,165,166,167
DOSDATA:0B31		     db	168,169,170,171,172,173,174,175
DOSDATA:0B31		     db	176,177,178,179,180,181,182,183
DOSDATA:0B31		     db	184,185,186,187,188,189,190,191
DOSDATA:0B31		     db	192,193,194,195,196,197,198,199
DOSDATA:0B31		     db	200,201,202,203,204,205,206,207
DOSDATA:0B31		     db	208,209,210,211,212,213,214,215
DOSDATA:0B31		     db	216,217,218,219,220,221,222,223
DOSDATA:0B31		     db	224,225,226,227,228,229,230,231
DOSDATA:0B31		     db	232,233,234,235,236,237,238,239
DOSDATA:0B31		     db	240,241,242,243,244,245,246,247
DOSDATA:0B31		     db	248,249,250,251,252,253,254,255
DOSDATA:0BB1 FILE_CHAR_TAB   dw	22		     ; ...
DOSDATA:0BB3		     db	1, 0, 255
DOSDATA:0BB6		     db	0, 0, 20h
DOSDATA:0BB9		     db	2, 14
DOSDATA:0BBB		     db	'."/\[]:|<>+=;,'
DOSDATA:0BC9		     db	24 dup(0)
DOSDATA:0BE1 COLLATE_TAB     dw	256		     ; ...
DOSDATA:0BE3		     db	0, 1, 2, 3, 4, 5, 6, 7
DOSDATA:0BEB		     db	8, 9, 10, 11, 12, 13, 14, 15
DOSDATA:0BF3		     db	16, 17,	18, 19,	20, 21,	22, 23
DOSDATA:0BFB		     db	24, 25,	26, 27,	28, 29,	30, 31
DOSDATA:0C03		     db	' ', '!', '"', '#', '$', '%', '&'
DOSDATA:0C0A		     db	27h
DOSDATA:0C0B		     db	'(', ')', '*', '+', ',', '-', '.', '/'
DOSDATA:0C0B		     db	'0', '1', '2', '3', '4', '5', '6', '7'
DOSDATA:0C0B		     db	'8', '9', ':', ';', '<', '=', '>', '?'
DOSDATA:0C0B		     db	'@', 'A', 'B', 'C', 'D', 'E', 'F', 'G'
DOSDATA:0C0B		     db	'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O'
DOSDATA:0C0B		     db	'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W'
DOSDATA:0C0B		     db	'X', 'Y', 'Z', '[', '\', ']', '^', '_'
DOSDATA:0C0B		     db	'`', 'A', 'B', 'C', 'D', 'E', 'F', 'G'
DOSDATA:0C0B		     db	'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O'
DOSDATA:0C0B		     db	'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W'
DOSDATA:0C0B		     db	'X', 'Y', 'Z', '{', '|', '}', '~', ''
DOSDATA:0C0B		     db	'C', 'U', 'E', 'A', 'A', 'A', 'A', 'C'
DOSDATA:0C0B		     db	'E', 'E', 'E', 'I', 'I', 'I', 'A', 'A'
DOSDATA:0C0B		     db	'E', 'A', 'A', 'O', 'O', 'O', 'U', 'U'
DOSDATA:0C0B		     db	'Y', 'O', 'U', '$', '$', '$', '$', '$'
DOSDATA:0C0B		     db	'A', 'I', 'O', 'U', 'N', 'N'
DOSDATA:0C89		     db	166, 167
DOSDATA:0C8B		     db	'?'
DOSDATA:0C8C		     db	169, 170, 171, 172
DOSDATA:0C90		     db	'!', '"', '"'
DOSDATA:0C93		     db	176, 177, 178, 179, 180, 181, 182, 183
DOSDATA:0C93		     db	184, 185, 186, 187, 188, 189, 190, 191
DOSDATA:0C93		     db	192, 193, 194, 195, 196, 197, 198, 199
DOSDATA:0C93		     db	200, 201, 202, 203, 204, 205, 206, 207
DOSDATA:0C93		     db	208, 209, 210, 211, 212, 213, 214, 215
DOSDATA:0C93		     db	216, 217, 218, 219, 220, 221, 222, 223
DOSDATA:0C93		     db	224
DOSDATA:0CC4		     db	'S'
DOSDATA:0CC5		     db	226, 227, 228, 229, 230, 231, 232, 233
DOSDATA:0CC5		     db	234, 235, 236, 237, 238, 239, 240, 241
DOSDATA:0CC5		     db	242, 243, 244, 245, 246, 247, 248, 249
DOSDATA:0CC5		     db	250, 251, 252, 253, 254, 255
DOSDATA:0CE3 DBCS_TAB	     dw	9 dup(0)	     ; ...
DOSDATA:0CF5 ; ---------------------------------------------------------------------------
DOSDATA:0CF5
DOSDATA:0CF5 MAP_CASE:				     ; ...
DOSDATA:0CF5		     cmp     al, 80h
DOSDATA:0CF7		     jnb     short Map1
DOSDATA:0CF9		     retf
DOSDATA:0CFA ; ---------------------------------------------------------------------------
DOSDATA:0CFA
DOSDATA:0CFA Map1:				     ; ...
DOSDATA:0CFA		     sub     al, 80h
DOSDATA:0CFC		     push    ds
DOSDATA:0CFD		     push    bx
DOSDATA:0CFE		     mov     bx, offset	UCASE_TAB_2 ; UCASE_TAB+2
DOSDATA:0D01		     push    cs
DOSDATA:0D02		     pop     ds
DOSDATA:0D03		     xlat
DOSDATA:0D04		     pop     bx
DOSDATA:0D05		     pop     ds
DOSDATA:0D06		     retf
DOSDATA:0D06 ; ---------------------------------------------------------------------------
DOSDATA:0D07 InterChar	     db	0
DOSDATA:0D08 InterCon	     db	0
DOSDATA:0D09 SaveCurFlg	     db	0
DOSDATA:0D0A TEMPSEG	     dw	0		     ; ...
DOSDATA:0D0C redir_patch     db	0		     ; ...
DOSDATA:0D0D		     db	5 dup(0)
DOSDATA:0D12		     db	5
DOSDATA:0D13		     db	0
DOSDATA:0D14 YRTAB	     db	200, 166	     ; ...
DOSDATA:0D14		     db	200, 165
DOSDATA:0D14		     db	200, 165
DOSDATA:0D14		     db	200, 165
DOSDATA:0D1C MONTAB	     db	31		     ; ...
DOSDATA:0D1D february	     db	28		     ; ...
DOSDATA:0D1D		     db	31
DOSDATA:0D1D		     db	30
DOSDATA:0D1D		     db	31
DOSDATA:0D1D		     db	30
DOSDATA:0D1D		     db	31
DOSDATA:0D1D		     db	31
DOSDATA:0D1D		     db	30
DOSDATA:0D1D		     db	31
DOSDATA:0D1D		     db	30
DOSDATA:0D1D		     db	31
DOSDATA:0D28 SysInitTable    dw	offset SYSINITVARS   ; ...
DOSDATA:0D2A		     dw	0
DOSDATA:0D2C		     dw	offset COUNTRY_CDPG
DOSDATA:0D2E		     dw	0
DOSDATA:0D30 FastOpenTable   dw	2		     ; ...
DOSDATA:0D32 FastOpenTable_2 dw	offset FastRet	     ; ...
DOSDATA:0D34		     dw	0
DOSDATA:0D36		     dw	offset FastRet
DOSDATA:0D38		     dw	0
DOSDATA:0D3A FastOpenFlg     db	0		     ; ...
DOSDATA:0D3B FastOpen_Ext_Info db 11 dup( 0)	     ; ...
DOSDATA:0D46 Dir_Info_Buff   db	32 dup(	0)	     ; ...
DOSDATA:0D66 Next_Element_Start	dw 0		     ; ...
DOSDATA:0D68 Del_ExtCluster  dw	0
DOSDATA:0D6A USER_SP_2F	     dw	offset FAKE_STACK_2F ; ...
DOSDATA:0D6C FAKE_STACK_2F   dw	14 dup(0)	     ; ...
DOSDATA:0D6C					     ; DOS_TEMP
DOSDATA:0D88 Hash_Temp	     dw	4 dup(0)
DOSDATA:0D90 SCAN_FLAG	     db	0		     ; ...
DOSDATA:0D91 DATE_FLAG	     dw	0		     ; ...
DOSDATA:0D93 FETCHI_TAG	     dw	0		     ; OBSOLETE
DOSDATA:0D95 MSG_EXTERROR    dd	0
DOSDATA:0D99		     dd	0
DOSDATA:0D9D		     dd	0
DOSDATA:0DA1		     dd	0
DOSDATA:0DA5		     dd	0
DOSDATA:0DA9 SEQ_SECTOR	     dd	-1		     ; ...
DOSDATA:0DAD SC_SECTOR_SIZE  dw	0		     ; ...
DOSDATA:0DAF SC_DRIVE	     db	0		     ; ...
DOSDATA:0DB0 CurSC_DRIVE     db	-1		     ; ...
DOSDATA:0DB1 CurSC_SECTOR    dd	0		     ; ...
DOSDATA:0DB5 SC_STATUS	     dw	0		     ; ...
DOSDATA:0DB7 SC_FLAG	     db	0		     ; ...
DOSDATA:0DB8 AbsDskErr	     dw	0		     ; ...
DOSDATA:0DBA NO_NAME_ID	     db	'NO NAME    '        ; ...
DOSDATA:0DC5 LOOKSIZ	     db	0
DOSDATA:0DC6 ; ---------------------------------------------------------------------------
DOSDATA:0DC6
DOSDATA:0DC6 SNULDEV:				     ; ...
DOSDATA:0DC6		     or	     word ptr es:[bx+3], 100h ;	[es:bx+SRHEAD.REQSTAT],
DOSDATA:0DC6					     ; STDON
DOSDATA:0DCC
DOSDATA:0DCC INULDEV:				     ; ...
DOSDATA:0DCC		     retf
DOSDATA:0DCC ; ---------------------------------------------------------------------------
DOSDATA:0DCD WinoldPatch2    db	8 dup(0)	     ; ...
DOSDATA:0DD5 UmbSave2	     db	5 dup(0)	     ; ...
DOSDATA:0DDA UmbSaveFlag     db	0		     ; ...
DOSDATA:0DDB ERR_TABLE_21    db	1, 7, 4, 0FFh	     ; ...
DOSDATA:0DDB		     db	2, 8, 3, 2
DOSDATA:0DDB		     db	3, 8, 3, 2
DOSDATA:0DDB		     db	4, 1, 4, 1
DOSDATA:0DDB		     db	5, 3, 3, 0FFh
DOSDATA:0DDB		     db	6, 7, 4, 1
DOSDATA:0DDB		     db	7, 7, 5, 5
DOSDATA:0DDB		     db	8, 1, 4, 5
DOSDATA:0DDB		     db	9, 7, 4, 5
DOSDATA:0DDB		     db	0Ah, 7,	4, 5
DOSDATA:0DDB		     db	0Bh, 9,	3, 1
DOSDATA:0DDB		     db	0Ch, 7,	4, 1
DOSDATA:0DDB		     db	0Dh, 9,	4, 1
DOSDATA:0DDB		     db	0Fh, 8,	3, 2
DOSDATA:0DDB		     db	10h, 3,	3, 2
DOSDATA:0DDB		     db	11h, 0Dh, 3, 2
DOSDATA:0DDB		     db	12h, 8,	3, 2
DOSDATA:0DDB		     db	50h, 0Ch, 3, 2
DOSDATA:0DDB		     db	20h, 0Ah, 2, 2
DOSDATA:0DDB		     db	21h, 0Ah, 2, 2
DOSDATA:0DDB		     db	54h, 1,	4, 0FFh
DOSDATA:0DDB		     db	56h, 3,	3, 1
DOSDATA:0DDB		     db	52h, 1,	4, 2
DOSDATA:0DDB		     db	32h, 9,	3, 3
DOSDATA:0DDB		     db	55h, 0Ch, 3, 3
DOSDATA:0DDB		     db	57h, 9,	3, 1
DOSDATA:0DDB		     db	53h, 0Dh, 4, 1
DOSDATA:0DDB		     db	24h, 1,	4, 5
DOSDATA:0DDB		     db	26h, 1,	4, 1
DOSDATA:0DDB		     db	27h, 1,	4, 1
DOSDATA:0DDB		     db	5Ah, 0Dh, 4, 2
DOSDATA:0DDB		     db	0FFh, 0FFh, 0FFh, 0FFh
DOSDATA:0E5B ERR_TABLE_24    db	13h, 0Bh, 7, 2	     ; ...
DOSDATA:0E5B		     db	14h, 4,	5, 1
DOSDATA:0E5B		     db	15h, 5,	7, 0FFh
DOSDATA:0E5B		     db	16h, 4,	5, 1
DOSDATA:0E5B		     db	17h, 0Bh, 4, 2
DOSDATA:0E5B		     db	18h, 4,	5, 1
DOSDATA:0E5B		     db	19h, 5,	1, 2
DOSDATA:0E5B		     db	1Ah, 0Bh, 7, 2
DOSDATA:0E5B		     db	1Bh, 0Bh, 4, 2
DOSDATA:0E5B		     db	1Ch, 2,	7, 4
DOSDATA:0E5B		     db	1Dh, 5,	4, 0FFh
DOSDATA:0E5B		     db	1Eh, 5,	4, 0FFh
DOSDATA:0E5B		     db	1Fh, 0Dh, 4, 0FFh
DOSDATA:0E5B		     db	20h, 0Ah, 2, 2
DOSDATA:0E5B		     db	21h, 0Ah, 2, 2
DOSDATA:0E5B		     db	22h, 0Bh, 7, 2
DOSDATA:0E5B		     db	32h, 9,	3, 3
DOSDATA:0E5B		     db	23h, 7,	4, 1
DOSDATA:0E5B		     db	24h, 1,	4, 5
DOSDATA:0E5B		     db	0FFh, 0Dh, 5, 0FFh
DOSDATA:0EAB ErrMap24	     db	13h, 14h, 15h, 16h, 17h, 18h, 19h, 1Ah ; ...
DOSDATA:0EAB		     db	1Bh, 1Ch, 1Dh, 1Eh, 1Fh, 1Fh, 1Fh, 22h
DOSDATA:0EBB FIRST_BUFF_ADDR dw	0		     ; ...
DOSDATA:0EBD SPECIAL_VERSION dw	0		     ; ...
DOSDATA:0EBF FAKE_COUNT	     db	255 dup(0)
DOSDATA:0FBE OLD_FIRSTCLUS   dw	0		     ; ...
DOSDATA:0FC0 exec_init_SP    dw	0		     ; ...
DOSDATA:0FC2 exec_init_SS    dw	0		     ; ...
DOSDATA:0FC4 exec_init_IP    dw	0		     ; ...
DOSDATA:0FC6 exec_init_CS    dw	0		     ; ...
DOSDATA:0FC8 exec_signature  dw	0		     ; ...
DOSDATA:0FCA exec_len_mod_512 dw 0
DOSDATA:0FCC exec_pages	     dw	0		     ; ...
DOSDATA:0FCE exec_rle_count  dw	0		     ; ...
DOSDATA:0FD0 exec_par_dir    dw	0		     ; ...
DOSDATA:0FD2 exec_min_BSS    dw	0		     ; ...
DOSDATA:0FD4 exec_max_BSS    dw	0		     ; ...
DOSDATA:0FD6 exec_SS	     dw	0		     ; ...
DOSDATA:0FD8 exec_SP	     dw	0		     ; ...
DOSDATA:0FDA exec_chksum     dw	0
DOSDATA:0FDC exec_IP	     dw	0		     ; ...
DOSDATA:0FDE exec_CS	     dw	0
DOSDATA:0FE0 exec_rle_table  dw	0		     ; ...
DOSDATA:0FE2 Win386_Info     db	3, 13 dup(0)	     ; ...
DOSDATA:0FF0		     dw	offset Instance_Table
DOSDATA:0FF2 Win386_Info_16  dw	0		     ; ...
DOSDATA:0FF4 Instance_Table  dw	offset CONTPOS	     ; ...
DOSDATA:0FF6 Instance_Table_2 dw 0		     ; ...
DOSDATA:0FF8		     dw	2
DOSDATA:0FFA		     dw	offset BCON
DOSDATA:0FFC		     dw	0
DOSDATA:0FFE		     dw	4
DOSDATA:1000		     dw	offset CARPOS
DOSDATA:1002		     dw	0
DOSDATA:1004		     dw	106h
DOSDATA:1006		     dw	offset CHARCO
DOSDATA:1008		     dw	0
DOSDATA:100A		     dw	1
DOSDATA:100C		     dw	offset exec_init_SP
DOSDATA:100E		     dw	0
DOSDATA:1010		     dw	22h
DOSDATA:1012		     dw	offset UMBFLAG
DOSDATA:1014		     dw	0
DOSDATA:1016		     dw	1
DOSDATA:1018		     dw	offset UMB_HEAD
DOSDATA:101A		     dw	0
DOSDATA:101C		     dw	2
DOSDATA:101E		     dw	0
DOSDATA:1020		     dw	0
DOSDATA:1022 Win386_DOSVars  db	5		     ; ...
DOSDATA:1022					     ; Major version 5
DOSDATA:1023		     db	0		     ; Minor version 0
DOSDATA:1024		     dw	offset SAVEDS
DOSDATA:1026		     dw	offset SAVEBX
DOSDATA:1028		     dw	offset INDOS
DOSDATA:102A		     dw	offset USER_ID
DOSDATA:102C		     dw	offset CritPatch
DOSDATA:102E		     dw	offset UMB_HEAD
DOSDATA:1030 IsWin386	     db	0		     ; ...
DOSDATA:1031 VxDpath	     db	'c:\wina20.386',0    ; ...
DOSDATA:103F DriverLoad	     db	1		     ; ...
DOSDATA:1040 BiosDataPtr     dd	0		     ; ...
DOSDATA:1044		     db	36h, 0F6h, 6, 20h, 3, 0FFh ; Patch for Sidekick
DOSDATA:104A		     db	75h, 0Ch
DOSDATA:104C		     db	36h, 0FFh, 36h,	58h, 3
DOSDATA:1051		     db	0CDh, 28h
DOSDATA:1053		     db	80h, 3Eh, 20h, 3, 0  ; Patch for PortOfEntry
DOSDATA:1058		     db	75h, 37h
DOSDATA:105A		     db	0BCh, 0A0h, 0Ah
DOSDATA:105D LocalSFT	     dd	0		     ; ...
DOSDATA:1061		     db	90h		     ; align 2
DOSDATA:1062 DOSINTTABLE     dw	offset DIVOV	     ; ...
DOSDATA:1064		     dw	0
DOSDATA:1066 DOSINTTABLE_4   dw	offset QUIT	     ; ...
DOSDATA:1068		     dw	0
DOSDATA:106A DOSINTTABLE_8   dw	offset COMMAND	     ; ...
DOSDATA:106C		     dw	0
DOSDATA:106E DOSINTTABLE_12  dw	offset ABSDRD	     ; ...
DOSDATA:1070		     dw	0
DOSDATA:1072 DOSINTTABLE_16  dw	offset ABSDWRT	     ; ...
DOSDATA:1074		     dw	0
DOSDATA:1076 DOSINTTABLE_20  dw	offset STAY_RESIDENT ; ...
DOSDATA:1078		     dw	0
DOSDATA:107A DOSINTTABLE_24  dw	offset INT2F	     ; ...
DOSDATA:107C		     dw	0
DOSDATA:107E DOSINTTABLE_28  dw	offset CALL_ENTRY    ; ...
DOSDATA:1080		     dw	0
DOSDATA:1082		     dw	offset IRETT
DOSDATA:1084		     dw	0
DOSDATA:1086 SS_Save	     dw	0		     ; ...
DOSDATA:1088 SP_Save	     dw	0		     ; ...
DOSDATA:108A ; ---------------------------------------------------------------------------
DOSDATA:108A
DOSDATA:108A ldivov:				     ; ...
DOSDATA:108A		     jmp     short divov_cont ;	i0patch
DOSDATA:108C ; ---------------------------------------------------------------------------
DOSDATA:108C		     call    EnsureA20ON
DOSDATA:108F
DOSDATA:108F divov_cont:			     ; ...
DOSDATA:108F		     jmp     dword ptr cs:DOSINTTABLE
DOSDATA:1094 ; ---------------------------------------------------------------------------
DOSDATA:1094
DOSDATA:1094 lquit:				     ; ...
DOSDATA:1094		     jmp     short quit_cont ; i20patch
DOSDATA:1096 ; ---------------------------------------------------------------------------
DOSDATA:1096		     call    EnsureA20ON
DOSDATA:1099
DOSDATA:1099 quit_cont:				     ; ...
DOSDATA:1099		     jmp     dword ptr cs:DOSINTTABLE_4
DOSDATA:109E ; ---------------------------------------------------------------------------
DOSDATA:109E
DOSDATA:109E lcommand:				     ; ...
DOSDATA:109E		     jmp     short command_cont	; i21patch
DOSDATA:10A0 ; ---------------------------------------------------------------------------
DOSDATA:10A0		     call    EnsureA20ON
DOSDATA:10A3
DOSDATA:10A3 command_cont:			     ; ...
DOSDATA:10A3		     jmp     dword ptr cs:DOSINTTABLE_8
DOSDATA:10A8 ; ---------------------------------------------------------------------------
DOSDATA:10A8
DOSDATA:10A8 labsdrd:				     ; ...
DOSDATA:10A8		     jmp     short absdrd_cont ; i25patch
DOSDATA:10AA ; ---------------------------------------------------------------------------
DOSDATA:10AA		     call    EnsureA20ON
DOSDATA:10AD
DOSDATA:10AD absdrd_cont:			     ; ...
DOSDATA:10AD		     jmp     dword ptr cs:DOSINTTABLE_12
DOSDATA:10B2 ; ---------------------------------------------------------------------------
DOSDATA:10B2
DOSDATA:10B2 labsdwrt:				     ; ...
DOSDATA:10B2		     jmp     short absdwrt_cont	; i26patch
DOSDATA:10B4 ; ---------------------------------------------------------------------------
DOSDATA:10B4		     call    EnsureA20ON
DOSDATA:10B7
DOSDATA:10B7 absdwrt_cont:			     ; ...
DOSDATA:10B7		     jmp     dword ptr cs:DOSINTTABLE_16
DOSDATA:10BC ; ---------------------------------------------------------------------------
DOSDATA:10BC
DOSDATA:10BC lstay_resident:			     ; ...
DOSDATA:10BC		     jmp     short sr_cont   ; i27patch
DOSDATA:10BE ; ---------------------------------------------------------------------------
DOSDATA:10BE		     call    EnsureA20ON
DOSDATA:10C1
DOSDATA:10C1 sr_cont:				     ; ...
DOSDATA:10C1		     jmp     dword ptr cs:DOSINTTABLE_20
DOSDATA:10C6 ; ---------------------------------------------------------------------------
DOSDATA:10C6
DOSDATA:10C6 lint2f:				     ; ...
DOSDATA:10C6		     jmp     short int2f_cont ;	i2fpatch
DOSDATA:10C8 ; ---------------------------------------------------------------------------
DOSDATA:10C8		     call    EnsureA20ON
DOSDATA:10CB
DOSDATA:10CB int2f_cont:			     ; ...
DOSDATA:10CB		     jmp     dword ptr cs:DOSINTTABLE_24
DOSDATA:10D0 ; ---------------------------------------------------------------------------
DOSDATA:10D0
DOSDATA:10D0 lcall_entry:			     ; ...
DOSDATA:10D0		     jmp     short callentry_cont ; cpmpatch
DOSDATA:10D2 ; ---------------------------------------------------------------------------
DOSDATA:10D2		     call    EnsureA20ON
DOSDATA:10D5
DOSDATA:10D5 callentry_cont:			     ; ...
DOSDATA:10D5		     jmp     dword ptr cs:DOSINTTABLE_28
DOSDATA:10DA ; ---------------------------------------------------------------------------
DOSDATA:10DA
DOSDATA:10DA lirett:				     ; ...
DOSDATA:10DA		     iret
DOSDATA:10DA ; ---------------------------------------------------------------------------
DOSDATA:10DB DosRetAddr23    dd	0		     ; ...
DOSDATA:10DF DosRetAddr24    dd	0		     ; ...
DOSDATA:10E3 DosRetAddr28    dd	0
DOSDATA:10E7 ; ---------------------------------------------------------------------------
DOSDATA:10E7
DOSDATA:10E7 LowInt23:				     ; ...
DOSDATA:10E7		     pop     word ptr cs:DosRetAddr23
DOSDATA:10EC		     pop     word ptr cs:DosRetAddr23+2
DOSDATA:10F1		     int     23h	     ; DOS - CONTROL "C" EXIT ADDRESS
DOSDATA:10F1					     ; Return: return via RETF 2 with CF set
DOSDATA:10F1					     ; DOS will	abort program with errorlevel 0
DOSDATA:10F1					     ; else
DOSDATA:10F1					     ; interrupted DOS call continues
DOSDATA:10F3		     call    EnsureA20ON
DOSDATA:10F6		     jmp     cs:DosRetAddr23
DOSDATA:10FB ; ---------------------------------------------------------------------------
DOSDATA:10FB
DOSDATA:10FB LowInt24:				     ; ...
DOSDATA:10FB		     pop     word ptr cs:DosRetAddr24
DOSDATA:1100		     pop     word ptr cs:DosRetAddr24+2
DOSDATA:1105		     int     24h	     ; DOS - FATAL ERROR HANDLER ADDRESS
DOSDATA:1105					     ; Automatically called upon detection of unrecoverable I/O	error.
DOSDATA:1107		     call    EnsureA20ON
DOSDATA:110A		     jmp     cs:DosRetAddr24
DOSDATA:110F ; ---------------------------------------------------------------------------
DOSDATA:110F
DOSDATA:110F LowInt28:				     ; ...
DOSDATA:110F		     int     28h	     ; DOS 2+ internal - KEYBOARD BUSY LOOP
DOSDATA:1111		     call    EnsureA20ON
DOSDATA:1114		     retf
DOSDATA:1115 ; ---------------------------------------------------------------------------
DOSDATA:1115
DOSDATA:1115 disa20_xfer:			     ; ...
DOSDATA:1115		     call    XMMDisableA20
DOSDATA:1118		     cli
DOSDATA:1119		     mov     cs:INDOS, 0
DOSDATA:111F		     mov     ss, ax
DOSDATA:1121		     mov     sp, di
DOSDATA:1123		     sti
DOSDATA:1124		     push    ds
DOSDATA:1125		     push    si
DOSDATA:1126		     mov     es, dx
DOSDATA:1128		     mov     ds, dx
DOSDATA:112A		     mov     ax, bx
DOSDATA:112C		     retf
DOSDATA:112D ; ---------------------------------------------------------------------------
DOSDATA:112D
DOSDATA:112D disa20_iret:			     ; ...
DOSDATA:112D		     call    XMMDisableA20
DOSDATA:1130		     dec     byte ptr ds:321h
DOSDATA:1134		     mov     ss, word ptr ds:586h
DOSDATA:1138		     mov     sp, ds:584h
DOSDATA:113C		     mov     bp, sp
DOSDATA:113E		     mov     [bp+0], al
DOSDATA:1141		     mov     ax, ds:5F2h
DOSDATA:1144		     mov     ds:584h, ax
DOSDATA:1147		     mov     ax, ds:5F0h
DOSDATA:114A		     mov     ds:586h, ax
DOSDATA:114D		     pop     ax
DOSDATA:114E		     pop     bx
DOSDATA:114F		     pop     cx
DOSDATA:1150		     pop     dx
DOSDATA:1151		     pop     si
DOSDATA:1152		     pop     di
DOSDATA:1153		     pop     bp
DOSDATA:1154		     pop     ds
DOSDATA:1155		     pop     es
DOSDATA:1156		     iret
DOSDATA:1157
DOSDATA:1157 ; =============== S U B R O U T I N E =======================================
DOSDATA:1157
DOSDATA:1157
DOSDATA:1157 XMMDisableA20   proc near		     ; ...
DOSDATA:1157		     push    bx
DOSDATA:1158		     push    ax
DOSDATA:1159		     mov     ah, 6
DOSDATA:115B		     call    cs:XMMcontrol
DOSDATA:1160		     pop     ax
DOSDATA:1161		     pop     bx
DOSDATA:1162		     retn
DOSDATA:1162 XMMDisableA20   endp
DOSDATA:1162
DOSDATA:1162 ; ---------------------------------------------------------------------------
DOSDATA:1163 XMMcontrol	     dd	0		     ; ...
DOSDATA:1167 LowMemory	     dd	80h		     ; ...
DOSDATA:116B HighMemory	     dd	0FFFF0090h	     ; ...
DOSDATA:116F
DOSDATA:116F ; =============== S U B R O U T I N E =======================================
DOSDATA:116F
DOSDATA:116F
DOSDATA:116F EnsureA20ON     proc near		     ; ...
DOSDATA:116F		     pushf
DOSDATA:1170		     push    ds
DOSDATA:1171		     push    es
DOSDATA:1172		     push    cx
DOSDATA:1173		     push    si
DOSDATA:1174		     push    di
DOSDATA:1175		     lds     si, cs:LowMemory
DOSDATA:117A		     les     di, cs:HighMemory
DOSDATA:117F		     mov     cx, 4
DOSDATA:1182		     cld
DOSDATA:1183		     repe cmpsw
DOSDATA:1185		     jz	     short EA20_OFF
DOSDATA:1187
DOSDATA:1187 EA20_RET:				     ; ...
DOSDATA:1187		     pop     di
DOSDATA:1188		     pop     si
DOSDATA:1189		     pop     cx
DOSDATA:118A		     pop     es
DOSDATA:118B		     pop     ds
DOSDATA:118C		     popf
DOSDATA:118D		     retn
DOSDATA:118E ; ---------------------------------------------------------------------------
DOSDATA:118E
DOSDATA:118E EA20_OFF:				     ; ...
DOSDATA:118E		     push    bx
DOSDATA:118F		     push    ax
DOSDATA:1190		     mov     ax, ss
DOSDATA:1192		     mov     cs:SS_Save, ax
DOSDATA:1196		     mov     cs:SP_Save, sp
DOSDATA:119B		     mov     ax, cs
DOSDATA:119D		     mov     ss, ax
DOSDATA:119F		     mov     sp, offset	AUXSTACK
DOSDATA:11A2		     mov     ah, 5	     ; XMM_LOCAL_ENABLE_A20
DOSDATA:11A4		     call    cs:XMMcontrol
DOSDATA:11A9		     or	     ax, ax
DOSDATA:11AB		     jz	     short XMMerror
DOSDATA:11AD		     mov     ax, cs:SS_Save
DOSDATA:11B1		     mov     ss, ax
DOSDATA:11B3		     mov     sp, cs:SP_Save
DOSDATA:11B8		     pop     ax
DOSDATA:11B9		     pop     bx
DOSDATA:11BA		     jmp     short EA20_RET
DOSDATA:11BC ; ---------------------------------------------------------------------------
DOSDATA:11BC
DOSDATA:11BC XMMerror:				     ; ...
DOSDATA:11BC		     mov     ah, 0Fh
DOSDATA:11BE		     int     10h	     ; - VIDEO - SELECT	DISPLAY	PAGE
DOSDATA:11BE					     ; AL = display page, 0-7  for modes 0 & 1,	0-3  for modes 2 & 3
DOSDATA:11C0		     cmp     al, 7
DOSDATA:11C2		     jz	     short XMMcont
DOSDATA:11C4		     xor     ah, ah
DOSDATA:11C6		     mov     al, 2
DOSDATA:11C8		     int     10h	     ; - VIDEO -
DOSDATA:11CA
DOSDATA:11CA XMMcont:				     ; ...
DOSDATA:11CA		     mov     ah, 5
DOSDATA:11CC		     xor     al, al
DOSDATA:11CE		     int     10h	     ; - VIDEO - WRITE CHARACTER AND ADVANCE CURSOR (TTY WRITE)
DOSDATA:11CE					     ; AL = character, BH = display page (alpha	modes)
DOSDATA:11CE					     ; BL = foreground color (graphics modes)
DOSDATA:11D0		     mov     si, offset	XMMERRMSG ; "\r\nA20 Hardware Error\r\n$"
DOSDATA:11D3		     push    cs
DOSDATA:11D4		     pop     ds
DOSDATA:11D5		     cld
DOSDATA:11D6
DOSDATA:11D6 XMMprnt:				     ; ...
DOSDATA:11D6		     lodsb
DOSDATA:11D7		     cmp     al, '$'
DOSDATA:11D9		     jz	     short XMMStall
DOSDATA:11DB		     mov     ah, 0Eh
DOSDATA:11DD		     mov     bx, 7
DOSDATA:11E0		     int     10h	     ; - VIDEO -
DOSDATA:11E2		     jmp     short XMMprnt
DOSDATA:11E4 ; ---------------------------------------------------------------------------
DOSDATA:11E4
DOSDATA:11E4 XMMStall:				     ; ...
DOSDATA:11E4		     sti
DOSDATA:11E5		     jmp     short XMMStall
DOSDATA:11E5 EnsureA20ON     endp
DOSDATA:11E5
DOSDATA:11E5 ; ---------------------------------------------------------------------------
DOSDATA:11E7 OldInstanceJunk dw	70h		     ; ...
DOSDATA:11E9		     dw	0
DOSDATA:11EB		     dw	6
DOSDATA:11ED OldInstanceJunk_6 dw 0		     ; ...
DOSDATA:11EF		     dw	offset CONTPOS
DOSDATA:11F1		     dw	2
DOSDATA:11F3		     dw	0
DOSDATA:11F5		     dw	offset BCON
DOSDATA:11F7		     dw	4
DOSDATA:11F9		     dw	0
DOSDATA:11FB		     dw	offset CARPOS
DOSDATA:11FD		     dw	106h
DOSDATA:11FF		     dw	0
DOSDATA:1201		     dw	offset CHARCO
DOSDATA:1203		     dw	1
DOSDATA:1205		     dw	0
DOSDATA:1207		     dw	offset exec_init_SP
DOSDATA:1209		     dw	34
DOSDATA:120B		     dw	70h
DOSDATA:120D		     dw	0Ch		     ; DOSBIODATASEG:ALTAH
DOSDATA:120F		     dw	1
DOSDATA:1211 DosHasHMA	     db	0		     ; ...
DOSDATA:1212 FixExePatch     dw	0		     ; ...
DOSDATA:1214 RationalPatchPtr dw 0		     ; ...
DOSDATA:1216 ; ---------------------------------------------------------------------------
DOSDATA:1216
DOSDATA:1216 RatBugCode:			     ; ...
DOSDATA:1216		     push    cx
DOSDATA:1217		     mov     cx, FCBLRU	     ; [10h]
DOSDATA:121B
DOSDATA:121B rbc_loop:				     ; ...
DOSDATA:121B		     loop    rbc_loop
DOSDATA:121D		     pop     cx
DOSDATA:121E		     retf
DOSDATA:121E ; ---------------------------------------------------------------------------
DOSDATA:121F UmbSave1	     db	11 dup(0)	     ; ...
DOSDATA:122A COUNTRY_CDPG    db	0, 0, 0, 0, 0, 0, 0, 0 ; ...
DOSDATA:1232		     db	'\COUNTRY.SYS',0
DOSDATA:123F		     db	51 dup(0)
DOSDATA:1272		     dw	437
DOSDATA:1274		     dw	6
DOSDATA:1276 COUNTRY_CDPG_76 db	2		     ; ...
DOSDATA:1277		     dw	offset UCASE_TAB
DOSDATA:1279		     dw	0
DOSDATA:127B		     db	4
DOSDATA:127C		     dw	offset FILE_UCASE_TAB
DOSDATA:127E		     dw	0
DOSDATA:1280		     db	5
DOSDATA:1281		     dw	offset FILE_CHAR_TAB
DOSDATA:1283		     dw	0
DOSDATA:1285		     db	6
DOSDATA:1286		     dw	offset COLLATE_TAB
DOSDATA:1288		     dw	0
DOSDATA:128A		     db	7
DOSDATA:128B		     dw	offset DBCS_TAB
DOSDATA:128D		     dw	0
DOSDATA:128F		     db	1
DOSDATA:1290		     dw	38		     ; NEW_COUNTRY_SIZE
DOSDATA:1292		     dw	1
DOSDATA:1294		     dw	437
DOSDATA:1296 COUNTRY_CDPG_108 dw 0		     ; ...
DOSDATA:1298		     db	'$',0,0,0,0
DOSDATA:129D		     db	',',0,'.',0,'-',0,':',0
DOSDATA:12A5		     db	0
DOSDATA:12A6		     db	2
DOSDATA:12A7		     db	0
DOSDATA:12A8		     dw	offset MAP_CASE
DOSDATA:12AA		     dw	0
DOSDATA:12AC		     db	',',0
DOSDATA:12AE		     dw	0, 0, 0, 0, 0
DOSDATA:12B8 XMMERRMSG	     db	0Dh,0Ah		     ; ...
DOSDATA:12B8		     db	'A20 Hardware Error',0Dh,0Ah,'$'
DOSDATA:12CF DOSP1_ID	     db	36h, 0C5h, 36h
DOSDATA:12D2 DOSP1_THISSFT   db	36h, 5,	0C5h, 74h, 7, 0E8h
DOSDATA:12D8		     db	90h
DOSDATA:12D9		     db	90h
DOSDATA:12DA DOSP12_ID	     db	36h, 0C5h, 36h
DOSDATA:12DD DOSP12_THISSFT  db	36h, 5,	0C5h, 74h, 7, 0E8h
DOSDATA:12E3 DOSP3_ID	     db	51h, 6,	57h, 0BAh
DOSDATA:12E7 DOSP3_CONBUF    db	29h, 2,	0E8h
DOSDATA:12EA		     db	9Ah, 0E3h, 5Fh,	7
DOSDATA:12EE		     db	59h
DOSDATA:12EF DOSP5_ID	     db	51h
DOSDATA:12F0		     db	0ACh, 3Ch, 1Ah,	74h, 5
DOSDATA:12F5		     db	0E8h
DOSDATA:12F6 DOSP7_ID	     db	2Eh, 8Ch, 1Eh
DOSDATA:12F9 DOSP7_SAVEDS    db	7Eh, 5
DOSDATA:12FB		     db	2Eh, 89h, 1Eh
DOSDATA:12FE DOSP7_SAVEBX    db	7Ch, 5
DOSDATA:1300		     db	8Ch, 0CBh
DOSDATA:1302		     db	8Eh, 0DBh
DOSDATA:1304		     db	0FEh, 6
DOSDATA:1306 DOSP7_INDOS     db	0CFh, 2
DOSDATA:1308		     db	33h, 0C0h
DOSDATA:130A DOSP8_ID	     db	50h
DOSDATA:130B		     db	36h, 0A1h
DOSDATA:130D DOSP8_USER_ID   db	0EAh, 2
DOSDATA:130F		     db	26h, 3Bh, 45h
DOSDATA:1312		     db	2Fh, 58h
DOSDATA:1314 DOSP10_ID	     db	6, 1Fh
DOSDATA:1316 DOSP10_LOC	     db	8Bh, 0DFh
DOSDATA:1318		     db	33h, 0C0h, 8Bh,	0D0h, 0E8h
DOSDATA:131D		     db	0DFh, 0Eh
DOSDATA:131F		     db	1Eh, 36h, 0C5h,	36h, 36h, 5, 0E8h, 0AFh, 0Eh
DOSDATA:1328		     db	8Bh, 0D7h, 0B4h, 86h, 36h, 8Bh,	3Eh
DOSDATA:132F		     db	9, 3
DOSDATA:1331		     db	0F7h, 0C7h, 0, 80h, 74h, 19h, 0E8h, 47h, 17h
DOSDATA:133A		     db	8Bh, 0FAh, 0Ah,	0C0h, 74h, 10h,	3Ch, 3,	74h, 3
DOSDATA:1344		     db	1Fh, 0EBh, 0CFh
DOSDATA:1347		     db	5Fh
DOSDATA:1348		     db	36h, 0C4h, 3Eh,	36h, 5,	0E9h, 0A1h, 4
DOSDATA:1350		     db	5Fh, 8Bh, 0FAh
DOSDATA:1353 DOSP13_ID	     db	0ACh
DOSDATA:1354		     db	3Ch, 24h
DOSDATA:1354		     db	74h, 8
DOSDATA:1354		     db	0B3h, 7
DOSDATA:1354		     db	0B4h, 0Eh
DOSDATA:1354		     db	0CDh, 10h
DOSDATA:1354		     db	0EBh, 0F3h
DOSDATA:1354		     db	0EBh, 0FEh
DOSDATA:1354 DOSDATA	     ends
DOSDATA:1354
DOSDATA:1354
DOSDATA:1354		     end
